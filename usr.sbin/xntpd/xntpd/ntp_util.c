begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ntp_util.c - stuff I didn't have any other place for  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|"ntpd.h"
end_include

begin_include
include|#
directive|include
file|"ntp_io.h"
end_include

begin_include
include|#
directive|include
file|"ntp_unixtime.h"
end_include

begin_include
include|#
directive|include
file|"ntp_filegen.h"
end_include

begin_include
include|#
directive|include
file|"ntp_if.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|DOSYNCTODR
end_ifdef

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * This contains odds and ends.  Right now the only thing you'll find  * in here is the hourly stats printer and some code to support rereading  * the keys file, but I may eventually put other things in here such as  * code to do something with the leap bits.  */
end_comment

begin_comment
comment|/*  * Name of the keys file  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|key_file_name
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * The name of the drift_comp file and the temporary.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|stats_drift_file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|stats_temp_file
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Statistics file stuff  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|NTP_VAR
end_ifndef

begin_define
define|#
directive|define
name|NTP_VAR
value|"/var/NTP/"
end_define

begin_comment
comment|/* NOTE the trailing '/' */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|MAXPATHLEN
end_ifndef

begin_define
define|#
directive|define
name|MAXPATHLEN
value|1024
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|char
name|statsdir
index|[
name|MAXPATHLEN
index|]
init|=
name|NTP_VAR
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|FILEGEN
name|peerstats
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|FILEGEN
name|loopstats
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|FILEGEN
name|clockstats
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * We query the errno to see what kind of error occured  * when opening the drift file.  */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * This controls whether stats are written to the fileset. Provided  * so that xntpdc can turn off stats when the file system fills up.   */
end_comment

begin_decl_stmt
name|int
name|stats_control
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|debug
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * init_util - initialize the utilities  */
end_comment

begin_function
name|void
name|init_util
parameter_list|()
block|{
name|stats_drift_file
operator|=
literal|0
expr_stmt|;
name|stats_temp_file
operator|=
literal|0
expr_stmt|;
name|key_file_name
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|PEERNAME
value|"peerstats"
define|#
directive|define
name|LOOPNAME
value|"loopstats"
define|#
directive|define
name|CLOCKNAME
value|"clockstats"
name|peerstats
operator|.
name|fp
operator|=
name|NULL
expr_stmt|;
name|peerstats
operator|.
name|prefix
operator|=
operator|&
name|statsdir
index|[
literal|0
index|]
expr_stmt|;
name|peerstats
operator|.
name|basename
operator|=
name|emalloc
argument_list|(
name|strlen
argument_list|(
name|PEERNAME
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|peerstats
operator|.
name|basename
argument_list|,
name|PEERNAME
argument_list|)
expr_stmt|;
name|peerstats
operator|.
name|id
operator|=
literal|0
expr_stmt|;
name|peerstats
operator|.
name|type
operator|=
name|FILEGEN_DAY
expr_stmt|;
name|peerstats
operator|.
name|flag
operator|=
name|FGEN_FLAG_LINK
expr_stmt|;
comment|/* not yet enabled !!*/
name|filegen_register
argument_list|(
literal|"peerstats"
argument_list|,
operator|&
name|peerstats
argument_list|)
expr_stmt|;
name|loopstats
operator|.
name|fp
operator|=
name|NULL
expr_stmt|;
name|loopstats
operator|.
name|prefix
operator|=
operator|&
name|statsdir
index|[
literal|0
index|]
expr_stmt|;
name|loopstats
operator|.
name|basename
operator|=
name|emalloc
argument_list|(
name|strlen
argument_list|(
name|LOOPNAME
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|loopstats
operator|.
name|basename
argument_list|,
name|LOOPNAME
argument_list|)
expr_stmt|;
name|loopstats
operator|.
name|id
operator|=
literal|0
expr_stmt|;
name|loopstats
operator|.
name|type
operator|=
name|FILEGEN_DAY
expr_stmt|;
name|loopstats
operator|.
name|flag
operator|=
name|FGEN_FLAG_LINK
expr_stmt|;
comment|/* not yet enabled !!*/
name|filegen_register
argument_list|(
literal|"loopstats"
argument_list|,
operator|&
name|loopstats
argument_list|)
expr_stmt|;
name|clockstats
operator|.
name|fp
operator|=
name|NULL
expr_stmt|;
name|clockstats
operator|.
name|prefix
operator|=
operator|&
name|statsdir
index|[
literal|0
index|]
expr_stmt|;
name|clockstats
operator|.
name|basename
operator|=
name|emalloc
argument_list|(
name|strlen
argument_list|(
name|CLOCKNAME
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|clockstats
operator|.
name|basename
argument_list|,
name|CLOCKNAME
argument_list|)
expr_stmt|;
name|clockstats
operator|.
name|id
operator|=
literal|0
expr_stmt|;
name|clockstats
operator|.
name|type
operator|=
name|FILEGEN_DAY
expr_stmt|;
name|clockstats
operator|.
name|flag
operator|=
name|FGEN_FLAG_LINK
expr_stmt|;
comment|/* not yet enabled !!*/
name|filegen_register
argument_list|(
literal|"clockstats"
argument_list|,
operator|&
name|clockstats
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|PEERNAME
undef|#
directive|undef
name|LOOPNAME
undef|#
directive|undef
name|CLOCKNAME
block|}
end_function

begin_comment
comment|/*  * hourly_stats - print some interesting stats  */
end_comment

begin_function
name|void
name|hourly_stats
parameter_list|()
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
specifier|extern
name|l_fp
name|last_offset
decl_stmt|;
specifier|extern
name|s_fp
name|drift_comp
decl_stmt|;
specifier|extern
name|u_char
name|sys_poll
decl_stmt|;
specifier|extern
name|int
name|pll_status
decl_stmt|;
ifdef|#
directive|ifdef
name|DOSYNCTODR
name|struct
name|timeval
name|tv
decl_stmt|;
name|int
name|o_prio
decl_stmt|;
comment|/* 	 * Sometimes having a Sun can be a drag. 	 * 	 * The kernel variable dosynctodr controls whether the system's 	 * soft clock is kept in sync with the battery clock. If it 	 * is zero, then the soft clock is not synced, and the battery 	 * clock is simply left to rot. That means that when the system 	 * reboots, the battery clock (which has probably gone wacky) 	 * sets the soft clock. That means xntpd starts off with a very 	 * confused idea of what time it is. It then takes a large 	 * amount of time to figure out just how wacky the battery clock 	 * has made things drift, etc, etc. The solution is to make the 	 * battery clock sync up to system time. The way to do THAT is 	 * to simply set the time of day to the current time of day, but 	 * as quickly as possible. This may, or may not be a sensible 	 * thing to do. 	 * 	 * CAVEAT: settimeofday() steps the sun clock by about 800 us, 	 *         so setting DOSYNCTODR seems a bad idea in the 	 *         case of us resolution 	 */
name|o_prio
operator|=
name|getpriority
argument_list|(
name|PRIO_PROCESS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Save setting */
if|if
condition|(
name|setpriority
argument_list|(
name|PRIO_PROCESS
argument_list|,
literal|0
argument_list|,
operator|-
literal|20
argument_list|)
operator|!=
literal|0
condition|)
comment|/* overdrive */
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"can't elevate priority: %m"
argument_list|)
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
name|GETTIMEOFDAY
argument_list|(
operator|&
name|tv
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|SETTIMEOFDAY
argument_list|(
operator|&
name|tv
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
name|NULL
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"can't sync battery time: %m"
argument_list|)
expr_stmt|;
block|}
name|setpriority
argument_list|(
name|PRIO_PROCESS
argument_list|,
literal|0
argument_list|,
name|o_prio
argument_list|)
expr_stmt|;
comment|/* downshift */
name|skip
label|:
endif|#
directive|endif
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"offset %s freq %s poll %d"
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|last_offset
argument_list|,
literal|6
argument_list|)
argument_list|,
name|fptoa
argument_list|(
name|drift_comp
argument_list|,
literal|3
argument_list|)
argument_list|,
name|sys_poll
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats_drift_file
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|stats_temp_file
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"can't open %s: %m"
argument_list|,
name|stats_temp_file
argument_list|)
expr_stmt|;
return|return;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s %x\n"
argument_list|,
name|fptoa
argument_list|(
name|drift_comp
argument_list|,
literal|3
argument_list|)
argument_list|,
name|pll_status
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
comment|/* atomic */
operator|(
name|void
operator|)
name|rename
argument_list|(
name|stats_temp_file
argument_list|,
name|stats_drift_file
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * stats_config - configure the stats operation  */
end_comment

begin_function
name|void
name|stats_config
parameter_list|(
name|item
parameter_list|,
name|value
parameter_list|)
name|int
name|item
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
comment|/* only one type so far */
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|l_fp
name|old_drift
decl_stmt|;
name|int
name|temp
init|=
literal|0
decl_stmt|;
name|int
name|len
decl_stmt|;
switch|switch
condition|(
name|item
condition|)
block|{
case|case
name|STATS_FREQ_FILE
case|:
if|if
condition|(
name|stats_drift_file
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|free
argument_list|(
name|stats_drift_file
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|free
argument_list|(
name|stats_temp_file
argument_list|)
expr_stmt|;
name|stats_drift_file
operator|=
literal|0
expr_stmt|;
name|stats_temp_file
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|value
operator|==
literal|0
operator|||
operator|(
name|len
operator|=
name|strlen
argument_list|(
name|value
argument_list|)
operator|)
operator|==
literal|0
condition|)
break|break;
name|stats_drift_file
operator|=
name|emalloc
argument_list|(
call|(
name|u_int
call|)
argument_list|(
name|len
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|stats_temp_file
operator|=
name|emalloc
argument_list|(
call|(
name|u_int
call|)
argument_list|(
name|len
operator|+
sizeof|sizeof
argument_list|(
literal|".TEMP"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|stats_drift_file
argument_list|,
name|value
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|stats_temp_file
argument_list|,
name|value
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|stats_temp_file
operator|+
name|len
argument_list|,
literal|".TEMP"
argument_list|,
sizeof|sizeof
argument_list|(
literal|".TEMP"
argument_list|)
argument_list|)
expr_stmt|;
name|L_CLR
argument_list|(
operator|&
name|old_drift
argument_list|)
expr_stmt|;
comment|/* 		 * Open drift file and read frequency and mode. 		 */
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|stats_drift_file
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|ENOENT
condition|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"can't open %s: %m"
argument_list|,
name|stats_drift_file
argument_list|)
expr_stmt|;
name|loop_config
argument_list|(
name|LOOP_DRIFTCOMP
argument_list|,
operator|&
name|old_drift
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|fscanf
argument_list|(
name|fp
argument_list|,
literal|"%s %x"
argument_list|,
name|buf
argument_list|,
operator|&
name|temp
argument_list|)
operator|==
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"can't read %s: %m"
argument_list|,
name|stats_drift_file
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|loop_config
argument_list|(
name|LOOP_DRIFTCOMP
argument_list|,
operator|&
name|old_drift
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|atolfp
argument_list|(
name|buf
argument_list|,
operator|&
name|old_drift
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"drift value %s invalid"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
block|}
name|loop_config
argument_list|(
name|LOOP_DRIFTCOMP
argument_list|,
operator|&
name|old_drift
argument_list|,
name|temp
argument_list|)
expr_stmt|;
break|break;
case|case
name|STATS_STATSDIR
case|:
if|if
condition|(
name|strlen
argument_list|(
name|value
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|statsdir
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"value for statsdir too long (>%d, sigh)"
argument_list|,
sizeof|sizeof
argument_list|(
name|statsdir
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|l_fp
name|now
decl_stmt|;
name|gettstamp
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|statsdir
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|peerstats
operator|.
name|prefix
operator|==
operator|&
name|statsdir
index|[
literal|0
index|]
operator|&&
name|peerstats
operator|.
name|fp
operator|!=
name|NULL
condition|)
block|{
name|fclose
argument_list|(
name|peerstats
operator|.
name|fp
argument_list|)
expr_stmt|;
name|peerstats
operator|.
name|fp
operator|=
name|NULL
expr_stmt|;
name|filegen_setup
argument_list|(
operator|&
name|peerstats
argument_list|,
name|now
operator|.
name|l_ui
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|loopstats
operator|.
name|prefix
operator|==
operator|&
name|statsdir
index|[
literal|0
index|]
operator|&&
name|loopstats
operator|.
name|fp
operator|!=
name|NULL
condition|)
block|{
name|fclose
argument_list|(
name|loopstats
operator|.
name|fp
argument_list|)
expr_stmt|;
name|loopstats
operator|.
name|fp
operator|=
name|NULL
expr_stmt|;
name|filegen_setup
argument_list|(
operator|&
name|loopstats
argument_list|,
name|now
operator|.
name|l_ui
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|clockstats
operator|.
name|prefix
operator|==
operator|&
name|statsdir
index|[
literal|0
index|]
operator|&&
name|clockstats
operator|.
name|fp
operator|!=
name|NULL
condition|)
block|{
name|fclose
argument_list|(
name|clockstats
operator|.
name|fp
argument_list|)
expr_stmt|;
name|clockstats
operator|.
name|fp
operator|=
name|NULL
expr_stmt|;
name|filegen_setup
argument_list|(
operator|&
name|clockstats
argument_list|,
name|now
operator|.
name|l_ui
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|STATS_PID_FILE
case|:
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|value
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Can't open %s: %m"
argument_list|,
name|value
argument_list|)
expr_stmt|;
break|break;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%d"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
empty_stmt|;
break|break;
default|default:
comment|/* oh well */
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * record_peer_stats - write peer statistics to file  *  * file format:  * day (mjd)  * time (s past midnight)  * peer (ip address)  * peer status word (hex)  * peer offset (s)  * peer delay (s)  * peer dispersion (s)  */
end_comment

begin_function
name|void
name|record_peer_stats
parameter_list|(
name|addr
parameter_list|,
name|status
parameter_list|,
name|offset
parameter_list|,
name|delay
parameter_list|,
name|dispersion
parameter_list|)
name|struct
name|sockaddr_in
modifier|*
name|addr
decl_stmt|;
name|int
name|status
decl_stmt|;
name|l_fp
modifier|*
name|offset
decl_stmt|;
name|s_fp
name|delay
decl_stmt|;
name|u_fp
name|dispersion
decl_stmt|;
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|u_long
name|day
decl_stmt|,
name|sec
decl_stmt|,
name|msec
decl_stmt|;
if|if
condition|(
operator|!
name|stats_control
condition|)
return|return;
name|GETTIMEOFDAY
argument_list|(
operator|&
name|tv
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|day
operator|=
name|tv
operator|.
name|tv_sec
operator|/
literal|86400
operator|+
name|MJD_1970
expr_stmt|;
name|sec
operator|=
name|tv
operator|.
name|tv_sec
operator|%
literal|86400
expr_stmt|;
name|msec
operator|=
name|tv
operator|.
name|tv_usec
operator|/
literal|1000
expr_stmt|;
name|filegen_setup
argument_list|(
operator|&
name|peerstats
argument_list|,
call|(
name|u_long
call|)
argument_list|(
name|tv
operator|.
name|tv_sec
operator|+
name|JAN_1970
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peerstats
operator|.
name|fp
operator|!=
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|peerstats
operator|.
name|fp
argument_list|,
literal|"%lu %lu.%03lu %s %x %s %s %s\n"
argument_list|,
name|day
argument_list|,
name|sec
argument_list|,
name|msec
argument_list|,
name|ntoa
argument_list|(
name|addr
argument_list|)
argument_list|,
name|status
argument_list|,
name|lfptoa
argument_list|(
name|offset
argument_list|,
literal|6
argument_list|)
argument_list|,
name|fptoa
argument_list|(
name|delay
argument_list|,
literal|5
argument_list|)
argument_list|,
name|ufptoa
argument_list|(
name|dispersion
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|peerstats
operator|.
name|fp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * record_loop_stats - write loop filter statistics to file  *  * file format:  * day (mjd)  * time (s past midnight)  * offset (s)  * frequency (approx ppm)  * time constant (log base 2)  */
end_comment

begin_function
name|void
name|record_loop_stats
parameter_list|(
name|offset
parameter_list|,
name|freq
parameter_list|,
name|poll
parameter_list|)
name|l_fp
modifier|*
name|offset
decl_stmt|;
name|s_fp
name|freq
decl_stmt|;
name|u_char
name|poll
decl_stmt|;
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|u_long
name|day
decl_stmt|,
name|sec
decl_stmt|,
name|msec
decl_stmt|;
if|if
condition|(
operator|!
name|stats_control
condition|)
return|return;
name|GETTIMEOFDAY
argument_list|(
operator|&
name|tv
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|day
operator|=
name|tv
operator|.
name|tv_sec
operator|/
literal|86400
operator|+
name|MJD_1970
expr_stmt|;
name|sec
operator|=
name|tv
operator|.
name|tv_sec
operator|%
literal|86400
expr_stmt|;
name|msec
operator|=
name|tv
operator|.
name|tv_usec
operator|/
literal|1000
expr_stmt|;
name|filegen_setup
argument_list|(
operator|&
name|loopstats
argument_list|,
call|(
name|u_long
call|)
argument_list|(
name|tv
operator|.
name|tv_sec
operator|+
name|JAN_1970
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|loopstats
operator|.
name|fp
operator|!=
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|loopstats
operator|.
name|fp
argument_list|,
literal|"%lu %lu.%03lu %s %s %d\n"
argument_list|,
name|day
argument_list|,
name|sec
argument_list|,
name|msec
argument_list|,
name|lfptoa
argument_list|(
name|offset
argument_list|,
literal|6
argument_list|)
argument_list|,
name|fptoa
argument_list|(
name|freq
argument_list|,
literal|4
argument_list|)
argument_list|,
name|poll
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|loopstats
operator|.
name|fp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * record_clock_stats - write clock statistics to file  *  * file format:  * day (mjd)  * time (s past midnight)  * peer (ip address)  * text message  */
end_comment

begin_function
name|void
name|record_clock_stats
parameter_list|(
name|addr
parameter_list|,
name|text
parameter_list|)
name|struct
name|sockaddr_in
modifier|*
name|addr
decl_stmt|;
name|char
modifier|*
name|text
decl_stmt|;
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|u_long
name|day
decl_stmt|,
name|sec
decl_stmt|,
name|msec
decl_stmt|;
if|if
condition|(
operator|!
name|stats_control
condition|)
return|return;
name|GETTIMEOFDAY
argument_list|(
operator|&
name|tv
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|day
operator|=
name|tv
operator|.
name|tv_sec
operator|/
literal|86400
operator|+
name|MJD_1970
expr_stmt|;
name|sec
operator|=
name|tv
operator|.
name|tv_sec
operator|%
literal|86400
expr_stmt|;
name|msec
operator|=
name|tv
operator|.
name|tv_usec
operator|/
literal|1000
expr_stmt|;
name|filegen_setup
argument_list|(
operator|&
name|clockstats
argument_list|,
call|(
name|u_long
call|)
argument_list|(
name|tv
operator|.
name|tv_sec
operator|+
name|JAN_1970
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|clockstats
operator|.
name|fp
operator|!=
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|clockstats
operator|.
name|fp
argument_list|,
literal|"%lu %lu.%03lu %s %s\n"
argument_list|,
name|day
argument_list|,
name|sec
argument_list|,
name|msec
argument_list|,
name|ntoa
argument_list|(
name|addr
argument_list|)
argument_list|,
name|text
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|clockstats
operator|.
name|fp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * getauthkeys - read the authentication keys from the specified file  */
end_comment

begin_function
name|void
name|getauthkeys
parameter_list|(
name|keyfile
parameter_list|)
name|char
modifier|*
name|keyfile
decl_stmt|;
block|{
name|int
name|len
decl_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|keyfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|key_file_name
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|len
operator|>
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|key_file_name
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|free
argument_list|(
name|key_file_name
argument_list|)
expr_stmt|;
name|key_file_name
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|key_file_name
operator|==
literal|0
condition|)
name|key_file_name
operator|=
name|emalloc
argument_list|(
call|(
name|u_int
call|)
argument_list|(
name|len
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|key_file_name
argument_list|,
name|keyfile
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|authreadkeys
argument_list|(
name|key_file_name
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rereadkeys - read the authentication key file over again.  */
end_comment

begin_function
name|void
name|rereadkeys
parameter_list|()
block|{
if|if
condition|(
name|key_file_name
operator|!=
literal|0
condition|)
name|authreadkeys
argument_list|(
name|key_file_name
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


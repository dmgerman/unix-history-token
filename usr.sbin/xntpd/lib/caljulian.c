begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * caljulian - determine the Julian date from an NTP time.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|"ntp_types.h"
end_include

begin_include
include|#
directive|include
file|"ntp_calendar.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_comment
comment|/*  * calmonthtab - month start offsets from the beginning of a cycle.  */
end_comment

begin_decl_stmt
specifier|static
name|u_short
name|calmonthtab
index|[
literal|12
index|]
init|=
block|{
literal|0
block|,
comment|/* March */
name|MAR
block|,
comment|/* April */
operator|(
name|MAR
operator|+
name|APR
operator|)
block|,
comment|/* May */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|)
block|,
comment|/* June */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|)
block|,
comment|/* July */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|)
block|,
comment|/* August */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|+
name|AUG
operator|)
block|,
comment|/* September */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|+
name|AUG
operator|+
name|SEP
operator|)
block|,
comment|/* October */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|+
name|AUG
operator|+
name|SEP
operator|+
name|OCT
operator|)
block|,
comment|/* November */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|+
name|AUG
operator|+
name|SEP
operator|+
name|OCT
operator|+
name|NOV
operator|)
block|,
comment|/* December */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|+
name|AUG
operator|+
name|SEP
operator|+
name|OCT
operator|+
name|NOV
operator|+
name|DEC
operator|)
block|,
comment|/* January */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|+
name|AUG
operator|+
name|SEP
operator|+
name|OCT
operator|+
name|NOV
operator|+
name|DEC
operator|+
name|JAN
operator|)
block|,
comment|/* February */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * caldaytab - calendar year start day offsets  */
end_comment

begin_decl_stmt
specifier|static
name|u_short
name|caldaytab
index|[
name|YEARSPERCYCLE
index|]
init|=
block|{
operator|(
name|DAYSPERYEAR
operator|-
operator|(
name|JAN
operator|+
name|FEB
operator|)
operator|)
block|,
operator|(
operator|(
name|DAYSPERYEAR
operator|*
literal|2
operator|)
operator|-
operator|(
name|JAN
operator|+
name|FEB
operator|)
operator|)
block|,
operator|(
operator|(
name|DAYSPERYEAR
operator|*
literal|3
operator|)
operator|-
operator|(
name|JAN
operator|+
name|FEB
operator|)
operator|)
block|,
operator|(
operator|(
name|DAYSPERYEAR
operator|*
literal|4
operator|)
operator|-
operator|(
name|JAN
operator|+
name|FEB
operator|)
operator|)
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|caljulian
parameter_list|(
name|ntptime
parameter_list|,
name|jt
parameter_list|)
name|u_long
name|ntptime
decl_stmt|;
specifier|register
name|struct
name|calendar
modifier|*
name|jt
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|u_long
name|nt
decl_stmt|;
specifier|register
name|u_short
name|snt
decl_stmt|;
specifier|register
name|int
name|cyear
decl_stmt|;
comment|/* 	 * Find the start of the cycle this is in. 	 */
name|nt
operator|=
name|ntptime
expr_stmt|;
if|if
condition|(
name|nt
operator|>=
name|MAR1988
condition|)
block|{
name|cyear
operator|=
name|CYCLE22
expr_stmt|;
name|nt
operator|-=
name|MAR1988
expr_stmt|;
block|}
else|else
block|{
name|cyear
operator|=
literal|0
expr_stmt|;
name|nt
operator|-=
name|MAR1900
expr_stmt|;
block|}
while|while
condition|(
name|nt
operator|>=
name|SECSPERCYCLE
condition|)
block|{
name|nt
operator|-=
name|SECSPERCYCLE
expr_stmt|;
name|cyear
operator|++
expr_stmt|;
block|}
comment|/* 	 * Seconds, minutes and hours are too hard to do without 	 * divides, so we don't. 	 */
name|jt
operator|->
name|second
operator|=
name|nt
operator|%
name|SECSPERMIN
expr_stmt|;
name|nt
operator|/=
name|SECSPERMIN
expr_stmt|;
comment|/* nt in minutes */
name|jt
operator|->
name|minute
operator|=
name|nt
operator|%
name|MINSPERHR
expr_stmt|;
name|snt
operator|=
name|nt
operator|/
name|MINSPERHR
expr_stmt|;
comment|/* snt in hours */
name|jt
operator|->
name|hour
operator|=
name|snt
operator|%
name|HRSPERDAY
expr_stmt|;
name|snt
operator|/=
name|HRSPERDAY
expr_stmt|;
comment|/* nt in days */
comment|/* 	 * snt is now the number of days into the cycle, from 0 to 1460. 	 */
name|cyear
operator|<<=
literal|2
expr_stmt|;
if|if
condition|(
name|snt
operator|<
name|caldaytab
index|[
literal|0
index|]
condition|)
block|{
name|jt
operator|->
name|yearday
operator|=
name|snt
operator|+
name|JAN
operator|+
name|FEBLEAP
operator|+
literal|1
expr_stmt|;
comment|/* first year is leap */
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|YEARSPERCYCLE
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|snt
operator|<
name|caldaytab
index|[
name|i
index|]
condition|)
break|break;
name|jt
operator|->
name|yearday
operator|=
name|snt
operator|-
name|caldaytab
index|[
name|i
operator|-
literal|1
index|]
operator|+
literal|1
expr_stmt|;
name|cyear
operator|+=
name|i
expr_stmt|;
block|}
name|jt
operator|->
name|year
operator|=
name|cyear
operator|+
literal|1900
expr_stmt|;
comment|/* 	 * One last task, to compute the month and day.  Normalize snt to 	 * a day within a cycle year. 	 */
while|while
condition|(
name|snt
operator|>=
name|DAYSPERYEAR
condition|)
name|snt
operator|-=
name|DAYSPERYEAR
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|11
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|snt
operator|<
name|calmonthtab
index|[
name|i
operator|+
literal|1
index|]
condition|)
break|break;
if|if
condition|(
name|i
operator|>
literal|9
condition|)
name|jt
operator|->
name|month
operator|=
name|i
operator|-
literal|9
expr_stmt|;
comment|/* January or February */
else|else
name|jt
operator|->
name|month
operator|=
name|i
operator|+
literal|3
expr_stmt|;
comment|/* March through December */
name|jt
operator|->
name|monthday
operator|=
name|snt
operator|-
name|calmonthtab
index|[
name|i
index|]
operator|+
literal|1
expr_stmt|;
block|}
end_function

end_unit


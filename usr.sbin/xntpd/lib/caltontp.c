begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * caltontp - convert a julian date to an NTP time  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|"ntp_types.h"
end_include

begin_include
include|#
directive|include
file|"ntp_calendar.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_comment
comment|/*  * calmonthtab - month start offsets from the beginning of a cycle.  */
end_comment

begin_decl_stmt
specifier|static
name|u_short
name|calmonthtab
index|[
literal|12
index|]
init|=
block|{
literal|0
block|,
comment|/* March */
name|MAR
block|,
comment|/* April */
operator|(
name|MAR
operator|+
name|APR
operator|)
block|,
comment|/* May */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|)
block|,
comment|/* June */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|)
block|,
comment|/* July */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|)
block|,
comment|/* August */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|+
name|AUG
operator|)
block|,
comment|/* September */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|+
name|AUG
operator|+
name|SEP
operator|)
block|,
comment|/* October */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|+
name|AUG
operator|+
name|SEP
operator|+
name|OCT
operator|)
block|,
comment|/* November */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|+
name|AUG
operator|+
name|SEP
operator|+
name|OCT
operator|+
name|NOV
operator|)
block|,
comment|/* December */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|+
name|AUG
operator|+
name|SEP
operator|+
name|OCT
operator|+
name|NOV
operator|+
name|DEC
operator|)
block|,
comment|/* January */
operator|(
name|MAR
operator|+
name|APR
operator|+
name|MAY
operator|+
name|JUN
operator|+
name|JUL
operator|+
name|AUG
operator|+
name|SEP
operator|+
name|OCT
operator|+
name|NOV
operator|+
name|DEC
operator|+
name|JAN
operator|)
block|,
comment|/* February */
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|u_long
name|caltontp
parameter_list|(
name|jt
parameter_list|)
specifier|register
specifier|const
name|struct
name|calendar
modifier|*
name|jt
decl_stmt|;
block|{
specifier|register
name|int
name|cyear
decl_stmt|;
specifier|register
name|int
name|resyear
decl_stmt|;
specifier|register
name|u_long
name|nt
decl_stmt|;
specifier|register
name|int
name|yearday
decl_stmt|;
comment|/* 	 * Find the start of the cycle this is in. 	 */
name|cyear
operator|=
call|(
name|int
call|)
argument_list|(
name|jt
operator|->
name|year
operator|-
literal|1900
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|resyear
operator|=
operator|(
name|jt
operator|->
name|year
operator|-
literal|1900
operator|)
operator|-
operator|(
name|cyear
operator|<<
literal|2
operator|)
expr_stmt|;
name|yearday
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|resyear
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|jt
operator|->
name|yearday
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|jt
operator|->
name|month
operator|==
literal|1
operator|||
name|jt
operator|->
name|month
operator|==
literal|2
condition|)
block|{
name|cyear
operator|--
expr_stmt|;
name|resyear
operator|=
literal|3
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|jt
operator|->
name|yearday
operator|<=
call|(
name|u_short
call|)
argument_list|(
name|JAN
operator|+
name|FEBLEAP
argument_list|)
condition|)
block|{
name|cyear
operator|--
expr_stmt|;
name|resyear
operator|=
literal|3
expr_stmt|;
name|yearday
operator|=
name|calmonthtab
index|[
literal|10
index|]
operator|+
name|jt
operator|->
name|yearday
expr_stmt|;
block|}
else|else
block|{
name|yearday
operator|=
name|jt
operator|->
name|yearday
operator|-
operator|(
name|JAN
operator|+
name|FEBLEAP
operator|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|jt
operator|->
name|yearday
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|jt
operator|->
name|month
operator|==
literal|1
operator|||
name|jt
operator|->
name|month
operator|==
literal|2
condition|)
name|resyear
operator|--
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|jt
operator|->
name|yearday
operator|<=
call|(
name|u_short
call|)
argument_list|(
name|JAN
operator|+
name|FEB
argument_list|)
condition|)
block|{
name|resyear
operator|--
expr_stmt|;
name|yearday
operator|=
name|calmonthtab
index|[
literal|10
index|]
operator|+
name|jt
operator|->
name|yearday
expr_stmt|;
block|}
else|else
block|{
name|yearday
operator|=
name|jt
operator|->
name|yearday
operator|-
operator|(
name|JAN
operator|+
name|FEB
operator|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|yearday
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|jt
operator|->
name|month
operator|>=
literal|3
condition|)
block|{
name|yearday
operator|=
name|calmonthtab
index|[
name|jt
operator|->
name|month
operator|-
literal|3
index|]
operator|+
name|jt
operator|->
name|monthday
expr_stmt|;
block|}
else|else
block|{
name|yearday
operator|=
name|calmonthtab
index|[
name|jt
operator|->
name|month
operator|+
literal|9
index|]
operator|+
name|jt
operator|->
name|monthday
expr_stmt|;
block|}
block|}
name|nt
operator|=
name|TIMESDPERC
argument_list|(
operator|(
name|u_long
operator|)
name|cyear
argument_list|)
expr_stmt|;
while|while
condition|(
name|resyear
operator|--
operator|>
literal|0
condition|)
name|nt
operator|+=
name|DAYSPERYEAR
expr_stmt|;
name|nt
operator|+=
call|(
name|u_long
call|)
argument_list|(
name|yearday
operator|-
literal|1
argument_list|)
expr_stmt|;
name|nt
operator|=
name|TIMES24
argument_list|(
name|nt
argument_list|)
operator|+
operator|(
name|u_long
operator|)
name|jt
operator|->
name|hour
expr_stmt|;
name|nt
operator|=
name|TIMES60
argument_list|(
name|nt
argument_list|)
operator|+
operator|(
name|u_long
operator|)
name|jt
operator|->
name|minute
expr_stmt|;
name|nt
operator|=
name|TIMES60
argument_list|(
name|nt
argument_list|)
operator|+
operator|(
name|u_long
operator|)
name|jt
operator|->
name|second
expr_stmt|;
return|return
name|nt
operator|+
name|MAR1900
return|;
block|}
end_function

end_unit


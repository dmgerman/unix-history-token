begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * auth_parity - set parity on a key/check for odd parity  */
end_comment

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_function
name|int
name|DESauth_parity
parameter_list|(
name|key
parameter_list|)
name|U_LONG
modifier|*
name|key
decl_stmt|;
block|{
name|U_LONG
name|mask
decl_stmt|;
name|int
name|parity_err
decl_stmt|;
name|int
name|bitcount
decl_stmt|;
name|int
name|half
decl_stmt|;
name|int
name|byte
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* 	 * Go through counting bits in each byte.  Check to see if 	 * each parity bit was set correctly.  If not, note the error 	 * and set it right. 	 */
name|parity_err
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|half
operator|=
literal|0
init|;
name|half
operator|<
literal|2
condition|;
name|half
operator|++
control|)
block|{
comment|/* two halves of key */
name|mask
operator|=
literal|0x80000000
expr_stmt|;
for|for
control|(
name|byte
operator|=
literal|0
init|;
name|byte
operator|<
literal|4
condition|;
name|byte
operator|++
control|)
block|{
comment|/* 4 bytes per half */
name|bitcount
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
block|{
comment|/* 7 data bits / byte */
if|if
condition|(
name|key
index|[
name|half
index|]
operator|&
name|mask
condition|)
name|bitcount
operator|++
expr_stmt|;
name|mask
operator|>>=
literal|1
expr_stmt|;
block|}
comment|/* 			 * If bitcount is even, parity must be set.  If 			 * bitcount is odd, parity must be clear. 			 */
if|if
condition|(
operator|(
name|bitcount
operator|&
literal|0x1
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|key
index|[
name|half
index|]
operator|&
name|mask
operator|)
condition|)
block|{
name|parity_err
operator|++
expr_stmt|;
name|key
index|[
name|half
index|]
operator||=
name|mask
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|key
index|[
name|half
index|]
operator|&
name|mask
condition|)
block|{
name|parity_err
operator|++
expr_stmt|;
name|key
index|[
name|half
index|]
operator|&=
operator|~
name|mask
expr_stmt|;
block|}
block|}
name|mask
operator|>>=
literal|1
expr_stmt|;
block|}
block|}
comment|/* 	 * Return the result of the parity check. 	 */
return|return
operator|(
name|parity_err
operator|==
literal|0
operator|)
return|;
block|}
end_function

end_unit


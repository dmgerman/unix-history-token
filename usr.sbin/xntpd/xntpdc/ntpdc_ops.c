begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ntpdc_ops.c,v 3.1 1993/07/06 01:12:02 jbj Exp  * ntpdc_ops.c - subroutines which are called to perform operations by xntpdc  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|"ntpdc.h"
end_include

begin_include
include|#
directive|include
file|"ntp_control.h"
end_include

begin_include
include|#
directive|include
file|"ntp_refclock.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_comment
comment|/*  * Declarations for command handlers in here  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|checkitems
name|P
argument_list|(
operator|(
name|int
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|checkitemsize
name|P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|check1item
name|P
argument_list|(
operator|(
name|int
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|peerlist
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|peers
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|dmpeers
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|dopeers
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|printpeer
name|P
argument_list|(
operator|(
expr|struct
name|info_peer
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showpeer
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|peerstats
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|loopinfo
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|sysinfo
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|sysstats
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|iostats
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|memstats
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|timerstats
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|addpeer
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|addserver
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|broadcast
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|doconfig
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|unconfig
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|set
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|sys_clear
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|doset
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|reslist
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
specifier|restrict
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|unrestrict
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|delrestrict
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|do_restrict
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|monlist
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|monitor
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|reset
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|preset
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|readkeys
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|dodirty
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|dontdirty
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|trustkey
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|untrustkey
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|do_trustkey
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|authinfo
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|traps
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|addtrap
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|clrtrap
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|do_addclr_trap
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|requestkey
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|controlkey
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|do_changekey
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ctlstats
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|leapinfo
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|clockstat
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fudge
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|maxskew
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|clkbug
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|setprecision
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|setselect
name|P
argument_list|(
operator|(
expr|struct
name|parse
operator|*
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Commands we understand.  Ntpdc imports this.  */
end_comment

begin_decl_stmt
name|struct
name|xcmd
name|opcmds
index|[]
init|=
block|{
block|{
literal|"listpeers"
block|,
name|peerlist
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"print list of peers the server knows about"
block|}
block|,
block|{
literal|"peers"
block|,
name|peers
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"print peer summary information"
block|}
block|,
block|{
literal|"dmpeers"
block|,
name|dmpeers
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"print peer summary info the way Dave Mills likes it"
block|}
block|,
block|{
literal|"showpeer"
block|,
name|showpeer
block|,
block|{
name|ADD
block|,
name|OPT
operator||
name|ADD
block|,
name|OPT
operator||
name|ADD
block|,
name|OPT
operator||
name|ADD
block|}
block|,
block|{
literal|"peer_address"
block|,
literal|"peer2_addr"
block|,
literal|"peer3_addr"
block|,
literal|"peer4_addr"
block|}
block|,
literal|"print detailed information for one or more peers"
block|}
block|,
block|{
literal|"pstats"
block|,
name|peerstats
block|,
block|{
name|ADD
block|,
name|OPT
operator||
name|ADD
block|,
name|OPT
operator||
name|ADD
block|,
name|OPT
operator||
name|ADD
block|}
block|,
block|{
literal|"peer_address"
block|,
literal|"peer2_addr"
block|,
literal|"peer3_addr"
block|,
literal|"peer4_addr"
block|}
block|,
literal|"print statistical information for one or more peers"
block|}
block|,
block|{
literal|"loopinfo"
block|,
name|loopinfo
block|,
block|{
name|OPT
operator||
name|STR
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|"oneline|multiline"
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"print loop filter information"
block|}
block|,
block|{
literal|"sysinfo"
block|,
name|sysinfo
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"print local server information"
block|}
block|,
block|{
literal|"sysstats"
block|,
name|sysstats
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"print local server statistics"
block|}
block|,
block|{
literal|"memstats"
block|,
name|memstats
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"print peer memory usage statistics"
block|}
block|,
block|{
literal|"iostats"
block|,
name|iostats
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"print I/O subsystem statistics"
block|}
block|,
block|{
literal|"timerstats"
block|,
name|timerstats
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"print event timer subsystem statistics"
block|}
block|,
block|{
literal|"addpeer"
block|,
name|addpeer
block|,
block|{
name|ADD
block|,
name|OPT
operator||
name|UINT
block|,
name|OPT
operator||
name|UINT
block|,
name|OPT
operator||
name|STR
block|}
block|,
block|{
literal|"addr"
block|,
literal|"keyid"
block|,
literal|"version"
block|,
literal|"minpoll|prefer"
block|}
block|,
literal|"configure a new peer association"
block|}
block|,
block|{
literal|"addserver"
block|,
name|addserver
block|,
block|{
name|ADD
block|,
name|OPT
operator||
name|UINT
block|,
name|OPT
operator||
name|UINT
block|,
name|OPT
operator||
name|STR
block|}
block|,
block|{
literal|"addr"
block|,
literal|"keyid"
block|,
literal|"version"
block|,
literal|"minpoll|prefer"
block|}
block|,
literal|"configure a new server"
block|}
block|,
block|{
literal|"broadcast"
block|,
name|broadcast
block|,
block|{
name|ADD
block|,
name|OPT
operator||
name|UINT
block|,
name|OPT
operator||
name|UINT
block|,
name|OPT
operator||
name|STR
block|}
block|,
block|{
literal|"addr"
block|,
literal|"keyid"
block|,
literal|"version"
block|,
literal|"minpoll"
block|}
block|,
literal|"configure broadcasting time service"
block|}
block|,
block|{
literal|"unconfig"
block|,
name|unconfig
block|,
block|{
name|ADD
block|,
name|OPT
operator||
name|ADD
block|,
name|OPT
operator||
name|ADD
block|,
name|OPT
operator||
name|ADD
block|}
block|,
block|{
literal|"peer_address"
block|,
literal|"peer2_addr"
block|,
literal|"peer3_addr"
block|,
literal|"peer4_addr"
block|}
block|,
literal|"unconfigure existing peer assocations"
block|}
block|,
block|{
literal|"set"
block|,
name|set
block|,
block|{
name|STR
block|,
name|OPT
operator||
name|STR
block|,
name|OPT
operator||
name|STR
block|,
name|OPT
operator||
name|STR
block|}
block|,
block|{
literal|"bclient|auth"
block|,
literal|"..."
block|,
literal|"..."
block|,
literal|"..."
block|}
block|,
literal|"set a system flag (bclient, authenticate)"
block|}
block|,
block|{
literal|"clear"
block|,
name|sys_clear
block|,
block|{
name|STR
block|,
name|OPT
operator||
name|STR
block|,
name|OPT
operator||
name|STR
block|,
name|OPT
operator||
name|STR
block|}
block|,
block|{
literal|"bclient|auth"
block|,
literal|"..."
block|,
literal|"..."
block|,
literal|"..."
block|}
block|,
literal|"clear a system flag (bclient, authenticate)"
block|}
block|,
block|{
literal|"reslist"
block|,
name|reslist
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"print the server's restrict list"
block|}
block|,
block|{
literal|"restrict"
block|,
specifier|restrict
block|,
block|{
name|ADD
block|,
name|ADD
block|,
name|STR
block|,
name|OPT
operator||
name|STR
block|}
block|,
block|{
literal|"address"
block|,
literal|"mask"
block|,
literal|"ntpport|ignore|noserve|notrust|noquery|nomodify|nopeer"
block|,
literal|"..."
block|}
block|,
literal|"create restrict entry/add flags to entry"
block|}
block|,
block|{
literal|"unrestrict"
block|,
name|unrestrict
block|,
block|{
name|ADD
block|,
name|ADD
block|,
name|STR
block|,
name|OPT
operator||
name|STR
block|}
block|,
block|{
literal|"address"
block|,
literal|"mask"
block|,
literal|"ntpport|ignore|noserve|notrust|noquery|nomodify|nopeer"
block|,
literal|"..."
block|}
block|,
literal|"remove flags from a restrict entry"
block|}
block|,
block|{
literal|"delrestrict"
block|,
name|delrestrict
block|,
block|{
name|ADD
block|,
name|ADD
block|,
name|OPT
operator||
name|STR
block|,
name|NO
block|}
block|,
block|{
literal|"address"
block|,
literal|"mask"
block|,
literal|"ntpport"
block|,
literal|""
block|}
block|,
literal|"delete a restrict entry"
block|}
block|,
block|{
literal|"monlist"
block|,
name|monlist
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"print data the server's monitor routines have collected"
block|}
block|,
block|{
literal|"monitor"
block|,
name|monitor
block|,
block|{
name|STR
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|"on|off"
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"turn the server's monitoring facility on or off"
block|}
block|,
block|{
literal|"reset"
block|,
name|reset
block|,
block|{
name|STR
block|,
name|OPT
operator||
name|STR
block|,
name|OPT
operator||
name|STR
block|,
name|OPT
operator||
name|STR
block|}
block|,
block|{
literal|"io|sys|mem|timer|auth|allpeers"
block|,
literal|"..."
block|,
literal|"..."
block|,
literal|"..."
block|}
block|,
literal|"reset various subsystem statistics counters"
block|}
block|,
block|{
literal|"preset"
block|,
name|preset
block|,
block|{
name|ADD
block|,
name|OPT
operator||
name|ADD
block|,
name|OPT
operator||
name|ADD
block|,
name|OPT
operator||
name|ADD
block|}
block|,
block|{
literal|"peer_address"
block|,
literal|"peer2_addr"
block|,
literal|"peer3_addr"
block|,
literal|"peer4_addr"
block|}
block|,
literal|"reset stat counters associated with particular peer(s)"
block|}
block|,
block|{
literal|"readkeys"
block|,
name|readkeys
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"request a reread of the `keys' file and re-init of system keys"
block|}
block|,
block|{
literal|"dodirty"
block|,
name|dodirty
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"placeholder, historical interest only"
block|}
block|,
block|{
literal|"dontdirty"
block|,
name|dontdirty
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"placeholder, historical interest only"
block|}
block|,
block|{
literal|"trustkey"
block|,
name|trustkey
block|,
block|{
name|UINT
block|,
name|OPT
operator||
name|UINT
block|,
name|OPT
operator||
name|UINT
block|,
name|OPT
operator||
name|UINT
block|}
block|,
block|{
literal|"keyid"
block|,
literal|"keyid"
block|,
literal|"keyid"
block|,
literal|"keyid"
block|}
block|,
literal|"add one or more key ID's to the trusted list"
block|}
block|,
block|{
literal|"untrustkey"
block|,
name|untrustkey
block|,
block|{
name|UINT
block|,
name|OPT
operator||
name|UINT
block|,
name|OPT
operator||
name|UINT
block|,
name|OPT
operator||
name|UINT
block|}
block|,
block|{
literal|"keyid"
block|,
literal|"keyid"
block|,
literal|"keyid"
block|,
literal|"keyid"
block|}
block|,
literal|"remove one or more key ID's from the trusted list"
block|}
block|,
block|{
literal|"authinfo"
block|,
name|authinfo
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"obtain information concerning the state of the authentication code"
block|}
block|,
block|{
literal|"traps"
block|,
name|traps
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"obtain information about traps set in server"
block|}
block|,
block|{
literal|"addtrap"
block|,
name|addtrap
block|,
block|{
name|ADD
block|,
name|OPT
operator||
name|UINT
block|,
name|OPT
operator||
name|ADD
block|,
name|NO
block|}
block|,
block|{
literal|"address"
block|,
literal|"port"
block|,
literal|"interface"
block|,
literal|""
block|}
block|,
literal|"configure a trap in the server"
block|}
block|,
block|{
literal|"clrtrap"
block|,
name|clrtrap
block|,
block|{
name|ADD
block|,
name|OPT
operator||
name|UINT
block|,
name|OPT
operator||
name|ADD
block|,
name|NO
block|}
block|,
block|{
literal|"address"
block|,
literal|"port"
block|,
literal|"interface"
block|,
literal|""
block|}
block|,
literal|"remove a trap (configured or otherwise) from the server"
block|}
block|,
block|{
literal|"requestkey"
block|,
name|requestkey
block|,
block|{
name|UINT
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|"keyid"
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"change the keyid the server uses to authenticate requests"
block|}
block|,
block|{
literal|"controlkey"
block|,
name|controlkey
block|,
block|{
name|UINT
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|"keyid"
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"change the keyid the server uses to authenticate control messages"
block|}
block|,
block|{
literal|"ctlstats"
block|,
name|ctlstats
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"obtain packet count statistics from the control module"
block|}
block|,
block|{
literal|"leapinfo"
block|,
name|leapinfo
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"obtain information about the current leap second state"
block|}
block|,
block|{
literal|"clockstat"
block|,
name|clockstat
block|,
block|{
name|ADD
block|,
name|OPT
operator||
name|ADD
block|,
name|OPT
operator||
name|ADD
block|,
name|OPT
operator||
name|ADD
block|}
block|,
block|{
literal|"address"
block|,
literal|"address"
block|,
literal|"address"
block|,
literal|"address"
block|}
block|,
literal|"obtain status information about the specified clock"
block|}
block|,
block|{
literal|"fudge"
block|,
name|fudge
block|,
block|{
name|ADD
block|,
name|STR
block|,
name|STR
block|,
name|NO
block|}
block|,
block|{
literal|"address"
block|,
literal|"time1|time2|val1|val2|flags"
block|,
literal|"value"
block|,
literal|""
block|}
block|,
literal|"set/change one of a clock's fudge factors"
block|}
block|,
block|{
literal|"maxskew"
block|,
name|maxskew
block|,
block|{
name|STR
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|"maximum_skew"
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"set the server's maximum skew parameter"
block|}
block|,
block|{
literal|"clkbug"
block|,
name|clkbug
block|,
block|{
name|ADD
block|,
name|OPT
operator||
name|ADD
block|,
name|OPT
operator||
name|ADD
block|,
name|OPT
operator||
name|ADD
block|}
block|,
block|{
literal|"address"
block|,
literal|"address"
block|,
literal|"address"
block|,
literal|"address"
block|}
block|,
literal|"obtain debugging information from the specified clock"
block|}
block|,
block|{
literal|"setprecision"
block|,
name|setprecision
block|,
block|{
name|INT
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|"sys_precision"
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"set the server's advertised precision"
block|}
block|,
block|{
literal|"setselect"
block|,
name|setselect
block|,
block|{
name|UINT
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|"select_algorithm_number"
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|"change the selection weighting algorithm used by the server"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
block|{
name|NO
block|,
name|NO
block|,
name|NO
block|,
name|NO
block|}
block|,
block|{
literal|""
block|,
literal|""
block|,
literal|""
block|,
literal|""
block|}
block|,
literal|""
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Imported from ntpdc.c  */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|showhostnames
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|debug
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|servent
modifier|*
name|server_entry
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * For quick string comparisons  */
end_comment

begin_define
define|#
directive|define
name|STREQ
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(*(a) == *(b)&& strcmp((a), (b)) == 0)
end_define

begin_comment
comment|/*  * checkitems - utility to print a message if no items were returned  */
end_comment

begin_function
specifier|static
name|int
name|checkitems
parameter_list|(
name|items
parameter_list|,
name|fp
parameter_list|)
name|int
name|items
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
if|if
condition|(
name|items
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"No data returned in response to query\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * checkitemsize - utility to print a message if the item size is wrong  */
end_comment

begin_function
specifier|static
name|int
name|checkitemsize
parameter_list|(
name|itemsize
parameter_list|,
name|expected
parameter_list|)
name|int
name|itemsize
decl_stmt|;
name|int
name|expected
decl_stmt|;
block|{
if|if
condition|(
name|itemsize
operator|!=
name|expected
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"***Incorrect item size returned by remote host (%d should be %d)\n"
argument_list|,
name|itemsize
argument_list|,
name|expected
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * check1item - check to make sure we have exactly one item  */
end_comment

begin_function
specifier|static
name|int
name|check1item
parameter_list|(
name|items
parameter_list|,
name|fp
parameter_list|)
name|int
name|items
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
if|if
condition|(
name|items
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"No data returned in response to query\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|items
operator|>
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Expected one item in response, got %d\n"
argument_list|,
name|items
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * peerlist - get a short list of peers  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|peerlist
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_peer_list
modifier|*
name|plist
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_PEER_LIST
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|plist
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitems
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_peer_list
argument_list|)
argument_list|)
condition|)
return|return;
while|while
condition|(
name|items
operator|>
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%-9s %s\n"
argument_list|,
name|modetoa
argument_list|(
name|plist
operator|->
name|hmode
argument_list|)
argument_list|,
name|nntohost
argument_list|(
name|plist
operator|->
name|address
argument_list|)
argument_list|)
expr_stmt|;
name|plist
operator|++
expr_stmt|;
name|items
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * peers - show peer summary  */
end_comment

begin_function
specifier|static
name|void
name|peers
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|dopeers
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * dmpeers - show peer summary, Dave Mills style  */
end_comment

begin_function
specifier|static
name|void
name|dmpeers
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|dopeers
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * peers - show peer summary  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dopeers
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|,
name|dmstyle
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|dmstyle
decl_stmt|;
block|{
name|struct
name|info_peer_summary
modifier|*
name|plist
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|ntp_poll
decl_stmt|;
name|int
name|res
decl_stmt|;
name|int
name|c
decl_stmt|;
name|l_fp
name|tempts
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_PEER_LIST_SUM
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|plist
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitems
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_peer_summary
argument_list|)
argument_list|)
condition|)
return|return;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     remote           local      st poll reach  delay   offset   disp\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"======================================================================\n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|items
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|dmstyle
condition|)
block|{
if|if
condition|(
name|plist
operator|->
name|flags
operator|&
name|INFO_FLAG_SYSPEER
condition|)
name|c
operator|=
literal|'*'
expr_stmt|;
elseif|else
if|if
condition|(
name|plist
operator|->
name|hmode
operator|==
name|MODE_ACTIVE
condition|)
name|c
operator|=
literal|'+'
expr_stmt|;
elseif|else
if|if
condition|(
name|plist
operator|->
name|hmode
operator|==
name|MODE_PASSIVE
condition|)
name|c
operator|=
literal|'-'
expr_stmt|;
elseif|else
if|if
condition|(
name|plist
operator|->
name|hmode
operator|==
name|MODE_CLIENT
condition|)
name|c
operator|=
literal|'='
expr_stmt|;
elseif|else
if|if
condition|(
name|plist
operator|->
name|hmode
operator|==
name|MODE_BROADCAST
condition|)
name|c
operator|=
literal|'^'
expr_stmt|;
elseif|else
if|if
condition|(
name|plist
operator|->
name|hmode
operator|==
name|MODE_BCLIENT
condition|)
name|c
operator|=
literal|'~'
expr_stmt|;
else|else
name|c
operator|=
literal|' '
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|plist
operator|->
name|flags
operator|&
name|INFO_FLAG_SYSPEER
condition|)
name|c
operator|=
literal|'*'
expr_stmt|;
elseif|else
if|if
condition|(
name|plist
operator|->
name|flags
operator|&
name|INFO_FLAG_SHORTLIST
condition|)
name|c
operator|=
literal|'+'
expr_stmt|;
elseif|else
if|if
condition|(
name|plist
operator|->
name|flags
operator|&
name|INFO_FLAG_SEL_CANDIDATE
condition|)
name|c
operator|=
literal|'.'
expr_stmt|;
else|else
name|c
operator|=
literal|' '
expr_stmt|;
block|}
name|NTOHL_FP
argument_list|(
operator|&
operator|(
name|plist
operator|->
name|offset
operator|)
argument_list|,
operator|&
name|tempts
argument_list|)
expr_stmt|;
name|ntp_poll
operator|=
literal|1
operator|<<
name|max
argument_list|(
name|min3
argument_list|(
name|plist
operator|->
name|ppoll
argument_list|,
name|plist
operator|->
name|hpoll
argument_list|,
name|NTP_MAXPOLL
argument_list|)
argument_list|,
name|NTP_MINPOLL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%c%-15.15s %-15.15s %2d %4d  %3o %7.7s %9.9s %6.6s\n"
argument_list|,
name|c
argument_list|,
name|nntohost
argument_list|(
name|plist
operator|->
name|srcadr
argument_list|)
argument_list|,
name|numtoa
argument_list|(
name|plist
operator|->
name|dstadr
argument_list|)
argument_list|,
name|plist
operator|->
name|stratum
argument_list|,
name|ntp_poll
argument_list|,
name|plist
operator|->
name|reach
argument_list|,
name|fptoa
argument_list|(
name|NTOHS_FP
argument_list|(
name|plist
operator|->
name|delay
argument_list|)
argument_list|,
literal|4
argument_list|)
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|tempts
argument_list|,
literal|6
argument_list|)
argument_list|,
name|ufptoa
argument_list|(
name|NTOHS_FP
argument_list|(
name|plist
operator|->
name|dispersion
argument_list|)
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|plist
operator|++
expr_stmt|;
name|items
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * printpeer - print detail information for a peer  */
end_comment

begin_function
specifier|static
name|void
name|printpeer
parameter_list|(
name|pp
parameter_list|,
name|fp
parameter_list|)
specifier|register
name|struct
name|info_peer
modifier|*
name|pp
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|char
name|junk
index|[
literal|5
index|]
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|l_fp
name|tempts
decl_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"remote %s, local %s\n"
argument_list|,
name|numtoa
argument_list|(
name|pp
operator|->
name|srcadr
argument_list|)
argument_list|,
name|numtoa
argument_list|(
name|pp
operator|->
name|dstadr
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"hmode %s, pmode %s, stratum %d, precision %d\n"
argument_list|,
name|modetoa
argument_list|(
name|pp
operator|->
name|hmode
argument_list|)
argument_list|,
name|modetoa
argument_list|(
name|pp
operator|->
name|pmode
argument_list|)
argument_list|,
name|pp
operator|->
name|stratum
argument_list|,
name|pp
operator|->
name|precision
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|stratum
operator|<=
literal|1
condition|)
block|{
name|junk
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|memmove
argument_list|(
name|junk
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|pp
operator|->
name|refid
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|str
operator|=
name|junk
expr_stmt|;
block|}
else|else
block|{
name|str
operator|=
name|numtoa
argument_list|(
name|pp
operator|->
name|refid
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"leap %c%c, refid [%s], rootdistance %s, rootdispersion %s\n"
argument_list|,
name|pp
operator|->
name|leap
operator|&
literal|0x2
condition|?
literal|'1'
else|:
literal|'0'
argument_list|,
name|pp
operator|->
name|leap
operator|&
literal|0x1
condition|?
literal|'1'
else|:
literal|'0'
argument_list|,
name|str
argument_list|,
name|ufptoa
argument_list|(
name|HTONS_FP
argument_list|(
name|pp
operator|->
name|rootdelay
argument_list|)
argument_list|,
literal|4
argument_list|)
argument_list|,
name|ufptoa
argument_list|(
name|HTONS_FP
argument_list|(
name|pp
operator|->
name|rootdispersion
argument_list|)
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"ppoll %d, hpoll %d, keyid %u, version %d, association %u\n"
argument_list|,
name|pp
operator|->
name|ppoll
argument_list|,
name|pp
operator|->
name|hpoll
argument_list|,
name|pp
operator|->
name|keyid
argument_list|,
name|pp
operator|->
name|version
argument_list|,
name|ntohs
argument_list|(
name|pp
operator|->
name|associd
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"valid %d, reach %03o, unreach %d, trust %03o\n"
argument_list|,
name|pp
operator|->
name|valid
argument_list|,
name|pp
operator|->
name|reach
argument_list|,
name|pp
operator|->
name|unreach
argument_list|,
name|pp
operator|->
name|trust
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"timer %ds, flags"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|timer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" none\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|str
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|INFO_FLAG_SYSPEER
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" system_peer"
argument_list|)
expr_stmt|;
name|str
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|INFO_FLAG_CONFIG
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s configured"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|str
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|INFO_FLAG_MINPOLL
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s minpoll"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|str
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|INFO_FLAG_AUTHENABLE
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s authenable"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|str
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|INFO_FLAG_REFCLOCK
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s reference_clock"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|str
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|INFO_FLAG_PREFER
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s preferred_peer"
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|HTONL_FP
argument_list|(
operator|&
name|pp
operator|->
name|reftime
argument_list|,
operator|&
name|tempts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"reference time:      %s\n"
argument_list|,
name|prettydate
argument_list|(
operator|&
name|tempts
argument_list|)
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|pp
operator|->
name|org
argument_list|,
operator|&
name|tempts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"originate timestamp: %s\n"
argument_list|,
name|prettydate
argument_list|(
operator|&
name|tempts
argument_list|)
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|pp
operator|->
name|rec
argument_list|,
operator|&
name|tempts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"receive timestamp:   %s\n"
argument_list|,
name|prettydate
argument_list|(
operator|&
name|tempts
argument_list|)
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|pp
operator|->
name|xmt
argument_list|,
operator|&
name|tempts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"transmit timestamp:  %s\n"
argument_list|,
name|prettydate
argument_list|(
operator|&
name|tempts
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"filter delay: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NTP_SHIFT
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" %-8.8s"
argument_list|,
name|fptoa
argument_list|(
name|HTONS_FP
argument_list|(
name|pp
operator|->
name|filtdelay
index|[
name|i
index|]
argument_list|)
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|(
name|NTP_SHIFT
operator|>>
literal|1
operator|)
operator|-
literal|1
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n              "
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"filter offset:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NTP_SHIFT
condition|;
name|i
operator|++
control|)
block|{
name|HTONL_FP
argument_list|(
operator|&
name|pp
operator|->
name|filtoffset
index|[
name|i
index|]
argument_list|,
operator|&
name|tempts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" %-8.8s"
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|tempts
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|(
name|NTP_SHIFT
operator|>>
literal|1
operator|)
operator|-
literal|1
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n              "
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"filter order: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NTP_SHIFT
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" %-8d"
argument_list|,
name|pp
operator|->
name|order
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|(
name|NTP_SHIFT
operator|>>
literal|1
operator|)
operator|-
literal|1
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n              "
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"bdelay filter:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NTP_SHIFT
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" %-8.8s"
argument_list|,
name|mfptoa
argument_list|(
literal|0
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|bdelay
index|[
name|i
index|]
argument_list|)
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|(
name|NTP_SHIFT
operator|>>
literal|1
operator|)
operator|-
literal|1
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n              "
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"delay %s, estbdelay %s\n"
argument_list|,
name|fptoa
argument_list|(
name|HTONS_FP
argument_list|(
name|pp
operator|->
name|delay
argument_list|)
argument_list|,
literal|4
argument_list|)
argument_list|,
name|mfptoa
argument_list|(
literal|0
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|estbdelay
argument_list|)
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|pp
operator|->
name|offset
argument_list|,
operator|&
name|tempts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"offset %s, dispersion %s\n"
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|tempts
argument_list|,
literal|6
argument_list|)
argument_list|,
name|ufptoa
argument_list|(
name|HTONS_FP
argument_list|(
name|pp
operator|->
name|dispersion
argument_list|)
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * showpeer - show detailed information for a peer  */
end_comment

begin_function
specifier|static
name|void
name|showpeer
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_peer
modifier|*
name|pp
decl_stmt|;
comment|/* 4 is the maximum number of peers which will fit in a packet */
name|struct
name|info_peer_list
name|plist
index|[
name|min
argument_list|(
name|MAXARGS
argument_list|,
literal|4
argument_list|)
index|]
decl_stmt|;
name|int
name|qitems
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
for|for
control|(
name|qitems
operator|=
literal|0
init|;
name|qitems
operator|<
name|min
argument_list|(
name|pcmd
operator|->
name|nargs
argument_list|,
literal|4
argument_list|)
condition|;
name|qitems
operator|++
control|)
block|{
name|plist
index|[
name|qitems
index|]
operator|.
name|address
operator|=
name|pcmd
operator|->
name|argval
index|[
name|qitems
index|]
operator|.
name|netnum
expr_stmt|;
name|plist
index|[
name|qitems
index|]
operator|.
name|port
operator|=
name|server_entry
operator|->
name|s_port
expr_stmt|;
name|plist
index|[
name|qitems
index|]
operator|.
name|hmode
operator|=
name|plist
index|[
name|qitems
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
block|}
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_PEER_INFO
argument_list|,
literal|0
argument_list|,
name|qitems
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_peer_list
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|plist
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|pp
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitems
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_peer
argument_list|)
argument_list|)
condition|)
return|return;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
condition|)
block|{
name|printpeer
argument_list|(
name|pp
argument_list|,
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|items
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|pp
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * peerstats - return statistics for a peer  */
end_comment

begin_function
specifier|static
name|void
name|peerstats
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_peer_stats
modifier|*
name|pp
decl_stmt|;
comment|/* 4 is the maximum number of peers which will fit in a packet */
name|struct
name|info_peer_list
name|plist
index|[
name|min
argument_list|(
name|MAXARGS
argument_list|,
literal|4
argument_list|)
index|]
decl_stmt|;
name|int
name|qitems
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
for|for
control|(
name|qitems
operator|=
literal|0
init|;
name|qitems
operator|<
name|min
argument_list|(
name|pcmd
operator|->
name|nargs
argument_list|,
literal|4
argument_list|)
condition|;
name|qitems
operator|++
control|)
block|{
name|plist
index|[
name|qitems
index|]
operator|.
name|address
operator|=
name|pcmd
operator|->
name|argval
index|[
name|qitems
index|]
operator|.
name|netnum
expr_stmt|;
name|plist
index|[
name|qitems
index|]
operator|.
name|port
operator|=
name|server_entry
operator|->
name|s_port
expr_stmt|;
name|plist
index|[
name|qitems
index|]
operator|.
name|hmode
operator|=
name|plist
index|[
name|qitems
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
block|}
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_PEER_STATS
argument_list|,
literal|0
argument_list|,
name|qitems
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_peer_list
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|plist
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|pp
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitems
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_peer_stats
argument_list|)
argument_list|)
condition|)
return|return;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"remote host:          %s\n"
argument_list|,
name|nntohost
argument_list|(
name|pp
operator|->
name|srcadr
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"local interface:      %s\n"
argument_list|,
name|numtoa
argument_list|(
name|pp
operator|->
name|dstadr
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"time last received:   %ds\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|timereceived
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"time until next send: %ds\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|timetosend
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"reachability change:  %ds\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|timereachable
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"packets sent:         %d\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|sent
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"packets received:     %d\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|received
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"packets processed:    %d\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|processed
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"bad length packets:   %d\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|badlength
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"bad auth packets:     %d\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|badauth
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"bogus origin packets: %d\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|bogusorg
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"duplicate packets:    %d\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|oldpkt
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"bad delay rejections: %d\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|baddelay
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"select delay rejects: %d\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|seldelay
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"select disp rejects:  %d\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|seldisp
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"select finds broken:  %d\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|selbroken
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"too old for select:   %d\n"
argument_list|,
name|ntohl
argument_list|(
name|pp
operator|->
name|selold
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"sel candidate order:  %d\n"
argument_list|,
operator|(
name|int
operator|)
name|pp
operator|->
name|candidate
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"falseticker order:    %d\n"
argument_list|,
operator|(
name|int
operator|)
name|pp
operator|->
name|falseticker
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"select order:         %d\n"
argument_list|,
operator|(
name|int
operator|)
name|pp
operator|->
name|select
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"select total:         %d\n"
argument_list|,
operator|(
name|int
operator|)
name|pp
operator|->
name|select_total
argument_list|)
expr_stmt|;
if|if
condition|(
name|items
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|pp
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * loopinfo - show loop filter information  */
end_comment

begin_function
specifier|static
name|void
name|loopinfo
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_loop
modifier|*
name|il
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|oneline
init|=
literal|0
decl_stmt|;
name|int
name|res
decl_stmt|;
name|l_fp
name|tempts
decl_stmt|;
if|if
condition|(
name|pcmd
operator|->
name|nargs
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|0
index|]
operator|.
name|string
argument_list|,
literal|"oneline"
argument_list|)
condition|)
name|oneline
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|0
index|]
operator|.
name|string
argument_list|,
literal|"multiline"
argument_list|)
condition|)
name|oneline
operator|=
literal|0
expr_stmt|;
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"How many lines?\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_LOOP_INFO
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|il
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|check1item
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_loop
argument_list|)
argument_list|)
condition|)
return|return;
if|if
condition|(
name|oneline
condition|)
block|{
name|l_fp
name|temp2ts
decl_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|il
operator|->
name|last_offset
argument_list|,
operator|&
name|tempts
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|il
operator|->
name|drift_comp
argument_list|,
operator|&
name|temp2ts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"offset %s, drift %s, compliance %d, timer %d seconds\n"
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|tempts
argument_list|,
literal|7
argument_list|)
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|temp2ts
argument_list|,
literal|7
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|il
operator|->
name|compliance
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|il
operator|->
name|watchdog_timer
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|HTONL_FP
argument_list|(
operator|&
name|il
operator|->
name|last_offset
argument_list|,
operator|&
name|tempts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"offset:     %s seconds\n"
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|tempts
argument_list|,
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|il
operator|->
name|drift_comp
argument_list|,
operator|&
name|tempts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"frequency:  %s seconds\n"
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|tempts
argument_list|,
literal|7
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"compliance: %d seconds\n"
argument_list|,
name|ntohl
argument_list|(
name|il
operator|->
name|compliance
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"timer:      %d seconds\n"
argument_list|,
name|ntohl
argument_list|(
name|il
operator|->
name|watchdog_timer
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * sysinfo - show current system state  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|sysinfo
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_sys
modifier|*
name|is
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|char
name|junk
index|[
literal|5
index|]
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|l_fp
name|tempts
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_SYS_INFO
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|is
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|check1item
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_sys
argument_list|)
argument_list|)
condition|)
return|return;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"system peer:      %s\n"
argument_list|,
name|nntohost
argument_list|(
name|is
operator|->
name|peer
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"system peer mode: %s\n"
argument_list|,
name|modetoa
argument_list|(
name|is
operator|->
name|peer_mode
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"leap indicator:   %c%c\n"
argument_list|,
name|is
operator|->
name|leap
operator|&
literal|0x2
condition|?
literal|'1'
else|:
literal|'0'
argument_list|,
name|is
operator|->
name|leap
operator|&
literal|0x1
condition|?
literal|'1'
else|:
literal|'0'
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"stratum:          %d\n"
argument_list|,
operator|(
name|int
operator|)
name|is
operator|->
name|stratum
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"precision:        %d\n"
argument_list|,
operator|(
name|int
operator|)
name|is
operator|->
name|precision
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"select algorithm: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|is
operator|->
name|selection
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"sync distance:    %s\n"
argument_list|,
name|fptoa
argument_list|(
name|NTOHS_FP
argument_list|(
name|is
operator|->
name|rootdelay
argument_list|)
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"sync dispersion:  %s\n"
argument_list|,
name|ufptoa
argument_list|(
name|NTOHS_FP
argument_list|(
name|is
operator|->
name|rootdispersion
argument_list|)
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is
operator|->
name|stratum
operator|<=
literal|1
condition|)
block|{
name|junk
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|memmove
argument_list|(
name|junk
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|is
operator|->
name|refid
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|str
operator|=
name|junk
expr_stmt|;
block|}
else|else
block|{
name|str
operator|=
name|numtoa
argument_list|(
name|is
operator|->
name|refid
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"reference ID:     [%s]\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|is
operator|->
name|reftime
argument_list|,
operator|&
name|tempts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"reference time:   %s\n"
argument_list|,
name|prettydate
argument_list|(
operator|&
name|tempts
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"system flags:     "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|is
operator|->
name|flags
operator|&
operator|(
name|INFO_FLAG_BCLIENT
operator||
name|INFO_FLAG_AUTHENABLE
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"none\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|is
operator|->
name|flags
operator|&
name|INFO_FLAG_BCLIENT
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"bclient"
argument_list|)
expr_stmt|;
name|res
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|is
operator|->
name|flags
operator|&
name|INFO_FLAG_AUTHENABLE
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%sauthenticate"
argument_list|,
name|res
condition|?
literal|", "
else|:
literal|""
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|HTONL_FP
argument_list|(
operator|&
name|is
operator|->
name|bdelay
argument_list|,
operator|&
name|tempts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"broadcast delay:  %s\n"
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|tempts
argument_list|,
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|is
operator|->
name|authdelay
argument_list|,
operator|&
name|tempts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"encryption delay: %s\n"
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|tempts
argument_list|,
literal|7
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"maximum skew:     %s\n"
argument_list|,
name|ufptoa
argument_list|(
name|NTOHS_FP
argument_list|(
name|is
operator|->
name|maxskew
argument_list|)
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * sysstats - print system statistics  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|sysstats
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_sys_stats
modifier|*
name|ss
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_SYS_STATS
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|check1item
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_sys_stats
argument_list|)
argument_list|)
condition|)
return|return;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"system uptime:          %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ss
operator|->
name|timeup
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"time since reset:       %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ss
operator|->
name|timereset
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"bad stratum in packet:  %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ss
operator|->
name|badstratum
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"old version packets:    %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ss
operator|->
name|oldversionpkt
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"new version packets:    %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ss
operator|->
name|newversionpkt
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"unknown version number: %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ss
operator|->
name|unknownversion
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"bad packet length:      %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ss
operator|->
name|badlength
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"packets processed:      %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ss
operator|->
name|processed
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"bad authentication:     %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ss
operator|->
name|badauth
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"wander hold downs:      %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ss
operator|->
name|wanderhold
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * iostats - print I/O statistics  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|iostats
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_io_stats
modifier|*
name|io
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_IO_STATS
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|check1item
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_io_stats
argument_list|)
argument_list|)
condition|)
return|return;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"time since reset:      %d\n"
argument_list|,
name|ntohl
argument_list|(
name|io
operator|->
name|timereset
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"total receive buffers: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|ntohs
argument_list|(
name|io
operator|->
name|totalrecvbufs
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"free receive buffers:  %d\n"
argument_list|,
operator|(
name|int
operator|)
name|ntohs
argument_list|(
name|io
operator|->
name|freerecvbufs
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"used receive buffers:  %d\n"
argument_list|,
operator|(
name|int
operator|)
name|ntohs
argument_list|(
name|io
operator|->
name|fullrecvbufs
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"low water refills:     %d\n"
argument_list|,
operator|(
name|int
operator|)
name|ntohs
argument_list|(
name|io
operator|->
name|lowwater
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"dropped packets:       %d\n"
argument_list|,
name|ntohl
argument_list|(
name|io
operator|->
name|dropped
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"ignored packets:       %d\n"
argument_list|,
name|ntohl
argument_list|(
name|io
operator|->
name|ignored
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"received packets:      %d\n"
argument_list|,
name|ntohl
argument_list|(
name|io
operator|->
name|received
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"packets sent:          %d\n"
argument_list|,
name|ntohl
argument_list|(
name|io
operator|->
name|sent
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"packets not sent:      %d\n"
argument_list|,
name|ntohl
argument_list|(
name|io
operator|->
name|notsent
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"interrupts handled:    %d\n"
argument_list|,
name|ntohl
argument_list|(
name|io
operator|->
name|interrupts
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"received by interrupt: %d\n"
argument_list|,
name|ntohl
argument_list|(
name|io
operator|->
name|int_received
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * memstats - print peer memory statistics  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|memstats
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_mem_stats
modifier|*
name|mem
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_MEM_STATS
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|mem
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|check1item
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_mem_stats
argument_list|)
argument_list|)
condition|)
return|return;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"time since reset:     %d\n"
argument_list|,
name|ntohl
argument_list|(
name|mem
operator|->
name|timereset
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"total peer memory:    %d\n"
argument_list|,
operator|(
name|int
operator|)
name|ntohs
argument_list|(
name|mem
operator|->
name|totalpeermem
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"free peer memory:     %d\n"
argument_list|,
operator|(
name|int
operator|)
name|ntohs
argument_list|(
name|mem
operator|->
name|freepeermem
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"calls to findpeer:    %d\n"
argument_list|,
name|ntohl
argument_list|(
name|mem
operator|->
name|findpeer_calls
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"new peer allocations: %d\n"
argument_list|,
name|ntohl
argument_list|(
name|mem
operator|->
name|allocations
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"peer demobilizations: %d\n"
argument_list|,
name|ntohl
argument_list|(
name|mem
operator|->
name|demobilizations
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"hash table counts:   "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|HASH_SIZE
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%4d"
argument_list|,
operator|(
name|int
operator|)
name|mem
operator|->
name|hashcount
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|%
literal|8
operator|)
operator|==
literal|7
operator|&&
name|i
operator|!=
operator|(
name|HASH_SIZE
operator|-
literal|1
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n                     "
argument_list|)
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * timerstats - print timer statistics  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|timerstats
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_timer_stats
modifier|*
name|tim
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_TIMER_STATS
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|tim
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|check1item
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_timer_stats
argument_list|)
argument_list|)
condition|)
return|return;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"time since reset:  %d\n"
argument_list|,
name|ntohl
argument_list|(
name|tim
operator|->
name|timereset
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"alarms handled:    %d\n"
argument_list|,
name|ntohl
argument_list|(
name|tim
operator|->
name|alarms
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"alarm overruns:    %d\n"
argument_list|,
name|ntohl
argument_list|(
name|tim
operator|->
name|overflows
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"calls to transmit: %d\n"
argument_list|,
name|ntohl
argument_list|(
name|tim
operator|->
name|xmtcalls
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * addpeer - configure an active mode association  */
end_comment

begin_function
specifier|static
name|void
name|addpeer
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|doconfig
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|MODE_ACTIVE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * addserver - configure a client mode association  */
end_comment

begin_function
specifier|static
name|void
name|addserver
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|doconfig
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|MODE_CLIENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * broadcast - configure a broadcast mode association  */
end_comment

begin_function
specifier|static
name|void
name|broadcast
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|doconfig
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|MODE_BROADCAST
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * config - configure a new peer association  */
end_comment

begin_function
specifier|static
name|void
name|doconfig
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|,
name|mode
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|mode
decl_stmt|;
block|{
name|struct
name|conf_peer
name|cpeer
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|U_LONG
name|keyid
decl_stmt|;
name|u_int
name|version
decl_stmt|;
name|u_int
name|flags
decl_stmt|;
name|int
name|res
decl_stmt|;
name|keyid
operator|=
literal|0
expr_stmt|;
name|version
operator|=
name|NTP_VERSION
expr_stmt|;
name|flags
operator|=
literal|0
expr_stmt|;
name|res
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pcmd
operator|->
name|nargs
operator|>
literal|1
condition|)
block|{
name|keyid
operator|=
name|pcmd
operator|->
name|argval
index|[
literal|1
index|]
operator|.
name|uval
expr_stmt|;
if|if
condition|(
name|keyid
operator|>
literal|0
condition|)
block|{
name|flags
operator||=
name|CONF_FLAG_AUTHENABLE
expr_stmt|;
block|}
if|if
condition|(
name|pcmd
operator|->
name|nargs
operator|>
literal|2
condition|)
block|{
name|version
operator|=
operator|(
name|u_int
operator|)
name|pcmd
operator|->
name|argval
index|[
literal|2
index|]
operator|.
name|uval
expr_stmt|;
if|if
condition|(
name|version
operator|>
name|NTP_VERSION
operator|||
name|version
operator|<
name|NTP_OLDVERSION
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"funny version number %u specified\n"
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|res
operator|++
expr_stmt|;
block|}
name|items
operator|=
literal|3
expr_stmt|;
while|while
condition|(
name|pcmd
operator|->
name|nargs
operator|>
name|items
condition|)
block|{
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
name|items
index|]
operator|.
name|string
argument_list|,
literal|"minpoll"
argument_list|)
condition|)
block|{
name|flags
operator||=
name|CONF_FLAG_MINPOLL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
name|items
index|]
operator|.
name|string
argument_list|,
literal|"prefer"
argument_list|)
condition|)
block|{
name|flags
operator||=
name|CONF_FLAG_PREFER
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"`%s' not understood\n"
argument_list|,
name|pcmd
operator|->
name|argval
index|[
literal|3
index|]
operator|.
name|string
argument_list|)
expr_stmt|;
name|res
operator|++
expr_stmt|;
break|break;
block|}
block|}
name|items
operator|++
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|res
condition|)
return|return;
name|cpeer
operator|.
name|peeraddr
operator|=
name|pcmd
operator|->
name|argval
index|[
literal|0
index|]
operator|.
name|netnum
expr_stmt|;
name|cpeer
operator|.
name|hmode
operator|=
operator|(
name|u_char
operator|)
name|mode
expr_stmt|;
name|cpeer
operator|.
name|keyid
operator|=
name|keyid
expr_stmt|;
name|cpeer
operator|.
name|version
operator|=
operator|(
name|u_char
operator|)
name|version
expr_stmt|;
name|cpeer
operator|.
name|minpoll
operator|=
name|NTP_MINDPOLL
expr_stmt|;
name|cpeer
operator|.
name|maxpoll
operator|=
name|NTP_MAXPOLL
expr_stmt|;
name|cpeer
operator|.
name|flags
operator|=
operator|(
name|u_char
operator|)
name|flags
expr_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_CONFIG
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_peer
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|cpeer
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * unconfig - unconfigure some associations  */
end_comment

begin_function
specifier|static
name|void
name|unconfig
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
comment|/* 8 is the maximum number of peers which will fit in a packet */
name|struct
name|conf_unpeer
name|plist
index|[
name|min
argument_list|(
name|MAXARGS
argument_list|,
literal|8
argument_list|)
index|]
decl_stmt|;
name|int
name|qitems
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|res
decl_stmt|;
for|for
control|(
name|qitems
operator|=
literal|0
init|;
name|qitems
operator|<
name|min
argument_list|(
name|pcmd
operator|->
name|nargs
argument_list|,
literal|8
argument_list|)
condition|;
name|qitems
operator|++
control|)
block|{
name|plist
index|[
name|qitems
index|]
operator|.
name|peeraddr
operator|=
name|pcmd
operator|->
name|argval
index|[
name|qitems
index|]
operator|.
name|netnum
expr_stmt|;
block|}
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_UNCONFIG
argument_list|,
literal|1
argument_list|,
name|qitems
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_unpeer
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|plist
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * set - set some system flags  */
end_comment

begin_function
specifier|static
name|void
name|set
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|doset
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|REQ_SET_SYS_FLAG
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * clear - clear some system flags  */
end_comment

begin_function
specifier|static
name|void
name|sys_clear
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|doset
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|REQ_CLR_SYS_FLAG
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * doset - set/clear system flags  */
end_comment

begin_function
specifier|static
name|void
name|doset
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|,
name|req
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|req
decl_stmt|;
block|{
comment|/* 8 is the maximum number of peers which will fit in a packet */
name|struct
name|conf_sys_flags
name|sys
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|res
decl_stmt|;
name|sys
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|res
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|items
operator|=
literal|0
init|;
name|items
operator|<
name|pcmd
operator|->
name|nargs
condition|;
name|items
operator|++
control|)
block|{
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
name|items
index|]
operator|.
name|string
argument_list|,
literal|"bclient"
argument_list|)
condition|)
name|sys
operator|.
name|flags
operator||=
name|SYS_FLAG_BCLIENT
expr_stmt|;
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
name|items
index|]
operator|.
name|string
argument_list|,
literal|"auth"
argument_list|)
condition|)
name|sys
operator|.
name|flags
operator||=
name|SYS_FLAG_AUTHENTICATE
expr_stmt|;
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"unknown flag %s\n"
argument_list|,
name|pcmd
operator|->
name|argval
index|[
name|items
index|]
operator|.
name|string
argument_list|)
expr_stmt|;
name|res
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|res
operator|||
name|sys
operator|.
name|flags
operator|==
literal|0
condition|)
return|return;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|req
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_sys_flags
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|sys
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * data for printing/interrpreting the restrict flags  */
end_comment

begin_struct
struct|struct
name|resflags
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|bit
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|resflags
name|resflags
index|[]
init|=
block|{
block|{
literal|"ignore"
block|,
name|RES_IGNORE
block|}
block|,
block|{
literal|"noserve"
block|,
name|RES_DONTSERVE
block|}
block|,
block|{
literal|"notrust"
block|,
name|RES_DONTTRUST
block|}
block|,
block|{
literal|"noquery"
block|,
name|RES_NOQUERY
block|}
block|,
block|{
literal|"nomodify"
block|,
name|RES_NOMODIFY
block|}
block|,
block|{
literal|"nopeer"
block|,
name|RES_NOPEER
block|}
block|,
block|{
literal|"notrap"
block|,
name|RES_NOTRAP
block|}
block|,
block|{
literal|"lptrap"
block|,
name|RES_LPTRAP
block|}
block|,
block|{
literal|""
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|resflags
name|resmflags
index|[]
init|=
block|{
block|{
literal|"ntpport"
block|,
name|RESM_NTPONLY
block|}
block|,
block|{
literal|"interface"
block|,
name|RESM_INTERFACE
block|}
block|,
block|{
literal|""
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * reslist - obtain and print the server's restrict list  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|reslist
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_restrict
modifier|*
name|rl
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|char
modifier|*
name|addr
decl_stmt|;
name|char
modifier|*
name|mask
decl_stmt|;
name|struct
name|resflags
modifier|*
name|rf
decl_stmt|;
name|U_LONG
name|count
decl_stmt|;
name|u_short
name|flags
decl_stmt|;
name|u_short
name|mflags
decl_stmt|;
name|char
name|flagstr
index|[
literal|300
index|]
decl_stmt|;
specifier|static
name|char
modifier|*
name|comma
init|=
literal|", "
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_GET_RESTRICT
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|rl
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitems
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_restrict
argument_list|)
argument_list|)
condition|)
return|return;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"   address          mask            count        flags\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"=====================================================================\n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|items
operator|>
literal|0
condition|)
block|{
name|addr
operator|=
name|numtoa
argument_list|(
name|rl
operator|->
name|addr
argument_list|)
expr_stmt|;
name|mask
operator|=
name|numtoa
argument_list|(
name|rl
operator|->
name|mask
argument_list|)
expr_stmt|;
name|count
operator|=
name|ntohl
argument_list|(
name|rl
operator|->
name|count
argument_list|)
expr_stmt|;
name|flags
operator|=
name|ntohs
argument_list|(
name|rl
operator|->
name|flags
argument_list|)
expr_stmt|;
name|mflags
operator|=
name|ntohs
argument_list|(
name|rl
operator|->
name|mflags
argument_list|)
expr_stmt|;
name|flagstr
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|res
operator|=
literal|1
expr_stmt|;
name|rf
operator|=
operator|&
name|resmflags
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
name|rf
operator|->
name|bit
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|mflags
operator|&
name|rf
operator|->
name|bit
condition|)
block|{
if|if
condition|(
operator|!
name|res
condition|)
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|flagstr
argument_list|,
name|comma
argument_list|)
expr_stmt|;
name|res
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|flagstr
argument_list|,
name|rf
operator|->
name|str
argument_list|)
expr_stmt|;
block|}
name|rf
operator|++
expr_stmt|;
block|}
name|rf
operator|=
operator|&
name|resflags
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
name|rf
operator|->
name|bit
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|flags
operator|&
name|rf
operator|->
name|bit
condition|)
block|{
if|if
condition|(
operator|!
name|res
condition|)
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|flagstr
argument_list|,
name|comma
argument_list|)
expr_stmt|;
name|res
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|flagstr
argument_list|,
name|rf
operator|->
name|str
argument_list|)
expr_stmt|;
block|}
name|rf
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|flagstr
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|flagstr
argument_list|,
literal|"none"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%-15.15s %-15.15s %9d  %s\n"
argument_list|,
name|addr
argument_list|,
name|mask
argument_list|,
name|count
argument_list|,
name|flagstr
argument_list|)
expr_stmt|;
name|rl
operator|++
expr_stmt|;
name|items
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * restrict - create/add a set of restrictions  */
end_comment

begin_expr_stmt
specifier|static
name|void
specifier|restrict
operator|(
name|pcmd
operator|,
name|fp
operator|)
expr|struct
name|parse
operator|*
name|pcmd
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|do_restrict
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|REQ_RESADDFLAGS
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * unrestrict - remove restriction flags from existing entry  */
end_comment

begin_function
specifier|static
name|void
name|unrestrict
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|do_restrict
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|REQ_RESSUBFLAGS
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * delrestrict - delete an existing restriction  */
end_comment

begin_function
specifier|static
name|void
name|delrestrict
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|do_restrict
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|REQ_UNRESTRICT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * do_restrict - decode commandline restrictions and make the request  */
end_comment

begin_function
specifier|static
name|void
name|do_restrict
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|,
name|req_code
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|req_code
decl_stmt|;
block|{
name|struct
name|conf_restrict
name|cres
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|U_LONG
name|num
decl_stmt|;
name|U_LONG
name|bit
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|res
decl_stmt|;
name|int
name|err
decl_stmt|;
name|cres
operator|.
name|addr
operator|=
name|pcmd
operator|->
name|argval
index|[
literal|0
index|]
operator|.
name|netnum
expr_stmt|;
name|cres
operator|.
name|mask
operator|=
name|pcmd
operator|->
name|argval
index|[
literal|1
index|]
operator|.
name|netnum
expr_stmt|;
name|cres
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|cres
operator|.
name|mflags
operator|=
literal|0
expr_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|res
operator|=
literal|2
init|;
name|res
operator|<
name|pcmd
operator|->
name|nargs
condition|;
name|res
operator|++
control|)
block|{
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
name|res
index|]
operator|.
name|string
argument_list|,
literal|"ntpport"
argument_list|)
condition|)
block|{
name|cres
operator|.
name|mflags
operator||=
name|RESM_NTPONLY
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|resflags
index|[
name|i
index|]
operator|.
name|bit
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
name|res
index|]
operator|.
name|string
argument_list|,
name|resflags
index|[
name|i
index|]
operator|.
name|str
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|resflags
index|[
name|i
index|]
operator|.
name|bit
operator|!=
literal|0
condition|)
block|{
name|cres
operator|.
name|flags
operator||=
name|resflags
index|[
name|i
index|]
operator|.
name|bit
expr_stmt|;
if|if
condition|(
name|req_code
operator|==
name|REQ_UNRESTRICT
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Flag `%s' inappropriate\n"
argument_list|,
name|resflags
index|[
name|i
index|]
operator|.
name|str
argument_list|)
expr_stmt|;
name|err
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Unknown flag %s\n"
argument_list|,
name|pcmd
operator|->
name|argval
index|[
name|res
index|]
operator|.
name|string
argument_list|)
expr_stmt|;
name|err
operator|++
expr_stmt|;
block|}
block|}
block|}
comment|/* 	 * Make sure mask for default address is zero.  Otherwise, 	 * make sure mask bits are contiguous. 	 */
if|if
condition|(
name|cres
operator|.
name|addr
operator|==
literal|0
condition|)
block|{
name|cres
operator|.
name|mask
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|num
operator|=
name|ntohl
argument_list|(
name|cres
operator|.
name|mask
argument_list|)
expr_stmt|;
for|for
control|(
name|bit
operator|=
literal|0x80000000
init|;
name|bit
operator|!=
literal|0
condition|;
name|bit
operator|>>=
literal|1
control|)
if|if
condition|(
operator|(
name|num
operator|&
name|bit
operator|)
operator|==
literal|0
condition|)
break|break;
for|for
control|(
init|;
name|bit
operator|!=
literal|0
condition|;
name|bit
operator|>>=
literal|1
control|)
if|if
condition|(
operator|(
name|num
operator|&
name|bit
operator|)
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
name|bit
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Invalid mask %s\n"
argument_list|,
name|numtoa
argument_list|(
name|cres
operator|.
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|err
condition|)
return|return;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|req_code
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_restrict
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|cres
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * monlist - obtain and print the server's monitor data  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|monlist
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_monitor
modifier|*
name|ml
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_MON_GETLIST
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|ml
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitems
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_monitor
argument_list|)
argument_list|)
condition|)
return|return;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     address          port     count  mode version lasttime firsttime\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"=====================================================================\n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|items
operator|>
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%-20.20s %5d %9d %4d   %3d %9u %9u\n"
argument_list|,
name|nntohost
argument_list|(
name|ml
operator|->
name|addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|ml
operator|->
name|port
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|ml
operator|->
name|count
argument_list|)
argument_list|,
name|ml
operator|->
name|mode
argument_list|,
name|ml
operator|->
name|version
argument_list|,
name|ntohl
argument_list|(
name|ml
operator|->
name|lasttime
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|ml
operator|->
name|firsttime
argument_list|)
argument_list|)
expr_stmt|;
name|ml
operator|++
expr_stmt|;
name|items
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * monitor - turn the server's monitor facility on or off  */
end_comment

begin_function
specifier|static
name|void
name|monitor
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|req_code
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|0
index|]
operator|.
name|string
argument_list|,
literal|"on"
argument_list|)
condition|)
name|req_code
operator|=
name|REQ_MONITOR
expr_stmt|;
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|0
index|]
operator|.
name|string
argument_list|,
literal|"off"
argument_list|)
condition|)
name|req_code
operator|=
name|REQ_NOMONITOR
expr_stmt|;
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"monitor what?\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|req_code
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Mapping between command line strings and stat reset flags  */
end_comment

begin_struct
struct|struct
name|statreset
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|flag
decl_stmt|;
block|}
name|sreset
index|[]
init|=
block|{
block|{
literal|"io"
block|,
name|RESET_FLAG_IO
block|}
block|,
block|{
literal|"sys"
block|,
name|RESET_FLAG_SYS
block|}
block|,
block|{
literal|"mem"
block|,
name|RESET_FLAG_MEM
block|}
block|,
block|{
literal|"timer"
block|,
name|RESET_FLAG_TIMER
block|}
block|,
block|{
literal|"auth"
block|,
name|RESET_FLAG_AUTH
block|}
block|,
block|{
literal|"allpeers"
block|,
name|RESET_FLAG_ALLPEERS
block|}
block|,
block|{
literal|""
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_comment
comment|/*  * reset - reset statistic counters  */
end_comment

begin_function
specifier|static
name|void
name|reset
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|reset_flags
name|rflags
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|res
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|rflags
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|res
operator|=
literal|0
init|;
name|res
operator|<
name|pcmd
operator|->
name|nargs
condition|;
name|res
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|sreset
index|[
name|i
index|]
operator|.
name|flag
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
name|res
index|]
operator|.
name|string
argument_list|,
name|sreset
index|[
name|i
index|]
operator|.
name|str
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|sreset
index|[
name|i
index|]
operator|.
name|flag
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Flag `%s' unknown\n"
argument_list|,
name|pcmd
operator|->
name|argval
index|[
name|res
index|]
operator|.
name|string
argument_list|)
expr_stmt|;
name|err
operator|++
expr_stmt|;
block|}
else|else
block|{
name|rflags
operator|.
name|flags
operator||=
name|sreset
index|[
name|i
index|]
operator|.
name|flag
expr_stmt|;
block|}
block|}
if|if
condition|(
name|err
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Not done due to errors\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_RESET_STATS
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|reset_flags
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|rflags
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * preset - reset stat counters for particular peers  */
end_comment

begin_function
specifier|static
name|void
name|preset
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
comment|/* 8 is the maximum number of peers which will fit in a packet */
name|struct
name|conf_unpeer
name|plist
index|[
name|min
argument_list|(
name|MAXARGS
argument_list|,
literal|8
argument_list|)
index|]
decl_stmt|;
name|int
name|qitems
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|res
decl_stmt|;
for|for
control|(
name|qitems
operator|=
literal|0
init|;
name|qitems
operator|<
name|min
argument_list|(
name|pcmd
operator|->
name|nargs
argument_list|,
literal|8
argument_list|)
condition|;
name|qitems
operator|++
control|)
block|{
name|plist
index|[
name|qitems
index|]
operator|.
name|peeraddr
operator|=
name|pcmd
operator|->
name|argval
index|[
name|qitems
index|]
operator|.
name|netnum
expr_stmt|;
block|}
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_RESET_PEER
argument_list|,
literal|1
argument_list|,
name|qitems
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_unpeer
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|plist
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * readkeys - request the server to reread the keys file  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|readkeys
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_REREAD_KEYS
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * dodirty - request the server to do something dirty  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dodirty
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_DO_DIRTY_HACK
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * dontdirty - request the server to not do something dirty  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dontdirty
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_DONT_DIRTY_HACK
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * trustkey - add some keys to the trusted key list  */
end_comment

begin_function
specifier|static
name|void
name|trustkey
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|do_trustkey
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|REQ_TRUSTKEY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * untrustkey - remove some keys from the trusted key list  */
end_comment

begin_function
specifier|static
name|void
name|untrustkey
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|do_trustkey
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|REQ_UNTRUSTKEY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * do_trustkey - do grunge work of adding/deleting keys  */
end_comment

begin_function
specifier|static
name|void
name|do_trustkey
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|,
name|req
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|req
decl_stmt|;
block|{
name|U_LONG
name|keyids
index|[
name|MAXARGS
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|ritems
decl_stmt|;
name|int
name|res
decl_stmt|;
name|ritems
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pcmd
operator|->
name|nargs
condition|;
name|i
operator|++
control|)
block|{
name|keyids
index|[
name|ritems
operator|++
index|]
operator|=
name|pcmd
operator|->
name|argval
index|[
name|i
index|]
operator|.
name|uval
expr_stmt|;
block|}
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|req
argument_list|,
literal|1
argument_list|,
name|ritems
argument_list|,
sizeof|sizeof
argument_list|(
name|U_LONG
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|keyids
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * authinfo - obtain and print info about authentication  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|authinfo
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_auth
modifier|*
name|ia
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_AUTHINFO
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|ia
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|check1item
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_auth
argument_list|)
argument_list|)
condition|)
return|return;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"time since reset:       %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ia
operator|->
name|timereset
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"key lookups:            %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ia
operator|->
name|keylookups
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"keys not found:         %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ia
operator|->
name|keynotfound
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"encryptions:            %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ia
operator|->
name|encryptions
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"decryptions:            %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ia
operator|->
name|decryptions
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"successful decryptions: %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ia
operator|->
name|decryptions
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"uncached keys:          %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ia
operator|->
name|keyuncached
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * traps - obtain and print a list of traps  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|traps
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|struct
name|info_trap
modifier|*
name|it
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_TRAPS
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|it
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitems
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_trap
argument_list|)
argument_list|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|items
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"address %s, port %d\n"
argument_list|,
name|numtoa
argument_list|(
name|it
operator|->
name|trap_address
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|it
operator|->
name|trap_port
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"interface: %s, "
argument_list|,
name|it
operator|->
name|local_address
operator|==
literal|0
condition|?
literal|"wildcard"
else|:
name|numtoa
argument_list|(
name|it
operator|->
name|local_address
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|htonl
argument_list|(
name|it
operator|->
name|flags
argument_list|)
operator|&
name|TRAP_CONFIGURED
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"configured\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|it
operator|->
name|flags
operator|&
name|TRAP_NONPRIO
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"low priority\n"
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"normal priority\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"set for %d secs, last set %d secs ago\n"
argument_list|,
name|it
operator|->
name|origtime
argument_list|,
name|it
operator|->
name|settime
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"sequence %d, number of resets %d\n"
argument_list|,
name|it
operator|->
name|sequence
argument_list|,
name|it
operator|->
name|resets
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * addtrap - configure a trap  */
end_comment

begin_function
specifier|static
name|void
name|addtrap
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|do_addclr_trap
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|REQ_ADD_TRAP
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * clrtrap - clear a trap from the server  */
end_comment

begin_function
specifier|static
name|void
name|clrtrap
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|do_addclr_trap
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|REQ_CLR_TRAP
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * do_addclr_trap - do grunge work of adding/deleting traps  */
end_comment

begin_function
specifier|static
name|void
name|do_addclr_trap
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|,
name|req
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|req
decl_stmt|;
block|{
name|struct
name|conf_trap
name|ctrap
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|res
decl_stmt|;
name|ctrap
operator|.
name|trap_address
operator|=
name|pcmd
operator|->
name|argval
index|[
literal|0
index|]
operator|.
name|netnum
expr_stmt|;
name|ctrap
operator|.
name|local_address
operator|=
literal|0
expr_stmt|;
name|ctrap
operator|.
name|trap_port
operator|=
name|htons
argument_list|(
name|TRAPPORT
argument_list|)
expr_stmt|;
name|ctrap
operator|.
name|unused
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pcmd
operator|->
name|nargs
operator|>
literal|1
condition|)
block|{
name|ctrap
operator|.
name|trap_port
operator|=
name|htons
argument_list|(
call|(
name|u_short
call|)
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|1
index|]
operator|.
name|uval
operator|&
literal|0xffff
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcmd
operator|->
name|nargs
operator|>
literal|2
condition|)
name|ctrap
operator|.
name|local_address
operator|=
name|pcmd
operator|->
name|argval
index|[
literal|2
index|]
operator|.
name|netnum
expr_stmt|;
block|}
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|req
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_trap
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ctrap
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * requestkey - change the server's request key (a dangerous request)  */
end_comment

begin_function
specifier|static
name|void
name|requestkey
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|do_changekey
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|REQ_REQUEST_KEY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * controlkey - change the server's control key  */
end_comment

begin_function
specifier|static
name|void
name|controlkey
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|do_changekey
argument_list|(
name|pcmd
argument_list|,
name|fp
argument_list|,
name|REQ_CONTROL_KEY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * do_changekey - do grunge work of changing keys  */
end_comment

begin_function
specifier|static
name|void
name|do_changekey
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|,
name|req
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|req
decl_stmt|;
block|{
name|U_LONG
name|key
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|res
decl_stmt|;
name|key
operator|=
name|htonl
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|0
index|]
operator|.
name|uval
argument_list|)
expr_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|req
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|U_LONG
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|key
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * ctlstats - obtain and print info about authentication  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|ctlstats
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_control
modifier|*
name|ic
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_GET_CTLSTATS
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|ic
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|check1item
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_control
argument_list|)
argument_list|)
condition|)
return|return;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"time since reset:       %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|ctltimereset
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"requests received:      %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numctlreq
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"responses sent:         %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numctlresponses
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"fragments sent:         %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numctlfrags
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"async messages sent:    %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numasyncmsgs
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"error msgs sent:        %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numctlerrors
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"total bad pkts:         %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numctlbadpkts
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"packet too short:       %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numctltooshort
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"response on input:      %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numctlinputresp
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"fragment on input:      %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numctlinputfrag
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"error set on input:     %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numctlinputerr
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"bad offset on input:    %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numctlbadoffset
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"bad version packets:    %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numctlbadversion
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"data in pkt too short:  %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numctldatatooshort
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"unknown op codes:       %d\n"
argument_list|,
name|ntohl
argument_list|(
name|ic
operator|->
name|numctlbadop
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Table for human printing leap bits  */
end_comment

begin_decl_stmt
name|char
modifier|*
name|leapbittab
index|[]
init|=
block|{
literal|"00 (no leap second scheduled)"
block|,
literal|"01 (second to be added at end of month)"
block|,
literal|"10 (second to be deleted at end of month)"
block|,
literal|"11 (clock out of sync)"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|controlleapbittab
index|[]
init|=
block|{
literal|"00 (leap controlled by lower stratum)"
block|,
literal|"01 (second to be added at end of month)"
block|,
literal|"10 (second to be deleted at end of month)"
block|,
literal|"11 (lower stratum leap information ignored - no leap)"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * leapinfo - obtain information about the state of the leap second support  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|leapinfo
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|info_leap
modifier|*
name|il
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|l_fp
name|ts
decl_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_GET_LEAPINFO
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|il
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|check1item
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_leap
argument_list|)
argument_list|)
condition|)
return|return;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"sys.leap:       %s\n"
argument_list|,
name|leapbittab
index|[
name|il
operator|->
name|sys_leap
operator|&
name|INFO_LEAP_MASK
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"leap.indicator: %s\n"
argument_list|,
name|controlleapbittab
index|[
name|il
operator|->
name|leap_indicator
operator|&
name|INFO_LEAP_MASK
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"leap.warning:   %s\n"
argument_list|,
name|controlleapbittab
index|[
name|il
operator|->
name|leap_warning
operator|&
name|INFO_LEAP_MASK
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"leap.bits:      %s\n"
argument_list|,
name|leapbittab
index|[
name|il
operator|->
name|leap_bits
operator|&
name|INFO_LEAP_MASK
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|il
operator|->
name|leap_bits
operator|&
name|INFO_LEAP_OVERRIDE
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Leap overide option in effect\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|il
operator|->
name|leap_bits
operator|&
name|INFO_LEAP_SEENSTRATUM1
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Stratum 1 restrictions in effect\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"time to next leap interrupt: %d seconds\n"
argument_list|,
name|ntohl
argument_list|(
name|il
operator|->
name|leap_timer
argument_list|)
argument_list|)
expr_stmt|;
name|gettstamp
argument_list|(
operator|&
name|ts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"date of next leap interrupt: %s\n"
argument_list|,
name|humandate
argument_list|(
name|ts
operator|.
name|l_ui
operator|+
name|ntohl
argument_list|(
name|il
operator|->
name|leap_timer
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"calls to leap process: %u\n"
argument_list|,
name|ntohl
argument_list|(
name|il
operator|->
name|leap_processcalls
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"leap more than month away: %u\n"
argument_list|,
name|ntohl
argument_list|(
name|il
operator|->
name|leap_notclose
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"leap less than month away: %u\n"
argument_list|,
name|ntohl
argument_list|(
name|il
operator|->
name|leap_monthofleap
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"leap less than day away:   %u\n"
argument_list|,
name|ntohl
argument_list|(
name|il
operator|->
name|leap_dayofleap
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"leap in less than 2 hours: %u\n"
argument_list|,
name|ntohl
argument_list|(
name|il
operator|->
name|leap_hoursfromleap
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"leap happened:             %u\n"
argument_list|,
name|ntohl
argument_list|(
name|il
operator|->
name|leap_happened
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * clockstat - get and print clock status information  */
end_comment

begin_function
specifier|static
name|void
name|clockstat
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
specifier|extern
name|struct
name|clktype
name|clktypes
index|[]
decl_stmt|;
name|struct
name|info_clock
modifier|*
name|cl
decl_stmt|;
comment|/* 8 is the maximum number of clocks which will fit in a packet */
name|U_LONG
name|clist
index|[
name|min
argument_list|(
name|MAXARGS
argument_list|,
literal|8
argument_list|)
index|]
decl_stmt|;
name|int
name|qitems
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|l_fp
name|ts
decl_stmt|;
name|struct
name|clktype
modifier|*
name|clk
decl_stmt|;
for|for
control|(
name|qitems
operator|=
literal|0
init|;
name|qitems
operator|<
name|min
argument_list|(
name|pcmd
operator|->
name|nargs
argument_list|,
literal|8
argument_list|)
condition|;
name|qitems
operator|++
control|)
name|clist
index|[
name|qitems
index|]
operator|=
name|pcmd
operator|->
name|argval
index|[
name|qitems
index|]
operator|.
name|netnum
expr_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_GET_CLOCKINFO
argument_list|,
literal|0
argument_list|,
name|qitems
argument_list|,
sizeof|sizeof
argument_list|(
name|U_LONG
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|clist
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|cl
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitems
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_clock
argument_list|)
argument_list|)
condition|)
return|return;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"clock address:        %s\n"
argument_list|,
name|numtoa
argument_list|(
name|cl
operator|->
name|clockadr
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|clk
operator|=
name|clktypes
init|;
name|clk
operator|->
name|code
operator|>=
literal|0
condition|;
name|clk
operator|++
control|)
if|if
condition|(
name|clk
operator|->
name|code
operator|==
name|cl
operator|->
name|type
condition|)
break|break;
if|if
condition|(
name|clk
operator|->
name|code
operator|>=
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"clock type:   %s\n"
argument_list|,
name|clk
operator|->
name|clocktype
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"clock type:   unknown type (%d)\n"
argument_list|,
name|cl
operator|->
name|type
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"last event:           %d\n"
argument_list|,
name|cl
operator|->
name|lastevent
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"current status:       %d\n"
argument_list|,
name|cl
operator|->
name|currentstatus
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"number of polls:      %u\n"
argument_list|,
name|ntohl
argument_list|(
name|cl
operator|->
name|polls
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"no response to poll:  %u\n"
argument_list|,
name|ntohl
argument_list|(
name|cl
operator|->
name|noresponse
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"bad format responses: %u\n"
argument_list|,
name|ntohl
argument_list|(
name|cl
operator|->
name|badformat
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"bad data responses:   %u\n"
argument_list|,
name|ntohl
argument_list|(
name|cl
operator|->
name|baddata
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"running time:         %u\n"
argument_list|,
name|ntohl
argument_list|(
name|cl
operator|->
name|timestarted
argument_list|)
argument_list|)
expr_stmt|;
name|NTOHL_FP
argument_list|(
operator|&
name|cl
operator|->
name|fudgetime1
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"fudge time 1:         %s\n"
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|ts
argument_list|,
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|NTOHL_FP
argument_list|(
operator|&
name|cl
operator|->
name|fudgetime2
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"fudge time 2:         %s\n"
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|ts
argument_list|,
literal|7
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"fudge value 1:        %ld\n"
argument_list|,
name|ntohl
argument_list|(
name|cl
operator|->
name|fudgeval1
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"fudge value 2:        %ld\n"
argument_list|,
name|ntohl
argument_list|(
name|cl
operator|->
name|fudgeval2
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"fudge flags:          0x%x\n"
argument_list|,
name|cl
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|items
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|cl
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * fudge - set clock fudge factors  */
end_comment

begin_function
specifier|static
name|void
name|fudge
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|conf_fudge
name|fudgedata
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|l_fp
name|ts
decl_stmt|;
name|int
name|res
decl_stmt|;
name|LONG
name|val
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fudgedata
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|fudgedata
argument_list|)
expr_stmt|;
name|fudgedata
operator|.
name|clockadr
operator|=
name|pcmd
operator|->
name|argval
index|[
literal|0
index|]
operator|.
name|netnum
expr_stmt|;
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|1
index|]
operator|.
name|string
argument_list|,
literal|"time1"
argument_list|)
condition|)
block|{
name|fudgedata
operator|.
name|which
operator|=
name|htonl
argument_list|(
name|FUDGE_TIME1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|atolfp
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|2
index|]
operator|.
name|string
argument_list|,
operator|&
name|ts
argument_list|)
condition|)
name|err
operator|=
literal|1
expr_stmt|;
else|else
name|HTONL_FP
argument_list|(
operator|&
name|ts
argument_list|,
operator|&
name|fudgedata
operator|.
name|fudgetime
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|1
index|]
operator|.
name|string
argument_list|,
literal|"time2"
argument_list|)
condition|)
block|{
name|fudgedata
operator|.
name|which
operator|=
name|htonl
argument_list|(
name|FUDGE_TIME2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|atolfp
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|2
index|]
operator|.
name|string
argument_list|,
operator|&
name|ts
argument_list|)
condition|)
name|err
operator|=
literal|1
expr_stmt|;
else|else
name|HTONL_FP
argument_list|(
operator|&
name|ts
argument_list|,
operator|&
name|fudgedata
operator|.
name|fudgetime
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|1
index|]
operator|.
name|string
argument_list|,
literal|"val1"
argument_list|)
condition|)
block|{
name|fudgedata
operator|.
name|which
operator|=
name|htonl
argument_list|(
name|FUDGE_VAL1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|atoint
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|2
index|]
operator|.
name|string
argument_list|,
operator|&
name|val
argument_list|)
condition|)
name|err
operator|=
literal|1
expr_stmt|;
else|else
name|fudgedata
operator|.
name|fudgeval_flags
operator|=
name|htonl
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|1
index|]
operator|.
name|string
argument_list|,
literal|"val2"
argument_list|)
condition|)
block|{
name|fudgedata
operator|.
name|which
operator|=
name|htonl
argument_list|(
name|FUDGE_VAL2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|atoint
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|2
index|]
operator|.
name|string
argument_list|,
operator|&
name|val
argument_list|)
condition|)
name|err
operator|=
literal|1
expr_stmt|;
else|else
name|fudgedata
operator|.
name|fudgeval_flags
operator|=
name|htonl
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|STREQ
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|1
index|]
operator|.
name|string
argument_list|,
literal|"flags"
argument_list|)
condition|)
block|{
name|fudgedata
operator|.
name|which
operator|=
name|htonl
argument_list|(
name|FUDGE_FLAGS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|atoint
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|2
index|]
operator|.
name|string
argument_list|,
operator|&
name|val
argument_list|)
condition|)
name|err
operator|=
literal|1
expr_stmt|;
else|else
name|fudgedata
operator|.
name|fudgeval_flags
operator|=
name|htonl
argument_list|(
name|val
operator|&
literal|0xf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"What fudge is `%s'?\n"
argument_list|,
name|pcmd
operator|->
name|argval
index|[
literal|1
index|]
operator|.
name|string
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|err
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't decode the value `%s'\n"
argument_list|,
name|pcmd
operator|->
name|argval
index|[
literal|2
index|]
operator|.
name|string
argument_list|)
expr_stmt|;
return|return;
block|}
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_SET_CLKFUDGE
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_fudge
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|fudgedata
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * maxskew - set the server's maximum skew parameter  */
end_comment

begin_function
specifier|static
name|void
name|maxskew
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|u_fp
name|Xmaxskew
decl_stmt|;
name|l_fp
name|tmp
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
operator|!
name|atolfp
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|0
index|]
operator|.
name|string
argument_list|,
operator|&
name|tmp
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"What the heck does %s mean?\n"
argument_list|,
name|pcmd
operator|->
name|argval
index|[
literal|0
index|]
operator|.
name|string
argument_list|)
expr_stmt|;
return|return;
block|}
name|Xmaxskew
operator|=
name|HTONS_FP
argument_list|(
name|LFPTOFP
argument_list|(
operator|&
name|tmp
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_SET_MAXSKEW
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|u_fp
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|Xmaxskew
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * clkbug - get and print clock debugging information  */
end_comment

begin_function
specifier|static
name|void
name|clkbug
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|U_LONG
name|s
decl_stmt|;
name|struct
name|info_clkbug
modifier|*
name|cl
decl_stmt|;
comment|/* 8 is the maximum number of clocks which will fit in a packet */
name|U_LONG
name|clist
index|[
name|min
argument_list|(
name|MAXARGS
argument_list|,
literal|8
argument_list|)
index|]
decl_stmt|;
name|int
name|qitems
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|int
name|res
decl_stmt|;
name|l_fp
name|ts
decl_stmt|;
for|for
control|(
name|qitems
operator|=
literal|0
init|;
name|qitems
operator|<
name|min
argument_list|(
name|pcmd
operator|->
name|nargs
argument_list|,
literal|8
argument_list|)
condition|;
name|qitems
operator|++
control|)
name|clist
index|[
name|qitems
index|]
operator|=
name|pcmd
operator|->
name|argval
index|[
name|qitems
index|]
operator|.
name|netnum
expr_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_GET_CLKBUGINFO
argument_list|,
literal|0
argument_list|,
name|qitems
argument_list|,
sizeof|sizeof
argument_list|(
name|U_LONG
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|clist
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|cl
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
operator|&&
name|items
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitems
argument_list|(
name|items
argument_list|,
name|fp
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|checkitemsize
argument_list|(
name|itemsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_clkbug
argument_list|)
argument_list|)
condition|)
return|return;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"clock address:        %s\n"
argument_list|,
name|numtoa
argument_list|(
name|cl
operator|->
name|clockadr
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|=
operator|(
name|int
operator|)
name|cl
operator|->
name|nvalues
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"values: %d"
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|s
operator|=
operator|(
name|U_LONG
operator|)
name|ntohs
argument_list|(
name|cl
operator|->
name|svalues
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|NUMCBUGVALUES
condition|)
name|n
operator|=
name|NUMCBUGVALUES
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|i
operator|&
literal|0x3
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%12ld"
argument_list|,
operator|(
name|LONG
operator|)
name|ntohl
argument_list|(
name|cl
operator|->
name|values
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%12lu"
argument_list|,
name|ntohl
argument_list|(
name|cl
operator|->
name|values
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|n
operator|=
operator|(
name|int
operator|)
name|cl
operator|->
name|ntimes
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"times: %d"
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|s
operator|=
name|ntohl
argument_list|(
name|cl
operator|->
name|stimes
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|NUMCBUGTIMES
condition|)
name|n
operator|=
name|NUMCBUGTIMES
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|int
name|needsp
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|i
operator|&
literal|0x1
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
else|else
block|{
for|for
control|(
init|;
name|needsp
operator|>
literal|0
condition|;
name|needsp
operator|--
control|)
name|putc
argument_list|(
literal|' '
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
name|HTONL_FP
argument_list|(
operator|&
name|cl
operator|->
name|times
index|[
name|i
index|]
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%17s"
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|ts
argument_list|,
literal|6
argument_list|)
argument_list|)
expr_stmt|;
name|needsp
operator|=
literal|22
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%37s"
argument_list|,
name|uglydate
argument_list|(
operator|&
name|ts
argument_list|)
argument_list|)
expr_stmt|;
name|needsp
operator|=
literal|2
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|items
operator|>
literal|0
condition|)
block|{
name|cl
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * setprecision - set the server's value of sys.precision  */
end_comment

begin_function
specifier|static
name|void
name|setprecision
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|LONG
name|precision
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|res
decl_stmt|;
name|precision
operator|=
name|htonl
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|0
index|]
operator|.
name|ival
argument_list|)
expr_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_SET_PRECISION
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|LONG
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|precision
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * setselect - change the server's selection algorithm  */
end_comment

begin_function
specifier|static
name|void
name|setselect
parameter_list|(
name|pcmd
parameter_list|,
name|fp
parameter_list|)
name|struct
name|parse
modifier|*
name|pcmd
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|U_LONG
name|select_code
decl_stmt|;
name|int
name|items
decl_stmt|;
name|int
name|itemsize
decl_stmt|;
name|char
modifier|*
name|dummy
decl_stmt|;
name|int
name|res
decl_stmt|;
name|select_code
operator|=
name|htonl
argument_list|(
name|pcmd
operator|->
name|argval
index|[
literal|0
index|]
operator|.
name|uval
argument_list|)
expr_stmt|;
name|res
operator|=
name|doquery
argument_list|(
name|IMPL_XNTPD
argument_list|,
name|REQ_SET_SELECT_CODE
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|U_LONG
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|select_code
argument_list|,
operator|&
name|items
argument_list|,
operator|&
name|itemsize
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"done!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*  * stlstty.c  -- stallion intelligent multiport special options.  *  * Copyright (c) 1996-1998 Greg Ungerer (gerg@stallion.oz.au).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Greg Ungerer.  * 4. Neither the name of the author nor the names of any co-contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/cdk.h>
end_include

begin_comment
comment|/*****************************************************************************/
end_comment

begin_decl_stmt
name|char
modifier|*
name|version
init|=
literal|"2.0.0"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  *	Define some marker flags (to append to pflag values).  */
end_comment

begin_define
define|#
directive|define
name|PFLAG_ON
value|0x40000000
end_define

begin_define
define|#
directive|define
name|PFLAG_OFF
value|0x80000000
end_define

begin_comment
comment|/*  *	List of all options used. Use the option structure even though we  *	don't use getopt!  */
end_comment

begin_struct
struct|struct
name|stloption
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|val
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  *	List of all options used. Use the option structure even though we  *	don't use getopt!  */
end_comment

begin_decl_stmt
name|struct
name|stloption
name|longops
index|[]
init|=
block|{
block|{
literal|"-V"
block|,
literal|'V'
block|}
block|,
block|{
literal|"--version"
block|,
literal|'V'
block|}
block|,
block|{
literal|"-?"
block|,
literal|'h'
block|}
block|,
block|{
literal|"-h"
block|,
literal|'h'
block|}
block|,
block|{
literal|"--help"
block|,
literal|'h'
block|}
block|,
block|{
literal|"maprts"
block|,
operator|(
name|PFLAG_ON
operator||
name|P_MAPRTS
operator|)
block|}
block|,
block|{
literal|"-maprts"
block|,
operator|(
name|PFLAG_OFF
operator||
name|P_MAPRTS
operator|)
block|}
block|,
block|{
literal|"mapcts"
block|,
operator|(
name|PFLAG_ON
operator||
name|P_MAPCTS
operator|)
block|}
block|,
block|{
literal|"-mapcts"
block|,
operator|(
name|PFLAG_OFF
operator||
name|P_MAPCTS
operator|)
block|}
block|,
block|{
literal|"rtslock"
block|,
operator|(
name|PFLAG_ON
operator||
name|P_RTSLOCK
operator|)
block|}
block|,
block|{
literal|"-rtslock"
block|,
operator|(
name|PFLAG_OFF
operator||
name|P_RTSLOCK
operator|)
block|}
block|,
block|{
literal|"ctslock"
block|,
operator|(
name|PFLAG_ON
operator||
name|P_CTSLOCK
operator|)
block|}
block|,
block|{
literal|"-ctslock"
block|,
operator|(
name|PFLAG_OFF
operator||
name|P_CTSLOCK
operator|)
block|}
block|,
block|{
literal|"loopback"
block|,
operator|(
name|PFLAG_ON
operator||
name|P_LOOPBACK
operator|)
block|}
block|,
block|{
literal|"-loopback"
block|,
operator|(
name|PFLAG_OFF
operator||
name|P_LOOPBACK
operator|)
block|}
block|,
block|{
literal|"fakedcd"
block|,
operator|(
name|PFLAG_ON
operator||
name|P_FAKEDCD
operator|)
block|}
block|,
block|{
literal|"-fakedcd"
block|,
operator|(
name|PFLAG_OFF
operator||
name|P_FAKEDCD
operator|)
block|}
block|,
block|{
literal|"dtrfollow"
block|,
operator|(
name|PFLAG_ON
operator||
name|P_DTRFOLLOW
operator|)
block|}
block|,
block|{
literal|"-dtrfollow"
block|,
operator|(
name|PFLAG_OFF
operator||
name|P_DTRFOLLOW
operator|)
block|}
block|,
block|{
literal|"rximin"
block|,
operator|(
name|PFLAG_ON
operator||
name|P_RXIMIN
operator|)
block|}
block|,
block|{
literal|"-rximin"
block|,
operator|(
name|PFLAG_OFF
operator||
name|P_RXIMIN
operator|)
block|}
block|,
block|{
literal|"rxitime"
block|,
operator|(
name|PFLAG_ON
operator||
name|P_RXITIME
operator|)
block|}
block|,
block|{
literal|"-rxitime"
block|,
operator|(
name|PFLAG_OFF
operator||
name|P_RXITIME
operator|)
block|}
block|,
block|{
literal|"rxthold"
block|,
operator|(
name|PFLAG_ON
operator||
name|P_RXTHOLD
operator|)
block|}
block|,
block|{
literal|"-rxthold"
block|,
operator|(
name|PFLAG_OFF
operator||
name|P_RXTHOLD
operator|)
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*  *	Declare internal function prototypes here.  */
end_comment

begin_function_decl
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|usage
parameter_list|()
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: stlstty [OPTION] [ARGS]\n\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  -h, --help            print this information\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  -V, --version         show version information "
literal|"and exit\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  maprts, -maprts       set RTS mapping to DTR "
literal|"on or off\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  mapcts, -mapcts       set CTS mapping to DCD "
literal|"on or off\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  rtslock, -rtslock     set RTS hardware flow "
literal|"on or off\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  ctslock, -ctslock     set CTS hardware flow "
literal|"on or off\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  fakedcd, -fakedcd     set fake DCD on or off\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  dtrfollow, -dtrfollow set DTR data follow "
literal|"on or off\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  loopback, -loopback   set port internal loop back "
literal|"on or off\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  rximin, -rximin       set RX buffer minimum "
literal|"count on or off\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  rxitime, -rxitime     set RX buffer minimum "
literal|"time on or off\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  rxthold, -rxthold     set RX FIFO minimum "
literal|"count on or off\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|void
name|getpflags
parameter_list|()
block|{
name|unsigned
name|long
name|pflags
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
literal|0
argument_list|,
name|STL_GETPFLAG
argument_list|,
operator|&
name|pflags
argument_list|)
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"stdin not a Stallion serial port\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pflags
operator|&
name|P_MAPRTS
condition|)
name|printf
argument_list|(
literal|"maprts "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"-maprts "
argument_list|)
expr_stmt|;
if|if
condition|(
name|pflags
operator|&
name|P_MAPCTS
condition|)
name|printf
argument_list|(
literal|"mapcts "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"-mapcts "
argument_list|)
expr_stmt|;
if|if
condition|(
name|pflags
operator|&
name|P_RTSLOCK
condition|)
name|printf
argument_list|(
literal|"rtslock "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"-rtslock "
argument_list|)
expr_stmt|;
if|if
condition|(
name|pflags
operator|&
name|P_CTSLOCK
condition|)
name|printf
argument_list|(
literal|"ctslock "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"-ctslock "
argument_list|)
expr_stmt|;
if|if
condition|(
name|pflags
operator|&
name|P_FAKEDCD
condition|)
name|printf
argument_list|(
literal|"fakedcd "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"-fakedcd "
argument_list|)
expr_stmt|;
if|if
condition|(
name|pflags
operator|&
name|P_DTRFOLLOW
condition|)
name|printf
argument_list|(
literal|"dtrfollow "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"-dtrfollow "
argument_list|)
expr_stmt|;
if|if
condition|(
name|pflags
operator|&
name|P_LOOPBACK
condition|)
name|printf
argument_list|(
literal|"loopback "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"-loopback "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pflags
operator|&
name|P_RXIMIN
condition|)
name|printf
argument_list|(
literal|"rximin "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"-rximin "
argument_list|)
expr_stmt|;
if|if
condition|(
name|pflags
operator|&
name|P_RXITIME
condition|)
name|printf
argument_list|(
literal|"rxitime "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"-rxitime "
argument_list|)
expr_stmt|;
if|if
condition|(
name|pflags
operator|&
name|P_RXTHOLD
condition|)
name|printf
argument_list|(
literal|"rxthold "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"-rxthold "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|void
name|setpflags
parameter_list|(
name|unsigned
name|long
name|pflagin
parameter_list|,
name|unsigned
name|long
name|pflagout
parameter_list|)
block|{
name|unsigned
name|long
name|pflags
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
literal|0
argument_list|,
name|STL_GETPFLAG
argument_list|,
operator|&
name|pflags
argument_list|)
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"stdin not a Stallion serial port\n"
argument_list|)
expr_stmt|;
name|pflags
operator|&=
operator|~
operator|(
name|pflagout
operator|&
operator|~
name|PFLAG_OFF
operator|)
expr_stmt|;
name|pflags
operator||=
operator|(
name|pflagin
operator|&
operator|~
name|PFLAG_ON
operator|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
literal|0
argument_list|,
name|STL_SETPFLAG
argument_list|,
operator|&
name|pflags
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ioctl(SET_SETPFLAGS) failed"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|unsigned
name|long
name|pflagin
decl_stmt|,
name|pflagout
decl_stmt|;
name|int
name|optind
decl_stmt|,
name|optfound
decl_stmt|;
name|int
name|i
decl_stmt|,
name|val
decl_stmt|;
name|pflagin
operator|=
literal|0
expr_stmt|;
name|pflagout
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|optind
operator|=
literal|1
init|;
operator|(
name|optind
operator|<
name|argc
operator|)
condition|;
name|optind
operator|++
control|)
block|{
name|optfound
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|longops
index|[
name|i
index|]
operator|.
name|name
index|[
literal|0
index|]
operator|!=
literal|0
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
operator|&
operator|(
name|longops
index|[
name|i
index|]
operator|.
name|name
index|[
literal|0
index|]
operator|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val
operator|=
name|longops
index|[
name|i
index|]
operator|.
name|val
expr_stmt|;
name|optfound
operator|++
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|optfound
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid option '%s'\n"
argument_list|,
name|argv
index|[
name|optind
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|val
condition|)
block|{
case|case
literal|'V'
case|:
name|printf
argument_list|(
literal|"stlstats version %s\n"
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|usage
argument_list|()
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|val
operator|&
name|PFLAG_ON
condition|)
block|{
name|pflagin
operator||=
name|val
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|val
operator|&
name|PFLAG_OFF
condition|)
block|{
name|pflagout
operator||=
name|val
expr_stmt|;
block|}
else|else
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown option found, val=%x!\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|pflagin
operator||
name|pflagout
condition|)
name|setpflags
argument_list|(
name|pflagin
argument_list|,
name|pflagout
argument_list|)
expr_stmt|;
else|else
name|getpflags
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

end_unit


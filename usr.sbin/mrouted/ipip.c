begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * The mrouted program is covered by the license in the accompanying file  * named "LICENSE".  Use of the mrouted program represents acceptance of  * the terms and conditions listed in that file.  *  * The mrouted program is COPYRIGHT 1989 by The Board of Trustees of  * Leland Stanford Junior University.  *  *  * ipip.c,v 3.8.4.6 1998/01/06 01:57:45 fenner Exp  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|rcsid
index|[]
init|=
literal|"@(#) $Id: \ ipip.c,v 3.8.4.6 1998/01/06 01:57:45 fenner Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Exported variables.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|notyet
end_ifdef

begin_decl_stmt
name|int
name|raw_socket
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* socket for raw network I/O  */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  *XXX For now, we just use the IGMP socket to send packets.  * This is legal in BSD, because the protocol # is not checked  * on raw sockets.  The k_* interfaces need to gain a socket  * argument so that we can call them on the raw_socket also.  */
end_comment

begin_define
define|#
directive|define
name|raw_socket
value|igmp_socket
end_define

begin_comment
comment|/*  * Private variables.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|rawid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Open and initialize the raw socket.  */
end_comment

begin_function
name|void
name|init_ipip
parameter_list|()
block|{
ifdef|#
directive|ifdef
name|notyet
if|if
condition|(
operator|(
name|raw_socket
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_RAW
argument_list|,
name|IPPROTO_RAW
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"Raw IP socket"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * Allocate and fill in static IP header for encapsulating on a tunnel.  */
end_comment

begin_function
name|void
name|init_ipip_on_vif
parameter_list|(
name|v
parameter_list|)
name|struct
name|uvif
modifier|*
name|v
decl_stmt|;
block|{
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|ip
operator|=
name|v
operator|->
name|uv_encap_hdr
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|==
name|NULL
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|0
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|ip
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
argument_list|)
expr_stmt|;
comment|/*      * Fields zeroed that aren't filled in later:      * - IP ID (let the kernel fill it in)      * - Offset (we don't send fragments)      * - Checksum (let the kernel fill it in)      */
name|ip
operator|->
name|ip_v
operator|=
name|IPVERSION
expr_stmt|;
name|ip
operator|->
name|ip_hl
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|ip
operator|->
name|ip_tos
operator|=
literal|0xc0
expr_stmt|;
comment|/* Internet Control */
name|ip
operator|->
name|ip_ttl
operator|=
name|MAXTTL
expr_stmt|;
comment|/* applies to unicasts only */
name|ip
operator|->
name|ip_p
operator|=
name|IPPROTO_IPIP
expr_stmt|;
name|ip
operator|->
name|ip_src
operator|.
name|s_addr
operator|=
name|v
operator|->
name|uv_lcl_addr
expr_stmt|;
name|ip
operator|->
name|ip_dst
operator|.
name|s_addr
operator|=
name|v
operator|->
name|uv_rmt_addr
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Call build_igmp() to build an IGMP message in the output packet buffer.  * Then fill in the fields of the IP packet that build_igmp() left for the  * kernel to fill in, and encapsulate the original packet with the  * pre-created ip header for this vif.  */
end_comment

begin_function
name|void
name|send_ipip
parameter_list|(
name|src
parameter_list|,
name|dst
parameter_list|,
name|type
parameter_list|,
name|code
parameter_list|,
name|group
parameter_list|,
name|datalen
parameter_list|,
name|v
parameter_list|)
name|u_int32
name|src
decl_stmt|,
name|dst
decl_stmt|;
name|int
name|type
decl_stmt|,
name|code
decl_stmt|;
name|u_int32
name|group
decl_stmt|;
name|int
name|datalen
decl_stmt|;
name|struct
name|uvif
modifier|*
name|v
decl_stmt|;
block|{
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|iov
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|sockaddr_in
name|sdst
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|build_igmp
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|type
argument_list|,
name|code
argument_list|,
name|group
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|send_buf
expr_stmt|;
ifndef|#
directive|ifndef
name|RAW_OUTPUT_IS_RAW
name|ip
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ip
operator|->
name|ip_id
operator|=
name|htons
argument_list|(
name|rawid
operator|++
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
name|inet_cksum
argument_list|(
operator|(
name|u_short
operator|*
operator|)
name|ip
argument_list|,
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
argument_list|)
expr_stmt|;
name|ip
operator|=
name|v
operator|->
name|uv_encap_hdr
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
literal|2
operator|*
name|MIN_IP_HEADER_LEN
operator|+
name|IGMP_MINLEN
operator|+
name|datalen
expr_stmt|;
ifdef|#
directive|ifdef
name|RAW_OUTPUT_IS_RAW
name|ip
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|bzero
argument_list|(
operator|&
name|sdst
argument_list|,
sizeof|sizeof
argument_list|(
name|sdst
argument_list|)
argument_list|)
expr_stmt|;
name|sdst
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SA_LEN
name|sdst
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
name|sdst
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sdst
operator|.
name|sin_addr
operator|=
name|ip
operator|->
name|ip_dst
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
operator|(
name|caddr_t
operator|)
name|v
operator|->
name|uv_encap_hdr
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|caddr_t
operator|)
name|send_buf
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|MIN_IP_HEADER_LEN
operator|+
name|IGMP_MINLEN
operator|+
name|datalen
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|sdst
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
sizeof|sizeof
argument_list|(
name|sdst
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|iov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|sendmsg
argument_list|(
name|raw_socket
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENETDOWN
condition|)
name|check_vif_state
argument_list|()
expr_stmt|;
else|else
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
name|errno
argument_list|,
literal|"sendmsg to %s on %s"
argument_list|,
name|inet_fmt
argument_list|(
name|sdst
operator|.
name|sin_addr
operator|.
name|s_addr
argument_list|,
name|s1
argument_list|)
argument_list|,
name|inet_fmt
argument_list|(
name|src
argument_list|,
name|s2
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|IF_DEBUG
argument_list|(
argument|DEBUG_PKT|igmp_debug_kind(type, code)
argument_list|)
name|log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|0
argument_list|,
literal|"SENT %s from %-15s to %s encaped to %s"
argument_list|,
name|igmp_packet_kind
argument_list|(
name|type
argument_list|,
name|code
argument_list|)
argument_list|,
name|src
operator|==
name|INADDR_ANY
condition|?
literal|"INADDR_ANY"
else|:
name|inet_fmt
argument_list|(
name|src
argument_list|,
name|s1
argument_list|)
argument_list|,
name|inet_fmt
argument_list|(
name|dst
argument_list|,
name|s2
argument_list|)
argument_list|,
name|inet_fmt
argument_list|(
name|sdst
operator|.
name|sin_addr
operator|.
name|s_addr
argument_list|,
name|s3
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


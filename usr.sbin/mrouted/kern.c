begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * The mrouted program is covered by the license in the accompanying file  * named "LICENSE".  Use of the mrouted program represents acceptance of  * the terms and conditions listed in that file.  *  * The mrouted program is COPYRIGHT 1989 by The Board of Trustees of  * Leland Stanford Junior University.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$Id$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_function
name|void
name|k_set_rcvbuf
parameter_list|(
name|bufsize
parameter_list|)
name|int
name|bufsize
decl_stmt|;
block|{
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|bufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|bufsize
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt SO_RCVBUF %u"
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_hdr_include
parameter_list|(
name|bool
parameter_list|)
name|int
name|bool
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|IP_HDRINCL
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_HDRINCL
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|bool
argument_list|,
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt IP_HDRINCL %u"
argument_list|,
name|bool
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|k_set_ttl
parameter_list|(
name|t
parameter_list|)
name|int
name|t
decl_stmt|;
block|{
name|u_char
name|ttl
decl_stmt|;
name|ttl
operator|=
name|t
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_MULTICAST_TTL
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ttl
argument_list|,
sizeof|sizeof
argument_list|(
name|ttl
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt IP_MULTICAST_TTL %u"
argument_list|,
name|ttl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_set_loop
parameter_list|(
name|l
parameter_list|)
name|int
name|l
decl_stmt|;
block|{
name|u_char
name|loop
decl_stmt|;
name|loop
operator|=
name|l
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_MULTICAST_LOOP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|loop
argument_list|,
sizeof|sizeof
argument_list|(
name|loop
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt IP_MULTICAST_LOOP %u"
argument_list|,
name|loop
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_set_if
parameter_list|(
name|ifa
parameter_list|)
name|u_int32
name|ifa
decl_stmt|;
block|{
name|struct
name|in_addr
name|adr
decl_stmt|;
name|adr
operator|.
name|s_addr
operator|=
name|ifa
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_MULTICAST_IF
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|adr
argument_list|,
sizeof|sizeof
argument_list|(
name|adr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt IP_MULTICAST_IF %s"
argument_list|,
name|inet_fmt
argument_list|(
name|ifa
argument_list|,
name|s1
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_join
parameter_list|(
name|grp
parameter_list|,
name|ifa
parameter_list|)
name|u_int32
name|grp
decl_stmt|;
name|u_int32
name|ifa
decl_stmt|;
block|{
name|struct
name|ip_mreq
name|mreq
decl_stmt|;
name|mreq
operator|.
name|imr_multiaddr
operator|.
name|s_addr
operator|=
name|grp
expr_stmt|;
name|mreq
operator|.
name|imr_interface
operator|.
name|s_addr
operator|=
name|ifa
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_ADD_MEMBERSHIP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mreq
argument_list|,
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
name|errno
argument_list|,
literal|"can't join group %s on interface %s"
argument_list|,
name|inet_fmt
argument_list|(
name|grp
argument_list|,
name|s1
argument_list|)
argument_list|,
name|inet_fmt
argument_list|(
name|ifa
argument_list|,
name|s2
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_leave
parameter_list|(
name|grp
parameter_list|,
name|ifa
parameter_list|)
name|u_int32
name|grp
decl_stmt|;
name|u_int32
name|ifa
decl_stmt|;
block|{
name|struct
name|ip_mreq
name|mreq
decl_stmt|;
name|mreq
operator|.
name|imr_multiaddr
operator|.
name|s_addr
operator|=
name|grp
expr_stmt|;
name|mreq
operator|.
name|imr_interface
operator|.
name|s_addr
operator|=
name|ifa
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_DROP_MEMBERSHIP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mreq
argument_list|,
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
name|errno
argument_list|,
literal|"can't leave group %s on interface %s"
argument_list|,
name|inet_fmt
argument_list|(
name|grp
argument_list|,
name|s1
argument_list|)
argument_list|,
name|inet_fmt
argument_list|(
name|ifa
argument_list|,
name|s2
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_init_dvmrp
parameter_list|()
block|{
ifdef|#
directive|ifdef
name|OLD_KERNEL
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|MRT_INIT
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
else|#
directive|else
name|int
name|v
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|MRT_INIT
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|v
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
endif|#
directive|endif
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"can't enable Multicast routing in kernel"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_stop_dvmrp
parameter_list|()
block|{
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|MRT_DONE
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
name|errno
argument_list|,
literal|"can't disable Multicast routing in kernel"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_add_vif
parameter_list|(
name|vifi
parameter_list|,
name|v
parameter_list|)
name|vifi_t
name|vifi
decl_stmt|;
name|struct
name|uvif
modifier|*
name|v
decl_stmt|;
block|{
name|struct
name|vifctl
name|vc
decl_stmt|;
name|vc
operator|.
name|vifc_vifi
operator|=
name|vifi
expr_stmt|;
name|vc
operator|.
name|vifc_flags
operator|=
name|v
operator|->
name|uv_flags
operator|&
name|VIFF_KERNEL_FLAGS
expr_stmt|;
name|vc
operator|.
name|vifc_threshold
operator|=
name|v
operator|->
name|uv_threshold
expr_stmt|;
name|vc
operator|.
name|vifc_rate_limit
operator|=
name|v
operator|->
name|uv_rate_limit
expr_stmt|;
name|vc
operator|.
name|vifc_lcl_addr
operator|.
name|s_addr
operator|=
name|v
operator|->
name|uv_lcl_addr
expr_stmt|;
name|vc
operator|.
name|vifc_rmt_addr
operator|.
name|s_addr
operator|=
name|v
operator|->
name|uv_rmt_addr
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|MRT_ADD_VIF
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|vc
argument_list|,
sizeof|sizeof
argument_list|(
name|vc
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt MRT_ADD_VIF"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_del_vif
parameter_list|(
name|vifi
parameter_list|)
name|vifi_t
name|vifi
decl_stmt|;
block|{
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|MRT_DEL_VIF
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|vifi
argument_list|,
sizeof|sizeof
argument_list|(
name|vifi
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt MRT_DEL_VIF on vif %d"
argument_list|,
name|vifi
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Adds a (source, mcastgrp) entry to the kernel  */
end_comment

begin_function
name|void
name|k_add_rg
parameter_list|(
name|origin
parameter_list|,
name|g
parameter_list|)
name|u_int32
name|origin
decl_stmt|;
name|struct
name|gtable
modifier|*
name|g
decl_stmt|;
block|{
name|struct
name|mfcctl
name|mc
decl_stmt|;
name|vifi_t
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_MFC
name|md_log
argument_list|(
name|MD_ADD
argument_list|,
name|origin
argument_list|,
name|g
operator|->
name|gt_mcastgrp
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* copy table values so that setsockopt can process it */
name|mc
operator|.
name|mfcc_origin
operator|.
name|s_addr
operator|=
name|origin
expr_stmt|;
ifdef|#
directive|ifdef
name|OLD_KERNEL
name|mc
operator|.
name|mfcc_originmask
operator|.
name|s_addr
operator|=
literal|0xffffffff
expr_stmt|;
endif|#
directive|endif
name|mc
operator|.
name|mfcc_mcastgrp
operator|.
name|s_addr
operator|=
name|g
operator|->
name|gt_mcastgrp
expr_stmt|;
name|mc
operator|.
name|mfcc_parent
operator|=
name|g
operator|->
name|gt_route
condition|?
name|g
operator|->
name|gt_route
operator|->
name|rt_parent
else|:
name|NO_VIF
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numvifs
condition|;
name|i
operator|++
control|)
name|mc
operator|.
name|mfcc_ttls
index|[
name|i
index|]
operator|=
name|g
operator|->
name|gt_ttls
index|[
name|i
index|]
expr_stmt|;
comment|/* write to kernel space */
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|MRT_ADD_MFC
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mc
argument_list|,
sizeof|sizeof
argument_list|(
name|mc
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_MFC
name|md_log
argument_list|(
name|MD_ADD_FAIL
argument_list|,
name|origin
argument_list|,
name|g
operator|->
name|gt_mcastgrp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
name|errno
argument_list|,
literal|"setsockopt MRT_ADD_MFC"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Deletes a (source, mcastgrp) entry from the kernel  */
end_comment

begin_function
name|int
name|k_del_rg
parameter_list|(
name|origin
parameter_list|,
name|g
parameter_list|)
name|u_int32
name|origin
decl_stmt|;
name|struct
name|gtable
modifier|*
name|g
decl_stmt|;
block|{
name|struct
name|mfcctl
name|mc
decl_stmt|;
name|int
name|retval
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_MFC
name|md_log
argument_list|(
name|MD_DEL
argument_list|,
name|origin
argument_list|,
name|g
operator|->
name|gt_mcastgrp
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* copy table values so that setsockopt can process it */
name|mc
operator|.
name|mfcc_origin
operator|.
name|s_addr
operator|=
name|origin
expr_stmt|;
ifdef|#
directive|ifdef
name|OLD_KERNEL
name|mc
operator|.
name|mfcc_originmask
operator|.
name|s_addr
operator|=
literal|0xffffffff
expr_stmt|;
endif|#
directive|endif
name|mc
operator|.
name|mfcc_mcastgrp
operator|.
name|s_addr
operator|=
name|g
operator|->
name|gt_mcastgrp
expr_stmt|;
comment|/* write to kernel space */
if|if
condition|(
operator|(
name|retval
operator|=
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|MRT_DEL_MFC
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mc
argument_list|,
sizeof|sizeof
argument_list|(
name|mc
argument_list|)
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_MFC
name|md_log
argument_list|(
name|MD_DEL_FAIL
argument_list|,
name|origin
argument_list|,
name|g
operator|->
name|gt_mcastgrp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
name|errno
argument_list|,
literal|"setsockopt MRT_DEL_MFC"
argument_list|)
expr_stmt|;
block|}
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/*  * Get the kernel's idea of what version of mrouted needs to run with it.  */
end_comment

begin_function
name|int
name|k_get_version
parameter_list|()
block|{
ifdef|#
directive|ifdef
name|OLD_KERNEL
return|return
operator|-
literal|1
return|;
else|#
directive|else
name|int
name|vers
decl_stmt|;
name|int
name|len
init|=
sizeof|sizeof
argument_list|(
name|vers
argument_list|)
decl_stmt|;
if|if
condition|(
name|getsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|MRT_VERSION
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|vers
argument_list|,
operator|&
name|len
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"getsockopt MRT_VERSION: perhaps your kernel is too old"
argument_list|)
expr_stmt|;
return|return
name|vers
return|;
endif|#
directive|endif
block|}
end_function

end_unit


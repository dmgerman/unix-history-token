begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  * ===================================  * HARP  |  Host ATM Research Platform  * ===================================  *  *  * This Host ATM Research Platform ("HARP") file (the "Software") is  * made available by Network Computing Services, Inc. ("NetworkCS")  * "AS IS".  NetworkCS does not provide maintenance, improvements or  * support of any kind.  *  * NETWORKCS MAKES NO WARRANTIES OR REPRESENTATIONS, EXPRESS OR IMPLIED,  * INCLUDING, BUT NOT LIMITED TO, IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS FOR A PARTICULAR PURPOSE, AS TO ANY ELEMENT OF THE  * SOFTWARE OR ANY SUPPORT PROVIDED IN CONNECTION WITH THIS SOFTWARE.  * In no event shall NetworkCS be responsible for any damages, including  * but not limited to consequential damages, arising from or relating to  * any use of the Software or related support.  *  * Copyright 1994-1998 Network Computing Services, Inc.  *  * Copies of this Software may be made, however, the above copyright  * notice must be reproduced on all copies.  *  *	@(#) $FreeBSD$  *  */
end_comment

begin_comment
comment|/*  * Server Cache Synchronization Protocol (SCSP) Support  * ----------------------------------------------------  *  * SCSP-ATMARP server interface: SCSP/ATMARP interface code  *  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|RCSid
init|=
literal|"@(#) $FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netatm/port.h>
end_include

begin_include
include|#
directive|include
file|<netatm/queue.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_if.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sap.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sys.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<netatm/uni/uniip_var.h>
end_include

begin_include
include|#
directive|include
file|<libatm.h>
end_include

begin_include
include|#
directive|include
file|"../scspd/scsp_msg.h"
end_include

begin_include
include|#
directive|include
file|"../scspd/scsp_if.h"
end_include

begin_include
include|#
directive|include
file|"../scspd/scsp_var.h"
end_include

begin_include
include|#
directive|include
file|"atmarp_var.h"
end_include

begin_comment
comment|/*  * Send the cache for a LIS to SCSP  *  *  * Arguments:  *	aip	pointer to interface block  *  * Returns:  *	0	cache sent to SCSP OK  *	errno	reason for failure  *  */
end_comment

begin_function
name|int
name|atmarp_scsp_cache
parameter_list|(
name|aip
parameter_list|,
name|msg
parameter_list|)
name|Atmarp_intf
modifier|*
name|aip
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
name|Atmarp
modifier|*
name|aap
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|smp
init|=
operator|(
name|Scsp_if_msg
operator|*
operator|)
literal|0
decl_stmt|;
name|Scsp_atmarp_msg
modifier|*
name|sap
decl_stmt|;
comment|/* 	 * Figure out how big the message needs to be 	 */
name|len
operator|=
sizeof|sizeof
argument_list|(
name|Scsp_if_msg_hdr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ATMARP_HASHSIZ
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|aap
operator|=
name|aip
operator|->
name|ai_arptbl
index|[
name|i
index|]
init|;
name|aap
condition|;
name|aap
operator|=
name|aap
operator|->
name|aa_next
control|)
block|{
name|len
operator|+=
sizeof|sizeof
argument_list|(
name|Scsp_atmarp_msg
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Get memory for the cache message 	 */
name|smp
operator|=
operator|(
name|Scsp_if_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smp
condition|)
block|{
name|atmarp_mem_err
argument_list|(
literal|"atmarp_scsp_cache: len"
argument_list|)
expr_stmt|;
block|}
name|UM_ZERO
argument_list|(
name|smp
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* 	 * Set header fields in SCSP message 	 */
name|smp
operator|->
name|si_type
operator|=
name|SCSP_CACHE_RSP
expr_stmt|;
name|smp
operator|->
name|si_proto
operator|=
name|SCSP_PROTO_ATMARP
expr_stmt|;
name|smp
operator|->
name|si_len
operator|=
name|len
expr_stmt|;
name|smp
operator|->
name|si_tok
operator|=
name|msg
operator|->
name|si_tok
expr_stmt|;
comment|/* 	 * Loop through the cache, adding each entry to the SCSP 	 * Cache Response message 	 */
name|sap
operator|=
operator|&
name|smp
operator|->
name|si_atmarp
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ATMARP_HASHSIZ
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|aap
operator|=
name|aip
operator|->
name|ai_arptbl
index|[
name|i
index|]
init|;
name|aap
condition|;
name|aap
operator|=
name|aap
operator|->
name|aa_next
control|)
block|{
name|sap
operator|->
name|sa_state
operator|=
name|SCSP_ASTATE_NEW
expr_stmt|;
name|sap
operator|->
name|sa_cpa
operator|=
name|aap
operator|->
name|aa_dstip
expr_stmt|;
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|aap
operator|->
name|aa_dstatm
argument_list|,
operator|&
name|sap
operator|->
name|sa_cha
argument_list|)
expr_stmt|;
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|aap
operator|->
name|aa_dstatmsub
argument_list|,
operator|&
name|sap
operator|->
name|sa_csa
argument_list|)
expr_stmt|;
name|sap
operator|->
name|sa_key
operator|=
name|aap
operator|->
name|aa_key
expr_stmt|;
name|sap
operator|->
name|sa_oid
operator|=
name|aap
operator|->
name|aa_oid
expr_stmt|;
name|sap
operator|->
name|sa_seq
operator|=
name|aap
operator|->
name|aa_seq
expr_stmt|;
name|sap
operator|++
expr_stmt|;
block|}
block|}
comment|/* 	 * Send the message to SCSP 	 */
name|rc
operator|=
name|atmarp_scsp_out
argument_list|(
name|aip
argument_list|,
operator|(
name|char
operator|*
operator|)
name|smp
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* 	 * Free the message 	 */
name|cache_done
label|:
if|if
condition|(
name|smp
condition|)
name|UM_FREE
argument_list|(
name|smp
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Answer a reqeust for information about a cache entry  *  * Arguments:  *	aap	pointer to entry  *	state	entry's new state  *  * Returns:  *	0	success  *	errno	reason for failure  *  */
end_comment

begin_function
name|int
name|atmarp_scsp_solicit
parameter_list|(
name|aip
parameter_list|,
name|smp
parameter_list|)
name|Atmarp_intf
modifier|*
name|aip
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|smp
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
name|Atmarp
modifier|*
name|aap
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|rsp
init|=
operator|(
name|Scsp_if_msg
operator|*
operator|)
literal|0
decl_stmt|;
comment|/* 	 * Search the interface's ATMARP cache for an entry with 	 * the specified cache key and origin ID 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ATMARP_HASHSIZ
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|aap
operator|=
name|aip
operator|->
name|ai_arptbl
index|[
name|i
index|]
init|;
name|aap
condition|;
name|aap
operator|=
name|aap
operator|->
name|aa_next
control|)
block|{
if|if
condition|(
name|KEY_EQUAL
argument_list|(
operator|&
name|aap
operator|->
name|aa_key
argument_list|,
operator|&
name|smp
operator|->
name|si_sum
operator|.
name|ss_key
argument_list|)
operator|&&
name|OID_EQUAL
argument_list|(
operator|&
name|aap
operator|->
name|aa_oid
argument_list|,
operator|&
name|smp
operator|->
name|si_sum
operator|.
name|ss_oid
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|aap
condition|)
break|break;
block|}
comment|/* 	 * Get storage for a Solicit Response 	 */
name|rsp
operator|=
operator|(
name|Scsp_if_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_if_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsp
condition|)
block|{
name|atmarp_mem_err
argument_list|(
literal|"atmarp_scsp_solicit: sizeof(Scsp_if_msg)"
argument_list|)
expr_stmt|;
block|}
name|UM_ZERO
argument_list|(
name|rsp
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_if_msg
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Fill out the Solicit Rsp 	 */
name|rsp
operator|->
name|si_type
operator|=
name|SCSP_SOLICIT_RSP
expr_stmt|;
name|rsp
operator|->
name|si_proto
operator|=
name|smp
operator|->
name|si_proto
expr_stmt|;
name|rsp
operator|->
name|si_tok
operator|=
name|smp
operator|->
name|si_tok
expr_stmt|;
if|if
condition|(
name|aap
condition|)
block|{
comment|/* 		 * Copy fields from the ATMARP entry to the SCSP 		 * Update Request message 		 */
name|rsp
operator|->
name|si_rc
operator|=
name|SCSP_RSP_OK
expr_stmt|;
name|rsp
operator|->
name|si_len
operator|=
sizeof|sizeof
argument_list|(
name|Scsp_if_msg_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|Scsp_atmarp_msg
argument_list|)
expr_stmt|;
name|rsp
operator|->
name|si_atmarp
operator|.
name|sa_state
operator|=
name|SCSP_ASTATE_UPD
expr_stmt|;
name|rsp
operator|->
name|si_atmarp
operator|.
name|sa_cpa
operator|=
name|aap
operator|->
name|aa_dstip
expr_stmt|;
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|aap
operator|->
name|aa_dstatm
argument_list|,
operator|&
name|rsp
operator|->
name|si_atmarp
operator|.
name|sa_cha
argument_list|)
expr_stmt|;
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|aap
operator|->
name|aa_dstatmsub
argument_list|,
operator|&
name|rsp
operator|->
name|si_atmarp
operator|.
name|sa_csa
argument_list|)
expr_stmt|;
name|rsp
operator|->
name|si_atmarp
operator|.
name|sa_key
operator|=
name|aap
operator|->
name|aa_key
expr_stmt|;
name|rsp
operator|->
name|si_atmarp
operator|.
name|sa_oid
operator|=
name|aap
operator|->
name|aa_oid
expr_stmt|;
name|rsp
operator|->
name|si_atmarp
operator|.
name|sa_seq
operator|=
name|aap
operator|->
name|aa_seq
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Entry not found--set return code 		 */
name|rsp
operator|->
name|si_rc
operator|=
name|SCSP_RSP_NOT_FOUND
expr_stmt|;
name|rsp
operator|->
name|si_len
operator|=
name|smp
operator|->
name|si_len
expr_stmt|;
name|rsp
operator|->
name|si_sum
operator|=
name|smp
operator|->
name|si_sum
expr_stmt|;
block|}
comment|/* 	 * Send the message to SCSP 	 */
name|rc
operator|=
name|atmarp_scsp_out
argument_list|(
name|aip
argument_list|,
operator|(
name|char
operator|*
operator|)
name|rsp
argument_list|,
name|rsp
operator|->
name|si_len
argument_list|)
expr_stmt|;
name|UM_FREE
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send a cache update to SCSP  *  * Arguments:  *	aap	pointer to entry  *	state	entry's new state  *  * Returns:  *	0	success  *	errno	reason for failure  *  */
end_comment

begin_function
name|int
name|atmarp_scsp_update
parameter_list|(
name|aap
parameter_list|,
name|state
parameter_list|)
name|Atmarp
modifier|*
name|aap
decl_stmt|;
name|int
name|state
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
name|Atmarp_intf
modifier|*
name|aip
init|=
name|aap
operator|->
name|aa_intf
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|smp
init|=
operator|(
name|Scsp_if_msg
operator|*
operator|)
literal|0
decl_stmt|;
name|Scsp_atmarp_msg
modifier|*
name|sap
decl_stmt|;
comment|/* 	 * Make sure the connection to SCSP is active 	 */
if|if
condition|(
name|aip
operator|->
name|ai_state
operator|==
name|AI_STATE_NULL
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Get memory for the cache message 	 */
name|smp
operator|=
operator|(
name|Scsp_if_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_if_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smp
condition|)
block|{
name|atmarp_mem_err
argument_list|(
literal|"atmarp_scsp_update: sizeof(Scsp_if_msg)"
argument_list|)
expr_stmt|;
block|}
name|UM_ZERO
argument_list|(
name|smp
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_if_msg
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Set header fields in SCSP message 	 */
name|smp
operator|->
name|si_type
operator|=
name|SCSP_UPDATE_REQ
expr_stmt|;
name|smp
operator|->
name|si_proto
operator|=
name|SCSP_PROTO_ATMARP
expr_stmt|;
name|smp
operator|->
name|si_len
operator|=
sizeof|sizeof
argument_list|(
name|Scsp_if_msg_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|Scsp_atmarp_msg
argument_list|)
expr_stmt|;
comment|/* 	 * Copy fields from the ATMARP entry to the SCSP 	 * Update Request message 	 */
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_state
operator|=
name|state
expr_stmt|;
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_cpa
operator|=
name|aap
operator|->
name|aa_dstip
expr_stmt|;
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|aap
operator|->
name|aa_dstatm
argument_list|,
operator|&
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_cha
argument_list|)
expr_stmt|;
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|aap
operator|->
name|aa_dstatmsub
argument_list|,
operator|&
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_csa
argument_list|)
expr_stmt|;
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_key
operator|=
name|aap
operator|->
name|aa_key
expr_stmt|;
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_oid
operator|=
name|aap
operator|->
name|aa_oid
expr_stmt|;
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_seq
operator|=
name|aap
operator|->
name|aa_seq
expr_stmt|;
comment|/* 	 * Send the message to SCSP 	 */
name|rc
operator|=
name|atmarp_scsp_out
argument_list|(
name|aap
operator|->
name|aa_intf
argument_list|,
operator|(
name|char
operator|*
operator|)
name|smp
argument_list|,
name|smp
operator|->
name|si_len
argument_list|)
expr_stmt|;
name|UM_FREE
argument_list|(
name|smp
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Respond to a Cache Update Indication from SCSP  *  *  * Arguments:  *	aip	pointer to interface control block  *	smp	pointer to message from SCSP  *  * Returns:  *	0	Message processed OK  *	errno	Reason for failure  *  */
end_comment

begin_function
name|int
name|atmarp_scsp_update_in
parameter_list|(
name|aip
parameter_list|,
name|smp
parameter_list|)
name|Atmarp_intf
modifier|*
name|aip
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|smp
decl_stmt|;
block|{
name|int
name|accept
decl_stmt|,
name|rc
decl_stmt|;
name|Atmarp
modifier|*
name|aap
decl_stmt|;
comment|/* 	 * Look up the entry 	 */
name|ATMARP_LOOKUP
argument_list|(
name|aip
argument_list|,
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_cpa
operator|.
name|s_addr
argument_list|,
name|aap
argument_list|)
expr_stmt|;
comment|/* 	 * Whether we accept the request depends on whether we 	 * already have an entry for it 	 */
if|if
condition|(
operator|!
name|aap
condition|)
block|{
comment|/* 		 * We don't have this entry--accept it 		 */
name|accept
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * We do have an entry for this host--check the 		 * origin ID 		 */
if|if
condition|(
name|bcmp
argument_list|(
operator|&
name|aip
operator|->
name|ai_ip_addr
operator|.
name|s_addr
argument_list|,
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_oid
operator|.
name|id
argument_list|,
name|SCSP_ATMARP_ID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 			 * The received entry originated with us-- 			 * reject it 			 */
name|accept
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bcmp
argument_list|(
operator|&
name|aip
operator|->
name|ai_ip_addr
operator|.
name|s_addr
argument_list|,
name|aap
operator|->
name|aa_oid
operator|.
name|id
argument_list|,
name|SCSP_ATMARP_ID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 			 * We originated the entry we currently have-- 			 * only accept the new one if SCSP has higher 			 * priority than the existing entry 			 */
name|accept
operator|=
name|aap
operator|->
name|aa_origin
operator|<
name|UAO_SCSP
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * Accept the entry if it is more up-to-date 			 * than the existing entry 			 */
name|accept
operator|=
name|KEY_EQUAL
argument_list|(
operator|&
name|aap
operator|->
name|aa_key
argument_list|,
operator|&
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_key
argument_list|)
operator|&&
name|OID_EQUAL
argument_list|(
operator|&
name|aap
operator|->
name|aa_oid
argument_list|,
operator|&
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_oid
argument_list|)
operator|&&
operator|(
name|aap
operator|->
name|aa_seq
operator|<
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_seq
operator|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Add the entry to the cache, if appropriate 	 */
if|if
condition|(
name|accept
condition|)
block|{
if|if
condition|(
operator|!
name|aap
condition|)
block|{
comment|/* 			 * Copy info from SCSP to a new cache entry 			 */
name|aap
operator|=
operator|(
name|Atmarp
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Atmarp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|aap
condition|)
name|atmarp_mem_err
argument_list|(
literal|"atmarp_scsp_update_in: sizeof(Atmarp)"
argument_list|)
expr_stmt|;
name|UM_ZERO
argument_list|(
name|aap
argument_list|,
sizeof|sizeof
argument_list|(
name|Atmarp
argument_list|)
argument_list|)
expr_stmt|;
name|aap
operator|->
name|aa_dstip
operator|=
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_cpa
expr_stmt|;
name|aap
operator|->
name|aa_dstatm
operator|=
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_cha
expr_stmt|;
name|aap
operator|->
name|aa_dstatmsub
operator|=
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_csa
expr_stmt|;
name|aap
operator|->
name|aa_key
operator|=
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_key
expr_stmt|;
name|aap
operator|->
name|aa_oid
operator|=
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_oid
expr_stmt|;
name|aap
operator|->
name|aa_seq
operator|=
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_seq
expr_stmt|;
name|aap
operator|->
name|aa_intf
operator|=
name|aip
expr_stmt|;
name|aap
operator|->
name|aa_origin
operator|=
name|UAO_SCSP
expr_stmt|;
comment|/* 			 * Add the new entry to our cache 			 */
name|ATMARP_ADD
argument_list|(
name|aip
argument_list|,
name|aap
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * Update the existing entry 			 */
name|aap
operator|->
name|aa_dstip
operator|=
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_cpa
expr_stmt|;
name|aap
operator|->
name|aa_dstatm
operator|=
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_cha
expr_stmt|;
name|aap
operator|->
name|aa_dstatmsub
operator|=
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_csa
expr_stmt|;
name|aap
operator|->
name|aa_key
operator|=
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_key
expr_stmt|;
name|aap
operator|->
name|aa_oid
operator|=
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_oid
expr_stmt|;
name|aap
operator|->
name|aa_seq
operator|=
name|smp
operator|->
name|si_atmarp
operator|.
name|sa_seq
expr_stmt|;
name|aap
operator|->
name|aa_origin
operator|=
name|UAO_SCSP
expr_stmt|;
block|}
comment|/* 		 * Send the updated entry to the kernel 		 */
if|if
condition|(
name|atmarp_update_kernel
argument_list|(
name|aap
argument_list|)
operator|==
literal|0
condition|)
name|rc
operator|=
name|SCSP_RSP_OK
expr_stmt|;
else|else
name|rc
operator|=
name|SCSP_RSP_REJ
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
name|SCSP_RSP_REJ
expr_stmt|;
block|}
comment|/* 	 * Turn the received message into a response 	 */
name|smp
operator|->
name|si_type
operator|=
name|SCSP_UPDATE_RSP
expr_stmt|;
name|smp
operator|->
name|si_rc
operator|=
name|rc
expr_stmt|;
comment|/* 	 * Send the message to SCSP 	 */
name|rc
operator|=
name|atmarp_scsp_out
argument_list|(
name|aip
argument_list|,
operator|(
name|char
operator|*
operator|)
name|smp
argument_list|,
name|smp
operator|->
name|si_len
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read and process a message from SCSP  *  *  * Arguments:  *	aip	interface for read  *  * Returns:  *	0	success  *	errno	reason for failure  *  */
end_comment

begin_function
name|int
name|atmarp_scsp_read
parameter_list|(
name|aip
parameter_list|)
name|Atmarp_intf
modifier|*
name|aip
decl_stmt|;
block|{
name|int
name|len
decl_stmt|,
name|rc
decl_stmt|;
name|char
modifier|*
name|buff
init|=
operator|(
name|char
operator|*
operator|)
literal|0
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|smp
decl_stmt|;
name|Scsp_if_msg_hdr
name|msg_hdr
decl_stmt|;
comment|/* 	 * Read the header of the message from SCSP 	 */
name|len
operator|=
name|read
argument_list|(
name|aip
operator|->
name|ai_scsp_sock
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|msg_hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|msg_hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
operator|-
literal|1
condition|)
block|{
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|read_fail
goto|;
block|}
elseif|else
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
name|msg_hdr
argument_list|)
condition|)
block|{
name|rc
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|read_fail
goto|;
block|}
comment|/* 	 * Get a buffer that will hold the message 	 */
name|buff
operator|=
name|UM_ALLOC
argument_list|(
name|msg_hdr
operator|.
name|sh_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buff
condition|)
name|atmarp_mem_err
argument_list|(
literal|"atmarp_scsp_read: msg_hdr.sh_len"
argument_list|)
expr_stmt|;
name|UM_COPY
argument_list|(
operator|&
name|msg_hdr
argument_list|,
name|buff
argument_list|,
sizeof|sizeof
argument_list|(
name|msg_hdr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Read the rest of the message, if there is more than 	 * just a header 	 */
name|len
operator|=
name|msg_hdr
operator|.
name|sh_len
operator|-
sizeof|sizeof
argument_list|(
name|msg_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|len
operator|=
name|read
argument_list|(
name|aip
operator|->
name|ai_scsp_sock
argument_list|,
name|buff
operator|+
sizeof|sizeof
argument_list|(
name|msg_hdr
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
operator|-
literal|1
condition|)
block|{
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|read_fail
goto|;
block|}
elseif|else
if|if
condition|(
name|len
operator|!=
name|msg_hdr
operator|.
name|sh_len
operator|-
sizeof|sizeof
argument_list|(
name|msg_hdr
argument_list|)
condition|)
block|{
name|rc
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|read_fail
goto|;
block|}
block|}
comment|/* 	 * Handle the message based on its type 	 */
name|smp
operator|=
operator|(
name|Scsp_if_msg
operator|*
operator|)
name|buff
expr_stmt|;
switch|switch
condition|(
name|smp
operator|->
name|si_type
condition|)
block|{
case|case
name|SCSP_CFG_RSP
case|:
if|if
condition|(
name|smp
operator|->
name|si_rc
operator|!=
name|SCSP_RSP_OK
condition|)
block|{
goto|goto
name|read_fail
goto|;
block|}
break|break;
case|case
name|SCSP_CACHE_IND
case|:
name|rc
operator|=
name|atmarp_scsp_cache
argument_list|(
name|aip
argument_list|,
name|smp
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSP_SOLICIT_IND
case|:
name|rc
operator|=
name|atmarp_scsp_solicit
argument_list|(
name|aip
argument_list|,
name|smp
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSP_UPDATE_IND
case|:
name|rc
operator|=
name|atmarp_scsp_update_in
argument_list|(
name|aip
argument_list|,
name|smp
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSP_UPDATE_RSP
case|:
comment|/* 		 * Ignore Update Responses 		 */
name|rc
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|atmarp_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Unexpected SCSP message received"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
name|UM_FREE
argument_list|(
name|buff
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
name|read_fail
label|:
if|if
condition|(
name|buff
condition|)
block|{
name|UM_FREE
argument_list|(
name|buff
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Error on socket to SCSP--close the socket and set the state 	 * so that we know to retry when the cache timer fires. 	 */
name|atmarp_scsp_close
argument_list|(
name|aip
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send a message to SCSP  *  *  * Arguments:  *	aip	pointer to ATMARP interface to send message on  *	buff	pointer to message buffer  *	len	length of message  *  * Returns:  *	0	message sent  *	errno	reason for failure  *  */
end_comment

begin_function
name|int
name|atmarp_scsp_out
parameter_list|(
name|aip
parameter_list|,
name|buff
parameter_list|,
name|len
parameter_list|)
name|Atmarp_intf
modifier|*
name|aip
decl_stmt|;
name|char
modifier|*
name|buff
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
comment|/* 	 * Send the message to SCSP 	 */
name|rc
operator|=
name|write
argument_list|(
name|aip
operator|->
name|ai_scsp_sock
argument_list|,
name|buff
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|len
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* 	 * Error on write--close the socket to SCSP, clean up and 	 * set the state so that we know to retry when the cache 	 * timer fires. 	 */
name|atmarp_scsp_close
argument_list|(
name|aip
argument_list|)
expr_stmt|;
comment|/* 	 * Set the return code 	 */
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|errno
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
name|EFAULT
expr_stmt|;
block|}
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set up a socket and connect to SCSP  *  * Arguments:  *	aip	pointer to interface block  *  * Returns:  *	0	success, ai_scsp_sock is set  *	errno	reason for failure  *  *  */
end_comment

begin_function
name|int
name|atmarp_scsp_connect
parameter_list|(
name|aip
parameter_list|)
name|Atmarp_intf
modifier|*
name|aip
decl_stmt|;
block|{
name|int
name|len
decl_stmt|,
name|rc
decl_stmt|,
name|sd
decl_stmt|;
name|char
modifier|*
name|sn
decl_stmt|;
name|Scsp_if_msg
name|cfg_msg
decl_stmt|;
specifier|static
name|struct
name|sockaddr
name|local_addr
init|=
block|{
if|#
directive|if
operator|(
name|defined
argument_list|(
name|BSD
argument_list|)
operator|&&
operator|(
name|BSD
operator|>=
literal|199103
operator|)
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
block|,
comment|/* sa_len */
endif|#
directive|endif
name|AF_UNIX
block|,
comment|/* sa_family */
name|ATMARP_SOCK_PREFIX
comment|/* sa_data */
block|}
decl_stmt|;
specifier|static
name|struct
name|sockaddr
name|scsp_addr
init|=
block|{
if|#
directive|if
operator|(
name|defined
argument_list|(
name|BSD
argument_list|)
operator|&&
operator|(
name|BSD
operator|>=
literal|199103
operator|)
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
block|,
comment|/* sa_len */
endif|#
directive|endif
name|AF_UNIX
block|,
comment|/* sa_family */
name|SCSPD_SOCK_NAME
comment|/* sa_data */
block|}
decl_stmt|;
comment|/* 	 * Construct a name for the socket 	 */
name|strncpy
argument_list|(
name|local_addr
operator|.
name|sa_data
argument_list|,
name|ATMARP_SOCK_PREFIX
argument_list|,
sizeof|sizeof
argument_list|(
name|local_addr
operator|.
name|sa_data
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncat
argument_list|(
name|local_addr
operator|.
name|sa_data
argument_list|,
name|aip
operator|->
name|ai_intf
argument_list|,
sizeof|sizeof
argument_list|(
name|local_addr
operator|.
name|sa_data
argument_list|)
argument_list|)
expr_stmt|;
name|sn
operator|=
name|strdup
argument_list|(
name|local_addr
operator|.
name|sa_data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sn
condition|)
name|atmarp_mem_err
argument_list|(
literal|"atmarp_scsp_connect: strdup"
argument_list|)
expr_stmt|;
comment|/* 	 * Clean up any old socket 	 */
name|rc
operator|=
name|unlink
argument_list|(
name|sn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|ENOENT
condition|)
return|return
operator|(
name|errno
operator|)
return|;
comment|/* 	 * Open a socket to SCSP 	 */
name|sd
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|==
operator|-
literal|1
condition|)
block|{
name|UM_FREE
argument_list|(
name|sn
argument_list|)
expr_stmt|;
return|return
operator|(
name|errno
operator|)
return|;
block|}
if|if
condition|(
name|sd
operator|>
name|atmarp_max_socket
condition|)
block|{
name|atmarp_max_socket
operator|=
name|sd
expr_stmt|;
block|}
comment|/* 	 * Set non-blocking I/O 	 */
ifdef|#
directive|ifdef
name|sun
name|rc
operator|=
name|fcntl
argument_list|(
name|sd
argument_list|,
name|F_SETFL
argument_list|,
name|FNBIO
operator|+
name|FNDELAY
argument_list|)
expr_stmt|;
else|#
directive|else
name|rc
operator|=
name|fcntl
argument_list|(
name|sd
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
block|{
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|scsp_connect_fail
goto|;
block|}
comment|/* 	 * Bind the local socket address 	 */
name|rc
operator|=
name|bind
argument_list|(
name|sd
argument_list|,
operator|&
name|local_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|local_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|scsp_connect_fail
goto|;
block|}
comment|/* 	 * Connect to SCSP 	 */
name|rc
operator|=
name|connect
argument_list|(
name|sd
argument_list|,
operator|&
name|scsp_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|scsp_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|scsp_connect_fail
goto|;
block|}
comment|/* 	 * Save socket information in interface control block 	 */
name|aip
operator|->
name|ai_scsp_sock
operator|=
name|sd
expr_stmt|;
name|aip
operator|->
name|ai_scsp_sockname
operator|=
name|sn
expr_stmt|;
name|aip
operator|->
name|ai_state
operator|=
name|AI_STATE_UP
expr_stmt|;
comment|/* 	 * Send configuration information to SCSP 	 */
name|UM_ZERO
argument_list|(
operator|&
name|cfg_msg
argument_list|,
sizeof|sizeof
argument_list|(
name|cfg_msg
argument_list|)
argument_list|)
expr_stmt|;
name|cfg_msg
operator|.
name|si_type
operator|=
name|SCSP_CFG_REQ
expr_stmt|;
name|cfg_msg
operator|.
name|si_proto
operator|=
name|SCSP_PROTO_ATMARP
expr_stmt|;
name|strcpy
argument_list|(
name|cfg_msg
operator|.
name|si_cfg
operator|.
name|atmarp_netif
argument_list|,
name|aip
operator|->
name|ai_intf
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|Scsp_if_msg_hdr
argument_list|)
operator|+
name|strlen
argument_list|(
name|aip
operator|->
name|ai_intf
argument_list|)
operator|+
literal|1
expr_stmt|;
name|cfg_msg
operator|.
name|si_len
operator|=
name|len
expr_stmt|;
name|rc
operator|=
name|atmarp_scsp_out
argument_list|(
name|aip
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|cfg_msg
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
return|return
operator|(
name|rc
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|scsp_connect_fail
label|:
operator|(
name|void
operator|)
name|close
argument_list|(
name|sd
argument_list|)
expr_stmt|;
name|aip
operator|->
name|ai_scsp_sock
operator|=
operator|-
literal|1
expr_stmt|;
name|UM_FREE
argument_list|(
name|sn
argument_list|)
expr_stmt|;
name|aip
operator|->
name|ai_scsp_sockname
operator|=
name|NULL
expr_stmt|;
name|aip
operator|->
name|ai_state
operator|=
name|AI_STATE_NULL
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Close a socket connection to SCSP  *  * Arguments:  *	aip	pointer to interface block for connection to be closed  *  * Returns:  *	none  *  *  */
end_comment

begin_function
name|void
name|atmarp_scsp_close
parameter_list|(
name|aip
parameter_list|)
name|Atmarp_intf
modifier|*
name|aip
decl_stmt|;
block|{
comment|/* 	 * Close and unlink the SCSP socket 	 */
operator|(
name|void
operator|)
name|close
argument_list|(
name|aip
operator|->
name|ai_scsp_sock
argument_list|)
expr_stmt|;
name|aip
operator|->
name|ai_scsp_sock
operator|=
operator|-
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|aip
operator|->
name|ai_scsp_sockname
argument_list|)
expr_stmt|;
name|UM_FREE
argument_list|(
name|aip
operator|->
name|ai_scsp_sockname
argument_list|)
expr_stmt|;
name|aip
operator|->
name|ai_scsp_sockname
operator|=
name|NULL
expr_stmt|;
name|aip
operator|->
name|ai_state
operator|=
name|AI_STATE_NULL
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Disconnect an interface from SCSP  *  * Arguments:  *	aip	pointer to interface block for connection to be closed  *  * Returns:  *	0	success, ai_scsp_sock is set  *	errno	reason for failure  *  *  */
end_comment

begin_function
name|int
name|atmarp_scsp_disconnect
parameter_list|(
name|aip
parameter_list|)
name|Atmarp_intf
modifier|*
name|aip
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|Atmarp
modifier|*
name|aap
decl_stmt|;
comment|/* 	 * Close and unlink the SCSP socket 	 */
name|atmarp_scsp_close
argument_list|(
name|aip
argument_list|)
expr_stmt|;
comment|/* 	 * Free the ATMARP cache associated with the interface 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ATMARP_HASHSIZ
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|aap
operator|=
name|aip
operator|->
name|ai_arptbl
index|[
name|i
index|]
init|;
name|aap
condition|;
name|aap
operator|=
name|aap
operator|->
name|aa_next
control|)
block|{
name|UM_FREE
argument_list|(
name|aap
argument_list|)
expr_stmt|;
block|}
name|aip
operator|->
name|ai_arptbl
index|[
name|i
index|]
operator|=
operator|(
name|Atmarp
operator|*
operator|)
literal|0
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


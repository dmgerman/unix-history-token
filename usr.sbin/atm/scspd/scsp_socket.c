begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  * ===================================  * HARP  |  Host ATM Research Platform  * ===================================  *  *  * This Host ATM Research Platform ("HARP") file (the "Software") is  * made available by Network Computing Services, Inc. ("NetworkCS")  * "AS IS".  NetworkCS does not provide maintenance, improvements or  * support of any kind.  *  * NETWORKCS MAKES NO WARRANTIES OR REPRESENTATIONS, EXPRESS OR IMPLIED,  * INCLUDING, BUT NOT LIMITED TO, IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS FOR A PARTICULAR PURPOSE, AS TO ANY ELEMENT OF THE  * SOFTWARE OR ANY SUPPORT PROVIDED IN CONNECTION WITH THIS SOFTWARE.  * In no event shall NetworkCS be responsible for any damages, including  * but not limited to consequential damages, arising from or relating to  * any use of the Software or related support.  *  * Copyright 1994-1998 Network Computing Services, Inc.  *  * Copies of this Software may be made, however, the above copyright  * notice must be reproduced on all copies.  *  *	@(#) $FreeBSD$  *  */
end_comment

begin_comment
comment|/*  * Server Cache Synchronization Protocol (SCSP) Support  * ----------------------------------------------------  *  * SCSP socket management routines  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netatm/port.h>
end_include

begin_include
include|#
directive|include
file|<netatm/queue.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_if.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sap.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sys.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<libatm.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"scsp_msg.h"
end_include

begin_include
include|#
directive|include
file|"scsp_if.h"
end_include

begin_include
include|#
directive|include
file|"scsp_var.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"@(#) $FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Local variables  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|t_atm_llc
name|llc_scsp
init|=
block|{
name|T_ATM_LLC_SHARING
block|,
literal|8
block|,
block|{
literal|0xaa
block|,
literal|0xaa
block|,
literal|0x03
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x5e
block|,
literal|0x00
block|,
literal|0x05
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|t_atm_aal5
name|aal5
init|=
block|{
literal|0
block|,
comment|/* forward_max_SDU_size */
literal|0
block|,
comment|/* backward_max_SDU_size */
literal|0
comment|/* SSCS_type */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|t_atm_traffic
name|traffic
init|=
block|{
block|{
comment|/* forward */
name|T_ATM_ABSENT
block|,
comment|/* PCR_high_priority */
literal|0
block|,
comment|/* PCR_all_traffic */
name|T_ATM_ABSENT
block|,
comment|/* SCR_high_priority */
name|T_ATM_ABSENT
block|,
comment|/* SCR_all_traffic */
name|T_ATM_ABSENT
block|,
comment|/* MBS_high_priority */
name|T_ATM_ABSENT
block|,
comment|/* MBS_all_traffic */
name|T_NO
comment|/* tagging */
block|}
block|,
block|{
comment|/* backward */
name|T_ATM_ABSENT
block|,
comment|/* PCR_high_priority */
literal|0
block|,
comment|/* PCR_all_traffic */
name|T_ATM_ABSENT
block|,
comment|/* SCR_high_priority */
name|T_ATM_ABSENT
block|,
comment|/* SCR_all_traffic */
name|T_ATM_ABSENT
block|,
comment|/* MBS_high_priority */
name|T_ATM_ABSENT
block|,
comment|/* MBS_all_traffic */
name|T_NO
comment|/* tagging */
block|}
block|,
name|T_YES
comment|/* best_effort */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|t_atm_bearer
name|bearer
init|=
block|{
name|T_ATM_CLASS_X
block|,
comment|/* bearer_class */
name|T_ATM_NULL
block|,
comment|/* traffic_type */
name|T_ATM_NULL
block|,
comment|/* timing_requirements */
name|T_NO
block|,
comment|/* clipping_susceptibility */
name|T_ATM_1_TO_1
comment|/* connection_configuration */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|t_atm_qos
name|qos
init|=
block|{
name|T_ATM_NETWORK_CODING
block|,
comment|/* coding_standard */
block|{
comment|/* forward */
name|T_ATM_QOS_CLASS_0
comment|/* qos_class */
block|}
block|,
block|{
comment|/* backward */
name|T_ATM_QOS_CLASS_0
comment|/* qos_class */
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|t_atm_app_name
name|appname
init|=
block|{
literal|"SCSP"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Find a DCS, given its socket  *  * Arguments:  *	sd	socket descriptor  *  * Returns:  *	0	not found  *	address of DCS block corresponding to socket  *  */
end_comment

begin_function
name|Scsp_dcs
modifier|*
name|scsp_find_dcs
parameter_list|(
name|sd
parameter_list|)
name|int
name|sd
decl_stmt|;
block|{
name|Scsp_server
modifier|*
name|ssp
decl_stmt|;
name|Scsp_dcs
modifier|*
name|dcsp
init|=
name|NULL
decl_stmt|;
comment|/* 	 * Loop through the list of servers 	 */
for|for
control|(
name|ssp
operator|=
name|scsp_server_head
init|;
name|ssp
condition|;
name|ssp
operator|=
name|ssp
operator|->
name|ss_next
control|)
block|{
comment|/* 		 * Check all the DCSs chained from each server 		 */
for|for
control|(
name|dcsp
operator|=
name|ssp
operator|->
name|ss_dcs
init|;
name|dcsp
condition|;
name|dcsp
operator|=
name|dcsp
operator|->
name|sd_next
control|)
block|{
if|if
condition|(
name|dcsp
operator|->
name|sd_sock
operator|==
name|sd
condition|)
break|break;
block|}
block|}
return|return
operator|(
name|dcsp
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Find a server, given its socket  *  * Arguments:  *	sd	socket descriptor  *  * Returns:  *	0	not found  *	address of server block corresponding to socket  *  */
end_comment

begin_function
name|Scsp_server
modifier|*
name|scsp_find_server
parameter_list|(
name|sd
parameter_list|)
name|int
name|sd
decl_stmt|;
block|{
name|Scsp_server
modifier|*
name|ssp
decl_stmt|;
comment|/* 	 * Loop through the list of servers 	 */
for|for
control|(
name|ssp
operator|=
name|scsp_server_head
init|;
name|ssp
condition|;
name|ssp
operator|=
name|ssp
operator|->
name|ss_next
control|)
block|{
if|if
condition|(
name|ssp
operator|->
name|ss_sock
operator|==
name|sd
condition|)
break|break;
block|}
return|return
operator|(
name|ssp
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Connect to a directly connected server  *  * Arguments:  *	dcsp	pointer to DCS block for server  *  * Returns:  *	0	success (dcsp->sd_sock is set)  *	else	errno indicating reason for failure  *  */
end_comment

begin_function
name|int
name|scsp_dcs_connect
parameter_list|(
name|dcsp
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|,
name|sd
decl_stmt|;
name|struct
name|sockaddr_atm
name|DCS_addr
decl_stmt|;
comment|/* 	 * If the DCS already has an open connection, just return 	 */
if|if
condition|(
name|dcsp
operator|->
name|sd_sock
operator|!=
operator|-
literal|1
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Open an ATM socket 	 */
name|sd
operator|=
name|socket
argument_list|(
name|PF_ATM
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
name|ATM_PROTO_AAL5
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|(
name|ESOCKTNOSUPPORT
operator|)
return|;
block|}
if|if
condition|(
name|sd
operator|>
name|scsp_max_socket
condition|)
block|{
name|scsp_max_socket
operator|=
name|sd
expr_stmt|;
block|}
comment|/* 	 * Set up connection parameters for SCSP connection 	 */
name|UM_ZERO
argument_list|(
operator|&
name|DCS_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|DCS_addr
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|defined
argument_list|(
name|BSD
argument_list|)
operator|&&
operator|(
name|BSD
operator|>=
literal|199103
operator|)
operator|)
name|DCS_addr
operator|.
name|satm_len
operator|=
sizeof|sizeof
argument_list|(
name|DCS_addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|DCS_addr
operator|.
name|satm_family
operator|=
name|AF_ATM
expr_stmt|;
name|DCS_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_addr
operator|.
name|SVE_tag_addr
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|DCS_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_addr
operator|.
name|SVE_tag_selector
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|DCS_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_addr
operator|.
name|address_format
operator|=
name|dcsp
operator|->
name|sd_addr
operator|.
name|address_format
expr_stmt|;
name|DCS_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_addr
operator|.
name|address_length
operator|=
name|dcsp
operator|->
name|sd_addr
operator|.
name|address_length
expr_stmt|;
name|UM_COPY
argument_list|(
name|dcsp
operator|->
name|sd_addr
operator|.
name|address
argument_list|,
name|DCS_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_addr
operator|.
name|address
argument_list|,
name|dcsp
operator|->
name|sd_addr
operator|.
name|address_length
argument_list|)
expr_stmt|;
name|DCS_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_layer2
operator|.
name|SVE_tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|DCS_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_layer2
operator|.
name|ID_type
operator|=
name|T_ATM_SIMPLE_ID
expr_stmt|;
name|DCS_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_layer2
operator|.
name|ID
operator|.
name|simple_ID
operator|=
name|T_ATM_BLLI2_I8802
expr_stmt|;
name|DCS_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_layer3
operator|.
name|SVE_tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|DCS_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_appl
operator|.
name|SVE_tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
comment|/* 	 * Bind the socket to our address 	 */
if|if
condition|(
name|bind
argument_list|(
name|sd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|DCS_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|DCS_addr
argument_list|)
argument_list|)
condition|)
block|{
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|connect_fail
goto|;
block|}
comment|/* 	 * Set non-blocking operation 	 */
ifdef|#
directive|ifdef
name|sun
name|rc
operator|=
name|fcntl
argument_list|(
name|sd
argument_list|,
name|F_SETFL
argument_list|,
name|FNBIO
operator|+
name|FNDELAY
argument_list|)
expr_stmt|;
else|#
directive|else
name|rc
operator|=
name|fcntl
argument_list|(
name|sd
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
block|{
name|scsp_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"scsp_dcs_connect: fcntl failed"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|connect_fail
goto|;
block|}
comment|/* 	 * Set AAL 5 options 	 */
name|aal5
operator|.
name|forward_max_SDU_size
operator|=
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_mtu
expr_stmt|;
name|aal5
operator|.
name|backward_max_SDU_size
operator|=
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_mtu
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|T_ATM_SIGNALING
argument_list|,
name|T_ATM_AAL5
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|aal5
argument_list|,
sizeof|sizeof
argument_list|(
name|aal5
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|connect_fail
goto|;
block|}
comment|/* 	 * Set traffic options 	 */
switch|switch
condition|(
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_media
condition|)
block|{
case|case
name|MEDIA_TAXI_100
case|:
name|traffic
operator|.
name|forward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_TAXI100
expr_stmt|;
name|traffic
operator|.
name|backward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_TAXI100
expr_stmt|;
break|break;
case|case
name|MEDIA_TAXI_140
case|:
name|traffic
operator|.
name|forward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_TAXI140
expr_stmt|;
name|traffic
operator|.
name|backward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_TAXI140
expr_stmt|;
break|break;
case|case
name|MEDIA_OC3C
case|:
case|case
name|MEDIA_UTP155
case|:
name|traffic
operator|.
name|forward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_OC3C
expr_stmt|;
name|traffic
operator|.
name|backward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_OC3C
expr_stmt|;
break|break;
case|case
name|MEDIA_OC12C
case|:
name|traffic
operator|.
name|forward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_OC12C
expr_stmt|;
name|traffic
operator|.
name|backward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_OC12C
expr_stmt|;
break|break;
case|case
name|MEDIA_UNKNOWN
case|:
break|break;
block|}
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|T_ATM_SIGNALING
argument_list|,
name|T_ATM_TRAFFIC
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|traffic
argument_list|,
sizeof|sizeof
argument_list|(
name|traffic
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|connect_fail
goto|;
block|}
comment|/* 	 * Set bearer capability options 	 */
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|T_ATM_SIGNALING
argument_list|,
name|T_ATM_BEARER_CAP
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bearer
argument_list|,
sizeof|sizeof
argument_list|(
name|bearer
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|connect_fail
goto|;
block|}
comment|/* 	 * Set QOS options 	 */
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|T_ATM_SIGNALING
argument_list|,
name|T_ATM_QOS
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|qos
argument_list|,
sizeof|sizeof
argument_list|(
name|qos
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|connect_fail
goto|;
block|}
comment|/* 	 * Set LLC identifier 	 */
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|T_ATM_SIGNALING
argument_list|,
name|T_ATM_LLC
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|llc_scsp
argument_list|,
sizeof|sizeof
argument_list|(
name|llc_scsp
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|connect_fail
goto|;
block|}
comment|/* 	 * Set application name 	 */
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|T_ATM_SIGNALING
argument_list|,
name|T_ATM_APP_NAME
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|appname
argument_list|,
sizeof|sizeof
argument_list|(
name|appname
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|connect_fail
goto|;
block|}
comment|/* 	 * Connect to DCS 	 */
if|if
condition|(
name|connect
argument_list|(
name|sd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|DCS_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|DCS_addr
argument_list|)
argument_list|)
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|EINPROGRESS
condition|)
block|{
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|connect_fail
goto|;
block|}
comment|/* 	 * Set return values 	 */
name|dcsp
operator|->
name|sd_sock
operator|=
name|sd
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|connect_fail
label|:
comment|/* 	 * Close the socket if something didn't work 	 */
operator|(
name|void
operator|)
name|close
argument_list|(
name|sd
argument_list|)
expr_stmt|;
name|dcsp
operator|->
name|sd_sock
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
name|rc
operator|=
name|EFAULT
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Listen for ATM connections from DCSs  *  * Arguments:  *	None  *  * Returns:  *	sock	socket which is listening (also set in 		ssp->ss_dcs_lsock)  *	-1	error encountered (reason in errno)  *  */
end_comment

begin_function
name|int
name|scsp_dcs_listen
parameter_list|(
name|ssp
parameter_list|)
name|Scsp_server
modifier|*
name|ssp
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|,
name|sd
decl_stmt|;
name|struct
name|sockaddr_atm
name|ls_addr
decl_stmt|;
comment|/* 	 * Open a socket 	 */
name|sd
operator|=
name|socket
argument_list|(
name|PF_ATM
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
name|ATM_PROTO_AAL5
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|==
operator|-
literal|1
condition|)
block|{
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|listen_fail
goto|;
block|}
if|if
condition|(
name|sd
operator|>
name|scsp_max_socket
condition|)
block|{
name|scsp_max_socket
operator|=
name|sd
expr_stmt|;
block|}
comment|/* 	 * Set up our address 	 */
name|UM_ZERO
argument_list|(
operator|&
name|ls_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|ls_addr
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|defined
argument_list|(
name|BSD
argument_list|)
operator|&&
operator|(
name|BSD
operator|>=
literal|199103
operator|)
operator|)
name|ls_addr
operator|.
name|satm_len
operator|=
sizeof|sizeof
argument_list|(
name|ls_addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ls_addr
operator|.
name|satm_family
operator|=
name|AF_ATM
expr_stmt|;
name|ls_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_addr
operator|.
name|SVE_tag_addr
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ls_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_addr
operator|.
name|SVE_tag_selector
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ls_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_addr
operator|.
name|address_format
operator|=
name|ssp
operator|->
name|ss_addr
operator|.
name|address_format
expr_stmt|;
name|ls_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_addr
operator|.
name|address_length
operator|=
name|ssp
operator|->
name|ss_addr
operator|.
name|address_length
expr_stmt|;
name|UM_COPY
argument_list|(
name|ssp
operator|->
name|ss_addr
operator|.
name|address
argument_list|,
name|ls_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_addr
operator|.
name|address
argument_list|,
name|ssp
operator|->
name|ss_addr
operator|.
name|address_length
argument_list|)
expr_stmt|;
name|ls_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_layer2
operator|.
name|SVE_tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ls_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_layer2
operator|.
name|ID_type
operator|=
name|T_ATM_SIMPLE_ID
expr_stmt|;
name|ls_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_layer2
operator|.
name|ID
operator|.
name|simple_ID
operator|=
name|T_ATM_BLLI2_I8802
expr_stmt|;
name|ls_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_layer3
operator|.
name|SVE_tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|ls_addr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_appl
operator|.
name|SVE_tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
comment|/* 	 * Bind the socket to our address 	 */
name|rc
operator|=
name|bind
argument_list|(
name|sd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|ls_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|ls_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
block|{
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|listen_fail
goto|;
block|}
comment|/* 	 * Set non-blocking I/O 	 */
ifdef|#
directive|ifdef
name|sun
name|rc
operator|=
name|fcntl
argument_list|(
name|sd
argument_list|,
name|F_SETFL
argument_list|,
name|FNBIO
operator|+
name|FNDELAY
argument_list|)
expr_stmt|;
else|#
directive|else
name|rc
operator|=
name|fcntl
argument_list|(
name|sd
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
block|{
name|scsp_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"scsp_dcs_listen: fcntl failed"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|listen_fail
goto|;
block|}
comment|/* 	 * Set AAL 5 options 	 */
name|aal5
operator|.
name|forward_max_SDU_size
operator|=
name|ssp
operator|->
name|ss_mtu
expr_stmt|;
name|aal5
operator|.
name|backward_max_SDU_size
operator|=
name|ssp
operator|->
name|ss_mtu
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|T_ATM_SIGNALING
argument_list|,
name|T_ATM_AAL5
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|aal5
argument_list|,
sizeof|sizeof
argument_list|(
name|aal5
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|listen_fail
goto|;
block|}
comment|/* 	 * Set traffic options 	 */
switch|switch
condition|(
name|ssp
operator|->
name|ss_media
condition|)
block|{
case|case
name|MEDIA_TAXI_100
case|:
name|traffic
operator|.
name|forward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_TAXI100
expr_stmt|;
name|traffic
operator|.
name|backward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_TAXI100
expr_stmt|;
break|break;
case|case
name|MEDIA_TAXI_140
case|:
name|traffic
operator|.
name|forward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_TAXI140
expr_stmt|;
name|traffic
operator|.
name|backward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_TAXI140
expr_stmt|;
break|break;
case|case
name|MEDIA_OC3C
case|:
case|case
name|MEDIA_UTP155
case|:
name|traffic
operator|.
name|forward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_OC3C
expr_stmt|;
name|traffic
operator|.
name|backward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_OC3C
expr_stmt|;
break|break;
case|case
name|MEDIA_OC12C
case|:
name|traffic
operator|.
name|forward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_OC12C
expr_stmt|;
name|traffic
operator|.
name|backward
operator|.
name|PCR_all_traffic
operator|=
name|ATM_PCR_OC12C
expr_stmt|;
break|break;
case|case
name|MEDIA_UNKNOWN
case|:
break|break;
block|}
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|T_ATM_SIGNALING
argument_list|,
name|T_ATM_TRAFFIC
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|traffic
argument_list|,
sizeof|sizeof
argument_list|(
name|traffic
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|listen_fail
goto|;
block|}
comment|/* 	 * Set bearer capability options 	 */
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|T_ATM_SIGNALING
argument_list|,
name|T_ATM_BEARER_CAP
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bearer
argument_list|,
sizeof|sizeof
argument_list|(
name|bearer
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|listen_fail
goto|;
block|}
comment|/* 	 * Set QOS options 	 */
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|T_ATM_SIGNALING
argument_list|,
name|T_ATM_QOS
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|qos
argument_list|,
sizeof|sizeof
argument_list|(
name|qos
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|listen_fail
goto|;
block|}
comment|/* 	 * Set LLC identifier 	 */
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|T_ATM_SIGNALING
argument_list|,
name|T_ATM_LLC
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|llc_scsp
argument_list|,
sizeof|sizeof
argument_list|(
name|llc_scsp
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|listen_fail
goto|;
block|}
comment|/* 	 * Set application name 	 */
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|T_ATM_SIGNALING
argument_list|,
name|T_ATM_APP_NAME
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|appname
argument_list|,
sizeof|sizeof
argument_list|(
name|appname
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|listen_fail
goto|;
block|}
comment|/* 	 * Listen for new connections 	 */
if|if
condition|(
name|listen
argument_list|(
name|sd
argument_list|,
literal|5
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|listen_fail
goto|;
block|}
name|ssp
operator|->
name|ss_dcs_lsock
operator|=
name|sd
expr_stmt|;
return|return
operator|(
name|sd
operator|)
return|;
name|listen_fail
label|:
comment|/* 	 * Close the socket if anything didn't work 	 */
operator|(
name|void
operator|)
name|close
argument_list|(
name|sd
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
name|errno
operator|=
name|EFAULT
expr_stmt|;
else|else
name|errno
operator|=
name|rc
expr_stmt|;
name|ssp
operator|->
name|ss_dcs_lsock
operator|=
operator|-
literal|1
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Accept a connection from a DCS  *  * Arguments:  *	ssp	pointer to server block  *  * Returns:  *	address of DCS with new connection  *	0	failure (errno has reason)  *  */
end_comment

begin_function
name|Scsp_dcs
modifier|*
name|scsp_dcs_accept
parameter_list|(
name|ssp
parameter_list|)
name|Scsp_server
modifier|*
name|ssp
decl_stmt|;
block|{
name|int
name|len
decl_stmt|,
name|rc
decl_stmt|,
name|sd
decl_stmt|;
name|struct
name|sockaddr_atm
name|dcs_sockaddr
decl_stmt|;
name|struct
name|t_atm_sap_addr
modifier|*
name|dcs_addr
init|=
operator|&
name|dcs_sockaddr
operator|.
name|satm_addr
operator|.
name|t_atm_sap_addr
decl_stmt|;
name|Atm_addr
name|dcs_atmaddr
decl_stmt|;
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
comment|/* 	 * Accept the new connection 	 */
name|len
operator|=
sizeof|sizeof
argument_list|(
name|dcs_sockaddr
argument_list|)
expr_stmt|;
name|sd
operator|=
name|accept
argument_list|(
name|ssp
operator|->
name|ss_dcs_lsock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|dcs_sockaddr
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|<
literal|0
condition|)
block|{
return|return
operator|(
operator|(
name|Scsp_dcs
operator|*
operator|)
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sd
operator|>
name|scsp_max_socket
condition|)
block|{
name|scsp_max_socket
operator|=
name|sd
expr_stmt|;
block|}
comment|/* 	 * Copy the DCS's address from the sockaddr to an Atm_addr 	 */
if|if
condition|(
name|dcs_addr
operator|->
name|SVE_tag_addr
operator|!=
name|T_ATM_PRESENT
condition|)
block|{
name|dcs_atmaddr
operator|.
name|address_format
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|dcs_atmaddr
operator|.
name|address_length
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|dcs_atmaddr
operator|.
name|address_format
operator|=
name|dcs_addr
operator|->
name|address_format
expr_stmt|;
name|dcs_atmaddr
operator|.
name|address_length
operator|=
name|dcs_addr
operator|->
name|address_length
expr_stmt|;
name|UM_COPY
argument_list|(
name|dcs_addr
operator|->
name|address
argument_list|,
name|dcs_atmaddr
operator|.
name|address
argument_list|,
name|dcs_addr
operator|->
name|address_length
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Find out which DCS this connection is for 	 */
for|for
control|(
name|dcsp
operator|=
name|ssp
operator|->
name|ss_dcs
init|;
name|dcsp
condition|;
name|dcsp
operator|=
name|dcsp
operator|->
name|sd_next
control|)
block|{
comment|/* 		 * Compare DCS's address to address 		 * configured by user 		 */
if|if
condition|(
name|ATM_ADDR_EQUAL
argument_list|(
operator|&
name|dcsp
operator|->
name|sd_addr
argument_list|,
operator|&
name|dcs_atmaddr
argument_list|)
condition|)
break|break;
block|}
comment|/* 	 * Make sure we have this DCS configured 	 */
if|if
condition|(
operator|!
name|dcsp
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|dcs_accept_fail
goto|;
block|}
comment|/* 	 * Make sure we are in a state to accept the connection 	 */
if|if
condition|(
name|ssp
operator|->
name|ss_state
operator|!=
name|SCSP_SS_ACTIVE
condition|)
block|{
name|errno
operator|=
name|EACCES
expr_stmt|;
goto|goto
name|dcs_accept_fail
goto|;
block|}
comment|/* 	 * Make sure we don't already have a connection to this DCS 	 */
if|if
condition|(
name|dcsp
operator|->
name|sd_sock
operator|!=
operator|-
literal|1
condition|)
block|{
name|errno
operator|=
name|EALREADY
expr_stmt|;
goto|goto
name|dcs_accept_fail
goto|;
block|}
comment|/* 	 * Set application name 	 */
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|T_ATM_SIGNALING
argument_list|,
name|T_ATM_APP_NAME
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|appname
argument_list|,
sizeof|sizeof
argument_list|(
name|appname
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|dcs_accept_fail
goto|;
block|}
comment|/* 	 * Set non-blocking I/O 	 */
ifdef|#
directive|ifdef
name|sun
name|rc
operator|=
name|fcntl
argument_list|(
name|sd
argument_list|,
name|F_SETFL
argument_list|,
name|FNBIO
operator|+
name|FNDELAY
argument_list|)
expr_stmt|;
else|#
directive|else
name|rc
operator|=
name|fcntl
argument_list|(
name|sd
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|dcs_accept_fail
goto|;
block|}
comment|/* 	 * Cancel the open retry timer 	 */
name|HARP_CANCEL
argument_list|(
operator|&
name|dcsp
operator|->
name|sd_open_t
argument_list|)
expr_stmt|;
comment|/* 	 * Save the socket address and return the 	 * address of the DCS 	 */
name|dcsp
operator|->
name|sd_sock
operator|=
name|sd
expr_stmt|;
return|return
operator|(
name|dcsp
operator|)
return|;
name|dcs_accept_fail
label|:
comment|/* 	 * An error has occured--clean up and return 	 */
operator|(
name|void
operator|)
name|close
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|Scsp_dcs
operator|*
operator|)
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read an SCSP message from a directly connected server  *  * Arguments:  *	dcsp	pointer to DCS block that has data  *  * Returns:  *	0	success  *	else	errno indicating reason for failure  *  */
end_comment

begin_function
name|int
name|scsp_dcs_read
parameter_list|(
name|dcsp
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
block|{
name|int
name|len
decl_stmt|,
name|rc
decl_stmt|;
name|char
modifier|*
name|buff
init|=
operator|(
name|char
operator|*
operator|)
literal|0
decl_stmt|;
name|Scsp_server
modifier|*
name|ssp
init|=
name|dcsp
operator|->
name|sd_server
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
comment|/* 	 * Get a buffer to hold the entire message 	 */
name|len
operator|=
name|ssp
operator|->
name|ss_mtu
expr_stmt|;
name|buff
operator|=
operator|(
name|char
operator|*
operator|)
name|UM_ALLOC
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buff
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_dcs_read: ssp->ss_mtu"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Read the message 	 */
name|len
operator|=
name|read
argument_list|(
name|dcsp
operator|->
name|sd_sock
argument_list|,
name|buff
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
goto|goto
name|dcs_read_fail
goto|;
block|}
comment|/* 	 * Parse the input message and pass it to the Hello FSM 	 */
name|msg
operator|=
name|scsp_parse_msg
argument_list|(
name|buff
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
condition|)
block|{
comment|/* 		 * Write the message to the trace file if 		 * it's of a type we're tracing 		 */
if|if
condition|(
operator|(
operator|(
name|scsp_trace_mode
operator|&
name|SCSP_TRACE_HELLO_MSG
operator|)
operator|&&
name|msg
operator|->
name|sc_msg_type
operator|==
name|SCSP_HELLO_MSG
operator|)
operator|||
operator|(
operator|(
name|scsp_trace_mode
operator|&
name|SCSP_TRACE_CA_MSG
operator|)
operator|&&
name|msg
operator|->
name|sc_msg_type
operator|!=
name|SCSP_HELLO_MSG
operator|)
condition|)
block|{
name|scsp_trace_msg
argument_list|(
name|dcsp
argument_list|,
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|scsp_trace
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Pass the message to the Hello FSM 		 */
name|rc
operator|=
name|scsp_hfsm
argument_list|(
name|dcsp
argument_list|,
name|SCSP_HFSM_RCVD
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|scsp_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Message was invalid.  Write it to the trace file 		 * if we're tracing messages. 		 */
if|if
condition|(
name|scsp_trace_mode
operator|&
operator|(
name|SCSP_TRACE_HELLO_MSG
operator|&
name|SCSP_TRACE_CA_MSG
operator|)
condition|)
block|{
name|int
name|i
decl_stmt|;
name|scsp_trace
argument_list|(
literal|"Invalid message received:\n"
argument_list|)
expr_stmt|;
name|scsp_trace
argument_list|(
literal|"0x"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|scsp_trace
argument_list|(
literal|"%02x "
argument_list|,
operator|(
name|u_char
operator|)
name|buff
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|scsp_trace
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|UM_FREE
argument_list|(
name|buff
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|dcs_read_fail
label|:
comment|/* 	 * Error on read--check for special conditions 	 */
name|rc
operator|=
name|errno
expr_stmt|;
if|if
condition|(
name|errno
operator|==
name|ECONNRESET
condition|)
block|{
comment|/* 		 * VCC has been closed--pass the event to 		 * the Hello FSM 		 */
name|rc
operator|=
name|scsp_hfsm
argument_list|(
name|dcsp
argument_list|,
name|SCSP_HFSM_VC_CLOSED
argument_list|,
operator|(
name|Scsp_msg
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|errno
operator|==
name|ECONNREFUSED
condition|)
block|{
comment|/* 		 * VCC open failed--set a timer and try 		 * again when it fires 		 */
name|HARP_TIMER
argument_list|(
operator|&
name|dcsp
operator|->
name|sd_open_t
argument_list|,
name|SCSP_Open_Interval
argument_list|,
name|scsp_open_timeout
argument_list|)
expr_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|buff
condition|)
name|UM_FREE
argument_list|(
name|buff
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Listen for Unix connections from SCSP client servers  *  * Arguments:  *	None  *  * Returns:  *	sock	socket which is listening  *	-1	error (reason in errno)  *  */
end_comment

begin_function
name|int
name|scsp_server_listen
parameter_list|()
block|{
name|int
name|rc
decl_stmt|,
name|sd
decl_stmt|;
specifier|static
name|struct
name|sockaddr
name|scsp_addr
init|=
block|{
if|#
directive|if
operator|(
name|defined
argument_list|(
name|BSD
argument_list|)
operator|&&
operator|(
name|BSD
operator|>=
literal|199103
operator|)
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
block|,
comment|/* sa_len */
endif|#
directive|endif
name|AF_UNIX
block|,
comment|/* sa_family */
name|SCSPD_SOCK_NAME
comment|/* sa_data */
block|}
decl_stmt|;
comment|/* 	 * Unlink any old socket 	 */
name|rc
operator|=
name|unlink
argument_list|(
name|SCSPD_SOCK_NAME
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|ENOENT
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* 	 * Open a socket 	 */
name|sd
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|sd
operator|>
name|scsp_max_socket
condition|)
block|{
name|scsp_max_socket
operator|=
name|sd
expr_stmt|;
block|}
comment|/* 	 * Bind the socket's address 	 */
name|rc
operator|=
name|bind
argument_list|(
name|sd
argument_list|,
operator|&
name|scsp_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|scsp_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * Set non-blocking I/O 	 */
ifdef|#
directive|ifdef
name|sun
name|rc
operator|=
name|fcntl
argument_list|(
name|sd
argument_list|,
name|F_SETFL
argument_list|,
name|FNBIO
operator|+
name|FNDELAY
argument_list|)
expr_stmt|;
else|#
directive|else
name|rc
operator|=
name|fcntl
argument_list|(
name|sd
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * Listen for new connections 	 */
if|if
condition|(
name|listen
argument_list|(
name|sd
argument_list|,
literal|5
argument_list|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
name|sd
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Accept a connection from a server  *  * We accept a connection, but we won't know which server it is  * from until we get the configuration data from the server.  We  * put the connection on a 'pending' queue and will assign it to  * a server when the config data arrives.  *  * Arguments:  *	ls	listening socket to accept from  *  * Returns:  *	0	success  *	errno	reason for failure  *  */
end_comment

begin_function
name|int
name|scsp_server_accept
parameter_list|(
name|ls
parameter_list|)
name|int
name|ls
decl_stmt|;
block|{
name|int
name|len
decl_stmt|,
name|rc
decl_stmt|,
name|sd
decl_stmt|;
name|struct
name|sockaddr
name|server_addr
decl_stmt|;
name|Scsp_pending
modifier|*
name|psp
decl_stmt|;
comment|/* 	 * Accept the new connection 	 */
name|len
operator|=
sizeof|sizeof
argument_list|(
name|server_addr
argument_list|)
expr_stmt|;
name|sd
operator|=
name|accept
argument_list|(
name|ls
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|server_addr
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|<
literal|0
condition|)
block|{
return|return
operator|(
name|errno
operator|)
return|;
block|}
if|if
condition|(
name|sd
operator|>
name|scsp_max_socket
condition|)
block|{
name|scsp_max_socket
operator|=
name|sd
expr_stmt|;
block|}
comment|/* 	 * Set non-blocking operation 	 */
ifdef|#
directive|ifdef
name|sun
name|rc
operator|=
name|fcntl
argument_list|(
name|sd
argument_list|,
name|F_SETFL
argument_list|,
name|FNBIO
operator|+
name|FNDELAY
argument_list|)
expr_stmt|;
else|#
directive|else
name|rc
operator|=
name|fcntl
argument_list|(
name|sd
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|sd
argument_list|)
expr_stmt|;
name|rc
operator|=
name|errno
expr_stmt|;
block|}
comment|/* 	 * Put the new socket on the 'pending' queue 	 */
name|psp
operator|=
operator|(
name|Scsp_pending
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_pending
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|psp
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_server_accept: sizeof(Scsp_pending)"
argument_list|)
expr_stmt|;
block|}
name|psp
operator|->
name|sp_sock
operator|=
name|sd
expr_stmt|;
name|LINK2TAIL
argument_list|(
name|psp
argument_list|,
name|Scsp_pending
argument_list|,
name|scsp_pending_head
argument_list|,
name|sp_next
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read a server interface message from a socket  *  * Arguments:  *	sd	socket to read from  *  * Returns:  *	msg	pointer to message read  *	0	failure (errno has reason)  *  */
end_comment

begin_function
name|Scsp_if_msg
modifier|*
name|scsp_if_sock_read
parameter_list|(
name|sd
parameter_list|)
name|int
name|sd
decl_stmt|;
block|{
name|int
name|len
decl_stmt|;
name|char
modifier|*
name|buff
init|=
operator|(
name|char
operator|*
operator|)
literal|0
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|msg
decl_stmt|;
name|Scsp_if_msg_hdr
name|msg_hdr
decl_stmt|;
comment|/* 	 * Read the message header from the socket 	 */
name|len
operator|=
name|read
argument_list|(
name|sd
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|msg_hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|msg_hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
name|msg_hdr
argument_list|)
condition|)
block|{
if|if
condition|(
name|len
operator|>=
literal|0
condition|)
name|errno
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|socket_read_fail
goto|;
block|}
comment|/* 	 * Get a buffer and read the rest of the message into it 	 */
name|buff
operator|=
operator|(
name|char
operator|*
operator|)
name|UM_ALLOC
argument_list|(
name|msg_hdr
operator|.
name|sh_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buff
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_if_sock_read: msg_hdr.sh_len"
argument_list|)
expr_stmt|;
block|}
name|msg
operator|=
operator|(
name|Scsp_if_msg
operator|*
operator|)
name|buff
expr_stmt|;
name|msg
operator|->
name|si_hdr
operator|=
name|msg_hdr
expr_stmt|;
name|len
operator|=
name|read
argument_list|(
name|sd
argument_list|,
operator|&
name|buff
index|[
sizeof|sizeof
argument_list|(
name|Scsp_if_msg_hdr
argument_list|)
index|]
argument_list|,
name|msg
operator|->
name|si_len
operator|-
sizeof|sizeof
argument_list|(
name|Scsp_if_msg_hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|msg
operator|->
name|si_len
operator|-
sizeof|sizeof
argument_list|(
name|Scsp_if_msg_hdr
argument_list|)
condition|)
block|{
if|if
condition|(
name|len
operator|>=
literal|0
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
block|}
goto|goto
name|socket_read_fail
goto|;
block|}
comment|/* 	 * Trace the message 	 */
if|if
condition|(
name|scsp_trace_mode
operator|&
name|SCSP_TRACE_IF_MSG
condition|)
block|{
name|scsp_trace
argument_list|(
literal|"Received server I/F message:\n"
argument_list|)
expr_stmt|;
name|print_scsp_if_msg
argument_list|(
name|scsp_trace_file
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|scsp_trace
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|msg
operator|)
return|;
name|socket_read_fail
label|:
if|if
condition|(
name|buff
condition|)
name|UM_FREE
argument_list|(
name|buff
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|Scsp_if_msg
operator|*
operator|)
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Write a server interface message to a socket  *  * Arguments:  *	sd	socket to write to  *	msg	pointer to message to write  *  * Returns:  *	0	success  *	errno	reason for failure  *  */
end_comment

begin_function
name|int
name|scsp_if_sock_write
parameter_list|(
name|sd
parameter_list|,
name|msg
parameter_list|)
name|int
name|sd
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|len
decl_stmt|,
name|rc
decl_stmt|;
comment|/* 	 * Trace the message 	 */
if|if
condition|(
name|scsp_trace_mode
operator|&
name|SCSP_TRACE_IF_MSG
condition|)
block|{
name|scsp_trace
argument_list|(
literal|"Writing server I/F message:\n"
argument_list|)
expr_stmt|;
name|print_scsp_if_msg
argument_list|(
name|scsp_trace_file
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|scsp_trace
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Write the message to the indicated socket 	 */
name|len
operator|=
name|write
argument_list|(
name|sd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|msg
argument_list|,
name|msg
operator|->
name|si_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|msg
operator|->
name|si_len
condition|)
block|{
if|if
condition|(
name|len
operator|<
literal|0
condition|)
name|rc
operator|=
name|errno
expr_stmt|;
else|else
name|rc
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read data from a local server  *  * Arguments:  *	ssp	pointer to server block that has data  *  * Returns:  *	0	success  *	else	errno indicating reason for failure  *  */
end_comment

begin_function
name|int
name|scsp_server_read
parameter_list|(
name|ssp
parameter_list|)
name|Scsp_server
modifier|*
name|ssp
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|msg
decl_stmt|;
comment|/* 	 * Read the message 	 */
name|msg
operator|=
name|scsp_if_sock_read
argument_list|(
name|ssp
operator|->
name|ss_sock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EWOULDBLOCK
condition|)
block|{
comment|/* 			 * Nothing to read--just return 			 */
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
comment|/* 			 * Error--shut down the server entry 			 */
name|scsp_server_shutdown
argument_list|(
name|ssp
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|errno
operator|)
return|;
block|}
comment|/* 	 * Process the received message 	 */
switch|switch
condition|(
name|msg
operator|->
name|si_type
condition|)
block|{
case|case
name|SCSP_NOP_REQ
case|:
comment|/* 		 * Ignore a NOP 		 */
break|break;
case|case
name|SCSP_CACHE_RSP
case|:
comment|/* 		 * Summarize the server's cache and try to open 		 * connections to all of its DCSs 		 */
name|scsp_process_cache_rsp
argument_list|(
name|ssp
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|ssp
operator|->
name|ss_state
operator|=
name|SCSP_SS_ACTIVE
expr_stmt|;
for|for
control|(
name|dcsp
operator|=
name|ssp
operator|->
name|ss_dcs
init|;
name|dcsp
condition|;
name|dcsp
operator|=
name|dcsp
operator|->
name|sd_next
control|)
block|{
if|if
condition|(
name|scsp_dcs_connect
argument_list|(
name|dcsp
argument_list|)
condition|)
block|{
comment|/* 				 * Connect failed -- the DCS may not 				 * be up yet, so we'll try again later 				 */
name|HARP_TIMER
argument_list|(
operator|&
name|dcsp
operator|->
name|sd_open_t
argument_list|,
name|SCSP_Open_Interval
argument_list|,
name|scsp_open_timeout
argument_list|)
expr_stmt|;
block|}
block|}
name|ssp
operator|->
name|ss_state
operator|=
name|SCSP_SS_ACTIVE
expr_stmt|;
break|break;
case|case
name|SCSP_SOLICIT_RSP
case|:
comment|/* 		 * The server has answered our request for a particular 		 * entry from its cache 		 */
name|dcsp
operator|=
operator|(
name|Scsp_dcs
operator|*
operator|)
name|msg
operator|->
name|si_tok
expr_stmt|;
name|rc
operator|=
name|scsp_cfsm
argument_list|(
name|dcsp
argument_list|,
name|SCSP_CIFSM_SOL_RSP
argument_list|,
operator|(
name|Scsp_msg
operator|*
operator|)
literal|0
argument_list|,
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSP_UPDATE_REQ
case|:
comment|/* 		 * Pass the update request to the FSMs for all 		 * DCSs associated with the server 		 */
if|if
condition|(
name|ssp
operator|->
name|ss_state
operator|==
name|SCSP_SS_ACTIVE
condition|)
block|{
for|for
control|(
name|dcsp
operator|=
name|ssp
operator|->
name|ss_dcs
init|;
name|dcsp
condition|;
name|dcsp
operator|=
name|dcsp
operator|->
name|sd_next
control|)
block|{
name|rc
operator|=
name|scsp_cfsm
argument_list|(
name|dcsp
argument_list|,
name|SCSP_CIFSM_UPD_REQ
argument_list|,
operator|(
name|Scsp_msg
operator|*
operator|)
literal|0
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|SCSP_UPDATE_RSP
case|:
comment|/* 		 * Pass the update response to the FSM for the 		 * DCS associated with the request 		 */
name|dcsp
operator|=
operator|(
name|Scsp_dcs
operator|*
operator|)
name|msg
operator|->
name|si_tok
expr_stmt|;
name|rc
operator|=
name|scsp_cfsm
argument_list|(
name|dcsp
argument_list|,
name|SCSP_CIFSM_UPD_RSP
argument_list|,
operator|(
name|Scsp_msg
operator|*
operator|)
literal|0
argument_list|,
name|msg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|scsp_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"invalid message type %d from server"
argument_list|,
name|msg
operator|->
name|si_type
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|UM_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send a Cache Indication to a server  *  * Arguments:  *	ssp	pointer to server block block  *  * Returns:  *	0	success  *	else	errno indicating reason for failure  *  */
end_comment

begin_function
name|int
name|scsp_send_cache_ind
parameter_list|(
name|ssp
parameter_list|)
name|Scsp_server
modifier|*
name|ssp
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|msg
decl_stmt|;
comment|/* 	 * Get storage for a server interface message 	 */
name|msg
operator|=
operator|(
name|Scsp_if_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_if_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_send_cache_ind: sizeof(Scsp_if_msg)"
argument_list|)
expr_stmt|;
block|}
name|UM_ZERO
argument_list|(
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_if_msg
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Fill out the message 	 */
name|msg
operator|->
name|si_type
operator|=
name|SCSP_CACHE_IND
expr_stmt|;
name|msg
operator|->
name|si_rc
operator|=
literal|0
expr_stmt|;
name|msg
operator|->
name|si_proto
operator|=
name|ssp
operator|->
name|ss_pid
expr_stmt|;
name|msg
operator|->
name|si_len
operator|=
sizeof|sizeof
argument_list|(
name|Scsp_if_msg_hdr
argument_list|)
expr_stmt|;
name|msg
operator|->
name|si_tok
operator|=
operator|(
name|u_long
operator|)
name|ssp
expr_stmt|;
comment|/* 	 * Send the message 	 */
name|rc
operator|=
name|scsp_if_sock_write
argument_list|(
name|ssp
operator|->
name|ss_sock
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|UM_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read data from a pending server connection  *  * Arguments:  *	psp	pointer to pending block that has data  *  * Returns:  *	0	success  *	else	errno indicating reason for failure  *  */
end_comment

begin_function
name|int
name|scsp_pending_read
parameter_list|(
name|psp
parameter_list|)
name|Scsp_pending
modifier|*
name|psp
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|Scsp_server
modifier|*
name|ssp
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|msg
decl_stmt|;
comment|/* 	 * Read the message from the pending socket 	 */
name|msg
operator|=
name|scsp_if_sock_read
argument_list|(
name|psp
operator|->
name|sp_sock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
block|{
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|pending_read_fail
goto|;
block|}
comment|/* 	 * Make sure this is configuration data 	 */
if|if
condition|(
name|msg
operator|->
name|si_type
operator|!=
name|SCSP_CFG_REQ
condition|)
block|{
name|scsp_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"invalid message type %d from pending server"
argument_list|,
name|msg
operator|->
name|si_type
argument_list|)
expr_stmt|;
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|pending_read_fail
goto|;
block|}
comment|/* 	 * Find the server this message is for 	 */
for|for
control|(
name|ssp
operator|=
name|scsp_server_head
init|;
name|ssp
condition|;
name|ssp
operator|=
name|ssp
operator|->
name|ss_next
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|ssp
operator|->
name|ss_intf
argument_list|,
name|msg
operator|->
name|si_cfg
operator|.
name|atmarp_netif
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
operator|!
name|ssp
condition|)
block|{
name|scsp_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"refused connection from server for %s"
argument_list|,
name|msg
operator|->
name|si_cfg
operator|.
name|atmarp_netif
argument_list|)
expr_stmt|;
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|config_reject
goto|;
block|}
comment|/* 	 * Make sure the server is ready to go 	 */
name|rc
operator|=
name|scsp_get_server_info
argument_list|(
name|ssp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
goto|goto
name|config_reject
goto|;
block|}
comment|/* 	 * Save the socket 	 */
name|ssp
operator|->
name|ss_sock
operator|=
name|psp
operator|->
name|sp_sock
expr_stmt|;
name|ssp
operator|->
name|ss_state
operator|=
name|SCSP_SS_CFG
expr_stmt|;
name|UNLINK
argument_list|(
name|psp
argument_list|,
name|Scsp_pending
argument_list|,
name|scsp_pending_head
argument_list|,
name|sp_next
argument_list|)
expr_stmt|;
name|UM_FREE
argument_list|(
name|psp
argument_list|)
expr_stmt|;
comment|/* 	 * Listen for connections from the server's DCSs 	 */
name|rc
operator|=
name|scsp_dcs_listen
argument_list|(
name|ssp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
block|{
name|rc
operator|=
name|errno
expr_stmt|;
goto|goto
name|config_reject
goto|;
block|}
comment|/* 	 * Respond to the configuration message 	 */
name|msg
operator|->
name|si_type
operator|=
name|SCSP_CFG_RSP
expr_stmt|;
name|msg
operator|->
name|si_rc
operator|=
name|SCSP_RSP_OK
expr_stmt|;
name|msg
operator|->
name|si_len
operator|=
sizeof|sizeof
argument_list|(
name|Scsp_if_msg_hdr
argument_list|)
expr_stmt|;
name|rc
operator|=
name|scsp_if_sock_write
argument_list|(
name|ssp
operator|->
name|ss_sock
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
goto|goto
name|config_error
goto|;
empty_stmt|;
block|}
comment|/* 	 * Ask the server to send us its cache 	 */
name|rc
operator|=
name|scsp_send_cache_ind
argument_list|(
name|ssp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
goto|goto
name|config_error
goto|;
block|}
name|UM_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|config_reject
label|:
comment|/* 	 * Respond to the configuration message 	 */
name|msg
operator|->
name|si_type
operator|=
name|SCSP_CFG_RSP
expr_stmt|;
name|msg
operator|->
name|si_rc
operator|=
name|SCSP_RSP_REJ
expr_stmt|;
name|msg
operator|->
name|si_len
operator|=
sizeof|sizeof
argument_list|(
name|Scsp_if_msg_hdr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|scsp_if_sock_write
argument_list|(
name|ssp
operator|->
name|ss_sock
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|config_error
label|:
if|if
condition|(
name|ssp
operator|->
name|ss_sock
operator|!=
operator|-
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|ssp
operator|->
name|ss_sock
argument_list|)
expr_stmt|;
name|ssp
operator|->
name|ss_sock
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ssp
operator|->
name|ss_dcs_lsock
operator|!=
operator|-
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|ssp
operator|->
name|ss_dcs_lsock
argument_list|)
expr_stmt|;
name|ssp
operator|->
name|ss_sock
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|ssp
operator|->
name|ss_state
operator|=
name|SCSP_SS_NULL
expr_stmt|;
name|UM_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
name|pending_read_fail
label|:
comment|/* 	 * Close the socket and free the pending read block 	 */
operator|(
name|void
operator|)
name|close
argument_list|(
name|psp
operator|->
name|sp_sock
argument_list|)
expr_stmt|;
name|UNLINK
argument_list|(
name|psp
argument_list|,
name|Scsp_pending
argument_list|,
name|scsp_pending_head
argument_list|,
name|sp_next
argument_list|)
expr_stmt|;
name|UM_FREE
argument_list|(
name|psp
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
condition|)
name|UM_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  * ===================================  * HARP  |  Host ATM Research Platform  * ===================================  *  *  * This Host ATM Research Platform ("HARP") file (the "Software") is  * made available by Network Computing Services, Inc. ("NetworkCS")  * "AS IS".  NetworkCS does not provide maintenance, improvements or  * support of any kind.  *  * NETWORKCS MAKES NO WARRANTIES OR REPRESENTATIONS, EXPRESS OR IMPLIED,  * INCLUDING, BUT NOT LIMITED TO, IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS FOR A PARTICULAR PURPOSE, AS TO ANY ELEMENT OF THE  * SOFTWARE OR ANY SUPPORT PROVIDED IN CONNECTION WITH THIS SOFTWARE.  * In no event shall NetworkCS be responsible for any damages, including  * but not limited to consequential damages, arising from or relating to  * any use of the Software or related support.  *  * Copyright 1994-1998 Network Computing Services, Inc.  *  * Copies of this Software may be made, however, the above copyright  * notice must be reproduced on all copies.  *  *	@(#) $FreeBSD$  *  */
end_comment

begin_comment
comment|/*  * Server Cache Synchronization Protocol (SCSP) Support  * ----------------------------------------------------  *  * SCSP message-handling routines  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netatm/port.h>
end_include

begin_include
include|#
directive|include
file|<netatm/queue.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_if.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sap.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sys.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<libatm.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|"scsp_msg.h"
end_include

begin_include
include|#
directive|include
file|"scsp_if.h"
end_include

begin_include
include|#
directive|include
file|"scsp_var.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"@(#) $FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Copy CSAS records into a CA record  *  * Arguments:  *	dcsp	pointer to DCS block for DCS  *	cap	pointer to CA record for CSASs  *  *  * Returns:  *	none  *  */
end_comment

begin_function
specifier|static
name|void
name|scsp_ca_csas_setup
parameter_list|(
name|dcsp
parameter_list|,
name|cap
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_ca
modifier|*
name|cap
decl_stmt|;
block|{
name|int
name|csas_len
decl_stmt|,
name|len
decl_stmt|,
name|mtu
decl_stmt|;
name|Scsp_server
modifier|*
name|ssp
init|=
name|dcsp
operator|->
name|sd_server
decl_stmt|;
name|Scsp_cse
modifier|*
name|csep
decl_stmt|,
modifier|*
name|next_csep
decl_stmt|;
name|Scsp_csa
modifier|*
name|csap
decl_stmt|;
comment|/* 	 * Loop through pending CSAS records 	 */
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|scsp_nhdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|scsp_nmcp
argument_list|)
operator|+
name|ssp
operator|->
name|ss_lsid
operator|.
name|id_len
operator|+
name|dcsp
operator|->
name|sd_dcsid
operator|.
name|id_len
expr_stmt|;
name|csas_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|scsp_ncsa
argument_list|)
operator|+
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_id_len
operator|+
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_ckey_len
expr_stmt|;
name|mtu
operator|=
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_mtu
expr_stmt|;
for|for
control|(
name|csep
operator|=
name|dcsp
operator|->
name|sd_ca_csas
init|;
name|csep
operator|&&
operator|(
name|len
operator|<
name|mtu
operator|-
name|csas_len
operator|)
condition|;
name|csep
operator|=
name|next_csep
control|)
block|{
name|next_csep
operator|=
name|csep
operator|->
name|sc_next
expr_stmt|;
name|csap
operator|=
name|scsp_cse2csas
argument_list|(
name|csep
argument_list|)
expr_stmt|;
name|LINK2TAIL
argument_list|(
name|csap
argument_list|,
name|Scsp_csa
argument_list|,
name|cap
operator|->
name|ca_csa_rec
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|len
operator|+=
name|csas_len
expr_stmt|;
name|UNLINK
argument_list|(
name|csep
argument_list|,
name|Scsp_cse
argument_list|,
name|dcsp
operator|->
name|sd_ca_csas
argument_list|,
name|sc_next
argument_list|)
expr_stmt|;
name|UM_FREE
argument_list|(
name|csep
argument_list|)
expr_stmt|;
name|cap
operator|->
name|ca_mcp
operator|.
name|rec_cnt
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Process CSA records from a CSU Request that may be in response to  * CSAS records sent in a CSUS  *  * Arguments:  *	dcsp	pointer to DCS control block  *	msg	pointer to received message  *  * Returns:  *	none  *  */
end_comment

begin_function
name|void
name|scsp_csus_ack
parameter_list|(
name|dcsp
parameter_list|,
name|msg
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|Scsp_csu_msg
modifier|*
name|csusp
decl_stmt|;
name|Scsp_csa
modifier|*
name|csap
decl_stmt|,
modifier|*
name|csasp
decl_stmt|,
modifier|*
name|next_csasp
decl_stmt|;
comment|/* 	 * If this isn't a CSU Request, or there's no outstanding CSUS, 	 * or the outstanding CSUS has already been satisfied, just 	 * return 	 */
if|if
condition|(
operator|!
name|msg
operator|||
name|msg
operator|->
name|sc_msg_type
operator|!=
name|SCSP_CSU_REQ_MSG
operator|||
operator|!
name|dcsp
operator|->
name|sd_csus_rexmt_msg
operator|||
operator|!
name|dcsp
operator|->
name|sd_csus_rexmt_msg
operator|->
name|sc_csu_msg
operator|||
operator|!
name|dcsp
operator|->
name|sd_csus_rexmt_msg
operator|->
name|sc_csu_msg
operator|->
name|csu_csa_rec
condition|)
return|return;
comment|/* 	 * Loop through the CSASs in the CSUS message, checking for 	 * each in the CSA records of the received CSU Request 	 */
name|csusp
operator|=
name|dcsp
operator|->
name|sd_csus_rexmt_msg
operator|->
name|sc_csu_msg
expr_stmt|;
for|for
control|(
name|csasp
operator|=
name|csusp
operator|->
name|csu_csa_rec
init|;
name|csasp
condition|;
name|csasp
operator|=
name|next_csasp
control|)
block|{
name|next_csasp
operator|=
name|csasp
operator|->
name|next
expr_stmt|;
for|for
control|(
name|csap
operator|=
name|msg
operator|->
name|sc_csu_msg
operator|->
name|csu_csa_rec
init|;
name|csap
condition|;
name|csap
operator|=
name|csap
operator|->
name|next
control|)
block|{
comment|/* 			 * If the records match, unlink and free the 			 * CSAS from the CSUS 			 */
if|if
condition|(
name|scsp_cmp_key
argument_list|(
operator|&
name|csap
operator|->
name|key
argument_list|,
operator|&
name|csasp
operator|->
name|key
argument_list|)
operator|==
literal|0
operator|&&
name|scsp_cmp_key
argument_list|(
operator|&
name|csap
operator|->
name|key
argument_list|,
operator|&
name|csasp
operator|->
name|key
argument_list|)
operator|==
literal|0
operator|&&
name|scsp_cmp_id
argument_list|(
operator|&
name|csap
operator|->
name|oid
argument_list|,
operator|&
name|csasp
operator|->
name|oid
argument_list|)
operator|==
literal|0
operator|&&
name|csap
operator|->
name|seq
operator|>=
name|csasp
operator|->
name|seq
condition|)
block|{
name|UNLINK
argument_list|(
name|csasp
argument_list|,
name|Scsp_csa
argument_list|,
name|csusp
operator|->
name|csu_csa_rec
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|SCSP_FREE_CSA
argument_list|(
name|csasp
argument_list|)
expr_stmt|;
name|dcsp
operator|->
name|sd_csus_rexmt_msg
operator|->
name|sc_csu_msg
operator|->
name|csu_mcp
operator|.
name|rec_cnt
operator|--
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|csusp
operator|->
name|csu_csa_rec
operator|==
operator|(
name|Scsp_csa
operator|*
operator|)
literal|0
condition|)
block|{
comment|/* 		 * All CSASs in the CSUS message have been 		 * answered.  Stop the timer and free the 		 * saved message. 		 */
name|HARP_CANCEL
argument_list|(
operator|&
name|dcsp
operator|->
name|sd_csus_rexmt_t
argument_list|)
expr_stmt|;
name|scsp_free_msg
argument_list|(
name|dcsp
operator|->
name|sd_csus_rexmt_msg
argument_list|)
expr_stmt|;
name|dcsp
operator|->
name|sd_csus_rexmt_msg
operator|=
operator|(
name|Scsp_msg
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* 		 * If the CRL isn't empty, send another CSUS 		 */
if|if
condition|(
name|dcsp
operator|->
name|sd_crl
condition|)
block|{
operator|(
name|void
operator|)
name|scsp_send_csus
argument_list|(
name|dcsp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Send a CA message  *  * Arguments:  *	dcsp	pointer to DCS block for DCS  *  * Returns:  *	0	message sent OK  *	else	errno indicating reason for failure  *  */
end_comment

begin_function
name|int
name|scsp_send_ca
parameter_list|(
name|dcsp
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|Scsp_msg
modifier|*
name|ca_msg
decl_stmt|;
name|Scsp_ca
modifier|*
name|cap
decl_stmt|;
name|Scsp_server
modifier|*
name|ssp
init|=
name|dcsp
operator|->
name|sd_server
decl_stmt|;
comment|/* 	 * Get memory for a CA message 	 */
name|ca_msg
operator|=
operator|(
name|Scsp_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ca_msg
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_send_ca: sizeof(Scsp_msg)"
argument_list|)
expr_stmt|;
block|}
name|cap
operator|=
operator|(
name|Scsp_ca
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_ca
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cap
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_send_ca: sizeof(Scsp_ca)"
argument_list|)
expr_stmt|;
block|}
name|UM_ZERO
argument_list|(
name|ca_msg
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_msg
argument_list|)
argument_list|)
expr_stmt|;
name|UM_ZERO
argument_list|(
name|cap
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_ca
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Fill out constant fields 	 */
name|ca_msg
operator|->
name|sc_msg_type
operator|=
name|SCSP_CA_MSG
expr_stmt|;
name|ca_msg
operator|->
name|sc_ca
operator|=
name|cap
expr_stmt|;
name|cap
operator|->
name|ca_seq
operator|=
name|dcsp
operator|->
name|sd_ca_seq
expr_stmt|;
name|cap
operator|->
name|ca_mcp
operator|.
name|pid
operator|=
name|ssp
operator|->
name|ss_pid
expr_stmt|;
name|cap
operator|->
name|ca_mcp
operator|.
name|sgid
operator|=
name|ssp
operator|->
name|ss_sgid
expr_stmt|;
name|cap
operator|->
name|ca_mcp
operator|.
name|sid
operator|=
name|ssp
operator|->
name|ss_lsid
expr_stmt|;
name|cap
operator|->
name|ca_mcp
operator|.
name|rid
operator|=
name|dcsp
operator|->
name|sd_dcsid
expr_stmt|;
comment|/* 	 * Fill out state-dependent fields 	 */
switch|switch
condition|(
name|dcsp
operator|->
name|sd_ca_state
condition|)
block|{
case|case
name|SCSP_CAFSM_NEG
case|:
name|cap
operator|->
name|ca_m
operator|=
literal|1
expr_stmt|;
name|cap
operator|->
name|ca_i
operator|=
literal|1
expr_stmt|;
name|cap
operator|->
name|ca_o
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SCSP_CAFSM_MASTER
case|:
name|cap
operator|->
name|ca_m
operator|=
literal|1
expr_stmt|;
name|cap
operator|->
name|ca_i
operator|=
literal|0
expr_stmt|;
name|scsp_ca_csas_setup
argument_list|(
name|dcsp
argument_list|,
name|cap
argument_list|)
expr_stmt|;
name|cap
operator|->
name|ca_o
operator|=
name|dcsp
operator|->
name|sd_ca_csas
operator|!=
operator|(
name|Scsp_cse
operator|*
operator|)
literal|0
expr_stmt|;
break|break;
case|case
name|SCSP_CAFSM_SLAVE
case|:
name|cap
operator|->
name|ca_m
operator|=
literal|0
expr_stmt|;
name|cap
operator|->
name|ca_i
operator|=
literal|0
expr_stmt|;
name|scsp_ca_csas_setup
argument_list|(
name|dcsp
argument_list|,
name|cap
argument_list|)
expr_stmt|;
name|cap
operator|->
name|ca_o
operator|=
name|dcsp
operator|->
name|sd_ca_csas
operator|!=
operator|(
name|Scsp_cse
operator|*
operator|)
literal|0
expr_stmt|;
break|break;
default|default:
name|scsp_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Invalid state in scsp_send_ca"
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
comment|/* 	 * Send the CA message and save a pointer to it in case 	 * it needs to be retransmitted 	 */
name|rc
operator|=
name|scsp_send_msg
argument_list|(
name|dcsp
argument_list|,
name|ca_msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
block|{
name|dcsp
operator|->
name|sd_ca_rexmt_msg
operator|=
name|ca_msg
expr_stmt|;
block|}
else|else
block|{
name|scsp_free_msg
argument_list|(
name|ca_msg
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send a CSU Solicit message  *  * Arguments:  *	dcsp	pointer to DCS block for DCS  *  * Returns:  *	0	message sent OK  *	else	errno indicating reason for failure  *  */
end_comment

begin_function
name|int
name|scsp_send_csus
parameter_list|(
name|dcsp
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
block|{
name|int
name|csas_len
decl_stmt|,
name|len
decl_stmt|,
name|mtu
decl_stmt|,
name|rc
decl_stmt|;
name|Scsp_msg
modifier|*
name|csus_msg
decl_stmt|;
name|Scsp_csu_msg
modifier|*
name|csusp
decl_stmt|;
name|Scsp_csa
modifier|*
name|csasp
decl_stmt|,
modifier|*
name|next_csasp
decl_stmt|;
name|Scsp_server
modifier|*
name|ssp
init|=
name|dcsp
operator|->
name|sd_server
decl_stmt|;
comment|/* 	 * If we have a mesage saved for retransmission, use it. 	 * If not, get memory for a new one. 	 */
if|if
condition|(
name|dcsp
operator|->
name|sd_csus_rexmt_msg
condition|)
block|{
name|csus_msg
operator|=
name|dcsp
operator|->
name|sd_csus_rexmt_msg
expr_stmt|;
name|csusp
operator|=
name|csus_msg
operator|->
name|sc_csu_msg
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Get memory for a CSUS message 		 */
name|csus_msg
operator|=
operator|(
name|Scsp_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|csus_msg
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_send_csus: sizeof(Scsp_msg)"
argument_list|)
expr_stmt|;
block|}
name|csusp
operator|=
operator|(
name|Scsp_csu_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_csu_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|csusp
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_send_csus: sizeof(Scsp_csu_msg)"
argument_list|)
expr_stmt|;
block|}
name|UM_ZERO
argument_list|(
name|csus_msg
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_msg
argument_list|)
argument_list|)
expr_stmt|;
name|UM_ZERO
argument_list|(
name|csusp
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_csu_msg
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * Fill out constant fields 		 */
name|csus_msg
operator|->
name|sc_msg_type
operator|=
name|SCSP_CSUS_MSG
expr_stmt|;
name|csus_msg
operator|->
name|sc_csu_msg
operator|=
name|csusp
expr_stmt|;
name|csusp
operator|->
name|csu_mcp
operator|.
name|pid
operator|=
name|ssp
operator|->
name|ss_pid
expr_stmt|;
name|csusp
operator|->
name|csu_mcp
operator|.
name|sgid
operator|=
name|ssp
operator|->
name|ss_sgid
expr_stmt|;
name|csusp
operator|->
name|csu_mcp
operator|.
name|sid
operator|=
name|ssp
operator|->
name|ss_lsid
expr_stmt|;
name|csusp
operator|->
name|csu_mcp
operator|.
name|rid
operator|=
name|dcsp
operator|->
name|sd_dcsid
expr_stmt|;
block|}
comment|/* 	 * Move CSAS records from CRL into message 	 */
name|mtu
operator|=
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_mtu
expr_stmt|;
name|csas_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|scsp_ncsa
argument_list|)
operator|+
name|ssp
operator|->
name|ss_id_len
operator|+
name|ssp
operator|->
name|ss_ckey_len
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|scsp_nhdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|scsp_nmcp
argument_list|)
operator|+
literal|2
operator|*
name|ssp
operator|->
name|ss_id_len
operator|+
name|csas_len
operator|*
operator|(
name|csusp
operator|->
name|csu_mcp
operator|.
name|rec_cnt
operator|+
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|csasp
operator|=
name|dcsp
operator|->
name|sd_crl
init|;
name|csasp
operator|&&
operator|(
operator|(
name|len
operator|+
name|csas_len
operator|)
operator|<
name|mtu
operator|)
condition|;
name|csasp
operator|=
name|next_csasp
operator|,
name|len
operator|+=
name|csas_len
control|)
block|{
name|next_csasp
operator|=
name|csasp
operator|->
name|next
expr_stmt|;
name|csusp
operator|->
name|csu_mcp
operator|.
name|rec_cnt
operator|++
expr_stmt|;
name|UNLINK
argument_list|(
name|csasp
argument_list|,
name|Scsp_csa
argument_list|,
name|dcsp
operator|->
name|sd_crl
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|LINK2TAIL
argument_list|(
name|csasp
argument_list|,
name|Scsp_csa
argument_list|,
name|csusp
operator|->
name|csu_csa_rec
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|csasp
operator|->
name|hops
operator|=
literal|1
expr_stmt|;
block|}
comment|/* 	 * Send the CSUS message and save a pointer to it in case 	 * it needs to be retransmitted 	 */
name|rc
operator|=
name|scsp_send_msg
argument_list|(
name|dcsp
argument_list|,
name|csus_msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Success--Save a pointer to the message and 		 * start the CSUS retransmit timer 		 */
name|dcsp
operator|->
name|sd_csus_rexmt_msg
operator|=
name|csus_msg
expr_stmt|;
name|HARP_TIMER
argument_list|(
operator|&
name|dcsp
operator|->
name|sd_csus_rexmt_t
argument_list|,
name|dcsp
operator|->
name|sd_csus_rexmt_int
argument_list|,
name|scsp_csus_retran_timeout
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Error--free the CSUS message 		 */
name|scsp_free_msg
argument_list|(
name|csus_msg
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send a CSU Request message  *  * Arguments:  *	dcsp	pointer to DCS block for DCS  *	csap	pointer to CSAs to include  *  * Returns:  *	0	message sent OK  *	else	errno indicating reason for failure  *  */
end_comment

begin_function
name|int
name|scsp_send_csu_req
parameter_list|(
name|dcsp
parameter_list|,
name|csap
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_csa
modifier|*
name|csap
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|Scsp_server
modifier|*
name|ssp
init|=
name|dcsp
operator|->
name|sd_server
decl_stmt|;
name|Scsp_csa
modifier|*
name|cnt_csap
decl_stmt|;
name|Scsp_msg
modifier|*
name|csu_msg
decl_stmt|;
name|Scsp_csu_msg
modifier|*
name|csup
decl_stmt|;
name|Scsp_csu_rexmt
modifier|*
name|rxp
decl_stmt|;
comment|/* 	 * Return if CSA list is empty 	 */
if|if
condition|(
operator|!
name|csap
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* 	 * Get memory for a CSU Req message 	 */
name|csu_msg
operator|=
operator|(
name|Scsp_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|csu_msg
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_send_csu_req: sizeof(Scsp_msg)"
argument_list|)
expr_stmt|;
block|}
name|csup
operator|=
operator|(
name|Scsp_csu_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_csu_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|csup
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_send_csu_req: sizeof(Scsp_csu_msg)"
argument_list|)
expr_stmt|;
block|}
name|UM_ZERO
argument_list|(
name|csu_msg
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_msg
argument_list|)
argument_list|)
expr_stmt|;
name|UM_ZERO
argument_list|(
name|csup
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_csu_msg
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Get memory for a CSU Req retransmission queue entry 	 */
name|rxp
operator|=
operator|(
name|Scsp_csu_rexmt
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_csu_rexmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rxp
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_send_csu_req: sizeof(Scsp_csu_rexmt)"
argument_list|)
expr_stmt|;
block|}
name|UM_ZERO
argument_list|(
name|rxp
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_csu_rexmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Fill out constant fields 	 */
name|csu_msg
operator|->
name|sc_msg_type
operator|=
name|SCSP_CSU_REQ_MSG
expr_stmt|;
name|csu_msg
operator|->
name|sc_csu_msg
operator|=
name|csup
expr_stmt|;
name|csup
operator|->
name|csu_mcp
operator|.
name|pid
operator|=
name|ssp
operator|->
name|ss_pid
expr_stmt|;
name|csup
operator|->
name|csu_mcp
operator|.
name|sgid
operator|=
name|ssp
operator|->
name|ss_sgid
expr_stmt|;
name|csup
operator|->
name|csu_mcp
operator|.
name|sid
operator|=
name|ssp
operator|->
name|ss_lsid
expr_stmt|;
name|csup
operator|->
name|csu_mcp
operator|.
name|rid
operator|=
name|dcsp
operator|->
name|sd_dcsid
expr_stmt|;
comment|/* 	 * Put the CSA list into the message 	 */
name|csup
operator|->
name|csu_csa_rec
operator|=
name|csap
expr_stmt|;
for|for
control|(
name|cnt_csap
operator|=
name|csap
init|;
name|cnt_csap
condition|;
name|cnt_csap
operator|=
name|cnt_csap
operator|->
name|next
control|)
block|{
name|csup
operator|->
name|csu_mcp
operator|.
name|rec_cnt
operator|++
expr_stmt|;
block|}
comment|/* 	 * Send the CSU Request 	 */
name|rc
operator|=
name|scsp_send_msg
argument_list|(
name|dcsp
argument_list|,
name|csu_msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|scsp_free_msg
argument_list|(
name|csu_msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
name|UM_FREE
argument_list|(
name|csu_msg
argument_list|)
expr_stmt|;
name|UM_FREE
argument_list|(
name|csup
argument_list|)
expr_stmt|;
comment|/* 	 * Save the CSA entries on the CSU Request retransmission 	 * queue and start the retransmission timer 	 */
name|rxp
operator|->
name|sr_dcs
operator|=
name|dcsp
expr_stmt|;
name|rxp
operator|->
name|sr_csa
operator|=
name|csap
expr_stmt|;
name|HARP_TIMER
argument_list|(
operator|&
name|rxp
operator|->
name|sr_t
argument_list|,
name|dcsp
operator|->
name|sd_csu_rexmt_int
argument_list|,
name|scsp_csu_req_retran_timeout
argument_list|)
expr_stmt|;
name|LINK2TAIL
argument_list|(
name|rxp
argument_list|,
name|Scsp_csu_rexmt
argument_list|,
name|dcsp
operator|->
name|sd_csu_rexmt
argument_list|,
name|sr_next
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send a CSU Reply message  *  * Arguments:  *	dcsp	pointer to DCS block for DCS  *	csap	pointer to CSAs to include  *  * Returns:  *	0	message sent OK  *	errno	reason for failure  *  */
end_comment

begin_function
name|int
name|scsp_send_csu_reply
parameter_list|(
name|dcsp
parameter_list|,
name|csap
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_csa
modifier|*
name|csap
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|Scsp_server
modifier|*
name|ssp
init|=
name|dcsp
operator|->
name|sd_server
decl_stmt|;
name|Scsp_csa
modifier|*
name|csap1
decl_stmt|;
name|Scsp_msg
modifier|*
name|csu_msg
decl_stmt|;
name|Scsp_csu_msg
modifier|*
name|csup
decl_stmt|;
comment|/* 	 * Return if CSA list is empty 	 */
if|if
condition|(
operator|!
name|csap
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* 	 * Get memory for a CSU Reply message 	 */
name|csu_msg
operator|=
operator|(
name|Scsp_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|csu_msg
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_send_csu_reply: sizeof(Scsp_msg)"
argument_list|)
expr_stmt|;
block|}
name|csup
operator|=
operator|(
name|Scsp_csu_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_csu_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|csup
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_send_csu_reply: sizeof(Scsp_csu_msg)"
argument_list|)
expr_stmt|;
block|}
name|UM_ZERO
argument_list|(
name|csu_msg
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_msg
argument_list|)
argument_list|)
expr_stmt|;
name|UM_ZERO
argument_list|(
name|csup
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_csu_msg
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Fill out constant fields 	 */
name|csu_msg
operator|->
name|sc_msg_type
operator|=
name|SCSP_CSU_REPLY_MSG
expr_stmt|;
name|csu_msg
operator|->
name|sc_csu_msg
operator|=
name|csup
expr_stmt|;
name|csup
operator|->
name|csu_mcp
operator|.
name|pid
operator|=
name|ssp
operator|->
name|ss_pid
expr_stmt|;
name|csup
operator|->
name|csu_mcp
operator|.
name|sgid
operator|=
name|ssp
operator|->
name|ss_sgid
expr_stmt|;
name|csup
operator|->
name|csu_mcp
operator|.
name|sid
operator|=
name|ssp
operator|->
name|ss_lsid
expr_stmt|;
name|csup
operator|->
name|csu_mcp
operator|.
name|rid
operator|=
name|dcsp
operator|->
name|sd_dcsid
expr_stmt|;
comment|/* 	 * Put the CSA list into the message.  Convert the CSAs into 	 * CSASs by freeing the protocol-specific portion. 	 */
name|csup
operator|->
name|csu_csa_rec
operator|=
name|csap
expr_stmt|;
for|for
control|(
name|csap1
operator|=
name|csap
init|;
name|csap1
condition|;
name|csap1
operator|=
name|csap1
operator|->
name|next
control|)
block|{
switch|switch
condition|(
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_pid
condition|)
block|{
comment|/* 		 * We currently only support ATMARP 		 */
case|case
name|SCSP_PROTO_ATMARP
case|:
if|if
condition|(
name|csap1
operator|->
name|atmarp_data
condition|)
block|{
name|UM_FREE
argument_list|(
name|csap1
operator|->
name|atmarp_data
argument_list|)
expr_stmt|;
name|csap1
operator|->
name|atmarp_data
operator|=
operator|(
name|Scsp_atmarp_csa
operator|*
operator|)
literal|0
expr_stmt|;
block|}
break|break;
block|}
name|csup
operator|->
name|csu_mcp
operator|.
name|rec_cnt
operator|++
expr_stmt|;
block|}
comment|/* 	 * Send the CSU Reply 	 */
name|rc
operator|=
name|scsp_send_msg
argument_list|(
name|dcsp
argument_list|,
name|csu_msg
argument_list|)
expr_stmt|;
name|scsp_free_msg
argument_list|(
name|csu_msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send a Hello message  *  * Arguments:  *	dcsp	pointer to DCS control block  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
name|int
name|scsp_send_hello
parameter_list|(
name|dcsp
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|Scsp_msg
modifier|*
name|hello
decl_stmt|;
name|Scsp_hello
modifier|*
name|hp
decl_stmt|;
comment|/* 	 * Get memory for a Hello message 	 */
name|hello
operator|=
operator|(
name|Scsp_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hello
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_send_hello: sizeof(Scsp_msg)"
argument_list|)
expr_stmt|;
block|}
name|UM_ZERO
argument_list|(
name|hello
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_msg
argument_list|)
argument_list|)
expr_stmt|;
name|hp
operator|=
operator|(
name|Scsp_hello
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_hello
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hp
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_send_hello: sizeof(Scsp_hello)"
argument_list|)
expr_stmt|;
block|}
name|UM_ZERO
argument_list|(
name|hp
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_hello
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Set up the Hello message 	 */
name|hello
operator|->
name|sc_msg_type
operator|=
name|SCSP_HELLO_MSG
expr_stmt|;
name|hello
operator|->
name|sc_hello
operator|=
name|hp
expr_stmt|;
name|hp
operator|->
name|hello_int
operator|=
name|SCSP_HELLO_Interval
expr_stmt|;
name|hp
operator|->
name|dead_factor
operator|=
name|SCSP_HELLO_DF
expr_stmt|;
name|hp
operator|->
name|family_id
operator|=
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_fid
expr_stmt|;
name|hp
operator|->
name|hello_mcp
operator|.
name|pid
operator|=
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_pid
expr_stmt|;
name|hp
operator|->
name|hello_mcp
operator|.
name|sgid
operator|=
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_sgid
expr_stmt|;
name|hp
operator|->
name|hello_mcp
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|hp
operator|->
name|hello_mcp
operator|.
name|rec_cnt
operator|=
literal|0
expr_stmt|;
name|hp
operator|->
name|hello_mcp
operator|.
name|sid
operator|=
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_lsid
expr_stmt|;
name|hp
operator|->
name|hello_mcp
operator|.
name|rid
operator|=
name|dcsp
operator|->
name|sd_dcsid
expr_stmt|;
comment|/* 	 * Send and free the message 	 */
name|rc
operator|=
name|scsp_send_msg
argument_list|(
name|dcsp
argument_list|,
name|hello
argument_list|)
expr_stmt|;
name|scsp_free_msg
argument_list|(
name|hello
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

end_unit


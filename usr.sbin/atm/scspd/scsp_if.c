begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  * ===================================  * HARP  |  Host ATM Research Platform  * ===================================  *  *  * This Host ATM Research Platform ("HARP") file (the "Software") is  * made available by Network Computing Services, Inc. ("NetworkCS")  * "AS IS".  NetworkCS does not provide maintenance, improvements or  * support of any kind.  *  * NETWORKCS MAKES NO WARRANTIES OR REPRESENTATIONS, EXPRESS OR IMPLIED,  * INCLUDING, BUT NOT LIMITED TO, IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS FOR A PARTICULAR PURPOSE, AS TO ANY ELEMENT OF THE  * SOFTWARE OR ANY SUPPORT PROVIDED IN CONNECTION WITH THIS SOFTWARE.  * In no event shall NetworkCS be responsible for any damages, including  * but not limited to consequential damages, arising from or relating to  * any use of the Software or related support.  *  * Copyright 1994-1998 Network Computing Services, Inc.  *  * Copies of this Software may be made, however, the above copyright  * notice must be reproduced on all copies.  *  *	@(#) $FreeBSD$  *  */
end_comment

begin_comment
comment|/*  * Server Cache Synchronization Protocol (SCSP) Support  * ----------------------------------------------------  *  * Interface to client server protocol  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netatm/port.h>
end_include

begin_include
include|#
directive|include
file|<netatm/queue.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_if.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sap.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sys.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<libatm.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"scsp_msg.h"
end_include

begin_include
include|#
directive|include
file|"scsp_if.h"
end_include

begin_include
include|#
directive|include
file|"scsp_var.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"@(#) $FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * SCSP client server interface FSM actions  */
end_comment

begin_define
define|#
directive|define
name|SCSP_CIFSM_ACTION_CNT
value|11
end_define

begin_decl_stmt
name|int
name|scsp_client_act_00
name|__P
argument_list|(
operator|(
name|Scsp_dcs
operator|*
operator|,
name|Scsp_msg
operator|*
operator|,
name|Scsp_if_msg
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scsp_client_act_01
name|__P
argument_list|(
operator|(
name|Scsp_dcs
operator|*
operator|,
name|Scsp_msg
operator|*
operator|,
name|Scsp_if_msg
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scsp_client_act_02
name|__P
argument_list|(
operator|(
name|Scsp_dcs
operator|*
operator|,
name|Scsp_msg
operator|*
operator|,
name|Scsp_if_msg
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scsp_client_act_03
name|__P
argument_list|(
operator|(
name|Scsp_dcs
operator|*
operator|,
name|Scsp_msg
operator|*
operator|,
name|Scsp_if_msg
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scsp_client_act_04
name|__P
argument_list|(
operator|(
name|Scsp_dcs
operator|*
operator|,
name|Scsp_msg
operator|*
operator|,
name|Scsp_if_msg
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scsp_client_act_05
name|__P
argument_list|(
operator|(
name|Scsp_dcs
operator|*
operator|,
name|Scsp_msg
operator|*
operator|,
name|Scsp_if_msg
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scsp_client_act_06
name|__P
argument_list|(
operator|(
name|Scsp_dcs
operator|*
operator|,
name|Scsp_msg
operator|*
operator|,
name|Scsp_if_msg
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scsp_client_act_07
name|__P
argument_list|(
operator|(
name|Scsp_dcs
operator|*
operator|,
name|Scsp_msg
operator|*
operator|,
name|Scsp_if_msg
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scsp_client_act_08
name|__P
argument_list|(
operator|(
name|Scsp_dcs
operator|*
operator|,
name|Scsp_msg
operator|*
operator|,
name|Scsp_if_msg
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scsp_client_act_09
name|__P
argument_list|(
operator|(
name|Scsp_dcs
operator|*
operator|,
name|Scsp_msg
operator|*
operator|,
name|Scsp_if_msg
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scsp_client_act_10
name|__P
argument_list|(
operator|(
name|Scsp_dcs
operator|*
operator|,
name|Scsp_msg
operator|*
operator|,
name|Scsp_if_msg
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|scsp_action_vector
index|[
name|SCSP_CIFSM_ACTION_CNT
index|]
function_decl|)
parameter_list|()
init|=
block|{
name|scsp_client_act_00
operator|,
function_decl|scsp_client_act_01
operator|,
function_decl|scsp_client_act_02
operator|,
function_decl|scsp_client_act_03
operator|,
function_decl|scsp_client_act_04
operator|,
function_decl|scsp_client_act_05
operator|,
function_decl|scsp_client_act_06
operator|,
function_decl|scsp_client_act_07
operator|,
function_decl|scsp_client_act_08
operator|,
function_decl|scsp_client_act_09
operator|,
function_decl|scsp_client_act_10
end_function_decl

begin_comment
unit|};
comment|/*  * Client server interface FSM state table  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|client_state_table
index|[
name|SCSP_CIFSM_EVENT_CNT
index|]
index|[
name|SCSP_CIFSM_STATE_CNT
index|]
init|=
block|{
comment|/* 0   1   2   3  */
block|{
literal|1
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|}
block|,
comment|/*  0 */
block|{
literal|2
block|,
literal|5
block|,
literal|5
block|,
literal|5
block|}
block|,
comment|/*  1 */
block|{
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/*  2 */
block|{
literal|0
block|,
literal|6
block|,
literal|6
block|,
literal|1
block|}
block|,
comment|/*  3 */
block|{
literal|1
block|,
literal|0
block|,
literal|7
block|,
literal|7
block|}
block|,
comment|/*  4 */
block|{
literal|7
block|,
literal|7
block|,
literal|7
block|,
literal|7
block|}
block|,
comment|/*  5 */
block|{
literal|1
block|,
literal|1
block|,
literal|8
block|,
literal|8
block|}
block|,
comment|/*  6 */
block|{
literal|0
block|,
literal|0
block|,
literal|10
block|,
literal|10
block|}
block|,
comment|/*  7 */
block|{
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|}
block|,
comment|/*  8 */
block|{
literal|0
block|,
literal|0
block|,
literal|9
block|,
literal|9
block|}
comment|/*  9 */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * SCSP client server interface finite state machine  *  * Arguments:  *	ssp	pointer to server control block  *	event	the event which has occurred  *	msg	pointer to message from DCS, if there is one  *	cmsg	pointer to message from server, if there is one  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
name|int
name|scsp_cfsm
parameter_list|(
name|dcsp
parameter_list|,
name|event
parameter_list|,
name|msg
parameter_list|,
name|cmsg
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|int
name|event
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|cmsg
decl_stmt|;
block|{
name|int
name|action
decl_stmt|,
name|rc
decl_stmt|,
name|state
decl_stmt|;
comment|/* 	 * Select an action from the state table 	 */
name|state
operator|=
name|dcsp
operator|->
name|sd_client_state
expr_stmt|;
name|action
operator|=
name|client_state_table
index|[
name|event
index|]
index|[
name|state
index|]
expr_stmt|;
if|if
condition|(
name|scsp_trace_mode
operator|&
name|SCSP_TRACE_CFSM
condition|)
block|{
name|scsp_trace
argument_list|(
literal|"Server I/F FSM: state=%d, event=%d, action=%d\n"
argument_list|,
name|state
argument_list|,
name|event
argument_list|,
name|action
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|action
operator|>=
name|SCSP_CIFSM_ACTION_CNT
operator|||
name|action
operator|<=
literal|0
condition|)
block|{
name|scsp_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Server I/F FSM--invalid action %d; state=%d, event=%d"
argument_list|,
name|action
argument_list|,
name|dcsp
operator|->
name|sd_client_state
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Perform the selected action 	 */
name|rc
operator|=
name|scsp_action_vector
index|[
name|action
index|]
operator|(
name|dcsp
operator|,
name|msg
operator|,
name|cmsg
operator|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * SCSP client server interface finite state machine action 0  * Unexpected action -- log an error message  *  * Arguments:  *	dcsp	pointer to DCS control block  *	msg	pointer to message from DCS (ignored)  *	cmsg	pointer to message from server (ignored)  *  * Returns:  *	EOPNOTSUPP	always returns EOPNOTSUPP  *  */
end_comment

begin_function
name|int
name|scsp_client_act_00
parameter_list|(
name|dcsp
parameter_list|,
name|msg
parameter_list|,
name|cmsg
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|cmsg
decl_stmt|;
block|{
name|scsp_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Server I/F FSM error--unexpected action, state=%d"
argument_list|,
name|dcsp
operator|->
name|sd_client_state
argument_list|)
expr_stmt|;
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * SCSP client server interface finite state machine action 1  *  * Ignore an event  *  * Arguments:  *	dcsp	pointer to DCS control block  *	msg	pointer to message from DCS  *	cmsg	pointer to message from server  *  * Returns:  *	0	always returns 0  *  */
end_comment

begin_function
name|int
name|scsp_client_act_01
parameter_list|(
name|dcsp
parameter_list|,
name|msg
parameter_list|,
name|cmsg
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|cmsg
decl_stmt|;
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * SCSP client server interface finite state machine action 2  *  * CA FSM went to Cache Summarize state--go to Summarize  *  * Arguments:  *	dcsp	pointer to DCS control block  *	msg	pointer to message from DCS  *	cmsg	pointer to message from server  *  * Returns:  *	0	success  *	else	errno describing error  *  */
end_comment

begin_function
name|int
name|scsp_client_act_02
parameter_list|(
name|dcsp
parameter_list|,
name|msg
parameter_list|,
name|cmsg
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|cmsg
decl_stmt|;
block|{
comment|/* 	 * Set the new state 	 */
name|dcsp
operator|->
name|sd_client_state
operator|=
name|SCSP_CIFSM_SUM
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * SCSP client server interface finite state machine action 3  *  * CA FSM went down--clean up and go to Null  *  * Arguments:  *	dcsp	pointer to DCS control block  *	msg	pointer to message from DCS  *	cmsg	pointer to message from server  *  * Returns:  *	0	success  *	else	errno describing error  *  */
end_comment

begin_function
name|int
name|scsp_client_act_03
parameter_list|(
name|dcsp
parameter_list|,
name|msg
parameter_list|,
name|cmsg
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|cmsg
decl_stmt|;
block|{
comment|/* 	 * Set the new state 	 */
name|dcsp
operator|->
name|sd_client_state
operator|=
name|SCSP_CIFSM_NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * SCSP client server interface finite state machine action 4  *  * CA FSM went to Update Cache state--go to Update state  *  * Arguments:  *	dcsp	pointer to DCS control block  *	msg	pointer to message from DCS  *	cmsg	pointer to message from server  *  * Returns:  *	0	success  *	else	errno describing error  *  */
end_comment

begin_function
name|int
name|scsp_client_act_04
parameter_list|(
name|dcsp
parameter_list|,
name|msg
parameter_list|,
name|cmsg
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|cmsg
decl_stmt|;
block|{
comment|/* 	 * Set the new state 	 */
name|dcsp
operator|->
name|sd_client_state
operator|=
name|SCSP_CIFSM_UPD
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * SCSP client server interface finite state machine action 5  *  * The CA FSM went to Cache Summarize state from Summarize,  * Update, or Aligned, implying that the CA FSM went down and came  * back up--copy the server's cache to the DCSs CSAS list and go to  * Summarize state  *  * Arguments:  *	dcsp	pointer to DCS control block  *	msg	pointer to message from DCS  *	cmsg	pointer to message from server  *  * Returns:  *	0	success  *	else	errno describing error  *  */
end_comment

begin_function
name|int
name|scsp_client_act_05
parameter_list|(
name|dcsp
parameter_list|,
name|msg
parameter_list|,
name|cmsg
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|cmsg
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|Scsp_cse
modifier|*
name|csep
decl_stmt|,
modifier|*
name|ncsep
decl_stmt|;
comment|/* 	 * Copy the cache summmary to the CSAS list 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SCSP_HASHSZ
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|csep
operator|=
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_cache
index|[
name|i
index|]
init|;
name|csep
condition|;
name|csep
operator|=
name|csep
operator|->
name|sc_next
control|)
block|{
name|ncsep
operator|=
name|scsp_dup_cse
argument_list|(
name|csep
argument_list|)
expr_stmt|;
name|LINK2TAIL
argument_list|(
name|ncsep
argument_list|,
name|Scsp_cse
argument_list|,
name|dcsp
operator|->
name|sd_ca_csas
argument_list|,
name|sc_next
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Set the new state 	 */
name|dcsp
operator|->
name|sd_client_state
operator|=
name|SCSP_CIFSM_SUM
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * SCSP client server interface finite state machine action 6  *  * CA FSM went to Aligned state--go to Aligned  *  * Arguments:  *	dcsp	pointer to DCS control block  *	msg	pointer to message from DCS  *	cmsg	pointer to message from server  *  * Returns:  *	0	success  *	else	errno describing error  *  */
end_comment

begin_function
name|int
name|scsp_client_act_06
parameter_list|(
name|dcsp
parameter_list|,
name|msg
parameter_list|,
name|cmsg
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|cmsg
decl_stmt|;
block|{
comment|/* 	 * Set the new state 	 */
name|dcsp
operator|->
name|sd_client_state
operator|=
name|SCSP_CIFSM_ALIGN
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * SCSP client server interface finite state machine action 7  *  * We received a Solicit Rsp or Update Req from the server--pass it  * to the CA FSM  *  * Arguments:  *	dcsp	pointer to DCS control block  *	msg	pointer to message from DCS  *	cmsg	pointer to message from server  *  * Returns:  *	0	success  *	else	errno describing error  *  */
end_comment

begin_function
name|int
name|scsp_client_act_07
parameter_list|(
name|dcsp
parameter_list|,
name|msg
parameter_list|,
name|cmsg
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|cmsg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|Scsp_csa
modifier|*
name|csap
decl_stmt|;
name|Scsp_atmarp_csa
modifier|*
name|acp
decl_stmt|;
comment|/* 	 * Allocate memory for a CSA record 	 */
name|csap
operator|=
operator|(
name|Scsp_csa
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_csa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|csap
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_client_act_07: sizeof(Scsp_csa)"
argument_list|)
expr_stmt|;
block|}
name|acp
operator|=
operator|(
name|Scsp_atmarp_csa
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_atmarp_csa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|acp
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_client_act_07: sizeof(Scsp_atmarp_csa)"
argument_list|)
expr_stmt|;
block|}
name|UM_ZERO
argument_list|(
name|csap
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_csa
argument_list|)
argument_list|)
expr_stmt|;
name|UM_ZERO
argument_list|(
name|acp
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_atmarp_csa
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Build a CSA record from the server's message 	 */
name|csap
operator|->
name|hops
operator|=
name|dcsp
operator|->
name|sd_hops
expr_stmt|;
name|csap
operator|->
name|null
operator|=
operator|(
name|cmsg
operator|->
name|si_atmarp
operator|.
name|sa_state
operator|==
name|SCSP_ASTATE_DEL
operator|)
operator|||
operator|(
name|cmsg
operator|->
name|si_type
operator|==
name|SCSP_SOLICIT_RSP
operator|&&
name|cmsg
operator|->
name|si_rc
operator|!=
name|SCSP_RSP_OK
operator|)
expr_stmt|;
name|csap
operator|->
name|seq
operator|=
name|cmsg
operator|->
name|si_atmarp
operator|.
name|sa_seq
expr_stmt|;
name|csap
operator|->
name|key
operator|=
name|cmsg
operator|->
name|si_atmarp
operator|.
name|sa_key
expr_stmt|;
name|csap
operator|->
name|oid
operator|=
name|cmsg
operator|->
name|si_atmarp
operator|.
name|sa_oid
expr_stmt|;
name|csap
operator|->
name|atmarp_data
operator|=
name|acp
expr_stmt|;
name|acp
operator|->
name|sa_state
operator|=
name|cmsg
operator|->
name|si_atmarp
operator|.
name|sa_state
expr_stmt|;
name|acp
operator|->
name|sa_sha
operator|=
name|cmsg
operator|->
name|si_atmarp
operator|.
name|sa_cha
expr_stmt|;
name|acp
operator|->
name|sa_ssa
operator|=
name|cmsg
operator|->
name|si_atmarp
operator|.
name|sa_csa
expr_stmt|;
name|acp
operator|->
name|sa_spa
operator|=
name|cmsg
operator|->
name|si_atmarp
operator|.
name|sa_cpa
expr_stmt|;
name|acp
operator|->
name|sa_tpa
operator|=
name|cmsg
operator|->
name|si_atmarp
operator|.
name|sa_cpa
expr_stmt|;
comment|/* 	 * Call the CA FSM 	 */
name|rc
operator|=
name|scsp_cafsm
argument_list|(
name|dcsp
argument_list|,
name|SCSP_CAFSM_CACHE_UPD
argument_list|,
operator|(
name|void
operator|*
operator|)
name|csap
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * SCSP client server interface finite state machine action 8  *  * Update Rsp from server--pass the update to the CA FSM.  *  * Arguments:  *	dcsp	pointer to DCS control block  *	msg	pointer to message from DCS  *	cmsg	pointer to message from server  *  * Returns:  *	0	success  *	else	errno describing error  *  */
end_comment

begin_function
name|int
name|scsp_client_act_08
parameter_list|(
name|dcsp
parameter_list|,
name|msg
parameter_list|,
name|cmsg
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|cmsg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
comment|/*  	 * Pass the response to the CA FSM 	 */
switch|switch
condition|(
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_pid
condition|)
block|{
case|case
name|SCSP_PROTO_ATMARP
case|:
name|rc
operator|=
name|scsp_cafsm
argument_list|(
name|dcsp
argument_list|,
name|SCSP_CAFSM_CACHE_RSP
argument_list|,
name|cmsg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|rc
operator|=
name|EPROTONOSUPPORT
expr_stmt|;
block|}
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * SCSP client server interface finite state machine action 9  *  * CSU Solicit from DCS--pass Solicit Ind to server  *  * Arguments:  *	dcsp	pointer to DCS control block  *	msg	pointer to message from DCS  *	cmsg	pointer to message from server  *  * Returns:  *	0	success  *	else	errno describing error  *  */
end_comment

begin_function
name|int
name|scsp_client_act_09
parameter_list|(
name|dcsp
parameter_list|,
name|msg
parameter_list|,
name|cmsg
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|cmsg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|,
name|rrc
init|=
literal|0
decl_stmt|;
name|Scsp_csa
modifier|*
name|csap
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|csip
decl_stmt|;
comment|/* 	 * Get memory for a Solicit Ind 	 */
name|csip
operator|=
operator|(
name|Scsp_if_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_if_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|csip
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_client_act_09: sizeof(Scsp_if_msg)"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Loop through list of CSAs 	 */
for|for
control|(
name|csap
operator|=
name|msg
operator|->
name|sc_csu_msg
operator|->
name|csu_csa_rec
init|;
name|csap
condition|;
name|csap
operator|=
name|csap
operator|->
name|next
control|)
block|{
comment|/* 		 * Fill out the Solicit Indication 		 */
name|UM_ZERO
argument_list|(
name|csip
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_if_msg
argument_list|)
argument_list|)
expr_stmt|;
name|csip
operator|->
name|si_type
operator|=
name|SCSP_SOLICIT_IND
expr_stmt|;
name|csip
operator|->
name|si_proto
operator|=
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_pid
expr_stmt|;
name|csip
operator|->
name|si_tok
operator|=
operator|(
name|u_long
operator|)
name|dcsp
expr_stmt|;
name|csip
operator|->
name|si_len
operator|=
sizeof|sizeof
argument_list|(
name|Scsp_if_msg_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|Scsp_sum_msg
argument_list|)
expr_stmt|;
name|csip
operator|->
name|si_sum
operator|.
name|ss_hops
operator|=
name|csap
operator|->
name|hops
expr_stmt|;
name|csip
operator|->
name|si_sum
operator|.
name|ss_null
operator|=
name|csap
operator|->
name|null
expr_stmt|;
name|csip
operator|->
name|si_sum
operator|.
name|ss_seq
operator|=
name|csap
operator|->
name|seq
expr_stmt|;
name|csip
operator|->
name|si_sum
operator|.
name|ss_key
operator|=
name|csap
operator|->
name|key
expr_stmt|;
name|csip
operator|->
name|si_sum
operator|.
name|ss_oid
operator|=
name|csap
operator|->
name|oid
expr_stmt|;
comment|/* 		 * Send the Solicit Ind to the server 		 */
name|rc
operator|=
name|scsp_if_sock_write
argument_list|(
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_sock
argument_list|,
name|csip
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|rrc
operator|=
name|rc
expr_stmt|;
block|}
block|}
name|UM_FREE
argument_list|(
name|csip
argument_list|)
expr_stmt|;
return|return
operator|(
name|rrc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * SCSP client server interface finite state machine action 10  *  * CSU Request from DCS--pass it to the server as a Cache Update  * Indication  *  * Arguments:  *	dcsp	pointer to DCS control block  *	msg	pointer to message from DCS  *	cmsg	pointer to message from server  *  * Returns:  *	0	success  *	else	errno describing error  *  */
end_comment

begin_function
name|int
name|scsp_client_act_10
parameter_list|(
name|dcsp
parameter_list|,
name|msg
parameter_list|,
name|cmsg
parameter_list|)
name|Scsp_dcs
modifier|*
name|dcsp
decl_stmt|;
name|Scsp_msg
modifier|*
name|msg
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|cmsg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|,
name|rrc
init|=
literal|0
decl_stmt|;
name|Scsp_csa
modifier|*
name|csap
decl_stmt|;
name|Scsp_atmarp_csa
modifier|*
name|acp
decl_stmt|;
name|Scsp_if_msg
modifier|*
name|cuip
decl_stmt|;
comment|/* 	 * Get memory for a Cache Update Ind 	 */
name|cuip
operator|=
operator|(
name|Scsp_if_msg
operator|*
operator|)
name|UM_ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|Scsp_if_msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cuip
condition|)
block|{
name|scsp_mem_err
argument_list|(
literal|"scsp_client_act_10: sizeof(Scsp_if_msg)"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Loop through CSAs in message 	 */
for|for
control|(
name|csap
operator|=
name|msg
operator|->
name|sc_csu_msg
operator|->
name|csu_csa_rec
init|;
name|csap
condition|;
name|csap
operator|=
name|csap
operator|->
name|next
control|)
block|{
name|acp
operator|=
name|csap
operator|->
name|atmarp_data
expr_stmt|;
if|if
condition|(
operator|!
name|acp
condition|)
continue|continue;
comment|/* 		 * Fill out the Cache Update Ind 		 */
name|UM_ZERO
argument_list|(
name|cuip
argument_list|,
sizeof|sizeof
argument_list|(
name|Scsp_if_msg
argument_list|)
argument_list|)
expr_stmt|;
name|cuip
operator|->
name|si_type
operator|=
name|SCSP_UPDATE_IND
expr_stmt|;
name|cuip
operator|->
name|si_proto
operator|=
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_pid
expr_stmt|;
name|cuip
operator|->
name|si_tok
operator|=
operator|(
name|u_long
operator|)
name|dcsp
expr_stmt|;
switch|switch
condition|(
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_pid
condition|)
block|{
case|case
name|SCSP_PROTO_ATMARP
case|:
name|cuip
operator|->
name|si_len
operator|=
sizeof|sizeof
argument_list|(
name|Scsp_if_msg_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|Scsp_atmarp_msg
argument_list|)
expr_stmt|;
name|cuip
operator|->
name|si_atmarp
operator|.
name|sa_state
operator|=
name|acp
operator|->
name|sa_state
expr_stmt|;
name|cuip
operator|->
name|si_atmarp
operator|.
name|sa_cpa
operator|=
name|acp
operator|->
name|sa_spa
expr_stmt|;
name|cuip
operator|->
name|si_atmarp
operator|.
name|sa_cha
operator|=
name|acp
operator|->
name|sa_sha
expr_stmt|;
name|cuip
operator|->
name|si_atmarp
operator|.
name|sa_csa
operator|=
name|acp
operator|->
name|sa_ssa
expr_stmt|;
name|cuip
operator|->
name|si_atmarp
operator|.
name|sa_key
operator|=
name|csap
operator|->
name|key
expr_stmt|;
name|cuip
operator|->
name|si_atmarp
operator|.
name|sa_oid
operator|=
name|csap
operator|->
name|oid
expr_stmt|;
name|cuip
operator|->
name|si_atmarp
operator|.
name|sa_seq
operator|=
name|csap
operator|->
name|seq
expr_stmt|;
break|break;
case|case
name|SCSP_PROTO_NHRP
case|:
comment|/* 			 * Not implemented yet 			 */
break|break;
block|}
comment|/* 		 * Send the Cache Update Ind to the server 		 */
name|rc
operator|=
name|scsp_if_sock_write
argument_list|(
name|dcsp
operator|->
name|sd_server
operator|->
name|ss_sock
argument_list|,
name|cuip
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|rrc
operator|=
name|rc
expr_stmt|;
block|}
block|}
name|UM_FREE
argument_list|(
name|cuip
argument_list|)
expr_stmt|;
return|return
operator|(
name|rrc
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * This code is derived from code available from the STB bulletin board  */
end_comment

begin_comment
comment|/* $XFree86: mit/server/ddx/x386/common_hw/ICD2061Aalt.c,v 2.6 1994/04/15 05:10:30 dawes Exp $ */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|KERNEL
end_ifndef

begin_include
include|#
directive|include
file|"compiler.h"
end_include

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|GCCUSESGAS
end_define

begin_define
define|#
directive|define
name|PCVT_STANDALONE
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|SEQREG
value|0x03C4
end_define

begin_define
define|#
directive|define
name|MISCREG
value|0x03C2
end_define

begin_define
define|#
directive|define
name|MISCREAD
value|0x03CC
end_define

begin_decl_stmt
name|double
name|fref
init|=
literal|14.31818
operator|*
literal|2.0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|ascclk
index|[]
init|=
literal|"VIDEO CLOCK ?"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|clknum
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|vlbus_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|card
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|crtcaddr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|clockreg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|double
name|range
index|[
literal|15
index|]
init|=
block|{
literal|50.0
block|,
literal|51.0
block|,
literal|53.2
block|,
literal|58.5
block|,
literal|60.7
block|,
literal|64.4
block|,
literal|66.8
block|,
literal|73.5
block|,
literal|75.6
block|,
literal|80.9
block|,
literal|83.2
block|,
literal|91.5
block|,
literal|100.0
block|,
literal|120.0
block|,
literal|120.0
block|}
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|__STDC__
end_ifdef

begin_function_decl
specifier|static
name|double
name|genratio
parameter_list|(
name|unsigned
name|int
modifier|*
name|p
parameter_list|,
name|unsigned
name|int
modifier|*
name|q
parameter_list|,
name|double
name|tgt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|double
name|f
parameter_list|(
name|unsigned
name|int
name|p
parameter_list|,
name|unsigned
name|int
name|q
parameter_list|,
name|double
name|basefreq
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static void prtbinary(unsigned int size, unsigned int val);
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|wait_vb
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wrt_clk_bit
parameter_list|(
name|unsigned
name|int
name|value
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|init_clock
parameter_list|(
name|unsigned
name|long
name|setup
parameter_list|,
name|unsigned
name|short
name|crtcport
parameter_list|)
function_decl|;
end_function_decl

begin_else
else|#
directive|else
end_else

begin_function_decl
specifier|static
name|double
name|genratio
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|double
name|f
parameter_list|()
function_decl|;
end_function_decl

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static void prtbinary();
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|wait_vb
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wrt_clk_bit
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|init_clock
parameter_list|()
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|AltICD2061SetClock
parameter_list|(
name|frequency
parameter_list|,
name|select
parameter_list|)
specifier|register
name|long
name|frequency
decl_stmt|;
comment|/* in Hz */
name|int
name|select
decl_stmt|;
block|{
name|unsigned
name|int
name|m
decl_stmt|,
name|mval
decl_stmt|,
name|ival
decl_stmt|;
name|int
name|i
decl_stmt|;
name|long
name|dwv
decl_stmt|;
name|double
name|realval
decl_stmt|;
name|double
name|freq
decl_stmt|,
name|fvco
decl_stmt|;
name|double
name|dev
decl_stmt|,
name|devx
decl_stmt|;
name|double
name|delta
decl_stmt|,
name|deltax
decl_stmt|;
name|unsigned
name|int
name|p
decl_stmt|,
name|q
decl_stmt|;
name|unsigned
name|int
name|bestp
decl_stmt|,
name|bestq
decl_stmt|;
name|unsigned
name|char
name|tmp
decl_stmt|;
name|crtcaddr
operator|=
operator|(
name|inb
argument_list|(
literal|0x3CC
argument_list|)
operator|&
literal|0x01
operator|)
condition|?
literal|0x3D4
else|:
literal|0x3B4
expr_stmt|;
name|outb
argument_list|(
name|crtcaddr
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
comment|/* Unlock CRTC registers */
name|tmp
operator|=
name|inb
argument_list|(
name|crtcaddr
operator|+
literal|1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtcaddr
operator|+
literal|1
argument_list|,
name|tmp
operator|&
operator|~
literal|0x80
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|crtcaddr
argument_list|,
literal|0x4838
argument_list|)
expr_stmt|;
comment|/* Unlock S3 register set */
name|outw
argument_list|(
name|crtcaddr
argument_list|,
literal|0xA039
argument_list|)
expr_stmt|;
name|clknum
operator|=
name|select
expr_stmt|;
name|freq
operator|=
operator|(
operator|(
name|double
operator|)
name|frequency
operator|)
operator|/
literal|1000000.0
expr_stmt|;
if|if
condition|(
name|freq
operator|>
name|range
index|[
literal|14
index|]
condition|)
name|freq
operator|=
name|range
index|[
literal|14
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|freq
operator|<=
literal|6.99
condition|)
name|freq
operator|=
literal|7.0
expr_stmt|;
comment|/*  *  Calculate values to load into ICD 2061A clock chip to set frequency  */
name|delta
operator|=
literal|999.0
expr_stmt|;
name|dev
operator|=
literal|999.0
expr_stmt|;
name|ival
operator|=
literal|99
expr_stmt|;
name|mval
operator|=
literal|99
expr_stmt|;
name|fvco
operator|=
name|freq
operator|/
literal|2
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
literal|8
condition|;
name|m
operator|++
control|)
block|{
name|fvco
operator|*=
literal|2.0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|14
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
if|if
condition|(
name|fvco
operator|>=
name|range
index|[
name|i
index|]
condition|)
break|break;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
continue|continue;
if|if
condition|(
name|i
operator|==
literal|14
condition|)
break|break;
name|devx
operator|=
operator|(
name|fvco
operator|-
operator|(
name|range
index|[
name|i
index|]
operator|+
name|range
index|[
name|i
operator|+
literal|1
index|]
operator|)
operator|/
literal|2
operator|)
operator|/
name|fvco
expr_stmt|;
if|if
condition|(
name|devx
operator|<
literal|0
condition|)
name|devx
operator|=
operator|-
name|devx
expr_stmt|;
name|deltax
operator|=
name|genratio
argument_list|(
operator|&
name|p
argument_list|,
operator|&
name|q
argument_list|,
name|fvco
argument_list|)
expr_stmt|;
if|if
condition|(
name|delta
operator|<
name|deltax
condition|)
continue|continue;
if|if
condition|(
name|deltax
operator|<
name|delta
operator|||
name|devx
operator|<
name|dev
condition|)
block|{
name|bestp
operator|=
name|p
expr_stmt|;
name|bestq
operator|=
name|q
expr_stmt|;
name|delta
operator|=
name|deltax
expr_stmt|;
name|dev
operator|=
name|devx
expr_stmt|;
name|ival
operator|=
name|i
expr_stmt|;
name|mval
operator|=
name|m
expr_stmt|;
block|}
block|}
name|fvco
operator|=
name|fref
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|mval
condition|;
name|m
operator|++
control|)
name|fvco
operator|/=
literal|2.0
expr_stmt|;
name|realval
operator|=
name|f
argument_list|(
name|bestp
argument_list|,
name|bestq
argument_list|,
name|fvco
argument_list|)
expr_stmt|;
name|dwv
operator|=
operator|(
operator|(
operator|(
operator|(
operator|(
operator|(
name|long
operator|)
name|ival
operator|<<
literal|7
operator|)
operator||
name|bestp
operator|)
operator|<<
literal|3
operator|)
operator||
name|mval
operator|)
operator|<<
literal|7
operator|)
operator||
name|bestq
expr_stmt|;
comment|/*  * Write ICD 2061A clock chip  */
name|init_clock
argument_list|(
operator|(
operator|(
name|unsigned
name|long
operator|)
name|dwv
operator|)
operator||
operator|(
operator|(
operator|(
name|long
operator|)
name|clknum
operator|)
operator|<<
literal|21
operator|)
argument_list|,
name|crtcaddr
argument_list|)
expr_stmt|;
name|wait_vb
argument_list|()
expr_stmt|;
name|wait_vb
argument_list|()
expr_stmt|;
name|wait_vb
argument_list|()
expr_stmt|;
name|wait_vb
argument_list|()
expr_stmt|;
name|wait_vb
argument_list|()
expr_stmt|;
name|wait_vb
argument_list|()
expr_stmt|;
name|wait_vb
argument_list|()
expr_stmt|;
comment|/* 0.10 second delay... */
block|}
end_function

begin_function
specifier|static
name|double
name|f
parameter_list|(
name|p
parameter_list|,
name|q
parameter_list|,
name|base
parameter_list|)
name|unsigned
name|int
name|p
decl_stmt|;
name|unsigned
name|int
name|q
decl_stmt|;
name|double
name|base
decl_stmt|;
block|{
return|return
operator|(
name|base
operator|*
operator|(
name|p
operator|+
literal|3
operator|)
operator|/
operator|(
name|q
operator|+
literal|2
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|double
name|genratio
parameter_list|(
name|p
parameter_list|,
name|q
parameter_list|,
name|tgt
parameter_list|)
name|unsigned
name|int
modifier|*
name|p
decl_stmt|;
name|unsigned
name|int
modifier|*
name|q
decl_stmt|;
name|double
name|tgt
decl_stmt|;
block|{
name|int
name|k
decl_stmt|,
name|m
decl_stmt|;
name|double
name|test
decl_stmt|,
name|mindiff
decl_stmt|;
name|unsigned
name|int
name|mmax
decl_stmt|;
name|mindiff
operator|=
literal|999999999.0
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|13
init|;
name|k
operator|<
literal|69
condition|;
name|k
operator|++
control|)
block|{
comment|/* q={15..71}:Constraint 2 on page 14 */
name|m
operator|=
literal|50.0
operator|*
name|k
operator|/
name|fref
operator|-
literal|3
expr_stmt|;
if|if
condition|(
name|m
operator|<
literal|0
condition|)
name|m
operator|=
literal|0
expr_stmt|;
name|mmax
operator|=
literal|120
operator|*
name|k
operator|/
name|fref
operator|-
literal|3
expr_stmt|;
comment|/* m..mmax is constraint 3 on page 14 */
if|if
condition|(
name|mmax
operator|>
literal|128
condition|)
name|mmax
operator|=
literal|128
expr_stmt|;
while|while
condition|(
name|m
operator|<
name|mmax
condition|)
block|{
name|test
operator|=
name|f
argument_list|(
name|m
argument_list|,
name|k
argument_list|,
name|fref
argument_list|)
operator|-
name|tgt
expr_stmt|;
if|if
condition|(
name|test
operator|<
literal|0
condition|)
name|test
operator|=
operator|-
name|test
expr_stmt|;
if|if
condition|(
name|mindiff
operator|>
name|test
condition|)
block|{
name|mindiff
operator|=
name|test
expr_stmt|;
operator|*
name|p
operator|=
name|m
expr_stmt|;
operator|*
name|q
operator|=
name|k
expr_stmt|;
block|}
name|m
operator|++
expr_stmt|;
block|}
block|}
return|return
operator|(
name|mindiff
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static void prtbinary(size, val)    unsigned int size;    unsigned int val;    {    unsigned int mask;    int k;     mask = 1;     for (k=size; --k> 0 || mask<= val/2;)       mask<<= 1;     while (mask) {       fputc((mask&val)? '1': '0' , stderr);       mask>>= 1;       }    }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|wait_vb
parameter_list|()
block|{
while|while
condition|(
operator|(
name|inb
argument_list|(
name|crtcaddr
operator|+
literal|6
argument_list|)
operator|&
literal|0x08
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
while|while
condition|(
name|inb
argument_list|(
name|crtcaddr
operator|+
literal|6
argument_list|)
operator|&
literal|0x08
condition|)
empty_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|__STDC__
end_ifdef

begin_function
specifier|static
name|void
name|init_clock
parameter_list|(
name|unsigned
name|long
name|setup
parameter_list|,
name|unsigned
name|short
name|crtcport
parameter_list|)
else|#
directive|else
function|static void init_clock
parameter_list|(
name|setup
parameter_list|,
name|crtcport
parameter_list|)
name|unsigned
name|long
name|setup
decl_stmt|;
name|unsigned
name|short
name|crtcport
decl_stmt|;
endif|#
directive|endif
block|{
name|unsigned
name|char
name|nclk
index|[
literal|2
index|]
decl_stmt|,
name|clk
index|[
literal|2
index|]
decl_stmt|;
name|unsigned
name|short
name|restore42
decl_stmt|;
name|unsigned
name|short
name|oldclk
decl_stmt|;
name|unsigned
name|short
name|bitval
decl_stmt|;
name|int
name|i
decl_stmt|;
name|unsigned
name|char
name|c
decl_stmt|;
ifndef|#
directive|ifndef
name|PCVT_STANDALONE
operator|(
name|void
operator|)
name|xf86DisableInterrupts
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|oldclk
operator|=
name|inb
argument_list|(
literal|0x3CC
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtcport
argument_list|,
literal|0x42
argument_list|)
expr_stmt|;
name|restore42
operator|=
name|inb
argument_list|(
name|crtcport
operator|+
literal|1
argument_list|)
expr_stmt|;
name|outw
argument_list|(
literal|0x3C4
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x3C4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|c
operator|=
name|inb
argument_list|(
literal|0x3C5
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x3C5
argument_list|,
literal|0x20
operator||
name|c
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtcport
argument_list|,
literal|0x42
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtcport
operator|+
literal|1
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
name|outw
argument_list|(
literal|0x3C4
argument_list|,
literal|0x0300
argument_list|)
expr_stmt|;
name|nclk
index|[
literal|0
index|]
operator|=
name|oldclk
operator|&
literal|0xF3
expr_stmt|;
name|nclk
index|[
literal|1
index|]
operator|=
name|nclk
index|[
literal|0
index|]
operator||
literal|0x08
expr_stmt|;
name|clk
index|[
literal|0
index|]
operator|=
name|nclk
index|[
literal|0
index|]
operator||
literal|0x04
expr_stmt|;
name|clk
index|[
literal|1
index|]
operator|=
name|nclk
index|[
literal|0
index|]
operator||
literal|0x0C
expr_stmt|;
name|outb
argument_list|(
name|crtcport
argument_list|,
literal|0x42
argument_list|)
expr_stmt|;
name|i
operator|=
name|inw
argument_list|(
name|crtcport
argument_list|)
expr_stmt|;
name|outw
argument_list|(
literal|0x3C4
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
name|wrt_clk_bit
argument_list|(
name|oldclk
operator||
literal|0x08
argument_list|)
expr_stmt|;
name|wrt_clk_bit
argument_list|(
name|oldclk
operator||
literal|0x0C
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
block|{
name|wrt_clk_bit
argument_list|(
name|nclk
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|wrt_clk_bit
argument_list|(
name|clk
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|wrt_clk_bit
argument_list|(
name|nclk
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|wrt_clk_bit
argument_list|(
name|nclk
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|wrt_clk_bit
argument_list|(
name|clk
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|wrt_clk_bit
argument_list|(
name|nclk
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|wrt_clk_bit
argument_list|(
name|clk
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|24
condition|;
name|i
operator|++
control|)
block|{
name|bitval
operator|=
name|setup
operator|&
literal|0x01
expr_stmt|;
name|setup
operator|>>=
literal|1
expr_stmt|;
name|wrt_clk_bit
argument_list|(
name|clk
index|[
literal|1
operator|-
name|bitval
index|]
argument_list|)
expr_stmt|;
name|wrt_clk_bit
argument_list|(
name|nclk
index|[
literal|1
operator|-
name|bitval
index|]
argument_list|)
expr_stmt|;
name|wrt_clk_bit
argument_list|(
name|nclk
index|[
name|bitval
index|]
argument_list|)
expr_stmt|;
name|wrt_clk_bit
argument_list|(
name|clk
index|[
name|bitval
index|]
argument_list|)
expr_stmt|;
block|}
name|wrt_clk_bit
argument_list|(
name|clk
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|wrt_clk_bit
argument_list|(
name|nclk
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|wrt_clk_bit
argument_list|(
name|clk
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x3C4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|c
operator|=
name|inb
argument_list|(
literal|0x3C5
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x3C5
argument_list|,
literal|0xDF
operator|&
name|c
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtcport
argument_list|,
literal|0x42
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtcport
operator|+
literal|1
argument_list|,
name|restore42
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x3C2
argument_list|,
name|oldclk
argument_list|)
expr_stmt|;
name|outw
argument_list|(
literal|0x3C4
argument_list|,
literal|0x0300
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|PCVT_STANDALONE
name|xf86EnableInterrupts
argument_list|()
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|wrt_clk_bit
parameter_list|(
name|value
parameter_list|)
name|unsigned
name|int
name|value
decl_stmt|;
block|{
name|int
name|j
decl_stmt|;
name|outb
argument_list|(
literal|0x3C2
argument_list|,
name|value
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|2
init|;
operator|--
name|j
condition|;
control|)
name|inb
argument_list|(
literal|0x200
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


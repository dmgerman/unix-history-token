begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, 1993, 1994 by Hellmuth Michaelis  *  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *    This product includes software developed by Hellmuth Michaelis.  * 4. The name of the developer may not be used to endorse or promote  *    products derived from this software without specific prior written  *    permission.  *  * THIS SOFTWARE IS PROVIDED BY THE DEVELOPER ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE DEVELOPERS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * 	misc.c, 3.00, last edit-date: [Sun Jan  2 20:09:21 1994]  */
end_comment

begin_comment
comment|/*---------------------------------------------------------------------------  *  *	misc.c		font editor misc routines  *	-----------------------------------------  *  *	written by Hellmuth Michaelis, hm@hcshh.hcs.de  *  *	-hm	first public release  *	-hm	writefont routine  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|"fed.h"
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_decl_stmt
specifier|static
name|unsigned
name|char
modifier|*
name|fonttab
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ptr to font in core memory */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|bitmask
index|[]
init|=
block|{
literal|"...."
block|,
comment|/*  0 */
literal|"...*"
block|,
comment|/*  1 */
literal|"..*."
block|,
comment|/*  2 */
literal|"..**"
block|,
comment|/*  3 */
literal|".*.."
block|,
comment|/*  4 */
literal|".*.*"
block|,
comment|/*  5 */
literal|".**."
block|,
comment|/*  6 */
literal|".***"
block|,
comment|/*  7 */
literal|"*..."
block|,
comment|/*  8 */
literal|"*..*"
block|,
comment|/*  9 */
literal|"*.*."
block|,
comment|/*  A */
literal|"*.**"
block|,
comment|/*  B */
literal|"**.."
block|,
comment|/*  C */
literal|"**.*"
block|,
comment|/*  D */
literal|"***."
block|,
comment|/*  E */
literal|"****"
block|,
comment|/*  F */
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|lfilename
index|[
literal|1024
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* current filename */
end_comment

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|lfilesize
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* current filename's size */
end_comment

begin_comment
comment|/*---------------------------------------------------------------------------*  *	read fontfile into memory  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|readfont
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|FILE
modifier|*
name|in
decl_stmt|;
name|struct
name|stat
name|sbuf
decl_stmt|,
modifier|*
name|sbp
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|char
name|buffer
index|[
literal|1024
index|]
decl_stmt|;
name|sbp
operator|=
operator|&
name|sbuf
expr_stmt|;
if|if
condition|(
operator|(
name|in
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"cannot open file %s for reading"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|in
argument_list|)
argument_list|,
name|sbp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"cannot fstat file %s"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|sbp
operator|->
name|st_size
condition|)
block|{
case|case
name|FONT8X8
case|:
name|ch_height
operator|=
name|HEIGHT8X8
expr_stmt|;
name|ch_width
operator|=
name|WIDTH8
expr_stmt|;
break|break;
case|case
name|FONT8X10
case|:
name|ch_height
operator|=
name|HEIGHT8X10
expr_stmt|;
name|ch_width
operator|=
name|WIDTH8
expr_stmt|;
break|break;
case|case
name|FONT8X14
case|:
name|ch_height
operator|=
name|HEIGHT8X14
expr_stmt|;
name|ch_width
operator|=
name|WIDTH8
expr_stmt|;
break|break;
case|case
name|FONT8X16
case|:
name|ch_height
operator|=
name|HEIGHT8X16
expr_stmt|;
name|ch_width
operator|=
name|WIDTH8
expr_stmt|;
break|break;
case|case
name|FONT16X16
case|:
name|ch_height
operator|=
name|HEIGHT16X16
expr_stmt|;
name|ch_width
operator|=
name|WIDTH16
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"error, file %s is no valid font file, size=%d\n"
argument_list|,
name|filename
argument_list|,
name|sbp
operator|->
name|st_size
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fonttab
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|size_t
operator|)
name|sbp
operator|->
name|st_size
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"error, malloc failed\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|lfilename
argument_list|,
name|filename
argument_list|)
expr_stmt|;
comment|/* save for write */
name|lfilesize
operator|=
name|sbp
operator|->
name|st_size
expr_stmt|;
comment|/* save for write */
if|if
condition|(
operator|(
name|ret
operator|=
name|fread
argument_list|(
name|fonttab
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fonttab
argument_list|)
argument_list|,
name|sbp
operator|->
name|st_size
argument_list|,
name|in
argument_list|)
operator|)
operator|!=
name|sbp
operator|->
name|st_size
condition|)
block|{
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"error reading file %s, size = %d, ret = %d\n"
argument_list|,
name|filename
argument_list|,
name|sbp
operator|->
name|st_size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	write fontfile to disk  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|writefont
parameter_list|()
block|{
name|FILE
modifier|*
name|in
decl_stmt|,
modifier|*
name|out
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|char
name|buffer
index|[
literal|1024
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|in
operator|=
name|fopen
argument_list|(
name|lfilename
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|int
name|c
decl_stmt|;
name|char
name|wfn
index|[
literal|1024
index|]
decl_stmt|;
name|strcpy
argument_list|(
name|wfn
argument_list|,
name|lfilename
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|wfn
argument_list|,
literal|".BAK"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|out
operator|=
name|fopen
argument_list|(
name|wfn
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"cannot open file %s for writing"
argument_list|,
name|wfn
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|c
operator|=
name|fgetc
argument_list|(
name|in
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
name|fputc
argument_list|(
name|c
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|out
operator|=
name|fopen
argument_list|(
name|lfilename
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"cannot open file %s for writing"
argument_list|,
name|lfilename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ret
operator|=
name|fwrite
argument_list|(
name|fonttab
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fonttab
argument_list|)
argument_list|,
name|lfilesize
argument_list|,
name|out
argument_list|)
operator|)
operator|!=
name|lfilesize
condition|)
block|{
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"error writing file %s, size=%d, ret=%d\n"
argument_list|,
name|lfilename
argument_list|,
name|lfilesize
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	display a string  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|dis_cmd
parameter_list|(
name|char
modifier|*
name|strg
parameter_list|)
block|{
name|move
argument_list|(
literal|22
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtoeol
argument_list|()
expr_stmt|;
name|mvaddstr
argument_list|(
literal|22
argument_list|,
literal|0
argument_list|,
name|strg
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	clear a command string  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|clr_cmd
parameter_list|(
name|void
parameter_list|)
block|{
name|move
argument_list|(
literal|22
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtoeol
argument_list|()
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	move char from src to dest  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|move_ch
parameter_list|(
name|int
name|src
parameter_list|,
name|int
name|dst
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|d
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ch_width
operator|==
name|WIDTH16
condition|)
name|offset
operator|=
literal|2
expr_stmt|;
else|else
name|offset
operator|=
literal|1
expr_stmt|;
name|s
operator|=
operator|&
operator|(
name|fonttab
index|[
name|ch_height
operator|*
name|offset
operator|*
name|src
index|]
operator|)
expr_stmt|;
name|d
operator|=
operator|&
operator|(
name|fonttab
index|[
name|ch_height
operator|*
name|offset
operator|*
name|dst
index|]
operator|)
expr_stmt|;
name|bcopy
argument_list|(
name|s
argument_list|,
name|d
argument_list|,
operator|(
name|ch_height
operator|*
name|offset
operator|)
argument_list|)
expr_stmt|;
comment|/* src -> dst */
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	exchange char's src and dest  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|xchg_ch
parameter_list|(
name|int
name|src
parameter_list|,
name|int
name|dst
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|d
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ch_width
operator|==
name|WIDTH16
condition|)
name|offset
operator|=
literal|2
expr_stmt|;
else|else
name|offset
operator|=
literal|1
expr_stmt|;
name|s
operator|=
operator|&
operator|(
name|fonttab
index|[
name|ch_height
operator|*
name|offset
operator|*
name|src
index|]
operator|)
expr_stmt|;
name|d
operator|=
operator|&
operator|(
name|fonttab
index|[
name|ch_height
operator|*
name|offset
operator|*
name|dst
index|]
operator|)
expr_stmt|;
name|bcopy
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
operator|(
name|ch_height
operator|*
name|offset
operator|)
argument_list|)
expr_stmt|;
comment|/* src -> tmp */
name|bcopy
argument_list|(
name|d
argument_list|,
name|s
argument_list|,
operator|(
name|ch_height
operator|*
name|offset
operator|)
argument_list|)
expr_stmt|;
comment|/* dst -> src */
name|bcopy
argument_list|(
name|buf
argument_list|,
name|d
argument_list|,
operator|(
name|ch_height
operator|*
name|offset
operator|)
argument_list|)
expr_stmt|;
comment|/* tmp -> dst */
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	display the current selected character  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|display
parameter_list|(
name|int
name|no
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|fontchar
decl_stmt|;
name|char
name|line
index|[
literal|32
index|]
decl_stmt|;
name|int
name|ln_no
decl_stmt|;
name|unsigned
name|char
name|hibyte
decl_stmt|;
name|unsigned
name|char
name|lobyte
decl_stmt|;
name|int
name|offset
decl_stmt|;
name|int
name|r
decl_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
name|r
operator|=
literal|1
expr_stmt|;
name|lobyte
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ch_width
operator|==
name|WIDTH16
condition|)
name|fontchar
operator|=
operator|&
operator|(
name|fonttab
index|[
name|ch_height
operator|*
literal|2
operator|*
name|no
index|]
operator|)
expr_stmt|;
else|else
name|fontchar
operator|=
operator|&
operator|(
name|fonttab
index|[
name|ch_height
operator|*
name|no
index|]
operator|)
expr_stmt|;
for|for
control|(
name|ln_no
operator|=
literal|0
init|;
name|ln_no
operator|<
name|ch_height
condition|;
name|ln_no
operator|++
control|)
block|{
name|hibyte
operator|=
operator|*
operator|(
name|fontchar
operator|+
operator|(
name|offset
operator|++
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|ch_width
operator|==
name|WIDTH16
condition|)
block|{
name|lobyte
operator|=
operator|*
operator|(
name|fontchar
operator|+
name|offset
operator|++
operator|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|line
argument_list|,
name|bitmask
index|[
call|(
name|int
call|)
argument_list|(
operator|(
name|hibyte
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
argument_list|)
index|]
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|line
argument_list|,
name|bitmask
index|[
call|(
name|int
call|)
argument_list|(
name|hibyte
operator|&
literal|0x0f
argument_list|)
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch_width
operator|==
name|WIDTH16
condition|)
block|{
name|strcat
argument_list|(
name|line
argument_list|,
name|bitmask
index|[
call|(
name|int
call|)
argument_list|(
operator|(
name|lobyte
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
argument_list|)
index|]
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|line
argument_list|,
name|bitmask
index|[
call|(
name|int
call|)
argument_list|(
name|lobyte
operator|&
literal|0x0f
argument_list|)
index|]
argument_list|)
expr_stmt|;
name|mvwprintw
argument_list|(
name|ch_win
argument_list|,
name|r
argument_list|,
literal|1
argument_list|,
literal|"%16.16s"
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mvwprintw
argument_list|(
name|ch_win
argument_list|,
name|r
argument_list|,
literal|1
argument_list|,
literal|"%8.8s"
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
name|r
operator|++
expr_stmt|;
block|}
name|wmove
argument_list|(
name|ch_win
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|ch_win
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	save character  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|save_ch
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|int
name|r
decl_stmt|,
name|c
decl_stmt|;
name|unsigned
name|short
name|byte
decl_stmt|;
name|unsigned
name|short
name|shift
decl_stmt|;
if|if
condition|(
name|ch_width
operator|==
name|WIDTH16
condition|)
name|offset
operator|=
literal|2
expr_stmt|;
else|else
name|offset
operator|=
literal|1
expr_stmt|;
name|s
operator|=
operator|&
operator|(
name|fonttab
index|[
name|ch_height
operator|*
name|offset
operator|*
name|curchar
index|]
operator|)
expr_stmt|;
name|r
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|r
operator|<=
name|ch_height
condition|)
block|{
name|c
operator|=
literal|1
expr_stmt|;
name|byte
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|offset
operator|==
literal|2
condition|)
name|shift
operator|=
literal|0x8000
expr_stmt|;
else|else
name|shift
operator|=
literal|0x80
expr_stmt|;
while|while
condition|(
name|c
operator|<=
name|ch_width
condition|)
block|{
if|if
condition|(
name|mvwinch
argument_list|(
name|ch_win
argument_list|,
name|r
argument_list|,
name|c
argument_list|)
operator|==
name|BLACK
condition|)
name|byte
operator||=
name|shift
expr_stmt|;
name|shift
operator|=
operator|(
name|shift
operator|>>
literal|1
operator|)
expr_stmt|;
name|c
operator|++
expr_stmt|;
block|}
operator|*
name|s
operator|++
operator|=
name|byte
expr_stmt|;
name|r
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------- E O F ----------------------------------*/
end_comment

end_unit


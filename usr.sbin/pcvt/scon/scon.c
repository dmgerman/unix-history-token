begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992,1993,1994 Hellmuth Michaelis and Joerg Wunsch  *  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by  *	Hellmuth Michaelis and Joerg Wunsch  * 4. The name authors may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|id
init|=
literal|"@(#)scon.c, 3.20, Last Edit-Date: [Sun Sep 25 12:33:21 1994]"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*---------------------------------------------------------------------------*  *  *	history:  *  *	-hm	moving fd for default device from 1 -> 0 for such things  *		as "scon -p list | more" to be possible  *		(reported by Gordon L. Burditt, gordon@sneaky.lonestar.org)  *	-hm	adding option "a" for just returning the type of video adaptor  *	-hm	removing explicit HGC support, same as MDA ...  *	-hm	vga type/family/132col support info on -l  *	-hm	force 24 lines in DEC 25 lines mode and HP 28 lines mode  *	-hm	fixed bug with 132 column mode display status display  *	-jw	added 132/80 col mode switching  *	-hm	removed -h flag, use -? now ... ;-)  *	-hm	S3 chipsets ..  *	-hm	Cirrus chipsets support from Onno van der Linden  *	-hm	-m option, display monitor type  *	-hm	bugfix, scon -c<screen-num> cleared dest screen, fixed  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<machine/pcvt_ioctl.h>
end_include

begin_define
define|#
directive|define
name|DEFAULTFD
value|0
end_define

begin_decl_stmt
name|int
name|aflag
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lflag
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mflag
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|current
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pflag
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|hflag
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|res
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|device
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dflag
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|vflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Pflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|fflag
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|colms
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|onoff
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|timeout
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|screeninfo
name|screeninfo
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NVGAPEL
value|256
end_define

begin_struct
struct|struct
name|rgb
block|{
name|unsigned
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|int
name|dothis
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|rgb
name|palette
index|[
name|NVGAPEL
index|]
init|=
block|{
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*   0 - black		*/
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*   1 - blue		*/
block|{
literal|0x00
block|,
literal|0x2a
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*   2 - green		*/
block|{
literal|0x00
block|,
literal|0x2a
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*   3 - cyan		*/
block|{
literal|0x2a
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*   4 - red		*/
block|{
literal|0x2a
block|,
literal|0x00
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*   5 - magenta	*/
block|{
literal|0x2a
block|,
literal|0x2a
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*   6 			*/
block|{
literal|0x2a
block|,
literal|0x2a
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*   7 - lightgray	*/
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*   8 			*/
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*   9 			*/
block|{
literal|0x00
block|,
literal|0x2a
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  10 			*/
block|{
literal|0x00
block|,
literal|0x2a
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  11 			*/
block|{
literal|0x2a
block|,
literal|0x00
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  12 			*/
block|{
literal|0x2a
block|,
literal|0x00
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  13 			*/
block|{
literal|0x2a
block|,
literal|0x2a
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  14 			*/
block|{
literal|0x2a
block|,
literal|0x2a
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  15 			*/
block|{
literal|0x00
block|,
literal|0x15
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*  16 			*/
block|{
literal|0x00
block|,
literal|0x15
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*  17 			*/
block|{
literal|0x00
block|,
literal|0x3f
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*  18 			*/
block|{
literal|0x00
block|,
literal|0x3f
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*  19 			*/
block|{
literal|0x2a
block|,
literal|0x15
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*  20 - brown		*/
block|{
literal|0x2a
block|,
literal|0x15
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*  21 			*/
block|{
literal|0x2a
block|,
literal|0x3f
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*  22 			*/
block|{
literal|0x2a
block|,
literal|0x3f
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*  23 			*/
block|{
literal|0x00
block|,
literal|0x15
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  24 			*/
block|{
literal|0x00
block|,
literal|0x15
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  25 			*/
block|{
literal|0x00
block|,
literal|0x3f
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  26 			*/
block|{
literal|0x00
block|,
literal|0x3f
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  27 			*/
block|{
literal|0x2a
block|,
literal|0x15
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  28 			*/
block|{
literal|0x2a
block|,
literal|0x15
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  29 			*/
block|{
literal|0x2a
block|,
literal|0x3f
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  30 			*/
block|{
literal|0x2a
block|,
literal|0x3f
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  31 			*/
block|{
literal|0x15
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*  32 			*/
block|{
literal|0x15
block|,
literal|0x00
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*  33 			*/
block|{
literal|0x15
block|,
literal|0x2a
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*  34 			*/
block|{
literal|0x15
block|,
literal|0x2a
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*  35 			*/
block|{
literal|0x3f
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*  36 			*/
block|{
literal|0x3f
block|,
literal|0x00
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*  37 			*/
block|{
literal|0x3f
block|,
literal|0x2a
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*  38 			*/
block|{
literal|0x3f
block|,
literal|0x2a
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*  39 			*/
block|{
literal|0x15
block|,
literal|0x00
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  40 			*/
block|{
literal|0x15
block|,
literal|0x00
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  41 			*/
block|{
literal|0x15
block|,
literal|0x2a
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  42 			*/
block|{
literal|0x15
block|,
literal|0x2a
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  43 			*/
block|{
literal|0x3f
block|,
literal|0x00
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  44 			*/
block|{
literal|0x3f
block|,
literal|0x00
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  45 			*/
block|{
literal|0x3f
block|,
literal|0x2a
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  46 			*/
block|{
literal|0x3f
block|,
literal|0x2a
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  47 			*/
block|{
literal|0x15
block|,
literal|0x15
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*  48 			*/
block|{
literal|0x15
block|,
literal|0x15
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*  49 			*/
block|{
literal|0x15
block|,
literal|0x3f
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*  50 			*/
block|{
literal|0x15
block|,
literal|0x3f
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*  51 			*/
block|{
literal|0x3f
block|,
literal|0x15
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*  52 			*/
block|{
literal|0x3f
block|,
literal|0x15
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*  53 			*/
block|{
literal|0x3f
block|,
literal|0x3f
block|,
literal|0x00
block|,
literal|0
block|}
block|,
comment|/*  54 			*/
block|{
literal|0x3f
block|,
literal|0x3f
block|,
literal|0x2a
block|,
literal|0
block|}
block|,
comment|/*  55 			*/
block|{
literal|0x15
block|,
literal|0x15
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  56 - darkgray	*/
block|{
literal|0x15
block|,
literal|0x15
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  57 - lightblue	*/
block|{
literal|0x15
block|,
literal|0x3f
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  58 - lightgreen	*/
block|{
literal|0x15
block|,
literal|0x3f
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  59 - lightcyan	*/
block|{
literal|0x3f
block|,
literal|0x15
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  60 - lightred	*/
block|{
literal|0x3f
block|,
literal|0x15
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  61 - lightmagenta	*/
block|{
literal|0x3f
block|,
literal|0x3f
block|,
literal|0x15
block|,
literal|0
block|}
block|,
comment|/*  62 - yellow		*/
block|{
literal|0x3f
block|,
literal|0x3f
block|,
literal|0x3f
block|,
literal|0
block|}
block|,
comment|/*  63 - white		*/
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0
block|}
comment|/*  64 ... - empty	*/
block|}
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
name|colname
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
block|}
name|colnames
index|[]
init|=
block|{
block|{
literal|"black"
block|,
literal|0
block|}
block|,
block|{
literal|"blue"
block|,
literal|1
block|}
block|,
block|{
literal|"green"
block|,
literal|2
block|}
block|,
block|{
literal|"cyan"
block|,
literal|3
block|}
block|,
block|{
literal|"red"
block|,
literal|4
block|}
block|,
block|{
literal|"magenta"
block|,
literal|5
block|}
block|,
block|{
literal|"brown"
block|,
literal|20
block|}
block|,
block|{
literal|"lightgray"
block|,
literal|7
block|}
block|,
block|{
literal|"lightgrey"
block|,
literal|7
block|}
block|,
block|{
literal|"darkgray"
block|,
literal|56
block|}
block|,
block|{
literal|"darkgrey"
block|,
literal|56
block|}
block|,
block|{
literal|"lightblue"
block|,
literal|57
block|}
block|,
block|{
literal|"lightgreen"
block|,
literal|58
block|}
block|,
block|{
literal|"lightcyan"
block|,
literal|59
block|}
block|,
block|{
literal|"lightred"
block|,
literal|60
block|}
block|,
block|{
literal|"lightmagenta"
block|,
literal|61
block|}
block|,
block|{
literal|"yellow"
block|,
literal|62
block|}
block|,
block|{
literal|"white"
block|,
literal|63
block|}
block|,
comment|/* must be terminator: */
block|{
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|parsepopt
parameter_list|(
name|char
modifier|*
name|arg
parameter_list|,
name|unsigned
modifier|*
name|idx
parameter_list|,
name|unsigned
modifier|*
name|r
parameter_list|,
name|unsigned
modifier|*
name|g
parameter_list|,
name|unsigned
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|printpalette
parameter_list|(
name|int
name|fd
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
specifier|extern
name|int
name|optind
decl_stmt|;
specifier|extern
name|int
name|opterr
decl_stmt|;
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
name|int
name|c
decl_stmt|;
name|int
name|fd
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"ac:d:f:HVlms:t:vp:18"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'a'
case|:
name|aflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|lflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|mflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|current
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|device
operator|=
name|optarg
expr_stmt|;
name|dflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|onoff
operator|=
name|optarg
expr_stmt|;
name|fflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'V'
case|:
name|pflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
name|hflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|optarg
argument_list|,
literal|"25"
argument_list|,
literal|2
argument_list|)
condition|)
name|res
operator|=
name|SIZ_25ROWS
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|optarg
argument_list|,
literal|"28"
argument_list|,
literal|2
argument_list|)
condition|)
name|res
operator|=
name|SIZ_28ROWS
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|optarg
argument_list|,
literal|"35"
argument_list|,
literal|2
argument_list|)
condition|)
name|res
operator|=
name|SIZ_35ROWS
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|optarg
argument_list|,
literal|"40"
argument_list|,
literal|2
argument_list|)
condition|)
name|res
operator|=
name|SIZ_40ROWS
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|optarg
argument_list|,
literal|"43"
argument_list|,
literal|2
argument_list|)
condition|)
name|res
operator|=
name|SIZ_43ROWS
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|optarg
argument_list|,
literal|"50"
argument_list|,
literal|2
argument_list|)
condition|)
name|res
operator|=
name|SIZ_50ROWS
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|vflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|optarg
argument_list|,
literal|"list"
argument_list|)
condition|)
block|{
if|if
condition|(
name|Pflag
condition|)
name|errx
argument_list|(
literal|2
argument_list|,
literal|"-p list is mutual exclusive with other -p options"
argument_list|)
expr_stmt|;
name|Pflag
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|optarg
argument_list|,
literal|"default"
argument_list|)
condition|)
block|{
if|if
condition|(
name|Pflag
condition|)
name|errx
argument_list|(
literal|2
argument_list|,
literal|"multiple -p default not allowed"
argument_list|)
expr_stmt|;
name|Pflag
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|unsigned
name|idx
decl_stmt|,
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
if|if
condition|(
name|Pflag
operator|>
literal|1
condition|)
name|errx
argument_list|(
literal|2
argument_list|,
literal|"-p default and -p i,r,g,b ambiguous"
argument_list|)
expr_stmt|;
name|Pflag
operator|=
literal|1
expr_stmt|;
name|parsepopt
argument_list|(
name|optarg
argument_list|,
operator|&
name|idx
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|g
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|>=
name|NVGAPEL
condition|)
name|errx
argument_list|(
literal|2
argument_list|,
literal|"index %u in -p option out of range"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|palette
index|[
name|idx
index|]
operator|.
name|r
operator|=
name|r
expr_stmt|;
name|palette
index|[
name|idx
index|]
operator|.
name|g
operator|=
name|g
expr_stmt|;
name|palette
index|[
name|idx
index|]
operator|.
name|b
operator|=
name|b
expr_stmt|;
name|palette
index|[
name|idx
index|]
operator|.
name|dothis
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
literal|'t'
case|:
name|tflag
operator|++
expr_stmt|;
name|timeout
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'1'
case|:
name|colms
operator|=
literal|132
expr_stmt|;
break|break;
case|case
literal|'8'
case|:
name|colms
operator|=
literal|80
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
default|default:
name|usage
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|(
name|pflag
operator|==
literal|1
operator|)
operator|&&
operator|(
name|hflag
operator|==
literal|1
operator|)
condition|)
name|usage
argument_list|()
expr_stmt|;
if|if
condition|(
name|dflag
operator|==
operator|-
literal|1
operator|&&
name|lflag
operator|==
operator|-
literal|1
operator|&&
name|current
operator|==
operator|-
literal|1
operator|&&
name|pflag
operator|==
operator|-
literal|1
operator|&&
name|hflag
operator|==
operator|-
literal|1
operator|&&
name|res
operator|==
operator|-
literal|1
operator|&&
name|Pflag
operator|==
literal|0
operator|&&
name|tflag
operator|==
literal|0
operator|&&
name|fflag
operator|==
operator|-
literal|1
operator|&&
name|colms
operator|==
literal|0
operator|&&
name|mflag
operator|==
operator|-
literal|1
condition|)
block|{
name|lflag
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|dflag
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|"using current device\n"
argument_list|)
expr_stmt|;
name|fd
operator|=
name|DEFAULTFD
expr_stmt|;
comment|/* -hm, Feb 12 1993 */
block|}
else|else
block|{
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|device
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ERROR opening %s"
argument_list|,
name|device
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|"using device %s\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|aflag
operator|==
literal|1
condition|)
comment|/* return adaptor type */
block|{
name|printadaptor
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mflag
operator|==
literal|1
condition|)
comment|/* return monitor type */
block|{
name|printmonitor
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lflag
operator|==
literal|1
condition|)
comment|/* list information */
block|{
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|"processing option -l, listing screen info\n"
argument_list|)
expr_stmt|;
name|printinfo
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tflag
condition|)
comment|/* set screen saver timeout */
block|{
if|if
condition|(
name|vflag
condition|)
block|{
name|printf
argument_list|(
literal|"processing option -t, setting screen saver timeout: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
condition|)
name|printf
argument_list|(
literal|"new timeout = %d s\n"
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"turned off\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|VGASCREENSAVER
argument_list|,
operator|&
name|timeout
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"ioctl(VGASCREENSAVER)"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Check the driver, the screensaver is probably not compiled in!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
goto|goto
name|success
goto|;
block|}
if|if
condition|(
name|colms
condition|)
block|{
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|"Setting number of columns to %d\n"
argument_list|,
name|colms
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|VGASETCOLMS
argument_list|,
operator|&
name|colms
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"ioctl(VGASETCOLMS)"
argument_list|)
expr_stmt|;
goto|goto
name|success
goto|;
block|}
if|if
condition|(
name|Pflag
operator|==
literal|3
condition|)
block|{
comment|/* listing VGA palette */
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|"processing option -p list, "
literal|"listing VGA palette\n"
argument_list|)
expr_stmt|;
name|printpalette
argument_list|(
name|fd
argument_list|)
expr_stmt|;
goto|goto
name|success
goto|;
block|}
if|if
condition|(
name|Pflag
condition|)
block|{
name|unsigned
name|int
name|idx
decl_stmt|;
comment|/* setting VGA palette */
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|"processing option -p, setting VGA palette%s\n"
argument_list|,
name|Pflag
operator|==
literal|2
condition|?
literal|" to default"
else|:
literal|""
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|NVGAPEL
condition|;
name|idx
operator|++
control|)
if|if
condition|(
name|Pflag
operator|==
literal|2
operator|||
name|palette
index|[
name|idx
index|]
operator|.
name|dothis
condition|)
block|{
name|struct
name|vgapel
name|p
decl_stmt|;
name|p
operator|.
name|idx
operator|=
name|idx
expr_stmt|;
name|p
operator|.
name|r
operator|=
name|palette
index|[
name|idx
index|]
operator|.
name|r
expr_stmt|;
name|p
operator|.
name|g
operator|=
name|palette
index|[
name|idx
index|]
operator|.
name|g
expr_stmt|;
name|p
operator|.
name|b
operator|=
name|palette
index|[
name|idx
index|]
operator|.
name|b
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|VGAWRITEPEL
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|p
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"ioctl(fd, VGAWRITEPEL)"
argument_list|)
expr_stmt|;
block|}
goto|goto
name|success
goto|;
block|}
name|screeninfo
operator|.
name|screen_no
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* We are using fd */
name|screeninfo
operator|.
name|current_screen
operator|=
name|current
expr_stmt|;
name|screeninfo
operator|.
name|pure_vt_mode
operator|=
operator|-
literal|1
expr_stmt|;
name|screeninfo
operator|.
name|screen_size
operator|=
name|res
expr_stmt|;
name|screeninfo
operator|.
name|force_24lines
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|current
operator|!=
operator|-
literal|1
condition|)
comment|/* set current screen */
block|{
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|"processing option -c, setting current screen to %d\n"
argument_list|,
name|current
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
literal|1
argument_list|,
name|VGASETSCREEN
argument_list|,
operator|&
name|screeninfo
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ioctl VGASETSCREEN failed"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pflag
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|"processing option -V, setting emulation to pure VT220\n"
argument_list|)
expr_stmt|;
name|screeninfo
operator|.
name|pure_vt_mode
operator|=
name|M_PUREVT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hflag
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|"processing option -H, setting emulation to VT220 + HP Labels\n"
argument_list|)
expr_stmt|;
name|screeninfo
operator|.
name|pure_vt_mode
operator|=
name|M_HPVT
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|"no change in terminal emulation\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vflag
condition|)
block|{
if|if
condition|(
name|res
operator|==
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"no change in screen resolution\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|res
operator|==
name|SIZ_25ROWS
condition|)
name|printf
argument_list|(
literal|"change screen resolution to 25 lines\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|res
operator|==
name|SIZ_28ROWS
condition|)
name|printf
argument_list|(
literal|"change screen resolution to 28 lines\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|res
operator|==
name|SIZ_35ROWS
condition|)
name|printf
argument_list|(
literal|"change screen resolution to 35 lines\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|res
operator|==
name|SIZ_40ROWS
condition|)
name|printf
argument_list|(
literal|"change screen resolution to 40 lines\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|res
operator|==
name|SIZ_43ROWS
condition|)
name|printf
argument_list|(
literal|"change screen resolution to 43 lines\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|res
operator|==
name|SIZ_50ROWS
condition|)
name|printf
argument_list|(
literal|"change screen resolution to 50 lines\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fflag
operator|==
literal|1
condition|)
comment|/* force 24 lines on/off */
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|onoff
argument_list|,
literal|"on"
argument_list|)
condition|)
block|{
name|fflag
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|onoff
argument_list|,
literal|"off"
argument_list|)
condition|)
block|{
name|fflag
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"you must specify 'on' or 'off' with -f option!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|screeninfo
operator|.
name|force_24lines
operator|=
name|fflag
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|VGASETSCREEN
argument_list|,
operator|&
name|screeninfo
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ioctl VGASETSCREEN failed"
argument_list|)
expr_stmt|;
name|success
label|:
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|"successful execution of ioctl VGASETSCREEN!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|usage
argument_list|()
end_macro

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nscon - screen control utility for the pcvt video driver\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: scon -a -l -m -v -c [n] -d [dev] -f [on|off] -V -H -s [n]\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: scon -p [default | list | i,r,g,b] | -t [sec] | -1 | -8\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -a              list video adaptor type (MDA,CGA,EGA or VGA)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -c<screen no>  switch current virtual screen to<screen no>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -d<device>     set parameters(-V|-H|-s) for virtual device\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -f<on|off>     force 24 lines in VT 25 lines and HP 28 lines mode\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -H              set VT220/HP emulation mode for a virtual screen\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -l              list current parameters for a virtual screen\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -m              report monitor type (MONO/COLOR)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -p default      set default VGA palette\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -p list         list current VGA palette\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -p<i,r,g,b>    set VGA palette entry i to r/g/b\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -p<name,r,g,b> set VGA palette entry for color name to r/g/b\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -s<lines>      set 25, 28, 35, 40, 43 or 50 lines for a virtual screen\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -t<timeout>    set screen saver timeout [seconds]\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -1              set 132 columns mode\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -8              set 80 columns mode\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -v              verbose mode\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -V              set pure VT220 emulation for a virtual screen\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -?              display help (this message)\n\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|printadaptor
argument_list|(
argument|fd
argument_list|)
end_macro

begin_decl_stmt
name|int
name|fd
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|VGAGETSCREEN
argument_list|,
operator|&
name|screeninfo
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ioctl VGAGETSCREEN failed"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|screeninfo
operator|.
name|adaptor_type
condition|)
block|{
default|default:
case|case
name|UNKNOWN_ADAPTOR
case|:
name|printf
argument_list|(
literal|"UNKNOWN\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MDA_ADAPTOR
case|:
name|printf
argument_list|(
literal|"MDA\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CGA_ADAPTOR
case|:
name|printf
argument_list|(
literal|"CGA\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|EGA_ADAPTOR
case|:
name|printf
argument_list|(
literal|"EGA\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|VGA_ADAPTOR
case|:
name|printf
argument_list|(
literal|"VGA\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_macro
name|printmonitor
argument_list|(
argument|fd
argument_list|)
end_macro

begin_decl_stmt
name|int
name|fd
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|VGAGETSCREEN
argument_list|,
operator|&
name|screeninfo
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ioctl VGAGETSCREEN failed"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|screeninfo
operator|.
name|monitor_type
condition|)
block|{
default|default:
name|printf
argument_list|(
literal|"UNKNOWN\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MONITOR_MONO
case|:
name|printf
argument_list|(
literal|"MONO\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MONITOR_COLOR
case|:
name|printf
argument_list|(
literal|"COLOR\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_function
name|char
modifier|*
name|vga_type
parameter_list|(
name|int
name|number
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|vga_tab
index|[]
init|=
block|{
literal|"Generic VGA"
block|,
literal|"ET4000"
block|,
literal|"ET3000"
block|,
literal|"PVGA1A"
block|,
literal|"WD90C00"
block|,
literal|"WD90C10"
block|,
literal|"WD90C11"
block|,
literal|"VIDEO 7 VEGA"
block|,
literal|"VIDEO 7 FAST"
block|,
literal|"VIDEO 7 VER5"
block|,
literal|"VIDEO 7 1024I"
block|,
literal|"Unknown VIDEO 7"
block|,
literal|"TVGA 8800BR"
block|,
literal|"TVGA 8800CS"
block|,
literal|"TVGA 8900B"
block|,
literal|"TVGA 8900C"
block|,
literal|"TVGA 8900CL"
block|,
literal|"TVGA 9000"
block|,
literal|"TVGA 9100"
block|,
literal|"TVGA 9200"
block|,
literal|"Unknown TRIDENT"
block|,
literal|"S3 80C911"
block|,
literal|"S3 80C924"
block|,
literal|"S3 80C801/80C805"
block|,
literal|"S3 80C928"
block|,
literal|"Unknown S3"
block|,
literal|"CL-GD5402"
block|,
literal|"CL-GD5402r1"
block|,
literal|"CL-GD5420"
block|,
literal|"CL-GD5420r1"
block|,
literal|"CL-GD5422"
block|,
literal|"CL-GD5424"
block|,
literal|"CL-GD5426"
block|,
literal|"CL-GD5428"
block|,  	}
decl_stmt|;
return|return
operator|(
name|vga_tab
index|[
name|number
index|]
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|vga_family
parameter_list|(
name|int
name|number
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|vga_tab
index|[]
init|=
block|{
literal|"Generic VGA"
block|,
literal|"Tseng Labs"
block|,
literal|"Western Digital"
block|,
literal|"Video Seven"
block|,
literal|"Trident"
block|,
literal|"S3 Incorporated"
block|,
literal|"Cirrus Logic"
block|, 	}
decl_stmt|;
return|return
operator|(
name|vga_tab
index|[
name|number
index|]
operator|)
return|;
block|}
end_function

begin_macro
name|printinfo
argument_list|(
argument|fd
argument_list|)
end_macro

begin_decl_stmt
name|int
name|fd
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|VGAGETSCREEN
argument_list|,
operator|&
name|screeninfo
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ioctl VGAGETSCREEN failed"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nVideo Adaptor Type           = "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|screeninfo
operator|.
name|adaptor_type
condition|)
block|{
default|default:
case|case
name|UNKNOWN_ADAPTOR
case|:
name|printf
argument_list|(
literal|"UNKNOWN Video Adaptor\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MDA_ADAPTOR
case|:
name|printf
argument_list|(
literal|"MDA - Monochrome Display Adaptor\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CGA_ADAPTOR
case|:
name|printf
argument_list|(
literal|"CGA - Color Graphics Adaptor\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|EGA_ADAPTOR
case|:
name|printf
argument_list|(
literal|"EGA - Enhanced Graphics Adaptor\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|VGA_ADAPTOR
case|:
name|printf
argument_list|(
literal|"VGA - Video Graphics Adaptor/Array\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" VGA Chipset Manufacturer    = %s\n"
argument_list|,
name|vga_family
argument_list|(
name|screeninfo
operator|.
name|vga_family
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" VGA Chipset Type            = %s\n"
argument_list|,
name|vga_type
argument_list|(
name|screeninfo
operator|.
name|vga_type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Support for 132 Column Mode = %s\n"
argument_list|,
name|screeninfo
operator|.
name|vga_132
condition|?
literal|"Yes"
else|:
literal|"No"
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"Display Monitor Type         = "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|screeninfo
operator|.
name|monitor_type
condition|)
block|{
default|default:
name|printf
argument_list|(
literal|"UNKNOWN Monitor Type\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MONITOR_MONO
case|:
name|printf
argument_list|(
literal|"Monochrome Monitor\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MONITOR_COLOR
case|:
name|printf
argument_list|(
literal|"Color Monitor\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"Number of Downloadable Fonts = %d\n"
argument_list|,
name|screeninfo
operator|.
name|totalfonts
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Number of Virtual Screens    = %d\n"
argument_list|,
name|screeninfo
operator|.
name|totalscreens
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Info Request Screen Number   = %d\n"
argument_list|,
name|screeninfo
operator|.
name|screen_no
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Current Displayed Screen     = %d\n"
argument_list|,
name|screeninfo
operator|.
name|current_screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|screeninfo
operator|.
name|pure_vt_mode
operator|==
name|M_PUREVT
condition|)
name|printf
argument_list|(
literal|"Terminal Emulation Mode      = VT220\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Terminal Emulation Mode      = VT220 with HP Features\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Lines                        = "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|screeninfo
operator|.
name|screen_size
condition|)
block|{
case|case
name|SIZ_25ROWS
case|:
name|printf
argument_list|(
literal|"25\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIZ_28ROWS
case|:
name|printf
argument_list|(
literal|"28\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIZ_35ROWS
case|:
name|printf
argument_list|(
literal|"35\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIZ_40ROWS
case|:
name|printf
argument_list|(
literal|"40\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIZ_43ROWS
case|:
name|printf
argument_list|(
literal|"43\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIZ_50ROWS
case|:
name|printf
argument_list|(
literal|"50\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"UNKNOWN\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"Force 24 Lines               = %s"
argument_list|,
name|screeninfo
operator|.
name|force_24lines
condition|?
literal|"Yes"
else|:
literal|"No"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|findname
parameter_list|(
name|unsigned
name|idx
parameter_list|)
block|{
comment|/* try to find a name for palette entry idx */
comment|/* if multiple names exist, returns first matching */
specifier|register
name|struct
name|colname
modifier|*
name|cnp
decl_stmt|;
for|for
control|(
name|cnp
operator|=
name|colnames
init|;
name|cnp
operator|->
name|name
condition|;
name|cnp
operator|++
control|)
if|if
condition|(
name|cnp
operator|->
name|idx
operator|==
name|idx
condition|)
return|return
name|cnp
operator|->
name|name
return|;
comment|/* not found */
return|return
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|printpalette
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
specifier|register
name|unsigned
name|idx
decl_stmt|,
name|last
decl_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|NVGAPEL
condition|;
name|idx
operator|++
control|)
block|{
name|struct
name|vgapel
name|p
decl_stmt|;
name|p
operator|.
name|idx
operator|=
name|idx
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|VGAREADPEL
argument_list|,
operator|&
name|p
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"ioctl(VGAREADPEL)"
argument_list|)
expr_stmt|;
name|palette
index|[
name|idx
index|]
operator|.
name|r
operator|=
name|p
operator|.
name|r
expr_stmt|;
name|palette
index|[
name|idx
index|]
operator|.
name|g
operator|=
name|p
operator|.
name|g
expr_stmt|;
name|palette
index|[
name|idx
index|]
operator|.
name|b
operator|=
name|p
operator|.
name|b
expr_stmt|;
block|}
comment|/* find last non-empty entry */
for|for
control|(
name|last
operator|=
name|NVGAPEL
operator|-
literal|1
init|;
name|last
condition|;
name|last
operator|--
control|)
if|if
condition|(
name|palette
index|[
name|last
index|]
operator|.
name|r
operator|||
name|palette
index|[
name|last
index|]
operator|.
name|g
operator|||
name|palette
index|[
name|last
index|]
operator|.
name|b
condition|)
break|break;
if|if
condition|(
name|last
operator|!=
name|NVGAPEL
operator|-
literal|1
condition|)
name|last
operator|++
expr_stmt|;
comment|/* now, everything's collected. print out table */
name|printf
argument_list|(
literal|"VGA palette status\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"index    red  green   blue  name\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|last
condition|;
name|idx
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|cp
decl_stmt|;
name|printf
argument_list|(
literal|"%5d  %5d  %5d  %5d"
argument_list|,
name|idx
argument_list|,
name|palette
index|[
name|idx
index|]
operator|.
name|r
argument_list|,
name|palette
index|[
name|idx
index|]
operator|.
name|g
argument_list|,
name|palette
index|[
name|idx
index|]
operator|.
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|=
name|findname
argument_list|(
name|idx
argument_list|)
condition|)
name|printf
argument_list|(
literal|"  %s\n"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
else|else
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|parsepopt
parameter_list|(
name|char
modifier|*
name|arg
parameter_list|,
name|unsigned
modifier|*
name|idx
parameter_list|,
name|unsigned
modifier|*
name|r
parameter_list|,
name|unsigned
modifier|*
name|g
parameter_list|,
name|unsigned
modifier|*
name|b
parameter_list|)
block|{
name|char
name|firstarg
index|[
literal|21
index|]
decl_stmt|;
specifier|register
name|unsigned
name|i
decl_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|arg
argument_list|,
literal|"%20[a-zA-Z0-9]%*[,:]%u,%u,%u"
argument_list|,
name|firstarg
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
operator|<
literal|4
operator|||
name|strlen
argument_list|(
name|firstarg
argument_list|)
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|2
argument_list|,
literal|"too few args in -p i,r,g,b"
argument_list|)
expr_stmt|;
if|if
condition|(
name|firstarg
index|[
literal|0
index|]
operator|>=
literal|'0'
operator|&&
name|firstarg
index|[
literal|0
index|]
operator|<=
literal|'9'
condition|)
block|{
operator|*
name|idx
operator|=
name|strtoul
argument_list|(
name|firstarg
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|colnames
index|[
name|i
index|]
operator|.
name|name
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcasecmp
argument_list|(
name|colnames
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|firstarg
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|idx
operator|=
name|colnames
index|[
name|i
index|]
operator|.
name|idx
expr_stmt|;
return|return;
block|}
name|errx
argument_list|(
literal|2
argument_list|,
literal|"arg ``%s'' in -p option not recognized"
argument_list|,
name|firstarg
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992,1993,1994 Hellmuth Michaelis  *  * Copyright (c) 1992,1993 Holger Veit.  *  * All rights reserved.  *  * This code is derived from software contributed to 386BSD by  * Holger Veit  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by  *	Hellmuth Michaelis and Holger Veit  * 4. The name authors may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|id
init|=
literal|"@(#)kcon.c, 3.20, Last Edit-Date: [Wed Jan 25 16:33:08 1995]"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*---------------------------------------------------------------------------*  *  *	kcon.c		Keyboard control and remapping  *	----------------------------------------------  *  *	based on "keymap" which was written by  *	Holger Veit (veit@du9ds3.uni-duisburg.de)  *  *	-hm	a first rewrite  *	-hm	rewrite for pcvt 2.0 distribution  *	-hm	adding show current typematic values  *	-hm	hex/octal/esc output choices  *	-hm	remapping debugging  *	-hm	garbage output for remapped keys bugfix  *	-hm	patch from Lon Willet, adding -R  *  *---------------------------------------------------------------------------*/
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/pcvt_ioctl.h>
end_include

begin_include
include|#
directive|include
file|"keycap.h"
end_include

begin_decl_stmt
name|int
name|Rf
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|df
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lf
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mf
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|of
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pf
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rf
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tf
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|xf
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sf
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*---------------------------------------------------------------------------*  *	main entry  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
specifier|extern
name|int
name|optind
decl_stmt|;
name|int
name|c
init|=
literal|0
decl_stmt|;
name|int
name|errf
init|=
literal|0
decl_stmt|;
name|int
name|rate
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|delay
init|=
operator|-
literal|1
decl_stmt|;
name|char
modifier|*
name|map
decl_stmt|;
name|int
name|kbfd
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"Rd:lm:opr:st:x"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'R'
case|:
name|Rf
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|df
operator|=
literal|1
expr_stmt|;
name|delay
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|lf
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|mf
operator|=
literal|1
expr_stmt|;
name|map
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
if|if
condition|(
name|xf
condition|)
name|errf
operator|=
literal|1
expr_stmt|;
else|else
name|of
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|pf
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|rf
operator|=
literal|1
expr_stmt|;
name|rate
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|sf
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
if|if
condition|(
operator|*
name|optarg
operator|==
literal|'+'
condition|)
name|tf
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|optarg
operator|==
literal|'-'
condition|)
name|tf
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|errf
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
if|if
condition|(
name|of
condition|)
name|errf
operator|=
literal|1
expr_stmt|;
else|else
name|xf
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|Rf
operator|==
literal|0
operator|&&
name|df
operator|==
literal|0
operator|&&
name|lf
operator|==
literal|0
operator|&&
name|tf
operator|==
literal|0
operator|&&
name|sf
operator|==
literal|0
operator|&&
name|rf
operator|==
literal|0
operator|&&
name|mf
operator|==
literal|0
operator|)
operator|||
name|errf
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|kbfd
operator|=
name|open
argument_list|(
name|KEYB_DEVICE
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"kcon: keyboard open failiure"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sf
condition|)
block|{
name|showtypeamatic
argument_list|(
name|kbfd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lf
condition|)
block|{
name|listcurrent
argument_list|(
name|kbfd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Rf
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|kbfd
argument_list|,
name|KBDRESET
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"kcon: ioctl KBDRESET failed"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|tf
condition|)
block|{
name|setrepeat
argument_list|(
name|kbfd
argument_list|,
name|tf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|df
operator|||
name|rf
condition|)
block|{
if|if
condition|(
name|delay
operator|>
literal|3
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Delay value (%d) out of range, possible values are 0..3!\n"
argument_list|,
name|delay
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rate
operator|>
literal|31
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Rate value (%d) out of range, possible values are 0..31!\n"
argument_list|,
name|rate
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|settypeam
argument_list|(
name|kbfd
argument_list|,
name|delay
argument_list|,
name|rate
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mf
condition|)
block|{
name|remapkeys
argument_list|(
name|kbfd
argument_list|,
name|map
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|kbfd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	display usage info& exit  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|usage
argument_list|()
end_macro

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nkcon: keyboard control and remapping utility for pcvt video driver\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: [-R] [-d delay] [-l] [-m map] [-o] [-p] [-r rate] [-t +/-] [-x]\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -R   full reset of keyboard\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -d   delay until a key is repeated (range: 0...3 => 250...1000ms)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -l   produce listing of current keyboard mapping\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -m   set keyboard remapping from a keycap entry\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -o   set octal output for listing\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -p   pure, don't display escape as 'ESC' for listing\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -r   chars/second repeat value (range: 0...31 => 30...2 chars/sec)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -s   show, display the current keyboard typematic values\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -t   switch repeat on(+) or off(-)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       -x   set hexadecimal output for listing\n\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*---------------------------------------------------------------------------*  *	convert control char in string to printable values  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|char
modifier|*
name|showcntrl
parameter_list|(
name|s
parameter_list|)
name|u_char
modifier|*
name|s
decl_stmt|;
block|{
specifier|static
name|char
name|res_str
index|[
literal|80
index|]
decl_stmt|;
specifier|static
name|char
name|conv_buf
index|[
literal|80
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|res_str
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|s
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|s
index|[
name|i
index|]
operator|>
literal|0x20
operator|)
operator|&&
operator|(
name|s
index|[
name|i
index|]
operator|<=
literal|0x7e
operator|)
operator|)
operator|||
operator|(
operator|(
name|s
index|[
name|i
index|]
operator|>=
literal|0xa0
operator|)
operator|&&
operator|(
name|s
index|[
name|i
index|]
operator|<=
literal|0xff
operator|)
operator|)
condition|)
block|{
name|conv_buf
index|[
literal|0
index|]
operator|=
name|s
index|[
name|i
index|]
expr_stmt|;
name|conv_buf
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|s
index|[
name|i
index|]
operator|==
literal|0x1b
operator|)
operator|&&
operator|(
name|pf
operator|==
literal|0
operator|)
condition|)
block|{
name|strcpy
argument_list|(
name|conv_buf
argument_list|,
literal|"ESC "
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|of
condition|)
block|{
name|sprintf
argument_list|(
name|conv_buf
argument_list|,
literal|"\\%03.3o "
argument_list|,
name|s
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|conv_buf
argument_list|,
literal|"0x%02.2X "
argument_list|,
name|s
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|strcat
argument_list|(
name|res_str
argument_list|,
name|conv_buf
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|res_str
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	list the current keyboard mapping  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|listcurrent
argument_list|(
argument|kbfd
argument_list|)
end_macro

begin_decl_stmt
name|int
name|kbfd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|char
modifier|*
name|keytypetab
index|[]
init|=
block|{
literal|"NONE     "
block|,
literal|"SHIFT    "
block|,
literal|"ALT/META "
block|,
literal|"NUMLOCK  "
block|,
literal|"CONTROL  "
block|,
literal|"CAPSLOCK "
block|,
literal|"ASCII    "
block|,
literal|"SCROLL   "
block|,
literal|"FUNCTION "
block|,
literal|"KEYPAD   "
block|,
literal|"BREAK    "
block|,
literal|"ALTGR    "
block|,
literal|"SHIFTLOCK"
block|,
literal|"CURSOR   "
block|,
literal|"RETURN   "
block|}
decl_stmt|;
name|struct
name|kbd_ovlkey
name|keyboardmap
index|[
name|KBDMAXKEYS
index|]
decl_stmt|;
name|struct
name|kbd_ovlkey
modifier|*
name|kbmapp
decl_stmt|;
name|int
name|keytype
decl_stmt|;
name|int
name|altgr_defined
decl_stmt|;
name|int
name|i
decl_stmt|;
name|altgr_defined
operator|=
literal|0
expr_stmt|;
name|kbmapp
operator|=
name|keyboardmap
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|KBDMAXKEYS
condition|;
name|i
operator|++
control|)
block|{
name|kbmapp
operator|->
name|keynum
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|kbfd
argument_list|,
name|KBDGCKEY
argument_list|,
name|kbmapp
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"kcon: ioctl KBDGCKEY failed"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|kbmapp
operator|->
name|type
operator|&
name|KBD_MASK
operator|)
operator|==
name|KBD_ALTGR
condition|)
name|altgr_defined
operator|=
name|i
expr_stmt|;
name|kbmapp
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|altgr_defined
condition|)
block|{
name|printf
argument_list|(
literal|"S Key KeyType   Normal          Shift           Control         Altgr          \n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"- --- --------- --------------- --------------- --------------- ---------------\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"S Key KeyType   Normal          Shift           Control        \n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"- --- --------- --------------- --------------- ---------------\n"
argument_list|)
expr_stmt|;
block|}
name|kbmapp
operator|=
operator|&
name|keyboardmap
index|[
literal|1
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|KBDMAXKEYS
condition|;
name|i
operator|++
control|)
block|{
name|keytype
operator|=
name|kbmapp
operator|->
name|type
expr_stmt|;
if|if
condition|(
name|keytype
condition|)
block|{
if|if
condition|(
name|keytype
operator|&
name|KBD_OVERLOAD
condition|)
name|printf
argument_list|(
literal|"! %3.3d %9.9s "
argument_list|,
name|i
argument_list|,
name|keytypetab
index|[
name|keytype
operator|&
name|KBD_MASK
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"- %3.3d %9.9s "
argument_list|,
name|i
argument_list|,
name|keytypetab
index|[
name|keytype
operator|&
name|KBD_MASK
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|keytype
operator|&
name|KBD_MASK
condition|)
block|{
case|case
name|KBD_NUM
case|:
case|case
name|KBD_ASCII
case|:
case|case
name|KBD_FUNC
case|:
case|case
name|KBD_KP
case|:
case|case
name|KBD_CURSOR
case|:
case|case
name|KBD_RETURN
case|:
comment|/* ??? */
if|if
condition|(
name|kbmapp
operator|->
name|subu
operator|==
name|KBD_SUBT_STR
condition|)
name|printf
argument_list|(
literal|"%-15s "
argument_list|,
name|showcntrl
argument_list|(
name|kbmapp
operator|->
name|unshift
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Function()      "
argument_list|)
expr_stmt|;
if|if
condition|(
name|kbmapp
operator|->
name|subs
operator|==
name|KBD_SUBT_STR
condition|)
name|printf
argument_list|(
literal|"%-15s "
argument_list|,
name|showcntrl
argument_list|(
name|kbmapp
operator|->
name|shift
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Function()      "
argument_list|)
expr_stmt|;
if|if
condition|(
name|kbmapp
operator|->
name|subc
operator|==
name|KBD_SUBT_STR
condition|)
name|printf
argument_list|(
literal|"%-15s "
argument_list|,
name|showcntrl
argument_list|(
name|kbmapp
operator|->
name|ctrl
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Function()      "
argument_list|)
expr_stmt|;
if|if
condition|(
name|altgr_defined
condition|)
block|{
if|if
condition|(
name|kbmapp
operator|->
name|suba
operator|==
name|KBD_SUBT_STR
condition|)
name|printf
argument_list|(
literal|"%-15s "
argument_list|,
name|showcntrl
argument_list|(
name|kbmapp
operator|->
name|altgr
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Function()      "
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
name|kbmapp
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*---------------------------------------------------------------------------*  *	show delay and rate values for keyboard  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|showtypeamatic
argument_list|(
argument|kbfd
argument_list|)
end_macro

begin_decl_stmt
name|int
name|kbfd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|char
modifier|*
name|delaytab
index|[]
init|=
block|{
literal|"250"
block|,
literal|"500"
block|,
literal|"750"
block|,
literal|"1000"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|ratetab
index|[]
init|=
block|{
literal|"30.0"
block|,
literal|"26.7"
block|,
literal|"24.0"
block|,
literal|"21.8"
block|,
literal|"20.0"
block|,
literal|"18.5"
block|,
literal|"17.1"
block|,
literal|"16.0"
block|,
literal|"15.0"
block|,
literal|"13.3"
block|,
literal|"12.0"
block|,
literal|"10.9"
block|,
literal|"10.0"
block|,
literal|"9.2"
block|,
literal|"8.6"
block|,
literal|"8.0"
block|,
literal|"7.5"
block|,
literal|"6.7"
block|,
literal|"6.0"
block|,
literal|"5.5"
block|,
literal|"5.0"
block|,
literal|"4.6"
block|,
literal|"4.3"
block|,
literal|"4.0"
block|,
literal|"3.7"
block|,
literal|"3.3"
block|,
literal|"3.0"
block|,
literal|"2.7"
block|,
literal|"2.5"
block|,
literal|"2.3"
block|,
literal|"2.1"
block|,
literal|"2.0"
block|}
decl_stmt|;
name|int
name|cur_typemat_val
decl_stmt|;
name|int
name|delay
decl_stmt|,
name|rate
decl_stmt|;
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|kbfd
argument_list|,
name|KBDGTPMAT
argument_list|,
operator|&
name|cur_typemat_val
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"kcon: ioctl KBDGTPMAT failed"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|delay
operator|=
operator|(
operator|(
name|cur_typemat_val
operator|&
literal|0x60
operator|)
operator|>>
literal|5
operator|)
expr_stmt|;
name|rate
operator|=
name|cur_typemat_val
operator|&
literal|0x1f
expr_stmt|;
name|printf
argument_list|(
literal|"\nDisplaying the current keyboard typematic values:\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"The delay-until-repeat time is [ %s ] milliseconds\n"
argument_list|,
name|delaytab
index|[
name|delay
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"The repeat-rate is [ %s ] characters per second\n\n"
argument_list|,
name|ratetab
index|[
name|rate
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*---------------------------------------------------------------------------*  *	set repeat feature on/off  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|setrepeat
argument_list|(
argument|kbfd
argument_list|,
argument|tf
argument_list|)
end_macro

begin_decl_stmt
name|int
name|kbfd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tf
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|srepsw_val
decl_stmt|;
if|if
condition|(
name|tf
operator|==
literal|1
condition|)
name|srepsw_val
operator|=
name|KBD_REPEATON
expr_stmt|;
else|else
name|srepsw_val
operator|=
name|KBD_REPEATOFF
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|kbfd
argument_list|,
name|KBDSREPSW
argument_list|,
operator|&
name|srepsw_val
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"kcon: ioctl KBDREPSW failed"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*---------------------------------------------------------------------------*  *	set delay and rate values for keyboard  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|settypeam
argument_list|(
argument|kbfd
argument_list|,
argument|delay
argument_list|,
argument|rate
argument_list|)
end_macro

begin_decl_stmt
name|int
name|kbfd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|delay
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rate
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|cur_typemat_val
decl_stmt|;
name|int
name|new_typemat_val
decl_stmt|;
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|kbfd
argument_list|,
name|KBDGTPMAT
argument_list|,
operator|&
name|cur_typemat_val
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"kcon: ioctl KBDGTPMAT failed"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|delay
operator|==
operator|-
literal|1
condition|)
name|delay
operator|=
operator|(
name|cur_typemat_val
operator|&
literal|0x60
operator|)
expr_stmt|;
else|else
name|delay
operator|=
operator|(
operator|(
name|delay
operator|<<
literal|5
operator|)
operator|&
literal|0x60
operator|)
expr_stmt|;
if|if
condition|(
name|rate
operator|==
operator|-
literal|1
condition|)
name|rate
operator|=
operator|(
name|cur_typemat_val
operator|&
literal|0x1f
operator|)
expr_stmt|;
else|else
name|rate
operator|&=
literal|0x1f
expr_stmt|;
name|new_typemat_val
operator|=
name|delay
operator||
name|rate
expr_stmt|;
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|kbfd
argument_list|,
name|KBDSTPMAT
argument_list|,
operator|&
name|new_typemat_val
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"kcon: ioctl KBDSTPMAT failed"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*---------------------------------------------------------------------------*  *	remap keyboard from keycap entry  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|remapkeys
argument_list|(
argument|kbfd
argument_list|,
argument|map
argument_list|)
end_macro

begin_decl_stmt
name|int
name|kbfd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|map
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|cap_entry
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|char
name|keyflag
index|[
literal|128
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* try to find the entry */
name|ret
operator|=
name|kgetent
argument_list|(
name|cap_entry
argument_list|,
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"kcon: keycap database not found or not accessible!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"kcon: keycap entry [%s] not found in database!\n"
argument_list|,
name|map
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* set default mapping */
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|kbfd
argument_list|,
name|KBDDEFAULT
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"kcon: ioctl KBDDEFAULT failed"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* DE flag present? */
if|if
condition|(
name|kgetflag
argument_list|(
literal|"de"
argument_list|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|KBDMAXKEYS
condition|;
name|i
operator|++
control|)
name|keyflag
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|set_lock
argument_list|(
name|keyflag
argument_list|,
name|kbfd
argument_list|)
expr_stmt|;
name|set_shift
argument_list|(
name|keyflag
argument_list|,
name|kbfd
argument_list|)
expr_stmt|;
name|set_char
argument_list|(
name|keyflag
argument_list|,
name|kbfd
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*---------------------------------------------------------------------------*  *	care for lock keys  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|set_lock
argument_list|(
argument|keyflag
argument_list|,
argument|kbfd
argument_list|)
end_macro

begin_decl_stmt
name|char
name|keyflag
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kbfd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
name|cap
index|[
literal|16
index|]
decl_stmt|;
name|struct
name|kbd_ovlkey
name|entry
decl_stmt|;
struct|struct
block|{
name|char
modifier|*
name|ch
decl_stmt|;
name|u_short
name|typ
decl_stmt|;
block|}
name|lock
index|[]
init|=
block|{
literal|"ca"
block|,
name|KBD_CAPS
block|,
literal|"sh"
block|,
name|KBD_SHFTLOCK
block|,
literal|"nl"
block|,
name|KBD_NUMLOCK
block|,
literal|"sc"
block|,
name|KBD_SCROLL
block|}
struct|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|int
name|n
decl_stmt|;
name|sprintf
argument_list|(
name|cap
argument_list|,
literal|"%s"
argument_list|,
name|lock
index|[
name|i
index|]
operator|.
name|ch
argument_list|)
expr_stmt|;
name|n
operator|=
name|kgetnum
argument_list|(
name|cap
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|keyflag
index|[
name|n
index|]
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"kcon: duplicate key definition for key [%d]!\n"
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|keyflag
index|[
name|n
index|]
operator|=
literal|1
expr_stmt|;
name|entry
operator|.
name|keynum
operator|=
name|n
expr_stmt|;
name|entry
operator|.
name|type
operator|=
name|lock
index|[
name|i
index|]
operator|.
name|typ
expr_stmt|;
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|kbfd
argument_list|,
name|KBDSCKEY
argument_list|,
operator|&
name|entry
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"kcon: ioctl KBDSCKEY failed"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_block

begin_comment
comment|/*---------------------------------------------------------------------------*  *	care for shifting keys  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|set_shift
argument_list|(
argument|keyflag
argument_list|,
argument|kbfd
argument_list|)
end_macro

begin_decl_stmt
name|char
name|keyflag
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kbfd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
name|cap
index|[
literal|16
index|]
decl_stmt|;
name|struct
name|kbd_ovlkey
name|entry
decl_stmt|;
struct|struct
block|{
name|char
name|ch
decl_stmt|;
name|u_short
name|typ
decl_stmt|;
block|}
name|shift
index|[]
init|=
block|{
literal|'m'
block|,
name|KBD_META
block|,
literal|'l'
block|,
name|KBD_ALTGR
block|,
literal|'h'
block|,
name|KBD_SHIFT
block|,
literal|'t'
block|,
name|KBD_CTL
block|}
struct|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
literal|10
condition|;
name|j
operator|++
control|)
block|{
name|int
name|n
decl_stmt|;
name|sprintf
argument_list|(
name|cap
argument_list|,
literal|"%c%d"
argument_list|,
name|shift
index|[
name|i
index|]
operator|.
name|ch
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|n
operator|=
name|kgetnum
argument_list|(
name|cap
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|keyflag
index|[
name|n
index|]
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"kcon: duplicate key definition for key [%d]!\n"
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|keyflag
index|[
name|n
index|]
operator|=
literal|1
expr_stmt|;
name|entry
operator|.
name|keynum
operator|=
name|n
expr_stmt|;
name|entry
operator|.
name|type
operator|=
name|shift
index|[
name|i
index|]
operator|.
name|typ
expr_stmt|;
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|kbfd
argument_list|,
name|KBDSCKEY
argument_list|,
operator|&
name|entry
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"kcon: ioctl KBDSCKEY failed"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_block

begin_comment
comment|/*---------------------------------------------------------------------------*  *	care for normal keys  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|set_char
argument_list|(
argument|keyflag
argument_list|,
argument|kbfd
argument_list|)
end_macro

begin_decl_stmt
name|char
name|keyflag
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kbfd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
name|cap
index|[
literal|16
index|]
decl_stmt|;
name|int
name|setflag
decl_stmt|;
name|char
modifier|*
name|addr_str
decl_stmt|;
name|char
modifier|*
name|new_str
decl_stmt|;
name|struct
name|kbd_ovlkey
name|entry
decl_stmt|;
struct|struct
block|{
name|char
modifier|*
name|addr
decl_stmt|;
name|char
name|ch
decl_stmt|;
block|}
name|standard
index|[]
init|=
block|{
literal|0
block|,
literal|'D'
block|,
operator|&
name|entry
operator|.
name|unshift
index|[
literal|0
index|]
block|,
literal|'K'
block|,
operator|&
name|entry
operator|.
name|shift
index|[
literal|0
index|]
block|,
literal|'S'
block|,
operator|&
name|entry
operator|.
name|ctrl
index|[
literal|0
index|]
block|,
literal|'C'
block|,
operator|&
name|entry
operator|.
name|altgr
index|[
literal|0
index|]
block|,
literal|'A'
block|}
struct|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|KBDMAXKEYS
condition|;
name|i
operator|++
control|)
block|{
name|setflag
operator|=
literal|0
expr_stmt|;
name|entry
operator|.
name|keynum
operator|=
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|kbfd
argument_list|,
name|KBDGOKEY
argument_list|,
operator|&
name|entry
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"kcon: ioctl KBDGOKEY failed"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|entry
operator|.
name|type
operator|=
name|KBD_ASCII
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|5
condition|;
name|j
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|cap
argument_list|,
literal|"%c%d"
argument_list|,
name|standard
index|[
name|j
index|]
operator|.
name|ch
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|j
operator|==
literal|0
operator|)
operator|&&
operator|(
name|kgetflag
argument_list|(
name|cap
argument_list|)
operator|)
condition|)
block|{
comment|/* delete a key */
name|entry
operator|.
name|type
operator|=
name|KBD_NONE
expr_stmt|;
name|setflag
operator|=
literal|1
expr_stmt|;
goto|goto
name|setit
goto|;
block|}
else|else
block|{
name|addr_str
operator|=
name|standard
index|[
name|j
index|]
operator|.
name|addr
expr_stmt|;
if|if
condition|(
name|new_str
operator|=
name|kgetstr
argument_list|(
name|cap
argument_list|,
operator|&
name|addr_str
argument_list|)
condition|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|new_str
argument_list|)
operator|>
name|KBDMAXOVLKEYSIZE
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"kcon: database entry string [%s] longer than max [%d]!\n"
argument_list|,
name|new_str
argument_list|,
name|KBDMAXOVLKEYSIZE
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|setflag
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
name|setit
label|:
if|if
condition|(
name|setflag
condition|)
block|{
if|if
condition|(
name|keyflag
index|[
name|i
index|]
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"kcon: duplicate key definition for key [%d]!\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|keyflag
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|kbfd
argument_list|,
name|KBDSCKEY
argument_list|,
operator|&
name|entry
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"kcon: ioctl KBDSCKEY failed"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_block

begin_comment
comment|/*------------------- EOF ------------------------------------------------*/
end_comment

end_unit


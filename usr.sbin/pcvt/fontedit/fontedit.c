begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * fontedit  *	Fonteditor for VT220  *  *  BUGS:  *	o Cursor motion is less than optimal (but who cares at 9600),  *  *  COMPILE:  *	cc -O fontedit.c -o fontedit  *      (use Makefile)  *  *	Copyright (c) 1987 by Greg Franks.  *  *	Permission is granted to do anything you want with this program  *	except claim that you wrote it.  *  *  *      REVISION HISTORY:  *  *      Nov 21, 1987 - Fixed man page to say "Fontedit" instead of "Top"   *      Nov 22, 1987 - Added BSD Compatible ioctl, turned cursor on/off  *                     - eap@bucsf.bu.edu  */
end_comment

begin_function_decl
name|void
name|clear_screen
parameter_list|()
function_decl|;
end_function_decl

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SYSV
end_ifdef

begin_include
include|#
directive|include
file|<sys/termio.h>
end_include

begin_endif
endif|#
directive|endif
endif|SYSV
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|BSD
end_ifdef

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_endif
endif|#
directive|endif
endif|BSD
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__386BSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/termios.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __386BSD__ || __NetBSD__ || __FreeBSD__ */
end_comment

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CURFIX
end_ifdef

begin_define
define|#
directive|define
name|CURSORON
value|"\033[?25h"
end_define

begin_define
define|#
directive|define
name|CURSOROFF
value|"\033[?25l"
end_define

begin_endif
endif|#
directive|endif
endif|CURFIX
end_endif

begin_define
define|#
directive|define
name|MAX_ROWS
value|10
end_define

begin_define
define|#
directive|define
name|MAX_COLS
value|8
end_define

begin_typedef
typedef|typedef
enum|enum
block|{
name|false
block|,
name|true
block|}
name|bool
typedef|;
end_typedef

begin_define
define|#
directive|define
name|KEY_FIND
value|0x0100
end_define

begin_define
define|#
directive|define
name|KEY_INSERT
value|0x0101
end_define

begin_define
define|#
directive|define
name|KEY_REMOVE
value|0x0102
end_define

begin_define
define|#
directive|define
name|KEY_SELECT
value|0x0103
end_define

begin_define
define|#
directive|define
name|KEY_PREV
value|0x0104
end_define

begin_define
define|#
directive|define
name|KEY_NEXT
value|0x0105
end_define

begin_define
define|#
directive|define
name|KEY_F6
value|0X0106
end_define

begin_define
define|#
directive|define
name|KEY_F7
value|0x0107
end_define

begin_define
define|#
directive|define
name|KEY_F8
value|0x0108
end_define

begin_define
define|#
directive|define
name|KEY_F9
value|0x0109
end_define

begin_define
define|#
directive|define
name|KEY_F10
value|0x010a
end_define

begin_define
define|#
directive|define
name|KEY_F11
value|0x010b
end_define

begin_define
define|#
directive|define
name|KEY_F12
value|0x010c
end_define

begin_define
define|#
directive|define
name|KEY_F13
value|0x010d
end_define

begin_define
define|#
directive|define
name|KEY_F14
value|0x010e
end_define

begin_define
define|#
directive|define
name|KEY_HELP
value|0x010f
end_define

begin_define
define|#
directive|define
name|KEY_DO
value|0x0110
end_define

begin_define
define|#
directive|define
name|KEY_F17
value|0x0111
end_define

begin_define
define|#
directive|define
name|KEY_F18
value|0x0112
end_define

begin_define
define|#
directive|define
name|KEY_F19
value|0x0113
end_define

begin_define
define|#
directive|define
name|KEY_F20
value|0x0114
end_define

begin_define
define|#
directive|define
name|KEY_UP
value|0x0115
end_define

begin_define
define|#
directive|define
name|KEY_DOWN
value|0x0116
end_define

begin_define
define|#
directive|define
name|KEY_RIGHT
value|0x0117
end_define

begin_define
define|#
directive|define
name|KEY_LEFT
value|0x0118
end_define

begin_comment
comment|/*  * Position of main drawing screen.  */
end_comment

begin_define
define|#
directive|define
name|ROW_OFFSET
value|3
end_define

begin_define
define|#
directive|define
name|COL_OFFSET
value|10
end_define

begin_comment
comment|/*   * Position of the DRCS table.  */
end_comment

begin_define
define|#
directive|define
name|TABLE_ROW
value|4
end_define

begin_define
define|#
directive|define
name|TABLE_COL
value|50
end_define

begin_comment
comment|/*  *  */
end_comment

begin_define
define|#
directive|define
name|ERROR_ROW
value|20
end_define

begin_define
define|#
directive|define
name|ERROR_COL
value|40
end_define

begin_decl_stmt
name|bool
name|display_table
index|[
name|MAX_ROWS
index|]
index|[
name|MAX_COLS
index|]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|TOTAL_ENTRIES
value|(128 - 32)
end_define

begin_define
define|#
directive|define
name|SIXELS_PER_CHAR
value|16
end_define

begin_decl_stmt
name|char
name|font_table
index|[
name|TOTAL_ENTRIES
index|]
index|[
name|SIXELS_PER_CHAR
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|int
name|current_entry
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|SYSV
end_ifdef

begin_decl_stmt
name|struct
name|termio
name|old_stty
decl_stmt|,
name|new_stty
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|SYSV
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|BSD
end_ifdef

begin_decl_stmt
name|struct
name|sgttyb
name|old_stty
decl_stmt|,
name|new_stty
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|BSD
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__386BSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_if

begin_decl_stmt
name|struct
name|termios
name|old_stty
decl_stmt|,
name|new_stty
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __386BSD__ || __NetBSD__ || __FreeBSD__ */
end_comment

begin_decl_stmt
name|FILE
modifier|*
name|font_file
init|=
operator|(
name|FILE
operator|*
operator|)
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Interrupt  *	Exit gracefully.  */
end_comment

begin_macro
name|interrupt
argument_list|()
end_macro

begin_block
block|{
name|void
name|clear_screen
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|CURFIX
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|CURSORON
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|CURFIX
ifdef|#
directive|ifdef
name|SYSV
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TCSETA
argument_list|,
operator|&
name|old_stty
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SYSV
ifdef|#
directive|ifdef
name|BSD
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSETP
argument_list|,
operator|&
name|old_stty
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BSD
if|#
directive|if
name|defined
argument_list|(
name|__386BSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSETA
argument_list|,
operator|&
name|old_stty
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* __386BSD__ || __NetBSD__ || __FreeBSD__ */
name|clear_screen
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Main  *	Grab input/output file and call main command processor.  */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|void
name|command
argument_list|()
decl_stmt|,
name|init_restore
argument_list|()
decl_stmt|,
name|clear_screen
argument_list|()
decl_stmt|;
name|void
name|save_table
argument_list|()
decl_stmt|,
name|get_table
argument_list|()
decl_stmt|,
name|extract_entry
argument_list|()
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: fontedit filename\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Press HELP for help\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\033P1;1;2{ @\033\\"
argument_list|)
expr_stmt|;
comment|/* Clear font buffer	*/
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* Let terminal catch up	*/
comment|/* otherwise we get frogs	*/
if|if
condition|(
operator|(
name|font_file
operator|=
name|fopen
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
operator|(
name|FILE
operator|*
operator|)
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|font_file
operator|=
name|fopen
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
operator|(
name|FILE
operator|*
operator|)
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot create file %s \n"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|fclose
argument_list|(
name|font_file
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|font_file
operator|=
name|fopen
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
operator|(
name|FILE
operator|*
operator|)
literal|0
condition|)
block|{
name|get_table
argument_list|(
name|font_file
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|font_file
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|font_file
operator|=
name|fopen
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"r+"
argument_list|)
operator|)
operator|==
operator|(
name|FILE
operator|*
operator|)
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot open %s for writing\n"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CURFIX
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|CURSOROFF
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|CURFIX
ifdef|#
directive|ifdef
name|SYSV
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TCGETA
argument_list|,
operator|&
name|old_stty
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SYSV
ifdef|#
directive|ifdef
name|BSD
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCGETP
argument_list|,
operator|&
name|old_stty
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BSD
if|#
directive|if
name|defined
argument_list|(
name|__386BSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCGETA
argument_list|,
operator|&
name|old_stty
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* __386BSD__ || __NetBSD__ || __FreeBSD__ */
name|signal
argument_list|(
name|SIGINT
argument_list|,
operator|(
name|void
operator|*
operator|)
name|interrupt
argument_list|)
expr_stmt|;
name|new_stty
operator|=
name|old_stty
expr_stmt|;
ifdef|#
directive|ifdef
name|SYSV
name|new_stty
operator|.
name|c_lflag
operator|&=
operator|~
name|ICANON
expr_stmt|;
name|new_stty
operator|.
name|c_cc
index|[
name|VMIN
index|]
operator|=
literal|1
expr_stmt|;
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TCSETA
argument_list|,
operator|&
name|new_stty
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SYSV
if|#
directive|if
name|defined
argument_list|(
name|__386BSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
name|new_stty
operator|.
name|c_lflag
operator|&=
operator|~
name|ICANON
expr_stmt|;
name|new_stty
operator|.
name|c_lflag
operator|&=
operator|~
name|ECHO
expr_stmt|;
name|new_stty
operator|.
name|c_cc
index|[
name|VMIN
index|]
operator|=
literal|1
expr_stmt|;
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSETA
argument_list|,
operator|&
name|new_stty
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* __386BSD__ || __NetBSD__ || __FreeBSD__ */
ifdef|#
directive|ifdef
name|BSD
name|new_stty
operator|.
name|sg_flags
operator||=
name|CBREAK
expr_stmt|;
name|new_stty
operator|.
name|sg_flags
operator|&=
operator|~
name|ECHO
expr_stmt|;
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSETP
argument_list|,
operator|&
name|new_stty
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BSD
name|current_entry
operator|=
literal|1
expr_stmt|;
name|extract_entry
argument_list|(
name|current_entry
argument_list|)
expr_stmt|;
name|init_restore
argument_list|()
expr_stmt|;
name|command
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|SYSV
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TCSETA
argument_list|,
operator|&
name|old_stty
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SYSV
ifdef|#
directive|ifdef
name|BSD
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSETP
argument_list|,
operator|&
name|old_stty
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BSD
if|#
directive|if
name|defined
argument_list|(
name|__386BSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSETA
argument_list|,
operator|&
name|old_stty
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* __386BSD__ || __NetBSD__ || __FreeBSD__ */
name|clear_screen
argument_list|()
expr_stmt|;
comment|/* Overwrite the old file. */
name|fseek
argument_list|(
name|font_file
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|save_table
argument_list|(
name|font_file
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|font_file
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CURFIX
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|CURSORON
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|CURFIX
block|}
end_function

begin_comment
comment|/*  * Command  *	Process a function key.   *  *	The user cannot fill in slots 0 or 95 (space and del respecitively).  */
end_comment

begin_function
name|void
name|command
parameter_list|()
block|{
specifier|register
name|int
name|c
decl_stmt|;
specifier|register
name|int
name|row
decl_stmt|,
name|col
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|bool
name|change
decl_stmt|,
name|error
decl_stmt|,
name|override
decl_stmt|;
name|void
name|build_entry
argument_list|()
decl_stmt|,
name|extract_entry
argument_list|()
decl_stmt|,
name|send_entry
argument_list|()
decl_stmt|,
name|print_entry
argument_list|()
decl_stmt|;
name|void
name|highlight
argument_list|()
decl_stmt|,
name|draw_current
argument_list|()
decl_stmt|,
name|init_restore
argument_list|()
decl_stmt|,
name|help
argument_list|()
decl_stmt|;
name|void
name|warning
parameter_list|()
function_decl|;
name|change
operator|=
name|false
expr_stmt|;
name|error
operator|=
name|false
expr_stmt|;
name|override
operator|=
name|false
expr_stmt|;
name|row
operator|=
literal|0
expr_stmt|;
name|col
operator|=
literal|0
expr_stmt|;
name|highlight
argument_list|(
name|row
argument_list|,
name|col
argument_list|,
name|true
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|c
operator|=
name|get_key
argument_list|()
expr_stmt|;
name|highlight
argument_list|(
name|row
argument_list|,
name|col
argument_list|,
name|false
argument_list|)
expr_stmt|;
comment|/* turn cursor off	*/
if|if
condition|(
name|error
condition|)
block|{
name|move
argument_list|(
name|ERROR_ROW
argument_list|,
name|ERROR_COL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\033[K"
argument_list|)
expr_stmt|;
comment|/* Clear error message	*/
name|move
argument_list|(
name|ERROR_ROW
operator|+
literal|1
argument_list|,
name|ERROR_COL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\033[K"
argument_list|)
expr_stmt|;
comment|/* Clear error message	*/
name|error
operator|=
name|false
expr_stmt|;
block|}
else|else
block|{
name|override
operator|=
name|false
expr_stmt|;
block|}
switch|switch
condition|(
name|c
condition|)
block|{
case|case
name|KEY_FIND
case|:
comment|/* update DRCS 	*/
if|if
condition|(
operator|!
name|change
operator|&&
operator|!
name|override
condition|)
block|{
name|warning
argument_list|(
literal|"No changes to save"
argument_list|)
expr_stmt|;
name|override
operator|=
name|true
expr_stmt|;
name|error
operator|=
name|true
expr_stmt|;
block|}
else|else
block|{
name|build_entry
argument_list|(
name|current_entry
argument_list|)
expr_stmt|;
name|send_entry
argument_list|(
name|current_entry
argument_list|)
expr_stmt|;
name|print_entry
argument_list|(
name|current_entry
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|change
operator|=
name|false
expr_stmt|;
block|}
break|break;
case|case
name|KEY_F6
case|:
comment|/* Turn on pixel	*/
name|change
operator|=
name|true
expr_stmt|;
name|display_table
index|[
name|row
index|]
index|[
name|col
index|]
operator|=
name|true
expr_stmt|;
name|highlight
argument_list|(
name|row
argument_list|,
name|col
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|col
operator|=
operator|(
name|col
operator|+
literal|1
operator|)
operator|%
name|MAX_COLS
expr_stmt|;
if|if
condition|(
name|col
operator|==
literal|0
condition|)
name|row
operator|=
operator|(
name|row
operator|+
literal|1
operator|)
operator|%
name|MAX_ROWS
expr_stmt|;
break|break;
case|case
name|KEY_F7
case|:
comment|/* Turn off pixel	*/
name|change
operator|=
name|true
expr_stmt|;
name|display_table
index|[
name|row
index|]
index|[
name|col
index|]
operator|=
name|false
expr_stmt|;
name|highlight
argument_list|(
name|row
argument_list|,
name|col
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|col
operator|=
operator|(
name|col
operator|+
literal|1
operator|)
operator|%
name|MAX_COLS
expr_stmt|;
if|if
condition|(
name|col
operator|==
literal|0
condition|)
name|row
operator|=
operator|(
name|row
operator|+
literal|1
operator|)
operator|%
name|MAX_ROWS
expr_stmt|;
break|break;
case|case
name|KEY_INSERT
case|:
comment|/* Insert a blank row	*/
name|change
operator|=
name|true
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|MAX_COLS
condition|;
operator|++
name|j
control|)
block|{
for|for
control|(
name|i
operator|=
name|MAX_ROWS
operator|-
literal|1
init|;
name|i
operator|>
name|row
condition|;
operator|--
name|i
control|)
block|{
name|display_table
index|[
name|i
index|]
index|[
name|j
index|]
operator|=
name|display_table
index|[
name|i
operator|-
literal|1
index|]
index|[
name|j
index|]
expr_stmt|;
block|}
name|display_table
index|[
name|row
index|]
index|[
name|j
index|]
operator|=
name|false
expr_stmt|;
block|}
name|draw_current
argument_list|()
expr_stmt|;
break|break;
case|case
name|KEY_REMOVE
case|:
comment|/* Remove a row	*/
name|change
operator|=
name|true
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|MAX_COLS
condition|;
operator|++
name|j
control|)
block|{
for|for
control|(
name|i
operator|=
name|row
init|;
name|i
operator|<
name|MAX_ROWS
operator|-
literal|1
condition|;
operator|++
name|i
control|)
block|{
name|display_table
index|[
name|i
index|]
index|[
name|j
index|]
operator|=
name|display_table
index|[
name|i
operator|+
literal|1
index|]
index|[
name|j
index|]
expr_stmt|;
block|}
name|display_table
index|[
name|MAX_ROWS
operator|-
literal|1
index|]
index|[
name|j
index|]
operator|=
name|false
expr_stmt|;
block|}
name|draw_current
argument_list|()
expr_stmt|;
break|break;
case|case
name|KEY_F13
case|:
comment|/* Clear buffer	*/
if|if
condition|(
name|change
operator|&&
operator|!
name|override
condition|)
block|{
name|warning
argument_list|(
literal|"Changes not saved"
argument_list|)
expr_stmt|;
name|error
operator|=
name|true
expr_stmt|;
name|override
operator|=
name|true
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|MAX_COLS
condition|;
operator|++
name|j
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_ROWS
condition|;
operator|++
name|i
control|)
block|{
name|display_table
index|[
name|i
index|]
index|[
name|j
index|]
operator|=
name|false
expr_stmt|;
block|}
block|}
name|draw_current
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|KEY_SELECT
case|:
comment|/* Select font from DRCS	*/
if|if
condition|(
name|change
operator|&&
operator|!
name|override
condition|)
block|{
name|warning
argument_list|(
literal|"Changes not saved"
argument_list|)
expr_stmt|;
name|error
operator|=
name|true
expr_stmt|;
name|override
operator|=
name|true
expr_stmt|;
block|}
else|else
block|{
name|extract_entry
argument_list|(
name|current_entry
argument_list|)
expr_stmt|;
name|draw_current
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|KEY_PREV
case|:
comment|/* Move to prev entry in DRCS	*/
if|if
condition|(
name|change
operator|&&
operator|!
name|override
condition|)
block|{
name|warning
argument_list|(
literal|"Changes not saved"
argument_list|)
expr_stmt|;
name|override
operator|=
name|true
expr_stmt|;
name|error
operator|=
name|true
expr_stmt|;
block|}
else|else
block|{
name|print_entry
argument_list|(
name|current_entry
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|current_entry
operator|=
name|current_entry
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|current_entry
operator|==
literal|0
condition|)
name|current_entry
operator|=
name|TOTAL_ENTRIES
operator|-
literal|2
expr_stmt|;
name|print_entry
argument_list|(
name|current_entry
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|KEY_NEXT
case|:
comment|/* Move to next entry in DRCS	*/
if|if
condition|(
name|change
operator|&&
operator|!
name|override
condition|)
block|{
name|warning
argument_list|(
literal|"Changes not saved"
argument_list|)
expr_stmt|;
name|override
operator|=
name|true
expr_stmt|;
name|error
operator|=
name|true
expr_stmt|;
block|}
else|else
block|{
name|print_entry
argument_list|(
name|current_entry
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|current_entry
operator|=
name|current_entry
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|current_entry
operator|==
name|TOTAL_ENTRIES
operator|-
literal|1
condition|)
name|current_entry
operator|=
literal|1
expr_stmt|;
name|print_entry
argument_list|(
name|current_entry
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|KEY_UP
case|:
comment|/* UP one row.			*/
if|if
condition|(
name|row
operator|==
literal|0
condition|)
name|row
operator|=
name|MAX_ROWS
expr_stmt|;
name|row
operator|=
name|row
operator|-
literal|1
expr_stmt|;
break|break;
case|case
name|KEY_DOWN
case|:
comment|/* Guess.			*/
name|row
operator|=
operator|(
name|row
operator|+
literal|1
operator|)
operator|%
name|MAX_ROWS
expr_stmt|;
break|break;
case|case
name|KEY_RIGHT
case|:
name|col
operator|=
operator|(
name|col
operator|+
literal|1
operator|)
operator|%
name|MAX_COLS
expr_stmt|;
break|break;
case|case
name|KEY_LEFT
case|:
if|if
condition|(
name|col
operator|==
literal|0
condition|)
name|col
operator|=
name|MAX_COLS
expr_stmt|;
name|col
operator|=
name|col
operator|-
literal|1
expr_stmt|;
break|break;
case|case
name|KEY_HELP
case|:
comment|/* Display helpful info		*/
name|clear_screen
argument_list|()
expr_stmt|;
name|help
argument_list|()
expr_stmt|;
name|c
operator|=
name|getchar
argument_list|()
expr_stmt|;
name|init_restore
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'\004'
case|:
comment|/* All done!			*/
return|return;
case|case
literal|'\f'
case|:
comment|/* Redraw display		*/
name|init_restore
argument_list|()
expr_stmt|;
break|break;
default|default:
comment|/* user is a klutzy  typist	*/
name|move
argument_list|(
name|ERROR_ROW
argument_list|,
name|ERROR_COL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Unknown key: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|<
literal|0x20
condition|)
block|{
name|printf
argument_list|(
literal|"^%c"
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|<
literal|0x0100
condition|)
block|{
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"0x%04x"
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|error
operator|=
name|true
expr_stmt|;
block|}
name|highlight
argument_list|(
name|row
argument_list|,
name|col
argument_list|,
name|true
argument_list|)
expr_stmt|;
comment|/* turn cursor on	*/
block|}
block|}
end_function

begin_decl_stmt
name|char
modifier|*
name|key_table
index|[]
init|=
block|{
literal|"\033[1~"
block|,
comment|/* Find		*/
literal|"\033[2~"
block|,
comment|/* Insert	*/
literal|"\033[3~"
block|,
comment|/* Remove	*/
literal|"\033[4~"
block|,
comment|/* Select	*/
literal|"\033[5~"
block|,
comment|/* Prev		*/
literal|"\033[6~"
block|,
comment|/* Next		*/
literal|"\033[17~"
block|,
literal|"\033[18~"
block|,
literal|"\033[19~"
block|,
literal|"\033[20~"
block|,
literal|"\033[21~"
block|,
literal|"\033[23~"
block|,
literal|"\033[24~"
block|,
literal|"\033[25~"
block|,
literal|"\033[26~"
block|,
literal|"\033[28~"
block|,
literal|"\033[29~"
block|,
literal|"\033[31~"
block|,
literal|"\033[32~"
block|,
literal|"\033[33~"
block|,
literal|"\033[34~"
block|,
literal|"\033[A"
block|,
literal|"\033[B"
block|,
literal|"\033[C"
block|,
literal|"\033[D"
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * get_key  *	Convert VT220 escape sequence into something more reasonable.  */
end_comment

begin_function
name|int
name|get_key
parameter_list|()
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|char
name|s
index|[
literal|10
index|]
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|p
operator|=
name|s
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
operator|++
name|i
control|)
block|{
operator|*
name|p
operator|=
name|getchar
argument_list|()
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
operator|&&
operator|*
name|p
operator|!=
literal|'\033'
condition|)
return|return
operator|(
operator|(
name|int
operator|)
operator|*
name|p
operator|)
return|;
comment|/* Not an escape sequence */
if|if
condition|(
operator|*
name|p
operator|!=
literal|'\033'
operator|&&
operator|*
name|p
operator|<
literal|0x0020
condition|)
return|return
operator|(
operator|(
name|int
operator|)
operator|*
name|p
operator|)
return|;
comment|/* Control character	*/
operator|*
operator|++
name|p
operator|=
literal|'\0'
expr_stmt|;
comment|/* Null terminate	*/
for|for
control|(
name|j
operator|=
literal|0
init|;
name|key_table
index|[
name|j
index|]
condition|;
operator|++
name|j
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|s
argument_list|,
name|key_table
index|[
name|j
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
operator|(
name|j
operator||
literal|0x0100
operator|)
return|;
block|}
block|}
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * pad  *	Emit nulls so that the terminal can catch up.  */
end_comment

begin_macro
name|pad
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
operator|++
name|i
control|)
name|putchar
argument_list|(
literal|'\000'
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * init_restore  *	refresh the main display table.  */
end_comment

begin_function
name|void
name|init_restore
parameter_list|()
block|{
specifier|register
name|int
name|row
decl_stmt|,
name|col
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|void
name|draw_current
argument_list|()
decl_stmt|,
name|clear_screen
argument_list|()
decl_stmt|,
name|print_entry
argument_list|()
decl_stmt|;
name|clear_screen
argument_list|()
expr_stmt|;
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
name|MAX_COLS
condition|;
operator|++
name|col
control|)
block|{
name|move
argument_list|(
name|ROW_OFFSET
operator|-
literal|2
argument_list|,
name|col
operator|*
literal|3
operator|+
name|COL_OFFSET
operator|+
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d"
argument_list|,
name|col
argument_list|)
expr_stmt|;
block|}
name|move
argument_list|(
name|ROW_OFFSET
operator|-
literal|1
argument_list|,
name|COL_OFFSET
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"+--+--+--+--+--+--+--+--+"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|ROW_OFFSET
operator|+
name|MAX_ROWS
operator|*
literal|2
argument_list|,
name|COL_OFFSET
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"+--+--+--+--+--+--+--+--+"
argument_list|)
expr_stmt|;
for|for
control|(
name|row
operator|=
literal|0
init|;
name|row
operator|<
name|MAX_ROWS
condition|;
operator|++
name|row
control|)
block|{
if|if
condition|(
name|row
operator|!=
literal|0
operator|&&
name|row
operator|!=
literal|7
condition|)
block|{
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
argument_list|,
name|COL_OFFSET
operator|-
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d|"
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
operator|+
literal|1
argument_list|,
name|COL_OFFSET
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"|"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
argument_list|,
name|COL_OFFSET
operator|+
name|MAX_COLS
operator|*
literal|3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"|"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
operator|+
literal|1
argument_list|,
name|COL_OFFSET
operator|+
name|MAX_COLS
operator|*
literal|3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"|"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
argument_list|,
name|COL_OFFSET
operator|-
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d*"
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
operator|+
literal|1
argument_list|,
name|COL_OFFSET
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"*"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
argument_list|,
name|COL_OFFSET
operator|+
name|MAX_COLS
operator|*
literal|3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"*"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
operator|+
literal|1
argument_list|,
name|COL_OFFSET
operator|+
name|MAX_COLS
operator|*
literal|3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"*"
argument_list|)
expr_stmt|;
block|}
block|}
name|draw_current
argument_list|()
expr_stmt|;
name|move
argument_list|(
name|TABLE_ROW
operator|-
literal|1
argument_list|,
name|TABLE_COL
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"+-+-+-+-+-+-+-+-+-+-+-+-+"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|TABLE_ROW
operator|+
literal|8
operator|*
literal|2
operator|-
literal|1
argument_list|,
name|TABLE_COL
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"+-+-+-+-+-+-+-+-+-+-+-+-+"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
block|{
name|move
argument_list|(
name|TABLE_ROW
operator|+
name|i
operator|*
literal|2
argument_list|,
name|TABLE_COL
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"|"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|TABLE_ROW
operator|+
name|i
operator|*
literal|2
operator|+
literal|1
argument_list|,
name|TABLE_COL
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"+"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|TABLE_ROW
operator|+
name|i
operator|*
literal|2
argument_list|,
name|TABLE_COL
operator|+
literal|12
operator|*
literal|2
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"|"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|TABLE_ROW
operator|+
name|i
operator|*
literal|2
operator|+
literal|1
argument_list|,
name|TABLE_COL
operator|+
literal|12
operator|*
literal|2
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"+"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TOTAL_ENTRIES
condition|;
operator|++
name|i
control|)
name|print_entry
argument_list|(
name|i
argument_list|,
operator|(
name|i
operator|==
name|current_entry
operator|)
condition|?
name|true
else|:
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * draw_current  *	Draw the complete current entry.  */
end_comment

begin_function
name|void
name|draw_current
parameter_list|()
block|{
specifier|register
name|int
name|row
decl_stmt|,
name|col
decl_stmt|;
name|printf
argument_list|(
literal|"\033)0"
argument_list|)
expr_stmt|;
comment|/* Special graphics in G1	*/
name|printf
argument_list|(
literal|"\016"
argument_list|)
expr_stmt|;
comment|/* Lock in G1 (SO)		*/
for|for
control|(
name|row
operator|=
literal|0
init|;
name|row
operator|<
name|MAX_ROWS
condition|;
operator|++
name|row
control|)
block|{
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
name|MAX_COLS
condition|;
operator|++
name|col
control|)
block|{
if|if
condition|(
name|display_table
index|[
name|row
index|]
index|[
name|col
index|]
condition|)
block|{
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
argument_list|,
name|col
operator|*
literal|3
operator|+
name|COL_OFFSET
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\141\141\141"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
operator|+
literal|1
argument_list|,
name|col
operator|*
literal|3
operator|+
name|COL_OFFSET
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\141\141\141"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
argument_list|,
name|col
operator|*
literal|3
operator|+
name|COL_OFFSET
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   "
argument_list|)
expr_stmt|;
comment|/* erase splat	*/
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
operator|+
literal|1
argument_list|,
name|col
operator|*
literal|3
operator|+
name|COL_OFFSET
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   "
argument_list|)
expr_stmt|;
comment|/* erase splat	*/
block|}
block|}
name|pad
argument_list|()
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\017"
argument_list|)
expr_stmt|;
comment|/* Lock in G0 (SI)	*/
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * highlight  *	Draw the cursor in the main display area.  */
end_comment

begin_function
name|void
name|highlight
parameter_list|(
name|row
parameter_list|,
name|col
parameter_list|,
name|on
parameter_list|)
name|unsigned
name|int
name|row
decl_stmt|,
name|col
decl_stmt|;
name|bool
name|on
decl_stmt|;
block|{
name|printf
argument_list|(
literal|"\033)0"
argument_list|)
expr_stmt|;
comment|/* Special graphics in G1	*/
name|printf
argument_list|(
literal|"\016"
argument_list|)
expr_stmt|;
comment|/* Lock in G1 (SO)		*/
if|if
condition|(
name|on
condition|)
block|{
name|printf
argument_list|(
literal|"\033[7m"
argument_list|)
expr_stmt|;
comment|/* Reverse video cursor		*/
block|}
if|if
condition|(
name|display_table
index|[
name|row
index|]
index|[
name|col
index|]
condition|)
block|{
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
argument_list|,
name|col
operator|*
literal|3
operator|+
name|COL_OFFSET
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\141\141\141"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
operator|+
literal|1
argument_list|,
name|col
operator|*
literal|3
operator|+
name|COL_OFFSET
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\141\141\141"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
argument_list|,
name|col
operator|*
literal|3
operator|+
name|COL_OFFSET
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   "
argument_list|)
expr_stmt|;
comment|/* erase splat	*/
name|move
argument_list|(
name|row
operator|*
literal|2
operator|+
name|ROW_OFFSET
operator|+
literal|1
argument_list|,
name|col
operator|*
literal|3
operator|+
name|COL_OFFSET
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   "
argument_list|)
expr_stmt|;
comment|/* erase splat	*/
block|}
name|pad
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"\017"
argument_list|)
expr_stmt|;
comment|/* Lock in G0 (SI)	*/
name|printf
argument_list|(
literal|"\033[0m"
argument_list|)
expr_stmt|;
comment|/* normal video		*/
name|printf
argument_list|(
literal|"\b"
argument_list|)
expr_stmt|;
comment|/* Back up one spot	*/
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Clear_screen  */
end_comment

begin_function
name|void
name|clear_screen
parameter_list|()
block|{
name|printf
argument_list|(
literal|"\033[H\033[J"
argument_list|)
expr_stmt|;
comment|/* Clear screen.	*/
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * move  */
end_comment

begin_macro
name|move
argument_list|(
argument|y
argument_list|,
argument|x
argument_list|)
end_macro

begin_decl_stmt
name|int
name|y
decl_stmt|,
name|x
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"\033[%d;%df"
argument_list|,
name|y
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Build_entry  *	Convert the bit pattern used in the main display area into something  *	that the vt220 can digest - namely sixels...  */
end_comment

begin_function
name|void
name|build_entry
parameter_list|(
name|entry_no
parameter_list|)
name|unsigned
name|int
name|entry_no
decl_stmt|;
block|{
specifier|register
name|int
name|row
decl_stmt|,
name|col
decl_stmt|;
specifier|register
name|unsigned
name|int
name|mask
decl_stmt|;
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
literal|8
condition|;
operator|++
name|col
control|)
block|{
comment|/* Top set of sixels	*/
name|mask
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|row
operator|=
literal|5
init|;
name|row
operator|>=
literal|0
condition|;
operator|--
name|row
control|)
block|{
name|mask
operator|=
name|mask
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|display_table
index|[
name|row
index|]
index|[
name|col
index|]
condition|)
name|mask
operator||=
literal|1
expr_stmt|;
block|}
name|font_table
index|[
name|entry_no
index|]
index|[
name|col
index|]
operator|=
name|mask
operator|+
literal|077
expr_stmt|;
comment|/*  Bottom set of sixels	*/
name|mask
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|row
operator|=
literal|9
init|;
name|row
operator|>=
literal|6
condition|;
operator|--
name|row
control|)
block|{
name|mask
operator|=
name|mask
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|display_table
index|[
name|row
index|]
index|[
name|col
index|]
condition|)
name|mask
operator||=
literal|1
expr_stmt|;
block|}
name|font_table
index|[
name|entry_no
index|]
index|[
name|col
operator|+
literal|8
index|]
operator|=
name|mask
operator|+
literal|077
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Extract_engry  *	convert sixel representation into an array of bits.  */
end_comment

begin_function
name|void
name|extract_entry
parameter_list|(
name|entry_no
parameter_list|)
name|unsigned
name|int
name|entry_no
decl_stmt|;
block|{
specifier|register
name|int
name|row
decl_stmt|,
name|col
decl_stmt|;
specifier|register
name|unsigned
name|int
name|mask
decl_stmt|;
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
literal|8
condition|;
operator|++
name|col
control|)
block|{
comment|/* Top set of sixels	*/
name|mask
operator|=
name|font_table
index|[
name|entry_no
index|]
index|[
name|col
index|]
expr_stmt|;
if|if
condition|(
name|mask
operator|>=
literal|077
condition|)
name|mask
operator|-=
literal|077
expr_stmt|;
else|else
name|mask
operator|=
literal|0
expr_stmt|;
comment|/* Bogus entry	*/
for|for
control|(
name|row
operator|=
literal|0
init|;
name|row
operator|<=
literal|5
condition|;
operator|++
name|row
control|)
block|{
name|display_table
index|[
name|row
index|]
index|[
name|col
index|]
operator|=
call|(
name|bool
call|)
argument_list|(
name|mask
operator|&
literal|0x0001
argument_list|)
expr_stmt|;
name|mask
operator|=
name|mask
operator|>>
literal|1
expr_stmt|;
block|}
comment|/*  Bottom set of sixels	*/
name|mask
operator|=
name|font_table
index|[
name|entry_no
index|]
index|[
name|col
operator|+
literal|8
index|]
expr_stmt|;
if|if
condition|(
name|mask
operator|>=
literal|077
condition|)
name|mask
operator|-=
literal|077
expr_stmt|;
else|else
name|mask
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|row
operator|=
literal|6
init|;
name|row
operator|<=
literal|9
condition|;
operator|++
name|row
control|)
block|{
name|display_table
index|[
name|row
index|]
index|[
name|col
index|]
operator|=
call|(
name|bool
call|)
argument_list|(
name|mask
operator|&
literal|0x0001
argument_list|)
expr_stmt|;
name|mask
operator|=
name|mask
operator|>>
literal|1
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Send_entry  *	Emit the stuff used by the VT220 to load a character into the  *	DRCS.  We could, of course, send more than one entry at a time...  */
end_comment

begin_function
name|void
name|send_entry
parameter_list|(
name|entry_no
parameter_list|)
name|int
name|entry_no
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|fp
init|=
name|font_table
index|[
name|entry_no
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"\033P1;%d;1;0;0;0{ @%c%c%c%c%c%c%c%c/%c%c%c%c%c%c%c%c\033\\"
argument_list|,
name|entry_no
argument_list|,
name|fp
index|[
literal|0
index|]
argument_list|,
name|fp
index|[
literal|1
index|]
argument_list|,
name|fp
index|[
literal|2
index|]
argument_list|,
name|fp
index|[
literal|3
index|]
argument_list|,
name|fp
index|[
literal|4
index|]
argument_list|,
name|fp
index|[
literal|5
index|]
argument_list|,
name|fp
index|[
literal|6
index|]
argument_list|,
name|fp
index|[
literal|7
index|]
argument_list|,
name|fp
index|[
literal|8
index|]
argument_list|,
name|fp
index|[
literal|9
index|]
argument_list|,
name|fp
index|[
literal|10
index|]
argument_list|,
name|fp
index|[
literal|11
index|]
argument_list|,
name|fp
index|[
literal|12
index|]
argument_list|,
name|fp
index|[
literal|13
index|]
argument_list|,
name|fp
index|[
literal|14
index|]
argument_list|,
name|fp
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print_entry  *	The terminal normally has G0 in GL.  We don't want to change  *	this, nor do we want to use GR.  Sooooo send out the necessary  *	magic for shifting in G2 temporarily for the character that we  *	want to display.  */
end_comment

begin_function
name|void
name|print_entry
parameter_list|(
name|entry_no
parameter_list|,
name|highlight
parameter_list|)
specifier|register
name|unsigned
name|int
name|entry_no
decl_stmt|;
name|bool
name|highlight
decl_stmt|;
block|{
specifier|register
name|int
name|y
decl_stmt|,
name|x
decl_stmt|;
name|y
operator|=
name|entry_no
operator|&
literal|0x07
expr_stmt|;
name|x
operator|=
name|entry_no
operator|>>
literal|3
operator|&
literal|0x1f
expr_stmt|;
name|entry_no
operator|+=
literal|32
expr_stmt|;
comment|/* Map up to G set	*/
name|move
argument_list|(
name|y
operator|*
literal|2
operator|+
name|TABLE_ROW
argument_list|,
name|x
operator|*
literal|2
operator|+
name|TABLE_COL
argument_list|)
expr_stmt|;
if|if
condition|(
name|highlight
condition|)
name|printf
argument_list|(
literal|"\033[7m"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\033* @"
argument_list|)
expr_stmt|;
comment|/* select DRCS into G2	*/
name|printf
argument_list|(
literal|"\033N"
argument_list|)
expr_stmt|;
comment|/* select single shift	*/
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|entry_no
argument_list|)
expr_stmt|;
comment|/* Draw the character	*/
if|if
condition|(
name|highlight
condition|)
name|printf
argument_list|(
literal|"\033[0m"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Save_table  *	Save a font table  */
end_comment

begin_function
name|void
name|save_table
parameter_list|(
name|font_file
parameter_list|)
name|FILE
modifier|*
name|font_file
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|fp
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TOTAL_ENTRIES
condition|;
operator|++
name|i
control|)
block|{
name|fp
operator|=
name|font_table
index|[
name|i
index|]
expr_stmt|;
name|fprintf
argument_list|(
name|font_file
argument_list|,
literal|"\033P1;%d;1;0;0;0{ @%c%c%c%c%c%c%c%c/%c%c%c%c%c%c%c%c\033\\\n"
argument_list|,
name|i
argument_list|,
name|fp
index|[
literal|0
index|]
argument_list|,
name|fp
index|[
literal|1
index|]
argument_list|,
name|fp
index|[
literal|2
index|]
argument_list|,
name|fp
index|[
literal|3
index|]
argument_list|,
name|fp
index|[
literal|4
index|]
argument_list|,
name|fp
index|[
literal|5
index|]
argument_list|,
name|fp
index|[
literal|6
index|]
argument_list|,
name|fp
index|[
literal|7
index|]
argument_list|,
name|fp
index|[
literal|8
index|]
argument_list|,
name|fp
index|[
literal|9
index|]
argument_list|,
name|fp
index|[
literal|10
index|]
argument_list|,
name|fp
index|[
literal|11
index|]
argument_list|,
name|fp
index|[
literal|12
index|]
argument_list|,
name|fp
index|[
literal|13
index|]
argument_list|,
name|fp
index|[
literal|14
index|]
argument_list|,
name|fp
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Get_table  *	Extract font table entries from a file  */
end_comment

begin_function
name|void
name|get_table
parameter_list|(
name|font_file
parameter_list|)
name|FILE
modifier|*
name|font_file
decl_stmt|;
block|{
name|char
name|s
index|[
literal|256
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|char
modifier|*
name|fp
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|j
decl_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|s
argument_list|,
literal|255
argument_list|,
name|font_file
argument_list|)
condition|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|s
argument_list|,
literal|"\033P1;"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
comment|/* Bogus line	*/
name|p
operator|=
operator|&
name|s
index|[
literal|4
index|]
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|p
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|i
argument_list|)
operator|!=
literal|1
condition|)
continue|continue;
comment|/* Illegal entry number	*/
if|if
condition|(
name|i
operator|<=
literal|0
operator|||
name|TOTAL_ENTRIES
operator|<=
name|i
condition|)
continue|continue;
comment|/* Bogues entry	*/
name|fp
operator|=
name|font_table
index|[
name|i
index|]
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
literal|'@'
condition|)
operator|++
name|p
expr_stmt|;
comment|/* Skip to font definition */
if|if
condition|(
operator|!
operator|*
name|p
operator|++
condition|)
continue|continue;
comment|/* Skip @	*/
for|for
control|(
name|j
operator|=
literal|0
init|;
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
literal|'\033'
operator|&&
name|j
operator|<
literal|16
condition|;
operator|++
name|j
operator|,
operator|++
name|p
control|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|'/'
condition|)
block|{
name|j
operator|=
literal|8
expr_stmt|;
operator|++
name|p
expr_stmt|;
block|}
name|fp
index|[
name|j
index|]
operator|=
operator|*
name|p
expr_stmt|;
block|}
name|send_entry
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Help  *	Print out help information.  */
end_comment

begin_function
name|void
name|help
parameter_list|()
block|{
name|printf
argument_list|(
literal|"Font editor\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"F6     - Pixel on\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"F7     - Pixel off\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"F13    - Clear display area\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"HELP   - This screen\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"FIND   - Update font table\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"INSERT - Insert a blank row\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"REMOVE - Remove a row\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"SELECT - Select current font table entry\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"PREV   - Move to previous font table entry\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"NEXT   - Move to next font table entry\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"^D     - Exit\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\n\n\nPress any key to continue\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Warning  *	Issue a warning to the regarding the current status.  */
end_comment

begin_function
name|void
name|warning
parameter_list|(
name|s
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
block|{
name|move
argument_list|(
name|ERROR_ROW
argument_list|,
name|ERROR_COL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Warning: %s!\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|ERROR_ROW
operator|+
literal|1
argument_list|,
name|ERROR_COL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         Reissue command to override\n"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


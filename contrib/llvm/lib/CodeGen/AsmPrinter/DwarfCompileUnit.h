begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|//===-- llvm/CodeGen/DwarfCompileUnit.h - Dwarf Compile Unit ---*- C++ -*--===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//                     The LLVM Compiler Infrastructure
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file is distributed under the University of Illinois Open Source
end_comment

begin_comment
comment|// License. See LICENSE.TXT for details.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file contains support for writing dwarf compile unit.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|LLVM_LIB_CODEGEN_ASMPRINTER_DWARFCOMPILEUNIT_H
end_ifndef

begin_define
define|#
directive|define
name|LLVM_LIB_CODEGEN_ASMPRINTER_DWARFCOMPILEUNIT_H
end_define

begin_include
include|#
directive|include
file|"DwarfUnit.h"
end_include

begin_include
include|#
directive|include
file|"llvm/IR/DebugInfo.h"
end_include

begin_include
include|#
directive|include
file|"llvm/Support/Dwarf.h"
end_include

begin_decl_stmt
name|namespace
name|llvm
block|{
name|class
name|StringRef
decl_stmt|;
name|class
name|AsmPrinter
decl_stmt|;
name|class
name|DIE
decl_stmt|;
name|class
name|DwarfDebug
decl_stmt|;
name|class
name|DwarfFile
decl_stmt|;
name|class
name|MCSymbol
decl_stmt|;
name|class
name|LexicalScope
decl_stmt|;
name|class
name|DwarfCompileUnit
name|final
range|:
name|public
name|DwarfUnit
block|{
comment|/// A numeric ID unique among all CUs in the module
name|unsigned
name|UniqueID
block|;
comment|/// The attribute index of DW_AT_stmt_list in the compile unit DIE, avoiding
comment|/// the need to search for it in applyStmtList.
name|DIE
operator|::
name|value_iterator
name|StmtListValue
block|;
comment|/// Skeleton unit associated with this unit.
name|DwarfCompileUnit
operator|*
name|Skeleton
block|;
comment|/// The start of the unit within its section.
name|MCSymbol
operator|*
name|LabelBegin
block|;
comment|/// The start of the unit macro info within macro section.
name|MCSymbol
operator|*
name|MacroLabelBegin
block|;
typedef|typedef
name|llvm
operator|::
name|SmallVector
operator|<
specifier|const
name|MDNode
operator|*
operator|,
literal|8
operator|>
name|ImportedEntityList
expr_stmt|;
typedef|typedef
name|llvm
operator|::
name|DenseMap
operator|<
specifier|const
name|MDNode
operator|*
operator|,
name|ImportedEntityList
operator|>
name|ImportedEntityMap
expr_stmt|;
name|ImportedEntityMap
name|ImportedEntities
decl_stmt|;
comment|/// GlobalNames - A map of globally visible named entities for this unit.
name|StringMap
operator|<
specifier|const
name|DIE
operator|*
operator|>
name|GlobalNames
expr_stmt|;
comment|/// GlobalTypes - A map of globally visible types for this unit.
name|StringMap
operator|<
specifier|const
name|DIE
operator|*
operator|>
name|GlobalTypes
expr_stmt|;
comment|// List of range lists for a given compile unit, separate from the ranges for
comment|// the CU itself.
name|SmallVector
operator|<
name|RangeSpanList
operator|,
literal|1
operator|>
name|CURangeLists
expr_stmt|;
comment|// List of ranges for a given compile unit.
name|SmallVector
operator|<
name|RangeSpan
operator|,
literal|2
operator|>
name|CURanges
expr_stmt|;
comment|// The base address of this unit, if any. Used for relative references in
comment|// ranges/locs.
specifier|const
name|MCSymbol
modifier|*
name|BaseAddress
decl_stmt|;
comment|/// \brief Construct a DIE for the given DbgVariable without initializing the
comment|/// DbgVariable's DIE reference.
name|DIE
modifier|*
name|constructVariableDIEImpl
parameter_list|(
specifier|const
name|DbgVariable
modifier|&
name|DV
parameter_list|,
name|bool
name|Abstract
parameter_list|)
function_decl|;
name|bool
name|isDwoUnit
argument_list|()
specifier|const
name|override
expr_stmt|;
name|bool
name|includeMinimalInlineScopes
argument_list|()
specifier|const
expr_stmt|;
name|public
label|:
name|DwarfCompileUnit
argument_list|(
argument|unsigned UID
argument_list|,
argument|const DICompileUnit *Node
argument_list|,
argument|AsmPrinter *A
argument_list|,
argument|DwarfDebug *DW
argument_list|,
argument|DwarfFile *DWU
argument_list|)
empty_stmt|;
name|unsigned
name|getUniqueID
argument_list|()
specifier|const
block|{
return|return
name|UniqueID
return|;
block|}
name|DwarfCompileUnit
operator|*
name|getSkeleton
argument_list|()
specifier|const
block|{
return|return
name|Skeleton
return|;
block|}
name|void
name|initStmtList
parameter_list|()
function_decl|;
comment|/// Apply the DW_AT_stmt_list from this compile unit to the specified DIE.
name|void
name|applyStmtList
parameter_list|(
name|DIE
modifier|&
name|D
parameter_list|)
function_decl|;
comment|/// A pair of GlobalVariable and DIExpression.
struct|struct
name|GlobalExpr
block|{
specifier|const
name|GlobalVariable
modifier|*
name|Var
decl_stmt|;
specifier|const
name|DIExpression
modifier|*
name|Expr
decl_stmt|;
block|}
struct|;
comment|/// Get or create global variable DIE.
name|DIE
modifier|*
name|getOrCreateGlobalVariableDIE
argument_list|(
specifier|const
name|DIGlobalVariable
operator|*
name|GV
argument_list|,
name|ArrayRef
operator|<
name|GlobalExpr
operator|>
name|GlobalExprs
argument_list|)
decl_stmt|;
comment|/// addLabelAddress - Add a dwarf label attribute data and value using
comment|/// either DW_FORM_addr or DW_FORM_GNU_addr_index.
name|void
name|addLabelAddress
argument_list|(
name|DIE
operator|&
name|Die
argument_list|,
name|dwarf
operator|::
name|Attribute
name|Attribute
argument_list|,
specifier|const
name|MCSymbol
operator|*
name|Label
argument_list|)
decl_stmt|;
comment|/// addLocalLabelAddress - Add a dwarf label attribute data and value using
comment|/// DW_FORM_addr only.
name|void
name|addLocalLabelAddress
argument_list|(
name|DIE
operator|&
name|Die
argument_list|,
name|dwarf
operator|::
name|Attribute
name|Attribute
argument_list|,
specifier|const
name|MCSymbol
operator|*
name|Label
argument_list|)
decl_stmt|;
comment|/// addSectionDelta - Add a label delta attribute data and value.
name|DIE
operator|::
name|value_iterator
name|addSectionDelta
argument_list|(
argument|DIE&Die
argument_list|,
argument|dwarf::Attribute Attribute
argument_list|,
argument|const MCSymbol *Hi
argument_list|,
argument|const MCSymbol *Lo
argument_list|)
expr_stmt|;
name|DwarfCompileUnit
modifier|&
name|getCU
parameter_list|()
function|override
block|{
return|return
operator|*
name|this
return|;
block|}
name|unsigned
name|getOrCreateSourceID
argument_list|(
name|StringRef
name|FileName
argument_list|,
name|StringRef
name|DirName
argument_list|)
name|override
decl_stmt|;
name|void
name|addImportedEntity
parameter_list|(
specifier|const
name|DIImportedEntity
modifier|*
name|IE
parameter_list|)
block|{
name|DIScope
modifier|*
name|Scope
init|=
name|IE
operator|->
name|getScope
argument_list|()
decl_stmt|;
name|assert
argument_list|(
name|Scope
operator|&&
literal|"Invalid Scope encoding!"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isa
operator|<
name|DILocalScope
operator|>
operator|(
name|Scope
operator|)
condition|)
comment|// No need to add imported enities that are not local declaration.
return|return;
name|auto
operator|*
name|LocalScope
operator|=
name|cast
operator|<
name|DILocalScope
operator|>
operator|(
name|Scope
operator|)
operator|->
name|getNonLexicalBlockFileScope
argument_list|()
expr_stmt|;
name|ImportedEntities
index|[
name|LocalScope
index|]
operator|.
name|push_back
argument_list|(
name|IE
argument_list|)
expr_stmt|;
block|}
comment|/// addRange - Add an address range to the list of ranges for this unit.
name|void
name|addRange
parameter_list|(
name|RangeSpan
name|Range
parameter_list|)
function_decl|;
name|void
name|attachLowHighPC
parameter_list|(
name|DIE
modifier|&
name|D
parameter_list|,
specifier|const
name|MCSymbol
modifier|*
name|Begin
parameter_list|,
specifier|const
name|MCSymbol
modifier|*
name|End
parameter_list|)
function_decl|;
comment|/// addSectionLabel - Add a Dwarf section label attribute data and value.
comment|///
name|DIE
operator|::
name|value_iterator
name|addSectionLabel
argument_list|(
argument|DIE&Die
argument_list|,
argument|dwarf::Attribute Attribute
argument_list|,
argument|const MCSymbol *Label
argument_list|,
argument|const MCSymbol *Sec
argument_list|)
expr_stmt|;
comment|/// \brief Find DIE for the given subprogram and attach appropriate
comment|/// DW_AT_low_pc and DW_AT_high_pc attributes. If there are global
comment|/// variables in this scope then create and insert DIEs for these
comment|/// variables.
name|DIE
modifier|&
name|updateSubprogramScopeDIE
parameter_list|(
specifier|const
name|DISubprogram
modifier|*
name|SP
parameter_list|)
function_decl|;
name|void
name|constructScopeDIE
argument_list|(
name|LexicalScope
operator|*
name|Scope
argument_list|,
name|SmallVectorImpl
operator|<
name|DIE
operator|*
operator|>
operator|&
name|FinalChildren
argument_list|)
decl_stmt|;
comment|/// \brief A helper function to construct a RangeSpanList for a given
comment|/// lexical scope.
name|void
name|addScopeRangeList
argument_list|(
name|DIE
operator|&
name|ScopeDIE
argument_list|,
name|SmallVector
operator|<
name|RangeSpan
argument_list|,
literal|2
operator|>
name|Range
argument_list|)
decl_stmt|;
name|void
name|attachRangesOrLowHighPC
argument_list|(
name|DIE
operator|&
name|D
argument_list|,
name|SmallVector
operator|<
name|RangeSpan
argument_list|,
literal|2
operator|>
name|Ranges
argument_list|)
decl_stmt|;
name|void
name|attachRangesOrLowHighPC
argument_list|(
name|DIE
operator|&
name|D
argument_list|,
specifier|const
name|SmallVectorImpl
operator|<
name|InsnRange
operator|>
operator|&
name|Ranges
argument_list|)
decl_stmt|;
comment|/// \brief This scope represents inlined body of a function. Construct
comment|/// DIE to represent this concrete inlined copy of the function.
name|DIE
modifier|*
name|constructInlinedScopeDIE
parameter_list|(
name|LexicalScope
modifier|*
name|Scope
parameter_list|)
function_decl|;
comment|/// \brief Construct new DW_TAG_lexical_block for this scope and
comment|/// attach DW_AT_low_pc/DW_AT_high_pc labels.
name|DIE
modifier|*
name|constructLexicalScopeDIE
parameter_list|(
name|LexicalScope
modifier|*
name|Scope
parameter_list|)
function_decl|;
comment|/// constructVariableDIE - Construct a DIE for the given DbgVariable.
name|DIE
modifier|*
name|constructVariableDIE
parameter_list|(
name|DbgVariable
modifier|&
name|DV
parameter_list|,
name|bool
name|Abstract
init|=
name|false
parameter_list|)
function_decl|;
name|DIE
modifier|*
name|constructVariableDIE
parameter_list|(
name|DbgVariable
modifier|&
name|DV
parameter_list|,
specifier|const
name|LexicalScope
modifier|&
name|Scope
parameter_list|,
name|DIE
modifier|*
modifier|&
name|ObjectPointer
parameter_list|)
function_decl|;
comment|/// A helper function to create children of a Scope DIE.
name|DIE
modifier|*
name|createScopeChildrenDIE
argument_list|(
name|LexicalScope
operator|*
name|Scope
argument_list|,
name|SmallVectorImpl
operator|<
name|DIE
operator|*
operator|>
operator|&
name|Children
argument_list|,
name|unsigned
operator|*
name|ChildScopeCount
operator|=
name|nullptr
argument_list|)
decl_stmt|;
comment|/// \brief Construct a DIE for this subprogram scope.
name|void
name|constructSubprogramScopeDIE
parameter_list|(
specifier|const
name|DISubprogram
modifier|*
name|Sub
parameter_list|,
name|LexicalScope
modifier|*
name|Scope
parameter_list|)
function_decl|;
name|DIE
modifier|*
name|createAndAddScopeChildren
parameter_list|(
name|LexicalScope
modifier|*
name|Scope
parameter_list|,
name|DIE
modifier|&
name|ScopeDIE
parameter_list|)
function_decl|;
name|void
name|constructAbstractSubprogramScopeDIE
parameter_list|(
name|LexicalScope
modifier|*
name|Scope
parameter_list|)
function_decl|;
comment|/// \brief Construct import_module DIE.
name|DIE
modifier|*
name|constructImportedEntityDIE
parameter_list|(
specifier|const
name|DIImportedEntity
modifier|*
name|Module
parameter_list|)
function_decl|;
name|void
name|finishSubprogramDefinition
parameter_list|(
specifier|const
name|DISubprogram
modifier|*
name|SP
parameter_list|)
function_decl|;
comment|/// Set the skeleton unit associated with this unit.
name|void
name|setSkeleton
parameter_list|(
name|DwarfCompileUnit
modifier|&
name|Skel
parameter_list|)
block|{
name|Skeleton
operator|=
operator|&
name|Skel
expr_stmt|;
block|}
name|unsigned
name|getLength
parameter_list|()
block|{
return|return
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
comment|// Length field
name|getHeaderSize
argument_list|()
operator|+
name|getUnitDie
argument_list|()
operator|.
name|getSize
argument_list|()
return|;
block|}
name|void
name|emitHeader
argument_list|(
name|bool
name|UseOffsets
argument_list|)
name|override
decl_stmt|;
name|MCSymbol
operator|*
name|getLabelBegin
argument_list|()
specifier|const
block|{
name|assert
argument_list|(
name|getSection
argument_list|()
argument_list|)
block|;
return|return
name|LabelBegin
return|;
block|}
name|MCSymbol
operator|*
name|getMacroLabelBegin
argument_list|()
specifier|const
block|{
return|return
name|MacroLabelBegin
return|;
block|}
comment|/// Add a new global name to the compile unit.
name|void
name|addGlobalName
argument_list|(
name|StringRef
name|Name
argument_list|,
specifier|const
name|DIE
operator|&
name|Die
argument_list|,
specifier|const
name|DIScope
operator|*
name|Context
argument_list|)
name|override
decl_stmt|;
comment|/// Add a new global name present in a type unit to this compile unit.
name|void
name|addGlobalNameForTypeUnit
parameter_list|(
name|StringRef
name|Name
parameter_list|,
specifier|const
name|DIScope
modifier|*
name|Context
parameter_list|)
function_decl|;
comment|/// Add a new global type to the compile unit.
name|void
name|addGlobalType
argument_list|(
specifier|const
name|DIType
operator|*
name|Ty
argument_list|,
specifier|const
name|DIE
operator|&
name|Die
argument_list|,
specifier|const
name|DIScope
operator|*
name|Context
argument_list|)
name|override
decl_stmt|;
comment|/// Add a new global type present in a type unit to this compile unit.
name|void
name|addGlobalTypeUnitType
parameter_list|(
specifier|const
name|DIType
modifier|*
name|Ty
parameter_list|,
specifier|const
name|DIScope
modifier|*
name|Context
parameter_list|)
function_decl|;
specifier|const
name|StringMap
operator|<
specifier|const
name|DIE
operator|*
operator|>
operator|&
name|getGlobalNames
argument_list|()
specifier|const
block|{
return|return
name|GlobalNames
return|;
block|}
specifier|const
name|StringMap
operator|<
specifier|const
name|DIE
operator|*
operator|>
operator|&
name|getGlobalTypes
argument_list|()
specifier|const
block|{
return|return
name|GlobalTypes
return|;
block|}
comment|/// Add DW_AT_location attribute for a DbgVariable based on provided
comment|/// MachineLocation.
name|void
name|addVariableAddress
parameter_list|(
specifier|const
name|DbgVariable
modifier|&
name|DV
parameter_list|,
name|DIE
modifier|&
name|Die
parameter_list|,
name|MachineLocation
name|Location
parameter_list|)
function_decl|;
comment|/// Add an address attribute to a die based on the location provided.
name|void
name|addAddress
argument_list|(
name|DIE
operator|&
name|Die
argument_list|,
name|dwarf
operator|::
name|Attribute
name|Attribute
argument_list|,
specifier|const
name|MachineLocation
operator|&
name|Location
argument_list|)
decl_stmt|;
comment|/// Start with the address based on the location provided, and generate the
comment|/// DWARF information necessary to find the actual variable (navigating the
comment|/// extra location information encoded in the type) based on the starting
comment|/// location.  Add the DWARF information to the die.
name|void
name|addComplexAddress
argument_list|(
specifier|const
name|DbgVariable
operator|&
name|DV
argument_list|,
name|DIE
operator|&
name|Die
argument_list|,
name|dwarf
operator|::
name|Attribute
name|Attribute
argument_list|,
specifier|const
name|MachineLocation
operator|&
name|Location
argument_list|)
decl_stmt|;
comment|/// Add a Dwarf loclistptr attribute data and value.
name|void
name|addLocationList
argument_list|(
name|DIE
operator|&
name|Die
argument_list|,
name|dwarf
operator|::
name|Attribute
name|Attribute
argument_list|,
name|unsigned
name|Index
argument_list|)
decl_stmt|;
name|void
name|applyVariableAttributes
parameter_list|(
specifier|const
name|DbgVariable
modifier|&
name|Var
parameter_list|,
name|DIE
modifier|&
name|VariableDie
parameter_list|)
function_decl|;
comment|/// Add a Dwarf expression attribute data and value.
name|void
name|addExpr
argument_list|(
name|DIELoc
operator|&
name|Die
argument_list|,
name|dwarf
operator|::
name|Form
name|Form
argument_list|,
specifier|const
name|MCExpr
operator|*
name|Expr
argument_list|)
decl_stmt|;
name|void
name|applySubprogramAttributesToDefinition
parameter_list|(
specifier|const
name|DISubprogram
modifier|*
name|SP
parameter_list|,
name|DIE
modifier|&
name|SPDie
parameter_list|)
function_decl|;
comment|/// getRangeLists - Get the vector of range lists.
specifier|const
name|SmallVectorImpl
operator|<
name|RangeSpanList
operator|>
operator|&
name|getRangeLists
argument_list|()
specifier|const
block|{
return|return
operator|(
name|Skeleton
operator|?
name|Skeleton
operator|:
name|this
operator|)
operator|->
name|CURangeLists
return|;
block|}
comment|/// getRanges - Get the list of ranges for this unit.
specifier|const
name|SmallVectorImpl
operator|<
name|RangeSpan
operator|>
operator|&
name|getRanges
argument_list|()
specifier|const
block|{
return|return
name|CURanges
return|;
block|}
name|SmallVector
operator|<
name|RangeSpan
operator|,
literal|2
operator|>
name|takeRanges
argument_list|()
block|{
return|return
name|std
operator|::
name|move
argument_list|(
name|CURanges
argument_list|)
return|;
block|}
name|void
name|setBaseAddress
parameter_list|(
specifier|const
name|MCSymbol
modifier|*
name|Base
parameter_list|)
block|{
name|BaseAddress
operator|=
name|Base
expr_stmt|;
block|}
specifier|const
name|MCSymbol
operator|*
name|getBaseAddress
argument_list|()
specifier|const
block|{
return|return
name|BaseAddress
return|;
block|}
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
unit|}
comment|// end llvm namespace
end_comment

begin_endif
endif|#
directive|endif
end_endif

end_unit


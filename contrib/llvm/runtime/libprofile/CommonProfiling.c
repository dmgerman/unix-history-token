begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*===-- CommonProfiling.c - Profiling support library support -------------===*\ |* |*                     The LLVM Compiler Infrastructure |* |* This file is distributed under the University of Illinois Open Source       |* License. See LICENSE.TXT for details.                                       |*  |*===----------------------------------------------------------------------===*| |*  |* This file implements functions used by the various different types of |* profiling implementations. |* \*===----------------------------------------------------------------------===*/
end_comment

begin_include
include|#
directive|include
file|"Profiling.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_decl_stmt
specifier|static
name|char
modifier|*
name|SavedArgs
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|SavedArgsLength
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|OutputFilename
init|=
literal|"llvmprof.out"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* save_arguments - Save argc and argv as passed into the program for the file  * we output.  */
end_comment

begin_function
name|int
name|save_arguments
parameter_list|(
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|unsigned
name|Length
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|SavedArgs
operator|||
operator|!
name|argv
condition|)
return|return
name|argc
return|;
comment|/* This can be called multiple times */
comment|/* Check to see if there are any arguments passed into the program for the    * profiler.  If there are, strip them off and remember their settings.    */
while|while
condition|(
name|argc
operator|>
literal|1
operator|&&
operator|!
name|strncmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-llvmprof-"
argument_list|,
literal|10
argument_list|)
condition|)
block|{
comment|/* Ok, we have an llvmprof argument.  Remove it from the arg list and decide      * what to do with it.      */
specifier|const
name|char
modifier|*
name|Arg
init|=
name|argv
index|[
literal|1
index|]
decl_stmt|;
name|memmove
argument_list|(
operator|&
name|argv
index|[
literal|1
index|]
argument_list|,
operator|&
name|argv
index|[
literal|2
index|]
argument_list|,
operator|(
name|argc
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
operator|--
name|argc
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|Arg
argument_list|,
literal|"-llvmprof-output"
argument_list|)
condition|)
block|{
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
name|puts
argument_list|(
literal|"-llvmprof-output requires a filename argument!"
argument_list|)
expr_stmt|;
else|else
block|{
name|OutputFilename
operator|=
name|strdup
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
operator|&
name|argv
index|[
literal|1
index|]
argument_list|,
operator|&
name|argv
index|[
literal|2
index|]
argument_list|,
operator|(
name|argc
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
operator|--
name|argc
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown option to the profiler runtime: '%s' - ignored.\n"
argument_list|,
name|Arg
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|Length
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|!=
operator|(
name|unsigned
operator|)
name|argc
condition|;
operator|++
name|i
control|)
name|Length
operator|+=
name|strlen
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
name|SavedArgs
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|Length
argument_list|)
expr_stmt|;
for|for
control|(
name|Length
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|!=
operator|(
name|unsigned
operator|)
name|argc
condition|;
operator|++
name|i
control|)
block|{
name|unsigned
name|Len
init|=
name|strlen
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
decl_stmt|;
name|memcpy
argument_list|(
name|SavedArgs
operator|+
name|Length
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
name|Len
argument_list|)
expr_stmt|;
name|Length
operator|+=
name|Len
expr_stmt|;
name|SavedArgs
index|[
name|Length
operator|++
index|]
operator|=
literal|' '
expr_stmt|;
block|}
name|SavedArgsLength
operator|=
name|Length
expr_stmt|;
return|return
name|argc
return|;
block|}
end_function

begin_comment
comment|/* write_profiling_data - Write a raw block of profiling counters out to the  * llvmprof.out file.  Note that we allow programs to be instrumented with  * multiple different kinds of instrumentation.  For this reason, this function  * may be called more than once.  */
end_comment

begin_function
name|void
name|write_profiling_data
parameter_list|(
name|enum
name|ProfilingType
name|PT
parameter_list|,
name|unsigned
modifier|*
name|Start
parameter_list|,
name|unsigned
name|NumElements
parameter_list|)
block|{
specifier|static
name|int
name|OutFile
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|PTy
decl_stmt|;
comment|/* If this is the first time this function is called, open the output file for    * appending, creating it if it does not already exist.    */
if|if
condition|(
name|OutFile
operator|==
operator|-
literal|1
condition|)
block|{
name|OutFile
operator|=
name|open
argument_list|(
name|OutputFilename
argument_list|,
name|O_CREAT
operator||
name|O_WRONLY
operator||
name|O_APPEND
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
if|if
condition|(
name|OutFile
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"LLVM profiling runtime: while opening '%s': "
argument_list|,
name|OutputFilename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|""
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Output the command line arguments to the file. */
block|{
name|int
name|PTy
init|=
name|ArgumentInfo
decl_stmt|;
name|int
name|Zeros
init|=
literal|0
decl_stmt|;
name|write
argument_list|(
name|OutFile
argument_list|,
operator|&
name|PTy
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|OutFile
argument_list|,
operator|&
name|SavedArgsLength
argument_list|,
sizeof|sizeof
argument_list|(
name|unsigned
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|OutFile
argument_list|,
name|SavedArgs
argument_list|,
name|SavedArgsLength
argument_list|)
expr_stmt|;
comment|/* Pad out to a multiple of four bytes */
if|if
condition|(
name|SavedArgsLength
operator|&
literal|3
condition|)
name|write
argument_list|(
name|OutFile
argument_list|,
operator|&
name|Zeros
argument_list|,
literal|4
operator|-
operator|(
name|SavedArgsLength
operator|&
literal|3
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Write out this record! */
name|PTy
operator|=
name|PT
expr_stmt|;
name|write
argument_list|(
name|OutFile
argument_list|,
operator|&
name|PTy
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|OutFile
argument_list|,
operator|&
name|NumElements
argument_list|,
sizeof|sizeof
argument_list|(
name|unsigned
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|OutFile
argument_list|,
name|Start
argument_list|,
name|NumElements
operator|*
sizeof|sizeof
argument_list|(
name|unsigned
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|//===- RecordSerialization.h ------------------------------------*- C++ -*-===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//                     The LLVM Compiler Infrastructure
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file is distributed under the University of Illinois Open Source
end_comment

begin_comment
comment|// License. See LICENSE.TXT for details.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|LLVM_DEBUGINFO_CODEVIEW_RECORDSERIALIZATION_H
end_ifndef

begin_define
define|#
directive|define
name|LLVM_DEBUGINFO_CODEVIEW_RECORDSERIALIZATION_H
end_define

begin_include
include|#
directive|include
file|"llvm/ADT/APSInt.h"
end_include

begin_include
include|#
directive|include
file|"llvm/ADT/ArrayRef.h"
end_include

begin_include
include|#
directive|include
file|"llvm/ADT/StringRef.h"
end_include

begin_include
include|#
directive|include
file|"llvm/Support/Endian.h"
end_include

begin_include
include|#
directive|include
file|"llvm/DebugInfo/CodeView/CodeView.h"
end_include

begin_include
include|#
directive|include
file|<cinttypes>
end_include

begin_include
include|#
directive|include
file|<tuple>
end_include

begin_decl_stmt
name|namespace
name|llvm
block|{
name|namespace
name|codeview
block|{
name|using
name|llvm
operator|::
name|support
operator|::
name|little32_t
expr_stmt|;
name|using
name|llvm
operator|::
name|support
operator|::
name|ulittle16_t
expr_stmt|;
name|using
name|llvm
operator|::
name|support
operator|::
name|ulittle32_t
expr_stmt|;
struct|struct
name|RecordPrefix
block|{
name|ulittle16_t
name|RecordLen
decl_stmt|;
comment|// Record length, starting from&Leaf.
name|ulittle16_t
name|RecordKind
decl_stmt|;
comment|// Record kind enum (SymRecordKind or TypeRecordKind)
block|}
struct|;
comment|/// Reinterpret a byte array as an array of characters. Does not interpret as
comment|/// a C string, as StringRef has several helpers (split) that make that easy.
name|StringRef
name|getBytesAsCharacters
argument_list|(
name|ArrayRef
operator|<
name|uint8_t
operator|>
name|LeafData
argument_list|)
decl_stmt|;
name|StringRef
name|getBytesAsCString
argument_list|(
name|ArrayRef
operator|<
name|uint8_t
operator|>
name|LeafData
argument_list|)
decl_stmt|;
comment|/// Consumes sizeof(T) bytes from the given byte sequence. Returns an error if
comment|/// there are not enough bytes remaining. Reinterprets the consumed bytes as a
comment|/// T object and points 'Res' at them.
name|template
operator|<
name|typename
name|T
operator|,
name|typename
name|U
operator|>
specifier|inline
name|std
operator|::
name|error_code
name|consumeObject
argument_list|(
argument|U&Data
argument_list|,
argument|const T *&Res
argument_list|)
block|{
if|if
condition|(
name|Data
operator|.
name|size
argument_list|()
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|Res
argument_list|)
condition|)
return|return
name|std
operator|::
name|make_error_code
argument_list|(
name|std
operator|::
name|errc
operator|::
name|illegal_byte_sequence
argument_list|)
return|;
name|Res
operator|=
name|reinterpret_cast
operator|<
specifier|const
name|T
operator|*
operator|>
operator|(
name|Data
operator|.
name|data
argument_list|()
operator|)
expr_stmt|;
name|Data
operator|=
name|Data
operator|.
name|drop_front
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|Res
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
block|}
specifier|inline
name|std
operator|::
name|error_code
name|consume
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|)
block|{
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
block|}
comment|/// Decodes a numeric "leaf" value. These are integer literals encountered in
comment|/// the type stream. If the value is positive and less than LF_NUMERIC (1<<
comment|/// 15), it is emitted directly in Data. Otherwise, it has a tag like LF_CHAR
comment|/// that indicates the bitwidth and sign of the numeric data.
name|std
operator|::
name|error_code
name|consume
argument_list|(
name|ArrayRef
operator|<
name|uint8_t
operator|>
operator|&
name|Data
argument_list|,
name|APSInt
operator|&
name|Num
argument_list|)
expr_stmt|;
name|std
operator|::
name|error_code
name|consume
argument_list|(
name|StringRef
operator|&
name|Data
argument_list|,
name|APSInt
operator|&
name|Num
argument_list|)
expr_stmt|;
comment|/// Decodes a numeric leaf value that is known to be a particular type.
name|std
operator|::
name|error_code
name|consume_numeric
argument_list|(
name|ArrayRef
operator|<
name|uint8_t
operator|>
operator|&
name|Data
argument_list|,
name|uint64_t
operator|&
name|Value
argument_list|)
expr_stmt|;
comment|/// Decodes signed and unsigned fixed-length integers.
name|std
operator|::
name|error_code
name|consume
argument_list|(
name|ArrayRef
operator|<
name|uint8_t
operator|>
operator|&
name|Data
argument_list|,
name|uint32_t
operator|&
name|Item
argument_list|)
expr_stmt|;
name|std
operator|::
name|error_code
name|consume
argument_list|(
name|StringRef
operator|&
name|Data
argument_list|,
name|uint32_t
operator|&
name|Item
argument_list|)
expr_stmt|;
name|std
operator|::
name|error_code
name|consume
argument_list|(
name|ArrayRef
operator|<
name|uint8_t
operator|>
operator|&
name|Data
argument_list|,
name|int32_t
operator|&
name|Item
argument_list|)
expr_stmt|;
comment|/// Decodes a null terminated string.
name|std
operator|::
name|error_code
name|consume
argument_list|(
name|ArrayRef
operator|<
name|uint8_t
operator|>
operator|&
name|Data
argument_list|,
name|StringRef
operator|&
name|Item
argument_list|)
expr_stmt|;
comment|/// Decodes an arbitrary object whose layout matches that of the underlying
comment|/// byte sequence, and returns a pointer to the object.
name|template
operator|<
name|typename
name|T
operator|>
name|std
operator|::
name|error_code
name|consume
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|,
argument|T *&Item
argument_list|)
block|{
return|return
name|consumeObject
argument_list|(
name|Data
argument_list|,
name|Item
argument_list|)
return|;
block|}
name|template
operator|<
name|typename
name|T
operator|,
name|typename
name|U
operator|>
expr|struct
name|serialize_conditional_impl
block|{
name|serialize_conditional_impl
argument_list|(
argument|T&Item
argument_list|,
argument|U Func
argument_list|)
operator|:
name|Item
argument_list|(
name|Item
argument_list|)
block|,
name|Func
argument_list|(
argument|Func
argument_list|)
block|{}
name|std
operator|::
name|error_code
name|deserialize
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|)
specifier|const
block|{
if|if
condition|(
operator|!
name|Func
argument_list|()
condition|)
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
return|return
name|consume
argument_list|(
name|Data
argument_list|,
name|Item
argument_list|)
return|;
block|}
name|T
modifier|&
name|Item
decl_stmt|;
name|U
name|Func
decl_stmt|;
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_expr_stmt
name|template
operator|<
name|typename
name|T
operator|,
name|typename
name|U
operator|>
name|serialize_conditional_impl
operator|<
name|T
operator|,
name|U
operator|>
name|serialize_conditional
argument_list|(
argument|T&Item
argument_list|,
argument|U Func
argument_list|)
block|{
return|return
name|serialize_conditional_impl
operator|<
name|T
operator|,
name|U
operator|>
operator|(
name|Item
operator|,
name|Func
operator|)
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|template
operator|<
name|typename
name|T
operator|,
name|typename
name|U
operator|>
expr|struct
name|serialize_array_impl
block|{
name|serialize_array_impl
argument_list|(
argument|ArrayRef<T>&Item
argument_list|,
argument|U Func
argument_list|)
operator|:
name|Item
argument_list|(
name|Item
argument_list|)
block|,
name|Func
argument_list|(
argument|Func
argument_list|)
block|{}
name|std
operator|::
name|error_code
name|deserialize
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|)
specifier|const
block|{
name|uint32_t
name|N
operator|=
name|Func
argument_list|()
block|;
if|if
condition|(
name|N
operator|==
literal|0
condition|)
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
name|uint32_t
name|Size
operator|=
sizeof|sizeof
argument_list|(
name|T
argument_list|)
operator|*
name|N
block|;
if|if
condition|(
name|Size
operator|/
sizeof|sizeof
argument_list|(
name|T
argument_list|)
operator|!=
name|N
condition|)
return|return
name|std
operator|::
name|make_error_code
argument_list|(
name|std
operator|::
name|errc
operator|::
name|illegal_byte_sequence
argument_list|)
return|;
end_expr_stmt

begin_if
if|if
condition|(
name|Data
operator|.
name|size
argument_list|()
operator|<
name|Size
condition|)
return|return
name|std
operator|::
name|make_error_code
argument_list|(
name|std
operator|::
name|errc
operator|::
name|illegal_byte_sequence
argument_list|)
return|;
end_if

begin_expr_stmt
name|Item
operator|=
name|ArrayRef
operator|<
name|T
operator|>
operator|(
name|reinterpret_cast
operator|<
specifier|const
name|T
operator|*
operator|>
operator|(
name|Data
operator|.
name|data
argument_list|()
operator|)
operator|,
name|N
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|Data
operator|=
name|Data
operator|.
name|drop_front
argument_list|(
name|Size
argument_list|)
expr_stmt|;
end_expr_stmt

begin_return
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
end_return

begin_expr_stmt
unit|}    ArrayRef
operator|<
name|T
operator|>
operator|&
name|Item
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|U
name|Func
decl_stmt|;
end_decl_stmt

begin_expr_stmt
unit|};
name|template
operator|<
name|typename
name|T
operator|>
expr|struct
name|serialize_vector_tail_impl
block|{
name|serialize_vector_tail_impl
argument_list|(
name|std
operator|::
name|vector
operator|<
name|T
operator|>
operator|&
name|Item
argument_list|)
operator|:
name|Item
argument_list|(
argument|Item
argument_list|)
block|{}
name|std
operator|::
name|error_code
name|deserialize
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|)
specifier|const
block|{
name|T
name|Field
block|;
comment|// Stop when we run out of bytes or we hit record padding bytes.
while|while
condition|(
operator|!
name|Data
operator|.
name|empty
argument_list|()
operator|&&
name|Data
operator|.
name|front
argument_list|()
operator|<
name|LF_PAD0
condition|)
block|{
if|if
condition|(
name|auto
name|EC
init|=
name|consume
argument_list|(
name|Data
argument_list|,
name|Field
argument_list|)
condition|)
return|return
name|EC
return|;
name|Item
operator|.
name|push_back
argument_list|(
name|Field
argument_list|)
expr_stmt|;
block|}
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|std
operator|::
name|vector
operator|<
name|T
operator|>
operator|&
name|Item
expr_stmt|;
end_expr_stmt

begin_struct
unit|};
struct|struct
name|serialize_null_term_string_array_impl
block|{
name|serialize_null_term_string_array_impl
argument_list|(
name|std
operator|::
name|vector
operator|<
name|StringRef
operator|>
operator|&
name|Item
argument_list|)
operator|:
name|Item
argument_list|(
argument|Item
argument_list|)
block|{}
name|std
operator|::
name|error_code
name|deserialize
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|)
specifier|const
block|{
if|if
condition|(
name|Data
operator|.
name|empty
argument_list|()
condition|)
return|return
name|std
operator|::
name|make_error_code
argument_list|(
name|std
operator|::
name|errc
operator|::
name|illegal_byte_sequence
argument_list|)
return|;
name|StringRef
name|Field
expr_stmt|;
comment|// Stop when we run out of bytes or we hit record padding bytes.
while|while
condition|(
name|Data
operator|.
name|front
argument_list|()
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|auto
name|EC
init|=
name|consume
argument_list|(
name|Data
argument_list|,
name|Field
argument_list|)
condition|)
return|return
name|EC
return|;
name|Item
operator|.
name|push_back
argument_list|(
name|Field
argument_list|)
expr_stmt|;
if|if
condition|(
name|Data
operator|.
name|empty
argument_list|()
condition|)
return|return
name|std
operator|::
name|make_error_code
argument_list|(
name|std
operator|::
name|errc
operator|::
name|illegal_byte_sequence
argument_list|)
return|;
block|}
name|Data
operator|=
name|Data
operator|.
name|drop_front
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
block|}
name|std
decl|::
name|vector
decl|<
name|StringRef
decl|>
modifier|&
name|Item
struct|;
end_struct

begin_expr_stmt
unit|};
name|template
operator|<
name|typename
name|T
operator|>
expr|struct
name|serialize_arrayref_tail_impl
block|{
name|serialize_arrayref_tail_impl
argument_list|(
name|ArrayRef
operator|<
name|T
operator|>
operator|&
name|Item
argument_list|)
operator|:
name|Item
argument_list|(
argument|Item
argument_list|)
block|{}
name|std
operator|::
name|error_code
name|deserialize
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|)
specifier|const
block|{
name|uint32_t
name|Count
operator|=
name|Data
operator|.
name|size
argument_list|()
operator|/
sizeof|sizeof
argument_list|(
name|T
argument_list|)
block|;
name|Item
operator|=
name|ArrayRef
operator|<
name|T
operator|>
operator|(
name|reinterpret_cast
operator|<
specifier|const
name|T
operator|*
operator|>
operator|(
name|Data
operator|.
name|begin
argument_list|()
operator|)
operator|,
name|Count
operator|)
block|;
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
block|}
name|ArrayRef
operator|<
name|T
operator|>
operator|&
name|Item
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|};
name|template
operator|<
name|typename
name|T
operator|>
expr|struct
name|serialize_numeric_impl
block|{
name|serialize_numeric_impl
argument_list|(
name|T
operator|&
name|Item
argument_list|)
operator|:
name|Item
argument_list|(
argument|Item
argument_list|)
block|{}
name|std
operator|::
name|error_code
name|deserialize
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|)
specifier|const
block|{
return|return
name|consume_numeric
argument_list|(
name|Data
argument_list|,
name|Item
argument_list|)
return|;
block|}
name|T
operator|&
name|Item
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|};
name|template
operator|<
name|typename
name|T
operator|,
name|typename
name|U
operator|>
name|serialize_array_impl
operator|<
name|T
operator|,
name|U
operator|>
name|serialize_array
argument_list|(
argument|ArrayRef<T>&Item
argument_list|,
argument|U Func
argument_list|)
block|{
return|return
name|serialize_array_impl
operator|<
name|T
operator|,
name|U
operator|>
operator|(
name|Item
operator|,
name|Func
operator|)
return|;
block|}
end_expr_stmt

begin_decl_stmt
specifier|inline
name|serialize_null_term_string_array_impl
name|serialize_null_term_string_array
argument_list|(
name|std
operator|::
name|vector
operator|<
name|StringRef
operator|>
operator|&
name|Item
argument_list|)
block|{
return|return
name|serialize_null_term_string_array_impl
argument_list|(
name|Item
argument_list|)
return|;
block|}
end_decl_stmt

begin_expr_stmt
name|template
operator|<
name|typename
name|T
operator|>
name|serialize_vector_tail_impl
operator|<
name|T
operator|>
name|serialize_array_tail
argument_list|(
argument|std::vector<T>&Item
argument_list|)
block|{
return|return
name|serialize_vector_tail_impl
operator|<
name|T
operator|>
operator|(
name|Item
operator|)
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|template
operator|<
name|typename
name|T
operator|>
name|serialize_arrayref_tail_impl
operator|<
name|T
operator|>
name|serialize_array_tail
argument_list|(
argument|ArrayRef<T>&Item
argument_list|)
block|{
return|return
name|serialize_arrayref_tail_impl
operator|<
name|T
operator|>
operator|(
name|Item
operator|)
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|template
operator|<
name|typename
name|T
operator|>
name|serialize_numeric_impl
operator|<
name|T
operator|>
name|serialize_numeric
argument_list|(
argument|T&Item
argument_list|)
block|{
return|return
name|serialize_numeric_impl
operator|<
name|T
operator|>
operator|(
name|Item
operator|)
return|;
block|}
end_expr_stmt

begin_comment
comment|// This field is only present in the byte record if the condition is true.  The
end_comment

begin_comment
comment|// condition is evaluated lazily, so it can depend on items that were
end_comment

begin_comment
comment|// deserialized
end_comment

begin_comment
comment|// earlier.
end_comment

begin_define
define|#
directive|define
name|CV_CONDITIONAL_FIELD
parameter_list|(
name|I
parameter_list|,
name|C
parameter_list|)
define|\
value|serialize_conditional(I, [&]() { return !!(C); })
end_define

begin_comment
comment|// This is an array of N items, where N is evaluated lazily, so it can refer
end_comment

begin_comment
comment|// to a field deserialized earlier.
end_comment

begin_define
define|#
directive|define
name|CV_ARRAY_FIELD_N
parameter_list|(
name|I
parameter_list|,
name|N
parameter_list|)
value|serialize_array(I, [&]() { return N; })
end_define

begin_comment
comment|// This is an array that exhausts the remainder of the input buffer.
end_comment

begin_define
define|#
directive|define
name|CV_ARRAY_FIELD_TAIL
parameter_list|(
name|I
parameter_list|)
value|serialize_array_tail(I)
end_define

begin_comment
comment|// This is an array that consumes null terminated strings until a double null
end_comment

begin_comment
comment|// is encountered.
end_comment

begin_define
define|#
directive|define
name|CV_STRING_ARRAY_NULL_TERM
parameter_list|(
name|I
parameter_list|)
value|serialize_null_term_string_array(I)
end_define

begin_define
define|#
directive|define
name|CV_NUMERIC_FIELD
parameter_list|(
name|I
parameter_list|)
value|serialize_numeric(I)
end_define

begin_expr_stmt
name|template
operator|<
name|typename
name|T
operator|,
name|typename
name|U
operator|>
name|std
operator|::
name|error_code
name|consume
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|,
argument|const serialize_conditional_impl<T
argument_list|,
argument|U>&Item
argument_list|)
block|{
return|return
name|Item
operator|.
name|deserialize
argument_list|(
name|Data
argument_list|)
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|template
operator|<
name|typename
name|T
operator|,
name|typename
name|U
operator|>
name|std
operator|::
name|error_code
name|consume
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|,
argument|const serialize_array_impl<T
argument_list|,
argument|U>&Item
argument_list|)
block|{
return|return
name|Item
operator|.
name|deserialize
argument_list|(
name|Data
argument_list|)
return|;
block|}
end_expr_stmt

begin_expr_stmt
specifier|inline
name|std
operator|::
name|error_code
name|consume
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|,
argument|const serialize_null_term_string_array_impl&Item
argument_list|)
block|{
return|return
name|Item
operator|.
name|deserialize
argument_list|(
name|Data
argument_list|)
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|template
operator|<
name|typename
name|T
operator|>
name|std
operator|::
name|error_code
name|consume
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|,
argument|const serialize_vector_tail_impl<T>&Item
argument_list|)
block|{
return|return
name|Item
operator|.
name|deserialize
argument_list|(
name|Data
argument_list|)
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|template
operator|<
name|typename
name|T
operator|>
name|std
operator|::
name|error_code
name|consume
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|,
argument|const serialize_arrayref_tail_impl<T>&Item
argument_list|)
block|{
return|return
name|Item
operator|.
name|deserialize
argument_list|(
name|Data
argument_list|)
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|template
operator|<
name|typename
name|T
operator|>
name|std
operator|::
name|error_code
name|consume
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|,
argument|const serialize_numeric_impl<T>&Item
argument_list|)
block|{
return|return
name|Item
operator|.
name|deserialize
argument_list|(
name|Data
argument_list|)
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|template
operator|<
name|typename
name|T
operator|,
name|typename
name|U
operator|,
name|typename
operator|...
name|Args
operator|>
name|std
operator|::
name|error_code
name|consume
argument_list|(
argument|ArrayRef<uint8_t>&Data
argument_list|,
argument|T&&X
argument_list|,
argument|U&&Y
argument_list|,
argument|Args&&... Rest
argument_list|)
block|{
if|if
condition|(
name|auto
name|EC
init|=
name|consume
argument_list|(
name|Data
argument_list|,
name|X
argument_list|)
condition|)
return|return
name|EC
return|;
end_expr_stmt

begin_return
return|return
name|consume
argument_list|(
name|Data
argument_list|,
name|Y
argument_list|,
name|std
operator|::
name|forward
operator|<
name|Args
operator|>
operator|(
name|Rest
operator|)
operator|...
argument_list|)
return|;
end_return

begin_define
unit|}
define|#
directive|define
name|CV_DESERIALIZE
parameter_list|(
modifier|...
parameter_list|)
define|\
value|if (auto EC = consume(__VA_ARGS__))                                          \     return EC;
end_define

begin_endif
unit|} }
endif|#
directive|endif
end_endif

end_unit


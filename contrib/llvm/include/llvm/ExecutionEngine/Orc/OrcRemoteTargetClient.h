begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|//===---- OrcRemoteTargetClient.h - Orc Remote-target Client ----*- C++ -*-===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//                     The LLVM Compiler Infrastructure
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file is distributed under the University of Illinois Open Source
end_comment

begin_comment
comment|// License. See LICENSE.TXT for details.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file defines the OrcRemoteTargetClient class and helpers. This class
end_comment

begin_comment
comment|// can be used to communicate over an RPCChannel with an OrcRemoteTargetServer
end_comment

begin_comment
comment|// instance to support remote-JITing.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|LLVM_EXECUTIONENGINE_ORC_ORCREMOTETARGETCLIENT_H
end_ifndef

begin_define
define|#
directive|define
name|LLVM_EXECUTIONENGINE_ORC_ORCREMOTETARGETCLIENT_H
end_define

begin_include
include|#
directive|include
file|"IndirectionUtils.h"
end_include

begin_include
include|#
directive|include
file|"OrcRemoteTargetRPCAPI.h"
end_include

begin_include
include|#
directive|include
file|<system_error>
end_include

begin_define
define|#
directive|define
name|DEBUG_TYPE
value|"orc-remote"
end_define

begin_decl_stmt
name|namespace
name|llvm
block|{
name|namespace
name|orc
block|{
name|namespace
name|remote
block|{
comment|/// This class provides utilities (including memory manager, indirect stubs
comment|/// manager, and compile callback manager types) that support remote JITing
comment|/// in ORC.
comment|///
comment|/// Each of the utility classes talks to a JIT server (an instance of the
comment|/// OrcRemoteTargetServer class) via an RPC system (see RPCUtils.h) to carry out
comment|/// its actions.
name|template
operator|<
name|typename
name|ChannelT
operator|>
name|class
name|OrcRemoteTargetClient
operator|:
name|public
name|OrcRemoteTargetRPCAPI
block|{
name|public
operator|:
comment|/// Remote memory manager.
name|class
name|RCMemoryManager
operator|:
name|public
name|RuntimeDyld
operator|::
name|MemoryManager
block|{
name|public
operator|:
name|RCMemoryManager
argument_list|(
argument|OrcRemoteTargetClient&Client
argument_list|,
argument|ResourceIdMgr::ResourceId Id
argument_list|)
operator|:
name|Client
argument_list|(
name|Client
argument_list|)
block|,
name|Id
argument_list|(
argument|Id
argument_list|)
block|{
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Created remote allocator "
operator|<<
name|Id
operator|<<
literal|"\n"
argument_list|)
block|;     }
name|RCMemoryManager
argument_list|(
name|RCMemoryManager
operator|&&
name|Other
argument_list|)
operator|:
name|Client
argument_list|(
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|Client
argument_list|)
argument_list|)
block|,
name|Id
argument_list|(
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|Id
argument_list|)
argument_list|)
block|,
name|Unmapped
argument_list|(
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|Unmapped
argument_list|)
argument_list|)
block|,
name|Unfinalized
argument_list|(
argument|std::move(Other.Unfinalized)
argument_list|)
block|{}
name|RCMemoryManager
name|operator
operator|=
operator|(
name|RCMemoryManager
operator|&&
name|Other
operator|)
block|{
name|Client
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|Client
argument_list|)
block|;
name|Id
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|Id
argument_list|)
block|;
name|Unmapped
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|Unmapped
argument_list|)
block|;
name|Unfinalized
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|Unfinalized
argument_list|)
block|;
return|return
operator|*
name|this
return|;
block|}
operator|~
name|RCMemoryManager
argument_list|()
block|{
name|Client
operator|.
name|destroyRemoteAllocator
argument_list|(
name|Id
argument_list|)
block|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Destroyed remote allocator "
operator|<<
name|Id
operator|<<
literal|"\n"
argument_list|)
block|;     }
name|uint8_t
operator|*
name|allocateCodeSection
argument_list|(
argument|uintptr_t Size
argument_list|,
argument|unsigned Alignment
argument_list|,
argument|unsigned SectionID
argument_list|,
argument|StringRef SectionName
argument_list|)
name|override
block|{
name|Unmapped
operator|.
name|back
argument_list|()
operator|.
name|CodeAllocs
operator|.
name|emplace_back
argument_list|(
name|Size
argument_list|,
name|Alignment
argument_list|)
block|;
name|uint8_t
operator|*
name|Alloc
operator|=
name|reinterpret_cast
operator|<
name|uint8_t
operator|*
operator|>
operator|(
name|Unmapped
operator|.
name|back
argument_list|()
operator|.
name|CodeAllocs
operator|.
name|back
argument_list|()
operator|.
name|getLocalAddress
argument_list|()
operator|)
block|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Allocator "
operator|<<
name|Id
operator|<<
literal|" allocated code for "
operator|<<
name|SectionName
operator|<<
literal|": "
operator|<<
name|Alloc
operator|<<
literal|" ("
operator|<<
name|Size
operator|<<
literal|" bytes, alignment "
operator|<<
name|Alignment
operator|<<
literal|")\n"
argument_list|)
block|;
return|return
name|Alloc
return|;
block|}
name|uint8_t
operator|*
name|allocateDataSection
argument_list|(
argument|uintptr_t Size
argument_list|,
argument|unsigned Alignment
argument_list|,
argument|unsigned SectionID
argument_list|,
argument|StringRef SectionName
argument_list|,
argument|bool IsReadOnly
argument_list|)
name|override
block|{
if|if
condition|(
name|IsReadOnly
condition|)
block|{
name|Unmapped
operator|.
name|back
argument_list|()
operator|.
name|RODataAllocs
operator|.
name|emplace_back
argument_list|(
name|Size
argument_list|,
name|Alignment
argument_list|)
expr_stmt|;
name|uint8_t
modifier|*
name|Alloc
init|=
name|reinterpret_cast
operator|<
name|uint8_t
operator|*
operator|>
operator|(
name|Unmapped
operator|.
name|back
argument_list|()
operator|.
name|RODataAllocs
operator|.
name|back
argument_list|()
operator|.
name|getLocalAddress
argument_list|()
operator|)
decl_stmt|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Allocator "
operator|<<
name|Id
operator|<<
literal|" allocated ro-data for "
operator|<<
name|SectionName
operator|<<
literal|": "
operator|<<
name|Alloc
operator|<<
literal|" ("
operator|<<
name|Size
operator|<<
literal|" bytes, alignment "
operator|<<
name|Alignment
operator|<<
literal|")\n"
argument_list|)
expr_stmt|;
return|return
name|Alloc
return|;
block|}
comment|// else...
name|Unmapped
operator|.
name|back
argument_list|()
operator|.
name|RWDataAllocs
operator|.
name|emplace_back
argument_list|(
name|Size
argument_list|,
name|Alignment
argument_list|)
expr_stmt|;
name|uint8_t
operator|*
name|Alloc
operator|=
name|reinterpret_cast
operator|<
name|uint8_t
operator|*
operator|>
operator|(
name|Unmapped
operator|.
name|back
argument_list|()
operator|.
name|RWDataAllocs
operator|.
name|back
argument_list|()
operator|.
name|getLocalAddress
argument_list|()
operator|)
block|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Allocator "
operator|<<
name|Id
operator|<<
literal|" allocated rw-data for "
operator|<<
name|SectionName
operator|<<
literal|": "
operator|<<
name|Alloc
operator|<<
literal|" ("
operator|<<
name|Size
operator|<<
literal|" bytes, alignment "
operator|<<
name|Alignment
operator|<<
literal|")\n"
argument_list|)
block|;
return|return
name|Alloc
return|;
block|}
name|void
name|reserveAllocationSpace
argument_list|(
argument|uintptr_t CodeSize
argument_list|,
argument|uint32_t CodeAlign
argument_list|,
argument|uintptr_t RODataSize
argument_list|,
argument|uint32_t RODataAlign
argument_list|,
argument|uintptr_t RWDataSize
argument_list|,
argument|uint32_t RWDataAlign
argument_list|)
name|override
block|{
name|Unmapped
operator|.
name|push_back
argument_list|(
name|ObjectAllocs
argument_list|()
argument_list|)
block|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Allocator "
operator|<<
name|Id
operator|<<
literal|" reserved:\n"
argument_list|)
block|;
if|if
condition|(
name|CodeSize
operator|!=
literal|0
condition|)
block|{
name|std
operator|::
name|error_code
name|EC
operator|=
name|Client
operator|.
name|reserveMem
argument_list|(
name|Unmapped
operator|.
name|back
argument_list|()
operator|.
name|RemoteCodeAddr
argument_list|,
name|Id
argument_list|,
name|CodeSize
argument_list|,
name|CodeAlign
argument_list|)
expr_stmt|;
comment|// FIXME; Add error to poll.
name|assert
argument_list|(
operator|!
name|EC
operator|&&
literal|"Failed reserving remote memory."
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|EC
expr_stmt|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"  code: "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|Unmapped
operator|.
name|back
argument_list|()
operator|.
name|RemoteCodeAddr
argument_list|)
operator|<<
literal|" ("
operator|<<
name|CodeSize
operator|<<
literal|" bytes, alignment "
operator|<<
name|CodeAlign
operator|<<
literal|")\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|RODataSize
operator|!=
literal|0
condition|)
block|{
name|std
operator|::
name|error_code
name|EC
operator|=
name|Client
operator|.
name|reserveMem
argument_list|(
name|Unmapped
operator|.
name|back
argument_list|()
operator|.
name|RemoteRODataAddr
argument_list|,
name|Id
argument_list|,
name|RODataSize
argument_list|,
name|RODataAlign
argument_list|)
expr_stmt|;
comment|// FIXME; Add error to poll.
name|assert
argument_list|(
operator|!
name|EC
operator|&&
literal|"Failed reserving remote memory."
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|EC
expr_stmt|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"  ro-data: "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|Unmapped
operator|.
name|back
argument_list|()
operator|.
name|RemoteRODataAddr
argument_list|)
operator|<<
literal|" ("
operator|<<
name|RODataSize
operator|<<
literal|" bytes, alignment "
operator|<<
name|RODataAlign
operator|<<
literal|")\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|RWDataSize
operator|!=
literal|0
condition|)
block|{
name|std
operator|::
name|error_code
name|EC
operator|=
name|Client
operator|.
name|reserveMem
argument_list|(
name|Unmapped
operator|.
name|back
argument_list|()
operator|.
name|RemoteRWDataAddr
argument_list|,
name|Id
argument_list|,
name|RWDataSize
argument_list|,
name|RWDataAlign
argument_list|)
expr_stmt|;
comment|// FIXME; Add error to poll.
name|assert
argument_list|(
operator|!
name|EC
operator|&&
literal|"Failed reserving remote memory."
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|EC
expr_stmt|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"  rw-data: "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|Unmapped
operator|.
name|back
argument_list|()
operator|.
name|RemoteRWDataAddr
argument_list|)
operator|<<
literal|" ("
operator|<<
name|RWDataSize
operator|<<
literal|" bytes, alignment "
operator|<<
name|RWDataAlign
operator|<<
literal|")\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|bool
name|needsToReserveAllocationSpace
argument_list|()
name|override
block|{
return|return
name|true
return|;
block|}
name|void
name|registerEHFrames
argument_list|(
argument|uint8_t *Addr
argument_list|,
argument|uint64_t LoadAddr
argument_list|,
argument|size_t Size
argument_list|)
name|override
block|{}
name|void
name|deregisterEHFrames
argument_list|(
argument|uint8_t *addr
argument_list|,
argument|uint64_t LoadAddr
argument_list|,
argument|size_t Size
argument_list|)
name|override
block|{}
name|void
name|notifyObjectLoaded
argument_list|(
argument|RuntimeDyld&Dyld
argument_list|,
argument|const object::ObjectFile&Obj
argument_list|)
name|override
block|{
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Allocator "
operator|<<
name|Id
operator|<<
literal|" applied mappings:\n"
argument_list|)
block|;
for|for
control|(
name|auto
operator|&
name|ObjAllocs
operator|:
name|Unmapped
control|)
block|{
block|{
name|TargetAddress
name|NextCodeAddr
init|=
name|ObjAllocs
operator|.
name|RemoteCodeAddr
decl_stmt|;
for|for
control|(
name|auto
operator|&
name|Alloc
operator|:
name|ObjAllocs
operator|.
name|CodeAllocs
control|)
block|{
name|NextCodeAddr
operator|=
name|RoundUpToAlignment
argument_list|(
name|NextCodeAddr
argument_list|,
name|Alloc
operator|.
name|getAlign
argument_list|()
argument_list|)
expr_stmt|;
name|Dyld
operator|.
name|mapSectionAddress
argument_list|(
name|Alloc
operator|.
name|getLocalAddress
argument_list|()
argument_list|,
name|NextCodeAddr
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"     code: "
operator|<<
name|static_cast
operator|<
name|void
operator|*
operator|>
operator|(
name|Alloc
operator|.
name|getLocalAddress
argument_list|()
operator|)
operator|<<
literal|" -> "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|NextCodeAddr
argument_list|)
operator|<<
literal|"\n"
argument_list|)
expr_stmt|;
name|Alloc
operator|.
name|setRemoteAddress
argument_list|(
name|NextCodeAddr
argument_list|)
expr_stmt|;
name|NextCodeAddr
operator|+=
name|Alloc
operator|.
name|getSize
argument_list|()
expr_stmt|;
block|}
block|}
block|{
name|TargetAddress
name|NextRODataAddr
init|=
name|ObjAllocs
operator|.
name|RemoteRODataAddr
decl_stmt|;
for|for
control|(
name|auto
operator|&
name|Alloc
operator|:
name|ObjAllocs
operator|.
name|RODataAllocs
control|)
block|{
name|NextRODataAddr
operator|=
name|RoundUpToAlignment
argument_list|(
name|NextRODataAddr
argument_list|,
name|Alloc
operator|.
name|getAlign
argument_list|()
argument_list|)
expr_stmt|;
name|Dyld
operator|.
name|mapSectionAddress
argument_list|(
name|Alloc
operator|.
name|getLocalAddress
argument_list|()
argument_list|,
name|NextRODataAddr
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"  ro-data: "
operator|<<
name|static_cast
operator|<
name|void
operator|*
operator|>
operator|(
name|Alloc
operator|.
name|getLocalAddress
argument_list|()
operator|)
operator|<<
literal|" -> "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|NextRODataAddr
argument_list|)
operator|<<
literal|"\n"
argument_list|)
expr_stmt|;
name|Alloc
operator|.
name|setRemoteAddress
argument_list|(
name|NextRODataAddr
argument_list|)
expr_stmt|;
name|NextRODataAddr
operator|+=
name|Alloc
operator|.
name|getSize
argument_list|()
expr_stmt|;
block|}
block|}
block|{
name|TargetAddress
name|NextRWDataAddr
init|=
name|ObjAllocs
operator|.
name|RemoteRWDataAddr
decl_stmt|;
for|for
control|(
name|auto
operator|&
name|Alloc
operator|:
name|ObjAllocs
operator|.
name|RWDataAllocs
control|)
block|{
name|NextRWDataAddr
operator|=
name|RoundUpToAlignment
argument_list|(
name|NextRWDataAddr
argument_list|,
name|Alloc
operator|.
name|getAlign
argument_list|()
argument_list|)
expr_stmt|;
name|Dyld
operator|.
name|mapSectionAddress
argument_list|(
name|Alloc
operator|.
name|getLocalAddress
argument_list|()
argument_list|,
name|NextRWDataAddr
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"  rw-data: "
operator|<<
name|static_cast
operator|<
name|void
operator|*
operator|>
operator|(
name|Alloc
operator|.
name|getLocalAddress
argument_list|()
operator|)
operator|<<
literal|" -> "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|NextRWDataAddr
argument_list|)
operator|<<
literal|"\n"
argument_list|)
expr_stmt|;
name|Alloc
operator|.
name|setRemoteAddress
argument_list|(
name|NextRWDataAddr
argument_list|)
expr_stmt|;
name|NextRWDataAddr
operator|+=
name|Alloc
operator|.
name|getSize
argument_list|()
expr_stmt|;
block|}
block|}
name|Unfinalized
operator|.
name|push_back
argument_list|(
name|std
operator|::
name|move
argument_list|(
name|ObjAllocs
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|Unmapped
operator|.
name|clear
argument_list|()
block|;     }
name|bool
name|finalizeMemory
argument_list|(
argument|std::string *ErrMsg = nullptr
argument_list|)
name|override
block|{
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Allocator "
operator|<<
name|Id
operator|<<
literal|" finalizing:\n"
argument_list|)
block|;
for|for
control|(
name|auto
operator|&
name|ObjAllocs
operator|:
name|Unfinalized
control|)
block|{
for|for
control|(
name|auto
operator|&
name|Alloc
operator|:
name|ObjAllocs
operator|.
name|CodeAllocs
control|)
block|{
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"  copying code: "
operator|<<
name|static_cast
operator|<
name|void
operator|*
operator|>
operator|(
name|Alloc
operator|.
name|getLocalAddress
argument_list|()
operator|)
operator|<<
literal|" -> "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|Alloc
operator|.
name|getRemoteAddress
argument_list|()
argument_list|)
operator|<<
literal|" ("
operator|<<
name|Alloc
operator|.
name|getSize
argument_list|()
operator|<<
literal|" bytes)\n"
argument_list|)
expr_stmt|;
name|Client
operator|.
name|writeMem
argument_list|(
name|Alloc
operator|.
name|getRemoteAddress
argument_list|()
argument_list|,
name|Alloc
operator|.
name|getLocalAddress
argument_list|()
argument_list|,
name|Alloc
operator|.
name|getSize
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ObjAllocs
operator|.
name|RemoteCodeAddr
condition|)
block|{
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"  setting R-X permissions on code block: "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|ObjAllocs
operator|.
name|RemoteCodeAddr
argument_list|)
operator|<<
literal|"\n"
argument_list|)
expr_stmt|;
name|Client
operator|.
name|setProtections
argument_list|(
name|Id
argument_list|,
name|ObjAllocs
operator|.
name|RemoteCodeAddr
argument_list|,
name|sys
operator|::
name|Memory
operator|::
name|MF_READ
operator||
name|sys
operator|::
name|Memory
operator|::
name|MF_EXEC
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|auto
operator|&
name|Alloc
operator|:
name|ObjAllocs
operator|.
name|RODataAllocs
control|)
block|{
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"  copying ro-data: "
operator|<<
name|static_cast
operator|<
name|void
operator|*
operator|>
operator|(
name|Alloc
operator|.
name|getLocalAddress
argument_list|()
operator|)
operator|<<
literal|" -> "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|Alloc
operator|.
name|getRemoteAddress
argument_list|()
argument_list|)
operator|<<
literal|" ("
operator|<<
name|Alloc
operator|.
name|getSize
argument_list|()
operator|<<
literal|" bytes)\n"
argument_list|)
expr_stmt|;
name|Client
operator|.
name|writeMem
argument_list|(
name|Alloc
operator|.
name|getRemoteAddress
argument_list|()
argument_list|,
name|Alloc
operator|.
name|getLocalAddress
argument_list|()
argument_list|,
name|Alloc
operator|.
name|getSize
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ObjAllocs
operator|.
name|RemoteRODataAddr
condition|)
block|{
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"  setting R-- permissions on ro-data block: "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|ObjAllocs
operator|.
name|RemoteRODataAddr
argument_list|)
operator|<<
literal|"\n"
argument_list|)
expr_stmt|;
name|Client
operator|.
name|setProtections
argument_list|(
name|Id
argument_list|,
name|ObjAllocs
operator|.
name|RemoteRODataAddr
argument_list|,
name|sys
operator|::
name|Memory
operator|::
name|MF_READ
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|auto
operator|&
name|Alloc
operator|:
name|ObjAllocs
operator|.
name|RWDataAllocs
control|)
block|{
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"  copying rw-data: "
operator|<<
name|static_cast
operator|<
name|void
operator|*
operator|>
operator|(
name|Alloc
operator|.
name|getLocalAddress
argument_list|()
operator|)
operator|<<
literal|" -> "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|Alloc
operator|.
name|getRemoteAddress
argument_list|()
argument_list|)
operator|<<
literal|" ("
operator|<<
name|Alloc
operator|.
name|getSize
argument_list|()
operator|<<
literal|" bytes)\n"
argument_list|)
expr_stmt|;
name|Client
operator|.
name|writeMem
argument_list|(
name|Alloc
operator|.
name|getRemoteAddress
argument_list|()
argument_list|,
name|Alloc
operator|.
name|getLocalAddress
argument_list|()
argument_list|,
name|Alloc
operator|.
name|getSize
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ObjAllocs
operator|.
name|RemoteRWDataAddr
condition|)
block|{
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"  setting RW- permissions on rw-data block: "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|ObjAllocs
operator|.
name|RemoteRWDataAddr
argument_list|)
operator|<<
literal|"\n"
argument_list|)
expr_stmt|;
name|Client
operator|.
name|setProtections
argument_list|(
name|Id
argument_list|,
name|ObjAllocs
operator|.
name|RemoteRWDataAddr
argument_list|,
name|sys
operator|::
name|Memory
operator|::
name|MF_READ
operator||
name|sys
operator|::
name|Memory
operator|::
name|MF_WRITE
argument_list|)
expr_stmt|;
block|}
block|}
name|Unfinalized
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return
name|false
return|;
block|}
name|private
label|:
name|class
name|Alloc
block|{
name|public
label|:
name|Alloc
argument_list|(
argument|uint64_t Size
argument_list|,
argument|unsigned Align
argument_list|)
block|:
name|Size
argument_list|(
name|Size
argument_list|)
operator|,
name|Align
argument_list|(
name|Align
argument_list|)
operator|,
name|Contents
argument_list|(
argument|new char[Size + Align -
literal|1
argument|]
argument_list|)
operator|,
name|RemoteAddr
argument_list|(
literal|0
argument_list|)
block|{}
name|Alloc
argument_list|(
name|Alloc
operator|&&
name|Other
argument_list|)
operator|:
name|Size
argument_list|(
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|Size
argument_list|)
argument_list|)
operator|,
name|Align
argument_list|(
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|Align
argument_list|)
argument_list|)
operator|,
name|Contents
argument_list|(
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|Contents
argument_list|)
argument_list|)
operator|,
name|RemoteAddr
argument_list|(
argument|std::move(Other.RemoteAddr)
argument_list|)
block|{}
name|Alloc
operator|&
name|operator
operator|=
operator|(
name|Alloc
operator|&&
name|Other
operator|)
block|{
name|Size
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|Size
argument_list|)
block|;
name|Align
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|Align
argument_list|)
block|;
name|Contents
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|Contents
argument_list|)
block|;
name|RemoteAddr
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|RemoteAddr
argument_list|)
block|;
return|return
operator|*
name|this
return|;
block|}
name|uint64_t
name|getSize
argument_list|()
specifier|const
block|{
return|return
name|Size
return|;
block|}
name|unsigned
name|getAlign
argument_list|()
specifier|const
block|{
return|return
name|Align
return|;
block|}
name|char
operator|*
name|getLocalAddress
argument_list|()
specifier|const
block|{
name|uintptr_t
name|LocalAddr
operator|=
name|reinterpret_cast
operator|<
name|uintptr_t
operator|>
operator|(
name|Contents
operator|.
name|get
argument_list|()
operator|)
block|;
name|LocalAddr
operator|=
name|RoundUpToAlignment
argument_list|(
name|LocalAddr
argument_list|,
name|Align
argument_list|)
block|;
return|return
name|reinterpret_cast
operator|<
name|char
operator|*
operator|>
operator|(
name|LocalAddr
operator|)
return|;
block|}
name|void
name|setRemoteAddress
parameter_list|(
name|TargetAddress
name|RemoteAddr
parameter_list|)
block|{
name|this
operator|->
name|RemoteAddr
operator|=
name|RemoteAddr
expr_stmt|;
block|}
name|TargetAddress
name|getRemoteAddress
argument_list|()
specifier|const
block|{
return|return
name|RemoteAddr
return|;
block|}
name|private
label|:
name|uint64_t
name|Size
decl_stmt|;
name|unsigned
name|Align
decl_stmt|;
name|std
operator|::
name|unique_ptr
operator|<
name|char
index|[]
operator|>
name|Contents
expr_stmt|;
name|TargetAddress
name|RemoteAddr
decl_stmt|;
block|}
empty_stmt|;
struct|struct
name|ObjectAllocs
block|{
name|ObjectAllocs
argument_list|()
operator|:
name|RemoteCodeAddr
argument_list|(
literal|0
argument_list|)
operator|,
name|RemoteRODataAddr
argument_list|(
literal|0
argument_list|)
operator|,
name|RemoteRWDataAddr
argument_list|(
literal|0
argument_list|)
block|{}
name|ObjectAllocs
argument_list|(
name|ObjectAllocs
operator|&&
name|Other
argument_list|)
operator|:
name|RemoteCodeAddr
argument_list|(
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|RemoteCodeAddr
argument_list|)
argument_list|)
operator|,
name|RemoteRODataAddr
argument_list|(
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|RemoteRODataAddr
argument_list|)
argument_list|)
operator|,
name|RemoteRWDataAddr
argument_list|(
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|RemoteRWDataAddr
argument_list|)
argument_list|)
operator|,
name|CodeAllocs
argument_list|(
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|CodeAllocs
argument_list|)
argument_list|)
operator|,
name|RODataAllocs
argument_list|(
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|RODataAllocs
argument_list|)
argument_list|)
operator|,
name|RWDataAllocs
argument_list|(
argument|std::move(Other.RWDataAllocs)
argument_list|)
block|{}
name|ObjectAllocs
operator|&
name|operator
operator|=
operator|(
name|ObjectAllocs
operator|&&
name|Other
operator|)
block|{
name|RemoteCodeAddr
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|RemoteCodeAddr
argument_list|)
block|;
name|RemoteRODataAddr
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|RemoteRODataAddr
argument_list|)
block|;
name|RemoteRWDataAddr
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|RemoteRWDataAddr
argument_list|)
block|;
name|CodeAllocs
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|CodeAllocs
argument_list|)
block|;
name|RODataAllocs
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|RODataAllocs
argument_list|)
block|;
name|RWDataAllocs
operator|=
name|std
operator|::
name|move
argument_list|(
name|Other
operator|.
name|RWDataAllocs
argument_list|)
block|;
return|return
operator|*
name|this
return|;
block|}
name|TargetAddress
name|RemoteCodeAddr
decl_stmt|;
name|TargetAddress
name|RemoteRODataAddr
decl_stmt|;
name|TargetAddress
name|RemoteRWDataAddr
decl_stmt|;
name|std
operator|::
name|vector
operator|<
name|Alloc
operator|>
name|CodeAllocs
operator|,
name|RODataAllocs
operator|,
name|RWDataAllocs
expr_stmt|;
block|}
struct|;
name|OrcRemoteTargetClient
modifier|&
name|Client
decl_stmt|;
name|ResourceIdMgr
operator|::
name|ResourceId
name|Id
expr_stmt|;
name|std
operator|::
name|vector
operator|<
name|ObjectAllocs
operator|>
name|Unmapped
expr_stmt|;
name|std
operator|::
name|vector
operator|<
name|ObjectAllocs
operator|>
name|Unfinalized
expr_stmt|;
block|}
empty_stmt|;
comment|/// Remote indirect stubs manager.
name|class
name|RCIndirectStubsManager
range|:
name|public
name|IndirectStubsManager
block|{
name|public
operator|:
name|RCIndirectStubsManager
argument_list|(
argument|OrcRemoteTargetClient&Remote
argument_list|,
argument|ResourceIdMgr::ResourceId Id
argument_list|)
operator|:
name|Remote
argument_list|(
name|Remote
argument_list|)
block|,
name|Id
argument_list|(
argument|Id
argument_list|)
block|{}
operator|~
name|RCIndirectStubsManager
argument_list|()
block|{
name|Remote
operator|.
name|destroyIndirectStubsManager
argument_list|(
name|Id
argument_list|)
block|; }
name|std
operator|::
name|error_code
name|createStub
argument_list|(
argument|StringRef StubName
argument_list|,
argument|TargetAddress StubAddr
argument_list|,
argument|JITSymbolFlags StubFlags
argument_list|)
name|override
block|{
if|if
condition|(
name|auto
name|EC
init|=
name|reserveStubs
argument_list|(
literal|1
argument_list|)
condition|)
return|return
name|EC
return|;
return|return
name|createStubInternal
argument_list|(
name|StubName
argument_list|,
name|StubAddr
argument_list|,
name|StubFlags
argument_list|)
return|;
block|}
name|std
operator|::
name|error_code
name|createStubs
argument_list|(
argument|const StubInitsMap&StubInits
argument_list|)
name|override
block|{
if|if
condition|(
name|auto
name|EC
init|=
name|reserveStubs
argument_list|(
name|StubInits
operator|.
name|size
argument_list|()
argument_list|)
condition|)
return|return
name|EC
return|;
for|for
control|(
name|auto
operator|&
name|Entry
operator|:
name|StubInits
control|)
if|if
condition|(
name|auto
name|EC
init|=
name|createStubInternal
argument_list|(
name|Entry
operator|.
name|first
argument_list|()
argument_list|,
name|Entry
operator|.
name|second
operator|.
name|first
argument_list|,
name|Entry
operator|.
name|second
operator|.
name|second
argument_list|)
condition|)
return|return
name|EC
return|;
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
block|}
end_decl_stmt

begin_function
name|JITSymbol
name|findStub
parameter_list|(
name|StringRef
name|Name
parameter_list|,
name|bool
name|ExportedStubsOnly
parameter_list|)
function|override
block|{
name|auto
name|I
init|=
name|StubIndexes
operator|.
name|find
argument_list|(
name|Name
argument_list|)
decl_stmt|;
if|if
condition|(
name|I
operator|==
name|StubIndexes
operator|.
name|end
argument_list|()
condition|)
return|return
name|nullptr
return|;
name|auto
name|Key
init|=
name|I
operator|->
name|second
operator|.
name|first
decl_stmt|;
name|auto
name|Flags
init|=
name|I
operator|->
name|second
operator|.
name|second
decl_stmt|;
name|auto
name|StubSymbol
init|=
name|JITSymbol
argument_list|(
name|getStubAddr
argument_list|(
name|Key
argument_list|)
argument_list|,
name|Flags
argument_list|)
decl_stmt|;
if|if
condition|(
name|ExportedStubsOnly
operator|&&
operator|!
name|StubSymbol
operator|.
name|isExported
argument_list|()
condition|)
return|return
name|nullptr
return|;
return|return
name|StubSymbol
return|;
block|}
end_function

begin_function
name|JITSymbol
name|findPointer
parameter_list|(
name|StringRef
name|Name
parameter_list|)
function|override
block|{
name|auto
name|I
init|=
name|StubIndexes
operator|.
name|find
argument_list|(
name|Name
argument_list|)
decl_stmt|;
if|if
condition|(
name|I
operator|==
name|StubIndexes
operator|.
name|end
argument_list|()
condition|)
return|return
name|nullptr
return|;
name|auto
name|Key
init|=
name|I
operator|->
name|second
operator|.
name|first
decl_stmt|;
name|auto
name|Flags
init|=
name|I
operator|->
name|second
operator|.
name|second
decl_stmt|;
return|return
name|JITSymbol
argument_list|(
name|getPtrAddr
argument_list|(
name|Key
argument_list|)
argument_list|,
name|Flags
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
name|std
operator|::
name|error_code
name|updatePointer
argument_list|(
argument|StringRef Name
argument_list|,
argument|TargetAddress NewAddr
argument_list|)
name|override
block|{
name|auto
name|I
operator|=
name|StubIndexes
operator|.
name|find
argument_list|(
name|Name
argument_list|)
block|;
name|assert
argument_list|(
name|I
operator|!=
name|StubIndexes
operator|.
name|end
argument_list|()
operator|&&
literal|"No stub pointer for symbol"
argument_list|)
block|;
name|auto
name|Key
operator|=
name|I
operator|->
name|second
operator|.
name|first
block|;
return|return
name|Remote
operator|.
name|writePointer
argument_list|(
name|getPtrAddr
argument_list|(
name|Key
argument_list|)
argument_list|,
name|NewAddr
argument_list|)
return|;
block|}
end_expr_stmt

begin_label
name|private
label|:
end_label

begin_struct
struct|struct
name|RemoteIndirectStubsInfo
block|{
name|RemoteIndirectStubsInfo
argument_list|(
argument|TargetAddress StubBase
argument_list|,
argument|TargetAddress PtrBase
argument_list|,
argument|unsigned NumStubs
argument_list|)
block|:
name|StubBase
argument_list|(
name|StubBase
argument_list|)
operator|,
name|PtrBase
argument_list|(
name|PtrBase
argument_list|)
operator|,
name|NumStubs
argument_list|(
argument|NumStubs
argument_list|)
block|{}
name|TargetAddress
name|StubBase
expr_stmt|;
name|TargetAddress
name|PtrBase
decl_stmt|;
name|unsigned
name|NumStubs
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|OrcRemoteTargetClient
modifier|&
name|Remote
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|ResourceIdMgr
operator|::
name|ResourceId
name|Id
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|std
operator|::
name|vector
operator|<
name|RemoteIndirectStubsInfo
operator|>
name|RemoteIndirectStubsInfos
expr_stmt|;
end_expr_stmt

begin_typedef
typedef|typedef
name|std
operator|::
name|pair
operator|<
name|uint16_t
operator|,
name|uint16_t
operator|>
name|StubKey
expr_stmt|;
end_typedef

begin_expr_stmt
name|std
operator|::
name|vector
operator|<
name|StubKey
operator|>
name|FreeStubs
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|StringMap
operator|<
name|std
operator|::
name|pair
operator|<
name|StubKey
operator|,
name|JITSymbolFlags
operator|>>
name|StubIndexes
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|std
operator|::
name|error_code
name|reserveStubs
argument_list|(
argument|unsigned NumStubs
argument_list|)
block|{
if|if
condition|(
name|NumStubs
operator|<=
name|FreeStubs
operator|.
name|size
argument_list|()
condition|)
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
name|unsigned
name|NewStubsRequired
operator|=
name|NumStubs
operator|-
name|FreeStubs
operator|.
name|size
argument_list|()
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|TargetAddress
name|StubBase
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|TargetAddress
name|PtrBase
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|NumStubsEmitted
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|Remote
operator|.
name|emitIndirectStubs
argument_list|(
name|StubBase
argument_list|,
name|PtrBase
argument_list|,
name|NumStubsEmitted
argument_list|,
name|Id
argument_list|,
name|NewStubsRequired
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|unsigned
name|NewBlockId
init|=
name|RemoteIndirectStubsInfos
operator|.
name|size
argument_list|()
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|RemoteIndirectStubsInfos
operator|.
name|push_back
argument_list|(
name|RemoteIndirectStubsInfo
argument_list|(
name|StubBase
argument_list|,
name|PtrBase
argument_list|,
name|NumStubsEmitted
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_for
for|for
control|(
name|unsigned
name|I
init|=
literal|0
init|;
name|I
operator|<
name|NumStubsEmitted
condition|;
operator|++
name|I
control|)
name|FreeStubs
operator|.
name|push_back
argument_list|(
name|std
operator|::
name|make_pair
argument_list|(
name|NewBlockId
argument_list|,
name|I
argument_list|)
argument_list|)
expr_stmt|;
end_for

begin_return
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
end_return

begin_expr_stmt
unit|}      std
operator|::
name|error_code
name|createStubInternal
argument_list|(
argument|StringRef StubName
argument_list|,
argument|TargetAddress InitAddr
argument_list|,
argument|JITSymbolFlags StubFlags
argument_list|)
block|{
name|auto
name|Key
operator|=
name|FreeStubs
operator|.
name|back
argument_list|()
block|;
name|FreeStubs
operator|.
name|pop_back
argument_list|()
block|;
name|StubIndexes
index|[
name|StubName
index|]
operator|=
name|std
operator|::
name|make_pair
argument_list|(
name|Key
argument_list|,
name|StubFlags
argument_list|)
block|;
return|return
name|Remote
operator|.
name|writePointer
argument_list|(
name|getPtrAddr
argument_list|(
name|Key
argument_list|)
argument_list|,
name|InitAddr
argument_list|)
return|;
block|}
end_expr_stmt

begin_function
name|TargetAddress
name|getStubAddr
parameter_list|(
name|StubKey
name|K
parameter_list|)
block|{
name|assert
argument_list|(
name|RemoteIndirectStubsInfos
index|[
name|K
operator|.
name|first
index|]
operator|.
name|StubBase
operator|!=
literal|0
operator|&&
literal|"Missing stub address"
argument_list|)
expr_stmt|;
return|return
name|RemoteIndirectStubsInfos
index|[
name|K
operator|.
name|first
index|]
operator|.
name|StubBase
operator|+
name|K
operator|.
name|second
operator|*
name|Remote
operator|.
name|getIndirectStubSize
argument_list|()
return|;
block|}
end_function

begin_function
name|TargetAddress
name|getPtrAddr
parameter_list|(
name|StubKey
name|K
parameter_list|)
block|{
name|assert
argument_list|(
name|RemoteIndirectStubsInfos
index|[
name|K
operator|.
name|first
index|]
operator|.
name|PtrBase
operator|!=
literal|0
operator|&&
literal|"Missing pointer address"
argument_list|)
expr_stmt|;
return|return
name|RemoteIndirectStubsInfos
index|[
name|K
operator|.
name|first
index|]
operator|.
name|PtrBase
operator|+
name|K
operator|.
name|second
operator|*
name|Remote
operator|.
name|getPointerSize
argument_list|()
return|;
block|}
end_function

begin_comment
unit|};
comment|/// Remote compile callback manager.
end_comment

begin_decl_stmt
name|class
name|RCCompileCallbackManager
range|:
name|public
name|JITCompileCallbackManager
block|{
name|public
operator|:
name|RCCompileCallbackManager
argument_list|(
argument|TargetAddress ErrorHandlerAddress
argument_list|,
argument|OrcRemoteTargetClient&Remote
argument_list|)
operator|:
name|JITCompileCallbackManager
argument_list|(
name|ErrorHandlerAddress
argument_list|)
block|,
name|Remote
argument_list|(
argument|Remote
argument_list|)
block|{
name|assert
argument_list|(
operator|!
name|Remote
operator|.
name|CompileCallback
operator|&&
literal|"Compile callback already set"
argument_list|)
block|;
name|Remote
operator|.
name|CompileCallback
operator|=
index|[
name|this
index|]
operator|(
name|TargetAddress
name|TrampolineAddr
operator|)
block|{
return|return
name|executeCompileCallback
argument_list|(
name|TrampolineAddr
argument_list|)
return|;
block|}
block|;
name|Remote
operator|.
name|emitResolverBlock
argument_list|()
block|;     }
name|private
operator|:
name|void
name|grow
argument_list|()
block|{
name|TargetAddress
name|BlockAddr
operator|=
literal|0
block|;
name|uint32_t
name|NumTrampolines
operator|=
literal|0
block|;
name|auto
name|EC
operator|=
name|Remote
operator|.
name|emitTrampolineBlock
argument_list|(
name|BlockAddr
argument_list|,
name|NumTrampolines
argument_list|)
block|;
name|assert
argument_list|(
operator|!
name|EC
operator|&&
literal|"Failed to create trampolines"
argument_list|)
block|;
name|uint32_t
name|TrampolineSize
operator|=
name|Remote
operator|.
name|getTrampolineSize
argument_list|()
block|;
for|for
control|(
name|unsigned
name|I
init|=
literal|0
init|;
name|I
operator|<
name|NumTrampolines
condition|;
operator|++
name|I
control|)
name|this
operator|->
name|AvailableTrampolines
operator|.
name|push_back
argument_list|(
name|BlockAddr
operator|+
operator|(
name|I
operator|*
name|TrampolineSize
operator|)
argument_list|)
expr_stmt|;
block|}
name|OrcRemoteTargetClient
operator|&
name|Remote
block|;   }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/// Create an OrcRemoteTargetClient.
end_comment

begin_comment
comment|/// Channel is the ChannelT instance to communicate on. It is assumed that
end_comment

begin_comment
comment|/// the channel is ready to be read from and written to.
end_comment

begin_expr_stmt
specifier|static
name|ErrorOr
operator|<
name|OrcRemoteTargetClient
operator|>
name|Create
argument_list|(
argument|ChannelT&Channel
argument_list|)
block|{
name|std
operator|::
name|error_code
name|EC
block|;
name|OrcRemoteTargetClient
name|H
argument_list|(
name|Channel
argument_list|,
name|EC
argument_list|)
block|;
if|if
condition|(
name|EC
condition|)
return|return
name|EC
return|;
end_expr_stmt

begin_return
return|return
name|H
return|;
end_return

begin_comment
unit|}
comment|/// Call the int(void) function at the given address in the target and return
end_comment

begin_comment
comment|/// its result.
end_comment

begin_expr_stmt
unit|std
operator|::
name|error_code
name|callIntVoid
argument_list|(
argument|int&Result
argument_list|,
argument|TargetAddress Addr
argument_list|)
block|{
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Calling int(*)(void) "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|Addr
argument_list|)
operator|<<
literal|"\n"
argument_list|)
block|;
if|if
condition|(
name|auto
name|EC
init|=
name|call
operator|<
name|CallIntVoid
operator|>
operator|(
name|Channel
expr|,
name|Addr
operator|)
condition|)
return|return
name|EC
return|;
name|unsigned
name|NextProcId
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|auto
name|EC
init|=
name|listenForCompileRequests
argument_list|(
name|NextProcId
argument_list|)
condition|)
return|return
name|EC
return|;
end_if

begin_if
if|if
condition|(
name|NextProcId
operator|!=
name|CallIntVoidResponseId
condition|)
return|return
name|orcError
argument_list|(
name|OrcErrorCode
operator|::
name|UnexpectedRPCCall
argument_list|)
return|;
end_if

begin_return
return|return
name|handle
operator|<
name|CallIntVoidResponse
operator|>
operator|(
name|Channel
operator|,
index|[
operator|&
index|]
operator|(
name|int
name|R
operator|)
block|{
name|Result
operator|=
name|R
block|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Result: "
operator|<<
name|R
operator|<<
literal|"\n"
argument_list|)
block|;
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
block|}
end_return

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_comment
unit|}
comment|/// Call the int(int, char*[]) function at the given address in the target and
end_comment

begin_comment
comment|/// return its result.
end_comment

begin_expr_stmt
unit|std
operator|::
name|error_code
name|callMain
argument_list|(
argument|int&Result
argument_list|,
argument|TargetAddress Addr
argument_list|,
argument|const std::vector<std::string>&Args
argument_list|)
block|{
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Calling int(*)(int, char*[]) "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|Addr
argument_list|)
operator|<<
literal|"\n"
argument_list|)
block|;
if|if
condition|(
name|auto
name|EC
init|=
name|call
operator|<
name|CallMain
operator|>
operator|(
name|Channel
expr|,
name|Addr
expr|,
name|Args
operator|)
condition|)
return|return
name|EC
return|;
name|unsigned
name|NextProcId
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|auto
name|EC
init|=
name|listenForCompileRequests
argument_list|(
name|NextProcId
argument_list|)
condition|)
return|return
name|EC
return|;
end_if

begin_if
if|if
condition|(
name|NextProcId
operator|!=
name|CallMainResponseId
condition|)
return|return
name|orcError
argument_list|(
name|OrcErrorCode
operator|::
name|UnexpectedRPCCall
argument_list|)
return|;
end_if

begin_return
return|return
name|handle
operator|<
name|CallMainResponse
operator|>
operator|(
name|Channel
operator|,
index|[
operator|&
index|]
operator|(
name|int
name|R
operator|)
block|{
name|Result
operator|=
name|R
block|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Result: "
operator|<<
name|R
operator|<<
literal|"\n"
argument_list|)
block|;
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
block|}
end_return

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_comment
unit|}
comment|/// Call the void() function at the given address in the target and wait for
end_comment

begin_comment
comment|/// it to finish.
end_comment

begin_expr_stmt
unit|std
operator|::
name|error_code
name|callVoidVoid
argument_list|(
argument|TargetAddress Addr
argument_list|)
block|{
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Calling void(*)(void) "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|Addr
argument_list|)
operator|<<
literal|"\n"
argument_list|)
block|;
if|if
condition|(
name|auto
name|EC
init|=
name|call
operator|<
name|CallVoidVoid
operator|>
operator|(
name|Channel
expr|,
name|Addr
operator|)
condition|)
return|return
name|EC
return|;
name|unsigned
name|NextProcId
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|auto
name|EC
init|=
name|listenForCompileRequests
argument_list|(
name|NextProcId
argument_list|)
condition|)
return|return
name|EC
return|;
end_if

begin_if
if|if
condition|(
name|NextProcId
operator|!=
name|CallVoidVoidResponseId
condition|)
return|return
name|orcError
argument_list|(
name|OrcErrorCode
operator|::
name|UnexpectedRPCCall
argument_list|)
return|;
end_if

begin_return
return|return
name|handle
operator|<
name|CallVoidVoidResponse
operator|>
operator|(
name|Channel
operator|,
name|doNothing
operator|)
return|;
end_return

begin_comment
unit|}
comment|/// Create an RCMemoryManager which will allocate its memory on the remote
end_comment

begin_comment
comment|/// target.
end_comment

begin_expr_stmt
unit|std
operator|::
name|error_code
name|createRemoteMemoryManager
argument_list|(
argument|std::unique_ptr<RCMemoryManager>&MM
argument_list|)
block|{
name|assert
argument_list|(
operator|!
name|MM
operator|&&
literal|"MemoryManager should be null before creation."
argument_list|)
block|;
name|auto
name|Id
operator|=
name|AllocatorIds
operator|.
name|getNext
argument_list|()
block|;
if|if
condition|(
name|auto
name|EC
init|=
name|call
operator|<
name|CreateRemoteAllocator
operator|>
operator|(
name|Channel
expr|,
name|Id
operator|)
condition|)
return|return
name|EC
return|;
name|MM
operator|=
name|llvm
operator|::
name|make_unique
operator|<
name|RCMemoryManager
operator|>
operator|(
operator|*
name|this
operator|,
name|Id
operator|)
expr_stmt|;
end_expr_stmt

begin_return
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
end_return

begin_comment
unit|}
comment|/// Create an RCIndirectStubsManager that will allocate stubs on the remote
end_comment

begin_comment
comment|/// target.
end_comment

begin_expr_stmt
unit|std
operator|::
name|error_code
name|createIndirectStubsManager
argument_list|(
argument|std::unique_ptr<RCIndirectStubsManager>&I
argument_list|)
block|{
name|assert
argument_list|(
operator|!
name|I
operator|&&
literal|"Indirect stubs manager should be null before creation."
argument_list|)
block|;
name|auto
name|Id
operator|=
name|IndirectStubOwnerIds
operator|.
name|getNext
argument_list|()
block|;
if|if
condition|(
name|auto
name|EC
init|=
name|call
operator|<
name|CreateIndirectStubsOwner
operator|>
operator|(
name|Channel
expr|,
name|Id
operator|)
condition|)
return|return
name|EC
return|;
name|I
operator|=
name|llvm
operator|::
name|make_unique
operator|<
name|RCIndirectStubsManager
operator|>
operator|(
operator|*
name|this
operator|,
name|Id
operator|)
expr_stmt|;
end_expr_stmt

begin_return
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
end_return

begin_comment
unit|}
comment|/// Search for symbols in the remote process. Note: This should be used by
end_comment

begin_comment
comment|/// symbol resolvers *after* they've searched the local symbol table in the
end_comment

begin_comment
comment|/// JIT stack.
end_comment

begin_expr_stmt
unit|std
operator|::
name|error_code
name|getSymbolAddress
argument_list|(
argument|TargetAddress&Addr
argument_list|,
argument|StringRef Name
argument_list|)
block|{
comment|// Check for an 'out-of-band' error, e.g. from an MM destructor.
if|if
condition|(
name|ExistingError
condition|)
return|return
name|ExistingError
return|;
end_expr_stmt

begin_comment
comment|// Request remote symbol address.
end_comment

begin_if
if|if
condition|(
name|auto
name|EC
init|=
name|call
operator|<
name|GetSymbolAddress
operator|>
operator|(
name|Channel
expr|,
name|Name
operator|)
condition|)
return|return
name|EC
return|;
end_if

begin_return
return|return
name|expect
operator|<
name|GetSymbolAddressResponse
operator|>
operator|(
name|Channel
operator|,
index|[
operator|&
index|]
operator|(
name|TargetAddress
operator|&
name|A
operator|)
block|{
name|Addr
operator|=
name|A
block|;
name|DEBUG
argument_list|(
name|dbgs
argument_list|()
operator|<<
literal|"Remote address lookup "
operator|<<
name|Name
operator|<<
literal|" = "
operator|<<
name|format
argument_list|(
literal|"0x%016x"
argument_list|,
name|Addr
argument_list|)
operator|<<
literal|"\n"
argument_list|)
block|;
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
block|}
end_return

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_comment
unit|}
comment|/// Get the triple for the remote target.
end_comment

begin_expr_stmt
unit|const
name|std
operator|::
name|string
operator|&
name|getTargetTriple
argument_list|()
specifier|const
block|{
return|return
name|RemoteTargetTriple
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|std
operator|::
name|error_code
name|terminateSession
argument_list|()
block|{
return|return
name|call
operator|<
name|TerminateSession
operator|>
operator|(
name|Channel
operator|)
return|;
block|}
end_expr_stmt

begin_label
name|private
label|:
end_label

begin_expr_stmt
name|OrcRemoteTargetClient
argument_list|(
name|ChannelT
operator|&
name|Channel
argument_list|,
name|std
operator|::
name|error_code
operator|&
name|EC
argument_list|)
operator|:
name|Channel
argument_list|(
name|Channel
argument_list|)
operator|,
name|RemotePointerSize
argument_list|(
literal|0
argument_list|)
operator|,
name|RemotePageSize
argument_list|(
literal|0
argument_list|)
operator|,
name|RemoteTrampolineSize
argument_list|(
literal|0
argument_list|)
operator|,
name|RemoteIndirectStubSize
argument_list|(
literal|0
argument_list|)
block|{
if|if
condition|(
operator|(
name|EC
operator|=
name|call
operator|<
name|GetRemoteInfo
operator|>
operator|(
name|Channel
operator|)
operator|)
condition|)
return|return;
name|EC
operator|=
name|expect
operator|<
name|GetRemoteInfoResponse
operator|>
operator|(
name|Channel
operator|,
name|readArgs
argument_list|(
name|RemoteTargetTriple
argument_list|,
name|RemotePointerSize
argument_list|,
name|RemotePageSize
argument_list|,
name|RemoteTrampolineSize
argument_list|,
name|RemoteIndirectStubSize
argument_list|)
operator|)
expr_stmt|;
end_expr_stmt

begin_macro
unit|}    void
name|destroyRemoteAllocator
argument_list|(
argument|ResourceIdMgr::ResourceId Id
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|auto
name|EC
init|=
name|call
operator|<
name|DestroyRemoteAllocator
operator|>
operator|(
name|Channel
expr|,
name|Id
operator|)
condition|)
block|{
comment|// FIXME: This will be triggered by a removeModuleSet call: Propagate
comment|//        error return up through that.
name|llvm_unreachable
argument_list|(
literal|"Failed to destroy remote allocator."
argument_list|)
expr_stmt|;
name|AllocatorIds
operator|.
name|release
argument_list|(
name|Id
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|std
operator|::
name|error_code
name|destroyIndirectStubsManager
argument_list|(
argument|ResourceIdMgr::ResourceId Id
argument_list|)
block|{
name|IndirectStubOwnerIds
operator|.
name|release
argument_list|(
name|Id
argument_list|)
block|;
return|return
name|call
operator|<
name|DestroyIndirectStubsOwner
operator|>
operator|(
name|Channel
operator|,
name|Id
operator|)
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|std
operator|::
name|error_code
name|emitIndirectStubs
argument_list|(
argument|TargetAddress&StubBase
argument_list|,
argument|TargetAddress&PtrBase
argument_list|,
argument|uint32_t&NumStubsEmitted
argument_list|,
argument|ResourceIdMgr::ResourceId Id
argument_list|,
argument|uint32_t NumStubsRequired
argument_list|)
block|{
if|if
condition|(
name|auto
name|EC
init|=
name|call
operator|<
name|EmitIndirectStubs
operator|>
operator|(
name|Channel
expr|,
name|Id
expr|,
name|NumStubsRequired
operator|)
condition|)
return|return
name|EC
return|;
end_expr_stmt

begin_return
return|return
name|expect
operator|<
name|EmitIndirectStubsResponse
operator|>
operator|(
name|Channel
operator|,
name|readArgs
argument_list|(
name|StubBase
argument_list|,
name|PtrBase
argument_list|,
name|NumStubsEmitted
argument_list|)
operator|)
return|;
end_return

begin_expr_stmt
unit|}    std
operator|::
name|error_code
name|emitResolverBlock
argument_list|()
block|{
comment|// Check for an 'out-of-band' error, e.g. from an MM destructor.
if|if
condition|(
name|ExistingError
condition|)
return|return
name|ExistingError
return|;
end_expr_stmt

begin_return
return|return
name|call
operator|<
name|EmitResolverBlock
operator|>
operator|(
name|Channel
operator|)
return|;
end_return

begin_expr_stmt
unit|}    std
operator|::
name|error_code
name|emitTrampolineBlock
argument_list|(
argument|TargetAddress&BlockAddr
argument_list|,
argument|uint32_t&NumTrampolines
argument_list|)
block|{
comment|// Check for an 'out-of-band' error, e.g. from an MM destructor.
if|if
condition|(
name|ExistingError
condition|)
return|return
name|ExistingError
return|;
end_expr_stmt

begin_if
if|if
condition|(
name|auto
name|EC
init|=
name|call
operator|<
name|EmitTrampolineBlock
operator|>
operator|(
name|Channel
operator|)
condition|)
return|return
name|EC
return|;
end_if

begin_return
return|return
name|expect
operator|<
name|EmitTrampolineBlockResponse
operator|>
operator|(
name|Channel
operator|,
index|[
operator|&
index|]
operator|(
name|TargetAddress
name|BAddr
operator|,
name|uint32_t
name|NTrampolines
operator|)
block|{
name|BlockAddr
operator|=
name|BAddr
block|;
name|NumTrampolines
operator|=
name|NTrampolines
block|;
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
block|}
end_return

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_macro
unit|}    uint32_t
name|getIndirectStubSize
argument_list|()
end_macro

begin_expr_stmt
specifier|const
block|{
return|return
name|RemoteIndirectStubSize
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|uint32_t
name|getPageSize
argument_list|()
specifier|const
block|{
return|return
name|RemotePageSize
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|uint32_t
name|getPointerSize
argument_list|()
specifier|const
block|{
return|return
name|RemotePointerSize
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|uint32_t
name|getTrampolineSize
argument_list|()
specifier|const
block|{
return|return
name|RemoteTrampolineSize
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|std
operator|::
name|error_code
name|listenForCompileRequests
argument_list|(
argument|uint32_t&NextId
argument_list|)
block|{
comment|// Check for an 'out-of-band' error, e.g. from an MM destructor.
if|if
condition|(
name|ExistingError
condition|)
return|return
name|ExistingError
return|;
end_expr_stmt

begin_if
if|if
condition|(
name|auto
name|EC
init|=
name|getNextProcId
argument_list|(
name|Channel
argument_list|,
name|NextId
argument_list|)
condition|)
return|return
name|EC
return|;
end_if

begin_while
while|while
condition|(
name|NextId
operator|==
name|RequestCompileId
condition|)
block|{
name|TargetAddress
name|TrampolineAddr
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|auto
name|EC
init|=
name|handle
operator|<
name|RequestCompile
operator|>
operator|(
name|Channel
expr|,
name|readArgs
argument_list|(
name|TrampolineAddr
argument_list|)
operator|)
condition|)
return|return
name|EC
return|;
name|TargetAddress
name|ImplAddr
init|=
name|CompileCallback
argument_list|(
name|TrampolineAddr
argument_list|)
decl_stmt|;
if|if
condition|(
name|auto
name|EC
init|=
name|call
operator|<
name|RequestCompileResponse
operator|>
operator|(
name|Channel
expr|,
name|ImplAddr
operator|)
condition|)
return|return
name|EC
return|;
if|if
condition|(
name|auto
name|EC
init|=
name|getNextProcId
argument_list|(
name|Channel
argument_list|,
name|NextId
argument_list|)
condition|)
return|return
name|EC
return|;
block|}
end_while

begin_return
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
end_return

begin_expr_stmt
unit|}    std
operator|::
name|error_code
name|readMem
argument_list|(
argument|char *Dst
argument_list|,
argument|TargetAddress Src
argument_list|,
argument|uint64_t Size
argument_list|)
block|{
comment|// Check for an 'out-of-band' error, e.g. from an MM destructor.
if|if
condition|(
name|ExistingError
condition|)
return|return
name|ExistingError
return|;
end_expr_stmt

begin_if
if|if
condition|(
name|auto
name|EC
init|=
name|call
operator|<
name|ReadMem
operator|>
operator|(
name|Channel
expr|,
name|Src
expr|,
name|Size
operator|)
condition|)
return|return
name|EC
return|;
end_if

begin_if
if|if
condition|(
name|auto
name|EC
init|=
name|expect
operator|<
name|ReadMemResponse
operator|>
operator|(
name|Channel
expr|,
index|[
operator|&
index|]
operator|(
operator|)
block|{
return|return
name|Channel
operator|.
name|readBytes
argument_list|(
name|Dst
argument_list|,
name|Size
argument_list|)
return|;
block|}
end_if

begin_return
unit|))
return|return
name|EC
return|;
end_return

begin_return
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
end_return

begin_expr_stmt
unit|}    std
operator|::
name|error_code
name|reserveMem
argument_list|(
argument|TargetAddress&RemoteAddr
argument_list|,
argument|ResourceIdMgr::ResourceId Id
argument_list|,
argument|uint64_t Size
argument_list|,
argument|uint32_t Align
argument_list|)
block|{
comment|// Check for an 'out-of-band' error, e.g. from an MM destructor.
if|if
condition|(
name|ExistingError
condition|)
return|return
name|ExistingError
return|;
end_expr_stmt

begin_if
if|if
condition|(
name|std
operator|::
name|error_code
name|EC
operator|=
name|call
operator|<
name|ReserveMem
operator|>
operator|(
name|Channel
operator|,
name|Id
operator|,
name|Size
operator|,
name|Align
operator|)
condition|)
return|return
name|EC
return|;
end_if

begin_return
return|return
name|expect
operator|<
name|ReserveMemResponse
operator|>
operator|(
name|Channel
operator|,
name|readArgs
argument_list|(
name|RemoteAddr
argument_list|)
operator|)
return|;
end_return

begin_expr_stmt
unit|}    std
operator|::
name|error_code
name|setProtections
argument_list|(
argument|ResourceIdMgr::ResourceId Id
argument_list|,
argument|TargetAddress RemoteSegAddr
argument_list|,
argument|unsigned ProtFlags
argument_list|)
block|{
return|return
name|call
operator|<
name|SetProtections
operator|>
operator|(
name|Channel
operator|,
name|Id
operator|,
name|RemoteSegAddr
operator|,
name|ProtFlags
operator|)
return|;
block|}
end_expr_stmt

begin_expr_stmt
name|std
operator|::
name|error_code
name|writeMem
argument_list|(
argument|TargetAddress Addr
argument_list|,
argument|const char *Src
argument_list|,
argument|uint64_t Size
argument_list|)
block|{
comment|// Check for an 'out-of-band' error, e.g. from an MM destructor.
if|if
condition|(
name|ExistingError
condition|)
return|return
name|ExistingError
return|;
end_expr_stmt

begin_comment
comment|// Make the send call.
end_comment

begin_if
if|if
condition|(
name|auto
name|EC
init|=
name|call
operator|<
name|WriteMem
operator|>
operator|(
name|Channel
expr|,
name|Addr
expr|,
name|Size
operator|)
condition|)
return|return
name|EC
return|;
end_if

begin_comment
comment|// Follow this up with the section contents.
end_comment

begin_if
if|if
condition|(
name|auto
name|EC
init|=
name|Channel
operator|.
name|appendBytes
argument_list|(
name|Src
argument_list|,
name|Size
argument_list|)
condition|)
return|return
name|EC
return|;
end_if

begin_return
return|return
name|Channel
operator|.
name|send
argument_list|()
return|;
end_return

begin_expr_stmt
unit|}    std
operator|::
name|error_code
name|writePointer
argument_list|(
argument|TargetAddress Addr
argument_list|,
argument|TargetAddress PtrVal
argument_list|)
block|{
comment|// Check for an 'out-of-band' error, e.g. from an MM destructor.
if|if
condition|(
name|ExistingError
condition|)
return|return
name|ExistingError
return|;
end_expr_stmt

begin_return
return|return
name|call
operator|<
name|WritePtr
operator|>
operator|(
name|Channel
operator|,
name|Addr
operator|,
name|PtrVal
operator|)
return|;
end_return

begin_expr_stmt
unit|}    static
name|std
operator|::
name|error_code
name|doNothing
argument_list|()
block|{
return|return
name|std
operator|::
name|error_code
argument_list|()
return|;
block|}
end_expr_stmt

begin_decl_stmt
name|ChannelT
modifier|&
name|Channel
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|std
operator|::
name|error_code
name|ExistingError
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|std
operator|::
name|string
name|RemoteTargetTriple
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|uint32_t
name|RemotePointerSize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|RemotePageSize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|RemoteTrampolineSize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|RemoteIndirectStubSize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ResourceIdMgr
name|AllocatorIds
decl_stmt|,
name|IndirectStubOwnerIds
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|std
operator|::
name|function
operator|<
name|TargetAddress
argument_list|(
name|TargetAddress
argument_list|)
operator|>
name|CompileCallback
expr_stmt|;
end_expr_stmt

begin_comment
unit|};  }
comment|// end namespace remote
end_comment

begin_comment
unit|}
comment|// end namespace orc
end_comment

begin_comment
unit|}
comment|// end namespace llvm
end_comment

begin_undef
undef|#
directive|undef
name|DEBUG_TYPE
end_undef

begin_endif
endif|#
directive|endif
end_endif

end_unit


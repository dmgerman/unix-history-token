begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * (c) Magerya Vitaly  *  * Copying and distribution of this file, with or without modification,  * are permitted in any medium without royalty provided the copyright  * notice and this notice are preserved. This file is offered as-is,  * without any warranty.  */
end_comment

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_comment
comment|/* General utilities.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|progname
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|countof
parameter_list|(
name|array
parameter_list|)
value|(sizeof(array)/sizeof(*(array)))
end_define

begin_function
specifier|static
name|void
name|die
parameter_list|(
name|int
name|code
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: "
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|fmt
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ndots
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
operator|(
name|name
operator|=
name|strchr
argument_list|(
name|name
argument_list|,
literal|'.'
argument_list|)
operator|)
condition|;
name|n
operator|++
operator|,
name|name
operator|++
control|)
empty_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_comment
comment|/* General LDNS-specific utilities.  */
end_comment

begin_function
specifier|static
name|ldns_status
name|ldns_resolver_new_default
parameter_list|(
name|ldns_resolver
modifier|*
modifier|*
name|res
parameter_list|)
block|{
if|if
condition|(
name|ldns_resolver_new_frm_file
argument_list|(
name|res
argument_list|,
name|NULL
argument_list|)
operator|==
name|LDNS_STATUS_OK
operator|||
operator|(
operator|*
name|res
operator|=
name|ldns_resolver_new
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
return|return
name|LDNS_STATUS_OK
return|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_status
name|ldns_resolver_push_default_servers
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|)
block|{
name|ldns_status
name|status
decl_stmt|;
name|ldns_rdf
modifier|*
name|addr
decl_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|ldns_str2rdf_a
argument_list|(
operator|&
name|addr
argument_list|,
literal|"127.0.0.1"
argument_list|)
operator|)
operator|!=
name|LDNS_STATUS_OK
operator|||
operator|(
name|status
operator|=
name|ldns_resolver_push_nameserver
argument_list|(
name|res
argument_list|,
name|addr
argument_list|)
operator|)
operator|!=
name|LDNS_STATUS_OK
condition|)
return|return
name|ldns_rdf_deep_free
argument_list|(
name|addr
argument_list|)
operator|,
name|status
return|;
name|ldns_rdf_deep_free
argument_list|(
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|ldns_str2rdf_aaaa
argument_list|(
operator|&
name|addr
argument_list|,
literal|"::1"
argument_list|)
operator|)
operator|!=
name|LDNS_STATUS_OK
operator|||
operator|(
name|status
operator|=
name|ldns_resolver_push_nameserver
argument_list|(
name|res
argument_list|,
name|addr
argument_list|)
operator|)
operator|!=
name|LDNS_STATUS_OK
condition|)
return|return
name|ldns_rdf_deep_free
argument_list|(
name|addr
argument_list|)
operator|,
name|status
return|;
name|ldns_rdf_deep_free
argument_list|(
name|addr
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_rdf
modifier|*
name|ldns_rdf_new_addr_frm_str
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|addr
decl_stmt|;
if|if
condition|(
operator|(
name|addr
operator|=
name|ldns_rdf_new_frm_str
argument_list|(
name|LDNS_RDF_TYPE_A
argument_list|,
name|str
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|addr
operator|=
name|ldns_rdf_new_frm_str
argument_list|(
name|LDNS_RDF_TYPE_AAAA
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
name|addr
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ldns_resolver_remove_nameservers
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|)
block|{
while|while
condition|(
name|ldns_resolver_nameserver_count
argument_list|(
name|res
argument_list|)
operator|>
literal|0
condition|)
name|ldns_rdf_deep_free
argument_list|(
name|ldns_resolver_pop_nameserver
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ldns_rdf
modifier|*
name|ldns_rdf_reverse_a
parameter_list|(
name|ldns_rdf
modifier|*
name|addr
parameter_list|,
specifier|const
name|char
modifier|*
name|base
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|base
argument_list|)
expr_stmt|;
name|buf
operator|=
name|alloca
argument_list|(
name|LDNS_IP4ADDRLEN
operator|*
literal|4
operator|+
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|len
operator|=
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LDNS_IP4ADDRLEN
condition|;
name|i
operator|++
control|)
name|len
operator|+=
name|sprintf
argument_list|(
operator|&
name|buf
index|[
name|len
index|]
argument_list|,
literal|"%d."
argument_list|,
operator|(
name|int
operator|)
name|ldns_rdf_data
argument_list|(
name|addr
argument_list|)
index|[
name|LDNS_IP4ADDRLEN
operator|-
name|i
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
operator|&
name|buf
index|[
name|len
index|]
argument_list|,
literal|"%s"
argument_list|,
name|base
argument_list|)
expr_stmt|;
return|return
name|ldns_dname_new_frm_str
argument_list|(
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_rdf
modifier|*
name|ldns_rdf_reverse_aaaa
parameter_list|(
name|ldns_rdf
modifier|*
name|addr
parameter_list|,
specifier|const
name|char
modifier|*
name|base
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|base
argument_list|)
expr_stmt|;
name|buf
operator|=
name|alloca
argument_list|(
name|LDNS_IP6ADDRLEN
operator|*
literal|4
operator|+
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LDNS_IP6ADDRLEN
condition|;
name|i
operator|++
control|)
block|{
name|uint8_t
name|byte
init|=
name|ldns_rdf_data
argument_list|(
name|addr
argument_list|)
index|[
name|LDNS_IP6ADDRLEN
operator|-
name|i
operator|-
literal|1
index|]
decl_stmt|;
name|sprintf
argument_list|(
operator|&
name|buf
index|[
name|i
operator|*
literal|4
index|]
argument_list|,
literal|"%x.%x."
argument_list|,
name|byte
operator|&
literal|0x0F
argument_list|,
name|byte
operator|>>
literal|4
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
operator|&
name|buf
index|[
name|LDNS_IP6ADDRLEN
operator|*
literal|4
index|]
argument_list|,
literal|"%s"
argument_list|,
name|base
argument_list|)
expr_stmt|;
return|return
name|ldns_dname_new_frm_str
argument_list|(
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_status
name|ldns_pkt_push_rr_soa
parameter_list|(
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|ldns_pkt_section
name|sec
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|ldns_rr_class
name|c
parameter_list|,
name|uint32_t
name|serial
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|rdf
decl_stmt|;
name|ldns_rr
modifier|*
name|rr
decl_stmt|;
name|uint32_t
name|n
decl_stmt|;
if|if
condition|(
operator|(
name|rr
operator|=
name|ldns_rr_new_frm_type
argument_list|(
name|LDNS_RR_TYPE_SOA
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
name|ldns_rr_set_class
argument_list|(
name|rr
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|ldns_rr_set_owner
argument_list|(
name|rr
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_set_ttl
argument_list|(
name|rr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|rdf
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_DNAME
argument_list|,
literal|1
argument_list|,
operator|&
name|n
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|memerr
goto|;
name|ldns_rr_set_rdf
argument_list|(
name|rr
argument_list|,
name|rdf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_rr_set_rdf
argument_list|(
name|rr
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|rdf
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|n
operator|=
name|htonl
argument_list|(
name|serial
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdf
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_INT32
argument_list|,
literal|4
argument_list|,
operator|&
name|n
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|memerr
goto|;
name|ldns_rr_set_rdf
argument_list|(
name|rr
argument_list|,
name|rdf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|rdf
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_PERIOD
argument_list|,
literal|4
argument_list|,
operator|&
name|n
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|memerr
goto|;
name|ldns_rr_set_rdf
argument_list|(
name|rr
argument_list|,
name|rdf
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ldns_rr_set_rdf
argument_list|(
name|rr
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|rdf
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ldns_rr_set_rdf
argument_list|(
name|rr
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|rdf
argument_list|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|ldns_rr_set_rdf
argument_list|(
name|rr
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|rdf
argument_list|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
literal|1
argument_list|)
operator|==
name|NULL
operator|||
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
literal|4
argument_list|)
operator|==
name|NULL
operator|||
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
literal|5
argument_list|)
operator|==
name|NULL
operator|||
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
literal|6
argument_list|)
operator|==
name|NULL
operator|||
operator|!
name|ldns_pkt_push_rr
argument_list|(
name|pkt
argument_list|,
name|sec
argument_list|,
name|rr
argument_list|)
condition|)
goto|goto
name|memerr
goto|;
return|return
name|LDNS_STATUS_OK
return|;
name|memerr
label|:
name|ldns_rr_free
argument_list|(
name|rr
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|ldns_rr_soa_get_serial
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
specifier|const
name|ldns_rdf
modifier|*
name|rdf
decl_stmt|;
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|!=
name|LDNS_RR_TYPE_SOA
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ldns_rr_rd_count
argument_list|(
name|rr
argument_list|)
operator|!=
literal|7
condition|)
return|return
literal|0
return|;
name|rdf
operator|=
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rdf_get_type
argument_list|(
name|rdf
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_INT32
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ldns_rdf_size
argument_list|(
name|rdf
argument_list|)
operator|!=
literal|4
condition|)
return|return
literal|0
return|;
return|return
name|ldns_rdf2native_int32
argument_list|(
name|rdf
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_status
name|ldns_tcp_start
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_pkt
modifier|*
name|qpkt
parameter_list|,
name|int
name|nameserver
parameter_list|)
block|{
comment|/* This routine is based on ldns_axfr_start, with the major      * difference in that it takes a query packet explicitly.      */
name|struct
name|sockaddr_storage
modifier|*
name|ns
init|=
name|NULL
decl_stmt|;
name|size_t
name|ns_len
init|=
literal|0
decl_stmt|;
name|ldns_buffer
modifier|*
name|qbuf
init|=
name|NULL
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|ns
operator|=
name|ldns_rdf2native_sockaddr_storage
argument_list|(
name|res
operator|->
name|_nameservers
index|[
name|nameserver
index|]
argument_list|,
name|ldns_resolver_port
argument_list|(
name|res
argument_list|)
argument_list|,
operator|&
name|ns_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ns
operator|==
name|NULL
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_MEM_ERR
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|res
operator|->
name|_socket
operator|=
name|ldns_tcp_connect
argument_list|(
name|ns
argument_list|,
operator|(
name|socklen_t
operator|)
name|ns_len
argument_list|,
name|ldns_resolver_timeout
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|_socket
operator|<=
literal|0
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_ADDRESS_ERR
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|qbuf
operator|=
name|ldns_buffer_new
argument_list|(
name|LDNS_MAX_PACKETLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|qbuf
operator|==
name|NULL
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_MEM_ERR
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|status
operator|=
name|ldns_pkt2buffer_wire
argument_list|(
name|qbuf
argument_list|,
name|qpkt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|ldns_tcp_send_query
argument_list|(
name|qbuf
argument_list|,
name|res
operator|->
name|_socket
argument_list|,
name|ns
argument_list|,
operator|(
name|socklen_t
operator|)
name|ns_len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_NETWORK_ERR
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ldns_buffer_free
argument_list|(
name|qbuf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ns
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
name|error
label|:
name|ldns_buffer_free
argument_list|(
name|qbuf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ns
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|_socket
operator|>
literal|0
condition|)
block|{
name|close
argument_list|(
name|res
operator|->
name|_socket
argument_list|)
expr_stmt|;
name|res
operator|->
name|_socket
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_status
name|ldns_tcp_read
parameter_list|(
name|ldns_pkt
modifier|*
modifier|*
name|answer
parameter_list|,
name|ldns_resolver
modifier|*
name|res
parameter_list|)
block|{
name|ldns_status
name|status
decl_stmt|;
name|struct
name|timeval
name|t1
decl_stmt|,
name|t2
decl_stmt|;
name|uint8_t
modifier|*
name|data
decl_stmt|;
name|size_t
name|size
decl_stmt|;
if|if
condition|(
name|res
operator|->
name|_socket
operator|<=
literal|0
condition|)
return|return
name|LDNS_STATUS_ERR
return|;
name|gettimeofday
argument_list|(
operator|&
name|t1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|data
operator|=
name|ldns_tcp_read_wire_timeout
argument_list|(
name|res
operator|->
name|_socket
argument_list|,
operator|&
name|size
argument_list|,
name|ldns_resolver_timeout
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|status
operator|=
name|ldns_wire2pkt
argument_list|(
name|answer
argument_list|,
name|data
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
goto|goto
name|error
goto|;
name|gettimeofday
argument_list|(
operator|&
name|t2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_pkt_set_querytime
argument_list|(
operator|*
name|answer
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|t2
operator|.
name|tv_sec
operator|-
name|t1
operator|.
name|tv_sec
operator|)
operator|*
literal|1000
argument_list|)
operator|+
operator|(
name|t2
operator|.
name|tv_usec
operator|-
name|t1
operator|.
name|tv_usec
operator|)
operator|/
literal|1000
argument_list|)
expr_stmt|;
name|ldns_pkt_set_timestamp
argument_list|(
operator|*
name|answer
argument_list|,
name|t2
argument_list|)
expr_stmt|;
return|return
name|status
return|;
name|error
label|:
name|close
argument_list|(
name|res
operator|->
name|_socket
argument_list|)
expr_stmt|;
name|res
operator|->
name|_socket
operator|=
literal|0
expr_stmt|;
return|return
name|LDNS_STATUS_ERR
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ldns_tcp_close
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|)
block|{
if|if
condition|(
name|res
operator|->
name|_socket
operator|>
literal|0
condition|)
block|{
name|close
argument_list|(
name|res
operator|->
name|_socket
argument_list|)
expr_stmt|;
name|res
operator|->
name|_socket
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|ldns_status
name|ldns_resolver_send_to
parameter_list|(
name|ldns_pkt
modifier|*
modifier|*
name|answer
parameter_list|,
name|ldns_resolver
modifier|*
name|res
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|ldns_rr_type
name|t
parameter_list|,
name|ldns_rr_class
name|c
parameter_list|,
name|uint16_t
name|flags
parameter_list|,
name|uint32_t
name|ixfr_serial
parameter_list|,
name|int
name|nameserver
parameter_list|,
name|bool
name|close_tcp
parameter_list|)
block|{
name|ldns_status
name|status
init|=
name|LDNS_STATUS_OK
decl_stmt|;
name|ldns_pkt
modifier|*
name|qpkt
decl_stmt|;
name|struct
name|timeval
name|now
decl_stmt|;
name|int
name|nscnt
init|=
name|ldns_resolver_nameserver_count
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|ldns_rdf
modifier|*
modifier|*
name|ns
init|=
name|ldns_resolver_nameservers
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|size_t
modifier|*
name|rtt
init|=
name|ldns_resolver_rtt
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|ldns_resolver_set_nameservers
argument_list|(
name|res
argument_list|,
operator|&
name|ns
index|[
name|nameserver
index|]
argument_list|)
expr_stmt|;
name|ldns_resolver_set_rtt
argument_list|(
name|res
argument_list|,
operator|&
name|rtt
index|[
name|nameserver
index|]
argument_list|)
expr_stmt|;
name|ldns_resolver_set_nameserver_count
argument_list|(
name|res
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* The next fragment should have been a call to      * ldns_resolver_prepare_query_pkt(), but starting with ldns      * version 1.6.17 that function tries to add it's own SOA      * records when rr_type is LDNS_RR_TYPE_IXFR, and we don't      * want that.      */
name|qpkt
operator|=
name|ldns_pkt_query_new
argument_list|(
name|ldns_rdf_clone
argument_list|(
name|name
argument_list|)
argument_list|,
name|t
argument_list|,
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|qpkt
operator|==
name|NULL
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_ERR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|now
operator|.
name|tv_sec
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|now
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|ldns_pkt_set_timestamp
argument_list|(
name|qpkt
argument_list|,
name|now
argument_list|)
expr_stmt|;
name|ldns_pkt_set_random_id
argument_list|(
name|qpkt
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|LDNS_RR_TYPE_IXFR
condition|)
block|{
name|status
operator|=
name|ldns_pkt_push_rr_soa
argument_list|(
name|qpkt
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|,
name|name
argument_list|,
name|c
argument_list|,
name|ixfr_serial
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|close_tcp
condition|)
block|{
name|status
operator|=
name|ldns_resolver_send_pkt
argument_list|(
name|answer
argument_list|,
name|res
argument_list|,
name|qpkt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|ldns_tcp_start
argument_list|(
name|res
argument_list|,
name|qpkt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
goto|goto
name|done
goto|;
name|status
operator|=
name|ldns_tcp_read
argument_list|(
name|answer
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
goto|goto
name|done
goto|;
name|ldns_pkt_set_answerfrom
argument_list|(
operator|*
name|answer
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|ns
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|done
label|:
name|ldns_pkt_free
argument_list|(
name|qpkt
argument_list|)
expr_stmt|;
name|ldns_resolver_set_nameservers
argument_list|(
name|res
argument_list|,
name|ns
argument_list|)
expr_stmt|;
name|ldns_resolver_set_rtt
argument_list|(
name|res
argument_list|,
name|rtt
argument_list|)
expr_stmt|;
name|ldns_resolver_set_nameserver_count
argument_list|(
name|res
argument_list|,
name|nscnt
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ldns_pkt_filter_answer
parameter_list|(
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|ldns_rr_type
name|type
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|cnt
decl_stmt|;
name|ldns_rr_list
modifier|*
name|rrlist
decl_stmt|;
name|ldns_rr
modifier|*
name|rr
decl_stmt|;
name|ldns_rr_type
name|rrtype
decl_stmt|;
name|rrlist
operator|=
name|ldns_pkt_answer
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
name|cnt
operator|=
name|ldns_rr_list_rr_count
argument_list|(
name|rrlist
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|rrlist
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|rrtype
operator|=
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|LDNS_RR_TYPE_ANY
operator|||
name|type
operator|==
name|rrtype
operator|||
operator|(
name|type
operator|==
name|LDNS_RR_TYPE_AXFR
operator|&&
operator|(
name|rrtype
operator|==
name|LDNS_RR_TYPE_A
operator|||
name|rrtype
operator|==
name|LDNS_RR_TYPE_AAAA
operator|||
name|rrtype
operator|==
name|LDNS_RR_TYPE_NS
operator|||
name|rrtype
operator|==
name|LDNS_RR_TYPE_PTR
operator|)
operator|)
condition|)
name|ldns_rr_list_set_rr
argument_list|(
name|rrlist
argument_list|,
name|rr
argument_list|,
name|j
operator|++
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_set_rr_count
argument_list|(
name|rrlist
argument_list|,
name|j
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Packet content printing.  */
end_comment

begin_struct
specifier|static
struct|struct
block|{
name|ldns_rr_type
name|type
decl_stmt|;
specifier|const
name|char
modifier|*
name|text
decl_stmt|;
block|}
name|rr_types
index|[]
init|=
block|{
block|{
name|LDNS_RR_TYPE_A
block|,
literal|"has address"
block|}
block|,
block|{
name|LDNS_RR_TYPE_NS
block|,
literal|"name server"
block|}
block|,
block|{
name|LDNS_RR_TYPE_CNAME
block|,
literal|"is an alias for"
block|}
block|,
block|{
name|LDNS_RR_TYPE_WKS
block|,
literal|"has well known services"
block|}
block|,
block|{
name|LDNS_RR_TYPE_PTR
block|,
literal|"domain name pointer"
block|}
block|,
block|{
name|LDNS_RR_TYPE_HINFO
block|,
literal|"host information"
block|}
block|,
block|{
name|LDNS_RR_TYPE_MX
block|,
literal|"mail is handled by"
block|}
block|,
block|{
name|LDNS_RR_TYPE_TXT
block|,
literal|"descriptive text"
block|}
block|,
block|{
name|LDNS_RR_TYPE_X25
block|,
literal|"x25 address"
block|}
block|,
block|{
name|LDNS_RR_TYPE_ISDN
block|,
literal|"ISDN address"
block|}
block|,
block|{
name|LDNS_RR_TYPE_SIG
block|,
literal|"has signature"
block|}
block|,
block|{
name|LDNS_RR_TYPE_KEY
block|,
literal|"has key"
block|}
block|,
block|{
name|LDNS_RR_TYPE_AAAA
block|,
literal|"has IPv6 address"
block|}
block|,
block|{
name|LDNS_RR_TYPE_LOC
block|,
literal|"location"
block|}
block|, }
struct|;
end_struct

begin_function
specifier|static
name|void
name|print_opcode
parameter_list|(
name|ldns_pkt_opcode
name|opcode
parameter_list|)
block|{
name|ldns_lookup_table
modifier|*
name|lt
init|=
name|ldns_lookup_by_id
argument_list|(
name|ldns_opcodes
argument_list|,
name|opcode
argument_list|)
decl_stmt|;
if|if
condition|(
name|lt
operator|&&
name|lt
operator|->
name|name
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|lt
operator|->
name|name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"RESERVED%d"
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_rcode
parameter_list|(
name|uint8_t
name|rcode
parameter_list|)
block|{
name|ldns_lookup_table
modifier|*
name|lt
init|=
name|ldns_lookup_by_id
argument_list|(
name|ldns_rcodes
argument_list|,
name|rcode
argument_list|)
decl_stmt|;
if|if
condition|(
name|lt
operator|&&
name|lt
operator|->
name|name
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|lt
operator|->
name|name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"RESERVED%d"
argument_list|,
name|rcode
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_rr_type
parameter_list|(
name|ldns_rr_type
name|type
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|n
decl_stmt|;
name|str
operator|=
name|ldns_rr_type2str
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|n
operator|=
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_rr_class
parameter_list|(
name|ldns_rr_class
name|cls
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|n
decl_stmt|;
name|str
operator|=
name|ldns_rr_class2str
argument_list|(
name|cls
argument_list|)
expr_stmt|;
name|n
operator|=
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_rdf
parameter_list|(
name|ldns_rdf
modifier|*
name|rdf
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|n
decl_stmt|;
name|str
operator|=
name|ldns_rdf2str
argument_list|(
name|rdf
argument_list|)
expr_stmt|;
name|n
operator|=
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_rdf_nodot
parameter_list|(
name|ldns_rdf
modifier|*
name|rdf
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|len
decl_stmt|,
name|n
decl_stmt|;
name|str
operator|=
name|ldns_rdf2str
argument_list|(
name|rdf
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|n
operator|=
name|printf
argument_list|(
literal|"%.*s"
argument_list|,
name|str
index|[
name|len
operator|-
literal|1
index|]
operator|==
literal|'.'
condition|?
name|len
operator|-
literal|1
else|:
name|len
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_padding
parameter_list|(
name|int
name|fromcol
parameter_list|,
name|int
name|tocol
parameter_list|)
block|{
name|int
name|col
init|=
name|fromcol
decl_stmt|,
name|nextcol
init|=
name|fromcol
operator|+
literal|8
operator|-
name|fromcol
operator|%
literal|8
decl_stmt|;
if|if
condition|(
name|fromcol
operator|+
literal|1
operator|>
name|tocol
condition|)
name|tocol
operator|=
name|fromcol
operator|+
literal|1
expr_stmt|;
for|for
control|(
init|;
name|nextcol
operator|<=
name|tocol
condition|;
name|col
operator|=
name|nextcol
operator|,
name|nextcol
operator|+=
literal|8
control|)
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|col
operator|<
name|tocol
condition|;
name|col
operator|++
control|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
return|return
name|col
operator|-
name|fromcol
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_rr_verbose
parameter_list|(
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
name|bool
name|isq
init|=
name|ldns_rr_is_question
argument_list|(
name|rr
argument_list|)
decl_stmt|;
name|int
name|rdcnt
init|=
name|ldns_rr_rd_count
argument_list|(
name|rr
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
comment|/* bind9-host does not count the initial ';' here */
name|n
operator|=
name|isq
condition|?
name|printf
argument_list|(
literal|";"
argument_list|)
else|:
literal|0
expr_stmt|;
name|n
operator|=
name|print_rdf
argument_list|(
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isq
condition|)
block|{
name|n
operator|+=
name|print_padding
argument_list|(
name|n
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|n
operator|+=
name|printf
argument_list|(
literal|"%d"
argument_list|,
name|ldns_rr_ttl
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|n
operator|+=
name|print_padding
argument_list|(
name|n
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|n
operator|+=
name|print_rr_class
argument_list|(
name|ldns_rr_get_class
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|+=
name|print_padding
argument_list|(
name|n
argument_list|,
literal|40
argument_list|)
expr_stmt|;
name|n
operator|+=
name|print_rr_type
argument_list|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdcnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|print_padding
argument_list|(
name|n
argument_list|,
literal|48
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|print_rdf
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_pkt_section_verbose
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrlist
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cnt
init|=
name|ldns_rr_list_rr_count
argument_list|(
name|rrlist
argument_list|)
decl_stmt|;
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
return|return;
name|printf
argument_list|(
literal|";; %s SECTION:\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
name|print_rr_verbose
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrlist
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_pkt_verbose
parameter_list|(
name|ldns_pkt
modifier|*
name|pkt
parameter_list|)
block|{
name|int
name|got_flags
init|=
literal|0
decl_stmt|;
name|printf
argument_list|(
literal|";; ->>HEADER<<- opcode: "
argument_list|)
expr_stmt|;
name|print_opcode
argument_list|(
name|ldns_pkt_get_opcode
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", status: "
argument_list|)
expr_stmt|;
name|print_rcode
argument_list|(
name|ldns_pkt_get_rcode
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", id: %u\n"
argument_list|,
name|ldns_pkt_id
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|";; flags:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_pkt_qr
argument_list|(
name|pkt
argument_list|)
condition|)
name|printf
argument_list|(
literal|" qr"
argument_list|)
operator|,
name|got_flags
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ldns_pkt_aa
argument_list|(
name|pkt
argument_list|)
condition|)
name|printf
argument_list|(
literal|" aa"
argument_list|)
operator|,
name|got_flags
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ldns_pkt_tc
argument_list|(
name|pkt
argument_list|)
condition|)
name|printf
argument_list|(
literal|" tc"
argument_list|)
operator|,
name|got_flags
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ldns_pkt_rd
argument_list|(
name|pkt
argument_list|)
condition|)
name|printf
argument_list|(
literal|" rd"
argument_list|)
operator|,
name|got_flags
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ldns_pkt_ra
argument_list|(
name|pkt
argument_list|)
condition|)
name|printf
argument_list|(
literal|" ra"
argument_list|)
operator|,
name|got_flags
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ldns_pkt_ad
argument_list|(
name|pkt
argument_list|)
condition|)
name|printf
argument_list|(
literal|" ad"
argument_list|)
operator|,
name|got_flags
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ldns_pkt_cd
argument_list|(
name|pkt
argument_list|)
condition|)
name|printf
argument_list|(
literal|" cd"
argument_list|)
operator|,
name|got_flags
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|got_flags
condition|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"; QUERY: %u, ANSWER: %u, AUTHORITY: %u, ADDITIONAL: %u\n"
argument_list|,
name|ldns_pkt_qdcount
argument_list|(
name|pkt
argument_list|)
argument_list|,
name|ldns_pkt_ancount
argument_list|(
name|pkt
argument_list|)
argument_list|,
name|ldns_pkt_nscount
argument_list|(
name|pkt
argument_list|)
argument_list|,
name|ldns_pkt_arcount
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_pkt_edns
argument_list|(
name|pkt
argument_list|)
condition|)
name|printf
argument_list|(
literal|";; EDNS: version: %u, udp=%u\n"
argument_list|,
name|ldns_pkt_edns_version
argument_list|(
name|pkt
argument_list|)
argument_list|,
name|ldns_pkt_edns_udp_size
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|print_pkt_section_verbose
argument_list|(
literal|"QUESTION"
argument_list|,
name|ldns_pkt_question
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|print_pkt_section_verbose
argument_list|(
literal|"ANSWER"
argument_list|,
name|ldns_pkt_answer
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|print_pkt_section_verbose
argument_list|(
literal|"AUTHORITY"
argument_list|,
name|ldns_pkt_authority
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|print_pkt_section_verbose
argument_list|(
literal|"ADDITIONAL"
argument_list|,
name|ldns_pkt_additional
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_rr_short
parameter_list|(
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
name|ldns_rr_type
name|type
init|=
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|rdcnt
init|=
name|ldns_rr_rd_count
argument_list|(
name|rr
argument_list|)
decl_stmt|;
name|print_rdf_nodot
argument_list|(
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|countof
argument_list|(
name|rr_types
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rr_types
index|[
name|i
index|]
operator|.
name|type
operator|==
name|type
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|rr_types
index|[
name|i
index|]
operator|.
name|text
argument_list|)
expr_stmt|;
goto|goto
name|found
goto|;
block|}
block|}
name|printf
argument_list|(
literal|"has "
argument_list|)
expr_stmt|;
name|print_rr_type
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" record"
argument_list|)
expr_stmt|;
name|found
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdcnt
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|print_rdf
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_pkt_short
parameter_list|(
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|bool
name|print_rr_server
parameter_list|)
block|{
name|ldns_rr_list
modifier|*
name|rrlist
init|=
name|ldns_pkt_answer
argument_list|(
name|pkt
argument_list|)
decl_stmt|;
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rrlist
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|print_rr_server
condition|)
block|{
name|printf
argument_list|(
literal|"Nameserver "
argument_list|)
expr_stmt|;
name|print_rdf
argument_list|(
name|ldns_pkt_answerfrom
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|":\n\t"
argument_list|)
expr_stmt|;
block|}
name|print_rr_short
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrlist
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_received_line
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_pkt
modifier|*
name|pkt
parameter_list|)
block|{
name|char
modifier|*
name|from
init|=
name|ldns_rdf2str
argument_list|(
name|ldns_pkt_answerfrom
argument_list|(
name|pkt
argument_list|)
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Received %zu bytes from %s#%d in %d ms\n"
argument_list|,
name|ldns_pkt_size
argument_list|(
name|pkt
argument_list|)
argument_list|,
name|from
argument_list|,
name|ldns_resolver_port
argument_list|(
name|res
argument_list|)
argument_list|,
name|ldns_pkt_querytime
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|from
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Main program.  *  * Note that no memory is freed below this line by intention.  */
end_comment

begin_define
define|#
directive|define
name|DEFAULT_TCP_TIMEOUT
value|10
end_define

begin_define
define|#
directive|define
name|DEFAULT_UDP_TIMEOUT
value|5
end_define

begin_enum
enum|enum
name|operation_mode
block|{
name|M_AXFR
block|,
name|M_IXFR
block|,
name|M_DEFAULT_Q
block|,
name|M_SINGLE_Q
block|,
name|M_SOA
block|}
enum|;
end_enum

begin_decl_stmt
specifier|static
name|enum
name|operation_mode
name|o_mode
init|=
name|M_DEFAULT_Q
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bool
name|o_ignore_servfail
init|=
name|true
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bool
name|o_ip6_int
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bool
name|o_print_pkt_server
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bool
name|o_print_rr_server
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bool
name|o_recursive
init|=
name|true
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bool
name|o_tcp
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bool
name|o_verbose
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|o_name
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|o_server
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|o_ipversion
init|=
name|LDNS_RESOLV_INETANY
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|o_ndots
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|o_retries
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ldns_rr_class
name|o_rrclass
init|=
name|LDNS_RR_CLASS_IN
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ldns_rr_type
name|o_rrtype
init|=
operator|(
name|ldns_rr_type
operator|)
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|time_t
name|o_timeout
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|o_ixfr_serial
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-aCdilrsTvw46] [-c class] [-N ndots] [-R number]\n"
literal|"       %*c [-t type] [-W wait] name [server]\n"
literal|"\t-a same as -v -t ANY\n"
literal|"\t-C query SOA records from all authoritative name servers\n"
literal|"\t-c use this query class (IN, CH, HS, etc)\n"
literal|"\t-d produce verbose output, same as -v\n"
literal|"\t-i use IP6.INT for IPv6 reverse lookups\n"
literal|"\t-l list records in a zone via AXFR\n"
literal|"\t-N consider names with at least this many dots as absolute\n"
literal|"\t-R retry UDP queries this many times\n"
literal|"\t-r disable recursive query\n"
literal|"\t-s do not ignore SERVFAIL responses\n"
literal|"\t-T send query via TCP\n"
literal|"\t-t use this query type (A, AAAA, MX, etc)\n"
literal|"\t-v produce verbose output\n"
literal|"\t-w wait forever for a server reply\n"
literal|"\t-W wait this many seconds for a reply\n"
literal|"\t-4 use IPv4 only\n"
literal|"\t-6 use IPv6 only\n"
argument_list|,
name|progname
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|progname
argument_list|)
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|parse_args
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|ch
decl_stmt|;
name|progname
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"aCdilrsTvw46c:N:R:t:W:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'a'
case|:
if|if
condition|(
name|o_mode
operator|!=
name|M_AXFR
condition|)
name|o_mode
operator|=
name|M_SINGLE_Q
expr_stmt|;
name|o_rrtype
operator|=
name|LDNS_RR_TYPE_ANY
expr_stmt|;
name|o_verbose
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|o_mode
operator|=
name|M_SOA
expr_stmt|;
name|o_print_rr_server
operator|=
name|true
expr_stmt|;
name|o_rrclass
operator|=
name|LDNS_RR_CLASS_IN
expr_stmt|;
name|o_rrtype
operator|=
name|LDNS_RR_TYPE_NS
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
comment|/* bind9-host sets o_mode to M_SINGLE_Q here */
name|o_rrclass
operator|=
name|ldns_get_rr_class_by_name
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|o_rrclass
operator|<=
literal|0
condition|)
name|die
argument_list|(
literal|2
argument_list|,
literal|"invalid class: %s\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|o_verbose
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|o_ip6_int
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|o_mode
operator|=
name|M_AXFR
expr_stmt|;
if|if
condition|(
name|o_rrtype
operator|==
operator|(
name|ldns_rr_type
operator|)
operator|-
literal|1
condition|)
name|o_rrtype
operator|=
name|LDNS_RR_TYPE_AXFR
expr_stmt|;
name|o_tcp
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
name|o_ndots
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|o_ndots
operator|<
literal|0
condition|)
name|o_ndots
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
comment|/* bind9-host accepts and ignores this option */
break|break;
case|case
literal|'r'
case|:
name|o_recursive
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|o_retries
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|o_retries
operator|<=
literal|0
condition|)
name|o_retries
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|o_retries
operator|>
literal|255
condition|)
name|o_retries
operator|=
literal|255
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|o_ignore_servfail
operator|=
name|false
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
name|o_tcp
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
if|if
condition|(
name|o_mode
operator|!=
name|M_AXFR
condition|)
name|o_mode
operator|=
name|M_SINGLE_Q
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|optarg
argument_list|,
literal|"ixfr="
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|o_rrtype
operator|=
name|LDNS_RR_TYPE_IXFR
expr_stmt|;
name|o_ixfr_serial
operator|=
name|atol
argument_list|(
name|optarg
operator|+
literal|5
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|o_rrtype
operator|=
name|ldns_get_rr_type_by_name
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|o_rrtype
operator|<=
literal|0
condition|)
name|die
argument_list|(
literal|2
argument_list|,
literal|"invalid type: %s\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|o_rrtype
operator|==
name|LDNS_RR_TYPE_AXFR
condition|)
block|{
name|o_mode
operator|=
name|M_AXFR
expr_stmt|;
name|o_rrtype
operator|=
name|LDNS_RR_TYPE_ANY
expr_stmt|;
name|o_verbose
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|o_rrtype
operator|==
name|LDNS_RR_TYPE_IXFR
condition|)
block|{
name|o_mode
operator|=
name|M_IXFR
expr_stmt|;
name|o_rrtype
operator|=
name|LDNS_RR_TYPE_ANY
expr_stmt|;
block|}
break|break;
case|case
literal|'v'
case|:
name|o_verbose
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
name|o_timeout
operator|=
operator|(
name|time_t
operator|)
name|INT_MAX
expr_stmt|;
break|break;
case|case
literal|'W'
case|:
name|o_timeout
operator|=
name|atol
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|o_timeout
operator|<=
literal|0
condition|)
name|o_timeout
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'4'
case|:
name|o_ipversion
operator|=
name|LDNS_RESOLV_INET
expr_stmt|;
break|break;
case|case
literal|'6'
case|:
name|o_ipversion
operator|=
name|LDNS_RESOLV_INET6
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
comment|/* bind9-host ignores arguments after the 2-nd one */
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|usage
argument_list|()
expr_stmt|;
name|o_name
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|o_server
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
name|o_print_pkt_server
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|o_rrtype
operator|==
operator|(
name|ldns_rr_type
operator|)
operator|-
literal|1
condition|)
name|o_rrtype
operator|=
name|LDNS_RR_TYPE_A
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ldns_rdf
modifier|*
name|safe_str2rdf_dname
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|dname
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|ldns_str2rdf_dname
argument_list|(
operator|&
name|dname
argument_list|,
name|name
argument_list|)
operator|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|die
argument_list|(
literal|1
argument_list|,
literal|"'%s' is not a legal name (%s)"
argument_list|,
name|name
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|dname
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_rdf
modifier|*
name|safe_dname_cat_clone
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|rd1
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|rd2
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|result
init|=
name|ldns_dname_cat_clone
argument_list|(
name|rd1
argument_list|,
name|rd2
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"not enought memory for a domain name"
argument_list|)
expr_stmt|;
comment|/* Why doesn't ldns_dname_cat_clone check this condition? */
if|if
condition|(
name|ldns_rdf_size
argument_list|(
name|result
argument_list|)
operator|>
name|LDNS_MAX_DOMAINLEN
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"'%s' is not a legal name (%s)\n"
argument_list|,
name|ldns_rdf2str
argument_list|(
name|result
argument_list|)
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|LDNS_STATUS_DOMAINNAME_OVERFLOW
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|query
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_rdf
modifier|*
name|domain
parameter_list|,
name|ldns_pkt
modifier|*
modifier|*
name|pkt
parameter_list|,
name|bool
name|close_tcp
parameter_list|)
block|{
name|ldns_status
name|status
decl_stmt|;
name|ldns_pkt_rcode
name|rcode
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|;
if|if
condition|(
name|o_verbose
condition|)
block|{
name|printf
argument_list|(
literal|"Trying \""
argument_list|)
expr_stmt|;
name|print_rdf_nodot
argument_list|(
name|domain
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\"\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|cnt
operator|=
name|ldns_resolver_nameserver_count
argument_list|(
name|res
argument_list|)
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|status
operator|=
name|ldns_resolver_send_to
argument_list|(
name|pkt
argument_list|,
name|res
argument_list|,
name|domain
argument_list|,
name|o_rrtype
argument_list|,
name|o_rrclass
argument_list|,
name|o_recursive
condition|?
name|LDNS_RD
else|:
literal|0
argument_list|,
name|o_ixfr_serial
argument_list|,
name|i
argument_list|,
name|close_tcp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
operator|*
name|pkt
operator|=
name|NULL
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ldns_pkt_tc
argument_list|(
operator|*
name|pkt
argument_list|)
operator|&&
operator|!
name|ldns_resolver_usevc
argument_list|(
name|res
argument_list|)
condition|)
block|{
if|if
condition|(
name|o_verbose
condition|)
name|printf
argument_list|(
literal|";; Truncated, retrying in TCP mode.\n"
argument_list|)
expr_stmt|;
name|ldns_resolver_set_usevc
argument_list|(
name|res
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_resolver_send_to
argument_list|(
name|pkt
argument_list|,
name|res
argument_list|,
name|domain
argument_list|,
name|o_rrtype
argument_list|,
name|o_rrclass
argument_list|,
name|o_recursive
condition|?
name|LDNS_RD
else|:
literal|0
argument_list|,
name|o_ixfr_serial
argument_list|,
name|i
argument_list|,
name|close_tcp
argument_list|)
expr_stmt|;
name|ldns_resolver_set_usevc
argument_list|(
name|res
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
continue|continue;
block|}
name|rcode
operator|=
name|ldns_pkt_get_rcode
argument_list|(
operator|*
name|pkt
argument_list|)
expr_stmt|;
if|if
condition|(
name|o_ignore_servfail
operator|&&
name|rcode
operator|==
name|LDNS_RCODE_SERVFAIL
operator|&&
name|cnt
operator|>
literal|1
condition|)
continue|continue;
return|return
name|rcode
operator|==
name|LDNS_RCODE_NOERROR
return|;
block|}
if|if
condition|(
operator|*
name|pkt
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|";; connection timed out; no servers could be reached\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_rdf
modifier|*
name|search
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_rdf
modifier|*
name|domain
parameter_list|,
name|ldns_pkt
modifier|*
modifier|*
name|pkt
parameter_list|,
name|bool
name|absolute
parameter_list|,
name|bool
name|close_tcp
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|dname
decl_stmt|,
modifier|*
modifier|*
name|searchlist
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
if|if
condition|(
name|absolute
operator|&&
name|query
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
name|pkt
argument_list|,
name|close_tcp
argument_list|)
condition|)
return|return
name|domain
return|;
if|if
condition|(
operator|(
name|dname
operator|=
name|ldns_resolver_domain
argument_list|(
name|res
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|dname
operator|=
name|safe_dname_cat_clone
argument_list|(
name|domain
argument_list|,
name|dname
argument_list|)
expr_stmt|;
if|if
condition|(
name|query
argument_list|(
name|res
argument_list|,
name|dname
argument_list|,
name|pkt
argument_list|,
name|close_tcp
argument_list|)
condition|)
return|return
name|dname
return|;
block|}
name|searchlist
operator|=
name|ldns_resolver_searchlist
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|n
operator|=
name|ldns_resolver_searchlist_count
argument_list|(
name|res
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|dname
operator|=
name|safe_dname_cat_clone
argument_list|(
name|domain
argument_list|,
name|searchlist
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|query
argument_list|(
name|res
argument_list|,
name|dname
argument_list|,
name|pkt
argument_list|,
name|close_tcp
argument_list|)
condition|)
return|return
name|dname
return|;
block|}
if|if
condition|(
operator|!
name|absolute
operator|&&
name|query
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
name|pkt
argument_list|,
name|close_tcp
argument_list|)
condition|)
return|return
name|domain
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|report
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_rdf
modifier|*
name|domain
parameter_list|,
name|ldns_pkt
modifier|*
name|pkt
parameter_list|)
block|{
name|ldns_pkt_rcode
name|rcode
decl_stmt|;
if|if
condition|(
name|o_print_pkt_server
condition|)
block|{
name|printf
argument_list|(
literal|"Using domain server:\nName: %s\nAddress: "
argument_list|,
name|o_server
argument_list|)
expr_stmt|;
name|print_rdf
argument_list|(
name|ldns_pkt_answerfrom
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"#%d\nAliases: \n\n"
argument_list|,
name|ldns_resolver_port
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
name|o_print_pkt_server
operator|=
name|false
expr_stmt|;
block|}
name|rcode
operator|=
name|ldns_pkt_get_rcode
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
if|if
condition|(
name|rcode
operator|!=
name|LDNS_RCODE_NOERROR
condition|)
block|{
name|printf
argument_list|(
literal|"Host "
argument_list|)
expr_stmt|;
name|print_rdf_nodot
argument_list|(
name|domain
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" not found: %d("
argument_list|,
name|rcode
argument_list|)
expr_stmt|;
name|print_rcode
argument_list|(
name|rcode
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|")\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|o_verbose
condition|)
block|{
name|print_pkt_verbose
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|print_pkt_short
argument_list|(
name|pkt
argument_list|,
name|o_print_rr_server
argument_list|)
expr_stmt|;
if|if
condition|(
name|o_mode
operator|==
name|M_SINGLE_Q
operator|&&
name|ldns_rr_list_rr_count
argument_list|(
name|ldns_pkt_answer
argument_list|(
name|pkt
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|print_rdf_nodot
argument_list|(
name|domain
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" has no "
argument_list|)
expr_stmt|;
name|print_rr_type
argument_list|(
name|o_rrtype
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" record\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|o_verbose
condition|)
name|print_received_line
argument_list|(
name|res
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|doquery
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_rdf
modifier|*
name|domain
parameter_list|)
block|{
name|ldns_pkt
modifier|*
name|pkt
decl_stmt|;
name|bool
name|q
decl_stmt|;
name|q
operator|=
name|query
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
operator|&
name|pkt
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|report
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|q
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|doquery_filtered
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_rdf
modifier|*
name|domain
parameter_list|)
block|{
name|ldns_pkt
modifier|*
name|pkt
decl_stmt|;
name|bool
name|q
decl_stmt|;
name|q
operator|=
name|query
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
operator|&
name|pkt
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ldns_pkt_filter_answer
argument_list|(
name|pkt
argument_list|,
name|o_rrtype
argument_list|)
expr_stmt|;
name|report
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|q
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|dosearch
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_rdf
modifier|*
name|domain
parameter_list|,
name|bool
name|absolute
parameter_list|)
block|{
name|ldns_pkt
modifier|*
name|pkt
decl_stmt|;
name|ldns_rdf
modifier|*
name|dname
decl_stmt|;
name|dname
operator|=
name|search
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
operator|&
name|pkt
argument_list|,
name|absolute
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|report
argument_list|(
name|res
argument_list|,
name|dname
operator|!=
name|NULL
condition|?
name|dname
else|:
name|domain
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|o_mode
operator|!=
name|M_DEFAULT_Q
condition|?
operator|(
name|dname
operator|!=
name|NULL
operator|)
else|:
operator|(
name|dname
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|o_rrtype
operator|=
name|LDNS_RR_TYPE_AAAA
operator|,
name|doquery_filtered
argument_list|(
name|res
argument_list|,
name|dname
argument_list|)
operator|)
operator|&&
operator|(
name|o_rrtype
operator|=
name|LDNS_RR_TYPE_MX
operator|,
name|doquery_filtered
argument_list|(
name|res
argument_list|,
name|dname
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|dozonetransfer
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_rdf
modifier|*
name|domain
parameter_list|,
name|bool
name|absolute
parameter_list|)
block|{
name|ldns_pkt
modifier|*
name|pkt
decl_stmt|,
modifier|*
name|nextpkt
decl_stmt|;
name|ldns_rdf
modifier|*
name|dname
decl_stmt|;
name|ldns_rr_type
name|rrtype
decl_stmt|;
name|ldns_rr_list
modifier|*
name|rrl
decl_stmt|;
name|ldns_rr
modifier|*
name|rr
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|nsoa
init|=
literal|0
decl_stmt|;
name|uint32_t
name|first_serial
decl_stmt|;
name|rrtype
operator|=
name|o_rrtype
expr_stmt|;
name|o_rrtype
operator|=
operator|(
name|o_mode
operator|==
name|M_AXFR
operator|)
condition|?
name|LDNS_RR_TYPE_AXFR
else|:
name|LDNS_RR_TYPE_IXFR
expr_stmt|;
name|dname
operator|=
name|search
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
operator|&
name|pkt
argument_list|,
name|absolute
argument_list|,
name|false
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|rrl
operator|=
name|ldns_rr_list_clone
argument_list|(
name|ldns_pkt_answer
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_filter_answer
argument_list|(
name|pkt
argument_list|,
name|rrtype
argument_list|)
expr_stmt|;
name|report
argument_list|(
name|res
argument_list|,
name|dname
operator|!=
name|NULL
condition|?
name|dname
else|:
name|domain
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dname
operator|==
name|NULL
operator|)
operator|||
operator|(
name|ldns_pkt_get_rcode
argument_list|(
name|pkt
argument_list|)
operator|!=
name|LDNS_RCODE_NOERROR
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"; Transfer failed.\n"
argument_list|)
expr_stmt|;
name|ldns_tcp_close
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rrl
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|rrl
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsoa
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|!=
name|LDNS_RR_TYPE_SOA
condition|)
block|{
name|printf
argument_list|(
literal|"; Transfer failed. "
literal|"Didn't start with SOA answer.\n"
argument_list|)
expr_stmt|;
name|ldns_tcp_close
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|first_serial
operator|=
name|ldns_rr_soa_get_serial
argument_list|(
name|rr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|o_mode
operator|==
name|M_IXFR
operator|)
operator|&&
operator|(
name|first_serial
operator|<=
name|o_ixfr_serial
operator|)
condition|)
block|{
name|ldns_tcp_close
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
block|}
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_SOA
condition|)
block|{
name|nsoa
operator|=
name|nsoa
operator|<
literal|2
condition|?
name|nsoa
operator|+
literal|1
else|:
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|nsoa
operator|==
literal|2
operator|)
operator|&&
operator|(
name|ldns_rr_soa_get_serial
argument_list|(
name|rr
argument_list|)
operator|==
name|first_serial
operator|)
condition|)
block|{
name|ldns_tcp_close
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
block|}
block|}
if|if
condition|(
name|ldns_tcp_read
argument_list|(
operator|&
name|nextpkt
argument_list|,
name|res
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|printf
argument_list|(
literal|"; Transfer failed.\n"
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|ldns_pkt_set_answerfrom
argument_list|(
name|nextpkt
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|ldns_pkt_answerfrom
argument_list|(
name|pkt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
name|ldns_rr_list_free
argument_list|(
name|rrl
argument_list|)
expr_stmt|;
name|pkt
operator|=
name|nextpkt
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|bool
name|dosoa
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_rdf
modifier|*
name|domain
parameter_list|,
name|bool
name|absolute
parameter_list|)
block|{
name|ldns_rr_list
modifier|*
name|answer
decl_stmt|,
modifier|*
modifier|*
name|nsaddrs
decl_stmt|;
name|ldns_rdf
modifier|*
name|dname
decl_stmt|,
modifier|*
name|addr
decl_stmt|;
name|ldns_pkt
modifier|*
name|pkt
decl_stmt|;
name|ldns_rr
modifier|*
name|rr
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|n
decl_stmt|,
name|cnt
decl_stmt|;
if|if
condition|(
operator|(
name|dname
operator|=
name|search
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
operator|&
name|pkt
argument_list|,
name|absolute
argument_list|,
name|true
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|false
return|;
name|answer
operator|=
name|ldns_pkt_answer
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
name|cnt
operator|=
name|ldns_rr_list_rr_count
argument_list|(
name|answer
argument_list|)
expr_stmt|;
name|nsaddrs
operator|=
name|alloca
argument_list|(
name|cnt
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|nsaddrs
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|addr
operator|=
name|ldns_rr_ns_nsdname
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|answer
argument_list|,
name|i
argument_list|)
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|nsaddrs
index|[
name|n
operator|++
index|]
operator|=
name|ldns_get_rr_list_addr_by_name
argument_list|(
name|res
argument_list|,
name|addr
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|o_print_pkt_server
operator|=
name|false
expr_stmt|;
name|o_recursive
operator|=
name|false
expr_stmt|;
name|o_rrtype
operator|=
name|LDNS_RR_TYPE_SOA
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|cnt
operator|=
name|ldns_rr_list_rr_count
argument_list|(
name|nsaddrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|cnt
condition|;
name|j
operator|++
control|)
block|{
name|ldns_resolver_remove_nameservers
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsaddrs
index|[
name|i
index|]
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ldns_resolver_ip6
argument_list|(
name|res
argument_list|)
operator|==
name|LDNS_RESOLV_INET
operator|&&
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_AAAA
operator|)
operator|||
operator|(
name|ldns_resolver_ip6
argument_list|(
name|res
argument_list|)
operator|==
name|LDNS_RESOLV_INET6
operator|&&
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_A
operator|)
condition|)
continue|continue;
if|if
condition|(
name|ldns_resolver_push_nameserver_rr
argument_list|(
name|res
argument_list|,
name|rr
argument_list|)
operator|==
name|LDNS_STATUS_OK
condition|)
comment|/* bind9-host queries for domain, not dname here */
name|doquery
argument_list|(
name|res
argument_list|,
name|dname
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|resolver_set_nameserver_hostname
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
specifier|const
name|char
modifier|*
name|server
parameter_list|)
block|{
name|struct
name|addrinfo
name|hints
decl_stmt|,
modifier|*
name|ailist
decl_stmt|,
modifier|*
name|ai
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|ldns_rdf
modifier|*
name|rdf
decl_stmt|;
name|int
name|err
decl_stmt|;
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|hints
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ldns_resolver_ip6
argument_list|(
name|res
argument_list|)
condition|)
block|{
case|case
name|LDNS_RESOLV_INET
case|:
name|hints
operator|.
name|ai_family
operator|=
name|PF_INET
expr_stmt|;
break|break;
case|case
name|LDNS_RESOLV_INET6
case|:
name|hints
operator|.
name|ai_family
operator|=
name|PF_INET6
expr_stmt|;
break|break;
default|default:
name|hints
operator|.
name|ai_family
operator|=
name|PF_UNSPEC
expr_stmt|;
break|break;
block|}
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_STREAM
expr_stmt|;
do|do
name|err
operator|=
name|getaddrinfo
argument_list|(
name|server
argument_list|,
name|NULL
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|ailist
argument_list|)
expr_stmt|;
do|while
condition|(
name|err
operator|==
name|EAI_AGAIN
condition|)
do|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"couldn't get address for '%s': %s"
argument_list|,
name|server
argument_list|,
name|gai_strerror
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ai
operator|=
name|ailist
init|;
name|ai
operator|!=
name|NULL
condition|;
name|ai
operator|=
name|ai
operator|->
name|ai_next
control|)
block|{
if|if
condition|(
operator|(
name|rdf
operator|=
name|ldns_sockaddr_storage2rdf
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ai
operator|->
name|ai_addr
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"couldn't allocate an rdf: %s"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|LDNS_STATUS_MEM_ERR
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_resolver_push_nameserver
argument_list|(
name|res
argument_list|,
name|rdf
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"couldn't push a nameserver address: %s"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|resolver_set_nameserver_str
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
specifier|const
name|char
modifier|*
name|server
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|addr
decl_stmt|;
name|ldns_resolver_remove_nameservers
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|addr
operator|=
name|ldns_rdf_new_addr_frm_str
argument_list|(
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
block|{
if|if
condition|(
name|ldns_resolver_push_nameserver
argument_list|(
name|res
argument_list|,
name|addr
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"couldn't push a nameserver address"
argument_list|)
expr_stmt|;
block|}
else|else
name|resolver_set_nameserver_hostname
argument_list|(
name|res
argument_list|,
name|server
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|addr
decl_stmt|,
modifier|*
name|dname
decl_stmt|;
name|ldns_resolver
modifier|*
name|res
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|struct
name|timeval
name|restimeout
decl_stmt|;
name|parse_args
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_resolver_new_default
argument_list|(
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"error creating resolver: %s"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_resolver_nameserver_count
argument_list|(
name|res
argument_list|)
operator|==
literal|0
condition|)
name|ldns_resolver_push_default_servers
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|ldns_resolver_set_usevc
argument_list|(
name|res
argument_list|,
name|o_tcp
argument_list|)
expr_stmt|;
name|restimeout
operator|.
name|tv_sec
operator|=
name|o_timeout
operator|>
literal|0
condition|?
name|o_timeout
else|:
name|o_tcp
condition|?
name|DEFAULT_TCP_TIMEOUT
else|:
name|DEFAULT_UDP_TIMEOUT
expr_stmt|;
name|restimeout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|ldns_resolver_set_timeout
argument_list|(
name|res
argument_list|,
name|restimeout
argument_list|)
expr_stmt|;
name|ldns_resolver_set_retry
argument_list|(
name|res
argument_list|,
name|o_retries
operator|+
literal|1
argument_list|)
expr_stmt|;
name|ldns_resolver_set_ip6
argument_list|(
name|res
argument_list|,
name|o_ipversion
argument_list|)
expr_stmt|;
name|ldns_resolver_set_defnames
argument_list|(
name|res
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ldns_resolver_set_fallback
argument_list|(
name|res
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|o_server
condition|)
name|resolver_set_nameserver_str
argument_list|(
name|res
argument_list|,
name|o_server
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_str2rdf_a
argument_list|(
operator|&
name|addr
argument_list|,
name|o_name
argument_list|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|dname
operator|=
name|ldns_rdf_reverse_a
argument_list|(
name|addr
argument_list|,
literal|"in-addr.arpa"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dname
operator|==
name|NULL
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"can't reverse '%s': %s"
argument_list|,
name|o_name
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|LDNS_STATUS_MEM_ERR
argument_list|)
argument_list|)
expr_stmt|;
name|o_mode
operator|=
name|M_SINGLE_Q
expr_stmt|;
name|o_rrtype
operator|=
name|LDNS_RR_TYPE_PTR
expr_stmt|;
return|return
operator|!
name|doquery
argument_list|(
name|res
argument_list|,
name|dname
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|ldns_str2rdf_aaaa
argument_list|(
operator|&
name|addr
argument_list|,
name|o_name
argument_list|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|dname
operator|=
name|ldns_rdf_reverse_aaaa
argument_list|(
name|addr
argument_list|,
name|o_ip6_int
condition|?
literal|"ip6.int"
else|:
literal|"ip6.arpa"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dname
operator|==
name|NULL
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"can't reverse '%s': %s"
argument_list|,
name|o_name
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|LDNS_STATUS_MEM_ERR
argument_list|)
argument_list|)
expr_stmt|;
name|o_mode
operator|=
name|M_SINGLE_Q
expr_stmt|;
name|o_rrtype
operator|=
name|LDNS_RR_TYPE_PTR
expr_stmt|;
return|return
operator|!
name|doquery
argument_list|(
name|res
argument_list|,
name|dname
argument_list|)
return|;
block|}
return|return
operator|!
operator|(
name|o_mode
operator|==
name|M_SOA
condition|?
name|dosoa
else|:
name|o_mode
operator|==
name|M_AXFR
condition|?
name|dozonetransfer
else|:
name|o_mode
operator|==
name|M_IXFR
condition|?
name|dozonetransfer
else|:
name|dosearch
operator|)
operator|(
name|res
operator|,
name|safe_str2rdf_dname
argument_list|(
name|o_name
argument_list|)
operator|,
name|ndots
argument_list|(
name|o_name
argument_list|)
operator|>=
name|o_ndots
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"libfdt_env.h"
end_include

begin_include
include|#
directive|include
file|<fdt.h>
end_include

begin_include
include|#
directive|include
file|<libfdt.h>
end_include

begin_include
include|#
directive|include
file|"libfdt_internal.h"
end_include

begin_comment
comment|/**  * overlay_get_target_phandle - retrieves the target phandle of a fragment  * @fdto: pointer to the device tree overlay blob  * @fragment: node offset of the fragment in the overlay  *  * overlay_get_target_phandle() retrieves the target phandle of an  * overlay fragment when that fragment uses a phandle (target  * property) instead of a path (target-path property).  *  * returns:  *      the phandle pointed by the target property  *      0, if the phandle was not found  *	-1, if the phandle was malformed  */
end_comment

begin_function
specifier|static
name|uint32_t
name|overlay_get_target_phandle
parameter_list|(
specifier|const
name|void
modifier|*
name|fdto
parameter_list|,
name|int
name|fragment
parameter_list|)
block|{
specifier|const
name|uint32_t
modifier|*
name|val
decl_stmt|;
name|int
name|len
decl_stmt|;
name|val
operator|=
name|fdt_getprop
argument_list|(
name|fdto
argument_list|,
name|fragment
argument_list|,
literal|"target"
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|val
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|val
argument_list|)
operator|)
operator|||
operator|(
operator|*
name|val
operator|==
operator|(
name|uint32_t
operator|)
operator|-
literal|1
operator|)
condition|)
return|return
operator|(
name|uint32_t
operator|)
operator|-
literal|1
return|;
return|return
name|fdt32_to_cpu
argument_list|(
operator|*
name|val
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * overlay_get_target - retrieves the offset of a fragment's target  * @fdt: Base device tree blob  * @fdto: Device tree overlay blob  * @fragment: node offset of the fragment in the overlay  *  * overlay_get_target() retrieves the target offset in the base  * device tree of a fragment, no matter how the actual targetting is  * done (through a phandle or a path)  *  * returns:  *      the targetted node offset in the base device tree  *      Negative error code on error  */
end_comment

begin_function
specifier|static
name|int
name|overlay_get_target
parameter_list|(
specifier|const
name|void
modifier|*
name|fdt
parameter_list|,
specifier|const
name|void
modifier|*
name|fdto
parameter_list|,
name|int
name|fragment
parameter_list|)
block|{
name|uint32_t
name|phandle
decl_stmt|;
specifier|const
name|char
modifier|*
name|path
decl_stmt|;
name|int
name|path_len
decl_stmt|;
comment|/* Try first to do a phandle based lookup */
name|phandle
operator|=
name|overlay_get_target_phandle
argument_list|(
name|fdto
argument_list|,
name|fragment
argument_list|)
expr_stmt|;
if|if
condition|(
name|phandle
operator|==
operator|(
name|uint32_t
operator|)
operator|-
literal|1
condition|)
return|return
operator|-
name|FDT_ERR_BADPHANDLE
return|;
if|if
condition|(
name|phandle
condition|)
return|return
name|fdt_node_offset_by_phandle
argument_list|(
name|fdt
argument_list|,
name|phandle
argument_list|)
return|;
comment|/* And then a path based lookup */
name|path
operator|=
name|fdt_getprop
argument_list|(
name|fdto
argument_list|,
name|fragment
argument_list|,
literal|"target-path"
argument_list|,
operator|&
name|path_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
block|{
comment|/* 		 * If we haven't found either a target or a 		 * target-path property in a node that contains a 		 * __overlay__ subnode (we wouldn't be called 		 * otherwise), consider it a improperly written 		 * overlay 		 */
if|if
condition|(
name|path_len
operator|==
operator|-
name|FDT_ERR_NOTFOUND
condition|)
return|return
operator|-
name|FDT_ERR_BADOVERLAY
return|;
return|return
name|path_len
return|;
block|}
return|return
name|fdt_path_offset
argument_list|(
name|fdt
argument_list|,
name|path
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * overlay_phandle_add_offset - Increases a phandle by an offset  * @fdt: Base device tree blob  * @node: Device tree overlay blob  * @name: Name of the property to modify (phandle or linux,phandle)  * @delta: offset to apply  *  * overlay_phandle_add_offset() increments a node phandle by a given  * offset.  *  * returns:  *      0 on success.  *      Negative error code on error  */
end_comment

begin_function
specifier|static
name|int
name|overlay_phandle_add_offset
parameter_list|(
name|void
modifier|*
name|fdt
parameter_list|,
name|int
name|node
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|uint32_t
name|delta
parameter_list|)
block|{
specifier|const
name|uint32_t
modifier|*
name|val
decl_stmt|;
name|uint32_t
name|adj_val
decl_stmt|;
name|int
name|len
decl_stmt|;
name|val
operator|=
name|fdt_getprop
argument_list|(
name|fdt
argument_list|,
name|node
argument_list|,
name|name
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|val
condition|)
return|return
name|len
return|;
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|val
argument_list|)
condition|)
return|return
operator|-
name|FDT_ERR_BADPHANDLE
return|;
name|adj_val
operator|=
name|fdt32_to_cpu
argument_list|(
operator|*
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|adj_val
operator|+
name|delta
operator|)
operator|<
name|adj_val
condition|)
return|return
operator|-
name|FDT_ERR_NOPHANDLES
return|;
name|adj_val
operator|+=
name|delta
expr_stmt|;
if|if
condition|(
name|adj_val
operator|==
operator|(
name|uint32_t
operator|)
operator|-
literal|1
condition|)
return|return
operator|-
name|FDT_ERR_NOPHANDLES
return|;
return|return
name|fdt_setprop_inplace_u32
argument_list|(
name|fdt
argument_list|,
name|node
argument_list|,
name|name
argument_list|,
name|adj_val
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * overlay_adjust_node_phandles - Offsets the phandles of a node  * @fdto: Device tree overlay blob  * @node: Offset of the node we want to adjust  * @delta: Offset to shift the phandles of  *  * overlay_adjust_node_phandles() adds a constant to all the phandles  * of a given node. This is mainly use as part of the overlay  * application process, when we want to update all the overlay  * phandles to not conflict with the overlays of the base device tree.  *  * returns:  *      0 on success  *      Negative error code on failure  */
end_comment

begin_function
specifier|static
name|int
name|overlay_adjust_node_phandles
parameter_list|(
name|void
modifier|*
name|fdto
parameter_list|,
name|int
name|node
parameter_list|,
name|uint32_t
name|delta
parameter_list|)
block|{
name|int
name|child
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|overlay_phandle_add_offset
argument_list|(
name|fdto
argument_list|,
name|node
argument_list|,
literal|"phandle"
argument_list|,
name|delta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|&&
name|ret
operator|!=
operator|-
name|FDT_ERR_NOTFOUND
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|overlay_phandle_add_offset
argument_list|(
name|fdto
argument_list|,
name|node
argument_list|,
literal|"linux,phandle"
argument_list|,
name|delta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|&&
name|ret
operator|!=
operator|-
name|FDT_ERR_NOTFOUND
condition|)
return|return
name|ret
return|;
name|fdt_for_each_subnode
argument_list|(
argument|child
argument_list|,
argument|fdto
argument_list|,
argument|node
argument_list|)
block|{
name|ret
operator|=
name|overlay_adjust_node_phandles
argument_list|(
name|fdto
argument_list|,
name|child
argument_list|,
name|delta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * overlay_adjust_local_phandles - Adjust the phandles of a whole overlay  * @fdto: Device tree overlay blob  * @delta: Offset to shift the phandles of  *  * overlay_adjust_local_phandles() adds a constant to all the  * phandles of an overlay. This is mainly use as part of the overlay  * application process, when we want to update all the overlay  * phandles to not conflict with the overlays of the base device tree.  *  * returns:  *      0 on success  *      Negative error code on failure  */
end_comment

begin_function
specifier|static
name|int
name|overlay_adjust_local_phandles
parameter_list|(
name|void
modifier|*
name|fdto
parameter_list|,
name|uint32_t
name|delta
parameter_list|)
block|{
comment|/* 	 * Start adjusting the phandles from the overlay root 	 */
return|return
name|overlay_adjust_node_phandles
argument_list|(
name|fdto
argument_list|,
literal|0
argument_list|,
name|delta
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * overlay_update_local_node_references - Adjust the overlay references  * @fdto: Device tree overlay blob  * @tree_node: Node offset of the node to operate on  * @fixup_node: Node offset of the matching local fixups node  * @delta: Offset to shift the phandles of  *  * overlay_update_local_nodes_references() update the phandles  * pointing to a node within the device tree overlay by adding a  * constant delta.  *  * This is mainly used as part of a device tree application process,  * where you want the device tree overlays phandles to not conflict  * with the ones from the base device tree before merging them.  *  * returns:  *      0 on success  *      Negative error code on failure  */
end_comment

begin_function
specifier|static
name|int
name|overlay_update_local_node_references
parameter_list|(
name|void
modifier|*
name|fdto
parameter_list|,
name|int
name|tree_node
parameter_list|,
name|int
name|fixup_node
parameter_list|,
name|uint32_t
name|delta
parameter_list|)
block|{
name|int
name|fixup_prop
decl_stmt|;
name|int
name|fixup_child
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|fdt_for_each_property_offset
argument_list|(
argument|fixup_prop
argument_list|,
argument|fdto
argument_list|,
argument|fixup_node
argument_list|)
block|{
specifier|const
name|uint32_t
modifier|*
name|fixup_val
decl_stmt|;
specifier|const
name|char
modifier|*
name|tree_val
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|fixup_len
decl_stmt|;
name|int
name|tree_len
decl_stmt|;
name|int
name|i
decl_stmt|;
name|fixup_val
operator|=
name|fdt_getprop_by_offset
argument_list|(
name|fdto
argument_list|,
name|fixup_prop
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|fixup_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fixup_val
condition|)
return|return
name|fixup_len
return|;
if|if
condition|(
name|fixup_len
operator|%
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
return|return
operator|-
name|FDT_ERR_BADOVERLAY
return|;
name|tree_val
operator|=
name|fdt_getprop
argument_list|(
name|fdto
argument_list|,
name|tree_node
argument_list|,
name|name
argument_list|,
operator|&
name|tree_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tree_val
condition|)
block|{
if|if
condition|(
name|tree_len
operator|==
operator|-
name|FDT_ERR_NOTFOUND
condition|)
return|return
operator|-
name|FDT_ERR_BADOVERLAY
return|;
return|return
name|tree_len
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|fixup_len
operator|/
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|uint32_t
name|adj_val
decl_stmt|,
name|poffset
decl_stmt|;
name|poffset
operator|=
name|fdt32_to_cpu
argument_list|(
name|fixup_val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* 			 * phandles to fixup can be unaligned. 			 * 			 * Use a memcpy for the architectures that do 			 * not support unaligned accesses. 			 */
name|memcpy
argument_list|(
operator|&
name|adj_val
argument_list|,
name|tree_val
operator|+
name|poffset
argument_list|,
sizeof|sizeof
argument_list|(
name|adj_val
argument_list|)
argument_list|)
expr_stmt|;
name|adj_val
operator|=
name|fdt32_to_cpu
argument_list|(
name|adj_val
argument_list|)
expr_stmt|;
name|adj_val
operator|+=
name|delta
expr_stmt|;
name|adj_val
operator|=
name|cpu_to_fdt32
argument_list|(
name|adj_val
argument_list|)
expr_stmt|;
name|ret
operator|=
name|fdt_setprop_inplace_namelen_partial
argument_list|(
name|fdto
argument_list|,
name|tree_node
argument_list|,
name|name
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|,
name|poffset
argument_list|,
operator|&
name|adj_val
argument_list|,
sizeof|sizeof
argument_list|(
name|adj_val
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|FDT_ERR_NOSPACE
condition|)
return|return
operator|-
name|FDT_ERR_BADOVERLAY
return|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
block|}
name|fdt_for_each_subnode
argument_list|(
argument|fixup_child
argument_list|,
argument|fdto
argument_list|,
argument|fixup_node
argument_list|)
block|{
specifier|const
name|char
modifier|*
name|fixup_child_name
init|=
name|fdt_get_name
argument_list|(
name|fdto
argument_list|,
name|fixup_child
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|int
name|tree_child
decl_stmt|;
name|tree_child
operator|=
name|fdt_subnode_offset
argument_list|(
name|fdto
argument_list|,
name|tree_node
argument_list|,
name|fixup_child_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|FDT_ERR_NOTFOUND
condition|)
return|return
operator|-
name|FDT_ERR_BADOVERLAY
return|;
if|if
condition|(
name|tree_child
operator|<
literal|0
condition|)
return|return
name|tree_child
return|;
name|ret
operator|=
name|overlay_update_local_node_references
argument_list|(
name|fdto
argument_list|,
name|tree_child
argument_list|,
name|fixup_child
argument_list|,
name|delta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * overlay_update_local_references - Adjust the overlay references  * @fdto: Device tree overlay blob  * @delta: Offset to shift the phandles of  *  * overlay_update_local_references() update all the phandles pointing  * to a node within the device tree overlay by adding a constant  * delta to not conflict with the base overlay.  *  * This is mainly used as part of a device tree application process,  * where you want the device tree overlays phandles to not conflict  * with the ones from the base device tree before merging them.  *  * returns:  *      0 on success  *      Negative error code on failure  */
end_comment

begin_function
specifier|static
name|int
name|overlay_update_local_references
parameter_list|(
name|void
modifier|*
name|fdto
parameter_list|,
name|uint32_t
name|delta
parameter_list|)
block|{
name|int
name|fixups
decl_stmt|;
name|fixups
operator|=
name|fdt_path_offset
argument_list|(
name|fdto
argument_list|,
literal|"/__local_fixups__"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fixups
operator|<
literal|0
condition|)
block|{
comment|/* There's no local phandles to adjust, bail out */
if|if
condition|(
name|fixups
operator|==
operator|-
name|FDT_ERR_NOTFOUND
condition|)
return|return
literal|0
return|;
return|return
name|fixups
return|;
block|}
comment|/* 	 * Update our local references from the root of the tree 	 */
return|return
name|overlay_update_local_node_references
argument_list|(
name|fdto
argument_list|,
literal|0
argument_list|,
name|fixups
argument_list|,
name|delta
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * overlay_fixup_one_phandle - Set an overlay phandle to the base one  * @fdt: Base Device Tree blob  * @fdto: Device tree overlay blob  * @symbols_off: Node offset of the symbols node in the base device tree  * @path: Path to a node holding a phandle in the overlay  * @path_len: number of path characters to consider  * @name: Name of the property holding the phandle reference in the overlay  * @name_len: number of name characters to consider  * @poffset: Offset within the overlay property where the phandle is stored  * @label: Label of the node referenced by the phandle  *  * overlay_fixup_one_phandle() resolves an overlay phandle pointing to  * a node in the base device tree.  *  * This is part of the device tree overlay application process, when  * you want all the phandles in the overlay to point to the actual  * base dt nodes.  *  * returns:  *      0 on success  *      Negative error code on failure  */
end_comment

begin_function
specifier|static
name|int
name|overlay_fixup_one_phandle
parameter_list|(
name|void
modifier|*
name|fdt
parameter_list|,
name|void
modifier|*
name|fdto
parameter_list|,
name|int
name|symbols_off
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|uint32_t
name|path_len
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|uint32_t
name|name_len
parameter_list|,
name|int
name|poffset
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|symbol_path
decl_stmt|;
name|uint32_t
name|phandle
decl_stmt|;
name|int
name|symbol_off
decl_stmt|,
name|fixup_off
decl_stmt|;
name|int
name|prop_len
decl_stmt|;
if|if
condition|(
name|symbols_off
operator|<
literal|0
condition|)
return|return
name|symbols_off
return|;
name|symbol_path
operator|=
name|fdt_getprop
argument_list|(
name|fdt
argument_list|,
name|symbols_off
argument_list|,
name|label
argument_list|,
operator|&
name|prop_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|symbol_path
condition|)
return|return
name|prop_len
return|;
name|symbol_off
operator|=
name|fdt_path_offset
argument_list|(
name|fdt
argument_list|,
name|symbol_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|symbol_off
operator|<
literal|0
condition|)
return|return
name|symbol_off
return|;
name|phandle
operator|=
name|fdt_get_phandle
argument_list|(
name|fdt
argument_list|,
name|symbol_off
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|phandle
condition|)
return|return
operator|-
name|FDT_ERR_NOTFOUND
return|;
name|fixup_off
operator|=
name|fdt_path_offset_namelen
argument_list|(
name|fdto
argument_list|,
name|path
argument_list|,
name|path_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|fixup_off
operator|==
operator|-
name|FDT_ERR_NOTFOUND
condition|)
return|return
operator|-
name|FDT_ERR_BADOVERLAY
return|;
if|if
condition|(
name|fixup_off
operator|<
literal|0
condition|)
return|return
name|fixup_off
return|;
name|phandle
operator|=
name|cpu_to_fdt32
argument_list|(
name|phandle
argument_list|)
expr_stmt|;
return|return
name|fdt_setprop_inplace_namelen_partial
argument_list|(
name|fdto
argument_list|,
name|fixup_off
argument_list|,
name|name
argument_list|,
name|name_len
argument_list|,
name|poffset
argument_list|,
operator|&
name|phandle
argument_list|,
sizeof|sizeof
argument_list|(
name|phandle
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
comment|/**  * overlay_fixup_phandle - Set an overlay phandle to the base one  * @fdt: Base Device Tree blob  * @fdto: Device tree overlay blob  * @symbols_off: Node offset of the symbols node in the base device tree  * @property: Property offset in the overlay holding the list of fixups  *  * overlay_fixup_phandle() resolves all the overlay phandles pointed  * to in a __fixups__ property, and updates them to match the phandles  * in use in the base device tree.  *  * This is part of the device tree overlay application process, when  * you want all the phandles in the overlay to point to the actual  * base dt nodes.  *  * returns:  *      0 on success  *      Negative error code on failure  */
end_comment

begin_function
specifier|static
name|int
name|overlay_fixup_phandle
parameter_list|(
name|void
modifier|*
name|fdt
parameter_list|,
name|void
modifier|*
name|fdto
parameter_list|,
name|int
name|symbols_off
parameter_list|,
name|int
name|property
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|value
decl_stmt|;
specifier|const
name|char
modifier|*
name|label
decl_stmt|;
name|int
name|len
decl_stmt|;
name|value
operator|=
name|fdt_getprop_by_offset
argument_list|(
name|fdto
argument_list|,
name|property
argument_list|,
operator|&
name|label
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|value
condition|)
block|{
if|if
condition|(
name|len
operator|==
operator|-
name|FDT_ERR_NOTFOUND
condition|)
return|return
operator|-
name|FDT_ERR_INTERNAL
return|;
return|return
name|len
return|;
block|}
do|do
block|{
specifier|const
name|char
modifier|*
name|path
decl_stmt|,
modifier|*
name|name
decl_stmt|,
modifier|*
name|fixup_end
decl_stmt|;
specifier|const
name|char
modifier|*
name|fixup_str
init|=
name|value
decl_stmt|;
name|uint32_t
name|path_len
decl_stmt|,
name|name_len
decl_stmt|;
name|uint32_t
name|fixup_len
decl_stmt|;
name|char
modifier|*
name|sep
decl_stmt|,
modifier|*
name|endptr
decl_stmt|;
name|int
name|poffset
decl_stmt|,
name|ret
decl_stmt|;
name|fixup_end
operator|=
name|memchr
argument_list|(
name|value
argument_list|,
literal|'\0'
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fixup_end
condition|)
return|return
operator|-
name|FDT_ERR_BADOVERLAY
return|;
name|fixup_len
operator|=
name|fixup_end
operator|-
name|fixup_str
expr_stmt|;
name|len
operator|-=
name|fixup_len
operator|+
literal|1
expr_stmt|;
name|value
operator|+=
name|fixup_len
operator|+
literal|1
expr_stmt|;
name|path
operator|=
name|fixup_str
expr_stmt|;
name|sep
operator|=
name|memchr
argument_list|(
name|fixup_str
argument_list|,
literal|':'
argument_list|,
name|fixup_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sep
operator|||
operator|*
name|sep
operator|!=
literal|':'
condition|)
return|return
operator|-
name|FDT_ERR_BADOVERLAY
return|;
name|path_len
operator|=
name|sep
operator|-
name|path
expr_stmt|;
if|if
condition|(
name|path_len
operator|==
operator|(
name|fixup_len
operator|-
literal|1
operator|)
condition|)
return|return
operator|-
name|FDT_ERR_BADOVERLAY
return|;
name|fixup_len
operator|-=
name|path_len
operator|+
literal|1
expr_stmt|;
name|name
operator|=
name|sep
operator|+
literal|1
expr_stmt|;
name|sep
operator|=
name|memchr
argument_list|(
name|name
argument_list|,
literal|':'
argument_list|,
name|fixup_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sep
operator|||
operator|*
name|sep
operator|!=
literal|':'
condition|)
return|return
operator|-
name|FDT_ERR_BADOVERLAY
return|;
name|name_len
operator|=
name|sep
operator|-
name|name
expr_stmt|;
if|if
condition|(
operator|!
name|name_len
condition|)
return|return
operator|-
name|FDT_ERR_BADOVERLAY
return|;
name|poffset
operator|=
name|strtoul
argument_list|(
name|sep
operator|+
literal|1
argument_list|,
operator|&
name|endptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|endptr
operator|!=
literal|'\0'
operator|)
operator|||
operator|(
name|endptr
operator|<=
operator|(
name|sep
operator|+
literal|1
operator|)
operator|)
condition|)
return|return
operator|-
name|FDT_ERR_BADOVERLAY
return|;
name|ret
operator|=
name|overlay_fixup_one_phandle
argument_list|(
name|fdt
argument_list|,
name|fdto
argument_list|,
name|symbols_off
argument_list|,
name|path
argument_list|,
name|path_len
argument_list|,
name|name
argument_list|,
name|name_len
argument_list|,
name|poffset
argument_list|,
name|label
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
do|while
condition|(
name|len
operator|>
literal|0
condition|)
do|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * overlay_fixup_phandles - Resolve the overlay phandles to the base  *                          device tree  * @fdt: Base Device Tree blob  * @fdto: Device tree overlay blob  *  * overlay_fixup_phandles() resolves all the overlay phandles pointing  * to nodes in the base device tree.  *  * This is one of the steps of the device tree overlay application  * process, when you want all the phandles in the overlay to point to  * the actual base dt nodes.  *  * returns:  *      0 on success  *      Negative error code on failure  */
end_comment

begin_function
specifier|static
name|int
name|overlay_fixup_phandles
parameter_list|(
name|void
modifier|*
name|fdt
parameter_list|,
name|void
modifier|*
name|fdto
parameter_list|)
block|{
name|int
name|fixups_off
decl_stmt|,
name|symbols_off
decl_stmt|;
name|int
name|property
decl_stmt|;
comment|/* We can have overlays without any fixups */
name|fixups_off
operator|=
name|fdt_path_offset
argument_list|(
name|fdto
argument_list|,
literal|"/__fixups__"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fixups_off
operator|==
operator|-
name|FDT_ERR_NOTFOUND
condition|)
return|return
literal|0
return|;
comment|/* nothing to do */
if|if
condition|(
name|fixups_off
operator|<
literal|0
condition|)
return|return
name|fixups_off
return|;
comment|/* And base DTs without symbols */
name|symbols_off
operator|=
name|fdt_path_offset
argument_list|(
name|fdt
argument_list|,
literal|"/__symbols__"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|symbols_off
operator|<
literal|0
operator|&&
operator|(
name|symbols_off
operator|!=
operator|-
name|FDT_ERR_NOTFOUND
operator|)
operator|)
condition|)
return|return
name|symbols_off
return|;
name|fdt_for_each_property_offset
argument_list|(
argument|property
argument_list|,
argument|fdto
argument_list|,
argument|fixups_off
argument_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|overlay_fixup_phandle
argument_list|(
name|fdt
argument_list|,
name|fdto
argument_list|,
name|symbols_off
argument_list|,
name|property
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * overlay_apply_node - Merges a node into the base device tree  * @fdt: Base Device Tree blob  * @target: Node offset in the base device tree to apply the fragment to  * @fdto: Device tree overlay blob  * @node: Node offset in the overlay holding the changes to merge  *  * overlay_apply_node() merges a node into a target base device tree  * node pointed.  *  * This is part of the final step in the device tree overlay  * application process, when all the phandles have been adjusted and  * resolved and you just have to merge overlay into the base device  * tree.  *  * returns:  *      0 on success  *      Negative error code on failure  */
end_comment

begin_function
specifier|static
name|int
name|overlay_apply_node
parameter_list|(
name|void
modifier|*
name|fdt
parameter_list|,
name|int
name|target
parameter_list|,
name|void
modifier|*
name|fdto
parameter_list|,
name|int
name|node
parameter_list|)
block|{
name|int
name|property
decl_stmt|;
name|int
name|subnode
decl_stmt|;
name|fdt_for_each_property_offset
argument_list|(
argument|property
argument_list|,
argument|fdto
argument_list|,
argument|node
argument_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|void
modifier|*
name|prop
decl_stmt|;
name|int
name|prop_len
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|prop
operator|=
name|fdt_getprop_by_offset
argument_list|(
name|fdto
argument_list|,
name|property
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|prop_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|prop_len
operator|==
operator|-
name|FDT_ERR_NOTFOUND
condition|)
return|return
operator|-
name|FDT_ERR_INTERNAL
return|;
if|if
condition|(
name|prop_len
operator|<
literal|0
condition|)
return|return
name|prop_len
return|;
name|ret
operator|=
name|fdt_setprop
argument_list|(
name|fdt
argument_list|,
name|target
argument_list|,
name|name
argument_list|,
name|prop
argument_list|,
name|prop_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|fdt_for_each_subnode
argument_list|(
argument|subnode
argument_list|,
argument|fdto
argument_list|,
argument|node
argument_list|)
block|{
specifier|const
name|char
modifier|*
name|name
init|=
name|fdt_get_name
argument_list|(
name|fdto
argument_list|,
name|subnode
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|int
name|nnode
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|nnode
operator|=
name|fdt_add_subnode
argument_list|(
name|fdt
argument_list|,
name|target
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|nnode
operator|==
operator|-
name|FDT_ERR_EXISTS
condition|)
block|{
name|nnode
operator|=
name|fdt_subnode_offset
argument_list|(
name|fdt
argument_list|,
name|target
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|nnode
operator|==
operator|-
name|FDT_ERR_NOTFOUND
condition|)
return|return
operator|-
name|FDT_ERR_INTERNAL
return|;
block|}
if|if
condition|(
name|nnode
operator|<
literal|0
condition|)
return|return
name|nnode
return|;
name|ret
operator|=
name|overlay_apply_node
argument_list|(
name|fdt
argument_list|,
name|nnode
argument_list|,
name|fdto
argument_list|,
name|subnode
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * overlay_merge - Merge an overlay into its base device tree  * @fdt: Base Device Tree blob  * @fdto: Device tree overlay blob  *  * overlay_merge() merges an overlay into its base device tree.  *  * This is the final step in the device tree overlay application  * process, when all the phandles have been adjusted and resolved and  * you just have to merge overlay into the base device tree.  *  * returns:  *      0 on success  *      Negative error code on failure  */
end_comment

begin_function
specifier|static
name|int
name|overlay_merge
parameter_list|(
name|void
modifier|*
name|fdt
parameter_list|,
name|void
modifier|*
name|fdto
parameter_list|)
block|{
name|int
name|fragment
decl_stmt|;
name|fdt_for_each_subnode
argument_list|(
argument|fragment
argument_list|,
argument|fdto
argument_list|,
literal|0
argument_list|)
block|{
name|int
name|overlay
decl_stmt|;
name|int
name|target
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* 		 * Each fragments will have an __overlay__ node. If 		 * they don't, it's not supposed to be merged 		 */
name|overlay
operator|=
name|fdt_subnode_offset
argument_list|(
name|fdto
argument_list|,
name|fragment
argument_list|,
literal|"__overlay__"
argument_list|)
expr_stmt|;
if|if
condition|(
name|overlay
operator|==
operator|-
name|FDT_ERR_NOTFOUND
condition|)
continue|continue;
if|if
condition|(
name|overlay
operator|<
literal|0
condition|)
return|return
name|overlay
return|;
name|target
operator|=
name|overlay_get_target
argument_list|(
name|fdt
argument_list|,
name|fdto
argument_list|,
name|fragment
argument_list|)
expr_stmt|;
if|if
condition|(
name|target
operator|<
literal|0
condition|)
return|return
name|target
return|;
name|ret
operator|=
name|overlay_apply_node
argument_list|(
name|fdt
argument_list|,
name|target
argument_list|,
name|fdto
argument_list|,
name|overlay
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|fdt_overlay_apply
parameter_list|(
name|void
modifier|*
name|fdt
parameter_list|,
name|void
modifier|*
name|fdto
parameter_list|)
block|{
name|uint32_t
name|delta
init|=
name|fdt_get_max_phandle
argument_list|(
name|fdt
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|FDT_CHECK_HEADER
argument_list|(
name|fdt
argument_list|)
expr_stmt|;
name|FDT_CHECK_HEADER
argument_list|(
name|fdto
argument_list|)
expr_stmt|;
name|ret
operator|=
name|overlay_adjust_local_phandles
argument_list|(
name|fdto
argument_list|,
name|delta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
name|overlay_update_local_references
argument_list|(
name|fdto
argument_list|,
name|delta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
name|overlay_fixup_phandles
argument_list|(
name|fdt
argument_list|,
name|fdto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
name|overlay_merge
argument_list|(
name|fdt
argument_list|,
name|fdto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
comment|/* 	 * The overlay has been damaged, erase its magic. 	 */
name|fdt_set_magic
argument_list|(
name|fdto
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err
label|:
comment|/* 	 * The overlay might have been damaged, erase its magic. 	 */
name|fdt_set_magic
argument_list|(
name|fdto
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * The base device tree might have been damaged, erase its 	 * magic. 	 */
name|fdt_set_magic
argument_list|(
name|fdt
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


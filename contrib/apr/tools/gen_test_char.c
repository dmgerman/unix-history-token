begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|WIN32
argument_list|)
operator|||
name|defined
argument_list|(
name|OS2
argument_list|)
end_if

begin_define
define|#
directive|define
name|NEED_ENHANCED_ESCAPES
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_comment
comment|/* A bunch of functions in util.c scan strings looking for certain characters.  * To make that more efficient we encode a lookup table.  */
end_comment

begin_define
define|#
directive|define
name|T_ESCAPE_SHELL_CMD
value|(0x01)
end_define

begin_define
define|#
directive|define
name|T_ESCAPE_PATH_SEGMENT
value|(0x02)
end_define

begin_define
define|#
directive|define
name|T_OS_ESCAPE_PATH
value|(0x04)
end_define

begin_define
define|#
directive|define
name|T_ESCAPE_ECHO
value|(0x08)
end_define

begin_define
define|#
directive|define
name|T_ESCAPE_URLENCODED
value|(0x10)
end_define

begin_define
define|#
directive|define
name|T_ESCAPE_XML
value|(0x20)
end_define

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|unsigned
name|c
decl_stmt|;
name|unsigned
name|char
name|flags
decl_stmt|;
name|printf
argument_list|(
literal|"/* this file is automatically generated by gen_test_char, "
literal|"do not edit. \"make include/private/apr_escape_test_char.h\" to regenerate. */\n"
literal|"#define T_ESCAPE_SHELL_CMD     (%u)\n"
literal|"#define T_ESCAPE_PATH_SEGMENT  (%u)\n"
literal|"#define T_OS_ESCAPE_PATH       (%u)\n"
literal|"#define T_ESCAPE_ECHO          (%u)\n"
literal|"#define T_ESCAPE_URLENCODED    (%u)\n"
literal|"#define T_ESCAPE_XML           (%u)\n"
literal|"\n"
literal|"static const unsigned char test_char_table[256] = {"
argument_list|,
name|T_ESCAPE_SHELL_CMD
argument_list|,
name|T_ESCAPE_PATH_SEGMENT
argument_list|,
name|T_OS_ESCAPE_PATH
argument_list|,
name|T_ESCAPE_ECHO
argument_list|,
name|T_ESCAPE_URLENCODED
argument_list|,
name|T_ESCAPE_XML
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|256
condition|;
operator|++
name|c
control|)
block|{
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|%
literal|20
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n    "
argument_list|)
expr_stmt|;
comment|/* escape_shell_cmd */
ifdef|#
directive|ifdef
name|NEED_ENHANCED_ESCAPES
comment|/* Win32/OS2 have many of the same vulnerable characters          * as Unix sh, plus the carriage return and percent char.          * The proper escaping of these characters varies from unix          * since Win32/OS2 use carets or doubled-double quotes,          * and neither lf nor cr can be escaped.  We escape unix          * specific as well, to assure that cross-compiled unix          * applications behave similiarly when invoked on win32/os2.          *          * Rem please keep in-sync with apr's list in win32/filesys.c          */
if|if
condition|(
name|c
operator|&&
name|strchr
argument_list|(
literal|"&;`'\"|*?~<>^()[]{}$\\\n\r%"
argument_list|,
name|c
argument_list|)
condition|)
block|{
name|flags
operator||=
name|T_ESCAPE_SHELL_CMD
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|c
operator|&&
name|strchr
argument_list|(
literal|"&;`'\"|*?~<>^()[]{}$\\\n"
argument_list|,
name|c
argument_list|)
condition|)
block|{
name|flags
operator||=
name|T_ESCAPE_SHELL_CMD
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|!
name|isalnum
argument_list|(
name|c
argument_list|)
operator|&&
operator|!
name|strchr
argument_list|(
literal|"$-_.+!*'(),:@&=~"
argument_list|,
name|c
argument_list|)
condition|)
block|{
name|flags
operator||=
name|T_ESCAPE_PATH_SEGMENT
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|isalnum
argument_list|(
name|c
argument_list|)
operator|&&
operator|!
name|strchr
argument_list|(
literal|"$-_.+!*'(),:@&=/~"
argument_list|,
name|c
argument_list|)
condition|)
block|{
name|flags
operator||=
name|T_OS_ESCAPE_PATH
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|isalnum
argument_list|(
name|c
argument_list|)
operator|&&
operator|!
name|strchr
argument_list|(
literal|".-*_ "
argument_list|,
name|c
argument_list|)
condition|)
block|{
name|flags
operator||=
name|T_ESCAPE_URLENCODED
expr_stmt|;
block|}
comment|/* For logging, escape all control characters,          * double quotes (because they delimit the request in the log file)          * backslashes (because we use backslash for escaping)          * and 8-bit chars with the high bit set          */
if|if
condition|(
name|c
operator|&&
operator|(
operator|!
name|isprint
argument_list|(
name|c
argument_list|)
operator|||
name|c
operator|==
literal|'"'
operator|||
name|c
operator|==
literal|'\\'
operator|||
name|iscntrl
argument_list|(
name|c
argument_list|)
operator|)
condition|)
block|{
name|flags
operator||=
name|T_ESCAPE_ECHO
expr_stmt|;
block|}
if|if
condition|(
name|strchr
argument_list|(
literal|"<>&\""
argument_list|,
name|c
argument_list|)
condition|)
block|{
name|flags
operator||=
name|T_ESCAPE_XML
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%u%c"
argument_list|,
name|flags
argument_list|,
operator|(
name|c
operator|<
literal|255
operator|)
condition|?
literal|','
else|:
literal|' '
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n};\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


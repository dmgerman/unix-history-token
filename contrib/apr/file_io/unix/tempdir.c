begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_include
include|#
directive|include
file|"apr_private.h"
end_include

begin_include
include|#
directive|include
file|"apr_file_io.h"
end_include

begin_include
include|#
directive|include
file|"apr_strings.h"
end_include

begin_include
include|#
directive|include
file|"apr_env.h"
end_include

begin_comment
comment|/* Try to open a temporary file in the temporary dir, write to it,    and then close it. */
end_comment

begin_function
specifier|static
name|int
name|test_tempdir
parameter_list|(
specifier|const
name|char
modifier|*
name|temp_dir
parameter_list|,
name|apr_pool_t
modifier|*
name|p
parameter_list|)
block|{
name|apr_file_t
modifier|*
name|dummy_file
decl_stmt|;
name|char
modifier|*
name|path
init|=
name|apr_pstrcat
argument_list|(
name|p
argument_list|,
name|temp_dir
argument_list|,
literal|"/apr-tmp.XXXXXX"
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|apr_file_mktemp
argument_list|(
operator|&
name|dummy_file
argument_list|,
name|path
argument_list|,
literal|0
argument_list|,
name|p
argument_list|)
operator|==
name|APR_SUCCESS
condition|)
block|{
if|if
condition|(
name|apr_file_putc
argument_list|(
literal|'!'
argument_list|,
name|dummy_file
argument_list|)
operator|==
name|APR_SUCCESS
condition|)
block|{
if|if
condition|(
name|apr_file_close
argument_list|(
name|dummy_file
argument_list|)
operator|==
name|APR_SUCCESS
condition|)
block|{
return|return
literal|1
return|;
block|}
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_macro
name|APR_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_temp_dir_get
argument_list|(
argument|const char **temp_dir
argument_list|,
argument|apr_pool_t *p
argument_list|)
end_macro

begin_block
block|{
name|apr_status_t
name|apr_err
decl_stmt|;
specifier|const
name|char
modifier|*
name|try_dirs
index|[]
init|=
block|{
literal|"/tmp"
block|,
literal|"/usr/tmp"
block|,
literal|"/var/tmp"
block|}
decl_stmt|;
specifier|const
name|char
modifier|*
name|try_envs
index|[]
init|=
block|{
literal|"TMPDIR"
block|,
literal|"TMP"
block|,
literal|"TEMP"
block|}
decl_stmt|;
specifier|const
name|char
modifier|*
name|dir
decl_stmt|;
name|char
modifier|*
name|cwd
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Our goal is to find a temporary directory suitable for writing        into.        Here's the order in which we'll try various paths:            $TMPDIR           $TMP           $TEMP           "C:\TEMP"     (windows only)           "SYS:\TMP"    (netware only)           "/tmp"           "/var/tmp"           "/usr/tmp"           P_tmpdir      (POSIX define)           `pwd`          NOTE: This algorithm is basically the same one used by Python        2.2's tempfile.py module.  */
comment|/* Try the environment first. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|try_envs
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
name|apr_err
operator|=
name|apr_env_get
argument_list|(
operator|&
name|value
argument_list|,
name|try_envs
index|[
name|i
index|]
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|apr_err
operator|==
name|APR_SUCCESS
operator|)
operator|&&
name|value
condition|)
block|{
name|apr_size_t
name|len
init|=
name|strlen
argument_list|(
name|value
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
operator|&&
operator|(
name|len
operator|<
name|APR_PATH_MAX
operator|)
operator|&&
name|test_tempdir
argument_list|(
name|value
argument_list|,
name|p
argument_list|)
condition|)
block|{
name|dir
operator|=
name|value
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
block|}
ifdef|#
directive|ifdef
name|WIN32
comment|/* Next, on Win32, try the C:\TEMP directory. */
if|if
condition|(
name|test_tempdir
argument_list|(
literal|"C:\\TEMP"
argument_list|,
name|p
argument_list|)
condition|)
block|{
name|dir
operator|=
literal|"C:\\TEMP"
expr_stmt|;
goto|goto
name|end
goto|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NETWARE
comment|/* Next, on NetWare, try the SYS:/TMP directory. */
if|if
condition|(
name|test_tempdir
argument_list|(
literal|"SYS:/TMP"
argument_list|,
name|p
argument_list|)
condition|)
block|{
name|dir
operator|=
literal|"SYS:/TMP"
expr_stmt|;
goto|goto
name|end
goto|;
block|}
endif|#
directive|endif
comment|/* Next, try a set of hard-coded paths. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|try_dirs
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|test_tempdir
argument_list|(
name|try_dirs
index|[
name|i
index|]
argument_list|,
name|p
argument_list|)
condition|)
block|{
name|dir
operator|=
name|try_dirs
index|[
name|i
index|]
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
ifdef|#
directive|ifdef
name|P_tmpdir
comment|/*       * If we have it, use the POSIX definition of where       * the tmpdir should be       */
if|if
condition|(
name|test_tempdir
argument_list|(
name|P_tmpdir
argument_list|,
name|p
argument_list|)
condition|)
block|{
name|dir
operator|=
name|P_tmpdir
expr_stmt|;
goto|goto
name|end
goto|;
block|}
endif|#
directive|endif
comment|/* Finally, try the current working directory. */
if|if
condition|(
name|APR_SUCCESS
operator|==
name|apr_filepath_get
argument_list|(
operator|&
name|cwd
argument_list|,
name|APR_FILEPATH_NATIVE
argument_list|,
name|p
argument_list|)
condition|)
block|{
if|if
condition|(
name|test_tempdir
argument_list|(
name|cwd
argument_list|,
name|p
argument_list|)
condition|)
block|{
name|dir
operator|=
name|cwd
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
comment|/* We didn't find a suitable temp dir anywhere */
return|return
name|APR_EGENERAL
return|;
name|end
label|:
operator|*
name|temp_dir
operator|=
name|apr_pstrdup
argument_list|(
name|p
argument_list|,
name|dir
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_block

end_unit


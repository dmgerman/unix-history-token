begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1992, 1993, 1994  *	The Regents of the University of California.  All rights reserved.  * Copyright (c) 1992, 1993, 1994, 1995, 1996  *	Keith Bostic.  All rights reserved.  *  * See the LICENSE file for redistribution information.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|sccsid
index|[]
init|=
literal|"@(#)v_at.c	10.8 (Berkeley) 4/27/96"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<bitstring.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"../common/common.h"
end_include

begin_include
include|#
directive|include
file|"vi.h"
end_include

begin_comment
comment|/*  * v_at -- @  *	Execute a buffer.  *  * PUBLIC: int v_at __P((SCR *, VICMD *));  */
end_comment

begin_function
name|int
name|v_at
parameter_list|(
name|sp
parameter_list|,
name|vp
parameter_list|)
name|SCR
modifier|*
name|sp
decl_stmt|;
name|VICMD
modifier|*
name|vp
decl_stmt|;
block|{
name|CB
modifier|*
name|cbp
decl_stmt|;
name|CHAR_T
name|name
decl_stmt|;
name|TEXT
modifier|*
name|tp
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|char
name|nbuf
index|[
literal|20
index|]
decl_stmt|;
comment|/* 	 * !!! 	 * Historically, [@*]<carriage-return> and [@*][@*] executed the most 	 * recently executed buffer in ex mode.  In vi mode, only @@ repeated 	 * the last buffer.  We change historic practice and make @* work from 	 * vi mode as well, it's simpler and more consistent. 	 * 	 * My intent is that *[buffer] will, in the future, pass the buffer to 	 * whatever interpreter is loaded. 	 */
name|name
operator|=
name|F_ISSET
argument_list|(
name|vp
argument_list|,
name|VC_BUFFER
argument_list|)
condition|?
name|vp
operator|->
name|buffer
else|:
literal|'@'
expr_stmt|;
if|if
condition|(
name|name
operator|==
literal|'@'
operator|||
name|name
operator|==
literal|'*'
condition|)
block|{
if|if
condition|(
operator|!
name|F_ISSET
argument_list|(
name|sp
argument_list|,
name|SC_AT_SET
argument_list|)
condition|)
block|{
name|ex_emsg
argument_list|(
name|sp
argument_list|,
name|NULL
argument_list|,
name|EXM_NOPREVBUF
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|name
operator|=
name|sp
operator|->
name|at_lbuf
expr_stmt|;
block|}
name|F_SET
argument_list|(
name|sp
argument_list|,
name|SC_AT_SET
argument_list|)
expr_stmt|;
name|CBNAME
argument_list|(
name|sp
argument_list|,
name|cbp
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|cbp
operator|==
name|NULL
condition|)
block|{
name|ex_emsg
argument_list|(
name|sp
argument_list|,
name|KEY_NAME
argument_list|(
name|sp
argument_list|,
name|name
argument_list|)
argument_list|,
name|EXM_EMPTYBUF
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* Save for reuse. */
name|sp
operator|->
name|at_lbuf
operator|=
name|name
expr_stmt|;
comment|/* 	 * The buffer is executed in vi mode, while in vi mode, so simply 	 * push it onto the terminal queue and continue. 	 * 	 * !!! 	 * Historic practice is that if the buffer was cut in line mode, 	 *<newlines> were appended to each line as it was pushed onto 	 * the stack.  If the buffer was cut in character mode,<newlines> 	 * were appended to all lines but the last one. 	 * 	 * XXX 	 * Historic practice is that execution of an @ buffer could be 	 * undone by a single 'u' command, i.e. the changes were grouped 	 * together.  We don't get this right; I'm waiting for the new DB 	 * logging code to be available. 	 */
for|for
control|(
name|tp
operator|=
name|cbp
operator|->
name|textq
operator|.
name|cqh_last
init|;
name|tp
operator|!=
operator|(
name|void
operator|*
operator|)
operator|&
name|cbp
operator|->
name|textq
condition|;
name|tp
operator|=
name|tp
operator|->
name|q
operator|.
name|cqe_prev
control|)
if|if
condition|(
operator|(
name|F_ISSET
argument_list|(
name|cbp
argument_list|,
name|CB_LMODE
argument_list|)
operator|||
name|tp
operator|->
name|q
operator|.
name|cqe_next
operator|!=
operator|(
name|void
operator|*
operator|)
operator|&
name|cbp
operator|->
name|textq
operator|)
operator|&&
name|v_event_push
argument_list|(
name|sp
argument_list|,
name|NULL
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
operator|||
name|v_event_push
argument_list|(
name|sp
argument_list|,
name|NULL
argument_list|,
name|tp
operator|->
name|lb
argument_list|,
name|tp
operator|->
name|len
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* 	 * !!! 	 * If any count was supplied, it applies to the first command in the 	 * at buffer. 	 */
if|if
condition|(
name|F_ISSET
argument_list|(
name|vp
argument_list|,
name|VC_C1SET
argument_list|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|nbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|nbuf
argument_list|)
argument_list|,
literal|"%lu"
argument_list|,
name|vp
operator|->
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|v_event_push
argument_list|(
name|sp
argument_list|,
name|NULL
argument_list|,
name|nbuf
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


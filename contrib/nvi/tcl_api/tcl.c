begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1992, 1993, 1994  *	The Regents of the University of California.  All rights reserved.  * Copyright (c) 1992, 1993, 1994, 1995  *	Keith Bostic.  All rights reserved.  * Copyright (c) 1995  *	George V. Neville-Neil. All rights reserved.  *  * See the LICENSE file for redistribution information.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|sccsid
index|[]
init|=
literal|"@(#)tcl.c	8.16 (Berkeley) 10/16/96"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<bitstring.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<tcl.h>
end_include

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"../common/common.h"
end_include

begin_include
include|#
directive|include
file|"tcl_extern.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|getint
name|__P
argument_list|(
operator|(
name|Tcl_Interp
operator|*
operator|,
name|char
operator|*
operator|,
name|char
operator|*
operator|,
name|int
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|getscreenid
name|__P
argument_list|(
operator|(
name|Tcl_Interp
operator|*
operator|,
name|SCR
operator|*
operator|*
operator|,
name|char
operator|*
operator|,
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|msghandler
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|GS
modifier|*
name|__global_list
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* XXX */
end_comment

begin_comment
comment|/*  * INITMESSAGE --  *	Macros to point messages at the Tcl message handler.  */
end_comment

begin_define
define|#
directive|define
name|INITMESSAGE
define|\
value|scr_msg = __global_list->scr_msg;				\ 	__global_list->scr_msg = msghandler;
end_define

begin_define
define|#
directive|define
name|ENDMESSAGE
define|\
value|__global_list->scr_msg = scr_msg;
end_define

begin_comment
comment|/*  * tcl_fscreen --  *	Return the screen id associated with file name.  *  * Tcl Command: viFindScreen  * Usage: viFindScreen file  */
end_comment

begin_function
specifier|static
name|int
name|tcl_fscreen
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viFindScreen file"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|NULL
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|interp
operator|->
name|result
argument_list|,
literal|"%d"
argument_list|,
name|sp
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_aline --  *	-- Append the string text after the line in lineNumber.  *  * Tcl Command: viAppendLine  * Usage: viAppendLine screenId lineNumber text  */
end_comment

begin_function
specifier|static
name|int
name|tcl_aline
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|lno
decl_stmt|,
name|rval
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|4
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viAppendLine screenId lineNumber text"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
operator|||
name|getint
argument_list|(
name|interp
argument_list|,
literal|"line number"
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
operator|&
name|lno
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_aline
argument_list|(
name|sp
argument_list|,
operator|(
name|recno_t
operator|)
name|lno
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|,
name|strlen
argument_list|(
name|argv
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
return|return
operator|(
name|rval
condition|?
name|TCL_ERROR
else|:
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_dline --  *	Delete lineNum.  *  * Tcl Command: viDelLine  * Usage: viDelLine screenId lineNum  */
end_comment

begin_function
specifier|static
name|int
name|tcl_dline
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|lno
decl_stmt|,
name|rval
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viDelLine screenId lineNumber"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
operator|||
name|getint
argument_list|(
name|interp
argument_list|,
literal|"line number"
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
operator|&
name|lno
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_dline
argument_list|(
name|sp
argument_list|,
operator|(
name|recno_t
operator|)
name|lno
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
return|return
operator|(
name|rval
condition|?
name|TCL_ERROR
else|:
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_gline --  *	Return lineNumber.  *  * Tcl Command: viGetLine  * Usage: viGetLine screenId lineNumber  */
end_comment

begin_function
specifier|static
name|int
name|tcl_gline
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|lno
decl_stmt|,
name|rval
decl_stmt|;
name|char
modifier|*
name|line
decl_stmt|,
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viGetLine screenId lineNumber"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
operator|||
name|getint
argument_list|(
name|interp
argument_list|,
literal|"line number"
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
operator|&
name|lno
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_gline
argument_list|(
name|sp
argument_list|,
operator|(
name|recno_t
operator|)
name|lno
argument_list|,
operator|&
name|p
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
if|if
condition|(
name|rval
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
if|if
condition|(
operator|(
name|line
operator|=
name|malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* XXX */
name|memmove
argument_list|(
name|line
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|line
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
name|line
argument_list|,
name|TCL_DYNAMIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_iline --  *	Insert the string text after the line in lineNumber.  *  * Tcl Command: viInsertLine  * Usage: viInsertLine screenId lineNumber text  */
end_comment

begin_function
specifier|static
name|int
name|tcl_iline
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|lno
decl_stmt|,
name|rval
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|4
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viInsertLine screenId lineNumber text"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
operator|||
name|getint
argument_list|(
name|interp
argument_list|,
literal|"line number"
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
operator|&
name|lno
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_iline
argument_list|(
name|sp
argument_list|,
operator|(
name|recno_t
operator|)
name|lno
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|,
name|strlen
argument_list|(
name|argv
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
return|return
operator|(
name|rval
condition|?
name|TCL_ERROR
else|:
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_lline --  *	Return the last line in the screen.  *  * Tcl Command: viLastLine  * Usage: viLastLine screenId  */
end_comment

begin_function
specifier|static
name|int
name|tcl_lline
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|;
name|recno_t
name|last
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|rval
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viLastLine screenId"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_lline
argument_list|(
name|sp
argument_list|,
operator|&
name|last
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
if|if
condition|(
name|rval
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|interp
operator|->
name|result
argument_list|,
literal|"%lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|last
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_sline --  *	Set lineNumber to the text supplied.  *  * Tcl Command: viSetLine  * Usage: viSetLine screenId lineNumber text  */
end_comment

begin_function
specifier|static
name|int
name|tcl_sline
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|lno
decl_stmt|,
name|rval
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|4
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viSetLine screenId lineNumber text"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
operator|||
name|getint
argument_list|(
name|interp
argument_list|,
literal|"line number"
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
operator|&
name|lno
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_sline
argument_list|(
name|sp
argument_list|,
operator|(
name|recno_t
operator|)
name|lno
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|,
name|strlen
argument_list|(
name|argv
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
return|return
operator|(
name|rval
condition|?
name|TCL_ERROR
else|:
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_getmark --  *	Return the mark's cursor position as a list with two elements.  *	{line, column}.  *  * Tcl Command: viGetMark  * Usage: viGetMark screenId mark  */
end_comment

begin_function
specifier|static
name|int
name|tcl_getmark
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|MARK
name|cursor
decl_stmt|;
name|SCR
modifier|*
name|sp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|rval
decl_stmt|;
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viGetMark screenId mark"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_getmark
argument_list|(
name|sp
argument_list|,
operator|(
name|int
operator|)
name|argv
index|[
literal|2
index|]
index|[
literal|0
index|]
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
if|if
condition|(
name|rval
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%lu"
argument_list|,
operator|(
name|u_long
operator|)
name|cursor
operator|.
name|lno
argument_list|)
expr_stmt|;
name|Tcl_AppendElement
argument_list|(
name|interp
argument_list|,
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%lu"
argument_list|,
operator|(
name|u_long
operator|)
name|cursor
operator|.
name|cno
argument_list|)
expr_stmt|;
name|Tcl_AppendElement
argument_list|(
name|interp
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_setmark --  *	Set the mark to the line and column numbers supplied.  *  * Tcl Command: viSetMark  * Usage: viSetMark screenId mark line column  */
end_comment

begin_function
specifier|static
name|int
name|tcl_setmark
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|MARK
name|cursor
decl_stmt|;
name|SCR
modifier|*
name|sp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|i
decl_stmt|,
name|rval
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|5
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viSetMark screenId mark line column"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
if|if
condition|(
name|getint
argument_list|(
name|interp
argument_list|,
literal|"line number"
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|,
operator|&
name|i
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|cursor
operator|.
name|lno
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|getint
argument_list|(
name|interp
argument_list|,
literal|"column number"
argument_list|,
name|argv
index|[
literal|4
index|]
argument_list|,
operator|&
name|i
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|cursor
operator|.
name|cno
operator|=
name|i
expr_stmt|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_setmark
argument_list|(
name|sp
argument_list|,
operator|(
name|int
operator|)
name|argv
index|[
literal|2
index|]
index|[
literal|0
index|]
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
return|return
operator|(
name|rval
condition|?
name|TCL_ERROR
else|:
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_getcursor --  *	Return the current cursor position as a list with two elements.  *	{line, column}.  *  * Tcl Command: viGetCursor  * Usage: viGetCursor screenId  */
end_comment

begin_function
specifier|static
name|int
name|tcl_getcursor
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|MARK
name|cursor
decl_stmt|;
name|SCR
modifier|*
name|sp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|rval
decl_stmt|;
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viGetCursor screenId"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_getcursor
argument_list|(
name|sp
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
if|if
condition|(
name|rval
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%lu"
argument_list|,
operator|(
name|u_long
operator|)
name|cursor
operator|.
name|lno
argument_list|)
expr_stmt|;
name|Tcl_AppendElement
argument_list|(
name|interp
argument_list|,
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%lu"
argument_list|,
operator|(
name|u_long
operator|)
name|cursor
operator|.
name|cno
argument_list|)
expr_stmt|;
name|Tcl_AppendElement
argument_list|(
name|interp
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_setcursor --  *	Set the cursor to the line and column numbers supplied.  *  * Tcl Command: viSetCursor  * Usage: viSetCursor screenId line column  */
end_comment

begin_function
specifier|static
name|int
name|tcl_setcursor
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|MARK
name|cursor
decl_stmt|;
name|SCR
modifier|*
name|sp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|i
decl_stmt|,
name|rval
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|4
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viSetCursor screenId line column"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
if|if
condition|(
name|getint
argument_list|(
name|interp
argument_list|,
literal|"screen id"
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
operator|&
name|i
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|cursor
operator|.
name|lno
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|getint
argument_list|(
name|interp
argument_list|,
literal|"screen id"
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|,
operator|&
name|i
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|cursor
operator|.
name|cno
operator|=
name|i
expr_stmt|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_setcursor
argument_list|(
name|sp
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
return|return
operator|(
name|rval
condition|?
name|TCL_ERROR
else|:
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_msg --  *	Set the message line to text.  *  * Tcl Command: viMsg  * Usage: viMsg screenId text  */
end_comment

begin_function
specifier|static
name|int
name|tcl_msg
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viMsg screenId text"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|api_imessage
argument_list|(
name|sp
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_iscreen --  *	Create a new screen.  If a filename is specified then the screen  *	is opened with that file.  *  * Tcl Command: viNewScreen  * Usage: viNewScreen screenId [file]  */
end_comment

begin_function
specifier|static
name|int
name|tcl_iscreen
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|,
modifier|*
name|nsp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|rval
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
operator|&&
name|argc
operator|!=
literal|3
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viNewScreen screenId [file]"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_edit
argument_list|(
name|sp
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
operator|&
name|nsp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
if|if
condition|(
name|rval
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|interp
operator|->
name|result
argument_list|,
literal|"%d"
argument_list|,
name|nsp
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_escreen --  *	End a screen.  *  * Tcl Command: viEndScreen  * Usage: viEndScreen screenId  */
end_comment

begin_function
specifier|static
name|int
name|tcl_escreen
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|rval
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viEndScreen screenId"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_escreen
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
return|return
operator|(
name|rval
condition|?
name|TCL_ERROR
else|:
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_swscreen --  *	Change the current focus to screen.  *  * Tcl Command: viSwitchScreen  * Usage: viSwitchScreen screenId screenId  */
end_comment

begin_function
specifier|static
name|int
name|tcl_swscreen
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|,
modifier|*
name|new
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|rval
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viSwitchScreen cur_screenId new_screenId"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|new
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_swscreen
argument_list|(
name|sp
argument_list|,
name|new
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
return|return
operator|(
name|rval
condition|?
name|TCL_ERROR
else|:
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_map --  *	Associate a key with a tcl procedure.  *  * Tcl Command: viMapKey  * Usage: viMapKey screenId key tclproc  */
end_comment

begin_function
specifier|static
name|int
name|tcl_map
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|rval
decl_stmt|;
name|char
name|command
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|4
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viMapKey screenId key tclproc"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|command
argument_list|,
sizeof|sizeof
argument_list|(
name|command
argument_list|)
argument_list|,
literal|":tcl %s\n"
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|rval
operator|=
name|api_map
argument_list|(
name|sp
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
name|command
argument_list|,
name|strlen
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
return|return
operator|(
name|rval
condition|?
name|TCL_ERROR
else|:
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_unmap --  *	Unmap a key.  *  * Tcl Command: viUnmapKey  * Usage: viUnmMapKey screenId key  */
end_comment

begin_function
specifier|static
name|int
name|tcl_unmap
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|rval
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viUnmapKey screenId key"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_unmap
argument_list|(
name|sp
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
return|return
operator|(
name|rval
condition|?
name|TCL_ERROR
else|:
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_opts_set --  *	Set an option.  *  * Tcl Command: viSetOpt  * Usage: viSetOpt screenId command  */
end_comment

begin_function
specifier|static
name|int
name|tcl_opts_set
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|rval
decl_stmt|;
name|char
modifier|*
name|setting
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viSetOpt screenId command"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
comment|/*rval = api_opts_set(sp, argv[2]);*/
name|MALLOC
argument_list|(
name|sp
argument_list|,
name|setting
argument_list|,
name|char
operator|*
argument_list|,
name|strlen
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
operator|+
literal|6
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|setting
argument_list|,
literal|":set "
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|setting
operator|+
literal|5
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|rval
operator|=
name|api_run_str
argument_list|(
name|sp
argument_list|,
name|setting
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|setting
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
return|return
operator|(
name|rval
condition|?
name|TCL_ERROR
else|:
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_opts_get --  	Return the value of an option.  *	  * Tcl Command: viGetOpt  * Usage: viGetOpt screenId option  */
end_comment

begin_function
specifier|static
name|int
name|tcl_opts_get
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SCR
modifier|*
name|sp
decl_stmt|;
name|void
argument_list|(
argument|*scr_msg
argument_list|)
name|__P
argument_list|(
operator|(
name|SCR
operator|*
operator|,
name|mtype_t
operator|,
name|char
operator|*
operator|,
name|size_t
operator|)
argument_list|)
expr_stmt|;
name|int
name|rval
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
block|{
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
literal|"Usage: viGetOpt screenId option"
argument_list|,
name|TCL_STATIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
block|}
if|if
condition|(
name|getscreenid
argument_list|(
name|interp
argument_list|,
operator|&
name|sp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|INITMESSAGE
expr_stmt|;
name|rval
operator|=
name|api_opts_get
argument_list|(
name|sp
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
operator|&
name|value
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ENDMESSAGE
expr_stmt|;
if|if
condition|(
name|rval
condition|)
return|return
operator|(
name|TCL_ERROR
operator|)
return|;
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
name|value
argument_list|,
name|TCL_DYNAMIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|TCL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * tcl_init --  *	Create the TCL commands used by nvi.  *  * PUBLIC: int tcl_init __P((GS *));  */
end_comment

begin_function
name|int
name|tcl_init
parameter_list|(
name|gp
parameter_list|)
name|GS
modifier|*
name|gp
decl_stmt|;
block|{
name|gp
operator|->
name|tcl_interp
operator|=
name|Tcl_CreateInterp
argument_list|()
expr_stmt|;
if|if
condition|(
name|Tcl_Init
argument_list|(
name|gp
operator|->
name|tcl_interp
argument_list|)
operator|==
name|TCL_ERROR
condition|)
return|return
operator|(
literal|1
operator|)
return|;
define|#
directive|define
name|TCC
parameter_list|(
name|name
parameter_list|,
name|function
parameter_list|)
value|{						\ 	Tcl_CreateCommand(gp->tcl_interp, name, function,		\ 	    (ClientData)NULL, (Tcl_CmdDeleteProc *)NULL);		\ }
name|TCC
argument_list|(
literal|"viAppendLine"
argument_list|,
name|tcl_aline
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viDelLine"
argument_list|,
name|tcl_dline
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viEndScreen"
argument_list|,
name|tcl_escreen
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viFindScreen"
argument_list|,
name|tcl_fscreen
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viGetCursor"
argument_list|,
name|tcl_getcursor
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viGetLine"
argument_list|,
name|tcl_gline
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viGetMark"
argument_list|,
name|tcl_getmark
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viGetOpt"
argument_list|,
name|tcl_opts_get
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viInsertLine"
argument_list|,
name|tcl_iline
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viLastLine"
argument_list|,
name|tcl_lline
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viMapKey"
argument_list|,
name|tcl_map
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viMsg"
argument_list|,
name|tcl_msg
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viNewScreen"
argument_list|,
name|tcl_iscreen
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viSetCursor"
argument_list|,
name|tcl_setcursor
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viSetLine"
argument_list|,
name|tcl_sline
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viSetMark"
argument_list|,
name|tcl_setmark
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viSetOpt"
argument_list|,
name|tcl_opts_set
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viSwitchScreen"
argument_list|,
name|tcl_swscreen
argument_list|)
expr_stmt|;
name|TCC
argument_list|(
literal|"viUnmapKey"
argument_list|,
name|tcl_unmap
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * getscreenid --  *	Get the specified screen pointer.  *  * XXX  * This is fatal.  We can't post a message into vi that we're unable to find  * the screen without first finding the screen... So, this must be the first  * thing a Tcl routine does, and, if it fails, the last as well.  */
end_comment

begin_function
specifier|static
name|int
name|getscreenid
parameter_list|(
name|interp
parameter_list|,
name|spp
parameter_list|,
name|id
parameter_list|,
name|name
parameter_list|)
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|SCR
modifier|*
modifier|*
name|spp
decl_stmt|;
name|char
modifier|*
name|id
decl_stmt|,
decl|*
name|name
decl_stmt|;
end_function

begin_block
block|{
name|int
name|scr_no
decl_stmt|;
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
name|id
operator|!=
name|NULL
operator|&&
name|getint
argument_list|(
name|interp
argument_list|,
literal|"screen id"
argument_list|,
name|id
argument_list|,
operator|&
name|scr_no
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
operator|(
operator|*
name|spp
operator|=
name|api_fscreen
argument_list|(
name|scr_no
argument_list|,
name|name
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"unknown screen id: %s"
argument_list|,
name|name
operator|==
name|NULL
condition|?
name|id
else|:
name|name
argument_list|)
expr_stmt|;
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
name|buf
argument_list|,
name|TCL_VOLATILE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * getint --  *	Get a Tcl integer.  *  * XXX  * This code assumes that both recno_t and size_t are larger than ints.  */
end_comment

begin_function
specifier|static
name|int
name|getint
parameter_list|(
name|interp
parameter_list|,
name|msg
parameter_list|,
name|s
parameter_list|,
name|intp
parameter_list|)
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
name|char
modifier|*
name|msg
decl_stmt|,
decl|*
name|s
decl_stmt|;
end_function

begin_decl_stmt
name|int
modifier|*
name|intp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
name|Tcl_GetInt
argument_list|(
name|interp
argument_list|,
name|s
argument_list|,
name|intp
argument_list|)
operator|==
name|TCL_ERROR
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
operator|*
name|intp
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"illegal %s %s: may not be negative"
argument_list|,
name|msg
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|Tcl_SetResult
argument_list|(
name|interp
argument_list|,
name|buf
argument_list|,
name|TCL_VOLATILE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * msghandler --  *	Tcl message routine so that error messages are processed in  *	Tcl, not in nvi.  */
end_comment

begin_function
specifier|static
name|void
name|msghandler
parameter_list|(
name|sp
parameter_list|,
name|mtype
parameter_list|,
name|msg
parameter_list|,
name|len
parameter_list|)
name|SCR
modifier|*
name|sp
decl_stmt|;
name|mtype_t
name|mtype
decl_stmt|;
name|char
modifier|*
name|msg
decl_stmt|;
name|size_t
name|len
decl_stmt|;
block|{
comment|/* Replace the trailing<newline> with an EOS. */
name|msg
index|[
name|len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|Tcl_SetResult
argument_list|(
name|sp
operator|->
name|gp
operator|->
name|tcl_interp
argument_list|,
name|msg
argument_list|,
name|TCL_VOLATILE
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* dlutils.c - handy functions and definitions for dl_*.xs files  *  * Currently this file is simply #included into dl_*.xs/.c files.  * It should really be split into a dlutils.h and dlutils.c  *  * Modified:  * 29th Feburary 2000 - Alan Burlison: Added functionality to close dlopen'd  *                      files when the interpreter exits  */
end_comment

begin_comment
comment|/* pointer to allocated memory for last error message */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|LastError
init|=
operator|(
name|char
operator|*
operator|)
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* flag for immediate rather than lazy linking (spots unresolved symbol) */
end_comment

begin_decl_stmt
specifier|static
name|int
name|dl_nonlazy
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|DL_LOADONCEONLY
end_ifdef

begin_decl_stmt
specifier|static
name|HV
modifier|*
name|dl_loaded_files
init|=
name|Nullhv
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* only needed on a few systems */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUGGING
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|dl_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* value copied from $DynaLoader::dl_debug */
end_comment

begin_define
define|#
directive|define
name|DLDEBUG
parameter_list|(
name|level
parameter_list|,
name|code
parameter_list|)
value|if (dl_debug>=level) { code; }
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DLDEBUG
parameter_list|(
name|level
parameter_list|,
name|code
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Close all dlopen'd files */
end_comment

begin_function
specifier|static
name|void
name|dl_unload_all_files
parameter_list|(
name|pTHXo_
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|CV
modifier|*
name|sub
decl_stmt|;
name|AV
modifier|*
name|dl_librefs
decl_stmt|;
name|SV
modifier|*
name|dl_libref
decl_stmt|;
if|if
condition|(
operator|(
name|sub
operator|=
name|get_cv
argument_list|(
literal|"DynaLoader::dl_unload_file"
argument_list|,
name|FALSE
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|dl_librefs
operator|=
name|get_av
argument_list|(
literal|"DynaLoader::dl_librefs"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|dl_libref
operator|=
name|av_pop
argument_list|(
name|dl_librefs
argument_list|)
operator|)
operator|!=
operator|&
name|PL_sv_undef
condition|)
block|{
name|dSP
expr_stmt|;
name|ENTER
expr_stmt|;
name|SAVETMPS
expr_stmt|;
name|PUSHMARK
argument_list|(
name|SP
argument_list|)
expr_stmt|;
name|XPUSHs
argument_list|(
name|sv_2mortal
argument_list|(
name|dl_libref
argument_list|)
argument_list|)
expr_stmt|;
name|PUTBACK
expr_stmt|;
name|call_sv
argument_list|(
operator|(
name|SV
operator|*
operator|)
name|sub
argument_list|,
name|G_DISCARD
operator||
name|G_NODEBUG
argument_list|)
expr_stmt|;
name|FREETMPS
expr_stmt|;
name|LEAVE
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dl_generic_private_init
parameter_list|(
name|pTHXo
parameter_list|)
comment|/* called by dl_*.xs dl_private_init() */
block|{
name|char
modifier|*
name|perl_dl_nonlazy
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUGGING
name|SV
modifier|*
name|sv
init|=
name|get_sv
argument_list|(
literal|"DynaLoader::dl_debug"
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|dl_debug
operator|=
name|sv
condition|?
name|SvIV
argument_list|(
name|sv
argument_list|)
else|:
literal|0
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|perl_dl_nonlazy
operator|=
name|getenv
argument_list|(
literal|"PERL_DL_NONLAZY"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|dl_nonlazy
operator|=
name|atoi
argument_list|(
name|perl_dl_nonlazy
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_nonlazy
condition|)
name|DLDEBUG
argument_list|(
literal|1
argument_list|,
name|PerlIO_printf
argument_list|(
name|Perl_debug_log
argument_list|,
literal|"DynaLoader bind mode is 'non-lazy'\n"
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DL_LOADONCEONLY
if|if
condition|(
operator|!
name|dl_loaded_files
condition|)
name|dl_loaded_files
operator|=
name|newHV
argument_list|()
expr_stmt|;
comment|/* provide cache for dl_*.xs if needed */
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DL_UNLOAD_ALL_AT_EXIT
name|call_atexit
argument_list|(
operator|&
name|dl_unload_all_files
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* SaveError() takes printf style args and saves the result in LastError */
end_comment

begin_function
specifier|static
name|void
name|SaveError
parameter_list|(
name|pTHXo_
name|char
modifier|*
name|pat
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|SV
modifier|*
name|msv
decl_stmt|;
name|char
modifier|*
name|message
decl_stmt|;
name|STRLEN
name|len
decl_stmt|;
comment|/* This code is based on croak/warn, see mess() in util.c */
name|va_start
argument_list|(
name|args
argument_list|,
name|pat
argument_list|)
expr_stmt|;
name|msv
operator|=
name|vmess
argument_list|(
name|pat
argument_list|,
operator|&
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|message
operator|=
name|SvPV
argument_list|(
name|msv
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|len
operator|++
expr_stmt|;
comment|/* include terminating null char */
comment|/* Allocate some memory for the error message */
if|if
condition|(
name|LastError
condition|)
name|LastError
operator|=
operator|(
name|char
operator|*
operator|)
name|saferealloc
argument_list|(
name|LastError
argument_list|,
name|len
argument_list|)
expr_stmt|;
else|else
name|LastError
operator|=
operator|(
name|char
operator|*
operator|)
name|safemalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
comment|/* Copy message into LastError (including terminating null char)	*/
name|strncpy
argument_list|(
name|LastError
argument_list|,
name|message
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|DLDEBUG
argument_list|(
literal|2
argument_list|,
name|PerlIO_printf
argument_list|(
name|Perl_debug_log
argument_list|,
literal|"DynaLoader: stored error msg '%s'\n"
argument_list|,
name|LastError
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


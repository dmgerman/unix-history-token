begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"EXTERN.h"
end_include

begin_define
define|#
directive|define
name|PERL_IN_XSUTILS_C
end_define

begin_include
include|#
directive|include
file|"perl.h"
end_include

begin_comment
comment|/*  * Contributed by Spider Boardman (spider.boardman@orb.nashua.nh.us).  */
end_comment

begin_comment
comment|/* package attributes; */
end_comment

begin_function_decl
name|void
name|XS_attributes__warn_reserved
parameter_list|(
name|pTHXo_
name|CV
modifier|*
name|cv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|XS_attributes_reftype
parameter_list|(
name|pTHXo_
name|CV
modifier|*
name|cv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|XS_attributes__modify_attrs
parameter_list|(
name|pTHXo_
name|CV
modifier|*
name|cv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|XS_attributes__guess_stash
parameter_list|(
name|pTHXo_
name|CV
modifier|*
name|cv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|XS_attributes__fetch_attrs
parameter_list|(
name|pTHXo_
name|CV
modifier|*
name|cv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|XS_attributes_bootstrap
parameter_list|(
name|pTHXo_
name|CV
modifier|*
name|cv
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Note that only ${pkg}::bootstrap definitions should go here.  * This helps keep down the start-up time, which is especially  * relevant for users who don't invoke any features which are  * (partially) implemented here.  *  * The various bootstrap definitions can take care of doing  * package-specific newXS() calls.  Since the layout of the  * bundled *.pm files is in a version-specific directory,  * version checks in these bootstrap calls are optional.  */
end_comment

begin_function
name|void
name|Perl_boot_core_xsutils
parameter_list|(
name|pTHX
parameter_list|)
block|{
name|char
modifier|*
name|file
init|=
name|__FILE__
decl_stmt|;
name|newXS
argument_list|(
literal|"attributes::bootstrap"
argument_list|,
name|XS_attributes_bootstrap
argument_list|,
name|file
argument_list|)
expr_stmt|;
block|}
end_function

begin_include
include|#
directive|include
file|"XSUB.h"
end_include

begin_function
specifier|static
name|int
name|modify_SV_attributes
parameter_list|(
name|pTHXo_
name|SV
modifier|*
name|sv
parameter_list|,
name|SV
modifier|*
modifier|*
name|retlist
parameter_list|,
name|SV
modifier|*
modifier|*
name|attrlist
parameter_list|,
name|int
name|numattrs
parameter_list|)
block|{
name|SV
modifier|*
name|attr
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|STRLEN
name|len
decl_stmt|;
name|bool
name|negated
decl_stmt|;
name|int
name|nret
decl_stmt|;
for|for
control|(
name|nret
operator|=
literal|0
init|;
name|numattrs
operator|&&
operator|(
name|attr
operator|=
operator|*
name|attrlist
operator|++
operator|)
condition|;
name|numattrs
operator|--
control|)
block|{
name|name
operator|=
name|SvPV
argument_list|(
name|attr
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|negated
operator|=
operator|(
operator|*
name|name
operator|==
literal|'-'
operator|)
operator|)
condition|)
block|{
name|name
operator|++
expr_stmt|;
name|len
operator|--
expr_stmt|;
block|}
switch|switch
condition|(
name|SvTYPE
argument_list|(
name|sv
argument_list|)
condition|)
block|{
case|case
name|SVt_PVCV
case|:
switch|switch
condition|(
operator|(
name|int
operator|)
name|len
condition|)
block|{
case|case
literal|6
case|:
switch|switch
condition|(
operator|*
name|name
condition|)
block|{
case|case
literal|'l'
case|:
ifdef|#
directive|ifdef
name|CVf_LVALUE
if|if
condition|(
name|strEQ
argument_list|(
name|name
argument_list|,
literal|"lvalue"
argument_list|)
condition|)
block|{
if|if
condition|(
name|negated
condition|)
name|CvFLAGS
argument_list|(
operator|(
name|CV
operator|*
operator|)
name|sv
argument_list|)
operator|&=
operator|~
name|CVf_LVALUE
expr_stmt|;
else|else
name|CvFLAGS
argument_list|(
operator|(
name|CV
operator|*
operator|)
name|sv
argument_list|)
operator||=
name|CVf_LVALUE
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
comment|/* defined CVf_LVALUE */
if|if
condition|(
name|strEQ
argument_list|(
name|name
argument_list|,
literal|"locked"
argument_list|)
condition|)
block|{
if|if
condition|(
name|negated
condition|)
name|CvFLAGS
argument_list|(
operator|(
name|CV
operator|*
operator|)
name|sv
argument_list|)
operator|&=
operator|~
name|CVf_LOCKED
expr_stmt|;
else|else
name|CvFLAGS
argument_list|(
operator|(
name|CV
operator|*
operator|)
name|sv
argument_list|)
operator||=
name|CVf_LOCKED
expr_stmt|;
continue|continue;
block|}
break|break;
case|case
literal|'m'
case|:
if|if
condition|(
name|strEQ
argument_list|(
name|name
argument_list|,
literal|"method"
argument_list|)
condition|)
block|{
if|if
condition|(
name|negated
condition|)
name|CvFLAGS
argument_list|(
operator|(
name|CV
operator|*
operator|)
name|sv
argument_list|)
operator|&=
operator|~
name|CVf_METHOD
expr_stmt|;
else|else
name|CvFLAGS
argument_list|(
operator|(
name|CV
operator|*
operator|)
name|sv
argument_list|)
operator||=
name|CVf_METHOD
expr_stmt|;
continue|continue;
block|}
break|break;
block|}
break|break;
block|}
break|break;
default|default:
comment|/* nothing, yet */
break|break;
block|}
comment|/* anything recognized had a 'continue' above */
operator|*
name|retlist
operator|++
operator|=
name|attr
expr_stmt|;
name|nret
operator|++
expr_stmt|;
block|}
return|return
name|nret
return|;
block|}
end_function

begin_comment
comment|/* package attributes; */
end_comment

begin_macro
name|XS
argument_list|(
argument|XS_attributes_bootstrap
argument_list|)
end_macro

begin_block
block|{
name|dXSARGS
expr_stmt|;
name|char
modifier|*
name|file
init|=
name|__FILE__
decl_stmt|;
name|newXSproto
argument_list|(
literal|"attributes::_warn_reserved"
argument_list|,
name|XS_attributes__warn_reserved
argument_list|,
name|file
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|newXS
argument_list|(
literal|"attributes::_modify_attrs"
argument_list|,
name|XS_attributes__modify_attrs
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|newXSproto
argument_list|(
literal|"attributes::_guess_stash"
argument_list|,
name|XS_attributes__guess_stash
argument_list|,
name|file
argument_list|,
literal|"$"
argument_list|)
expr_stmt|;
name|newXSproto
argument_list|(
literal|"attributes::_fetch_attrs"
argument_list|,
name|XS_attributes__fetch_attrs
argument_list|,
name|file
argument_list|,
literal|"$"
argument_list|)
expr_stmt|;
name|newXSproto
argument_list|(
literal|"attributes::reftype"
argument_list|,
name|XS_attributes_reftype
argument_list|,
name|file
argument_list|,
literal|"$"
argument_list|)
expr_stmt|;
name|XSRETURN
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|XS
argument_list|(
argument|XS_attributes__modify_attrs
argument_list|)
end_macro

begin_block
block|{
name|dXSARGS
expr_stmt|;
name|SV
modifier|*
name|rv
decl_stmt|,
modifier|*
name|sv
decl_stmt|;
if|if
condition|(
name|items
operator|<
literal|1
condition|)
block|{
name|usage
label|:
name|Perl_croak
argument_list|(
name|aTHX_
literal|"Usage: attributes::_modify_attrs $reference, @attributes"
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|ST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|SvOK
argument_list|(
name|rv
argument_list|)
operator|&&
name|SvROK
argument_list|(
name|rv
argument_list|)
operator|)
condition|)
goto|goto
name|usage
goto|;
name|sv
operator|=
name|SvRV
argument_list|(
name|rv
argument_list|)
expr_stmt|;
if|if
condition|(
name|items
operator|>
literal|1
condition|)
name|XSRETURN
argument_list|(
name|modify_SV_attributes
argument_list|(
argument|aTHXo_ sv
argument_list|,
argument|&ST(
literal|0
argument|)
argument_list|,
argument|&ST(
literal|1
argument|)
argument_list|,
argument|items-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|XSRETURN
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|XS
argument_list|(
argument|XS_attributes__fetch_attrs
argument_list|)
end_macro

begin_block
block|{
name|dXSARGS
expr_stmt|;
name|SV
modifier|*
name|rv
decl_stmt|,
modifier|*
name|sv
decl_stmt|;
name|cv_flags_t
name|cvflags
decl_stmt|;
if|if
condition|(
name|items
operator|!=
literal|1
condition|)
block|{
name|usage
label|:
name|Perl_croak
argument_list|(
name|aTHX_
literal|"Usage: attributes::_fetch_attrs $reference"
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|ST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|SP
operator|-=
name|items
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|SvOK
argument_list|(
name|rv
argument_list|)
operator|&&
name|SvROK
argument_list|(
name|rv
argument_list|)
operator|)
condition|)
goto|goto
name|usage
goto|;
name|sv
operator|=
name|SvRV
argument_list|(
name|rv
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SvTYPE
argument_list|(
name|sv
argument_list|)
condition|)
block|{
case|case
name|SVt_PVCV
case|:
name|cvflags
operator|=
name|CvFLAGS
argument_list|(
operator|(
name|CV
operator|*
operator|)
name|sv
argument_list|)
expr_stmt|;
if|if
condition|(
name|cvflags
operator|&
name|CVf_LOCKED
condition|)
name|XPUSHs
argument_list|(
name|sv_2mortal
argument_list|(
name|newSVpvn
argument_list|(
literal|"locked"
argument_list|,
literal|6
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CVf_LVALUE
if|if
condition|(
name|cvflags
operator|&
name|CVf_LVALUE
condition|)
name|XPUSHs
argument_list|(
name|sv_2mortal
argument_list|(
name|newSVpvn
argument_list|(
literal|"lvalue"
argument_list|,
literal|6
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cvflags
operator|&
name|CVf_METHOD
condition|)
name|XPUSHs
argument_list|(
name|sv_2mortal
argument_list|(
name|newSVpvn
argument_list|(
literal|"method"
argument_list|,
literal|6
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|PUTBACK
expr_stmt|;
block|}
end_block

begin_macro
name|XS
argument_list|(
argument|XS_attributes__guess_stash
argument_list|)
end_macro

begin_block
block|{
name|dXSARGS
expr_stmt|;
name|SV
modifier|*
name|rv
decl_stmt|,
modifier|*
name|sv
decl_stmt|;
ifdef|#
directive|ifdef
name|dXSTARGET
name|dXSTARGET
expr_stmt|;
else|#
directive|else
name|SV
modifier|*
name|TARG
init|=
name|sv_newmortal
argument_list|()
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|items
operator|!=
literal|1
condition|)
block|{
name|usage
label|:
name|Perl_croak
argument_list|(
name|aTHX_
literal|"Usage: attributes::_guess_stash $reference"
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|ST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ST
argument_list|(
literal|0
argument_list|)
operator|=
name|TARG
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|SvOK
argument_list|(
name|rv
argument_list|)
operator|&&
name|SvROK
argument_list|(
name|rv
argument_list|)
operator|)
condition|)
goto|goto
name|usage
goto|;
name|sv
operator|=
name|SvRV
argument_list|(
name|rv
argument_list|)
expr_stmt|;
if|if
condition|(
name|SvOBJECT
argument_list|(
name|sv
argument_list|)
condition|)
name|sv_setpv
argument_list|(
name|TARG
argument_list|,
name|HvNAME
argument_list|(
name|SvSTASH
argument_list|(
name|sv
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* this was probably a bad idea */
if|else if (SvPADMY(sv)) 	sv_setsv(TARG,&PL_sv_no);
comment|/* unblessed lexical */
endif|#
directive|endif
else|else
block|{
name|HV
modifier|*
name|stash
init|=
name|Nullhv
decl_stmt|;
switch|switch
condition|(
name|SvTYPE
argument_list|(
name|sv
argument_list|)
condition|)
block|{
case|case
name|SVt_PVCV
case|:
if|if
condition|(
name|CvGV
argument_list|(
name|sv
argument_list|)
operator|&&
name|isGV
argument_list|(
name|CvGV
argument_list|(
name|sv
argument_list|)
argument_list|)
operator|&&
name|GvSTASH
argument_list|(
name|CvGV
argument_list|(
name|sv
argument_list|)
argument_list|)
operator|&&
name|HvNAME
argument_list|(
name|GvSTASH
argument_list|(
name|CvGV
argument_list|(
name|sv
argument_list|)
argument_list|)
argument_list|)
condition|)
name|stash
operator|=
name|GvSTASH
argument_list|(
name|CvGV
argument_list|(
name|sv
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
comment|/* !CvANON(sv)&& */
name|CvSTASH
argument_list|(
name|sv
argument_list|)
operator|&&
name|HvNAME
argument_list|(
name|CvSTASH
argument_list|(
name|sv
argument_list|)
argument_list|)
condition|)
name|stash
operator|=
name|CvSTASH
argument_list|(
name|sv
argument_list|)
expr_stmt|;
break|break;
case|case
name|SVt_PVMG
case|:
if|if
condition|(
operator|!
operator|(
name|SvFAKE
argument_list|(
name|sv
argument_list|)
operator|&&
name|SvTIED_mg
argument_list|(
name|sv
argument_list|,
literal|'*'
argument_list|)
operator|)
condition|)
break|break;
comment|/*FALLTHROUGH*/
case|case
name|SVt_PVGV
case|:
if|if
condition|(
name|GvGP
argument_list|(
name|sv
argument_list|)
operator|&&
name|GvESTASH
argument_list|(
operator|(
name|GV
operator|*
operator|)
name|sv
argument_list|)
operator|&&
name|HvNAME
argument_list|(
name|GvESTASH
argument_list|(
operator|(
name|GV
operator|*
operator|)
name|sv
argument_list|)
argument_list|)
condition|)
name|stash
operator|=
name|GvESTASH
argument_list|(
operator|(
name|GV
operator|*
operator|)
name|sv
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|stash
condition|)
name|sv_setpv
argument_list|(
name|TARG
argument_list|,
name|HvNAME
argument_list|(
name|stash
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|dXSTARGET
name|SvSETMAGIC
argument_list|(
name|TARG
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|XSRETURN
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|XS
argument_list|(
argument|XS_attributes_reftype
argument_list|)
end_macro

begin_block
block|{
name|dXSARGS
expr_stmt|;
name|SV
modifier|*
name|rv
decl_stmt|,
modifier|*
name|sv
decl_stmt|;
ifdef|#
directive|ifdef
name|dXSTARGET
name|dXSTARGET
expr_stmt|;
else|#
directive|else
name|SV
modifier|*
name|TARG
init|=
name|sv_newmortal
argument_list|()
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|items
operator|!=
literal|1
condition|)
block|{
name|usage
label|:
name|Perl_croak
argument_list|(
name|aTHX_
literal|"Usage: attributes::reftype $reference"
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|ST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ST
argument_list|(
literal|0
argument_list|)
operator|=
name|TARG
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|SvOK
argument_list|(
name|rv
argument_list|)
operator|&&
name|SvROK
argument_list|(
name|rv
argument_list|)
operator|)
condition|)
goto|goto
name|usage
goto|;
name|sv
operator|=
name|SvRV
argument_list|(
name|rv
argument_list|)
expr_stmt|;
name|sv_setpv
argument_list|(
name|TARG
argument_list|,
name|sv_reftype
argument_list|(
name|sv
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|dXSTARGET
name|SvSETMAGIC
argument_list|(
name|TARG
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|XSRETURN
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|XS
argument_list|(
argument|XS_attributes__warn_reserved
argument_list|)
end_macro

begin_block
block|{
name|dXSARGS
expr_stmt|;
ifdef|#
directive|ifdef
name|dXSTARGET
name|dXSTARGET
expr_stmt|;
else|#
directive|else
name|SV
modifier|*
name|TARG
init|=
name|sv_newmortal
argument_list|()
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|items
operator|!=
literal|0
condition|)
block|{
name|Perl_croak
argument_list|(
name|aTHX_
literal|"Usage: attributes::_warn_reserved ()"
argument_list|)
expr_stmt|;
block|}
name|EXTEND
argument_list|(
name|SP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ST
argument_list|(
literal|0
argument_list|)
operator|=
name|TARG
expr_stmt|;
name|sv_setiv
argument_list|(
name|TARG
argument_list|,
name|ckWARN
argument_list|(
name|WARN_RESERVED
argument_list|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|dXSTARGET
name|SvSETMAGIC
argument_list|(
name|TARG
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|XSRETURN
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    utf8.c  *  *    Copyright (c) 1998-2000, Larry Wall  *  *    You may distribute under the terms of either the GNU General Public  *    License or the Artistic License, as specified in the README file.  *  */
end_comment

begin_comment
comment|/*  * 'What a fix!' said Sam. 'That's the one place in all the lands we've ever  * heard of that we don't want to see any closer; and that's the one place  * we're trying to get to!  And that's just where we can't get, nohow.'  *  * 'Well do I understand your speech,' he answered in the same language;  * 'yet few strangers do so.  Why then do you not speak in the Common Tongue,  * as is the custom in the West, if you wish to be answered?'  *  * ...the travellers perceived that the floor was paved with stones of many  * hues; branching runes and strange devices intertwined beneath their feet.  */
end_comment

begin_include
include|#
directive|include
file|"EXTERN.h"
end_include

begin_define
define|#
directive|define
name|PERL_IN_UTF8_C
end_define

begin_include
include|#
directive|include
file|"perl.h"
end_include

begin_comment
comment|/* Unicode support */
end_comment

begin_function
name|U8
modifier|*
name|Perl_uv_to_utf8
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|d
parameter_list|,
name|UV
name|uv
parameter_list|)
block|{
if|if
condition|(
name|uv
operator|<
literal|0x80
condition|)
block|{
operator|*
name|d
operator|++
operator|=
name|uv
expr_stmt|;
return|return
name|d
return|;
block|}
if|if
condition|(
name|uv
operator|<
literal|0x800
condition|)
block|{
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|>>
literal|6
operator|)
operator||
literal|0xc0
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
return|return
name|d
return|;
block|}
if|if
condition|(
name|uv
operator|<
literal|0x10000
condition|)
block|{
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|>>
literal|12
operator|)
operator||
literal|0xe0
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|6
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
return|return
name|d
return|;
block|}
if|if
condition|(
name|uv
operator|<
literal|0x200000
condition|)
block|{
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|>>
literal|18
operator|)
operator||
literal|0xf0
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|12
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|6
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
return|return
name|d
return|;
block|}
if|if
condition|(
name|uv
operator|<
literal|0x4000000
condition|)
block|{
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|>>
literal|24
operator|)
operator||
literal|0xf8
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|18
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|12
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|6
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
return|return
name|d
return|;
block|}
if|if
condition|(
name|uv
operator|<
literal|0x80000000
condition|)
block|{
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|>>
literal|30
operator|)
operator||
literal|0xfc
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|24
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|18
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|12
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|6
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
return|return
name|d
return|;
block|}
ifdef|#
directive|ifdef
name|HAS_QUAD
if|if
condition|(
name|uv
operator|<
literal|0x1000000000LL
condition|)
endif|#
directive|endif
block|{
operator|*
name|d
operator|++
operator|=
literal|0xfe
expr_stmt|;
comment|/* Can't match U+FEFF! */
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|30
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|24
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|18
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|12
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|6
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
return|return
name|d
return|;
block|}
ifdef|#
directive|ifdef
name|HAS_QUAD
block|{
operator|*
name|d
operator|++
operator|=
literal|0xff
expr_stmt|;
comment|/* Can't match U+FFFE! */
operator|*
name|d
operator|++
operator|=
literal|0x80
expr_stmt|;
comment|/* 6 Reserved bits */
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|60
operator|)
operator|&
literal|0x0f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
comment|/* 2 Reserved bits */
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|54
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|48
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|42
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|36
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|30
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|24
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|18
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|12
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|6
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
return|return
name|d
return|;
block|}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* Tests if some arbitrary number of bytes begins in a valid UTF-8 character.  * The actual number of bytes in the UTF-8 character will be returned if it  * is valid, otherwise 0. */
end_comment

begin_function
name|int
name|Perl_is_utf8_char
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|s
parameter_list|)
block|{
name|U8
name|u
init|=
operator|*
name|s
decl_stmt|;
name|int
name|slen
decl_stmt|,
name|len
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|u
operator|&
literal|0x80
operator|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
operator|(
name|u
operator|&
literal|0x40
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
operator|(
name|u
operator|&
literal|0x20
operator|)
condition|)
block|{
name|len
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|u
operator|&
literal|0x10
operator|)
condition|)
block|{
name|len
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|u
operator|&
literal|0x08
operator|)
condition|)
block|{
name|len
operator|=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|u
operator|&
literal|0x04
operator|)
condition|)
block|{
name|len
operator|=
literal|5
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|u
operator|&
literal|0x02
operator|)
condition|)
block|{
name|len
operator|=
literal|6
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|u
operator|&
literal|0x01
operator|)
condition|)
block|{
name|len
operator|=
literal|7
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
literal|13
expr_stmt|;
block|}
comment|/* whoa! */
name|slen
operator|=
name|len
operator|-
literal|1
expr_stmt|;
name|s
operator|++
expr_stmt|;
while|while
condition|(
name|slen
operator|--
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|s
operator|&
literal|0xc0
operator|)
operator|!=
literal|0x80
condition|)
return|return
literal|0
return|;
name|s
operator|++
expr_stmt|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|UV
name|Perl_utf8_to_uv
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|s
parameter_list|,
name|I32
modifier|*
name|retlen
parameter_list|)
block|{
name|UV
name|uv
init|=
operator|*
name|s
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|uv
operator|&
literal|0x80
operator|)
condition|)
block|{
if|if
condition|(
name|retlen
condition|)
operator|*
name|retlen
operator|=
literal|1
expr_stmt|;
return|return
operator|*
name|s
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|uv
operator|&
literal|0x40
operator|)
condition|)
block|{
name|dTHR
expr_stmt|;
if|if
condition|(
name|ckWARN_d
argument_list|(
name|WARN_UTF8
argument_list|)
condition|)
name|Perl_warner
argument_list|(
argument|aTHX_ WARN_UTF8
argument_list|,
literal|"Malformed UTF-8 character"
argument_list|)
empty_stmt|;
if|if
condition|(
name|retlen
condition|)
operator|*
name|retlen
operator|=
literal|1
expr_stmt|;
return|return
operator|*
name|s
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|uv
operator|&
literal|0x20
operator|)
condition|)
block|{
name|len
operator|=
literal|2
expr_stmt|;
name|uv
operator|&=
literal|0x1f
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|uv
operator|&
literal|0x10
operator|)
condition|)
block|{
name|len
operator|=
literal|3
expr_stmt|;
name|uv
operator|&=
literal|0x0f
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|uv
operator|&
literal|0x08
operator|)
condition|)
block|{
name|len
operator|=
literal|4
expr_stmt|;
name|uv
operator|&=
literal|0x07
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|uv
operator|&
literal|0x04
operator|)
condition|)
block|{
name|len
operator|=
literal|5
expr_stmt|;
name|uv
operator|&=
literal|0x03
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|uv
operator|&
literal|0x02
operator|)
condition|)
block|{
name|len
operator|=
literal|6
expr_stmt|;
name|uv
operator|&=
literal|0x01
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|uv
operator|&
literal|0x01
operator|)
condition|)
block|{
name|len
operator|=
literal|7
expr_stmt|;
name|uv
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
literal|13
expr_stmt|;
name|uv
operator|=
literal|0
expr_stmt|;
block|}
comment|/* whoa! */
if|if
condition|(
name|retlen
condition|)
operator|*
name|retlen
operator|=
name|len
expr_stmt|;
operator|--
name|len
expr_stmt|;
name|s
operator|++
expr_stmt|;
while|while
condition|(
name|len
operator|--
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|s
operator|&
literal|0xc0
operator|)
operator|!=
literal|0x80
condition|)
block|{
name|dTHR
expr_stmt|;
if|if
condition|(
name|ckWARN_d
argument_list|(
name|WARN_UTF8
argument_list|)
condition|)
name|Perl_warner
argument_list|(
argument|aTHX_ WARN_UTF8
argument_list|,
literal|"Malformed UTF-8 character"
argument_list|)
empty_stmt|;
if|if
condition|(
name|retlen
condition|)
operator|*
name|retlen
operator|-=
name|len
operator|+
literal|1
expr_stmt|;
return|return
literal|0xfffd
return|;
block|}
else|else
name|uv
operator|=
operator|(
name|uv
operator|<<
literal|6
operator|)
operator||
operator|(
operator|*
name|s
operator|++
operator|&
literal|0x3f
operator|)
expr_stmt|;
block|}
return|return
name|uv
return|;
block|}
end_function

begin_comment
comment|/* utf8_distance(a,b) is intended to be a - b in pointer arithmetic */
end_comment

begin_function
name|I32
name|Perl_utf8_distance
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|a
parameter_list|,
name|U8
modifier|*
name|b
parameter_list|)
block|{
name|I32
name|off
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|a
operator|<
name|b
condition|)
block|{
while|while
condition|(
name|a
operator|<
name|b
condition|)
block|{
name|a
operator|+=
name|UTF8SKIP
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|off
operator|--
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|b
operator|<
name|a
condition|)
block|{
name|b
operator|+=
name|UTF8SKIP
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|off
operator|++
expr_stmt|;
block|}
block|}
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* WARNING: do not use the following unless you *know* off is within bounds */
end_comment

begin_function
name|U8
modifier|*
name|Perl_utf8_hop
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|s
parameter_list|,
name|I32
name|off
parameter_list|)
block|{
if|if
condition|(
name|off
operator|>=
literal|0
condition|)
block|{
while|while
condition|(
name|off
operator|--
condition|)
name|s
operator|+=
name|UTF8SKIP
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|off
operator|++
condition|)
block|{
name|s
operator|--
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|&
literal|0x80
condition|)
block|{
while|while
condition|(
operator|(
operator|*
name|s
operator|&
literal|0xc0
operator|)
operator|==
literal|0x80
condition|)
name|s
operator|--
expr_stmt|;
block|}
block|}
block|}
return|return
name|s
return|;
block|}
end_function

begin_comment
comment|/* XXX NOTHING CALLS THE FOLLOWING TWO ROUTINES YET!!! */
end_comment

begin_comment
comment|/*  * Convert native or reversed UTF-16 to UTF-8.  *  * Destination must be pre-extended to 3/2 source.  Do not use in-place.  * We optimize for native, for obvious reasons. */
end_comment

begin_function
name|U8
modifier|*
name|Perl_utf16_to_utf8
parameter_list|(
name|pTHX_
name|U16
modifier|*
name|p
parameter_list|,
name|U8
modifier|*
name|d
parameter_list|,
name|I32
name|bytelen
parameter_list|)
block|{
name|U16
modifier|*
name|pend
init|=
name|p
operator|+
name|bytelen
operator|/
literal|2
decl_stmt|;
while|while
condition|(
name|p
operator|<
name|pend
condition|)
block|{
name|UV
name|uv
init|=
operator|*
name|p
operator|++
decl_stmt|;
if|if
condition|(
name|uv
operator|<
literal|0x80
condition|)
block|{
operator|*
name|d
operator|++
operator|=
name|uv
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|uv
operator|<
literal|0x800
condition|)
block|{
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|>>
literal|6
operator|)
operator||
literal|0xc0
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|uv
operator|>=
literal|0xd800
operator|&&
name|uv
operator|<
literal|0xdbff
condition|)
block|{
comment|/* surrogates */
name|dTHR
expr_stmt|;
name|int
name|low
init|=
operator|*
name|p
operator|++
decl_stmt|;
if|if
condition|(
name|low
operator|<
literal|0xdc00
operator|||
name|low
operator|>=
literal|0xdfff
condition|)
block|{
if|if
condition|(
name|ckWARN_d
argument_list|(
name|WARN_UTF8
argument_list|)
condition|)
name|Perl_warner
argument_list|(
argument|aTHX_ WARN_UTF8
argument_list|,
literal|"Malformed UTF-16 surrogate"
argument_list|)
empty_stmt|;
name|p
operator|--
expr_stmt|;
name|uv
operator|=
literal|0xfffd
expr_stmt|;
block|}
name|uv
operator|=
operator|(
operator|(
name|uv
operator|-
literal|0xd800
operator|)
operator|<<
literal|10
operator|)
operator|+
operator|(
name|low
operator|-
literal|0xdc00
operator|)
operator|+
literal|0x10000
expr_stmt|;
block|}
if|if
condition|(
name|uv
operator|<
literal|0x10000
condition|)
block|{
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|>>
literal|12
operator|)
operator||
literal|0xe0
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|6
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
continue|continue;
block|}
else|else
block|{
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|>>
literal|18
operator|)
operator||
literal|0xf0
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|12
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
operator|(
name|uv
operator|>>
literal|6
operator|)
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
operator|*
name|d
operator|++
operator|=
operator|(
operator|(
name|uv
operator|&
literal|0x3f
operator|)
operator||
literal|0x80
operator|)
expr_stmt|;
continue|continue;
block|}
block|}
return|return
name|d
return|;
block|}
end_function

begin_comment
comment|/* Note: this one is slightly destructive of the source. */
end_comment

begin_function
name|U8
modifier|*
name|Perl_utf16_to_utf8_reversed
parameter_list|(
name|pTHX_
name|U16
modifier|*
name|p
parameter_list|,
name|U8
modifier|*
name|d
parameter_list|,
name|I32
name|bytelen
parameter_list|)
block|{
name|U8
modifier|*
name|s
init|=
operator|(
name|U8
operator|*
operator|)
name|p
decl_stmt|;
name|U8
modifier|*
name|send
init|=
name|s
operator|+
name|bytelen
decl_stmt|;
while|while
condition|(
name|s
operator|<
name|send
condition|)
block|{
name|U8
name|tmp
init|=
name|s
index|[
literal|0
index|]
decl_stmt|;
name|s
index|[
literal|0
index|]
operator|=
name|s
index|[
literal|1
index|]
expr_stmt|;
name|s
index|[
literal|1
index|]
operator|=
name|tmp
expr_stmt|;
name|s
operator|+=
literal|2
expr_stmt|;
block|}
return|return
name|utf16_to_utf8
argument_list|(
name|p
argument_list|,
name|d
argument_list|,
name|bytelen
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* for now these are all defined (inefficiently) in terms of the utf8 versions */
end_comment

begin_function
name|bool
name|Perl_is_uni_alnum
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_alnum
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_alnumc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_alnumc
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_idfirst
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_idfirst
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_alpha
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_alpha
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_ascii
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_ascii
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_space
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_space
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_digit
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_digit
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_upper
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_upper
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_lower
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_lower
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_cntrl
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_cntrl
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_graph
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_graph
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_print
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_print
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_punct
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_punct
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_xdigit
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|is_utf8_xdigit
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|U32
name|Perl_to_uni_upper
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|to_utf8_upper
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|U32
name|Perl_to_uni_title
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|to_utf8_title
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_function
name|U32
name|Perl_to_uni_lower
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
name|U8
name|tmpbuf
index|[
name|UTF8_MAXLEN
index|]
decl_stmt|;
name|uv_to_utf8
argument_list|(
name|tmpbuf
argument_list|,
operator|(
name|UV
operator|)
name|c
argument_list|)
expr_stmt|;
return|return
name|to_utf8_lower
argument_list|(
name|tmpbuf
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* for now these all assume no locale info available for Unicode> 255 */
end_comment

begin_function
name|bool
name|Perl_is_uni_alnum_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_alnum
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_alnumc_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_alnumc
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_idfirst_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_idfirst
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_alpha_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_alpha
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_ascii_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_ascii
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_space_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_space
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_digit_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_digit
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_upper_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_upper
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_lower_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_lower
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_cntrl_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_cntrl
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_graph_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_graph
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_print_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_print
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_punct_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_punct
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_uni_xdigit_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|is_uni_xdigit
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|U32
name|Perl_to_uni_upper_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|to_uni_upper
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|U32
name|Perl_to_uni_title_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|to_uni_title
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|U32
name|Perl_to_uni_lower_lc
parameter_list|(
name|pTHX_
name|U32
name|c
parameter_list|)
block|{
return|return
name|to_uni_lower
argument_list|(
name|c
argument_list|)
return|;
comment|/* XXX no locale support yet */
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_alnum
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_alnum
condition|)
name|PL_utf8_alnum
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsAlnum"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_alnum
argument_list|,
name|p
argument_list|)
return|;
comment|/*    return *p == '_' || is_utf8_alpha(p) || is_utf8_digit(p); */
ifdef|#
directive|ifdef
name|SURPRISINGLY_SLOWER
comment|/* probably because alpha is usually true */
if|if
condition|(
operator|!
name|PL_utf8_alnum
condition|)
name|PL_utf8_alnum
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|""
argument_list|,
name|sv_2mortal
argument_list|(
name|newSVpv
argument_list|(
literal|"+utf8::IsAlpha\n+utf8::IsDigit\n005F\n"
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_alnum
argument_list|,
name|p
argument_list|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_alnumc
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_alnum
condition|)
name|PL_utf8_alnum
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsAlnumC"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_alnum
argument_list|,
name|p
argument_list|)
return|;
comment|/*    return is_utf8_alpha(p) || is_utf8_digit(p); */
ifdef|#
directive|ifdef
name|SURPRISINGLY_SLOWER
comment|/* probably because alpha is usually true */
if|if
condition|(
operator|!
name|PL_utf8_alnum
condition|)
name|PL_utf8_alnum
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|""
argument_list|,
name|sv_2mortal
argument_list|(
name|newSVpv
argument_list|(
literal|"+utf8::IsAlpha\n+utf8::IsDigit\n005F\n"
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_alnum
argument_list|,
name|p
argument_list|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_idfirst
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
return|return
operator|*
name|p
operator|==
literal|'_'
operator|||
name|is_utf8_alpha
argument_list|(
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_alpha
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_alpha
condition|)
name|PL_utf8_alpha
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsAlpha"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_alpha
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_ascii
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_ascii
condition|)
name|PL_utf8_ascii
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsAscii"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_ascii
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_space
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_space
condition|)
name|PL_utf8_space
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsSpace"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_space
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_digit
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_digit
condition|)
name|PL_utf8_digit
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsDigit"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_digit
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_upper
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_upper
condition|)
name|PL_utf8_upper
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsUpper"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_upper
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_lower
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_lower
condition|)
name|PL_utf8_lower
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsLower"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_lower
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_cntrl
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_cntrl
condition|)
name|PL_utf8_cntrl
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsCntrl"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_cntrl
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_graph
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_graph
condition|)
name|PL_utf8_graph
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsGraph"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_graph
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_print
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_print
condition|)
name|PL_utf8_print
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsPrint"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_print
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_punct
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_punct
condition|)
name|PL_utf8_punct
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsPunct"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_punct
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_xdigit
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_xdigit
condition|)
name|PL_utf8_xdigit
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsXDigit"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_xdigit
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|Perl_is_utf8_mark
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|is_utf8_char
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|PL_utf8_mark
condition|)
name|PL_utf8_mark
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"IsM"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|swash_fetch
argument_list|(
name|PL_utf8_mark
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|UV
name|Perl_to_utf8_upper
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
name|UV
name|uv
decl_stmt|;
if|if
condition|(
operator|!
name|PL_utf8_toupper
condition|)
name|PL_utf8_toupper
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"ToUpper"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|uv
operator|=
name|swash_fetch
argument_list|(
name|PL_utf8_toupper
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
name|uv
condition|?
name|uv
else|:
name|utf8_to_uv
argument_list|(
name|p
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|UV
name|Perl_to_utf8_title
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
name|UV
name|uv
decl_stmt|;
if|if
condition|(
operator|!
name|PL_utf8_totitle
condition|)
name|PL_utf8_totitle
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"ToTitle"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|uv
operator|=
name|swash_fetch
argument_list|(
name|PL_utf8_totitle
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
name|uv
condition|?
name|uv
else|:
name|utf8_to_uv
argument_list|(
name|p
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|UV
name|Perl_to_utf8_lower
parameter_list|(
name|pTHX_
name|U8
modifier|*
name|p
parameter_list|)
block|{
name|UV
name|uv
decl_stmt|;
if|if
condition|(
operator|!
name|PL_utf8_tolower
condition|)
name|PL_utf8_tolower
operator|=
name|swash_init
argument_list|(
literal|"utf8"
argument_list|,
literal|"ToLower"
argument_list|,
operator|&
name|PL_sv_undef
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|uv
operator|=
name|swash_fetch
argument_list|(
name|PL_utf8_tolower
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
name|uv
condition|?
name|uv
else|:
name|utf8_to_uv
argument_list|(
name|p
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* a "swash" is a swatch hash */
end_comment

begin_function
name|SV
modifier|*
name|Perl_swash_init
parameter_list|(
name|pTHX_
name|char
modifier|*
name|pkg
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|SV
modifier|*
name|listsv
parameter_list|,
name|I32
name|minbits
parameter_list|,
name|I32
name|none
parameter_list|)
block|{
name|SV
modifier|*
name|retval
decl_stmt|;
name|char
name|tmpbuf
index|[
literal|256
index|]
decl_stmt|;
name|dSP
expr_stmt|;
if|if
condition|(
operator|!
name|gv_stashpv
argument_list|(
name|pkg
argument_list|,
literal|0
argument_list|)
condition|)
block|{
comment|/* demand load utf8 */
name|ENTER
expr_stmt|;
name|Perl_load_module
argument_list|(
argument|aTHX_ PERL_LOADMOD_NOIMPORT
argument_list|,
argument|newSVpv(pkg,
literal|0
argument|)
argument_list|,
argument|Nullsv
argument_list|)
empty_stmt|;
name|LEAVE
expr_stmt|;
block|}
name|SPAGAIN
expr_stmt|;
name|PUSHSTACKi
argument_list|(
name|PERLSI_MAGIC
argument_list|)
expr_stmt|;
name|PUSHMARK
argument_list|(
name|SP
argument_list|)
expr_stmt|;
name|EXTEND
argument_list|(
name|SP
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUSHs
argument_list|(
name|sv_2mortal
argument_list|(
name|newSVpvn
argument_list|(
name|pkg
argument_list|,
name|strlen
argument_list|(
name|pkg
argument_list|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|PUSHs
argument_list|(
name|sv_2mortal
argument_list|(
name|newSVpvn
argument_list|(
name|name
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|PUSHs
argument_list|(
name|listsv
argument_list|)
expr_stmt|;
name|PUSHs
argument_list|(
name|sv_2mortal
argument_list|(
name|newSViv
argument_list|(
name|minbits
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|PUSHs
argument_list|(
name|sv_2mortal
argument_list|(
name|newSViv
argument_list|(
name|none
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|PUTBACK
expr_stmt|;
name|ENTER
expr_stmt|;
name|SAVEI32
argument_list|(
name|PL_hints
argument_list|)
expr_stmt|;
name|PL_hints
operator|=
literal|0
expr_stmt|;
name|save_re_context
argument_list|()
expr_stmt|;
if|if
condition|(
name|PL_curcop
operator|==
operator|&
name|PL_compiling
condition|)
comment|/* XXX ought to be handled by lex_start */
name|strncpy
argument_list|(
name|tmpbuf
argument_list|,
name|PL_tokenbuf
argument_list|,
sizeof|sizeof
name|tmpbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|call_method
argument_list|(
literal|"SWASHNEW"
argument_list|,
name|G_SCALAR
argument_list|)
condition|)
name|retval
operator|=
name|newSVsv
argument_list|(
operator|*
name|PL_stack_sp
operator|--
argument_list|)
expr_stmt|;
else|else
name|retval
operator|=
operator|&
name|PL_sv_undef
expr_stmt|;
name|LEAVE
expr_stmt|;
name|POPSTACK
expr_stmt|;
if|if
condition|(
name|PL_curcop
operator|==
operator|&
name|PL_compiling
condition|)
block|{
name|strncpy
argument_list|(
name|PL_tokenbuf
argument_list|,
name|tmpbuf
argument_list|,
sizeof|sizeof
name|tmpbuf
argument_list|)
expr_stmt|;
name|PL_curcop
operator|->
name|op_private
operator|=
name|PL_hints
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|SvROK
argument_list|(
name|retval
argument_list|)
operator|||
name|SvTYPE
argument_list|(
name|SvRV
argument_list|(
name|retval
argument_list|)
argument_list|)
operator|!=
name|SVt_PVHV
condition|)
name|Perl_croak
argument_list|(
name|aTHX_
literal|"SWASHNEW didn't return an HV ref"
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_function
name|UV
name|Perl_swash_fetch
parameter_list|(
name|pTHX_
name|SV
modifier|*
name|sv
parameter_list|,
name|U8
modifier|*
name|ptr
parameter_list|)
block|{
name|HV
modifier|*
name|hv
init|=
operator|(
name|HV
operator|*
operator|)
name|SvRV
argument_list|(
name|sv
argument_list|)
decl_stmt|;
name|U32
name|klen
init|=
name|UTF8SKIP
argument_list|(
name|ptr
argument_list|)
operator|-
literal|1
decl_stmt|;
name|U32
name|off
init|=
name|ptr
index|[
name|klen
index|]
operator|&
literal|127
decl_stmt|;
comment|/* NB: 64 bit always 0 when len> 1 */
name|STRLEN
name|slen
decl_stmt|;
name|STRLEN
name|needents
init|=
operator|(
name|klen
condition|?
literal|64
else|:
literal|128
operator|)
decl_stmt|;
name|U8
modifier|*
name|tmps
decl_stmt|;
name|U32
name|bit
decl_stmt|;
name|SV
modifier|*
name|retval
decl_stmt|;
comment|/*      * This single-entry cache saves about 1/3 of the utf8 overhead in test      * suite.  (That is, only 7-8% overall over just a hash cache.  Still,      * it's nothing to sniff at.)  Pity we usually come through at least      * two function calls to get here...      *      * NB: this code assumes that swatches are never modified, once generated!      */
if|if
condition|(
name|hv
operator|==
name|PL_last_swash_hv
operator|&&
name|klen
operator|==
name|PL_last_swash_klen
operator|&&
operator|(
operator|!
name|klen
operator|||
name|memEQ
argument_list|(
name|ptr
argument_list|,
name|PL_last_swash_key
argument_list|,
name|klen
argument_list|)
operator|)
condition|)
block|{
name|tmps
operator|=
name|PL_last_swash_tmps
expr_stmt|;
name|slen
operator|=
name|PL_last_swash_slen
expr_stmt|;
block|}
else|else
block|{
comment|/* Try our second-level swatch cache, kept in a hash. */
name|SV
modifier|*
modifier|*
name|svp
init|=
name|hv_fetch
argument_list|(
name|hv
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ptr
argument_list|,
name|klen
argument_list|,
name|FALSE
argument_list|)
decl_stmt|;
comment|/* If not cached, generate it via utf8::SWASHGET */
if|if
condition|(
operator|!
name|svp
operator|||
operator|!
name|SvPOK
argument_list|(
operator|*
name|svp
argument_list|)
operator|||
operator|!
operator|(
name|tmps
operator|=
operator|(
name|U8
operator|*
operator|)
name|SvPV
argument_list|(
operator|*
name|svp
argument_list|,
name|slen
argument_list|)
operator|)
condition|)
block|{
name|dSP
expr_stmt|;
name|ENTER
expr_stmt|;
name|SAVETMPS
expr_stmt|;
name|save_re_context
argument_list|()
expr_stmt|;
name|PUSHSTACKi
argument_list|(
name|PERLSI_MAGIC
argument_list|)
expr_stmt|;
name|PUSHMARK
argument_list|(
name|SP
argument_list|)
expr_stmt|;
name|EXTEND
argument_list|(
name|SP
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|PUSHs
argument_list|(
operator|(
name|SV
operator|*
operator|)
name|sv
argument_list|)
expr_stmt|;
name|PUSHs
argument_list|(
name|sv_2mortal
argument_list|(
name|newSViv
argument_list|(
name|utf8_to_uv
argument_list|(
name|ptr
argument_list|,
literal|0
argument_list|)
operator|&
operator|~
operator|(
name|needents
operator|-
literal|1
operator|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|PUSHs
argument_list|(
name|sv_2mortal
argument_list|(
name|newSViv
argument_list|(
name|needents
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|PUTBACK
expr_stmt|;
if|if
condition|(
name|call_method
argument_list|(
literal|"SWASHGET"
argument_list|,
name|G_SCALAR
argument_list|)
condition|)
name|retval
operator|=
name|newSVsv
argument_list|(
operator|*
name|PL_stack_sp
operator|--
argument_list|)
expr_stmt|;
else|else
name|retval
operator|=
operator|&
name|PL_sv_undef
expr_stmt|;
name|POPSTACK
expr_stmt|;
name|FREETMPS
expr_stmt|;
name|LEAVE
expr_stmt|;
if|if
condition|(
name|PL_curcop
operator|==
operator|&
name|PL_compiling
condition|)
name|PL_curcop
operator|->
name|op_private
operator|=
name|PL_hints
expr_stmt|;
name|svp
operator|=
name|hv_store
argument_list|(
name|hv
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ptr
argument_list|,
name|klen
argument_list|,
name|retval
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svp
operator|||
operator|!
operator|(
name|tmps
operator|=
operator|(
name|U8
operator|*
operator|)
name|SvPV
argument_list|(
operator|*
name|svp
argument_list|,
name|slen
argument_list|)
operator|)
operator|||
name|slen
operator|<
literal|8
condition|)
name|Perl_croak
argument_list|(
name|aTHX_
literal|"SWASHGET didn't return result of proper length"
argument_list|)
expr_stmt|;
block|}
name|PL_last_swash_hv
operator|=
name|hv
expr_stmt|;
name|PL_last_swash_klen
operator|=
name|klen
expr_stmt|;
name|PL_last_swash_tmps
operator|=
name|tmps
expr_stmt|;
name|PL_last_swash_slen
operator|=
name|slen
expr_stmt|;
if|if
condition|(
name|klen
condition|)
name|Copy
argument_list|(
name|ptr
argument_list|,
name|PL_last_swash_key
argument_list|,
name|klen
argument_list|,
name|U8
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
operator|(
name|slen
operator|<<
literal|3
operator|)
operator|/
name|needents
condition|)
block|{
case|case
literal|1
case|:
name|bit
operator|=
literal|1
operator|<<
operator|(
name|off
operator|&
literal|7
operator|)
expr_stmt|;
name|off
operator|>>=
literal|3
expr_stmt|;
return|return
operator|(
name|tmps
index|[
name|off
index|]
operator|&
name|bit
operator|)
operator|!=
literal|0
return|;
case|case
literal|8
case|:
return|return
name|tmps
index|[
name|off
index|]
return|;
case|case
literal|16
case|:
name|off
operator|<<=
literal|1
expr_stmt|;
return|return
operator|(
name|tmps
index|[
name|off
index|]
operator|<<
literal|8
operator|)
operator|+
name|tmps
index|[
name|off
operator|+
literal|1
index|]
return|;
case|case
literal|32
case|:
name|off
operator|<<=
literal|2
expr_stmt|;
return|return
operator|(
name|tmps
index|[
name|off
index|]
operator|<<
literal|24
operator|)
operator|+
operator|(
name|tmps
index|[
name|off
operator|+
literal|1
index|]
operator|<<
literal|16
operator|)
operator|+
operator|(
name|tmps
index|[
name|off
operator|+
literal|2
index|]
operator|<<
literal|8
operator|)
operator|+
name|tmps
index|[
name|off
operator|+
literal|3
index|]
return|;
block|}
name|Perl_croak
argument_list|(
name|aTHX_
literal|"panic: swash_fetch"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


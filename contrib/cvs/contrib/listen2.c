begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* This will develop into the inted-like program which    we may want to use for a server on Win95/NT.  Right now    it is just a test program ("telnet foo 2401" and you'll    get a message).  */
end_comment

begin_include
include|#
directive|include
file|<winsock.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<io.h>
end_include

begin_include
include|#
directive|include
file|<process.h>
end_include

begin_function
name|int
name|main
parameter_list|()
block|{
name|struct
name|sockaddr_in
name|sa
decl_stmt|;
name|SOCKET
name|t
decl_stmt|;
name|SOCKET
name|s
decl_stmt|;
name|WSADATA
name|data
decl_stmt|;
if|if
condition|(
name|WSAStartup
argument_list|(
name|MAKEWORD
argument_list|(
literal|1
argument_list|,
literal|1
argument_list|)
argument_list|,
operator|&
name|data
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cvs: unable to initialize winsock\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|t
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|INVALID_SOCKET
condition|)
block|{
name|printf
argument_list|(
literal|"Error in socket(): %d\n"
argument_list|,
name|WSAGetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sa
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sa
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
name|sa
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
literal|2401
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|t
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sa
argument_list|,
sizeof|sizeof
argument_list|(
name|sa
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Cannot bind(): %d\n"
argument_list|,
name|WSAGetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|listen
argument_list|(
name|t
argument_list|,
literal|1
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Cannot listen(): %d\n"
argument_list|,
name|WSAGetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
literal|1
condition|)
block|{
name|int
name|sasize
init|=
sizeof|sizeof
argument_list|(
name|sa
argument_list|)
decl_stmt|;
if|#
directive|if
literal|0
block|int save_stdin, save_stdout;
endif|#
directive|endif
name|s
operator|=
name|accept
argument_list|(
name|t
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sa
argument_list|,
operator|&
name|sasize
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|INVALID_SOCKET
condition|)
block|{
name|printf
argument_list|(
literal|"Cannot accept(): %d\n"
argument_list|,
name|WSAGetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
comment|/* This, of course, does not work because sockets are 	   not file descriptors and file descriptors are not 	   sockets.  Duh!  */
block|save_stdin = _dup (0); 	if (save_stdin< 0) 	{ 	    printf ("Cannot save stdin: %s\n", strerror (errno)); 	    exit (1); 	} 	save_stdout = _dup (1); 	if (save_stdout< 0) 	{ 	    printf ("Cannot save stdout: %s\n", strerror (errno)); 	    exit (1); 	} 	if (_dup2 (s, 0)< 0) 	{ 	    printf ("Cannot dup stdin: %s\n", strerror (errno)); 	    exit (1); 	} 	if (_dup2 (s, 1)< 0) 	{ 	    printf ("Cannot dup stdout: %s\n", strerror (errno)); 	    exit (1); 	}
comment|/* Of course this will be "cvs" eventually, but "netstat" 	   is for testing.  */
block|if (_spawnl (_P_DETACH, "netstat", "netstat", NULL)< 0) 	{ 	    printf ("Cannot spawn subprocess: %s\n", strerror (errno)); 	    exit (1); 	}
else|#
directive|else
if|if
condition|(
name|send
argument_list|(
name|s
argument_list|,
literal|"hello, world\n"
argument_list|,
literal|13
argument_list|,
literal|0
argument_list|)
operator|==
name|SOCKET_ERROR
condition|)
block|{
comment|/* Note that we do not detect the case in which we sent 	       less than the requested number of bytes.  */
name|printf
argument_list|(
literal|"Cannot send(): %d\n"
argument_list|,
name|WSAGetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|closesocket
argument_list|(
name|s
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Cannot closesocket(): %d\n"
argument_list|,
name|WSAGetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, Brian Berliner and Jeff Polk  * Copyright (c) 1989-1992, Brian Berliner  *   * You may distribute under the terms of the GNU General Public License as  * specified in the README file that comes with the CVS 1.4 kit.  *   * The functions in this file provide an interface for performing   * operations directly on RCS files.   */
end_comment

begin_include
include|#
directive|include
file|"cvs.h"
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_comment
comment|/* For RCS file PATH, make symbolic tag TAG point to revision REV.    This validates that TAG is OK for a user to use.  Return value is    -1 for error (and errno is set to indicate the error), positive for    error (and an error message has been printed), or zero for success.  */
end_comment

begin_function
name|int
name|RCS_settag
parameter_list|(
name|path
parameter_list|,
name|tag
parameter_list|,
name|rev
parameter_list|)
specifier|const
name|char
modifier|*
name|path
decl_stmt|;
specifier|const
name|char
modifier|*
name|tag
decl_stmt|;
specifier|const
name|char
modifier|*
name|rev
decl_stmt|;
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|tag
argument_list|,
name|TAG_BASE
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|tag
argument_list|,
name|TAG_HEAD
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Print the name of the tag might be considered redundant 	   with the caller, which also prints it.  Perhaps this helps 	   clarify why the tag name is considered reserved, I don't 	   know.  */
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"Attempt to add reserved tag name %s"
argument_list|,
name|tag
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|run_setup
argument_list|(
literal|"%s%s -x,v/ -q -N%s:%s"
argument_list|,
name|Rcsbin
argument_list|,
name|RCS
argument_list|,
name|tag
argument_list|,
name|rev
argument_list|)
expr_stmt|;
name|run_arg
argument_list|(
name|path
argument_list|)
expr_stmt|;
return|return
name|run_exec
argument_list|(
name|RUN_TTY
argument_list|,
name|RUN_TTY
argument_list|,
name|RUN_TTY
argument_list|,
name|RUN_NORMAL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* NOERR is 1 to suppress errors--FIXME it would    be better to avoid the errors or some cleaner solution.  */
end_comment

begin_function
name|int
name|RCS_deltag
parameter_list|(
name|path
parameter_list|,
name|tag
parameter_list|,
name|noerr
parameter_list|)
specifier|const
name|char
modifier|*
name|path
decl_stmt|;
specifier|const
name|char
modifier|*
name|tag
decl_stmt|;
name|int
name|noerr
decl_stmt|;
block|{
name|run_setup
argument_list|(
literal|"%s%s -x,v/ -q -N%s"
argument_list|,
name|Rcsbin
argument_list|,
name|RCS
argument_list|,
name|tag
argument_list|)
expr_stmt|;
name|run_arg
argument_list|(
name|path
argument_list|)
expr_stmt|;
return|return
name|run_exec
argument_list|(
name|RUN_TTY
argument_list|,
name|RUN_TTY
argument_list|,
name|noerr
condition|?
name|DEVNULL
else|:
name|RUN_TTY
argument_list|,
name|RUN_NORMAL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* set RCS branch to REV */
end_comment

begin_function
name|int
name|RCS_setbranch
parameter_list|(
name|path
parameter_list|,
name|rev
parameter_list|)
specifier|const
name|char
modifier|*
name|path
decl_stmt|;
specifier|const
name|char
modifier|*
name|rev
decl_stmt|;
block|{
name|run_setup
argument_list|(
literal|"%s%s -x,v/ -q -b%s"
argument_list|,
name|Rcsbin
argument_list|,
name|RCS
argument_list|,
name|rev
condition|?
name|rev
else|:
literal|""
argument_list|)
expr_stmt|;
name|run_arg
argument_list|(
name|path
argument_list|)
expr_stmt|;
return|return
name|run_exec
argument_list|(
name|RUN_TTY
argument_list|,
name|RUN_TTY
argument_list|,
name|RUN_TTY
argument_list|,
name|RUN_NORMAL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Lock revision REV.  NOERR is 1 to suppress errors--FIXME it would    be better to avoid the errors or some cleaner solution.  */
end_comment

begin_function
name|int
name|RCS_lock
parameter_list|(
name|path
parameter_list|,
name|rev
parameter_list|,
name|noerr
parameter_list|)
specifier|const
name|char
modifier|*
name|path
decl_stmt|;
specifier|const
name|char
modifier|*
name|rev
decl_stmt|;
name|int
name|noerr
decl_stmt|;
block|{
name|run_setup
argument_list|(
literal|"%s%s -x,v/ -q -l%s"
argument_list|,
name|Rcsbin
argument_list|,
name|RCS
argument_list|,
name|rev
condition|?
name|rev
else|:
literal|""
argument_list|)
expr_stmt|;
name|run_arg
argument_list|(
name|path
argument_list|)
expr_stmt|;
return|return
name|run_exec
argument_list|(
name|RUN_TTY
argument_list|,
name|RUN_TTY
argument_list|,
name|noerr
condition|?
name|DEVNULL
else|:
name|RUN_TTY
argument_list|,
name|RUN_NORMAL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Unlock revision REV.  NOERR is 1 to suppress errors--FIXME it would    be better to avoid the errors or some cleaner solution.  */
end_comment

begin_function
name|int
name|RCS_unlock
parameter_list|(
name|path
parameter_list|,
name|rev
parameter_list|,
name|noerr
parameter_list|)
specifier|const
name|char
modifier|*
name|path
decl_stmt|;
specifier|const
name|char
modifier|*
name|rev
decl_stmt|;
name|int
name|noerr
decl_stmt|;
block|{
name|run_setup
argument_list|(
literal|"%s%s -x,v/ -q -u%s"
argument_list|,
name|Rcsbin
argument_list|,
name|RCS
argument_list|,
name|rev
condition|?
name|rev
else|:
literal|""
argument_list|)
expr_stmt|;
name|run_arg
argument_list|(
name|path
argument_list|)
expr_stmt|;
return|return
name|run_exec
argument_list|(
name|RUN_TTY
argument_list|,
name|RUN_TTY
argument_list|,
name|noerr
condition|?
name|DEVNULL
else|:
name|RUN_TTY
argument_list|,
name|RUN_NORMAL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Merge revisions REV1 and REV2. */
end_comment

begin_function
name|int
name|RCS_merge
parameter_list|(
name|path
parameter_list|,
name|options
parameter_list|,
name|rev1
parameter_list|,
name|rev2
parameter_list|)
specifier|const
name|char
modifier|*
name|path
decl_stmt|;
specifier|const
name|char
modifier|*
name|options
decl_stmt|;
specifier|const
name|char
modifier|*
name|rev1
decl_stmt|;
specifier|const
name|char
modifier|*
name|rev2
decl_stmt|;
block|{
name|int
name|status
decl_stmt|;
comment|/* XXX - Do merge by hand instead of using rcsmerge, due to -k handling */
name|run_setup
argument_list|(
literal|"%s%s -x,v/ %s -r%s -r%s %s"
argument_list|,
name|Rcsbin
argument_list|,
name|RCS_RCSMERGE
argument_list|,
name|options
argument_list|,
name|rev1
argument_list|,
name|rev2
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|status
operator|=
name|run_exec
argument_list|(
name|RUN_TTY
argument_list|,
name|RUN_TTY
argument_list|,
name|RUN_TTY
argument_list|,
name|RUN_NORMAL
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|HAVE_RCS5
if|if
condition|(
name|status
operator|==
literal|0
condition|)
block|{
comment|/* Run GREP to see if there appear to be conflicts in the file */
name|run_setup
argument_list|(
literal|"%s"
argument_list|,
name|GREP
argument_list|)
expr_stmt|;
name|run_arg
argument_list|(
name|RCS_MERGE_PAT
argument_list|)
expr_stmt|;
name|run_arg
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|status
operator|=
operator|(
name|run_exec
argument_list|(
name|RUN_TTY
argument_list|,
name|DEVNULL
argument_list|,
name|RUN_TTY
argument_list|,
name|RUN_NORMAL
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* Check out a revision from RCSFILE into WORKFILE, or to standard output    if WORKFILE is NULL.  If WORKFILE is "", let RCS pick the working file    name.  TAG is the tag to check out, or NULL if one should check out    the head of the default branch.  OPTIONS is a string such as    -kb or -kkv, for keyword expansion options, or NULL if there are none.    If WORKFILE is NULL, run regardless of noexec; if non-NULL, noexec    inhibits execution.  SOUT is what to do with standard output    (typically RUN_TTY).  If FLAGS& RCS_FLAGS_LOCK, lock it.  If    FLAGS& RCS_FLAGS_FORCE, check out even on top of an existing file.    If NOERR is nonzero, suppress errors.  */
end_comment

begin_function
name|int
name|RCS_checkout
parameter_list|(
name|rcsfile
parameter_list|,
name|workfile
parameter_list|,
name|tag
parameter_list|,
name|options
parameter_list|,
name|sout
parameter_list|,
name|flags
parameter_list|,
name|noerr
parameter_list|)
name|char
modifier|*
name|rcsfile
decl_stmt|;
name|char
modifier|*
name|workfile
decl_stmt|;
name|char
modifier|*
name|tag
decl_stmt|;
name|char
modifier|*
name|options
decl_stmt|;
name|char
modifier|*
name|sout
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|int
name|noerr
decl_stmt|;
block|{
name|run_setup
argument_list|(
literal|"%s%s -x,v/ -q %s%s"
argument_list|,
name|Rcsbin
argument_list|,
name|RCS_CO
argument_list|,
name|tag
condition|?
literal|"-r"
else|:
literal|""
argument_list|,
name|tag
condition|?
name|tag
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|!=
name|NULL
operator|&&
name|options
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|run_arg
argument_list|(
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|workfile
operator|==
name|NULL
condition|)
name|run_arg
argument_list|(
literal|"-p"
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|RCS_FLAGS_LOCK
condition|)
name|run_arg
argument_list|(
literal|"-l"
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|RCS_FLAGS_FORCE
condition|)
name|run_arg
argument_list|(
literal|"-f"
argument_list|)
expr_stmt|;
name|run_arg
argument_list|(
name|rcsfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|workfile
operator|!=
name|NULL
operator|&&
name|workfile
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|run_arg
argument_list|(
name|workfile
argument_list|)
expr_stmt|;
return|return
name|run_exec
argument_list|(
name|RUN_TTY
argument_list|,
name|sout
argument_list|,
name|noerr
condition|?
name|DEVNULL
else|:
name|RUN_TTY
argument_list|,
name|workfile
operator|==
name|NULL
condition|?
operator|(
name|RUN_NORMAL
operator||
name|RUN_REALLY
operator|)
else|:
name|RUN_NORMAL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Check in to RCSFILE with revision REV (which must be greater than the    largest revision) and message MESSAGE (which is checked for legality).    If FLAGS& RCS_FLAGS_DEAD, check in a dead revision.  If NOERR, do not    report errors.  If FLAGS& RCS_FLAGS_QUIET suppress errors somewhat more    selectively.  If FLAGS& RCS_FLAGS_MODTIME, use the working file's    modification time for the checkin time.  WORKFILE is the working file    to check in from, or NULL to use the usual RCS rules for deriving it    from the RCSFILE.  */
end_comment

begin_function
name|int
name|RCS_checkin
parameter_list|(
name|rcsfile
parameter_list|,
name|workfile
parameter_list|,
name|message
parameter_list|,
name|rev
parameter_list|,
name|flags
parameter_list|,
name|noerr
parameter_list|)
name|char
modifier|*
name|rcsfile
decl_stmt|;
name|char
modifier|*
name|workfile
decl_stmt|;
name|char
modifier|*
name|message
decl_stmt|;
name|char
modifier|*
name|rev
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|int
name|noerr
decl_stmt|;
block|{
name|run_setup
argument_list|(
literal|"%s%s -x,v/ -f %s%s"
argument_list|,
name|Rcsbin
argument_list|,
name|RCS_CI
argument_list|,
name|rev
condition|?
literal|"-r"
else|:
literal|""
argument_list|,
name|rev
condition|?
name|rev
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|RCS_FLAGS_DEAD
condition|)
name|run_arg
argument_list|(
literal|"-sdead"
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|RCS_FLAGS_QUIET
condition|)
name|run_arg
argument_list|(
literal|"-q"
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|RCS_FLAGS_MODTIME
condition|)
name|run_arg
argument_list|(
literal|"-d"
argument_list|)
expr_stmt|;
name|run_args
argument_list|(
literal|"-m%s"
argument_list|,
name|make_message_rcslegal
argument_list|(
name|message
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|workfile
operator|!=
name|NULL
condition|)
name|run_arg
argument_list|(
name|workfile
argument_list|)
expr_stmt|;
name|run_arg
argument_list|(
name|rcsfile
argument_list|)
expr_stmt|;
return|return
name|run_exec
argument_list|(
name|RUN_TTY
argument_list|,
name|RUN_TTY
argument_list|,
name|noerr
condition|?
name|DEVNULL
else|:
name|RUN_TTY
argument_list|,
name|RUN_NORMAL
argument_list|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, Brian Berliner and Jeff Polk  * Copyright (c) 1989-1992, Brian Berliner  *   * You may distribute under the terms of the GNU General Public License as  * specified in the README file that comes with the CVS 1.4 kit.  *   * Create Administration.  *   * Creates a CVS administration directory based on the argument repository; the  * "Entries" file is prefilled from the "initrecord" argument.  */
end_comment

begin_include
include|#
directive|include
file|"cvs.h"
end_include

begin_comment
comment|/* update_dir includes dir as its last component.  */
end_comment

begin_function
name|void
name|Create_Admin
parameter_list|(
name|dir
parameter_list|,
name|update_dir
parameter_list|,
name|repository
parameter_list|,
name|tag
parameter_list|,
name|date
parameter_list|,
name|nonbranch
parameter_list|)
name|char
modifier|*
name|dir
decl_stmt|;
name|char
modifier|*
name|update_dir
decl_stmt|;
name|char
modifier|*
name|repository
decl_stmt|;
name|char
modifier|*
name|tag
decl_stmt|;
name|char
modifier|*
name|date
decl_stmt|;
name|int
name|nonbranch
decl_stmt|;
block|{
name|FILE
modifier|*
name|fout
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|char
modifier|*
name|tmp
decl_stmt|;
ifdef|#
directive|ifdef
name|SERVER_SUPPORT
if|if
condition|(
name|trace
condition|)
block|{
name|char
modifier|*
name|wd
init|=
name|xgetwd
argument_list|()
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%c-> Create_Admin (%s, %s, %s, %s, %s) in %s\n"
argument_list|,
operator|(
name|server_active
operator|)
condition|?
literal|'S'
else|:
literal|' '
argument_list|,
name|dir
argument_list|,
name|update_dir
argument_list|,
name|repository
argument_list|,
name|tag
condition|?
name|tag
else|:
literal|""
argument_list|,
name|date
condition|?
name|date
else|:
literal|""
argument_list|,
name|wd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|wd
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|noexec
condition|)
return|return;
name|tmp
operator|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|dir
argument_list|)
operator|+
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%s/%s"
argument_list|,
name|dir
argument_list|,
name|CVSADM
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|CVSADM
argument_list|)
expr_stmt|;
if|if
condition|(
name|isfile
argument_list|(
name|tmp
argument_list|)
condition|)
name|error
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|"there is a version in %s already"
argument_list|,
name|update_dir
argument_list|)
expr_stmt|;
name|make_directory
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
comment|/* record the current cvs root for later use */
name|Create_Root
argument_list|(
name|dir
argument_list|,
name|CVSroot_original
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%s/%s"
argument_list|,
name|dir
argument_list|,
name|CVSADM_REP
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|CVSADM_REP
argument_list|)
expr_stmt|;
name|fout
operator|=
name|CVS_FOPEN
argument_list|(
name|tmp
argument_list|,
literal|"w+"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fout
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|update_dir
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot open %s"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
else|else
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot open %s/%s"
argument_list|,
name|update_dir
argument_list|,
name|CVSADM_REP
argument_list|)
expr_stmt|;
block|}
name|cp
operator|=
name|repository
expr_stmt|;
name|strip_trailing_slashes
argument_list|(
name|cp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RELATIVE_REPOS
comment|/*      * If the Repository file is to hold a relative path, try to strip off      * the leading CVSroot argument.      */
if|if
condition|(
name|CVSroot_directory
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|path
init|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|CVSroot_directory
argument_list|)
operator|+
literal|10
argument_list|)
decl_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|path
argument_list|,
literal|"%s/"
argument_list|,
name|CVSroot_directory
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|repository
argument_list|,
name|path
argument_list|,
name|strlen
argument_list|(
name|path
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|cp
operator|=
name|repository
operator|+
name|strlen
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|fprintf
argument_list|(
name|fout
argument_list|,
literal|"%s\n"
argument_list|,
name|cp
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|update_dir
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"write to %s failed"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
else|else
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"write to %s/%s failed"
argument_list|,
name|update_dir
argument_list|,
name|CVSADM_REP
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fclose
argument_list|(
name|fout
argument_list|)
operator|==
name|EOF
condition|)
block|{
if|if
condition|(
name|update_dir
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot close %s"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
else|else
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot close %s/%s"
argument_list|,
name|update_dir
argument_list|,
name|CVSADM_REP
argument_list|)
expr_stmt|;
block|}
comment|/* now, do the Entries file */
if|if
condition|(
name|dir
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%s/%s"
argument_list|,
name|dir
argument_list|,
name|CVSADM_ENT
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|CVSADM_ENT
argument_list|)
expr_stmt|;
name|fout
operator|=
name|CVS_FOPEN
argument_list|(
name|tmp
argument_list|,
literal|"w+"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fout
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|update_dir
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot open %s"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
else|else
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot open %s/%s"
argument_list|,
name|update_dir
argument_list|,
name|CVSADM_ENT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fclose
argument_list|(
name|fout
argument_list|)
operator|==
name|EOF
condition|)
block|{
if|if
condition|(
name|update_dir
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot close %s"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
else|else
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot close %s/%s"
argument_list|,
name|update_dir
argument_list|,
name|CVSADM_ENT
argument_list|)
expr_stmt|;
block|}
comment|/* Create a new CVS/Tag file */
name|WriteTag
argument_list|(
name|dir
argument_list|,
name|tag
argument_list|,
name|date
argument_list|,
name|nonbranch
argument_list|,
name|update_dir
argument_list|,
name|repository
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SERVER_SUPPORT
if|if
condition|(
name|server_active
condition|)
block|{
name|server_template
argument_list|(
name|update_dir
argument_list|,
name|repository
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|trace
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%c<- Create_Admin\n"
argument_list|,
operator|(
name|server_active
operator|)
condition|?
literal|'S'
else|:
literal|' '
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


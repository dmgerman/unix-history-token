begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, Brian Berliner and Jeff Polk  * Copyright (c) 1989-1992, Brian Berliner  *   * You may distribute under the terms of the GNU General Public License as  * specified in the README file that comes with the CVS source distribution.  *   * Difference  *   * Run diff against versions in the repository.  Options that are specified are  * passed on directly to "rcsdiff".  *   * Without any file arguments, runs diff against all the currently modified  * files.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|"cvs.h"
end_include

begin_enum
enum|enum
name|diff_file
block|{
name|DIFF_ERROR
block|,
name|DIFF_ADDED
block|,
name|DIFF_REMOVED
block|,
name|DIFF_DIFFERENT
block|,
name|DIFF_SAME
block|}
enum|;
end_enum

begin_decl_stmt
specifier|static
name|Dtype
name|diff_dirproc
name|PROTO
argument_list|(
operator|(
name|void
operator|*
name|callerdat
operator|,
specifier|const
name|char
operator|*
name|dir
operator|,
specifier|const
name|char
operator|*
name|pos_repos
operator|,
specifier|const
name|char
operator|*
name|update_dir
operator|,
name|List
operator|*
name|entries
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|diff_filesdoneproc
name|PROTO
argument_list|(
operator|(
name|void
operator|*
name|callerdat
operator|,
name|int
name|err
operator|,
specifier|const
name|char
operator|*
name|repos
operator|,
specifier|const
name|char
operator|*
name|update_dir
operator|,
name|List
operator|*
name|entries
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|diff_dirleaveproc
name|PROTO
argument_list|(
operator|(
name|void
operator|*
name|callerdat
operator|,
specifier|const
name|char
operator|*
name|dir
operator|,
name|int
name|err
operator|,
specifier|const
name|char
operator|*
name|update_dir
operator|,
name|List
operator|*
name|entries
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|enum
name|diff_file
name|diff_file_nodiff
name|PROTO
argument_list|(
operator|(
expr|struct
name|file_info
operator|*
name|finfo
operator|,
name|Vers_TS
operator|*
name|vers
operator|,
expr|enum
name|diff_file
operator|,
name|char
operator|*
operator|*
name|rev1_cache
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|diff_fileproc
name|PROTO
argument_list|(
operator|(
name|void
operator|*
name|callerdat
operator|,
expr|struct
name|file_info
operator|*
name|finfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|diff_mark_errors
name|PROTO
argument_list|(
operator|(
name|int
name|err
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Global variables.  Would be cleaner if we just put this stuff in a    struct like log.c does.  */
end_comment

begin_comment
comment|/* Command line tags, from -r option.  Points into argv.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|diff_rev1
decl_stmt|,
modifier|*
name|diff_rev2
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Command line dates, from -D option.  Malloc'd.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|diff_date1
decl_stmt|,
modifier|*
name|diff_date2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|diff_join1
decl_stmt|,
modifier|*
name|diff_join2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|use_rev1
decl_stmt|,
modifier|*
name|use_rev2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|have_rev1_label
decl_stmt|,
name|have_rev2_label
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Revision of the user file, if it is unchanged from something in the    repository and we want to use that fact.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|user_file_rev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|options
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|opts
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|size_t
name|opts_allocated
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|diff_errors
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|empty_files
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|diff_usage
index|[]
init|=
block|{
literal|"Usage: %s %s [-lR] [-k kopt] [format_options]\n"
block|,
literal|"    [[-r rev1 | -D date1] [-r rev2 | -D date2]] [files...] \n"
block|,
literal|"\t-l\tLocal directory only, not recursive\n"
block|,
literal|"\t-R\tProcess directories recursively.\n"
block|,
literal|"\t-k kopt\tSpecify keyword expansion mode.\n"
block|,
literal|"\t-D d1\tDiff revision for date against working file.\n"
block|,
literal|"\t-D d2\tDiff rev1/date1 against date2.\n"
block|,
literal|"\t-r rev1\tDiff revision for rev1 against working file.\n"
block|,
literal|"\t-r rev2\tDiff rev1/date1 against rev2.\n"
block|,
literal|"\nformat_options:\n"
block|,
literal|"  -i  --ignore-case  Consider upper- and lower-case to be the same.\n"
block|,
literal|"  -w  --ignore-all-space  Ignore all white space.\n"
block|,
literal|"  -b  --ignore-space-change  Ignore changes in the amount of white space.\n"
block|,
literal|"  -B  --ignore-blank-lines  Ignore changes whose lines are all blank.\n"
block|,
literal|"  -I RE  --ignore-matching-lines=RE  Ignore changes whose lines all match RE.\n"
block|,
literal|"  --binary  Read and write data in binary mode.\n"
block|,
literal|"  -a  --text  Treat all files as text.\n\n"
block|,
literal|"  -c  -C NUM  --context[=NUM]  Output NUM (default 2) lines of copied context.\n"
block|,
literal|"  -u  -U NUM  --unified[=NUM]  Output NUM (default 2) lines of unified context.\n"
block|,
literal|"    -NUM  Use NUM context lines.\n"
block|,
literal|"    -L LABEL  --label LABEL  Use LABEL instead of file name.\n"
block|,
literal|"    -p  --show-c-function  Show which C function each change is in.\n"
block|,
literal|"    -F RE  --show-function-line=RE  Show the most recent line matching RE.\n"
block|,
literal|"  --brief  Output only whether files differ.\n"
block|,
literal|"  -e  --ed  Output an ed script.\n"
block|,
literal|"  -f  --forward-ed  Output something like an ed script in forward order.\n"
block|,
literal|"  -n  --rcs  Output an RCS format diff.\n"
block|,
literal|"  -y  --side-by-side  Output in two columns.\n"
block|,
literal|"    -W NUM  --width=NUM  Output at most NUM (default 130) characters per line.\n"
block|,
literal|"    --left-column  Output only the left column of common lines.\n"
block|,
literal|"    --suppress-common-lines  Do not output common lines.\n"
block|,
literal|"  --ifdef=NAME  Output merged file to show `#ifdef NAME' diffs.\n"
block|,
literal|"  --GTYPE-group-format=GFMT  Similar, but format GTYPE input groups with GFMT.\n"
block|,
literal|"  --line-format=LFMT  Similar, but format all input lines with LFMT.\n"
block|,
literal|"  --LTYPE-line-format=LFMT  Similar, but format LTYPE input lines with LFMT.\n"
block|,
literal|"    LTYPE is `old', `new', or `unchanged'.  GTYPE is LTYPE or `changed'.\n"
block|,
literal|"    GFMT may contain:\n"
block|,
literal|"      %%<  lines from FILE1\n"
block|,
literal|"      %%>  lines from FILE2\n"
block|,
literal|"      %%=  lines common to FILE1 and FILE2\n"
block|,
literal|"      %%[-][WIDTH][.[PREC]]{doxX}LETTER  printf-style spec for LETTER\n"
block|,
literal|"        LETTERs are as follows for new group, lower case for old group:\n"
block|,
literal|"          F  first line number\n"
block|,
literal|"          L  last line number\n"
block|,
literal|"          N  number of lines = L-F+1\n"
block|,
literal|"          E  F-1\n"
block|,
literal|"          M  L+1\n"
block|,
literal|"    LFMT may contain:\n"
block|,
literal|"      %%L  contents of line\n"
block|,
literal|"      %%l  contents of line, excluding any trailing newline\n"
block|,
literal|"      %%[-][WIDTH][.[PREC]]{doxX}n  printf-style spec for input line number\n"
block|,
literal|"    Either GFMT or LFMT may contain:\n"
block|,
literal|"      %%%%  %%\n"
block|,
literal|"      %%c'C'  the single character C\n"
block|,
literal|"      %%c'\\OOO'  the character with octal code OOO\n\n"
block|,
literal|"  -t  --expand-tabs  Expand tabs to spaces in output.\n"
block|,
literal|"  -T  --initial-tab  Make tabs line up by prepending a tab.\n\n"
block|,
literal|"  -N  --new-file  Treat absent files as empty.\n"
block|,
literal|"  -s  --report-identical-files  Report when two files are the same.\n"
block|,
literal|"  --horizon-lines=NUM  Keep NUM lines of the common prefix and suffix.\n"
block|,
literal|"  -d  --minimal  Try hard to find a smaller set of changes.\n"
block|,
literal|"  -H  --speed-large-files  Assume large files and many scattered small changes.\n"
block|,
literal|"\n(Specify the --help global option for a list of other help options)\n"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* I copied this array directly out of diff.c in diffutils 2.7, after    removing the following entries, none of which seem relevant to use    with CVS:      --help      --version (-v)      --recursive (-r)      --unidirectional-new-file (-P)      --starting-file (-S)      --exclude (-x)      --exclude-from (-X)      --sdiff-merge-assist      --paginate (-l)  (doesn't work with library callbacks)     I changed the options which take optional arguments (--context and    --unified) to return a number rather than a letter, so that the    optional argument could be handled more easily.  I changed the    --brief and --ifdef options to return numbers, since -q  and -D mean    something else to cvs diff.     The numbers 129- that appear in the fourth element of some entries    tell the big switch in `diff' how to process those options. -- Ian     The following options, which diff lists as "An alias, no longer    recommended" have been removed: --file-label --entire-new-file    --ascii --print.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|option
specifier|const
name|longopts
index|[]
init|=
block|{
block|{
literal|"ignore-blank-lines"
block|,
literal|0
block|,
literal|0
block|,
literal|'B'
block|}
block|,
block|{
literal|"context"
block|,
literal|2
block|,
literal|0
block|,
literal|143
block|}
block|,
block|{
literal|"ifdef"
block|,
literal|1
block|,
literal|0
block|,
literal|131
block|}
block|,
block|{
literal|"show-function-line"
block|,
literal|1
block|,
literal|0
block|,
literal|'F'
block|}
block|,
block|{
literal|"speed-large-files"
block|,
literal|0
block|,
literal|0
block|,
literal|'H'
block|}
block|,
block|{
literal|"ignore-matching-lines"
block|,
literal|1
block|,
literal|0
block|,
literal|'I'
block|}
block|,
block|{
literal|"label"
block|,
literal|1
block|,
literal|0
block|,
literal|'L'
block|}
block|,
block|{
literal|"new-file"
block|,
literal|0
block|,
literal|0
block|,
literal|'N'
block|}
block|,
block|{
literal|"initial-tab"
block|,
literal|0
block|,
literal|0
block|,
literal|'T'
block|}
block|,
block|{
literal|"width"
block|,
literal|1
block|,
literal|0
block|,
literal|'W'
block|}
block|,
block|{
literal|"text"
block|,
literal|0
block|,
literal|0
block|,
literal|'a'
block|}
block|,
block|{
literal|"ignore-space-change"
block|,
literal|0
block|,
literal|0
block|,
literal|'b'
block|}
block|,
block|{
literal|"minimal"
block|,
literal|0
block|,
literal|0
block|,
literal|'d'
block|}
block|,
block|{
literal|"ed"
block|,
literal|0
block|,
literal|0
block|,
literal|'e'
block|}
block|,
block|{
literal|"forward-ed"
block|,
literal|0
block|,
literal|0
block|,
literal|'f'
block|}
block|,
block|{
literal|"ignore-case"
block|,
literal|0
block|,
literal|0
block|,
literal|'i'
block|}
block|,
block|{
literal|"rcs"
block|,
literal|0
block|,
literal|0
block|,
literal|'n'
block|}
block|,
block|{
literal|"show-c-function"
block|,
literal|0
block|,
literal|0
block|,
literal|'p'
block|}
block|,
comment|/* This is a potentially very useful option, except the output is so        silly.  It would be much better for it to look like "cvs rdiff -s"        which displays all the same info, minus quite a few lines of        extraneous garbage.  */
block|{
literal|"brief"
block|,
literal|0
block|,
literal|0
block|,
literal|145
block|}
block|,
block|{
literal|"report-identical-files"
block|,
literal|0
block|,
literal|0
block|,
literal|'s'
block|}
block|,
block|{
literal|"expand-tabs"
block|,
literal|0
block|,
literal|0
block|,
literal|'t'
block|}
block|,
block|{
literal|"ignore-all-space"
block|,
literal|0
block|,
literal|0
block|,
literal|'w'
block|}
block|,
block|{
literal|"side-by-side"
block|,
literal|0
block|,
literal|0
block|,
literal|'y'
block|}
block|,
block|{
literal|"unified"
block|,
literal|2
block|,
literal|0
block|,
literal|146
block|}
block|,
block|{
literal|"left-column"
block|,
literal|0
block|,
literal|0
block|,
literal|129
block|}
block|,
block|{
literal|"suppress-common-lines"
block|,
literal|0
block|,
literal|0
block|,
literal|130
block|}
block|,
block|{
literal|"old-line-format"
block|,
literal|1
block|,
literal|0
block|,
literal|132
block|}
block|,
block|{
literal|"new-line-format"
block|,
literal|1
block|,
literal|0
block|,
literal|133
block|}
block|,
block|{
literal|"unchanged-line-format"
block|,
literal|1
block|,
literal|0
block|,
literal|134
block|}
block|,
block|{
literal|"line-format"
block|,
literal|1
block|,
literal|0
block|,
literal|135
block|}
block|,
block|{
literal|"old-group-format"
block|,
literal|1
block|,
literal|0
block|,
literal|136
block|}
block|,
block|{
literal|"new-group-format"
block|,
literal|1
block|,
literal|0
block|,
literal|137
block|}
block|,
block|{
literal|"unchanged-group-format"
block|,
literal|1
block|,
literal|0
block|,
literal|138
block|}
block|,
block|{
literal|"changed-group-format"
block|,
literal|1
block|,
literal|0
block|,
literal|139
block|}
block|,
block|{
literal|"horizon-lines"
block|,
literal|1
block|,
literal|0
block|,
literal|140
block|}
block|,
block|{
literal|"binary"
block|,
literal|0
block|,
literal|0
block|,
literal|142
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* CVS 1.9 and similar versions seemed to have pretty weird handling    of -y and -T.  In the cases where it called rcsdiff,    they would have the meanings mentioned below.  In the cases where it    called diff, they would have the meanings mentioned in "longopts".    Noone seems to have missed them, so I think the right thing to do is    just to remove the options altogether (which I have done).     In the case of -z and -q, "cvs diff" did not accept them even back    when we called rcsdiff (at least, it hasn't accepted them    recently).     In comparing rcsdiff to the new CVS implementation, I noticed that    the following rcsdiff flags are not handled by CVS diff:  	   -y: perform diff even when the requested revisions are the 		   same revision number 	   -q: run quietly 	   -T: preserve modification time on the RCS file 	   -z: specify timezone for use in file labels     I think these are not really relevant.  -y is undocumented even in    RCS 5.7, and seems like a minor change at best.  According to RCS    documentation, -T only applies when a RCS file has been modified    because of lock changes; doesn't CVS sidestep RCS's entire lock    structure?  -z seems to be unsupported by CVS diff, and has a    different meaning as a global option anyway.  (Adding it could be    a feature, but if it is left out for now, it should not break    anything.)  For the purposes of producing output, CVS diff appears    mostly to ignore -q.  Maybe this should be fixed, but I think it's    a larger issue than the changes included here.  */
end_comment

begin_function
name|int
name|diff
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|char
name|tmp
index|[
literal|50
index|]
decl_stmt|;
name|int
name|c
decl_stmt|,
name|err
init|=
literal|0
decl_stmt|;
name|int
name|local
init|=
literal|0
decl_stmt|;
name|int
name|which
decl_stmt|;
name|int
name|option_index
decl_stmt|;
if|if
condition|(
name|argc
operator|==
operator|-
literal|1
condition|)
name|usage
argument_list|(
name|diff_usage
argument_list|)
expr_stmt|;
name|have_rev1_label
operator|=
name|have_rev2_label
operator|=
literal|0
expr_stmt|;
comment|/*      * Note that we catch all the valid arguments here, so that we can      * intercept the -r arguments for doing revision diffs; and -l/-R for a      * non-recursive/recursive diff.      */
comment|/* Clean out our global variables (multiroot can call us multiple        times and the server can too, if the client sends several        diff commands).  */
if|if
condition|(
name|opts
operator|==
name|NULL
condition|)
block|{
name|opts_allocated
operator|=
literal|1
expr_stmt|;
name|opts
operator|=
name|xmalloc
argument_list|(
name|opts_allocated
argument_list|)
expr_stmt|;
block|}
name|opts
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|diff_rev1
operator|=
name|NULL
expr_stmt|;
name|diff_rev2
operator|=
name|NULL
expr_stmt|;
name|diff_date1
operator|=
name|NULL
expr_stmt|;
name|diff_date2
operator|=
name|NULL
expr_stmt|;
name|diff_join1
operator|=
name|NULL
expr_stmt|;
name|diff_join2
operator|=
name|NULL
expr_stmt|;
name|optind
operator|=
literal|0
expr_stmt|;
comment|/* FIXME: This should really be allocating an argv to be passed to diff      * later rather than strcatting onto the opts variable.  We have some      * handling routines that can already handle most of the argc/argv      * maintenance for us and currently, if anyone were to attempt to pass a      * quoted string in here, it would be split on spaces and tabs on its way      * to diff.      */
while|while
condition|(
operator|(
name|c
operator|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"+abcdefhilnpstuwy0123456789BHNRTC:D:F:I:L:U:W:k:r:j:"
argument_list|,
name|longopts
argument_list|,
operator|&
name|option_index
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'y'
case|:
name|xrealloc_and_strcat
argument_list|(
operator|&
name|opts
argument_list|,
operator|&
name|opts_allocated
argument_list|,
literal|" --side-by-side"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
case|case
literal|'b'
case|:
case|case
literal|'c'
case|:
case|case
literal|'d'
case|:
case|case
literal|'e'
case|:
case|case
literal|'f'
case|:
case|case
literal|'h'
case|:
case|case
literal|'i'
case|:
case|case
literal|'n'
case|:
case|case
literal|'p'
case|:
case|case
literal|'s'
case|:
case|case
literal|'t'
case|:
case|case
literal|'u'
case|:
case|case
literal|'w'
case|:
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
case|case
literal|'B'
case|:
case|case
literal|'H'
case|:
case|case
literal|'T'
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|" -%c"
argument_list|,
operator|(
name|char
operator|)
name|c
argument_list|)
expr_stmt|;
name|xrealloc_and_strcat
argument_list|(
operator|&
name|opts
argument_list|,
operator|&
name|opts_allocated
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
if|if
condition|(
name|have_rev1_label
operator|++
condition|)
if|if
condition|(
name|have_rev2_label
operator|++
condition|)
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"extra -L arguments ignored"
argument_list|)
expr_stmt|;
break|break;
block|}
name|xrealloc_and_strcat
argument_list|(
operator|&
name|opts
argument_list|,
operator|&
name|opts_allocated
argument_list|,
literal|" -L"
argument_list|)
expr_stmt|;
name|xrealloc_and_strcat
argument_list|(
operator|&
name|opts
argument_list|,
operator|&
name|opts_allocated
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
case|case
literal|'F'
case|:
case|case
literal|'I'
case|:
case|case
literal|'U'
case|:
case|case
literal|'W'
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|" -%c"
argument_list|,
operator|(
name|char
operator|)
name|c
argument_list|)
expr_stmt|;
name|xrealloc_and_strcat
argument_list|(
operator|&
name|opts
argument_list|,
operator|&
name|opts_allocated
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|xrealloc_and_strcat
argument_list|(
operator|&
name|opts
argument_list|,
operator|&
name|opts_allocated
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|131
case|:
comment|/* --ifdef.  */
name|xrealloc_and_strcat
argument_list|(
operator|&
name|opts
argument_list|,
operator|&
name|opts_allocated
argument_list|,
literal|" --ifdef="
argument_list|)
expr_stmt|;
name|xrealloc_and_strcat
argument_list|(
operator|&
name|opts
argument_list|,
operator|&
name|opts_allocated
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|129
case|:
case|case
literal|130
case|:
case|case
literal|132
case|:
case|case
literal|133
case|:
case|case
literal|134
case|:
case|case
literal|135
case|:
case|case
literal|136
case|:
case|case
literal|137
case|:
case|case
literal|138
case|:
case|case
literal|139
case|:
case|case
literal|140
case|:
case|case
literal|141
case|:
case|case
literal|142
case|:
case|case
literal|143
case|:
case|case
literal|145
case|:
case|case
literal|146
case|:
name|xrealloc_and_strcat
argument_list|(
operator|&
name|opts
argument_list|,
operator|&
name|opts_allocated
argument_list|,
literal|" --"
argument_list|)
expr_stmt|;
name|xrealloc_and_strcat
argument_list|(
operator|&
name|opts
argument_list|,
operator|&
name|opts_allocated
argument_list|,
name|longopts
index|[
name|option_index
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|longopts
index|[
name|option_index
index|]
operator|.
name|has_arg
operator|==
literal|1
operator|||
operator|(
name|longopts
index|[
name|option_index
index|]
operator|.
name|has_arg
operator|==
literal|2
operator|&&
name|optarg
operator|!=
name|NULL
operator|)
condition|)
block|{
name|xrealloc_and_strcat
argument_list|(
operator|&
name|opts
argument_list|,
operator|&
name|opts_allocated
argument_list|,
literal|"="
argument_list|)
expr_stmt|;
name|xrealloc_and_strcat
argument_list|(
operator|&
name|opts
argument_list|,
operator|&
name|opts_allocated
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'R'
case|:
name|local
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|local
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
if|if
condition|(
name|options
condition|)
name|free
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|options
operator|=
name|RCS_check_kflag
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'j'
case|:
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|cpy
init|=
name|strdup
argument_list|(
name|optarg
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|ptr
operator|=
name|strchr
argument_list|(
name|optarg
argument_list|,
literal|':'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|ptr
operator|++
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|diff_rev2
operator|!=
name|NULL
operator|||
name|diff_date2
operator|!=
name|NULL
condition|)
name|error
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|"no more than two revisions/dates can be specified"
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_rev1
operator|!=
name|NULL
operator|||
name|diff_date1
operator|!=
name|NULL
condition|)
block|{
name|diff_join2
operator|=
name|cpy
expr_stmt|;
name|diff_rev2
operator|=
name|optarg
expr_stmt|;
name|diff_date2
operator|=
name|ptr
condition|?
name|Make_Date
argument_list|(
name|ptr
argument_list|)
else|:
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|diff_join1
operator|=
name|cpy
expr_stmt|;
name|diff_rev1
operator|=
name|optarg
expr_stmt|;
name|diff_date1
operator|=
name|ptr
condition|?
name|Make_Date
argument_list|(
name|ptr
argument_list|)
else|:
name|NULL
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'r'
case|:
if|if
condition|(
name|diff_rev2
operator|!=
name|NULL
operator|||
name|diff_date2
operator|!=
name|NULL
condition|)
name|error
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|"no more than two revisions/dates can be specified"
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_rev1
operator|!=
name|NULL
operator|||
name|diff_date1
operator|!=
name|NULL
condition|)
name|diff_rev2
operator|=
name|optarg
expr_stmt|;
else|else
name|diff_rev1
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
if|if
condition|(
name|diff_rev2
operator|!=
name|NULL
operator|||
name|diff_date2
operator|!=
name|NULL
condition|)
name|error
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|"no more than two revisions/dates can be specified"
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_rev1
operator|!=
name|NULL
operator|||
name|diff_date1
operator|!=
name|NULL
condition|)
name|diff_date2
operator|=
name|Make_Date
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
else|else
name|diff_date1
operator|=
name|Make_Date
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
name|empty_files
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
default|default:
name|usage
argument_list|(
name|diff_usage
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
comment|/* make sure options is non-null */
if|if
condition|(
operator|!
name|options
condition|)
name|options
operator|=
name|xstrdup
argument_list|(
literal|""
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CLIENT_SUPPORT
if|if
condition|(
name|current_parsed_root
operator|->
name|isremote
condition|)
block|{
comment|/* We're the client side.  Fire up the remote server.  */
name|start_server
argument_list|()
expr_stmt|;
name|ign_setup
argument_list|()
expr_stmt|;
if|if
condition|(
name|local
condition|)
name|send_arg
argument_list|(
literal|"-l"
argument_list|)
expr_stmt|;
if|if
condition|(
name|empty_files
condition|)
name|send_arg
argument_list|(
literal|"-N"
argument_list|)
expr_stmt|;
name|send_option_string
argument_list|(
name|opts
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|send_arg
argument_list|(
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_join1
condition|)
name|option_with_arg
argument_list|(
literal|"-j"
argument_list|,
name|diff_join1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|diff_rev1
condition|)
name|option_with_arg
argument_list|(
literal|"-r"
argument_list|,
name|diff_rev1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|diff_date1
condition|)
name|client_senddate
argument_list|(
name|diff_date1
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_join2
condition|)
name|option_with_arg
argument_list|(
literal|"-j"
argument_list|,
name|diff_join2
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|diff_rev2
condition|)
name|option_with_arg
argument_list|(
literal|"-r"
argument_list|,
name|diff_rev2
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|diff_date2
condition|)
name|client_senddate
argument_list|(
name|diff_date2
argument_list|)
expr_stmt|;
name|send_arg
argument_list|(
literal|"--"
argument_list|)
expr_stmt|;
comment|/* Send the current files unless diffing two revs from the archive */
if|if
condition|(
name|diff_rev2
operator|==
name|NULL
operator|&&
name|diff_date2
operator|==
name|NULL
condition|)
name|send_files
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|local
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|send_files
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|local
argument_list|,
literal|0
argument_list|,
name|SEND_NO_CONTENTS
argument_list|)
expr_stmt|;
name|send_file_names
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|SEND_EXPAND_WILD
argument_list|)
expr_stmt|;
name|send_to_server
argument_list|(
literal|"diff\012"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|err
operator|=
name|get_responses_and_close
argument_list|()
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
if|if
condition|(
name|diff_rev1
operator|!=
name|NULL
condition|)
name|tag_check_valid
argument_list|(
name|diff_rev1
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|local
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_rev2
operator|!=
name|NULL
condition|)
name|tag_check_valid
argument_list|(
name|diff_rev2
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|local
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|which
operator|=
name|W_LOCAL
expr_stmt|;
if|if
condition|(
name|diff_rev1
operator|!=
name|NULL
operator|||
name|diff_date1
operator|!=
name|NULL
condition|)
name|which
operator||=
name|W_REPOS
operator||
name|W_ATTIC
expr_stmt|;
name|wrap_setup
argument_list|()
expr_stmt|;
comment|/* start the recursion processor */
name|err
operator|=
name|start_recursion
argument_list|(
name|diff_fileproc
argument_list|,
name|diff_filesdoneproc
argument_list|,
name|diff_dirproc
argument_list|,
name|diff_dirleaveproc
argument_list|,
name|NULL
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|local
argument_list|,
name|which
argument_list|,
literal|0
argument_list|,
name|CVS_LOCK_READ
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
comment|/* clean up */
name|free
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|options
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|diff_date1
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|diff_date1
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_date2
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|diff_date2
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_join1
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|diff_join1
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_join2
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|diff_join2
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Do a file diff  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|diff_fileproc
parameter_list|(
name|callerdat
parameter_list|,
name|finfo
parameter_list|)
name|void
modifier|*
name|callerdat
decl_stmt|;
name|struct
name|file_info
modifier|*
name|finfo
decl_stmt|;
block|{
name|int
name|status
decl_stmt|,
name|err
init|=
literal|2
decl_stmt|;
comment|/* 2 == trouble, like rcsdiff */
name|Vers_TS
modifier|*
name|vers
decl_stmt|;
name|enum
name|diff_file
name|empty_file
init|=
name|DIFF_DIFFERENT
decl_stmt|;
name|char
modifier|*
name|tmp
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|tocvsPath
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|fname
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|label1
decl_stmt|;
name|char
modifier|*
name|label2
decl_stmt|;
name|char
modifier|*
name|rev1_cache
init|=
name|NULL
decl_stmt|;
name|user_file_rev
operator|=
literal|0
expr_stmt|;
name|vers
operator|=
name|Version_TS
argument_list|(
name|finfo
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_rev2
operator|!=
name|NULL
operator|||
name|diff_date2
operator|!=
name|NULL
condition|)
block|{
comment|/* Skip all the following checks regarding the user file; we're 	   not using it.  */
block|}
elseif|else
if|if
condition|(
name|vers
operator|->
name|vn_user
operator|==
name|NULL
condition|)
block|{
comment|/* The file does not exist in the working directory.  */
if|if
condition|(
operator|(
name|diff_rev1
operator|!=
name|NULL
operator|||
name|diff_date1
operator|!=
name|NULL
operator|)
operator|&&
name|vers
operator|->
name|srcfile
operator|!=
name|NULL
condition|)
block|{
comment|/* The file does exist in the repository.  */
if|if
condition|(
name|empty_files
condition|)
name|empty_file
operator|=
name|DIFF_REMOVED
expr_stmt|;
else|else
block|{
name|int
name|exists
decl_stmt|;
name|exists
operator|=
literal|0
expr_stmt|;
comment|/* special handling for TAG_HEAD XXX */
if|if
condition|(
name|diff_rev1
operator|&&
name|strcmp
argument_list|(
name|diff_rev1
argument_list|,
name|TAG_HEAD
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|head
init|=
operator|(
name|vers
operator|->
name|vn_rcs
operator|==
name|NULL
condition|?
name|NULL
else|:
name|RCS_branch_head
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
name|vers
operator|->
name|vn_rcs
argument_list|)
operator|)
decl_stmt|;
name|exists
operator|=
name|head
operator|!=
name|NULL
operator|&&
operator|!
name|RCS_isdead
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
name|head
argument_list|)
expr_stmt|;
if|if
condition|(
name|head
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|head
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Vers_TS
modifier|*
name|xvers
decl_stmt|;
name|xvers
operator|=
name|Version_TS
argument_list|(
name|finfo
argument_list|,
name|NULL
argument_list|,
name|diff_rev1
argument_list|,
name|diff_date1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|exists
operator|=
name|xvers
operator|->
name|vn_rcs
operator|!=
name|NULL
operator|&&
operator|!
name|RCS_isdead
argument_list|(
name|xvers
operator|->
name|srcfile
argument_list|,
name|xvers
operator|->
name|vn_rcs
argument_list|)
expr_stmt|;
name|freevers_ts
argument_list|(
operator|&
name|xvers
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|exists
condition|)
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"%s no longer exists, no comparison available"
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"I know nothing about %s"
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|vers
operator|->
name|vn_user
index|[
literal|0
index|]
operator|==
literal|'0'
operator|&&
name|vers
operator|->
name|vn_user
index|[
literal|1
index|]
operator|==
literal|'\0'
condition|)
block|{
comment|/* The file was added locally.  */
name|int
name|exists
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|vers
operator|->
name|srcfile
operator|!=
name|NULL
condition|)
block|{
comment|/* The file does exist in the repository.  */
if|if
condition|(
operator|(
name|diff_rev1
operator|!=
name|NULL
operator|||
name|diff_date1
operator|!=
name|NULL
operator|)
condition|)
block|{
comment|/* special handling for TAG_HEAD */
if|if
condition|(
name|diff_rev1
operator|&&
name|strcmp
argument_list|(
name|diff_rev1
argument_list|,
name|TAG_HEAD
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|head
init|=
operator|(
name|vers
operator|->
name|vn_rcs
operator|==
name|NULL
condition|?
name|NULL
else|:
name|RCS_branch_head
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
name|vers
operator|->
name|vn_rcs
argument_list|)
operator|)
decl_stmt|;
name|exists
operator|=
name|head
operator|!=
name|NULL
operator|&&
operator|!
name|RCS_isdead
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
name|head
argument_list|)
expr_stmt|;
if|if
condition|(
name|head
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|head
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Vers_TS
modifier|*
name|xvers
decl_stmt|;
name|xvers
operator|=
name|Version_TS
argument_list|(
name|finfo
argument_list|,
name|NULL
argument_list|,
name|diff_rev1
argument_list|,
name|diff_date1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|exists
operator|=
name|xvers
operator|->
name|vn_rcs
operator|!=
name|NULL
operator|&&
operator|!
name|RCS_isdead
argument_list|(
name|xvers
operator|->
name|srcfile
argument_list|,
name|xvers
operator|->
name|vn_rcs
argument_list|)
expr_stmt|;
name|freevers_ts
argument_list|(
operator|&
name|xvers
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* The file was added locally, but an RCS archive exists.  Our 		 * base revision must be dead. 		 */
comment|/* No need to set, exists = 0, here.  That's the default.  */
block|}
block|}
if|if
condition|(
operator|!
name|exists
condition|)
block|{
comment|/* If we got here, then either the RCS archive does not exist or 	     * the relevant revision is dead. 	     */
if|if
condition|(
name|empty_files
condition|)
name|empty_file
operator|=
name|DIFF_ADDED
expr_stmt|;
else|else
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"%s is a new entry, no comparison available"
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|vers
operator|->
name|vn_user
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
if|if
condition|(
name|empty_files
condition|)
name|empty_file
operator|=
name|DIFF_REMOVED
expr_stmt|;
else|else
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"%s was removed, no comparison available"
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|vers
operator|->
name|vn_rcs
operator|==
name|NULL
operator|&&
name|vers
operator|->
name|srcfile
operator|==
name|NULL
condition|)
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"cannot find revision control file for %s"
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
else|else
block|{
if|if
condition|(
name|vers
operator|->
name|ts_user
operator|==
name|NULL
condition|)
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"cannot find %s"
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|vers
operator|->
name|ts_user
argument_list|,
name|vers
operator|->
name|ts_rcs
argument_list|)
condition|)
block|{
comment|/* The user file matches some revision in the repository 		   Diff against the repository (for remote CVS, we might not 		   have a copy of the user file around).  */
name|user_file_rev
operator|=
name|vers
operator|->
name|vn_user
expr_stmt|;
block|}
block|}
block|}
name|empty_file
operator|=
name|diff_file_nodiff
argument_list|(
name|finfo
argument_list|,
name|vers
argument_list|,
name|empty_file
argument_list|,
operator|&
name|rev1_cache
argument_list|)
expr_stmt|;
if|if
condition|(
name|empty_file
operator|==
name|DIFF_SAME
condition|)
block|{
comment|/* In the server case, would be nice to send a "Checked-in" 	   response, so that the client can rewrite its timestamp. 	   server_checked_in by itself isn't the right thing (it 	   needs a server_register), but I'm not sure what is. 	   It isn't clear to me how "cvs status" handles this (that 	   is, for a client which sends Modified not Is-modified to 	   "cvs status"), but it does.  */
name|err
operator|=
literal|0
expr_stmt|;
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
name|empty_file
operator|==
name|DIFF_ERROR
condition|)
goto|goto
name|out
goto|;
comment|/* Output an "Index:" line for patch to use */
name|cvs_output
argument_list|(
literal|"Index: "
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cvs_output
argument_list|(
name|finfo
operator|->
name|fullname
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cvs_output
argument_list|(
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tocvsPath
operator|=
name|wrap_tocvs_process_file
argument_list|(
name|finfo
operator|->
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|tocvsPath
operator|!=
name|NULL
condition|)
block|{
comment|/* Backup the current version of the file to CVS/,,filename */
name|fname
operator|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|finfo
operator|->
name|file
argument_list|)
operator|+
sizeof|sizeof
name|CVSADM
operator|+
sizeof|sizeof
name|CVSPREFIX
operator|+
literal|10
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|fname
argument_list|,
literal|"%s/%s%s"
argument_list|,
name|CVSADM
argument_list|,
name|CVSPREFIX
argument_list|,
name|finfo
operator|->
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlink_file_dir
argument_list|(
name|fname
argument_list|)
operator|<
literal|0
condition|)
if|if
condition|(
operator|!
name|existence_error
argument_list|(
name|errno
argument_list|)
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot remove %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|rename_file
argument_list|(
name|finfo
operator|->
name|file
argument_list|,
name|fname
argument_list|)
expr_stmt|;
comment|/* Copy the wrapped file to the current directory then go to work */
name|copy_file
argument_list|(
name|tocvsPath
argument_list|,
name|finfo
operator|->
name|file
argument_list|)
expr_stmt|;
block|}
comment|/* Set up file labels appropriate for compatibility with the Larry Wall      * implementation of patch if the user didn't specify.  This is irrelevant      * according to the POSIX.2 specification.      */
name|label1
operator|=
name|NULL
expr_stmt|;
name|label2
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|have_rev1_label
condition|)
block|{
if|if
condition|(
name|empty_file
operator|==
name|DIFF_ADDED
condition|)
name|label1
operator|=
name|make_file_label
argument_list|(
name|DEVNULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|label1
operator|=
name|make_file_label
argument_list|(
name|finfo
operator|->
name|fullname
argument_list|,
name|use_rev1
argument_list|,
name|vers
condition|?
name|vers
operator|->
name|srcfile
else|:
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|have_rev2_label
condition|)
block|{
if|if
condition|(
name|empty_file
operator|==
name|DIFF_REMOVED
condition|)
name|label2
operator|=
name|make_file_label
argument_list|(
name|DEVNULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|label2
operator|=
name|make_file_label
argument_list|(
name|finfo
operator|->
name|fullname
argument_list|,
name|use_rev2
argument_list|,
name|vers
condition|?
name|vers
operator|->
name|srcfile
else|:
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|empty_file
operator|==
name|DIFF_ADDED
operator|||
name|empty_file
operator|==
name|DIFF_REMOVED
condition|)
block|{
comment|/* This is fullname, not file, possibly despite the POSIX.2 	 * specification, because that's the way all the Larry Wall 	 * implementations of patch (are there other implementations?) want 	 * things and the POSIX.2 spec appears to leave room for this. 	 */
name|cvs_output
argument_list|(
literal|"\ ===================================================================\n\ RCS file: "
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cvs_output
argument_list|(
name|finfo
operator|->
name|fullname
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cvs_output
argument_list|(
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cvs_output
argument_list|(
literal|"diff -N "
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cvs_output
argument_list|(
name|finfo
operator|->
name|fullname
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cvs_output
argument_list|(
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|empty_file
operator|==
name|DIFF_ADDED
condition|)
block|{
if|if
condition|(
name|use_rev2
operator|==
name|NULL
condition|)
name|status
operator|=
name|diff_exec
argument_list|(
name|DEVNULL
argument_list|,
name|finfo
operator|->
name|file
argument_list|,
name|label1
argument_list|,
name|label2
argument_list|,
name|opts
argument_list|,
name|RUN_TTY
argument_list|)
expr_stmt|;
else|else
block|{
name|int
name|retcode
decl_stmt|;
name|tmp
operator|=
name|cvs_temp_name
argument_list|()
expr_stmt|;
name|retcode
operator|=
name|RCS_checkout
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|use_rev2
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
operator|*
name|options
condition|?
name|options
else|:
name|vers
operator|->
name|options
operator|)
argument_list|,
name|tmp
argument_list|,
operator|(
name|RCSCHECKOUTPROC
operator|)
name|NULL
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
name|status
operator|=
name|diff_exec
argument_list|(
name|DEVNULL
argument_list|,
name|tmp
argument_list|,
name|label1
argument_list|,
name|label2
argument_list|,
name|opts
argument_list|,
name|RUN_TTY
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|int
name|retcode
decl_stmt|;
name|tmp
operator|=
name|cvs_temp_name
argument_list|()
expr_stmt|;
name|retcode
operator|=
name|RCS_checkout
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|use_rev1
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|*
name|options
condition|?
name|options
else|:
name|vers
operator|->
name|options
argument_list|,
name|tmp
argument_list|,
operator|(
name|RCSCHECKOUTPROC
operator|)
name|NULL
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
name|status
operator|=
name|diff_exec
argument_list|(
name|tmp
argument_list|,
name|DEVNULL
argument_list|,
name|label1
argument_list|,
name|label2
argument_list|,
name|opts
argument_list|,
name|RUN_TTY
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|status
operator|=
name|RCS_exec_rcsdiff
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
name|opts
argument_list|,
operator|*
name|options
condition|?
name|options
else|:
name|vers
operator|->
name|options
argument_list|,
name|use_rev1
argument_list|,
name|rev1_cache
argument_list|,
name|use_rev2
argument_list|,
name|label1
argument_list|,
name|label2
argument_list|,
name|finfo
operator|->
name|file
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|label1
condition|)
name|free
argument_list|(
name|label1
argument_list|)
expr_stmt|;
if|if
condition|(
name|label2
condition|)
name|free
argument_list|(
name|label2
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
operator|-
literal|1
case|:
comment|/* fork failed */
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"fork failed while diffing %s"
argument_list|,
name|vers
operator|->
name|srcfile
operator|->
name|path
argument_list|)
expr_stmt|;
case|case
literal|0
case|:
comment|/* everything ok */
name|err
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
comment|/* other error */
name|err
operator|=
name|status
expr_stmt|;
break|break;
block|}
name|out
label|:
if|if
condition|(
name|tocvsPath
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|unlink_file_dir
argument_list|(
name|finfo
operator|->
name|file
argument_list|)
operator|<
literal|0
condition|)
if|if
condition|(
operator|!
name|existence_error
argument_list|(
name|errno
argument_list|)
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot remove %s"
argument_list|,
name|finfo
operator|->
name|file
argument_list|)
expr_stmt|;
name|rename_file
argument_list|(
name|fname
argument_list|,
name|finfo
operator|->
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlink_file
argument_list|(
name|tocvsPath
argument_list|)
operator|<
literal|0
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot remove %s"
argument_list|,
name|tocvsPath
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fname
argument_list|)
expr_stmt|;
block|}
comment|/* Call CVS_UNLINK() rather than unlink_file() below to avoid the check      * for noexec.      */
if|if
condition|(
name|tmp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|CVS_UNLINK
argument_list|(
name|tmp
argument_list|)
operator|<
literal|0
condition|)
name|error
argument_list|(
literal|0
argument_list|,
name|errno
argument_list|,
literal|"cannot remove %s"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rev1_cache
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|CVS_UNLINK
argument_list|(
name|rev1_cache
argument_list|)
operator|<
literal|0
condition|)
name|error
argument_list|(
literal|0
argument_list|,
name|errno
argument_list|,
literal|"cannot remove %s"
argument_list|,
name|rev1_cache
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rev1_cache
argument_list|)
expr_stmt|;
block|}
name|freevers_ts
argument_list|(
operator|&
name|vers
argument_list|)
expr_stmt|;
name|diff_mark_errors
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/*  * Remember the exit status for each file.  */
end_comment

begin_function
specifier|static
name|void
name|diff_mark_errors
parameter_list|(
name|err
parameter_list|)
name|int
name|err
decl_stmt|;
block|{
if|if
condition|(
name|err
operator|>
name|diff_errors
condition|)
name|diff_errors
operator|=
name|err
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print a warm fuzzy message when we enter a dir  *  * Don't try to diff directories that don't exist! -- DW  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|Dtype
name|diff_dirproc
parameter_list|(
name|callerdat
parameter_list|,
name|dir
parameter_list|,
name|pos_repos
parameter_list|,
name|update_dir
parameter_list|,
name|entries
parameter_list|)
name|void
modifier|*
name|callerdat
decl_stmt|;
specifier|const
name|char
modifier|*
name|dir
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos_repos
decl_stmt|;
specifier|const
name|char
modifier|*
name|update_dir
decl_stmt|;
name|List
modifier|*
name|entries
decl_stmt|;
block|{
comment|/* XXX - check for dirs we don't want to process??? */
comment|/* YES ... for instance dirs that don't exist!!! -- DW */
if|if
condition|(
operator|!
name|isdir
argument_list|(
name|dir
argument_list|)
condition|)
return|return
operator|(
name|R_SKIP_ALL
operator|)
return|;
if|if
condition|(
operator|!
name|quiet
condition|)
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"Diffing %s"
argument_list|,
name|update_dir
argument_list|)
expr_stmt|;
return|return
operator|(
name|R_PROCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Concoct the proper exit status - done with files  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|diff_filesdoneproc
parameter_list|(
name|callerdat
parameter_list|,
name|err
parameter_list|,
name|repos
parameter_list|,
name|update_dir
parameter_list|,
name|entries
parameter_list|)
name|void
modifier|*
name|callerdat
decl_stmt|;
name|int
name|err
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos
decl_stmt|;
specifier|const
name|char
modifier|*
name|update_dir
decl_stmt|;
name|List
modifier|*
name|entries
decl_stmt|;
block|{
return|return
operator|(
name|diff_errors
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Concoct the proper exit status - leaving directories  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|diff_dirleaveproc
parameter_list|(
name|callerdat
parameter_list|,
name|dir
parameter_list|,
name|err
parameter_list|,
name|update_dir
parameter_list|,
name|entries
parameter_list|)
name|void
modifier|*
name|callerdat
decl_stmt|;
specifier|const
name|char
modifier|*
name|dir
decl_stmt|;
name|int
name|err
decl_stmt|;
specifier|const
name|char
modifier|*
name|update_dir
decl_stmt|;
name|List
modifier|*
name|entries
decl_stmt|;
block|{
return|return
operator|(
name|diff_errors
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * verify that a file is different  */
end_comment

begin_function
specifier|static
name|enum
name|diff_file
name|diff_file_nodiff
parameter_list|(
name|finfo
parameter_list|,
name|vers
parameter_list|,
name|empty_file
parameter_list|,
name|rev1_cache
parameter_list|)
name|struct
name|file_info
modifier|*
name|finfo
decl_stmt|;
name|Vers_TS
modifier|*
name|vers
decl_stmt|;
name|enum
name|diff_file
name|empty_file
decl_stmt|;
name|char
modifier|*
modifier|*
name|rev1_cache
decl_stmt|;
comment|/* Cache the content of rev1 if we have to look 				 * it up. 				 */
block|{
name|Vers_TS
modifier|*
name|xvers
decl_stmt|;
name|int
name|retcode
decl_stmt|;
comment|/* free up any old use_rev* variables and reset 'em */
if|if
condition|(
name|use_rev1
condition|)
name|free
argument_list|(
name|use_rev1
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_rev2
condition|)
name|free
argument_list|(
name|use_rev2
argument_list|)
expr_stmt|;
name|use_rev1
operator|=
name|use_rev2
operator|=
operator|(
name|char
operator|*
operator|)
name|NULL
expr_stmt|;
if|if
condition|(
name|diff_rev1
operator|||
name|diff_date1
condition|)
block|{
comment|/* special handling for TAG_HEAD XXX */
if|if
condition|(
name|diff_rev1
operator|&&
name|strcmp
argument_list|(
name|diff_rev1
argument_list|,
name|TAG_HEAD
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|vers
operator|->
name|vn_rcs
operator|!=
name|NULL
operator|&&
name|vers
operator|->
name|srcfile
operator|!=
name|NULL
condition|)
name|use_rev1
operator|=
name|RCS_branch_head
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
name|vers
operator|->
name|vn_rcs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xvers
operator|=
name|Version_TS
argument_list|(
name|finfo
argument_list|,
name|NULL
argument_list|,
name|diff_rev1
argument_list|,
name|diff_date1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|xvers
operator|->
name|vn_rcs
operator|!=
name|NULL
condition|)
name|use_rev1
operator|=
name|xstrdup
argument_list|(
name|xvers
operator|->
name|vn_rcs
argument_list|)
expr_stmt|;
name|freevers_ts
argument_list|(
operator|&
name|xvers
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|diff_rev2
operator|||
name|diff_date2
condition|)
block|{
comment|/* special handling for TAG_HEAD XXX */
if|if
condition|(
name|diff_rev2
operator|&&
name|strcmp
argument_list|(
name|diff_rev2
argument_list|,
name|TAG_HEAD
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|vers
operator|->
name|vn_rcs
operator|!=
name|NULL
operator|&&
name|vers
operator|->
name|srcfile
operator|!=
name|NULL
condition|)
name|use_rev2
operator|=
name|RCS_branch_head
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
name|vers
operator|->
name|vn_rcs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xvers
operator|=
name|Version_TS
argument_list|(
name|finfo
argument_list|,
name|NULL
argument_list|,
name|diff_rev2
argument_list|,
name|diff_date2
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|xvers
operator|->
name|vn_rcs
operator|!=
name|NULL
condition|)
name|use_rev2
operator|=
name|xstrdup
argument_list|(
name|xvers
operator|->
name|vn_rcs
argument_list|)
expr_stmt|;
name|freevers_ts
argument_list|(
operator|&
name|xvers
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|use_rev1
operator|==
name|NULL
operator|||
name|RCS_isdead
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
name|use_rev1
argument_list|)
condition|)
block|{
comment|/* The first revision does not exist.  If EMPTY_FILES is                true, treat this as an added file.  Otherwise, warn                about the missing tag.  */
if|if
condition|(
name|use_rev2
operator|==
name|NULL
operator|||
name|RCS_isdead
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
name|use_rev2
argument_list|)
condition|)
comment|/* At least in the case where DIFF_REV1 and DIFF_REV2 		 * are both numeric (and non-existant (NULL), as opposed to 		 * dead?), we should be returning some kind of error (see 		 * basicb-8a0 in testsuite).  The symbolic case may be more 		 * complicated. 		 */
return|return
name|DIFF_SAME
return|;
if|if
condition|(
name|empty_files
condition|)
return|return
name|DIFF_ADDED
return|;
if|if
condition|(
name|use_rev1
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|diff_rev1
condition|)
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"Tag %s refers to a dead (removed) revision in file `%s'."
argument_list|,
name|diff_rev1
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"Date %s refers to a dead (removed) revision in file `%s'."
argument_list|,
name|diff_date1
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
block|}
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"No comparison available.  Pass `-N' to `%s diff'?"
argument_list|,
name|program_name
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|diff_rev1
condition|)
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"tag %s is not in file %s"
argument_list|,
name|diff_rev1
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
else|else
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"no revision for date %s in file %s"
argument_list|,
name|diff_date1
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
return|return
name|DIFF_ERROR
return|;
block|}
name|assert
argument_list|(
name|use_rev1
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_rev2
operator|==
name|NULL
operator|||
name|RCS_isdead
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
name|use_rev2
argument_list|)
condition|)
block|{
comment|/* The second revision does not exist.  If EMPTY_FILES is                true, treat this as a removed file.  Otherwise warn                about the missing tag.  */
if|if
condition|(
name|empty_files
condition|)
return|return
name|DIFF_REMOVED
return|;
if|if
condition|(
name|use_rev2
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|diff_rev2
condition|)
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"Tag %s refers to a dead (removed) revision in file `%s'."
argument_list|,
name|diff_rev2
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"Date %s refers to a dead (removed) revision in file `%s'."
argument_list|,
name|diff_date2
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
block|}
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"No comparison available.  Pass `-N' to `%s diff'?"
argument_list|,
name|program_name
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|diff_rev2
condition|)
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"tag %s is not in file %s"
argument_list|,
name|diff_rev2
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
else|else
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"no revision for date %s in file %s"
argument_list|,
name|diff_date2
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
return|return
name|DIFF_ERROR
return|;
block|}
comment|/* Now, see if we really need to do the diff.  We can't assume that the 	 * files are different when the revs are. 	 */
name|assert
argument_list|(
name|use_rev2
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|use_rev1
argument_list|,
name|use_rev2
argument_list|)
operator|==
literal|0
condition|)
return|return
name|DIFF_SAME
return|;
comment|/* else fall through and do the diff */
block|}
comment|/* If we had a r1/d1& r2/d2, then at this point we must have a C3P0...      * err...  ok, then both rev1& rev2 must have resolved to an existing,      * live version due to if statement we just closed.      */
name|assert
argument_list|(
operator|!
operator|(
name|diff_rev2
operator|||
name|diff_date2
operator|)
operator|||
operator|(
name|use_rev1
operator|&&
name|use_rev2
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|diff_rev1
operator|||
name|diff_date1
operator|)
operator|&&
operator|(
name|use_rev1
operator|==
name|NULL
operator|||
name|RCS_isdead
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
name|use_rev1
argument_list|)
operator|)
condition|)
block|{
comment|/* The first revision does not exist, and no second revision            was given.  */
if|if
condition|(
name|empty_files
condition|)
block|{
if|if
condition|(
name|empty_file
operator|==
name|DIFF_REMOVED
condition|)
return|return
name|DIFF_SAME
return|;
if|if
condition|(
name|user_file_rev
operator|&&
name|use_rev2
operator|==
name|NULL
condition|)
name|use_rev2
operator|=
name|xstrdup
argument_list|(
name|user_file_rev
argument_list|)
expr_stmt|;
return|return
name|DIFF_ADDED
return|;
block|}
if|if
condition|(
name|use_rev1
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|diff_rev1
condition|)
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"Tag %s refers to a dead (removed) revision in file `%s'."
argument_list|,
name|diff_rev1
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"Date %s refers to a dead (removed) revision in file `%s'."
argument_list|,
name|diff_date1
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
block|}
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"No comparison available.  Pass `-N' to `%s diff'?"
argument_list|,
name|program_name
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|diff_rev1
condition|)
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"tag %s is not in file %s"
argument_list|,
name|diff_rev1
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
else|else
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"no revision for date %s in file %s"
argument_list|,
name|diff_date1
argument_list|,
name|finfo
operator|->
name|fullname
argument_list|)
expr_stmt|;
return|return
name|DIFF_ERROR
return|;
block|}
name|assert
argument_list|(
operator|!
name|diff_rev1
operator|||
name|use_rev1
argument_list|)
expr_stmt|;
if|if
condition|(
name|user_file_rev
condition|)
block|{
comment|/* drop user_file_rev into first unused use_rev */
if|if
condition|(
operator|!
name|use_rev1
condition|)
name|use_rev1
operator|=
name|xstrdup
argument_list|(
name|user_file_rev
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|use_rev2
condition|)
name|use_rev2
operator|=
name|xstrdup
argument_list|(
name|user_file_rev
argument_list|)
expr_stmt|;
comment|/* and if not, it wasn't needed anyhow */
name|user_file_rev
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Now, see if we really need to do the diff.  We can't assume that the      * files are different when the revs are.      */
if|if
condition|(
name|use_rev1
operator|&&
name|use_rev2
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|use_rev1
argument_list|,
name|use_rev2
argument_list|)
operator|==
literal|0
condition|)
return|return
name|DIFF_SAME
return|;
comment|/* Fall through and do the diff. */
block|}
comment|/* Don't want to do the timestamp check with both use_rev1& use_rev2 set.      * The timestamp check is just for the default case of diffing the      * workspace file against its base revision.      */
elseif|else
if|if
condition|(
name|use_rev1
operator|==
name|NULL
operator|||
operator|(
name|vers
operator|->
name|vn_user
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|use_rev1
argument_list|,
name|vers
operator|->
name|vn_user
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|empty_file
operator|==
name|DIFF_DIFFERENT
operator|&&
name|vers
operator|->
name|ts_user
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|vers
operator|->
name|ts_rcs
argument_list|,
name|vers
operator|->
name|ts_user
argument_list|)
operator|==
literal|0
operator|&&
operator|(
operator|!
operator|(
operator|*
name|options
operator|)
operator|||
name|strcmp
argument_list|(
name|options
argument_list|,
name|vers
operator|->
name|options
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
return|return
name|DIFF_SAME
return|;
block|}
if|if
condition|(
name|use_rev1
operator|==
name|NULL
operator|&&
operator|(
name|vers
operator|->
name|vn_user
index|[
literal|0
index|]
operator|!=
literal|'0'
operator|||
name|vers
operator|->
name|vn_user
index|[
literal|1
index|]
operator|!=
literal|'\0'
operator|)
condition|)
block|{
if|if
condition|(
name|vers
operator|->
name|vn_user
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
name|use_rev1
operator|=
name|xstrdup
argument_list|(
name|vers
operator|->
name|vn_user
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|use_rev1
operator|=
name|xstrdup
argument_list|(
name|vers
operator|->
name|vn_user
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If we already know that the file is being added or removed,        then we don't want to do an actual file comparison here.  */
if|if
condition|(
name|empty_file
operator|!=
name|DIFF_DIFFERENT
condition|)
return|return
name|empty_file
return|;
comment|/*      * Run a quick cmp to see if we should bother with a full diff.      */
name|retcode
operator|=
name|RCS_cmp_file
argument_list|(
name|vers
operator|->
name|srcfile
argument_list|,
name|use_rev1
argument_list|,
name|rev1_cache
argument_list|,
name|use_rev2
argument_list|,
operator|*
name|options
condition|?
name|options
else|:
name|vers
operator|->
name|options
argument_list|,
name|finfo
operator|->
name|file
argument_list|)
expr_stmt|;
return|return
name|retcode
operator|==
literal|0
condition|?
name|DIFF_SAME
else|:
name|DIFF_DIFFERENT
return|;
block|}
end_function

end_unit


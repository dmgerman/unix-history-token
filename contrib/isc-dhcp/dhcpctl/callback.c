begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* callback.c     The dhcpctl callback object. */
end_comment

begin_comment
comment|/*  * Copyright (c) 1999-2002 Internet Software Consortium.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of The Internet Software Consortium nor the names  *    of its contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INTERNET SOFTWARE CONSORTIUM AND  * CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE INTERNET SOFTWARE CONSORTIUM OR  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * This software has been written for the Internet Software Consortium  * by Ted Lemon in cooperation with Vixie Enterprises and Nominum, Inc.  * To learn more about the Internet Software Consortium, see  * ``http://www.isc.org/''.  To learn more about Vixie Enterprises,  * see ``http://www.vix.com''.   To learn more about Nominum, Inc., see  * ``http://www.nominum.com''.  */
end_comment

begin_include
include|#
directive|include
file|<omapip/omapip_p.h>
end_include

begin_include
include|#
directive|include
file|"dhcpctl.h"
end_include

begin_comment
comment|/* dhcpctl_set_callback     synchronous, with asynchronous aftereffect    handle is some object upon which some kind of process has been    started - e.g., an open, an update or a refresh.    data is an anonymous pointer containing some information that    the callback will use to figure out what event completed.    return value of 0 means callback was successfully set, a nonzero    status code is returned otherwise.    Upon completion of whatever task is in process, the callback    will be passed the handle to the object, a status code    indicating what happened, and the anonymous pointer passed to  */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_set_callback
parameter_list|(
name|dhcpctl_handle
name|h
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|dhcpctl_handle
parameter_list|,
name|dhcpctl_status
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|dhcpctl_callback_object_t
modifier|*
name|callback
decl_stmt|;
name|omapi_object_t
modifier|*
name|inner
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|callback
operator|=
name|dmalloc
argument_list|(
sizeof|sizeof
expr|*
name|callback
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|callback
condition|)
return|return
name|ISC_R_NOMEMORY
return|;
comment|/* Tie the callback object to the innermost object in the chain. */
for|for
control|(
name|inner
operator|=
name|h
init|;
name|inner
operator|->
name|inner
condition|;
name|inner
operator|=
name|inner
operator|->
name|inner
control|)
empty_stmt|;
name|omapi_object_reference
argument_list|(
operator|&
name|inner
operator|->
name|inner
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|callback
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_object_reference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|callback
operator|->
name|outer
argument_list|,
name|inner
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
comment|/* Save the actual handle pointer we were passed for the callback. */
name|omapi_object_reference
argument_list|(
operator|&
name|callback
operator|->
name|object
argument_list|,
name|h
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|callback
operator|->
name|data
operator|=
name|data
expr_stmt|;
name|callback
operator|->
name|callback
operator|=
name|func
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* Callback methods (not meant to be called directly) */
end_comment

begin_function
name|isc_result_t
name|dhcpctl_callback_set_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_typed_data_t
modifier|*
name|value
parameter_list|)
block|{
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcpctl_callback_type
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
condition|)
return|return
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcpctl_callback_get_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_value_t
modifier|*
modifier|*
name|value
parameter_list|)
block|{
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcpctl_callback_type
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
return|return
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcpctl_callback_signal_handler
parameter_list|(
name|omapi_object_t
modifier|*
name|o
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|dhcpctl_callback_object_t
modifier|*
name|p
decl_stmt|;
name|isc_result_t
name|waitstatus
decl_stmt|;
if|if
condition|(
name|o
operator|->
name|type
operator|!=
name|dhcpctl_callback_type
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|p
operator|=
operator|(
name|dhcpctl_callback_object_t
operator|*
operator|)
name|o
expr_stmt|;
comment|/* Not a signal we recognize? */
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"ready"
argument_list|)
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|inner
operator|&&
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
condition|)
return|return
operator|(
operator|*
operator|(
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
operator|)
operator|)
operator|(
name|p
operator|->
name|inner
operator|,
name|name
operator|,
name|ap
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
if|if
condition|(
name|p
operator|->
name|object
operator|->
name|type
operator|==
name|dhcpctl_remote_type
condition|)
block|{
name|waitstatus
operator|=
operator|(
operator|(
operator|(
name|dhcpctl_remote_object_t
operator|*
operator|)
operator|(
name|p
operator|->
name|object
operator|)
operator|)
operator|->
name|waitstatus
operator|)
expr_stmt|;
block|}
else|else
name|waitstatus
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
comment|/* Do the callback. */
if|if
condition|(
name|p
operator|->
name|callback
condition|)
operator|(
operator|*
operator|(
name|p
operator|->
name|callback
operator|)
operator|)
operator|(
name|p
operator|->
name|object
operator|,
name|waitstatus
operator|,
name|p
operator|->
name|data
operator|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcpctl_callback_destroy
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|dhcpctl_callback_object_t
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcpctl_callback_type
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|p
operator|=
operator|(
name|dhcpctl_callback_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|handle
condition|)
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|p
operator|->
name|handle
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* Write all the published values associated with the object through the    specified connection. */
end_comment

begin_function
name|isc_result_t
name|dhcpctl_callback_stuff_values
parameter_list|(
name|omapi_object_t
modifier|*
name|c
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|type
operator|!=
name|dhcpctl_callback_type
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|p
operator|->
name|inner
operator|&&
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
condition|)
return|return
operator|(
operator|*
operator|(
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
operator|)
operator|)
operator|(
name|c
operator|,
name|id
operator|,
name|p
operator|->
name|inner
operator|)
return|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

end_unit


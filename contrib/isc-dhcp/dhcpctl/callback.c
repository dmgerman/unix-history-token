begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* callback.c     The dhcpctl callback object. */
end_comment

begin_comment
comment|/*  * Copyright (c) 2004 by Internet Systems Consortium, Inc. ("ISC")  * Copyright (c) 1999-2003 by Internet Software Consortium  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT  * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  *   Internet Systems Consortium, Inc.  *   950 Charter Street  *   Redwood City, CA 94063  *<info@isc.org>  *   http://www.isc.org/  *  * This software has been written for Internet Systems Consortium  * by Ted Lemon in cooperation with Vixie Enterprises and Nominum, Inc.  * To learn more about Internet Systems Consortium, see  * ``http://www.isc.org/''.  To learn more about Vixie Enterprises,  * see ``http://www.vix.com''.   To learn more about Nominum, Inc., see  * ``http://www.nominum.com''.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|copyright
index|[]
init|=
literal|"$Id: callback.c,v 1.5.2.2 2004/06/10 17:59:23 dhankins Exp $ Copyright (c) 2004 Internet Systems Consortium.  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<omapip/omapip_p.h>
end_include

begin_include
include|#
directive|include
file|"dhcpctl.h"
end_include

begin_comment
comment|/* dhcpctl_set_callback     synchronous, with asynchronous aftereffect    handle is some object upon which some kind of process has been    started - e.g., an open, an update or a refresh.    data is an anonymous pointer containing some information that    the callback will use to figure out what event completed.    return value of 0 means callback was successfully set, a nonzero    status code is returned otherwise.    Upon completion of whatever task is in process, the callback    will be passed the handle to the object, a status code    indicating what happened, and the anonymous pointer passed to  */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_set_callback
parameter_list|(
name|dhcpctl_handle
name|h
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|dhcpctl_handle
parameter_list|,
name|dhcpctl_status
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|dhcpctl_callback_object_t
modifier|*
name|callback
decl_stmt|;
name|omapi_object_t
modifier|*
name|inner
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|callback
operator|=
name|dmalloc
argument_list|(
sizeof|sizeof
expr|*
name|callback
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|callback
condition|)
return|return
name|ISC_R_NOMEMORY
return|;
comment|/* Tie the callback object to the innermost object in the chain. */
for|for
control|(
name|inner
operator|=
name|h
init|;
name|inner
operator|->
name|inner
condition|;
name|inner
operator|=
name|inner
operator|->
name|inner
control|)
empty_stmt|;
name|omapi_object_reference
argument_list|(
operator|&
name|inner
operator|->
name|inner
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|callback
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_object_reference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|callback
operator|->
name|outer
argument_list|,
name|inner
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
comment|/* Save the actual handle pointer we were passed for the callback. */
name|omapi_object_reference
argument_list|(
operator|&
name|callback
operator|->
name|object
argument_list|,
name|h
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|callback
operator|->
name|data
operator|=
name|data
expr_stmt|;
name|callback
operator|->
name|callback
operator|=
name|func
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* Callback methods (not meant to be called directly) */
end_comment

begin_function
name|isc_result_t
name|dhcpctl_callback_set_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_typed_data_t
modifier|*
name|value
parameter_list|)
block|{
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcpctl_callback_type
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
condition|)
return|return
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcpctl_callback_get_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_value_t
modifier|*
modifier|*
name|value
parameter_list|)
block|{
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcpctl_callback_type
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
return|return
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcpctl_callback_signal_handler
parameter_list|(
name|omapi_object_t
modifier|*
name|o
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|dhcpctl_callback_object_t
modifier|*
name|p
decl_stmt|;
name|isc_result_t
name|waitstatus
decl_stmt|;
if|if
condition|(
name|o
operator|->
name|type
operator|!=
name|dhcpctl_callback_type
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|p
operator|=
operator|(
name|dhcpctl_callback_object_t
operator|*
operator|)
name|o
expr_stmt|;
comment|/* Not a signal we recognize? */
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"ready"
argument_list|)
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|inner
operator|&&
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
condition|)
return|return
operator|(
operator|*
operator|(
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
operator|)
operator|)
operator|(
name|p
operator|->
name|inner
operator|,
name|name
operator|,
name|ap
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
if|if
condition|(
name|p
operator|->
name|object
operator|->
name|type
operator|==
name|dhcpctl_remote_type
condition|)
block|{
name|waitstatus
operator|=
operator|(
operator|(
operator|(
name|dhcpctl_remote_object_t
operator|*
operator|)
operator|(
name|p
operator|->
name|object
operator|)
operator|)
operator|->
name|waitstatus
operator|)
expr_stmt|;
block|}
else|else
name|waitstatus
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
comment|/* Do the callback. */
if|if
condition|(
name|p
operator|->
name|callback
condition|)
operator|(
operator|*
operator|(
name|p
operator|->
name|callback
operator|)
operator|)
operator|(
name|p
operator|->
name|object
operator|,
name|waitstatus
operator|,
name|p
operator|->
name|data
operator|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcpctl_callback_destroy
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|dhcpctl_callback_object_t
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcpctl_callback_type
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|p
operator|=
operator|(
name|dhcpctl_callback_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|handle
condition|)
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|p
operator|->
name|handle
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* Write all the published values associated with the object through the    specified connection. */
end_comment

begin_function
name|isc_result_t
name|dhcpctl_callback_stuff_values
parameter_list|(
name|omapi_object_t
modifier|*
name|c
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|type
operator|!=
name|dhcpctl_callback_type
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|p
operator|->
name|inner
operator|&&
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
condition|)
return|return
operator|(
operator|*
operator|(
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
operator|)
operator|)
operator|(
name|c
operator|,
name|id
operator|,
name|p
operator|->
name|inner
operator|)
return|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* dhcpctl.c     Subroutines providing general support for objects. */
end_comment

begin_comment
comment|/*  * Copyright (c) 1999-2002 Internet Software Consortium.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of The Internet Software Consortium nor the names  *    of its contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INTERNET SOFTWARE CONSORTIUM AND  * CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE INTERNET SOFTWARE CONSORTIUM OR  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * This software has been written for the Internet Software Consortium  * by Ted Lemon in cooperation with Vixie Enterprises and Nominum, Inc.  * To learn more about the Internet Software Consortium, see  * ``http://www.isc.org/''.  To learn more about Vixie Enterprises,  * see ``http://www.vix.com''.   To learn more about Nominum, Inc., see  * ``http://www.nominum.com''.  */
end_comment

begin_include
include|#
directive|include
file|<omapip/omapip_p.h>
end_include

begin_include
include|#
directive|include
file|"dhcpctl.h"
end_include

begin_decl_stmt
name|omapi_object_type_t
modifier|*
name|dhcpctl_callback_type
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|omapi_object_type_t
modifier|*
name|dhcpctl_remote_type
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dhcpctl_initialize ()     Must be called before any other dhcpctl function. */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_initialize
parameter_list|()
block|{
name|isc_result_t
name|status
decl_stmt|;
name|status
operator|=
name|omapi_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|status
operator|=
name|omapi_object_type_register
argument_list|(
operator|&
name|dhcpctl_callback_type
argument_list|,
literal|"dhcpctl-callback"
argument_list|,
name|dhcpctl_callback_set_value
argument_list|,
name|dhcpctl_callback_get_value
argument_list|,
name|dhcpctl_callback_destroy
argument_list|,
name|dhcpctl_callback_signal_handler
argument_list|,
name|dhcpctl_callback_stuff_values
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dhcpctl_callback_object_t
argument_list|)
argument_list|,
literal|0
argument_list|,
name|RC_MISC
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|status
operator|=
name|omapi_object_type_register
argument_list|(
operator|&
name|dhcpctl_remote_type
argument_list|,
literal|"dhcpctl-remote"
argument_list|,
name|dhcpctl_remote_set_value
argument_list|,
name|dhcpctl_remote_get_value
argument_list|,
name|dhcpctl_remote_destroy
argument_list|,
name|dhcpctl_remote_signal_handler
argument_list|,
name|dhcpctl_remote_stuff_values
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dhcpctl_remote_object_t
argument_list|)
argument_list|,
literal|0
argument_list|,
name|RC_MISC
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* dhcpctl_connect     synchronous    returns nonzero status code if it didn't connect, zero otherwise    stores connection handle through connection, which can be used    for subsequent access to the specified server.     server_name is the name of the server, and port is the TCP    port on which it is listening.    authinfo is the handle to an object containing authentication    information. */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_connect
parameter_list|(
name|dhcpctl_handle
modifier|*
name|connection
parameter_list|,
specifier|const
name|char
modifier|*
name|server_name
parameter_list|,
name|int
name|port
parameter_list|,
name|dhcpctl_handle
name|authinfo
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|dhcpctl_status
name|waitstatus
decl_stmt|;
name|status
operator|=
name|omapi_generic_new
argument_list|(
name|connection
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_protocol_connect
argument_list|(
operator|*
name|connection
argument_list|,
name|server_name
argument_list|,
operator|(
name|unsigned
operator|)
name|port
argument_list|,
name|authinfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_INCOMPLETE
condition|)
block|{
name|omapi_object_dereference
argument_list|(
name|connection
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_wait_for_completion
argument_list|(
operator|*
name|connection
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
name|connection
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* dhcpctl_wait_for_completion     synchronous    returns zero if the callback completes, a nonzero status if    there was some problem relating to the wait operation.   The    status of the queued request will be stored through s, and    will also be either zero for success or nonzero for some kind    of failure.    Never returns until completion or until the    connection to the server is lost.   This performs the same    function as dhcpctl_set_callback and the subsequent callback,    for programs that want to do inline execution instead of using    callbacks. */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_wait_for_completion
parameter_list|(
name|dhcpctl_handle
name|h
parameter_list|,
name|dhcpctl_status
modifier|*
name|s
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|status
operator|=
name|omapi_wait_for_completion
argument_list|(
name|h
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
if|if
condition|(
name|h
operator|->
name|type
operator|==
name|dhcpctl_remote_type
condition|)
operator|*
name|s
operator|=
operator|(
operator|(
name|dhcpctl_remote_object_t
operator|*
operator|)
name|h
operator|)
operator|->
name|waitstatus
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* dhcpctl_get_value     synchronous    returns zero if the call succeeded, a nonzero status code if    it didn't.     result is the address of an empty data string (initialized    with bzero or cleared with data_string_forget).   On    successful completion, the addressed data string will contain    the value that was fetched.    dhcpctl_handle refers to some dhcpctl item    value_name refers to some value related to that item - e.g.,    for a handle associated with a completed host lookup, value    could be one of "hardware-address", "dhcp-client-identifier",    "known" or "client-hostname". */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_get_value
parameter_list|(
name|dhcpctl_data_string
modifier|*
name|result
parameter_list|,
name|dhcpctl_handle
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|value_name
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_value_t
modifier|*
name|tv
init|=
operator|(
name|omapi_value_t
operator|*
operator|)
literal|0
decl_stmt|;
name|omapi_data_string_t
modifier|*
name|value
init|=
operator|(
name|omapi_data_string_t
operator|*
operator|)
literal|0
decl_stmt|;
name|unsigned
name|len
decl_stmt|;
name|int
name|ip
decl_stmt|;
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|h
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
name|value_name
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
switch|switch
condition|(
name|tv
operator|->
name|value
operator|->
name|type
condition|)
block|{
case|case
name|omapi_datatype_int
case|:
name|len
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
break|break;
case|case
name|omapi_datatype_string
case|:
case|case
name|omapi_datatype_data
case|:
name|len
operator|=
name|tv
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
expr_stmt|;
break|break;
case|case
name|omapi_datatype_object
case|:
name|len
operator|=
sizeof|sizeof
argument_list|(
name|omapi_handle_t
argument_list|)
expr_stmt|;
break|break;
default|default:
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|tv
operator|->
name|value
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_UNEXPECTED
return|;
block|}
name|status
operator|=
name|omapi_data_string_new
argument_list|(
name|result
argument_list|,
name|len
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|tv
operator|->
name|value
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
switch|switch
condition|(
name|tv
operator|->
name|value
operator|->
name|type
condition|)
block|{
case|case
name|omapi_datatype_int
case|:
name|ip
operator|=
name|htonl
argument_list|(
name|tv
operator|->
name|value
operator|->
name|u
operator|.
name|integer
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
operator|*
name|result
operator|)
operator|->
name|value
argument_list|,
operator|&
name|ip
argument_list|,
sizeof|sizeof
name|ip
argument_list|)
expr_stmt|;
break|break;
case|case
name|omapi_datatype_string
case|:
case|case
name|omapi_datatype_data
case|:
name|memcpy
argument_list|(
operator|(
operator|*
name|result
operator|)
operator|->
name|value
argument_list|,
name|tv
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|tv
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|omapi_datatype_object
case|:
name|ip
operator|=
name|htonl
argument_list|(
name|tv
operator|->
name|value
operator|->
name|u
operator|.
name|object
operator|->
name|handle
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
operator|*
name|result
operator|)
operator|->
name|value
argument_list|,
operator|&
name|ip
argument_list|,
sizeof|sizeof
name|ip
argument_list|)
expr_stmt|;
break|break;
block|}
name|omapi_value_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* dhcpctl_get_boolean     like dhcpctl_get_value, but more convenient for boolean    values, since no data_string needs to be dealt with. */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_get_boolean
parameter_list|(
name|int
modifier|*
name|result
parameter_list|,
name|dhcpctl_handle
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|value_name
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|dhcpctl_data_string
name|data
init|=
operator|(
name|dhcpctl_data_string
operator|)
literal|0
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|status
operator|=
name|dhcpctl_get_value
argument_list|(
operator|&
name|data
argument_list|,
name|h
argument_list|,
name|value_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
if|if
condition|(
name|data
operator|->
name|len
operator|!=
sizeof|sizeof
name|rv
condition|)
block|{
name|omapi_data_string_dereference
argument_list|(
operator|&
name|data
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_UNEXPECTED
return|;
block|}
name|memcpy
argument_list|(
operator|&
name|rv
argument_list|,
name|data
operator|->
name|value
argument_list|,
sizeof|sizeof
name|rv
argument_list|)
expr_stmt|;
operator|*
name|result
operator|=
name|ntohl
argument_list|(
name|rv
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* dhcpctl_set_value     Sets a value on an object referred to by a dhcpctl_handle.    The opposite of dhcpctl_get_value.   Does not update the    server - just sets the value on the handle. */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_set_value
parameter_list|(
name|dhcpctl_handle
name|h
parameter_list|,
name|dhcpctl_data_string
name|value
parameter_list|,
specifier|const
name|char
modifier|*
name|value_name
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_typed_data_t
modifier|*
name|tv
init|=
operator|(
name|omapi_typed_data_t
operator|*
operator|)
literal|0
decl_stmt|;
name|omapi_data_string_t
modifier|*
name|name
init|=
operator|(
name|omapi_data_string_t
operator|*
operator|)
literal|0
decl_stmt|;
name|int
name|len
decl_stmt|;
name|status
operator|=
name|omapi_data_string_new
argument_list|(
operator|&
name|name
argument_list|,
name|strlen
argument_list|(
name|value_name
argument_list|)
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|memcpy
argument_list|(
name|name
operator|->
name|value
argument_list|,
name|value_name
argument_list|,
name|strlen
argument_list|(
name|value_name
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_typed_data_new
argument_list|(
name|MDL
argument_list|,
operator|&
name|tv
argument_list|,
name|omapi_datatype_data
argument_list|,
name|value
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_data_string_dereference
argument_list|(
operator|&
name|name
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|memcpy
argument_list|(
name|tv
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|value
operator|->
name|value
argument_list|,
name|value
operator|->
name|len
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_set_value
argument_list|(
name|h
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
name|name
argument_list|,
name|tv
argument_list|)
expr_stmt|;
name|omapi_data_string_dereference
argument_list|(
operator|&
name|name
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* dhcpctl_set_string_value     Sets a NUL-terminated ASCII value on an object referred to by    a dhcpctl_handle.   like dhcpctl_set_value, but saves the    trouble of creating a data_string for a NUL-terminated string.    Does not update the server - just sets the value on the handle. */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_set_string_value
parameter_list|(
name|dhcpctl_handle
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|,
specifier|const
name|char
modifier|*
name|value_name
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_typed_data_t
modifier|*
name|tv
init|=
operator|(
name|omapi_typed_data_t
operator|*
operator|)
literal|0
decl_stmt|;
name|omapi_data_string_t
modifier|*
name|name
init|=
operator|(
name|omapi_data_string_t
operator|*
operator|)
literal|0
decl_stmt|;
name|int
name|len
decl_stmt|;
name|status
operator|=
name|omapi_data_string_new
argument_list|(
operator|&
name|name
argument_list|,
name|strlen
argument_list|(
name|value_name
argument_list|)
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|memcpy
argument_list|(
name|name
operator|->
name|value
argument_list|,
name|value_name
argument_list|,
name|strlen
argument_list|(
name|value_name
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_typed_data_new
argument_list|(
name|MDL
argument_list|,
operator|&
name|tv
argument_list|,
name|omapi_datatype_string
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_data_string_dereference
argument_list|(
operator|&
name|name
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_value
argument_list|(
name|h
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
name|name
argument_list|,
name|tv
argument_list|)
expr_stmt|;
name|omapi_data_string_dereference
argument_list|(
operator|&
name|name
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* dhcpctl_set_buffer_value     Sets a value on an object referred to by a dhcpctl_handle.  like    dhcpctl_set_value, but saves the trouble of creating a data_string    for string for which we have a buffer and length.  Does not update    the server - just sets the value on the handle. */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_set_data_value
parameter_list|(
name|dhcpctl_handle
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|,
name|unsigned
name|len
parameter_list|,
specifier|const
name|char
modifier|*
name|value_name
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_typed_data_t
modifier|*
name|tv
init|=
operator|(
name|omapi_typed_data_t
operator|*
operator|)
literal|0
decl_stmt|;
name|omapi_data_string_t
modifier|*
name|name
init|=
operator|(
name|omapi_data_string_t
operator|*
operator|)
literal|0
decl_stmt|;
name|unsigned
name|ll
decl_stmt|;
name|ll
operator|=
name|strlen
argument_list|(
name|value_name
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_data_string_new
argument_list|(
operator|&
name|name
argument_list|,
name|ll
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|memcpy
argument_list|(
name|name
operator|->
name|value
argument_list|,
name|value_name
argument_list|,
name|ll
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_typed_data_new
argument_list|(
name|MDL
argument_list|,
operator|&
name|tv
argument_list|,
name|omapi_datatype_data
argument_list|,
name|len
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_data_string_dereference
argument_list|(
operator|&
name|name
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|memcpy
argument_list|(
name|tv
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|value
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_set_value
argument_list|(
name|h
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
name|name
argument_list|,
name|tv
argument_list|)
expr_stmt|;
name|omapi_data_string_dereference
argument_list|(
operator|&
name|name
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* dhcpctl_set_null_value     Sets a null value on an object referred to by a dhcpctl_handle. */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_set_null_value
parameter_list|(
name|dhcpctl_handle
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|value_name
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_data_string_t
modifier|*
name|name
init|=
operator|(
name|omapi_data_string_t
operator|*
operator|)
literal|0
decl_stmt|;
name|unsigned
name|ll
decl_stmt|;
name|ll
operator|=
name|strlen
argument_list|(
name|value_name
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_data_string_new
argument_list|(
operator|&
name|name
argument_list|,
name|ll
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|memcpy
argument_list|(
name|name
operator|->
name|value
argument_list|,
name|value_name
argument_list|,
name|ll
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_set_value
argument_list|(
name|h
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
name|name
argument_list|,
operator|(
name|omapi_typed_data_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|omapi_data_string_dereference
argument_list|(
operator|&
name|name
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* dhcpctl_set_boolean_value     Sets a boolean value on an object - like dhcpctl_set_value,    only more convenient for booleans. */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_set_boolean_value
parameter_list|(
name|dhcpctl_handle
name|h
parameter_list|,
name|int
name|value
parameter_list|,
specifier|const
name|char
modifier|*
name|value_name
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_typed_data_t
modifier|*
name|tv
init|=
operator|(
name|omapi_typed_data_t
operator|*
operator|)
literal|0
decl_stmt|;
name|omapi_data_string_t
modifier|*
name|name
init|=
operator|(
name|omapi_data_string_t
operator|*
operator|)
literal|0
decl_stmt|;
name|int
name|len
decl_stmt|;
name|status
operator|=
name|omapi_data_string_new
argument_list|(
operator|&
name|name
argument_list|,
name|strlen
argument_list|(
name|value_name
argument_list|)
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|memcpy
argument_list|(
name|name
operator|->
name|value
argument_list|,
name|value_name
argument_list|,
name|strlen
argument_list|(
name|value_name
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_typed_data_new
argument_list|(
name|MDL
argument_list|,
operator|&
name|tv
argument_list|,
name|omapi_datatype_int
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_data_string_dereference
argument_list|(
operator|&
name|name
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_value
argument_list|(
name|h
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
name|name
argument_list|,
name|tv
argument_list|)
expr_stmt|;
name|omapi_data_string_dereference
argument_list|(
operator|&
name|name
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* dhcpctl_set_int_value     Sets a boolean value on an object - like dhcpctl_set_value,    only more convenient for booleans. */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_set_int_value
parameter_list|(
name|dhcpctl_handle
name|h
parameter_list|,
name|int
name|value
parameter_list|,
specifier|const
name|char
modifier|*
name|value_name
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_typed_data_t
modifier|*
name|tv
init|=
operator|(
name|omapi_typed_data_t
operator|*
operator|)
literal|0
decl_stmt|;
name|omapi_data_string_t
modifier|*
name|name
init|=
operator|(
name|omapi_data_string_t
operator|*
operator|)
literal|0
decl_stmt|;
name|int
name|len
decl_stmt|;
name|status
operator|=
name|omapi_data_string_new
argument_list|(
operator|&
name|name
argument_list|,
name|strlen
argument_list|(
name|value_name
argument_list|)
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|memcpy
argument_list|(
name|name
operator|->
name|value
argument_list|,
name|value_name
argument_list|,
name|strlen
argument_list|(
name|value_name
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_typed_data_new
argument_list|(
name|MDL
argument_list|,
operator|&
name|tv
argument_list|,
name|omapi_datatype_int
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_data_string_dereference
argument_list|(
operator|&
name|name
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_value
argument_list|(
name|h
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
name|name
argument_list|,
name|tv
argument_list|)
expr_stmt|;
name|omapi_data_string_dereference
argument_list|(
operator|&
name|name
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* dhcpctl_object_update     Queues an update on the object referenced by the handle (there    can't be any other work in progress on the handle).   An    update means local parameters will be sent to the server. */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_object_update
parameter_list|(
name|dhcpctl_handle
name|connection
parameter_list|,
name|dhcpctl_handle
name|h
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_object_t
modifier|*
name|message
init|=
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
decl_stmt|;
name|dhcpctl_remote_object_t
modifier|*
name|ro
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcpctl_remote_type
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|ro
operator|=
operator|(
name|dhcpctl_remote_object_t
operator|*
operator|)
name|h
expr_stmt|;
name|status
operator|=
name|omapi_message_new
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_int_value
argument_list|(
name|message
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"op"
argument_list|,
name|OMAPI_OP_UPDATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_object_value
argument_list|(
name|message
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"object"
argument_list|,
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_int_value
argument_list|(
name|message
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"handle"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|ro
operator|->
name|remote_handle
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|omapi_message_register
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_protocol_send_message
argument_list|(
name|connection
operator|->
name|outer
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
name|message
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* Requests a refresh on the object referenced by the handle (there    can't be any other work in progress on the handle).   A    refresh means local parameters are updated from the server. */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_object_refresh
parameter_list|(
name|dhcpctl_handle
name|connection
parameter_list|,
name|dhcpctl_handle
name|h
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_object_t
modifier|*
name|message
init|=
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
decl_stmt|;
name|dhcpctl_remote_object_t
modifier|*
name|ro
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcpctl_remote_type
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|ro
operator|=
operator|(
name|dhcpctl_remote_object_t
operator|*
operator|)
name|h
expr_stmt|;
name|status
operator|=
name|omapi_message_new
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_int_value
argument_list|(
name|message
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"op"
argument_list|,
name|OMAPI_OP_REFRESH
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_int_value
argument_list|(
name|message
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"handle"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|ro
operator|->
name|remote_handle
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|omapi_message_register
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_protocol_send_message
argument_list|(
name|connection
operator|->
name|outer
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
name|message
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
comment|/* We don't want to send the contents of the object down the 	   wire, but we do need to reference it so that we know what 	   to do with the update. */
name|status
operator|=
name|omapi_set_object_value
argument_list|(
name|message
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"object"
argument_list|,
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* Requests the removal of the object referenced by the handle (there    can't be any other work in progress on the handle).   A    removal means that all searchable references to the object on the    server are deleted. */
end_comment

begin_function
name|dhcpctl_status
name|dhcpctl_object_remove
parameter_list|(
name|dhcpctl_handle
name|connection
parameter_list|,
name|dhcpctl_handle
name|h
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_object_t
modifier|*
name|message
init|=
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
decl_stmt|;
name|dhcpctl_remote_object_t
modifier|*
name|ro
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcpctl_remote_type
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|ro
operator|=
operator|(
name|dhcpctl_remote_object_t
operator|*
operator|)
name|h
expr_stmt|;
name|status
operator|=
name|omapi_message_new
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_int_value
argument_list|(
name|message
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"op"
argument_list|,
name|OMAPI_OP_DELETE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_int_value
argument_list|(
name|message
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"handle"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|ro
operator|->
name|remote_handle
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_object_value
argument_list|(
name|message
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"notify-object"
argument_list|,
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|omapi_message_register
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_protocol_send_message
argument_list|(
name|connection
operator|->
name|outer
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
name|message
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|omapi_object_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcpctl_data_string_dereference
parameter_list|(
name|dhcpctl_data_string
modifier|*
name|vp
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
return|return
name|omapi_data_string_dereference
argument_list|(
name|vp
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
return|;
block|}
end_function

end_unit


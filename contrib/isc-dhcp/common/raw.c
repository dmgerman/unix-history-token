begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* socket.c     BSD raw socket interface code... */
end_comment

begin_comment
comment|/* XXX     It's not clear how this should work, and that lack of clarity is    terribly detrimental to the NetBSD 1.1 kernel - it crashes and    burns.     Using raw sockets ought to be a big win over using BPF or something    like it, because you don't need to deal with the complexities of    the physical layer, but it appears not to be possible with existing    raw socket implementations.  This may be worth revisiting in the    future.  For now, this code can probably be considered a curiosity.    Sigh. */
end_comment

begin_comment
comment|/*  * Copyright (c) 2004 by Internet Systems Consortium, Inc. ("ISC")  * Copyright (c) 1995-2003 by Internet Software Consortium  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT  * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  *   Internet Systems Consortium, Inc.  *   950 Charter Street  *   Redwood City, CA 94063  *<info@isc.org>  *   http://www.isc.org/  *  * This software has been written for Internet Systems Consortium  * by Ted Lemon in cooperation with Vixie Enterprises and Nominum, Inc.  * To learn more about Internet Systems Consortium, see  * ``http://www.isc.org/''.  To learn more about Vixie Enterprises,  * see ``http://www.vix.com''.   To learn more about Nominum, Inc., see  * ``http://www.nominum.com''.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|copyright
index|[]
init|=
literal|"$Id: raw.c,v 1.17.2.2 2004/06/10 17:59:20 dhankins Exp $ Copyright (c) 2004 Internet Systems Consortium.  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|"dhcpd.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|USE_RAW_SEND
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_comment
comment|/* Generic interface registration routine... */
end_comment

begin_function
name|void
name|if_register_send
parameter_list|(
name|info
parameter_list|)
name|struct
name|interface_info
modifier|*
name|info
decl_stmt|;
block|{
name|struct
name|sockaddr_in
name|name
decl_stmt|;
name|int
name|sock
decl_stmt|;
name|struct
name|socklist
modifier|*
name|tmp
decl_stmt|;
name|int
name|flag
decl_stmt|;
comment|/* Set up the address we're going to connect to. */
name|name
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|name
operator|.
name|sin_port
operator|=
name|local_port
expr_stmt|;
name|name
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|INADDR_BROADCAST
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|name
operator|.
name|sin_zero
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|name
operator|.
name|sin_zero
argument_list|)
argument_list|)
expr_stmt|;
comment|/* List addresses on which we're listening. */
if|if
condition|(
operator|!
name|quiet_interface_discovery
condition|)
name|log_info
argument_list|(
literal|"Sending on %s, port %d"
argument_list|,
name|piaddr
argument_list|(
name|info
operator|->
name|address
argument_list|)
argument_list|,
name|htons
argument_list|(
name|local_port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sock
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_RAW
argument_list|,
name|IPPROTO_RAW
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|log_fatal
argument_list|(
literal|"Can't create dhcp socket: %m"
argument_list|)
expr_stmt|;
comment|/* Set the BROADCAST option so that we can broadcast DHCP responses. */
name|flag
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|sock
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_BROADCAST
argument_list|,
operator|&
name|flag
argument_list|,
sizeof|sizeof
name|flag
argument_list|)
operator|<
literal|0
condition|)
name|log_fatal
argument_list|(
literal|"Can't set SO_BROADCAST option on dhcp socket: %m"
argument_list|)
expr_stmt|;
comment|/* Set the IP_HDRINCL flag so that we can supply our own IP 	   headers... */
if|if
condition|(
name|setsockopt
argument_list|(
name|sock
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_HDRINCL
argument_list|,
operator|&
name|flag
argument_list|,
sizeof|sizeof
name|flag
argument_list|)
operator|<
literal|0
condition|)
name|log_fatal
argument_list|(
literal|"Can't set IP_HDRINCL flag: %m"
argument_list|)
expr_stmt|;
name|info
operator|->
name|wfdesc
operator|=
name|sock
expr_stmt|;
if|if
condition|(
operator|!
name|quiet_interface_discovery
condition|)
name|log_info
argument_list|(
literal|"Sending on   Raw/%s%s%s"
argument_list|,
name|info
operator|->
name|name
argument_list|,
operator|(
name|info
operator|->
name|shared_network
condition|?
literal|"/"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|info
operator|->
name|shared_network
condition|?
name|info
operator|->
name|shared_network
operator|->
name|name
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|if_deregister_send
parameter_list|(
name|info
parameter_list|)
name|struct
name|interface_info
modifier|*
name|info
decl_stmt|;
block|{
name|close
argument_list|(
name|info
operator|->
name|wfdesc
argument_list|)
expr_stmt|;
name|info
operator|->
name|wfdesc
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|quiet_interface_discovery
condition|)
name|log_info
argument_list|(
literal|"Disabling output on Raw/%s%s%s"
argument_list|,
name|info
operator|->
name|name
argument_list|,
operator|(
name|info
operator|->
name|shared_network
condition|?
literal|"/"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|info
operator|->
name|shared_network
condition|?
name|info
operator|->
name|shared_network
operator|->
name|name
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|size_t
name|send_packet
parameter_list|(
name|interface
parameter_list|,
name|packet
parameter_list|,
name|raw
parameter_list|,
name|len
parameter_list|,
name|from
parameter_list|,
name|to
parameter_list|,
name|hto
parameter_list|)
name|struct
name|interface_info
modifier|*
name|interface
decl_stmt|;
name|struct
name|packet
modifier|*
name|packet
decl_stmt|;
name|struct
name|dhcp_packet
modifier|*
name|raw
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|in_addr
name|from
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|to
decl_stmt|;
name|struct
name|hardware
modifier|*
name|hto
decl_stmt|;
block|{
name|unsigned
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|int
name|bufp
init|=
literal|0
decl_stmt|;
name|struct
name|iovec
name|iov
index|[
literal|2
index|]
decl_stmt|;
name|int
name|result
decl_stmt|;
comment|/* Assemble the headers... */
name|assemble_udp_ip_header
argument_list|(
name|interface
argument_list|,
name|buf
argument_list|,
operator|&
name|bufp
argument_list|,
name|from
operator|.
name|s_addr
argument_list|,
name|to
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
name|to
operator|->
name|sin_port
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|raw
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* Fire it off */
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
operator|(
name|char
operator|*
operator|)
name|buf
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|bufp
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|char
operator|*
operator|)
name|raw
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
name|result
operator|=
name|writev
argument_list|(
name|interface
operator|->
name|wfdesc
argument_list|,
name|iov
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
name|log_error
argument_list|(
literal|"send_packet: %m"
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* USE_SOCKET_SEND */
end_comment

end_unit


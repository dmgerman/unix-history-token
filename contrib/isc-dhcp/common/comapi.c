begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* omapi.c     OMAPI object interfaces for the DHCP server. */
end_comment

begin_comment
comment|/*  * Copyright (c) 1999-2002 Internet Software Consortium.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of The Internet Software Consortium nor the names  *    of its contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INTERNET SOFTWARE CONSORTIUM AND  * CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE INTERNET SOFTWARE CONSORTIUM OR  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * This software has been written for the Internet Software Consortium  * by Ted Lemon in cooperation with Vixie Enterprises and Nominum, Inc.  * To learn more about the Internet Software Consortium, see  * ``http://www.isc.org/''.  To learn more about Vixie Enterprises,  * see ``http://www.vix.com''.   To learn more about Nominum, Inc., see  * ``http://www.nominum.com''.  */
end_comment

begin_comment
comment|/* Many, many thanks to Brian Murrell and BCtel for this code - BCtel    provided the funding that resulted in this code and the entire    OMAPI support library being written, and Brian helped brainstorm    and refine the requirements.  To the extent that this code is    useful, you have Brian and BCtel to thank.  Any limitations in the    code are a result of mistakes on my part.  -- Ted Lemon */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|copyright
index|[]
init|=
literal|"$Id: comapi.c,v 1.9.2.6 2002/11/17 02:26:56 dhankins Exp $ Copyright (c) 1999-2002 The Internet Software Consortium.  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|"dhcpd.h"
end_include

begin_include
include|#
directive|include
file|<omapip/omapip_p.h>
end_include

begin_macro
name|OMAPI_OBJECT_ALLOC
argument_list|(
argument|subnet
argument_list|,
argument|struct subnet
argument_list|,
argument|dhcp_type_subnet
argument_list|)
end_macro

begin_macro
name|OMAPI_OBJECT_ALLOC
argument_list|(
argument|shared_network
argument_list|,
argument|struct shared_network
argument_list|,
argument|dhcp_type_shared_network
argument_list|)
end_macro

begin_macro
name|OMAPI_OBJECT_ALLOC
argument_list|(
argument|group_object
argument_list|,
argument|struct group_object
argument_list|,
argument|dhcp_type_group
argument_list|)
end_macro

begin_macro
name|OMAPI_OBJECT_ALLOC
argument_list|(
argument|dhcp_control
argument_list|,
argument|dhcp_control_object_t
argument_list|,
argument|dhcp_type_control
argument_list|)
end_macro

begin_decl_stmt
name|omapi_object_type_t
modifier|*
name|dhcp_type_interface
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|omapi_object_type_t
modifier|*
name|dhcp_type_group
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|omapi_object_type_t
modifier|*
name|dhcp_type_shared_network
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|omapi_object_type_t
modifier|*
name|dhcp_type_subnet
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|omapi_object_type_t
modifier|*
name|dhcp_type_control
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|dhcp_control_object_t
modifier|*
name|dhcp_control_object
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|dhcp_common_objects_setup
parameter_list|()
block|{
name|isc_result_t
name|status
decl_stmt|;
name|status
operator|=
name|omapi_object_type_register
argument_list|(
operator|&
name|dhcp_type_control
argument_list|,
literal|"control"
argument_list|,
name|dhcp_control_set_value
argument_list|,
name|dhcp_control_get_value
argument_list|,
name|dhcp_control_destroy
argument_list|,
name|dhcp_control_signal_handler
argument_list|,
name|dhcp_control_stuff_values
argument_list|,
name|dhcp_control_lookup
argument_list|,
name|dhcp_control_create
argument_list|,
name|dhcp_control_remove
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dhcp_control_object_t
argument_list|)
argument_list|,
literal|0
argument_list|,
name|RC_MISC
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
name|log_fatal
argument_list|(
literal|"Can't register control object type: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|dhcp_control_allocate
argument_list|(
operator|&
name|dhcp_control_object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
name|log_fatal
argument_list|(
literal|"Can't make initial control object: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|dhcp_control_object
operator|->
name|state
operator|=
name|server_startup
expr_stmt|;
name|status
operator|=
name|omapi_object_type_register
argument_list|(
operator|&
name|dhcp_type_group
argument_list|,
literal|"group"
argument_list|,
name|dhcp_group_set_value
argument_list|,
name|dhcp_group_get_value
argument_list|,
name|dhcp_group_destroy
argument_list|,
name|dhcp_group_signal_handler
argument_list|,
name|dhcp_group_stuff_values
argument_list|,
name|dhcp_group_lookup
argument_list|,
name|dhcp_group_create
argument_list|,
name|dhcp_group_remove
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|group_object
argument_list|)
argument_list|,
literal|0
argument_list|,
name|RC_MISC
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
name|log_fatal
argument_list|(
literal|"Can't register group object type: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_object_type_register
argument_list|(
operator|&
name|dhcp_type_subnet
argument_list|,
literal|"subnet"
argument_list|,
name|dhcp_subnet_set_value
argument_list|,
name|dhcp_subnet_get_value
argument_list|,
name|dhcp_subnet_destroy
argument_list|,
name|dhcp_subnet_signal_handler
argument_list|,
name|dhcp_subnet_stuff_values
argument_list|,
name|dhcp_subnet_lookup
argument_list|,
name|dhcp_subnet_create
argument_list|,
name|dhcp_subnet_remove
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|subnet
argument_list|)
argument_list|,
literal|0
argument_list|,
name|RC_MISC
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
name|log_fatal
argument_list|(
literal|"Can't register subnet object type: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_object_type_register
argument_list|(
operator|&
name|dhcp_type_shared_network
argument_list|,
literal|"shared-network"
argument_list|,
name|dhcp_shared_network_set_value
argument_list|,
name|dhcp_shared_network_get_value
argument_list|,
name|dhcp_shared_network_destroy
argument_list|,
name|dhcp_shared_network_signal_handler
argument_list|,
name|dhcp_shared_network_stuff_values
argument_list|,
name|dhcp_shared_network_lookup
argument_list|,
name|dhcp_shared_network_create
argument_list|,
name|dhcp_shared_network_remove
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|shared_network
argument_list|)
argument_list|,
literal|0
argument_list|,
name|RC_MISC
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
name|log_fatal
argument_list|(
literal|"Can't register shared network object type: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|interface_setup
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_group_set_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_typed_data_t
modifier|*
name|value
parameter_list|)
block|{
name|struct
name|group_object
modifier|*
name|group
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|int
name|foo
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_group
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|group
operator|=
operator|(
expr|struct
name|group_object
operator|*
operator|)
name|h
expr_stmt|;
comment|/* XXX For now, we can only set these values on new group objects.  	   XXX Soon, we need to be able to update group objects. */
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"name"
argument_list|)
condition|)
block|{
if|if
condition|(
name|group
operator|->
name|name
condition|)
return|return
name|ISC_R_EXISTS
return|;
if|if
condition|(
name|value
operator|->
name|type
operator|==
name|omapi_datatype_data
operator|||
name|value
operator|->
name|type
operator|==
name|omapi_datatype_string
condition|)
block|{
name|group
operator|->
name|name
operator|=
name|dmalloc
argument_list|(
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
operator|+
literal|1
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|group
operator|->
name|name
condition|)
return|return
name|ISC_R_NOMEMORY
return|;
name|memcpy
argument_list|(
name|group
operator|->
name|name
argument_list|,
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
argument_list|)
expr_stmt|;
name|group
operator|->
name|name
index|[
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
return|return
name|ISC_R_INVALIDARG
return|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"statements"
argument_list|)
condition|)
block|{
if|if
condition|(
name|group
operator|->
name|group
operator|&&
name|group
operator|->
name|group
operator|->
name|statements
condition|)
return|return
name|ISC_R_EXISTS
return|;
if|if
condition|(
operator|!
name|group
operator|->
name|group
condition|)
block|{
if|if
condition|(
operator|!
name|clone_group
argument_list|(
operator|&
name|group
operator|->
name|group
argument_list|,
name|root_group
argument_list|,
name|MDL
argument_list|)
condition|)
return|return
name|ISC_R_NOMEMORY
return|;
block|}
if|if
condition|(
name|value
operator|->
name|type
operator|==
name|omapi_datatype_data
operator|||
name|value
operator|->
name|type
operator|==
name|omapi_datatype_string
condition|)
block|{
name|struct
name|parse
modifier|*
name|parse
decl_stmt|;
name|int
name|lose
init|=
literal|0
decl_stmt|;
name|parse
operator|=
operator|(
expr|struct
name|parse
operator|*
operator|)
literal|0
expr_stmt|;
name|status
operator|=
name|new_parse
argument_list|(
operator|&
name|parse
argument_list|,
operator|-
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|)
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
argument_list|,
literal|"network client"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
if|if
condition|(
operator|!
operator|(
name|parse_executable_statements
argument_list|(
operator|&
name|group
operator|->
name|group
operator|->
name|statements
argument_list|,
name|parse
argument_list|,
operator|&
name|lose
argument_list|,
name|context_any
argument_list|)
operator|)
condition|)
block|{
name|end_parse
argument_list|(
operator|&
name|parse
argument_list|)
expr_stmt|;
return|return
name|ISC_R_BADPARSE
return|;
block|}
name|end_parse
argument_list|(
operator|&
name|parse
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
else|else
return|return
name|ISC_R_INVALIDARG
return|;
block|}
comment|/* Try to find some inner object that can take the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
operator|||
name|status
operator|==
name|ISC_R_UNCHANGED
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_group_get_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_value_t
modifier|*
modifier|*
name|value
parameter_list|)
block|{
name|struct
name|group_object
modifier|*
name|group
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|struct
name|data_string
name|ip_addrs
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_group
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|group
operator|=
operator|(
expr|struct
name|group_object
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"name"
argument_list|)
condition|)
return|return
name|omapi_make_string_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
name|group
operator|->
name|name
argument_list|,
name|MDL
argument_list|)
return|;
comment|/* Try to find some inner object that can take the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_group_destroy
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|struct
name|group_object
modifier|*
name|group
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_group
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|group
operator|=
operator|(
expr|struct
name|group_object
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|name
condition|)
block|{
if|if
condition|(
name|group_name_hash
condition|)
block|{
name|t
operator|=
operator|(
expr|struct
name|group_object
operator|*
operator|)
literal|0
expr_stmt|;
if|if
condition|(
name|group_hash_lookup
argument_list|(
operator|&
name|t
argument_list|,
name|group_name_hash
argument_list|,
name|group
operator|->
name|name
argument_list|,
name|strlen
argument_list|(
name|group
operator|->
name|name
argument_list|)
argument_list|,
name|MDL
argument_list|)
condition|)
block|{
name|group_hash_delete
argument_list|(
name|group_name_hash
argument_list|,
name|group
operator|->
name|name
argument_list|,
name|strlen
argument_list|(
name|group
operator|->
name|name
argument_list|)
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|group_object_dereference
argument_list|(
operator|&
name|t
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
block|}
name|dfree
argument_list|(
name|group
operator|->
name|name
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|group
operator|->
name|name
operator|=
operator|(
name|char
operator|*
operator|)
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|group
operator|->
name|group
condition|)
name|group_dereference
argument_list|(
operator|&
name|group
operator|->
name|group
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_group_signal_handler
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|struct
name|group_object
modifier|*
name|group
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|int
name|updatep
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_group
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|group
operator|=
operator|(
expr|struct
name|group_object
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"updated"
argument_list|)
condition|)
block|{
comment|/* A group object isn't valid if a subgroup hasn't yet been 		   associated with it. */
if|if
condition|(
operator|!
name|group
operator|->
name|group
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
comment|/* Group objects always have to have names. */
if|if
condition|(
operator|!
name|group
operator|->
name|name
condition|)
block|{
name|char
name|hnbuf
index|[
literal|64
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|hnbuf
argument_list|,
literal|"ng%08lx%08lx"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cur_time
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|group
argument_list|)
expr_stmt|;
name|group
operator|->
name|name
operator|=
name|dmalloc
argument_list|(
name|strlen
argument_list|(
name|hnbuf
argument_list|)
operator|+
literal|1
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|group
operator|->
name|name
condition|)
return|return
name|ISC_R_NOMEMORY
return|;
name|strcpy
argument_list|(
name|group
operator|->
name|name
argument_list|,
name|hnbuf
argument_list|)
expr_stmt|;
block|}
name|supersede_group
argument_list|(
name|group
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|updatep
operator|=
literal|1
expr_stmt|;
block|}
comment|/* Try to find some inner object that can take the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|name
operator|,
name|ap
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
if|if
condition|(
name|updatep
condition|)
return|return
name|ISC_R_SUCCESS
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_group_stuff_values
parameter_list|(
name|omapi_object_t
modifier|*
name|c
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|h
parameter_list|)
block|{
name|struct
name|group_object
modifier|*
name|group
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_group
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|group
operator|=
operator|(
expr|struct
name|group_object
operator|*
operator|)
name|h
expr_stmt|;
comment|/* Write out all the values. */
if|if
condition|(
name|group
operator|->
name|name
condition|)
block|{
name|status
operator|=
name|omapi_connection_put_name
argument_list|(
name|c
argument_list|,
literal|"name"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|status
operator|=
name|omapi_connection_put_string
argument_list|(
name|c
argument_list|,
name|group
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
comment|/* Write out the inner object, if any. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
operator|)
operator|)
operator|(
name|c
operator|,
name|id
operator|,
name|h
operator|->
name|inner
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_group_lookup
parameter_list|(
name|omapi_object_t
modifier|*
modifier|*
name|lp
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|ref
parameter_list|)
block|{
name|omapi_value_t
modifier|*
name|tv
init|=
operator|(
name|omapi_value_t
operator|*
operator|)
literal|0
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|struct
name|group_object
modifier|*
name|group
decl_stmt|;
if|if
condition|(
operator|!
name|ref
condition|)
return|return
name|ISC_R_NOKEYS
return|;
comment|/* First see if we were sent a handle. */
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|ref
argument_list|,
name|id
argument_list|,
literal|"handle"
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|status
operator|=
name|omapi_handle_td_lookup
argument_list|(
name|lp
argument_list|,
name|tv
operator|->
name|value
argument_list|)
expr_stmt|;
name|omapi_value_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
comment|/* Don't return the object if the type is wrong. */
if|if
condition|(
operator|(
operator|*
name|lp
operator|)
operator|->
name|type
operator|!=
name|dhcp_type_group
condition|)
block|{
name|omapi_object_dereference
argument_list|(
name|lp
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_INVALIDARG
return|;
block|}
block|}
comment|/* Now look for a name. */
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|ref
argument_list|,
name|id
argument_list|,
literal|"name"
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|group
operator|=
operator|(
expr|struct
name|group_object
operator|*
operator|)
literal|0
expr_stmt|;
if|if
condition|(
name|group_name_hash
operator|&&
name|group_hash_lookup
argument_list|(
operator|&
name|group
argument_list|,
name|group_name_hash
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|tv
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|tv
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
argument_list|,
name|MDL
argument_list|)
condition|)
block|{
name|omapi_value_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|lp
operator|&&
operator|*
name|lp
operator|!=
operator|(
name|omapi_object_t
operator|*
operator|)
name|group
condition|)
block|{
name|group_object_dereference
argument_list|(
operator|&
name|group
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_object_dereference
argument_list|(
name|lp
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_KEYCONFLICT
return|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|*
name|lp
condition|)
block|{
comment|/* XXX fix so that hash lookup itself creates 			       XXX the reference. */
name|omapi_object_reference
argument_list|(
name|lp
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|group
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|group_object_dereference
argument_list|(
operator|&
name|group
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
operator|*
name|lp
condition|)
return|return
name|ISC_R_NOTFOUND
return|;
block|}
comment|/* If we get to here without finding a group, no valid key was 	   specified. */
if|if
condition|(
operator|!
operator|*
name|lp
condition|)
return|return
name|ISC_R_NOKEYS
return|;
if|if
condition|(
operator|(
operator|(
expr|struct
name|group_object
operator|*
operator|)
operator|(
operator|*
name|lp
operator|)
operator|)
operator|->
name|flags
operator|&
name|GROUP_OBJECT_DELETED
condition|)
block|{
name|omapi_object_dereference
argument_list|(
name|lp
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_group_create
parameter_list|(
name|omapi_object_t
modifier|*
modifier|*
name|lp
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|)
block|{
name|struct
name|group_object
modifier|*
name|group
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|group
operator|=
operator|(
expr|struct
name|group_object
operator|*
operator|)
literal|0
expr_stmt|;
name|status
operator|=
name|group_object_allocate
argument_list|(
operator|&
name|group
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|group
operator|->
name|flags
operator|=
name|GROUP_OBJECT_DYNAMIC
expr_stmt|;
name|status
operator|=
name|omapi_object_reference
argument_list|(
name|lp
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|group
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|group_object_dereference
argument_list|(
operator|&
name|group
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_group_remove
parameter_list|(
name|omapi_object_t
modifier|*
name|lp
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|)
block|{
name|struct
name|group_object
modifier|*
name|group
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|lp
operator|->
name|type
operator|!=
name|dhcp_type_group
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|group
operator|=
operator|(
expr|struct
name|group_object
operator|*
operator|)
name|lp
expr_stmt|;
name|group
operator|->
name|flags
operator||=
name|GROUP_OBJECT_DELETED
expr_stmt|;
if|if
condition|(
name|group_write_hook
condition|)
block|{
if|if
condition|(
operator|!
call|(
modifier|*
name|group_write_hook
call|)
argument_list|(
name|group
argument_list|)
condition|)
return|return
name|ISC_R_IOERROR
return|;
block|}
name|status
operator|=
name|dhcp_group_destroy
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|group
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_control_set_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_typed_data_t
modifier|*
name|value
parameter_list|)
block|{
name|dhcp_control_object_t
modifier|*
name|control
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|int
name|foo
decl_stmt|;
name|unsigned
name|long
name|newstate
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_control
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|control
operator|=
operator|(
name|dhcp_control_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"state"
argument_list|)
condition|)
block|{
name|status
operator|=
name|omapi_get_int_value
argument_list|(
operator|&
name|newstate
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|status
operator|=
name|dhcp_set_control_state
argument_list|(
name|control
operator|->
name|state
argument_list|,
name|newstate
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
name|control
operator|->
name|state
operator|=
name|value
operator|->
name|u
operator|.
name|integer
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Try to find some inner object that can take the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
operator|||
name|status
operator|==
name|ISC_R_UNCHANGED
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_control_get_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_value_t
modifier|*
modifier|*
name|value
parameter_list|)
block|{
name|dhcp_control_object_t
modifier|*
name|control
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|struct
name|data_string
name|ip_addrs
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_control
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|control
operator|=
operator|(
name|dhcp_control_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"state"
argument_list|)
condition|)
return|return
name|omapi_make_int_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
operator|(
name|int
operator|)
name|control
operator|->
name|state
argument_list|,
name|MDL
argument_list|)
return|;
comment|/* Try to find some inner object that can take the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_control_destroy
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|dhcp_control_object_t
modifier|*
name|control
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_control
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
comment|/* Can't destroy the control object. */
return|return
name|ISC_R_NOPERM
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_control_signal_handler
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|dhcp_control_object_t
modifier|*
name|control
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|int
name|updatep
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_control
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|control
operator|=
operator|(
name|dhcp_control_object_t
operator|*
operator|)
name|h
expr_stmt|;
comment|/* Try to find some inner object that can take the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|name
operator|,
name|ap
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_control_stuff_values
parameter_list|(
name|omapi_object_t
modifier|*
name|c
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|h
parameter_list|)
block|{
name|dhcp_control_object_t
modifier|*
name|control
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_control
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|control
operator|=
operator|(
name|dhcp_control_object_t
operator|*
operator|)
name|h
expr_stmt|;
comment|/* Write out all the values. */
name|status
operator|=
name|omapi_connection_put_name
argument_list|(
name|c
argument_list|,
literal|"state"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|status
operator|=
name|omapi_connection_put_uint32
argument_list|(
name|c
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|status
operator|=
name|omapi_connection_put_uint32
argument_list|(
name|c
argument_list|,
name|control
operator|->
name|state
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
comment|/* Write out the inner object, if any. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
operator|)
operator|)
operator|(
name|c
operator|,
name|id
operator|,
name|h
operator|->
name|inner
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_control_lookup
parameter_list|(
name|omapi_object_t
modifier|*
modifier|*
name|lp
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|ref
parameter_list|)
block|{
name|omapi_value_t
modifier|*
name|tv
init|=
operator|(
name|omapi_value_t
operator|*
operator|)
literal|0
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|dhcp_control_object_t
modifier|*
name|control
decl_stmt|;
comment|/* First see if we were sent a handle. */
if|if
condition|(
name|ref
condition|)
block|{
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|ref
argument_list|,
name|id
argument_list|,
literal|"handle"
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|status
operator|=
name|omapi_handle_td_lookup
argument_list|(
name|lp
argument_list|,
name|tv
operator|->
name|value
argument_list|)
expr_stmt|;
name|omapi_value_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
comment|/* Don't return the object if the type is wrong. */
if|if
condition|(
operator|(
operator|*
name|lp
operator|)
operator|->
name|type
operator|!=
name|dhcp_type_control
condition|)
block|{
name|omapi_object_dereference
argument_list|(
name|lp
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_INVALIDARG
return|;
block|}
block|}
block|}
comment|/* Otherwise, stop playing coy - there's only one control object, 	   so we can just return it. */
name|dhcp_control_reference
argument_list|(
operator|(
name|dhcp_control_object_t
operator|*
operator|*
operator|)
name|lp
argument_list|,
name|dhcp_control_object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_control_create
parameter_list|(
name|omapi_object_t
modifier|*
modifier|*
name|lp
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|)
block|{
comment|/* Can't create a control object - there can be only one. */
return|return
name|ISC_R_NOPERM
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_control_remove
parameter_list|(
name|omapi_object_t
modifier|*
name|lp
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|)
block|{
comment|/* Form is emptiness; emptiness form.   The control object 	   cannot go out of existance. */
return|return
name|ISC_R_NOPERM
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_subnet_set_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_typed_data_t
modifier|*
name|value
parameter_list|)
block|{
name|struct
name|subnet
modifier|*
name|subnet
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|int
name|foo
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_subnet
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|subnet
operator|=
operator|(
expr|struct
name|subnet
operator|*
operator|)
name|h
expr_stmt|;
comment|/* No values to set yet. */
comment|/* Try to find some inner object that can take the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
operator|||
name|status
operator|==
name|ISC_R_UNCHANGED
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_subnet_get_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_value_t
modifier|*
modifier|*
name|value
parameter_list|)
block|{
name|struct
name|subnet
modifier|*
name|subnet
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_subnet
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|subnet
operator|=
operator|(
expr|struct
name|subnet
operator|*
operator|)
name|h
expr_stmt|;
comment|/* No values to get yet. */
comment|/* Try to find some inner object that can provide the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_subnet_destroy
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|struct
name|subnet
modifier|*
name|subnet
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_subnet
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|subnet
operator|=
operator|(
expr|struct
name|subnet
operator|*
operator|)
name|h
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
operator|||
expr|\
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE_ON_EXIT
argument_list|)
if|if
condition|(
name|subnet
operator|->
name|next_subnet
condition|)
name|subnet_dereference
argument_list|(
operator|&
name|subnet
operator|->
name|next_subnet
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|subnet
operator|->
name|next_sibling
condition|)
name|subnet_dereference
argument_list|(
operator|&
name|subnet
operator|->
name|next_sibling
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|subnet
operator|->
name|shared_network
condition|)
name|shared_network_dereference
argument_list|(
operator|&
name|subnet
operator|->
name|shared_network
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|subnet
operator|->
name|interface
condition|)
name|interface_dereference
argument_list|(
operator|&
name|subnet
operator|->
name|interface
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|subnet
operator|->
name|group
condition|)
name|group_dereference
argument_list|(
operator|&
name|subnet
operator|->
name|group
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_subnet_signal_handler
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|struct
name|subnet
modifier|*
name|subnet
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|int
name|updatep
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_subnet
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|subnet
operator|=
operator|(
expr|struct
name|subnet
operator|*
operator|)
name|h
expr_stmt|;
comment|/* Can't write subnets yet. */
comment|/* Try to find some inner object that can take the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|name
operator|,
name|ap
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
if|if
condition|(
name|updatep
condition|)
return|return
name|ISC_R_SUCCESS
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_subnet_stuff_values
parameter_list|(
name|omapi_object_t
modifier|*
name|c
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|h
parameter_list|)
block|{
name|struct
name|subnet
modifier|*
name|subnet
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_subnet
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|subnet
operator|=
operator|(
expr|struct
name|subnet
operator|*
operator|)
name|h
expr_stmt|;
comment|/* Can't stuff subnet values yet. */
comment|/* Write out the inner object, if any. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
operator|)
operator|)
operator|(
name|c
operator|,
name|id
operator|,
name|h
operator|->
name|inner
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_subnet_lookup
parameter_list|(
name|omapi_object_t
modifier|*
modifier|*
name|lp
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|ref
parameter_list|)
block|{
name|omapi_value_t
modifier|*
name|tv
init|=
operator|(
name|omapi_value_t
operator|*
operator|)
literal|0
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|struct
name|subnet
modifier|*
name|subnet
decl_stmt|;
comment|/* Can't look up subnets yet. */
comment|/* If we get to here without finding a subnet, no valid key was 	   specified. */
if|if
condition|(
operator|!
operator|*
name|lp
condition|)
return|return
name|ISC_R_NOKEYS
return|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_subnet_create
parameter_list|(
name|omapi_object_t
modifier|*
modifier|*
name|lp
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|)
block|{
return|return
name|ISC_R_NOTIMPLEMENTED
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_subnet_remove
parameter_list|(
name|omapi_object_t
modifier|*
name|lp
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|)
block|{
return|return
name|ISC_R_NOTIMPLEMENTED
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_shared_network_set_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_typed_data_t
modifier|*
name|value
parameter_list|)
block|{
name|struct
name|shared_network
modifier|*
name|shared_network
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|int
name|foo
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_shared_network
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|shared_network
operator|=
operator|(
expr|struct
name|shared_network
operator|*
operator|)
name|h
expr_stmt|;
comment|/* No values to set yet. */
comment|/* Try to find some inner object that can take the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
operator|||
name|status
operator|==
name|ISC_R_UNCHANGED
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_shared_network_get_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_value_t
modifier|*
modifier|*
name|value
parameter_list|)
block|{
name|struct
name|shared_network
modifier|*
name|shared_network
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_shared_network
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|shared_network
operator|=
operator|(
expr|struct
name|shared_network
operator|*
operator|)
name|h
expr_stmt|;
comment|/* No values to get yet. */
comment|/* Try to find some inner object that can provide the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_shared_network_destroy
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|struct
name|shared_network
modifier|*
name|shared_network
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_shared_network
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|shared_network
operator|=
operator|(
expr|struct
name|shared_network
operator|*
operator|)
name|h
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
operator|||
expr|\
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE_ON_EXIT
argument_list|)
if|if
condition|(
name|shared_network
operator|->
name|next
condition|)
name|shared_network_dereference
argument_list|(
operator|&
name|shared_network
operator|->
name|next
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|shared_network
operator|->
name|name
condition|)
block|{
name|dfree
argument_list|(
name|shared_network
operator|->
name|name
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|shared_network
operator|->
name|name
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|shared_network
operator|->
name|subnets
condition|)
name|subnet_dereference
argument_list|(
operator|&
name|shared_network
operator|->
name|subnets
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|shared_network
operator|->
name|interface
condition|)
name|interface_dereference
argument_list|(
operator|&
name|shared_network
operator|->
name|interface
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|shared_network
operator|->
name|pools
condition|)
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|shared_network
operator|->
name|pools
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|shared_network
operator|->
name|group
condition|)
name|group_dereference
argument_list|(
operator|&
name|shared_network
operator|->
name|group
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|FAILOVER_PROTOCOL
argument_list|)
if|if
condition|(
name|shared_network
operator|->
name|failover_peer
condition|)
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|shared_network
operator|->
name|failover_peer
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* DEBUG_MEMORY_LEAKAGE */
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_shared_network_signal_handler
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|struct
name|shared_network
modifier|*
name|shared_network
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|int
name|updatep
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_shared_network
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|shared_network
operator|=
operator|(
expr|struct
name|shared_network
operator|*
operator|)
name|h
expr_stmt|;
comment|/* Can't write shared_networks yet. */
comment|/* Try to find some inner object that can take the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|name
operator|,
name|ap
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
if|if
condition|(
name|updatep
condition|)
return|return
name|ISC_R_SUCCESS
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_shared_network_stuff_values
parameter_list|(
name|omapi_object_t
modifier|*
name|c
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|h
parameter_list|)
block|{
name|struct
name|shared_network
modifier|*
name|shared_network
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|dhcp_type_shared_network
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|shared_network
operator|=
operator|(
expr|struct
name|shared_network
operator|*
operator|)
name|h
expr_stmt|;
comment|/* Can't stuff shared_network values yet. */
comment|/* Write out the inner object, if any. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
operator|)
operator|)
operator|(
name|c
operator|,
name|id
operator|,
name|h
operator|->
name|inner
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_shared_network_lookup
parameter_list|(
name|omapi_object_t
modifier|*
modifier|*
name|lp
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|ref
parameter_list|)
block|{
name|omapi_value_t
modifier|*
name|tv
init|=
operator|(
name|omapi_value_t
operator|*
operator|)
literal|0
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|struct
name|shared_network
modifier|*
name|shared_network
decl_stmt|;
comment|/* Can't look up shared_networks yet. */
comment|/* If we get to here without finding a shared_network, no valid key was 	   specified. */
if|if
condition|(
operator|!
operator|*
name|lp
condition|)
return|return
name|ISC_R_NOKEYS
return|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_shared_network_create
parameter_list|(
name|omapi_object_t
modifier|*
modifier|*
name|lp
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|)
block|{
return|return
name|ISC_R_NOTIMPLEMENTED
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dhcp_shared_network_remove
parameter_list|(
name|omapi_object_t
modifier|*
name|lp
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|)
block|{
return|return
name|ISC_R_NOTIMPLEMENTED
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* trace.c     Subroutines that support dhcp tracing... */
end_comment

begin_comment
comment|/*  * Copyright (c) 2001 Internet Software Consortium.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of The Internet Software Consortium nor the names  *    of its contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INTERNET SOFTWARE CONSORTIUM AND  * CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE INTERNET SOFTWARE CONSORTIUM OR  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * This software has been written for the Internet Software Consortium  * by Ted Lemon, as part of a project for Nominum, Inc.   To learn more  * about the Internet Software Consortium, see http://www.isc.org/.  To  * learn more about Nominum, Inc., see ``http://www.nominum.com''.  */
end_comment

begin_include
include|#
directive|include
file|"dhcpd.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|TRACING
argument_list|)
end_if

begin_function
name|void
name|trace_interface_register
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|,
name|struct
name|interface_info
modifier|*
name|ip
parameter_list|)
block|{
name|trace_interface_packet_t
name|tipkt
decl_stmt|;
if|if
condition|(
name|trace_record
argument_list|()
condition|)
block|{
name|memset
argument_list|(
operator|&
name|tipkt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|tipkt
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|tipkt
operator|.
name|hw_address
argument_list|,
operator|&
name|ip
operator|->
name|hw_address
argument_list|,
sizeof|sizeof
name|ip
operator|->
name|hw_address
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|tipkt
operator|.
name|primary_address
argument_list|,
operator|&
name|ip
operator|->
name|primary_address
argument_list|,
sizeof|sizeof
name|ip
operator|->
name|primary_address
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|tipkt
operator|.
name|name
argument_list|,
name|ip
operator|->
name|name
argument_list|,
sizeof|sizeof
name|ip
operator|->
name|name
argument_list|)
expr_stmt|;
name|tipkt
operator|.
name|index
operator|=
name|htonl
argument_list|(
name|ip
operator|->
name|index
argument_list|)
expr_stmt|;
name|trace_write_packet
argument_list|(
name|ttype
argument_list|,
sizeof|sizeof
name|tipkt
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|tipkt
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|trace_interface_input
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|,
name|unsigned
name|len
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|trace_interface_packet_t
modifier|*
name|tipkt
decl_stmt|;
name|struct
name|interface_info
modifier|*
name|ip
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|struct
name|iaddr
name|addr
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
expr|*
name|tipkt
condition|)
block|{
name|log_error
argument_list|(
literal|"trace interface packet size mismatch: %ld != %d"
argument_list|,
call|(
name|long
call|)
argument_list|(
sizeof|sizeof
expr|*
name|tipkt
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|tipkt
operator|=
operator|(
name|trace_interface_packet_t
operator|*
operator|)
name|buf
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|interface_info
operator|*
operator|)
literal|0
expr_stmt|;
name|status
operator|=
name|interface_allocate
argument_list|(
operator|&
name|ip
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|foo
label|:
name|log_error
argument_list|(
literal|"trace_interface_input: %s."
argument_list|,
name|isc_result_totext
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ip
operator|->
name|ifp
operator|=
name|dmalloc
argument_list|(
sizeof|sizeof
expr|*
operator|(
name|ip
operator|->
name|ifp
operator|)
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ip
operator|->
name|ifp
condition|)
block|{
name|interface_dereference
argument_list|(
operator|&
name|ip
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|status
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|foo
goto|;
block|}
name|memcpy
argument_list|(
operator|&
name|ip
operator|->
name|hw_address
argument_list|,
operator|&
name|tipkt
operator|->
name|hw_address
argument_list|,
sizeof|sizeof
name|ip
operator|->
name|hw_address
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|ip
operator|->
name|primary_address
argument_list|,
operator|&
name|tipkt
operator|->
name|primary_address
argument_list|,
sizeof|sizeof
name|ip
operator|->
name|primary_address
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ip
operator|->
name|name
argument_list|,
name|tipkt
operator|->
name|name
argument_list|,
sizeof|sizeof
name|ip
operator|->
name|name
argument_list|)
expr_stmt|;
name|ip
operator|->
name|index
operator|=
name|ntohl
argument_list|(
name|tipkt
operator|->
name|index
argument_list|)
expr_stmt|;
name|interface_snorf
argument_list|(
name|ip
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dhcp_interface_discovery_hook
condition|)
call|(
modifier|*
name|dhcp_interface_discovery_hook
call|)
argument_list|(
name|ip
argument_list|)
expr_stmt|;
comment|/* Fake up an ifp. */
name|memcpy
argument_list|(
name|ip
operator|->
name|ifp
operator|->
name|ifr_name
argument_list|,
name|ip
operator|->
name|name
argument_list|,
sizeof|sizeof
name|ip
operator|->
name|name
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SA_LEN
name|ip
operator|->
name|ifp
operator|->
name|ifr_addr
operator|.
name|sa_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|ip
operator|->
name|ifp
operator|->
name|ifr_addr
expr_stmt|;
name|sin
operator|->
name|sin_addr
operator|=
name|ip
operator|->
name|primary_address
expr_stmt|;
name|addr
operator|.
name|len
operator|=
literal|4
expr_stmt|;
name|memcpy
argument_list|(
name|addr
operator|.
name|iabuf
argument_list|,
operator|&
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
name|addr
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|dhcp_interface_setup_hook
condition|)
call|(
modifier|*
name|dhcp_interface_setup_hook
call|)
argument_list|(
name|ip
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
name|interface_stash
argument_list|(
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|quiet_interface_discovery
condition|)
block|{
name|log_info
argument_list|(
literal|"Listening on Trace/%s/%s%s%s"
argument_list|,
name|ip
operator|->
name|name
argument_list|,
name|print_hw_addr
argument_list|(
name|ip
operator|->
name|hw_address
operator|.
name|hbuf
index|[
literal|0
index|]
argument_list|,
name|ip
operator|->
name|hw_address
operator|.
name|hlen
operator|-
literal|1
argument_list|,
operator|&
name|ip
operator|->
name|hw_address
operator|.
name|hbuf
index|[
literal|1
index|]
argument_list|)
argument_list|,
operator|(
name|ip
operator|->
name|shared_network
condition|?
literal|"/"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|ip
operator|->
name|shared_network
condition|?
name|ip
operator|->
name|shared_network
operator|->
name|name
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|ip
operator|->
name|name
argument_list|,
literal|"fallback"
argument_list|)
condition|)
block|{
name|log_info
argument_list|(
literal|"Sending   on Trace/%s/%s%s%s"
argument_list|,
name|ip
operator|->
name|name
argument_list|,
name|print_hw_addr
argument_list|(
name|ip
operator|->
name|hw_address
operator|.
name|hbuf
index|[
literal|0
index|]
argument_list|,
name|ip
operator|->
name|hw_address
operator|.
name|hlen
operator|-
literal|1
argument_list|,
operator|&
name|ip
operator|->
name|hw_address
operator|.
name|hbuf
index|[
literal|1
index|]
argument_list|)
argument_list|,
operator|(
name|ip
operator|->
name|shared_network
condition|?
literal|"/"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|ip
operator|->
name|shared_network
condition|?
name|ip
operator|->
name|shared_network
operator|->
name|name
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|interface_dereference
argument_list|(
operator|&
name|ip
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|trace_interface_stop
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|)
block|{
comment|/* XXX */
block|}
end_function

begin_function
name|void
name|trace_inpacket_stash
parameter_list|(
name|struct
name|interface_info
modifier|*
name|interface
parameter_list|,
name|struct
name|dhcp_packet
modifier|*
name|packet
parameter_list|,
name|unsigned
name|len
parameter_list|,
name|unsigned
name|int
name|from_port
parameter_list|,
name|struct
name|iaddr
name|from
parameter_list|,
name|struct
name|hardware
modifier|*
name|hfrom
parameter_list|)
block|{
name|trace_inpacket_t
name|tip
decl_stmt|;
name|trace_iov_t
name|iov
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|trace_record
argument_list|()
condition|)
return|return;
name|tip
operator|.
name|from_port
operator|=
name|from_port
expr_stmt|;
name|tip
operator|.
name|from
operator|=
name|from
expr_stmt|;
if|if
condition|(
name|hfrom
condition|)
block|{
name|tip
operator|.
name|hfrom
operator|=
operator|*
name|hfrom
expr_stmt|;
name|tip
operator|.
name|havehfrom
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|memset
argument_list|(
operator|&
name|tip
operator|.
name|hfrom
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|tip
operator|.
name|hfrom
argument_list|)
expr_stmt|;
name|tip
operator|.
name|havehfrom
operator|=
literal|0
expr_stmt|;
block|}
name|tip
operator|.
name|index
operator|=
name|htonl
argument_list|(
name|interface
operator|->
name|index
argument_list|)
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|tip
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|len
operator|=
sizeof|sizeof
name|tip
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
name|packet
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|trace_write_packet_iov
argument_list|(
name|inpacket_trace
argument_list|,
literal|2
argument_list|,
name|iov
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|trace_inpacket_input
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|,
name|unsigned
name|len
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|trace_inpacket_t
modifier|*
name|tip
decl_stmt|;
name|int
name|index
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
expr|*
name|tip
condition|)
block|{
name|log_error
argument_list|(
literal|"trace_input_packet: too short - %d"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|tip
operator|=
operator|(
name|trace_inpacket_t
operator|*
operator|)
name|buf
expr_stmt|;
name|index
operator|=
name|ntohl
argument_list|(
name|tip
operator|->
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|>
name|interface_count
operator|||
name|index
operator|<
literal|0
operator|||
operator|!
name|interface_vector
index|[
name|index
index|]
condition|)
block|{
name|log_error
argument_list|(
literal|"trace_input_packet: unknown interface index %d"
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|bootp_packet_handler
condition|)
block|{
name|log_error
argument_list|(
literal|"trace_input_packet: no bootp packet handler."
argument_list|)
expr_stmt|;
return|return;
block|}
call|(
modifier|*
name|bootp_packet_handler
call|)
argument_list|(
name|interface_vector
index|[
name|index
index|]
argument_list|,
operator|(
expr|struct
name|dhcp_packet
operator|*
operator|)
operator|(
name|tip
operator|+
literal|1
operator|)
argument_list|,
name|len
operator|-
sizeof|sizeof
expr|*
name|tip
argument_list|,
name|tip
operator|->
name|from_port
argument_list|,
name|tip
operator|->
name|from
argument_list|,
operator|(
name|tip
operator|->
name|havehfrom
condition|?
operator|&
name|tip
operator|->
name|hfrom
else|:
operator|(
expr|struct
name|hardware
operator|*
operator|)
literal|0
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|trace_inpacket_stop
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|)
block|{ }
end_function

begin_function
name|ssize_t
name|trace_packet_send
parameter_list|(
name|struct
name|interface_info
modifier|*
name|interface
parameter_list|,
name|struct
name|packet
modifier|*
name|packet
parameter_list|,
name|struct
name|dhcp_packet
modifier|*
name|raw
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|in_addr
name|from
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|to
parameter_list|,
name|struct
name|hardware
modifier|*
name|hto
parameter_list|)
block|{
name|trace_outpacket_t
name|tip
decl_stmt|;
name|trace_iov_t
name|iov
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|trace_record
argument_list|()
condition|)
block|{
if|if
condition|(
name|hto
condition|)
block|{
name|tip
operator|.
name|hto
operator|=
operator|*
name|hto
expr_stmt|;
name|tip
operator|.
name|havehto
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|memset
argument_list|(
operator|&
name|tip
operator|.
name|hto
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|tip
operator|.
name|hto
argument_list|)
expr_stmt|;
name|tip
operator|.
name|havehto
operator|=
literal|0
expr_stmt|;
block|}
name|tip
operator|.
name|from
operator|.
name|len
operator|=
literal|4
expr_stmt|;
name|memcpy
argument_list|(
name|tip
operator|.
name|from
operator|.
name|iabuf
argument_list|,
operator|&
name|from
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tip
operator|.
name|to
operator|.
name|len
operator|=
literal|4
expr_stmt|;
name|memcpy
argument_list|(
name|tip
operator|.
name|to
operator|.
name|iabuf
argument_list|,
operator|&
name|to
operator|->
name|sin_addr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tip
operator|.
name|to_port
operator|=
name|to
operator|->
name|sin_port
expr_stmt|;
name|tip
operator|.
name|index
operator|=
name|htonl
argument_list|(
name|interface
operator|->
name|index
argument_list|)
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|tip
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|len
operator|=
sizeof|sizeof
name|tip
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
name|raw
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|trace_write_packet_iov
argument_list|(
name|outpacket_trace
argument_list|,
literal|2
argument_list|,
name|iov
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|trace_playback
argument_list|()
condition|)
block|{
return|return
name|send_packet
argument_list|(
name|interface
argument_list|,
name|packet
argument_list|,
name|raw
argument_list|,
name|len
argument_list|,
name|from
argument_list|,
name|to
argument_list|,
name|hto
argument_list|)
return|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|void
name|trace_outpacket_input
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|,
name|unsigned
name|len
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|trace_outpacket_t
modifier|*
name|tip
decl_stmt|;
name|int
name|index
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
expr|*
name|tip
condition|)
block|{
name|log_error
argument_list|(
literal|"trace_input_packet: too short - %d"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|tip
operator|=
operator|(
name|trace_outpacket_t
operator|*
operator|)
name|buf
expr_stmt|;
name|index
operator|=
name|ntohl
argument_list|(
name|tip
operator|->
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|>
name|interface_count
operator|||
name|index
operator|<
literal|0
operator|||
operator|!
name|interface_vector
index|[
name|index
index|]
condition|)
block|{
name|log_error
argument_list|(
literal|"trace_input_packet: unknown interface index %d"
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* XXX would be nice to somehow take notice of these. */
block|}
end_function

begin_function
name|void
name|trace_outpacket_stop
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|)
block|{ }
end_function

begin_function
name|void
name|trace_seed_stash
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|,
name|unsigned
name|seed
parameter_list|)
block|{
name|u_int32_t
name|outseed
decl_stmt|;
if|if
condition|(
operator|!
name|trace_record
argument_list|()
condition|)
return|return;
name|outseed
operator|=
name|htonl
argument_list|(
name|seed
argument_list|)
expr_stmt|;
name|trace_write_packet
argument_list|(
name|ttype
argument_list|,
sizeof|sizeof
name|outseed
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|outseed
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|trace_seed_input
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|,
name|unsigned
name|length
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|seed
decl_stmt|;
if|if
condition|(
name|length
operator|!=
sizeof|sizeof
name|seed
condition|)
block|{
name|log_error
argument_list|(
literal|"trace_seed_input: wrong size (%d)"
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
name|seed
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|buf
expr_stmt|;
name|srandom
argument_list|(
name|ntohl
argument_list|(
operator|*
name|seed
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|trace_seed_stop
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|)
block|{ }
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* TRACING */
end_comment

end_unit


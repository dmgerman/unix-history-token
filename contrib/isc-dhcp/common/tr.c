begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * packet_tr.c - token ring interface code, contributed in May of 1999  * by Andrew Chittenden  */
end_comment

begin_include
include|#
directive|include
file|"dhcpd.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_TR_SUPPORT
argument_list|)
operator|&&
expr|\
operator|(
name|defined
argument_list|(
name|PACKET_ASSEMBLY
argument_list|)
operator|||
name|defined
argument_list|(
name|PACKET_DECODING
argument_list|)
operator|)
end_if

begin_include
include|#
directive|include
file|"includes/netinet/ip.h"
end_include

begin_include
include|#
directive|include
file|"includes/netinet/udp.h"
end_include

begin_include
include|#
directive|include
file|"includes/netinet/if_ether.h"
end_include

begin_include
include|#
directive|include
file|"netinet/if_tr.h"
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_comment
comment|/*  * token ring device handling subroutines.  These are required as token-ring  * does not have a simple on-the-wire header but requires the use of  * source routing  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|insert_source_routing
name|PROTO
argument_list|(
operator|(
expr|struct
name|trh_hdr
operator|*
name|trh
operator|,
expr|struct
name|interface_info
operator|*
name|interface
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|save_source_routing
name|PROTO
argument_list|(
operator|(
expr|struct
name|trh_hdr
operator|*
name|trh
operator|,
expr|struct
name|interface_info
operator|*
name|interface
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|expire_routes
name|PROTO
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * As we keep a list of interesting routing information only, a singly  * linked list is all we need  */
end_comment

begin_struct
struct|struct
name|routing_entry
block|{
name|struct
name|routing_entry
modifier|*
name|next
decl_stmt|;
name|unsigned
name|char
name|addr
index|[
name|TR_ALEN
index|]
decl_stmt|;
name|unsigned
name|char
name|iface
index|[
literal|5
index|]
decl_stmt|;
name|__u16
name|rcf
decl_stmt|;
comment|/* route control field */
name|__u16
name|rseg
index|[
literal|8
index|]
decl_stmt|;
comment|/* routing registers */
name|unsigned
name|long
name|access_time
decl_stmt|;
comment|/* time we last used this entry */
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|routing_entry
modifier|*
name|routing_info
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|routing_timeout
init|=
literal|10
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|timeval
name|routing_timer
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|assemble_tr_header
parameter_list|(
name|interface
parameter_list|,
name|buf
parameter_list|,
name|bufix
parameter_list|,
name|to
parameter_list|)
name|struct
name|interface_info
modifier|*
name|interface
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|int
modifier|*
name|bufix
decl_stmt|;
name|struct
name|hardware
modifier|*
name|to
decl_stmt|;
block|{
name|struct
name|trh_hdr
modifier|*
name|trh
decl_stmt|;
name|int
name|hdr_len
decl_stmt|;
name|struct
name|trllc
modifier|*
name|llc
decl_stmt|;
comment|/* set up the token header */
name|trh
operator|=
operator|(
expr|struct
name|trh_hdr
operator|*
operator|)
operator|&
name|buf
index|[
operator|*
name|bufix
index|]
expr_stmt|;
if|if
condition|(
name|interface
operator|->
name|hw_address
operator|.
name|hlen
operator|==
sizeof|sizeof
argument_list|(
name|trh
operator|->
name|saddr
argument_list|)
condition|)
name|memcpy
argument_list|(
name|trh
operator|->
name|saddr
argument_list|,
name|interface
operator|->
name|hw_address
operator|.
name|haddr
argument_list|,
sizeof|sizeof
argument_list|(
name|trh
operator|->
name|saddr
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|memset
argument_list|(
name|trh
operator|->
name|saddr
argument_list|,
literal|0x00
argument_list|,
sizeof|sizeof
argument_list|(
name|trh
operator|->
name|saddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|to
operator|&&
name|to
operator|->
name|hlen
operator|==
literal|6
condition|)
comment|/* XXX */
name|memcpy
argument_list|(
name|trh
operator|->
name|daddr
argument_list|,
name|to
operator|->
name|haddr
argument_list|,
sizeof|sizeof
name|trh
operator|->
name|daddr
argument_list|)
expr_stmt|;
else|else
name|memset
argument_list|(
name|trh
operator|->
name|daddr
argument_list|,
literal|0xff
argument_list|,
sizeof|sizeof
argument_list|(
name|trh
operator|->
name|daddr
argument_list|)
argument_list|)
expr_stmt|;
name|hdr_len
operator|=
name|insert_source_routing
argument_list|(
name|trh
argument_list|,
name|interface
argument_list|)
expr_stmt|;
name|trh
operator|->
name|ac
operator|=
name|AC
expr_stmt|;
name|trh
operator|->
name|fc
operator|=
name|LLC_FRAME
expr_stmt|;
comment|/* set up the llc header for snap encoding after the tr header */
name|llc
operator|=
operator|(
expr|struct
name|trllc
operator|*
operator|)
operator|(
name|buf
operator|+
operator|*
name|bufix
operator|+
name|hdr_len
operator|)
expr_stmt|;
name|llc
operator|->
name|dsap
operator|=
name|EXTENDED_SAP
expr_stmt|;
name|llc
operator|->
name|ssap
operator|=
name|EXTENDED_SAP
expr_stmt|;
name|llc
operator|->
name|llc
operator|=
name|UI_CMD
expr_stmt|;
name|llc
operator|->
name|protid
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|llc
operator|->
name|protid
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|llc
operator|->
name|protid
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|llc
operator|->
name|ethertype
operator|=
name|htons
argument_list|(
name|ETHERTYPE_IP
argument_list|)
expr_stmt|;
name|hdr_len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|trllc
argument_list|)
expr_stmt|;
operator|*
name|bufix
operator|+=
name|hdr_len
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|tr_broadcast
index|[
literal|6
index|]
init|=
block|{
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * decoding the token header is a bit complex as you can see here. It is  * further complicated by the linux kernel stripping off some valuable  * information (see comment below) even though we've asked for the raw  * packets.  */
end_comment

begin_function
name|ssize_t
name|decode_tr_header
parameter_list|(
name|interface
parameter_list|,
name|buf
parameter_list|,
name|bufix
parameter_list|,
name|from
parameter_list|)
name|struct
name|interface_info
modifier|*
name|interface
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|bufix
decl_stmt|;
name|struct
name|hardware
modifier|*
name|from
decl_stmt|;
block|{
name|struct
name|trh_hdr
modifier|*
name|trh
init|=
operator|(
expr|struct
name|trh_hdr
operator|*
operator|)
name|buf
operator|+
name|bufix
decl_stmt|;
name|struct
name|trllc
modifier|*
name|llc
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|udp
decl_stmt|;
name|unsigned
name|int
name|route_len
init|=
literal|0
decl_stmt|;
name|ssize_t
name|hdr_len
decl_stmt|;
name|struct
name|timeval
name|now
decl_stmt|;
comment|/* see whether any source routing information has expired */
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|routing_timer
operator|.
name|tv_sec
operator|==
literal|0
condition|)
name|routing_timer
operator|.
name|tv_sec
operator|=
name|now
operator|.
name|tv_sec
operator|+
name|routing_timeout
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|now
operator|.
name|tv_sec
operator|-
name|routing_timer
operator|.
name|tv_sec
operator|)
operator|>
literal|0
condition|)
name|expire_routes
argument_list|()
expr_stmt|;
comment|/* the kernel might have stripped off the source          * routing bit. We try a heuristic to determine whether          * this is the case and put it back on if so          */
name|route_len
operator|=
operator|(
name|ntohs
argument_list|(
name|trh
operator|->
name|rcf
argument_list|)
operator|&
name|TR_RCF_LEN_MASK
operator|)
operator|>>
literal|8
expr_stmt|;
name|llc
operator|=
operator|(
expr|struct
name|trllc
operator|*
operator|)
operator|(
name|buf
operator|+
name|bufix
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|trh_hdr
argument_list|)
operator|-
name|TR_MAXRIFLEN
operator|+
name|route_len
operator|)
expr_stmt|;
if|if
condition|(
name|llc
operator|->
name|dsap
operator|==
name|EXTENDED_SAP
operator|&&
name|llc
operator|->
name|ssap
operator|==
name|EXTENDED_SAP
operator|&&
name|llc
operator|->
name|llc
operator|==
name|UI_CMD
operator|&&
name|llc
operator|->
name|protid
index|[
literal|0
index|]
operator|==
literal|0
operator|&&
name|llc
operator|->
name|protid
index|[
literal|1
index|]
operator|==
literal|0
operator|&&
name|llc
operator|->
name|protid
index|[
literal|2
index|]
operator|==
literal|0
condition|)
block|{
comment|/* say there is source routing information present */
name|trh
operator|->
name|saddr
index|[
literal|0
index|]
operator||=
name|TR_RII
expr_stmt|;
block|}
if|if
condition|(
name|trh
operator|->
name|saddr
index|[
literal|0
index|]
operator|&
name|TR_RII
condition|)
name|route_len
operator|=
operator|(
name|ntohs
argument_list|(
name|trh
operator|->
name|rcf
argument_list|)
operator|&
name|TR_RCF_LEN_MASK
operator|)
operator|>>
literal|8
expr_stmt|;
else|else
name|route_len
operator|=
literal|0
expr_stmt|;
name|hdr_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|trh_hdr
argument_list|)
operator|-
name|TR_MAXRIFLEN
operator|+
name|route_len
expr_stmt|;
comment|/* now filter out unwanted packets: this is based on the packet          * filter code in bpf.c */
name|llc
operator|=
operator|(
expr|struct
name|trllc
operator|*
operator|)
operator|(
name|buf
operator|+
name|bufix
operator|+
name|hdr_len
operator|)
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|llc
operator|+
literal|1
operator|)
expr_stmt|;
name|udp
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ip
operator|+
name|ip
operator|->
name|ip_hl
operator|*
literal|4
operator|)
expr_stmt|;
comment|/* make sure it is a snap encoded, IP, UDP, unfragmented packet sent          * to our port */
if|if
condition|(
name|llc
operator|->
name|dsap
operator|!=
name|EXTENDED_SAP
operator|||
name|ntohs
argument_list|(
name|llc
operator|->
name|ethertype
argument_list|)
operator|!=
name|ETHERTYPE_IP
operator|||
name|ip
operator|->
name|ip_p
operator|!=
name|IPPROTO_UDP
operator|||
operator|(
name|ip
operator|->
name|ip_off
operator|&
name|IP_OFFMASK
operator|)
operator|!=
literal|0
operator|||
name|udp
operator|->
name|uh_dport
operator|!=
name|local_port
condition|)
return|return
operator|-
literal|1
return|;
comment|/* only save source routing information for packets from valued hosts */
name|save_source_routing
argument_list|(
name|trh
argument_list|,
name|interface
argument_list|)
expr_stmt|;
return|return
name|hdr_len
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|trllc
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* insert_source_routing inserts source route information into the token ring  * header  */
end_comment

begin_function
specifier|static
name|int
name|insert_source_routing
parameter_list|(
name|trh
parameter_list|,
name|interface
parameter_list|)
name|struct
name|trh_hdr
modifier|*
name|trh
decl_stmt|;
name|struct
name|interface_info
modifier|*
name|interface
decl_stmt|;
block|{
name|struct
name|routing_entry
modifier|*
name|rover
decl_stmt|;
name|struct
name|timeval
name|now
decl_stmt|;
name|unsigned
name|int
name|route_len
init|=
literal|0
decl_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* single route broadcasts as per rfc 1042 */
if|if
condition|(
name|memcmp
argument_list|(
name|trh
operator|->
name|daddr
argument_list|,
name|tr_broadcast
argument_list|,
name|TR_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|trh
operator|->
name|saddr
index|[
literal|0
index|]
operator||=
name|TR_RII
expr_stmt|;
name|trh
operator|->
name|rcf
operator|=
operator|(
operator|(
sizeof|sizeof
argument_list|(
name|trh
operator|->
name|rcf
argument_list|)
operator|)
operator|<<
literal|8
operator|)
operator|&
name|TR_RCF_LEN_MASK
expr_stmt|;
name|trh
operator|->
name|rcf
operator||=
operator|(
name|TR_RCF_FRAME2K
operator||
name|TR_RCF_LIMITED_BROADCAST
operator|)
expr_stmt|;
name|trh
operator|->
name|rcf
operator|=
name|htons
argument_list|(
name|trh
operator|->
name|rcf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* look for a routing entry */
for|for
control|(
name|rover
operator|=
name|routing_info
init|;
name|rover
operator|!=
name|NULL
condition|;
name|rover
operator|=
name|rover
operator|->
name|next
control|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|rover
operator|->
name|addr
argument_list|,
name|trh
operator|->
name|daddr
argument_list|,
name|TR_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|rover
operator|!=
name|NULL
condition|)
block|{
comment|/* success: route that frame */
if|if
condition|(
operator|(
name|rover
operator|->
name|rcf
operator|&
name|TR_RCF_LEN_MASK
operator|)
operator|>>
literal|8
condition|)
block|{
name|__u16
name|rcf
init|=
name|rover
operator|->
name|rcf
decl_stmt|;
name|memcpy
argument_list|(
name|trh
operator|->
name|rseg
argument_list|,
name|rover
operator|->
name|rseg
argument_list|,
sizeof|sizeof
argument_list|(
name|trh
operator|->
name|rseg
argument_list|)
argument_list|)
expr_stmt|;
name|rcf
operator|^=
name|TR_RCF_DIR_BIT
expr_stmt|;
name|rcf
operator|&=
operator|~
name|TR_RCF_BROADCAST_MASK
expr_stmt|;
name|trh
operator|->
name|rcf
operator|=
name|htons
argument_list|(
name|rcf
argument_list|)
expr_stmt|;
name|trh
operator|->
name|saddr
index|[
literal|0
index|]
operator||=
name|TR_RII
expr_stmt|;
block|}
name|rover
operator|->
name|access_time
operator|=
name|now
operator|.
name|tv_sec
expr_stmt|;
block|}
else|else
block|{
comment|/* we don't have any routing information so send a                          * limited broadcast */
name|trh
operator|->
name|saddr
index|[
literal|0
index|]
operator||=
name|TR_RII
expr_stmt|;
name|trh
operator|->
name|rcf
operator|=
operator|(
operator|(
sizeof|sizeof
argument_list|(
name|trh
operator|->
name|rcf
argument_list|)
operator|)
operator|<<
literal|8
operator|)
operator|&
name|TR_RCF_LEN_MASK
expr_stmt|;
name|trh
operator|->
name|rcf
operator||=
operator|(
name|TR_RCF_FRAME2K
operator||
name|TR_RCF_LIMITED_BROADCAST
operator|)
expr_stmt|;
name|trh
operator|->
name|rcf
operator|=
name|htons
argument_list|(
name|trh
operator|->
name|rcf
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* return how much of the header we've actually used */
if|if
condition|(
name|trh
operator|->
name|saddr
index|[
literal|0
index|]
operator|&
name|TR_RII
condition|)
name|route_len
operator|=
operator|(
name|ntohs
argument_list|(
name|trh
operator|->
name|rcf
argument_list|)
operator|&
name|TR_RCF_LEN_MASK
operator|)
operator|>>
literal|8
expr_stmt|;
else|else
name|route_len
operator|=
literal|0
expr_stmt|;
return|return
sizeof|sizeof
argument_list|(
expr|struct
name|trh_hdr
argument_list|)
operator|-
name|TR_MAXRIFLEN
operator|+
name|route_len
return|;
block|}
end_function

begin_comment
comment|/*  * save any source routing information  */
end_comment

begin_function
specifier|static
name|void
name|save_source_routing
parameter_list|(
name|trh
parameter_list|,
name|interface
parameter_list|)
name|struct
name|trh_hdr
modifier|*
name|trh
decl_stmt|;
name|struct
name|interface_info
modifier|*
name|interface
decl_stmt|;
block|{
name|struct
name|routing_entry
modifier|*
name|rover
decl_stmt|;
name|struct
name|timeval
name|now
decl_stmt|;
name|unsigned
name|char
name|saddr
index|[
name|TR_ALEN
index|]
decl_stmt|;
name|__u16
name|rcf
init|=
literal|0
decl_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|saddr
argument_list|,
name|trh
operator|->
name|saddr
argument_list|,
sizeof|sizeof
argument_list|(
name|saddr
argument_list|)
argument_list|)
expr_stmt|;
name|saddr
index|[
literal|0
index|]
operator|&=
literal|0x7f
expr_stmt|;
comment|/* strip off source routing present flag */
comment|/* scan our table to see if we've got it */
for|for
control|(
name|rover
operator|=
name|routing_info
init|;
name|rover
operator|!=
name|NULL
condition|;
name|rover
operator|=
name|rover
operator|->
name|next
control|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|rover
operator|->
name|addr
index|[
literal|0
index|]
argument_list|,
operator|&
name|saddr
index|[
literal|0
index|]
argument_list|,
name|TR_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
comment|/* found an entry so update it with fresh information */
if|if
condition|(
name|rover
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|trh
operator|->
name|saddr
index|[
literal|0
index|]
operator|&
name|TR_RII
operator|)
operator|&&
operator|(
operator|(
operator|(
name|ntohs
argument_list|(
name|trh
operator|->
name|rcf
argument_list|)
operator|&
name|TR_RCF_LEN_MASK
operator|)
operator|>>
literal|8
operator|)
operator|>
literal|2
operator|)
condition|)
block|{
name|rcf
operator|=
name|ntohs
argument_list|(
name|trh
operator|->
name|rcf
argument_list|)
expr_stmt|;
name|rcf
operator|&=
operator|~
name|TR_RCF_BROADCAST_MASK
expr_stmt|;
name|memcpy
argument_list|(
name|rover
operator|->
name|rseg
argument_list|,
name|trh
operator|->
name|rseg
argument_list|,
sizeof|sizeof
argument_list|(
name|rover
operator|->
name|rseg
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|rover
operator|->
name|rcf
operator|=
name|rcf
expr_stmt|;
name|rover
operator|->
name|access_time
operator|=
name|now
operator|.
name|tv_sec
expr_stmt|;
return|return;
comment|/* that's all folks */
block|}
comment|/* no entry found, so create one */
name|rover
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|routing_entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rover
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: unable to save source routing information\n"
argument_list|,
name|__FILE__
argument_list|)
expr_stmt|;
return|return;
block|}
name|memcpy
argument_list|(
name|rover
operator|->
name|addr
argument_list|,
name|saddr
argument_list|,
sizeof|sizeof
argument_list|(
name|rover
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rover
operator|->
name|iface
argument_list|,
name|interface
operator|->
name|name
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|rover
operator|->
name|access_time
operator|=
name|now
operator|.
name|tv_sec
expr_stmt|;
if|if
condition|(
name|trh
operator|->
name|saddr
index|[
literal|0
index|]
operator|&
name|TR_RII
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|ntohs
argument_list|(
name|trh
operator|->
name|rcf
argument_list|)
operator|&
name|TR_RCF_LEN_MASK
operator|)
operator|>>
literal|8
operator|)
operator|>
literal|2
condition|)
block|{
name|rcf
operator|=
name|ntohs
argument_list|(
name|trh
operator|->
name|rcf
argument_list|)
expr_stmt|;
name|rcf
operator|&=
operator|~
name|TR_RCF_BROADCAST_MASK
expr_stmt|;
name|memcpy
argument_list|(
name|rover
operator|->
name|rseg
argument_list|,
name|trh
operator|->
name|rseg
argument_list|,
sizeof|sizeof
argument_list|(
name|rover
operator|->
name|rseg
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|rover
operator|->
name|rcf
operator|=
name|rcf
expr_stmt|;
block|}
comment|/* insert into list */
name|rover
operator|->
name|next
operator|=
name|routing_info
expr_stmt|;
name|routing_info
operator|=
name|rover
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * get rid of old routes  */
end_comment

begin_function
specifier|static
name|void
name|expire_routes
parameter_list|()
block|{
name|struct
name|routing_entry
modifier|*
name|rover
decl_stmt|;
name|struct
name|routing_entry
modifier|*
modifier|*
name|prover
init|=
operator|&
name|routing_info
decl_stmt|;
name|struct
name|timeval
name|now
decl_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|rover
operator|=
operator|*
name|prover
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|now
operator|.
name|tv_sec
operator|-
name|rover
operator|->
name|access_time
operator|)
operator|>
name|routing_timeout
condition|)
block|{
operator|*
name|prover
operator|=
name|rover
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|rover
argument_list|)
expr_stmt|;
block|}
else|else
name|prover
operator|=
operator|&
name|rover
operator|->
name|next
expr_stmt|;
block|}
comment|/* Reset the timer */
name|routing_timer
operator|.
name|tv_sec
operator|=
name|now
operator|.
name|tv_sec
operator|+
name|routing_timeout
expr_stmt|;
name|routing_timer
operator|.
name|tv_usec
operator|=
name|now
operator|.
name|tv_usec
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


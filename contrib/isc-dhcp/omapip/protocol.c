begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* protocol.c     Functions supporting the object management protocol... */
end_comment

begin_comment
comment|/*  * Copyright (c) 1999-2000 Internet Software Consortium.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of The Internet Software Consortium nor the names  *    of its contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INTERNET SOFTWARE CONSORTIUM AND  * CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE INTERNET SOFTWARE CONSORTIUM OR  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * This software has been written for the Internet Software Consortium  * by Ted Lemon in cooperation with Vixie Enterprises and Nominum, Inc.  * To learn more about the Internet Software Consortium, see  * ``http://www.isc.org/''.  To learn more about Vixie Enterprises,  * see ``http://www.vix.com''.   To learn more about Nominum, Inc., see  * ``http://www.nominum.com''.  */
end_comment

begin_include
include|#
directive|include
file|<omapip/omapip_p.h>
end_include

begin_macro
name|OMAPI_OBJECT_ALLOC
argument_list|(
argument|omapi_protocol
argument_list|,
argument|omapi_protocol_object_t
argument_list|,
argument|omapi_type_protocol
argument_list|)
end_macro

begin_macro
name|OMAPI_OBJECT_ALLOC
argument_list|(
argument|omapi_protocol_listener
argument_list|,
argument|omapi_protocol_listener_object_t
argument_list|,
argument|omapi_type_protocol_listener
argument_list|)
end_macro

begin_function
name|isc_result_t
name|omapi_protocol_connect
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|server_name
parameter_list|,
name|unsigned
name|port
parameter_list|,
name|omapi_object_t
modifier|*
name|a
parameter_list|)
block|{
name|isc_result_t
name|rstatus
decl_stmt|,
name|status
decl_stmt|;
name|omapi_protocol_object_t
modifier|*
name|obj
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_PROTOCOL
name|log_debug
argument_list|(
literal|"omapi_protocol_connect(%s port=%d)"
argument_list|,
name|server_name
argument_list|,
name|port
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|obj
operator|=
operator|(
name|omapi_protocol_object_t
operator|*
operator|)
literal|0
expr_stmt|;
name|status
operator|=
name|omapi_protocol_allocate
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|rstatus
operator|=
name|omapi_connect
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|obj
argument_list|,
name|server_name
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|rstatus
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|rstatus
operator|!=
name|ISC_R_INCOMPLETE
condition|)
block|{
name|omapi_protocol_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|rstatus
return|;
block|}
name|status
operator|=
name|omapi_object_reference
argument_list|(
operator|&
name|h
operator|->
name|outer
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_protocol_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_object_reference
argument_list|(
operator|&
name|obj
operator|->
name|inner
argument_list|,
name|h
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_protocol_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* If we were passed a default authenticator, store it now.  We'll 	   open it once we're connected. */
if|if
condition|(
name|a
condition|)
block|{
name|obj
operator|->
name|default_auth
operator|=
name|dmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|omapi_remote_auth_t
argument_list|)
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|obj
operator|->
name|default_auth
condition|)
block|{
name|omapi_protocol_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_NOMEMORY
return|;
block|}
name|obj
operator|->
name|default_auth
operator|->
name|next
operator|=
operator|(
name|omapi_remote_auth_t
operator|*
operator|)
literal|0
expr_stmt|;
name|status
operator|=
name|omapi_object_reference
argument_list|(
operator|&
name|obj
operator|->
name|default_auth
operator|->
name|a
argument_list|,
name|a
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dfree
argument_list|(
name|obj
operator|->
name|default_auth
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_protocol_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|obj
operator|->
name|insecure
operator|=
literal|0
expr_stmt|;
name|rstatus
operator|=
name|ISC_R_INCOMPLETE
expr_stmt|;
block|}
else|else
block|{
name|obj
operator|->
name|insecure
operator|=
literal|1
expr_stmt|;
if|#
directive|if
literal|0
block|status = ISC_R_SUCCESS;
endif|#
directive|endif
block|}
name|omapi_protocol_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|rstatus
return|;
block|}
end_function

begin_comment
comment|/* Send the protocol introduction message. */
end_comment

begin_function
name|isc_result_t
name|omapi_protocol_send_intro
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|unsigned
name|ver
parameter_list|,
name|unsigned
name|hsize
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_protocol_object_t
modifier|*
name|p
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_PROTOCOL
name|log_debug
argument_list|(
literal|"omapi_protocol_send_intro()"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_protocol
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|p
operator|=
operator|(
name|omapi_protocol_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
operator|!
name|h
operator|->
name|outer
operator|||
name|h
operator|->
name|outer
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
name|ISC_R_NOTCONNECTED
return|;
name|status
operator|=
name|omapi_connection_put_uint32
argument_list|(
name|h
operator|->
name|outer
argument_list|,
name|ver
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|status
operator|=
name|omapi_connection_put_uint32
argument_list|(
name|h
operator|->
name|outer
argument_list|,
name|hsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
comment|/* Require the other end to send an intro - this kicks off the 	   protocol input state machine. */
name|p
operator|->
name|state
operator|=
name|omapi_protocol_intro_wait
expr_stmt|;
name|status
operator|=
name|omapi_connection_require
argument_list|(
name|h
operator|->
name|outer
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|status
operator|!=
name|ISC_R_NOTYET
condition|)
return|return
name|status
return|;
comment|/* Make up an initial transaction ID for this connection. */
name|p
operator|->
name|next_xid
operator|=
name|random
argument_list|()
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_protocol_send_message
parameter_list|(
name|omapi_object_t
modifier|*
name|po
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|mo
parameter_list|,
name|omapi_object_t
modifier|*
name|omo
parameter_list|)
block|{
name|omapi_protocol_object_t
modifier|*
name|p
decl_stmt|;
name|omapi_object_t
modifier|*
name|c
decl_stmt|;
name|omapi_message_object_t
modifier|*
name|m
decl_stmt|,
modifier|*
name|om
decl_stmt|;
name|omapi_remote_auth_t
modifier|*
name|ra
decl_stmt|;
name|omapi_value_t
modifier|*
name|signature
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|u_int32_t
name|foo
decl_stmt|;
name|unsigned
name|auth_len
decl_stmt|;
if|if
condition|(
name|po
operator|->
name|type
operator|!=
name|omapi_type_protocol
operator|||
operator|!
name|po
operator|->
name|outer
operator|||
name|po
operator|->
name|outer
operator|->
name|type
operator|!=
name|omapi_type_connection
operator|||
name|mo
operator|->
name|type
operator|!=
name|omapi_type_message
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|omo
operator|&&
name|omo
operator|->
name|type
operator|!=
name|omapi_type_message
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|p
operator|=
operator|(
name|omapi_protocol_object_t
operator|*
operator|)
name|po
expr_stmt|;
name|c
operator|=
operator|(
name|omapi_object_t
operator|*
operator|)
operator|(
name|po
operator|->
name|outer
operator|)
expr_stmt|;
name|m
operator|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
name|mo
expr_stmt|;
name|om
operator|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
name|omo
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_PROTOCOL
name|log_debug
argument_list|(
literal|"omapi_protocol_send_message()"
literal|"op=%ld  handle=%#lx  id=%#lx  rid=%#lx"
argument_list|,
operator|(
name|long
operator|)
name|m
operator|->
name|op
argument_list|,
call|(
name|long
call|)
argument_list|(
name|m
operator|->
name|object
condition|?
name|m
operator|->
name|object
operator|->
name|handle
else|:
name|m
operator|->
name|handle
argument_list|)
argument_list|,
operator|(
name|long
operator|)
name|p
operator|->
name|next_xid
argument_list|,
operator|(
name|long
operator|)
name|m
operator|->
name|rid
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Find the authid to use for this message. */
if|if
condition|(
name|id
condition|)
block|{
for|for
control|(
name|ra
operator|=
name|p
operator|->
name|remote_auth_list
init|;
name|ra
condition|;
name|ra
operator|=
name|ra
operator|->
name|next
control|)
block|{
if|if
condition|(
name|ra
operator|->
name|a
operator|==
name|id
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|ra
condition|)
return|return
name|ISC_R_KEY_UNKNOWN
return|;
block|}
elseif|else
if|if
condition|(
name|p
operator|->
name|remote_auth_list
condition|)
block|{
name|ra
operator|=
name|p
operator|->
name|default_auth
expr_stmt|;
block|}
else|else
block|{
name|ra
operator|=
operator|(
name|omapi_remote_auth_t
operator|*
operator|)
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ra
condition|)
block|{
name|m
operator|->
name|authid
operator|=
name|ra
operator|->
name|remote_handle
expr_stmt|;
name|status
operator|=
name|omapi_object_reference
argument_list|(
operator|&
name|m
operator|->
name|id_object
argument_list|,
name|ra
operator|->
name|a
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
comment|/* Write the ID of the authentication key we're using. */
name|status
operator|=
name|omapi_connection_put_uint32
argument_list|(
name|c
argument_list|,
name|ra
condition|?
name|ra
operator|->
name|remote_handle
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Activate the authentication key on the connection. */
name|auth_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ra
condition|)
block|{
name|status
operator|=
name|omapi_set_object_value
argument_list|(
name|c
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"output-authenticator"
argument_list|,
name|ra
operator|->
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_connection_output_auth_length
argument_list|(
name|c
argument_list|,
operator|&
name|auth_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
comment|/* Write the authenticator length */
name|status
operator|=
name|omapi_connection_put_uint32
argument_list|(
name|c
argument_list|,
name|auth_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Write the opcode. */
name|status
operator|=
name|omapi_connection_put_uint32
argument_list|(
name|c
argument_list|,
name|m
operator|->
name|op
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Write the handle.  If we've been given an explicit handle, use 	   that.   Otherwise, use the handle of the object we're sending. 	   The caller is responsible for arranging for one of these handles 	   to be set (or not). */
name|status
operator|=
name|omapi_connection_put_uint32
argument_list|(
name|c
argument_list|,
operator|(
name|m
operator|->
name|h
condition|?
name|m
operator|->
name|h
else|:
operator|(
name|m
operator|->
name|object
condition|?
name|m
operator|->
name|object
operator|->
name|handle
else|:
literal|0
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Set and write the transaction ID. */
name|m
operator|->
name|id
operator|=
name|p
operator|->
name|next_xid
operator|++
expr_stmt|;
name|status
operator|=
name|omapi_connection_put_uint32
argument_list|(
name|c
argument_list|,
name|m
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Write the transaction ID of the message to which this is a 	   response, if there is such a message. */
name|status
operator|=
name|omapi_connection_put_uint32
argument_list|(
name|c
argument_list|,
name|om
condition|?
name|om
operator|->
name|id
else|:
name|m
operator|->
name|rid
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Stuff out the name/value pairs specific to this message. */
name|status
operator|=
name|omapi_stuff_values
argument_list|(
name|c
argument_list|,
name|id
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Write the zero-length name that terminates the list of name/value 	   pairs specific to the message. */
name|status
operator|=
name|omapi_connection_put_uint16
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Stuff out all the published name/value pairs in the object that's 	   being sent in the message, if there is one. */
if|if
condition|(
name|m
operator|->
name|object
condition|)
block|{
name|status
operator|=
name|omapi_stuff_values
argument_list|(
name|c
argument_list|,
name|id
argument_list|,
name|m
operator|->
name|object
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
comment|/* Write the zero-length name that terminates the list of name/value 	   pairs for the associated object. */
name|status
operator|=
name|omapi_connection_put_uint16
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
if|if
condition|(
name|ra
condition|)
block|{
comment|/* Calculate the message signature. */
name|signature
operator|=
operator|(
name|omapi_value_t
operator|*
operator|)
literal|0
expr_stmt|;
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|c
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"output-signature"
argument_list|,
operator|&
name|signature
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Write the authenticator... */
name|status
operator|=
operator|(
name|omapi_connection_copyin
argument_list|(
name|c
argument_list|,
name|signature
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|signature
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
argument_list|)
operator|)
expr_stmt|;
name|omapi_value_dereference
argument_list|(
operator|&
name|signature
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Dectivate the authentication key on the connection. */
name|status
operator|=
name|omapi_set_value_str
argument_list|(
name|c
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"output-authenticator"
argument_list|,
operator|(
name|omapi_typed_data_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
if|if
condition|(
operator|!
name|omo
condition|)
block|{
name|omapi_protocol_reference
argument_list|(
operator|&
name|m
operator|->
name|protocol_object
argument_list|,
name|p
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_protocol_signal_handler
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_protocol_object_t
modifier|*
name|p
decl_stmt|;
name|omapi_object_t
modifier|*
name|c
decl_stmt|;
name|omapi_message_object_t
modifier|*
name|m
decl_stmt|;
name|omapi_value_t
modifier|*
name|signature
decl_stmt|;
name|u_int16_t
name|nlen
decl_stmt|;
name|u_int32_t
name|vlen
decl_stmt|;
name|u_int32_t
name|th
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
name|unsigned
name|long
name|previous_outstanding
init|=
literal|0xDEADBEEF
decl_stmt|;
name|unsigned
name|long
name|connect_outstanding
init|=
literal|0xDEADBEEF
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_protocol
condition|)
block|{
comment|/* XXX shouldn't happen.   Put an assert here? */
return|return
name|ISC_R_UNEXPECTED
return|;
block|}
name|p
operator|=
operator|(
name|omapi_protocol_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"connect"
argument_list|)
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
name|connect_outstanding
operator|=
name|dmalloc_outstanding
expr_stmt|;
endif|#
directive|endif
comment|/* Send the introductory message. */
name|status
operator|=
name|omapi_protocol_send_intro
argument_list|(
name|h
argument_list|,
name|OMAPI_PROTOCOL_VERSION
argument_list|,
sizeof|sizeof
argument_list|(
name|omapi_protocol_header_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|p
operator|->
name|outer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
return|return
name|ISC_R_SUCCESS
return|;
block|}
comment|/* Should only receive these when opening the initial authenticator. */
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"status"
argument_list|)
condition|)
block|{
name|status
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|isc_result_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_signal_in
argument_list|(
name|h
operator|->
name|inner
argument_list|,
literal|"status"
argument_list|,
name|status
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|omapi_disconnect
argument_list|(
name|p
operator|->
name|outer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
return|return
name|omapi_signal_in
argument_list|(
name|h
operator|->
name|inner
argument_list|,
literal|"ready"
argument_list|)
return|;
block|}
block|}
comment|/* If we get a disconnect, dump memory usage. */
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"disconnect"
argument_list|)
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
if|if
condition|(
name|connect_outstanding
operator|!=
literal|0xDEADBEEF
condition|)
block|{
name|log_info
argument_list|(
literal|"generation %ld: %ld new, %ld outstanding, %ld%s"
argument_list|,
name|dmalloc_generation
argument_list|,
name|dmalloc_outstanding
operator|-
name|previous_outstanding
argument_list|,
name|dmalloc_outstanding
argument_list|,
name|dmalloc_longterm
argument_list|,
literal|" long-term"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
name|dmalloc_dump_outstanding
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_RC_HISTORY_EXHAUSTIVELY
argument_list|)
name|dump_rc_history
argument_list|()
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|m
operator|=
name|omapi_registered_messages
init|;
name|m
condition|;
name|m
operator|=
name|m
operator|->
name|next
control|)
block|{
if|if
condition|(
name|m
operator|->
name|protocol_object
operator|==
name|p
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|object
condition|)
name|omapi_signal
argument_list|(
name|m
operator|->
name|object
argument_list|,
literal|"disconnect"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Not a signal we recognize? */
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"ready"
argument_list|)
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|inner
operator|&&
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
condition|)
return|return
operator|(
operator|*
operator|(
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
operator|)
operator|)
operator|(
name|h
operator|,
name|name
operator|,
name|ap
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
if|if
condition|(
operator|!
name|p
operator|->
name|outer
operator|||
name|p
operator|->
name|outer
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|c
operator|=
name|p
operator|->
name|outer
expr_stmt|;
comment|/* We get here because we requested that we be woken up after            some number of bytes were read, and that number of bytes            has in fact been read. */
switch|switch
condition|(
name|p
operator|->
name|state
condition|)
block|{
case|case
name|omapi_protocol_intro_wait
case|:
comment|/* Get protocol version and header size in network 		   byte order. */
name|omapi_connection_get_uint32
argument_list|(
name|c
argument_list|,
operator|&
name|p
operator|->
name|protocol_version
argument_list|)
expr_stmt|;
name|omapi_connection_get_uint32
argument_list|(
name|c
argument_list|,
operator|&
name|p
operator|->
name|header_size
argument_list|)
expr_stmt|;
comment|/* We currently only support the current protocol version. */
if|if
condition|(
name|p
operator|->
name|protocol_version
operator|!=
name|OMAPI_PROTOCOL_VERSION
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ISC_R_VERSIONMISMATCH
return|;
block|}
if|if
condition|(
name|p
operator|->
name|header_size
operator|<
sizeof|sizeof
argument_list|(
name|omapi_protocol_header_t
argument_list|)
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ISC_R_PROTOCOLERROR
return|;
block|}
if|if
condition|(
name|p
operator|->
name|default_auth
condition|)
block|{
name|status
operator|=
name|omapi_protocol_send_open
argument_list|(
name|h
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"authenticator"
argument_list|,
name|p
operator|->
name|default_auth
operator|->
name|a
argument_list|,
name|OMAPI_NOTIFY_PROTOCOL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
else|else
block|{
name|status
operator|=
name|omapi_signal_in
argument_list|(
name|h
operator|->
name|inner
argument_list|,
literal|"ready"
argument_list|)
expr_stmt|;
block|}
name|to_header_wait
label|:
comment|/* The next thing we're expecting is a message header. */
name|p
operator|->
name|state
operator|=
name|omapi_protocol_header_wait
expr_stmt|;
comment|/* Register a need for the number of bytes in a 		   header, and if we already have that many, process 		   them immediately. */
if|if
condition|(
operator|(
name|omapi_connection_require
argument_list|(
name|c
argument_list|,
name|p
operator|->
name|header_size
argument_list|)
operator|)
operator|!=
name|ISC_R_SUCCESS
condition|)
break|break;
comment|/* If we already have the data, fall through. */
case|case
name|omapi_protocol_header_wait
case|:
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
if|if
condition|(
name|previous_outstanding
operator|!=
literal|0xDEADBEEF
condition|)
block|{
name|log_info
argument_list|(
literal|"%s %ld: %ld new, %ld outstanding, %ld%s"
argument_list|,
literal|"generation"
argument_list|,
name|dmalloc_generation
argument_list|,
name|dmalloc_outstanding
operator|-
name|previous_outstanding
argument_list|,
name|dmalloc_outstanding
argument_list|,
name|dmalloc_longterm
argument_list|,
literal|" long-term"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
operator|(
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
operator|||
name|defined
argument_list|(
name|DEBUG_MALLOC_POOL
argument_list|)
operator|)
name|dmalloc_dump_outstanding
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_RC_HISTORY_EXHAUSTIVELY
argument_list|)
name|dump_rc_history
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
block|}
name|previous_outstanding
operator|=
name|dmalloc_outstanding
expr_stmt|;
endif|#
directive|endif
name|status
operator|=
name|omapi_message_new
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|p
operator|->
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|p
operator|->
name|verify_result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
comment|/* Swap in the header... */
name|omapi_connection_get_uint32
argument_list|(
name|c
argument_list|,
operator|&
name|p
operator|->
name|message
operator|->
name|authid
argument_list|)
expr_stmt|;
comment|/* Bind the authenticator to the message object. */
if|if
condition|(
name|p
operator|->
name|message
operator|->
name|authid
condition|)
block|{
name|status
operator|=
operator|(
name|omapi_protocol_lookup_auth
argument_list|(
operator|&
name|p
operator|->
name|message
operator|->
name|id_object
argument_list|,
name|h
argument_list|,
name|p
operator|->
name|message
operator|->
name|authid
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
name|p
operator|->
name|verify_result
operator|=
name|status
expr_stmt|;
comment|/* Activate the authentication key. */
name|status
operator|=
name|omapi_set_object_value
argument_list|(
name|c
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"input-authenticator"
argument_list|,
name|p
operator|->
name|message
operator|->
name|id_object
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
name|omapi_connection_get_uint32
argument_list|(
name|c
argument_list|,
operator|&
name|p
operator|->
name|message
operator|->
name|authlen
argument_list|)
expr_stmt|;
name|omapi_connection_get_uint32
argument_list|(
name|c
argument_list|,
operator|&
name|p
operator|->
name|message
operator|->
name|op
argument_list|)
expr_stmt|;
name|omapi_connection_get_uint32
argument_list|(
name|c
argument_list|,
operator|&
name|th
argument_list|)
expr_stmt|;
name|p
operator|->
name|message
operator|->
name|h
operator|=
name|th
expr_stmt|;
name|omapi_connection_get_uint32
argument_list|(
name|c
argument_list|,
operator|&
name|p
operator|->
name|message
operator|->
name|id
argument_list|)
expr_stmt|;
name|omapi_connection_get_uint32
argument_list|(
name|c
argument_list|,
operator|&
name|p
operator|->
name|message
operator|->
name|rid
argument_list|)
expr_stmt|;
comment|/* If there was any extra header data, skip over it. */
if|if
condition|(
name|p
operator|->
name|header_size
operator|>
sizeof|sizeof
argument_list|(
name|omapi_protocol_header_t
argument_list|)
condition|)
block|{
name|omapi_connection_copyout
argument_list|(
literal|0
argument_list|,
name|c
argument_list|,
operator|(
name|p
operator|->
name|header_size
operator|-
sizeof|sizeof
argument_list|(
name|omapi_protocol_header_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* XXX must compute partial signature across the                    XXX preceding bytes.    Also, if authenticator 		   specifies encryption as well as signing, we may 		   have to decrypt the data on the way in. */
comment|/* First we read in message-specific values, then object 		   values. */
name|p
operator|->
name|reading_message_values
operator|=
literal|1
expr_stmt|;
name|need_name_length
label|:
comment|/* The next thing we're expecting is length of the 		   first name. */
name|p
operator|->
name|state
operator|=
name|omapi_protocol_name_length_wait
expr_stmt|;
comment|/* Wait for a 16-bit length. */
if|if
condition|(
operator|(
name|omapi_connection_require
argument_list|(
name|c
argument_list|,
literal|2
argument_list|)
operator|)
operator|!=
name|ISC_R_SUCCESS
condition|)
break|break;
comment|/* If it's already here, fall through. */
case|case
name|omapi_protocol_name_length_wait
case|:
name|omapi_connection_get_uint16
argument_list|(
name|c
argument_list|,
operator|&
name|nlen
argument_list|)
expr_stmt|;
comment|/* A zero-length name means that we're done reading name+value 		   pairs. */
if|if
condition|(
name|nlen
operator|==
literal|0
condition|)
block|{
comment|/* If we've already read in the object, we are 			   done reading the message, but if we've just 			   finished reading in the values associated 			   with the message, we need to read the 			   object. */
if|if
condition|(
name|p
operator|->
name|reading_message_values
condition|)
block|{
name|p
operator|->
name|reading_message_values
operator|=
literal|0
expr_stmt|;
goto|goto
name|need_name_length
goto|;
block|}
comment|/* If the authenticator length is zero, there's no 			   signature to read in, so go straight to processing 			   the message. */
if|if
condition|(
name|p
operator|->
name|message
operator|->
name|authlen
operator|==
literal|0
condition|)
goto|goto
name|message_done
goto|;
comment|/* The next thing we're expecting is the                            message signature. */
name|p
operator|->
name|state
operator|=
name|omapi_protocol_signature_wait
expr_stmt|;
comment|/* Wait for the number of bytes specified for 			   the authenticator.  If we already have it, 			   go read it in. */
if|if
condition|(
name|omapi_connection_require
argument_list|(
name|c
argument_list|,
name|p
operator|->
name|message
operator|->
name|authlen
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
goto|goto
name|signature_wait
goto|;
break|break;
block|}
comment|/* Allocate a buffer for the name. */
name|status
operator|=
operator|(
name|omapi_data_string_new
argument_list|(
operator|&
name|p
operator|->
name|name
argument_list|,
name|nlen
argument_list|,
name|MDL
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ISC_R_NOMEMORY
return|;
block|}
name|p
operator|->
name|state
operator|=
name|omapi_protocol_name_wait
expr_stmt|;
if|if
condition|(
name|omapi_connection_require
argument_list|(
name|c
argument_list|,
name|nlen
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
break|break;
comment|/* If it's already here, fall through. */
case|case
name|omapi_protocol_name_wait
case|:
name|omapi_connection_copyout
argument_list|(
name|p
operator|->
name|name
operator|->
name|value
argument_list|,
name|c
argument_list|,
name|p
operator|->
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
comment|/* Wait for a 32-bit length. */
name|p
operator|->
name|state
operator|=
name|omapi_protocol_value_length_wait
expr_stmt|;
if|if
condition|(
operator|(
name|omapi_connection_require
argument_list|(
name|c
argument_list|,
literal|4
argument_list|)
operator|)
operator|!=
name|ISC_R_SUCCESS
condition|)
break|break;
comment|/* If it's already here, fall through. */
case|case
name|omapi_protocol_value_length_wait
case|:
name|omapi_connection_get_uint32
argument_list|(
name|c
argument_list|,
operator|&
name|vlen
argument_list|)
expr_stmt|;
comment|/* Zero-length values are allowed - if we get one, we 		   don't have to read any data for the value - just 		   get the next one, if there is a next one. */
if|if
condition|(
operator|!
name|vlen
condition|)
goto|goto
name|insert_new_value
goto|;
name|status
operator|=
name|omapi_typed_data_new
argument_list|(
name|MDL
argument_list|,
operator|&
name|p
operator|->
name|value
argument_list|,
name|omapi_datatype_data
argument_list|,
name|vlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ISC_R_NOMEMORY
return|;
block|}
name|p
operator|->
name|state
operator|=
name|omapi_protocol_value_wait
expr_stmt|;
if|if
condition|(
name|omapi_connection_require
argument_list|(
name|c
argument_list|,
name|vlen
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
break|break;
comment|/* If it's already here, fall through. */
case|case
name|omapi_protocol_value_wait
case|:
name|omapi_connection_copyout
argument_list|(
name|p
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|c
argument_list|,
name|p
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
argument_list|)
expr_stmt|;
name|insert_new_value
label|:
if|if
condition|(
name|p
operator|->
name|reading_message_values
condition|)
block|{
name|status
operator|=
operator|(
name|omapi_set_value
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|p
operator|->
name|message
argument_list|,
name|p
operator|->
name|message
operator|->
name|id_object
argument_list|,
name|p
operator|->
name|name
argument_list|,
name|p
operator|->
name|value
argument_list|)
operator|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|p
operator|->
name|message
operator|->
name|object
condition|)
block|{
comment|/* We need a generic object to hang off of the 				   incoming message. */
name|status
operator|=
operator|(
name|omapi_generic_new
argument_list|(
operator|&
name|p
operator|->
name|message
operator|->
name|object
argument_list|,
name|MDL
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
name|status
operator|=
operator|(
name|omapi_set_value
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|p
operator|->
name|message
operator|->
name|object
argument_list|,
name|p
operator|->
name|message
operator|->
name|id_object
argument_list|,
name|p
operator|->
name|name
argument_list|,
name|p
operator|->
name|value
argument_list|)
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|omapi_data_string_dereference
argument_list|(
operator|&
name|p
operator|->
name|name
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|value
condition|)
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|p
operator|->
name|value
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
goto|goto
name|need_name_length
goto|;
name|signature_wait
label|:
case|case
name|omapi_protocol_signature_wait
case|:
if|if
condition|(
name|p
operator|->
name|message
operator|->
name|id_object
condition|)
block|{
comment|/* Compute the signature of the message. */
name|signature
operator|=
operator|(
name|omapi_value_t
operator|*
operator|)
literal|0
expr_stmt|;
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|c
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"input-signature"
argument_list|,
operator|&
name|signature
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Disable the authentication key on the connection. */
name|status
operator|=
name|omapi_set_value_str
argument_list|(
name|c
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"input-authenticator"
argument_list|,
operator|(
name|omapi_typed_data_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_value_dereference
argument_list|(
operator|&
name|signature
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
comment|/* Read the authenticator. */
name|status
operator|=
name|omapi_typed_data_new
argument_list|(
name|MDL
argument_list|,
operator|&
name|p
operator|->
name|message
operator|->
name|authenticator
argument_list|,
name|omapi_datatype_data
argument_list|,
name|p
operator|->
name|message
operator|->
name|authlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_value_dereference
argument_list|(
operator|&
name|signature
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ISC_R_NOMEMORY
return|;
block|}
name|omapi_connection_copyout
argument_list|(
name|p
operator|->
name|message
operator|->
name|authenticator
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|c
argument_list|,
name|p
operator|->
name|message
operator|->
name|authlen
argument_list|)
expr_stmt|;
comment|/* Verify the signature. */
if|if
condition|(
name|p
operator|->
name|message
operator|->
name|id_object
operator|&&
operator|(
operator|(
name|signature
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
operator|!=
name|p
operator|->
name|message
operator|->
name|authlen
operator|)
operator|||
operator|(
name|memcmp
argument_list|(
name|signature
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|p
operator|->
name|message
operator|->
name|authenticator
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|p
operator|->
name|message
operator|->
name|authlen
argument_list|)
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
comment|/* Invalid signature. */
name|p
operator|->
name|verify_result
operator|=
name|ISC_R_INVALIDKEY
expr_stmt|;
block|}
name|omapi_value_dereference
argument_list|(
operator|&
name|signature
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
comment|/* Process the message. */
name|message_done
label|:
if|if
condition|(
name|p
operator|->
name|verify_result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|status
operator|=
name|omapi_protocol_send_status
argument_list|(
name|h
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
name|p
operator|->
name|verify_result
argument_list|,
name|p
operator|->
name|message
operator|->
name|id
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|omapi_message_process
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|p
operator|->
name|message
argument_list|,
name|h
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ISC_R_NOMEMORY
return|;
block|}
name|omapi_message_dereference
argument_list|(
operator|&
name|p
operator|->
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
name|log_info
argument_list|(
literal|"generation %ld: %ld new, %ld outstanding, %ld%s"
argument_list|,
name|dmalloc_generation
argument_list|,
name|dmalloc_outstanding
operator|-
name|previous_outstanding
argument_list|,
name|dmalloc_outstanding
argument_list|,
name|dmalloc_longterm
argument_list|,
literal|" long-term"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
operator|(
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
operator|||
name|defined
argument_list|(
name|DEBUG_MALLOC_POOL
argument_list|)
operator|)
name|dmalloc_dump_outstanding
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_RC_HISTORY_EXHAUSTIVELY
argument_list|)
name|dump_rc_history
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
name|previous_outstanding
operator|=
literal|0xDEADBEEF
expr_stmt|;
endif|#
directive|endif
comment|/* Now wait for the next message. */
goto|goto
name|to_header_wait
goto|;
default|default:
comment|/* XXX should never get here.   Assertion? */
break|break;
block|}
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_protocol_add_auth
parameter_list|(
name|omapi_object_t
modifier|*
name|po
parameter_list|,
name|omapi_object_t
modifier|*
name|ao
parameter_list|,
name|omapi_handle_t
name|handle
parameter_list|)
block|{
name|omapi_protocol_object_t
modifier|*
name|p
decl_stmt|;
name|omapi_remote_auth_t
modifier|*
name|r
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|ao
operator|->
name|type
operator|!=
name|omapi_type_auth_key
operator|&&
operator|(
operator|!
name|ao
operator|->
name|inner
operator|||
name|ao
operator|->
name|inner
operator|->
name|type
operator|!=
name|omapi_type_auth_key
operator|)
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|po
operator|->
name|type
operator|!=
name|omapi_type_protocol
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|p
operator|=
operator|(
name|omapi_protocol_object_t
operator|*
operator|)
name|po
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_PROTOCOL
name|log_debug
argument_list|(
literal|"omapi_protocol_add_auth(name=%s)"
argument_list|,
operator|(
operator|(
name|omapi_auth_key_t
operator|*
operator|)
name|ao
operator|)
operator|->
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|p
operator|->
name|verify_auth
condition|)
block|{
name|status
operator|=
call|(
name|p
operator|->
name|verify_auth
call|)
argument_list|(
name|po
argument_list|,
operator|(
name|omapi_auth_key_t
operator|*
operator|)
name|ao
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
comment|/* If omapi_protocol_connect() was called with a default 	   authenticator, p -> default_auth will already be set, 	   but p -> remote_auth_list will not yet be initialized. */
if|if
condition|(
name|p
operator|->
name|default_auth
operator|&&
operator|!
name|p
operator|->
name|remote_auth_list
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|default_auth
operator|->
name|a
operator|!=
name|ao
condition|)
block|{
comment|/* Something just went horribly wrong. */
name|omapi_disconnect
argument_list|(
name|p
operator|->
name|outer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ISC_R_UNEXPECTED
return|;
block|}
name|p
operator|->
name|remote_auth_list
operator|=
name|p
operator|->
name|default_auth
expr_stmt|;
name|p
operator|->
name|default_auth
operator|->
name|remote_handle
operator|=
name|handle
expr_stmt|;
return|return
name|omapi_signal_in
argument_list|(
name|p
operator|->
name|inner
argument_list|,
literal|"ready"
argument_list|)
return|;
block|}
name|r
operator|=
name|dmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|r
argument_list|)
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
return|return
name|ISC_R_NOMEMORY
return|;
name|status
operator|=
name|omapi_object_reference
argument_list|(
operator|&
name|r
operator|->
name|a
argument_list|,
name|ao
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dfree
argument_list|(
name|r
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|r
operator|->
name|remote_handle
operator|=
name|handle
expr_stmt|;
name|r
operator|->
name|next
operator|=
name|p
operator|->
name|remote_auth_list
expr_stmt|;
name|p
operator|->
name|remote_auth_list
operator|=
name|r
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_protocol_lookup_auth
parameter_list|(
name|omapi_object_t
modifier|*
modifier|*
name|a
parameter_list|,
name|omapi_object_t
modifier|*
name|po
parameter_list|,
name|omapi_handle_t
name|handle
parameter_list|)
block|{
name|omapi_protocol_object_t
modifier|*
name|p
decl_stmt|;
name|omapi_remote_auth_t
modifier|*
name|r
decl_stmt|;
if|if
condition|(
name|po
operator|->
name|type
operator|!=
name|omapi_type_protocol
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|p
operator|=
operator|(
name|omapi_protocol_object_t
operator|*
operator|)
name|po
expr_stmt|;
for|for
control|(
name|r
operator|=
name|p
operator|->
name|remote_auth_list
init|;
name|r
condition|;
name|r
operator|=
name|r
operator|->
name|next
control|)
if|if
condition|(
name|r
operator|->
name|remote_handle
operator|==
name|handle
condition|)
return|return
name|omapi_object_reference
argument_list|(
name|a
argument_list|,
name|r
operator|->
name|a
argument_list|,
name|MDL
argument_list|)
return|;
return|return
name|ISC_R_KEY_UNKNOWN
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_protocol_set_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_typed_data_t
modifier|*
name|value
parameter_list|)
block|{
name|omapi_protocol_object_t
modifier|*
name|p
decl_stmt|;
name|omapi_remote_auth_t
modifier|*
name|r
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_protocol
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|p
operator|=
operator|(
name|omapi_protocol_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"default-authenticator"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|value
operator|->
name|type
operator|!=
name|omapi_datatype_object
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
operator|!
name|value
operator|||
operator|!
name|value
operator|->
name|u
operator|.
name|object
condition|)
block|{
name|p
operator|->
name|default_auth
operator|=
operator|(
name|omapi_remote_auth_t
operator|*
operator|)
literal|0
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|r
operator|=
name|p
operator|->
name|remote_auth_list
init|;
name|r
condition|;
name|r
operator|=
name|r
operator|->
name|next
control|)
if|if
condition|(
name|r
operator|->
name|a
operator|==
name|value
operator|->
name|u
operator|.
name|object
condition|)
break|break;
if|if
condition|(
operator|!
name|r
condition|)
return|return
name|ISC_R_KEY_UNKNOWN
return|;
name|p
operator|->
name|default_auth
operator|=
name|r
expr_stmt|;
block|}
return|return
name|ISC_R_SUCCESS
return|;
block|}
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
condition|)
return|return
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_protocol_get_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_value_t
modifier|*
modifier|*
name|value
parameter_list|)
block|{
name|omapi_protocol_object_t
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_protocol
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|p
operator|=
operator|(
name|omapi_protocol_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"default-authenticator"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|p
operator|->
name|default_auth
condition|)
return|return
name|ISC_R_NOTFOUND
return|;
return|return
name|omapi_make_object_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
name|p
operator|->
name|default_auth
operator|->
name|a
argument_list|,
name|MDL
argument_list|)
return|;
block|}
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
return|return
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_protocol_destroy
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|omapi_protocol_object_t
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_protocol
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|p
operator|=
operator|(
name|omapi_protocol_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|message
condition|)
name|omapi_message_dereference
argument_list|(
operator|&
name|p
operator|->
name|message
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
comment|/* This will happen if: 1) A default authenticator is supplied to 	   omapi_protocol_connect(), and 2) something goes wrong before 	   the authenticator can be opened. */
if|if
condition|(
name|p
operator|->
name|default_auth
operator|&&
operator|!
name|p
operator|->
name|remote_auth_list
condition|)
name|dfree
argument_list|(
name|p
operator|->
name|default_auth
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
while|while
condition|(
name|p
operator|->
name|remote_auth_list
condition|)
block|{
name|omapi_remote_auth_t
modifier|*
name|r
init|=
name|p
operator|->
name|remote_auth_list
operator|->
name|next
decl_stmt|;
name|p
operator|->
name|remote_auth_list
operator|=
name|r
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|r
operator|->
name|a
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|dfree
argument_list|(
name|r
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* Write all the published values associated with the object through the    specified connection. */
end_comment

begin_function
name|isc_result_t
name|omapi_protocol_stuff_values
parameter_list|(
name|omapi_object_t
modifier|*
name|c
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|type
operator|!=
name|omapi_type_protocol
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|p
operator|->
name|inner
operator|&&
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
condition|)
return|return
operator|(
operator|*
operator|(
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
operator|)
operator|)
operator|(
name|c
operator|,
name|id
operator|,
name|p
operator|->
name|inner
operator|)
return|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* Returns a boolean indicating whether this protocol requires that    messages be authenticated or not. */
end_comment

begin_function
name|isc_boolean_t
name|omapi_protocol_authenticated
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|)
block|{
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_protocol
condition|)
return|return
name|isc_boolean_false
return|;
if|if
condition|(
operator|(
operator|(
name|omapi_protocol_object_t
operator|*
operator|)
name|h
operator|)
operator|->
name|insecure
condition|)
return|return
name|isc_boolean_false
return|;
else|else
return|return
name|isc_boolean_true
return|;
block|}
end_function

begin_comment
comment|/* Sets the address and authenticator verification callbacks.  The handle    is to a listener object, not a protocol object. */
end_comment

begin_function
name|isc_result_t
name|omapi_protocol_configure_security
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|isc_result_t
function_decl|(
modifier|*
name|verify_addr
function_decl|)
parameter_list|(
name|omapi_object_t
modifier|*
parameter_list|,
name|omapi_addr_t
modifier|*
parameter_list|)
parameter_list|,
name|isc_result_t
function_decl|(
modifier|*
name|verify_auth
function_decl|)
parameter_list|(
name|omapi_object_t
modifier|*
parameter_list|,
name|omapi_auth_key_t
modifier|*
parameter_list|)
parameter_list|)
block|{
name|omapi_protocol_listener_object_t
modifier|*
name|l
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|outer
operator|&&
name|h
operator|->
name|outer
operator|->
name|type
operator|==
name|omapi_type_protocol_listener
condition|)
name|h
operator|=
name|h
operator|->
name|outer
expr_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_protocol_listener
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|l
operator|=
operator|(
name|omapi_protocol_listener_object_t
operator|*
operator|)
name|h
expr_stmt|;
name|l
operator|->
name|verify_auth
operator|=
name|verify_auth
expr_stmt|;
name|l
operator|->
name|insecure
operator|=
literal|0
expr_stmt|;
return|return
name|omapi_listener_configure_security
argument_list|(
name|h
operator|->
name|outer
argument_list|,
name|verify_addr
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Set up a listener for the omapi protocol.    The handle stored points to    a listener object, not a protocol object. */
end_comment

begin_function
name|isc_result_t
name|omapi_protocol_listen
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|unsigned
name|port
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_protocol_listener_object_t
modifier|*
name|obj
decl_stmt|;
name|obj
operator|=
operator|(
name|omapi_protocol_listener_object_t
operator|*
operator|)
literal|0
expr_stmt|;
name|status
operator|=
name|omapi_protocol_listener_allocate
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|status
operator|=
name|omapi_object_reference
argument_list|(
operator|&
name|h
operator|->
name|outer
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_protocol_listener_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_object_reference
argument_list|(
operator|&
name|obj
operator|->
name|inner
argument_list|,
name|h
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_protocol_listener_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* What a terrible default. */
name|obj
operator|->
name|insecure
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|omapi_listen
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|obj
argument_list|,
name|port
argument_list|,
name|max
argument_list|)
expr_stmt|;
name|omapi_protocol_listener_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* Signal handler for protocol listener - if we get a connect signal,    create a new protocol connection, otherwise pass the signal down. */
end_comment

begin_function
name|isc_result_t
name|omapi_protocol_listener_signal
parameter_list|(
name|omapi_object_t
modifier|*
name|o
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_object_t
modifier|*
name|c
decl_stmt|;
name|omapi_protocol_object_t
modifier|*
name|obj
decl_stmt|;
name|omapi_protocol_listener_object_t
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|o
operator|||
name|o
operator|->
name|type
operator|!=
name|omapi_type_protocol_listener
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|p
operator|=
operator|(
name|omapi_protocol_listener_object_t
operator|*
operator|)
name|o
expr_stmt|;
comment|/* Not a signal we recognize? */
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"connect"
argument_list|)
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|inner
operator|&&
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
condition|)
return|return
operator|(
operator|*
operator|(
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
operator|)
operator|)
operator|(
name|p
operator|->
name|inner
operator|,
name|name
operator|,
name|ap
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
name|c
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|omapi_object_t
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|c
operator|||
name|c
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|obj
operator|=
operator|(
name|omapi_protocol_object_t
operator|*
operator|)
literal|0
expr_stmt|;
name|status
operator|=
name|omapi_protocol_allocate
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|obj
operator|->
name|verify_auth
operator|=
name|p
operator|->
name|verify_auth
expr_stmt|;
name|obj
operator|->
name|insecure
operator|=
name|p
operator|->
name|insecure
expr_stmt|;
name|status
operator|=
name|omapi_object_reference
argument_list|(
operator|&
name|obj
operator|->
name|outer
argument_list|,
name|c
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|lose
label|:
name|omapi_protocol_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_disconnect
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_object_reference
argument_list|(
operator|&
name|c
operator|->
name|inner
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|lose
goto|;
comment|/* Send the introductory message. */
name|status
operator|=
name|omapi_protocol_send_intro
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|obj
argument_list|,
name|OMAPI_PROTOCOL_VERSION
argument_list|,
sizeof|sizeof
argument_list|(
name|omapi_protocol_header_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|lose
goto|;
name|omapi_protocol_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_protocol_listener_set_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_typed_data_t
modifier|*
name|value
parameter_list|)
block|{
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_protocol_listener
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
condition|)
return|return
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_protocol_listener_get_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_value_t
modifier|*
modifier|*
name|value
parameter_list|)
block|{
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_protocol_listener
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
return|return
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_protocol_listener_destroy
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_protocol_listener
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* Write all the published values associated with the object through the    specified connection. */
end_comment

begin_function
name|isc_result_t
name|omapi_protocol_listener_stuff
parameter_list|(
name|omapi_object_t
modifier|*
name|c
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|type
operator|!=
name|omapi_type_protocol_listener
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|p
operator|->
name|inner
operator|&&
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
condition|)
return|return
operator|(
operator|*
operator|(
name|p
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
operator|)
operator|)
operator|(
name|c
operator|,
name|id
operator|,
name|p
operator|->
name|inner
operator|)
return|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_protocol_send_status
parameter_list|(
name|omapi_object_t
modifier|*
name|po
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|isc_result_t
name|waitstatus
parameter_list|,
name|unsigned
name|rid
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_message_object_t
modifier|*
name|message
init|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
literal|0
decl_stmt|;
name|omapi_object_t
modifier|*
name|mo
decl_stmt|;
if|if
condition|(
name|po
operator|->
name|type
operator|!=
name|omapi_type_protocol
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|status
operator|=
name|omapi_message_new
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|mo
operator|=
operator|(
name|omapi_object_t
operator|*
operator|)
name|message
expr_stmt|;
name|status
operator|=
name|omapi_set_int_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"op"
argument_list|,
name|OMAPI_OP_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_message_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_int_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"rid"
argument_list|,
operator|(
name|int
operator|)
name|rid
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_message_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_int_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"result"
argument_list|,
operator|(
name|int
operator|)
name|waitstatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_message_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* If a message has been provided, send it. */
if|if
condition|(
name|msg
condition|)
block|{
name|status
operator|=
name|omapi_set_string_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"message"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_message_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
name|status
operator|=
name|omapi_protocol_send_message
argument_list|(
name|po
argument_list|,
name|id
argument_list|,
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|omapi_message_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* The OMAPI_NOTIFY_PROTOCOL flag will cause the notify-object for the    message to be set to the protocol object.  This is used when opening    the default authenticator. */
end_comment

begin_function
name|isc_result_t
name|omapi_protocol_send_open
parameter_list|(
name|omapi_object_t
modifier|*
name|po
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
name|omapi_object_t
modifier|*
name|object
parameter_list|,
name|unsigned
name|flags
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_message_object_t
modifier|*
name|message
init|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
literal|0
decl_stmt|;
name|omapi_object_t
modifier|*
name|mo
decl_stmt|;
if|if
condition|(
name|po
operator|->
name|type
operator|!=
name|omapi_type_protocol
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|status
operator|=
name|omapi_message_new
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|mo
operator|=
operator|(
name|omapi_object_t
operator|*
operator|)
name|message
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
name|status
operator|=
name|omapi_set_int_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"op"
argument_list|,
name|OMAPI_OP_OPEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
name|status
operator|=
name|omapi_set_object_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"object"
argument_list|,
name|object
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|OMAPI_CREATE
operator|)
operator|&&
operator|(
name|status
operator|==
name|ISC_R_SUCCESS
operator|)
condition|)
name|status
operator|=
name|omapi_set_boolean_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"create"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|OMAPI_UPDATE
operator|)
operator|&&
operator|(
name|status
operator|==
name|ISC_R_SUCCESS
operator|)
condition|)
name|status
operator|=
name|omapi_set_boolean_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"update"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|OMAPI_EXCL
operator|)
operator|&&
operator|(
name|status
operator|==
name|ISC_R_SUCCESS
operator|)
condition|)
name|status
operator|=
name|omapi_set_boolean_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"exclusive"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|OMAPI_NOTIFY_PROTOCOL
operator|)
operator|&&
operator|(
name|status
operator|==
name|ISC_R_SUCCESS
operator|)
condition|)
name|status
operator|=
name|omapi_set_object_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"notify-object"
argument_list|,
name|po
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|&&
operator|(
name|status
operator|==
name|ISC_R_SUCCESS
operator|)
condition|)
name|status
operator|=
name|omapi_set_string_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"type"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
name|status
operator|=
name|omapi_message_register
argument_list|(
name|mo
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|status
operator|=
name|omapi_protocol_send_message
argument_list|(
name|po
argument_list|,
name|id
argument_list|,
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
name|omapi_message_unregister
argument_list|(
name|mo
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|message
condition|)
name|omapi_message_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_protocol_send_update
parameter_list|(
name|omapi_object_t
modifier|*
name|po
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|unsigned
name|rid
parameter_list|,
name|omapi_object_t
modifier|*
name|object
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_message_object_t
modifier|*
name|message
init|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
literal|0
decl_stmt|;
name|omapi_object_t
modifier|*
name|mo
decl_stmt|;
if|if
condition|(
name|po
operator|->
name|type
operator|!=
name|omapi_type_protocol
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|status
operator|=
name|omapi_message_new
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|mo
operator|=
operator|(
name|omapi_object_t
operator|*
operator|)
name|message
expr_stmt|;
name|status
operator|=
name|omapi_set_int_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"op"
argument_list|,
name|OMAPI_OP_UPDATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_message_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
if|if
condition|(
name|rid
condition|)
block|{
name|omapi_handle_t
name|handle
decl_stmt|;
name|status
operator|=
name|omapi_set_int_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"rid"
argument_list|,
operator|(
name|int
operator|)
name|rid
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_message_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_object_handle
argument_list|(
operator|&
name|handle
argument_list|,
name|object
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_message_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_set_int_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"handle"
argument_list|,
operator|(
name|int
operator|)
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_message_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
name|status
operator|=
name|omapi_set_object_value
argument_list|(
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"object"
argument_list|,
name|object
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_message_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_protocol_send_message
argument_list|(
name|po
argument_list|,
name|id
argument_list|,
name|mo
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|omapi_message_dereference
argument_list|(
operator|&
name|message
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* connection.c     Subroutines for dealing with connections. */
end_comment

begin_comment
comment|/*  * Copyright (c) 1999-2001 Internet Software Consortium.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of The Internet Software Consortium nor the names  *    of its contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INTERNET SOFTWARE CONSORTIUM AND  * CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE INTERNET SOFTWARE CONSORTIUM OR  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * This software has been written for the Internet Software Consortium  * by Ted Lemon in cooperation with Vixie Enterprises and Nominum, Inc.  * To learn more about the Internet Software Consortium, see  * ``http://www.isc.org/''.  To learn more about Vixie Enterprises,  * see ``http://www.vix.com''.   To learn more about Nominum, Inc., see  * ``http://www.nominum.com''.  */
end_comment

begin_include
include|#
directive|include
file|<omapip/omapip_p.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<arpa/nameser.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|TRACING
argument_list|)
end_if

begin_function_decl
specifier|static
name|void
name|trace_connect_input
parameter_list|(
name|trace_type_t
modifier|*
parameter_list|,
name|unsigned
parameter_list|,
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|trace_connect_stop
parameter_list|(
name|trace_type_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|trace_disconnect_input
parameter_list|(
name|trace_type_t
modifier|*
parameter_list|,
name|unsigned
parameter_list|,
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|trace_disconnect_stop
parameter_list|(
name|trace_type_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|trace_type_t
modifier|*
name|trace_connect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|trace_type_t
modifier|*
name|trace_disconnect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|omapi_array_t
modifier|*
name|trace_listeners
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|isc_result_t
name|omapi_connection_connect_internal
parameter_list|(
name|omapi_object_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_macro
name|OMAPI_OBJECT_ALLOC
argument_list|(
argument|omapi_connection
argument_list|,
argument|omapi_connection_object_t
argument_list|,
argument|omapi_type_connection
argument_list|)
end_macro

begin_function
name|isc_result_t
name|omapi_connect
parameter_list|(
name|omapi_object_t
modifier|*
name|c
parameter_list|,
specifier|const
name|char
modifier|*
name|server_name
parameter_list|,
name|unsigned
name|port
parameter_list|)
block|{
name|struct
name|hostent
modifier|*
name|he
decl_stmt|;
name|unsigned
name|i
decl_stmt|,
name|hix
decl_stmt|;
name|omapi_addr_list_t
modifier|*
name|addrs
init|=
operator|(
name|omapi_addr_list_t
operator|*
operator|)
literal|0
decl_stmt|;
name|struct
name|in_addr
name|foo
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_PROTOCOL
name|log_debug
argument_list|(
literal|"omapi_connect(%s, port=%d)"
argument_list|,
name|server_name
argument_list|,
name|port
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|inet_aton
argument_list|(
name|server_name
argument_list|,
operator|&
name|foo
argument_list|)
condition|)
block|{
comment|/* If we didn't get a numeric address, try for a domain 		   name.  It's okay for this call to block. */
name|he
operator|=
name|gethostbyname
argument_list|(
name|server_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|he
condition|)
return|return
name|ISC_R_HOSTUNKNOWN
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|he
operator|->
name|h_addr_list
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
return|return
name|ISC_R_HOSTUNKNOWN
return|;
name|hix
operator|=
name|i
expr_stmt|;
name|status
operator|=
name|omapi_addr_list_new
argument_list|(
operator|&
name|addrs
argument_list|,
name|hix
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hix
condition|;
name|i
operator|++
control|)
block|{
name|addrs
operator|->
name|addresses
index|[
name|i
index|]
operator|.
name|addrtype
operator|=
name|he
operator|->
name|h_addrtype
expr_stmt|;
name|addrs
operator|->
name|addresses
index|[
name|i
index|]
operator|.
name|addrlen
operator|=
name|he
operator|->
name|h_length
expr_stmt|;
name|memcpy
argument_list|(
name|addrs
operator|->
name|addresses
index|[
name|i
index|]
operator|.
name|address
argument_list|,
name|he
operator|->
name|h_addr_list
index|[
name|i
index|]
argument_list|,
operator|(
name|unsigned
operator|)
name|he
operator|->
name|h_length
argument_list|)
expr_stmt|;
name|addrs
operator|->
name|addresses
index|[
name|i
index|]
operator|.
name|port
operator|=
name|port
expr_stmt|;
block|}
block|}
else|else
block|{
name|status
operator|=
name|omapi_addr_list_new
argument_list|(
operator|&
name|addrs
argument_list|,
literal|1
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|addrs
operator|->
name|addresses
index|[
literal|0
index|]
operator|.
name|addrtype
operator|=
name|AF_INET
expr_stmt|;
name|addrs
operator|->
name|addresses
index|[
literal|0
index|]
operator|.
name|addrlen
operator|=
sizeof|sizeof
name|foo
expr_stmt|;
name|memcpy
argument_list|(
name|addrs
operator|->
name|addresses
index|[
literal|0
index|]
operator|.
name|address
argument_list|,
operator|&
name|foo
argument_list|,
sizeof|sizeof
name|foo
argument_list|)
expr_stmt|;
name|addrs
operator|->
name|addresses
index|[
literal|0
index|]
operator|.
name|port
operator|=
name|port
expr_stmt|;
name|hix
operator|=
literal|1
expr_stmt|;
block|}
name|status
operator|=
name|omapi_connect_list
argument_list|(
name|c
argument_list|,
name|addrs
argument_list|,
operator|(
name|omapi_addr_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|omapi_addr_list_dereference
argument_list|(
operator|&
name|addrs
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_connect_list
parameter_list|(
name|omapi_object_t
modifier|*
name|c
parameter_list|,
name|omapi_addr_list_t
modifier|*
name|remote_addrs
parameter_list|,
name|omapi_addr_t
modifier|*
name|local_addr
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|omapi_connection_object_t
modifier|*
name|obj
decl_stmt|;
name|int
name|flag
decl_stmt|;
name|struct
name|sockaddr_in
name|local_sin
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TRACING
argument_list|)
name|trace_addr_t
modifier|*
name|addrs
decl_stmt|;
name|u_int16_t
name|naddrs
decl_stmt|;
endif|#
directive|endif
name|obj
operator|=
operator|(
name|omapi_connection_object_t
operator|*
operator|)
literal|0
expr_stmt|;
name|status
operator|=
name|omapi_connection_allocate
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|status
operator|=
name|omapi_object_reference
argument_list|(
operator|&
name|c
operator|->
name|outer
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_connection_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_object_reference
argument_list|(
operator|&
name|obj
operator|->
name|inner
argument_list|,
name|c
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_connection_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Store the address list on the object. */
name|omapi_addr_list_reference
argument_list|(
operator|&
name|obj
operator|->
name|connect_list
argument_list|,
name|remote_addrs
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|obj
operator|->
name|cptr
operator|=
literal|0
expr_stmt|;
name|obj
operator|->
name|state
operator|=
name|omapi_connection_unconnected
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TRACING
argument_list|)
comment|/* If we're playing back, don't actually try to connect - just leave 	   the object available for a subsequent connect or disconnect. */
if|if
condition|(
operator|!
name|trace_playback
argument_list|()
condition|)
block|{
endif|#
directive|endif
comment|/* Create a socket on which to communicate. */
name|obj
operator|->
name|socket
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
name|IPPROTO_TCP
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|->
name|socket
operator|<
literal|0
condition|)
block|{
name|omapi_connection_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|==
name|EMFILE
operator|||
name|errno
operator|==
name|ENFILE
operator|||
name|errno
operator|==
name|ENOBUFS
condition|)
return|return
name|ISC_R_NORESOURCES
return|;
return|return
name|ISC_R_UNEXPECTED
return|;
block|}
comment|/* Set up the local address, if any. */
if|if
condition|(
name|local_addr
condition|)
block|{
comment|/* Only do TCPv4 so far. */
if|if
condition|(
name|local_addr
operator|->
name|addrtype
operator|!=
name|AF_INET
condition|)
block|{
name|omapi_connection_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_INVALIDARG
return|;
block|}
name|local_sin
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|local_addr
operator|->
name|port
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|local_sin
operator|.
name|sin_addr
argument_list|,
name|local_addr
operator|->
name|address
argument_list|,
name|local_addr
operator|->
name|addrlen
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SA_LEN
argument_list|)
name|local_sin
operator|.
name|sin_len
operator|=
sizeof|sizeof
name|local_addr
expr_stmt|;
endif|#
directive|endif
name|local_sin
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|memset
argument_list|(
operator|&
name|local_sin
operator|.
name|sin_zero
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|local_sin
operator|.
name|sin_zero
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|obj
operator|->
name|socket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|local_sin
argument_list|,
sizeof|sizeof
name|local_sin
argument_list|)
operator|<
literal|0
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|==
name|EADDRINUSE
condition|)
return|return
name|ISC_R_ADDRINUSE
return|;
if|if
condition|(
name|errno
operator|==
name|EADDRNOTAVAIL
condition|)
return|return
name|ISC_R_ADDRNOTAVAIL
return|;
if|if
condition|(
name|errno
operator|==
name|EACCES
condition|)
return|return
name|ISC_R_NOPERM
return|;
return|return
name|ISC_R_UNEXPECTED
return|;
block|}
name|obj
operator|->
name|local_addr
operator|=
name|local_sin
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SETFD
argument_list|)
if|if
condition|(
name|fcntl
argument_list|(
name|obj
operator|->
name|socket
argument_list|,
name|F_SETFD
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|close
argument_list|(
name|obj
operator|->
name|socket
argument_list|)
expr_stmt|;
name|omapi_connection_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_UNEXPECTED
return|;
block|}
endif|#
directive|endif
comment|/* Set the SO_REUSEADDR flag (this should not fail). */
name|flag
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|obj
operator|->
name|socket
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_REUSEADDR
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|flag
argument_list|,
sizeof|sizeof
name|flag
argument_list|)
operator|<
literal|0
condition|)
block|{
name|omapi_connection_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_UNEXPECTED
return|;
block|}
comment|/* Set the file to nonblocking mode. */
if|if
condition|(
name|fcntl
argument_list|(
name|obj
operator|->
name|socket
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
operator|<
literal|0
condition|)
block|{
name|omapi_connection_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_UNEXPECTED
return|;
block|}
name|status
operator|=
operator|(
name|omapi_register_io_object
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|obj
argument_list|,
literal|0
argument_list|,
name|omapi_connection_writefd
argument_list|,
literal|0
argument_list|,
name|omapi_connection_connect
argument_list|,
name|omapi_connection_reaper
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|out
goto|;
name|status
operator|=
name|omapi_connection_connect_internal
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|obj
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TRACING
argument_list|)
block|}
name|omapi_connection_register
argument_list|(
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|out
label|:
name|omapi_connection_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|TRACING
argument_list|)
end_if

begin_decl_stmt
name|omapi_array_t
modifier|*
name|omapi_connections
decl_stmt|;
end_decl_stmt

begin_macro
name|OMAPI_ARRAY_TYPE
argument_list|(
argument|omapi_connection
argument_list|,
argument|omapi_connection_object_t
argument_list|)
end_macro

begin_function
name|void
name|omapi_connection_trace_setup
parameter_list|(
name|void
parameter_list|)
block|{
name|trace_connect
operator|=
name|trace_type_register
argument_list|(
literal|"connect"
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|0
argument_list|,
name|trace_connect_input
argument_list|,
name|trace_connect_stop
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|trace_disconnect
operator|=
name|trace_type_register
argument_list|(
literal|"disconnect"
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|0
argument_list|,
name|trace_disconnect_input
argument_list|,
name|trace_disconnect_stop
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|omapi_connection_register
parameter_list|(
name|omapi_connection_object_t
modifier|*
name|obj
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|trace_iov_t
name|iov
index|[
literal|6
index|]
decl_stmt|;
name|int
name|iov_count
init|=
literal|0
decl_stmt|;
name|int32_t
name|connect_index
decl_stmt|,
name|listener_index
decl_stmt|;
specifier|static
name|int32_t
name|index
decl_stmt|;
if|if
condition|(
operator|!
name|omapi_connections
condition|)
block|{
name|status
operator|=
name|omapi_connection_array_allocate
argument_list|(
operator|&
name|omapi_connections
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return;
block|}
name|status
operator|=
name|omapi_connection_array_extend
argument_list|(
name|omapi_connections
argument_list|,
name|obj
argument_list|,
operator|(
name|int
operator|*
operator|)
literal|0
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|obj
operator|->
name|index
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
if|#
directive|if
name|defined
argument_list|(
name|TRACING
argument_list|)
if|if
condition|(
name|trace_record
argument_list|()
condition|)
block|{
comment|/* Connection registration packet: 		    		     int32_t index 		     int32_t listener_index [-1 means no listener] 		   u_int16_t remote_port 		   u_int16_t local_port 		   u_int32_t remote_addr 		   u_int32_t local_addr */
name|connect_index
operator|=
name|htonl
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|++
expr_stmt|;
if|if
condition|(
name|obj
operator|->
name|listener
condition|)
name|listener_index
operator|=
name|htonl
argument_list|(
name|obj
operator|->
name|listener
operator|->
name|index
argument_list|)
expr_stmt|;
else|else
name|listener_index
operator|=
name|htonl
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
name|iov
index|[
name|iov_count
index|]
operator|.
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|connect_index
expr_stmt|;
name|iov
index|[
name|iov_count
operator|++
index|]
operator|.
name|len
operator|=
sizeof|sizeof
name|connect_index
expr_stmt|;
name|iov
index|[
name|iov_count
index|]
operator|.
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|listener_index
expr_stmt|;
name|iov
index|[
name|iov_count
operator|++
index|]
operator|.
name|len
operator|=
sizeof|sizeof
name|listener_index
expr_stmt|;
name|iov
index|[
name|iov_count
index|]
operator|.
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|obj
operator|->
name|remote_addr
operator|.
name|sin_port
expr_stmt|;
name|iov
index|[
name|iov_count
operator|++
index|]
operator|.
name|len
operator|=
sizeof|sizeof
name|obj
operator|->
name|remote_addr
operator|.
name|sin_port
expr_stmt|;
name|iov
index|[
name|iov_count
index|]
operator|.
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|obj
operator|->
name|local_addr
operator|.
name|sin_port
expr_stmt|;
name|iov
index|[
name|iov_count
operator|++
index|]
operator|.
name|len
operator|=
sizeof|sizeof
name|obj
operator|->
name|local_addr
operator|.
name|sin_port
expr_stmt|;
name|iov
index|[
name|iov_count
index|]
operator|.
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|obj
operator|->
name|remote_addr
operator|.
name|sin_addr
expr_stmt|;
name|iov
index|[
name|iov_count
operator|++
index|]
operator|.
name|len
operator|=
sizeof|sizeof
name|obj
operator|->
name|remote_addr
operator|.
name|sin_addr
expr_stmt|;
name|iov
index|[
name|iov_count
index|]
operator|.
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|obj
operator|->
name|local_addr
operator|.
name|sin_addr
expr_stmt|;
name|iov
index|[
name|iov_count
operator|++
index|]
operator|.
name|len
operator|=
sizeof|sizeof
name|obj
operator|->
name|local_addr
operator|.
name|sin_addr
expr_stmt|;
name|status
operator|=
name|trace_write_packet_iov
argument_list|(
name|trace_connect
argument_list|,
name|iov_count
argument_list|,
name|iov
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|trace_connect_input
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|,
name|unsigned
name|length
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|sockaddr_in
name|remote
decl_stmt|,
name|local
decl_stmt|;
name|int32_t
name|connect_index
decl_stmt|,
name|listener_index
decl_stmt|;
name|char
modifier|*
name|s
init|=
name|buf
decl_stmt|;
name|omapi_connection_object_t
modifier|*
name|obj
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|length
operator|!=
operator|(
operator|(
sizeof|sizeof
name|connect_index
operator|)
operator|+
operator|(
sizeof|sizeof
name|remote
operator|.
name|sin_port
operator|)
operator|+
operator|(
sizeof|sizeof
name|remote
operator|.
name|sin_addr
operator|)
operator|)
operator|*
literal|2
condition|)
block|{
name|log_error
argument_list|(
literal|"Trace connect: invalid length %d"
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return;
block|}
name|memset
argument_list|(
operator|&
name|remote
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|remote
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|local
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|local
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|connect_index
argument_list|,
name|s
argument_list|,
sizeof|sizeof
name|connect_index
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
name|connect_index
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|listener_index
argument_list|,
name|s
argument_list|,
sizeof|sizeof
name|listener_index
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
name|listener_index
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|remote
operator|.
name|sin_port
argument_list|,
name|s
argument_list|,
sizeof|sizeof
name|remote
operator|.
name|sin_port
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
name|remote
operator|.
name|sin_port
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|local
operator|.
name|sin_port
argument_list|,
name|s
argument_list|,
sizeof|sizeof
name|local
operator|.
name|sin_port
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
name|local
operator|.
name|sin_port
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|remote
operator|.
name|sin_addr
argument_list|,
name|s
argument_list|,
sizeof|sizeof
name|remote
operator|.
name|sin_addr
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
name|remote
operator|.
name|sin_addr
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|local
operator|.
name|sin_addr
argument_list|,
name|s
argument_list|,
sizeof|sizeof
name|local
operator|.
name|sin_addr
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
name|local
operator|.
name|sin_addr
expr_stmt|;
name|connect_index
operator|=
name|ntohl
argument_list|(
name|connect_index
argument_list|)
expr_stmt|;
name|listener_index
operator|=
name|ntohl
argument_list|(
name|listener_index
argument_list|)
expr_stmt|;
comment|/* If this was a connect to a listener, then we just slap together 	   a new connection. */
if|if
condition|(
name|listener_index
operator|!=
operator|-
literal|1
condition|)
block|{
name|omapi_listener_object_t
modifier|*
name|listener
decl_stmt|;
name|listener
operator|=
operator|(
name|omapi_listener_object_t
operator|*
operator|)
literal|0
expr_stmt|;
name|omapi_array_foreach_begin
argument_list|(
argument|trace_listeners
argument_list|,
argument|omapi_listener_object_t
argument_list|,
argument|lp
argument_list|)
block|{
if|if
condition|(
name|lp
operator|->
name|address
operator|.
name|sin_port
operator|==
name|local
operator|.
name|sin_port
condition|)
block|{
name|omapi_listener_reference
argument_list|(
operator|&
name|listener
argument_list|,
name|lp
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_listener_dereference
argument_list|(
operator|&
name|lp
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|omapi_array_foreach_end
argument_list|(
name|trace_listeners
argument_list|,
name|omapi_listener_object_t
argument_list|,
name|lp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|listener
condition|)
block|{
name|log_error
argument_list|(
literal|"%s%ld, addr %s, port %d"
argument_list|,
literal|"Spurious traced listener connect - index "
argument_list|,
operator|(
name|long
name|int
operator|)
name|listener_index
argument_list|,
name|inet_ntoa
argument_list|(
name|local
operator|.
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|local
operator|.
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|obj
operator|=
operator|(
name|omapi_connection_object_t
operator|*
operator|)
literal|0
expr_stmt|;
name|status
operator|=
name|omapi_listener_connect
argument_list|(
operator|&
name|obj
argument_list|,
name|listener
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|remote
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|log_error
argument_list|(
literal|"traced listener connect: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|obj
condition|)
name|omapi_connection_dereference
argument_list|(
operator|&
name|obj
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_listener_dereference
argument_list|(
operator|&
name|listener
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Find the matching connect object, if there is one. */
name|omapi_array_foreach_begin
argument_list|(
argument|omapi_connections
argument_list|,
argument|omapi_connection_object_t
argument_list|,
argument|lp
argument_list|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|lp
operator|->
name|connect_list
operator|&&
name|i
operator|<
name|lp
operator|->
name|connect_list
operator|->
name|count
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|memcmp
argument_list|(
operator|&
name|remote
operator|.
name|sin_addr
argument_list|,
operator|&
name|lp
operator|->
name|connect_list
operator|->
name|addresses
index|[
name|i
index|]
operator|.
name|address
argument_list|,
sizeof|sizeof
name|remote
operator|.
name|sin_addr
argument_list|)
operator|&&
operator|(
name|ntohs
argument_list|(
name|remote
operator|.
name|sin_port
argument_list|)
operator|==
name|lp
operator|->
name|connect_list
operator|->
name|addresses
index|[
name|i
index|]
operator|.
name|port
operator|)
condition|)
name|lp
operator|->
name|state
operator|=
name|omapi_connection_connected
expr_stmt|;
name|lp
operator|->
name|remote_addr
operator|=
name|remote
expr_stmt|;
name|lp
operator|->
name|remote_addr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SIN_LEN
argument_list|)
name|lp
operator|->
name|remote_addr
operator|.
name|sin_len
operator|=
sizeof|sizeof
name|remote
expr_stmt|;
endif|#
directive|endif
name|omapi_addr_list_dereference
argument_list|(
operator|&
name|lp
operator|->
name|connect_list
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|lp
operator|->
name|index
operator|=
name|connect_index
expr_stmt|;
name|status
operator|=
name|omapi_signal_in
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|lp
argument_list|,
literal|"connect"
argument_list|)
expr_stmt|;
name|omapi_connection_dereference
argument_list|(
operator|&
name|lp
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|omapi_array_foreach_end
argument_list|(
name|omapi_connections
argument_list|,
name|omapi_connection_object_t
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|log_error
argument_list|(
literal|"Spurious traced connect - index %ld, addr %s, port %d"
argument_list|,
operator|(
name|long
name|int
operator|)
name|connect_index
argument_list|,
name|inet_ntoa
argument_list|(
name|remote
operator|.
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|remote
operator|.
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|trace_connect_stop
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|trace_disconnect_input
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|,
name|unsigned
name|length
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|int32_t
modifier|*
name|index
decl_stmt|;
if|if
condition|(
name|length
operator|!=
sizeof|sizeof
expr|*
name|index
condition|)
block|{
name|log_error
argument_list|(
literal|"trace disconnect: wrong length %d"
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return;
block|}
name|index
operator|=
operator|(
name|int32_t
operator|*
operator|)
name|buf
expr_stmt|;
name|omapi_array_foreach_begin
argument_list|(
argument|omapi_connections
argument_list|,
argument|omapi_connection_object_t
argument_list|,
argument|lp
argument_list|)
block|{
if|if
condition|(
name|lp
operator|->
name|index
operator|==
name|ntohl
argument_list|(
operator|*
name|index
argument_list|)
condition|)
block|{
name|omapi_disconnect
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|lp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|omapi_connection_dereference
argument_list|(
operator|&
name|lp
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|omapi_array_foreach_end
argument_list|(
name|omapi_connections
argument_list|,
name|omapi_connection_object_t
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|log_error
argument_list|(
literal|"trace disconnect: no connection matching index %ld"
argument_list|,
operator|(
name|long
name|int
operator|)
name|ntohl
argument_list|(
operator|*
name|index
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|trace_disconnect_stop
parameter_list|(
name|trace_type_t
modifier|*
name|ttype
parameter_list|)
block|{ }
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Disconnect a connection object from the remote end.   If force is nonzero,    close the connection immediately.   Otherwise, shut down the receiving end    but allow any unsent data to be sent before actually closing the socket. */
end_comment

begin_function
name|isc_result_t
name|omapi_disconnect
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|int
name|force
parameter_list|)
block|{
name|omapi_connection_object_t
modifier|*
name|c
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_PROTOCOL
name|log_debug
argument_list|(
literal|"omapi_disconnect(%s)"
argument_list|,
name|force
condition|?
literal|"force"
else|:
literal|""
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|c
operator|=
operator|(
name|omapi_connection_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|#
directive|if
name|defined
argument_list|(
name|TRACING
argument_list|)
if|if
condition|(
name|trace_record
argument_list|()
condition|)
block|{
name|int32_t
name|index
decl_stmt|;
name|index
operator|=
name|htonl
argument_list|(
name|c
operator|->
name|index
argument_list|)
expr_stmt|;
name|status
operator|=
name|trace_write_packet
argument_list|(
name|trace_disconnect
argument_list|,
sizeof|sizeof
name|index
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|index
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|trace_stop
argument_list|()
expr_stmt|;
name|log_error
argument_list|(
literal|"trace_write_packet: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|trace_playback
argument_list|()
condition|)
block|{
endif|#
directive|endif
if|if
condition|(
operator|!
name|force
condition|)
block|{
comment|/* If we're already disconnecting, we don't have to do 			   anything. */
if|if
condition|(
name|c
operator|->
name|state
operator|==
name|omapi_connection_disconnecting
condition|)
return|return
name|ISC_R_SUCCESS
return|;
comment|/* Try to shut down the socket - this sends a FIN to 			   the remote end, so that it won't send us any more 			   data.   If the shutdown succeeds, and we still 			   have bytes left to write, defer closing the socket 			   until that's done. */
if|if
condition|(
operator|!
name|shutdown
argument_list|(
name|c
operator|->
name|socket
argument_list|,
name|SHUT_RD
argument_list|)
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|out_bytes
operator|>
literal|0
condition|)
block|{
name|c
operator|->
name|state
operator|=
name|omapi_connection_disconnecting
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
block|}
block|}
name|close
argument_list|(
name|c
operator|->
name|socket
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TRACING
argument_list|)
block|}
endif|#
directive|endif
name|c
operator|->
name|state
operator|=
name|omapi_connection_closed
expr_stmt|;
comment|/* Disconnect from I/O object, if any. */
if|if
condition|(
name|h
operator|->
name|outer
condition|)
block|{
if|if
condition|(
name|h
operator|->
name|outer
operator|->
name|inner
condition|)
name|omapi_object_dereference
argument_list|(
operator|&
name|h
operator|->
name|outer
operator|->
name|inner
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_object_dereference
argument_list|(
operator|&
name|h
operator|->
name|outer
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
comment|/* If whatever created us registered a signal handler, send it 	   a disconnect signal. */
name|omapi_signal
argument_list|(
name|h
argument_list|,
literal|"disconnect"
argument_list|,
name|h
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_connection_require
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|unsigned
name|bytes
parameter_list|)
block|{
name|omapi_connection_object_t
modifier|*
name|c
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|c
operator|=
operator|(
name|omapi_connection_object_t
operator|*
operator|)
name|h
expr_stmt|;
name|c
operator|->
name|bytes_needed
operator|=
name|bytes
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|bytes_needed
operator|<=
name|c
operator|->
name|in_bytes
condition|)
block|{
return|return
name|ISC_R_SUCCESS
return|;
block|}
return|return
name|ISC_R_NOTYET
return|;
block|}
end_function

begin_comment
comment|/* Return the socket on which the dispatcher should wait for readiness    to read, for a connection object.   If we already have more bytes than    we need to do the next thing, and we have at least a single full input    buffer, then don't indicate that we're ready to read. */
end_comment

begin_function
name|int
name|omapi_connection_readfd
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|)
block|{
name|omapi_connection_object_t
modifier|*
name|c
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
operator|-
literal|1
return|;
name|c
operator|=
operator|(
name|omapi_connection_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|state
operator|!=
name|omapi_connection_connected
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|c
operator|->
name|in_bytes
operator|>=
name|OMAPI_BUF_SIZE
operator|-
literal|1
operator|&&
name|c
operator|->
name|in_bytes
operator|>
name|c
operator|->
name|bytes_needed
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|c
operator|->
name|socket
return|;
block|}
end_function

begin_comment
comment|/* Return the socket on which the dispatcher should wait for readiness    to write, for a connection object.   If there are no bytes buffered    for writing, then don't indicate that we're ready to write. */
end_comment

begin_function
name|int
name|omapi_connection_writefd
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|)
block|{
name|omapi_connection_object_t
modifier|*
name|c
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
operator|-
literal|1
return|;
name|c
operator|=
operator|(
name|omapi_connection_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|state
operator|==
name|omapi_connection_connecting
condition|)
return|return
name|c
operator|->
name|socket
return|;
if|if
condition|(
name|c
operator|->
name|out_bytes
condition|)
return|return
name|c
operator|->
name|socket
return|;
else|else
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_connection_connect
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
name|status
operator|=
name|omapi_connection_connect_internal
argument_list|(
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
name|omapi_signal
argument_list|(
name|h
argument_list|,
literal|"status"
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|omapi_connection_connect_internal
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|omapi_connection_object_t
modifier|*
name|c
decl_stmt|;
name|SOCKLEN_T
name|sl
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|c
operator|=
operator|(
name|omapi_connection_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|state
operator|==
name|omapi_connection_connecting
condition|)
block|{
name|sl
operator|=
sizeof|sizeof
name|error
expr_stmt|;
if|if
condition|(
name|getsockopt
argument_list|(
name|c
operator|->
name|socket
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_ERROR
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|error
argument_list|,
operator|&
name|sl
argument_list|)
operator|<
literal|0
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|h
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
if|if
condition|(
operator|!
name|error
condition|)
name|c
operator|->
name|state
operator|=
name|omapi_connection_connected
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|state
operator|==
name|omapi_connection_connecting
operator|||
name|c
operator|->
name|state
operator|==
name|omapi_connection_unconnected
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|cptr
operator|>=
name|c
operator|->
name|connect_list
operator|->
name|count
condition|)
block|{
switch|switch
condition|(
name|error
condition|)
block|{
case|case
name|ECONNREFUSED
case|:
name|status
operator|=
name|ISC_R_CONNREFUSED
expr_stmt|;
break|break;
case|case
name|ENETUNREACH
case|:
name|status
operator|=
name|ISC_R_NETUNREACH
expr_stmt|;
break|break;
default|default:
name|status
operator|=
name|uerr2isc
argument_list|(
name|error
argument_list|)
expr_stmt|;
break|break;
block|}
name|omapi_disconnect
argument_list|(
name|h
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
if|if
condition|(
name|c
operator|->
name|connect_list
operator|->
name|addresses
index|[
name|c
operator|->
name|cptr
index|]
operator|.
name|addrtype
operator|!=
name|AF_INET
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|h
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ISC_R_INVALIDARG
return|;
block|}
name|memcpy
argument_list|(
operator|&
name|c
operator|->
name|remote_addr
operator|.
name|sin_addr
argument_list|,
operator|&
name|c
operator|->
name|connect_list
operator|->
name|addresses
index|[
name|c
operator|->
name|cptr
index|]
operator|.
name|address
argument_list|,
sizeof|sizeof
name|c
operator|->
name|remote_addr
operator|.
name|sin_addr
argument_list|)
expr_stmt|;
name|c
operator|->
name|remote_addr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|c
operator|->
name|remote_addr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|c
operator|->
name|connect_list
operator|->
name|addresses
index|[
name|c
operator|->
name|cptr
index|]
operator|.
name|port
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SA_LEN
argument_list|)
name|c
operator|->
name|remote_addr
operator|.
name|sin_len
operator|=
sizeof|sizeof
name|c
operator|->
name|remote_addr
expr_stmt|;
endif|#
directive|endif
name|memset
argument_list|(
operator|&
name|c
operator|->
name|remote_addr
operator|.
name|sin_zero
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|c
operator|->
name|remote_addr
operator|.
name|sin_zero
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|cptr
expr_stmt|;
name|error
operator|=
name|connect
argument_list|(
name|c
operator|->
name|socket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|c
operator|->
name|remote_addr
argument_list|,
sizeof|sizeof
name|c
operator|->
name|remote_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|<
literal|0
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|EINPROGRESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|h
argument_list|,
literal|1
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|error
condition|)
block|{
case|case
name|ECONNREFUSED
case|:
name|status
operator|=
name|ISC_R_CONNREFUSED
expr_stmt|;
break|break;
case|case
name|ENETUNREACH
case|:
name|status
operator|=
name|ISC_R_NETUNREACH
expr_stmt|;
break|break;
default|default:
name|status
operator|=
name|uerr2isc
argument_list|(
name|error
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
name|c
operator|->
name|state
operator|=
name|omapi_connection_connecting
expr_stmt|;
return|return
name|ISC_R_INCOMPLETE
return|;
block|}
name|c
operator|->
name|state
operator|=
name|omapi_connection_connected
expr_stmt|;
block|}
comment|/* I don't know why this would fail, so I'm tempted not to test 	   the return value. */
name|sl
operator|=
sizeof|sizeof
argument_list|(
name|c
operator|->
name|local_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockname
argument_list|(
name|c
operator|->
name|socket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|c
operator|->
name|local_addr
argument_list|,
operator|&
name|sl
argument_list|)
operator|<
literal|0
condition|)
block|{ 	}
comment|/* Disconnect from I/O object, if any. */
if|if
condition|(
name|h
operator|->
name|outer
condition|)
name|omapi_unregister_io_object
argument_list|(
name|h
argument_list|)
expr_stmt|;
name|status
operator|=
name|omapi_register_io_object
argument_list|(
name|h
argument_list|,
name|omapi_connection_readfd
argument_list|,
name|omapi_connection_writefd
argument_list|,
name|omapi_connection_reader
argument_list|,
name|omapi_connection_writer
argument_list|,
name|omapi_connection_reaper
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_disconnect
argument_list|(
name|h
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|omapi_signal_in
argument_list|(
name|h
argument_list|,
literal|"connect"
argument_list|)
expr_stmt|;
name|omapi_addr_list_dereference
argument_list|(
operator|&
name|c
operator|->
name|connect_list
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* Reaper function for connection - if the connection is completely closed,    reap it.   If it's in the disconnecting state, there were bytes left    to write when the user closed it, so if there are now no bytes left to    write, we can close it. */
end_comment

begin_function
name|isc_result_t
name|omapi_connection_reaper
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|)
block|{
name|omapi_connection_object_t
modifier|*
name|c
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|c
operator|=
operator|(
name|omapi_connection_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|state
operator|==
name|omapi_connection_disconnecting
operator|&&
name|c
operator|->
name|out_bytes
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_PROTOCOL
name|log_debug
argument_list|(
literal|"omapi_connection_reaper(): disconnect"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|omapi_disconnect
argument_list|(
name|h
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|state
operator|==
name|omapi_connection_closed
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_PROTOCOL
name|log_debug
argument_list|(
literal|"omapi_connection_reaper(): closed"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|ISC_R_NOTCONNECTED
return|;
block|}
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|make_dst_key
parameter_list|(
name|DST_KEY
modifier|*
modifier|*
name|dst_key
parameter_list|,
name|omapi_object_t
modifier|*
name|a
parameter_list|)
block|{
name|omapi_value_t
modifier|*
name|name
init|=
operator|(
name|omapi_value_t
operator|*
operator|)
literal|0
decl_stmt|;
name|omapi_value_t
modifier|*
name|algorithm
init|=
operator|(
name|omapi_value_t
operator|*
operator|)
literal|0
decl_stmt|;
name|omapi_value_t
modifier|*
name|key
init|=
operator|(
name|omapi_value_t
operator|*
operator|)
literal|0
decl_stmt|;
name|int
name|algorithm_id
decl_stmt|;
name|char
modifier|*
name|name_str
decl_stmt|;
name|isc_result_t
name|status
init|=
name|ISC_R_SUCCESS
decl_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|a
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"name"
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|a
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"algorithm"
argument_list|,
operator|&
name|algorithm
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|a
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
argument_list|,
literal|"key"
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|algorithm
operator|->
name|value
operator|->
name|type
operator|==
name|omapi_datatype_data
operator|||
name|algorithm
operator|->
name|value
operator|->
name|type
operator|==
name|omapi_datatype_string
operator|)
operator|&&
name|strncasecmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|algorithm
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|NS_TSIG_ALG_HMAC_MD5
literal|"."
argument_list|,
name|algorithm
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|algorithm_id
operator|=
name|KEY_HMAC_MD5
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|ISC_R_INVALIDARG
expr_stmt|;
block|}
block|}
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|name_str
operator|=
name|dmalloc
argument_list|(
name|name
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
operator|+
literal|1
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|name_str
condition|)
name|status
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|memcpy
argument_list|(
name|name_str
argument_list|,
name|name
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|name
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
argument_list|)
expr_stmt|;
name|name_str
index|[
name|name
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
index|]
operator|=
literal|0
expr_stmt|;
operator|*
name|dst_key
operator|=
name|dst_buffer_to_key
argument_list|(
name|name_str
argument_list|,
name|algorithm_id
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|key
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
argument_list|,
name|key
operator|->
name|value
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|dst_key
condition|)
name|status
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
block|}
if|if
condition|(
name|name_str
condition|)
name|dfree
argument_list|(
name|name_str
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
name|omapi_value_dereference
argument_list|(
operator|&
name|key
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|algorithm
condition|)
name|omapi_value_dereference
argument_list|(
operator|&
name|algorithm
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
condition|)
name|omapi_value_dereference
argument_list|(
operator|&
name|name
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_connection_sign_data
parameter_list|(
name|int
name|mode
parameter_list|,
name|DST_KEY
modifier|*
name|key
parameter_list|,
name|void
modifier|*
modifier|*
name|context
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|data
parameter_list|,
specifier|const
name|unsigned
name|len
parameter_list|,
name|omapi_typed_data_t
modifier|*
modifier|*
name|result
parameter_list|)
block|{
name|omapi_typed_data_t
modifier|*
name|td
init|=
operator|(
name|omapi_typed_data_t
operator|*
operator|)
literal|0
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|mode
operator|&
name|SIG_MODE_FINAL
condition|)
block|{
name|status
operator|=
name|omapi_typed_data_new
argument_list|(
name|MDL
argument_list|,
operator|&
name|td
argument_list|,
name|omapi_datatype_data
argument_list|,
name|dst_sig_size
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
name|r
operator|=
name|dst_sign_data
argument_list|(
name|mode
argument_list|,
name|key
argument_list|,
name|context
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|td
condition|?
name|td
operator|->
name|u
operator|.
name|buffer
operator|.
name|value
else|:
operator|(
name|u_char
operator|*
operator|)
literal|0
argument_list|,
name|td
condition|?
name|td
operator|->
name|u
operator|.
name|buffer
operator|.
name|len
else|:
literal|0
argument_list|)
expr_stmt|;
comment|/* dst_sign_data() really should do this for us, shouldn't it? */
if|if
condition|(
name|mode
operator|&
name|SIG_MODE_FINAL
condition|)
operator|*
name|context
operator|=
operator|(
name|void
operator|*
operator|)
literal|0
expr_stmt|;
if|if
condition|(
name|r
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|td
condition|)
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|td
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_INVALIDKEY
return|;
block|}
if|if
condition|(
name|result
operator|&&
name|td
condition|)
block|{
name|omapi_typed_data_reference
argument_list|(
name|result
argument_list|,
name|td
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|td
condition|)
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|td
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_connection_output_auth_length
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|unsigned
modifier|*
name|l
parameter_list|)
block|{
name|omapi_connection_object_t
modifier|*
name|c
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|c
operator|=
operator|(
name|omapi_connection_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
operator|!
name|c
operator|->
name|out_key
condition|)
return|return
name|ISC_R_NOTFOUND
return|;
operator|*
name|l
operator|=
name|dst_sig_size
argument_list|(
name|c
operator|->
name|out_key
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_connection_set_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_typed_data_t
modifier|*
name|value
parameter_list|)
block|{
name|omapi_connection_object_t
modifier|*
name|c
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|c
operator|=
operator|(
name|omapi_connection_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"input-authenticator"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|value
operator|&&
name|value
operator|->
name|type
operator|!=
name|omapi_datatype_object
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|c
operator|->
name|in_context
condition|)
block|{
name|omapi_connection_sign_data
argument_list|(
name|SIG_MODE_FINAL
argument_list|,
name|c
operator|->
name|in_key
argument_list|,
operator|&
name|c
operator|->
name|in_context
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|omapi_typed_data_t
operator|*
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|in_key
condition|)
block|{
name|dst_free_key
argument_list|(
name|c
operator|->
name|in_key
argument_list|)
expr_stmt|;
name|c
operator|->
name|in_key
operator|=
operator|(
name|DST_KEY
operator|*
operator|)
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|value
condition|)
block|{
name|status
operator|=
name|make_dst_key
argument_list|(
operator|&
name|c
operator|->
name|in_key
argument_list|,
name|value
operator|->
name|u
operator|.
name|object
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_SUCCESS
return|;
block|}
elseif|else
if|if
condition|(
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"output-authenticator"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|value
operator|&&
name|value
operator|->
name|type
operator|!=
name|omapi_datatype_object
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|c
operator|->
name|out_context
condition|)
block|{
name|omapi_connection_sign_data
argument_list|(
name|SIG_MODE_FINAL
argument_list|,
name|c
operator|->
name|out_key
argument_list|,
operator|&
name|c
operator|->
name|out_context
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|omapi_typed_data_t
operator|*
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|out_key
condition|)
block|{
name|dst_free_key
argument_list|(
name|c
operator|->
name|out_key
argument_list|)
expr_stmt|;
name|c
operator|->
name|out_key
operator|=
operator|(
name|DST_KEY
operator|*
operator|)
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|value
condition|)
block|{
name|status
operator|=
name|make_dst_key
argument_list|(
operator|&
name|c
operator|->
name|out_key
argument_list|,
name|value
operator|->
name|u
operator|.
name|object
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_SUCCESS
return|;
block|}
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
condition|)
return|return
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_connection_get_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_value_t
modifier|*
modifier|*
name|value
parameter_list|)
block|{
name|omapi_connection_object_t
modifier|*
name|c
decl_stmt|;
name|omapi_typed_data_t
modifier|*
name|td
init|=
operator|(
name|omapi_typed_data_t
operator|*
operator|)
literal|0
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|c
operator|=
operator|(
name|omapi_connection_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"input-signature"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|c
operator|->
name|in_key
operator|||
operator|!
name|c
operator|->
name|in_context
condition|)
return|return
name|ISC_R_NOTFOUND
return|;
name|status
operator|=
name|omapi_connection_sign_data
argument_list|(
name|SIG_MODE_FINAL
argument_list|,
name|c
operator|->
name|in_key
argument_list|,
operator|&
name|c
operator|->
name|in_context
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|status
operator|=
name|omapi_make_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
name|td
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|td
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
elseif|else
if|if
condition|(
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"input-signature-size"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|c
operator|->
name|in_key
condition|)
return|return
name|ISC_R_NOTFOUND
return|;
return|return
name|omapi_make_int_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
name|dst_sig_size
argument_list|(
name|c
operator|->
name|in_key
argument_list|)
argument_list|,
name|MDL
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"output-signature"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|c
operator|->
name|out_key
operator|||
operator|!
name|c
operator|->
name|out_context
condition|)
return|return
name|ISC_R_NOTFOUND
return|;
name|status
operator|=
name|omapi_connection_sign_data
argument_list|(
name|SIG_MODE_FINAL
argument_list|,
name|c
operator|->
name|out_key
argument_list|,
operator|&
name|c
operator|->
name|out_context
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|status
operator|=
name|omapi_make_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
name|td
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|td
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
elseif|else
if|if
condition|(
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"output-signature-size"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|c
operator|->
name|out_key
condition|)
return|return
name|ISC_R_NOTFOUND
return|;
return|return
name|omapi_make_int_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
name|dst_sig_size
argument_list|(
name|c
operator|->
name|out_key
argument_list|)
argument_list|,
name|MDL
argument_list|)
return|;
block|}
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
return|return
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_connection_destroy
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|omapi_connection_object_t
modifier|*
name|c
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_PROTOCOL
name|log_debug
argument_list|(
literal|"omapi_connection_destroy()"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
name|ISC_R_UNEXPECTED
return|;
name|c
operator|=
operator|(
name|omapi_connection_object_t
operator|*
operator|)
operator|(
name|h
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|state
operator|==
name|omapi_connection_connected
condition|)
name|omapi_disconnect
argument_list|(
name|h
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|listener
condition|)
name|omapi_listener_dereference
argument_list|(
operator|&
name|c
operator|->
name|listener
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|connect_list
condition|)
name|omapi_addr_list_dereference
argument_list|(
operator|&
name|c
operator|->
name|connect_list
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_connection_signal_handler
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
ifdef|#
directive|ifdef
name|DEBUG_PROTOCOL
name|log_debug
argument_list|(
literal|"omapi_connection_signal_handler(%s)"
argument_list|,
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
condition|)
return|return
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|name
operator|,
name|ap
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_comment
comment|/* Write all the published values associated with the object through the    specified connection. */
end_comment

begin_function
name|isc_result_t
name|omapi_connection_stuff_values
parameter_list|(
name|omapi_object_t
modifier|*
name|c
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|m
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|m
operator|->
name|type
operator|!=
name|omapi_type_connection
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|m
operator|->
name|inner
operator|&&
name|m
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
condition|)
return|return
operator|(
operator|*
operator|(
name|m
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
operator|)
operator|)
operator|(
name|c
operator|,
name|id
operator|,
name|m
operator|->
name|inner
operator|)
return|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* message.c     Subroutines for dealing with message objects. */
end_comment

begin_comment
comment|/*  * Copyright (c) 1999-2000 Internet Software Consortium.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of The Internet Software Consortium nor the names  *    of its contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INTERNET SOFTWARE CONSORTIUM AND  * CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE INTERNET SOFTWARE CONSORTIUM OR  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * This software has been written for the Internet Software Consortium  * by Ted Lemon in cooperation with Vixie Enterprises and Nominum, Inc.  * To learn more about the Internet Software Consortium, see  * ``http://www.isc.org/''.  To learn more about Vixie Enterprises,  * see ``http://www.vix.com''.   To learn more about Nominum, Inc., see  * ``http://www.nominum.com''.  */
end_comment

begin_include
include|#
directive|include
file|<omapip/omapip_p.h>
end_include

begin_macro
name|OMAPI_OBJECT_ALLOC
argument_list|(
argument|omapi_message
argument_list|,
argument|omapi_message_object_t
argument_list|,
argument|omapi_type_message
argument_list|)
end_macro

begin_decl_stmt
name|omapi_message_object_t
modifier|*
name|omapi_registered_messages
decl_stmt|;
end_decl_stmt

begin_function
name|isc_result_t
name|omapi_message_new
parameter_list|(
name|omapi_object_t
modifier|*
modifier|*
name|o
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|omapi_message_object_t
modifier|*
name|m
decl_stmt|;
name|omapi_object_t
modifier|*
name|g
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
name|m
operator|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
literal|0
expr_stmt|;
name|status
operator|=
name|omapi_message_allocate
argument_list|(
operator|&
name|m
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
name|g
operator|=
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
expr_stmt|;
name|status
operator|=
name|omapi_generic_new
argument_list|(
operator|&
name|g
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dfree
argument_list|(
name|m
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_object_reference
argument_list|(
operator|&
name|m
operator|->
name|inner
argument_list|,
name|g
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|m
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|omapi_object_dereference
argument_list|(
operator|&
name|g
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_object_reference
argument_list|(
operator|&
name|g
operator|->
name|outer
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|m
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|m
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|omapi_object_dereference
argument_list|(
operator|&
name|g
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|omapi_object_reference
argument_list|(
name|o
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|m
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|omapi_message_dereference
argument_list|(
operator|&
name|m
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|omapi_object_dereference
argument_list|(
operator|&
name|g
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_message_set_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_typed_data_t
modifier|*
name|value
parameter_list|)
block|{
name|omapi_message_object_t
modifier|*
name|m
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_message
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|m
operator|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
name|h
expr_stmt|;
comment|/* Can't set authlen. */
comment|/* Can set authenticator, but the value must be typed data. */
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"authenticator"
argument_list|)
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|authenticator
condition|)
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|m
operator|->
name|authenticator
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_typed_data_reference
argument_list|(
operator|&
name|m
operator|->
name|authenticator
argument_list|,
name|value
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"object"
argument_list|)
condition|)
block|{
if|if
condition|(
name|value
operator|->
name|type
operator|!=
name|omapi_datatype_object
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|m
operator|->
name|object
condition|)
name|omapi_object_dereference
argument_list|(
operator|&
name|m
operator|->
name|object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_object_reference
argument_list|(
operator|&
name|m
operator|->
name|object
argument_list|,
name|value
operator|->
name|u
operator|.
name|object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"notify-object"
argument_list|)
condition|)
block|{
if|if
condition|(
name|value
operator|->
name|type
operator|!=
name|omapi_datatype_object
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|m
operator|->
name|notify_object
condition|)
name|omapi_object_dereference
argument_list|(
operator|&
name|m
operator|->
name|notify_object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_object_reference
argument_list|(
operator|&
name|m
operator|->
name|notify_object
argument_list|,
name|value
operator|->
name|u
operator|.
name|object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
comment|/* Can set authid, but it has to be an integer. */
block|}
elseif|else
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"authid"
argument_list|)
condition|)
block|{
if|if
condition|(
name|value
operator|->
name|type
operator|!=
name|omapi_datatype_int
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|m
operator|->
name|authid
operator|=
name|value
operator|->
name|u
operator|.
name|integer
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
comment|/* Can set op, but it has to be an integer. */
block|}
elseif|else
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"op"
argument_list|)
condition|)
block|{
if|if
condition|(
name|value
operator|->
name|type
operator|!=
name|omapi_datatype_int
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|m
operator|->
name|op
operator|=
name|value
operator|->
name|u
operator|.
name|integer
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
comment|/* Handle also has to be an integer. */
block|}
elseif|else
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"handle"
argument_list|)
condition|)
block|{
if|if
condition|(
name|value
operator|->
name|type
operator|!=
name|omapi_datatype_int
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|m
operator|->
name|h
operator|=
name|value
operator|->
name|u
operator|.
name|integer
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
comment|/* Transaction ID has to be an integer. */
block|}
elseif|else
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"id"
argument_list|)
condition|)
block|{
if|if
condition|(
name|value
operator|->
name|type
operator|!=
name|omapi_datatype_int
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|m
operator|->
name|id
operator|=
name|value
operator|->
name|u
operator|.
name|integer
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
comment|/* Remote transaction ID has to be an integer. */
block|}
elseif|else
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"rid"
argument_list|)
condition|)
block|{
if|if
condition|(
name|value
operator|->
name|type
operator|!=
name|omapi_datatype_int
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|m
operator|->
name|rid
operator|=
name|value
operator|->
name|u
operator|.
name|integer
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
comment|/* Try to find some inner object that can take the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
condition|)
block|{
name|status
operator|=
operator|(
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|set_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
name|status
return|;
block|}
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_message_get_value
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_data_string_t
modifier|*
name|name
parameter_list|,
name|omapi_value_t
modifier|*
modifier|*
name|value
parameter_list|)
block|{
name|omapi_message_object_t
modifier|*
name|m
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_message
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|m
operator|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
name|h
expr_stmt|;
comment|/* Look for values that are in the message data structure. */
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"authlen"
argument_list|)
condition|)
return|return
name|omapi_make_int_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
operator|(
name|int
operator|)
name|m
operator|->
name|authlen
argument_list|,
name|MDL
argument_list|)
return|;
elseif|else
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"authenticator"
argument_list|)
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|authenticator
condition|)
return|return
name|omapi_make_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
name|m
operator|->
name|authenticator
argument_list|,
name|MDL
argument_list|)
return|;
else|else
return|return
name|ISC_R_NOTFOUND
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"authid"
argument_list|)
condition|)
block|{
return|return
name|omapi_make_int_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
operator|(
name|int
operator|)
name|m
operator|->
name|authid
argument_list|,
name|MDL
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"op"
argument_list|)
condition|)
block|{
return|return
name|omapi_make_int_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
operator|(
name|int
operator|)
name|m
operator|->
name|op
argument_list|,
name|MDL
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"handle"
argument_list|)
condition|)
block|{
return|return
name|omapi_make_int_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
operator|(
name|int
operator|)
name|m
operator|->
name|h
argument_list|,
name|MDL
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"id"
argument_list|)
condition|)
block|{
return|return
name|omapi_make_int_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
operator|(
name|int
operator|)
name|m
operator|->
name|id
argument_list|,
name|MDL
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|omapi_ds_strcmp
argument_list|(
name|name
argument_list|,
literal|"rid"
argument_list|)
condition|)
block|{
return|return
name|omapi_make_int_value
argument_list|(
name|value
argument_list|,
name|name
argument_list|,
operator|(
name|int
operator|)
name|m
operator|->
name|rid
argument_list|,
name|MDL
argument_list|)
return|;
block|}
comment|/* See if there's an inner object that has the value. */
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
condition|)
return|return
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|get_value
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|id
operator|,
name|name
operator|,
name|value
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_message_destroy
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|omapi_message_object_t
modifier|*
name|m
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_message
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|m
operator|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|authenticator
condition|)
block|{
name|omapi_typed_data_dereference
argument_list|(
operator|&
name|m
operator|->
name|authenticator
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|m
operator|->
name|prev
operator|&&
name|omapi_registered_messages
operator|!=
name|m
condition|)
name|omapi_message_unregister
argument_list|(
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|id_object
condition|)
name|omapi_object_dereference
argument_list|(
operator|&
name|m
operator|->
name|id_object
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|object
condition|)
name|omapi_object_dereference
argument_list|(
operator|&
name|m
operator|->
name|object
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|notify_object
condition|)
name|omapi_object_dereference
argument_list|(
operator|&
name|m
operator|->
name|notify_object
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|protocol_object
condition|)
name|omapi_protocol_dereference
argument_list|(
operator|&
name|m
operator|->
name|protocol_object
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_message_signal_handler
parameter_list|(
name|omapi_object_t
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|omapi_message_object_t
modifier|*
name|m
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|type
operator|!=
name|omapi_type_message
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|m
operator|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
name|h
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"status"
argument_list|)
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|notify_object
operator|&&
name|m
operator|->
name|notify_object
operator|->
name|type
operator|->
name|signal_handler
condition|)
return|return
operator|(
operator|(
name|m
operator|->
name|notify_object
operator|->
name|type
operator|->
name|signal_handler
operator|)
operator|)
operator|(
name|m
operator|->
name|notify_object
operator|,
name|name
operator|,
name|ap
operator|)
return|;
elseif|else
if|if
condition|(
name|m
operator|->
name|object
operator|&&
name|m
operator|->
name|object
operator|->
name|type
operator|->
name|signal_handler
condition|)
return|return
operator|(
operator|(
name|m
operator|->
name|object
operator|->
name|type
operator|->
name|signal_handler
operator|)
operator|)
operator|(
name|m
operator|->
name|object
operator|,
name|name
operator|,
name|ap
operator|)
return|;
block|}
if|if
condition|(
name|h
operator|->
name|inner
operator|&&
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
condition|)
return|return
operator|(
operator|*
operator|(
name|h
operator|->
name|inner
operator|->
name|type
operator|->
name|signal_handler
operator|)
operator|)
operator|(
name|h
operator|->
name|inner
operator|,
name|name
operator|,
name|ap
operator|)
return|;
return|return
name|ISC_R_NOTFOUND
return|;
block|}
end_function

begin_comment
comment|/* Write all the published values associated with the object through the    specified connection. */
end_comment

begin_function
name|isc_result_t
name|omapi_message_stuff_values
parameter_list|(
name|omapi_object_t
modifier|*
name|c
parameter_list|,
name|omapi_object_t
modifier|*
name|id
parameter_list|,
name|omapi_object_t
modifier|*
name|m
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|m
operator|->
name|type
operator|!=
name|omapi_type_message
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|m
operator|->
name|inner
operator|&&
name|m
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
condition|)
return|return
operator|(
operator|*
operator|(
name|m
operator|->
name|inner
operator|->
name|type
operator|->
name|stuff_values
operator|)
operator|)
operator|(
name|c
operator|,
name|id
operator|,
name|m
operator|->
name|inner
operator|)
return|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_message_register
parameter_list|(
name|omapi_object_t
modifier|*
name|mo
parameter_list|)
block|{
name|omapi_message_object_t
modifier|*
name|m
decl_stmt|;
if|if
condition|(
name|mo
operator|->
name|type
operator|!=
name|omapi_type_message
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|m
operator|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
name|mo
expr_stmt|;
comment|/* Already registered? */
if|if
condition|(
name|m
operator|->
name|prev
operator|||
name|m
operator|->
name|next
operator|||
name|omapi_registered_messages
operator|==
name|m
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
if|if
condition|(
name|omapi_registered_messages
condition|)
block|{
name|omapi_object_reference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|m
operator|->
name|next
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|omapi_registered_messages
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_object_reference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|omapi_registered_messages
operator|->
name|prev
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|m
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|omapi_registered_messages
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
name|omapi_object_reference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|omapi_registered_messages
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|m
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
empty_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|omapi_message_unregister
parameter_list|(
name|omapi_object_t
modifier|*
name|mo
parameter_list|)
block|{
name|omapi_message_object_t
modifier|*
name|m
decl_stmt|;
name|omapi_message_object_t
modifier|*
name|n
decl_stmt|;
if|if
condition|(
name|mo
operator|->
name|type
operator|!=
name|omapi_type_message
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|m
operator|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
name|mo
expr_stmt|;
comment|/* Not registered? */
if|if
condition|(
operator|!
name|m
operator|->
name|prev
operator|&&
name|omapi_registered_messages
operator|!=
name|m
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|n
operator|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
literal|0
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|next
condition|)
block|{
name|omapi_object_reference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|n
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|m
operator|->
name|next
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|m
operator|->
name|next
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|->
name|prev
condition|)
block|{
name|omapi_message_object_t
modifier|*
name|tmp
init|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
literal|0
decl_stmt|;
name|omapi_object_reference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|tmp
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|m
operator|->
name|prev
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|m
operator|->
name|prev
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|->
name|next
condition|)
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|tmp
operator|->
name|next
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
condition|)
name|omapi_object_reference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|tmp
operator|->
name|next
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|n
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|tmp
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|omapi_registered_messages
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
condition|)
name|omapi_object_reference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|omapi_registered_messages
argument_list|,
operator|(
name|omapi_object_t
operator|*
operator|)
name|n
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|n
condition|)
name|omapi_object_dereference
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|*
operator|)
operator|&
name|n
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG_PROTOCOL
end_ifdef

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|omapi_message_op_name
parameter_list|(
name|int
name|op
parameter_list|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|OMAPI_OP_OPEN
case|:
return|return
literal|"OMAPI_OP_OPEN"
return|;
case|case
name|OMAPI_OP_REFRESH
case|:
return|return
literal|"OMAPI_OP_REFRESH"
return|;
case|case
name|OMAPI_OP_UPDATE
case|:
return|return
literal|"OMAPI_OP_UPDATE"
return|;
case|case
name|OMAPI_OP_STATUS
case|:
return|return
literal|"OMAPI_OP_STATUS"
return|;
case|case
name|OMAPI_OP_DELETE
case|:
return|return
literal|"OMAPI_OP_DELETE"
return|;
case|case
name|OMAPI_OP_NOTIFY
case|:
return|return
literal|"OMAPI_OP_NOTIFY"
return|;
default|default:
return|return
literal|"(unknown op)"
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|isc_result_t
name|omapi_message_process_internal
parameter_list|(
name|omapi_object_t
modifier|*
parameter_list|,
name|omapi_object_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|isc_result_t
name|omapi_message_process
parameter_list|(
name|omapi_object_t
modifier|*
name|mo
parameter_list|,
name|omapi_object_t
modifier|*
name|po
parameter_list|)
block|{
name|isc_result_t
name|status
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
name|unsigned
name|long
name|previous_outstanding
init|=
name|dmalloc_outstanding
decl_stmt|;
endif|#
directive|endif
name|status
operator|=
name|omapi_message_process_internal
argument_list|(
name|mo
argument_list|,
name|po
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
operator|&&
literal|0
name|log_info
argument_list|(
literal|"generation %ld: %ld new, %ld outstanding, %ld long-term"
argument_list|,
name|dmalloc_generation
argument_list|,
name|dmalloc_outstanding
operator|-
name|previous_outstanding
argument_list|,
name|dmalloc_outstanding
argument_list|,
name|dmalloc_longterm
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_MEMORY_LEAKAGE
argument_list|)
operator|&&
literal|0
name|dmalloc_dump_outstanding
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_RC_HISTORY_EXHAUSTIVELY
argument_list|)
operator|&&
literal|0
name|dump_rc_history
argument_list|()
expr_stmt|;
endif|#
directive|endif
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|omapi_message_process_internal
parameter_list|(
name|omapi_object_t
modifier|*
name|mo
parameter_list|,
name|omapi_object_t
modifier|*
name|po
parameter_list|)
block|{
name|omapi_message_object_t
modifier|*
name|message
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|omapi_object_t
modifier|*
name|object
init|=
operator|(
name|omapi_object_t
operator|*
operator|)
literal|0
decl_stmt|;
name|omapi_value_t
modifier|*
name|tv
init|=
operator|(
name|omapi_value_t
operator|*
operator|)
literal|0
decl_stmt|;
name|unsigned
name|long
name|create
decl_stmt|,
name|update
decl_stmt|,
name|exclusive
decl_stmt|;
name|unsigned
name|long
name|wsi
decl_stmt|;
name|isc_result_t
name|status
decl_stmt|,
name|waitstatus
decl_stmt|;
name|omapi_object_type_t
modifier|*
name|type
decl_stmt|;
if|if
condition|(
name|mo
operator|->
name|type
operator|!=
name|omapi_type_message
condition|)
return|return
name|ISC_R_INVALIDARG
return|;
name|message
operator|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
name|mo
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_PROTOCOL
name|log_debug
argument_list|(
literal|"omapi_message_process(): "
literal|"op=%s  handle=%#x  id=%#x  rid=%#x"
argument_list|,
name|omapi_message_op_name
argument_list|(
name|message
operator|->
name|op
argument_list|)
argument_list|,
name|message
operator|->
name|h
argument_list|,
name|message
operator|->
name|id
argument_list|,
name|message
operator|->
name|rid
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|message
operator|->
name|rid
condition|)
block|{
for|for
control|(
name|m
operator|=
name|omapi_registered_messages
init|;
name|m
condition|;
name|m
operator|=
name|m
operator|->
name|next
control|)
if|if
condition|(
name|m
operator|->
name|id
operator|==
name|message
operator|->
name|rid
condition|)
break|break;
comment|/* If we don't have a real message corresponding to 		   the message ID to which this message claims it is a 		   response, something's fishy. */
if|if
condition|(
operator|!
name|m
condition|)
return|return
name|ISC_R_NOTFOUND
return|;
comment|/* The authenticator on responses must match the initial 		   message. */
if|if
condition|(
name|message
operator|->
name|authid
operator|!=
name|m
operator|->
name|authid
condition|)
return|return
name|ISC_R_NOTFOUND
return|;
block|}
else|else
block|{
name|m
operator|=
operator|(
name|omapi_message_object_t
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* All messages must have an authenticator, with the exception 		   of messages that are opening a new authenticator. */
if|if
condition|(
name|omapi_protocol_authenticated
argument_list|(
name|po
argument_list|)
operator|&&
operator|!
name|message
operator|->
name|id_object
operator|&&
name|message
operator|->
name|op
operator|!=
name|OMAPI_OP_OPEN
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|ISC_R_NOKEYS
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"No authenticator on message"
argument_list|)
return|;
block|}
block|}
switch|switch
condition|(
name|message
operator|->
name|op
condition|)
block|{
case|case
name|OMAPI_OP_OPEN
case|:
if|if
condition|(
name|m
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|ISC_R_INVALIDARG
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"OPEN can't be a response"
argument_list|)
return|;
block|}
comment|/* Get the type of the requested object, if one was 		   specified. */
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|mo
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
literal|"type"
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
operator|&&
operator|(
name|tv
operator|->
name|value
operator|->
name|type
operator|==
name|omapi_datatype_data
operator|||
name|tv
operator|->
name|value
operator|->
name|type
operator|==
name|omapi_datatype_string
operator|)
condition|)
block|{
for|for
control|(
name|type
operator|=
name|omapi_object_types
init|;
name|type
condition|;
name|type
operator|=
name|type
operator|->
name|next
control|)
if|if
condition|(
operator|!
name|omapi_td_strcmp
argument_list|(
name|tv
operator|->
name|value
argument_list|,
name|type
operator|->
name|name
argument_list|)
condition|)
break|break;
block|}
else|else
name|type
operator|=
operator|(
name|omapi_object_type_t
operator|*
operator|)
literal|0
expr_stmt|;
if|if
condition|(
name|tv
condition|)
name|omapi_value_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
comment|/* If this object had no authenticator, the requested object 		   must be an authenticator object. */
if|if
condition|(
name|omapi_protocol_authenticated
argument_list|(
name|po
argument_list|)
operator|&&
operator|!
name|message
operator|->
name|id_object
operator|&&
name|type
operator|!=
name|omapi_type_auth_key
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|ISC_R_NOKEYS
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"No authenticator on message"
argument_list|)
return|;
block|}
comment|/* Get the create flag. */
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|mo
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
literal|"create"
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|status
operator|=
name|omapi_get_int_value
argument_list|(
operator|&
name|create
argument_list|,
name|tv
operator|->
name|value
argument_list|)
expr_stmt|;
name|omapi_value_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"invalid create flag value"
argument_list|)
return|;
block|}
block|}
else|else
name|create
operator|=
literal|0
expr_stmt|;
comment|/* Get the update flag. */
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|mo
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
literal|"update"
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|status
operator|=
name|omapi_get_int_value
argument_list|(
operator|&
name|update
argument_list|,
name|tv
operator|->
name|value
argument_list|)
expr_stmt|;
name|omapi_value_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"invalid update flag value"
argument_list|)
return|;
block|}
block|}
else|else
name|update
operator|=
literal|0
expr_stmt|;
comment|/* Get the exclusive flag. */
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|mo
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
literal|"exclusive"
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|status
operator|=
name|omapi_get_int_value
argument_list|(
operator|&
name|exclusive
argument_list|,
name|tv
operator|->
name|value
argument_list|)
expr_stmt|;
name|omapi_value_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"invalid exclusive flag value"
argument_list|)
return|;
block|}
block|}
else|else
name|exclusive
operator|=
literal|0
expr_stmt|;
comment|/* If we weren't given a type, look the object up with                    the handle. */
if|if
condition|(
operator|!
name|type
condition|)
block|{
if|if
condition|(
name|create
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|ISC_R_INVALIDARG
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"type required on create"
argument_list|)
return|;
block|}
goto|goto
name|refresh
goto|;
block|}
comment|/* If the type doesn't provide a lookup method, we can't 		   look up the object. */
if|if
condition|(
operator|!
name|type
operator|->
name|lookup
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|ISC_R_NOTIMPLEMENTED
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"unsearchable object type"
argument_list|)
return|;
block|}
name|status
operator|=
operator|(
operator|*
operator|(
name|type
operator|->
name|lookup
operator|)
operator|)
operator|(
operator|&
name|object
operator|,
name|message
operator|->
name|id_object
operator|,
name|message
operator|->
name|object
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|status
operator|!=
name|ISC_R_NOTFOUND
operator|&&
name|status
operator|!=
name|ISC_R_NOKEYS
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"object lookup failed"
argument_list|)
return|;
block|}
comment|/* If we didn't find the object and we aren't supposed to 		   create it, return an error. */
if|if
condition|(
name|status
operator|==
name|ISC_R_NOTFOUND
operator|&&
operator|!
name|create
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|ISC_R_NOTFOUND
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"no object matches specification"
argument_list|)
return|;
block|}
comment|/* If we found an object, we're supposed to be creating an 		   object, and we're not supposed to have found an object, 		   return an error. */
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
operator|&&
name|create
operator|&&
name|exclusive
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|ISC_R_EXISTS
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"specified object already exists"
argument_list|)
return|;
block|}
comment|/* If we're creating the object, do it now. */
if|if
condition|(
operator|!
name|object
condition|)
block|{
name|status
operator|=
name|omapi_object_create
argument_list|(
operator|&
name|object
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"can't create new object"
argument_list|)
return|;
block|}
block|}
comment|/* If we're updating it, do so now. */
if|if
condition|(
name|create
operator|||
name|update
condition|)
block|{
comment|/* This check does not belong here. */
if|if
condition|(
name|object
operator|->
name|type
operator|==
name|omapi_type_auth_key
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"can't update object"
argument_list|)
return|;
block|}
name|status
operator|=
name|omapi_object_update
argument_list|(
name|object
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|message
operator|->
name|object
argument_list|,
name|message
operator|->
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"can't update object"
argument_list|)
return|;
block|}
block|}
comment|/* If this is an authenticator object, add it to the active 		   set for the connection. */
if|if
condition|(
name|object
operator|->
name|type
operator|==
name|omapi_type_auth_key
condition|)
block|{
name|omapi_handle_t
name|handle
decl_stmt|;
name|status
operator|=
name|omapi_object_handle
argument_list|(
operator|&
name|handle
argument_list|,
name|object
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"can't select authenticator"
argument_list|)
return|;
block|}
name|status
operator|=
name|omapi_protocol_add_auth
argument_list|(
name|po
argument_list|,
name|object
argument_list|,
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"can't select authenticator"
argument_list|)
return|;
block|}
block|}
comment|/* Now send the new contents of the object back in 		   response. */
goto|goto
name|send
goto|;
case|case
name|OMAPI_OP_REFRESH
case|:
name|refresh
label|:
name|status
operator|=
name|omapi_handle_lookup
argument_list|(
operator|&
name|object
argument_list|,
name|message
operator|->
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"no matching handle"
argument_list|)
return|;
block|}
name|send
label|:
name|status
operator|=
name|omapi_protocol_send_update
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|message
operator|->
name|id
argument_list|,
name|object
argument_list|)
expr_stmt|;
name|omapi_object_dereference
argument_list|(
operator|&
name|object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
case|case
name|OMAPI_OP_UPDATE
case|:
if|if
condition|(
name|m
operator|&&
name|m
operator|->
name|object
condition|)
block|{
name|omapi_object_reference
argument_list|(
operator|&
name|object
argument_list|,
name|m
operator|->
name|object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|omapi_handle_lookup
argument_list|(
operator|&
name|object
argument_list|,
name|message
operator|->
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"no matching handle"
argument_list|)
return|;
block|}
block|}
if|if
condition|(
name|object
operator|->
name|type
operator|==
name|omapi_type_auth_key
operator|||
operator|(
name|object
operator|->
name|inner
operator|&&
name|object
operator|->
name|inner
operator|->
name|type
operator|==
name|omapi_type_auth_key
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|m
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"cannot update authenticator"
argument_list|)
return|;
block|}
name|status
operator|=
name|omapi_protocol_add_auth
argument_list|(
name|po
argument_list|,
name|object
argument_list|,
name|message
operator|->
name|h
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|omapi_object_update
argument_list|(
name|object
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|message
operator|->
name|object
argument_list|,
name|message
operator|->
name|h
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|omapi_object_dereference
argument_list|(
operator|&
name|object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|message
operator|->
name|rid
condition|)
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"can't update object"
argument_list|)
return|;
if|if
condition|(
name|m
condition|)
name|omapi_signal
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|m
argument_list|,
literal|"status"
argument_list|,
name|status
argument_list|,
operator|(
name|omapi_typed_data_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
block|}
if|if
condition|(
operator|!
name|message
operator|->
name|rid
condition|)
name|status
operator|=
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|ISC_R_SUCCESS
argument_list|,
name|message
operator|->
name|id
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
name|omapi_signal
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|m
argument_list|,
literal|"status"
argument_list|,
name|ISC_R_SUCCESS
argument_list|,
operator|(
name|omapi_typed_data_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
return|return
name|status
return|;
case|case
name|OMAPI_OP_NOTIFY
case|:
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|ISC_R_NOTIMPLEMENTED
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"notify not implemented yet"
argument_list|)
return|;
case|case
name|OMAPI_OP_STATUS
case|:
comment|/* The return status of a request. */
if|if
condition|(
operator|!
name|m
condition|)
return|return
name|ISC_R_UNEXPECTED
return|;
comment|/* Get the wait status. */
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|mo
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
literal|"result"
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|status
operator|=
name|omapi_get_int_value
argument_list|(
operator|&
name|wsi
argument_list|,
name|tv
operator|->
name|value
argument_list|)
expr_stmt|;
name|waitstatus
operator|=
name|wsi
expr_stmt|;
name|omapi_value_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
name|waitstatus
operator|=
name|ISC_R_UNEXPECTED
expr_stmt|;
block|}
else|else
name|waitstatus
operator|=
name|ISC_R_UNEXPECTED
expr_stmt|;
name|status
operator|=
name|omapi_get_value_str
argument_list|(
name|mo
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
literal|"message"
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
name|omapi_signal
argument_list|(
operator|(
name|omapi_object_t
operator|*
operator|)
name|m
argument_list|,
literal|"status"
argument_list|,
name|waitstatus
argument_list|,
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|ISC_R_SUCCESS
condition|)
name|omapi_value_dereference
argument_list|(
operator|&
name|tv
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|ISC_R_SUCCESS
return|;
case|case
name|OMAPI_OP_DELETE
case|:
name|status
operator|=
name|omapi_handle_lookup
argument_list|(
operator|&
name|object
argument_list|,
name|message
operator|->
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"no matching handle"
argument_list|)
return|;
block|}
if|if
condition|(
operator|!
name|object
operator|->
name|type
operator|->
name|remove
condition|)
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|ISC_R_NOTIMPLEMENTED
argument_list|,
name|message
operator|->
name|id
argument_list|,
literal|"no remove method for object"
argument_list|)
return|;
name|status
operator|=
operator|(
operator|*
operator|(
name|object
operator|->
name|type
operator|->
name|remove
operator|)
operator|)
operator|(
name|object
operator|,
name|message
operator|->
name|id_object
operator|)
expr_stmt|;
name|omapi_object_dereference
argument_list|(
operator|&
name|object
argument_list|,
name|MDL
argument_list|)
expr_stmt|;
return|return
name|omapi_protocol_send_status
argument_list|(
name|po
argument_list|,
name|message
operator|->
name|id_object
argument_list|,
name|status
argument_list|,
name|message
operator|->
name|id
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|)
return|;
block|}
return|return
name|ISC_R_NOTIMPLEMENTED
return|;
block|}
end_function

end_unit


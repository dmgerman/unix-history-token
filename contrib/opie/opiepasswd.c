begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* opiepasswd.c: Add/change an OTP password in the key database.  %%% portions-copyright-cmetz-96 Portions of this software are Copyright 1996-1999 by Craig Metz, All Rights Reserved. The Inner Net License Version 2 applies to these portions of the software. You should have received a copy of the license with this software. If you didn't get a copy, you may request one from<license@inner.net>.  Portions of this software are Copyright 1995 by Randall Atkinson and Dan McDonald, All Rights Reserved. All Rights under this copyright are assigned to the U.S. Naval Research Laboratory (NRL). The NRL Copyright Notice and License Agreement applies to this software.  	History:  	Modified by cmetz for OPIE 2.4. Use struct opie_key for key blocks. 		Use opiestrncpy(). 	Modified by cmetz for OPIE 2.32. Use OPIE_SEED_MAX instead of 		hard coding the length. Unlock user on failed lookup. 	Modified by cmetz for OPIE 2.3. Got of some variables and made some 		local to where they're used. Split out the finishing code. Use 		opielookup() instead of opiechallenge() to find user. Three 		strikes on prompts. Use opiepasswd()'s new calling 		convention. Changed OPIE_PASS_{MAX,MIN} to 		OPIE_SECRET_{MAX,MIN}. Handle automatic reinits happenning 		below us. Got rid of unneeded headers. Use new opieatob8() 		return value convention. Added -f flag. Added SHA support. 	Modified by cmetz for OPIE 2.22. Finally got rid of the lock 	        filename kluge by implementing refcounts for locks. 		Use opiepasswd() to update key file. Error if we can't 		write to the key file. Check for minimum seed length.         Modified at NRL for OPIE 2.2. Changed opiestrip_crlf to                 opiestripcrlf. Check opiereadpass() return value.                 Minor optimization. Change calls to opiereadpass() to                 use echo arg. Use opiereadpass() where we can.                 Make everything static. Ifdef around some headers.                 Changed use of gethostname() to uname(). Got rid of                 the need for buf[]. Properly check return value of                 opieatob8. Check seed length. Always generate proper-                 length seeds. 	Modified at NRL for OPIE 2.1. Minor autoconf changes.         Modified heavily at NRL for OPIE 2.0. 	Written at Bellcore for the S/Key Version 1 software distribution 		(skeyinit.c).   $FreeBSD$ */
end_comment

begin_include
include|#
directive|include
file|"opie_cfg.h"
end_include

begin_if
if|#
directive|if
name|HAVE_PWD_H
end_if

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_PWD_H */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_if
if|#
directive|if
name|HAVE_STRING_H
end_if

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_STRING_H */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_if
if|#
directive|if
name|HAVE_UNISTD_H
end_if

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_UNISTD_H */
end_comment

begin_if
if|#
directive|if
name|HAVE_STDLIB_H
end_if

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_STDLIB_H */
end_comment

begin_include
include|#
directive|include
file|"opie.h"
end_include

begin_define
define|#
directive|define
name|MODE_DEFAULT
value|0
end_define

begin_define
define|#
directive|define
name|MODE_CONSOLE
value|1
end_define

begin_define
define|#
directive|define
name|MODE_DISABLE
value|2
end_define

begin_decl_stmt
specifier|extern
name|int
name|optind
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|algnames
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"SHA-1"
block|,
literal|"MD4"
block|,
literal|"MD5"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|algids
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"sha1"
block|,
literal|"md4"
block|,
literal|"md5"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|VOIDRET
name|usage
name|FUNCTION
argument_list|(
operator|(
name|myname
operator|)
argument_list|,
name|char
operator|*
name|myname
argument_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [-v] [-h] [-c|-d] [-f] [-n initial_sequence_number]\n                            [-s seed] [username]\n"
argument_list|,
name|myname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_decl_stmt

begin_decl_stmt
specifier|static
name|VOIDRET
name|finish
name|FUNCTION
argument_list|(
operator|(
name|name
operator|)
argument_list|,
name|char
operator|*
name|name
argument_list|)
block|{
name|struct
name|opie
name|opie
decl_stmt|;
name|char
name|buf
index|[
name|OPIE_RESPONSE_MAX
operator|+
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|name
condition|)
block|{
if|if
condition|(
name|opiechallenge
argument_list|(
operator|&
name|opie
argument_list|,
name|name
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error verifying database.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\nID %s "
argument_list|,
name|opie
operator|.
name|opie_principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|opie
operator|.
name|opie_val
operator|&&
operator|(
name|opie
operator|.
name|opie_val
index|[
literal|0
index|]
operator|==
literal|'*'
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"is disabled.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"OTP key is %d %s\n"
argument_list|,
name|opie
operator|.
name|opie_n
argument_list|,
name|opie
operator|.
name|opie_seed
argument_list|)
expr_stmt|;
block|{
name|struct
name|opie_otpkey
name|key
decl_stmt|;
if|if
condition|(
operator|!
name|opieatob8
argument_list|(
operator|&
name|key
argument_list|,
name|opie
operator|.
name|opie_val
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error verifying key -- possible database corruption.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|opiebtoe
argument_list|(
name|buf
argument_list|,
operator|&
name|key
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
while|while
condition|(
operator|!
name|opieunlock
argument_list|()
condition|)
empty_stmt|;
name|exit
argument_list|(
name|name
condition|?
literal|0
else|:
literal|1
argument_list|)
expr_stmt|;
block|}
end_decl_stmt

begin_decl_stmt
name|int
decl|main
name|FUNCTION
argument_list|(
operator|(
name|argc
operator|,
name|argv
operator|)
argument_list|,
name|int
name|argc
name|AND
name|char
operator|*
name|argv
index|[]
argument_list|)
block|{
name|struct
name|opie
name|opie
decl_stmt|;
name|int
name|rval
decl_stmt|,
name|n
init|=
literal|499
decl_stmt|,
name|i
decl_stmt|,
name|mode
init|=
name|MODE_DEFAULT
decl_stmt|,
name|force
init|=
literal|0
decl_stmt|;
name|char
name|seed
index|[
name|OPIE_SEED_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pp
decl_stmt|;
name|memset
argument_list|(
name|seed
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|seed
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pp
operator|=
name|getpwnam
argument_list|(
name|getlogin
argument_list|()
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Who are you?"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
while|while
condition|(
operator|(
name|i
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"fhvcn:s:d"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|'v'
case|:
name|opieversion
argument_list|()
expr_stmt|;
case|case
literal|'f'
case|:
if|#
directive|if
name|INSECURE_OVERRIDE
name|force
operator|=
name|OPIEPASSWD_FORCE
expr_stmt|;
else|#
directive|else
comment|/* INSECURE_OVERRIDE */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Sorry, but the -f option is not supported by this build of OPIE.\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* INSECURE_OVERRIDE */
break|break;
case|case
literal|'c'
case|:
name|mode
operator|=
name|MODE_CONSOLE
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|mode
operator|=
name|MODE_DISABLE
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|i
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|i
operator|>
literal|0
operator|&&
name|i
operator|<
literal|10000
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Sequence numbers must be> 0 and< 10000\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|n
operator|=
name|i
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|i
operator|=
name|strlen
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|>
name|OPIE_SEED_MAX
operator|)
operator|||
operator|(
name|i
operator|<
name|OPIE_SEED_MIN
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Seeds must be between %d and %d characters long.\n"
argument_list|,
name|OPIE_SEED_MIN
argument_list|,
name|OPIE_SEED_MAX
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|opiestrncpy
argument_list|(
name|seed
argument_list|,
name|optarg
argument_list|,
sizeof|sizeof
argument_list|(
name|seed
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|argc
operator|-
name|optind
operator|>=
literal|1
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
name|pp
operator|->
name|pw_name
argument_list|)
condition|)
block|{
if|if
condition|(
name|getuid
argument_list|()
condition|)
block|{
name|printf
argument_list|(
literal|"Only root can change others' passwords.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|pp
operator|=
name|getpwnam
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: user unknown.\n"
argument_list|,
name|argv
index|[
name|optind
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|opielock
argument_list|(
name|pp
operator|->
name|pw_name
argument_list|)
expr_stmt|;
name|rval
operator|=
name|opielookup
argument_list|(
operator|&
name|opie
argument_list|,
name|pp
operator|->
name|pw_name
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rval
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"Updating %s:\n"
argument_list|,
name|pp
operator|->
name|pw_name
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"Adding %s:\n"
argument_list|,
name|pp
operator|->
name|pw_name
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error: Can't update key database.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error reading key database\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|seed
index|[
literal|0
index|]
condition|)
block|{
name|i
operator|=
name|strlen
argument_list|(
name|seed
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|OPIE_SEED_MAX
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Seeds must be less than %d characters long."
argument_list|,
name|OPIE_SEED_MAX
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
name|OPIE_SEED_MIN
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Seeds must be greater than %d characters long."
argument_list|,
name|OPIE_SEED_MIN
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|rval
condition|)
name|strcpy
argument_list|(
name|seed
argument_list|,
name|opie
operator|.
name|opie_seed
argument_list|)
expr_stmt|;
if|if
condition|(
name|opienewseed
argument_list|(
name|seed
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error updating seed.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|opie
operator|.
name|opie_seed
operator|&&
name|opie
operator|.
name|opie_seed
index|[
literal|0
index|]
operator|&&
operator|!
name|strcmp
argument_list|(
name|opie
operator|.
name|opie_seed
argument_list|,
name|seed
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"You must use a different seed for the new OTP sequence.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|MODE_DEFAULT
case|:
block|{
name|char
name|tmp
index|[
name|OPIE_RESPONSE_MAX
operator|+
literal|2
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"You need the response from an OTP generator.\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|DEBUG
if|if
condition|(
operator|!
name|rval
condition|)
block|{
else|#
directive|else
comment|/* DEBUG */
if|if
condition|(
operator|!
name|rval
operator|&&
name|getuid
argument_list|()
condition|)
block|{
endif|#
directive|endif
comment|/* DEBUG */
name|char
name|oseed
index|[
name|OPIE_SEED_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|on
decl_stmt|;
if|if
condition|(
name|opiechallenge
argument_list|(
operator|&
name|opie
argument_list|,
name|pp
operator|->
name|pw_name
argument_list|,
name|tmp
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error issuing challenge.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|on
operator|=
name|opiegetsequence
argument_list|(
operator|&
name|opie
argument_list|)
expr_stmt|;
block|{
name|char
modifier|*
name|c
decl_stmt|;
if|if
condition|(
name|c
operator|=
name|strrchr
argument_list|(
name|tmp
argument_list|,
literal|' '
argument_list|)
condition|)
name|opiestrncpy
argument_list|(
name|oseed
argument_list|,
name|c
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|oseed
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
if|#
directive|if
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"opiepasswd: bogus challenge\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"Old secret pass phrase:\n\t%s\n\tResponse: "
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opiereadpass
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|,
literal|1
argument_list|)
condition|)
name|tmp
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|opieverify
argument_list|(
operator|&
name|opie
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
index|[
literal|0
index|]
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error reading response.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error verifying response.\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"opiepasswd: opieverify() returned %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
block|{
name|char
name|nseed
index|[
name|OPIE_SEED_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|nn
decl_stmt|;
if|if
condition|(
name|opiechallenge
argument_list|(
operator|&
name|opie
argument_list|,
name|pp
operator|->
name|pw_name
argument_list|,
name|tmp
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error verifying database.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|nn
operator|=
name|opiegetsequence
argument_list|(
operator|&
name|opie
argument_list|)
expr_stmt|;
block|{
name|char
modifier|*
name|c
decl_stmt|;
if|if
condition|(
name|c
operator|=
name|strrchr
argument_list|(
name|tmp
argument_list|,
literal|' '
argument_list|)
condition|)
name|opiestrncpy
argument_list|(
name|nseed
argument_list|,
name|c
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|nseed
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
if|#
directive|if
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"opiepasswd: bogus challenge\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
name|opieverify
argument_list|(
operator|&
name|opie
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|nn
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|nn
operator|!=
name|on
operator|)
operator|||
name|strcmp
argument_list|(
name|oseed
argument_list|,
name|nseed
argument_list|)
condition|)
name|finish
argument_list|(
name|pp
operator|->
name|pw_name
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"New secret pass phrase:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|2
condition|)
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\totp-%s %d %s\n\tResponse: "
argument_list|,
name|algids
index|[
name|MDX
index|]
argument_list|,
name|n
argument_list|,
name|seed
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opiereadpass
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error reading response.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tmp
index|[
literal|0
index|]
operator|==
literal|'?'
condition|)
block|{
name|printf
argument_list|(
literal|"Enter the response from your OTP calculator: \n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|tmp
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Secret pass phrase unchanged.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|rval
operator|=
name|opiepasswd
argument_list|(
operator|&
name|opie
argument_list|,
name|force
argument_list|,
name|pp
operator|->
name|pw_name
argument_list|,
name|n
argument_list|,
name|seed
argument_list|,
name|tmp
argument_list|)
operator|)
condition|)
name|finish
argument_list|(
name|pp
operator|->
name|pw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error updating key database.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\tThat is not a valid OTP response.\n"
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|MODE_CONSOLE
case|:
block|{
name|char
name|passwd
index|[
name|OPIE_SECRET_MAX
operator|+
literal|1
index|]
decl_stmt|,
name|passwd2
index|[
name|OPIE_SECRET_MAX
operator|+
literal|1
index|]
decl_stmt|;
comment|/* Get user's secret password */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Only use this method from the console; NEVER from remote. If you are using\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"telnet, xterm, or a dial-in, type ^C now or exit with no password.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Then run opiepasswd without the -c parameter.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opieinsecure
argument_list|()
operator|&&
operator|!
name|force
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Sorry, but you don't seem to be on the console or a secure terminal.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|force
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Warning: Continuing could disclose your secret pass phrase to an attacker!\n"
argument_list|)
expr_stmt|;
else|else
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"Using %s to compute responses.\n"
argument_list|,
name|algnames
index|[
name|MDX
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rval
operator|&&
name|getuid
argument_list|()
condition|)
block|{
name|printf
argument_list|(
literal|"Enter old secret pass phrase: "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opiereadpass
argument_list|(
name|passwd
argument_list|,
sizeof|sizeof
argument_list|(
name|passwd
argument_list|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error reading secret pass phrase!\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|passwd
index|[
literal|0
index|]
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Secret pass phrase unchanged.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
block|{
name|struct
name|opie_otpkey
name|key
decl_stmt|;
name|char
name|tbuf
index|[
name|OPIE_RESPONSE_MAX
operator|+
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|opiekeycrunch
argument_list|(
name|MDX
argument_list|,
operator|&
name|key
argument_list|,
name|opie
operator|.
name|opie_seed
argument_list|,
name|passwd
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: key crunch failed. Secret pass phrase unchanged\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|passwd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|passwd
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|=
name|opie
operator|.
name|opie_n
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|i
operator|--
operator|!=
literal|0
condition|)
name|opiehash
argument_list|(
operator|&
name|key
argument_list|,
name|MDX
argument_list|)
expr_stmt|;
name|opiebtoe
argument_list|(
name|tbuf
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|opieverify
argument_list|(
operator|&
name|opie
argument_list|,
name|tbuf
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Sorry.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|2
condition|)
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Enter new secret pass phrase: "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opiereadpass
argument_list|(
name|passwd
argument_list|,
sizeof|sizeof
argument_list|(
name|passwd
argument_list|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error reading secret pass phrase.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|passwd
index|[
literal|0
index|]
operator|||
name|feof
argument_list|(
name|stdin
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Secret pass phrase unchanged.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opiepasscheck
argument_list|(
name|passwd
argument_list|)
condition|)
block|{
name|memset
argument_list|(
name|passwd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|passwd
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Secret pass phrases must be between %d and %d characters long.\n"
argument_list|,
name|OPIE_SECRET_MIN
argument_list|,
name|OPIE_SECRET_MAX
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|printf
argument_list|(
literal|"Again new secret pass phrase: "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opiereadpass
argument_list|(
name|passwd2
argument_list|,
sizeof|sizeof
argument_list|(
name|passwd2
argument_list|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error reading secret pass phrase.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|feof
argument_list|(
name|stdin
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Secret pass phrase unchanged.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|passwd
index|[
literal|0
index|]
operator|||
operator|!
name|strcmp
argument_list|(
name|passwd
argument_list|,
name|passwd2
argument_list|)
condition|)
break|break;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Sorry, no match.\n"
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|passwd2
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|passwd2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|opiepasswd
argument_list|(
operator|&
name|opie
argument_list|,
literal|1
operator||
name|force
argument_list|,
name|pp
operator|->
name|pw_name
argument_list|,
name|n
argument_list|,
name|seed
argument_list|,
name|passwd
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error updating key database.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|finish
argument_list|(
name|pp
operator|->
name|pw_name
argument_list|)
expr_stmt|;
block|}
case|case
name|MODE_DISABLE
case|:
block|{
name|char
name|tmp
index|[
literal|4
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|2
condition|)
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Disable %s's OTP access? (yes or no) "
argument_list|,
name|pp
operator|->
name|pw_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opiereadpass
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error reading entry.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|tmp
argument_list|,
literal|"no"
argument_list|)
condition|)
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|tmp
argument_list|,
literal|"yes"
argument_list|)
condition|)
block|{
if|if
condition|(
name|opiepasswd
argument_list|(
operator|&
name|opie
argument_list|,
literal|0
argument_list|,
name|pp
operator|->
name|pw_name
argument_list|,
name|n
argument_list|,
name|seed
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error updating key database.\n"
argument_list|)
expr_stmt|;
name|finish
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|finish
argument_list|(
name|pp
operator|->
name|pw_name
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_decl_stmt

end_unit


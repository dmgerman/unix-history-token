begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* getusershell.c: minimal implementation of the getusershell() and    endusershell() library routines for systems that don't have them.  %%% portions-copyright-cmetz Portions of this software are Copyright 1996 by Craig Metz, All Rights Reserved. The Inner Net License Version 2 applies to these portions of the software. You should have received a copy of the license with this software. If you didn't get a copy, you may request one from<license@inner.net>.  Portions of this software are Copyright 1995 by Randall Atkinson and Dan McDonald, All Rights Reserved. All Rights under this copyright are assigned to the U.S. Naval Research Laboratory (NRL). The NRL Copyright Notice and License Agreement applies to this software.  	History:  	Modified by cmetz for OPIE 2.2. Use FUNCTION declaration et al. 	Modified at NRL for OPIE 2.1. Remove trailing newlines from 	        /etc/shells entries. Fixed infinite loop. Fixed a bug                 where second invocation on would fail. 	Written at NRL for OPIE 2.0. */
end_comment

begin_include
include|#
directive|include
file|"opie_cfg.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_if
if|#
directive|if
name|HAVE_STRING_H
end_if

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_STRING_H */
end_comment

begin_include
include|#
directive|include
file|"opie.h"
end_include

begin_decl_stmt
specifier|static
name|FILE
modifier|*
name|fh
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|internal
index|[]
init|=
block|{
literal|"/bin/sh"
block|,
literal|"/bin/csh"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|i
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|buffer
index|[
literal|1024
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|getusershell
name|FUNCTION_NOARGS
block|{
name|char
modifier|*
name|c
decl_stmt|;
if|if
condition|(
operator|!
name|fh
condition|)
name|fh
operator|=
name|fopen
argument_list|(
literal|"/etc/shells"
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fh
condition|)
block|{
if|if
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|fh
argument_list|)
condition|)
block|{
if|if
condition|(
name|c
operator|=
name|strchr
argument_list|(
name|buffer
argument_list|,
literal|'\n'
argument_list|)
condition|)
operator|*
name|c
operator|=
literal|0
expr_stmt|;
return|return
name|buffer
return|;
block|}
else|else
block|{
name|fclose
argument_list|(
name|fh
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|internal
index|[
name|i
index|]
condition|)
return|return
name|internal
index|[
name|i
operator|++
index|]
return|;
else|else
return|return
name|NULL
return|;
block|}
block|}
end_decl_stmt

begin_decl_stmt
name|VOIDRET
name|endusershell
name|FUNCTION_NOARGS
block|{
if|if
condition|(
name|fh
condition|)
block|{
name|fclose
argument_list|(
name|fh
argument_list|)
expr_stmt|;
name|fh
operator|=
name|NULL
expr_stmt|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
block|}
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* passwd.c: The opiepasswd() library function.  %%% copyright-cmetz-96 This software is Copyright 1996-2001 by Craig Metz, All Rights Reserved. The Inner Net License Version 3 applies to this software. You should have received a copy of the license with this software. If you didn't get a copy, you may request one from<license@inner.net>.  	History:  	Modified by cmetz for OPIE 2.32. Renamed mode to flags. Made flag 		values symbolic constants. Added a flag for insecure override 		support. 	Modified by cmetz for OPIE 2.31. Removed active attack protection 		support. 	Modified by cmetz for OPIE 2.3. Split most of the function off 		and turned this into a front-end for the new __opiewriterec(). 		Added code to compute the key from the secret. Use the opie_ 		prefix. Use new opieatob8() and opiebtoa8() return values. 	Created by cmetz for OPIE 2.22. */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"opie_cfg.h"
end_include

begin_include
include|#
directive|include
file|"opie.h"
end_include

begin_decl_stmt
name|int
name|opiepasswd
name|FUNCTION
argument_list|(
operator|(
name|old
operator|,
name|flags
operator|,
name|principal
operator|,
name|n
operator|,
name|seed
operator|,
name|ks
operator|)
argument_list|,
expr|struct
name|opie
operator|*
name|old
name|AND
name|int
name|flags
name|AND
name|char
operator|*
name|principal
name|AND
name|int
name|n
name|AND
name|char
operator|*
name|seed
name|AND
name|char
operator|*
name|ks
argument_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|opie
name|opie
decl_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|OPIEPASSWD_CONSOLE
operator|)
operator|&&
name|opieinsecure
argument_list|()
condition|)
if|#
directive|if
name|INSECURE_OVERRIDE
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|OPIEPASSWD_FORCE
operator|)
condition|)
endif|#
directive|endif
comment|/* INSECURE_OVERRIDE */
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|opie
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|opie
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|old
condition|)
block|{
name|opie
operator|.
name|opie_flags
operator|=
name|old
operator|->
name|opie_flags
expr_stmt|;
name|opie
operator|.
name|opie_recstart
operator|=
name|old
operator|->
name|opie_recstart
expr_stmt|;
block|}
name|opie
operator|.
name|opie_principal
operator|=
name|principal
expr_stmt|;
name|opie
operator|.
name|opie_n
operator|=
name|n
expr_stmt|;
name|opie
operator|.
name|opie_seed
operator|=
name|seed
expr_stmt|;
if|if
condition|(
name|ks
condition|)
block|{
name|struct
name|opie_otpkey
name|key
decl_stmt|;
if|if
condition|(
name|flags
operator|&
name|OPIEPASSWD_CONSOLE
condition|)
block|{
if|if
condition|(
name|opiekeycrunch
argument_list|(
name|MDX
argument_list|,
operator|&
name|key
argument_list|,
name|seed
argument_list|,
name|ks
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
condition|;
name|i
operator|--
control|)
name|opiehash
argument_list|(
operator|&
name|key
argument_list|,
name|MDX
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|opie
operator|.
name|opie_val
operator|=
name|opiebtoa8
argument_list|(
name|opie
operator|.
name|opie_buf
argument_list|,
operator|&
name|key
argument_list|)
operator|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|opieetob
argument_list|(
operator|&
name|key
argument_list|,
name|ks
argument_list|)
operator|!=
literal|1
operator|)
operator|&&
operator|!
name|opieatob8
argument_list|(
operator|&
name|key
argument_list|,
name|ks
argument_list|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
operator|(
name|opie
operator|.
name|opie_val
operator|=
name|opiebtoa8
argument_list|(
name|opie
operator|.
name|opie_buf
argument_list|,
operator|&
name|key
argument_list|)
operator|)
condition|)
return|return
literal|1
return|;
block|}
block|}
if|if
condition|(
name|opielock
argument_list|(
name|principal
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|i
operator|=
name|__opiewriterec
argument_list|(
operator|&
name|opie
argument_list|)
expr_stmt|;
if|if
condition|(
name|opieunlock
argument_list|()
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|i
return|;
block|}
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* newseed.c: The opienewseed() library function.  %%% copyright-cmetz-96 This software is Copyright 1996-2001 by Craig Metz, All Rights Reserved. The Inner Net License Version 3 applies to this software. You should have received a copy of the license with this software. If you didn't get a copy, you may request one from<license@inner.net>.  	History:  	Modified by cmetz for OPIE 2.4. Greatly simplified increment. Now does 		not add digits. Reformatted the code. 	Modified by cmetz for OPIE 2.32. Added syslog.h if DEBUG. 	Modified by cmetz for OPIE 2.31. Added time.h. 	Created by cmetz for OPIE 2.22. */
end_comment

begin_include
include|#
directive|include
file|"opie_cfg.h"
end_include

begin_if
if|#
directive|if
name|HAVE_TIME_H
end_if

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_TIME_H */
end_comment

begin_if
if|#
directive|if
name|HAVE_STRING_H
end_if

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_STRING_H */
end_comment

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_if
if|#
directive|if
name|HAVE_UNISTD_H
end_if

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_UNISTD_H */
end_comment

begin_if
if|#
directive|if
name|HAVE_SYS_UTSNAME_H
end_if

begin_include
include|#
directive|include
file|<sys/utsname.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SYS_UTSNAME_H */
end_comment

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_if
if|#
directive|if
name|DEBUG
end_if

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DEBUG */
end_comment

begin_include
include|#
directive|include
file|"opie.h"
end_include

begin_decl_stmt
name|int
name|opienewseed
name|FUNCTION
argument_list|(
operator|(
name|seed
operator|)
argument_list|,
name|char
operator|*
name|seed
argument_list|)
block|{
if|if
condition|(
operator|!
name|seed
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|seed
index|[
literal|0
index|]
condition|)
block|{
name|char
modifier|*
name|c
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|max
decl_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|strlen
argument_list|(
name|seed
argument_list|)
operator|)
operator|>
name|OPIE_SEED_MAX
condition|)
name|i
operator|=
name|OPIE_SEED_MAX
expr_stmt|;
for|for
control|(
name|c
operator|=
name|end
operator|=
name|seed
operator|+
name|i
operator|-
literal|1
operator|,
name|max
operator|=
literal|1
init|;
operator|(
name|c
operator|>
name|seed
operator|)
operator|&&
name|isdigit
argument_list|(
operator|*
name|c
argument_list|)
condition|;
name|c
operator|--
control|)
name|max
operator|*=
literal|10
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|strtoul
argument_list|(
operator|++
name|c
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
literal|0
argument_list|,
literal|10
argument_list|)
operator|)
operator|<
name|max
condition|)
block|{
if|if
condition|(
operator|++
name|i
operator|>=
name|max
condition|)
name|i
operator|=
literal|1
expr_stmt|;
name|snprintf
argument_list|(
name|c
argument_list|,
name|end
operator|-
name|c
argument_list|,
literal|"%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|seed
index|[
name|OPIE_SEED_MAX
index|]
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
block|{
name|time_t
name|now
decl_stmt|;
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|srand
argument_list|(
name|now
argument_list|)
expr_stmt|;
block|}
block|{
name|struct
name|utsname
name|utsname
decl_stmt|;
if|if
condition|(
name|uname
argument_list|(
operator|&
name|utsname
argument_list|)
operator|<
literal|0
condition|)
block|{
if|#
directive|if
name|DEBUG
name|syslog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"uname: %s(%d)"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|,
name|errno
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
name|utsname
operator|.
name|nodename
index|[
literal|0
index|]
operator|=
literal|'k'
expr_stmt|;
name|utsname
operator|.
name|nodename
index|[
literal|1
index|]
operator|=
literal|'e'
expr_stmt|;
block|}
name|utsname
operator|.
name|nodename
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|snprintf
argument_list|(
name|seed
argument_list|,
name|OPIE_SEED_MAX
operator|+
literal|1
argument_list|,
literal|"%s%04d"
argument_list|,
name|utsname
operator|.
name|nodename
argument_list|,
operator|(
name|rand
argument_list|()
operator|%
literal|9999
operator|)
operator|+
literal|1
argument_list|)
operator|>=
name|OPIE_SEED_MAX
operator|+
literal|1
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
block|}
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* opietest.c: Quick, though definitely not complete, regression test for                libopie. This is intended to catch two things:  	(1) when changes break something         (2) if some system wierdness (libc, compiler, or CPU/hardware) is             not getting along at all with OPIE.          It's safe to say that, if tests fail, OPIE isn't going to work right on your system. The converse is not such a safe statement.  %%% copyright-cmetz-96 This software is Copyright 1996-2001 by Craig Metz, All Rights Reserved. The Inner Net License Version 3 applies to this software. You should have received a copy of the license with this software. If you didn't get a copy, you may request one from<license@inner.net>.          History:  	Modified by cmetz for OPIE 2.4. Use struct opie_key for key blocks. 	Modified by cmetz for OPIE 2.31. Added a couple of new checks, 		removed a few commented-out checks for functions that 		no longer exist, added test-skip capability. 	Modified by cmetz for OPIE 2.3. Use new calling conventions for 		opiebtoa8()/atob8(). opiegenerator() outputs hex now. 	Modified by cmetz for OPIE 2.22. Test opielock()/opieunlock() 		refcount support. 	Created by cmetz for OPIE 2.2. */
end_comment

begin_include
include|#
directive|include
file|"opie_cfg.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"opie.h"
end_include

begin_decl_stmt
name|char
name|buffer
index|[
literal|1024
index|]
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|testatob8
parameter_list|()
block|{
specifier|static
name|char
name|testin
index|[]
init|=
literal|"0123456789abcdef"
decl_stmt|;
specifier|static
name|unsigned
name|char
name|testout
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
index|]
init|=
block|{
literal|0x01
block|,
literal|0x23
block|,
literal|0x45
block|,
literal|0x67
block|,
literal|0x89
block|,
literal|0xab
block|,
literal|0xcd
block|,
literal|0xef
block|}
decl_stmt|;
name|struct
name|opie_otpkey
name|key
decl_stmt|;
if|if
condition|(
operator|!
name|opieatob8
argument_list|(
operator|&
name|key
argument_list|,
name|testin
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|key
argument_list|,
name|testout
argument_list|,
sizeof|sizeof
argument_list|(
name|testout
argument_list|)
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|testbtoa8
parameter_list|()
block|{
specifier|static
name|unsigned
name|char
name|testin
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
index|]
init|=
block|{
literal|0x01
block|,
literal|0x23
block|,
literal|0x45
block|,
literal|0x67
block|,
literal|0x89
block|,
literal|0xab
block|,
literal|0xcd
block|,
literal|0xef
block|}
decl_stmt|;
specifier|static
name|char
name|testout
index|[]
init|=
literal|"0123456789abcdef"
decl_stmt|;
name|struct
name|opie_otpkey
name|testin_aligned
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|testin_aligned
argument_list|,
name|testin
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opiebtoa8
argument_list|(
name|buffer
argument_list|,
operator|&
name|testin_aligned
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|memcmp
argument_list|(
name|buffer
argument_list|,
name|testout
argument_list|,
sizeof|sizeof
argument_list|(
name|testout
argument_list|)
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|testbtoe
parameter_list|()
block|{
specifier|static
name|unsigned
name|char
name|testin
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
index|]
init|=
block|{
literal|0x01
block|,
literal|0x23
block|,
literal|0x45
block|,
literal|0x67
block|,
literal|0x89
block|,
literal|0xab
block|,
literal|0xcd
block|,
literal|0xef
block|}
decl_stmt|;
specifier|static
name|char
name|testout
index|[]
init|=
literal|"AIM HEW BLUM FED MITE WARM"
decl_stmt|;
name|struct
name|opie_otpkey
name|testin_aligned
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|testin_aligned
argument_list|,
name|testin
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opiebtoe
argument_list|(
name|buffer
argument_list|,
operator|&
name|testin_aligned
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|memcmp
argument_list|(
name|buffer
argument_list|,
name|testout
argument_list|,
sizeof|sizeof
argument_list|(
name|testout
argument_list|)
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|testetob
parameter_list|()
block|{
specifier|static
name|char
name|testin
index|[]
init|=
literal|"AIM HEW BLUM FED MITE WARM"
decl_stmt|;
specifier|static
name|unsigned
name|char
name|testout
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
index|]
init|=
block|{
literal|0x01
block|,
literal|0x23
block|,
literal|0x45
block|,
literal|0x67
block|,
literal|0x89
block|,
literal|0xab
block|,
literal|0xcd
block|,
literal|0xef
block|}
decl_stmt|;
name|struct
name|opie_otpkey
name|key
decl_stmt|;
if|if
condition|(
name|opieetob
argument_list|(
operator|&
name|key
argument_list|,
name|testin
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|key
argument_list|,
name|testout
argument_list|,
sizeof|sizeof
argument_list|(
name|testout
argument_list|)
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|testgenerator
parameter_list|()
block|{
specifier|static
name|char
name|testin1
index|[]
init|=
literal|"otp-md5 123 ke1234"
decl_stmt|;
specifier|static
name|char
name|testin2
index|[]
init|=
literal|"this is a test"
decl_stmt|;
comment|/*  static char testout[] = "END KERN BALM NICK EROS WAVY"; */
specifier|static
name|char
name|testout
index|[]
init|=
literal|"11D4 C147 E227 C1F1"
decl_stmt|;
if|if
condition|(
name|opiegenerator
argument_list|(
name|testin1
argument_list|,
name|testin2
argument_list|,
name|buffer
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|memcmp
argument_list|(
name|buffer
argument_list|,
name|testout
argument_list|,
sizeof|sizeof
argument_list|(
name|testout
argument_list|)
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|testgetsequence
parameter_list|()
block|{
name|struct
name|opie
name|testin
decl_stmt|;
name|testin
operator|.
name|opie_n
operator|=
literal|42
expr_stmt|;
if|if
condition|(
name|opiegetsequence
argument_list|(
operator|&
name|testin
argument_list|)
operator|!=
literal|42
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|testhashmd4
parameter_list|()
block|{
specifier|static
name|unsigned
name|char
name|testin
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
index|]
init|=
block|{
literal|0x01
block|,
literal|0x23
block|,
literal|0x45
block|,
literal|0x67
block|,
literal|0x89
block|,
literal|0xab
block|,
literal|0xcd
block|,
literal|0xef
block|}
decl_stmt|;
specifier|static
name|unsigned
name|char
name|testout
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
index|]
init|=
block|{
literal|0x9f
block|,
literal|0x40
block|,
literal|0xfb
block|,
literal|0x84
block|,
literal|0xb
block|,
literal|0xf8
block|,
literal|0x7f
block|,
literal|0x4b
block|}
decl_stmt|;
name|struct
name|opie_otpkey
name|testin_aligned
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|testin_aligned
argument_list|,
name|testin
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
argument_list|)
expr_stmt|;
name|opiehash
argument_list|(
operator|&
name|testin_aligned
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|testin_aligned
argument_list|,
name|testout
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|testhashmd5
parameter_list|()
block|{
specifier|static
name|unsigned
name|char
name|testin
index|[]
init|=
block|{
literal|0x01
block|,
literal|0x23
block|,
literal|0x45
block|,
literal|0x67
block|,
literal|0x89
block|,
literal|0xab
block|,
literal|0xcd
block|,
literal|0xef
block|}
decl_stmt|;
specifier|static
name|unsigned
name|char
name|testout
index|[]
init|=
block|{
literal|0x78
block|,
literal|0xdd
block|,
literal|0x1a
block|,
literal|0x37
block|,
literal|0xf8
block|,
literal|0x91
block|,
literal|0x54
block|,
literal|0xe1
block|}
decl_stmt|;
name|struct
name|opie_otpkey
name|testin_aligned
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|testin_aligned
argument_list|,
name|testin
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
argument_list|)
expr_stmt|;
name|opiehash
argument_list|(
operator|&
name|testin_aligned
argument_list|,
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|testin_aligned
argument_list|,
name|testout
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|testinsecure
parameter_list|()
block|{
name|opieinsecure
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|testkeycrunch
parameter_list|()
block|{
specifier|static
name|char
name|testin1
index|[]
init|=
literal|"ke1234"
decl_stmt|;
specifier|static
name|char
name|testin2
index|[]
init|=
literal|"this is a test"
decl_stmt|;
specifier|static
name|unsigned
name|char
name|testout
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
index|]
init|=
block|{
literal|0x2e
block|,
literal|0xd3
block|,
literal|0x5d
block|,
literal|0x74
block|,
literal|0x3e
block|,
literal|0xa9
block|,
literal|0xe9
block|,
literal|0xe8
block|}
decl_stmt|;
name|struct
name|opie_otpkey
name|opie_otpkey
decl_stmt|;
if|if
condition|(
name|opiekeycrunch
argument_list|(
literal|5
argument_list|,
operator|&
name|opie_otpkey
argument_list|,
name|testin1
argument_list|,
name|testin2
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|opie_otpkey
argument_list|,
name|testout
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|opie_otpkey
argument_list|)
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|testlock
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|getuid
argument_list|()
condition|)
return|return
operator|-
literal|2
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|opielock
argument_list|(
literal|"__opietest"
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|testpasscheck
parameter_list|()
block|{
specifier|static
name|char
name|testin1
index|[]
init|=
literal|"abadone"
decl_stmt|;
specifier|static
name|char
name|testin2
index|[]
init|=
literal|"A more reasonable choice."
decl_stmt|;
if|if
condition|(
operator|!
name|opiepasscheck
argument_list|(
name|testin1
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|opiepasscheck
argument_list|(
name|testin2
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|testrandomchallenge
parameter_list|()
block|{
name|char
name|buffer
index|[
name|OPIE_CHALLENGE_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|opierandomchallenge
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|buffer
argument_list|,
literal|"otp-"
argument_list|,
literal|4
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|testunlock
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|getuid
argument_list|()
condition|)
return|return
operator|-
literal|2
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|opieunlock
argument_list|()
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|opieunlock
argument_list|()
operator|!=
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
name|opietest
block|{
name|int
function_decl|(
modifier|*
name|f
function_decl|)
parameter_list|()
function_decl|;
name|char
modifier|*
name|n
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|opietest
name|opietests
index|[]
init|=
block|{
block|{
name|testatob8
block|,
literal|"atob8"
block|}
block|,
block|{
name|testbtoa8
block|,
literal|"btoa8"
block|}
block|,
block|{
name|testbtoe
block|,
literal|"btoe"
block|}
block|,
block|{
name|testetob
block|,
literal|"etob"
block|}
block|,
comment|/*  { testchallenge, "challenge" }, */
block|{
name|testgenerator
block|,
literal|"generator"
block|}
block|,
block|{
name|testgetsequence
block|,
literal|"getsequence"
block|}
block|,
block|{
name|testhashmd4
block|,
literal|"hash(MD4)"
block|}
block|,
block|{
name|testhashmd5
block|,
literal|"hash(MD5)"
block|}
block|,
block|{
name|testinsecure
block|,
literal|"insecure"
block|}
block|,
block|{
name|testkeycrunch
block|,
literal|"keycrunch"
block|}
block|,
block|{
name|testlock
block|,
literal|"lock"
block|}
block|,
block|{
name|testrandomchallenge
block|,
literal|"randomchallenge"
block|}
block|,
comment|/* { testreadpass, "readpass" }, */
block|{
name|testunlock
block|,
literal|"unlock"
block|}
block|,
comment|/*  { testverify, "verify" }, */
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
decl|main
name|FUNCTION
argument_list|(
operator|(
name|argc
operator|,
name|argv
operator|)
argument_list|,
name|int
name|argc
name|AND
name|char
operator|*
name|argv
index|[]
argument_list|)
block|{
name|struct
name|opietest
modifier|*
name|opietest
decl_stmt|;
name|int
name|tests_passed
init|=
literal|0
decl_stmt|;
name|int
name|tests_failed
init|=
literal|0
decl_stmt|;
name|int
name|tests_skipped
init|=
literal|0
decl_stmt|;
name|int
name|ntests
init|=
literal|0
decl_stmt|,
name|testn
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|getuid
argument_list|()
operator|!=
name|geteuid
argument_list|()
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"opietest: do not make this program setuid!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
for|for
control|(
name|opietest
operator|=
name|opietests
init|;
name|opietest
operator|->
name|n
condition|;
name|opietest
operator|++
control|)
name|ntests
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"opietest: executing %d tests\n"
argument_list|,
name|ntests
argument_list|)
expr_stmt|;
for|for
control|(
name|opietest
operator|=
name|opietests
operator|,
name|testn
operator|=
literal|1
init|;
name|opietest
operator|->
name|n
condition|;
name|opietest
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"(%2d/%2d) testing opie%s... "
argument_list|,
name|testn
operator|++
argument_list|,
name|ntests
argument_list|,
name|opietest
operator|->
name|n
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|opietest
operator|->
name|f
argument_list|()
condition|)
block|{
case|case
operator|-
literal|2
case|:
name|printf
argument_list|(
literal|"skipped\n"
argument_list|)
expr_stmt|;
name|tests_skipped
operator|++
expr_stmt|;
name|opietest
operator|->
name|f
operator|=
name|NULL
expr_stmt|;
break|break;
case|case
operator|-
literal|1
case|:
name|printf
argument_list|(
literal|"FAILED!\n"
argument_list|)
expr_stmt|;
name|tests_failed
operator|++
expr_stmt|;
break|break;
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"passed\n"
argument_list|)
expr_stmt|;
name|tests_passed
operator|++
expr_stmt|;
name|opietest
operator|->
name|f
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
block|}
name|printf
argument_list|(
literal|"opietest: completed %d tests. %d tests passed, %d tests skipped, %d tests failed.\n"
argument_list|,
name|ntests
argument_list|,
name|tests_passed
argument_list|,
name|tests_skipped
argument_list|,
name|tests_failed
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests_failed
condition|)
block|{
name|printf
argument_list|(
literal|"opietest: please correct the following failures before attempting to use OPIE:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|opietest
operator|=
name|opietests
init|;
name|opietest
operator|->
name|n
condition|;
name|opietest
operator|++
control|)
if|if
condition|(
name|opietest
operator|->
name|f
condition|)
name|printf
argument_list|(
literal|"          opie%s\n"
argument_list|,
name|opietest
operator|->
name|n
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_decl_stmt

end_unit


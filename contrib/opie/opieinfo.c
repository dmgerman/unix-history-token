begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* opieinfo: Print a user's current OPIE sequence number and seed  %%% portions-copyright-cmetz-96 Portions of this software are Copyright 1996-1999 by Craig Metz, All Rights Reserved. The Inner Net License Version 2 applies to these portions of the software. You should have received a copy of the license with this software. If you didn't get a copy, you may request one from<license@inner.net>.  Portions of this software are Copyright 1995 by Randall Atkinson and Dan McDonald, All Rights Reserved. All Rights under this copyright are assigned to the U.S. Naval Research Laboratory (NRL). The NRL Copyright Notice and License Agreement applies to this software.  	History:  	Modified by cmetz for OPIE 2.3. Removed unneeded debug message. 	Modified by cmetz for OPIE 2.2. Use FUNCTION definition et al.                Fixed include order. Make everything static. Ifdef around                some headers.         Modified at NRL for OPIE 2.1. Substitute @@KEY_FILE@@. Re-write in 	       C.         Modified at NRL for OPIE 2.01. Remove hard-coded paths for grep and                awk and let PATH take care of it. Substitute for Makefile                 variables $(EXISTS) and $(KEY_FILE). Only compute $WHO if                 there's a key file. Got rid of grep since awk can do the job                itself. 	Modified at NRL for OPIE 2.0. 	Written at Bellcore for the S/Key Version 1 software distribution 		(keyinfo)  $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opie_cfg.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_if
if|#
directive|if
name|HAVE_UNISTD_H
end_if

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_UNISTD_H */
end_comment

begin_include
include|#
directive|include
file|"opie.h"
end_include

begin_comment
comment|/* extern char *optarg; */
end_comment

begin_comment
comment|/* extern int errno, optind; */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|getusername
name|FUNCTION_NOARGS
block|{
name|char
modifier|*
name|login
decl_stmt|;
name|login
operator|=
name|getlogin
argument_list|()
expr_stmt|;
if|if
condition|(
name|login
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot find login name\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|login
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|int
decl|main
name|FUNCTION
argument_list|(
operator|(
name|argc
operator|,
name|argv
operator|)
argument_list|,
name|int
name|argc
name|AND
name|char
operator|*
name|argv
index|[]
argument_list|)
block|{
name|char
modifier|*
name|username
decl_stmt|;
name|struct
name|opie
name|opie
decl_stmt|;
name|int
name|i
decl_stmt|;
while|while
condition|(
operator|(
name|i
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"hv"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|'v'
case|:
name|opieversion
argument_list|()
expr_stmt|;
case|case
literal|'h'
case|:
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [-h] [-v] [user_name]\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|optind
operator|<
name|argc
condition|)
block|{
if|if
condition|(
name|getuid
argument_list|()
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Only superuser may get another user's keys\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|username
operator|=
name|argv
index|[
name|optind
index|]
expr_stmt|;
block|}
else|else
name|username
operator|=
name|getusername
argument_list|()
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|username
argument_list|)
operator|>=
name|MAXLOGNAME
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Username too long.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|i
operator|=
name|opielookup
argument_list|(
operator|&
name|opie
argument_list|,
name|username
argument_list|)
operator|)
operator|&&
operator|(
name|i
operator|!=
literal|2
operator|)
condition|)
block|{
if|if
condition|(
name|i
operator|<
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error opening database! (errno = %d)\n"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s not found in database.\n"
argument_list|,
name|username
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%d %s\n"
argument_list|,
name|opie
operator|.
name|opie_n
operator|-
literal|1
argument_list|,
name|opie
operator|.
name|opie_seed
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   * tclUnixTime.c --  *  *	Contains Unix specific versions of Tcl functions that  *	obtain time values from the operating system.  *  * Copyright (c) 1995 Sun Microsystems, Inc.  *  * See the file "license.terms" for information on usage and redistribution  * of this file, and for a DISCLAIMER OF ALL WARRANTIES.  *  * SCCS: @(#) tclUnixTime.c 1.13 97/10/31 15:04:58  */
end_comment

begin_include
include|#
directive|include
file|"tclInt.h"
end_include

begin_include
include|#
directive|include
file|"tclPort.h"
end_include

begin_escape
end_escape

begin_comment
comment|/*  *-----------------------------------------------------------------------------  *  * TclpGetSeconds --  *  *	This procedure returns the number of seconds from the epoch.  On  *	most Unix systems the epoch is Midnight Jan 1, 1970 GMT.  *  * Results:  *	Number of seconds from the epoch.  *  * Side effects:  *	None.  *  *-----------------------------------------------------------------------------  */
end_comment

begin_function
name|unsigned
name|long
name|TclpGetSeconds
parameter_list|()
block|{
return|return
name|time
argument_list|(
operator|(
name|time_t
operator|*
operator|)
name|NULL
argument_list|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *-----------------------------------------------------------------------------  *  * TclpGetClicks --  *  *	This procedure returns a value that represents the highest resolution  *	clock available on the system.  There are no garantees on what the  *	resolution will be.  In Tcl we will call this value a "click".  The  *	start time is also system dependant.  *  * Results:  *	Number of clicks from some start time.  *  * Side effects:  *	None.  *  *-----------------------------------------------------------------------------  */
end_comment

begin_function
name|unsigned
name|long
name|TclpGetClicks
parameter_list|()
block|{
name|unsigned
name|long
name|now
decl_stmt|;
ifdef|#
directive|ifdef
name|NO_GETTOD
name|struct
name|tms
name|dummy
decl_stmt|;
else|#
directive|else
name|struct
name|timeval
name|date
decl_stmt|;
name|struct
name|timezone
name|tz
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NO_GETTOD
name|now
operator|=
operator|(
name|unsigned
name|long
operator|)
name|times
argument_list|(
operator|&
name|dummy
argument_list|)
expr_stmt|;
else|#
directive|else
name|gettimeofday
argument_list|(
operator|&
name|date
argument_list|,
operator|&
name|tz
argument_list|)
expr_stmt|;
name|now
operator|=
name|date
operator|.
name|tv_sec
operator|*
literal|1000000
operator|+
name|date
operator|.
name|tv_usec
expr_stmt|;
endif|#
directive|endif
return|return
name|now
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * TclpGetTimeZone --  *  *	Determines the current timezone.  The method varies wildly  *	between different platform implementations, so its hidden in  *	this function.  *  * Results:  *	The return value is the local time zone, measured in  *	minutes away from GMT (-ve for east, +ve for west).  *  * Side effects:  *	None.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
name|int
name|TclpGetTimeZone
parameter_list|(
name|currentTime
parameter_list|)
name|unsigned
name|long
name|currentTime
decl_stmt|;
block|{
comment|/*      * Determine how a timezone is obtained from "struct tm".  If there is no      * time zone in this struct (very lame) then use the timezone variable.      * This is done in a way to make the timezone variable the method of last      * resort, as some systems have it in addition to a field in "struct tm".      * The gettimeofday system call can also be used to determine the time      * zone.      */
if|#
directive|if
name|defined
argument_list|(
name|HAVE_TM_TZADJ
argument_list|)
define|#
directive|define
name|TCL_GOT_TIMEZONE
name|time_t
name|curTime
init|=
operator|(
name|time_t
operator|)
name|currentTime
decl_stmt|;
name|struct
name|tm
modifier|*
name|timeDataPtr
init|=
name|localtime
argument_list|(
operator|&
name|curTime
argument_list|)
decl_stmt|;
name|int
name|timeZone
decl_stmt|;
name|timeZone
operator|=
name|timeDataPtr
operator|->
name|tm_tzadj
operator|/
literal|60
expr_stmt|;
if|if
condition|(
name|timeDataPtr
operator|->
name|tm_isdst
condition|)
block|{
name|timeZone
operator|+=
literal|60
expr_stmt|;
block|}
return|return
name|timeZone
return|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|HAVE_TM_GMTOFF
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|TCL_GOT_TIMEZONE
argument_list|)
define|#
directive|define
name|TCL_GOT_TIMEZONE
name|time_t
name|curTime
init|=
operator|(
name|time_t
operator|)
name|currentTime
decl_stmt|;
name|struct
name|tm
modifier|*
name|timeDataPtr
init|=
name|localtime
argument_list|(
operator|&
name|curTime
argument_list|)
decl_stmt|;
name|int
name|timeZone
decl_stmt|;
name|timeZone
operator|=
operator|-
operator|(
name|timeDataPtr
operator|->
name|tm_gmtoff
operator|/
literal|60
operator|)
expr_stmt|;
if|if
condition|(
name|timeDataPtr
operator|->
name|tm_isdst
condition|)
block|{
name|timeZone
operator|+=
literal|60
expr_stmt|;
block|}
return|return
name|timeZone
return|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|USE_DELTA_FOR_TZ
argument_list|)
define|#
directive|define
name|TCL_GOT_TIMEZONE
value|1
comment|/*      * This hack replaces using global var timezone or gettimeofday      * in situations where they are buggy such as on AIX when libbsd.a      * is linked in.      */
name|int
name|timeZone
decl_stmt|;
name|time_t
name|tt
decl_stmt|;
name|struct
name|tm
modifier|*
name|stm
decl_stmt|;
name|tt
operator|=
literal|849268800L
expr_stmt|;
comment|/*    1996-11-29 12:00:00  GMT */
name|stm
operator|=
name|localtime
argument_list|(
operator|&
name|tt
argument_list|)
expr_stmt|;
comment|/* eg 1996-11-29  6:00:00  CST6CDT */
comment|/* The calculation below assumes a max of +12 or -12 hours from GMT */
name|timeZone
operator|=
operator|(
literal|12
operator|-
name|stm
operator|->
name|tm_hour
operator|)
operator|*
literal|60
operator|+
operator|(
literal|0
operator|-
name|stm
operator|->
name|tm_min
operator|)
expr_stmt|;
return|return
name|timeZone
return|;
comment|/* eg +360 for CST6CDT */
endif|#
directive|endif
comment|/*      * Must prefer timezone variable over gettimeofday, as gettimeofday does      * not return timezone information on many systems that have moved this      * information outside of the kernel.      */
if|#
directive|if
name|defined
argument_list|(
name|HAVE_TIMEZONE_VAR
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|TCL_GOT_TIMEZONE
argument_list|)
define|#
directive|define
name|TCL_GOT_TIMEZONE
specifier|static
name|int
name|setTZ
init|=
literal|0
decl_stmt|;
name|int
name|timeZone
decl_stmt|;
if|if
condition|(
operator|!
name|setTZ
condition|)
block|{
name|tzset
argument_list|()
expr_stmt|;
name|setTZ
operator|=
literal|1
expr_stmt|;
block|}
comment|/*      * Note: this is not a typo in "timezone" below!  See tzset      * documentation for details.      */
name|timeZone
operator|=
name|timezone
operator|/
literal|60
expr_stmt|;
return|return
name|timeZone
return|;
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|NO_GETTOD
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|TCL_GOT_TIMEZONE
argument_list|)
define|#
directive|define
name|TCL_GOT_TIMEZONE
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|timezone
name|tz
decl_stmt|;
name|int
name|timeZone
decl_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
operator|&
name|tz
argument_list|)
expr_stmt|;
name|timeZone
operator|=
name|tz
operator|.
name|tz_minuteswest
expr_stmt|;
if|if
condition|(
name|tz
operator|.
name|tz_dsttime
condition|)
block|{
name|timeZone
operator|+=
literal|60
expr_stmt|;
block|}
return|return
name|timeZone
return|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|TCL_GOT_TIMEZONE
comment|/*      * Cause compile error, we don't know how to get timezone.      */
name|error
label|:
name|autoconf
name|did
name|not
name|figure
name|out
name|how
name|to
name|determine
name|the
name|timezone
operator|.
endif|#
directive|endif
expr|}
comment|/*  *----------------------------------------------------------------------  *  * TclpGetTime --  *  *	Gets the current system time in seconds and microseconds  *	since the beginning of the epoch: 00:00 UCT, January 1, 1970.  *  * Results:  *	Returns the current time in timePtr.  *  * Side effects:  *	None.  *  *----------------------------------------------------------------------  */
name|void
name|TclpGetTime
argument_list|(
argument|timePtr
argument_list|)
name|Tcl_Time
operator|*
name|timePtr
expr_stmt|;
comment|/* Location to store time information. */
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|timezone
name|tz
decl_stmt|;
operator|(
name|void
operator|)
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
operator|&
name|tz
argument_list|)
expr_stmt|;
name|timePtr
operator|->
name|sec
operator|=
name|tv
operator|.
name|tv_sec
expr_stmt|;
name|timePtr
operator|->
name|usec
operator|=
name|tv
operator|.
name|tv_usec
expr_stmt|;
block|}
end_function

end_unit


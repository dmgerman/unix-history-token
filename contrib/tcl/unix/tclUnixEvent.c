begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   * tclUnixEvent.c --  *  *	This file implements Unix specific event related routines.  *  * Copyright (c) 1997 by Sun Microsystems, Inc.  *  * See the file "license.terms" for information on usage and redistribution  * of this file, and for a DISCLAIMER OF ALL WARRANTIES.  *  * SCCS: @(#) tclUnixEvent.c 1.1 97/03/04 14:19:34  */
end_comment

begin_include
include|#
directive|include
file|"tclInt.h"
end_include

begin_include
include|#
directive|include
file|"tclPort.h"
end_include

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * Tcl_Sleep --  *  *	Delay execution for the specified number of milliseconds.  *  * Results:  *	None.  *  * Side effects:  *	Time passes.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
name|void
name|Tcl_Sleep
parameter_list|(
name|ms
parameter_list|)
name|int
name|ms
decl_stmt|;
comment|/* Number of milliseconds to sleep. */
block|{
specifier|static
name|struct
name|timeval
name|delay
decl_stmt|;
name|Tcl_Time
name|before
decl_stmt|,
name|after
decl_stmt|;
comment|/*      * The only trick here is that select appears to return early      * under some conditions, so we have to check to make sure that      * the right amount of time really has elapsed.  If it's too      * early, go back to sleep again.      */
name|TclpGetTime
argument_list|(
operator|&
name|before
argument_list|)
expr_stmt|;
name|after
operator|=
name|before
expr_stmt|;
name|after
operator|.
name|sec
operator|+=
name|ms
operator|/
literal|1000
expr_stmt|;
name|after
operator|.
name|usec
operator|+=
operator|(
name|ms
operator|%
literal|1000
operator|)
operator|*
literal|1000
expr_stmt|;
if|if
condition|(
name|after
operator|.
name|usec
operator|>
literal|1000000
condition|)
block|{
name|after
operator|.
name|usec
operator|-=
literal|1000000
expr_stmt|;
name|after
operator|.
name|sec
operator|+=
literal|1
expr_stmt|;
block|}
while|while
condition|(
literal|1
condition|)
block|{
name|delay
operator|.
name|tv_sec
operator|=
name|after
operator|.
name|sec
operator|-
name|before
operator|.
name|sec
expr_stmt|;
name|delay
operator|.
name|tv_usec
operator|=
name|after
operator|.
name|usec
operator|-
name|before
operator|.
name|usec
expr_stmt|;
if|if
condition|(
name|delay
operator|.
name|tv_usec
operator|<
literal|0
condition|)
block|{
name|delay
operator|.
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
name|delay
operator|.
name|tv_sec
operator|-=
literal|1
expr_stmt|;
block|}
comment|/* 	 * Special note:  must convert delay.tv_sec to int before comparing 	 * to zero, since delay.tv_usec is unsigned on some platforms. 	 */
if|if
condition|(
operator|(
operator|(
operator|(
name|int
operator|)
name|delay
operator|.
name|tv_sec
operator|)
operator|<
literal|0
operator|)
operator|||
operator|(
operator|(
name|delay
operator|.
name|tv_usec
operator|==
literal|0
operator|)
operator|&&
operator|(
name|delay
operator|.
name|tv_sec
operator|==
literal|0
operator|)
operator|)
condition|)
block|{
break|break;
block|}
operator|(
name|void
operator|)
name|select
argument_list|(
literal|0
argument_list|,
operator|(
name|SELECT_MASK
operator|*
operator|)
literal|0
argument_list|,
operator|(
name|SELECT_MASK
operator|*
operator|)
literal|0
argument_list|,
operator|(
name|SELECT_MASK
operator|*
operator|)
literal|0
argument_list|,
operator|&
name|delay
argument_list|)
expr_stmt|;
name|TclpGetTime
argument_list|(
operator|&
name|before
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   * tclEnv.c --  *  *	Tcl support for environment variables, including a setenv  *	procedure.  This file contains the generic portion of the  *	environment module.  It is primarily responsible for keeping  *	the "env" arrays in sync with the system environment variables.  *  * Copyright (c) 1991-1994 The Regents of the University of California.  * Copyright (c) 1994-1996 Sun Microsystems, Inc.  *  * See the file "license.terms" for information on usage and redistribution  * of this file, and for a DISCLAIMER OF ALL WARRANTIES.  *  * SCCS: @(#) tclEnv.c 1.49 97/08/11 20:22:40  */
end_comment

begin_include
include|#
directive|include
file|"tclInt.h"
end_include

begin_include
include|#
directive|include
file|"tclPort.h"
end_include

begin_comment
comment|/*  * The structure below is used to keep track of all of the interpereters  * for which we're managing the "env" array.  It's needed so that they  * can all be updated whenever an environment variable is changed  * anywhere.  */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|EnvInterp
block|{
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
comment|/* Interpreter for which we're managing 				 * the env array. */
name|struct
name|EnvInterp
modifier|*
name|nextPtr
decl_stmt|;
comment|/* Next in list of all such interpreters, 				 * or zero. */
block|}
name|EnvInterp
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|EnvInterp
modifier|*
name|firstInterpPtr
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* First in list of all managed interpreters, 				 * or NULL if none. */
end_comment

begin_decl_stmt
specifier|static
name|int
name|cacheSize
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Number of env strings in environCache. */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
modifier|*
name|environCache
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Array containing all of the environment 				 * strings that Tcl has allocated. */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|USE_PUTENV
end_ifndef

begin_decl_stmt
specifier|static
name|int
name|environSize
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Non-zero means that the environ array was 				 * malloced and has this many total entries 				 * allocated to it (not all may be in use at 				 * once).  Zero means that the environment 				 * array is in its original static state. */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Declarations for local procedures defined in this file:  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|EnvTraceProc
name|_ANSI_ARGS_
argument_list|(
operator|(
name|ClientData
name|clientData
operator|,
name|Tcl_Interp
operator|*
name|interp
operator|,
name|char
operator|*
name|name1
operator|,
name|char
operator|*
name|name2
operator|,
name|int
name|flags
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|FindVariable
name|_ANSI_ARGS_
argument_list|(
operator|(
name|CONST
name|char
operator|*
name|name
operator|,
name|int
operator|*
name|lengthPtr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ReplaceString
name|_ANSI_ARGS_
argument_list|(
operator|(
name|CONST
name|char
operator|*
name|oldStr
operator|,
name|char
operator|*
name|newStr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|TclSetEnv
name|_ANSI_ARGS_
argument_list|(
operator|(
name|CONST
name|char
operator|*
name|name
operator|,
name|CONST
name|char
operator|*
name|value
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|TclUnsetEnv
name|_ANSI_ARGS_
argument_list|(
operator|(
name|CONST
name|char
operator|*
name|name
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * TclSetupEnv --  *  *	This procedure is invoked for an interpreter to make environment  *	variables accessible from that interpreter via the "env"  *	associative array.  *  * Results:  *	None.  *  * Side effects:  *	The interpreter is added to a list of interpreters managed  *	by us, so that its view of envariables can be kept consistent  *	with the view in other interpreters.  If this is the first  *	call to Tcl_SetupEnv, then additional initialization happens,  *	such as copying the environment to dynamically-allocated space  *	for ease of management.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
name|void
name|TclSetupEnv
parameter_list|(
name|interp
parameter_list|)
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
comment|/* Interpreter whose "env" array is to be 				 * managed. */
block|{
name|EnvInterp
modifier|*
name|eiPtr
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|p2
decl_stmt|;
name|Tcl_DString
name|ds
decl_stmt|;
name|int
name|i
decl_stmt|,
name|sz
decl_stmt|;
ifdef|#
directive|ifdef
name|MAC_TCL
if|if
condition|(
name|environ
operator|==
name|NULL
condition|)
block|{
name|environSize
operator|=
name|TclMacCreateEnv
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
comment|/*      * Next, initialize the DString we are going to use for copying      * the names of the environment variables.      */
name|Tcl_DStringInit
argument_list|(
operator|&
name|ds
argument_list|)
expr_stmt|;
comment|/*      * Next, add the interpreter to the list of those that we manage.      */
name|eiPtr
operator|=
operator|(
name|EnvInterp
operator|*
operator|)
name|ckalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|EnvInterp
argument_list|)
argument_list|)
expr_stmt|;
name|eiPtr
operator|->
name|interp
operator|=
name|interp
expr_stmt|;
name|eiPtr
operator|->
name|nextPtr
operator|=
name|firstInterpPtr
expr_stmt|;
name|firstInterpPtr
operator|=
name|eiPtr
expr_stmt|;
comment|/*      * Store the environment variable values into the interpreter's      * "env" array, and arrange for us to be notified on future      * writes and unsets to that array.      */
operator|(
name|void
operator|)
name|Tcl_UnsetVar2
argument_list|(
name|interp
argument_list|,
literal|"env"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|TCL_GLOBAL_ONLY
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
name|environ
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
for|for
control|(
name|p2
operator|=
name|p
init|;
operator|*
name|p2
operator|!=
literal|'='
condition|;
name|p2
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|p2
operator|==
literal|0
condition|)
block|{
comment|/* 		 * This condition doesn't seem like it should ever happen, 		 * but it does seem to happen occasionally under some 		 * versions of Solaris; ignore the entry. 		 */
goto|goto
name|nextEntry
goto|;
block|}
block|}
name|sz
operator|=
name|p2
operator|-
name|p
expr_stmt|;
name|Tcl_DStringSetLength
argument_list|(
operator|&
name|ds
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|Tcl_DStringAppend
argument_list|(
operator|&
name|ds
argument_list|,
name|p
argument_list|,
name|sz
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|Tcl_SetVar2
argument_list|(
name|interp
argument_list|,
literal|"env"
argument_list|,
name|Tcl_DStringValue
argument_list|(
operator|&
name|ds
argument_list|)
argument_list|,
name|p2
operator|+
literal|1
argument_list|,
name|TCL_GLOBAL_ONLY
argument_list|)
expr_stmt|;
name|nextEntry
label|:
continue|continue;
block|}
name|Tcl_TraceVar2
argument_list|(
name|interp
argument_list|,
literal|"env"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|TCL_GLOBAL_ONLY
operator||
name|TCL_TRACE_WRITES
operator||
name|TCL_TRACE_UNSETS
argument_list|,
name|EnvTraceProc
argument_list|,
operator|(
name|ClientData
operator|)
name|NULL
argument_list|)
expr_stmt|;
comment|/*      * Finally clean up the DString.      */
name|Tcl_DStringFree
argument_list|(
operator|&
name|ds
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * TclSetEnv --  *  *	Set an environment variable, replacing an existing value  *	or creating a new variable if there doesn't exist a variable  *	by the given name.  This procedure is intended to be a  *	stand-in for the  UNIX "setenv" procedure so that applications  *	using that procedure will interface properly to Tcl.  To make  *	it a stand-in, the Makefile must define "TclSetEnv" to "setenv".  *  * Results:  *	None.  *  * Side effects:  *	The environ array gets updated, as do all of the interpreters  *	that we manage.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
name|void
name|TclSetEnv
parameter_list|(
name|name
parameter_list|,
name|value
parameter_list|)
name|CONST
name|char
modifier|*
name|name
decl_stmt|;
comment|/* Name of variable whose value is to be 				 * set. */
name|CONST
name|char
modifier|*
name|value
decl_stmt|;
comment|/* New value for variable. */
block|{
name|int
name|index
decl_stmt|,
name|length
decl_stmt|,
name|nameLength
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|oldValue
decl_stmt|;
name|EnvInterp
modifier|*
name|eiPtr
decl_stmt|;
ifdef|#
directive|ifdef
name|MAC_TCL
if|if
condition|(
name|environ
operator|==
name|NULL
condition|)
block|{
name|environSize
operator|=
name|TclMacCreateEnv
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
comment|/*      * Figure out where the entry is going to go.  If the name doesn't      * already exist, enlarge the array if necessary to make room.  If      * the name exists, free its old entry.      */
name|index
operator|=
name|FindVariable
argument_list|(
name|name
argument_list|,
operator|&
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|==
operator|-
literal|1
condition|)
block|{
ifndef|#
directive|ifndef
name|USE_PUTENV
if|if
condition|(
operator|(
name|length
operator|+
literal|2
operator|)
operator|>
name|environSize
condition|)
block|{
name|char
modifier|*
modifier|*
name|newEnviron
decl_stmt|;
name|newEnviron
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|ckalloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
operator|(
name|length
operator|+
literal|5
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|VOID
operator|*
operator|)
name|newEnviron
argument_list|,
operator|(
name|VOID
operator|*
operator|)
name|environ
argument_list|,
name|length
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|environSize
operator|!=
literal|0
condition|)
block|{
name|ckfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|environ
argument_list|)
expr_stmt|;
block|}
name|environ
operator|=
name|newEnviron
expr_stmt|;
name|environSize
operator|=
name|length
operator|+
literal|5
expr_stmt|;
block|}
name|index
operator|=
name|length
expr_stmt|;
name|environ
index|[
name|index
operator|+
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
name|oldValue
operator|=
name|NULL
expr_stmt|;
name|nameLength
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 	 * Compare the new value to the existing value.  If they're 	 * the same then quit immediately (e.g. don't rewrite the 	 * value or propagate it to other interpreters).  Otherwise, 	 * when there are N interpreters there will be N! propagations 	 * of the same value among the interpreters. 	 */
if|if
condition|(
name|strcmp
argument_list|(
name|value
argument_list|,
name|environ
index|[
name|index
index|]
operator|+
name|length
operator|+
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return;
block|}
name|oldValue
operator|=
name|environ
index|[
name|index
index|]
expr_stmt|;
name|nameLength
operator|=
name|length
expr_stmt|;
block|}
comment|/*      * Update all of the interpreters.      */
for|for
control|(
name|eiPtr
operator|=
name|firstInterpPtr
init|;
name|eiPtr
operator|!=
name|NULL
condition|;
name|eiPtr
operator|=
name|eiPtr
operator|->
name|nextPtr
control|)
block|{
operator|(
name|void
operator|)
name|Tcl_SetVar2
argument_list|(
name|eiPtr
operator|->
name|interp
argument_list|,
literal|"env"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|name
argument_list|,
operator|(
name|char
operator|*
operator|)
name|value
argument_list|,
name|TCL_GLOBAL_ONLY
argument_list|)
expr_stmt|;
block|}
comment|/*      * Create a new entry.      */
name|p
operator|=
operator|(
name|char
operator|*
operator|)
name|ckalloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|nameLength
operator|+
name|strlen
argument_list|(
name|value
argument_list|)
operator|+
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|p
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|p
index|[
name|nameLength
index|]
operator|=
literal|'='
expr_stmt|;
name|strcpy
argument_list|(
name|p
operator|+
name|nameLength
operator|+
literal|1
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/*      * Update the system environment.      */
ifdef|#
directive|ifdef
name|USE_PUTENV
name|putenv
argument_list|(
name|p
argument_list|)
expr_stmt|;
else|#
directive|else
name|environ
index|[
name|index
index|]
operator|=
name|p
expr_stmt|;
endif|#
directive|endif
comment|/*      * Replace the old value with the new value in the cache.      */
name|ReplaceString
argument_list|(
name|oldValue
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * Tcl_PutEnv --  *  *	Set an environment variable.  Similar to setenv except that  *	the information is passed in a single string of the form  *	NAME=value, rather than as separate name strings.  This procedure  *	is intended to be a stand-in for the  UNIX "putenv" procedure  *	so that applications using that procedure will interface  *	properly to Tcl.  To make it a stand-in, the Makefile will  *	define "Tcl_PutEnv" to "putenv".  *  * Results:  *	None.  *  * Side effects:  *	The environ array gets updated, as do all of the interpreters  *	that we manage.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
name|int
name|Tcl_PutEnv
parameter_list|(
name|string
parameter_list|)
name|CONST
name|char
modifier|*
name|string
decl_stmt|;
comment|/* Info about environment variable in the 				 * form NAME=value. */
block|{
name|int
name|nameLength
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|string
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
comment|/*      * Separate the string into name and value parts, then call      * TclSetEnv to do all of the real work.      */
name|value
operator|=
name|strchr
argument_list|(
name|string
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
name|nameLength
operator|=
name|value
operator|-
name|string
expr_stmt|;
if|if
condition|(
name|nameLength
operator|==
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
name|name
operator|=
operator|(
name|char
operator|*
operator|)
name|ckalloc
argument_list|(
operator|(
name|unsigned
operator|)
name|nameLength
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|VOID
operator|*
operator|)
name|name
argument_list|,
operator|(
name|VOID
operator|*
operator|)
name|string
argument_list|,
operator|(
name|size_t
operator|)
name|nameLength
argument_list|)
expr_stmt|;
name|name
index|[
name|nameLength
index|]
operator|=
literal|0
expr_stmt|;
name|TclSetEnv
argument_list|(
name|name
argument_list|,
name|value
operator|+
literal|1
argument_list|)
expr_stmt|;
name|ckfree
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * TclUnsetEnv --  *  *	Remove an environment variable, updating the "env" arrays  *	in all interpreters managed by us.  This function is intended  *	to replace the UNIX "unsetenv" function (but to do this the  *	Makefile must be modified to redefine "TclUnsetEnv" to  *	"unsetenv".  *  * Results:  *	None.  *  * Side effects:  *	Interpreters are updated, as is environ.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
name|void
name|TclUnsetEnv
parameter_list|(
name|name
parameter_list|)
name|CONST
name|char
modifier|*
name|name
decl_stmt|;
comment|/* Name of variable to remove. */
block|{
name|EnvInterp
modifier|*
name|eiPtr
decl_stmt|;
name|char
modifier|*
name|oldValue
decl_stmt|;
name|int
name|length
decl_stmt|,
name|index
decl_stmt|;
ifdef|#
directive|ifdef
name|USE_PUTENV
name|char
modifier|*
name|string
decl_stmt|;
else|#
directive|else
name|char
modifier|*
modifier|*
name|envPtr
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|MAC_TCL
if|if
condition|(
name|environ
operator|==
name|NULL
condition|)
block|{
name|environSize
operator|=
name|TclMacCreateEnv
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
name|index
operator|=
name|FindVariable
argument_list|(
name|name
argument_list|,
operator|&
name|length
argument_list|)
expr_stmt|;
comment|/*      * First make sure that the environment variable exists to avoid      * doing needless work and to avoid recursion on the unset.      */
if|if
condition|(
name|index
operator|==
operator|-
literal|1
condition|)
block|{
return|return;
block|}
comment|/*      * Remember the old value so we can free it if Tcl created the string.      */
name|oldValue
operator|=
name|environ
index|[
name|index
index|]
expr_stmt|;
comment|/*      * Update the system environment.  This must be done before we       * update the interpreters or we will recurse.      */
ifdef|#
directive|ifdef
name|USE_PUTENV
name|string
operator|=
name|ckalloc
argument_list|(
name|length
operator|+
literal|2
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|VOID
operator|*
operator|)
name|string
argument_list|,
operator|(
name|VOID
operator|*
operator|)
name|name
argument_list|,
operator|(
name|size_t
operator|)
name|length
argument_list|)
expr_stmt|;
name|string
index|[
name|length
index|]
operator|=
literal|'='
expr_stmt|;
name|string
index|[
name|length
operator|+
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|putenv
argument_list|(
name|string
argument_list|)
expr_stmt|;
name|ckfree
argument_list|(
name|string
argument_list|)
expr_stmt|;
else|#
directive|else
for|for
control|(
name|envPtr
operator|=
name|environ
operator|+
name|index
operator|+
literal|1
init|;
condition|;
name|envPtr
operator|++
control|)
block|{
name|envPtr
index|[
operator|-
literal|1
index|]
operator|=
operator|*
name|envPtr
expr_stmt|;
if|if
condition|(
operator|*
name|envPtr
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
block|}
endif|#
directive|endif
comment|/*      * Replace the old value in the cache.      */
name|ReplaceString
argument_list|(
name|oldValue
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/*      * Update all of the interpreters.      */
for|for
control|(
name|eiPtr
operator|=
name|firstInterpPtr
init|;
name|eiPtr
operator|!=
name|NULL
condition|;
name|eiPtr
operator|=
name|eiPtr
operator|->
name|nextPtr
control|)
block|{
operator|(
name|void
operator|)
name|Tcl_UnsetVar2
argument_list|(
name|eiPtr
operator|->
name|interp
argument_list|,
literal|"env"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|name
argument_list|,
name|TCL_GLOBAL_ONLY
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * TclGetEnv --  *  *	Retrieve the value of an environment variable.  *  * Results:  *	Returns a pointer to a static string in the environment,  *	or NULL if the value was not found.  *  * Side effects:  *	None.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
name|char
modifier|*
name|TclGetEnv
parameter_list|(
name|name
parameter_list|)
name|CONST
name|char
modifier|*
name|name
decl_stmt|;
comment|/* Name of variable to find. */
block|{
name|int
name|length
decl_stmt|,
name|index
decl_stmt|;
ifdef|#
directive|ifdef
name|MAC_TCL
if|if
condition|(
name|environ
operator|==
name|NULL
condition|)
block|{
name|environSize
operator|=
name|TclMacCreateEnv
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
name|index
operator|=
name|FindVariable
argument_list|(
name|name
argument_list|,
operator|&
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|index
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
operator|*
operator|(
name|environ
index|[
name|index
index|]
operator|+
name|length
operator|)
operator|==
literal|'='
operator|)
condition|)
block|{
return|return
name|environ
index|[
name|index
index|]
operator|+
name|length
operator|+
literal|1
return|;
block|}
else|else
block|{
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * EnvTraceProc --  *  *	This procedure is invoked whenever an environment variable  *	is modified or deleted.  It propagates the change to the  *	"environ" array and to any other interpreters for whom  *	we're managing an "env" array.  *  * Results:  *	Always returns NULL to indicate success.  *  * Side effects:  *	Environment variable changes get propagated.  If the whole  *	"env" array is deleted, then we stop managing things for  *	this interpreter (usually this happens because the whole  *	interpreter is being deleted).  *  *----------------------------------------------------------------------  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|EnvTraceProc
parameter_list|(
name|clientData
parameter_list|,
name|interp
parameter_list|,
name|name1
parameter_list|,
name|name2
parameter_list|,
name|flags
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
comment|/* Not used. */
name|Tcl_Interp
modifier|*
name|interp
decl_stmt|;
comment|/* Interpreter whose "env" variable is 				 * being modified. */
name|char
modifier|*
name|name1
decl_stmt|;
comment|/* Better be "env". */
name|char
modifier|*
name|name2
decl_stmt|;
comment|/* Name of variable being modified, or 				 * NULL if whole array is being deleted. */
name|int
name|flags
decl_stmt|;
comment|/* Indicates what's happening. */
block|{
comment|/*      * First see if the whole "env" variable is being deleted.  If      * so, just forget about this interpreter.      */
if|if
condition|(
name|name2
operator|==
name|NULL
condition|)
block|{
specifier|register
name|EnvInterp
modifier|*
name|eiPtr
decl_stmt|,
modifier|*
name|prevPtr
decl_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
operator|(
name|TCL_TRACE_UNSETS
operator||
name|TCL_TRACE_DESTROYED
operator|)
operator|)
operator|!=
operator|(
name|TCL_TRACE_UNSETS
operator||
name|TCL_TRACE_DESTROYED
operator|)
condition|)
block|{
name|panic
argument_list|(
literal|"EnvTraceProc called with confusing arguments"
argument_list|)
expr_stmt|;
block|}
name|eiPtr
operator|=
name|firstInterpPtr
expr_stmt|;
if|if
condition|(
name|eiPtr
operator|->
name|interp
operator|==
name|interp
condition|)
block|{
name|firstInterpPtr
operator|=
name|eiPtr
operator|->
name|nextPtr
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|prevPtr
operator|=
name|eiPtr
operator|,
name|eiPtr
operator|=
name|eiPtr
operator|->
name|nextPtr
init|;
condition|;
name|prevPtr
operator|=
name|eiPtr
operator|,
name|eiPtr
operator|=
name|eiPtr
operator|->
name|nextPtr
control|)
block|{
if|if
condition|(
name|eiPtr
operator|==
name|NULL
condition|)
block|{
name|panic
argument_list|(
literal|"EnvTraceProc couldn't find interpreter"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eiPtr
operator|->
name|interp
operator|==
name|interp
condition|)
block|{
name|prevPtr
operator|->
name|nextPtr
operator|=
name|eiPtr
operator|->
name|nextPtr
expr_stmt|;
break|break;
block|}
block|}
block|}
name|ckfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|eiPtr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/*      * If a value is being set, call TclSetEnv to do all of the work.      */
if|if
condition|(
name|flags
operator|&
name|TCL_TRACE_WRITES
condition|)
block|{
name|TclSetEnv
argument_list|(
name|name2
argument_list|,
name|Tcl_GetVar2
argument_list|(
name|interp
argument_list|,
literal|"env"
argument_list|,
name|name2
argument_list|,
name|TCL_GLOBAL_ONLY
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|TCL_TRACE_UNSETS
condition|)
block|{
name|TclUnsetEnv
argument_list|(
name|name2
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * ReplaceString --  *  *	Replace one string with another in the environment variable  *	cache.  The cache keeps track of all of the environment  *	variables that Tcl has modified so they can be freed later.  *  * Results:  *	None.  *  * Side effects:  *	May free the old string.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
specifier|static
name|void
name|ReplaceString
parameter_list|(
name|oldStr
parameter_list|,
name|newStr
parameter_list|)
name|CONST
name|char
modifier|*
name|oldStr
decl_stmt|;
comment|/* Old environment string. */
name|char
modifier|*
name|newStr
decl_stmt|;
comment|/* New environment string. */
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
modifier|*
name|newCache
decl_stmt|;
comment|/*      * Check to see if the old value was allocated by Tcl.  If so,      * it needs to be deallocated to avoid memory leaks.  Note that this      * algorithm is O(n), not O(1).  This will result in n-squared behavior      * if lots of environment changes are being made.      */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cacheSize
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|environCache
index|[
name|i
index|]
operator|==
name|oldStr
operator|)
operator|||
operator|(
name|environCache
index|[
name|i
index|]
operator|==
name|NULL
operator|)
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|<
name|cacheSize
condition|)
block|{
comment|/* 	 * Replace or delete the old value. 	 */
if|if
condition|(
name|environCache
index|[
name|i
index|]
condition|)
block|{
name|ckfree
argument_list|(
name|environCache
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|newStr
condition|)
block|{
name|environCache
index|[
name|i
index|]
operator|=
name|newStr
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
init|;
name|i
operator|<
name|cacheSize
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|environCache
index|[
name|i
index|]
operator|=
name|environCache
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
block|}
name|environCache
index|[
name|cacheSize
operator|-
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 	 * We need to grow the cache in order to hold the new string. 	 */
name|newCache
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|ckalloc
argument_list|(
operator|(
name|cacheSize
operator|+
literal|5
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|environCache
condition|)
block|{
name|memcpy
argument_list|(
operator|(
name|VOID
operator|*
operator|)
name|newCache
argument_list|,
operator|(
name|VOID
operator|*
operator|)
name|environCache
argument_list|,
call|(
name|size_t
call|)
argument_list|(
name|cacheSize
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ckfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|environCache
argument_list|)
expr_stmt|;
block|}
name|environCache
operator|=
name|newCache
expr_stmt|;
name|environCache
index|[
name|cacheSize
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|newStr
expr_stmt|;
name|environCache
index|[
name|cacheSize
operator|+
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|cacheSize
operator|+=
literal|5
expr_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * FindVariable --  *  *	Locate the entry in environ for a given name.  *  * Results:  *	The return value is the index in environ of an entry with the  *	name "name", or -1 if there is no such entry.   The integer at  *	*lengthPtr is filled in with the length of name (if a matching  *	entry is found) or the length of the environ array (if no matching  *	entry is found).  *  * Side effects:  *	None.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
specifier|static
name|int
name|FindVariable
parameter_list|(
name|name
parameter_list|,
name|lengthPtr
parameter_list|)
name|CONST
name|char
modifier|*
name|name
decl_stmt|;
comment|/* Name of desired environment variable. */
name|int
modifier|*
name|lengthPtr
decl_stmt|;
comment|/* Used to return length of name (for 				 * successful searches) or number of non-NULL 				 * entries in environ (for unsuccessful 				 * searches). */
block|{
name|int
name|i
decl_stmt|;
specifier|register
name|CONST
name|char
modifier|*
name|p1
decl_stmt|,
modifier|*
name|p2
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|p1
operator|=
name|environ
index|[
name|i
index|]
init|;
name|p1
operator|!=
name|NULL
condition|;
name|i
operator|++
operator|,
name|p1
operator|=
name|environ
index|[
name|i
index|]
control|)
block|{
for|for
control|(
name|p2
operator|=
name|name
init|;
operator|*
name|p2
operator|==
operator|*
name|p1
condition|;
name|p1
operator|++
operator|,
name|p2
operator|++
control|)
block|{
comment|/* NULL loop body. */
block|}
if|if
condition|(
operator|(
operator|*
name|p1
operator|==
literal|'='
operator|)
operator|&&
operator|(
operator|*
name|p2
operator|==
literal|'\0'
operator|)
condition|)
block|{
operator|*
name|lengthPtr
operator|=
name|p2
operator|-
name|name
expr_stmt|;
return|return
name|i
return|;
block|}
block|}
operator|*
name|lengthPtr
operator|=
name|i
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * TclFinalizeEnvironment --  *  *	This function releases any storage allocated by this module  *	that isn't still in use by the global environment.  Any  *	strings that are still in the environment will be leaked.  *  * Results:  *	None.  *  * Side effects:  *	May deallocate storage.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
name|void
name|TclFinalizeEnvironment
parameter_list|()
block|{
comment|/*      * For now we just deallocate the cache array and none of the environment      * strings.  This may leak more memory that strictly necessary, since some      * of the strings may no longer be in the environment.  However,      * determining which ones are ok to delete is n-squared, and is pretty      * unlikely, so we don't bother.      */
if|if
condition|(
name|environCache
condition|)
block|{
name|ckfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|environCache
argument_list|)
expr_stmt|;
name|environCache
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

end_unit


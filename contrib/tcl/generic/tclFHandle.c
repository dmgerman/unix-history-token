begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   * tclFHandle.c --  *  *	This file contains functions for manipulating Tcl file handles.  *  * Copyright (c) 1995 Sun Microsystems, Inc.  *  * See the file "license.terms" for information on usage and redistribution  * of this file, and for a DISCLAIMER OF ALL WARRANTIES.  *  * SCCS: @(#) tclFHandle.c 1.6 96/02/13 16:29:55  */
end_comment

begin_include
include|#
directive|include
file|"tcl.h"
end_include

begin_include
include|#
directive|include
file|"tclPort.h"
end_include

begin_comment
comment|/*  * The FileHashKey structure is used to associate the OS file handle and type  * with the corresponding notifier data in a FileHandle.  */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|FileHashKey
block|{
name|int
name|type
decl_stmt|;
comment|/* File handle type. */
name|ClientData
name|osHandle
decl_stmt|;
comment|/* Platform specific OS file handle. */
block|}
name|FileHashKey
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|FileHandle
block|{
name|FileHashKey
name|key
decl_stmt|;
comment|/* Hash key for a given file. */
name|ClientData
name|data
decl_stmt|;
comment|/* Platform specific notifier data. */
name|Tcl_FileFreeProc
modifier|*
name|proc
decl_stmt|;
comment|/* Callback to invoke when file is freed. */
block|}
name|FileHandle
typedef|;
end_typedef

begin_comment
comment|/*  * Static variables used in this file:  */
end_comment

begin_decl_stmt
specifier|static
name|Tcl_HashTable
name|fileTable
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Hash table containing file handles. */
end_comment

begin_decl_stmt
specifier|static
name|int
name|initialized
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 1 if this module has been initialized. */
end_comment

begin_comment
comment|/*  * Static procedures used in this file:  */
end_comment

begin_decl_stmt
specifier|static
name|void
name|FileExitProc
name|_ANSI_ARGS_
argument_list|(
operator|(
name|ClientData
name|clientData
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * Tcl_GetFile --  *  *	This function retrieves the file handle associated with a  *	platform specific file handle of the given type.  It creates  *	a new file handle if needed.  *  * Results:  *	Returns the file handle associated with the file descriptor.  *  * Side effects:  *	Initializes the file handle table if necessary.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
name|Tcl_File
name|Tcl_GetFile
parameter_list|(
name|osHandle
parameter_list|,
name|type
parameter_list|)
name|ClientData
name|osHandle
decl_stmt|;
comment|/* Platform specific file handle. */
name|int
name|type
decl_stmt|;
comment|/* Type of file handle. */
block|{
name|FileHashKey
name|key
decl_stmt|;
name|Tcl_HashEntry
modifier|*
name|entryPtr
decl_stmt|;
name|int
name|new
decl_stmt|;
if|if
condition|(
operator|!
name|initialized
condition|)
block|{
name|Tcl_InitHashTable
argument_list|(
operator|&
name|fileTable
argument_list|,
sizeof|sizeof
argument_list|(
name|FileHashKey
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|Tcl_CreateExitHandler
argument_list|(
name|FileExitProc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|initialized
operator|=
literal|1
expr_stmt|;
block|}
name|key
operator|.
name|osHandle
operator|=
name|osHandle
expr_stmt|;
name|key
operator|.
name|type
operator|=
name|type
expr_stmt|;
name|entryPtr
operator|=
name|Tcl_CreateHashEntry
argument_list|(
operator|&
name|fileTable
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|key
argument_list|,
operator|&
name|new
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
condition|)
block|{
name|FileHandle
modifier|*
name|newHandlePtr
decl_stmt|;
name|newHandlePtr
operator|=
operator|(
name|FileHandle
operator|*
operator|)
name|ckalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|FileHandle
argument_list|)
argument_list|)
expr_stmt|;
name|newHandlePtr
operator|->
name|key
operator|=
name|key
expr_stmt|;
name|newHandlePtr
operator|->
name|data
operator|=
name|NULL
expr_stmt|;
name|newHandlePtr
operator|->
name|proc
operator|=
name|NULL
expr_stmt|;
name|Tcl_SetHashValue
argument_list|(
name|entryPtr
argument_list|,
name|newHandlePtr
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|Tcl_File
operator|)
name|Tcl_GetHashValue
argument_list|(
name|entryPtr
argument_list|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * Tcl_FreeFile --  *  *	Deallocates an entry in the file handle table.  *  * Results:  *	None.  *  * Side effects:  *	None.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
name|void
name|Tcl_FreeFile
parameter_list|(
name|handle
parameter_list|)
name|Tcl_File
name|handle
decl_stmt|;
block|{
name|Tcl_HashEntry
modifier|*
name|entryPtr
decl_stmt|;
name|FileHandle
modifier|*
name|handlePtr
init|=
operator|(
name|FileHandle
operator|*
operator|)
name|handle
decl_stmt|;
comment|/*      * Invoke free procedure, then delete the handle.      */
if|if
condition|(
name|handlePtr
operator|->
name|proc
condition|)
block|{
call|(
modifier|*
name|handlePtr
operator|->
name|proc
call|)
argument_list|(
name|handlePtr
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
name|entryPtr
operator|=
name|Tcl_FindHashEntry
argument_list|(
operator|&
name|fileTable
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|handlePtr
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|entryPtr
condition|)
block|{
name|Tcl_DeleteHashEntry
argument_list|(
name|entryPtr
argument_list|)
expr_stmt|;
name|ckfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|handlePtr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * Tcl_GetFileInfo --  *  *	This function retrieves the platform specific file data and  *	type from the file handle.  *  * Results:  *	If typePtr is not NULL, sets *typePtr to the type of the file.  *	Returns the platform specific file data.  *  * Side effects:  *	None.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
name|ClientData
name|Tcl_GetFileInfo
parameter_list|(
name|handle
parameter_list|,
name|typePtr
parameter_list|)
name|Tcl_File
name|handle
decl_stmt|;
name|int
modifier|*
name|typePtr
decl_stmt|;
block|{
name|FileHandle
modifier|*
name|handlePtr
init|=
operator|(
name|FileHandle
operator|*
operator|)
name|handle
decl_stmt|;
if|if
condition|(
name|typePtr
condition|)
block|{
operator|*
name|typePtr
operator|=
name|handlePtr
operator|->
name|key
operator|.
name|type
expr_stmt|;
block|}
return|return
name|handlePtr
operator|->
name|key
operator|.
name|osHandle
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * Tcl_SetNotifierData --  *  *	This function is used by the notifier to associate platform  *	specific notifier information and a deletion procedure with  *	a file handle.  *  * Results:  *	None.  *  * Side effects:  *	Updates the data and delProc slots in the file handle.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
name|void
name|Tcl_SetNotifierData
parameter_list|(
name|handle
parameter_list|,
name|proc
parameter_list|,
name|data
parameter_list|)
name|Tcl_File
name|handle
decl_stmt|;
name|Tcl_FileFreeProc
modifier|*
name|proc
decl_stmt|;
name|ClientData
name|data
decl_stmt|;
block|{
name|FileHandle
modifier|*
name|handlePtr
init|=
operator|(
name|FileHandle
operator|*
operator|)
name|handle
decl_stmt|;
name|handlePtr
operator|->
name|proc
operator|=
name|proc
expr_stmt|;
name|handlePtr
operator|->
name|data
operator|=
name|data
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * Tcl_GetNotifierData --  *  *	This function is used by the notifier to retrieve the platform  *	specific notifier information associated with a file handle.  *  * Results:  *	Returns the data stored in a file handle by a previous call to  *	Tcl_SetNotifierData, and places a pointer to the free proc  *	in the location referred to by procPtr.  *  * Side effects:  *	None.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
name|ClientData
name|Tcl_GetNotifierData
parameter_list|(
name|handle
parameter_list|,
name|procPtr
parameter_list|)
name|Tcl_File
name|handle
decl_stmt|;
name|Tcl_FileFreeProc
modifier|*
modifier|*
name|procPtr
decl_stmt|;
block|{
name|FileHandle
modifier|*
name|handlePtr
init|=
operator|(
name|FileHandle
operator|*
operator|)
name|handle
decl_stmt|;
if|if
condition|(
name|procPtr
operator|!=
name|NULL
condition|)
block|{
operator|*
name|procPtr
operator|=
name|handlePtr
operator|->
name|proc
expr_stmt|;
block|}
return|return
name|handlePtr
operator|->
name|data
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *----------------------------------------------------------------------  *  * FileExitProc --  *  *	This function an exit handler that frees any memory allocated  *	for the file handle table.  *  * Results:  *	None.  *  * Side effects:  *	Cleans up the file handle table.  *  *----------------------------------------------------------------------  */
end_comment

begin_function
specifier|static
name|void
name|FileExitProc
parameter_list|(
name|clientData
parameter_list|)
name|ClientData
name|clientData
decl_stmt|;
comment|/* Not used. */
block|{
name|Tcl_HashSearch
name|search
decl_stmt|;
name|Tcl_HashEntry
modifier|*
name|entryPtr
decl_stmt|;
name|entryPtr
operator|=
name|Tcl_FirstHashEntry
argument_list|(
operator|&
name|fileTable
argument_list|,
operator|&
name|search
argument_list|)
expr_stmt|;
while|while
condition|(
name|entryPtr
condition|)
block|{
name|ckfree
argument_list|(
name|Tcl_GetHashValue
argument_list|(
name|entryPtr
argument_list|)
argument_list|)
expr_stmt|;
name|entryPtr
operator|=
name|Tcl_NextHashEntry
argument_list|(
operator|&
name|search
argument_list|)
expr_stmt|;
block|}
name|Tcl_DeleteHashTable
argument_list|(
operator|&
name|fileTable
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Subroutines needed for unwinding stack frames via the libunwind API.    Copyright (C) 2002, 2003    Free Software Foundation, Inc.    Contributed by David Mosberger-Tang<davidm@hpl.hp.com>     This file is part of GCC.     GCC is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2, or (at your option)    any later version.     GCC is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with GCC; see the file COPYING.  If not, write to    the Free Software Foundation, 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_comment
comment|/* As a special exception, if you link this library with other files,    some of which are compiled with GCC, to produce an executable,    this library does not by itself cause the resulting executable    to be covered by the GNU General Public License.    This exception does not however invalidate any other reasons why    the executable file might be covered by the GNU General Public License.  */
end_comment

begin_include
include|#
directive|include
file|"tconfig.h"
end_include

begin_include
include|#
directive|include
file|"tsystem.h"
end_include

begin_include
include|#
directive|include
file|"unwind.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|__USING_SJLJ_EXCEPTIONS__
end_ifndef

begin_define
define|#
directive|define
name|UNW_LOCAL_ONLY
end_define

begin_include
include|#
directive|include
file|<libunwind.h>
end_include

begin_typedef
typedef|typedef
struct|struct
block|{
name|_Unwind_Personality_Fn
name|personality
decl_stmt|;
block|}
name|_Unwind_FrameState
typedef|;
end_typedef

begin_struct
struct|struct
name|_Unwind_Context
block|{
name|unw_cursor_t
name|cursor
decl_stmt|;
block|}
struct|;
end_struct

begin_escape
end_escape

begin_comment
comment|/* First come the helper-routines that are needed by unwind.inc.  */
end_comment

begin_function
specifier|static
name|_Unwind_Reason_Code
name|uw_frame_state_for
parameter_list|(
name|struct
name|_Unwind_Context
modifier|*
name|context
parameter_list|,
name|_Unwind_FrameState
modifier|*
name|fs
parameter_list|)
block|{
name|unw_proc_info_t
name|pi
decl_stmt|;
if|if
condition|(
name|unw_step
argument_list|(
operator|&
name|context
operator|->
name|cursor
argument_list|)
operator|<=
literal|0
condition|)
return|return
name|_URC_END_OF_STACK
return|;
name|unw_get_proc_info
argument_list|(
operator|&
name|context
operator|->
name|cursor
argument_list|,
operator|&
name|pi
argument_list|)
expr_stmt|;
name|fs
operator|->
name|personality
operator|=
operator|(
name|_Unwind_Personality_Fn
operator|)
name|pi
operator|.
name|handler
expr_stmt|;
return|return
name|_URC_NO_REASON
return|;
block|}
end_function

begin_define
define|#
directive|define
name|uw_update_context
parameter_list|(
name|context
parameter_list|,
name|fs
parameter_list|)
value|do { ; } while (0)
end_define

begin_function
specifier|static
specifier|inline
name|_Unwind_Ptr
name|uw_identify_context
parameter_list|(
name|struct
name|_Unwind_Context
modifier|*
name|context
parameter_list|)
block|{
name|unw_word_t
name|ip
decl_stmt|;
name|unw_get_reg
argument_list|(
operator|&
name|context
operator|->
name|cursor
argument_list|,
name|UNW_REG_IP
argument_list|,
operator|&
name|ip
argument_list|)
expr_stmt|;
return|return
operator|(
name|_Unwind_Ptr
operator|)
name|ip
return|;
block|}
end_function

begin_define
define|#
directive|define
name|uw_init_context
parameter_list|(
name|context
parameter_list|)
define|\
value|do						\   {						\     unw_context_t uc;				\     unw_getcontext (&uc);			\     unw_init_local (&(context)->cursor,&uc);	\   }						\ while (0)
end_define

begin_decl_stmt
specifier|static
specifier|inline
name|void
name|__attribute__
argument_list|(
operator|(
name|noreturn
operator|)
argument_list|)
name|uw_install_context
argument_list|(
expr|struct
name|_Unwind_Context
operator|*
name|current
name|__attribute__
argument_list|(
operator|(
name|unused
operator|)
argument_list|)
argument_list|,
expr|struct
name|_Unwind_Context
operator|*
name|target
argument_list|)
block|{
name|unw_resume
argument_list|(
operator|&
operator|(
name|target
operator|)
operator|->
name|cursor
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/* Now come the helper-routines which may be called from an exception    handler.  The interface for these routines are defined by the C++    ABI.  See: http://www.codesourcery.com/cxx-abi/abi-eh.html */
end_comment

begin_function
name|_Unwind_Word
name|_Unwind_GetGR
parameter_list|(
name|struct
name|_Unwind_Context
modifier|*
name|context
parameter_list|,
name|int
name|index
parameter_list|)
block|{
name|unw_word_t
name|ret
decl_stmt|;
comment|/* Note: here we depend on the fact that general registers are      expected to start with register number 0!  */
name|unw_get_reg
argument_list|(
operator|&
name|context
operator|->
name|cursor
argument_list|,
name|index
argument_list|,
operator|&
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Get the value of the CFA as saved in CONTEXT.  */
end_comment

begin_function
name|_Unwind_Word
name|_Unwind_GetCFA
parameter_list|(
name|struct
name|_Unwind_Context
modifier|*
name|context
parameter_list|)
block|{
comment|/* ??? Is there any way to get this information?  */
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* Overwrite the saved value for register REG in CONTEXT with VAL.  */
end_comment

begin_function
name|void
name|_Unwind_SetGR
parameter_list|(
name|struct
name|_Unwind_Context
modifier|*
name|context
parameter_list|,
name|int
name|index
parameter_list|,
name|_Unwind_Word
name|val
parameter_list|)
block|{
comment|/* Note: here we depend on the fact that general registers are      expected to start with register number 0!  */
name|unw_set_reg
argument_list|(
operator|&
name|context
operator|->
name|cursor
argument_list|,
name|index
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Retrieve the return address for CONTEXT.  */
end_comment

begin_function
specifier|inline
name|_Unwind_Ptr
name|_Unwind_GetIP
parameter_list|(
name|struct
name|_Unwind_Context
modifier|*
name|context
parameter_list|)
block|{
name|unw_word_t
name|ret
decl_stmt|;
name|unw_get_reg
argument_list|(
operator|&
name|context
operator|->
name|cursor
argument_list|,
name|UNW_REG_IP
argument_list|,
operator|&
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Overwrite the return address for CONTEXT with VAL.  */
end_comment

begin_function
specifier|inline
name|void
name|_Unwind_SetIP
parameter_list|(
name|struct
name|_Unwind_Context
modifier|*
name|context
parameter_list|,
name|_Unwind_Ptr
name|val
parameter_list|)
block|{
name|unw_set_reg
argument_list|(
operator|&
name|context
operator|->
name|cursor
argument_list|,
name|UNW_REG_IP
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
modifier|*
name|_Unwind_GetLanguageSpecificData
parameter_list|(
name|struct
name|_Unwind_Context
modifier|*
name|context
parameter_list|)
block|{
name|unw_proc_info_t
name|pi
decl_stmt|;
name|unw_get_proc_info
argument_list|(
operator|&
name|context
operator|->
name|cursor
argument_list|,
operator|&
name|pi
argument_list|)
expr_stmt|;
return|return
operator|(
name|void
operator|*
operator|)
name|pi
operator|.
name|lsda
return|;
block|}
end_function

begin_function
name|_Unwind_Ptr
name|_Unwind_GetRegionStart
parameter_list|(
name|struct
name|_Unwind_Context
modifier|*
name|context
parameter_list|)
block|{
name|unw_proc_info_t
name|pi
decl_stmt|;
name|unw_get_proc_info
argument_list|(
operator|&
name|context
operator|->
name|cursor
argument_list|,
operator|&
name|pi
argument_list|)
expr_stmt|;
return|return
operator|(
name|_Unwind_Ptr
operator|)
name|pi
operator|.
name|start_ip
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|_Unwind_FindEnclosingFunction
parameter_list|(
name|void
modifier|*
name|pc
parameter_list|)
block|{
return|return
name|NULL
return|;
block|}
end_function

begin_include
include|#
directive|include
file|"unwind.inc"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !__USING_SJLJ_EXCEPTIONS__ */
end_comment

end_unit


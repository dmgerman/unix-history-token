begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* mingw32 host-specific hook definitions.    Copyright (C) 2004 Free Software Foundation, Inc.     This file is part of GCC.     GCC is free software; you can redistribute it and/or modify it    under the terms of the GNU General Public License as published    by the Free Software Foundation; either version 2, or (at your    option) any later version.     GCC is distributed in the hope that it will be useful, but WITHOUT    ANY WARRANTY; without even the implied warranty of MERCHANTABILITY    or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public    License for more details.     You should have received a copy of the GNU General Public License    along with GCC; see the file COPYING.  If not, write to the    Free Software Foundation, 51 Franklin Street, Fifth Floor, Boston,    MA 02110-1301, USA.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"system.h"
end_include

begin_include
include|#
directive|include
file|"coretypes.h"
end_include

begin_include
include|#
directive|include
file|"hosthooks.h"
end_include

begin_include
include|#
directive|include
file|"hosthooks-def.h"
end_include

begin_include
include|#
directive|include
file|"toplev.h"
end_include

begin_include
include|#
directive|include
file|"diagnostic.h"
end_include

begin_define
define|#
directive|define
name|WIN32_LEAN_AND_MEAN
end_define

begin_comment
comment|/* Not so important if we have windows.h.gch.  */
end_comment

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_function_decl
specifier|static
name|void
modifier|*
name|mingw32_gt_pch_get_address
parameter_list|(
name|size_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mingw32_gt_pch_use_address
parameter_list|(
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|int
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|size_t
name|mingw32_gt_pch_alloc_granularity
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_undef
undef|#
directive|undef
name|HOST_HOOKS_GT_PCH_GET_ADDRESS
end_undef

begin_define
define|#
directive|define
name|HOST_HOOKS_GT_PCH_GET_ADDRESS
value|mingw32_gt_pch_get_address
end_define

begin_undef
undef|#
directive|undef
name|HOST_HOOKS_GT_PCH_USE_ADDRESS
end_undef

begin_define
define|#
directive|define
name|HOST_HOOKS_GT_PCH_USE_ADDRESS
value|mingw32_gt_pch_use_address
end_define

begin_undef
undef|#
directive|undef
name|HOST_HOOKS_GT_PCH_ALLOC_GRANULARITY
end_undef

begin_define
define|#
directive|define
name|HOST_HOOKS_GT_PCH_ALLOC_GRANULARITY
value|mingw32_gt_pch_alloc_granularity
end_define

begin_function_decl
specifier|static
specifier|inline
name|void
name|w32_error
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* FIXME: Is this big enough?  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|size_t
name|pch_VA_max_size
init|=
literal|128
operator|*
literal|1024
operator|*
literal|1024
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Granularity for reserving address space.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|size_t
name|va_granularity
init|=
literal|0x10000
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Print out the GetLastError() translation.  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|w32_error
parameter_list|(
specifier|const
name|char
modifier|*
name|function
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|,
specifier|const
name|char
modifier|*
name|my_msg
parameter_list|)
block|{
name|LPSTR
name|w32_msgbuf
decl_stmt|;
name|FormatMessageA
argument_list|(
name|FORMAT_MESSAGE_ALLOCATE_BUFFER
operator||
name|FORMAT_MESSAGE_FROM_SYSTEM
operator||
name|FORMAT_MESSAGE_IGNORE_INSERTS
operator||
name|FORMAT_MESSAGE_MAX_WIDTH_MASK
argument_list|,
name|NULL
argument_list|,
name|GetLastError
argument_list|()
argument_list|,
name|MAKELANGID
argument_list|(
name|LANG_NEUTRAL
argument_list|,
name|SUBLANG_DEFAULT
argument_list|)
argument_list|,
operator|(
name|LPSTR
operator|)
operator|&
name|w32_msgbuf
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"internal error in %s, at %s:%d: %s: %s\n"
argument_list|,
name|function
argument_list|,
name|trim_filename
argument_list|(
name|file
argument_list|)
argument_list|,
name|line
argument_list|,
name|my_msg
argument_list|,
name|w32_msgbuf
argument_list|)
expr_stmt|;
name|LocalFree
argument_list|(
operator|(
name|HLOCAL
operator|)
name|w32_msgbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Granularity for reserving address space.  */
end_comment

begin_function
specifier|static
name|size_t
name|mingw32_gt_pch_alloc_granularity
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|va_granularity
return|;
block|}
end_function

begin_comment
comment|/* Identify an address that's likely to be free in a subsequent invocation    of the compiler.  The area should be able to hold SIZE bytes.  FD is an    open file descriptor if the host would like to probe with mmap.  */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|mingw32_gt_pch_get_address
parameter_list|(
name|size_t
name|size
parameter_list|,
name|int
name|fd
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
name|void
modifier|*
name|res
decl_stmt|;
name|size
operator|=
operator|(
name|size
operator|+
name|va_granularity
operator|-
literal|1
operator|)
operator|&
operator|~
operator|(
name|va_granularity
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|pch_VA_max_size
condition|)
return|return
name|NULL
return|;
comment|/* FIXME: We let system determine base by setting first arg to NULL.      Allocating at top of available address space avoids unnecessary      fragmentation of "ordinary" (malloc's)  address space but may not be safe      with delayed load of system dll's. Preferred addresses for NT system      dlls is in 0x70000000 to 0x78000000 range.      If we allocate at bottom we need to reserve the address as early as possible      and at the same point in each invocation. */
name|res
operator|=
name|VirtualAlloc
argument_list|(
name|NULL
argument_list|,
name|pch_VA_max_size
argument_list|,
name|MEM_RESERVE
operator||
name|MEM_TOP_DOWN
argument_list|,
name|PAGE_NOACCESS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
name|w32_error
argument_list|(
name|__FUNCTION__
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"VirtualAlloc"
argument_list|)
expr_stmt|;
else|else
comment|/* We do not need the address space for now, so free it.  */
name|VirtualFree
argument_list|(
name|res
argument_list|,
literal|0
argument_list|,
name|MEM_RELEASE
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/* ADDR is an address returned by gt_pch_get_address.  Attempt to allocate    SIZE bytes at the same address and load it with the data from FD at     OFFSET.  Return -1 if we couldn't allocate memory at ADDR, return 0    if the memory is allocated but the data not loaded, return 1 if done.  */
end_comment

begin_function
specifier|static
name|int
name|mingw32_gt_pch_use_address
parameter_list|(
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|int
name|fd
parameter_list|,
name|size_t
name|offset
parameter_list|)
block|{
name|void
modifier|*
name|mmap_addr
decl_stmt|;
specifier|static
name|HANDLE
name|mmap_handle
decl_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* Offset must be also be a multiple of allocation granularity for      this to work.  We can't change the offset. */
if|if
condition|(
operator|(
name|offset
operator|&
operator|(
name|va_granularity
operator|-
literal|1
operator|)
operator|)
operator|!=
literal|0
operator|||
name|size
operator|>
name|pch_VA_max_size
condition|)
return|return
operator|-
literal|1
return|;
name|mmap_handle
operator|=
name|CreateFileMapping
argument_list|(
operator|(
name|HANDLE
operator|)
name|_get_osfhandle
argument_list|(
name|fd
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|PAGE_WRITECOPY
operator||
name|SEC_COMMIT
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mmap_handle
operator|==
name|NULL
condition|)
block|{
name|w32_error
argument_list|(
name|__FUNCTION__
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"CreateFileMapping"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|mmap_addr
operator|=
name|MapViewOfFileEx
argument_list|(
name|mmap_handle
argument_list|,
name|FILE_MAP_COPY
argument_list|,
literal|0
argument_list|,
name|offset
argument_list|,
name|size
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mmap_addr
operator|!=
name|addr
condition|)
block|{
name|w32_error
argument_list|(
name|__FUNCTION__
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"MapViewOfFileEx"
argument_list|)
expr_stmt|;
name|CloseHandle
argument_list|(
name|mmap_handle
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|host_hooks
name|host_hooks
init|=
name|HOST_HOOKS_INITIALIZER
decl_stmt|;
end_decl_stmt

end_unit


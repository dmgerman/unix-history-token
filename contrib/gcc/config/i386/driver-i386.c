begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Subroutines for the gcc driver.    Copyright (C) 2006, 2007 Free Software Foundation, Inc.  This file is part of GCC.  GCC is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2, or (at your option) any later version.  GCC is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with GCC; see the file COPYING.  If not, write to the Free Software Foundation, 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"system.h"
end_include

begin_include
include|#
directive|include
file|"coretypes.h"
end_include

begin_include
include|#
directive|include
file|"tm.h"
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_function_decl
specifier|const
name|char
modifier|*
name|host_detect_local_cpu
parameter_list|(
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|GCC_VERSION
end_ifdef

begin_define
define|#
directive|define
name|cpuid
parameter_list|(
name|num
parameter_list|,
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|,
name|d
parameter_list|)
define|\
value|asm volatile ("xchgl %%ebx, %1; cpuid; xchgl %%ebx, %1" \ 		: "=a" (a), "=r" (b), "=c" (c), "=d" (d)  \ 		: "0" (num))
end_define

begin_define
define|#
directive|define
name|bit_CMPXCHG8B
value|(1<< 8)
end_define

begin_define
define|#
directive|define
name|bit_CMOV
value|(1<< 15)
end_define

begin_define
define|#
directive|define
name|bit_MMX
value|(1<< 23)
end_define

begin_define
define|#
directive|define
name|bit_SSE
value|(1<< 25)
end_define

begin_define
define|#
directive|define
name|bit_SSE2
value|(1<< 26)
end_define

begin_define
define|#
directive|define
name|bit_SSE3
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|bit_SSSE3
value|(1<< 9)
end_define

begin_define
define|#
directive|define
name|bit_SSE4a
value|(1<< 6)
end_define

begin_define
define|#
directive|define
name|bit_CMPXCHG16B
value|(1<< 13)
end_define

begin_define
define|#
directive|define
name|bit_3DNOW
value|(1<< 31)
end_define

begin_define
define|#
directive|define
name|bit_3DNOWP
value|(1<< 30)
end_define

begin_define
define|#
directive|define
name|bit_LM
value|(1<< 29)
end_define

begin_comment
comment|/* This will be called by the spec parser in gcc.c when it sees    a %:local_cpu_detect(args) construct.  Currently it will be called    with either "arch" or "tune" as argument depending on if -march=native    or -mtune=native is to be substituted.     It returns a string containing new command line parameters to be    put at the place of the above two options, depending on what CPU    this is executed.  E.g. "-march=k8" on an AMD64 machine    for -march=native.     ARGC and ARGV are set depending on the actual arguments given    in the spec.  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|host_detect_local_cpu
parameter_list|(
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cpu
init|=
name|NULL
decl_stmt|;
name|enum
name|processor_type
name|processor
init|=
name|PROCESSOR_I386
decl_stmt|;
name|unsigned
name|int
name|eax
decl_stmt|,
name|ebx
decl_stmt|,
name|ecx
decl_stmt|,
name|edx
decl_stmt|;
name|unsigned
name|int
name|max_level
decl_stmt|;
name|unsigned
name|int
name|vendor
decl_stmt|;
name|unsigned
name|int
name|ext_level
decl_stmt|;
name|unsigned
name|char
name|has_mmx
init|=
literal|0
decl_stmt|,
name|has_3dnow
init|=
literal|0
decl_stmt|,
name|has_3dnowp
init|=
literal|0
decl_stmt|,
name|has_sse
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|has_sse2
init|=
literal|0
decl_stmt|,
name|has_sse3
init|=
literal|0
decl_stmt|,
name|has_ssse3
init|=
literal|0
decl_stmt|,
name|has_cmov
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|has_longmode
init|=
literal|0
decl_stmt|,
name|has_cmpxchg8b
init|=
literal|0
decl_stmt|,
name|has_sse4a
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|is_amd
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|family
init|=
literal|0
decl_stmt|;
name|bool
name|arch
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
return|return
name|NULL
return|;
name|arch
operator|=
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"arch"
argument_list|)
operator|==
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|arch
operator|&&
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"tune"
argument_list|)
condition|)
return|return
name|NULL
return|;
ifndef|#
directive|ifndef
name|__x86_64__
comment|/* See if we can use cpuid.  */
asm|asm
specifier|volatile
asm|("pushfl; pushfl; popl %0; movl %0,%1; xorl %2,%0;" 		"pushl %0; popfl; pushfl; popl %0; popfl" 		: "=&r" (eax), "=&r" (ebx) 		: "i" (0x00200000));
if|if
condition|(
operator|(
operator|(
name|eax
operator|^
name|ebx
operator|)
operator|&
literal|0x00200000
operator|)
operator|==
literal|0
condition|)
goto|goto
name|done
goto|;
endif|#
directive|endif
name|processor
operator|=
name|PROCESSOR_PENTIUM
expr_stmt|;
comment|/* Check the highest input value for eax.  */
name|cpuid
argument_list|(
literal|0
argument_list|,
name|eax
argument_list|,
name|ebx
argument_list|,
name|ecx
argument_list|,
name|edx
argument_list|)
expr_stmt|;
name|max_level
operator|=
name|eax
expr_stmt|;
comment|/* We only look at the first four characters.  */
name|vendor
operator|=
name|ebx
expr_stmt|;
if|if
condition|(
name|max_level
operator|==
literal|0
condition|)
goto|goto
name|done
goto|;
name|cpuid
argument_list|(
literal|1
argument_list|,
name|eax
argument_list|,
name|ebx
argument_list|,
name|ecx
argument_list|,
name|edx
argument_list|)
expr_stmt|;
name|has_cmpxchg8b
operator|=
operator|!
operator|!
operator|(
name|edx
operator|&
name|bit_CMPXCHG8B
operator|)
expr_stmt|;
name|has_cmov
operator|=
operator|!
operator|!
operator|(
name|edx
operator|&
name|bit_CMOV
operator|)
expr_stmt|;
name|has_mmx
operator|=
operator|!
operator|!
operator|(
name|edx
operator|&
name|bit_MMX
operator|)
expr_stmt|;
name|has_sse
operator|=
operator|!
operator|!
operator|(
name|edx
operator|&
name|bit_SSE
operator|)
expr_stmt|;
name|has_sse2
operator|=
operator|!
operator|!
operator|(
name|edx
operator|&
name|bit_SSE2
operator|)
expr_stmt|;
name|has_sse3
operator|=
operator|!
operator|!
operator|(
name|ecx
operator|&
name|bit_SSE3
operator|)
expr_stmt|;
name|has_ssse3
operator|=
operator|!
operator|!
operator|(
name|ecx
operator|&
name|bit_SSSE3
operator|)
expr_stmt|;
comment|/* We don't care for extended family.  */
name|family
operator|=
operator|(
name|eax
operator|>>
literal|8
operator|)
operator|&
operator|~
operator|(
literal|1
operator|<<
literal|4
operator|)
expr_stmt|;
name|cpuid
argument_list|(
literal|0x80000000
argument_list|,
name|eax
argument_list|,
name|ebx
argument_list|,
name|ecx
argument_list|,
name|edx
argument_list|)
expr_stmt|;
name|ext_level
operator|=
name|eax
expr_stmt|;
if|if
condition|(
name|ext_level
operator|>=
literal|0x80000000
condition|)
block|{
name|cpuid
argument_list|(
literal|0x80000001
argument_list|,
name|eax
argument_list|,
name|ebx
argument_list|,
name|ecx
argument_list|,
name|edx
argument_list|)
expr_stmt|;
name|has_3dnow
operator|=
operator|!
operator|!
operator|(
name|edx
operator|&
name|bit_3DNOW
operator|)
expr_stmt|;
name|has_3dnowp
operator|=
operator|!
operator|!
operator|(
name|edx
operator|&
name|bit_3DNOWP
operator|)
expr_stmt|;
name|has_longmode
operator|=
operator|!
operator|!
operator|(
name|edx
operator|&
name|bit_LM
operator|)
expr_stmt|;
name|has_sse4a
operator|=
operator|!
operator|!
operator|(
name|ecx
operator|&
name|bit_SSE4a
operator|)
expr_stmt|;
block|}
name|is_amd
operator|=
name|vendor
operator|==
operator|*
operator|(
name|unsigned
name|int
operator|*
operator|)
literal|"Auth"
expr_stmt|;
if|if
condition|(
name|is_amd
condition|)
block|{
if|if
condition|(
name|has_mmx
condition|)
name|processor
operator|=
name|PROCESSOR_K6
expr_stmt|;
if|if
condition|(
name|has_3dnowp
condition|)
name|processor
operator|=
name|PROCESSOR_ATHLON
expr_stmt|;
if|if
condition|(
name|has_sse2
operator|||
name|has_longmode
condition|)
name|processor
operator|=
name|PROCESSOR_K8
expr_stmt|;
if|if
condition|(
name|has_sse4a
condition|)
name|processor
operator|=
name|PROCESSOR_AMDFAM10
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|family
condition|)
block|{
case|case
literal|5
case|:
comment|/* Default is PROCESSOR_PENTIUM.  */
break|break;
case|case
literal|6
case|:
name|processor
operator|=
name|PROCESSOR_PENTIUMPRO
expr_stmt|;
break|break;
case|case
literal|15
case|:
name|processor
operator|=
name|PROCESSOR_PENTIUM4
expr_stmt|;
break|break;
default|default:
comment|/* We have no idea.  Use something reasonable.  */
if|if
condition|(
name|arch
condition|)
block|{
if|if
condition|(
name|has_ssse3
condition|)
name|cpu
operator|=
literal|"core2"
expr_stmt|;
elseif|else
if|if
condition|(
name|has_sse3
condition|)
block|{
if|if
condition|(
name|has_longmode
condition|)
name|cpu
operator|=
literal|"nocona"
expr_stmt|;
else|else
name|cpu
operator|=
literal|"prescott"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|has_sse2
condition|)
name|cpu
operator|=
literal|"pentium4"
expr_stmt|;
elseif|else
if|if
condition|(
name|has_cmov
condition|)
name|cpu
operator|=
literal|"pentiumpro"
expr_stmt|;
elseif|else
if|if
condition|(
name|has_mmx
condition|)
name|cpu
operator|=
literal|"pentium-mmx"
expr_stmt|;
elseif|else
if|if
condition|(
name|has_cmpxchg8b
condition|)
name|cpu
operator|=
literal|"pentium"
expr_stmt|;
else|else
name|cpu
operator|=
literal|"i386"
expr_stmt|;
block|}
else|else
name|cpu
operator|=
literal|"generic"
expr_stmt|;
goto|goto
name|done
goto|;
break|break;
block|}
block|}
switch|switch
condition|(
name|processor
condition|)
block|{
case|case
name|PROCESSOR_I386
case|:
name|cpu
operator|=
literal|"i386"
expr_stmt|;
break|break;
case|case
name|PROCESSOR_I486
case|:
name|cpu
operator|=
literal|"i486"
expr_stmt|;
break|break;
case|case
name|PROCESSOR_PENTIUM
case|:
if|if
condition|(
name|has_mmx
condition|)
name|cpu
operator|=
literal|"pentium-mmx"
expr_stmt|;
else|else
name|cpu
operator|=
literal|"pentium"
expr_stmt|;
break|break;
case|case
name|PROCESSOR_PENTIUMPRO
case|:
if|if
condition|(
name|arch
condition|)
block|{
if|if
condition|(
name|has_sse3
condition|)
block|{
if|if
condition|(
name|has_longmode
condition|)
block|{
comment|/* It is Core 2 Duo.  */
name|cpu
operator|=
literal|"nocona"
expr_stmt|;
block|}
else|else
block|{
comment|/* It is Core Duo.  */
name|cpu
operator|=
literal|"prescott"
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|has_sse2
condition|)
block|{
comment|/* It is Pentium M.  */
name|cpu
operator|=
literal|"pentium4"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|has_sse
condition|)
block|{
comment|/* It is Pentium III.  */
name|cpu
operator|=
literal|"pentium3"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|has_mmx
condition|)
block|{
comment|/* It is Pentium II.  */
name|cpu
operator|=
literal|"pentium2"
expr_stmt|;
block|}
else|else
block|{
comment|/* Default to Pentium Pro.  */
name|cpu
operator|=
literal|"pentiumpro"
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* For -mtune, we default to -mtune=generic.  */
name|cpu
operator|=
literal|"generic"
expr_stmt|;
block|}
break|break;
case|case
name|PROCESSOR_GEODE
case|:
name|cpu
operator|=
literal|"geode"
expr_stmt|;
break|break;
case|case
name|PROCESSOR_K6
case|:
if|if
condition|(
name|has_3dnow
condition|)
name|cpu
operator|=
literal|"k6-3"
expr_stmt|;
else|else
name|cpu
operator|=
literal|"k6"
expr_stmt|;
break|break;
case|case
name|PROCESSOR_ATHLON
case|:
if|if
condition|(
name|has_sse
condition|)
name|cpu
operator|=
literal|"athlon-4"
expr_stmt|;
else|else
name|cpu
operator|=
literal|"athlon"
expr_stmt|;
break|break;
case|case
name|PROCESSOR_PENTIUM4
case|:
if|if
condition|(
name|has_sse3
condition|)
block|{
if|if
condition|(
name|has_longmode
condition|)
name|cpu
operator|=
literal|"nocona"
expr_stmt|;
else|else
name|cpu
operator|=
literal|"prescott"
expr_stmt|;
block|}
else|else
name|cpu
operator|=
literal|"pentium4"
expr_stmt|;
break|break;
case|case
name|PROCESSOR_K8
case|:
name|cpu
operator|=
literal|"k8"
expr_stmt|;
break|break;
case|case
name|PROCESSOR_NOCONA
case|:
name|cpu
operator|=
literal|"nocona"
expr_stmt|;
break|break;
case|case
name|PROCESSOR_AMDFAM10
case|:
name|cpu
operator|=
literal|"amdfam10"
expr_stmt|;
break|break;
case|case
name|PROCESSOR_GENERIC32
case|:
case|case
name|PROCESSOR_GENERIC64
case|:
name|cpu
operator|=
literal|"generic"
expr_stmt|;
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
break|break;
block|}
name|done
label|:
return|return
name|concat
argument_list|(
literal|"-m"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"="
argument_list|,
name|cpu
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* If we aren't compiling with GCC we just provide a minimal    default value.  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|host_detect_local_cpu
parameter_list|(
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cpu
decl_stmt|;
name|bool
name|arch
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
return|return
name|NULL
return|;
name|arch
operator|=
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"arch"
argument_list|)
operator|==
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|arch
operator|&&
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"tune"
argument_list|)
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|arch
condition|)
block|{
comment|/* FIXME: i386 is wrong for 64bit compiler.  How can we tell if 	 we are generating 64bit or 32bit code?  */
name|cpu
operator|=
literal|"i386"
expr_stmt|;
block|}
else|else
name|cpu
operator|=
literal|"generic"
expr_stmt|;
return|return
name|concat
argument_list|(
literal|"-m"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"="
argument_list|,
name|cpu
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* GCC_VERSION */
end_comment

end_unit


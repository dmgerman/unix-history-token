begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* KeyMgr backwards-compatibility support for Darwin.    Copyright (C) 2001, 2002 Free Software Foundation, Inc.  This file is part of GCC.  GCC is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2, or (at your option) any later version.  In addition to the permissions in the GNU General Public License, the Free Software Foundation gives you unlimited permission to link the compiled version of this file into combinations with other programs, and to distribute those combinations without any restriction coming from the use of this file.  (The General Public License restrictions do apply in other respects; for example, they cover modification of the file, and distribution when not linked into a combine executable.)  GCC is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with GCC; see the file COPYING.  If not, write to the Free Software Foundation, 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_comment
comment|/* It is incorrect to include config.h here, because this file is being    compiled for the target, and hence definitions concerning only the host    do not apply.  */
end_comment

begin_include
include|#
directive|include
file|"tconfig.h"
end_include

begin_include
include|#
directive|include
file|"tsystem.h"
end_include

begin_comment
comment|/* Homemade decls substituting for getsect.h and dyld.h, so cross    compilation works.  */
end_comment

begin_struct_decl
struct_decl|struct
name|mach_header
struct_decl|;
end_struct_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|getsectdatafromheader
parameter_list|(
name|struct
name|mach_header
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|unsigned
name|long
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|_dyld_register_func_for_add_image
parameter_list|(
name|void
function_decl|(
modifier|*
function_decl|)
parameter_list|(
name|struct
name|mach_header
modifier|*
parameter_list|,
name|unsigned
name|long
parameter_list|)
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|_dyld_register_func_for_remove_image
parameter_list|(
name|void
function_decl|(
modifier|*
function_decl|)
parameter_list|(
name|struct
name|mach_header
modifier|*
parameter_list|,
name|unsigned
name|long
parameter_list|)
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|__darwin_gcc3_preregister_frame_info
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* These are from "keymgr.h".  */
end_comment

begin_function_decl
specifier|extern
name|void
name|_init_keymgr
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
modifier|*
name|_keymgr_get_and_lock_processwide_ptr
parameter_list|(
name|unsigned
name|key
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|_keymgr_set_and_unlock_processwide_ptr
parameter_list|(
name|unsigned
name|key
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|void
modifier|*
name|__keymgr_global
index|[]
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
name|_Sinfo_Node
block|{
name|unsigned
name|int
name|size
decl_stmt|;
comment|/*size of this node*/
name|unsigned
name|short
name|major_version
decl_stmt|;
comment|/*API major version.*/
name|unsigned
name|short
name|minor_version
decl_stmt|;
comment|/*API minor version.*/
block|}
name|_Tinfo_Node
typedef|;
end_typedef

begin_comment
comment|/* KeyMgr 3.x is the first one supporting GCC3 stuff natively.  */
end_comment

begin_define
define|#
directive|define
name|KEYMGR_API_MAJOR_GCC3
value|3
end_define

begin_comment
comment|/* ... with these keys.  */
end_comment

begin_define
define|#
directive|define
name|KEYMGR_GCC3_LIVE_IMAGE_LIST
value|301
end_define

begin_comment
comment|/* loaded images  */
end_comment

begin_define
define|#
directive|define
name|KEYMGR_GCC3_DW2_OBJ_LIST
value|302
end_define

begin_comment
comment|/* Dwarf2 object list  */
end_comment

begin_comment
comment|/* Node of KEYMGR_GCC3_LIVE_IMAGE_LIST.  Info about each resident image.  */
end_comment

begin_struct
struct|struct
name|live_images
block|{
name|unsigned
name|long
name|this_size
decl_stmt|;
comment|/* sizeof (live_images)  */
name|struct
name|mach_header
modifier|*
name|mh
decl_stmt|;
comment|/* the image info  */
name|unsigned
name|long
name|vm_slide
decl_stmt|;
name|void
function_decl|(
modifier|*
name|destructor
function_decl|)
parameter_list|(
name|struct
name|live_images
modifier|*
parameter_list|)
function_decl|;
comment|/* destructor for this  */
name|struct
name|live_images
modifier|*
name|next
decl_stmt|;
name|unsigned
name|int
name|examined_p
decl_stmt|;
name|void
modifier|*
name|fde
decl_stmt|;
name|void
modifier|*
name|object_info
decl_stmt|;
name|unsigned
name|long
name|info
index|[
literal|2
index|]
decl_stmt|;
comment|/* Future use.  */
block|}
struct|;
end_struct

begin_escape
end_escape

begin_comment
comment|/* These routines are used only on Darwin versions before 10.2.    Later versions have equivalent code in the system.      Eventually, they might go away, although it might be a long time...  */
end_comment

begin_function_decl
specifier|static
name|void
name|darwin_unwind_dyld_remove_image_hook
parameter_list|(
name|struct
name|mach_header
modifier|*
name|m
parameter_list|,
name|unsigned
name|long
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|darwin_unwind_dyld_remove_image_hook
parameter_list|(
name|struct
name|mach_header
modifier|*
name|m
parameter_list|,
name|unsigned
name|long
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|__darwin_gcc3_preregister_frame_info
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|darwin_unwind_dyld_add_image_hook
parameter_list|(
name|struct
name|mach_header
modifier|*
name|mh
parameter_list|,
name|unsigned
name|long
name|slide
parameter_list|)
block|{
name|struct
name|live_images
modifier|*
name|l
init|=
operator|(
expr|struct
name|live_images
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|l
argument_list|)
argument_list|)
decl_stmt|;
name|l
operator|->
name|mh
operator|=
name|mh
expr_stmt|;
name|l
operator|->
name|vm_slide
operator|=
name|slide
expr_stmt|;
name|l
operator|->
name|this_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|l
argument_list|)
expr_stmt|;
name|l
operator|->
name|next
operator|=
operator|(
expr|struct
name|live_images
operator|*
operator|)
name|_keymgr_get_and_lock_processwide_ptr
argument_list|(
name|KEYMGR_GCC3_LIVE_IMAGE_LIST
argument_list|)
expr_stmt|;
name|_keymgr_set_and_unlock_processwide_ptr
argument_list|(
name|KEYMGR_GCC3_LIVE_IMAGE_LIST
argument_list|,
name|l
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|darwin_unwind_dyld_remove_image_hook
parameter_list|(
name|struct
name|mach_header
modifier|*
name|m
parameter_list|,
name|unsigned
name|long
name|s
parameter_list|)
block|{
name|struct
name|live_images
modifier|*
name|top
decl_stmt|,
modifier|*
modifier|*
name|lip
decl_stmt|,
modifier|*
name|destroy
init|=
name|NULL
decl_stmt|;
comment|/* Look for it in the list of live images and delete it.  */
name|top
operator|=
operator|(
expr|struct
name|live_images
operator|*
operator|)
name|_keymgr_get_and_lock_processwide_ptr
argument_list|(
name|KEYMGR_GCC3_LIVE_IMAGE_LIST
argument_list|)
expr_stmt|;
for|for
control|(
name|lip
operator|=
operator|&
name|top
init|;
operator|*
name|lip
operator|!=
name|NULL
condition|;
name|lip
operator|=
operator|&
operator|(
operator|*
name|lip
operator|)
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|(
operator|*
name|lip
operator|)
operator|->
name|mh
operator|==
name|m
operator|&&
operator|(
operator|*
name|lip
operator|)
operator|->
name|vm_slide
operator|==
name|s
condition|)
block|{
name|destroy
operator|=
operator|*
name|lip
expr_stmt|;
operator|*
name|lip
operator|=
name|destroy
operator|->
name|next
expr_stmt|;
comment|/* unlink DESTROY  */
if|if
condition|(
name|destroy
operator|->
name|this_size
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|destroy
argument_list|)
condition|)
comment|/* sanity check  */
name|abort
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
name|_keymgr_set_and_unlock_processwide_ptr
argument_list|(
name|KEYMGR_GCC3_LIVE_IMAGE_LIST
argument_list|,
name|top
argument_list|)
expr_stmt|;
comment|/* Now that we have unlinked this from the image list, toss it.  */
if|if
condition|(
name|destroy
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|destroy
operator|->
name|destructor
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|destroy
operator|->
name|destructor
call|)
argument_list|(
name|destroy
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|destroy
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|__darwin_gcc3_preregister_frame_info
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|_Tinfo_Node
modifier|*
name|info
decl_stmt|;
name|_init_keymgr
argument_list|()
expr_stmt|;
name|info
operator|=
operator|(
name|_Tinfo_Node
operator|*
operator|)
name|__keymgr_global
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|info
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|info
operator|->
name|major_version
operator|>=
name|KEYMGR_API_MAJOR_GCC3
condition|)
return|return;
comment|/* Otherwise, use our own add_image_hooks.  */
block|}
name|_dyld_register_func_for_add_image
argument_list|(
name|darwin_unwind_dyld_add_image_hook
argument_list|)
expr_stmt|;
name|_dyld_register_func_for_remove_image
argument_list|(
name|darwin_unwind_dyld_remove_image_hook
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


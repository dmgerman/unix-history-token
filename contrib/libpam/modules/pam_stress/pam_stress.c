begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* pam_stress module */
end_comment

begin_comment
comment|/* $Id: pam_stress.c,v 1.2 2000/11/19 23:54:05 agmorgan Exp $  *  * created by Andrew Morgan<morgan@linux.kernel.org> 1996/3/12  */
end_comment

begin_include
include|#
directive|include
file|<security/_pam_aconf.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_define
define|#
directive|define
name|__USE_BSD
end_define

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_comment
comment|/*  * here, we make definitions for the externally accessible functions  * in this file (these definitions are required for static modules  * but strongly encouraged generally) they are used to instruct the  * modules include file to define their prototypes.  */
end_comment

begin_define
define|#
directive|define
name|PAM_SM_AUTH
end_define

begin_define
define|#
directive|define
name|PAM_SM_ACCOUNT
end_define

begin_define
define|#
directive|define
name|PAM_SM_SESSION
end_define

begin_define
define|#
directive|define
name|PAM_SM_PASSWORD
end_define

begin_include
include|#
directive|include
file|<security/pam_modules.h>
end_include

begin_include
include|#
directive|include
file|<security/_pam_macros.h>
end_include

begin_function
specifier|static
name|char
modifier|*
name|_strdup
parameter_list|(
specifier|const
name|char
modifier|*
name|x
parameter_list|)
block|{
name|char
modifier|*
name|new
decl_stmt|;
name|new
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|x
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|new
argument_list|,
name|x
argument_list|)
expr_stmt|;
return|return
name|new
return|;
block|}
end_function

begin_comment
comment|/* log errors */
end_comment

begin_function
specifier|static
name|void
name|_pam_log
parameter_list|(
name|int
name|err
parameter_list|,
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|openlog
argument_list|(
literal|"PAM-stress"
argument_list|,
name|LOG_CONS
operator||
name|LOG_PID
argument_list|,
name|LOG_AUTH
argument_list|)
expr_stmt|;
name|vsyslog
argument_list|(
name|err
argument_list|,
name|format
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|closelog
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ---------- */
end_comment

begin_comment
comment|/* an internal function to turn all possible test arguments into bits    of a ctrl number */
end_comment

begin_comment
comment|/* generic options */
end_comment

begin_define
define|#
directive|define
name|PAM_ST_DEBUG
value|01
end_define

begin_define
define|#
directive|define
name|PAM_ST_NO_WARN
value|02
end_define

begin_define
define|#
directive|define
name|PAM_ST_USE_PASS1
value|04
end_define

begin_define
define|#
directive|define
name|PAM_ST_TRY_PASS1
value|010
end_define

begin_define
define|#
directive|define
name|PAM_ST_ROOTOK
value|020
end_define

begin_comment
comment|/* simulation options */
end_comment

begin_define
define|#
directive|define
name|PAM_ST_EXPIRED
value|040
end_define

begin_define
define|#
directive|define
name|PAM_ST_FAIL_1
value|0100
end_define

begin_define
define|#
directive|define
name|PAM_ST_FAIL_2
value|0200
end_define

begin_define
define|#
directive|define
name|PAM_ST_PRELIM
value|0400
end_define

begin_define
define|#
directive|define
name|PAM_ST_REQUIRE_PWD
value|01000
end_define

begin_comment
comment|/* some syslogging */
end_comment

begin_function
specifier|static
name|void
name|_pam_report
parameter_list|(
name|int
name|ctrl
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_DEBUG
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"CALLED: %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"FLAGS : 0%o%s"
argument_list|,
name|flags
argument_list|,
operator|(
name|flags
operator|&
name|PAM_SILENT
operator|)
condition|?
literal|" (silent)"
else|:
literal|""
argument_list|)
expr_stmt|;
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"CTRL  = 0%o"
argument_list|,
name|ctrl
argument_list|)
expr_stmt|;
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"ARGV  :"
argument_list|)
expr_stmt|;
while|while
condition|(
name|argc
operator|--
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|" \"%s\""
argument_list|,
operator|*
name|argv
operator|++
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|_pam_parse
parameter_list|(
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ctrl
init|=
literal|0
decl_stmt|;
comment|/* step through arguments */
for|for
control|(
name|ctrl
operator|=
literal|0
init|;
name|argc
operator|--
operator|>
literal|0
condition|;
operator|++
name|argv
control|)
block|{
comment|/* generic options */
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"debug"
argument_list|)
condition|)
name|ctrl
operator||=
name|PAM_ST_DEBUG
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"no_warn"
argument_list|)
condition|)
name|ctrl
operator||=
name|PAM_ST_NO_WARN
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"use_first_pass"
argument_list|)
condition|)
name|ctrl
operator||=
name|PAM_ST_USE_PASS1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"try_first_pass"
argument_list|)
condition|)
name|ctrl
operator||=
name|PAM_ST_TRY_PASS1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"rootok"
argument_list|)
condition|)
name|ctrl
operator||=
name|PAM_ST_ROOTOK
expr_stmt|;
comment|/* simulation options */
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"expired"
argument_list|)
condition|)
comment|/* signal password needs 						  renewal */
name|ctrl
operator||=
name|PAM_ST_EXPIRED
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"fail_1"
argument_list|)
condition|)
comment|/* instruct fn 1 to fail */
name|ctrl
operator||=
name|PAM_ST_FAIL_1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"fail_2"
argument_list|)
condition|)
comment|/* instruct fn 2 to fail */
name|ctrl
operator||=
name|PAM_ST_FAIL_2
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"prelim"
argument_list|)
condition|)
comment|/* instruct pam_sm_setcred 						  to fail on first call */
name|ctrl
operator||=
name|PAM_ST_PRELIM
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"required"
argument_list|)
condition|)
comment|/* module is fussy about the 						  user being authenticated */
name|ctrl
operator||=
name|PAM_ST_REQUIRE_PWD
expr_stmt|;
else|else
block|{
name|_pam_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pam_parse: unknown option; %s"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ctrl
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|converse
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|nargs
parameter_list|,
name|struct
name|pam_message
modifier|*
modifier|*
name|message
parameter_list|,
name|struct
name|pam_response
modifier|*
modifier|*
name|response
parameter_list|)
block|{
name|int
name|retval
decl_stmt|;
name|struct
name|pam_conv
modifier|*
name|conv
decl_stmt|;
if|if
condition|(
operator|(
name|retval
operator|=
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_CONV
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|conv
argument_list|)
operator|)
operator|==
name|PAM_SUCCESS
condition|)
block|{
name|retval
operator|=
name|conv
operator|->
name|conv
argument_list|(
name|nargs
argument_list|,
operator|(
specifier|const
expr|struct
name|pam_message
operator|*
operator|*
operator|)
name|message
argument_list|,
name|response
argument_list|,
name|conv
operator|->
name|appdata_ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"(pam_stress) converse returned %d"
argument_list|,
name|retval
argument_list|)
expr_stmt|;
name|_pam_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"that is: %s"
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|retval
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|_pam_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"(pam_stress) converse failed to get pam_conv"
argument_list|)
expr_stmt|;
block|}
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/* authentication management functions */
end_comment

begin_function
specifier|static
name|int
name|stress_get_password
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|ctrl
parameter_list|,
name|char
modifier|*
modifier|*
name|password
parameter_list|)
block|{
name|char
modifier|*
name|pass
decl_stmt|;
if|if
condition|(
operator|(
name|ctrl
operator|&
operator|(
name|PAM_ST_TRY_PASS1
operator||
name|PAM_ST_USE_PASS1
operator|)
operator|)
operator|&&
operator|(
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|pass
argument_list|)
operator|==
name|PAM_SUCCESS
operator|)
operator|&&
operator|(
name|pass
operator|!=
name|NULL
operator|)
condition|)
block|{
name|pass
operator|=
name|_strdup
argument_list|(
name|pass
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ctrl
operator|&
name|PAM_ST_USE_PASS1
operator|)
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"pam_stress: no forwarded password"
argument_list|)
expr_stmt|;
return|return
name|PAM_PERM_DENIED
return|;
block|}
else|else
block|{
comment|/* we will have to get one */
name|struct
name|pam_message
name|msg
index|[
literal|1
index|]
decl_stmt|,
modifier|*
name|pmsg
index|[
literal|1
index|]
decl_stmt|;
name|struct
name|pam_response
modifier|*
name|resp
decl_stmt|;
name|int
name|retval
decl_stmt|;
comment|/* set up conversation call */
name|pmsg
index|[
literal|0
index|]
operator|=
operator|&
name|msg
index|[
literal|0
index|]
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|msg_style
operator|=
name|PAM_PROMPT_ECHO_OFF
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|msg
operator|=
literal|"STRESS Password: "
expr_stmt|;
name|resp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|retval
operator|=
name|converse
argument_list|(
name|pamh
argument_list|,
literal|1
argument_list|,
name|pmsg
argument_list|,
operator|&
name|resp
argument_list|)
operator|)
operator|!=
name|PAM_SUCCESS
condition|)
block|{
return|return
name|retval
return|;
block|}
if|if
condition|(
name|resp
condition|)
block|{
if|if
condition|(
operator|(
name|resp
index|[
literal|0
index|]
operator|.
name|resp
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|ctrl
operator|&
name|PAM_ST_DEBUG
operator|)
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_sm_authenticate: NULL authtok given"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|flags
operator|&
name|PAM_DISALLOW_NULL_AUTHTOK
operator|)
operator|&&
name|resp
index|[
literal|0
index|]
operator|.
name|resp
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return
name|PAM_AUTH_ERR
return|;
block|}
name|pass
operator|=
name|resp
index|[
literal|0
index|]
operator|.
name|resp
expr_stmt|;
comment|/* remember this! */
name|resp
index|[
literal|0
index|]
operator|.
name|resp
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_DEBUG
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_sm_authenticate: no error reported"
argument_list|)
expr_stmt|;
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"getting password, but NULL returned!?"
argument_list|)
expr_stmt|;
return|return
name|PAM_CONV_ERR
return|;
block|}
name|free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
operator|*
name|password
operator|=
name|pass
expr_stmt|;
comment|/* this *MUST* be free()'d by this module */
return|return
name|PAM_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* function to clean up data items */
end_comment

begin_function
specifier|static
name|void
name|wipe_up
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|PAM_EXTERN
name|int
name|pam_sm_authenticate
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|username
decl_stmt|;
name|int
name|retval
init|=
name|PAM_SUCCESS
decl_stmt|;
name|char
modifier|*
name|pass
decl_stmt|;
name|int
name|ctrl
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"called."
operator|)
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|_pam_parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|_pam_report
argument_list|(
name|ctrl
argument_list|,
literal|"pam_sm_authenticate"
argument_list|,
name|flags
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
comment|/* try to get the username */
name|retval
operator|=
name|pam_get_user
argument_list|(
name|pamh
argument_list|,
operator|&
name|username
argument_list|,
literal|"username: "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctrl
operator|&
name|PAM_ST_DEBUG
operator|)
operator|&&
operator|(
name|retval
operator|==
name|PAM_SUCCESS
operator|)
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_sm_authenticate: username = %s"
argument_list|,
name|username
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"pam_sm_authenticate: failed to get username"
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
comment|/* now get the password */
name|retval
operator|=
name|stress_get_password
argument_list|(
name|pamh
argument_list|,
name|flags
argument_list|,
name|ctrl
argument_list|,
operator|&
name|pass
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"pam_sm_authenticate: "
literal|"failed to get a password"
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
comment|/* try to set password item */
name|retval
operator|=
name|pam_set_item
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
name|pass
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"pam_sm_authenticate: "
literal|"failed to store new password"
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|pass
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pass
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
comment|/* clean up local copy of password */
name|_pam_overwrite
argument_list|(
name|pass
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pass
argument_list|)
expr_stmt|;
name|pass
operator|=
name|NULL
expr_stmt|;
comment|/* if we are debugging then we print the password */
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_DEBUG
condition|)
block|{
operator|(
name|void
operator|)
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|pass
argument_list|)
expr_stmt|;
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_st_authenticate: password entered is: [%s]\n"
argument_list|,
name|pass
argument_list|)
expr_stmt|;
name|pass
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* if we signal a fail for this function then fail */
if|if
condition|(
operator|(
name|ctrl
operator|&
name|PAM_ST_FAIL_1
operator|)
operator|&&
name|retval
operator|==
name|PAM_SUCCESS
condition|)
return|return
name|PAM_PERM_DENIED
return|;
return|return
name|retval
return|;
block|}
end_function

begin_function
name|PAM_EXTERN
name|int
name|pam_sm_setcred
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ctrl
init|=
name|_pam_parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"called. [post parsing]"
operator|)
argument_list|)
expr_stmt|;
name|_pam_report
argument_list|(
name|ctrl
argument_list|,
literal|"pam_sm_setcred"
argument_list|,
name|flags
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_FAIL_2
condition|)
return|return
name|PAM_CRED_ERR
return|;
return|return
name|PAM_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* account management functions */
end_comment

begin_function
name|PAM_EXTERN
name|int
name|pam_sm_acct_mgmt
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ctrl
init|=
name|_pam_parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"called. [post parsing]"
operator|)
argument_list|)
expr_stmt|;
name|_pam_report
argument_list|(
name|ctrl
argument_list|,
literal|"pam_sm_acct_mgmt"
argument_list|,
name|flags
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_FAIL_1
condition|)
return|return
name|PAM_PERM_DENIED
return|;
elseif|else
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_EXPIRED
condition|)
block|{
name|void
modifier|*
name|text
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
literal|"yes"
argument_list|)
operator|+
literal|1
argument_list|)
decl_stmt|;
name|strcpy
argument_list|(
name|text
argument_list|,
literal|"yes"
argument_list|)
expr_stmt|;
name|pam_set_data
argument_list|(
name|pamh
argument_list|,
literal|"stress_new_pwd"
argument_list|,
name|text
argument_list|,
name|wipe_up
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_DEBUG
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_sm_acct_mgmt: need a new password"
argument_list|)
expr_stmt|;
block|}
return|return
name|PAM_NEW_AUTHTOK_REQD
return|;
block|}
return|return
name|PAM_SUCCESS
return|;
block|}
end_function

begin_function
name|PAM_EXTERN
name|int
name|pam_sm_open_session
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|char
modifier|*
name|username
decl_stmt|,
modifier|*
name|service
decl_stmt|;
name|int
name|ctrl
init|=
name|_pam_parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"called. [post parsing]"
operator|)
argument_list|)
expr_stmt|;
name|_pam_report
argument_list|(
name|ctrl
argument_list|,
literal|"pam_sm_open_session"
argument_list|,
name|flags
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|username
argument_list|)
operator|!=
name|PAM_SUCCESS
operator|)
operator|||
operator|(
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_SERVICE
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|service
argument_list|)
operator|!=
name|PAM_SUCCESS
operator|)
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"pam_sm_open_session: for whom?"
argument_list|)
expr_stmt|;
return|return
name|PAM_SESSION_ERR
return|;
block|}
name|_pam_log
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"pam_stress: opened [%s] session for user [%s]"
argument_list|,
name|service
argument_list|,
name|username
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_FAIL_1
condition|)
return|return
name|PAM_SESSION_ERR
return|;
return|return
name|PAM_SUCCESS
return|;
block|}
end_function

begin_function
name|PAM_EXTERN
name|int
name|pam_sm_close_session
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|username
decl_stmt|,
modifier|*
name|service
decl_stmt|;
name|int
name|ctrl
init|=
name|_pam_parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"called. [post parsing]"
operator|)
argument_list|)
expr_stmt|;
name|_pam_report
argument_list|(
name|ctrl
argument_list|,
literal|"pam_sm_close_session"
argument_list|,
name|flags
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|username
argument_list|)
operator|!=
name|PAM_SUCCESS
operator|)
operator|||
operator|(
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_SERVICE
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|service
argument_list|)
operator|!=
name|PAM_SUCCESS
operator|)
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"pam_sm_close_session: for whom?"
argument_list|)
expr_stmt|;
return|return
name|PAM_SESSION_ERR
return|;
block|}
name|_pam_log
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"pam_stress: closed [%s] session for user [%s]"
argument_list|,
name|service
argument_list|,
name|username
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_FAIL_2
condition|)
return|return
name|PAM_SESSION_ERR
return|;
return|return
name|PAM_SUCCESS
return|;
block|}
end_function

begin_function
name|PAM_EXTERN
name|int
name|pam_sm_chauthtok
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|retval
decl_stmt|;
name|int
name|ctrl
init|=
name|_pam_parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"called. [post parsing]"
operator|)
argument_list|)
expr_stmt|;
name|_pam_report
argument_list|(
name|ctrl
argument_list|,
literal|"pam_sm_chauthtok"
argument_list|,
name|flags
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
comment|/* this function should be called twice by the Linux-PAM library */
if|if
condition|(
name|flags
operator|&
name|PAM_PRELIM_CHECK
condition|)
block|{
comment|/* first call */
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_DEBUG
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_sm_chauthtok: prelim check"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_PRELIM
condition|)
return|return
name|PAM_TRY_AGAIN
return|;
return|return
name|PAM_SUCCESS
return|;
block|}
elseif|else
if|if
condition|(
name|flags
operator|&
name|PAM_UPDATE_AUTHTOK
condition|)
block|{
comment|/* second call */
name|struct
name|pam_message
name|msg
index|[
literal|3
index|]
decl_stmt|,
modifier|*
name|pmsg
index|[
literal|3
index|]
decl_stmt|;
name|struct
name|pam_response
modifier|*
name|resp
decl_stmt|;
specifier|const
name|char
modifier|*
name|text
decl_stmt|;
name|char
modifier|*
name|txt
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_DEBUG
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_sm_chauthtok: alter password"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_FAIL_1
condition|)
return|return
name|PAM_AUTHTOK_LOCK_BUSY
return|;
if|if
condition|(
operator|!
operator|(
name|ctrl
operator|&&
name|PAM_ST_EXPIRED
operator|)
operator|&&
operator|(
name|flags
operator|&
name|PAM_CHANGE_EXPIRED_AUTHTOK
operator|)
operator|&&
operator|(
name|pam_get_data
argument_list|(
name|pamh
argument_list|,
literal|"stress_new_pwd"
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|text
argument_list|)
operator|!=
name|PAM_SUCCESS
operator|||
name|strcmp
argument_list|(
name|text
argument_list|,
literal|"yes"
argument_list|)
operator|)
condition|)
block|{
return|return
name|PAM_SUCCESS
return|;
comment|/* the token has not expired */
block|}
comment|/* the password should be changed */
if|if
condition|(
operator|(
name|ctrl
operator|&
name|PAM_ST_REQUIRE_PWD
operator|)
operator|&&
operator|!
operator|(
name|getuid
argument_list|()
operator|==
literal|0
operator|&&
operator|(
name|ctrl
operator|&
name|PAM_ST_ROOTOK
operator|)
operator|)
condition|)
block|{
comment|/* first get old one? */
name|char
modifier|*
name|pass
decl_stmt|;
if|if
condition|(
name|ctrl
operator|&
name|PAM_ST_DEBUG
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_sm_chauthtok: getting old password"
argument_list|)
expr_stmt|;
block|}
name|retval
operator|=
name|stress_get_password
argument_list|(
name|pamh
argument_list|,
name|flags
argument_list|,
name|ctrl
argument_list|,
operator|&
name|pass
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_sm_chauthtok: no password obtained"
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
name|retval
operator|=
name|pam_set_item
argument_list|(
name|pamh
argument_list|,
name|PAM_OLDAUTHTOK
argument_list|,
name|pass
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_sm_chauthtok: could not set OLDAUTHTOK"
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|pass
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pass
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
name|_pam_overwrite
argument_list|(
name|pass
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pass
argument_list|)
expr_stmt|;
block|}
comment|/* set up for conversation */
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|PAM_SILENT
operator|)
condition|)
block|{
name|char
modifier|*
name|username
decl_stmt|;
if|if
condition|(
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|username
argument_list|)
operator|||
name|username
operator|==
name|NULL
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"no username set"
argument_list|)
expr_stmt|;
return|return
name|PAM_USER_UNKNOWN
return|;
block|}
name|pmsg
index|[
literal|0
index|]
operator|=
operator|&
name|msg
index|[
literal|0
index|]
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|msg_style
operator|=
name|PAM_TEXT_INFO
expr_stmt|;
define|#
directive|define
name|_LOCAL_STRESS_COMMENT
value|"Changing STRESS password for "
name|txt
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|_LOCAL_STRESS_COMMENT
argument_list|)
operator|+
name|strlen
argument_list|(
name|username
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|txt
argument_list|,
name|_LOCAL_STRESS_COMMENT
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|_LOCAL_STRESS_COMMENT
name|strcat
argument_list|(
name|txt
argument_list|,
name|username
argument_list|)
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|msg
operator|=
name|txt
expr_stmt|;
name|i
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
literal|0
expr_stmt|;
block|}
name|pmsg
index|[
name|i
index|]
operator|=
operator|&
name|msg
index|[
name|i
index|]
expr_stmt|;
name|msg
index|[
name|i
index|]
operator|.
name|msg_style
operator|=
name|PAM_PROMPT_ECHO_OFF
expr_stmt|;
name|msg
index|[
name|i
operator|++
index|]
operator|.
name|msg
operator|=
literal|"Enter new STRESS password: "
expr_stmt|;
name|pmsg
index|[
name|i
index|]
operator|=
operator|&
name|msg
index|[
name|i
index|]
expr_stmt|;
name|msg
index|[
name|i
index|]
operator|.
name|msg_style
operator|=
name|PAM_PROMPT_ECHO_OFF
expr_stmt|;
name|msg
index|[
name|i
operator|++
index|]
operator|.
name|msg
operator|=
literal|"Retype new STRESS password: "
expr_stmt|;
name|resp
operator|=
name|NULL
expr_stmt|;
name|retval
operator|=
name|converse
argument_list|(
name|pamh
argument_list|,
name|i
argument_list|,
name|pmsg
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|txt
condition|)
block|{
name|free
argument_list|(
name|txt
argument_list|)
expr_stmt|;
name|txt
operator|=
name|NULL
expr_stmt|;
comment|/* clean up */
block|}
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
block|{
return|return
name|retval
return|;
block|}
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|_pam_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pam_sm_chauthtok: no response from conv"
argument_list|)
expr_stmt|;
return|return
name|PAM_CONV_ERR
return|;
block|}
comment|/* store the password */
if|if
condition|(
name|resp
index|[
name|i
operator|-
literal|2
index|]
operator|.
name|resp
operator|&&
name|resp
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|resp
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|resp
index|[
name|i
operator|-
literal|2
index|]
operator|.
name|resp
argument_list|,
name|resp
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|resp
argument_list|)
condition|)
block|{
comment|/* passwords are not the same; forget and return error */
name|_pam_drop_reply
argument_list|(
name|resp
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|PAM_SILENT
operator|)
operator|&&
operator|!
operator|(
name|ctrl
operator|&
name|PAM_ST_NO_WARN
operator|)
condition|)
block|{
name|pmsg
index|[
literal|0
index|]
operator|=
operator|&
name|msg
index|[
literal|0
index|]
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|msg_style
operator|=
name|PAM_ERROR_MSG
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|msg
operator|=
literal|"Verification mis-typed; "
literal|"password unchaged"
expr_stmt|;
name|resp
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|converse
argument_list|(
name|pamh
argument_list|,
literal|1
argument_list|,
name|pmsg
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
condition|)
block|{
name|_pam_drop_reply
argument_list|(
name|resp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|PAM_AUTHTOK_ERR
return|;
block|}
if|if
condition|(
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|text
argument_list|)
operator|==
name|PAM_SUCCESS
condition|)
block|{
operator|(
name|void
operator|)
name|pam_set_item
argument_list|(
name|pamh
argument_list|,
name|PAM_OLDAUTHTOK
argument_list|,
name|text
argument_list|)
expr_stmt|;
name|text
operator|=
name|NULL
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|pam_set_item
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
name|resp
index|[
literal|0
index|]
operator|.
name|resp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|_pam_log
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_sm_chauthtok: problem with resp"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SYSTEM_ERR
expr_stmt|;
block|}
name|_pam_drop_reply
argument_list|(
name|resp
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* clean up the passwords */
block|}
else|else
block|{
name|_pam_log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"pam_sm_chauthtok: this must be a Linux-PAM error"
argument_list|)
expr_stmt|;
return|return
name|PAM_SYSTEM_ERR
return|;
block|}
return|return
name|retval
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PAM_STATIC
end_ifdef

begin_comment
comment|/* static module data */
end_comment

begin_decl_stmt
name|struct
name|pam_module
name|_pam_stress_modstruct
init|=
block|{
literal|"pam_stress"
block|,
name|pam_sm_authenticate
block|,
name|pam_sm_setcred
block|,
name|pam_sm_acct_mgmt
block|,
name|pam_sm_open_session
block|,
name|pam_sm_close_session
block|,
name|pam_sm_chauthtok
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $Id: help_env.c,v 1.2 1997/01/04 20:19:20 morgan Exp morgan $  * $FreeBSD$  *  * This file was written by Andrew G. Morgan<morgan@parc.power.net>  *  * $Log: help_env.c,v $  * Revision 1.2  1997/01/04 20:19:20  morgan  * added a prototype (no warning) and fixed paste function  *  * Revision 1.1  1996/12/01 03:25:37  morgan  * Initial revision  *  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<security/pam_misc.h>
end_include

begin_comment
comment|/*  * This is a useful function for dumping the Linux-PAM environment  * into some local memory, prior to it all getting lost when pam_end()  * is called.  *  * Initially it was assumed that libpam did not do this part correctly  * (based on a loose email definition).  The X/Open XSSO spec makes it  * clear that this function is a duplicate of the one already in  * libpam and therefore unnecessary.  IT WILL BE COMPLETELY REMOVED  * IN libpam_misc 1.0 */
end_comment

begin_function_decl
name|char
modifier|*
modifier|*
name|pam_misc_copy_env
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|char
modifier|*
modifier|*
name|pam_misc_copy_env
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|)
block|{
return|return
name|pam_getenvlist
argument_list|(
name|pamh
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * This function should be used to carefully dispose of the copied  * environment.  *  *     usage:     env = pam_misc_drop_env(env);  */
end_comment

begin_function
name|char
modifier|*
modifier|*
name|pam_misc_drop_env
parameter_list|(
name|char
modifier|*
modifier|*
name|dump
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|dump
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
operator|++
name|i
control|)
block|{
name|D
argument_list|(
operator|(
literal|"dump[%d]=`%s'"
operator|,
name|i
operator|,
name|dump
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|dump
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|dump
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|_pam_drop
argument_list|(
name|dump
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*  *  This function takes the supplied environment and uploads it to be  *  the PAM one.  */
end_comment

begin_function
name|int
name|pam_misc_paste_env
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
specifier|const
name|char
modifier|*
specifier|const
modifier|*
name|user_env
parameter_list|)
block|{
for|for
control|(
init|;
name|user_env
operator|&&
operator|*
name|user_env
condition|;
operator|++
name|user_env
control|)
block|{
name|int
name|retval
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"uploading: %s"
operator|,
operator|*
name|user_env
operator|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|pam_putenv
argument_list|(
name|pamh
argument_list|,
operator|*
name|user_env
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|D
argument_list|(
operator|(
literal|"error setting %s: %s"
operator|,
operator|*
name|user_env
operator|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|retval
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
block|}
name|D
argument_list|(
operator|(
literal|"done."
operator|)
argument_list|)
expr_stmt|;
return|return
name|PAM_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/*  * This is a wrapper to make pam behave in the way that setenv() does.  */
end_comment

begin_function
name|int
name|pam_misc_setenv
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|,
name|int
name|readonly
parameter_list|)
block|{
name|char
modifier|*
name|tmp
decl_stmt|;
name|int
name|retval
decl_stmt|;
if|if
condition|(
name|readonly
condition|)
block|{
specifier|const
name|char
modifier|*
name|etmp
decl_stmt|;
comment|/* we check if the variable is there already */
name|etmp
operator|=
name|pam_getenv
argument_list|(
name|pamh
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|etmp
operator|!=
name|NULL
condition|)
block|{
name|D
argument_list|(
operator|(
literal|"failed to set readonly variable: %s"
operator|,
name|name
operator|)
argument_list|)
expr_stmt|;
return|return
name|PAM_PERM_DENIED
return|;
comment|/* not allowed to overwrite */
block|}
block|}
name|tmp
operator|=
name|malloc
argument_list|(
literal|2
operator|+
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
name|strlen
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|!=
name|NULL
condition|)
block|{
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%s=%s"
argument_list|,
name|name
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"pam_putt()ing: %s"
operator|,
name|tmp
operator|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|pam_putenv
argument_list|(
name|pamh
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
comment|/* purge */
name|_pam_drop
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
comment|/* forget */
block|}
else|else
block|{
name|D
argument_list|(
operator|(
literal|"malloc failure"
operator|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_BUF_ERR
expr_stmt|;
block|}
return|return
name|retval
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $Id: xsh.c,v 1.3 2001/02/05 06:50:41 agmorgan Exp $  */
end_comment

begin_comment
comment|/* Andrew Morgan (morgan@kernel.org) -- an example application  * that invokes a shell, based on blank.c */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<security/pam_appl.h>
end_include

begin_include
include|#
directive|include
file|<security/pam_misc.h>
end_include

begin_comment
comment|/* ------ some local (static) functions ------- */
end_comment

begin_function
specifier|static
name|void
name|bail_out
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|really
parameter_list|,
name|int
name|code
parameter_list|,
specifier|const
name|char
modifier|*
name|fn
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"==> called %s()\n  got: `%s'\n"
argument_list|,
name|fn
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|code
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|really
operator|&&
name|code
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ------ some static data objects ------- */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|pam_conv
name|conv
init|=
block|{
name|misc_conv
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ------- the application itself -------- */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|pam_handle_t
modifier|*
name|pamh
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|username
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|service
init|=
literal|"xsh"
decl_stmt|;
name|int
name|retcode
decl_stmt|;
comment|/* did the user call with a username as an argument ?       * did they also */
if|if
condition|(
name|argc
operator|>
literal|3
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [username [service-name]]\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>=
literal|2
condition|)
block|{
name|username
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|==
literal|3
condition|)
block|{
name|service
operator|=
name|argv
index|[
literal|2
index|]
expr_stmt|;
block|}
comment|/* initialize the Linux-PAM library */
name|retcode
operator|=
name|pam_start
argument_list|(
name|service
argument_list|,
name|username
argument_list|,
operator|&
name|conv
argument_list|,
operator|&
name|pamh
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|1
argument_list|,
name|retcode
argument_list|,
literal|"pam_start"
argument_list|)
expr_stmt|;
comment|/* to avoid using goto we abuse a loop here */
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* authenticate the user --- `0' here, could have been PAM_SILENT 	   *	| PAM_DISALLOW_NULL_AUTHTOK */
name|retcode
operator|=
name|pam_authenticate
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_authenticate"
argument_list|)
expr_stmt|;
comment|/* has the user proved themself valid? */
if|if
condition|(
name|retcode
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: invalid request\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* the user is valid, but should they have access at this 	     time? */
name|retcode
operator|=
name|pam_acct_mgmt
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* `0' could be as above */
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_acct_mgmt"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|==
name|PAM_NEW_AUTHTOK_REQD
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Application must request new password...\n"
argument_list|)
expr_stmt|;
name|retcode
operator|=
name|pam_chauthtok
argument_list|(
name|pamh
argument_list|,
name|PAM_CHANGE_EXPIRED_AUTHTOK
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_chauthtok"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|retcode
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: invalid request\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* `0' could be as above */
name|retcode
operator|=
name|pam_setcred
argument_list|(
name|pamh
argument_list|,
name|PAM_ESTABLISH_CRED
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_setcred"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: problem setting user credentials\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* open a session for the user --- `0' could be PAM_SILENT */
name|retcode
operator|=
name|pam_open_session
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_open_session"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: problem opening a session\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|username
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"The user [%s] has been authenticated and `logged in'\n"
argument_list|,
name|username
argument_list|)
expr_stmt|;
comment|/* this is always a really bad thing for security! */
name|system
argument_list|(
literal|"/bin/sh"
argument_list|)
expr_stmt|;
comment|/* close a session for the user --- `0' could be PAM_SILENT 	   * it is possible that this pam_close_call is in another program.. 	   */
name|retcode
operator|=
name|pam_close_session
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_close_session"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: problem closing a session\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* `0' could be as above */
name|retcode
operator|=
name|pam_setcred
argument_list|(
name|pamh
argument_list|,
name|PAM_DELETE_CRED
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_setcred"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: problem deleting user credentials\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
comment|/* don't go on for ever! */
block|}
comment|/* close the Linux-PAM library */
name|retcode
operator|=
name|pam_end
argument_list|(
name|pamh
argument_list|,
name|PAM_SUCCESS
argument_list|)
expr_stmt|;
name|pamh
operator|=
name|NULL
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|1
argument_list|,
name|retcode
argument_list|,
literal|"pam_end"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


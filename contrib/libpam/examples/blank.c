begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $Id: blank.c,v 1.7 1996/12/01 03:16:53 morgan Exp morgan $  *  * $Log: blank.c,v $  * Revision 1.7  1996/12/01 03:16:53  morgan  * added setcred closing function  *  * Revision 1.6  1996/11/10 19:51:40  morgan  * minor change to avoid gcc warning  *  * Revision 1.5  1996/07/07 23:53:05  morgan  * added optional fail delay (non-standard Linux-PAM)  *  * Revision 1.4  1996/05/02 04:44:18  morgan  * moved conversation to a libmisc library routine.  *  *  */
end_comment

begin_comment
comment|/* Andrew Morgan (morgan@parc.power.net) -- a self contained `blank'  * application  *  * I am not very proud of this code.  It makes use of a possibly ill-  * defined pamh pointer to call pam_strerror() with.  The reason that  * I was sloppy with this is historical (pam_strerror, prior to 0.59,  * did not require a pamh argument) and if this program is used as a  * model for anything, I should wish that you will take this error into  * account.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<security/pam_appl.h>
end_include

begin_include
include|#
directive|include
file|<security/pam_misc.h>
end_include

begin_comment
comment|/* ------ some local (static) functions ------- */
end_comment

begin_function
specifier|static
name|void
name|bail_out
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|really
parameter_list|,
name|int
name|code
parameter_list|,
specifier|const
name|char
modifier|*
name|fn
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"==> called %s()\n  got: `%s'\n"
argument_list|,
name|fn
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|code
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|really
operator|&&
name|code
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ------ some static data objects ------- */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|pam_conv
name|conv
init|=
block|{
name|misc_conv
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ------- the application itself -------- */
end_comment

begin_function
name|void
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|pam_handle_t
modifier|*
name|pamh
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|username
init|=
name|NULL
decl_stmt|;
name|int
name|retcode
decl_stmt|;
comment|/* did the user call with a username as an argument ? */
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [username]\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
block|{
name|username
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
block|}
comment|/* initialize the Linux-PAM library */
name|retcode
operator|=
name|pam_start
argument_list|(
literal|"blank"
argument_list|,
name|username
argument_list|,
operator|&
name|conv
argument_list|,
operator|&
name|pamh
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|1
argument_list|,
name|retcode
argument_list|,
literal|"pam_start"
argument_list|)
expr_stmt|;
comment|/* test the environment stuff */
block|{
define|#
directive|define
name|MAXENV
value|15
specifier|const
name|char
modifier|*
name|greek
index|[
name|MAXENV
index|]
init|=
block|{
literal|"a=alpha"
block|,
literal|"b=beta"
block|,
literal|"c=gamma"
block|,
literal|"d=delta"
block|,
literal|"e=epsilon"
block|,
literal|"f=phi"
block|,
literal|"g=psi"
block|,
literal|"h=eta"
block|,
literal|"i=iota"
block|,
literal|"j=mu"
block|,
literal|"k=nu"
block|,
literal|"l=zeta"
block|,
literal|"h="
block|,
literal|"d"
block|,
literal|"k=xi"
block|}
decl_stmt|;
name|char
modifier|*
modifier|*
name|env
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXENV
condition|;
operator|++
name|i
control|)
block|{
name|retcode
operator|=
name|pam_putenv
argument_list|(
name|pamh
argument_list|,
name|greek
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_putenv"
argument_list|)
expr_stmt|;
block|}
name|env
operator|=
name|pam_getenvlist
argument_list|(
name|pamh
argument_list|)
expr_stmt|;
if|if
condition|(
name|env
condition|)
name|env
operator|=
name|pam_misc_drop_env
argument_list|(
name|env
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"???\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"a test: c=[%s], j=[%s]\n"
argument_list|,
name|pam_getenv
argument_list|(
name|pamh
argument_list|,
literal|"c"
argument_list|)
argument_list|,
name|pam_getenv
argument_list|(
name|pamh
argument_list|,
literal|"j"
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* to avoid using goto we abuse a loop here */
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* authenticate the user --- `0' here, could have been PAM_SILENT 	   *	| PAM_DISALLOW_NULL_AUTHTOK */
name|retcode
operator|=
name|pam_authenticate
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_authenticate"
argument_list|)
expr_stmt|;
comment|/* has the user proved themself valid? */
if|if
condition|(
name|retcode
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: invalid request\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* the user is valid, but should they have access at this 	     time? */
name|retcode
operator|=
name|pam_acct_mgmt
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* `0' could be as above */
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_acct_mgmt"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|==
name|PAM_NEW_AUTHTOK_REQD
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Application must request new password...\n"
argument_list|)
expr_stmt|;
name|retcode
operator|=
name|pam_chauthtok
argument_list|(
name|pamh
argument_list|,
name|PAM_CHANGE_EXPIRED_AUTHTOK
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_chauthtok"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|retcode
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: invalid request\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* `0' could be as above */
name|retcode
operator|=
name|pam_setcred
argument_list|(
name|pamh
argument_list|,
name|PAM_ESTABLISH_CRED
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_setcred1"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: problem setting user credentials\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* open a session for the user --- `0' could be PAM_SILENT */
name|retcode
operator|=
name|pam_open_session
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_open_session"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: problem opening a session\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"The user has been authenticated and `logged in'\n"
argument_list|)
expr_stmt|;
comment|/* close a session for the user --- `0' could be PAM_SILENT 	   * it is possible that this pam_close_call is in another program.. 	   */
name|retcode
operator|=
name|pam_close_session
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_close_session"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: problem closing a session\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
name|retcode
operator|=
name|pam_setcred
argument_list|(
name|pamh
argument_list|,
name|PAM_DELETE_CRED
argument_list|)
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|,
name|retcode
argument_list|,
literal|"pam_setcred2"
argument_list|)
expr_stmt|;
break|break;
comment|/* don't go on for ever! */
block|}
comment|/* close the Linux-PAM library */
name|retcode
operator|=
name|pam_end
argument_list|(
name|pamh
argument_list|,
name|PAM_SUCCESS
argument_list|)
expr_stmt|;
name|pamh
operator|=
name|NULL
expr_stmt|;
name|bail_out
argument_list|(
name|pamh
argument_list|,
literal|1
argument_list|,
name|retcode
argument_list|,
literal|"pam_end"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


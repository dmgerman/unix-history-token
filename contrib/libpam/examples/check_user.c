begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   $Id: check_user.c,v 1.2 2000/12/04 19:02:33 baggins Exp $      This program was contributed by Shane Watts<shane@icarus.bofh.asn.au>   slight modifications by AGM.    You need to add the following (or equivalent) to the /etc/pam.conf file.   # check authorization   check   auth       required     pam_unix_auth.so   check   account    required     pam_unix_acct.so */
end_comment

begin_include
include|#
directive|include
file|<security/pam_appl.h>
end_include

begin_include
include|#
directive|include
file|<security/pam_misc.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_decl_stmt
specifier|static
name|struct
name|pam_conv
name|conv
init|=
block|{
name|misc_conv
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|pam_handle_t
modifier|*
name|pamh
init|=
name|NULL
decl_stmt|;
name|int
name|retval
decl_stmt|;
specifier|const
name|char
modifier|*
name|user
init|=
literal|"nobody"
decl_stmt|;
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
block|{
name|user
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: check_user [username]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|retval
operator|=
name|pam_start
argument_list|(
literal|"check"
argument_list|,
name|user
argument_list|,
operator|&
name|conv
argument_list|,
operator|&
name|pamh
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|==
name|PAM_SUCCESS
condition|)
name|retval
operator|=
name|pam_authenticate
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* is user really user? */
if|if
condition|(
name|retval
operator|==
name|PAM_SUCCESS
condition|)
name|retval
operator|=
name|pam_acct_mgmt
argument_list|(
name|pamh
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* permitted access? */
comment|/* This is where we have been authorized or not. */
if|if
condition|(
name|retval
operator|==
name|PAM_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Authenticated\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Not Authenticated\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pam_end
argument_list|(
name|pamh
argument_list|,
name|retval
argument_list|)
operator|!=
name|PAM_SUCCESS
condition|)
block|{
comment|/* close Linux-PAM */
name|pamh
operator|=
name|NULL
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"check_user: failed to release authenticator\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|retval
operator|==
name|PAM_SUCCESS
condition|?
literal|0
else|:
literal|1
operator|)
return|;
comment|/* indicate success */
block|}
end_function

end_unit


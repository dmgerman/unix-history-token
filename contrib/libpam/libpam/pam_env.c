begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * pam_env.c  *  * Copyright (c) Andrew G. Morgan<morgan@parc.power.net> 1996,1997  * All rights reserved.  *  * This file was written from a "hint" provided by the people at SUN.  * and the X/Open XSSO draft of March 1997.  *  * $Id: pam_env.c,v 1.2 1997/02/15 15:56:48 morgan Exp morgan $  * $FreeBSD$  *  * $Log: pam_env.c,v $  * Revision 1.2  1997/02/15 15:56:48  morgan  * liberate pamh->env structure too!  *  * Revision 1.1  1996/12/01 03:14:13  morgan  * Initial revision  */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|sunos
end_ifdef

begin_define
define|#
directive|define
name|memmove
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|bcopy(y,x,z)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"pam_private.h"
end_include

begin_comment
comment|/* helper functions */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_function
specifier|static
name|void
name|_pam_dump_env
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"Listing environment of pamh=%p"
operator|,
name|pamh
operator|)
argument_list|)
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"pamh->env = %p"
operator|,
name|pamh
operator|->
name|env
operator|)
argument_list|)
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"environment entries used = %d [of %d allocated]"
operator|,
name|pamh
operator|->
name|env
operator|->
name|requested
operator|,
name|pamh
operator|->
name|env
operator|->
name|entries
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pamh
operator|->
name|env
operator|->
name|requested
condition|;
operator|++
name|i
control|)
block|{
name|_pam_output_debug
argument_list|(
literal|">%-3d [%9p]:[%s]"
argument_list|,
name|i
argument_list|,
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|i
index|]
argument_list|,
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|_pam_output_debug
argument_list|(
literal|"*NOTE* the last item should be (nil)"
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|_pam_dump_env
parameter_list|(
name|x
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Create the environment  */
end_comment

begin_function
name|int
name|_pam_make_env
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|)
block|{
name|D
argument_list|(
operator|(
literal|"called."
operator|)
argument_list|)
expr_stmt|;
name|IF_NO_PAMH
argument_list|(
literal|"_pam_make_env"
argument_list|,
name|pamh
argument_list|,
name|PAM_ABORT
argument_list|)
expr_stmt|;
comment|/*      * get structure memory      */
name|pamh
operator|->
name|env
operator|=
operator|(
expr|struct
name|pam_environ
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|pam_environ
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pamh
operator|->
name|env
operator|==
name|NULL
condition|)
block|{
name|pam_system_log
argument_list|(
name|pamh
argument_list|,
name|NULL
argument_list|,
name|LOG_CRIT
argument_list|,
literal|"_pam_make_env: out of memory"
argument_list|)
expr_stmt|;
return|return
name|PAM_BUF_ERR
return|;
block|}
comment|/*      * get list memory      */
name|pamh
operator|->
name|env
operator|->
name|list
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|calloc
argument_list|(
name|PAM_ENV_CHUNK
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pamh
operator|->
name|env
operator|->
name|list
operator|==
name|NULL
condition|)
block|{
name|pam_system_log
argument_list|(
name|pamh
argument_list|,
name|NULL
argument_list|,
name|LOG_CRIT
argument_list|,
literal|"_pam_make_env: no memory for list"
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|env
argument_list|)
expr_stmt|;
return|return
name|PAM_BUF_ERR
return|;
block|}
comment|/*      * fill entries in pamh->env      */
name|pamh
operator|->
name|env
operator|->
name|entries
operator|=
name|PAM_ENV_CHUNK
expr_stmt|;
name|pamh
operator|->
name|env
operator|->
name|requested
operator|=
literal|1
expr_stmt|;
name|pamh
operator|->
name|env
operator|->
name|list
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
name|_pam_dump_env
argument_list|(
name|pamh
argument_list|)
expr_stmt|;
comment|/* only active when debugging */
return|return
name|PAM_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/*  * purge the environment  */
end_comment

begin_function
name|void
name|_pam_drop_env
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|)
block|{
name|D
argument_list|(
operator|(
literal|"called."
operator|)
argument_list|)
expr_stmt|;
name|IF_NO_PAMH
argument_list|(
literal|"_pam_make_env"
argument_list|,
name|pamh
argument_list|,
comment|/* nothing to return */
argument_list|)
expr_stmt|;
if|if
condition|(
name|pamh
operator|->
name|env
operator|!=
name|NULL
condition|)
block|{
name|int
name|i
decl_stmt|;
comment|/* we will only purge the pamh->env->requested number of elements */
for|for
control|(
name|i
operator|=
name|pamh
operator|->
name|env
operator|->
name|requested
operator|-
literal|1
init|;
name|i
operator|--
operator|>
literal|0
condition|;
control|)
block|{
name|D
argument_list|(
operator|(
literal|"dropping #%3d>%s<"
operator|,
name|i
operator|,
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* clean */
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* forget */
block|}
name|pamh
operator|->
name|env
operator|->
name|requested
operator|=
literal|0
expr_stmt|;
name|pamh
operator|->
name|env
operator|->
name|entries
operator|=
literal|0
expr_stmt|;
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|env
operator|->
name|list
argument_list|)
expr_stmt|;
comment|/* forget */
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|env
argument_list|)
expr_stmt|;
comment|/* forget */
block|}
else|else
block|{
name|D
argument_list|(
operator|(
literal|"no environment present in pamh?"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Return the item number of the given variable = first 'length' chars  * of 'name_value'. Since this is a static function, it is safe to  * assume its supplied arguments are well defined.  */
end_comment

begin_function
specifier|static
name|int
name|_pam_search_env
parameter_list|(
specifier|const
name|struct
name|pam_environ
modifier|*
name|env
parameter_list|,
specifier|const
name|char
modifier|*
name|name_value
parameter_list|,
name|int
name|length
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|env
operator|->
name|requested
operator|-
literal|1
init|;
name|i
operator|--
operator|>
literal|0
condition|;
control|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|name_value
argument_list|,
name|env
operator|->
name|list
index|[
name|i
index|]
argument_list|,
name|length
argument_list|)
operator|==
literal|0
operator|&&
name|env
operator|->
name|list
index|[
name|i
index|]
index|[
name|length
index|]
operator|==
literal|'='
condition|)
block|{
return|return
name|i
return|;
comment|/* Got it! */
block|}
block|}
return|return
operator|-
literal|1
return|;
comment|/* no luck */
block|}
end_function

begin_comment
comment|/*  * externally visible functions  */
end_comment

begin_comment
comment|/*  *  pam_putenv(): Add/replace/delete a PAM-environment variable.  *  *  Add/replace:  *      name_value = "NAME=VALUE" or "NAME=" (for empty value="\0")  *  *  delete:  *      name_value = "NAME"  */
end_comment

begin_function
name|int
name|pam_putenv
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
specifier|const
name|char
modifier|*
name|name_value
parameter_list|)
block|{
name|int
name|l2eq
decl_stmt|,
name|item
decl_stmt|,
name|retval
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"called."
operator|)
argument_list|)
expr_stmt|;
name|IF_NO_PAMH
argument_list|(
literal|"pam_putenv"
argument_list|,
name|pamh
argument_list|,
name|PAM_ABORT
argument_list|)
expr_stmt|;
if|if
condition|(
name|name_value
operator|==
name|NULL
condition|)
block|{
name|pam_system_log
argument_list|(
name|pamh
argument_list|,
name|NULL
argument_list|,
name|LOG_ERR
argument_list|,
literal|"pam_putenv: no variable indicated"
argument_list|)
expr_stmt|;
return|return
name|PAM_PERM_DENIED
return|;
block|}
comment|/*      * establish if we are setting or deleting; scan for '='      */
for|for
control|(
name|l2eq
operator|=
literal|0
init|;
name|name_value
index|[
name|l2eq
index|]
operator|&&
name|name_value
index|[
name|l2eq
index|]
operator|!=
literal|'='
condition|;
operator|++
name|l2eq
control|)
empty_stmt|;
if|if
condition|(
name|l2eq
operator|<=
literal|0
condition|)
block|{
name|pam_system_log
argument_list|(
name|pamh
argument_list|,
name|NULL
argument_list|,
name|LOG_ERR
argument_list|,
literal|"pam_putenv: bad variable"
argument_list|)
expr_stmt|;
return|return
name|PAM_BAD_ITEM
return|;
block|}
comment|/*      *  Look first for environment.      */
if|if
condition|(
name|pamh
operator|->
name|env
operator|==
name|NULL
operator|||
name|pamh
operator|->
name|env
operator|->
name|list
operator|==
name|NULL
condition|)
block|{
name|pam_system_log
argument_list|(
name|pamh
argument_list|,
name|NULL
argument_list|,
name|LOG_ERR
argument_list|,
literal|"pam_putenv: no env%s found"
argument_list|,
name|pamh
operator|->
name|env
operator|==
name|NULL
condition|?
literal|""
else|:
literal|"-list"
argument_list|)
expr_stmt|;
return|return
name|PAM_ABORT
return|;
block|}
comment|/* find the item to replace */
name|item
operator|=
name|_pam_search_env
argument_list|(
name|pamh
operator|->
name|env
argument_list|,
name|name_value
argument_list|,
name|l2eq
argument_list|)
expr_stmt|;
if|if
condition|(
name|name_value
index|[
name|l2eq
index|]
condition|)
block|{
comment|/* (re)setting */
if|if
condition|(
name|item
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* new variable */
name|D
argument_list|(
operator|(
literal|"adding item: %s"
operator|,
name|name_value
operator|)
argument_list|)
expr_stmt|;
comment|/* enough space? */
if|if
condition|(
name|pamh
operator|->
name|env
operator|->
name|entries
operator|<=
name|pamh
operator|->
name|env
operator|->
name|requested
condition|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|tmp
decl_stmt|;
comment|/* get some new space */
name|tmp
operator|=
name|calloc
argument_list|(
name|pamh
operator|->
name|env
operator|->
name|entries
operator|+
name|PAM_ENV_CHUNK
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
comment|/* nothing has changed - old env intact */
name|pam_system_log
argument_list|(
name|pamh
argument_list|,
name|NULL
argument_list|,
name|LOG_CRIT
argument_list|,
literal|"pam_putenv: cannot grow environment"
argument_list|)
expr_stmt|;
return|return
name|PAM_BUF_ERR
return|;
block|}
comment|/* copy old env-item pointers/forget old */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pamh
operator|->
name|env
operator|->
name|requested
condition|;
operator|++
name|i
control|)
block|{
name|tmp
index|[
name|i
index|]
operator|=
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|i
index|]
expr_stmt|;
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* drop old list and replace with new */
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|env
operator|->
name|list
argument_list|)
expr_stmt|;
name|pamh
operator|->
name|env
operator|->
name|list
operator|=
name|tmp
expr_stmt|;
name|pamh
operator|->
name|env
operator|->
name|entries
operator|+=
name|PAM_ENV_CHUNK
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"resized env list"
operator|)
argument_list|)
expr_stmt|;
name|_pam_dump_env
argument_list|(
name|pamh
argument_list|)
expr_stmt|;
comment|/* only when debugging */
block|}
name|item
operator|=
name|pamh
operator|->
name|env
operator|->
name|requested
operator|-
literal|1
expr_stmt|;
comment|/* old last item (NULL) */
comment|/* add a new NULL entry at end; increase counter */
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|pamh
operator|->
name|env
operator|->
name|requested
operator|++
index|]
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
comment|/* replace old */
name|D
argument_list|(
operator|(
literal|"replacing item: %s\n          with: %s"
operator|,
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|item
index|]
operator|,
name|name_value
operator|)
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|item
index|]
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|item
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * now we have a place to put the new env-item, insert at 'item' 	 */
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|item
index|]
operator|=
name|_pam_strdup
argument_list|(
name|name_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|item
index|]
operator|!=
name|NULL
condition|)
block|{
name|_pam_dump_env
argument_list|(
name|pamh
argument_list|)
expr_stmt|;
comment|/* only when debugging */
return|return
name|PAM_SUCCESS
return|;
block|}
comment|/* something went wrong; we should delete the item - fall through */
name|retval
operator|=
name|PAM_BUF_ERR
expr_stmt|;
comment|/* an error occurred */
block|}
else|else
block|{
name|retval
operator|=
name|PAM_SUCCESS
expr_stmt|;
comment|/* we requested delete */
block|}
comment|/* getting to here implies we are deleting an item */
if|if
condition|(
name|item
operator|<
literal|0
condition|)
block|{
name|pam_system_log
argument_list|(
name|pamh
argument_list|,
name|NULL
argument_list|,
name|LOG_ERR
argument_list|,
literal|"pam_putenv: delete non-existent entry; %s"
argument_list|,
name|name_value
argument_list|)
expr_stmt|;
return|return
name|PAM_BAD_ITEM
return|;
block|}
comment|/*      * remove item: purge memory; reset counter; resize [; display-env]      */
name|D
argument_list|(
operator|(
literal|"deleting: env#%3d:[%s]"
operator|,
name|item
operator|,
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|item
index|]
operator|)
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|item
index|]
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|item
index|]
argument_list|)
expr_stmt|;
operator|--
operator|(
name|pamh
operator|->
name|env
operator|->
name|requested
operator|)
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"mmove: item[%d]+%d -> item[%d]"
operator|,
name|item
operator|+
literal|1
operator|,
operator|(
name|pamh
operator|->
name|env
operator|->
name|requested
operator|-
name|item
operator|)
operator|,
name|item
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memmove
argument_list|(
operator|&
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|item
index|]
argument_list|,
operator|&
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|item
operator|+
literal|1
index|]
argument_list|,
operator|(
name|pamh
operator|->
name|env
operator|->
name|requested
operator|-
name|item
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|_pam_dump_env
argument_list|(
name|pamh
argument_list|)
expr_stmt|;
comment|/* only when debugging */
comment|/*      * deleted.      */
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/*  *  Return the value of the requested environment variable  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|pam_getenv
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|item
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"called."
operator|)
argument_list|)
expr_stmt|;
name|IF_NO_PAMH
argument_list|(
literal|"pam_getenv"
argument_list|,
name|pamh
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
name|pam_system_log
argument_list|(
name|pamh
argument_list|,
name|NULL
argument_list|,
name|LOG_ERR
argument_list|,
literal|"pam_getenv: no variable indicated"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|pamh
operator|->
name|env
operator|==
name|NULL
operator|||
name|pamh
operator|->
name|env
operator|->
name|list
operator|==
name|NULL
condition|)
block|{
name|pam_system_log
argument_list|(
name|pamh
argument_list|,
name|NULL
argument_list|,
name|LOG_ERR
argument_list|,
literal|"pam_getenv: no env%s found"
argument_list|,
name|pamh
operator|->
name|env
operator|==
name|NULL
condition|?
literal|""
else|:
literal|"-list"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* find the requested item */
name|item
operator|=
name|_pam_search_env
argument_list|(
name|pamh
operator|->
name|env
argument_list|,
name|name
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|item
operator|!=
operator|-
literal|1
condition|)
block|{
name|D
argument_list|(
operator|(
literal|"env-item: %s, found!"
operator|,
name|name
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|item
index|]
operator|+
literal|1
operator|+
name|strlen
argument_list|(
name|name
argument_list|)
operator|)
return|;
block|}
else|else
block|{
name|D
argument_list|(
operator|(
literal|"env-item: %s, not found"
operator|,
name|name
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
modifier|*
name|_copy_env
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|dump
decl_stmt|;
name|int
name|i
init|=
name|pamh
operator|->
name|env
operator|->
name|requested
decl_stmt|;
comment|/* reckon size of environment */
name|char
modifier|*
specifier|const
modifier|*
name|env
init|=
name|pamh
operator|->
name|env
operator|->
name|list
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"now get some memory for dump"
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate some memory for this (plus the null tail-pointer) */
name|dump
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|calloc
argument_list|(
name|i
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"dump = %p"
operator|,
name|dump
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* now run through entries and copy the variables over */
name|dump
index|[
operator|--
name|i
index|]
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|i
operator|--
operator|>
literal|0
condition|)
block|{
name|D
argument_list|(
operator|(
literal|"env[%d]=`%s'"
operator|,
name|i
operator|,
name|env
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
name|dump
index|[
name|i
index|]
operator|=
name|_pam_strdup
argument_list|(
name|env
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"->dump[%d]=`%s'"
operator|,
name|i
operator|,
name|dump
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
comment|/* out of memory */
while|while
condition|(
name|dump
index|[
operator|++
name|i
index|]
condition|)
block|{
name|_pam_overwrite
argument_list|(
name|dump
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|dump
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
block|}
name|env
operator|=
name|NULL
expr_stmt|;
comment|/* forget now */
comment|/* return transcribed environment */
return|return
name|dump
return|;
block|}
end_function

begin_function
name|char
modifier|*
modifier|*
name|pam_getenvlist
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"called."
operator|)
argument_list|)
expr_stmt|;
name|IF_NO_PAMH
argument_list|(
literal|"pam_getenvlist"
argument_list|,
name|pamh
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pamh
operator|->
name|env
operator|==
name|NULL
operator|||
name|pamh
operator|->
name|env
operator|->
name|list
operator|==
name|NULL
condition|)
block|{
name|pam_system_log
argument_list|(
name|pamh
argument_list|,
name|NULL
argument_list|,
name|LOG_ERR
argument_list|,
literal|"pam_getenvlist: no env%s found"
argument_list|,
name|pamh
operator|->
name|env
operator|==
name|NULL
condition|?
literal|""
else|:
literal|"-list"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* some quick checks */
if|if
condition|(
name|pamh
operator|->
name|env
operator|->
name|requested
operator|>
name|pamh
operator|->
name|env
operator|->
name|entries
condition|)
block|{
name|pam_system_log
argument_list|(
name|pamh
argument_list|,
name|NULL
argument_list|,
name|LOG_ERR
argument_list|,
literal|"pam_getenvlist: environment corruption"
argument_list|)
expr_stmt|;
name|_pam_dump_env
argument_list|(
name|pamh
argument_list|)
expr_stmt|;
comment|/* only active when debugging */
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
name|pamh
operator|->
name|env
operator|->
name|requested
operator|-
literal|1
init|;
name|i
operator|--
operator|>
literal|0
condition|;
control|)
block|{
if|if
condition|(
name|pamh
operator|->
name|env
operator|->
name|list
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|pam_system_log
argument_list|(
name|pamh
argument_list|,
name|NULL
argument_list|,
name|LOG_ERR
argument_list|,
literal|"pam_getenvlist: environment broken"
argument_list|)
expr_stmt|;
name|_pam_dump_env
argument_list|(
name|pamh
argument_list|)
expr_stmt|;
comment|/* only active when debugging */
return|return
name|NULL
return|;
comment|/* somehow we've broken the environment!? */
block|}
block|}
comment|/* Seems fine; copy environment */
name|_pam_dump_env
argument_list|(
name|pamh
argument_list|)
expr_stmt|;
comment|/* only active when debugging */
return|return
name|_copy_env
argument_list|(
name|pamh
argument_list|)
return|;
block|}
end_function

end_unit


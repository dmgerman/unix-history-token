begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* pam_end.c */
end_comment

begin_comment
comment|/*  * $Id: pam_end.c,v 1.5 1996/12/01 03:14:13 morgan Exp $  * $FreeBSD$  *  * $Log: pam_end.c,v $  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|"pam_private.h"
end_include

begin_function
name|int
name|pam_end
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|pam_status
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|IF_NO_PAMH
argument_list|(
literal|"pam_end"
argument_list|,
name|pamh
argument_list|,
name|PAM_SYSTEM_ERR
argument_list|)
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"entering pam_end()"
operator|)
argument_list|)
expr_stmt|;
comment|/* first liberate the modules (it is not inconcevible that the        modules may need to use the service_name etc. to clean up) */
name|_pam_free_data
argument_list|(
name|pamh
argument_list|,
name|pam_status
argument_list|)
expr_stmt|;
comment|/* now drop all modules */
if|if
condition|(
operator|(
name|ret
operator|=
name|_pam_free_handlers
argument_list|(
name|pamh
argument_list|)
operator|)
operator|!=
name|PAM_SUCCESS
condition|)
block|{
return|return
name|ret
return|;
comment|/* error occurred */
block|}
comment|/* from this point we cannot call the modules any more. Free the remaining        memory used by the Linux-PAM interface */
name|_pam_drop_env
argument_list|(
name|pamh
argument_list|)
expr_stmt|;
comment|/* purge the environment */
name|_pam_overwrite
argument_list|(
name|pamh
operator|->
name|authtok
argument_list|)
expr_stmt|;
comment|/* blank out old token */
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|authtok
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|pamh
operator|->
name|oldauthtok
argument_list|)
expr_stmt|;
comment|/* blank out old token */
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|oldauthtok
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|pamh
operator|->
name|former
operator|.
name|prompt
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|former
operator|.
name|prompt
argument_list|)
expr_stmt|;
comment|/* drop saved prompt */
name|_pam_overwrite
argument_list|(
name|pamh
operator|->
name|service_name
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|service_name
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|pamh
operator|->
name|user
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|user
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|pamh
operator|->
name|prompt
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|prompt
argument_list|)
expr_stmt|;
comment|/* prompt for pam_get_user() */
name|_pam_overwrite
argument_list|(
name|pamh
operator|->
name|tty
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|tty
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|pamh
operator|->
name|rhost
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|rhost
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|pamh
operator|->
name|ruser
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|ruser
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|pam_conversation
argument_list|)
expr_stmt|;
name|pamh
operator|->
name|fail_delay
operator|.
name|delay_fn_ptr
operator|=
name|NULL
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|pamh
operator|->
name|pam_default_log
operator|.
name|ident
argument_list|)
expr_stmt|;
name|_pam_drop
argument_list|(
name|pamh
operator|->
name|pam_default_log
operator|.
name|ident
argument_list|)
expr_stmt|;
comment|/* and finally liberate the memory for the pam_handle structure */
name|_pam_drop
argument_list|(
name|pamh
argument_list|)
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"exiting pam_end() successfully"
operator|)
argument_list|)
expr_stmt|;
return|return
name|PAM_SUCCESS
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2010 Kai Wang  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"_libdwarf.h"
end_include

begin_expr_stmt
name|ELFTC_VCSID
argument_list|(
literal|"$Id: dwarf_pro_frame.c 2074 2011-10-27 03:34:33Z jkoshy $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|Dwarf_P_Fde
name|dwarf_new_fde
parameter_list|(
name|Dwarf_P_Debug
name|dbg
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_P_Fde
name|fde
decl_stmt|;
if|if
condition|(
name|dbg
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_ARGUMENT
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLV_BADADDR
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|fde
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|_Dwarf_Fde
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLV_BADADDR
operator|)
return|;
block|}
name|fde
operator|->
name|fde_dbg
operator|=
name|dbg
expr_stmt|;
return|return
operator|(
name|fde
operator|)
return|;
block|}
end_function

begin_function
name|Dwarf_Unsigned
name|dwarf_add_frame_cie
parameter_list|(
name|Dwarf_P_Debug
name|dbg
parameter_list|,
name|char
modifier|*
name|augmenter
parameter_list|,
name|Dwarf_Small
name|caf
parameter_list|,
name|Dwarf_Small
name|daf
parameter_list|,
name|Dwarf_Small
name|ra
parameter_list|,
name|Dwarf_Ptr
name|initinst
parameter_list|,
name|Dwarf_Unsigned
name|inst_len
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_P_Cie
name|cie
decl_stmt|;
if|if
condition|(
name|dbg
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_ARGUMENT
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLV_NOCOUNT
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|cie
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|_Dwarf_Cie
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLV_NOCOUNT
operator|)
return|;
block|}
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|dbg
operator|->
name|dbgp_cielist
argument_list|,
name|cie
argument_list|,
name|cie_next
argument_list|)
expr_stmt|;
name|cie
operator|->
name|cie_index
operator|=
name|dbg
operator|->
name|dbgp_cielen
operator|++
expr_stmt|;
if|if
condition|(
name|augmenter
operator|!=
name|NULL
condition|)
block|{
name|cie
operator|->
name|cie_augment
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|strdup
argument_list|(
name|augmenter
argument_list|)
expr_stmt|;
if|if
condition|(
name|cie
operator|->
name|cie_augment
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLV_NOCOUNT
operator|)
return|;
block|}
block|}
name|cie
operator|->
name|cie_caf
operator|=
name|caf
expr_stmt|;
name|cie
operator|->
name|cie_daf
operator|=
operator|(
name|int8_t
operator|)
name|daf
expr_stmt|;
comment|/* daf is signed. */
name|cie
operator|->
name|cie_ra
operator|=
name|ra
expr_stmt|;
if|if
condition|(
name|initinst
operator|!=
name|NULL
operator|&&
name|inst_len
operator|>
literal|0
condition|)
block|{
name|cie
operator|->
name|cie_initinst
operator|=
name|malloc
argument_list|(
operator|(
name|size_t
operator|)
name|inst_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cie
operator|->
name|cie_initinst
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLV_NOCOUNT
operator|)
return|;
block|}
name|memcpy
argument_list|(
name|cie
operator|->
name|cie_initinst
argument_list|,
name|initinst
argument_list|,
name|inst_len
argument_list|)
expr_stmt|;
name|cie
operator|->
name|cie_instlen
operator|=
name|inst_len
expr_stmt|;
block|}
return|return
operator|(
name|cie
operator|->
name|cie_index
operator|)
return|;
block|}
end_function

begin_function
name|Dwarf_Unsigned
name|dwarf_add_frame_fde
parameter_list|(
name|Dwarf_P_Debug
name|dbg
parameter_list|,
name|Dwarf_P_Fde
name|fde
parameter_list|,
name|Dwarf_P_Die
name|die
parameter_list|,
name|Dwarf_Unsigned
name|cie
parameter_list|,
name|Dwarf_Addr
name|virt_addr
parameter_list|,
name|Dwarf_Unsigned
name|code_len
parameter_list|,
name|Dwarf_Unsigned
name|symbol_index
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
return|return
operator|(
name|dwarf_add_frame_fde_b
argument_list|(
name|dbg
argument_list|,
name|fde
argument_list|,
name|die
argument_list|,
name|cie
argument_list|,
name|virt_addr
argument_list|,
name|code_len
argument_list|,
name|symbol_index
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|error
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|Dwarf_Unsigned
name|dwarf_add_frame_fde_b
parameter_list|(
name|Dwarf_P_Debug
name|dbg
parameter_list|,
name|Dwarf_P_Fde
name|fde
parameter_list|,
name|Dwarf_P_Die
name|die
parameter_list|,
name|Dwarf_Unsigned
name|cie
parameter_list|,
name|Dwarf_Addr
name|virt_addr
parameter_list|,
name|Dwarf_Unsigned
name|code_len
parameter_list|,
name|Dwarf_Unsigned
name|symbol_index
parameter_list|,
name|Dwarf_Unsigned
name|end_symbol_index
parameter_list|,
name|Dwarf_Addr
name|offset_from_end_sym
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_P_Cie
name|ciep
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* 	 * XXX SGI libdwarf need the DIE arg because later it will insert a 	 * DW_AT_MIPS_fde attribute, which points to the offset the 	 * correspoding FDE, into this DIE. Do we need this? 	 */
operator|(
name|void
operator|)
name|die
expr_stmt|;
if|if
condition|(
name|dbg
operator|==
name|NULL
operator|||
name|fde
operator|==
name|NULL
operator|||
name|fde
operator|->
name|fde_dbg
operator|!=
name|dbg
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_ARGUMENT
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLV_NOCOUNT
operator|)
return|;
block|}
name|ciep
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|dbg
operator|->
name|dbgp_cielist
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|Dwarf_Unsigned
operator|)
name|i
operator|<
name|cie
condition|;
name|i
operator|++
control|)
block|{
name|ciep
operator|=
name|STAILQ_NEXT
argument_list|(
name|ciep
argument_list|,
name|cie_next
argument_list|)
expr_stmt|;
if|if
condition|(
name|ciep
operator|==
name|NULL
condition|)
break|break;
block|}
if|if
condition|(
name|ciep
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_ARGUMENT
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLV_NOCOUNT
operator|)
return|;
block|}
if|if
condition|(
name|end_symbol_index
operator|>
literal|0
operator|&&
operator|(
name|dbg
operator|->
name|dbgp_flags
operator|&
name|DW_DLC_SYMBOLIC_RELOCATIONS
operator|)
operator|==
literal|0
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_ARGUMENT
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLV_NOCOUNT
operator|)
return|;
block|}
name|fde
operator|->
name|fde_cie
operator|=
name|ciep
expr_stmt|;
name|fde
operator|->
name|fde_initloc
operator|=
name|virt_addr
expr_stmt|;
name|fde
operator|->
name|fde_adrange
operator|=
name|code_len
expr_stmt|;
name|fde
operator|->
name|fde_symndx
operator|=
name|symbol_index
expr_stmt|;
name|fde
operator|->
name|fde_esymndx
operator|=
name|end_symbol_index
expr_stmt|;
name|fde
operator|->
name|fde_eoff
operator|=
name|offset_from_end_sym
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|dbg
operator|->
name|dbgp_fdelist
argument_list|,
name|fde
argument_list|,
name|fde_next
argument_list|)
expr_stmt|;
return|return
operator|(
name|dbg
operator|->
name|dbgp_fdelen
operator|++
operator|)
return|;
block|}
end_function

begin_function
name|Dwarf_P_Fde
name|dwarf_fde_cfa_offset
parameter_list|(
name|Dwarf_P_Fde
name|fde
parameter_list|,
name|Dwarf_Unsigned
name|reg
parameter_list|,
name|Dwarf_Signed
name|offset
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|Dwarf_Debug
name|dbg
decl_stmt|;
name|dbg
operator|=
name|fde
operator|!=
name|NULL
condition|?
name|fde
operator|->
name|fde_dbg
else|:
name|NULL
expr_stmt|;
if|if
condition|(
name|fde
operator|==
name|NULL
operator|||
name|reg
operator|>
literal|0x3f
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_ARGUMENT
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLV_BADADDR
operator|)
return|;
block|}
name|ret
operator|=
name|_dwarf_frame_fde_add_inst
argument_list|(
name|fde
argument_list|,
name|DW_CFA_offset
operator||
operator|(
name|reg
operator|&
literal|0x3f
operator|)
argument_list|,
name|offset
argument_list|,
literal|0
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|DW_DLE_NONE
condition|)
return|return
operator|(
name|DW_DLV_BADADDR
operator|)
return|;
return|return
operator|(
name|fde
operator|)
return|;
block|}
end_function

begin_function
name|Dwarf_P_Fde
name|dwarf_add_fde_inst
parameter_list|(
name|Dwarf_P_Fde
name|fde
parameter_list|,
name|Dwarf_Small
name|op
parameter_list|,
name|Dwarf_Unsigned
name|val1
parameter_list|,
name|Dwarf_Unsigned
name|val2
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|fde
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|NULL
argument_list|,
name|error
argument_list|,
name|DW_DLE_ARGUMENT
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLV_BADADDR
operator|)
return|;
block|}
name|ret
operator|=
name|_dwarf_frame_fde_add_inst
argument_list|(
name|fde
argument_list|,
name|op
argument_list|,
name|val1
argument_list|,
name|val2
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|DW_DLE_NONE
condition|)
return|return
operator|(
name|DW_DLV_BADADDR
operator|)
return|;
return|return
operator|(
name|fde
operator|)
return|;
block|}
end_function

end_unit


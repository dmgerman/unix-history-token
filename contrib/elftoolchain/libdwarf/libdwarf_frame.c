begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009-2011 Kai Wang  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"_libdwarf.h"
end_include

begin_expr_stmt
name|ELFTC_VCSID
argument_list|(
literal|"$Id: libdwarf_frame.c 2529 2012-07-29 23:31:12Z kaiwang27 $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|_dwarf_frame_find_cie
parameter_list|(
name|Dwarf_FrameSec
name|fs
parameter_list|,
name|Dwarf_Unsigned
name|offset
parameter_list|,
name|Dwarf_Cie
modifier|*
name|ret_cie
parameter_list|)
block|{
name|Dwarf_Cie
name|cie
decl_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|cie
argument_list|,
argument|&fs->fs_cielist
argument_list|,
argument|cie_next
argument_list|)
block|{
if|if
condition|(
name|cie
operator|->
name|cie_offset
operator|==
name|offset
condition|)
break|break;
block|}
if|if
condition|(
name|cie
operator|==
name|NULL
condition|)
return|return
operator|(
name|DW_DLE_NO_ENTRY
operator|)
return|;
if|if
condition|(
name|ret_cie
operator|!=
name|NULL
condition|)
operator|*
name|ret_cie
operator|=
name|cie
expr_stmt|;
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|_dwarf_frame_read_lsb_encoded
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|,
name|uint64_t
modifier|*
name|val
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|,
name|uint64_t
modifier|*
name|offsetp
parameter_list|,
name|uint8_t
name|encode
parameter_list|,
name|Dwarf_Addr
name|pc
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|uint8_t
name|application
decl_stmt|;
if|if
condition|(
name|encode
operator|==
name|DW_EH_PE_omit
condition|)
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
name|application
operator|=
name|encode
operator|&
literal|0xf0
expr_stmt|;
name|encode
operator|&=
literal|0x0f
expr_stmt|;
switch|switch
condition|(
name|encode
condition|)
block|{
case|case
name|DW_EH_PE_absptr
case|:
operator|*
name|val
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|data
argument_list|,
name|offsetp
argument_list|,
name|dbg
operator|->
name|dbg_pointer_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_EH_PE_uleb128
case|:
operator|*
name|val
operator|=
name|_dwarf_read_uleb128
argument_list|(
name|data
argument_list|,
name|offsetp
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_EH_PE_udata2
case|:
operator|*
name|val
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|data
argument_list|,
name|offsetp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_EH_PE_udata4
case|:
operator|*
name|val
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|data
argument_list|,
name|offsetp
argument_list|,
literal|4
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_EH_PE_udata8
case|:
operator|*
name|val
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|data
argument_list|,
name|offsetp
argument_list|,
literal|8
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_EH_PE_sleb128
case|:
operator|*
name|val
operator|=
name|_dwarf_read_sleb128
argument_list|(
name|data
argument_list|,
name|offsetp
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_EH_PE_sdata2
case|:
operator|*
name|val
operator|=
operator|(
name|int16_t
operator|)
name|dbg
operator|->
name|read
argument_list|(
name|data
argument_list|,
name|offsetp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_EH_PE_sdata4
case|:
operator|*
name|val
operator|=
operator|(
name|int32_t
operator|)
name|dbg
operator|->
name|read
argument_list|(
name|data
argument_list|,
name|offsetp
argument_list|,
literal|4
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_EH_PE_sdata8
case|:
operator|*
name|val
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|data
argument_list|,
name|offsetp
argument_list|,
literal|8
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_FRAME_AUGMENTATION_UNKNOWN
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_FRAME_AUGMENTATION_UNKNOWN
operator|)
return|;
block|}
if|if
condition|(
name|application
operator|==
name|DW_EH_PE_pcrel
condition|)
block|{
comment|/* 		 * Value is relative to .eh_frame section virtual addr. 		 */
switch|switch
condition|(
name|encode
condition|)
block|{
case|case
name|DW_EH_PE_uleb128
case|:
case|case
name|DW_EH_PE_udata2
case|:
case|case
name|DW_EH_PE_udata4
case|:
case|case
name|DW_EH_PE_udata8
case|:
operator|*
name|val
operator|+=
name|pc
expr_stmt|;
break|break;
case|case
name|DW_EH_PE_sleb128
case|:
case|case
name|DW_EH_PE_sdata2
case|:
case|case
name|DW_EH_PE_sdata4
case|:
case|case
name|DW_EH_PE_sdata8
case|:
operator|*
name|val
operator|=
name|pc
operator|+
operator|(
name|int64_t
operator|)
operator|*
name|val
expr_stmt|;
break|break;
default|default:
comment|/* DW_EH_PE_absptr is absolute value. */
break|break;
block|}
block|}
comment|/* XXX Applications other than DW_EH_PE_pcrel are not handled. */
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|_dwarf_frame_parse_lsb_cie_augment
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|,
name|Dwarf_Cie
name|cie
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|uint8_t
modifier|*
name|aug_p
decl_stmt|,
modifier|*
name|augdata_p
decl_stmt|;
name|uint64_t
name|val
decl_stmt|,
name|offset
decl_stmt|;
name|uint8_t
name|encode
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|assert
argument_list|(
name|cie
operator|->
name|cie_augment
operator|!=
name|NULL
operator|&&
operator|*
name|cie
operator|->
name|cie_augment
operator|==
literal|'z'
argument_list|)
expr_stmt|;
comment|/* 	 * Here we're only interested in the presence of augment 'R' 	 * and associated CIE augment data, which describes the 	 * encoding scheme of FDE PC begin and range. 	 */
name|aug_p
operator|=
operator|&
name|cie
operator|->
name|cie_augment
index|[
literal|1
index|]
expr_stmt|;
name|augdata_p
operator|=
name|cie
operator|->
name|cie_augdata
expr_stmt|;
while|while
condition|(
operator|*
name|aug_p
operator|!=
literal|'\0'
condition|)
block|{
switch|switch
condition|(
operator|*
name|aug_p
condition|)
block|{
case|case
literal|'L'
case|:
comment|/* Skip one augment in augment data. */
name|augdata_p
operator|++
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
comment|/* Skip two augments in augment data. */
name|encode
operator|=
operator|*
name|augdata_p
operator|++
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|_dwarf_frame_read_lsb_encoded
argument_list|(
name|dbg
argument_list|,
operator|&
name|val
argument_list|,
name|augdata_p
argument_list|,
operator|&
name|offset
argument_list|,
name|encode
argument_list|,
literal|0
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|DW_DLE_NONE
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|augdata_p
operator|+=
name|offset
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|cie
operator|->
name|cie_fde_encode
operator|=
operator|*
name|augdata_p
operator|++
expr_stmt|;
break|break;
default|default:
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_FRAME_AUGMENTATION_UNKNOWN
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_FRAME_AUGMENTATION_UNKNOWN
operator|)
return|;
block|}
name|aug_p
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|_dwarf_frame_add_cie
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|,
name|Dwarf_FrameSec
name|fs
parameter_list|,
name|Dwarf_Section
modifier|*
name|ds
parameter_list|,
name|Dwarf_Unsigned
modifier|*
name|off
parameter_list|,
name|Dwarf_Cie
modifier|*
name|ret_cie
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_Cie
name|cie
decl_stmt|;
name|uint64_t
name|length
decl_stmt|;
name|int
name|dwarf_size
decl_stmt|,
name|ret
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
comment|/* Check if we already added this CIE. */
if|if
condition|(
name|_dwarf_frame_find_cie
argument_list|(
name|fs
argument_list|,
operator|*
name|off
argument_list|,
operator|&
name|cie
argument_list|)
operator|!=
name|DW_DLE_NO_ENTRY
condition|)
block|{
operator|*
name|off
operator|+=
name|cie
operator|->
name|cie_length
operator|+
literal|4
expr_stmt|;
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|cie
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|_Dwarf_Cie
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_MEMORY
operator|)
return|;
block|}
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|fs
operator|->
name|fs_cielist
argument_list|,
name|cie
argument_list|,
name|cie_next
argument_list|)
expr_stmt|;
name|cie
operator|->
name|cie_dbg
operator|=
name|dbg
expr_stmt|;
name|cie
operator|->
name|cie_index
operator|=
name|fs
operator|->
name|fs_cielen
expr_stmt|;
name|cie
operator|->
name|cie_offset
operator|=
operator|*
name|off
expr_stmt|;
name|length
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|==
literal|0xffffffff
condition|)
block|{
name|dwarf_size
operator|=
literal|8
expr_stmt|;
name|length
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
name|dwarf_size
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|length
operator|>
name|ds
operator|->
name|ds_size
operator|-
operator|*
name|off
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_DEBUG_FRAME_LENGTH_BAD
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_DEBUG_FRAME_LENGTH_BAD
operator|)
return|;
block|}
operator|(
name|void
operator|)
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
name|dwarf_size
argument_list|)
expr_stmt|;
comment|/* Skip CIE id. */
name|cie
operator|->
name|cie_length
operator|=
name|length
expr_stmt|;
name|cie
operator|->
name|cie_version
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cie
operator|->
name|cie_version
operator|!=
literal|1
operator|&&
name|cie
operator|->
name|cie_version
operator|!=
literal|3
operator|&&
name|cie
operator|->
name|cie_version
operator|!=
literal|4
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_FRAME_VERSION_BAD
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_FRAME_VERSION_BAD
operator|)
return|;
block|}
name|cie
operator|->
name|cie_augment
operator|=
name|ds
operator|->
name|ds_data
operator|+
operator|*
name|off
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
name|ds
operator|->
name|ds_data
expr_stmt|;
while|while
condition|(
name|p
index|[
operator|(
operator|*
name|off
operator|)
operator|++
index|]
operator|!=
literal|'\0'
condition|)
empty_stmt|;
comment|/* We only recognize normal .dwarf_frame and GNU .eh_frame sections. */
if|if
condition|(
operator|*
name|cie
operator|->
name|cie_augment
operator|!=
literal|0
operator|&&
operator|*
name|cie
operator|->
name|cie_augment
operator|!=
literal|'z'
condition|)
block|{
operator|*
name|off
operator|=
name|cie
operator|->
name|cie_offset
operator|+
operator|(
operator|(
name|dwarf_size
operator|==
literal|4
operator|)
condition|?
literal|4
else|:
literal|12
operator|)
operator|+
name|cie
operator|->
name|cie_length
expr_stmt|;
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
comment|/* Optional EH Data field for .eh_frame section. */
if|if
condition|(
name|strstr
argument_list|(
operator|(
name|char
operator|*
operator|)
name|cie
operator|->
name|cie_augment
argument_list|,
literal|"eh"
argument_list|)
operator|!=
name|NULL
condition|)
name|cie
operator|->
name|cie_ehdata
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
name|dbg
operator|->
name|dbg_pointer_size
argument_list|)
expr_stmt|;
name|cie
operator|->
name|cie_caf
operator|=
name|_dwarf_read_uleb128
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|)
expr_stmt|;
name|cie
operator|->
name|cie_daf
operator|=
name|_dwarf_read_sleb128
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|)
expr_stmt|;
comment|/* Return address register. */
if|if
condition|(
name|cie
operator|->
name|cie_version
operator|==
literal|1
condition|)
name|cie
operator|->
name|cie_ra
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|cie
operator|->
name|cie_ra
operator|=
name|_dwarf_read_uleb128
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|)
expr_stmt|;
comment|/* Optional CIE augmentation data for .eh_frame section. */
if|if
condition|(
operator|*
name|cie
operator|->
name|cie_augment
operator|==
literal|'z'
condition|)
block|{
name|cie
operator|->
name|cie_auglen
operator|=
name|_dwarf_read_uleb128
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|)
expr_stmt|;
name|cie
operator|->
name|cie_augdata
operator|=
name|ds
operator|->
name|ds_data
operator|+
operator|*
name|off
expr_stmt|;
operator|*
name|off
operator|+=
name|cie
operator|->
name|cie_auglen
expr_stmt|;
comment|/* 		 * XXX Use DW_EH_PE_absptr for default FDE PC start/range, 		 * in case _dwarf_frame_parse_lsb_cie_augment fails to 		 * find out the real encode. 		 */
name|cie
operator|->
name|cie_fde_encode
operator|=
name|DW_EH_PE_absptr
expr_stmt|;
name|ret
operator|=
name|_dwarf_frame_parse_lsb_cie_augment
argument_list|(
name|dbg
argument_list|,
name|cie
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|DW_DLE_NONE
condition|)
return|return
operator|(
name|ret
operator|)
return|;
block|}
comment|/* CIE Initial instructions. */
name|cie
operator|->
name|cie_initinst
operator|=
name|ds
operator|->
name|ds_data
operator|+
operator|*
name|off
expr_stmt|;
if|if
condition|(
name|dwarf_size
operator|==
literal|4
condition|)
name|cie
operator|->
name|cie_instlen
operator|=
name|cie
operator|->
name|cie_offset
operator|+
literal|4
operator|+
name|length
operator|-
operator|*
name|off
expr_stmt|;
else|else
name|cie
operator|->
name|cie_instlen
operator|=
name|cie
operator|->
name|cie_offset
operator|+
literal|12
operator|+
name|length
operator|-
operator|*
name|off
expr_stmt|;
operator|*
name|off
operator|+=
name|cie
operator|->
name|cie_instlen
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"cie:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tcie_version=%u cie_offset=%ju cie_length=%ju cie_augment=%s"
literal|" cie_instlen=%ju cie->cie_caf=%ju cie->cie_daf=%jd off=%ju\n"
argument_list|,
name|cie
operator|->
name|cie_version
argument_list|,
name|cie
operator|->
name|cie_offset
argument_list|,
name|cie
operator|->
name|cie_length
argument_list|,
operator|(
name|char
operator|*
operator|)
name|cie
operator|->
name|cie_augment
argument_list|,
name|cie
operator|->
name|cie_instlen
argument_list|,
name|cie
operator|->
name|cie_caf
argument_list|,
name|cie
operator|->
name|cie_daf
argument_list|,
operator|*
name|off
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ret_cie
operator|!=
name|NULL
condition|)
operator|*
name|ret_cie
operator|=
name|cie
expr_stmt|;
name|fs
operator|->
name|fs_cielen
operator|++
expr_stmt|;
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|_dwarf_frame_add_fde
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|,
name|Dwarf_FrameSec
name|fs
parameter_list|,
name|Dwarf_Section
modifier|*
name|ds
parameter_list|,
name|Dwarf_Unsigned
modifier|*
name|off
parameter_list|,
name|int
name|eh_frame
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_Cie
name|cie
decl_stmt|;
name|Dwarf_Fde
name|fde
decl_stmt|;
name|Dwarf_Unsigned
name|cieoff
decl_stmt|;
name|uint64_t
name|length
decl_stmt|,
name|val
decl_stmt|;
name|int
name|dwarf_size
decl_stmt|,
name|ret
decl_stmt|;
if|if
condition|(
operator|(
name|fde
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|_Dwarf_Fde
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_MEMORY
operator|)
return|;
block|}
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|fs
operator|->
name|fs_fdelist
argument_list|,
name|fde
argument_list|,
name|fde_next
argument_list|)
expr_stmt|;
name|fde
operator|->
name|fde_dbg
operator|=
name|dbg
expr_stmt|;
name|fde
operator|->
name|fde_fs
operator|=
name|fs
expr_stmt|;
name|fde
operator|->
name|fde_addr
operator|=
name|ds
operator|->
name|ds_data
operator|+
operator|*
name|off
expr_stmt|;
name|fde
operator|->
name|fde_offset
operator|=
operator|*
name|off
expr_stmt|;
name|length
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|==
literal|0xffffffff
condition|)
block|{
name|dwarf_size
operator|=
literal|8
expr_stmt|;
name|length
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
name|dwarf_size
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|length
operator|>
name|ds
operator|->
name|ds_size
operator|-
operator|*
name|off
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_DEBUG_FRAME_LENGTH_BAD
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_DEBUG_FRAME_LENGTH_BAD
operator|)
return|;
block|}
name|fde
operator|->
name|fde_length
operator|=
name|length
expr_stmt|;
if|if
condition|(
name|eh_frame
condition|)
block|{
name|fde
operator|->
name|fde_cieoff
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|cieoff
operator|=
operator|*
name|off
operator|-
operator|(
literal|4
operator|+
name|fde
operator|->
name|fde_cieoff
operator|)
expr_stmt|;
comment|/* This delta should never be 0. */
if|if
condition|(
name|cieoff
operator|==
name|fde
operator|->
name|fde_offset
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_NO_CIE_FOR_FDE
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_NO_CIE_FOR_FDE
operator|)
return|;
block|}
block|}
else|else
block|{
name|fde
operator|->
name|fde_cieoff
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
name|dwarf_size
argument_list|)
expr_stmt|;
name|cieoff
operator|=
name|fde
operator|->
name|fde_cieoff
expr_stmt|;
block|}
if|if
condition|(
name|_dwarf_frame_find_cie
argument_list|(
name|fs
argument_list|,
name|cieoff
argument_list|,
operator|&
name|cie
argument_list|)
operator|==
name|DW_DLE_NO_ENTRY
condition|)
block|{
name|ret
operator|=
name|_dwarf_frame_add_cie
argument_list|(
name|dbg
argument_list|,
name|fs
argument_list|,
name|ds
argument_list|,
operator|&
name|cieoff
argument_list|,
operator|&
name|cie
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|DW_DLE_NONE
condition|)
return|return
operator|(
name|ret
operator|)
return|;
block|}
name|fde
operator|->
name|fde_cie
operator|=
name|cie
expr_stmt|;
if|if
condition|(
name|eh_frame
condition|)
block|{
comment|/* 		 * The FDE PC start/range for .eh_frame is encoded according 		 * to the LSB spec's extension to DWARF2. 		 */
name|ret
operator|=
name|_dwarf_frame_read_lsb_encoded
argument_list|(
name|dbg
argument_list|,
operator|&
name|val
argument_list|,
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
name|cie
operator|->
name|cie_fde_encode
argument_list|,
name|ds
operator|->
name|ds_addr
operator|+
operator|*
name|off
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|DW_DLE_NONE
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|fde
operator|->
name|fde_initloc
operator|=
name|val
expr_stmt|;
comment|/* 		 * FDE PC range should not be relative value to anything. 		 * So pass 0 for pc value. 		 */
name|ret
operator|=
name|_dwarf_frame_read_lsb_encoded
argument_list|(
name|dbg
argument_list|,
operator|&
name|val
argument_list|,
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
name|cie
operator|->
name|cie_fde_encode
argument_list|,
literal|0
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|DW_DLE_NONE
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|fde
operator|->
name|fde_adrange
operator|=
name|val
expr_stmt|;
block|}
else|else
block|{
name|fde
operator|->
name|fde_initloc
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
name|dbg
operator|->
name|dbg_pointer_size
argument_list|)
expr_stmt|;
name|fde
operator|->
name|fde_adrange
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|,
name|dbg
operator|->
name|dbg_pointer_size
argument_list|)
expr_stmt|;
block|}
comment|/* Optional FDE augmentation data for .eh_frame section. (ignored) */
if|if
condition|(
name|eh_frame
operator|&&
operator|*
name|cie
operator|->
name|cie_augment
operator|==
literal|'z'
condition|)
block|{
name|fde
operator|->
name|fde_auglen
operator|=
name|_dwarf_read_uleb128
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
name|off
argument_list|)
expr_stmt|;
name|fde
operator|->
name|fde_augdata
operator|=
name|ds
operator|->
name|ds_data
operator|+
operator|*
name|off
expr_stmt|;
operator|*
name|off
operator|+=
name|fde
operator|->
name|fde_auglen
expr_stmt|;
block|}
name|fde
operator|->
name|fde_inst
operator|=
name|ds
operator|->
name|ds_data
operator|+
operator|*
name|off
expr_stmt|;
if|if
condition|(
name|dwarf_size
operator|==
literal|4
condition|)
name|fde
operator|->
name|fde_instlen
operator|=
name|fde
operator|->
name|fde_offset
operator|+
literal|4
operator|+
name|length
operator|-
operator|*
name|off
expr_stmt|;
else|else
name|fde
operator|->
name|fde_instlen
operator|=
name|fde
operator|->
name|fde_offset
operator|+
literal|12
operator|+
name|length
operator|-
operator|*
name|off
expr_stmt|;
operator|*
name|off
operator|+=
name|fde
operator|->
name|fde_instlen
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"fde:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eh_frame
condition|)
name|printf
argument_list|(
literal|"(eh_frame)"
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tfde_offset=%ju fde_length=%ju fde_cieoff=%ju"
literal|" fde_instlen=%ju off=%ju\n"
argument_list|,
name|fde
operator|->
name|fde_offset
argument_list|,
name|fde
operator|->
name|fde_length
argument_list|,
name|fde
operator|->
name|fde_cieoff
argument_list|,
name|fde
operator|->
name|fde_instlen
argument_list|,
operator|*
name|off
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fs
operator|->
name|fs_fdelen
operator|++
expr_stmt|;
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|_dwarf_frame_section_cleanup
parameter_list|(
name|Dwarf_FrameSec
name|fs
parameter_list|)
block|{
name|Dwarf_Cie
name|cie
decl_stmt|,
name|tcie
decl_stmt|;
name|Dwarf_Fde
name|fde
decl_stmt|,
name|tfde
decl_stmt|;
name|STAILQ_FOREACH_SAFE
argument_list|(
argument|cie
argument_list|,
argument|&fs->fs_cielist
argument_list|,
argument|cie_next
argument_list|,
argument|tcie
argument_list|)
block|{
name|STAILQ_REMOVE
argument_list|(
operator|&
name|fs
operator|->
name|fs_cielist
argument_list|,
name|cie
argument_list|,
name|_Dwarf_Cie
argument_list|,
name|cie_next
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cie
argument_list|)
expr_stmt|;
block|}
name|STAILQ_FOREACH_SAFE
argument_list|(
argument|fde
argument_list|,
argument|&fs->fs_fdelist
argument_list|,
argument|fde_next
argument_list|,
argument|tfde
argument_list|)
block|{
name|STAILQ_REMOVE
argument_list|(
operator|&
name|fs
operator|->
name|fs_fdelist
argument_list|,
name|fde
argument_list|,
name|_Dwarf_Fde
argument_list|,
name|fde_next
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fde
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fs
operator|->
name|fs_ciearray
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|fs
operator|->
name|fs_ciearray
argument_list|)
expr_stmt|;
if|if
condition|(
name|fs
operator|->
name|fs_fdearray
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|fs
operator|->
name|fs_fdearray
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|_dwarf_frame_section_init
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|,
name|Dwarf_FrameSec
modifier|*
name|frame_sec
parameter_list|,
name|Dwarf_Section
modifier|*
name|ds
parameter_list|,
name|int
name|eh_frame
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_FrameSec
name|fs
decl_stmt|;
name|Dwarf_Cie
name|cie
decl_stmt|;
name|Dwarf_Fde
name|fde
decl_stmt|;
name|uint64_t
name|length
decl_stmt|,
name|offset
decl_stmt|,
name|cie_id
decl_stmt|,
name|entry_off
decl_stmt|;
name|int
name|dwarf_size
decl_stmt|,
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|assert
argument_list|(
name|frame_sec
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|*
name|frame_sec
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fs
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|_Dwarf_FrameSec
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_MEMORY
operator|)
return|;
block|}
name|STAILQ_INIT
argument_list|(
operator|&
name|fs
operator|->
name|fs_cielist
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|fs
operator|->
name|fs_fdelist
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|offset
operator|<
name|ds
operator|->
name|ds_size
condition|)
block|{
name|entry_off
operator|=
name|offset
expr_stmt|;
name|length
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
operator|&
name|offset
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|==
literal|0xffffffff
condition|)
block|{
name|dwarf_size
operator|=
literal|8
expr_stmt|;
name|length
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
operator|&
name|offset
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
name|dwarf_size
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|length
operator|>
name|ds
operator|->
name|ds_size
operator|-
name|offset
operator|||
operator|(
name|length
operator|==
literal|0
operator|&&
operator|!
name|eh_frame
operator|)
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_DEBUG_FRAME_LENGTH_BAD
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_DEBUG_FRAME_LENGTH_BAD
operator|)
return|;
block|}
comment|/* Check terminator for .eh_frame */
if|if
condition|(
name|eh_frame
operator|&&
name|length
operator|==
literal|0
condition|)
break|break;
name|cie_id
operator|=
name|dbg
operator|->
name|read
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
operator|&
name|offset
argument_list|,
name|dwarf_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|eh_frame
condition|)
block|{
comment|/* GNU .eh_frame use CIE id 0. */
if|if
condition|(
name|cie_id
operator|==
literal|0
condition|)
name|ret
operator|=
name|_dwarf_frame_add_cie
argument_list|(
name|dbg
argument_list|,
name|fs
argument_list|,
name|ds
argument_list|,
operator|&
name|entry_off
argument_list|,
name|NULL
argument_list|,
name|error
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|_dwarf_frame_add_fde
argument_list|(
name|dbg
argument_list|,
name|fs
argument_list|,
name|ds
argument_list|,
operator|&
name|entry_off
argument_list|,
literal|1
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* .dwarf_frame use CIE id ~0 */
if|if
condition|(
operator|(
name|dwarf_size
operator|==
literal|4
operator|&&
name|cie_id
operator|==
operator|~
literal|0U
operator|)
operator|||
operator|(
name|dwarf_size
operator|==
literal|8
operator|&&
name|cie_id
operator|==
operator|~
literal|0ULL
operator|)
condition|)
name|ret
operator|=
name|_dwarf_frame_add_cie
argument_list|(
name|dbg
argument_list|,
name|fs
argument_list|,
name|ds
argument_list|,
operator|&
name|entry_off
argument_list|,
name|NULL
argument_list|,
name|error
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|_dwarf_frame_add_fde
argument_list|(
name|dbg
argument_list|,
name|fs
argument_list|,
name|ds
argument_list|,
operator|&
name|entry_off
argument_list|,
literal|0
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
name|DW_DLE_NONE
condition|)
goto|goto
name|fail_cleanup
goto|;
name|offset
operator|=
name|entry_off
expr_stmt|;
block|}
comment|/* Create CIE array. */
if|if
condition|(
name|fs
operator|->
name|fs_cielen
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|fs
operator|->
name|fs_ciearray
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Dwarf_Cie
argument_list|)
operator|*
name|fs
operator|->
name|fs_cielen
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|DW_DLE_MEMORY
expr_stmt|;
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|fail_cleanup
goto|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|cie
argument_list|,
argument|&fs->fs_cielist
argument_list|,
argument|cie_next
argument_list|)
block|{
name|fs
operator|->
name|fs_ciearray
index|[
name|i
operator|++
index|]
operator|=
name|cie
expr_stmt|;
block|}
name|assert
argument_list|(
operator|(
name|Dwarf_Unsigned
operator|)
name|i
operator|==
name|fs
operator|->
name|fs_cielen
argument_list|)
expr_stmt|;
block|}
comment|/* Create FDE array. */
if|if
condition|(
name|fs
operator|->
name|fs_fdelen
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|fs
operator|->
name|fs_fdearray
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Dwarf_Fde
argument_list|)
operator|*
name|fs
operator|->
name|fs_fdelen
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|DW_DLE_MEMORY
expr_stmt|;
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|fail_cleanup
goto|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|fde
argument_list|,
argument|&fs->fs_fdelist
argument_list|,
argument|fde_next
argument_list|)
block|{
name|fs
operator|->
name|fs_fdearray
index|[
name|i
operator|++
index|]
operator|=
name|fde
expr_stmt|;
block|}
name|assert
argument_list|(
operator|(
name|Dwarf_Unsigned
operator|)
name|i
operator|==
name|fs
operator|->
name|fs_fdelen
argument_list|)
expr_stmt|;
block|}
operator|*
name|frame_sec
operator|=
name|fs
expr_stmt|;
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
name|fail_cleanup
label|:
name|_dwarf_frame_section_cleanup
argument_list|(
name|fs
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|_dwarf_frame_run_inst
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|,
name|Dwarf_Regtable3
modifier|*
name|rt
parameter_list|,
name|uint8_t
modifier|*
name|insts
parameter_list|,
name|Dwarf_Unsigned
name|len
parameter_list|,
name|Dwarf_Unsigned
name|caf
parameter_list|,
name|Dwarf_Signed
name|daf
parameter_list|,
name|Dwarf_Addr
name|pc
parameter_list|,
name|Dwarf_Addr
name|pc_req
parameter_list|,
name|Dwarf_Addr
modifier|*
name|row_pc
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_Regtable3
modifier|*
name|init_rt
decl_stmt|,
modifier|*
name|saved_rt
decl_stmt|;
name|uint8_t
modifier|*
name|p
decl_stmt|,
modifier|*
name|pe
decl_stmt|;
name|uint8_t
name|high2
decl_stmt|,
name|low6
decl_stmt|;
name|uint64_t
name|reg
decl_stmt|,
name|reg2
decl_stmt|,
name|uoff
decl_stmt|,
name|soff
decl_stmt|;
name|int
name|ret
decl_stmt|;
define|#
directive|define
name|CFA
value|rt->rt3_cfa_rule
define|#
directive|define
name|INITCFA
value|init_rt->rt3_cfa_rule
define|#
directive|define
name|RL
value|rt->rt3_rules
define|#
directive|define
name|INITRL
value|init_rt->rt3_rules
define|#
directive|define
name|CHECK_TABLE_SIZE
parameter_list|(
name|x
parameter_list|)
define|\
value|do {								\ 		if ((x)>= rt->rt3_reg_table_size) {			\ 			DWARF_SET_ERROR(dbg, error,			\ 			    DW_DLE_DF_REG_NUM_TOO_HIGH);		\ 			ret = DW_DLE_DF_REG_NUM_TOO_HIGH;		\ 			goto program_done;				\ 		}							\ 	} while(0)
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"frame_run_inst: (caf=%ju, daf=%jd)\n"
argument_list|,
name|caf
argument_list|,
name|daf
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ret
operator|=
name|DW_DLE_NONE
expr_stmt|;
name|init_rt
operator|=
name|saved_rt
operator|=
name|NULL
expr_stmt|;
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
comment|/* Save a copy of the table as initial state. */
name|_dwarf_frame_regtable_copy
argument_list|(
name|dbg
argument_list|,
operator|&
name|init_rt
argument_list|,
name|rt
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|p
operator|=
name|insts
expr_stmt|;
name|pe
operator|=
name|p
operator|+
name|len
expr_stmt|;
while|while
condition|(
name|p
operator|<
name|pe
condition|)
block|{
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"p=%p pe=%p pc=%#jx pc_req=%#jx\n"
argument_list|,
name|p
argument_list|,
name|pe
argument_list|,
name|pc
argument_list|,
name|pc_req
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|*
name|p
operator|==
name|DW_CFA_nop
condition|)
block|{
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_nop\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|p
operator|++
expr_stmt|;
continue|continue;
block|}
name|high2
operator|=
operator|*
name|p
operator|&
literal|0xc0
expr_stmt|;
name|low6
operator|=
operator|*
name|p
operator|&
literal|0x3f
expr_stmt|;
name|p
operator|++
expr_stmt|;
if|if
condition|(
name|high2
operator|>
literal|0
condition|)
block|{
switch|switch
condition|(
name|high2
condition|)
block|{
case|case
name|DW_CFA_advance_loc
case|:
name|pc
operator|+=
name|low6
operator|*
name|caf
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_advance_loc(%#jx(%u))\n"
argument_list|,
name|pc
argument_list|,
name|low6
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pc_req
operator|<
name|pc
condition|)
goto|goto
name|program_done
goto|;
break|break;
case|case
name|DW_CFA_offset
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|CHECK_TABLE_SIZE
argument_list|(
name|low6
argument_list|)
expr_stmt|;
name|RL
index|[
name|low6
index|]
operator|.
name|dw_offset_relevant
operator|=
literal|1
expr_stmt|;
name|RL
index|[
name|low6
index|]
operator|.
name|dw_value_type
operator|=
name|DW_EXPR_OFFSET
expr_stmt|;
name|RL
index|[
name|low6
index|]
operator|.
name|dw_regnum
operator|=
name|dbg
operator|->
name|dbg_frame_cfa_value
expr_stmt|;
name|RL
index|[
name|low6
index|]
operator|.
name|dw_offset_or_block_len
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
operator|*
name|daf
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_offset(%jd)\n"
argument_list|,
name|RL
index|[
name|low6
index|]
operator|.
name|dw_offset_or_block_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_restore
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|CHECK_TABLE_SIZE
argument_list|(
name|low6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|RL
index|[
name|low6
index|]
argument_list|,
operator|&
name|INITRL
index|[
name|low6
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|Dwarf_Regtable_Entry3
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_restore(%u)\n"
argument_list|,
name|low6
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
default|default:
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_FRAME_INSTR_EXEC_ERROR
argument_list|)
expr_stmt|;
name|ret
operator|=
name|DW_DLE_FRAME_INSTR_EXEC_ERROR
expr_stmt|;
goto|goto
name|program_done
goto|;
block|}
continue|continue;
block|}
switch|switch
condition|(
name|low6
condition|)
block|{
case|case
name|DW_CFA_set_loc
case|:
name|pc
operator|=
name|dbg
operator|->
name|decode
argument_list|(
operator|&
name|p
argument_list|,
name|dbg
operator|->
name|dbg_pointer_size
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_set_loc(pc=%#jx)\n"
argument_list|,
name|pc
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pc_req
operator|<
name|pc
condition|)
goto|goto
name|program_done
goto|;
break|break;
case|case
name|DW_CFA_advance_loc1
case|:
name|pc
operator|+=
name|dbg
operator|->
name|decode
argument_list|(
operator|&
name|p
argument_list|,
literal|1
argument_list|)
operator|*
name|caf
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_set_loc1(pc=%#jx)\n"
argument_list|,
name|pc
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pc_req
operator|<
name|pc
condition|)
goto|goto
name|program_done
goto|;
break|break;
case|case
name|DW_CFA_advance_loc2
case|:
name|pc
operator|+=
name|dbg
operator|->
name|decode
argument_list|(
operator|&
name|p
argument_list|,
literal|2
argument_list|)
operator|*
name|caf
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_set_loc2(pc=%#jx)\n"
argument_list|,
name|pc
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pc_req
operator|<
name|pc
condition|)
goto|goto
name|program_done
goto|;
break|break;
case|case
name|DW_CFA_advance_loc4
case|:
name|pc
operator|+=
name|dbg
operator|->
name|decode
argument_list|(
operator|&
name|p
argument_list|,
literal|4
argument_list|)
operator|*
name|caf
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_set_loc4(pc=%#jx)\n"
argument_list|,
name|pc
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pc_req
operator|<
name|pc
condition|)
goto|goto
name|program_done
goto|;
break|break;
case|case
name|DW_CFA_offset_extended
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|uoff
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CHECK_TABLE_SIZE
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_relevant
operator|=
literal|1
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_value_type
operator|=
name|DW_EXPR_OFFSET
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_regnum
operator|=
name|dbg
operator|->
name|dbg_frame_cfa_value
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_or_block_len
operator|=
name|uoff
operator|*
name|daf
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_offset_extended(reg=%ju,uoff=%ju)\n"
argument_list|,
name|reg
argument_list|,
name|uoff
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_restore_extended
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CHECK_TABLE_SIZE
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|RL
index|[
name|reg
index|]
argument_list|,
operator|&
name|INITRL
index|[
name|reg
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|Dwarf_Regtable_Entry3
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_restore_extended(%ju)\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_undefined
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CHECK_TABLE_SIZE
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_relevant
operator|=
literal|0
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_regnum
operator|=
name|dbg
operator|->
name|dbg_frame_undefined_value
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_undefined(%ju)\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_same_value
case|:
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CHECK_TABLE_SIZE
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_relevant
operator|=
literal|0
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_regnum
operator|=
name|dbg
operator|->
name|dbg_frame_same_value
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_same_value(%ju)\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_register
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|reg2
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CHECK_TABLE_SIZE
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_relevant
operator|=
literal|0
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_regnum
operator|=
name|reg2
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_register(reg=%ju,reg2=%ju)\n"
argument_list|,
name|reg
argument_list|,
name|reg2
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_remember_state
case|:
name|_dwarf_frame_regtable_copy
argument_list|(
name|dbg
argument_list|,
operator|&
name|saved_rt
argument_list|,
name|rt
argument_list|,
name|error
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_remember_state\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_restore_state
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|_dwarf_frame_regtable_copy
argument_list|(
name|dbg
argument_list|,
operator|&
name|rt
argument_list|,
name|saved_rt
argument_list|,
name|error
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_restore_state\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_def_cfa
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|uoff
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CFA
operator|.
name|dw_offset_relevant
operator|=
literal|1
expr_stmt|;
name|CFA
operator|.
name|dw_value_type
operator|=
name|DW_EXPR_OFFSET
expr_stmt|;
name|CFA
operator|.
name|dw_regnum
operator|=
name|reg
expr_stmt|;
name|CFA
operator|.
name|dw_offset_or_block_len
operator|=
name|uoff
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_def_cfa(reg=%ju,uoff=%ju)\n"
argument_list|,
name|reg
argument_list|,
name|uoff
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_def_cfa_register
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CFA
operator|.
name|dw_regnum
operator|=
name|reg
expr_stmt|;
comment|/* 			 * Note that DW_CFA_def_cfa_register change the CFA 			 * rule register while keep the old offset. So we 			 * should not touch the CFA.dw_offset_relevant flag 			 * here. 			 */
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_def_cfa_register(%ju)\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_def_cfa_offset
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|uoff
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CFA
operator|.
name|dw_offset_relevant
operator|=
literal|1
expr_stmt|;
name|CFA
operator|.
name|dw_value_type
operator|=
name|DW_EXPR_OFFSET
expr_stmt|;
name|CFA
operator|.
name|dw_offset_or_block_len
operator|=
name|uoff
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_def_cfa_offset(%ju)\n"
argument_list|,
name|uoff
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_def_cfa_expression
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|CFA
operator|.
name|dw_offset_relevant
operator|=
literal|0
expr_stmt|;
name|CFA
operator|.
name|dw_value_type
operator|=
name|DW_EXPR_EXPRESSION
expr_stmt|;
name|CFA
operator|.
name|dw_offset_or_block_len
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CFA
operator|.
name|dw_block_ptr
operator|=
name|p
expr_stmt|;
name|p
operator|+=
name|CFA
operator|.
name|dw_offset_or_block_len
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_def_cfa_expression\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_expression
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CHECK_TABLE_SIZE
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_relevant
operator|=
literal|0
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_value_type
operator|=
name|DW_EXPR_EXPRESSION
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_or_block_len
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_block_ptr
operator|=
name|p
expr_stmt|;
name|p
operator|+=
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_or_block_len
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_expression\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_offset_extended_sf
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|soff
operator|=
name|_dwarf_decode_sleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CHECK_TABLE_SIZE
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_relevant
operator|=
literal|1
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_value_type
operator|=
name|DW_EXPR_OFFSET
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_regnum
operator|=
name|dbg
operator|->
name|dbg_frame_cfa_value
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_or_block_len
operator|=
name|soff
operator|*
name|daf
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_offset_extended_sf(reg=%ju,soff=%jd)\n"
argument_list|,
name|reg
argument_list|,
name|soff
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_def_cfa_sf
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|soff
operator|=
name|_dwarf_decode_sleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CFA
operator|.
name|dw_offset_relevant
operator|=
literal|1
expr_stmt|;
name|CFA
operator|.
name|dw_value_type
operator|=
name|DW_EXPR_OFFSET
expr_stmt|;
name|CFA
operator|.
name|dw_regnum
operator|=
name|reg
expr_stmt|;
name|CFA
operator|.
name|dw_offset_or_block_len
operator|=
name|soff
operator|*
name|daf
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_def_cfa_sf(reg=%ju,soff=%jd)\n"
argument_list|,
name|reg
argument_list|,
name|soff
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_def_cfa_offset_sf
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|soff
operator|=
name|_dwarf_decode_sleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CFA
operator|.
name|dw_offset_relevant
operator|=
literal|1
expr_stmt|;
name|CFA
operator|.
name|dw_value_type
operator|=
name|DW_EXPR_OFFSET
expr_stmt|;
name|CFA
operator|.
name|dw_offset_or_block_len
operator|=
name|soff
operator|*
name|daf
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_def_cfa_offset_sf(soff=%jd)\n"
argument_list|,
name|soff
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_val_offset
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|uoff
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CHECK_TABLE_SIZE
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_relevant
operator|=
literal|1
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_value_type
operator|=
name|DW_EXPR_VAL_OFFSET
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_regnum
operator|=
name|dbg
operator|->
name|dbg_frame_cfa_value
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_or_block_len
operator|=
name|uoff
operator|*
name|daf
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_val_offset(reg=%ju,uoff=%ju)\n"
argument_list|,
name|reg
argument_list|,
name|uoff
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_val_offset_sf
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|soff
operator|=
name|_dwarf_decode_sleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CHECK_TABLE_SIZE
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_relevant
operator|=
literal|1
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_value_type
operator|=
name|DW_EXPR_VAL_OFFSET
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_regnum
operator|=
name|dbg
operator|->
name|dbg_frame_cfa_value
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_or_block_len
operator|=
name|soff
operator|*
name|daf
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_val_offset_sf(reg=%ju,soff=%jd)\n"
argument_list|,
name|reg
argument_list|,
name|soff
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|DW_CFA_val_expression
case|:
operator|*
name|row_pc
operator|=
name|pc
expr_stmt|;
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|CHECK_TABLE_SIZE
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_relevant
operator|=
literal|0
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_value_type
operator|=
name|DW_EXPR_VAL_EXPRESSION
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_or_block_len
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|RL
index|[
name|reg
index|]
operator|.
name|dw_block_ptr
operator|=
name|p
expr_stmt|;
name|p
operator|+=
name|RL
index|[
name|reg
index|]
operator|.
name|dw_offset_or_block_len
expr_stmt|;
ifdef|#
directive|ifdef
name|FRAME_DEBUG
name|printf
argument_list|(
literal|"DW_CFA_val_expression\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
default|default:
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_FRAME_INSTR_EXEC_ERROR
argument_list|)
expr_stmt|;
name|ret
operator|=
name|DW_DLE_FRAME_INSTR_EXEC_ERROR
expr_stmt|;
goto|goto
name|program_done
goto|;
block|}
block|}
name|program_done
label|:
name|free
argument_list|(
name|init_rt
operator|->
name|rt3_rules
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|init_rt
argument_list|)
expr_stmt|;
if|if
condition|(
name|saved_rt
condition|)
block|{
name|free
argument_list|(
name|saved_rt
operator|->
name|rt3_rules
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|saved_rt
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
undef|#
directive|undef
name|CFA
undef|#
directive|undef
name|INITCFA
undef|#
directive|undef
name|RL
undef|#
directive|undef
name|INITRL
undef|#
directive|undef
name|CHECK_TABLE_SIZE
block|}
end_function

begin_function
specifier|static
name|int
name|_dwarf_frame_convert_inst
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|,
name|uint8_t
modifier|*
name|insts
parameter_list|,
name|Dwarf_Unsigned
name|len
parameter_list|,
name|Dwarf_Unsigned
modifier|*
name|count
parameter_list|,
name|Dwarf_Frame_Op
modifier|*
name|fop
parameter_list|,
name|Dwarf_Frame_Op3
modifier|*
name|fop3
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|uint8_t
modifier|*
name|p
decl_stmt|,
modifier|*
name|pe
decl_stmt|;
name|uint8_t
name|high2
decl_stmt|,
name|low6
decl_stmt|;
name|uint64_t
name|reg
decl_stmt|,
name|reg2
decl_stmt|,
name|uoff
decl_stmt|,
name|soff
decl_stmt|,
name|blen
decl_stmt|;
name|int
name|ret
decl_stmt|;
define|#
directive|define
name|SET_BASE_OP
parameter_list|(
name|x
parameter_list|)
define|\
value|do {							\ 		if (fop != NULL)				\ 			fop[*count].fp_base_op = (x)>> 6;	\ 		if (fop3 != NULL)				\ 			fop3[*count].fp_base_op = (x)>> 6;	\ 	} while(0)
define|#
directive|define
name|SET_EXTENDED_OP
parameter_list|(
name|x
parameter_list|)
define|\
value|do {							\ 		if (fop != NULL)				\ 			fop[*count].fp_extended_op = (x);	\ 		if (fop3 != NULL)				\ 			fop3[*count].fp_extended_op = (x);	\ 	} while(0)
define|#
directive|define
name|SET_REGISTER
parameter_list|(
name|x
parameter_list|)
define|\
value|do {							\ 		if (fop != NULL)				\ 			fop[*count].fp_register = (x);		\ 		if (fop3 != NULL)				\ 			fop3[*count].fp_register = (x);		\ 	} while(0)
define|#
directive|define
name|SET_OFFSET
parameter_list|(
name|x
parameter_list|)
define|\
value|do {							\ 		if (fop != NULL)				\ 			fop[*count].fp_offset = (x);		\ 		if (fop3 != NULL)				\ 			fop3[*count].fp_offset_or_block_len =	\ 			    (x);				\ 	} while(0)
define|#
directive|define
name|SET_INSTR_OFFSET
parameter_list|(
name|x
parameter_list|)
define|\
value|do {							\ 		if (fop != NULL)				\ 			fop[*count].fp_instr_offset = (x);	\ 		if (fop3 != NULL)				\ 			fop3[*count].fp_instr_offset = (x);	\ 	} while(0)
define|#
directive|define
name|SET_BLOCK_LEN
parameter_list|(
name|x
parameter_list|)
define|\
value|do {							\ 		if (fop3 != NULL)				\ 			fop3[*count].fp_offset_or_block_len =	\ 			    (x);				\ 	} while(0)
define|#
directive|define
name|SET_EXPR_BLOCK
parameter_list|(
name|addr
parameter_list|,
name|len
parameter_list|)
define|\
value|do {								\ 		if (fop3 != NULL) {					\ 			fop3[*count].fp_expr_block =			\ 			    malloc((size_t) (len));			\ 			if (fop3[*count].fp_expr_block == NULL)	{	\ 				DWARF_SET_ERROR(dbg, error,		\ 				    DW_DLE_MEMORY);			\ 				return (DW_DLE_MEMORY);			\ 			}						\ 			memcpy(&fop3[*count].fp_expr_block,		\ 			    (addr), (len));				\ 		}							\ 	} while(0)
name|ret
operator|=
name|DW_DLE_NONE
expr_stmt|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
name|p
operator|=
name|insts
expr_stmt|;
name|pe
operator|=
name|p
operator|+
name|len
expr_stmt|;
while|while
condition|(
name|p
operator|<
name|pe
condition|)
block|{
name|SET_INSTR_OFFSET
argument_list|(
name|p
operator|-
name|insts
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
name|DW_CFA_nop
condition|)
block|{
name|p
operator|++
expr_stmt|;
operator|(
operator|*
name|count
operator|)
operator|++
expr_stmt|;
continue|continue;
block|}
name|high2
operator|=
operator|*
name|p
operator|&
literal|0xc0
expr_stmt|;
name|low6
operator|=
operator|*
name|p
operator|&
literal|0x3f
expr_stmt|;
name|p
operator|++
expr_stmt|;
if|if
condition|(
name|high2
operator|>
literal|0
condition|)
block|{
switch|switch
condition|(
name|high2
condition|)
block|{
case|case
name|DW_CFA_advance_loc
case|:
name|SET_BASE_OP
argument_list|(
name|high2
argument_list|)
expr_stmt|;
name|SET_OFFSET
argument_list|(
name|low6
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_offset
case|:
name|SET_BASE_OP
argument_list|(
name|high2
argument_list|)
expr_stmt|;
name|SET_REGISTER
argument_list|(
name|low6
argument_list|)
expr_stmt|;
name|uoff
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|SET_OFFSET
argument_list|(
name|uoff
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_restore
case|:
name|SET_BASE_OP
argument_list|(
name|high2
argument_list|)
expr_stmt|;
name|SET_REGISTER
argument_list|(
name|low6
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_FRAME_INSTR_EXEC_ERROR
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_FRAME_INSTR_EXEC_ERROR
operator|)
return|;
block|}
operator|(
operator|*
name|count
operator|)
operator|++
expr_stmt|;
continue|continue;
block|}
name|SET_EXTENDED_OP
argument_list|(
name|low6
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|low6
condition|)
block|{
case|case
name|DW_CFA_set_loc
case|:
name|uoff
operator|=
name|dbg
operator|->
name|decode
argument_list|(
operator|&
name|p
argument_list|,
name|dbg
operator|->
name|dbg_pointer_size
argument_list|)
expr_stmt|;
name|SET_OFFSET
argument_list|(
name|uoff
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_advance_loc1
case|:
name|uoff
operator|=
name|dbg
operator|->
name|decode
argument_list|(
operator|&
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|SET_OFFSET
argument_list|(
name|uoff
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_advance_loc2
case|:
name|uoff
operator|=
name|dbg
operator|->
name|decode
argument_list|(
operator|&
name|p
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|SET_OFFSET
argument_list|(
name|uoff
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_advance_loc4
case|:
name|uoff
operator|=
name|dbg
operator|->
name|decode
argument_list|(
operator|&
name|p
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|SET_OFFSET
argument_list|(
name|uoff
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_offset_extended
case|:
case|case
name|DW_CFA_def_cfa
case|:
case|case
name|DW_CFA_val_offset
case|:
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|uoff
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|SET_REGISTER
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|SET_OFFSET
argument_list|(
name|uoff
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_restore_extended
case|:
case|case
name|DW_CFA_undefined
case|:
case|case
name|DW_CFA_same_value
case|:
case|case
name|DW_CFA_def_cfa_register
case|:
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|SET_REGISTER
argument_list|(
name|reg
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_register
case|:
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|reg2
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|SET_REGISTER
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|SET_OFFSET
argument_list|(
name|reg2
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_remember_state
case|:
case|case
name|DW_CFA_restore_state
case|:
break|break;
case|case
name|DW_CFA_def_cfa_offset
case|:
name|uoff
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|SET_OFFSET
argument_list|(
name|uoff
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_def_cfa_expression
case|:
name|blen
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|SET_BLOCK_LEN
argument_list|(
name|blen
argument_list|)
expr_stmt|;
name|SET_EXPR_BLOCK
argument_list|(
name|p
argument_list|,
name|blen
argument_list|)
expr_stmt|;
name|p
operator|+=
name|blen
expr_stmt|;
break|break;
case|case
name|DW_CFA_expression
case|:
case|case
name|DW_CFA_val_expression
case|:
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|blen
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|SET_REGISTER
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|SET_BLOCK_LEN
argument_list|(
name|blen
argument_list|)
expr_stmt|;
name|SET_EXPR_BLOCK
argument_list|(
name|p
argument_list|,
name|blen
argument_list|)
expr_stmt|;
name|p
operator|+=
name|blen
expr_stmt|;
break|break;
case|case
name|DW_CFA_offset_extended_sf
case|:
case|case
name|DW_CFA_def_cfa_sf
case|:
case|case
name|DW_CFA_val_offset_sf
case|:
name|reg
operator|=
name|_dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|soff
operator|=
name|_dwarf_decode_sleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|SET_REGISTER
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|SET_OFFSET
argument_list|(
name|soff
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_def_cfa_offset_sf
case|:
name|soff
operator|=
name|_dwarf_decode_sleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|SET_OFFSET
argument_list|(
name|soff
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_FRAME_INSTR_EXEC_ERROR
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_FRAME_INSTR_EXEC_ERROR
operator|)
return|;
block|}
operator|(
operator|*
name|count
operator|)
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
end_function

begin_function
name|int
name|_dwarf_frame_get_fop
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|,
name|uint8_t
modifier|*
name|insts
parameter_list|,
name|Dwarf_Unsigned
name|len
parameter_list|,
name|Dwarf_Frame_Op
modifier|*
modifier|*
name|ret_oplist
parameter_list|,
name|Dwarf_Signed
modifier|*
name|ret_opcnt
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_Frame_Op
modifier|*
name|oplist
decl_stmt|;
name|Dwarf_Unsigned
name|count
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|_dwarf_frame_convert_inst
argument_list|(
name|dbg
argument_list|,
name|insts
argument_list|,
name|len
argument_list|,
operator|&
name|count
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|DW_DLE_NONE
condition|)
return|return
operator|(
name|ret
operator|)
return|;
if|if
condition|(
operator|(
name|oplist
operator|=
name|calloc
argument_list|(
name|count
argument_list|,
sizeof|sizeof
argument_list|(
name|Dwarf_Frame_Op
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_MEMORY
operator|)
return|;
block|}
name|ret
operator|=
name|_dwarf_frame_convert_inst
argument_list|(
name|dbg
argument_list|,
name|insts
argument_list|,
name|len
argument_list|,
operator|&
name|count
argument_list|,
name|oplist
argument_list|,
name|NULL
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|DW_DLE_NONE
condition|)
block|{
name|free
argument_list|(
name|oplist
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
operator|*
name|ret_oplist
operator|=
name|oplist
expr_stmt|;
operator|*
name|ret_opcnt
operator|=
name|count
expr_stmt|;
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
end_function

begin_function
name|int
name|_dwarf_frame_regtable_copy
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|,
name|Dwarf_Regtable3
modifier|*
modifier|*
name|dest
parameter_list|,
name|Dwarf_Regtable3
modifier|*
name|src
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|assert
argument_list|(
name|dest
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|src
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|dest
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|dest
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Dwarf_Regtable3
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_MEMORY
operator|)
return|;
block|}
operator|(
operator|*
name|dest
operator|)
operator|->
name|rt3_reg_table_size
operator|=
name|src
operator|->
name|rt3_reg_table_size
expr_stmt|;
operator|(
operator|*
name|dest
operator|)
operator|->
name|rt3_rules
operator|=
name|malloc
argument_list|(
name|src
operator|->
name|rt3_reg_table_size
operator|*
sizeof|sizeof
argument_list|(
name|Dwarf_Regtable_Entry3
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|dest
operator|)
operator|->
name|rt3_rules
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
operator|*
name|dest
argument_list|)
expr_stmt|;
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_MEMORY
operator|)
return|;
block|}
block|}
name|memcpy
argument_list|(
operator|&
operator|(
operator|*
name|dest
operator|)
operator|->
name|rt3_cfa_rule
argument_list|,
operator|&
name|src
operator|->
name|rt3_cfa_rule
argument_list|,
sizeof|sizeof
argument_list|(
name|Dwarf_Regtable_Entry3
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
operator|*
name|dest
operator|)
operator|->
name|rt3_reg_table_size
operator|&&
name|i
operator|<
name|src
operator|->
name|rt3_reg_table_size
condition|;
name|i
operator|++
control|)
name|memcpy
argument_list|(
operator|&
operator|(
operator|*
name|dest
operator|)
operator|->
name|rt3_rules
index|[
name|i
index|]
argument_list|,
operator|&
name|src
operator|->
name|rt3_rules
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|Dwarf_Regtable_Entry3
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
operator|(
operator|*
name|dest
operator|)
operator|->
name|rt3_reg_table_size
condition|;
name|i
operator|++
control|)
operator|(
operator|*
name|dest
operator|)
operator|->
name|rt3_rules
index|[
name|i
index|]
operator|.
name|dw_regnum
operator|=
name|dbg
operator|->
name|dbg_frame_undefined_value
expr_stmt|;
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
end_function

begin_function
name|int
name|_dwarf_frame_get_internal_table
parameter_list|(
name|Dwarf_Fde
name|fde
parameter_list|,
name|Dwarf_Addr
name|pc_req
parameter_list|,
name|Dwarf_Regtable3
modifier|*
modifier|*
name|ret_rt
parameter_list|,
name|Dwarf_Addr
modifier|*
name|ret_row_pc
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_Debug
name|dbg
decl_stmt|;
name|Dwarf_Cie
name|cie
decl_stmt|;
name|Dwarf_Regtable3
modifier|*
name|rt
decl_stmt|;
name|Dwarf_Addr
name|row_pc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|assert
argument_list|(
name|ret_rt
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dbg
operator|=
name|fde
operator|->
name|fde_dbg
expr_stmt|;
name|assert
argument_list|(
name|dbg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|rt
operator|=
name|dbg
operator|->
name|dbg_internal_reg_table
expr_stmt|;
comment|/* Clear the content of regtable from previous run. */
name|memset
argument_list|(
operator|&
name|rt
operator|->
name|rt3_cfa_rule
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|Dwarf_Regtable_Entry3
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|rt
operator|->
name|rt3_rules
argument_list|,
literal|0
argument_list|,
name|rt
operator|->
name|rt3_reg_table_size
operator|*
sizeof|sizeof
argument_list|(
name|Dwarf_Regtable_Entry3
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set rules to initial values. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rt
operator|->
name|rt3_reg_table_size
condition|;
name|i
operator|++
control|)
name|rt
operator|->
name|rt3_rules
index|[
name|i
index|]
operator|.
name|dw_regnum
operator|=
name|dbg
operator|->
name|dbg_frame_rule_initial_value
expr_stmt|;
comment|/* Run initial instructions in CIE. */
name|cie
operator|=
name|fde
operator|->
name|fde_cie
expr_stmt|;
name|assert
argument_list|(
name|cie
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_dwarf_frame_run_inst
argument_list|(
name|dbg
argument_list|,
name|rt
argument_list|,
name|cie
operator|->
name|cie_initinst
argument_list|,
name|cie
operator|->
name|cie_instlen
argument_list|,
name|cie
operator|->
name|cie_caf
argument_list|,
name|cie
operator|->
name|cie_daf
argument_list|,
literal|0
argument_list|,
operator|~
literal|0ULL
argument_list|,
operator|&
name|row_pc
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|DW_DLE_NONE
condition|)
return|return
operator|(
name|ret
operator|)
return|;
comment|/* Run instructions in FDE. */
if|if
condition|(
name|pc_req
operator|>=
name|fde
operator|->
name|fde_initloc
condition|)
block|{
name|ret
operator|=
name|_dwarf_frame_run_inst
argument_list|(
name|dbg
argument_list|,
name|rt
argument_list|,
name|fde
operator|->
name|fde_inst
argument_list|,
name|fde
operator|->
name|fde_instlen
argument_list|,
name|cie
operator|->
name|cie_caf
argument_list|,
name|cie
operator|->
name|cie_daf
argument_list|,
name|fde
operator|->
name|fde_initloc
argument_list|,
name|pc_req
argument_list|,
operator|&
name|row_pc
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|DW_DLE_NONE
condition|)
return|return
operator|(
name|ret
operator|)
return|;
block|}
operator|*
name|ret_rt
operator|=
name|rt
expr_stmt|;
operator|*
name|ret_row_pc
operator|=
name|row_pc
expr_stmt|;
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
end_function

begin_function
name|void
name|_dwarf_frame_cleanup
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|)
block|{
name|Dwarf_Regtable3
modifier|*
name|rt
decl_stmt|;
name|assert
argument_list|(
name|dbg
operator|!=
name|NULL
operator|&&
name|dbg
operator|->
name|dbg_mode
operator|==
name|DW_DLC_READ
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbg
operator|->
name|dbg_internal_reg_table
condition|)
block|{
name|rt
operator|=
name|dbg
operator|->
name|dbg_internal_reg_table
expr_stmt|;
name|free
argument_list|(
name|rt
operator|->
name|rt3_rules
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rt
argument_list|)
expr_stmt|;
name|dbg
operator|->
name|dbg_internal_reg_table
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|dbg
operator|->
name|dbg_frame
condition|)
block|{
name|_dwarf_frame_section_cleanup
argument_list|(
name|dbg
operator|->
name|dbg_frame
argument_list|)
expr_stmt|;
name|dbg
operator|->
name|dbg_frame
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|dbg
operator|->
name|dbg_eh_frame
condition|)
block|{
name|_dwarf_frame_section_cleanup
argument_list|(
name|dbg
operator|->
name|dbg_eh_frame
argument_list|)
expr_stmt|;
name|dbg
operator|->
name|dbg_eh_frame
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|_dwarf_frame_section_load
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_Section
modifier|*
name|ds
decl_stmt|;
if|if
condition|(
operator|(
name|ds
operator|=
name|_dwarf_find_section
argument_list|(
name|dbg
argument_list|,
literal|".debug_frame"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
return|return
operator|(
name|_dwarf_frame_section_init
argument_list|(
name|dbg
argument_list|,
operator|&
name|dbg
operator|->
name|dbg_frame
argument_list|,
name|ds
argument_list|,
literal|0
argument_list|,
name|error
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
end_function

begin_function
name|int
name|_dwarf_frame_section_load_eh
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_Section
modifier|*
name|ds
decl_stmt|;
if|if
condition|(
operator|(
name|ds
operator|=
name|_dwarf_find_section
argument_list|(
name|dbg
argument_list|,
literal|".eh_frame"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
return|return
operator|(
name|_dwarf_frame_section_init
argument_list|(
name|dbg
argument_list|,
operator|&
name|dbg
operator|->
name|dbg_eh_frame
argument_list|,
name|ds
argument_list|,
literal|1
argument_list|,
name|error
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
end_function

begin_function
name|void
name|_dwarf_frame_params_init
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|)
block|{
comment|/* Initialise call frame related parameters. */
name|dbg
operator|->
name|dbg_frame_rule_table_size
operator|=
name|DW_FRAME_LAST_REG_NUM
expr_stmt|;
name|dbg
operator|->
name|dbg_frame_rule_initial_value
operator|=
name|DW_FRAME_REG_INITIAL_VALUE
expr_stmt|;
name|dbg
operator|->
name|dbg_frame_cfa_value
operator|=
name|DW_FRAME_CFA_COL3
expr_stmt|;
name|dbg
operator|->
name|dbg_frame_same_value
operator|=
name|DW_FRAME_SAME_VAL
expr_stmt|;
name|dbg
operator|->
name|dbg_frame_undefined_value
operator|=
name|DW_FRAME_UNDEFINED_VAL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|_dwarf_frame_interal_table_init
parameter_list|(
name|Dwarf_Debug
name|dbg
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_Regtable3
modifier|*
name|rt
decl_stmt|;
if|if
condition|(
name|dbg
operator|->
name|dbg_internal_reg_table
operator|!=
name|NULL
condition|)
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
comment|/* Initialise internal register table. */
if|if
condition|(
operator|(
name|rt
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|Dwarf_Regtable3
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_MEMORY
operator|)
return|;
block|}
name|rt
operator|->
name|rt3_reg_table_size
operator|=
name|dbg
operator|->
name|dbg_frame_rule_table_size
expr_stmt|;
if|if
condition|(
operator|(
name|rt
operator|->
name|rt3_rules
operator|=
name|calloc
argument_list|(
name|rt
operator|->
name|rt3_reg_table_size
argument_list|,
sizeof|sizeof
argument_list|(
name|Dwarf_Regtable_Entry3
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|rt
argument_list|)
expr_stmt|;
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_MEMORY
operator|)
return|;
block|}
name|dbg
operator|->
name|dbg_internal_reg_table
operator|=
name|rt
expr_stmt|;
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|_FDE_INST_INIT_SIZE
value|128
end_define

begin_function
name|int
name|_dwarf_frame_fde_add_inst
parameter_list|(
name|Dwarf_P_Fde
name|fde
parameter_list|,
name|Dwarf_Small
name|op
parameter_list|,
name|Dwarf_Unsigned
name|val1
parameter_list|,
name|Dwarf_Unsigned
name|val2
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_P_Debug
name|dbg
decl_stmt|;
name|uint8_t
name|high2
decl_stmt|,
name|low6
decl_stmt|;
name|int
name|ret
decl_stmt|;
define|#
directive|define
name|ds
value|fde
define|#
directive|define
name|ds_data
value|fde_inst
define|#
directive|define
name|ds_cap
value|fde_instcap
define|#
directive|define
name|ds_size
value|fde_instlen
name|assert
argument_list|(
name|fde
operator|!=
name|NULL
operator|&&
name|fde
operator|->
name|fde_dbg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dbg
operator|=
name|fde
operator|->
name|fde_dbg
expr_stmt|;
if|if
condition|(
name|fde
operator|->
name|fde_inst
operator|==
name|NULL
condition|)
block|{
name|fde
operator|->
name|fde_instcap
operator|=
name|_FDE_INST_INIT_SIZE
expr_stmt|;
name|fde
operator|->
name|fde_instlen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|fde
operator|->
name|fde_inst
operator|=
name|malloc
argument_list|(
operator|(
name|size_t
operator|)
name|fde
operator|->
name|fde_instcap
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_MEMORY
operator|)
return|;
block|}
block|}
name|assert
argument_list|(
name|fde
operator|->
name|fde_instcap
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
name|op
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|==
name|DW_CFA_nop
condition|)
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
name|high2
operator|=
name|op
operator|&
literal|0xc0
expr_stmt|;
name|low6
operator|=
name|op
operator|&
literal|0x3f
expr_stmt|;
if|if
condition|(
name|high2
operator|>
literal|0
condition|)
block|{
switch|switch
condition|(
name|high2
condition|)
block|{
case|case
name|DW_CFA_advance_loc
case|:
case|case
name|DW_CFA_restore
case|:
break|break;
case|case
name|DW_CFA_offset
case|:
name|RCHECK
argument_list|(
name|WRITE_ULEB128
argument_list|(
name|val1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_FRAME_INSTR_EXEC_ERROR
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_FRAME_INSTR_EXEC_ERROR
operator|)
return|;
block|}
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
block|}
switch|switch
condition|(
name|low6
condition|)
block|{
case|case
name|DW_CFA_set_loc
case|:
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
name|val1
argument_list|,
name|dbg
operator|->
name|dbg_pointer_size
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_advance_loc1
case|:
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
name|val1
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_advance_loc2
case|:
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
name|val1
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_advance_loc4
case|:
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
name|val1
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_offset_extended
case|:
case|case
name|DW_CFA_def_cfa
case|:
case|case
name|DW_CFA_register
case|:
name|RCHECK
argument_list|(
name|WRITE_ULEB128
argument_list|(
name|val1
argument_list|)
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|WRITE_ULEB128
argument_list|(
name|val2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_restore_extended
case|:
case|case
name|DW_CFA_undefined
case|:
case|case
name|DW_CFA_same_value
case|:
case|case
name|DW_CFA_def_cfa_register
case|:
case|case
name|DW_CFA_def_cfa_offset
case|:
name|RCHECK
argument_list|(
name|WRITE_ULEB128
argument_list|(
name|val1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DW_CFA_remember_state
case|:
case|case
name|DW_CFA_restore_state
case|:
break|break;
default|default:
name|DWARF_SET_ERROR
argument_list|(
name|dbg
argument_list|,
name|error
argument_list|,
name|DW_DLE_FRAME_INSTR_EXEC_ERROR
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_FRAME_INSTR_EXEC_ERROR
operator|)
return|;
block|}
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
name|gen_fail
label|:
return|return
operator|(
name|ret
operator|)
return|;
undef|#
directive|undef
name|ds
undef|#
directive|undef
name|ds_data
undef|#
directive|undef
name|ds_cap
undef|#
directive|undef
name|ds_size
block|}
end_function

begin_function
specifier|static
name|int
name|_dwarf_frame_gen_cie
parameter_list|(
name|Dwarf_P_Debug
name|dbg
parameter_list|,
name|Dwarf_P_Section
name|ds
parameter_list|,
name|Dwarf_P_Cie
name|cie
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_Unsigned
name|len
decl_stmt|;
name|uint64_t
name|offset
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|assert
argument_list|(
name|dbg
operator|!=
name|NULL
operator|&&
name|ds
operator|!=
name|NULL
operator|&&
name|cie
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|cie
operator|->
name|cie_offset
operator|=
name|offset
operator|=
name|ds
operator|->
name|ds_size
expr_stmt|;
name|cie
operator|->
name|cie_length
operator|=
literal|0
expr_stmt|;
name|cie
operator|->
name|cie_version
operator|=
literal|1
expr_stmt|;
comment|/* Length placeholder. */
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
name|cie
operator|->
name|cie_length
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
comment|/* .debug_frame use CIE id ~0. */
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
operator|~
literal|0U
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
comment|/* .debug_frame version is 1. (DWARF2) */
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
name|cie
operator|->
name|cie_version
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write augmentation, if present. */
if|if
condition|(
name|cie
operator|->
name|cie_augment
operator|!=
name|NULL
condition|)
name|RCHECK
argument_list|(
name|WRITE_BLOCK
argument_list|(
name|cie
operator|->
name|cie_augment
argument_list|,
name|strlen
argument_list|(
operator|(
name|char
operator|*
operator|)
name|cie
operator|->
name|cie_augment
argument_list|)
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write caf, daf and ra. */
name|RCHECK
argument_list|(
name|WRITE_ULEB128
argument_list|(
name|cie
operator|->
name|cie_caf
argument_list|)
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|WRITE_SLEB128
argument_list|(
name|cie
operator|->
name|cie_daf
argument_list|)
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
name|cie
operator|->
name|cie_ra
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write initial instructions, if present. */
if|if
condition|(
name|cie
operator|->
name|cie_initinst
operator|!=
name|NULL
condition|)
name|RCHECK
argument_list|(
name|WRITE_BLOCK
argument_list|(
name|cie
operator|->
name|cie_initinst
argument_list|,
name|cie
operator|->
name|cie_instlen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Add padding. */
name|len
operator|=
name|ds
operator|->
name|ds_size
operator|-
name|cie
operator|->
name|cie_offset
operator|-
literal|4
expr_stmt|;
name|cie
operator|->
name|cie_length
operator|=
name|roundup
argument_list|(
name|len
argument_list|,
name|dbg
operator|->
name|dbg_pointer_size
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|++
operator|<
name|cie
operator|->
name|cie_length
condition|)
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
name|DW_CFA_nop
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Fill in the length field. */
name|dbg
operator|->
name|write
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
operator|&
name|offset
argument_list|,
name|cie
operator|->
name|cie_length
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
name|gen_fail
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|_dwarf_frame_gen_fde
parameter_list|(
name|Dwarf_P_Debug
name|dbg
parameter_list|,
name|Dwarf_P_Section
name|ds
parameter_list|,
name|Dwarf_Rel_Section
name|drs
parameter_list|,
name|Dwarf_P_Fde
name|fde
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_Unsigned
name|len
decl_stmt|;
name|uint64_t
name|offset
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|assert
argument_list|(
name|dbg
operator|!=
name|NULL
operator|&&
name|ds
operator|!=
name|NULL
operator|&&
name|drs
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|fde
operator|!=
name|NULL
operator|&&
name|fde
operator|->
name|fde_cie
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|fde
operator|->
name|fde_offset
operator|=
name|offset
operator|=
name|ds
operator|->
name|ds_size
expr_stmt|;
name|fde
operator|->
name|fde_length
operator|=
literal|0
expr_stmt|;
name|fde
operator|->
name|fde_cieoff
operator|=
name|fde
operator|->
name|fde_cie
operator|->
name|cie_offset
expr_stmt|;
comment|/* Length placeholder. */
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
name|fde
operator|->
name|fde_length
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write CIE pointer. */
name|RCHECK
argument_list|(
name|_dwarf_reloc_entry_add
argument_list|(
name|dbg
argument_list|,
name|drs
argument_list|,
name|ds
argument_list|,
name|dwarf_drt_data_reloc
argument_list|,
literal|4
argument_list|,
name|ds
operator|->
name|ds_size
argument_list|,
literal|0
argument_list|,
name|fde
operator|->
name|fde_cieoff
argument_list|,
literal|".debug_frame"
argument_list|,
name|error
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write FDE initial location. */
name|RCHECK
argument_list|(
name|_dwarf_reloc_entry_add
argument_list|(
name|dbg
argument_list|,
name|drs
argument_list|,
name|ds
argument_list|,
name|dwarf_drt_data_reloc
argument_list|,
name|dbg
operator|->
name|dbg_pointer_size
argument_list|,
name|ds
operator|->
name|ds_size
argument_list|,
name|fde
operator|->
name|fde_symndx
argument_list|,
name|fde
operator|->
name|fde_initloc
argument_list|,
name|NULL
argument_list|,
name|error
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Write FDE address range. Use a pair of relocation entries if 	 * application provided end symbol index. Otherwise write the 	 * length without assoicating any relocation info. 	 */
if|if
condition|(
name|fde
operator|->
name|fde_esymndx
operator|>
literal|0
condition|)
name|RCHECK
argument_list|(
name|_dwarf_reloc_entry_add_pair
argument_list|(
name|dbg
argument_list|,
name|drs
argument_list|,
name|ds
argument_list|,
name|dbg
operator|->
name|dbg_pointer_size
argument_list|,
name|ds
operator|->
name|ds_size
argument_list|,
name|fde
operator|->
name|fde_symndx
argument_list|,
name|fde
operator|->
name|fde_esymndx
argument_list|,
name|fde
operator|->
name|fde_initloc
argument_list|,
name|fde
operator|->
name|fde_eoff
argument_list|,
name|error
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
name|fde
operator|->
name|fde_adrange
argument_list|,
name|dbg
operator|->
name|dbg_pointer_size
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write FDE frame instructions. */
name|RCHECK
argument_list|(
name|WRITE_BLOCK
argument_list|(
name|fde
operator|->
name|fde_inst
argument_list|,
name|fde
operator|->
name|fde_instlen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Add padding. */
name|len
operator|=
name|ds
operator|->
name|ds_size
operator|-
name|fde
operator|->
name|fde_offset
operator|-
literal|4
expr_stmt|;
name|fde
operator|->
name|fde_length
operator|=
name|roundup
argument_list|(
name|len
argument_list|,
name|dbg
operator|->
name|dbg_pointer_size
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|++
operator|<
name|fde
operator|->
name|fde_length
condition|)
name|RCHECK
argument_list|(
name|WRITE_VALUE
argument_list|(
name|DW_CFA_nop
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Fill in the length field. */
name|dbg
operator|->
name|write
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|,
operator|&
name|offset
argument_list|,
name|fde
operator|->
name|fde_length
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
name|gen_fail
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|_dwarf_frame_gen
parameter_list|(
name|Dwarf_P_Debug
name|dbg
parameter_list|,
name|Dwarf_Error
modifier|*
name|error
parameter_list|)
block|{
name|Dwarf_P_Section
name|ds
decl_stmt|;
name|Dwarf_Rel_Section
name|drs
decl_stmt|;
name|Dwarf_P_Cie
name|cie
decl_stmt|;
name|Dwarf_P_Fde
name|fde
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|STAILQ_EMPTY
argument_list|(
operator|&
name|dbg
operator|->
name|dbgp_cielist
argument_list|)
condition|)
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
comment|/* Create .debug_frame section. */
if|if
condition|(
operator|(
name|ret
operator|=
name|_dwarf_section_init
argument_list|(
name|dbg
argument_list|,
operator|&
name|ds
argument_list|,
literal|".debug_frame"
argument_list|,
literal|0
argument_list|,
name|error
argument_list|)
operator|)
operator|!=
name|DW_DLE_NONE
condition|)
goto|goto
name|gen_fail0
goto|;
comment|/* Create relocation section for .debug_frame */
name|RCHECK
argument_list|(
name|_dwarf_reloc_section_init
argument_list|(
name|dbg
argument_list|,
operator|&
name|drs
argument_list|,
name|ds
argument_list|,
name|error
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Generate list of CIE. */
name|STAILQ_FOREACH
argument_list|(
argument|cie
argument_list|,
argument|&dbg->dbgp_cielist
argument_list|,
argument|cie_next
argument_list|)
name|RCHECK
argument_list|(
name|_dwarf_frame_gen_cie
argument_list|(
name|dbg
argument_list|,
name|ds
argument_list|,
name|cie
argument_list|,
name|error
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Generate list of FDE. */
name|STAILQ_FOREACH
argument_list|(
argument|fde
argument_list|,
argument|&dbg->dbgp_fdelist
argument_list|,
argument|fde_next
argument_list|)
name|RCHECK
argument_list|(
name|_dwarf_frame_gen_fde
argument_list|(
name|dbg
argument_list|,
name|ds
argument_list|,
name|drs
argument_list|,
name|fde
argument_list|,
name|error
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Inform application the creation of .debug_frame ELF section. */
name|RCHECK
argument_list|(
name|_dwarf_section_callback
argument_list|(
name|dbg
argument_list|,
name|ds
argument_list|,
name|SHT_PROGBITS
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|error
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Finalize relocation section for .debug_frame */
name|RCHECK
argument_list|(
name|_dwarf_reloc_section_finalize
argument_list|(
name|dbg
argument_list|,
name|drs
argument_list|,
name|error
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|DW_DLE_NONE
operator|)
return|;
name|gen_fail
label|:
name|_dwarf_reloc_section_free
argument_list|(
name|dbg
argument_list|,
operator|&
name|drs
argument_list|)
expr_stmt|;
name|gen_fail0
label|:
name|_dwarf_section_free
argument_list|(
name|dbg
argument_list|,
operator|&
name|ds
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|void
name|_dwarf_frame_pro_cleanup
parameter_list|(
name|Dwarf_P_Debug
name|dbg
parameter_list|)
block|{
name|Dwarf_P_Cie
name|cie
decl_stmt|,
name|tcie
decl_stmt|;
name|Dwarf_P_Fde
name|fde
decl_stmt|,
name|tfde
decl_stmt|;
name|assert
argument_list|(
name|dbg
operator|!=
name|NULL
operator|&&
name|dbg
operator|->
name|dbg_mode
operator|==
name|DW_DLC_WRITE
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH_SAFE
argument_list|(
argument|cie
argument_list|,
argument|&dbg->dbgp_cielist
argument_list|,
argument|cie_next
argument_list|,
argument|tcie
argument_list|)
block|{
name|STAILQ_REMOVE
argument_list|(
operator|&
name|dbg
operator|->
name|dbgp_cielist
argument_list|,
name|cie
argument_list|,
name|_Dwarf_Cie
argument_list|,
name|cie_next
argument_list|)
expr_stmt|;
if|if
condition|(
name|cie
operator|->
name|cie_augment
condition|)
name|free
argument_list|(
name|cie
operator|->
name|cie_augment
argument_list|)
expr_stmt|;
if|if
condition|(
name|cie
operator|->
name|cie_initinst
condition|)
name|free
argument_list|(
name|cie
operator|->
name|cie_initinst
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cie
argument_list|)
expr_stmt|;
block|}
name|dbg
operator|->
name|dbgp_cielen
operator|=
literal|0
expr_stmt|;
name|STAILQ_FOREACH_SAFE
argument_list|(
argument|fde
argument_list|,
argument|&dbg->dbgp_fdelist
argument_list|,
argument|fde_next
argument_list|,
argument|tfde
argument_list|)
block|{
name|STAILQ_REMOVE
argument_list|(
operator|&
name|dbg
operator|->
name|dbgp_fdelist
argument_list|,
name|fde
argument_list|,
name|_Dwarf_Fde
argument_list|,
name|fde_next
argument_list|)
expr_stmt|;
if|if
condition|(
name|fde
operator|->
name|fde_inst
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|fde
operator|->
name|fde_inst
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fde
argument_list|)
expr_stmt|;
block|}
name|dbg
operator|->
name|dbgp_fdelen
operator|=
literal|0
expr_stmt|;
block|}
end_function

end_unit


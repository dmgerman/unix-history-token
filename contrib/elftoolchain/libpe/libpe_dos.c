begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Kai Wang  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"_libpe.h"
end_include

begin_expr_stmt
name|ELFTC_VCSID
argument_list|(
literal|"$Id: libpe_dos.c 3312 2016-01-10 09:23:51Z kaiwang27 $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|libpe_parse_msdos_header
parameter_list|(
name|PE
modifier|*
name|pe
parameter_list|,
name|char
modifier|*
name|hdr
parameter_list|)
block|{
name|PE_DosHdr
modifier|*
name|dh
decl_stmt|;
name|char
name|coff
index|[
sizeof|sizeof
argument_list|(
name|PE_CoffHdr
argument_list|)
index|]
decl_stmt|;
name|uint32_t
name|pe_magic
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|pe
operator|->
name|pe_stub
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|memcpy
argument_list|(
name|pe
operator|->
name|pe_stub
argument_list|,
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dh
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|dh
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|pe
operator|->
name|pe_dh
operator|=
name|dh
expr_stmt|;
comment|/* Read the conventional MS-DOS EXE header. */
name|memcpy
argument_list|(
name|dh
operator|->
name|dh_magic
argument_list|,
name|hdr
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|hdr
operator|+=
literal|2
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_lastsize
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_nblock
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_nreloc
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_hdrsize
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_minalloc
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_maxalloc
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_ss
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_sp
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_checksum
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_ip
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_cs
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_relocpos
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_noverlay
argument_list|)
expr_stmt|;
comment|/* Do not continue if the EXE is not a PE/NE/... (new executable) */
if|if
condition|(
name|dh
operator|->
name|dh_relocpos
operator|!=
literal|0x40
condition|)
block|{
name|pe
operator|->
name|pe_flags
operator||=
name|LIBPE_F_BAD_DOS_HEADER
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_reserved1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_oemid
argument_list|)
expr_stmt|;
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_oeminfo
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
name|PE_READ16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_reserved2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|PE_READ32
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_lfanew
argument_list|)
expr_stmt|;
comment|/* Check if the e_lfanew pointer is valid. */
if|if
condition|(
name|dh
operator|->
name|dh_lfanew
operator|>
name|pe
operator|->
name|pe_fsize
operator|-
literal|4
condition|)
block|{
name|pe
operator|->
name|pe_flags
operator||=
name|LIBPE_F_BAD_DOS_HEADER
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|dh
operator|->
name|dh_lfanew
operator|<
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
operator|&&
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_SPECIAL_FILE
operator|)
condition|)
block|{
name|pe
operator|->
name|pe_flags
operator||=
name|LIBPE_F_BAD_DOS_HEADER
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|dh
operator|->
name|dh_lfanew
operator|>
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
condition|)
block|{
name|pe
operator|->
name|pe_stub_ex
operator|=
name|dh
operator|->
name|dh_lfanew
operator|-
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_SPECIAL_FILE
condition|)
block|{
comment|/* Read in DOS stub now. */
if|if
condition|(
name|libpe_read_msdos_stub
argument_list|(
name|pe
argument_list|)
operator|<
literal|0
condition|)
block|{
name|pe
operator|->
name|pe_flags
operator||=
name|LIBPE_F_BAD_DOS_HEADER
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
if|if
condition|(
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_SPECIAL_FILE
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* Jump to the PE header. */
if|if
condition|(
name|lseek
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
operator|(
name|off_t
operator|)
name|dh
operator|->
name|dh_lfanew
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|pe
operator|->
name|pe_flags
operator||=
name|LIBPE_F_BAD_PE_HEADER
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
if|if
condition|(
name|read
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
operator|&
name|pe_magic
argument_list|,
literal|4
argument_list|)
operator|!=
literal|4
operator|||
name|htole32
argument_list|(
name|pe_magic
argument_list|)
operator|!=
name|PE_SIGNATURE
condition|)
block|{
name|pe
operator|->
name|pe_flags
operator||=
name|LIBPE_F_BAD_PE_HEADER
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|read
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
name|coff
argument_list|,
sizeof|sizeof
argument_list|(
name|coff
argument_list|)
argument_list|)
operator|!=
operator|(
name|ssize_t
operator|)
sizeof|sizeof
argument_list|(
name|coff
argument_list|)
condition|)
block|{
name|pe
operator|->
name|pe_flags
operator||=
name|LIBPE_F_BAD_COFF_HEADER
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|libpe_parse_coff_header
argument_list|(
name|pe
argument_list|,
name|coff
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|libpe_read_msdos_stub
parameter_list|(
name|PE
modifier|*
name|pe
parameter_list|)
block|{
name|void
modifier|*
name|m
decl_stmt|;
name|assert
argument_list|(
name|pe
operator|->
name|pe_stub_ex
operator|>
literal|0
operator|&&
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_LOAD_DOS_STUB
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_SPECIAL_FILE
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|lseek
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
operator|(
name|off_t
operator|)
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|errno
operator|=
name|EIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
if|if
condition|(
operator|(
name|m
operator|=
name|realloc
argument_list|(
name|pe
operator|->
name|pe_stub
argument_list|,
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
operator|+
name|pe
operator|->
name|pe_stub_ex
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|pe
operator|->
name|pe_stub
operator|=
name|m
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
name|pe
operator|->
name|pe_stub
operator|+
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
argument_list|,
name|pe
operator|->
name|pe_stub_ex
argument_list|)
operator|!=
operator|(
name|ssize_t
operator|)
name|pe
operator|->
name|pe_stub_ex
condition|)
block|{
name|errno
operator|=
name|EIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|pe
operator|->
name|pe_flags
operator||=
name|LIBPE_F_LOAD_DOS_STUB
expr_stmt|;
comment|/* Search for the Rich header embedded just before the PE header. */
operator|(
name|void
operator|)
name|libpe_parse_rich_header
argument_list|(
name|pe
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|pe
operator|->
name|pe_stub_ex
operator|=
literal|0
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * The "standard" MS-DOS stub displaying "This program cannot be run in  * DOS mode".  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|msdos_stub
index|[]
init|=
block|{
literal|'\x0e'
block|,
literal|'\x1f'
block|,
literal|'\xba'
block|,
literal|'\x0e'
block|,
literal|'\x00'
block|,
literal|'\xb4'
block|,
literal|'\x09'
block|,
literal|'\xcd'
block|,
literal|'\x21'
block|,
literal|'\xb8'
block|,
literal|'\x01'
block|,
literal|'\x4c'
block|,
literal|'\xcd'
block|,
literal|'\x21'
block|,
literal|'\x54'
block|,
literal|'\x68'
block|,
literal|'\x69'
block|,
literal|'\x73'
block|,
literal|'\x20'
block|,
literal|'\x70'
block|,
literal|'\x72'
block|,
literal|'\x6f'
block|,
literal|'\x67'
block|,
literal|'\x72'
block|,
literal|'\x61'
block|,
literal|'\x6d'
block|,
literal|'\x20'
block|,
literal|'\x63'
block|,
literal|'\x61'
block|,
literal|'\x6e'
block|,
literal|'\x6e'
block|,
literal|'\x6f'
block|,
literal|'\x74'
block|,
literal|'\x20'
block|,
literal|'\x62'
block|,
literal|'\x65'
block|,
literal|'\x20'
block|,
literal|'\x72'
block|,
literal|'\x75'
block|,
literal|'\x6e'
block|,
literal|'\x20'
block|,
literal|'\x69'
block|,
literal|'\x6e'
block|,
literal|'\x20'
block|,
literal|'\x44'
block|,
literal|'\x4f'
block|,
literal|'\x53'
block|,
literal|'\x20'
block|,
literal|'\x6d'
block|,
literal|'\x6f'
block|,
literal|'\x64'
block|,
literal|'\x65'
block|,
literal|'\x2e'
block|,
literal|'\x0d'
block|,
literal|'\x0d'
block|,
literal|'\x0a'
block|,
literal|'\x24'
block|,
literal|'\x00'
block|,
literal|'\x00'
block|,
literal|'\x00'
block|,
literal|'\x00'
block|,
literal|'\x00'
block|,
literal|'\x00'
block|,
literal|'\x00'
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|init_dos_header
parameter_list|(
name|PE_DosHdr
modifier|*
name|dh
parameter_list|)
block|{
name|dh
operator|->
name|dh_magic
index|[
literal|0
index|]
operator|=
literal|'M'
expr_stmt|;
name|dh
operator|->
name|dh_magic
index|[
literal|1
index|]
operator|=
literal|'Z'
expr_stmt|;
name|dh
operator|->
name|dh_lastsize
operator|=
literal|144
expr_stmt|;
name|dh
operator|->
name|dh_nblock
operator|=
literal|3
expr_stmt|;
name|dh
operator|->
name|dh_hdrsize
operator|=
literal|4
expr_stmt|;
name|dh
operator|->
name|dh_maxalloc
operator|=
literal|65535
expr_stmt|;
name|dh
operator|->
name|dh_sp
operator|=
literal|184
expr_stmt|;
name|dh
operator|->
name|dh_relocpos
operator|=
literal|0x40
expr_stmt|;
name|dh
operator|->
name|dh_lfanew
operator|=
literal|0x80
expr_stmt|;
block|}
end_function

begin_function
name|off_t
name|libpe_write_msdos_stub
parameter_list|(
name|PE
modifier|*
name|pe
parameter_list|,
name|off_t
name|off
parameter_list|)
block|{
name|PE_DosHdr
modifier|*
name|dh
decl_stmt|;
name|char
name|tmp
index|[
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
index|]
decl_stmt|,
modifier|*
name|hdr
decl_stmt|;
name|off_t
name|d
decl_stmt|;
name|int
name|i
decl_stmt|,
name|strip_rich
decl_stmt|;
name|strip_rich
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pe
operator|->
name|pe_cmd
operator|==
name|PE_C_RDWR
condition|)
block|{
name|assert
argument_list|(
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_SPECIAL_FILE
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pe
operator|->
name|pe_dh
operator|!=
name|NULL
operator|&&
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|PE_F_STRIP_DOS_STUB
operator|)
condition|)
block|{
comment|/* 			 * If we strip MS-DOS stub, everything after it 			 * needs rewritten. 			 */
name|pe
operator|->
name|pe_flags
operator||=
name|LIBPE_F_BAD_PE_HEADER
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 		 * lseek(2) to the PE signature if MS-DOS stub is not 		 * modified. 		 */
if|if
condition|(
name|pe
operator|->
name|pe_dh
operator|!=
name|NULL
operator|&&
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_DIRTY_DOS_HEADER
operator|)
operator|==
literal|0
operator|&&
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_BAD_DOS_HEADER
operator|)
operator|==
literal|0
operator|&&
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|PE_F_STRIP_RICH_HEADER
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|lseek
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
call|(
name|off_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
operator|+
name|pe
operator|->
name|pe_stub_ex
argument_list|)
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
condition|)
block|{
name|errno
operator|=
name|EIO
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|off
operator|=
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
operator|+
name|pe
operator|->
name|pe_stub_ex
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* Check if we should strip the Rich header. */
if|if
condition|(
name|pe
operator|->
name|pe_dh
operator|!=
name|NULL
operator|&&
name|pe
operator|->
name|pe_stub_app
operator|==
name|NULL
operator|&&
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_BAD_DOS_HEADER
operator|)
operator|==
literal|0
operator|&&
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|PE_F_STRIP_RICH_HEADER
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_LOAD_DOS_STUB
operator|)
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|libpe_read_msdos_stub
argument_list|(
name|pe
argument_list|)
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
name|off
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|errno
operator|=
name|EIO
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
if|if
condition|(
name|pe
operator|->
name|pe_rh
operator|!=
name|NULL
condition|)
block|{
name|strip_rich
operator|=
literal|1
expr_stmt|;
name|pe
operator|->
name|pe_flags
operator||=
name|LIBPE_F_DIRTY_DOS_HEADER
expr_stmt|;
block|}
block|}
comment|/* 		 * If length of MS-DOS stub will change, Mark the PE 		 * signature is broken so that the PE signature and the 		 * headers follow it will be rewritten. 		 * 		 * The sections should be loaded now since the stub might 		 * overwrite the section data. 		 */
if|if
condition|(
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_BAD_DOS_HEADER
operator|)
operator|||
operator|(
name|pe
operator|->
name|pe_stub_app
operator|!=
name|NULL
operator|&&
name|pe
operator|->
name|pe_stub_app_sz
operator|!=
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
operator|+
name|pe
operator|->
name|pe_stub_ex
operator|)
operator|||
name|strip_rich
condition|)
block|{
if|if
condition|(
name|libpe_load_all_sections
argument_list|(
name|pe
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|lseek
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
name|off
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|errno
operator|=
name|EIO
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|pe
operator|->
name|pe_flags
operator||=
name|LIBPE_F_BAD_PE_HEADER
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pe
operator|->
name|pe_flags
operator|&
name|PE_F_STRIP_DOS_STUB
condition|)
goto|goto
name|done
goto|;
comment|/* Always use application supplied MS-DOS stub, if exists. */
if|if
condition|(
name|pe
operator|->
name|pe_stub_app
operator|!=
name|NULL
operator|&&
name|pe
operator|->
name|pe_stub_app_sz
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|write
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
name|pe
operator|->
name|pe_stub_app
argument_list|,
name|pe
operator|->
name|pe_stub_app_sz
argument_list|)
operator|!=
operator|(
name|ssize_t
operator|)
name|pe
operator|->
name|pe_stub_app_sz
condition|)
block|{
name|errno
operator|=
name|EIO
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|off
operator|=
name|pe
operator|->
name|pe_stub_app_sz
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 	 * Write MS-DOS header. 	 */
if|if
condition|(
name|pe
operator|->
name|pe_dh
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|dh
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|pe
operator|->
name|pe_dh
operator|=
name|dh
expr_stmt|;
name|init_dos_header
argument_list|(
name|dh
argument_list|)
expr_stmt|;
name|pe
operator|->
name|pe_flags
operator||=
name|LIBPE_F_DIRTY_DOS_HEADER
expr_stmt|;
block|}
else|else
name|dh
operator|=
name|pe
operator|->
name|pe_dh
expr_stmt|;
if|if
condition|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_BAD_DOS_HEADER
condition|)
name|init_dos_header
argument_list|(
name|dh
argument_list|)
expr_stmt|;
if|if
condition|(
name|strip_rich
condition|)
block|{
name|d
operator|=
name|pe
operator|->
name|pe_rh_start
operator|-
name|pe
operator|->
name|pe_stub
expr_stmt|;
name|dh
operator|->
name|dh_lfanew
operator|=
name|roundup
argument_list|(
name|d
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_DIRTY_DOS_HEADER
operator|)
operator|||
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_BAD_DOS_HEADER
operator|)
condition|)
block|{
name|memcpy
argument_list|(
name|tmp
argument_list|,
name|dh
operator|->
name|dh_magic
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|hdr
operator|=
name|tmp
operator|+
literal|2
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_lastsize
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_nblock
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_nreloc
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_hdrsize
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_minalloc
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_maxalloc
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_ss
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_sp
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_checksum
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_ip
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_cs
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_relocpos
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_noverlay
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_reserved1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_oemid
argument_list|)
expr_stmt|;
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_oeminfo
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
name|PE_WRITE16
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_reserved2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|PE_WRITE32
argument_list|(
name|hdr
argument_list|,
name|dh
operator|->
name|dh_lfanew
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|)
operator|!=
operator|(
name|ssize_t
operator|)
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
condition|)
block|{
name|errno
operator|=
name|EIO
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
else|else
block|{
name|assert
argument_list|(
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_SPECIAL_FILE
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
operator|(
name|off_t
operator|)
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
condition|)
block|{
name|errno
operator|=
name|EIO
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|off
operator|=
sizeof|sizeof
argument_list|(
name|PE_DosHdr
argument_list|)
expr_stmt|;
comment|/* 	 * Write the MS-DOS stub. 	 */
if|if
condition|(
name|strip_rich
condition|)
block|{
name|assert
argument_list|(
operator|(
name|pe
operator|->
name|pe_flags
operator|&
name|LIBPE_F_SPECIAL_FILE
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|pe
operator|->
name|pe_stub
operator|!=
name|NULL
operator|&&
name|pe
operator|->
name|pe_rh_start
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|d
operator|=
name|pe
operator|->
name|pe_rh_start
operator|-
name|pe
operator|->
name|pe_stub
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
name|d
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|errno
operator|=
name|EIO
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|off
operator|=
name|d
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|pe
operator|->
name|pe_cmd
operator|==
name|PE_C_RDWR
condition|)
block|{
if|if
condition|(
name|lseek
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
operator|(
name|off_t
operator|)
name|pe
operator|->
name|pe_stub_ex
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
condition|)
block|{
name|errno
operator|=
name|EIO
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|off
operator|+=
name|pe
operator|->
name|pe_stub_ex
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|write
argument_list|(
name|pe
operator|->
name|pe_fd
argument_list|,
name|msdos_stub
argument_list|,
sizeof|sizeof
argument_list|(
name|msdos_stub
argument_list|)
argument_list|)
operator|!=
operator|(
name|ssize_t
operator|)
sizeof|sizeof
argument_list|(
name|msdos_stub
argument_list|)
condition|)
block|{
name|errno
operator|=
name|EIO
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|off
operator|+=
sizeof|sizeof
argument_list|(
name|msdos_stub
argument_list|)
expr_stmt|;
name|done
label|:
name|pe
operator|->
name|pe_flags
operator|&=
operator|~
name|LIBPE_F_DIRTY_DOS_HEADER
expr_stmt|;
name|pe
operator|->
name|pe_flags
operator|&=
operator|~
name|LIBPE_F_BAD_DOS_HEADER
expr_stmt|;
return|return
operator|(
name|off
operator|)
return|;
block|}
end_function

end_unit


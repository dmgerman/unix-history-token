begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 2006, 2007 Free Software Foundation, Inc.    Contributed by Jakub Jelinek<jakub@redhat.com>.     This file is part of the GNU OpenMP Library (libgomp).     Libgomp is free software; you can redistribute it and/or modify it    under the terms of the GNU Lesser General Public License as published by    the Free Software Foundation; either version 2.1 of the License, or    (at your option) any later version.     Libgomp is distributed in the hope that it will be useful, but WITHOUT ANY    WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS    FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for    more details.     You should have received a copy of the GNU Lesser General Public License     along with libgomp; see the file COPYING.LIB.  If not, write to the    Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,    MA 02110-1301, USA.  */
end_comment

begin_comment
comment|/* As a special exception, if you link this library with other files, some    of which are compiled with GCC, to produce an executable, this library    does not by itself cause the resulting executable to be covered by the    GNU General Public License.  This exception does not however invalidate    any other reasons why the executable file might be covered by the GNU    General Public License.  */
end_comment

begin_comment
comment|/* This is a Linux specific implementation of a CPU affinity setting.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|_GNU_SOURCE
end_ifndef

begin_define
define|#
directive|define
name|_GNU_SOURCE
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"libgomp.h"
end_include

begin_include
include|#
directive|include
file|<sched.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_PTHREAD_AFFINITY_NP
end_ifdef

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|affinity_counter
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|HAVE_SYNC_BUILTINS
end_ifndef

begin_decl_stmt
specifier|static
name|gomp_mutex_t
name|affinity_lock
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|gomp_init_affinity
parameter_list|(
name|void
parameter_list|)
block|{
name|cpu_set_t
name|cpuset
decl_stmt|;
name|size_t
name|idx
decl_stmt|,
name|widx
decl_stmt|;
if|if
condition|(
name|pthread_getaffinity_np
argument_list|(
name|pthread_self
argument_list|()
argument_list|,
sizeof|sizeof
argument_list|(
name|cpuset
argument_list|)
argument_list|,
operator|&
name|cpuset
argument_list|)
condition|)
block|{
name|gomp_error
argument_list|(
literal|"could not get CPU affinity set"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|gomp_cpu_affinity
argument_list|)
expr_stmt|;
name|gomp_cpu_affinity
operator|=
name|NULL
expr_stmt|;
name|gomp_cpu_affinity_len
operator|=
literal|0
expr_stmt|;
return|return;
block|}
for|for
control|(
name|widx
operator|=
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|gomp_cpu_affinity_len
condition|;
name|idx
operator|++
control|)
if|if
condition|(
name|gomp_cpu_affinity
index|[
name|idx
index|]
operator|<
name|CPU_SETSIZE
operator|&&
name|CPU_ISSET
argument_list|(
name|gomp_cpu_affinity
index|[
name|idx
index|]
argument_list|,
operator|&
name|cpuset
argument_list|)
condition|)
name|gomp_cpu_affinity
index|[
name|widx
operator|++
index|]
operator|=
name|gomp_cpu_affinity
index|[
name|idx
index|]
expr_stmt|;
if|if
condition|(
name|widx
operator|==
literal|0
condition|)
block|{
name|gomp_error
argument_list|(
literal|"no CPUs left for affinity setting"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|gomp_cpu_affinity
argument_list|)
expr_stmt|;
name|gomp_cpu_affinity
operator|=
name|NULL
expr_stmt|;
name|gomp_cpu_affinity_len
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|gomp_cpu_affinity_len
operator|=
name|widx
expr_stmt|;
name|CPU_ZERO
argument_list|(
operator|&
name|cpuset
argument_list|)
expr_stmt|;
name|CPU_SET
argument_list|(
name|gomp_cpu_affinity
index|[
literal|0
index|]
argument_list|,
operator|&
name|cpuset
argument_list|)
expr_stmt|;
name|pthread_setaffinity_np
argument_list|(
name|pthread_self
argument_list|()
argument_list|,
sizeof|sizeof
argument_list|(
name|cpuset
argument_list|)
argument_list|,
operator|&
name|cpuset
argument_list|)
expr_stmt|;
name|affinity_counter
operator|=
literal|1
expr_stmt|;
ifndef|#
directive|ifndef
name|HAVE_SYNC_BUILTINS
name|gomp_mutex_init
argument_list|(
operator|&
name|affinity_lock
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|gomp_init_thread_affinity
parameter_list|(
name|pthread_attr_t
modifier|*
name|attr
parameter_list|)
block|{
name|unsigned
name|int
name|cpu
decl_stmt|;
name|cpu_set_t
name|cpuset
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SYNC_BUILTINS
name|cpu
operator|=
name|__sync_fetch_and_add
argument_list|(
operator|&
name|affinity_counter
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|#
directive|else
name|gomp_mutex_lock
argument_list|(
operator|&
name|affinity_lock
argument_list|)
expr_stmt|;
name|cpu
operator|=
name|affinity_counter
operator|++
expr_stmt|;
name|gomp_mutex_unlock
argument_list|(
operator|&
name|affinity_lock
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cpu
operator|%=
name|gomp_cpu_affinity_len
expr_stmt|;
name|CPU_ZERO
argument_list|(
operator|&
name|cpuset
argument_list|)
expr_stmt|;
name|CPU_SET
argument_list|(
name|gomp_cpu_affinity
index|[
name|cpu
index|]
argument_list|,
operator|&
name|cpuset
argument_list|)
expr_stmt|;
name|pthread_attr_setaffinity_np
argument_list|(
name|attr
argument_list|,
sizeof|sizeof
argument_list|(
name|cpu_set_t
argument_list|)
argument_list|,
operator|&
name|cpuset
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"../posix/affinity.c"
end_include

begin_endif
endif|#
directive|endif
end_endif

end_unit


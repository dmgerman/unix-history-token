begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<port_before.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<port_after.h>
end_include

begin_decl_stmt
name|char
modifier|*
name|flags
index|[]
init|=
block|{
literal|" AI_PASSIVE"
block|,
literal|" AI_CANONNAME"
block|,
literal|" AI_NUMERICHOST"
block|,
literal|" 0x00000008"
block|,
literal|" 0x00000010"
block|,
literal|" 0x00000020"
block|,
literal|" 0x00000040"
block|,
literal|" 0x00000080"
block|,
literal|" 0x00000100"
block|,
literal|" 0x00000200"
block|,
literal|" 0x00000400"
block|,
literal|" 0x00000800"
block|,
literal|" 0x00001000"
block|,
literal|" 0x00002000"
block|,
literal|" 0x00004000"
block|,
literal|" 0x00008000"
block|,
literal|" 0x00010000"
block|,
literal|" 0x00020000"
block|,
literal|" 0x00040000"
block|,
literal|" 0x00080000"
block|,
literal|" 0x00100000"
block|,
literal|" 0x00200000"
block|,
literal|" 0x00400000"
block|,
literal|" 0x00800000"
block|,
literal|" 0x01000000"
block|,
literal|" 0x02000000"
block|,
literal|" 0x04000000"
block|,
literal|" 0x08000000"
block|,
literal|" 0x10000000"
block|,
literal|" 0x20000000"
block|,
literal|" 0x40000000"
block|,
literal|" 0x80000000"
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|print_ai
parameter_list|(
name|struct
name|addrinfo
modifier|*
name|answer
parameter_list|,
name|int
name|hints
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|answer
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"No %s\n"
argument_list|,
name|hints
condition|?
literal|"Hints"
else|:
literal|"Answer"
argument_list|)
expr_stmt|;
return|return;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s:\n"
argument_list|,
name|hints
condition|?
literal|"Hints"
else|:
literal|"Answer"
argument_list|)
expr_stmt|;
while|while
condition|(
name|answer
condition|)
block|{
name|fputs
argument_list|(
literal|"flags:"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|answer
operator|->
name|ai_flags
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
name|fputs
argument_list|(
name|flags
index|[
name|i
index|]
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"family: %d, socktype: %d, protocol: %d\n"
argument_list|,
name|answer
operator|->
name|ai_family
argument_list|,
name|answer
operator|->
name|ai_socktype
argument_list|,
name|answer
operator|->
name|ai_protocol
argument_list|)
expr_stmt|;
if|if
condition|(
name|hints
condition|)
return|return;
if|if
condition|(
name|answer
operator|->
name|ai_canonname
operator|!=
name|NULL
condition|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"canonname: \"%s\"\n"
argument_list|,
name|answer
operator|->
name|ai_canonname
argument_list|)
expr_stmt|;
else|else
name|fputs
argument_list|(
literal|"canonname: --none--\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"addrlen: %d\n"
argument_list|,
name|answer
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|answer
operator|->
name|ai_addrlen
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s%02x"
argument_list|,
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
literal|"0x"
else|:
literal|""
argument_list|,
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|answer
operator|->
name|ai_addr
operator|)
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|answer
operator|->
name|ai_addrlen
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s%d"
argument_list|,
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
literal|""
else|:
literal|"."
argument_list|,
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|answer
operator|->
name|ai_addr
operator|)
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|answer
operator|->
name|ai_addrlen
condition|;
name|i
operator|++
control|)
block|{
name|int
name|c
init|=
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|answer
operator|->
name|ai_addr
operator|)
operator|)
index|[
name|i
index|]
decl_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%c"
argument_list|,
operator|(
name|isascii
argument_list|(
name|c
argument_list|)
operator|&&
name|isprint
argument_list|(
name|c
argument_list|)
operator|)
condition|?
name|c
else|:
literal|'.'
argument_list|)
expr_stmt|;
block|}
name|fputs
argument_list|(
literal|"\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|answer
operator|=
name|answer
operator|->
name|ai_next
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|usage
parameter_list|()
block|{
name|fputs
argument_list|(
literal|"usage:"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-h<hostname>\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-s<service>\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-p AI_PASSIVE\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-c AI_CANONNAME\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-n AI_NUMERICHOST\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-4 AF_INET4\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-6 AF_INET6\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-l AF_LOCAL\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-u IPPROTO_UDP\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-t IPPROTO_TCP\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-S SOCK_STREAM\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-D SOCK_DGRAM\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-R SOCK_RAW\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-M SOCK_RDM\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\t-P SOCK_SEQPACKET\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|c
decl_stmt|;
name|char
modifier|*
name|hostname
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|service
init|=
name|NULL
decl_stmt|;
name|struct
name|addrinfo
name|info
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|addrinfo
modifier|*
name|answer
decl_stmt|;
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|info
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"h:s:pcn46ltuSDRMP"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'h'
case|:
name|hostname
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|service
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|info
operator|.
name|ai_flags
operator||=
name|AI_PASSIVE
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|info
operator|.
name|ai_flags
operator||=
name|AI_CANONNAME
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|info
operator|.
name|ai_flags
operator||=
name|AI_NUMERICHOST
expr_stmt|;
break|break;
case|case
literal|'4'
case|:
name|info
operator|.
name|ai_family
operator|=
name|AF_INET
expr_stmt|;
break|break;
case|case
literal|'6'
case|:
name|info
operator|.
name|ai_family
operator|=
name|AF_INET6
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|AF_LOCAL
case|case
literal|'l'
case|:
name|info
operator|.
name|ai_family
operator|=
name|AF_LOCAL
expr_stmt|;
break|break;
else|#
directive|else
case|case
literal|'l'
case|:
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"AF_LOCAL not supported\n"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
literal|'t'
case|:
name|info
operator|.
name|ai_protocol
operator|=
name|IPPROTO_TCP
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|info
operator|.
name|ai_protocol
operator|=
name|IPPROTO_UDP
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|info
operator|.
name|ai_socktype
operator|=
name|SOCK_STREAM
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|info
operator|.
name|ai_socktype
operator|=
name|SOCK_DGRAM
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|info
operator|.
name|ai_socktype
operator|=
name|SOCK_RAW
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
name|info
operator|.
name|ai_socktype
operator|=
name|SOCK_RDM
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|info
operator|.
name|ai_socktype
operator|=
name|SOCK_SEQPACKET
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|usage
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
name|res
operator|=
name|getaddrinfo
argument_list|(
name|hostname
argument_list|,
name|service
argument_list|,
operator|&
name|info
argument_list|,
operator|&
name|answer
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s\n"
argument_list|,
name|gai_strerror
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|print_ai
argument_list|(
operator|&
name|info
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|print_ai
argument_list|(
name|answer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|freeaddrinfo
argument_list|(
name|answer
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright(c) 1999 by Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND INTERNET SOFTWARE CONSORTIUM DISCLAIMS  * ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL INTERNET SOFTWARE  * CONSORTIUM BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL  * DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR  * PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS  * ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS  * SOFTWARE.  */
end_comment

begin_comment
comment|/* Notes. */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|I have to use an AF_INET. Ctl_server should probably take a AF arugment.  The server has no way to issue any other greeting than HELLO. E.g., would like to be able to drop connection on greeting if client is not comming from 127.0.0.1.  Need to fix client to handle response with body.  should add iovec with body to the struct ctl_sess?  should we close connections on some errors (like marshalling errors)?  getnetbyname falls back to /etc/networks when named not running. Does not seem to be so for getnetbyaddr
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|LIBC_SCCS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
end_if

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$Id: irpd.c,v 1.10 2000/12/23 08:14:33 vixie Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* LIBC_SCCS and not lint */
end_comment

begin_comment
comment|/* Imports. */
end_comment

begin_include
include|#
directive|include
file|"port_before.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<arpa/nameser.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<grp.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<resolv.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<utmp.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|EMPTY
end_ifdef

begin_comment
comment|/* Digital UNIX utmp.h defines this. */
end_comment

begin_undef
undef|#
directive|undef
name|EMPTY
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<isc/ctl.h>
end_include

begin_include
include|#
directive|include
file|<isc/assertions.h>
end_include

begin_include
include|#
directive|include
file|<isc/list.h>
end_include

begin_include
include|#
directive|include
file|<isc/memcluster.h>
end_include

begin_include
include|#
directive|include
file|<isc/logging.h>
end_include

begin_include
include|#
directive|include
file|<irs.h>
end_include

begin_include
include|#
directive|include
file|<irp.h>
end_include

begin_include
include|#
directive|include
file|<isc/irpmarshall.h>
end_include

begin_include
include|#
directive|include
file|<irs_data.h>
end_include

begin_include
include|#
directive|include
file|"port_after.h"
end_include

begin_comment
comment|/* Macros. */
end_comment

begin_define
define|#
directive|define
name|ALLDIGITS
parameter_list|(
name|s
parameter_list|)
value|(strspn((s), "0123456789") == strlen((s)))
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|MAXHOSTNAMELEN
end_ifndef

begin_define
define|#
directive|define
name|MAXHOSTNAMELEN
value|256
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MAXNETNAMELEN
value|256
end_define

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|SUN_LEN
argument_list|)
end_if

begin_define
define|#
directive|define
name|SUN_LEN
parameter_list|(
name|su
parameter_list|)
define|\
value|(sizeof (*(su)) - sizeof ((su)->sun_path) + strlen((su)->sun_path))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * This macro is used to initialize a specified field of a net_data struct.  * If the initialization fails then an error response code is sent with a  * description of which field failed to be initialized.  *  * This is only meant for use at the start of the various verb functions.  */
end_comment

begin_define
define|#
directive|define
name|ND_INIT
parameter_list|(
name|nd
parameter_list|,
name|field
parameter_list|,
name|sess
parameter_list|,
name|respcode
parameter_list|)
define|\
value|do{ if ((nd)->field == 0) {					     \ 		(nd)->field = (*(nd)->irs->field ## _map)(nd->irs);	     \ 	        if ((nd)->field == 0) {					     \ 		    char *msg = "net_data " #field " initialization failed"; \ 		    ctl_response(sess, respcode, msg, CTL_EXIT, NULL,	     \ 			         NULL, NULL, NULL, 0);			     \ 		    return;						     \                 }							     \ 	    }								     \  	} while (0)
end_define

begin_comment
comment|/* Data structures. */
end_comment

begin_struct
struct|struct
name|arg_s
block|{
name|struct
name|iovec
modifier|*
name|iov
decl_stmt|;
name|int
name|iovlen
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|response_buff
block|{
name|char
modifier|*
name|buff
decl_stmt|;
name|size_t
name|bufflen
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|client_ctx
block|{
name|struct
name|net_data
modifier|*
name|net_data
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Forwards. */
end_comment

begin_function_decl
specifier|static
name|struct
name|response_buff
modifier|*
name|newbuffer
parameter_list|(
name|u_int
name|length
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|release_buffer
parameter_list|(
name|struct
name|response_buff
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|arg_s
modifier|*
name|split_string
parameter_list|(
specifier|const
name|char
modifier|*
name|string
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|free_args
parameter_list|(
name|struct
name|arg_s
modifier|*
name|args
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|client_ctx
modifier|*
name|make_cli_ctx
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|net_data
modifier|*
name|get_net_data
parameter_list|(
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_gethostbyname
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_gethostbyname2
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_gethostbyaddr
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_gethostent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_sethostent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getpwnam
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getpwuid
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getpwent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_setpwent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getnetbyname
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getnetbyaddr
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getnetent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_setnetent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getgrnam
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getgrgid
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getgrent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_setgrent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getservbyname
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getservbyport
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getservent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_setservent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getprotobyname
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getprotobynumber
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getprotoent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_setprotoent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_getnetgrent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_innetgr
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_setnetgrent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_endnetgrent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_quit
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_help
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_accept
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|irpd_abort
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|response_done
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
name|void
modifier|*
name|uap
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|logger
parameter_list|(
name|enum
name|ctl_severity
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Constants. */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|u_int
name|hello_code
init|=
name|IRPD_WELCOME_CODE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|hello_msg
index|[]
init|=
literal|"Welcome to IRPD (v 1)"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|u_int
name|unkncode
init|=
literal|500
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|u_int
name|timeoutcode
init|=
literal|501
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|u_int
name|irpd_quit_ok
init|=
literal|201
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|u_int
name|timeout
init|=
name|IRPD_TIMEOUT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Globals. */
end_comment

begin_decl_stmt
specifier|static
name|int
name|main_needs_exit
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|evContext
name|ev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ctl_verb
name|verbs
index|[]
init|=
block|{
block|{
literal|"gethostbyname"
block|,
name|irpd_gethostbyname
block|}
block|,
block|{
literal|"gethostbyname2"
block|,
name|irpd_gethostbyname2
block|}
block|,
block|{
literal|"gethostbyaddr"
block|,
name|irpd_gethostbyaddr
block|}
block|,
block|{
literal|"gethostent"
block|,
name|irpd_gethostent
block|}
block|,
block|{
literal|"sethostent"
block|,
name|irpd_sethostent
block|}
block|,
ifdef|#
directive|ifdef
name|WANT_IRS_PW
block|{
literal|"getpwnam"
block|,
name|irpd_getpwnam
block|}
block|,
block|{
literal|"getpwuid"
block|,
name|irpd_getpwuid
block|}
block|,
block|{
literal|"getpwent"
block|,
name|irpd_getpwent
block|}
block|,
block|{
literal|"setpwent"
block|,
name|irpd_setpwent
block|}
block|,
endif|#
directive|endif
block|{
literal|"getnetbyname"
block|,
name|irpd_getnetbyname
block|}
block|,
block|{
literal|"getnetbyaddr"
block|,
name|irpd_getnetbyaddr
block|}
block|,
block|{
literal|"getnetent"
block|,
name|irpd_getnetent
block|}
block|,
block|{
literal|"setnetent"
block|,
name|irpd_setnetent
block|}
block|,
ifdef|#
directive|ifdef
name|WANT_IRS_GR
block|{
literal|"getgrnam"
block|,
name|irpd_getgrnam
block|}
block|,
block|{
literal|"getgrgid"
block|,
name|irpd_getgrgid
block|}
block|,
block|{
literal|"getgrent"
block|,
name|irpd_getgrent
block|}
block|,
block|{
literal|"setgrent"
block|,
name|irpd_setgrent
block|}
block|,
endif|#
directive|endif
block|{
literal|"getservbyname"
block|,
name|irpd_getservbyname
block|}
block|,
block|{
literal|"getservbyport"
block|,
name|irpd_getservbyport
block|}
block|,
block|{
literal|"getservent"
block|,
name|irpd_getservent
block|}
block|,
block|{
literal|"setservent"
block|,
name|irpd_setservent
block|}
block|,
block|{
literal|"getprotobyname"
block|,
name|irpd_getprotobyname
block|}
block|,
block|{
literal|"getprotobynumber"
block|,
name|irpd_getprotobynumber
block|}
block|,
block|{
literal|"getprotoent"
block|,
name|irpd_getprotoent
block|}
block|,
block|{
literal|"setprotoent"
block|,
name|irpd_setprotoent
block|}
block|,
block|{
literal|"getnetgrent"
block|,
name|irpd_getnetgrent
block|}
block|,
block|{
literal|"innetgr"
block|,
name|irpd_innetgr
block|}
block|,
block|{
literal|"setnetgrent"
block|,
name|irpd_setnetgrent
block|}
block|,
block|{
literal|"endnetgrent"
block|,
name|irpd_endnetgrent
block|}
block|,
block|{
literal|"quit"
block|,
name|irpd_quit
block|}
block|,
block|{
literal|"help"
block|,
name|irpd_help
block|}
block|,
block|{
literal|""
block|,
name|irpd_accept
block|}
block|,
comment|/* For connection setups. */
comment|/* abort is a verb expected by the ctl library. Is called when the 	 * client drops the connection unexpectedly. 	 */
block|{
literal|"abort"
block|,
name|irpd_abort
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * An empty string causes the library to use the compiled in  * defaults and to ignore any external files.  */
end_comment

begin_decl_stmt
name|char
modifier|*
name|conffile
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Public. */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ctl_sctx
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|addr
decl_stmt|;
ifndef|#
directive|ifndef
name|NO_SOCKADDR_UN
name|struct
name|sockaddr_un
name|uaddr
decl_stmt|;
endif|#
directive|endif
name|struct
name|sockaddr_in
name|iaddr
decl_stmt|;
name|short
name|port
init|=
name|IRPD_PORT
decl_stmt|;
name|char
modifier|*
name|prog
init|=
name|argv
index|[
literal|0
index|]
decl_stmt|;
name|char
modifier|*
name|sockname
init|=
name|IRPD_PATH
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|ch
decl_stmt|;
name|size_t
name|socksize
decl_stmt|;
name|addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|iaddr
expr_stmt|;
name|socksize
operator|=
sizeof|sizeof
name|iaddr
expr_stmt|;
name|openlog
argument_list|(
literal|"iprd"
argument_list|,
name|LOG_CONS
operator||
name|LOG_PID
argument_list|,
name|ISC_FACILITY
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"u:p:c:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'c'
case|:
name|conffile
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|port
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
operator|&
name|p
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|!=
literal|'\0'
condition|)
block|{
comment|/* junk in argument */
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"port option not a number"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
ifndef|#
directive|ifndef
name|NO_SOCKADDR_UN
case|case
literal|'u'
case|:
name|sockname
operator|=
name|optarg
expr_stmt|;
name|addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|uaddr
expr_stmt|;
name|socksize
operator|=
sizeof|sizeof
name|uaddr
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
literal|'h'
case|:
case|case
literal|'?'
case|:
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s [ -c config-file ]\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
name|memset
argument_list|(
operator|&
name|iaddr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|iaddr
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SA_LEN
name|iaddr
operator|.
name|sin_len
operator|=
sizeof|sizeof
name|iaddr
expr_stmt|;
endif|#
directive|endif
name|iaddr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|iaddr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|IRPD_PORT
argument_list|)
expr_stmt|;
name|iaddr
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|INADDR_ANY
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|NO_SOCKADDR_UN
name|memset
argument_list|(
operator|&
name|uaddr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|uaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|==
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|uaddr
condition|)
block|{
name|uaddr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|strncpy
argument_list|(
name|uaddr
operator|.
name|sun_path
argument_list|,
name|sockname
argument_list|,
sizeof|sizeof
name|uaddr
operator|.
name|sun_path
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SA_LEN
name|uaddr
operator|.
name|sun_len
operator|=
name|SUN_LEN
argument_list|(
operator|&
name|uaddr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|socksize
operator|=
name|SUN_LEN
argument_list|(
operator|&
name|uaddr
argument_list|)
expr_stmt|;
comment|/* XXX what if this file is not currently a socket? */
name|unlink
argument_list|(
name|sockname
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|evCreate
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|ctl_server
argument_list|(
name|ev
argument_list|,
name|addr
argument_list|,
name|socksize
argument_list|,
name|verbs
argument_list|,
name|unkncode
argument_list|,
name|timeoutcode
argument_list|,
comment|/* IRPD_TIMEOUT */
literal|30
argument_list|,
literal|5
argument_list|,
name|IRPD_MAXSESS
argument_list|,
name|logger
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|main_needs_exit
condition|)
block|{
name|evEvent
name|event
decl_stmt|;
name|INSIST_ERR
argument_list|(
name|evGetNext
argument_list|(
name|ev
argument_list|,
operator|&
name|event
argument_list|,
name|EV_WAIT
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|INSIST_ERR
argument_list|(
name|evDispatch
argument_list|(
name|ev
argument_list|,
name|event
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * static void  * simple_response(struct ctl_sess *sess, u_int code, char *msg);  *	Send back a simple, one-line response to the client.  */
end_comment

begin_function
specifier|static
name|void
name|simple_response
parameter_list|(
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
name|u_int
name|code
parameter_list|,
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|response_buff
modifier|*
name|b
init|=
name|newbuffer
argument_list|(
name|strlen
argument_list|(
name|msg
argument_list|)
operator|+
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|b
operator|==
literal|0
condition|)
return|return;
name|strcpy
argument_list|(
name|b
operator|->
name|buff
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|ctl_response
argument_list|(
name|sess
argument_list|,
name|code
argument_list|,
name|b
operator|->
name|buff
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|response_done
argument_list|,
name|b
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * send_hostent(struct ctl_sess *sess, struct hostent *ho);  *	Send a hostent struct over the wire. If HO is NULL, then  *	a "No such host" is sent instead.  */
end_comment

begin_function
specifier|static
name|void
name|send_hostent
parameter_list|(
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
name|struct
name|hostent
modifier|*
name|ho
parameter_list|)
block|{
if|if
condition|(
name|ho
operator|==
name|NULL
condition|)
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETHOST_NONE
argument_list|,
literal|"No such host"
argument_list|)
expr_stmt|;
else|else
block|{
name|struct
name|response_buff
modifier|*
name|b
init|=
name|newbuffer
argument_list|(
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|irp_marshall_ho
argument_list|(
name|ho
argument_list|,
operator|&
name|b
operator|->
name|buff
argument_list|,
operator|&
name|b
operator|->
name|bufflen
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|,
literal|"Internal error"
argument_list|)
expr_stmt|;
name|logger
argument_list|(
name|ctl_warning
argument_list|,
literal|"Cannot marshall host data for %s\n"
argument_list|,
name|ho
operator|->
name|h_name
argument_list|)
expr_stmt|;
name|release_buffer
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strcat
argument_list|(
name|b
operator|->
name|buff
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|ctl_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETHOST_OK
argument_list|,
literal|"Host found"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|response_done
argument_list|,
name|b
argument_list|,
name|b
operator|->
name|buff
argument_list|,
name|strlen
argument_list|(
name|b
operator|->
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * static void  * do_gethostbyname2(struct ctl_sess *sess, struct net_data *nd,  *		     const char *hostname, int af);  *	Look up the given HOSTNAME by Address-Family  *	and then send the results to the client connected to  *	SESS.  */
end_comment

begin_function
specifier|static
name|void
name|do_gethostbyname2
parameter_list|(
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
name|struct
name|net_data
modifier|*
name|nd
parameter_list|,
specifier|const
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|af
parameter_list|)
block|{
name|struct
name|hostent
modifier|*
name|ho
decl_stmt|;
name|ho
operator|=
name|gethostbyname2_p
argument_list|(
name|hostname
argument_list|,
name|af
argument_list|,
name|nd
argument_list|)
expr_stmt|;
name|send_hostent
argument_list|(
name|sess
argument_list|,
name|ho
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_gethostbyname(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		      const struct ctl_verb *verb, const char *rest,  *		      u_int respflags, void *respctx, void *uctx);  *	Implementation of the GETHOSTBYNAME verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_gethostbyname
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|char
name|hname
index|[
name|MAXHOSTNAMELEN
index|]
decl_stmt|;
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|ho
argument_list|,
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|2
condition|)
block|{
comment|/* len includes NULL at end */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|,
literal|"Incorrect usage: GETHOSTBYNAME hostname"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|hname
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|,
literal|"GETHOSTBYNAME: name too long"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|hname
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|hname
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|do_gethostbyname2
argument_list|(
name|sess
argument_list|,
name|netdata
argument_list|,
name|hname
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
block|}
block|}
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_gethostbyname2(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		       const struct ctl_verb *verb, const char *rest,  *		       u_int respflags, void *respctx, void *uctx);  *	Implementation of the GETHOSTBYNAME2 verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_gethostbyname2
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|char
name|hname
index|[
name|MAXHOSTNAMELEN
index|]
decl_stmt|;
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|int
name|af
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|ho
argument_list|,
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|3
condition|)
block|{
comment|/* len includes NULL at end */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|,
literal|"Incorrect usage: GETHOSTBYNAME2 hostname AF"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|hname
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|,
literal|"GETHOSTBYNAME2: name too long"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|strncasecmp
argument_list|(
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_base
argument_list|,
literal|"af_inet6"
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
name|af
operator|=
name|AF_INET6
expr_stmt|;
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_base
argument_list|,
literal|"af_inet"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
name|af
operator|=
name|AF_INET
expr_stmt|;
else|else
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|,
literal|"Unknown address family"
argument_list|)
expr_stmt|;
goto|goto
name|untimely
goto|;
block|}
name|strncpy
argument_list|(
name|hname
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|hname
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|do_gethostbyname2
argument_list|(
name|sess
argument_list|,
name|netdata
argument_list|,
name|hname
argument_list|,
name|af
argument_list|)
expr_stmt|;
block|}
name|untimely
label|:
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_gethostbyaddr(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		      const struct ctl_verb *verb, const char *rest,  *		      u_int respflags, void *respctx, void *uctx);  *	Implementation of the GETHOSTBYADDR verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_gethostbyaddr
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|hostent
modifier|*
name|ho
decl_stmt|;
name|char
name|haddr
index|[
name|MAXHOSTNAMELEN
index|]
decl_stmt|;
name|char
name|tmpaddr
index|[
name|NS_IN6ADDRSZ
index|]
decl_stmt|;
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|int
name|af
decl_stmt|;
name|int
name|addrlen
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|ho
argument_list|,
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|3
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|,
literal|"GETHOSTBYADDR addr afamily"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|haddr
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|,
literal|"Address too long"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|haddr
argument_list|,
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|haddr
index|[
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|haddr
argument_list|,
literal|"af_inet"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|af
operator|=
name|AF_INET
expr_stmt|;
name|addrlen
operator|=
name|NS_INADDRSZ
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|haddr
argument_list|,
literal|"af_inet6"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|af
operator|=
name|AF_INET6
expr_stmt|;
name|addrlen
operator|=
name|NS_IN6ADDRSZ
expr_stmt|;
block|}
else|else
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|,
literal|"Unknown address family"
argument_list|)
expr_stmt|;
goto|goto
name|untimely
goto|;
block|}
name|strncpy
argument_list|(
name|haddr
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|haddr
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|inet_pton
argument_list|(
name|af
argument_list|,
name|haddr
argument_list|,
name|tmpaddr
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|,
literal|"Invalid address"
argument_list|)
expr_stmt|;
goto|goto
name|untimely
goto|;
block|}
name|ho
operator|=
name|gethostbyaddr_p
argument_list|(
name|tmpaddr
argument_list|,
name|addrlen
argument_list|,
name|af
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
name|send_hostent
argument_list|(
name|sess
argument_list|,
name|ho
argument_list|)
expr_stmt|;
block|}
block|}
name|untimely
label|:
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_gethostent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		   const struct ctl_verb *verb, const char *rest,  *		   u_int respflags, void *respctx, void *uctx);  *	Implementation of the GETHOSTENT verb  */
end_comment

begin_function
specifier|static
name|void
name|irpd_gethostent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|hostent
modifier|*
name|ho
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|ho
argument_list|,
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|)
expr_stmt|;
name|ho
operator|=
name|gethostent_p
argument_list|(
name|netdata
argument_list|)
expr_stmt|;
name|send_hostent
argument_list|(
name|sess
argument_list|,
name|ho
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_sethostent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		   const struct ctl_verb *verb, const char *rest,  *		   u_int respflags, void *respctx, void *uctx);  *	Implementation of the SETHOSTENT verb  */
end_comment

begin_function
specifier|static
name|void
name|irpd_sethostent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|ho
argument_list|,
name|sess
argument_list|,
name|IRPD_GETHOST_ERROR
argument_list|)
expr_stmt|;
name|sethostent_p
argument_list|(
literal|1
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
comment|/* always stayopen */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETHOST_SETOK
argument_list|,
literal|"ok"
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|WANT_IRS_PW
end_ifdef

begin_comment
comment|/*  * static void  * send_pwent(struct ctl_sess *sess, struct passwd *pw);  *	Send PW over the wire, or, if PW is NULL, a "No such  *	user" response.  */
end_comment

begin_function
specifier|static
name|void
name|send_pwent
parameter_list|(
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
name|struct
name|passwd
modifier|*
name|pw
parameter_list|)
block|{
if|if
condition|(
name|pw
operator|==
name|NULL
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETUSER_NONE
argument_list|,
literal|"No such user"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|response_buff
modifier|*
name|b
init|=
name|newbuffer
argument_list|(
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|irp_marshall_pw
argument_list|(
name|pw
argument_list|,
operator|&
name|b
operator|->
name|buff
argument_list|,
operator|&
name|b
operator|->
name|bufflen
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETUSER_ERROR
argument_list|,
literal|"Internal error"
argument_list|)
expr_stmt|;
name|logger
argument_list|(
name|ctl_warning
argument_list|,
literal|"Cant marshall pw\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|strcat
argument_list|(
name|b
operator|->
name|buff
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|ctl_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETUSER_OK
argument_list|,
literal|"User found"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|response_done
argument_list|,
name|b
argument_list|,
name|b
operator|->
name|buff
argument_list|,
name|strlen
argument_list|(
name|b
operator|->
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getpwnam(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		 const struct ctl_verb *verb, const char *rest,  *		 u_int respflags, void *respctx, void *uctx);  *	Implementation of the GETPWNAM verb  */
end_comment

begin_function
specifier|static
name|void
name|irpd_getpwnam
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
name|char
name|username
index|[
literal|64
index|]
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|pw
argument_list|,
name|sess
argument_list|,
name|IRPD_GETUSER_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|2
condition|)
block|{
comment|/* len includes NULL at end */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETUSER_ERROR
argument_list|,
literal|"GETPWNAM username"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|username
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETUSER_ERROR
argument_list|,
literal|"Name too long"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|username
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|username
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pw
operator|=
name|getpwnam_p
argument_list|(
name|username
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
name|send_pwent
argument_list|(
name|sess
argument_list|,
name|pw
argument_list|)
expr_stmt|;
block|}
block|}
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getpwuid(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		 const struct ctl_verb *verb, const char *rest,  *		 u_int respflags, void *respctx, void *uctx);  *	Implementation of the GETPWUID verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_getpwuid
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
name|char
name|userid
index|[
literal|64
index|]
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|pw
argument_list|,
name|sess
argument_list|,
name|IRPD_GETUSER_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|2
condition|)
block|{
comment|/* len includes NULL at end */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETUSER_ERROR
argument_list|,
literal|"GETPWUID uid"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|userid
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETUSER_ERROR
argument_list|,
literal|"Name too long"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|userid
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|userid
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|ALLDIGITS
argument_list|(
name|userid
argument_list|)
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETUSER_ERROR
argument_list|,
literal|"Not a uid"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uid_t
name|uid
decl_stmt|;
name|long
name|lval
decl_stmt|;
name|lval
operator|=
name|strtol
argument_list|(
name|userid
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|uid
operator|=
operator|(
name|uid_t
operator|)
name|lval
expr_stmt|;
if|if
condition|(
operator|(
name|long
operator|)
name|uid
operator|!=
name|lval
condition|)
block|{
comment|/* value was too big */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETUSER_ERROR
argument_list|,
literal|"Not a valid uid"
argument_list|)
expr_stmt|;
goto|goto
name|untimely
goto|;
block|}
name|pw
operator|=
name|getpwuid_p
argument_list|(
name|uid
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
name|send_pwent
argument_list|(
name|sess
argument_list|,
name|pw
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|untimely
label|:
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getpwent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		 const struct ctl_verb *verb, const char *rest,  *		 u_int respflags, void *respctx, void *uctx);  *	Implemtnation of the GETPWENT verb.   */
end_comment

begin_function
specifier|static
name|void
name|irpd_getpwent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|pw
argument_list|,
name|sess
argument_list|,
name|IRPD_GETUSER_ERROR
argument_list|)
expr_stmt|;
name|pw
operator|=
name|getpwent_p
argument_list|(
name|netdata
argument_list|)
expr_stmt|;
name|send_pwent
argument_list|(
name|sess
argument_list|,
name|pw
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_setpwent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		 const struct ctl_verb *verb, const char *rest,  *		 u_int respflags, void *respctx, void *uctx);  *	Implemtnation of the SETPWENT verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_setpwent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|pw
argument_list|,
name|sess
argument_list|,
name|IRPD_GETUSER_ERROR
argument_list|)
expr_stmt|;
name|setpwent_p
argument_list|(
name|netdata
argument_list|)
expr_stmt|;
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETUSER_SETOK
argument_list|,
literal|"ok"
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* WANT_IRS_PW */
end_comment

begin_comment
comment|/*  * static void  * send_nwent(struct ctl_sess *sess, struct nwent *ne);  *	Sends a nwent structure over the wire, or "No such  *	network" if NE is NULL.  */
end_comment

begin_function
specifier|static
name|void
name|send_nwent
parameter_list|(
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
name|struct
name|nwent
modifier|*
name|nw
parameter_list|)
block|{
if|if
condition|(
name|nw
operator|==
name|NULL
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNET_NONE
argument_list|,
literal|"No such net"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|response_buff
modifier|*
name|b
init|=
name|newbuffer
argument_list|(
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|irp_marshall_nw
argument_list|(
name|nw
argument_list|,
operator|&
name|b
operator|->
name|buff
argument_list|,
operator|&
name|b
operator|->
name|bufflen
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNET_ERROR
argument_list|,
literal|"Internal error"
argument_list|)
expr_stmt|;
name|logger
argument_list|(
name|ctl_warning
argument_list|,
literal|"Cant marshall nw\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|strcat
argument_list|(
name|b
operator|->
name|buff
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|ctl_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNET_OK
argument_list|,
literal|"Network found"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|response_done
argument_list|,
name|b
argument_list|,
name|b
operator|->
name|buff
argument_list|,
name|strlen
argument_list|(
name|b
operator|->
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getnetbyname(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		     const struct ctl_verb *verb, const char *rest,  *		     u_int respflags, void *respctx, void *uctx);  *	Implementation of GETNETBYNAME verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_getnetbyname
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|struct
name|netent
modifier|*
name|ne
decl_stmt|;
name|struct
name|nwent
modifier|*
name|nw
decl_stmt|;
name|char
name|netname
index|[
name|MAXNETNAMELEN
index|]
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|nw
argument_list|,
name|sess
argument_list|,
name|IRPD_GETNET_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|2
condition|)
block|{
comment|/* len includes NULL at end */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNET_ERROR
argument_list|,
literal|"GETNETBYNAME name"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|netname
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNET_ERROR
argument_list|,
literal|"Name too long"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|netname
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|netname
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|ne
operator|=
name|getnetbyname_p
argument_list|(
name|netname
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
comment|/* The public interface only gives us a struct 			   netent, and we need a struct nwent that irs uses 			   internally, so we go dig it out ourselves. Yuk 			*/
name|nw
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ne
operator|!=
name|NULL
condition|)
block|{
comment|/* Puke. */
name|INSIST
argument_list|(
name|netdata
operator|->
name|nw_last
operator|==
name|ne
argument_list|)
expr_stmt|;
name|nw
operator|=
name|netdata
operator|->
name|nww_last
expr_stmt|;
block|}
name|send_nwent
argument_list|(
name|sess
argument_list|,
name|nw
argument_list|)
expr_stmt|;
block|}
block|}
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getnetbyaddr(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		     const struct ctl_verb *verb, const char *rest,  *		     u_int respflags, void *respctx, void *uctx);  */
end_comment

begin_function
specifier|static
name|void
name|irpd_getnetbyaddr
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|netent
modifier|*
name|ne
decl_stmt|;
name|struct
name|nwent
modifier|*
name|nw
decl_stmt|;
name|char
name|haddr
index|[
name|MAXHOSTNAMELEN
index|]
decl_stmt|;
name|long
name|tmpaddr
decl_stmt|;
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|int
name|af
decl_stmt|;
name|int
name|addrlen
decl_stmt|;
name|int
name|bits
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|nw
argument_list|,
name|sess
argument_list|,
name|IRPD_GETUSER_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|3
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNET_ERROR
argument_list|,
literal|"GETNETBYADDR addr afamily"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|haddr
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNET_ERROR
argument_list|,
literal|"Address too long"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|haddr
argument_list|,
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|haddr
index|[
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|haddr
argument_list|,
literal|"af_inet"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|af
operator|=
name|AF_INET
expr_stmt|;
name|addrlen
operator|=
name|NS_INADDRSZ
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|haddr
argument_list|,
literal|"af_inet6"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|af
operator|=
name|AF_INET6
expr_stmt|;
name|addrlen
operator|=
name|NS_IN6ADDRSZ
expr_stmt|;
comment|/* XXX the interface we use(getnetbyaddr) 				 * can't handle AF_INET6, so for now we 				 * bail. 				 */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNET_ERROR
argument_list|,
literal|"AF_INET6 unsupported"
argument_list|)
expr_stmt|;
goto|goto
name|untimely
goto|;
block|}
else|else
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNET_ERROR
argument_list|,
literal|"Unknown address family"
argument_list|)
expr_stmt|;
goto|goto
name|untimely
goto|;
block|}
name|strncpy
argument_list|(
name|haddr
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|haddr
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|bits
operator|=
name|inet_net_pton
argument_list|(
name|af
argument_list|,
name|haddr
argument_list|,
operator|&
name|tmpaddr
argument_list|,
sizeof|sizeof
name|tmpaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bits
operator|<
literal|0
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNET_ERROR
argument_list|,
literal|"Invalid address"
argument_list|)
expr_stmt|;
goto|goto
name|untimely
goto|;
block|}
name|ne
operator|=
name|getnetbyaddr_p
argument_list|(
name|tmpaddr
argument_list|,
name|af
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
comment|/* The public interface only gives us a struct 			   netent, and we need a struct nwent that irs uses 			   internally, so we go dig it out ourselves. Yuk 			*/
name|nw
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ne
operator|!=
name|NULL
condition|)
block|{
comment|/* Puke puke */
name|INSIST
argument_list|(
name|netdata
operator|->
name|nw_last
operator|==
name|ne
argument_list|)
expr_stmt|;
name|nw
operator|=
name|netdata
operator|->
name|nww_last
expr_stmt|;
block|}
name|send_nwent
argument_list|(
name|sess
argument_list|,
name|nw
argument_list|)
expr_stmt|;
block|}
block|}
name|untimely
label|:
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getnetent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		  const struct ctl_verb *verb, const char *rest,  *		  u_int respflags, void *respctx, void *uctx);  *	Implementation of the GETNETENT verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_getnetent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|netent
modifier|*
name|ne
decl_stmt|;
name|struct
name|nwent
modifier|*
name|nw
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|nw
argument_list|,
name|sess
argument_list|,
name|IRPD_GETNET_ERROR
argument_list|)
expr_stmt|;
name|ne
operator|=
name|getnetent_p
argument_list|(
name|netdata
argument_list|)
expr_stmt|;
name|nw
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ne
operator|!=
name|NULL
condition|)
block|{
comment|/* triple puke */
name|INSIST
argument_list|(
name|netdata
operator|->
name|nw_last
operator|==
name|ne
argument_list|)
expr_stmt|;
name|nw
operator|=
name|netdata
operator|->
name|nww_last
expr_stmt|;
block|}
name|send_nwent
argument_list|(
name|sess
argument_list|,
name|nw
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_setnetent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		  const struct ctl_verb *verb, const char *rest,  *		  u_int respflags, void *respctx, void *uctx);  *	Implementation of the SETNETENT verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_setnetent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|nw
argument_list|,
name|sess
argument_list|,
name|IRPD_GETNET_ERROR
argument_list|)
expr_stmt|;
name|setnetent_p
argument_list|(
literal|1
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
comment|/* always stayopen */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNET_SETOK
argument_list|,
literal|"ok"
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|WANT_IRS_GR
end_ifdef

begin_comment
comment|/*  * static void  * send_grent(struct ctl_sess *sess, struct group *gr);  *	Marshall GR and send as body of response. If GR is NULL  *	then a "No such group" response is sent instead.  */
end_comment

begin_function
specifier|static
name|void
name|send_grent
parameter_list|(
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
name|struct
name|group
modifier|*
name|gr
parameter_list|)
block|{
if|if
condition|(
name|gr
operator|==
name|NULL
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETGROUP_NONE
argument_list|,
literal|"No such user"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|response_buff
modifier|*
name|b
init|=
name|newbuffer
argument_list|(
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|irp_marshall_gr
argument_list|(
name|gr
argument_list|,
operator|&
name|b
operator|->
name|buff
argument_list|,
operator|&
name|b
operator|->
name|bufflen
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETGROUP_ERROR
argument_list|,
literal|"Internal error"
argument_list|)
expr_stmt|;
name|logger
argument_list|(
name|ctl_warning
argument_list|,
literal|"Cant marshall gr\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|strcat
argument_list|(
name|b
operator|->
name|buff
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|ctl_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETGROUP_OK
argument_list|,
literal|"Group found"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|response_done
argument_list|,
name|b
argument_list|,
name|b
operator|->
name|buff
argument_list|,
name|strlen
argument_list|(
name|b
operator|->
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getgrnam(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		 const struct ctl_verb *verb, const char *rest,  *		 u_int respflags, void *respctx, void *uctx);  *	Implementation of the GETGRNAM verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_getgrnam
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|struct
name|group
modifier|*
name|gr
decl_stmt|;
name|char
name|groupname
index|[
literal|64
index|]
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|gr
argument_list|,
name|sess
argument_list|,
name|IRPD_GETGROUP_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|2
condition|)
block|{
comment|/* len includes NULL at end */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETGROUP_ERROR
argument_list|,
literal|"GETGRNAM groupname"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|groupname
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETGROUP_ERROR
argument_list|,
literal|"Name too long"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|groupname
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|groupname
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|gr
operator|=
name|getgrnam_p
argument_list|(
name|groupname
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
name|send_grent
argument_list|(
name|sess
argument_list|,
name|gr
argument_list|)
expr_stmt|;
block|}
block|}
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getgrgid(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		 const struct ctl_verb *verb, const char *rest,  *		 u_int respflags, void *respctx, void *uctx);  *	Implentation of the GETGRGID verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_getgrgid
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|struct
name|group
modifier|*
name|gr
decl_stmt|;
name|char
name|groupid
index|[
literal|64
index|]
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|gr
argument_list|,
name|sess
argument_list|,
name|IRPD_GETGROUP_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|2
condition|)
block|{
comment|/* len includes NULL at end */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETGROUP_ERROR
argument_list|,
literal|"GETGRUID gid"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|groupid
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETGROUP_ERROR
argument_list|,
literal|"Name too long"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|groupid
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|groupid
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|ALLDIGITS
argument_list|(
name|groupid
argument_list|)
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETGROUP_ERROR
argument_list|,
literal|"Not a gid"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gid_t
name|gid
decl_stmt|;
name|long
name|lval
decl_stmt|;
name|lval
operator|=
name|strtol
argument_list|(
name|groupid
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|gid
operator|=
operator|(
name|gid_t
operator|)
name|lval
expr_stmt|;
if|if
condition|(
operator|(
name|long
operator|)
name|gid
operator|!=
name|lval
condition|)
block|{
comment|/* value was too big */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETGROUP_ERROR
argument_list|,
literal|"Not a valid gid"
argument_list|)
expr_stmt|;
goto|goto
name|untimely
goto|;
block|}
name|gr
operator|=
name|getgrgid_p
argument_list|(
name|gid
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
name|send_grent
argument_list|(
name|sess
argument_list|,
name|gr
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|untimely
label|:
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getgrent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		 const struct ctl_verb *verb, const char *rest,  *		 u_int respflags, void *respctx, void *uctx);  *	Implementation of the GETGRENT verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_getgrent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|group
modifier|*
name|gr
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|gr
argument_list|,
name|sess
argument_list|,
name|IRPD_GETGROUP_ERROR
argument_list|)
expr_stmt|;
name|gr
operator|=
name|getgrent_p
argument_list|(
name|netdata
argument_list|)
expr_stmt|;
name|send_grent
argument_list|(
name|sess
argument_list|,
name|gr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_setgrent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		 const struct ctl_verb *verb, const char *rest,  *		 u_int respflags, void *respctx, void *uctx);  *	Implementation of the SETGRENT verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_setgrent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|gr
argument_list|,
name|sess
argument_list|,
name|IRPD_GETGROUP_ERROR
argument_list|)
expr_stmt|;
name|setgrent_p
argument_list|(
name|netdata
argument_list|)
expr_stmt|;
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETGROUP_SETOK
argument_list|,
literal|"ok"
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* WANT_IRS_GR */
end_comment

begin_function
specifier|static
name|void
name|send_servent
parameter_list|(
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
name|struct
name|servent
modifier|*
name|serv
parameter_list|)
block|{
if|if
condition|(
name|serv
operator|==
name|NULL
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETSERVICE_NONE
argument_list|,
literal|"No such service"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|response_buff
modifier|*
name|b
init|=
name|newbuffer
argument_list|(
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|irp_marshall_sv
argument_list|(
name|serv
argument_list|,
operator|&
name|b
operator|->
name|buff
argument_list|,
operator|&
name|b
operator|->
name|bufflen
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETSERVICE_ERROR
argument_list|,
literal|"Internal error"
argument_list|)
expr_stmt|;
name|logger
argument_list|(
name|ctl_warning
argument_list|,
literal|"Cant marshall servent\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|strcat
argument_list|(
name|b
operator|->
name|buff
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|ctl_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETSERVICE_OK
argument_list|,
literal|"Service found"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|response_done
argument_list|,
name|b
argument_list|,
name|b
operator|->
name|buff
argument_list|,
name|strlen
argument_list|(
name|b
operator|->
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|irpd_getservbyname
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|struct
name|servent
modifier|*
name|serv
decl_stmt|;
name|char
name|servicename
index|[
literal|64
index|]
decl_stmt|;
name|char
name|protoname
index|[
literal|10
index|]
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|sv
argument_list|,
name|sess
argument_list|,
name|IRPD_GETSERVICE_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|3
condition|)
block|{
comment|/* len includes NULL at end */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETSERVICE_ERROR
argument_list|,
literal|"GETSERVNAM servicename protocol"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|servicename
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETSERVICE_ERROR
argument_list|,
literal|"Invalid service name"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|protoname
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETSERVICE_ERROR
argument_list|,
literal|"Invalid protocol name"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|servicename
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|servicename
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|strncpy
argument_list|(
name|protoname
argument_list|,
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|protoname
index|[
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|serv
operator|=
name|getservbyname_p
argument_list|(
name|servicename
argument_list|,
name|protoname
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
name|send_servent
argument_list|(
name|sess
argument_list|,
name|serv
argument_list|)
expr_stmt|;
block|}
block|}
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getservbyport(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		      const struct ctl_verb *verb, const char *rest,  *		      u_int respflags, void *respctx, void *uctx);  *	Handle the GETSERVBYPORT verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_getservbyport
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|struct
name|servent
modifier|*
name|sv
decl_stmt|;
name|char
name|portnum
index|[
literal|64
index|]
decl_stmt|;
name|char
name|protoname
index|[
literal|10
index|]
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|sv
argument_list|,
name|sess
argument_list|,
name|IRPD_GETSERVICE_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|3
condition|)
block|{
comment|/* len includes NULL at end */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETSERVICE_ERROR
argument_list|,
literal|"GETSERVBYPORT port protocol"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|portnum
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETSERVICE_ERROR
argument_list|,
literal|"Invalid port"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
operator|>
sizeof|sizeof
name|protoname
operator|-
literal|1
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETSERVICE_ERROR
argument_list|,
literal|"Invalid protocol"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|portnum
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|portnum
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|strncpy
argument_list|(
name|protoname
argument_list|,
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|protoname
index|[
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|ALLDIGITS
argument_list|(
name|portnum
argument_list|)
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETSERVICE_ERROR
argument_list|,
literal|"Not a port number"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|short
name|port
decl_stmt|;
name|long
name|lval
decl_stmt|;
name|lval
operator|=
name|strtol
argument_list|(
name|portnum
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|port
operator|=
operator|(
name|short
operator|)
name|lval
expr_stmt|;
if|if
condition|(
operator|(
name|long
operator|)
name|port
operator|!=
name|lval
condition|)
block|{
comment|/* value was too big */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETSERVICE_ERROR
argument_list|,
literal|"Not a valid port"
argument_list|)
expr_stmt|;
goto|goto
name|untimely
goto|;
block|}
name|port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|sv
operator|=
name|getservbyport_p
argument_list|(
name|port
argument_list|,
name|protoname
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
name|send_servent
argument_list|(
name|sess
argument_list|,
name|sv
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|untimely
label|:
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getservent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		   const struct ctl_verb *verb, const char *rest,  *		   u_int respflags, void *respctx, void *uctx);  *	Handle the GETSERVENT verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_getservent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|servent
modifier|*
name|sv
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|sv
argument_list|,
name|sess
argument_list|,
name|IRPD_GETSERVICE_ERROR
argument_list|)
expr_stmt|;
name|sv
operator|=
name|getservent_p
argument_list|(
name|netdata
argument_list|)
expr_stmt|;
name|send_servent
argument_list|(
name|sess
argument_list|,
name|sv
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_setservent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		   const struct ctl_verb *verb, const char *rest,  *		   u_int respflags, void *respctx, void *uctx);  *	Handle the SETSERVENT verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_setservent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|sv
argument_list|,
name|sess
argument_list|,
name|IRPD_GETSERVICE_ERROR
argument_list|)
expr_stmt|;
name|setservent_p
argument_list|(
literal|1
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
comment|/* always stay open */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETSERVICE_SETOK
argument_list|,
literal|"ok"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * send_prent(struct ctl_sess *sess, struct protoent *pr);  *	Send the PR structure over the wire. If PR is NULL, then  *	the response "No such protocol" is sent instead.  */
end_comment

begin_function
specifier|static
name|void
name|send_prent
parameter_list|(
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
name|struct
name|protoent
modifier|*
name|pr
parameter_list|)
block|{
if|if
condition|(
name|pr
operator|==
name|NULL
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETPROTO_NONE
argument_list|,
literal|"No such protocol"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|response_buff
modifier|*
name|b
init|=
name|newbuffer
argument_list|(
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|irp_marshall_pr
argument_list|(
name|pr
argument_list|,
operator|&
name|b
operator|->
name|buff
argument_list|,
operator|&
name|b
operator|->
name|bufflen
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETPROTO_ERROR
argument_list|,
literal|"Internal error"
argument_list|)
expr_stmt|;
name|logger
argument_list|(
name|ctl_warning
argument_list|,
literal|"Cant marshall pr\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|strcat
argument_list|(
name|b
operator|->
name|buff
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|ctl_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETPROTO_OK
argument_list|,
literal|"Protocol found"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|response_done
argument_list|,
name|b
argument_list|,
name|b
operator|->
name|buff
argument_list|,
name|strlen
argument_list|(
name|b
operator|->
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getprotobyname(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		       const struct ctl_verb *verb, const char *rest,  *		       u_int respflags, void *respctx, void *uctx);  *	Handle the GETPROTOBYNAME verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_getprotobyname
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|struct
name|protoent
modifier|*
name|pr
decl_stmt|;
name|char
name|protoname
index|[
literal|64
index|]
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|pr
argument_list|,
name|sess
argument_list|,
name|IRPD_GETPROTO_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|2
condition|)
block|{
comment|/* len includes NULL at end */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETPROTO_ERROR
argument_list|,
literal|"GETPROTOBYNAME protocol"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|protoname
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETPROTO_ERROR
argument_list|,
literal|"Name too long"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|protoname
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|protoname
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pr
operator|=
name|getprotobyname_p
argument_list|(
name|protoname
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
name|send_prent
argument_list|(
name|sess
argument_list|,
name|pr
argument_list|)
expr_stmt|;
block|}
block|}
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getprotobynumber(struct ctl_sctx *ctx,  *			 struct ctl_sess *sess, const struct ctl_verb *verb,  *			 const char *rest, u_int respflags, void *respctx,  *			 void *uctx);  *	Handle the GETPROTOBYNUMBER verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_getprotobynumber
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|struct
name|protoent
modifier|*
name|pr
decl_stmt|;
name|char
name|protonum
index|[
literal|64
index|]
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|pr
argument_list|,
name|sess
argument_list|,
name|IRPD_GETPROTO_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|2
condition|)
block|{
comment|/* len includes NULL at end */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETPROTO_ERROR
argument_list|,
literal|"GETPROTOBYNUMBER protocol"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|>=
sizeof|sizeof
name|protonum
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETGROUP_ERROR
argument_list|,
literal|"Name too long"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|protonum
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|protonum
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|ALLDIGITS
argument_list|(
name|protonum
argument_list|)
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETPROTO_ERROR
argument_list|,
literal|"Not a protocol number"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|proto
decl_stmt|;
name|long
name|lval
decl_stmt|;
name|lval
operator|=
name|strtol
argument_list|(
name|protonum
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|proto
operator|=
operator|(
name|int
operator|)
name|lval
expr_stmt|;
if|if
condition|(
operator|(
name|long
operator|)
name|proto
operator|!=
name|lval
condition|)
block|{
comment|/* value was too big */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETPROTO_ERROR
argument_list|,
literal|"Not a valid proto"
argument_list|)
expr_stmt|;
goto|goto
name|untimely
goto|;
block|}
name|pr
operator|=
name|getprotobynumber_p
argument_list|(
name|proto
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
name|send_prent
argument_list|(
name|sess
argument_list|,
name|pr
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|untimely
label|:
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getprotoent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		    const struct ctl_verb *verb, const char *rest,  *		    u_int respflags, void *respctx, void *uctx);  *	Handle the GETPROTOENT verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_getprotoent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|protoent
modifier|*
name|pr
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|pr
argument_list|,
name|sess
argument_list|,
name|IRPD_GETPROTO_ERROR
argument_list|)
expr_stmt|;
name|pr
operator|=
name|getprotoent_p
argument_list|(
name|netdata
argument_list|)
expr_stmt|;
name|send_prent
argument_list|(
name|sess
argument_list|,
name|pr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_setprotoent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		    const struct ctl_verb *verb, const char *rest,  *		    u_int respflags, void *respctx, void *uctx);  *	Handle the SETPROTOENT verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_setprotoent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|pr
argument_list|,
name|sess
argument_list|,
name|IRPD_GETPROTO_ERROR
argument_list|)
expr_stmt|;
name|setprotoent_p
argument_list|(
literal|1
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
comment|/* always stay open */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETPROTO_SETOK
argument_list|,
literal|"ok"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * send_pwent(struct ctl_sess *sess, struct passwd *pw);  *	Send PW over the wire, or, if PW is NULL, a "No such  *	user" response.  */
end_comment

begin_function
specifier|static
name|void
name|send_ngent
parameter_list|(
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
name|char
modifier|*
name|host
parameter_list|,
name|char
modifier|*
name|user
parameter_list|,
name|char
modifier|*
name|domain
parameter_list|)
block|{
name|struct
name|response_buff
modifier|*
name|b
init|=
name|newbuffer
argument_list|(
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|irp_marshall_ng
argument_list|(
name|host
argument_list|,
name|user
argument_list|,
name|domain
argument_list|,
operator|&
name|b
operator|->
name|buff
argument_list|,
operator|&
name|b
operator|->
name|bufflen
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNETGR_ERROR
argument_list|,
literal|"Internal error"
argument_list|)
expr_stmt|;
name|logger
argument_list|(
name|ctl_warning
argument_list|,
literal|"Cant marshall ng\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|strcat
argument_list|(
name|b
operator|->
name|buff
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|ctl_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNETGR_OK
argument_list|,
literal|"Netgroup entry"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|response_done
argument_list|,
name|b
argument_list|,
name|b
operator|->
name|buff
argument_list|,
name|strlen
argument_list|(
name|b
operator|->
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_getnetgrent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		    const struct ctl_verb *verb, const char *rest,  *		    u_int respflags, void *respctx, void *uctx);  *	Handle the GETNETGRENT verb.   */
end_comment

begin_function
specifier|static
name|void
name|irpd_getnetgrent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|ng
argument_list|,
name|sess
argument_list|,
name|IRPD_GETNETGR_ERROR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rest
operator|!=
name|NULL
operator|&&
name|strlen
argument_list|(
name|rest
argument_list|)
operator|>
literal|0
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNETGR_ERROR
argument_list|,
literal|"GETNETGRENT"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|host
decl_stmt|,
modifier|*
name|user
decl_stmt|,
modifier|*
name|domain
decl_stmt|;
if|if
condition|(
name|getnetgrent_p
argument_list|(
operator|&
name|host
argument_list|,
operator|&
name|user
argument_list|,
operator|&
name|domain
argument_list|,
name|netdata
argument_list|)
operator|==
literal|1
condition|)
block|{
name|send_ngent
argument_list|(
name|sess
argument_list|,
name|host
argument_list|,
name|user
argument_list|,
name|domain
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNETGR_NOMORE
argument_list|,
literal|"No more"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_innetgr(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		const struct ctl_verb *verb, const char *rest,  *		u_int respflags, void *respctx, void *uctx);  *	Handle the INNETGR verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_innetgr
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|char
modifier|*
name|host
decl_stmt|;
name|char
modifier|*
name|user
decl_stmt|;
name|char
modifier|*
name|domain
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|ng
argument_list|,
name|sess
argument_list|,
name|IRPD_GETNETGR_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|3
condition|)
block|{
comment|/* len includes NULL at end */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNETGR_ERROR
argument_list|,
literal|"INNETGR netgroup ngentry"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|grptmp
init|=
name|memget
argument_list|(
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|+
literal|1
argument_list|)
decl_stmt|;
name|char
modifier|*
name|ngtmp
init|=
name|memget
argument_list|(
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
operator|+
literal|1
argument_list|)
decl_stmt|;
name|strncpy
argument_list|(
name|grptmp
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ngtmp
argument_list|,
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_base
argument_list|,
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|grptmp
index|[
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|ngtmp
index|[
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|irp_unmarshall_ng
argument_list|(
operator|&
name|host
argument_list|,
operator|&
name|user
argument_list|,
operator|&
name|domain
argument_list|,
name|ngtmp
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNETGR_ERROR
argument_list|,
literal|"ngentry must be (host,user,domain)"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|innetgr_p
argument_list|(
name|grptmp
argument_list|,
name|host
argument_list|,
name|user
argument_list|,
name|domain
argument_list|,
name|netdata
argument_list|)
operator|==
literal|1
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNETGR_MATCHES
argument_list|,
literal|"INNETGR matches"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNETGR_NOMATCH
argument_list|,
literal|"INNETGR does not match"
argument_list|)
expr_stmt|;
block|}
block|}
name|memput
argument_list|(
name|grptmp
argument_list|,
name|args
operator|->
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memput
argument_list|(
name|ngtmp
argument_list|,
name|args
operator|->
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_setnetgrent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		    const struct ctl_verb *verb, const char *rest,  *		    u_int respflags, void *respctx, void *uctx);  *	Handle the SETNETGRENT verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_setnetgrent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|arg_s
modifier|*
name|args
decl_stmt|;
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|ng
argument_list|,
name|sess
argument_list|,
name|IRPD_GETNETGR_ERROR
argument_list|)
expr_stmt|;
name|args
operator|=
name|split_string
argument_list|(
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|->
name|iovlen
operator|!=
literal|2
condition|)
block|{
comment|/* len includes NULL at end */
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNETGR_ERROR
argument_list|,
literal|"setnetgrent netgroup"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|setnetgrent_p
argument_list|(
name|rest
argument_list|,
name|netdata
argument_list|)
expr_stmt|;
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNETGR_SETOK
argument_list|,
literal|"setnetgrent ok"
argument_list|)
expr_stmt|;
block|}
name|free_args
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_endnetgrent(struct ctl_sctx *ctx, struct ctl_sess *sess,  *		    const struct ctl_verb *verb, const char *rest,  *		    u_int respflags, void *respctx, void *uctx);  *	Handle the ENDNETGRENT verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_endnetgrent
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|netdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ND_INIT
argument_list|(
name|netdata
argument_list|,
name|ng
argument_list|,
name|sess
argument_list|,
name|IRPD_GETNETGR_ERROR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rest
operator|!=
name|NULL
operator|&&
name|strlen
argument_list|(
name|rest
argument_list|)
operator|>
literal|0
condition|)
block|{
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNETGR_ERROR
argument_list|,
literal|"endnetgrent netgroup"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|endnetgrent_p
argument_list|(
name|netdata
argument_list|)
expr_stmt|;
name|simple_response
argument_list|(
name|sess
argument_list|,
name|IRPD_GETNETGR_SETOK
argument_list|,
literal|"endnetgrent ok"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_quit(struct ctl_sctx *ctx, struct ctl_sess *sess,  *	     const struct ctl_verb *verb, const char *rest,  *	     u_int respflags, void *respctx, void *uctx);  *	Handle the QUIT verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_quit
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|ctl_response
argument_list|(
name|sess
argument_list|,
name|irpd_quit_ok
argument_list|,
literal|"See ya!"
argument_list|,
name|CTL_EXIT
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_help(struct ctl_sctx *ctx, struct ctl_sess *sess,  *	     const struct ctl_verb *verb, const char *rest,  *	     u_int respflags, void *respctx, void *uctx);  *	Handle the HELP verb.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_help
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
comment|/* XXX	should make this do something better (like include required 	 *	arguments. 	 */
name|ctl_sendhelp
argument_list|(
name|sess
argument_list|,
literal|231
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_accept(struct ctl_sctx *ctx, struct ctl_sess *sess,  *	       const struct ctl_verb *verb, const char *rest,  *	       u_int respflags, void *respctx, void *uctx);  *	Handle a new connection.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_accept
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|sockaddr
modifier|*
name|sa
init|=
name|respctx
decl_stmt|;
name|char
name|raddr
index|[
sizeof|sizeof
expr|"ffff:ffff:ffff:ffff:ffff:ffff:255.255.255.255"]
expr_stmt|;
name|int
name|reject
init|=
literal|1
decl_stmt|;
name|int
name|response
decl_stmt|;
name|char
modifier|*
name|respmsg
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_UNIX
condition|)
block|{
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"New AF_UNIX connection"
argument_list|)
expr_stmt|;
name|reject
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|struct
name|sockaddr_in
modifier|*
name|sin
init|=
name|respctx
decl_stmt|;
specifier|static
name|long
name|localhost
decl_stmt|;
specifier|static
name|long
name|zero
decl_stmt|;
if|if
condition|(
name|localhost
operator|==
literal|0
condition|)
block|{
comment|/* yes, this could be done with simple arithmetic... */
name|inet_pton
argument_list|(
name|AF_INET
argument_list|,
literal|"127.0.0.1"
argument_list|,
operator|&
name|localhost
argument_list|)
expr_stmt|;
block|}
name|inet_ntop
argument_list|(
name|AF_INET
argument_list|,
operator|&
name|sin
operator|->
name|sin_addr
argument_list|,
name|raddr
argument_list|,
sizeof|sizeof
name|raddr
argument_list|)
expr_stmt|;
comment|/* we reject INET connections that are not from the local 		 * machine. 		 */
if|if
condition|(
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|==
name|zero
operator|||
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|==
name|localhost
condition|)
block|{
name|reject
operator|=
literal|0
expr_stmt|;
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"New connection from %s"
argument_list|,
name|raddr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"New connection from %s (reject)"
argument_list|,
name|raddr
argument_list|)
expr_stmt|;
name|respmsg
operator|=
literal|"Connections from off host not permitted"
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
comment|/* XXX should do something intelligent here. */
name|respmsg
operator|=
literal|"IPv6 connections not implemented yet."
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Cannot handle AF_INET6 connections yet"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Unknown peer type: %d"
argument_list|,
name|sa
operator|->
name|sa_family
argument_list|)
expr_stmt|;
name|respmsg
operator|=
literal|"What are you???"
expr_stmt|;
block|}
if|if
condition|(
name|reject
condition|)
block|{
name|response
operator|=
name|IRPD_NOT_WELCOME_CODE
expr_stmt|;
if|if
condition|(
name|respmsg
operator|==
name|NULL
condition|)
block|{
name|respmsg
operator|=
literal|"Go away!"
expr_stmt|;
block|}
comment|/* XXX can we be sure that stacked up commands will not be 		 * processed before the control connection is closed??? 		 */
block|}
else|else
block|{
name|void
modifier|*
name|ctx
init|=
name|make_cli_ctx
argument_list|()
decl_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|response
operator|=
name|IRPD_NOT_WELCOME_CODE
expr_stmt|;
name|respmsg
operator|=
literal|"Internal error (client context)"
expr_stmt|;
block|}
else|else
block|{
name|response
operator|=
name|IRPD_WELCOME_CODE
expr_stmt|;
if|if
condition|(
name|respmsg
operator|==
name|NULL
condition|)
block|{
name|respmsg
operator|=
literal|"Welcome to IRPD (v 1)"
expr_stmt|;
block|}
name|ctl_setcsctx
argument_list|(
name|sess
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
block|}
block|}
name|ctl_response
argument_list|(
name|sess
argument_list|,
name|response
argument_list|,
name|respmsg
argument_list|,
operator|(
name|reject
condition|?
name|CTL_EXIT
else|:
literal|0
operator|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * irpd_abort(struct ctl_sctx *ctx, struct ctl_sess *sess,  *	      const struct ctl_verb *verb, const char *rest,  *	      u_int respflags, void *respctx, void *uctx);  *	Handle a dropped connection.  */
end_comment

begin_function
specifier|static
name|void
name|irpd_abort
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
specifier|const
name|struct
name|ctl_verb
modifier|*
name|verb
parameter_list|,
specifier|const
name|char
modifier|*
name|rest
parameter_list|,
name|u_int
name|respflags
parameter_list|,
name|void
modifier|*
name|respctx
parameter_list|,
name|void
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|net_data
modifier|*
name|netdata
init|=
name|get_net_data
argument_list|(
name|sess
argument_list|)
decl_stmt|;
if|if
condition|(
name|netdata
operator|!=
name|NULL
condition|)
name|net_data_destroy
argument_list|(
name|netdata
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * void  * response_done(struct ctl_sctx *ctx, struct ctl_sess *sess, void *uap)  *	UAP is the response_buffer passed through to  *	ctl_response.  */
end_comment

begin_function
specifier|static
name|void
name|response_done
parameter_list|(
name|struct
name|ctl_sctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|,
name|void
modifier|*
name|uap
parameter_list|)
block|{
name|release_buffer
argument_list|(
name|uap
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static void  * logger(enum ctl_severity sev, const char *fmt, ...);  *	Logging routine called by the ctl_* functions. For now we  *	just spit everything to stderr.  */
end_comment

begin_function
specifier|static
name|void
name|logger
parameter_list|(
name|enum
name|ctl_severity
name|sev
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|1024
index|]
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
name|int
name|level
decl_stmt|;
if|if
condition|(
name|sev
operator|==
name|ctl_debug
condition|)
return|return;
if|if
condition|(
name|sev
operator|==
name|ctl_warning
condition|)
name|level
operator|=
name|LOG_WARNING
expr_stmt|;
elseif|else
if|if
condition|(
name|sev
operator|==
name|ctl_error
condition|)
name|level
operator|=
name|LOG_ERR
expr_stmt|;
else|else
block|{
name|syslog
argument_list|(
name|LOG_CRIT
argument_list|,
literal|"Invalid severity: %d"
argument_list|,
operator|(
name|int
operator|)
name|sev
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|fprintf(stderr, "irpd: "); 	vfprintf(stderr, fmt, ap);
else|#
directive|else
if|if
condition|(
name|vsprintf
argument_list|(
name|buffer
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
operator|>
operator|(
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
operator|-
literal|1
operator|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_CRIT
argument_list|,
literal|"Buffer overrun in logger"
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
name|syslog
argument_list|(
name|level
argument_list|,
literal|"%s"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static struct response_buff *  * newbuffer(u_int length);  *	Create a structure to hold an allocated buffer. We do  *	this so we can get the size to deallocate later.  * Returns:  *	Pointer to the structure  */
end_comment

begin_function
specifier|static
name|struct
name|response_buff
modifier|*
name|newbuffer
parameter_list|(
name|u_int
name|length
parameter_list|)
block|{
name|struct
name|response_buff
modifier|*
name|h
decl_stmt|;
name|h
operator|=
name|memget
argument_list|(
sizeof|sizeof
expr|*
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|h
operator|->
name|buff
operator|=
name|NULL
expr_stmt|;
name|h
operator|->
name|bufflen
operator|=
name|length
expr_stmt|;
if|if
condition|(
name|length
operator|>
literal|0
condition|)
block|{
name|h
operator|->
name|buff
operator|=
name|memget
argument_list|(
name|h
operator|->
name|bufflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|->
name|buff
operator|==
name|NULL
condition|)
block|{
name|memput
argument_list|(
name|h
argument_list|,
sizeof|sizeof
expr|*
name|h
argument_list|)
expr_stmt|;
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|memset
argument_list|(
name|h
operator|->
name|buff
argument_list|,
literal|0
argument_list|,
name|h
operator|->
name|bufflen
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|h
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * static void  * release_buffer(struct response_buff *b);  *	Free up a buffer allocated with newbuffer.  */
end_comment

begin_function
specifier|static
name|void
name|release_buffer
parameter_list|(
name|struct
name|response_buff
modifier|*
name|b
parameter_list|)
block|{
name|memset
argument_list|(
name|b
operator|->
name|buff
argument_list|,
literal|0
argument_list|,
name|b
operator|->
name|bufflen
argument_list|)
expr_stmt|;
name|memput
argument_list|(
name|b
operator|->
name|buff
argument_list|,
name|b
operator|->
name|bufflen
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|b
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|b
argument_list|)
expr_stmt|;
name|memput
argument_list|(
name|b
argument_list|,
sizeof|sizeof
expr|*
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * static struct arg_s *  * split_string(const char *string);  *	Create an array of iovecs(last one having NULL fields)  *	pointing into STRING at the non-whitespace sections. The  *	iovecs are stashed inside a structure so we can get the  *	size back later at deallocation time. Iovecs are used to avoid  *	modifying the argument with added nulls.  * Returns:  *	Pointer to the wrapper structure. Must be given to free_args()  *	when done  */
end_comment

begin_function
specifier|static
name|struct
name|arg_s
modifier|*
name|split_string
parameter_list|(
specifier|const
name|char
modifier|*
name|string
parameter_list|)
block|{
name|struct
name|iovec
modifier|*
name|iovs
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|,
name|c
decl_stmt|,
name|iswh
decl_stmt|;
name|struct
name|arg_s
modifier|*
name|a
decl_stmt|;
comment|/* count + 1 of the number of runs of non-whitespace. */
for|for
control|(
name|iswh
operator|=
literal|1
operator|,
name|i
operator|=
literal|1
operator|,
name|p
operator|=
name|string
init|;
name|p
operator|!=
name|NULL
operator|&&
operator|*
name|p
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
name|iswh
operator|&&
operator|!
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
block|{
name|iswh
operator|=
literal|0
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|iswh
operator|&&
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
block|{
name|iswh
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|iovs
operator|=
name|memget
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|iovec
argument_list|)
operator|*
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|iovs
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|a
operator|=
name|memget
argument_list|(
sizeof|sizeof
expr|*
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
name|memput
argument_list|(
name|iovs
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|iovec
argument_list|)
operator|*
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|a
operator|->
name|iov
operator|=
name|iovs
expr_stmt|;
name|a
operator|->
name|iovlen
operator|=
name|i
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
operator|,
name|p
operator|=
name|string
init|;
name|p
operator|!=
name|NULL
operator|&&
operator|*
name|p
condition|;
name|c
operator|++
control|)
block|{
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
block|{
name|p
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p
operator|==
literal|'\0'
condition|)
break|break;
name|iovs
index|[
name|c
index|]
operator|.
name|iov_base
operator|=
operator|(
name|void
operator|*
operator|)
name|p
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|&&
operator|!
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
block|{
name|p
operator|++
expr_stmt|;
block|}
name|iovs
index|[
name|c
index|]
operator|.
name|iov_len
operator|=
name|p
operator|-
operator|(
name|char
operator|*
operator|)
name|iovs
index|[
name|c
index|]
operator|.
name|iov_base
expr_stmt|;
block|}
name|INSIST
argument_list|(
name|c
operator|==
name|i
operator|-
literal|1
argument_list|)
expr_stmt|;
name|iovs
index|[
name|c
index|]
operator|.
name|iov_base
operator|=
name|NULL
expr_stmt|;
name|iovs
index|[
name|c
index|]
operator|.
name|iov_len
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|a
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * static void  * free_args(struct arg_s *args);  *	Free up the argument structure created with  *	split_string().  */
end_comment

begin_function
specifier|static
name|void
name|free_args
parameter_list|(
name|struct
name|arg_s
modifier|*
name|args
parameter_list|)
block|{
name|memput
argument_list|(
name|args
operator|->
name|iov
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|iovec
argument_list|)
operator|*
name|args
operator|->
name|iovlen
argument_list|)
expr_stmt|;
name|memput
argument_list|(
name|args
argument_list|,
sizeof|sizeof
expr|*
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|client_ctx
modifier|*
name|make_cli_ctx
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|client_ctx
modifier|*
name|p
init|=
name|memget
argument_list|(
sizeof|sizeof
expr|*
name|p
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|p
operator|->
name|net_data
operator|=
name|net_data_create
argument_list|(
name|conffile
argument_list|)
expr_stmt|;
return|return
operator|(
name|p
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|net_data
modifier|*
name|get_net_data
parameter_list|(
name|struct
name|ctl_sess
modifier|*
name|sess
parameter_list|)
block|{
name|struct
name|client_ctx
modifier|*
name|ctx
init|=
name|ctl_getcsctx
argument_list|(
name|sess
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|ctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ctx
operator|->
name|net_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ctx
operator|->
name|net_data
operator|)
return|;
block|}
end_function

end_unit


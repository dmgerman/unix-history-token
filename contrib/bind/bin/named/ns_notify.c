begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|SABER
argument_list|)
end_if

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$Id: ns_notify.c,v 8.10 2000/04/21 06:54:09 vixie Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_comment
comment|/*  * Copyright (c) 1994-2000 by Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND INTERNET SOFTWARE CONSORTIUM DISCLAIMS  * ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL INTERNET SOFTWARE  * CONSORTIUM BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL  * DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR  * PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS  * ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS  * SOFTWARE.  */
end_comment

begin_comment
comment|/* Import. */
end_comment

begin_include
include|#
directive|include
file|"port_before.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/nameser.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<resolv.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<isc/eventlib.h>
end_include

begin_include
include|#
directive|include
file|<isc/logging.h>
end_include

begin_include
include|#
directive|include
file|<isc/memcluster.h>
end_include

begin_include
include|#
directive|include
file|<isc/dst.h>
end_include

begin_include
include|#
directive|include
file|"port_after.h"
end_include

begin_include
include|#
directive|include
file|"named.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|BIND_NOTIFY
end_ifdef

begin_comment
comment|/* Types. */
end_comment

begin_struct
struct|struct
name|notify
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|ns_class
name|class
decl_stmt|;
name|ns_type
name|type
decl_stmt|;
name|evTimerID
name|timer
decl_stmt|;
name|LINK
argument_list|(
argument|struct notify
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Forward. */
end_comment

begin_function_decl
specifier|static
name|void
name|sysnotify
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|ns_class
parameter_list|,
name|ns_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sysnotify_slaves
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|ns_class
parameter_list|,
name|ns_type
parameter_list|,
name|int
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sysnotify_ns
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|ns_class
parameter_list|,
name|ns_type
parameter_list|,
name|int
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|free_notify
parameter_list|(
name|struct
name|notify
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|notify_timer
parameter_list|(
name|evContext
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|timespec
parameter_list|,
name|struct
name|timespec
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Local. */
end_comment

begin_expr_stmt
specifier|static
name|LIST
argument_list|(
argument|struct notify
argument_list|)
name|pending_notifies
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|LIST
argument_list|(
argument|struct notify
argument_list|)
name|loading_notifies
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Public. */
end_comment

begin_comment
comment|/*  * ns_notify(dname, class, type)  *	call this when a zone has changed and its slaves need to know.  */
end_comment

begin_function
name|void
name|ns_notify
parameter_list|(
specifier|const
name|char
modifier|*
name|dname
parameter_list|,
name|ns_class
name|class
parameter_list|,
name|ns_type
name|type
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|no_room
index|[]
init|=
literal|"%s failed, cannot notify for zone %s"
decl_stmt|;
name|int
name|delay
decl_stmt|,
name|max_delay
decl_stmt|;
name|struct
name|zoneinfo
modifier|*
name|zp
decl_stmt|;
name|struct
name|notify
modifier|*
name|ni
decl_stmt|;
name|zp
operator|=
name|find_auth_zone
argument_list|(
name|dname
argument_list|,
name|class
argument_list|)
expr_stmt|;
if|if
condition|(
name|zp
operator|==
name|NULL
condition|)
block|{
name|ns_warning
argument_list|(
name|ns_log_notify
argument_list|,
literal|"no zone found for notify (\"%s\" %s %s)"
argument_list|,
operator|(
name|dname
operator|&&
operator|*
name|dname
operator|)
condition|?
name|dname
else|:
literal|"."
argument_list|,
name|p_class
argument_list|(
name|class
argument_list|)
argument_list|,
name|p_type
argument_list|(
name|type
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ns_samename
argument_list|(
name|dname
argument_list|,
name|zp
operator|->
name|z_origin
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|ns_warning
argument_list|(
name|ns_log_notify
argument_list|,
literal|"notify not called with top of zone (\"%s\" %s %s)"
argument_list|,
operator|(
name|dname
operator|&&
operator|*
name|dname
operator|)
condition|?
name|dname
else|:
literal|"."
argument_list|,
name|p_class
argument_list|(
name|class
argument_list|)
argument_list|,
name|p_type
argument_list|(
name|type
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|zp
operator|->
name|z_flags
operator|&
name|Z_NOTIFY
operator|)
operator|!=
literal|0
condition|)
block|{
name|ns_info
argument_list|(
name|ns_log_notify
argument_list|,
literal|"suppressing duplicate notify (\"%s\" %s %s)"
argument_list|,
operator|(
name|dname
operator|&&
operator|*
name|dname
operator|)
condition|?
name|dname
else|:
literal|"."
argument_list|,
name|p_class
argument_list|(
name|class
argument_list|)
argument_list|,
name|p_type
argument_list|(
name|type
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ni
operator|=
name|memget
argument_list|(
sizeof|sizeof
expr|*
name|ni
argument_list|)
expr_stmt|;
if|if
condition|(
name|ni
operator|==
name|NULL
condition|)
block|{
name|ns_info
argument_list|(
name|ns_log_notify
argument_list|,
name|no_room
argument_list|,
literal|"memget"
argument_list|,
name|dname
argument_list|)
expr_stmt|;
return|return;
block|}
name|ni
operator|->
name|name
operator|=
name|savestr
argument_list|(
name|dname
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ni
operator|->
name|name
operator|==
name|NULL
condition|)
block|{
name|memput
argument_list|(
name|ni
argument_list|,
sizeof|sizeof
expr|*
name|ni
argument_list|)
expr_stmt|;
name|ni
operator|=
name|NULL
expr_stmt|;
name|ns_info
argument_list|(
name|ns_log_notify
argument_list|,
name|no_room
argument_list|,
literal|"memget"
argument_list|,
name|dname
argument_list|)
expr_stmt|;
return|return;
block|}
name|ni
operator|->
name|class
operator|=
name|class
expr_stmt|;
name|ni
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|evInitID
argument_list|(
operator|&
name|ni
operator|->
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|loading
operator|!=
literal|0
condition|)
block|{
name|APPEND
argument_list|(
name|loading_notifies
argument_list|,
name|ni
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Delay notification for from five seconds up to fifteen minutes. */
name|max_delay
operator|=
name|MIN
argument_list|(
name|nzones
operator|/
literal|5
argument_list|,
literal|895
argument_list|)
expr_stmt|;
name|max_delay
operator|=
name|MAX
argument_list|(
name|max_delay
argument_list|,
literal|25
argument_list|)
expr_stmt|;
name|delay
operator|=
literal|5
operator|+
operator|(
name|rand
argument_list|()
operator|%
name|max_delay
operator|)
expr_stmt|;
if|if
condition|(
name|evSetTimer
argument_list|(
name|ev
argument_list|,
name|notify_timer
argument_list|,
name|ni
argument_list|,
name|evAddTime
argument_list|(
name|evNowTime
argument_list|()
argument_list|,
name|evConsTime
argument_list|(
name|delay
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|,
name|evConsTime
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|ni
operator|->
name|timer
argument_list|)
operator|<
literal|0
condition|)
block|{
name|ns_error
argument_list|(
name|ns_log_notify
argument_list|,
literal|"evSetTimer() failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|freestr
argument_list|(
name|ni
operator|->
name|name
argument_list|)
expr_stmt|;
name|memput
argument_list|(
name|ni
argument_list|,
sizeof|sizeof
expr|*
name|ni
argument_list|)
expr_stmt|;
return|return;
block|}
name|zp
operator|->
name|z_flags
operator||=
name|Z_NOTIFY
expr_stmt|;
name|APPEND
argument_list|(
name|pending_notifies
argument_list|,
name|ni
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ns_debug
argument_list|(
name|ns_log_notify
argument_list|,
literal|3
argument_list|,
literal|"ns_notify(%s, %s, %s): ni %p, zp %p, delay %d"
argument_list|,
operator|(
name|dname
operator|&&
operator|*
name|dname
operator|)
condition|?
name|dname
else|:
literal|"."
argument_list|,
name|p_class
argument_list|(
name|class
argument_list|)
argument_list|,
name|p_type
argument_list|(
name|type
argument_list|)
argument_list|,
name|ni
argument_list|,
name|zp
argument_list|,
name|delay
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|notify_afterload
parameter_list|()
block|{
name|struct
name|notify
modifier|*
name|ni
decl_stmt|;
name|INSIST
argument_list|(
name|loading
operator|==
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ni
operator|=
name|HEAD
argument_list|(
name|loading_notifies
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|UNLINK
argument_list|(
name|loading_notifies
argument_list|,
name|ni
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ns_notify
argument_list|(
name|ni
operator|->
name|name
argument_list|,
name|ni
operator|->
name|class
argument_list|,
name|ni
operator|->
name|type
argument_list|)
expr_stmt|;
name|freestr
argument_list|(
name|ni
operator|->
name|name
argument_list|)
expr_stmt|;
name|memput
argument_list|(
name|ni
argument_list|,
sizeof|sizeof
expr|*
name|ni
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * ns_unnotify()  *	call this when all pending notifies are now considered junque.  */
end_comment

begin_function
name|void
name|ns_unnotify
parameter_list|(
name|void
parameter_list|)
block|{
while|while
condition|(
operator|!
name|EMPTY
argument_list|(
name|pending_notifies
argument_list|)
condition|)
block|{
name|struct
name|notify
modifier|*
name|ni
init|=
name|HEAD
argument_list|(
name|pending_notifies
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|LINKED
argument_list|(
name|ni
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
name|UNLINK
argument_list|(
name|pending_notifies
argument_list|,
name|ni
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free_notify
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * ns_stopnotify(const char *dname, ns_class class)  *	stop notifies for this particular zone.  */
end_comment

begin_function
name|void
name|ns_stopnotify
parameter_list|(
specifier|const
name|char
modifier|*
name|dname
parameter_list|,
name|ns_class
name|class
parameter_list|)
block|{
name|struct
name|notify
modifier|*
name|ni
decl_stmt|;
name|ni
operator|=
name|HEAD
argument_list|(
name|pending_notifies
argument_list|)
expr_stmt|;
while|while
condition|(
name|ni
operator|!=
name|NULL
operator|&&
operator|(
name|ni
operator|->
name|class
operator|!=
name|class
operator|||
name|ns_samename
argument_list|(
name|ni
operator|->
name|name
argument_list|,
name|dname
argument_list|)
operator|!=
literal|1
operator|)
condition|)
name|ni
operator|=
name|NEXT
argument_list|(
name|ni
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|ni
operator|!=
name|NULL
condition|)
block|{
name|UNLINK
argument_list|(
name|pending_notifies
argument_list|,
name|ni
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free_notify
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Private. */
end_comment

begin_comment
comment|/*  * sysnotify(dname, class, type)  *	cause a NOTIFY request to be sysquery()'d to each slave server  *	of the zone that "dname" is within.  */
end_comment

begin_function
specifier|static
name|void
name|sysnotify
parameter_list|(
specifier|const
name|char
modifier|*
name|dname
parameter_list|,
name|ns_class
name|class
parameter_list|,
name|ns_type
name|type
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|zname
decl_stmt|,
modifier|*
name|fname
decl_stmt|;
name|u_int32_t
name|zserial
decl_stmt|;
name|int
name|nns
decl_stmt|,
name|na
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|zoneinfo
modifier|*
name|zp
decl_stmt|;
name|struct
name|in_addr
modifier|*
name|also_addr
decl_stmt|;
name|ns_debug
argument_list|(
name|ns_log_notify
argument_list|,
literal|3
argument_list|,
literal|"sysnotify(%s, %s, %s)"
argument_list|,
name|dname
argument_list|,
name|p_class
argument_list|(
name|class
argument_list|)
argument_list|,
name|p_type
argument_list|(
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|zp
operator|=
name|find_auth_zone
argument_list|(
name|dname
argument_list|,
name|class
argument_list|)
expr_stmt|;
if|if
condition|(
name|zp
operator|==
name|NULL
condition|)
block|{
name|ns_warning
argument_list|(
name|ns_log_notify
argument_list|,
literal|"sysnotify: can't find \"%s\" (%s)"
argument_list|,
name|dname
argument_list|,
name|p_class
argument_list|(
name|class
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ns_samename
argument_list|(
name|dname
argument_list|,
name|zp
operator|->
name|z_origin
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|ns_warning
argument_list|(
name|ns_log_notify
argument_list|,
literal|"sysnotify: not auth for zone %s"
argument_list|,
name|dname
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|zp
operator|->
name|z_notify
operator|==
name|znotify_no
operator|||
operator|(
name|zp
operator|->
name|z_notify
operator|==
name|znotify_use_default
operator|&&
name|NS_OPTION_P
argument_list|(
name|OPTION_NONOTIFY
argument_list|)
operator|)
condition|)
return|return;
if|if
condition|(
name|zp
operator|->
name|z_type
operator|!=
name|z_master
operator|&&
name|zp
operator|->
name|z_type
operator|!=
name|z_slave
condition|)
block|{
name|ns_warning
argument_list|(
name|ns_log_notify
argument_list|,
literal|"sysnotify: %s not master or slave"
argument_list|,
name|dname
argument_list|)
expr_stmt|;
return|return;
block|}
name|zname
operator|=
name|zp
operator|->
name|z_origin
expr_stmt|;
name|zserial
operator|=
name|zp
operator|->
name|z_serial
expr_stmt|;
name|nns
operator|=
name|na
operator|=
literal|0
expr_stmt|;
name|sysnotify_slaves
argument_list|(
name|dname
argument_list|,
name|zname
argument_list|,
name|class
argument_list|,
name|type
argument_list|,
name|zp
operator|-
name|zones
argument_list|,
operator|&
name|nns
argument_list|,
operator|&
name|na
argument_list|)
expr_stmt|;
comment|/* 	 * Handle any global or zone-specific also-notify clauses 	 */
if|if
condition|(
name|zp
operator|->
name|z_notify_count
operator|!=
literal|0
condition|)
block|{
comment|/* zone-specific also notify */
name|ns_debug
argument_list|(
name|ns_log_notify
argument_list|,
literal|3
argument_list|,
literal|"zone notify ns = %d"
argument_list|,
name|zp
operator|->
name|z_notify_count
argument_list|)
expr_stmt|;
name|also_addr
operator|=
name|zp
operator|->
name|z_also_notify
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|zp
operator|->
name|z_notify_count
condition|;
name|i
operator|++
control|)
block|{
name|ns_debug
argument_list|(
name|ns_log_notify
argument_list|,
literal|4
argument_list|,
literal|"notifying %s"
argument_list|,
name|inet_ntoa
argument_list|(
operator|*
name|also_addr
argument_list|)
argument_list|)
expr_stmt|;
name|sysquery
argument_list|(
name|dname
argument_list|,
name|class
argument_list|,
name|type
argument_list|,
name|also_addr
argument_list|,
literal|1
argument_list|,
name|ns_port
argument_list|,
name|NS_NOTIFY_OP
argument_list|)
expr_stmt|;
name|also_addr
operator|++
expr_stmt|;
block|}
name|nns
operator|+=
name|zp
operator|->
name|z_notify_count
expr_stmt|;
name|na
operator|+=
name|zp
operator|->
name|z_notify_count
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|server_options
operator|->
name|notify_count
operator|!=
literal|0
condition|)
block|{
name|ns_debug
argument_list|(
name|ns_log_notify
argument_list|,
literal|4
argument_list|,
literal|"global notify ns = %d"
argument_list|,
name|server_options
operator|->
name|notify_count
argument_list|)
expr_stmt|;
name|also_addr
operator|=
name|server_options
operator|->
name|also_notify
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|server_options
operator|->
name|notify_count
condition|;
name|i
operator|++
control|)
block|{
name|ns_debug
argument_list|(
name|ns_log_notify
argument_list|,
literal|3
argument_list|,
literal|"notifying %s"
argument_list|,
name|inet_ntoa
argument_list|(
operator|*
name|also_addr
argument_list|)
argument_list|)
expr_stmt|;
name|sysquery
argument_list|(
name|dname
argument_list|,
name|class
argument_list|,
name|type
argument_list|,
name|also_addr
argument_list|,
literal|1
argument_list|,
name|ns_port
argument_list|,
name|ns_o_notify
argument_list|)
expr_stmt|;
name|also_addr
operator|++
expr_stmt|;
block|}
name|nns
operator|+=
name|server_options
operator|->
name|notify_count
expr_stmt|;
name|na
operator|+=
name|server_options
operator|->
name|notify_count
expr_stmt|;
block|}
if|if
condition|(
name|nns
operator|!=
literal|0
operator|||
name|na
operator|!=
literal|0
condition|)
name|ns_info
argument_list|(
name|ns_log_notify
argument_list|,
literal|"Sent NOTIFY for \"%s %s %s %u\" (%s); %d NS, %d A"
argument_list|,
name|dname
argument_list|,
name|p_class
argument_list|(
name|class
argument_list|)
argument_list|,
name|p_type
argument_list|(
name|type
argument_list|)
argument_list|,
name|zserial
argument_list|,
name|zname
argument_list|,
name|nns
argument_list|,
name|na
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sysnotify_slaves
parameter_list|(
specifier|const
name|char
modifier|*
name|dname
parameter_list|,
specifier|const
name|char
modifier|*
name|zname
parameter_list|,
name|ns_class
name|class
parameter_list|,
name|ns_type
name|type
parameter_list|,
name|int
name|zn
parameter_list|,
name|int
modifier|*
name|nns
parameter_list|,
name|int
modifier|*
name|na
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|mname
decl_stmt|,
modifier|*
name|fname
decl_stmt|;
name|struct
name|hashbuf
modifier|*
name|htp
decl_stmt|;
name|struct
name|namebuf
modifier|*
name|np
decl_stmt|;
name|struct
name|databuf
modifier|*
name|dp
decl_stmt|;
comment|/* 	 * Master. 	 */
name|htp
operator|=
name|hashtab
expr_stmt|;
name|np
operator|=
name|nlookup
argument_list|(
name|zname
argument_list|,
operator|&
name|htp
argument_list|,
operator|&
name|fname
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|==
name|NULL
condition|)
block|{
name|ns_warning
argument_list|(
name|ns_log_notify
argument_list|,
literal|"sysnotify: found name \"%s\" but not zone"
argument_list|,
name|dname
argument_list|)
expr_stmt|;
return|return;
block|}
name|mname
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|dp
operator|=
name|np
operator|->
name|n_data
init|;
name|dp
operator|!=
name|NULL
condition|;
name|dp
operator|=
name|dp
operator|->
name|d_next
control|)
block|{
if|if
condition|(
name|dp
operator|->
name|d_zone
operator|==
name|DB_Z_CACHE
operator|||
operator|!
name|match
argument_list|(
name|dp
argument_list|,
name|class
argument_list|,
name|ns_t_soa
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|dp
operator|->
name|d_type
operator|==
name|ns_t_sig
condition|)
continue|continue;
if|if
condition|(
name|mname
condition|)
block|{
name|ns_notice
argument_list|(
name|ns_log_notify
argument_list|,
literal|"multiple SOA's for zone \"%s\"?"
argument_list|,
name|zname
argument_list|)
expr_stmt|;
return|return;
block|}
name|mname
operator|=
operator|(
name|char
operator|*
operator|)
name|dp
operator|->
name|d_data
expr_stmt|;
block|}
if|if
condition|(
name|mname
operator|==
name|NULL
condition|)
block|{
name|ns_notice
argument_list|(
name|ns_log_notify
argument_list|,
literal|"no SOA found for zone \"%s\""
argument_list|,
name|zname
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|dp
operator|=
name|np
operator|->
name|n_data
init|;
name|dp
operator|!=
name|NULL
condition|;
name|dp
operator|=
name|dp
operator|->
name|d_next
control|)
block|{
if|if
condition|(
name|dp
operator|->
name|d_zone
operator|==
name|DB_Z_CACHE
operator|||
operator|!
name|match
argument_list|(
name|dp
argument_list|,
name|class
argument_list|,
name|ns_t_ns
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|dp
operator|->
name|d_type
operator|==
name|ns_t_sig
condition|)
continue|continue;
if|if
condition|(
name|ns_samename
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dp
operator|->
name|d_data
argument_list|,
name|mname
argument_list|)
operator|==
literal|1
condition|)
continue|continue;
name|sysnotify_ns
argument_list|(
name|dname
argument_list|,
operator|(
name|char
operator|*
operator|)
name|dp
operator|->
name|d_data
argument_list|,
name|class
argument_list|,
name|type
argument_list|,
name|zn
argument_list|,
name|nns
argument_list|,
name|na
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sysnotify_ns
parameter_list|(
specifier|const
name|char
modifier|*
name|dname
parameter_list|,
specifier|const
name|char
modifier|*
name|aname
parameter_list|,
name|ns_class
name|class
parameter_list|,
name|ns_type
name|type
parameter_list|,
name|int
name|zn
parameter_list|,
name|int
modifier|*
name|nns
parameter_list|,
name|int
modifier|*
name|na
parameter_list|)
block|{
name|struct
name|databuf
modifier|*
name|adp
decl_stmt|;
name|struct
name|namebuf
modifier|*
name|anp
decl_stmt|;
specifier|const
name|char
modifier|*
name|fname
decl_stmt|;
name|struct
name|in_addr
name|nss
index|[
name|NSMAX
index|]
decl_stmt|;
name|struct
name|hashbuf
modifier|*
name|htp
decl_stmt|;
name|int
name|is_us
decl_stmt|,
name|nsc
decl_stmt|;
name|htp
operator|=
name|hashtab
expr_stmt|;
name|anp
operator|=
name|nlookup
argument_list|(
name|aname
argument_list|,
operator|&
name|htp
argument_list|,
operator|&
name|fname
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nsc
operator|=
literal|0
expr_stmt|;
name|is_us
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|anp
operator|!=
name|NULL
condition|)
for|for
control|(
name|adp
operator|=
name|anp
operator|->
name|n_data
init|;
name|adp
condition|;
name|adp
operator|=
name|adp
operator|->
name|d_next
control|)
block|{
name|struct
name|in_addr
name|ina
decl_stmt|;
if|if
condition|(
operator|!
name|match
argument_list|(
name|adp
argument_list|,
name|class
argument_list|,
name|T_A
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|adp
operator|->
name|d_type
operator|==
name|ns_t_sig
condition|)
continue|continue;
name|ina
operator|=
name|ina_get
argument_list|(
name|adp
operator|->
name|d_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|aIsUs
argument_list|(
name|ina
argument_list|)
condition|)
block|{
name|is_us
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|nsc
operator|<
name|NSMAX
condition|)
name|nss
index|[
name|nsc
operator|++
index|]
operator|=
name|ina
expr_stmt|;
block|}
comment|/*next A*/
if|if
condition|(
name|nsc
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|is_us
operator|&&
operator|!
name|NS_OPTION_P
argument_list|(
name|OPTION_NOFETCHGLUE
argument_list|)
condition|)
block|{
name|struct
name|qinfo
modifier|*
name|qp
decl_stmt|;
name|qp
operator|=
name|sysquery
argument_list|(
name|aname
argument_list|,
name|class
argument_list|,
name|ns_t_a
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|ns_port
argument_list|,
name|ns_o_query
argument_list|)
expr_stmt|;
if|if
condition|(
name|qp
operator|!=
name|NULL
condition|)
name|qp
operator|->
name|q_notifyzone
operator|=
name|zn
expr_stmt|;
block|}
return|return;
block|}
name|sysquery
argument_list|(
name|dname
argument_list|,
name|class
argument_list|,
name|type
argument_list|,
name|nss
argument_list|,
name|nsc
argument_list|,
name|ns_port
argument_list|,
name|ns_o_notify
argument_list|)
expr_stmt|;
operator|(
operator|*
name|nns
operator|)
operator|++
expr_stmt|;
operator|*
name|na
operator|+=
name|nsc
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_notify
parameter_list|(
name|struct
name|notify
modifier|*
name|ni
parameter_list|)
block|{
name|struct
name|zoneinfo
modifier|*
name|zp
decl_stmt|;
name|INSIST
argument_list|(
operator|!
name|LINKED
argument_list|(
name|ni
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
name|zp
operator|=
name|find_auth_zone
argument_list|(
name|ni
operator|->
name|name
argument_list|,
name|ni
operator|->
name|class
argument_list|)
expr_stmt|;
if|if
condition|(
name|zp
operator|!=
name|NULL
operator|&&
name|ns_samename
argument_list|(
name|ni
operator|->
name|name
argument_list|,
name|zp
operator|->
name|z_origin
argument_list|)
operator|==
literal|1
condition|)
block|{
name|INSIST
argument_list|(
operator|(
name|zp
operator|->
name|z_flags
operator|&
name|Z_NOTIFY
operator|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|zp
operator|->
name|z_flags
operator|&=
operator|~
name|Z_NOTIFY
expr_stmt|;
block|}
if|if
condition|(
name|evTestID
argument_list|(
name|ni
operator|->
name|timer
argument_list|)
condition|)
block|{
name|evClearTimer
argument_list|(
name|ev
argument_list|,
name|ni
operator|->
name|timer
argument_list|)
expr_stmt|;
name|evInitID
argument_list|(
operator|&
name|ni
operator|->
name|timer
argument_list|)
expr_stmt|;
block|}
name|freestr
argument_list|(
name|ni
operator|->
name|name
argument_list|)
expr_stmt|;
name|memput
argument_list|(
name|ni
argument_list|,
sizeof|sizeof
expr|*
name|ni
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|notify_timer
parameter_list|(
name|evContext
name|ctx
parameter_list|,
name|void
modifier|*
name|uap
parameter_list|,
name|struct
name|timespec
name|due
parameter_list|,
name|struct
name|timespec
name|inter
parameter_list|)
block|{
name|struct
name|notify
modifier|*
name|ni
init|=
name|uap
decl_stmt|;
name|INSIST
argument_list|(
name|evTestID
argument_list|(
name|ni
operator|->
name|timer
argument_list|)
argument_list|)
expr_stmt|;
name|evInitID
argument_list|(
operator|&
name|ni
operator|->
name|timer
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|LINKED
argument_list|(
name|ni
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
name|UNLINK
argument_list|(
name|pending_notifies
argument_list|,
name|ni
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|sysnotify
argument_list|(
name|ni
operator|->
name|name
argument_list|,
name|ni
operator|->
name|class
argument_list|,
name|ni
operator|->
name|type
argument_list|)
expr_stmt|;
name|free_notify
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*BIND_NOTIFY*/
end_comment

end_unit


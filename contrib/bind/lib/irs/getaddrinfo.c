begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1997 Berkeley Software Design, Inc. All rights reserved.  * The Berkeley Software Design Inc. software License Agreement specifies  * the terms and conditions for redistribution.  *  *	BSDI $Id: getaddrinfo.c,v 8.3 1999/06/11 01:25:58 vixie Exp $  */
end_comment

begin_include
include|#
directive|include
file|<port_before.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<arpa/nameser.h>
end_include

begin_include
include|#
directive|include
file|<resolv.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<port_after.h>
end_include

begin_define
define|#
directive|define
name|SA
parameter_list|(
name|addr
parameter_list|)
value|((struct sockaddr *)(addr))
end_define

begin_define
define|#
directive|define
name|SIN
parameter_list|(
name|addr
parameter_list|)
value|((struct sockaddr_in *)(addr))
end_define

begin_define
define|#
directive|define
name|SIN6
parameter_list|(
name|addr
parameter_list|)
value|((struct sockaddr_in6 *)(addr))
end_define

begin_define
define|#
directive|define
name|SUN
parameter_list|(
name|addr
parameter_list|)
value|((struct sockaddr_un *)(addr))
end_define

begin_decl_stmt
specifier|static
name|struct
name|addrinfo
modifier|*
name|ai_reverse
argument_list|(
expr|struct
name|addrinfo
operator|*
name|oai
argument_list|)
decl_stmt|,
modifier|*
name|ai_clone
argument_list|(
expr|struct
name|addrinfo
operator|*
name|oai
argument_list|,
name|int
name|family
argument_list|)
decl_stmt|,
modifier|*
name|ai_alloc
argument_list|(
name|int
name|family
argument_list|,
name|int
name|addrlen
argument_list|)
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|AF_LOCAL
end_ifdef

begin_function_decl
specifier|static
name|int
name|get_local
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|socktype
parameter_list|,
name|struct
name|addrinfo
modifier|*
modifier|*
name|res
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|add_ipv4
parameter_list|(
specifier|const
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|flags
parameter_list|,
name|struct
name|addrinfo
modifier|*
modifier|*
name|aip
parameter_list|,
name|int
name|socktype
parameter_list|,
name|int
name|port
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|add_ipv6
parameter_list|(
specifier|const
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|flags
parameter_list|,
name|struct
name|addrinfo
modifier|*
modifier|*
name|aip
parameter_list|,
name|int
name|socktype
parameter_list|,
name|int
name|port
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|set_order
parameter_list|(
name|int
parameter_list|,
name|int
function_decl|(
modifier|*
modifier|*
function_decl|)
parameter_list|()
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|FOUND_IPV4
value|0x1
end_define

begin_define
define|#
directive|define
name|FOUND_IPV6
value|0x2
end_define

begin_define
define|#
directive|define
name|FOUND_MAX
value|2
end_define

begin_function
name|int
name|getaddrinfo
parameter_list|(
specifier|const
name|char
modifier|*
name|hostname
parameter_list|,
specifier|const
name|char
modifier|*
name|servname
parameter_list|,
specifier|const
name|struct
name|addrinfo
modifier|*
name|hints
parameter_list|,
name|struct
name|addrinfo
modifier|*
modifier|*
name|res
parameter_list|)
block|{
name|struct
name|servent
modifier|*
name|sp
decl_stmt|;
name|char
modifier|*
name|proto
decl_stmt|;
name|int
name|family
decl_stmt|,
name|socktype
decl_stmt|,
name|flags
decl_stmt|,
name|protocol
decl_stmt|;
name|struct
name|addrinfo
modifier|*
name|ai
decl_stmt|,
modifier|*
name|ai_list
decl_stmt|;
name|int
name|port
decl_stmt|,
name|err
decl_stmt|,
name|i
decl_stmt|;
name|int
function_decl|(
modifier|*
name|net_order
index|[
name|FOUND_MAX
operator|+
literal|1
index|]
function_decl|)
parameter_list|()
function_decl|;
if|if
condition|(
name|hostname
operator|==
name|NULL
operator|&&
name|servname
operator|==
name|NULL
condition|)
return|return
operator|(
name|EAI_NONAME
operator|)
return|;
name|proto
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|hints
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|hints
operator|->
name|ai_flags
operator|&
operator|~
operator|(
name|AI_MASK
operator|)
condition|)
return|return
operator|(
name|EAI_BADFLAGS
operator|)
return|;
if|if
condition|(
name|hints
operator|->
name|ai_addrlen
operator|||
name|hints
operator|->
name|ai_canonname
operator|||
name|hints
operator|->
name|ai_addr
operator|||
name|hints
operator|->
name|ai_next
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|EAI_SYSTEM
operator|)
return|;
block|}
name|family
operator|=
name|hints
operator|->
name|ai_family
expr_stmt|;
name|socktype
operator|=
name|hints
operator|->
name|ai_socktype
expr_stmt|;
name|protocol
operator|=
name|hints
operator|->
name|ai_protocol
expr_stmt|;
name|flags
operator|=
name|hints
operator|->
name|ai_flags
expr_stmt|;
switch|switch
condition|(
name|family
condition|)
block|{
case|case
name|AF_UNSPEC
case|:
switch|switch
condition|(
name|hints
operator|->
name|ai_socktype
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
name|proto
operator|=
literal|"tcp"
expr_stmt|;
break|break;
case|case
name|SOCK_DGRAM
case|:
name|proto
operator|=
literal|"udp"
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|AF_INET
case|:
case|case
name|AF_INET6
case|:
switch|switch
condition|(
name|hints
operator|->
name|ai_socktype
condition|)
block|{
case|case
literal|0
case|:
break|break;
case|case
name|SOCK_STREAM
case|:
name|proto
operator|=
literal|"tcp"
expr_stmt|;
break|break;
case|case
name|SOCK_DGRAM
case|:
name|proto
operator|=
literal|"udp"
expr_stmt|;
break|break;
case|case
name|SOCK_RAW
case|:
break|break;
default|default:
return|return
operator|(
name|EAI_SOCKTYPE
operator|)
return|;
block|}
break|break;
ifdef|#
directive|ifdef
name|AF_LOCAL
case|case
name|AF_LOCAL
case|:
switch|switch
condition|(
name|hints
operator|->
name|ai_socktype
condition|)
block|{
case|case
literal|0
case|:
break|break;
case|case
name|SOCK_STREAM
case|:
break|break;
case|case
name|SOCK_DGRAM
case|:
break|break;
default|default:
return|return
operator|(
name|EAI_SOCKTYPE
operator|)
return|;
block|}
break|break;
endif|#
directive|endif
default|default:
return|return
operator|(
name|EAI_FAMILY
operator|)
return|;
block|}
block|}
else|else
block|{
name|protocol
operator|=
literal|0
expr_stmt|;
name|family
operator|=
literal|0
expr_stmt|;
name|socktype
operator|=
literal|0
expr_stmt|;
name|flags
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|AF_LOCAL
comment|/* 	 * First, deal with AF_LOCAL.  If the family was not set, 	 * then assume AF_LOCAL if the first character of the 	 * hostname/servname is '/'. 	 */
if|if
condition|(
name|hostname
operator|&&
operator|(
name|family
operator|==
name|AF_LOCAL
operator|||
operator|(
name|family
operator|==
literal|0
operator|&&
operator|*
name|hostname
operator|==
literal|'/'
operator|)
operator|)
condition|)
return|return
operator|(
name|get_local
argument_list|(
name|hostname
argument_list|,
name|socktype
argument_list|,
name|res
argument_list|)
operator|)
return|;
if|if
condition|(
name|servname
operator|&&
operator|(
name|family
operator|==
name|AF_LOCAL
operator|||
operator|(
name|family
operator|==
literal|0
operator|&&
operator|*
name|servname
operator|==
literal|'/'
operator|)
operator|)
condition|)
return|return
operator|(
name|get_local
argument_list|(
name|servname
argument_list|,
name|socktype
argument_list|,
name|res
argument_list|)
operator|)
return|;
endif|#
directive|endif
comment|/* 	 * Ok, only AF_INET and AF_INET6 left. 	 */
name|ai_list
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * First, look up the service name (port) if it was 	 * requested.  If the socket type wasn't specified, then 	 * try and figure it out. 	 */
if|if
condition|(
name|servname
condition|)
block|{
name|char
modifier|*
name|e
decl_stmt|;
name|port
operator|=
name|strtol
argument_list|(
name|servname
argument_list|,
operator|&
name|e
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|e
operator|==
literal|'\0'
condition|)
block|{
if|if
condition|(
name|socktype
operator|==
literal|0
condition|)
return|return
operator|(
name|EAI_SOCKTYPE
operator|)
return|;
if|if
condition|(
name|port
operator|<
literal|0
operator|||
name|port
operator|>
literal|65535
condition|)
return|return
operator|(
name|EAI_SERVICE
operator|)
return|;
name|port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sp
operator|=
name|getservbyname
argument_list|(
name|servname
argument_list|,
name|proto
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
return|return
operator|(
name|EAI_SERVICE
operator|)
return|;
name|port
operator|=
name|sp
operator|->
name|s_port
expr_stmt|;
if|if
condition|(
name|socktype
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|sp
operator|->
name|s_proto
argument_list|,
literal|"tcp"
argument_list|)
condition|)
name|socktype
operator|=
name|SOCK_STREAM
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|sp
operator|->
name|s_proto
argument_list|,
literal|"udp"
argument_list|)
condition|)
name|socktype
operator|=
name|SOCK_DGRAM
expr_stmt|;
block|}
block|}
block|}
else|else
name|port
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Next, deal with just a service name, and no hostname. 	 * (we verified that one of them was non-null up above). 	 */
if|if
condition|(
name|hostname
operator|==
name|NULL
operator|&&
operator|(
name|flags
operator|&
name|AI_PASSIVE
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|family
operator|==
name|AF_INET
operator|||
name|family
operator|==
literal|0
condition|)
block|{
name|ai
operator|=
name|ai_alloc
argument_list|(
name|AF_INET
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|==
name|NULL
condition|)
return|return
operator|(
name|EAI_MEMORY
operator|)
return|;
name|ai
operator|->
name|ai_socktype
operator|=
name|socktype
expr_stmt|;
name|ai
operator|->
name|ai_protocol
operator|=
name|protocol
expr_stmt|;
name|SIN
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
operator|->
name|sin_port
operator|=
name|port
expr_stmt|;
name|ai
operator|->
name|ai_next
operator|=
name|ai_list
expr_stmt|;
name|ai_list
operator|=
name|ai
expr_stmt|;
block|}
if|if
condition|(
name|family
operator|==
name|AF_INET6
operator|||
name|family
operator|==
literal|0
condition|)
block|{
name|ai
operator|=
name|ai_alloc
argument_list|(
name|AF_INET6
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|==
name|NULL
condition|)
block|{
name|freeaddrinfo
argument_list|(
name|ai_list
argument_list|)
expr_stmt|;
return|return
operator|(
name|EAI_MEMORY
operator|)
return|;
block|}
name|ai
operator|->
name|ai_socktype
operator|=
name|socktype
expr_stmt|;
name|ai
operator|->
name|ai_protocol
operator|=
name|protocol
expr_stmt|;
name|SIN6
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
operator|->
name|sin6_port
operator|=
name|port
expr_stmt|;
name|ai
operator|->
name|ai_next
operator|=
name|ai_list
expr_stmt|;
name|ai_list
operator|=
name|ai
expr_stmt|;
block|}
operator|*
name|res
operator|=
name|ai_list
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * If the family isn't specified or AI_NUMERICHOST specified, 	 * check first to see if it * is a numeric address. 	 * Though the gethostbyname2() routine 	 * will recognize numeric addresses, it will only recognize 	 * the format that it is being called for.  Thus, a numeric 	 * AF_INET address will be treated by the AF_INET6 call as 	 * a domain name, and vice versa.  Checking for both numerics 	 * here avoids that. 	 */
if|if
condition|(
name|hostname
operator|!=
name|NULL
operator|&&
operator|(
name|family
operator|==
literal|0
operator|||
operator|(
name|flags
operator|&
name|AI_NUMERICHOST
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|char
name|abuf
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
index|]
decl_stmt|;
name|char
name|nbuf
index|[
sizeof|sizeof
argument_list|(
literal|"xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx00"
argument_list|)
index|]
decl_stmt|;
name|int
name|addrsize
decl_stmt|,
name|addroff
decl_stmt|;
if|if
condition|(
name|inet_aton
argument_list|(
name|hostname
argument_list|,
operator|(
expr|struct
name|in_addr
operator|*
operator|)
name|abuf
argument_list|)
condition|)
block|{
if|if
condition|(
name|family
operator|==
name|AF_INET6
condition|)
block|{
comment|/* Convert to a V4 mapped address */
name|struct
name|in6_addr
modifier|*
name|a6
init|=
operator|(
expr|struct
name|in6_addr
operator|*
operator|)
name|abuf
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|a6
operator|->
name|s6_addr
index|[
literal|12
index|]
argument_list|,
operator|&
name|a6
operator|->
name|s6_addr
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|a6
operator|->
name|s6_addr
index|[
literal|10
index|]
argument_list|,
literal|0xff
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|a6
operator|->
name|s6_addr
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
goto|goto
name|inet6_addr
goto|;
block|}
name|addrsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
expr_stmt|;
name|addroff
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
operator|&
name|SIN
argument_list|(
literal|0
argument_list|)
operator|->
name|sin_addr
operator|)
operator|-
operator|(
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|family
operator|=
name|AF_INET
expr_stmt|;
goto|goto
name|common
goto|;
block|}
elseif|else
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|hostname
argument_list|,
name|abuf
argument_list|)
condition|)
block|{
if|if
condition|(
name|family
operator|&&
name|family
operator|!=
name|AF_INET6
condition|)
return|return
operator|(
name|EAI_NONAME
operator|)
return|;
name|inet6_addr
label|:
name|addrsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
expr_stmt|;
name|addroff
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
operator|&
name|SIN6
argument_list|(
literal|0
argument_list|)
operator|->
name|sin6_addr
operator|)
operator|-
operator|(
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|family
operator|=
name|AF_INET6
expr_stmt|;
name|common
label|:
if|if
condition|(
operator|(
name|ai
operator|=
name|ai_clone
argument_list|(
name|ai_list
argument_list|,
name|family
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|EAI_MEMORY
operator|)
return|;
name|ai_list
operator|=
name|ai
expr_stmt|;
name|ai
operator|->
name|ai_socktype
operator|=
name|socktype
expr_stmt|;
name|SIN
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
operator|->
name|sin_port
operator|=
name|port
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ai
operator|->
name|ai_addr
operator|+
name|addroff
argument_list|,
name|abuf
argument_list|,
name|addrsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|AI_CANONNAME
condition|)
block|{
name|inet_ntop
argument_list|(
name|family
argument_list|,
name|abuf
argument_list|,
name|nbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|nbuf
argument_list|)
argument_list|)
expr_stmt|;
name|ai
operator|->
name|ai_canonname
operator|=
name|strdup
argument_list|(
name|nbuf
argument_list|)
expr_stmt|;
block|}
goto|goto
name|done
goto|;
block|}
elseif|else
if|if
condition|(
operator|(
name|flags
operator|&
name|AI_NUMERICHOST
operator|)
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|EAI_NONAME
operator|)
return|;
block|}
block|}
name|set_order
argument_list|(
name|family
argument_list|,
name|net_order
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FOUND_MAX
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|net_order
index|[
name|i
index|]
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
operator|(
name|err
operator|=
operator|(
name|net_order
index|[
name|i
index|]
operator|)
operator|(
name|hostname
operator|,
name|flags
operator|,
operator|&
name|ai_list
operator|,
name|socktype
operator|,
name|port
operator|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|err
operator|)
return|;
block|}
if|if
condition|(
name|ai_list
operator|==
name|NULL
condition|)
return|return
operator|(
name|EAI_NODATA
operator|)
return|;
name|done
label|:
name|ai_list
operator|=
name|ai_reverse
argument_list|(
name|ai_list
argument_list|)
expr_stmt|;
operator|*
name|res
operator|=
name|ai_list
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|void
name|set_order
argument_list|(
name|family
argument_list|,
name|net_order
argument_list|)
name|int
name|family
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
modifier|*
name|net_order
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
name|char
modifier|*
name|order
decl_stmt|,
modifier|*
name|tok
decl_stmt|;
name|int
name|found
decl_stmt|;
if|if
condition|(
name|family
condition|)
block|{
switch|switch
condition|(
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
operator|*
name|net_order
operator|++
operator|=
name|add_ipv4
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
operator|*
name|net_order
operator|++
operator|=
name|add_ipv6
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|order
operator|=
name|getenv
argument_list|(
literal|"NET_ORDER"
argument_list|)
expr_stmt|;
name|found
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|order
operator|!=
name|NULL
condition|)
block|{
comment|/* We ignore any unknown names.  */
name|tok
operator|=
name|strsep
argument_list|(
operator|&
name|order
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|tok
argument_list|,
literal|"inet6"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|found
operator|&
name|FOUND_IPV6
operator|)
operator|==
literal|0
condition|)
operator|*
name|net_order
operator|++
operator|=
name|add_ipv6
expr_stmt|;
name|found
operator||=
name|FOUND_IPV6
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|tok
argument_list|,
literal|"inet"
argument_list|)
operator|==
literal|0
operator|||
name|strcasecmp
argument_list|(
name|tok
argument_list|,
literal|"inet4"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|found
operator|&
name|FOUND_IPV4
operator|)
operator|==
literal|0
condition|)
operator|*
name|net_order
operator|++
operator|=
name|add_ipv4
expr_stmt|;
name|found
operator||=
name|FOUND_IPV4
expr_stmt|;
block|}
block|}
comment|/* Add in anything that we didn't find */
if|if
condition|(
operator|(
name|found
operator|&
name|FOUND_IPV4
operator|)
operator|==
literal|0
condition|)
operator|*
name|net_order
operator|++
operator|=
name|add_ipv4
expr_stmt|;
if|if
condition|(
operator|(
name|found
operator|&
name|FOUND_IPV6
operator|)
operator|==
literal|0
condition|)
operator|*
name|net_order
operator|++
operator|=
name|add_ipv6
expr_stmt|;
block|}
operator|*
name|net_order
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
end_block

begin_decl_stmt
specifier|static
name|char
name|v4_loop
index|[
literal|4
index|]
init|=
block|{
literal|127
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|add_ipv4
parameter_list|(
specifier|const
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|flags
parameter_list|,
name|struct
name|addrinfo
modifier|*
modifier|*
name|aip
parameter_list|,
name|int
name|socktype
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|struct
name|addrinfo
modifier|*
name|ai
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|char
modifier|*
modifier|*
name|addr
decl_stmt|;
if|if
condition|(
name|hostname
operator|==
name|NULL
operator|&&
operator|(
name|flags
operator|&
name|AI_PASSIVE
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|ai
operator|=
name|ai_clone
argument_list|(
operator|*
name|aip
argument_list|,
name|AF_INET
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|freeaddrinfo
argument_list|(
operator|*
name|aip
argument_list|)
expr_stmt|;
return|return
operator|(
name|EAI_MEMORY
operator|)
return|;
block|}
operator|*
name|aip
operator|=
name|ai
expr_stmt|;
name|ai
operator|->
name|ai_socktype
operator|=
name|socktype
expr_stmt|;
name|SIN
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
operator|->
name|sin_port
operator|=
name|port
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|SIN
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
operator|->
name|sin_addr
argument_list|,
name|v4_loop
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|hp
operator|=
name|gethostbyname2
argument_list|(
name|hostname
argument_list|,
name|AF_INET
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|addr
operator|=
name|hp
operator|->
name|h_addr_list
init|;
operator|*
name|addr
condition|;
name|addr
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ai
operator|=
name|ai_clone
argument_list|(
operator|*
name|aip
argument_list|,
name|hp
operator|->
name|h_addrtype
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|freeaddrinfo
argument_list|(
operator|*
name|aip
argument_list|)
expr_stmt|;
return|return
operator|(
name|EAI_MEMORY
operator|)
return|;
block|}
operator|*
name|aip
operator|=
name|ai
expr_stmt|;
name|ai
operator|->
name|ai_socktype
operator|=
name|socktype
expr_stmt|;
comment|/* We get IPv6 addresses if RES_USE_INET6 is set */
if|if
condition|(
name|hp
operator|->
name|h_addrtype
operator|==
name|AF_INET6
condition|)
block|{
name|SIN6
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
operator|->
name|sin6_port
operator|=
name|port
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|SIN6
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
operator|->
name|sin6_addr
argument_list|,
operator|*
name|addr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SIN
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
operator|->
name|sin_port
operator|=
name|port
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|SIN
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
operator|->
name|sin_addr
argument_list|,
operator|*
name|addr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|AI_CANONNAME
condition|)
name|ai
operator|->
name|ai_canonname
operator|=
name|strdup
argument_list|(
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
name|v6_loop
index|[
literal|16
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|add_ipv6
parameter_list|(
specifier|const
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|flags
parameter_list|,
name|struct
name|addrinfo
modifier|*
modifier|*
name|aip
parameter_list|,
name|int
name|socktype
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|struct
name|addrinfo
modifier|*
name|ai
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|char
modifier|*
modifier|*
name|addr
decl_stmt|;
if|if
condition|(
name|hostname
operator|==
name|NULL
operator|&&
operator|(
name|flags
operator|&
name|AI_PASSIVE
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|ai
operator|=
name|ai_clone
argument_list|(
operator|*
name|aip
argument_list|,
name|AF_INET6
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|freeaddrinfo
argument_list|(
operator|*
name|aip
argument_list|)
expr_stmt|;
return|return
operator|(
name|EAI_MEMORY
operator|)
return|;
block|}
operator|*
name|aip
operator|=
name|ai
expr_stmt|;
name|ai
operator|->
name|ai_socktype
operator|=
name|socktype
expr_stmt|;
name|SIN6
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
operator|->
name|sin6_port
operator|=
name|port
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|SIN6
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
operator|->
name|sin6_addr
argument_list|,
name|v6_loop
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|hp
operator|=
name|gethostbyname2
argument_list|(
name|hostname
argument_list|,
name|AF_INET6
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|addr
operator|=
name|hp
operator|->
name|h_addr_list
init|;
operator|*
name|addr
condition|;
name|addr
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ai
operator|=
name|ai_clone
argument_list|(
operator|*
name|aip
argument_list|,
name|AF_INET6
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|freeaddrinfo
argument_list|(
operator|*
name|aip
argument_list|)
expr_stmt|;
return|return
operator|(
name|EAI_MEMORY
operator|)
return|;
block|}
operator|*
name|aip
operator|=
name|ai
expr_stmt|;
name|ai
operator|->
name|ai_socktype
operator|=
name|socktype
expr_stmt|;
name|SIN6
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
operator|->
name|sin6_port
operator|=
name|port
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|SIN6
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
operator|->
name|sin6_addr
argument_list|,
operator|*
name|addr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|AI_CANONNAME
condition|)
name|ai
operator|->
name|ai_canonname
operator|=
name|strdup
argument_list|(
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|freeaddrinfo
parameter_list|(
name|struct
name|addrinfo
modifier|*
name|ai
parameter_list|)
block|{
name|struct
name|addrinfo
modifier|*
name|ai_next
decl_stmt|;
while|while
condition|(
name|ai
operator|!=
name|NULL
condition|)
block|{
name|ai_next
operator|=
name|ai
operator|->
name|ai_next
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|ai_addr
condition|)
name|free
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|ai_canonname
condition|)
name|free
argument_list|(
name|ai
operator|->
name|ai_canonname
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ai
argument_list|)
expr_stmt|;
name|ai
operator|=
name|ai_next
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|AF_LOCAL
end_ifdef

begin_function
specifier|static
name|int
name|get_local
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|socktype
parameter_list|,
name|struct
name|addrinfo
modifier|*
modifier|*
name|res
parameter_list|)
block|{
name|struct
name|addrinfo
modifier|*
name|ai
decl_stmt|;
name|struct
name|sockaddr_un
modifier|*
name|sun
decl_stmt|;
if|if
condition|(
name|socktype
operator|==
literal|0
condition|)
return|return
operator|(
name|EAI_SOCKTYPE
operator|)
return|;
if|if
condition|(
operator|(
name|ai
operator|=
name|ai_alloc
argument_list|(
name|AF_LOCAL
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sun
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|EAI_MEMORY
operator|)
return|;
name|sun
operator|=
name|SUN
argument_list|(
name|ai
operator|->
name|ai_addr
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|sun
operator|->
name|sun_path
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
operator|->
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
name|ai
operator|->
name|ai_socktype
operator|=
name|socktype
expr_stmt|;
comment|/* 	 * ai->ai_flags, ai->ai_protocol, ai->ai_canonname, 	 * and ai->ai_next were initialized to zero. 	 */
operator|*
name|res
operator|=
name|ai
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Allocate an addrinfo structure, and a sockaddr structure  * of the specificed length.  We initialize:  *	ai_addrlen  *	ai_family  *	ai_addr  *	ai_addr->sa_family  *	ai_addr->sa_len	(HAVE_SA_LEN)  * and everything else is initialized to zero.  */
end_comment

begin_function
specifier|static
name|struct
name|addrinfo
modifier|*
name|ai_alloc
parameter_list|(
name|int
name|family
parameter_list|,
name|int
name|addrlen
parameter_list|)
block|{
name|struct
name|addrinfo
modifier|*
name|ai
decl_stmt|;
if|if
condition|(
operator|(
name|ai
operator|=
operator|(
expr|struct
name|addrinfo
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ai
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
operator|(
name|ai
operator|->
name|ai_addr
operator|=
name|SA
argument_list|(
name|calloc
argument_list|(
literal|1
argument_list|,
name|addrlen
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|ai
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|ai
operator|->
name|ai_addrlen
operator|=
name|addrlen
expr_stmt|;
name|ai
operator|->
name|ai_family
operator|=
name|family
expr_stmt|;
name|ai
operator|->
name|ai_addr
operator|->
name|sa_family
operator|=
name|family
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SA_LEN
name|ai
operator|->
name|ai_addr
operator|->
name|sa_len
operator|=
name|addrlen
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|ai
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|addrinfo
modifier|*
name|ai_clone
parameter_list|(
name|struct
name|addrinfo
modifier|*
name|oai
parameter_list|,
name|int
name|family
parameter_list|)
block|{
name|struct
name|addrinfo
modifier|*
name|ai
decl_stmt|;
name|ai
operator|=
name|ai_alloc
argument_list|(
name|family
argument_list|,
operator|(
operator|(
name|family
operator|==
name|AF_INET6
operator|)
condition|?
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
else|:
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|==
name|NULL
condition|)
block|{
name|freeaddrinfo
argument_list|(
name|oai
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|oai
operator|==
name|NULL
condition|)
return|return
operator|(
name|ai
operator|)
return|;
name|ai
operator|->
name|ai_flags
operator|=
name|oai
operator|->
name|ai_flags
expr_stmt|;
name|ai
operator|->
name|ai_socktype
operator|=
name|oai
operator|->
name|ai_socktype
expr_stmt|;
name|ai
operator|->
name|ai_protocol
operator|=
name|oai
operator|->
name|ai_protocol
expr_stmt|;
name|ai
operator|->
name|ai_canonname
operator|=
name|NULL
expr_stmt|;
name|ai
operator|->
name|ai_next
operator|=
name|oai
expr_stmt|;
return|return
operator|(
name|ai
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|addrinfo
modifier|*
name|ai_reverse
parameter_list|(
name|struct
name|addrinfo
modifier|*
name|oai
parameter_list|)
block|{
name|struct
name|addrinfo
modifier|*
name|nai
decl_stmt|,
modifier|*
name|tai
decl_stmt|;
name|nai
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|oai
condition|)
block|{
comment|/* grab one off the old list */
name|tai
operator|=
name|oai
expr_stmt|;
name|oai
operator|=
name|oai
operator|->
name|ai_next
expr_stmt|;
comment|/* put it on the front of the new list */
name|tai
operator|->
name|ai_next
operator|=
name|nai
expr_stmt|;
name|nai
operator|=
name|tai
expr_stmt|;
block|}
return|return
operator|(
name|nai
operator|)
return|;
block|}
end_function

end_unit


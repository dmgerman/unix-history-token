begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1996-1999 by Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND INTERNET SOFTWARE CONSORTIUM DISCLAIMS  * ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL INTERNET SOFTWARE  * CONSORTIUM BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL  * DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR  * PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS  * ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS  * SOFTWARE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$Id: ns_print.c,v 8.24 2001/06/18 06:40:45 marka Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Import. */
end_comment

begin_include
include|#
directive|include
file|"port_before.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/nameser.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<isc/assertions.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<resolv.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"port_after.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SPRINTF_CHAR
end_ifdef

begin_define
define|#
directive|define
name|SPRINTF
parameter_list|(
name|x
parameter_list|)
value|strlen(sprintf
comment|/**/
value|x)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|SPRINTF
parameter_list|(
name|x
parameter_list|)
value|((size_t)sprintf x)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Forward. */
end_comment

begin_function_decl
specifier|static
name|size_t
name|prune_origin
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|origin
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|charstr
parameter_list|(
specifier|const
name|u_char
modifier|*
name|rdata
parameter_list|,
specifier|const
name|u_char
modifier|*
name|edata
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buflen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|addname
parameter_list|(
specifier|const
name|u_char
modifier|*
name|msg
parameter_list|,
name|size_t
name|msglen
parameter_list|,
specifier|const
name|u_char
modifier|*
modifier|*
name|p
parameter_list|,
specifier|const
name|char
modifier|*
name|origin
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buflen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|addlen
parameter_list|(
name|size_t
name|len
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buflen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|addstr
parameter_list|(
specifier|const
name|char
modifier|*
name|src
parameter_list|,
name|size_t
name|len
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buflen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|addtab
parameter_list|(
name|size_t
name|len
parameter_list|,
name|size_t
name|target
parameter_list|,
name|int
name|spaced
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buflen
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Proto. */
end_comment

begin_function_decl
name|u_int16_t
name|dst_s_dns_key_id
parameter_list|(
specifier|const
name|u_char
modifier|*
parameter_list|,
specifier|const
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Macros. */
end_comment

begin_define
define|#
directive|define
name|T
parameter_list|(
name|x
parameter_list|)
define|\
value|do { \ 		if ((x)< 0) \ 			return (-1); \ 	} while (0)
end_define

begin_comment
comment|/* Public. */
end_comment

begin_comment
comment|/*  * int  * ns_sprintrr(handle, rr, name_ctx, origin, buf, buflen)  *	Convert an RR to presentation format.  * return:  *	Number of characters written to buf, or -1 (check errno).  */
end_comment

begin_function
name|int
name|ns_sprintrr
parameter_list|(
specifier|const
name|ns_msg
modifier|*
name|handle
parameter_list|,
specifier|const
name|ns_rr
modifier|*
name|rr
parameter_list|,
specifier|const
name|char
modifier|*
name|name_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|origin
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|n
operator|=
name|ns_sprintrrf
argument_list|(
name|ns_msg_base
argument_list|(
operator|*
name|handle
argument_list|)
argument_list|,
name|ns_msg_size
argument_list|(
operator|*
name|handle
argument_list|)
argument_list|,
name|ns_rr_name
argument_list|(
operator|*
name|rr
argument_list|)
argument_list|,
name|ns_rr_class
argument_list|(
operator|*
name|rr
argument_list|)
argument_list|,
name|ns_rr_type
argument_list|(
operator|*
name|rr
argument_list|)
argument_list|,
name|ns_rr_ttl
argument_list|(
operator|*
name|rr
argument_list|)
argument_list|,
name|ns_rr_rdata
argument_list|(
operator|*
name|rr
argument_list|)
argument_list|,
name|ns_rr_rdlen
argument_list|(
operator|*
name|rr
argument_list|)
argument_list|,
name|name_ctx
argument_list|,
name|origin
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
return|return
operator|(
name|n
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * int  * ns_sprintrrf(msg, msglen, name, class, type, ttl, rdata, rdlen,  *	       name_ctx, origin, buf, buflen)  *	Convert the fields of an RR into presentation format.  * return:  *	Number of characters written to buf, or -1 (check errno).  */
end_comment

begin_function
name|int
name|ns_sprintrrf
parameter_list|(
specifier|const
name|u_char
modifier|*
name|msg
parameter_list|,
name|size_t
name|msglen
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|ns_class
name|class
parameter_list|,
name|ns_type
name|type
parameter_list|,
name|u_long
name|ttl
parameter_list|,
specifier|const
name|u_char
modifier|*
name|rdata
parameter_list|,
name|size_t
name|rdlen
parameter_list|,
specifier|const
name|char
modifier|*
name|name_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|origin
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|obuf
init|=
name|buf
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|edata
init|=
name|rdata
operator|+
name|rdlen
decl_stmt|;
name|int
name|spaced
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|comment
decl_stmt|;
name|char
name|tmp
index|[
literal|100
index|]
decl_stmt|;
name|int
name|len
decl_stmt|,
name|x
decl_stmt|;
comment|/* 	 * Owner. 	 */
if|if
condition|(
name|name_ctx
operator|!=
name|NULL
operator|&&
name|ns_samename
argument_list|(
name|name_ctx
argument_list|,
name|name
argument_list|)
operator|==
literal|1
condition|)
block|{
name|T
argument_list|(
name|addstr
argument_list|(
literal|"\t\t\t"
argument_list|,
literal|3
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|prune_origin
argument_list|(
name|name
argument_list|,
name|origin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|name
operator|==
literal|'\0'
condition|)
block|{
goto|goto
name|root
goto|;
block|}
elseif|else
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|T
argument_list|(
name|addstr
argument_list|(
literal|"@\t\t\t"
argument_list|,
literal|4
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|T
argument_list|(
name|addstr
argument_list|(
name|name
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Origin not used or not root, and no trailing dot? */
if|if
condition|(
operator|(
operator|(
name|origin
operator|==
name|NULL
operator|||
name|origin
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|)
operator|||
operator|(
name|origin
index|[
literal|0
index|]
operator|!=
literal|'.'
operator|&&
name|origin
index|[
literal|1
index|]
operator|!=
literal|'\0'
operator|&&
name|name
index|[
name|len
index|]
operator|==
literal|'\0'
operator|)
operator|)
operator|&&
name|name
index|[
name|len
operator|-
literal|1
index|]
operator|!=
literal|'.'
condition|)
block|{
name|root
label|:
name|T
argument_list|(
name|addstr
argument_list|(
literal|"."
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|++
expr_stmt|;
block|}
name|T
argument_list|(
name|spaced
operator|=
name|addtab
argument_list|(
name|len
argument_list|,
literal|24
argument_list|,
name|spaced
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * TTL, Class, Type. 	 */
name|T
argument_list|(
name|x
operator|=
name|ns_format_ttl
argument_list|(
name|ttl
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|addlen
argument_list|(
name|x
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|" %s %s"
operator|,
name|p_class
argument_list|(
name|class
argument_list|)
operator|,
name|p_type
argument_list|(
name|type
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdlen
operator|==
literal|0
condition|)
return|return
operator|(
name|buf
operator|-
name|obuf
operator|)
return|;
name|T
argument_list|(
name|spaced
operator|=
name|addtab
argument_list|(
name|x
operator|+
name|len
argument_list|,
literal|16
argument_list|,
name|spaced
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * RData. 	 */
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|ns_t_a
case|:
if|if
condition|(
name|rdlen
operator|!=
name|NS_INADDRSZ
condition|)
goto|goto
name|formerr
goto|;
operator|(
name|void
operator|)
name|inet_ntop
argument_list|(
name|AF_INET
argument_list|,
name|rdata
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|addlen
argument_list|(
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
break|break;
case|case
name|ns_t_cname
case|:
case|case
name|ns_t_mb
case|:
case|case
name|ns_t_mg
case|:
case|case
name|ns_t_mr
case|:
case|case
name|ns_t_ns
case|:
case|case
name|ns_t_ptr
case|:
case|case
name|ns_t_dname
case|:
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ns_t_hinfo
case|:
case|case
name|ns_t_isdn
case|:
comment|/* First word. */
name|T
argument_list|(
name|len
operator|=
name|charstr
argument_list|(
name|rdata
argument_list|,
name|edata
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
goto|goto
name|formerr
goto|;
name|rdata
operator|+=
name|len
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|" "
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Second word, optional in ISDN records. */
if|if
condition|(
name|type
operator|==
name|ns_t_isdn
operator|&&
name|rdata
operator|==
name|edata
condition|)
break|break;
name|T
argument_list|(
name|len
operator|=
name|charstr
argument_list|(
name|rdata
argument_list|,
name|edata
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
goto|goto
name|formerr
goto|;
name|rdata
operator|+=
name|len
expr_stmt|;
break|break;
case|case
name|ns_t_soa
case|:
block|{
name|u_long
name|t
decl_stmt|;
comment|/* Server name. */
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|" "
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Administrator name. */
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|" (\n"
argument_list|,
literal|3
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|spaced
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|edata
operator|-
name|rdata
operator|)
operator|!=
literal|5
operator|*
name|NS_INT32SZ
condition|)
goto|goto
name|formerr
goto|;
comment|/* Serial number. */
name|t
operator|=
name|ns_get32
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT32SZ
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|"\t\t\t\t\t"
argument_list|,
literal|5
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%lu"
operator|,
name|t
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|spaced
operator|=
name|addtab
argument_list|(
name|len
argument_list|,
literal|16
argument_list|,
name|spaced
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|"; serial\n"
argument_list|,
literal|9
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|spaced
operator|=
literal|0
expr_stmt|;
comment|/* Refresh interval. */
name|t
operator|=
name|ns_get32
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT32SZ
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|"\t\t\t\t\t"
argument_list|,
literal|5
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|len
operator|=
name|ns_format_ttl
argument_list|(
name|t
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|addlen
argument_list|(
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|spaced
operator|=
name|addtab
argument_list|(
name|len
argument_list|,
literal|16
argument_list|,
name|spaced
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|"; refresh\n"
argument_list|,
literal|10
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|spaced
operator|=
literal|0
expr_stmt|;
comment|/* Retry interval. */
name|t
operator|=
name|ns_get32
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT32SZ
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|"\t\t\t\t\t"
argument_list|,
literal|5
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|len
operator|=
name|ns_format_ttl
argument_list|(
name|t
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|addlen
argument_list|(
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|spaced
operator|=
name|addtab
argument_list|(
name|len
argument_list|,
literal|16
argument_list|,
name|spaced
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|"; retry\n"
argument_list|,
literal|8
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|spaced
operator|=
literal|0
expr_stmt|;
comment|/* Expiry. */
name|t
operator|=
name|ns_get32
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT32SZ
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|"\t\t\t\t\t"
argument_list|,
literal|5
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|len
operator|=
name|ns_format_ttl
argument_list|(
name|t
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|addlen
argument_list|(
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|spaced
operator|=
name|addtab
argument_list|(
name|len
argument_list|,
literal|16
argument_list|,
name|spaced
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|"; expiry\n"
argument_list|,
literal|9
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|spaced
operator|=
literal|0
expr_stmt|;
comment|/* Minimum TTL. */
name|t
operator|=
name|ns_get32
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT32SZ
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|"\t\t\t\t\t"
argument_list|,
literal|5
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|len
operator|=
name|ns_format_ttl
argument_list|(
name|t
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|addlen
argument_list|(
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|" )"
argument_list|,
literal|2
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|spaced
operator|=
name|addtab
argument_list|(
name|len
argument_list|,
literal|16
argument_list|,
name|spaced
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|"; minimum\n"
argument_list|,
literal|10
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|ns_t_mx
case|:
case|case
name|ns_t_afsdb
case|:
case|case
name|ns_t_rt
case|:
block|{
name|u_int
name|t
decl_stmt|;
if|if
condition|(
name|rdlen
operator|<
name|NS_INT16SZ
condition|)
goto|goto
name|formerr
goto|;
comment|/* Priority. */
name|t
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%u "
operator|,
name|t
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Target. */
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|ns_t_px
case|:
block|{
name|u_int
name|t
decl_stmt|;
if|if
condition|(
name|rdlen
operator|<
name|NS_INT16SZ
condition|)
goto|goto
name|formerr
goto|;
comment|/* Priority. */
name|t
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%u "
operator|,
name|t
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Name1. */
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|" "
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Name2. */
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|ns_t_x25
case|:
name|T
argument_list|(
name|len
operator|=
name|charstr
argument_list|(
name|rdata
argument_list|,
name|edata
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
goto|goto
name|formerr
goto|;
name|rdata
operator|+=
name|len
expr_stmt|;
break|break;
case|case
name|ns_t_txt
case|:
while|while
condition|(
name|rdata
operator|<
name|edata
condition|)
block|{
name|T
argument_list|(
name|len
operator|=
name|charstr
argument_list|(
name|rdata
argument_list|,
name|edata
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
goto|goto
name|formerr
goto|;
name|rdata
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|rdata
operator|<
name|edata
condition|)
name|T
argument_list|(
name|addstr
argument_list|(
literal|" "
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ns_t_nsap
case|:
block|{
name|char
name|t
index|[
literal|2
operator|+
literal|255
operator|*
literal|3
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|inet_nsap_ntoa
argument_list|(
name|rdlen
argument_list|,
name|rdata
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|t
argument_list|,
name|strlen
argument_list|(
name|t
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|ns_t_aaaa
case|:
if|if
condition|(
name|rdlen
operator|!=
name|NS_IN6ADDRSZ
condition|)
goto|goto
name|formerr
goto|;
operator|(
name|void
operator|)
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|rdata
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|addlen
argument_list|(
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
break|break;
case|case
name|ns_t_loc
case|:
block|{
name|char
name|t
index|[
literal|255
index|]
decl_stmt|;
comment|/* XXX protocol format checking? */
operator|(
name|void
operator|)
name|loc_ntoa
argument_list|(
name|rdata
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|t
argument_list|,
name|strlen
argument_list|(
name|t
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|ns_t_naptr
case|:
block|{
name|u_int
name|order
decl_stmt|,
name|preference
decl_stmt|;
name|char
name|t
index|[
literal|50
index|]
decl_stmt|;
if|if
condition|(
name|rdlen
operator|<
literal|2
operator|*
name|NS_INT16SZ
condition|)
goto|goto
name|formerr
goto|;
comment|/* Order, Precedence. */
name|order
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|preference
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|t
operator|,
literal|"%u %u "
operator|,
name|order
operator|,
name|preference
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|t
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Flags. */
name|T
argument_list|(
name|len
operator|=
name|charstr
argument_list|(
name|rdata
argument_list|,
name|edata
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
goto|goto
name|formerr
goto|;
name|rdata
operator|+=
name|len
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|" "
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Service. */
name|T
argument_list|(
name|len
operator|=
name|charstr
argument_list|(
name|rdata
argument_list|,
name|edata
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
goto|goto
name|formerr
goto|;
name|rdata
operator|+=
name|len
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|" "
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Regexp. */
name|T
argument_list|(
name|len
operator|=
name|charstr
argument_list|(
name|rdata
argument_list|,
name|edata
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
goto|goto
name|formerr
goto|;
name|rdata
operator|+=
name|len
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|" "
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Server. */
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|ns_t_srv
case|:
block|{
name|u_int
name|priority
decl_stmt|,
name|weight
decl_stmt|,
name|port
decl_stmt|;
name|char
name|t
index|[
literal|50
index|]
decl_stmt|;
if|if
condition|(
name|rdlen
operator|<
name|NS_INT16SZ
operator|*
literal|3
condition|)
goto|goto
name|formerr
goto|;
comment|/* Priority, Weight, Port. */
name|priority
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|weight
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|port
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|t
operator|,
literal|"%u %u %u "
operator|,
name|priority
operator|,
name|weight
operator|,
name|port
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|t
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Server. */
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|ns_t_minfo
case|:
case|case
name|ns_t_rp
case|:
comment|/* Name1. */
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|" "
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Name2. */
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ns_t_wks
case|:
block|{
name|int
name|n
decl_stmt|,
name|lcnt
decl_stmt|;
if|if
condition|(
name|rdlen
operator|<
name|NS_INT32SZ
operator|+
literal|1
condition|)
goto|goto
name|formerr
goto|;
comment|/* Address. */
operator|(
name|void
operator|)
name|inet_ntop
argument_list|(
name|AF_INET
argument_list|,
name|rdata
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|addlen
argument_list|(
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INADDRSZ
expr_stmt|;
comment|/* Protocol. */
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|" %u ( "
operator|,
operator|*
name|rdata
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT8SZ
expr_stmt|;
comment|/* Bit map. */
name|n
operator|=
literal|0
expr_stmt|;
name|lcnt
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|rdata
operator|<
name|edata
condition|)
block|{
name|u_int
name|c
init|=
operator|*
name|rdata
operator|++
decl_stmt|;
do|do
block|{
if|if
condition|(
name|c
operator|&
literal|0200
condition|)
block|{
if|if
condition|(
name|lcnt
operator|==
literal|0
condition|)
block|{
name|T
argument_list|(
name|addstr
argument_list|(
literal|"\n\t\t\t\t"
argument_list|,
literal|5
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|lcnt
operator|=
literal|10
expr_stmt|;
name|spaced
operator|=
literal|0
expr_stmt|;
block|}
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%d "
operator|,
name|n
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|lcnt
operator|--
expr_stmt|;
block|}
name|c
operator|<<=
literal|1
expr_stmt|;
block|}
do|while
condition|(
operator|++
name|n
operator|&
literal|07
condition|)
do|;
block|}
name|T
argument_list|(
name|addstr
argument_list|(
literal|")"
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|ns_t_key
case|:
block|{
name|char
name|base64_key
index|[
name|NS_MD5RSA_MAX_BASE64
index|]
decl_stmt|;
name|u_int
name|keyflags
decl_stmt|,
name|protocol
decl_stmt|,
name|algorithm
decl_stmt|,
name|key_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|leader
decl_stmt|;
name|int
name|n
decl_stmt|;
if|if
condition|(
name|rdlen
operator|<
name|NS_INT16SZ
operator|+
name|NS_INT8SZ
operator|+
name|NS_INT8SZ
condition|)
goto|goto
name|formerr
goto|;
comment|/* Key flags, Protocol, Algorithm. */
name|key_id
operator|=
name|dst_s_dns_key_id
argument_list|(
name|rdata
argument_list|,
name|edata
operator|-
name|rdata
argument_list|)
expr_stmt|;
name|keyflags
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|protocol
operator|=
operator|*
name|rdata
operator|++
expr_stmt|;
name|algorithm
operator|=
operator|*
name|rdata
operator|++
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"0x%04x %u %u"
operator|,
name|keyflags
operator|,
name|protocol
operator|,
name|algorithm
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Public key data. */
name|len
operator|=
name|b64_ntop
argument_list|(
name|rdata
argument_list|,
name|edata
operator|-
name|rdata
argument_list|,
name|base64_key
argument_list|,
sizeof|sizeof
name|base64_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
goto|goto
name|formerr
goto|;
if|if
condition|(
name|len
operator|>
literal|15
condition|)
block|{
name|T
argument_list|(
name|addstr
argument_list|(
literal|" ("
argument_list|,
literal|2
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|leader
operator|=
literal|"\n\t\t"
expr_stmt|;
name|spaced
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|leader
operator|=
literal|" "
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|len
condition|;
name|n
operator|+=
literal|48
control|)
block|{
name|T
argument_list|(
name|addstr
argument_list|(
name|leader
argument_list|,
name|strlen
argument_list|(
name|leader
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|base64_key
operator|+
name|n
argument_list|,
name|MIN
argument_list|(
name|len
operator|-
name|n
argument_list|,
literal|48
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|>
literal|15
condition|)
name|T
argument_list|(
name|addstr
argument_list|(
literal|" )"
argument_list|,
literal|2
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|" ; key_tag= %u"
operator|,
name|key_id
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|n
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|ns_t_sig
case|:
block|{
name|char
name|base64_key
index|[
name|NS_MD5RSA_MAX_BASE64
index|]
decl_stmt|;
name|u_int
name|type
decl_stmt|,
name|algorithm
decl_stmt|,
name|labels
decl_stmt|,
name|footprint
decl_stmt|;
specifier|const
name|char
modifier|*
name|leader
decl_stmt|;
name|u_long
name|t
decl_stmt|;
name|int
name|n
decl_stmt|;
if|if
condition|(
name|rdlen
operator|<
literal|22
condition|)
goto|goto
name|formerr
goto|;
comment|/* Type covered, Algorithm, Label count, Original TTL. */
name|type
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|algorithm
operator|=
operator|*
name|rdata
operator|++
expr_stmt|;
name|labels
operator|=
operator|*
name|rdata
operator|++
expr_stmt|;
name|t
operator|=
name|ns_get32
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT32SZ
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%s %d %d %lu "
operator|,
name|p_type
argument_list|(
name|type
argument_list|)
operator|,
name|algorithm
operator|,
name|labels
operator|,
name|t
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|labels
operator|>
operator|(
name|u_int
operator|)
name|dn_count_labels
argument_list|(
name|name
argument_list|)
condition|)
goto|goto
name|formerr
goto|;
comment|/* Signature expiry. */
name|t
operator|=
name|ns_get32
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT32SZ
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%s "
operator|,
name|p_secstodate
argument_list|(
name|t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Time signed. */
name|t
operator|=
name|ns_get32
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT32SZ
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%s "
operator|,
name|p_secstodate
argument_list|(
name|t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Signature Footprint. */
name|footprint
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%u "
operator|,
name|footprint
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Signer's name. */
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Signature. */
name|len
operator|=
name|b64_ntop
argument_list|(
name|rdata
argument_list|,
name|edata
operator|-
name|rdata
argument_list|,
name|base64_key
argument_list|,
sizeof|sizeof
name|base64_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|15
condition|)
block|{
name|T
argument_list|(
name|addstr
argument_list|(
literal|" ("
argument_list|,
literal|2
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|leader
operator|=
literal|"\n\t\t"
expr_stmt|;
name|spaced
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|leader
operator|=
literal|" "
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
goto|goto
name|formerr
goto|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|len
condition|;
name|n
operator|+=
literal|48
control|)
block|{
name|T
argument_list|(
name|addstr
argument_list|(
name|leader
argument_list|,
name|strlen
argument_list|(
name|leader
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|base64_key
operator|+
name|n
argument_list|,
name|MIN
argument_list|(
name|len
operator|-
name|n
argument_list|,
literal|48
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|>
literal|15
condition|)
name|T
argument_list|(
name|addstr
argument_list|(
literal|" )"
argument_list|,
literal|2
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|ns_t_nxt
case|:
block|{
name|int
name|n
decl_stmt|,
name|c
decl_stmt|;
comment|/* Next domain name. */
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Type bit map. */
name|n
operator|=
name|edata
operator|-
name|rdata
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|n
operator|*
literal|8
condition|;
name|c
operator|++
control|)
if|if
condition|(
name|NS_NXT_BIT_ISSET
argument_list|(
name|c
argument_list|,
name|rdata
argument_list|)
condition|)
block|{
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|" %s"
operator|,
name|p_type
argument_list|(
name|c
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|ns_t_cert
case|:
block|{
name|u_int
name|c_type
decl_stmt|,
name|key_tag
decl_stmt|,
name|alg
decl_stmt|;
name|int
name|n
decl_stmt|;
name|unsigned
name|int
name|siz
decl_stmt|;
name|char
name|base64_cert
index|[
literal|8192
index|]
decl_stmt|,
name|tmp
index|[
literal|40
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|leader
decl_stmt|;
name|c_type
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|key_tag
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|alg
operator|=
operator|(
name|u_int
operator|)
operator|*
name|rdata
operator|++
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%d %d %d "
operator|,
name|c_type
operator|,
name|key_tag
operator|,
name|alg
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|siz
operator|=
operator|(
name|edata
operator|-
name|rdata
operator|)
operator|*
literal|4
operator|/
literal|3
operator|+
literal|4
expr_stmt|;
comment|/* "+4" accounts for trailing \0 */
if|if
condition|(
name|siz
operator|>
sizeof|sizeof
argument_list|(
name|base64_cert
argument_list|)
operator|*
literal|3
operator|/
literal|4
condition|)
block|{
specifier|const
name|char
modifier|*
name|str
init|=
literal|"record too long to print"
decl_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|b64_ntop
argument_list|(
name|rdata
argument_list|,
name|edata
operator|-
name|rdata
argument_list|,
name|base64_cert
argument_list|,
name|siz
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
goto|goto
name|formerr
goto|;
elseif|else
if|if
condition|(
name|len
operator|>
literal|15
condition|)
block|{
name|T
argument_list|(
name|addstr
argument_list|(
literal|" ("
argument_list|,
literal|2
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|leader
operator|=
literal|"\n\t\t"
expr_stmt|;
name|spaced
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|leader
operator|=
literal|" "
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|len
condition|;
name|n
operator|+=
literal|48
control|)
block|{
name|T
argument_list|(
name|addstr
argument_list|(
name|leader
argument_list|,
name|strlen
argument_list|(
name|leader
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|base64_cert
operator|+
name|n
argument_list|,
name|MIN
argument_list|(
name|len
operator|-
name|n
argument_list|,
literal|48
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|>
literal|15
condition|)
name|T
argument_list|(
name|addstr
argument_list|(
literal|" )"
argument_list|,
literal|2
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|ns_t_tkey
case|:
block|{
comment|/* KJD - need to complete this */
name|u_long
name|t
decl_stmt|;
name|int
name|mode
decl_stmt|,
name|err
decl_stmt|,
name|keysize
decl_stmt|;
comment|/* Algorithm name. */
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|" "
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Inception. */
name|t
operator|=
name|ns_get32
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT32SZ
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%s "
operator|,
name|p_secstodate
argument_list|(
name|t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Experation. */
name|t
operator|=
name|ns_get32
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT32SZ
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%s "
operator|,
name|p_secstodate
argument_list|(
name|t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Mode , Error, Key Size. */
comment|/* Priority, Weight, Port. */
name|mode
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|err
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|keysize
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|NS_INT16SZ
expr_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%u %u %u "
operator|,
name|mode
operator|,
name|err
operator|,
name|keysize
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
comment|/* needs to dump key, print otherdata length& other data */
break|break;
block|}
case|case
name|ns_t_tsig
case|:
block|{
comment|/* BEW - need to complete this */
name|int
name|n
decl_stmt|;
name|T
argument_list|(
name|len
operator|=
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|" "
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|rdata
operator|+=
literal|8
expr_stmt|;
comment|/* time */
name|n
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|INT16SZ
expr_stmt|;
name|rdata
operator|+=
name|n
expr_stmt|;
comment|/* sig */
name|n
operator|=
name|ns_get16
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|INT16SZ
expr_stmt|;
comment|/* original id */
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d"
argument_list|,
name|ns_get16
argument_list|(
name|rdata
argument_list|)
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|INT16SZ
expr_stmt|;
name|addlen
argument_list|(
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|ns_t_a6
case|:
block|{
name|struct
name|in6_addr
name|a
decl_stmt|;
name|int
name|pbyte
decl_stmt|,
name|pbit
decl_stmt|;
comment|/* prefix length */
if|if
condition|(
name|rdlen
operator|==
literal|0
condition|)
goto|goto
name|formerr
goto|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%d "
operator|,
operator|*
name|rdata
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|pbit
operator|=
operator|*
name|rdata
expr_stmt|;
if|if
condition|(
name|pbit
operator|>
literal|128
condition|)
goto|goto
name|formerr
goto|;
name|pbyte
operator|=
operator|(
name|pbit
operator|&
operator|~
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
name|rdata
operator|++
expr_stmt|;
comment|/* address suffix: provided only when prefix len != 128 */
if|if
condition|(
name|pbit
operator|<
literal|128
condition|)
block|{
if|if
condition|(
name|rdata
operator|+
name|pbyte
operator|>=
name|edata
condition|)
goto|goto
name|formerr
goto|;
name|memset
argument_list|(
operator|&
name|a
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|a
operator|.
name|s6_addr
index|[
name|pbyte
index|]
argument_list|,
name|rdata
argument_list|,
sizeof|sizeof
argument_list|(
name|a
argument_list|)
operator|-
name|pbyte
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
name|a
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|addlen
argument_list|(
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
name|rdata
operator|+=
sizeof|sizeof
argument_list|(
name|a
argument_list|)
operator|-
name|pbyte
expr_stmt|;
block|}
comment|/* prefix name: provided only when prefix len> 0 */
if|if
condition|(
name|pbit
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|rdata
operator|>=
name|edata
condition|)
goto|goto
name|formerr
goto|;
name|T
argument_list|(
name|addstr
argument_list|(
literal|" "
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addname
argument_list|(
name|msg
argument_list|,
name|msglen
argument_list|,
operator|&
name|rdata
argument_list|,
name|origin
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|ns_t_opt
case|:
block|{
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"%u bytes"
operator|,
name|class
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|comment
operator|=
literal|"unknown RR type"
expr_stmt|;
goto|goto
name|hexify
goto|;
block|}
return|return
operator|(
name|buf
operator|-
name|obuf
operator|)
return|;
name|formerr
label|:
name|comment
operator|=
literal|"RR format error"
expr_stmt|;
name|hexify
label|:
block|{
name|int
name|n
decl_stmt|,
name|m
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|len
operator|=
name|SPRINTF
argument_list|(
operator|(
name|tmp
operator|,
literal|"\\# %u (\t; %s"
operator|,
name|edata
operator|-
name|rdata
operator|,
name|comment
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|len
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|rdata
operator|<
name|edata
condition|)
block|{
name|p
operator|=
name|tmp
expr_stmt|;
name|p
operator|+=
name|SPRINTF
argument_list|(
operator|(
name|p
operator|,
literal|"\n\t"
operator|)
argument_list|)
expr_stmt|;
name|spaced
operator|=
literal|0
expr_stmt|;
name|n
operator|=
name|MIN
argument_list|(
literal|16
argument_list|,
name|edata
operator|-
name|rdata
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|n
condition|;
name|m
operator|++
control|)
name|p
operator|+=
name|SPRINTF
argument_list|(
operator|(
name|p
operator|,
literal|"%02x "
operator|,
name|rdata
index|[
name|m
index|]
operator|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|p
operator|-
name|tmp
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|16
condition|)
block|{
name|T
argument_list|(
name|addstr
argument_list|(
literal|")"
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|T
argument_list|(
name|addtab
argument_list|(
name|p
operator|-
name|tmp
operator|+
literal|1
argument_list|,
literal|48
argument_list|,
name|spaced
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|tmp
expr_stmt|;
name|p
operator|+=
name|SPRINTF
argument_list|(
operator|(
name|p
operator|,
literal|"; "
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|n
condition|;
name|m
operator|++
control|)
operator|*
name|p
operator|++
operator|=
operator|(
name|isascii
argument_list|(
name|rdata
index|[
name|m
index|]
argument_list|)
operator|&&
name|isprint
argument_list|(
name|rdata
index|[
name|m
index|]
argument_list|)
operator|)
condition|?
name|rdata
index|[
name|m
index|]
else|:
literal|'.'
expr_stmt|;
name|T
argument_list|(
name|addstr
argument_list|(
name|tmp
argument_list|,
name|p
operator|-
name|tmp
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|rdata
operator|+=
name|n
expr_stmt|;
block|}
return|return
operator|(
name|buf
operator|-
name|obuf
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* Private. */
end_comment

begin_comment
comment|/*  * size_t  * prune_origin(name, origin)  *	Find out if the name is at or under the current origin.  * return:  *	Number of characters in name before start of origin,  *	or length of name if origin does not match.  * notes:  *	This function should share code with samedomain().  */
end_comment

begin_function
specifier|static
name|size_t
name|prune_origin
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|origin
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|oname
init|=
name|name
decl_stmt|;
while|while
condition|(
operator|*
name|name
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|origin
operator|!=
name|NULL
operator|&&
name|ns_samename
argument_list|(
name|name
argument_list|,
name|origin
argument_list|)
operator|==
literal|1
condition|)
return|return
operator|(
name|name
operator|-
name|oname
operator|-
operator|(
name|name
operator|>
name|oname
operator|)
operator|)
return|;
while|while
condition|(
operator|*
name|name
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|*
name|name
operator|==
literal|'\\'
condition|)
block|{
name|name
operator|++
expr_stmt|;
comment|/* XXX need to handle \nnn form. */
if|if
condition|(
operator|*
name|name
operator|==
literal|'\0'
condition|)
break|break;
block|}
elseif|else
if|if
condition|(
operator|*
name|name
operator|==
literal|'.'
condition|)
block|{
name|name
operator|++
expr_stmt|;
break|break;
block|}
name|name
operator|++
expr_stmt|;
block|}
block|}
return|return
operator|(
name|name
operator|-
name|oname
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * int  * charstr(rdata, edata, buf, buflen)  *	Format a<character-string> into the presentation buffer.  * return:  *	Number of rdata octets consumed  *	0 for protocol format error  *	-1 for output buffer error  * side effects:  *	buffer is advanced on success.  */
end_comment

begin_function
specifier|static
name|int
name|charstr
parameter_list|(
specifier|const
name|u_char
modifier|*
name|rdata
parameter_list|,
specifier|const
name|u_char
modifier|*
name|edata
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buflen
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|odata
init|=
name|rdata
decl_stmt|;
name|size_t
name|save_buflen
init|=
operator|*
name|buflen
decl_stmt|;
name|char
modifier|*
name|save_buf
init|=
operator|*
name|buf
decl_stmt|;
if|if
condition|(
name|addstr
argument_list|(
literal|"\""
argument_list|,
literal|1
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|enospc
goto|;
if|if
condition|(
name|rdata
operator|<
name|edata
condition|)
block|{
name|int
name|n
init|=
operator|*
name|rdata
decl_stmt|;
if|if
condition|(
name|rdata
operator|+
literal|1
operator|+
name|n
operator|<=
name|edata
condition|)
block|{
name|rdata
operator|++
expr_stmt|;
while|while
condition|(
name|n
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|strchr
argument_list|(
literal|"\n\"\\"
argument_list|,
operator|*
name|rdata
argument_list|)
operator|!=
name|NULL
condition|)
if|if
condition|(
name|addstr
argument_list|(
literal|"\\"
argument_list|,
literal|1
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|enospc
goto|;
if|if
condition|(
name|addstr
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|rdata
argument_list|,
literal|1
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|enospc
goto|;
name|rdata
operator|++
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|addstr
argument_list|(
literal|"\""
argument_list|,
literal|1
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|enospc
goto|;
return|return
operator|(
name|rdata
operator|-
name|odata
operator|)
return|;
name|enospc
label|:
name|errno
operator|=
name|ENOSPC
expr_stmt|;
operator|*
name|buf
operator|=
name|save_buf
expr_stmt|;
operator|*
name|buflen
operator|=
name|save_buflen
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|addname
parameter_list|(
specifier|const
name|u_char
modifier|*
name|msg
parameter_list|,
name|size_t
name|msglen
parameter_list|,
specifier|const
name|u_char
modifier|*
modifier|*
name|pp
parameter_list|,
specifier|const
name|char
modifier|*
name|origin
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buflen
parameter_list|)
block|{
name|size_t
name|newlen
decl_stmt|,
name|save_buflen
init|=
operator|*
name|buflen
decl_stmt|;
name|char
modifier|*
name|save_buf
init|=
operator|*
name|buf
decl_stmt|;
name|int
name|n
decl_stmt|;
name|n
operator|=
name|dn_expand
argument_list|(
name|msg
argument_list|,
name|msg
operator|+
name|msglen
argument_list|,
operator|*
name|pp
argument_list|,
operator|*
name|buf
argument_list|,
operator|*
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
goto|goto
name|enospc
goto|;
comment|/* Guess. */
name|newlen
operator|=
name|prune_origin
argument_list|(
operator|*
name|buf
argument_list|,
name|origin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|buf
operator|==
literal|'\0'
condition|)
block|{
goto|goto
name|root
goto|;
block|}
elseif|else
if|if
condition|(
name|newlen
operator|==
literal|0
condition|)
block|{
comment|/* Use "@" instead of name. */
if|if
condition|(
name|newlen
operator|+
literal|2
operator|>
operator|*
name|buflen
condition|)
goto|goto
name|enospc
goto|;
comment|/* No room for "@\0". */
operator|(
operator|*
name|buf
operator|)
index|[
name|newlen
operator|++
index|]
operator|=
literal|'@'
expr_stmt|;
operator|(
operator|*
name|buf
operator|)
index|[
name|newlen
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
operator|(
name|origin
operator|==
name|NULL
operator|||
name|origin
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|)
operator|||
operator|(
name|origin
index|[
literal|0
index|]
operator|!=
literal|'.'
operator|&&
name|origin
index|[
literal|1
index|]
operator|!=
literal|'\0'
operator|&&
operator|(
operator|*
name|buf
operator|)
index|[
name|newlen
index|]
operator|==
literal|'\0'
operator|)
operator|)
operator|&&
operator|(
operator|*
name|buf
operator|)
index|[
name|newlen
operator|-
literal|1
index|]
operator|!=
literal|'.'
condition|)
block|{
comment|/* No trailing dot. */
name|root
label|:
if|if
condition|(
name|newlen
operator|+
literal|2
operator|>
operator|*
name|buflen
condition|)
goto|goto
name|enospc
goto|;
comment|/* No room for ".\0". */
operator|(
operator|*
name|buf
operator|)
index|[
name|newlen
operator|++
index|]
operator|=
literal|'.'
expr_stmt|;
operator|(
operator|*
name|buf
operator|)
index|[
name|newlen
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
operator|*
name|pp
operator|+=
name|n
expr_stmt|;
name|addlen
argument_list|(
name|newlen
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
operator|*
operator|*
name|buf
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|newlen
operator|)
return|;
name|enospc
label|:
name|errno
operator|=
name|ENOSPC
expr_stmt|;
operator|*
name|buf
operator|=
name|save_buf
expr_stmt|;
operator|*
name|buflen
operator|=
name|save_buflen
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|addlen
parameter_list|(
name|size_t
name|len
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buflen
parameter_list|)
block|{
name|INSIST
argument_list|(
name|len
operator|<=
operator|*
name|buflen
argument_list|)
expr_stmt|;
operator|*
name|buf
operator|+=
name|len
expr_stmt|;
operator|*
name|buflen
operator|-=
name|len
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|addstr
parameter_list|(
specifier|const
name|char
modifier|*
name|src
parameter_list|,
name|size_t
name|len
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buflen
parameter_list|)
block|{
if|if
condition|(
name|len
operator|>=
operator|*
name|buflen
condition|)
block|{
name|errno
operator|=
name|ENOSPC
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|memcpy
argument_list|(
operator|*
name|buf
argument_list|,
name|src
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|addlen
argument_list|(
name|len
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
operator|*
operator|*
name|buf
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|addtab
parameter_list|(
name|size_t
name|len
parameter_list|,
name|size_t
name|target
parameter_list|,
name|int
name|spaced
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buflen
parameter_list|)
block|{
name|size_t
name|save_buflen
init|=
operator|*
name|buflen
decl_stmt|;
name|char
modifier|*
name|save_buf
init|=
operator|*
name|buf
decl_stmt|;
name|int
name|t
decl_stmt|;
if|if
condition|(
name|spaced
operator|||
name|len
operator|>=
name|target
operator|-
literal|1
condition|)
block|{
name|T
argument_list|(
name|addstr
argument_list|(
literal|"  "
argument_list|,
literal|2
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
name|spaced
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|t
operator|=
operator|(
name|target
operator|-
name|len
operator|-
literal|1
operator|)
operator|/
literal|8
init|;
name|t
operator|>=
literal|0
condition|;
name|t
operator|--
control|)
if|if
condition|(
name|addstr
argument_list|(
literal|"\t"
argument_list|,
literal|1
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
operator|<
literal|0
condition|)
block|{
operator|*
name|buflen
operator|=
name|save_buflen
expr_stmt|;
operator|*
name|buf
operator|=
name|save_buf
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|spaced
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
name|spaced
operator|)
return|;
block|}
end_function

end_unit


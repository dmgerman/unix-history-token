begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000-2002 by Solar Designer. See LICENSE.  */
end_comment

begin_define
define|#
directive|define
name|_XOPEN_SOURCE
value|500
end_define

begin_define
define|#
directive|define
name|_XOPEN_SOURCE_EXTENDED
end_define

begin_define
define|#
directive|define
name|_XOPEN_VERSION
value|500
end_define

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SHADOW
end_ifdef

begin_include
include|#
directive|include
file|<shadow.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|PAM_SM_PASSWORD
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|LINUX_PAM
end_ifndef

begin_include
include|#
directive|include
file|<security/pam_appl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<security/pam_modules.h>
end_include

begin_include
include|#
directive|include
file|"pam_macros.h"
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|PAM_EXTERN
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|PAM_STATIC
argument_list|)
end_if

begin_define
define|#
directive|define
name|PAM_EXTERN
value|extern
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|PAM_AUTHTOK_RECOVERY_ERR
argument_list|)
operator|&&
name|defined
argument_list|(
name|PAM_AUTHTOK_RECOVER_ERR
argument_list|)
end_if

begin_define
define|#
directive|define
name|PAM_AUTHTOK_RECOVERY_ERR
value|PAM_AUTHTOK_RECOVER_ERR
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__sun__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|LINUX_PAM
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|_OPENPAM
argument_list|)
end_if

begin_comment
comment|/* Sun's PAM doesn't use const here */
end_comment

begin_define
define|#
directive|define
name|lo_const
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|lo_const
value|const
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
name|lo_const
name|void
modifier|*
name|pam_item_t
typedef|;
end_typedef

begin_include
include|#
directive|include
file|"passwdqc.h"
end_include

begin_define
define|#
directive|define
name|F_ENFORCE_MASK
value|0x00000003
end_define

begin_define
define|#
directive|define
name|F_ENFORCE_USERS
value|0x00000001
end_define

begin_define
define|#
directive|define
name|F_ENFORCE_ROOT
value|0x00000002
end_define

begin_define
define|#
directive|define
name|F_ENFORCE_EVERYONE
value|F_ENFORCE_MASK
end_define

begin_define
define|#
directive|define
name|F_NON_UNIX
value|0x00000004
end_define

begin_define
define|#
directive|define
name|F_ASK_OLDAUTHTOK_MASK
value|0x00000030
end_define

begin_define
define|#
directive|define
name|F_ASK_OLDAUTHTOK_PRELIM
value|0x00000010
end_define

begin_define
define|#
directive|define
name|F_ASK_OLDAUTHTOK_UPDATE
value|0x00000020
end_define

begin_define
define|#
directive|define
name|F_CHECK_OLDAUTHTOK
value|0x00000040
end_define

begin_define
define|#
directive|define
name|F_USE_FIRST_PASS
value|0x00000100
end_define

begin_define
define|#
directive|define
name|F_USE_AUTHTOK
value|0x00000200
end_define

begin_typedef
typedef|typedef
struct|struct
block|{
name|passwdqc_params_t
name|qc
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|int
name|retry
decl_stmt|;
block|}
name|params_t
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|params_t
name|defaults
init|=
block|{
block|{
block|{
name|INT_MAX
block|,
literal|24
block|,
literal|12
block|,
literal|8
block|,
literal|7
block|}
block|,
comment|/* min */
literal|40
block|,
comment|/* max */
literal|3
block|,
comment|/* passphrase_words */
literal|4
block|,
comment|/* match_length */
literal|1
block|,
comment|/* similar_deny */
literal|42
comment|/* random_bits */
block|}
block|,
name|F_ENFORCE_EVERYONE
block|,
comment|/* flags */
literal|3
comment|/* retry */
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PROMPT_OLDPASS
define|\
value|"Enter current password: "
end_define

begin_define
define|#
directive|define
name|PROMPT_NEWPASS1
define|\
value|"Enter new password: "
end_define

begin_define
define|#
directive|define
name|PROMPT_NEWPASS2
define|\
value|"Re-type new password: "
end_define

begin_define
define|#
directive|define
name|MESSAGE_MISCONFIGURED
define|\
value|"System configuration error.  Please contact your administrator."
end_define

begin_define
define|#
directive|define
name|MESSAGE_INVALID_OPTION
define|\
value|"pam_passwdqc: Invalid option: \"%s\"."
end_define

begin_define
define|#
directive|define
name|MESSAGE_INTRO_PASSWORD
define|\
value|"\nYou can now choose the new password.\n"
end_define

begin_define
define|#
directive|define
name|MESSAGE_INTRO_BOTH
define|\
value|"\nYou can now choose the new password or passphrase.\n"
end_define

begin_define
define|#
directive|define
name|MESSAGE_EXPLAIN_PASSWORD_1
define|\
value|"A valid password should be a mix of upper and lower case letters,\n" \ 	"digits and other characters.  You can use a%s %d character long\n" \ 	"password with characters from at least 3 of these 4 classes.\n" \ 	"Characters that form a common pattern are discarded by the check.\n"
end_define

begin_define
define|#
directive|define
name|MESSAGE_EXPLAIN_PASSWORD_2
define|\
value|"A valid password should be a mix of upper and lower case letters,\n" \ 	"digits and other characters.  You can use a%s %d character long\n" \ 	"password with characters from at least 3 of these 4 classes, or\n" \ 	"a%s %d character long password containing characters from all the\n" \ 	"classes.  Characters that form a common pattern are discarded by\n" \ 	"the check.\n"
end_define

begin_define
define|#
directive|define
name|MESSAGE_EXPLAIN_PASSPHRASE
define|\
value|"A passphrase should be of at least %d words, %d to %d characters\n" \ 	"long and contain enough different characters.\n"
end_define

begin_define
define|#
directive|define
name|MESSAGE_RANDOM
define|\
value|"Alternatively, if noone else can see your terminal now, you can\n" \ 	"pick this as your password: \"%s\".\n"
end_define

begin_define
define|#
directive|define
name|MESSAGE_RANDOMONLY
define|\
value|"This system is configured to permit randomly generated passwords\n" \ 	"only.  If noone else can see your terminal now, you can pick this\n" \ 	"as your password: \"%s\".  Otherwise, come back later.\n"
end_define

begin_define
define|#
directive|define
name|MESSAGE_RANDOMFAILED
define|\
value|"This system is configured to use randomly generated passwords\n" \ 	"only, but the attempt to generate a password has failed.  This\n" \ 	"could happen for a number of reasons: you could have requested\n" \ 	"an impossible password length, or the access to kernel random\n" \ 	"number pool could have failed."
end_define

begin_define
define|#
directive|define
name|MESSAGE_TOOLONG
define|\
value|"This password may be too long for some services.  Choose another."
end_define

begin_define
define|#
directive|define
name|MESSAGE_TRUNCATED
define|\
value|"Warning: your longer password will be truncated to 8 characters."
end_define

begin_define
define|#
directive|define
name|MESSAGE_WEAKPASS
define|\
value|"Weak password: %s."
end_define

begin_define
define|#
directive|define
name|MESSAGE_NOTRANDOM
define|\
value|"Sorry, you've mistyped the password that was generated for you."
end_define

begin_define
define|#
directive|define
name|MESSAGE_MISTYPED
define|\
value|"Sorry, passwords do not match."
end_define

begin_define
define|#
directive|define
name|MESSAGE_RETRY
define|\
value|"Try again."
end_define

begin_function
specifier|static
name|int
name|converse
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|style
parameter_list|,
name|lo_const
name|char
modifier|*
name|text
parameter_list|,
name|struct
name|pam_response
modifier|*
modifier|*
name|resp
parameter_list|)
block|{
name|struct
name|pam_conv
modifier|*
name|conv
decl_stmt|;
name|struct
name|pam_message
name|msg
decl_stmt|,
modifier|*
name|pmsg
decl_stmt|;
name|int
name|status
decl_stmt|;
name|status
operator|=
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_CONV
argument_list|,
operator|(
name|pam_item_t
operator|*
operator|)
operator|&
name|conv
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|PAM_SUCCESS
condition|)
return|return
name|status
return|;
name|pmsg
operator|=
operator|&
name|msg
expr_stmt|;
name|msg
operator|.
name|msg_style
operator|=
name|style
expr_stmt|;
name|msg
operator|.
name|msg
operator|=
name|text
expr_stmt|;
operator|*
name|resp
operator|=
name|NULL
expr_stmt|;
return|return
name|conv
operator|->
name|conv
argument_list|(
literal|1
argument_list|,
operator|(
name|lo_const
expr|struct
name|pam_message
operator|*
operator|*
operator|)
operator|&
name|pmsg
argument_list|,
name|resp
argument_list|,
name|conv
operator|->
name|appdata_ptr
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|__GNUC__
end_ifdef

begin_macro
name|__attribute__
argument_list|(
argument|(format (printf,
literal|3
argument|,
literal|4
argument|))
argument_list|)
end_macro

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|say
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|style
parameter_list|,
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|char
name|buffer
index|[
literal|0x800
index|]
decl_stmt|;
name|int
name|needed
decl_stmt|;
name|struct
name|pam_response
modifier|*
name|resp
decl_stmt|;
name|int
name|status
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|needed
operator|=
name|vsnprintf
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|format
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|unsigned
name|int
operator|)
name|needed
operator|<
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
condition|)
block|{
name|status
operator|=
name|converse
argument_list|(
name|pamh
argument_list|,
name|style
argument_list|,
name|buffer
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|PAM_ABORT
expr_stmt|;
name|memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_max
parameter_list|(
name|params_t
modifier|*
name|params
parameter_list|,
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
specifier|const
name|char
modifier|*
name|newpass
parameter_list|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|newpass
argument_list|)
operator|>
name|params
operator|->
name|qc
operator|.
name|max
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|qc
operator|.
name|max
operator|!=
literal|8
condition|)
block|{
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_ERROR_MSG
argument_list|,
name|MESSAGE_TOOLONG
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_TEXT_INFO
argument_list|,
name|MESSAGE_TRUNCATED
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse
parameter_list|(
name|params_t
modifier|*
name|params
parameter_list|,
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
name|char
modifier|*
name|e
decl_stmt|;
name|int
name|i
decl_stmt|;
name|unsigned
name|long
name|v
decl_stmt|;
while|while
condition|(
name|argc
condition|)
block|{
if|if
condition|(
operator|!
name|strncmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"min="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|p
operator|=
operator|*
name|argv
operator|+
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|p
argument_list|,
literal|"disabled"
argument_list|,
literal|8
argument_list|)
condition|)
block|{
name|v
operator|=
name|INT_MAX
expr_stmt|;
name|p
operator|+=
literal|8
expr_stmt|;
block|}
else|else
block|{
name|v
operator|=
name|strtoul
argument_list|(
name|p
argument_list|,
operator|&
name|e
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|p
operator|=
name|e
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
literal|4
operator|&&
operator|*
name|p
operator|++
operator|!=
literal|','
condition|)
break|break;
if|if
condition|(
name|v
operator|>
name|INT_MAX
condition|)
break|break;
if|if
condition|(
name|i
operator|&&
operator|(
name|int
operator|)
name|v
operator|>
name|params
operator|->
name|qc
operator|.
name|min
index|[
name|i
operator|-
literal|1
index|]
condition|)
break|break;
name|params
operator|->
name|qc
operator|.
name|min
index|[
name|i
index|]
operator|=
name|v
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p
condition|)
break|break;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"max="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|v
operator|=
name|strtoul
argument_list|(
operator|*
name|argv
operator|+
literal|4
argument_list|,
operator|&
name|e
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|e
operator|||
name|v
operator|<
literal|8
operator|||
name|v
operator|>
name|INT_MAX
condition|)
break|break;
name|params
operator|->
name|qc
operator|.
name|max
operator|=
name|v
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"passphrase="
argument_list|,
literal|11
argument_list|)
condition|)
block|{
name|v
operator|=
name|strtoul
argument_list|(
operator|*
name|argv
operator|+
literal|11
argument_list|,
operator|&
name|e
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|e
operator|||
name|v
operator|>
name|INT_MAX
condition|)
break|break;
name|params
operator|->
name|qc
operator|.
name|passphrase_words
operator|=
name|v
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"match="
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|v
operator|=
name|strtoul
argument_list|(
operator|*
name|argv
operator|+
literal|6
argument_list|,
operator|&
name|e
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|e
operator|||
name|v
operator|>
name|INT_MAX
condition|)
break|break;
name|params
operator|->
name|qc
operator|.
name|match_length
operator|=
name|v
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"similar="
argument_list|,
literal|8
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
operator|+
literal|8
argument_list|,
literal|"permit"
argument_list|)
condition|)
name|params
operator|->
name|qc
operator|.
name|similar_deny
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
operator|+
literal|8
argument_list|,
literal|"deny"
argument_list|)
condition|)
name|params
operator|->
name|qc
operator|.
name|similar_deny
operator|=
literal|1
expr_stmt|;
else|else
break|break;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"random="
argument_list|,
literal|7
argument_list|)
condition|)
block|{
name|v
operator|=
name|strtoul
argument_list|(
operator|*
name|argv
operator|+
literal|7
argument_list|,
operator|&
name|e
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|e
argument_list|,
literal|",only"
argument_list|)
condition|)
block|{
name|e
operator|+=
literal|5
expr_stmt|;
name|params
operator|->
name|qc
operator|.
name|min
index|[
literal|4
index|]
operator|=
name|INT_MAX
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|e
operator|||
name|v
operator|>
name|INT_MAX
condition|)
break|break;
name|params
operator|->
name|qc
operator|.
name|random_bits
operator|=
name|v
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"enforce="
argument_list|,
literal|8
argument_list|)
condition|)
block|{
name|params
operator|->
name|flags
operator|&=
operator|~
name|F_ENFORCE_MASK
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
operator|+
literal|8
argument_list|,
literal|"users"
argument_list|)
condition|)
name|params
operator|->
name|flags
operator||=
name|F_ENFORCE_USERS
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
operator|+
literal|8
argument_list|,
literal|"everyone"
argument_list|)
condition|)
name|params
operator|->
name|flags
operator||=
name|F_ENFORCE_EVERYONE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
operator|+
literal|8
argument_list|,
literal|"none"
argument_list|)
condition|)
break|break;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"non-unix"
argument_list|)
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|F_CHECK_OLDAUTHTOK
condition|)
break|break;
name|params
operator|->
name|flags
operator||=
name|F_NON_UNIX
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"retry="
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|v
operator|=
name|strtoul
argument_list|(
operator|*
name|argv
operator|+
literal|6
argument_list|,
operator|&
name|e
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|e
operator|||
name|v
operator|>
name|INT_MAX
condition|)
break|break;
name|params
operator|->
name|retry
operator|=
name|v
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"ask_oldauthtok"
argument_list|,
literal|14
argument_list|)
condition|)
block|{
name|params
operator|->
name|flags
operator|&=
operator|~
name|F_ASK_OLDAUTHTOK_MASK
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|F_USE_FIRST_PASS
condition|)
break|break;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
operator|+
literal|14
argument_list|,
literal|"=update"
argument_list|)
condition|)
name|params
operator|->
name|flags
operator||=
name|F_ASK_OLDAUTHTOK_UPDATE
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
operator|(
operator|*
name|argv
operator|)
index|[
literal|14
index|]
condition|)
name|params
operator|->
name|flags
operator||=
name|F_ASK_OLDAUTHTOK_PRELIM
expr_stmt|;
else|else
break|break;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"check_oldauthtok"
argument_list|)
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|F_NON_UNIX
condition|)
break|break;
name|params
operator|->
name|flags
operator||=
name|F_CHECK_OLDAUTHTOK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"use_first_pass"
argument_list|)
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|F_ASK_OLDAUTHTOK_MASK
condition|)
break|break;
name|params
operator|->
name|flags
operator||=
name|F_USE_FIRST_PASS
operator||
name|F_USE_AUTHTOK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"use_authtok"
argument_list|)
condition|)
block|{
name|params
operator|->
name|flags
operator||=
name|F_USE_AUTHTOK
expr_stmt|;
block|}
else|else
break|break;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|argc
condition|)
block|{
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_ERROR_MSG
argument_list|,
name|getuid
argument_list|()
operator|!=
literal|0
condition|?
name|MESSAGE_MISCONFIGURED
else|:
name|MESSAGE_INVALID_OPTION
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
return|return
name|PAM_ABORT
return|;
block|}
return|return
name|PAM_SUCCESS
return|;
block|}
end_function

begin_function
name|PAM_EXTERN
name|int
name|pam_sm_chauthtok
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|params_t
name|params
decl_stmt|;
name|struct
name|pam_response
modifier|*
name|resp
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|,
name|fake_pw
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SHADOW
name|struct
name|spwd
modifier|*
name|spw
decl_stmt|;
endif|#
directive|endif
name|char
modifier|*
name|user
decl_stmt|,
modifier|*
name|oldpass
decl_stmt|,
modifier|*
name|newpass
decl_stmt|,
modifier|*
name|randompass
decl_stmt|;
specifier|const
name|char
modifier|*
name|reason
decl_stmt|;
name|int
name|ask_oldauthtok
decl_stmt|;
name|int
name|randomonly
decl_stmt|,
name|enforce
decl_stmt|,
name|retries_left
decl_stmt|,
name|retry_wanted
decl_stmt|;
name|int
name|status
decl_stmt|;
name|params
operator|=
name|defaults
expr_stmt|;
name|status
operator|=
name|parse
argument_list|(
operator|&
name|params
argument_list|,
name|pamh
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|PAM_SUCCESS
condition|)
return|return
name|status
return|;
name|ask_oldauthtok
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|PAM_PRELIM_CHECK
condition|)
block|{
if|if
condition|(
name|params
operator|.
name|flags
operator|&
name|F_ASK_OLDAUTHTOK_PRELIM
condition|)
name|ask_oldauthtok
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flags
operator|&
name|PAM_UPDATE_AUTHTOK
condition|)
block|{
if|if
condition|(
name|params
operator|.
name|flags
operator|&
name|F_ASK_OLDAUTHTOK_UPDATE
condition|)
name|ask_oldauthtok
operator|=
literal|1
expr_stmt|;
block|}
else|else
return|return
name|PAM_SERVICE_ERR
return|;
if|if
condition|(
name|ask_oldauthtok
operator|&&
name|getuid
argument_list|()
operator|!=
literal|0
condition|)
block|{
name|status
operator|=
name|converse
argument_list|(
name|pamh
argument_list|,
name|PAM_PROMPT_ECHO_OFF
argument_list|,
name|PROMPT_OLDPASS
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|PAM_SUCCESS
condition|)
block|{
if|if
condition|(
name|resp
operator|&&
name|resp
operator|->
name|resp
condition|)
block|{
name|status
operator|=
name|pam_set_item
argument_list|(
name|pamh
argument_list|,
name|PAM_OLDAUTHTOK
argument_list|,
name|resp
operator|->
name|resp
argument_list|)
expr_stmt|;
name|_pam_drop_reply
argument_list|(
name|resp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|status
operator|=
name|PAM_AUTHTOK_RECOVERY_ERR
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|PAM_SUCCESS
condition|)
return|return
name|status
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|PAM_PRELIM_CHECK
condition|)
return|return
name|status
return|;
name|status
operator|=
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
operator|(
name|pam_item_t
operator|*
operator|)
operator|&
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|PAM_SUCCESS
condition|)
return|return
name|status
return|;
name|status
operator|=
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_OLDAUTHTOK
argument_list|,
operator|(
name|pam_item_t
operator|*
operator|)
operator|&
name|oldpass
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|PAM_SUCCESS
condition|)
return|return
name|status
return|;
if|if
condition|(
name|params
operator|.
name|flags
operator|&
name|F_NON_UNIX
condition|)
block|{
name|pw
operator|=
operator|&
name|fake_pw
expr_stmt|;
name|pw
operator|->
name|pw_name
operator|=
name|user
expr_stmt|;
name|pw
operator|->
name|pw_gecos
operator|=
literal|""
expr_stmt|;
block|}
else|else
block|{
name|pw
operator|=
name|getpwnam
argument_list|(
name|user
argument_list|)
expr_stmt|;
name|endpwent
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|pw
condition|)
return|return
name|PAM_USER_UNKNOWN
return|;
if|if
condition|(
operator|(
name|params
operator|.
name|flags
operator|&
name|F_CHECK_OLDAUTHTOK
operator|)
operator|&&
name|getuid
argument_list|()
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|oldpass
condition|)
name|status
operator|=
name|PAM_AUTH_ERR
expr_stmt|;
elseif|else
ifdef|#
directive|ifdef
name|HAVE_SHADOW
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|pw
operator|->
name|pw_passwd
argument_list|,
literal|"x"
argument_list|)
condition|)
block|{
name|spw
operator|=
name|getspnam
argument_list|(
name|user
argument_list|)
expr_stmt|;
name|endspent
argument_list|()
expr_stmt|;
if|if
condition|(
name|spw
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|crypt
argument_list|(
name|oldpass
argument_list|,
name|spw
operator|->
name|sp_pwdp
argument_list|)
argument_list|,
name|spw
operator|->
name|sp_pwdp
argument_list|)
condition|)
name|status
operator|=
name|PAM_AUTH_ERR
expr_stmt|;
name|memset
argument_list|(
name|spw
operator|->
name|sp_pwdp
argument_list|,
literal|0
argument_list|,
name|strlen
argument_list|(
name|spw
operator|->
name|sp_pwdp
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|status
operator|=
name|PAM_AUTH_ERR
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
if|if
condition|(
name|strcmp
argument_list|(
name|crypt
argument_list|(
name|oldpass
argument_list|,
name|pw
operator|->
name|pw_passwd
argument_list|)
argument_list|,
name|pw
operator|->
name|pw_passwd
argument_list|)
condition|)
name|status
operator|=
name|PAM_AUTH_ERR
expr_stmt|;
block|}
name|memset
argument_list|(
name|pw
operator|->
name|pw_passwd
argument_list|,
literal|0
argument_list|,
name|strlen
argument_list|(
name|pw
operator|->
name|pw_passwd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|PAM_SUCCESS
condition|)
return|return
name|status
return|;
block|}
name|randomonly
operator|=
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|4
index|]
operator|>
name|params
operator|.
name|qc
operator|.
name|max
expr_stmt|;
if|if
condition|(
name|getuid
argument_list|()
operator|!=
literal|0
condition|)
name|enforce
operator|=
name|params
operator|.
name|flags
operator|&
name|F_ENFORCE_USERS
expr_stmt|;
else|else
name|enforce
operator|=
name|params
operator|.
name|flags
operator|&
name|F_ENFORCE_ROOT
expr_stmt|;
if|if
condition|(
name|params
operator|.
name|flags
operator|&
name|F_USE_AUTHTOK
condition|)
block|{
name|status
operator|=
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
operator|(
name|pam_item_t
operator|*
operator|)
operator|&
name|newpass
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|PAM_SUCCESS
condition|)
return|return
name|status
return|;
if|if
condition|(
operator|!
name|newpass
operator|||
operator|(
name|check_max
argument_list|(
operator|&
name|params
argument_list|,
name|pamh
argument_list|,
name|newpass
argument_list|)
operator|&&
name|enforce
operator|)
condition|)
return|return
name|PAM_AUTHTOK_RECOVERY_ERR
return|;
name|reason
operator|=
name|_passwdqc_check
argument_list|(
operator|&
name|params
operator|.
name|qc
argument_list|,
name|newpass
argument_list|,
name|oldpass
argument_list|,
name|pw
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason
condition|)
block|{
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_ERROR_MSG
argument_list|,
name|MESSAGE_WEAKPASS
argument_list|,
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|enforce
condition|)
name|status
operator|=
name|PAM_AUTHTOK_RECOVERY_ERR
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
name|retries_left
operator|=
name|params
operator|.
name|retry
expr_stmt|;
name|retry
label|:
name|retry_wanted
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|randomonly
operator|&&
name|params
operator|.
name|qc
operator|.
name|passphrase_words
operator|&&
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|2
index|]
operator|<=
name|params
operator|.
name|qc
operator|.
name|max
condition|)
name|status
operator|=
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_TEXT_INFO
argument_list|,
name|MESSAGE_INTRO_BOTH
argument_list|)
expr_stmt|;
else|else
name|status
operator|=
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_TEXT_INFO
argument_list|,
name|MESSAGE_INTRO_PASSWORD
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|PAM_SUCCESS
condition|)
return|return
name|status
return|;
if|if
condition|(
operator|!
name|randomonly
operator|&&
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|3
index|]
operator|<=
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|4
index|]
condition|)
name|status
operator|=
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_TEXT_INFO
argument_list|,
name|MESSAGE_EXPLAIN_PASSWORD_1
argument_list|,
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|3
index|]
operator|==
literal|8
operator|||
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|3
index|]
operator|==
literal|11
condition|?
literal|"n"
else|:
literal|""
argument_list|,
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|randomonly
condition|)
name|status
operator|=
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_TEXT_INFO
argument_list|,
name|MESSAGE_EXPLAIN_PASSWORD_2
argument_list|,
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|3
index|]
operator|==
literal|8
operator|||
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|3
index|]
operator|==
literal|11
condition|?
literal|"n"
else|:
literal|""
argument_list|,
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|3
index|]
argument_list|,
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|4
index|]
operator|==
literal|8
operator|||
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|4
index|]
operator|==
literal|11
condition|?
literal|"n"
else|:
literal|""
argument_list|,
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|PAM_SUCCESS
condition|)
return|return
name|status
return|;
if|if
condition|(
operator|!
name|randomonly
operator|&&
name|params
operator|.
name|qc
operator|.
name|passphrase_words
operator|&&
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|2
index|]
operator|<=
name|params
operator|.
name|qc
operator|.
name|max
condition|)
block|{
name|status
operator|=
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_TEXT_INFO
argument_list|,
name|MESSAGE_EXPLAIN_PASSPHRASE
argument_list|,
name|params
operator|.
name|qc
operator|.
name|passphrase_words
argument_list|,
name|params
operator|.
name|qc
operator|.
name|min
index|[
literal|2
index|]
argument_list|,
name|params
operator|.
name|qc
operator|.
name|max
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|PAM_SUCCESS
condition|)
return|return
name|status
return|;
block|}
name|randompass
operator|=
name|_passwdqc_random
argument_list|(
operator|&
name|params
operator|.
name|qc
argument_list|)
expr_stmt|;
if|if
condition|(
name|randompass
condition|)
block|{
name|status
operator|=
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_TEXT_INFO
argument_list|,
name|randomonly
condition|?
name|MESSAGE_RANDOMONLY
else|:
name|MESSAGE_RANDOM
argument_list|,
name|randompass
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|_pam_overwrite
argument_list|(
name|randompass
argument_list|)
expr_stmt|;
name|randompass
operator|=
name|NULL
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|randomonly
condition|)
block|{
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_ERROR_MSG
argument_list|,
name|getuid
argument_list|()
operator|!=
literal|0
condition|?
name|MESSAGE_MISCONFIGURED
else|:
name|MESSAGE_RANDOMFAILED
argument_list|)
expr_stmt|;
return|return
name|PAM_AUTHTOK_RECOVERY_ERR
return|;
block|}
name|status
operator|=
name|converse
argument_list|(
name|pamh
argument_list|,
name|PAM_PROMPT_ECHO_OFF
argument_list|,
name|PROMPT_NEWPASS1
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|PAM_SUCCESS
operator|&&
operator|(
operator|!
name|resp
operator|||
operator|!
name|resp
operator|->
name|resp
operator|)
condition|)
name|status
operator|=
name|PAM_AUTHTOK_RECOVERY_ERR
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|PAM_SUCCESS
condition|)
block|{
if|if
condition|(
name|randompass
condition|)
name|_pam_overwrite
argument_list|(
name|randompass
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|newpass
operator|=
name|strdup
argument_list|(
name|resp
operator|->
name|resp
argument_list|)
expr_stmt|;
name|_pam_drop_reply
argument_list|(
name|resp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|newpass
condition|)
block|{
if|if
condition|(
name|randompass
condition|)
name|_pam_overwrite
argument_list|(
name|randompass
argument_list|)
expr_stmt|;
return|return
name|PAM_AUTHTOK_RECOVERY_ERR
return|;
block|}
if|if
condition|(
name|check_max
argument_list|(
operator|&
name|params
argument_list|,
name|pamh
argument_list|,
name|newpass
argument_list|)
operator|&&
name|enforce
condition|)
block|{
name|status
operator|=
name|PAM_AUTHTOK_RECOVERY_ERR
expr_stmt|;
name|retry_wanted
operator|=
literal|1
expr_stmt|;
block|}
name|reason
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|PAM_SUCCESS
operator|&&
operator|(
operator|!
name|randompass
operator|||
operator|!
name|strstr
argument_list|(
name|newpass
argument_list|,
name|randompass
argument_list|)
operator|)
operator|&&
operator|(
name|randomonly
operator|||
operator|(
name|reason
operator|=
name|_passwdqc_check
argument_list|(
operator|&
name|params
operator|.
name|qc
argument_list|,
name|newpass
argument_list|,
name|oldpass
argument_list|,
name|pw
argument_list|)
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|randomonly
condition|)
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_ERROR_MSG
argument_list|,
name|MESSAGE_NOTRANDOM
argument_list|)
expr_stmt|;
else|else
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_ERROR_MSG
argument_list|,
name|MESSAGE_WEAKPASS
argument_list|,
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|enforce
condition|)
block|{
name|status
operator|=
name|PAM_AUTHTOK_RECOVERY_ERR
expr_stmt|;
name|retry_wanted
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|status
operator|==
name|PAM_SUCCESS
condition|)
name|status
operator|=
name|converse
argument_list|(
name|pamh
argument_list|,
name|PAM_PROMPT_ECHO_OFF
argument_list|,
name|PROMPT_NEWPASS2
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|PAM_SUCCESS
condition|)
block|{
if|if
condition|(
name|resp
operator|&&
name|resp
operator|->
name|resp
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|newpass
argument_list|,
name|resp
operator|->
name|resp
argument_list|)
condition|)
block|{
name|status
operator|=
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_ERROR_MSG
argument_list|,
name|MESSAGE_MISTYPED
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|PAM_SUCCESS
condition|)
block|{
name|status
operator|=
name|PAM_AUTHTOK_RECOVERY_ERR
expr_stmt|;
name|retry_wanted
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|_pam_drop_reply
argument_list|(
name|resp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|status
operator|=
name|PAM_AUTHTOK_RECOVERY_ERR
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|PAM_SUCCESS
condition|)
name|status
operator|=
name|pam_set_item
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
name|newpass
argument_list|)
expr_stmt|;
if|if
condition|(
name|randompass
condition|)
name|_pam_overwrite
argument_list|(
name|randompass
argument_list|)
expr_stmt|;
name|_pam_overwrite
argument_list|(
name|newpass
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newpass
argument_list|)
expr_stmt|;
if|if
condition|(
name|retry_wanted
operator|&&
operator|--
name|retries_left
operator|>
literal|0
condition|)
block|{
name|status
operator|=
name|say
argument_list|(
name|pamh
argument_list|,
name|PAM_TEXT_INFO
argument_list|,
name|MESSAGE_RETRY
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|PAM_SUCCESS
condition|)
goto|goto
name|retry
goto|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PAM_MODULE_ENTRY
end_ifdef

begin_expr_stmt
name|PAM_MODULE_ENTRY
argument_list|(
literal|"pam_passwdqc"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|PAM_STATIC
argument_list|)
end_elif

begin_decl_stmt
name|struct
name|pam_module
name|_pam_passwdqc_modstruct
init|=
block|{
literal|"pam_passwdqc"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|pam_sm_chauthtok
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


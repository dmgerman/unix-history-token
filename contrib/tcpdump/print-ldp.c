begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code  * distributions retain the above copyright notice and this paragraph  * in its entirety, and (2) distributions including binary code include  * the above copyright notice and this paragraph in its entirety in  * the documentation or other materials provided with the distribution.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND  * WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, WITHOUT  * LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE.  *  * Original code by Hannes Gredler (hannes@juniper.net)  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
name|_U_
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-ldp.c,v 1.4.2.2 2003/11/16 08:51:31 guy Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_comment
comment|/*  * ldp common header  *  *  0                   1                   2                   3  *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |  Version                      |         PDU Length            |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                         LDP Identifier                        |  * +                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                               |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  *  */
end_comment

begin_struct
struct|struct
name|ldp_common_header
block|{
name|u_int8_t
name|version
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|pdu_length
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|lsr_id
index|[
literal|4
index|]
decl_stmt|;
name|u_int8_t
name|label_space
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|LDP_VERSION
value|1
end_define

begin_comment
comment|/*  * ldp message header  *  *  0                   1                   2                   3  *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |U|   Message Type              |      Message Length           |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                     Message ID                                |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                                                               |  * +                                                               +  * |                     Mandatory Parameters                      |  * +                                                               +  * |                                                               |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                                                               |  * +                                                               +  * |                     Optional Parameters                       |  * +                                                               +  * |                                                               |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  */
end_comment

begin_struct
struct|struct
name|ldp_msg_header
block|{
name|u_int8_t
name|type
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|length
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|id
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|LDP_MASK_MSG_TYPE
parameter_list|(
name|x
parameter_list|)
value|((x)&0x7fff)
end_define

begin_define
define|#
directive|define
name|LDP_MASK_U_BIT
parameter_list|(
name|x
parameter_list|)
value|((x)&0x8000)
end_define

begin_define
define|#
directive|define
name|LDP_MSG_NOTIF
value|0x0001
end_define

begin_define
define|#
directive|define
name|LDP_MSG_HELLO
value|0x0100
end_define

begin_define
define|#
directive|define
name|LDP_MSG_INIT
value|0x0200
end_define

begin_define
define|#
directive|define
name|LDP_MSG_KEEPALIVE
value|0x0201
end_define

begin_define
define|#
directive|define
name|LDP_MSG_ADDRESS
value|0x0300
end_define

begin_define
define|#
directive|define
name|LDP_MSG_ADDRESS_WITHDRAW
value|0x0301
end_define

begin_define
define|#
directive|define
name|LDP_MSG_LABEL_MAPPING
value|0x0400
end_define

begin_define
define|#
directive|define
name|LDP_MSG_LABEL_REQUEST
value|0x0401
end_define

begin_define
define|#
directive|define
name|LDP_MSG_LABEL_WITHDRAW
value|0x0402
end_define

begin_define
define|#
directive|define
name|LDP_MSG_LABEL_RELEASE
value|0x0403
end_define

begin_define
define|#
directive|define
name|LDP_MSG_LABEL_ABORT_REQUEST
value|0x0404
end_define

begin_define
define|#
directive|define
name|LDP_VENDOR_PRIVATE_MIN
value|0x3e00
end_define

begin_define
define|#
directive|define
name|LDP_VENDOR_PRIVATE_MAX
value|0x3eff
end_define

begin_define
define|#
directive|define
name|LDP_EXPERIMENTAL_MIN
value|0x3f00
end_define

begin_define
define|#
directive|define
name|LDP_EXPERIMENTAL_MAX
value|0x3fff
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|ldp_msg_values
index|[]
init|=
block|{
block|{
name|LDP_MSG_NOTIF
block|,
literal|"Notification"
block|}
block|,
block|{
name|LDP_MSG_HELLO
block|,
literal|"Hello"
block|}
block|,
block|{
name|LDP_MSG_INIT
block|,
literal|"Initialization"
block|}
block|,
block|{
name|LDP_MSG_KEEPALIVE
block|,
literal|"Keepalive"
block|}
block|,
block|{
name|LDP_MSG_ADDRESS
block|,
literal|"Address"
block|}
block|,
block|{
name|LDP_MSG_ADDRESS_WITHDRAW
block|,
literal|"Address Widthdraw"
block|}
block|,
block|{
name|LDP_MSG_LABEL_MAPPING
block|,
literal|"Label Mapping"
block|}
block|,
block|{
name|LDP_MSG_LABEL_REQUEST
block|,
literal|"Label Request"
block|}
block|,
block|{
name|LDP_MSG_LABEL_WITHDRAW
block|,
literal|"Label Withdraw"
block|}
block|,
block|{
name|LDP_MSG_LABEL_RELEASE
block|,
literal|"Label Release"
block|}
block|,
block|{
name|LDP_MSG_LABEL_ABORT_REQUEST
block|,
literal|"Label Abort Request"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|LDP_MASK_TLV_TYPE
parameter_list|(
name|x
parameter_list|)
value|((x)&0x3fff)
end_define

begin_define
define|#
directive|define
name|LDP_MASK_F_BIT
parameter_list|(
name|x
parameter_list|)
value|((x)&0x4000)
end_define

begin_define
define|#
directive|define
name|LDP_TLV_FEC
value|0x0100
end_define

begin_define
define|#
directive|define
name|LDP_TLV_ADDRESS_LIST
value|0x0101
end_define

begin_define
define|#
directive|define
name|LDP_TLV_HOP_COUNT
value|0x0103
end_define

begin_define
define|#
directive|define
name|LDP_TLV_PATH_VECTOR
value|0x0104
end_define

begin_define
define|#
directive|define
name|LDP_TLV_GENERIC_LABEL
value|0x0200
end_define

begin_define
define|#
directive|define
name|LDP_TLV_ATM_LABEL
value|0x0201
end_define

begin_define
define|#
directive|define
name|LDP_TLV_FR_LABEL
value|0x0202
end_define

begin_define
define|#
directive|define
name|LDP_TLV_STATUS
value|0x0300
end_define

begin_define
define|#
directive|define
name|LDP_TLV_EXTD_STATUS
value|0x0301
end_define

begin_define
define|#
directive|define
name|LDP_TLV_RETURNED_PDU
value|0x0302
end_define

begin_define
define|#
directive|define
name|LDP_TLV_RETURNED_MSG
value|0x0303
end_define

begin_define
define|#
directive|define
name|LDP_TLV_COMMON_HELLO
value|0x0400
end_define

begin_define
define|#
directive|define
name|LDP_TLV_IPV4_TRANSPORT_ADDR
value|0x0401
end_define

begin_define
define|#
directive|define
name|LDP_TLV_CONFIG_SEQ_NUMBER
value|0x0402
end_define

begin_define
define|#
directive|define
name|LDP_TLV_IPV6_TRANSPORT_ADDR
value|0x0403
end_define

begin_define
define|#
directive|define
name|LDP_TLV_COMMON_SESSION
value|0x0500
end_define

begin_define
define|#
directive|define
name|LDP_TLV_ATM_SESSION_PARM
value|0x0501
end_define

begin_define
define|#
directive|define
name|LDP_TLV_FR_SESSION_PARM
value|0x0502
end_define

begin_define
define|#
directive|define
name|LDP_TLV_LABEL_REQUEST_MSG_ID
value|0x0600
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|ldp_tlv_values
index|[]
init|=
block|{
block|{
name|LDP_TLV_FEC
block|,
literal|"FEC"
block|}
block|,
block|{
name|LDP_TLV_ADDRESS_LIST
block|,
literal|"Address List"
block|}
block|,
block|{
name|LDP_TLV_HOP_COUNT
block|,
literal|"Hop Count"
block|}
block|,
block|{
name|LDP_TLV_PATH_VECTOR
block|,
literal|"Path Vector"
block|}
block|,
block|{
name|LDP_TLV_GENERIC_LABEL
block|,
literal|"Generic Label"
block|}
block|,
block|{
name|LDP_TLV_ATM_LABEL
block|,
literal|"ATM Label"
block|}
block|,
block|{
name|LDP_TLV_FR_LABEL
block|,
literal|"Frame-Relay Label"
block|}
block|,
block|{
name|LDP_TLV_STATUS
block|,
literal|"Status"
block|}
block|,
block|{
name|LDP_TLV_EXTD_STATUS
block|,
literal|"Extended Status"
block|}
block|,
block|{
name|LDP_TLV_RETURNED_PDU
block|,
literal|"Returned PDU"
block|}
block|,
block|{
name|LDP_TLV_RETURNED_MSG
block|,
literal|"Returned Message"
block|}
block|,
block|{
name|LDP_TLV_COMMON_HELLO
block|,
literal|"Common Hello Parameters"
block|}
block|,
block|{
name|LDP_TLV_IPV4_TRANSPORT_ADDR
block|,
literal|"IPv4 Transport Address"
block|}
block|,
block|{
name|LDP_TLV_CONFIG_SEQ_NUMBER
block|,
literal|"Configuration Sequence Number"
block|}
block|,
block|{
name|LDP_TLV_IPV6_TRANSPORT_ADDR
block|,
literal|"IPv6 Transport Address"
block|}
block|,
block|{
name|LDP_TLV_COMMON_SESSION
block|,
literal|"Common Session Parameters"
block|}
block|,
block|{
name|LDP_TLV_ATM_SESSION_PARM
block|,
literal|"ATM Session Parameters"
block|}
block|,
block|{
name|LDP_TLV_FR_SESSION_PARM
block|,
literal|"Frame-Relay Session Parameters"
block|}
block|,
block|{
name|LDP_TLV_LABEL_REQUEST_MSG_ID
block|,
literal|"Label Request Message ID"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|FALSE
value|0
end_define

begin_define
define|#
directive|define
name|TRUE
value|1
end_define

begin_function_decl
name|int
name|ldp_tlv_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*   * ldp tlv header  *  *  0                   1                   2                   3  *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |U|F|        Type               |            Length             |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                                                               |  * |                             Value                             |  * ~                                                               ~  * |                                                               |  * |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                               |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  */
end_comment

begin_function
name|int
name|ldp_tlv_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|tptr
parameter_list|)
block|{
struct|struct
name|ldp_tlv_header
block|{
name|u_int8_t
name|type
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|length
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
specifier|const
name|struct
name|ldp_tlv_header
modifier|*
name|ldp_tlv_header
decl_stmt|;
name|u_short
name|tlv_type
decl_stmt|,
name|tlv_len
decl_stmt|,
name|tlv_tlen
decl_stmt|;
name|ldp_tlv_header
operator|=
operator|(
specifier|const
expr|struct
name|ldp_tlv_header
operator|*
operator|)
name|tptr
expr_stmt|;
name|tlv_len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|ldp_tlv_header
operator|->
name|length
argument_list|)
expr_stmt|;
name|tlv_tlen
operator|=
name|tlv_len
expr_stmt|;
name|tlv_type
operator|=
name|LDP_MASK_TLV_TYPE
argument_list|(
name|EXTRACT_16BITS
argument_list|(
name|ldp_tlv_header
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
comment|/* FIXME vendor private / experimental check */
name|printf
argument_list|(
literal|"\n\t    %s TLV (0x%04x), length: %u, Flags: [%s and %s forward if unknown]"
argument_list|,
name|tok2str
argument_list|(
name|ldp_tlv_values
argument_list|,
literal|"Unknown"
argument_list|,
name|tlv_type
argument_list|)
argument_list|,
name|tlv_type
argument_list|,
name|tlv_len
argument_list|,
name|LDP_MASK_U_BIT
argument_list|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ldp_tlv_header
operator|->
name|type
argument_list|)
argument_list|)
condition|?
literal|"continue processing"
else|:
literal|"ignore"
argument_list|,
name|LDP_MASK_F_BIT
argument_list|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ldp_tlv_header
operator|->
name|type
argument_list|)
argument_list|)
condition|?
literal|"do"
else|:
literal|"don't"
argument_list|)
expr_stmt|;
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ldp_tlv_header
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|tlv_type
condition|)
block|{
case|case
name|LDP_TLV_COMMON_HELLO
case|:
name|printf
argument_list|(
literal|"\n\t      Hold Time: %us, Flags: [%s Hello%s]"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
argument_list|,
operator|(
name|EXTRACT_16BITS
argument_list|(
name|tptr
operator|+
literal|2
argument_list|)
operator|&
literal|0x8000
operator|)
condition|?
literal|"Targeted"
else|:
literal|"Link"
argument_list|,
operator|(
name|EXTRACT_16BITS
argument_list|(
name|tptr
operator|+
literal|2
argument_list|)
operator|&
literal|0x4000
operator|)
condition|?
literal|", Request for targeted Hellos"
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|LDP_TLV_IPV4_TRANSPORT_ADDR
case|:
name|printf
argument_list|(
literal|"\n\t      IPv4 Transport Address: %s"
argument_list|,
name|ipaddr_string
argument_list|(
name|tptr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|LDP_TLV_IPV6_TRANSPORT_ADDR
case|:
name|printf
argument_list|(
literal|"\n\t      IPv6 Transport Address: %s"
argument_list|,
name|ip6addr_string
argument_list|(
name|tptr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|LDP_TLV_CONFIG_SEQ_NUMBER
case|:
name|printf
argument_list|(
literal|"\n\t      Sequence Number: %u"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
comment|/*      *  FIXME those are the defined TLVs that lack a decoder      *  you are welcome to contribute code ;-)      */
case|case
name|LDP_TLV_FEC
case|:
case|case
name|LDP_TLV_ADDRESS_LIST
case|:
case|case
name|LDP_TLV_HOP_COUNT
case|:
case|case
name|LDP_TLV_PATH_VECTOR
case|:
case|case
name|LDP_TLV_GENERIC_LABEL
case|:
case|case
name|LDP_TLV_ATM_LABEL
case|:
case|case
name|LDP_TLV_FR_LABEL
case|:
case|case
name|LDP_TLV_STATUS
case|:
case|case
name|LDP_TLV_EXTD_STATUS
case|:
case|case
name|LDP_TLV_RETURNED_PDU
case|:
case|case
name|LDP_TLV_RETURNED_MSG
case|:
case|case
name|LDP_TLV_COMMON_SESSION
case|:
case|case
name|LDP_TLV_ATM_SESSION_PARM
case|:
case|case
name|LDP_TLV_FR_SESSION_PARM
case|:
case|case
name|LDP_TLV_LABEL_REQUEST_MSG_ID
case|:
default|default:
if|if
condition|(
name|vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|tptr
argument_list|,
literal|"\n\t      "
argument_list|,
name|tlv_tlen
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|tlv_len
operator|+
literal|4
operator|)
return|;
comment|/* Type& Length fields not included */
block|}
end_function

begin_function
name|void
name|ldp_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|ldp_common_header
modifier|*
name|ldp_com_header
decl_stmt|;
specifier|const
name|struct
name|ldp_msg_header
modifier|*
name|ldp_msg_header
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|tptr
decl_stmt|,
modifier|*
name|msg_tptr
decl_stmt|;
name|u_short
name|tlen
decl_stmt|;
name|u_short
name|msg_len
decl_stmt|,
name|msg_type
decl_stmt|,
name|msg_tlen
decl_stmt|;
name|int
name|hexdump
decl_stmt|,
name|processed
decl_stmt|;
name|tptr
operator|=
name|pptr
expr_stmt|;
name|ldp_com_header
operator|=
operator|(
specifier|const
expr|struct
name|ldp_common_header
operator|*
operator|)
name|pptr
expr_stmt|;
name|TCHECK
argument_list|(
operator|*
name|ldp_com_header
argument_list|)
expr_stmt|;
comment|/*      * Sanity checking of the header.      */
if|if
condition|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ldp_com_header
operator|->
name|version
argument_list|)
operator|!=
name|LDP_VERSION
condition|)
block|{
name|printf
argument_list|(
literal|"LDP version %u packet not supported"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ldp_com_header
operator|->
name|version
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* print the LSR-ID, label-space& length */
name|printf
argument_list|(
literal|"%sLDP, Label-Space-ID: %s:%u, length: %u"
argument_list|,
operator|(
name|vflag
operator|<
literal|1
operator|)
condition|?
literal|""
else|:
literal|"\n\t"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|ldp_com_header
operator|->
name|lsr_id
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ldp_com_header
operator|->
name|label_space
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* bail out if non-verbose */
if|if
condition|(
name|vflag
operator|<
literal|1
condition|)
return|return;
comment|/* ok they seem to want to know everything - lets fully decode it */
name|tlen
operator|=
name|EXTRACT_16BITS
argument_list|(
name|ldp_com_header
operator|->
name|pdu_length
argument_list|)
expr_stmt|;
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
specifier|const
expr|struct
name|ldp_common_header
argument_list|)
expr_stmt|;
name|tlen
operator|-=
sizeof|sizeof
argument_list|(
specifier|const
expr|struct
name|ldp_common_header
argument_list|)
expr_stmt|;
while|while
condition|(
name|tlen
operator|>
literal|0
condition|)
block|{
comment|/* did we capture enough for fully decoding the msg header ? */
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|tptr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ldp_msg_header
argument_list|)
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
name|ldp_msg_header
operator|=
operator|(
specifier|const
expr|struct
name|ldp_msg_header
operator|*
operator|)
name|tptr
expr_stmt|;
name|msg_len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|ldp_msg_header
operator|->
name|length
argument_list|)
expr_stmt|;
name|msg_type
operator|=
name|LDP_MASK_MSG_TYPE
argument_list|(
name|EXTRACT_16BITS
argument_list|(
name|ldp_msg_header
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
comment|/* FIXME vendor private / experimental check */
name|printf
argument_list|(
literal|"\n\t  %s Message (0x%04x), length: %u, Message ID: 0x%08x, Flags: [%s if unknown]"
argument_list|,
name|tok2str
argument_list|(
name|ldp_msg_values
argument_list|,
literal|"Unknown"
argument_list|,
name|msg_type
argument_list|)
argument_list|,
name|msg_type
argument_list|,
name|msg_len
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|ldp_msg_header
operator|->
name|id
argument_list|)
argument_list|,
name|LDP_MASK_U_BIT
argument_list|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ldp_msg_header
operator|->
name|type
argument_list|)
argument_list|)
condition|?
literal|"continue processing"
else|:
literal|"ignore"
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg_len
operator|==
literal|0
condition|)
comment|/* infinite loop protection */
break|break;
name|msg_tptr
operator|=
name|tptr
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ldp_msg_header
argument_list|)
expr_stmt|;
name|msg_tlen
operator|=
name|msg_len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ldp_msg_header
argument_list|)
operator|+
literal|4
expr_stmt|;
comment|/* Type& Length fields not included */
comment|/* did we capture enough for fully decoding the message ? */
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|tptr
argument_list|,
name|msg_len
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
name|hexdump
operator|=
name|FALSE
expr_stmt|;
switch|switch
condition|(
name|msg_type
condition|)
block|{
case|case
name|LDP_MSG_HELLO
case|:
while|while
condition|(
name|msg_tlen
operator|>=
literal|4
condition|)
block|{
name|processed
operator|=
name|ldp_tlv_print
argument_list|(
name|msg_tptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|processed
operator|==
literal|0
condition|)
break|break;
name|msg_tlen
operator|-=
name|processed
expr_stmt|;
name|msg_tptr
operator|+=
name|processed
expr_stmt|;
block|}
break|break;
comment|/*          *  FIXME those are the defined messages that lack a decoder          *  you are welcome to contribute code ;-)          */
case|case
name|LDP_MSG_NOTIF
case|:
case|case
name|LDP_MSG_INIT
case|:
case|case
name|LDP_MSG_KEEPALIVE
case|:
case|case
name|LDP_MSG_ADDRESS
case|:
case|case
name|LDP_MSG_ADDRESS_WITHDRAW
case|:
case|case
name|LDP_MSG_LABEL_MAPPING
case|:
case|case
name|LDP_MSG_LABEL_REQUEST
case|:
case|case
name|LDP_MSG_LABEL_WITHDRAW
case|:
case|case
name|LDP_MSG_LABEL_RELEASE
case|:
case|case
name|LDP_MSG_LABEL_ABORT_REQUEST
case|:
default|default:
if|if
condition|(
name|vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|msg_tptr
argument_list|,
literal|"\n\t  "
argument_list|,
name|msg_tlen
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* do we want to see an additionally hexdump ? */
if|if
condition|(
name|vflag
operator|>
literal|1
operator|||
name|hexdump
operator|==
name|TRUE
condition|)
name|print_unknown_data
argument_list|(
name|tptr
operator|+
sizeof|sizeof
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ldp_msg_header
argument_list|)
argument_list|)
argument_list|,
literal|"\n\t  "
argument_list|,
name|msg_len
argument_list|)
expr_stmt|;
name|tptr
operator|+=
name|msg_len
expr_stmt|;
name|tlen
operator|-=
name|msg_len
expr_stmt|;
block|}
return|return;
name|trunc
label|:
name|printf
argument_list|(
literal|"\n\t\t packet exceeded snapshot"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code  * distributions retain the above copyright notice and this paragraph  * in its entirety, and (2) distributions including binary code include  * the above copyright notice and this paragraph in its entirety in  * the documentation or other materials provided with the distribution.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND  * WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, WITHOUT  * LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE.  *  * Original code by Hannes Gredler (hannes@juniper.net)  *  and Steinar Haug (sthaug@nethelp.no)  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
name|_U_
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-ldp.c,v 1.8.2.5 2005/06/16 01:10:35 guy Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"decode_prefix.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"l2vpn.h"
end_include

begin_comment
comment|/*  * ldp common header  *  *  0                   1                   2                   3  *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |  Version                      |         PDU Length            |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                         LDP Identifier                        |  * +                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                               |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  *  */
end_comment

begin_struct
struct|struct
name|ldp_common_header
block|{
name|u_int8_t
name|version
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|pdu_length
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|lsr_id
index|[
literal|4
index|]
decl_stmt|;
name|u_int8_t
name|label_space
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|LDP_VERSION
value|1
end_define

begin_comment
comment|/*  * ldp message header  *  *  0                   1                   2                   3  *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |U|   Message Type              |      Message Length           |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                     Message ID                                |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                                                               |  * +                                                               +  * |                     Mandatory Parameters                      |  * +                                                               +  * |                                                               |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                                                               |  * +                                                               +  * |                     Optional Parameters                       |  * +                                                               +  * |                                                               |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  */
end_comment

begin_struct
struct|struct
name|ldp_msg_header
block|{
name|u_int8_t
name|type
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|length
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|id
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|LDP_MASK_MSG_TYPE
parameter_list|(
name|x
parameter_list|)
value|((x)&0x7fff)
end_define

begin_define
define|#
directive|define
name|LDP_MASK_U_BIT
parameter_list|(
name|x
parameter_list|)
value|((x)&0x8000)
end_define

begin_define
define|#
directive|define
name|LDP_MSG_NOTIF
value|0x0001
end_define

begin_define
define|#
directive|define
name|LDP_MSG_HELLO
value|0x0100
end_define

begin_define
define|#
directive|define
name|LDP_MSG_INIT
value|0x0200
end_define

begin_define
define|#
directive|define
name|LDP_MSG_KEEPALIVE
value|0x0201
end_define

begin_define
define|#
directive|define
name|LDP_MSG_ADDRESS
value|0x0300
end_define

begin_define
define|#
directive|define
name|LDP_MSG_ADDRESS_WITHDRAW
value|0x0301
end_define

begin_define
define|#
directive|define
name|LDP_MSG_LABEL_MAPPING
value|0x0400
end_define

begin_define
define|#
directive|define
name|LDP_MSG_LABEL_REQUEST
value|0x0401
end_define

begin_define
define|#
directive|define
name|LDP_MSG_LABEL_WITHDRAW
value|0x0402
end_define

begin_define
define|#
directive|define
name|LDP_MSG_LABEL_RELEASE
value|0x0403
end_define

begin_define
define|#
directive|define
name|LDP_MSG_LABEL_ABORT_REQUEST
value|0x0404
end_define

begin_define
define|#
directive|define
name|LDP_VENDOR_PRIVATE_MIN
value|0x3e00
end_define

begin_define
define|#
directive|define
name|LDP_VENDOR_PRIVATE_MAX
value|0x3eff
end_define

begin_define
define|#
directive|define
name|LDP_EXPERIMENTAL_MIN
value|0x3f00
end_define

begin_define
define|#
directive|define
name|LDP_EXPERIMENTAL_MAX
value|0x3fff
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|ldp_msg_values
index|[]
init|=
block|{
block|{
name|LDP_MSG_NOTIF
block|,
literal|"Notification"
block|}
block|,
block|{
name|LDP_MSG_HELLO
block|,
literal|"Hello"
block|}
block|,
block|{
name|LDP_MSG_INIT
block|,
literal|"Initialization"
block|}
block|,
block|{
name|LDP_MSG_KEEPALIVE
block|,
literal|"Keepalive"
block|}
block|,
block|{
name|LDP_MSG_ADDRESS
block|,
literal|"Address"
block|}
block|,
block|{
name|LDP_MSG_ADDRESS_WITHDRAW
block|,
literal|"Address Widthdraw"
block|}
block|,
block|{
name|LDP_MSG_LABEL_MAPPING
block|,
literal|"Label Mapping"
block|}
block|,
block|{
name|LDP_MSG_LABEL_REQUEST
block|,
literal|"Label Request"
block|}
block|,
block|{
name|LDP_MSG_LABEL_WITHDRAW
block|,
literal|"Label Withdraw"
block|}
block|,
block|{
name|LDP_MSG_LABEL_RELEASE
block|,
literal|"Label Release"
block|}
block|,
block|{
name|LDP_MSG_LABEL_ABORT_REQUEST
block|,
literal|"Label Abort Request"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|LDP_MASK_TLV_TYPE
parameter_list|(
name|x
parameter_list|)
value|((x)&0x3fff)
end_define

begin_define
define|#
directive|define
name|LDP_MASK_F_BIT
parameter_list|(
name|x
parameter_list|)
value|((x)&0x4000)
end_define

begin_define
define|#
directive|define
name|LDP_TLV_FEC
value|0x0100
end_define

begin_define
define|#
directive|define
name|LDP_TLV_ADDRESS_LIST
value|0x0101
end_define

begin_define
define|#
directive|define
name|LDP_TLV_HOP_COUNT
value|0x0103
end_define

begin_define
define|#
directive|define
name|LDP_TLV_PATH_VECTOR
value|0x0104
end_define

begin_define
define|#
directive|define
name|LDP_TLV_GENERIC_LABEL
value|0x0200
end_define

begin_define
define|#
directive|define
name|LDP_TLV_ATM_LABEL
value|0x0201
end_define

begin_define
define|#
directive|define
name|LDP_TLV_FR_LABEL
value|0x0202
end_define

begin_define
define|#
directive|define
name|LDP_TLV_STATUS
value|0x0300
end_define

begin_define
define|#
directive|define
name|LDP_TLV_EXTD_STATUS
value|0x0301
end_define

begin_define
define|#
directive|define
name|LDP_TLV_RETURNED_PDU
value|0x0302
end_define

begin_define
define|#
directive|define
name|LDP_TLV_RETURNED_MSG
value|0x0303
end_define

begin_define
define|#
directive|define
name|LDP_TLV_COMMON_HELLO
value|0x0400
end_define

begin_define
define|#
directive|define
name|LDP_TLV_IPV4_TRANSPORT_ADDR
value|0x0401
end_define

begin_define
define|#
directive|define
name|LDP_TLV_CONFIG_SEQ_NUMBER
value|0x0402
end_define

begin_define
define|#
directive|define
name|LDP_TLV_IPV6_TRANSPORT_ADDR
value|0x0403
end_define

begin_define
define|#
directive|define
name|LDP_TLV_COMMON_SESSION
value|0x0500
end_define

begin_define
define|#
directive|define
name|LDP_TLV_ATM_SESSION_PARM
value|0x0501
end_define

begin_define
define|#
directive|define
name|LDP_TLV_FR_SESSION_PARM
value|0x0502
end_define

begin_define
define|#
directive|define
name|LDP_TLV_FT_SESSION
value|0x0503
end_define

begin_define
define|#
directive|define
name|LDP_TLV_LABEL_REQUEST_MSG_ID
value|0x0600
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|ldp_tlv_values
index|[]
init|=
block|{
block|{
name|LDP_TLV_FEC
block|,
literal|"FEC"
block|}
block|,
block|{
name|LDP_TLV_ADDRESS_LIST
block|,
literal|"Address List"
block|}
block|,
block|{
name|LDP_TLV_HOP_COUNT
block|,
literal|"Hop Count"
block|}
block|,
block|{
name|LDP_TLV_PATH_VECTOR
block|,
literal|"Path Vector"
block|}
block|,
block|{
name|LDP_TLV_GENERIC_LABEL
block|,
literal|"Generic Label"
block|}
block|,
block|{
name|LDP_TLV_ATM_LABEL
block|,
literal|"ATM Label"
block|}
block|,
block|{
name|LDP_TLV_FR_LABEL
block|,
literal|"Frame-Relay Label"
block|}
block|,
block|{
name|LDP_TLV_STATUS
block|,
literal|"Status"
block|}
block|,
block|{
name|LDP_TLV_EXTD_STATUS
block|,
literal|"Extended Status"
block|}
block|,
block|{
name|LDP_TLV_RETURNED_PDU
block|,
literal|"Returned PDU"
block|}
block|,
block|{
name|LDP_TLV_RETURNED_MSG
block|,
literal|"Returned Message"
block|}
block|,
block|{
name|LDP_TLV_COMMON_HELLO
block|,
literal|"Common Hello Parameters"
block|}
block|,
block|{
name|LDP_TLV_IPV4_TRANSPORT_ADDR
block|,
literal|"IPv4 Transport Address"
block|}
block|,
block|{
name|LDP_TLV_CONFIG_SEQ_NUMBER
block|,
literal|"Configuration Sequence Number"
block|}
block|,
block|{
name|LDP_TLV_IPV6_TRANSPORT_ADDR
block|,
literal|"IPv6 Transport Address"
block|}
block|,
block|{
name|LDP_TLV_COMMON_SESSION
block|,
literal|"Common Session Parameters"
block|}
block|,
block|{
name|LDP_TLV_ATM_SESSION_PARM
block|,
literal|"ATM Session Parameters"
block|}
block|,
block|{
name|LDP_TLV_FR_SESSION_PARM
block|,
literal|"Frame-Relay Session Parameters"
block|}
block|,
block|{
name|LDP_TLV_FT_SESSION
block|,
literal|"Fault-Tolerant Session Parameters"
block|}
block|,
block|{
name|LDP_TLV_LABEL_REQUEST_MSG_ID
block|,
literal|"Label Request Message ID"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|LDP_FEC_WILDCARD
value|0x01
end_define

begin_define
define|#
directive|define
name|LDP_FEC_PREFIX
value|0x02
end_define

begin_define
define|#
directive|define
name|LDP_FEC_HOSTADDRESS
value|0x03
end_define

begin_comment
comment|/* From draft-martini-l2circuit-trans-mpls-13.txt */
end_comment

begin_define
define|#
directive|define
name|LDP_FEC_MARTINI_VC
value|0x80
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|ldp_fec_values
index|[]
init|=
block|{
block|{
name|LDP_FEC_WILDCARD
block|,
literal|"Wildcard"
block|}
block|,
block|{
name|LDP_FEC_PREFIX
block|,
literal|"Prefix"
block|}
block|,
block|{
name|LDP_FEC_HOSTADDRESS
block|,
literal|"Host address"
block|}
block|,
block|{
name|LDP_FEC_MARTINI_VC
block|,
literal|"Martini VC"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|LDP_FEC_MARTINI_IFPARM_MTU
value|0x01
end_define

begin_define
define|#
directive|define
name|LDP_FEC_MARTINI_IFPARM_DESC
value|0x03
end_define

begin_define
define|#
directive|define
name|LDP_FEC_MARTINI_IFPARM_VCCV
value|0x0c
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|ldp_fec_martini_ifparm_values
index|[]
init|=
block|{
block|{
name|LDP_FEC_MARTINI_IFPARM_MTU
block|,
literal|"MTU"
block|}
block|,
block|{
name|LDP_FEC_MARTINI_IFPARM_DESC
block|,
literal|"Description"
block|}
block|,
block|{
name|LDP_FEC_MARTINI_IFPARM_VCCV
block|,
literal|"VCCV"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* draft-ietf-pwe3-vccv-04.txt */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|ldp_fec_martini_ifparm_vccv_cc_values
index|[]
init|=
block|{
block|{
literal|0x01
block|,
literal|"PWE3 control word"
block|}
block|,
block|{
literal|0x02
block|,
literal|"MPLS Router Alert Label"
block|}
block|,
block|{
literal|0x04
block|,
literal|"MPLS inner label TTL = 1"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* draft-ietf-pwe3-vccv-04.txt */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|ldp_fec_martini_ifparm_vccv_cv_values
index|[]
init|=
block|{
block|{
literal|0x01
block|,
literal|"ICMP Ping"
block|}
block|,
block|{
literal|0x02
block|,
literal|"LSP Ping"
block|}
block|,
block|{
literal|0x04
block|,
literal|"BFD"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* RFC1700 address family numbers, same definition in print-bgp.c */
end_comment

begin_define
define|#
directive|define
name|AFNUM_INET
value|1
end_define

begin_define
define|#
directive|define
name|AFNUM_INET6
value|2
end_define

begin_define
define|#
directive|define
name|FALSE
value|0
end_define

begin_define
define|#
directive|define
name|TRUE
value|1
end_define

begin_function_decl
name|int
name|ldp_msg_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|ldp_tlv_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*   * ldp tlv header  *  *  0                   1                   2                   3  *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |U|F|        Type               |            Length             |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                                                               |  * |                             Value                             |  * ~                                                               ~  * |                                                               |  * |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                               |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  */
end_comment

begin_function
name|int
name|ldp_tlv_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|tptr
parameter_list|)
block|{
struct|struct
name|ldp_tlv_header
block|{
name|u_int8_t
name|type
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|length
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
specifier|const
name|struct
name|ldp_tlv_header
modifier|*
name|ldp_tlv_header
decl_stmt|;
name|u_short
name|tlv_type
decl_stmt|,
name|tlv_len
decl_stmt|,
name|tlv_tlen
decl_stmt|,
name|af
decl_stmt|,
name|ft_flags
decl_stmt|;
name|u_char
name|fec_type
decl_stmt|;
name|u_int
name|ui
decl_stmt|,
name|vc_info_len
decl_stmt|,
name|vc_info_tlv_type
decl_stmt|,
name|vc_info_tlv_len
decl_stmt|,
name|idx
decl_stmt|;
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ldp_tlv_header
operator|=
operator|(
specifier|const
expr|struct
name|ldp_tlv_header
operator|*
operator|)
name|tptr
expr_stmt|;
name|tlv_len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|ldp_tlv_header
operator|->
name|length
argument_list|)
expr_stmt|;
name|tlv_tlen
operator|=
name|tlv_len
expr_stmt|;
name|tlv_type
operator|=
name|LDP_MASK_TLV_TYPE
argument_list|(
name|EXTRACT_16BITS
argument_list|(
name|ldp_tlv_header
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
comment|/* FIXME vendor private / experimental check */
name|printf
argument_list|(
literal|"\n\t    %s TLV (0x%04x), length: %u, Flags: [%s and %s forward if unknown]"
argument_list|,
name|tok2str
argument_list|(
name|ldp_tlv_values
argument_list|,
literal|"Unknown"
argument_list|,
name|tlv_type
argument_list|)
argument_list|,
name|tlv_type
argument_list|,
name|tlv_len
argument_list|,
name|LDP_MASK_U_BIT
argument_list|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ldp_tlv_header
operator|->
name|type
argument_list|)
argument_list|)
condition|?
literal|"continue processing"
else|:
literal|"ignore"
argument_list|,
name|LDP_MASK_F_BIT
argument_list|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ldp_tlv_header
operator|->
name|type
argument_list|)
argument_list|)
condition|?
literal|"do"
else|:
literal|"don't"
argument_list|)
expr_stmt|;
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ldp_tlv_header
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|tlv_type
condition|)
block|{
case|case
name|LDP_TLV_COMMON_HELLO
case|:
name|printf
argument_list|(
literal|"\n\t      Hold Time: %us, Flags: [%s Hello%s]"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
argument_list|,
operator|(
name|EXTRACT_16BITS
argument_list|(
name|tptr
operator|+
literal|2
argument_list|)
operator|&
literal|0x8000
operator|)
condition|?
literal|"Targeted"
else|:
literal|"Link"
argument_list|,
operator|(
name|EXTRACT_16BITS
argument_list|(
name|tptr
operator|+
literal|2
argument_list|)
operator|&
literal|0x4000
operator|)
condition|?
literal|", Request for targeted Hellos"
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|LDP_TLV_IPV4_TRANSPORT_ADDR
case|:
name|printf
argument_list|(
literal|"\n\t      IPv4 Transport Address: %s"
argument_list|,
name|ipaddr_string
argument_list|(
name|tptr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|LDP_TLV_IPV6_TRANSPORT_ADDR
case|:
name|printf
argument_list|(
literal|"\n\t      IPv6 Transport Address: %s"
argument_list|,
name|ip6addr_string
argument_list|(
name|tptr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|LDP_TLV_CONFIG_SEQ_NUMBER
case|:
name|printf
argument_list|(
literal|"\n\t      Sequence Number: %u"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|LDP_TLV_ADDRESS_LIST
case|:
name|af
operator|=
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|2
expr_stmt|;
name|printf
argument_list|(
literal|"\n\t      Adress Family: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|af
operator|==
name|AFNUM_INET
condition|)
block|{
name|printf
argument_list|(
literal|"IPv4, addresses:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|tlv_tlen
operator|-
literal|2
operator|)
operator|/
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|ipaddr_string
argument_list|(
name|tptr
argument_list|)
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|4
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|INET6
elseif|else
if|if
condition|(
name|af
operator|==
name|AFNUM_INET6
condition|)
block|{
name|printf
argument_list|(
literal|"IPv6, addresses:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|tlv_tlen
operator|-
literal|2
operator|)
operator|/
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|ip6addr_string
argument_list|(
name|tptr
argument_list|)
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|16
expr_stmt|;
block|}
block|}
endif|#
directive|endif
break|break;
case|case
name|LDP_TLV_COMMON_SESSION
case|:
name|printf
argument_list|(
literal|"\n\t      Version: %u, Keepalive: %us, Flags: [Downstream %s, Loop Detection %s]"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
operator|+
literal|2
argument_list|)
argument_list|,
operator|(
name|EXTRACT_16BITS
argument_list|(
name|tptr
operator|+
literal|6
argument_list|)
operator|&
literal|0x8000
operator|)
condition|?
literal|"On Demand"
else|:
literal|"Unsolicited"
argument_list|,
operator|(
name|EXTRACT_16BITS
argument_list|(
name|tptr
operator|+
literal|6
argument_list|)
operator|&
literal|0x4000
operator|)
condition|?
literal|"Enabled"
else|:
literal|"Disabled"
argument_list|)
expr_stmt|;
break|break;
case|case
name|LDP_TLV_FEC
case|:
name|fec_type
operator|=
operator|*
name|tptr
expr_stmt|;
name|printf
argument_list|(
literal|"\n\t      %s FEC (0x%02x)"
argument_list|,
name|tok2str
argument_list|(
name|ldp_fec_values
argument_list|,
literal|"Unknown"
argument_list|,
name|fec_type
argument_list|)
argument_list|,
name|fec_type
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|1
expr_stmt|;
switch|switch
condition|(
name|fec_type
condition|)
block|{
case|case
name|LDP_FEC_WILDCARD
case|:
break|break;
case|case
name|LDP_FEC_PREFIX
case|:
name|af
operator|=
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|af
operator|==
name|AFNUM_INET
condition|)
block|{
name|i
operator|=
name|decode_prefix4
argument_list|(
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|": IPv4 prefix %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|INET6
elseif|else
if|if
condition|(
name|af
operator|==
name|AFNUM_INET6
condition|)
block|{
name|i
operator|=
name|decode_prefix6
argument_list|(
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|": IPv6 prefix %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
break|break;
case|case
name|LDP_FEC_HOSTADDRESS
case|:
break|break;
case|case
name|LDP_FEC_MARTINI_VC
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|tptr
argument_list|,
literal|11
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
name|vc_info_len
operator|=
operator|*
operator|(
name|tptr
operator|+
literal|2
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|": %s, %scontrol word, group-ID %u, VC-ID %u, VC-info-length: %u"
argument_list|,
name|tok2str
argument_list|(
name|l2vpn_encaps_values
argument_list|,
literal|"Unknown"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
operator|&
literal|0x7fff
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
operator|&
literal|0x8000
condition|?
literal|""
else|:
literal|"no "
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
operator|+
literal|3
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
operator|+
literal|7
argument_list|)
argument_list|,
name|vc_info_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|vc_info_len
operator|==
literal|0
condition|)
comment|/* infinite loop protection */
break|break;
name|tptr
operator|+=
literal|11
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|tptr
argument_list|,
name|vc_info_len
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
while|while
condition|(
name|vc_info_len
operator|>
literal|2
condition|)
block|{
name|vc_info_tlv_type
operator|=
operator|*
name|tptr
expr_stmt|;
name|vc_info_tlv_len
operator|=
operator|*
operator|(
name|tptr
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|vc_info_tlv_len
operator|<
literal|2
condition|)
break|break;
if|if
condition|(
name|vc_info_len
operator|<
name|vc_info_tlv_len
condition|)
break|break;
name|printf
argument_list|(
literal|"\n\t\tInterface Parameter: %s (0x%02x), len %u"
argument_list|,
name|tok2str
argument_list|(
name|ldp_fec_martini_ifparm_values
argument_list|,
literal|"Unknown"
argument_list|,
name|vc_info_tlv_type
argument_list|)
argument_list|,
name|vc_info_tlv_type
argument_list|,
name|vc_info_tlv_len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|vc_info_tlv_type
condition|)
block|{
case|case
name|LDP_FEC_MARTINI_IFPARM_MTU
case|:
name|printf
argument_list|(
literal|": %u"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
operator|+
literal|2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|LDP_FEC_MARTINI_IFPARM_DESC
case|:
name|printf
argument_list|(
literal|": "
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|2
init|;
name|idx
operator|<
name|vc_info_tlv_len
condition|;
name|idx
operator|++
control|)
name|safeputchar
argument_list|(
operator|*
operator|(
name|tptr
operator|+
name|idx
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|LDP_FEC_MARTINI_IFPARM_VCCV
case|:
name|printf
argument_list|(
literal|"\n\t\t  Control Channels (0x%02x) = [%s]"
argument_list|,
operator|*
operator|(
name|tptr
operator|+
literal|2
operator|)
argument_list|,
name|bittok2str
argument_list|(
name|ldp_fec_martini_ifparm_vccv_cc_values
argument_list|,
literal|"none"
argument_list|,
operator|*
operator|(
name|tptr
operator|+
literal|2
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\t\t  CV Types (0x%02x) = [%s]"
argument_list|,
operator|*
operator|(
name|tptr
operator|+
literal|3
operator|)
argument_list|,
name|bittok2str
argument_list|(
name|ldp_fec_martini_ifparm_vccv_cv_values
argument_list|,
literal|"none"
argument_list|,
operator|*
operator|(
name|tptr
operator|+
literal|3
operator|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|print_unknown_data
argument_list|(
name|tptr
operator|+
literal|2
argument_list|,
literal|"\n\t\t  "
argument_list|,
name|vc_info_tlv_len
operator|-
literal|2
argument_list|)
expr_stmt|;
break|break;
block|}
name|vc_info_len
operator|-=
name|vc_info_tlv_len
expr_stmt|;
name|tptr
operator|+=
name|vc_info_tlv_len
expr_stmt|;
block|}
break|break;
block|}
break|break;
case|case
name|LDP_TLV_GENERIC_LABEL
case|:
name|printf
argument_list|(
literal|"\n\t      Label: %u"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
argument_list|)
operator|&
literal|0xfffff
argument_list|)
expr_stmt|;
break|break;
case|case
name|LDP_TLV_STATUS
case|:
name|ui
operator|=
name|EXTRACT_32BITS
argument_list|(
name|tptr
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|4
expr_stmt|;
name|printf
argument_list|(
literal|"\n\t      Status: 0x%02x, Flags: [%s and %s forward]"
argument_list|,
name|ui
operator|&
literal|0x3fffffff
argument_list|,
name|ui
operator|&
literal|0x80000000
condition|?
literal|"Fatal error"
else|:
literal|"Advisory Notification"
argument_list|,
name|ui
operator|&
literal|0x40000000
condition|?
literal|"do"
else|:
literal|"don't"
argument_list|)
expr_stmt|;
name|ui
operator|=
name|EXTRACT_32BITS
argument_list|(
name|tptr
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|ui
condition|)
name|printf
argument_list|(
literal|", causing Message ID: 0x%08x"
argument_list|,
name|ui
argument_list|)
expr_stmt|;
break|break;
case|case
name|LDP_TLV_FT_SESSION
case|:
name|ft_flags
operator|=
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\t      Flags: [%sReconnect, %sSave State, %sAll-Label Protection, %s Checkpoint, %sRe-Learn State]"
argument_list|,
name|ft_flags
operator|&
literal|0x8000
condition|?
literal|""
else|:
literal|"No "
argument_list|,
name|ft_flags
operator|&
literal|0x8
condition|?
literal|""
else|:
literal|"Don't "
argument_list|,
name|ft_flags
operator|&
literal|0x4
condition|?
literal|""
else|:
literal|"No "
argument_list|,
name|ft_flags
operator|&
literal|0x2
condition|?
literal|"Sequence Numbered Label"
else|:
literal|"All Labels"
argument_list|,
name|ft_flags
operator|&
literal|0x1
condition|?
literal|""
else|:
literal|"Don't "
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|4
expr_stmt|;
name|ui
operator|=
name|EXTRACT_32BITS
argument_list|(
name|tptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ui
condition|)
name|printf
argument_list|(
literal|", Reconnect Timeout: %ums"
argument_list|,
name|ui
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|4
expr_stmt|;
name|ui
operator|=
name|EXTRACT_32BITS
argument_list|(
name|tptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ui
condition|)
name|printf
argument_list|(
literal|", Recovery Time: %ums"
argument_list|,
name|ui
argument_list|)
expr_stmt|;
break|break;
comment|/*      *  FIXME those are the defined TLVs that lack a decoder      *  you are welcome to contribute code ;-)      */
case|case
name|LDP_TLV_HOP_COUNT
case|:
case|case
name|LDP_TLV_PATH_VECTOR
case|:
case|case
name|LDP_TLV_ATM_LABEL
case|:
case|case
name|LDP_TLV_FR_LABEL
case|:
case|case
name|LDP_TLV_EXTD_STATUS
case|:
case|case
name|LDP_TLV_RETURNED_PDU
case|:
case|case
name|LDP_TLV_RETURNED_MSG
case|:
case|case
name|LDP_TLV_ATM_SESSION_PARM
case|:
case|case
name|LDP_TLV_FR_SESSION_PARM
case|:
case|case
name|LDP_TLV_LABEL_REQUEST_MSG_ID
case|:
default|default:
if|if
condition|(
name|vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|tptr
argument_list|,
literal|"\n\t      "
argument_list|,
name|tlv_tlen
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|tlv_len
operator|+
literal|4
operator|)
return|;
comment|/* Type& Length fields not included */
name|trunc
label|:
name|printf
argument_list|(
literal|"\n\t\t packet exceeded snapshot"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ldp_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|)
block|{
name|int
name|processed
decl_stmt|;
while|while
condition|(
name|len
operator|>
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|ldp_common_header
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ldp_msg_header
argument_list|)
operator|)
condition|)
block|{
name|processed
operator|=
name|ldp_msg_print
argument_list|(
name|pptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|processed
operator|==
literal|0
condition|)
return|return;
name|len
operator|-=
name|processed
expr_stmt|;
name|pptr
operator|+=
name|processed
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|ldp_msg_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|)
block|{
specifier|const
name|struct
name|ldp_common_header
modifier|*
name|ldp_com_header
decl_stmt|;
specifier|const
name|struct
name|ldp_msg_header
modifier|*
name|ldp_msg_header
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|tptr
decl_stmt|,
modifier|*
name|msg_tptr
decl_stmt|;
name|u_short
name|tlen
decl_stmt|;
name|u_short
name|pdu_len
decl_stmt|,
name|msg_len
decl_stmt|,
name|msg_type
decl_stmt|,
name|msg_tlen
decl_stmt|;
name|int
name|hexdump
decl_stmt|,
name|processed
decl_stmt|;
name|tptr
operator|=
name|pptr
expr_stmt|;
name|ldp_com_header
operator|=
operator|(
specifier|const
expr|struct
name|ldp_common_header
operator|*
operator|)
name|pptr
expr_stmt|;
name|TCHECK
argument_list|(
operator|*
name|ldp_com_header
argument_list|)
expr_stmt|;
comment|/*      * Sanity checking of the header.      */
if|if
condition|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ldp_com_header
operator|->
name|version
argument_list|)
operator|!=
name|LDP_VERSION
condition|)
block|{
name|printf
argument_list|(
literal|"%sLDP version %u packet not supported"
argument_list|,
operator|(
name|vflag
operator|<
literal|1
operator|)
condition|?
literal|""
else|:
literal|"\n\t"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ldp_com_header
operator|->
name|version
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* print the LSR-ID, label-space& length */
name|pdu_len
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ldp_com_header
operator|->
name|pdu_length
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%sLDP, Label-Space-ID: %s:%u, pdu-length: %u"
argument_list|,
operator|(
name|vflag
operator|<
literal|1
operator|)
condition|?
literal|""
else|:
literal|"\n\t"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|ldp_com_header
operator|->
name|lsr_id
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ldp_com_header
operator|->
name|label_space
argument_list|)
argument_list|,
name|pdu_len
argument_list|)
expr_stmt|;
comment|/* bail out if non-verbose */
if|if
condition|(
name|vflag
operator|<
literal|1
condition|)
return|return
literal|0
return|;
comment|/* ok they seem to want to know everything - lets fully decode it */
name|tlen
operator|=
name|pdu_len
expr_stmt|;
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
specifier|const
expr|struct
name|ldp_common_header
argument_list|)
expr_stmt|;
name|tlen
operator|-=
sizeof|sizeof
argument_list|(
specifier|const
expr|struct
name|ldp_common_header
argument_list|)
operator|-
literal|4
expr_stmt|;
comment|/* Type& Length fields not included */
while|while
condition|(
name|tlen
operator|>
literal|0
condition|)
block|{
comment|/* did we capture enough for fully decoding the msg header ? */
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|tptr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ldp_msg_header
argument_list|)
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
name|ldp_msg_header
operator|=
operator|(
specifier|const
expr|struct
name|ldp_msg_header
operator|*
operator|)
name|tptr
expr_stmt|;
name|msg_len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|ldp_msg_header
operator|->
name|length
argument_list|)
expr_stmt|;
name|msg_type
operator|=
name|LDP_MASK_MSG_TYPE
argument_list|(
name|EXTRACT_16BITS
argument_list|(
name|ldp_msg_header
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
comment|/* FIXME vendor private / experimental check */
name|printf
argument_list|(
literal|"\n\t  %s Message (0x%04x), length: %u, Message ID: 0x%08x, Flags: [%s if unknown]"
argument_list|,
name|tok2str
argument_list|(
name|ldp_msg_values
argument_list|,
literal|"Unknown"
argument_list|,
name|msg_type
argument_list|)
argument_list|,
name|msg_type
argument_list|,
name|msg_len
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|ldp_msg_header
operator|->
name|id
argument_list|)
argument_list|,
name|LDP_MASK_U_BIT
argument_list|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ldp_msg_header
operator|->
name|type
argument_list|)
argument_list|)
condition|?
literal|"continue processing"
else|:
literal|"ignore"
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg_len
operator|==
literal|0
condition|)
comment|/* infinite loop protection */
return|return
literal|0
return|;
name|msg_tptr
operator|=
name|tptr
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ldp_msg_header
argument_list|)
expr_stmt|;
name|msg_tlen
operator|=
name|msg_len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ldp_msg_header
argument_list|)
operator|+
literal|4
expr_stmt|;
comment|/* Type& Length fields not included */
comment|/* did we capture enough for fully decoding the message ? */
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|tptr
argument_list|,
name|msg_len
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
name|hexdump
operator|=
name|FALSE
expr_stmt|;
switch|switch
condition|(
name|msg_type
condition|)
block|{
case|case
name|LDP_MSG_NOTIF
case|:
case|case
name|LDP_MSG_HELLO
case|:
case|case
name|LDP_MSG_INIT
case|:
case|case
name|LDP_MSG_KEEPALIVE
case|:
case|case
name|LDP_MSG_ADDRESS
case|:
case|case
name|LDP_MSG_LABEL_MAPPING
case|:
while|while
condition|(
name|msg_tlen
operator|>=
literal|4
condition|)
block|{
name|processed
operator|=
name|ldp_tlv_print
argument_list|(
name|msg_tptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|processed
operator|==
literal|0
condition|)
break|break;
name|msg_tlen
operator|-=
name|processed
expr_stmt|;
name|msg_tptr
operator|+=
name|processed
expr_stmt|;
block|}
break|break;
comment|/*          *  FIXME those are the defined messages that lack a decoder          *  you are welcome to contribute code ;-)          */
case|case
name|LDP_MSG_ADDRESS_WITHDRAW
case|:
case|case
name|LDP_MSG_LABEL_REQUEST
case|:
case|case
name|LDP_MSG_LABEL_WITHDRAW
case|:
case|case
name|LDP_MSG_LABEL_RELEASE
case|:
case|case
name|LDP_MSG_LABEL_ABORT_REQUEST
case|:
default|default:
if|if
condition|(
name|vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|msg_tptr
argument_list|,
literal|"\n\t  "
argument_list|,
name|msg_tlen
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* do we want to see an additionally hexdump ? */
if|if
condition|(
name|vflag
operator|>
literal|1
operator|||
name|hexdump
operator|==
name|TRUE
condition|)
name|print_unknown_data
argument_list|(
name|tptr
operator|+
sizeof|sizeof
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ldp_msg_header
argument_list|)
argument_list|)
argument_list|,
literal|"\n\t  "
argument_list|,
name|msg_len
argument_list|)
expr_stmt|;
name|tptr
operator|+=
name|msg_len
operator|+
literal|4
expr_stmt|;
name|tlen
operator|-=
name|msg_len
operator|+
literal|4
expr_stmt|;
block|}
return|return
name|pdu_len
operator|+
literal|4
return|;
name|trunc
label|:
name|printf
argument_list|(
literal|"\n\t\t packet exceeded snapshot"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


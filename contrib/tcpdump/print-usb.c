begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2009 Bert Vermeulen<bert@biot.com>  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code distributions  * retain the above copyright notice and this paragraph in its entirety, (2)  * distributions including binary code include the above copyright notice and  * this paragraph in its entirety in the documentation or other materials  * provided with the distribution, and (3) all advertising materials mentioning  * features or use of this software display the following acknowledgement:  * ``This product includes software developed by Paolo Abeni.''  * The name of author may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * Support for USB packets  *  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|<pcap.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_PCAP_USB_H
argument_list|)
operator|&&
name|defined
argument_list|(
name|DLT_USB_LINUX
argument_list|)
end_if

begin_include
include|#
directive|include
file|<pcap/usb.h>
end_include

begin_comment
comment|/* returns direction: 1=inbound 2=outbound -1=invalid */
end_comment

begin_function
specifier|static
name|int
name|get_direction
parameter_list|(
name|int
name|transfer_type
parameter_list|,
name|int
name|event_type
parameter_list|)
block|{
name|int
name|direction
decl_stmt|;
name|direction
operator|=
operator|-
literal|1
expr_stmt|;
switch|switch
condition|(
name|transfer_type
condition|)
block|{
case|case
name|URB_BULK
case|:
case|case
name|URB_CONTROL
case|:
case|case
name|URB_ISOCHRONOUS
case|:
switch|switch
condition|(
name|event_type
condition|)
block|{
case|case
name|URB_SUBMIT
case|:
name|direction
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|URB_COMPLETE
case|:
case|case
name|URB_ERROR
case|:
name|direction
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|direction
operator|=
operator|-
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|URB_INTERRUPT
case|:
switch|switch
condition|(
name|event_type
condition|)
block|{
case|case
name|URB_SUBMIT
case|:
name|direction
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|URB_COMPLETE
case|:
case|case
name|URB_ERROR
case|:
name|direction
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
name|direction
operator|=
operator|-
literal|1
expr_stmt|;
block|}
break|break;
default|default:
name|direction
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
name|direction
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|usb_header_print
parameter_list|(
specifier|const
name|pcap_usb_header
modifier|*
name|uh
parameter_list|)
block|{
name|int
name|direction
decl_stmt|;
switch|switch
condition|(
name|uh
operator|->
name|transfer_type
condition|)
block|{
case|case
name|URB_ISOCHRONOUS
case|:
name|printf
argument_list|(
literal|"ISOCHRONOUS"
argument_list|)
expr_stmt|;
break|break;
case|case
name|URB_INTERRUPT
case|:
name|printf
argument_list|(
literal|"INTERRUPT"
argument_list|)
expr_stmt|;
break|break;
case|case
name|URB_CONTROL
case|:
name|printf
argument_list|(
literal|"CONTROL"
argument_list|)
expr_stmt|;
break|break;
case|case
name|URB_BULK
case|:
name|printf
argument_list|(
literal|"BULK"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|" ?"
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|uh
operator|->
name|event_type
condition|)
block|{
case|case
name|URB_SUBMIT
case|:
name|printf
argument_list|(
literal|" SUBMIT"
argument_list|)
expr_stmt|;
break|break;
case|case
name|URB_COMPLETE
case|:
name|printf
argument_list|(
literal|" COMPLETE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|URB_ERROR
case|:
name|printf
argument_list|(
literal|" ERROR"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|" ?"
argument_list|)
expr_stmt|;
block|}
name|direction
operator|=
name|get_direction
argument_list|(
name|uh
operator|->
name|transfer_type
argument_list|,
name|uh
operator|->
name|event_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|direction
operator|==
literal|1
condition|)
name|printf
argument_list|(
literal|" from"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|direction
operator|==
literal|2
condition|)
name|printf
argument_list|(
literal|" to"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %d:%d:%d"
argument_list|,
name|uh
operator|->
name|bus_id
argument_list|,
name|uh
operator|->
name|device_address
argument_list|,
name|uh
operator|->
name|endpoint_number
operator|&
literal|0x7f
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This is the top level routine of the printer for captures with a  * 48-byte header.  *  * 'p' points to the header of the packet, 'h->ts' is the timestamp,  * 'h->len' is the length of the packet off the wire, and 'h->caplen'  * is the number of bytes actually captured.  */
end_comment

begin_function
name|u_int
name|usb_linux_48_byte_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
name|h
operator|->
name|caplen
operator|<
sizeof|sizeof
argument_list|(
name|pcap_usb_header
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"[|usb]"
argument_list|)
expr_stmt|;
return|return
operator|(
sizeof|sizeof
argument_list|(
name|pcap_usb_header
argument_list|)
operator|)
return|;
block|}
name|usb_header_print
argument_list|(
operator|(
specifier|const
name|pcap_usb_header
operator|*
operator|)
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
sizeof|sizeof
argument_list|(
name|pcap_usb_header
argument_list|)
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_USB_LINUX_MMAPPED
end_ifdef

begin_comment
comment|/*  * This is the top level routine of the printer for captures with a  * 64-byte header.  *  * 'p' points to the header of the packet, 'h->ts' is the timestamp,  * 'h->len' is the length of the packet off the wire, and 'h->caplen'  * is the number of bytes actually captured.  */
end_comment

begin_function
name|u_int
name|usb_linux_64_byte_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
name|h
operator|->
name|caplen
operator|<
sizeof|sizeof
argument_list|(
name|pcap_usb_header_mmapped
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"[|usb]"
argument_list|)
expr_stmt|;
return|return
operator|(
sizeof|sizeof
argument_list|(
name|pcap_usb_header_mmapped
argument_list|)
operator|)
return|;
block|}
name|usb_header_print
argument_list|(
operator|(
specifier|const
name|pcap_usb_header
operator|*
operator|)
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
sizeof|sizeof
argument_list|(
name|pcap_usb_header_mmapped
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DLT_USB_LINUX_MMAPPED */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defined(HAVE_PCAP_USB_H)&& defined(DLT_USB_LINUX) */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * This module implements decoding of AHCP (Ad Hoc Configuration Protocol) based  * on draft-chroboczek-ahcp-00 and source code of ahcpd-0.53.  *  *  * Copyright (c) 2013 The TCPDUMP project  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE  * COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN  * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_define
define|#
directive|define
name|NETDISSECT_REWORKED
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
name|tstr
index|[]
init|=
literal|" [|ahcp]"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|cstr
index|[]
init|=
literal|"(corrupt)"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AHCP_MAGIC_NUMBER
value|43
end_define

begin_define
define|#
directive|define
name|AHCP_VERSION_1
value|1
end_define

begin_define
define|#
directive|define
name|AHCP1_HEADER_FIX_LEN
value|24
end_define

begin_define
define|#
directive|define
name|AHCP1_BODY_MIN_LEN
value|4
end_define

begin_define
define|#
directive|define
name|AHCP1_MSG_DISCOVER
value|0
end_define

begin_define
define|#
directive|define
name|AHCP1_MSG_OFFER
value|1
end_define

begin_define
define|#
directive|define
name|AHCP1_MSG_REQUEST
value|2
end_define

begin_define
define|#
directive|define
name|AHCP1_MSG_ACK
value|3
end_define

begin_define
define|#
directive|define
name|AHCP1_MSG_NACK
value|4
end_define

begin_define
define|#
directive|define
name|AHCP1_MSG_RELEASE
value|5
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|ahcp1_msg_str
index|[]
init|=
block|{
block|{
name|AHCP1_MSG_DISCOVER
block|,
literal|"Discover"
block|}
block|,
block|{
name|AHCP1_MSG_OFFER
block|,
literal|"Offer"
block|}
block|,
block|{
name|AHCP1_MSG_REQUEST
block|,
literal|"Request"
block|}
block|,
block|{
name|AHCP1_MSG_ACK
block|,
literal|"Ack"
block|}
block|,
block|{
name|AHCP1_MSG_NACK
block|,
literal|"Nack"
block|}
block|,
block|{
name|AHCP1_MSG_RELEASE
block|,
literal|"Release"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AHCP1_OPT_PAD
value|0
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_MANDATORY
value|1
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_ORIGIN_TIME
value|2
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_EXPIRES
value|3
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_MY_IPV6_ADDRESS
value|4
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_MY_IPV4_ADDRESS
value|5
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_IPV6_PREFIX
value|6
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_IPV4_PREFIX
value|7
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_IPV6_ADDRESS
value|8
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_IPV4_ADDRESS
value|9
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_IPV6_PREFIX_DELEGATION
value|10
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_IPV4_PREFIX_DELEGATION
value|11
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_NAME_SERVER
value|12
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_NTP_SERVER
value|13
end_define

begin_define
define|#
directive|define
name|AHCP1_OPT_MAX
value|13
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|ahcp1_opt_str
index|[]
init|=
block|{
block|{
name|AHCP1_OPT_PAD
block|,
literal|"Pad"
block|}
block|,
block|{
name|AHCP1_OPT_MANDATORY
block|,
literal|"Mandatory"
block|}
block|,
block|{
name|AHCP1_OPT_ORIGIN_TIME
block|,
literal|"Origin Time"
block|}
block|,
block|{
name|AHCP1_OPT_EXPIRES
block|,
literal|"Expires"
block|}
block|,
block|{
name|AHCP1_OPT_MY_IPV6_ADDRESS
block|,
literal|"My-IPv6-Address"
block|}
block|,
block|{
name|AHCP1_OPT_MY_IPV4_ADDRESS
block|,
literal|"My-IPv4-Address"
block|}
block|,
block|{
name|AHCP1_OPT_IPV6_PREFIX
block|,
literal|"IPv6 Prefix"
block|}
block|,
block|{
name|AHCP1_OPT_IPV4_PREFIX
block|,
literal|"IPv4 Prefix"
block|}
block|,
block|{
name|AHCP1_OPT_IPV6_ADDRESS
block|,
literal|"IPv6 Address"
block|}
block|,
block|{
name|AHCP1_OPT_IPV4_ADDRESS
block|,
literal|"IPv4 Address"
block|}
block|,
block|{
name|AHCP1_OPT_IPV6_PREFIX_DELEGATION
block|,
literal|"IPv6 Prefix Delegation"
block|}
block|,
block|{
name|AHCP1_OPT_IPV4_PREFIX_DELEGATION
block|,
literal|"IPv4 Prefix Delegation"
block|}
block|,
block|{
name|AHCP1_OPT_NAME_SERVER
block|,
literal|"Name Server"
block|}
block|,
block|{
name|AHCP1_OPT_NTP_SERVER
block|,
literal|"NTP Server"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|ahcp_time_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|)
block|{
name|time_t
name|t
decl_stmt|;
name|struct
name|tm
modifier|*
name|tm
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZE
index|]
decl_stmt|;
if|if
condition|(
name|cp
operator|+
literal|4
operator|!=
name|ep
condition|)
goto|goto
name|corrupt
goto|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|t
operator|=
name|EXTRACT_32BITS
argument_list|(
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
operator|(
name|tm
operator|=
name|gmtime
argument_list|(
operator|&
name|t
argument_list|)
operator|)
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": gmtime() error"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
literal|0
operator|==
name|strftime
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%Y-%m-%d %H:%M:%S"
argument_list|,
name|tm
argument_list|)
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": strftime() error"
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": %s UTC"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": %s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ahcp_seconds_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|)
block|{
if|if
condition|(
name|cp
operator|+
literal|4
operator|!=
name|ep
condition|)
goto|goto
name|corrupt
goto|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": %us"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": %s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ahcp_ipv6_addresses_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|sep
init|=
literal|": "
decl_stmt|;
while|while
condition|(
name|cp
operator|<
name|ep
condition|)
block|{
if|if
condition|(
name|cp
operator|+
literal|16
operator|>
name|ep
condition|)
goto|goto
name|corrupt
goto|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|16
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s%s"
operator|,
name|sep
operator|,
name|ip6addr_string
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s(compiled w/o IPv6)"
operator|,
name|sep
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* INET6 */
name|cp
operator|+=
literal|16
expr_stmt|;
name|sep
operator|=
literal|", "
expr_stmt|;
block|}
return|return
literal|0
return|;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": %s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ahcp_ipv4_addresses_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|sep
init|=
literal|": "
decl_stmt|;
while|while
condition|(
name|cp
operator|<
name|ep
condition|)
block|{
if|if
condition|(
name|cp
operator|+
literal|4
operator|>
name|ep
condition|)
goto|goto
name|corrupt
goto|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s%s"
operator|,
name|sep
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|4
expr_stmt|;
name|sep
operator|=
literal|", "
expr_stmt|;
block|}
return|return
literal|0
return|;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": %s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ahcp_ipv6_prefixes_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|sep
init|=
literal|": "
decl_stmt|;
while|while
condition|(
name|cp
operator|<
name|ep
condition|)
block|{
if|if
condition|(
name|cp
operator|+
literal|17
operator|>
name|ep
condition|)
goto|goto
name|corrupt
goto|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|17
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s%s/%u"
operator|,
name|sep
operator|,
name|ip6addr_string
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|)
operator|,
operator|*
operator|(
name|cp
operator|+
literal|16
operator|)
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s(compiled w/o IPv6)/%u"
operator|,
name|sep
operator|,
operator|*
operator|(
name|cp
operator|+
literal|16
operator|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* INET6 */
name|cp
operator|+=
literal|17
expr_stmt|;
name|sep
operator|=
literal|", "
expr_stmt|;
block|}
return|return
literal|0
return|;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": %s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ahcp_ipv4_prefixes_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|sep
init|=
literal|": "
decl_stmt|;
while|while
condition|(
name|cp
operator|<
name|ep
condition|)
block|{
if|if
condition|(
name|cp
operator|+
literal|5
operator|>
name|ep
condition|)
goto|goto
name|corrupt
goto|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s%s/%u"
operator|,
name|sep
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|)
operator|,
operator|*
operator|(
name|cp
operator|+
literal|4
operator|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|5
expr_stmt|;
name|sep
operator|=
literal|", "
expr_stmt|;
block|}
return|return
literal|0
return|;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": %s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Data decoders signal truncated data with -1. */
end_comment

begin_expr_stmt
specifier|static
name|int
argument_list|(
operator|*
specifier|const
name|data_decoders
index|[
name|AHCP1_OPT_MAX
operator|+
literal|1
index|]
argument_list|)
argument_list|(
name|netdissect_options
operator|*
argument_list|,
specifier|const
name|u_char
operator|*
argument_list|,
specifier|const
name|u_char
operator|*
argument_list|)
operator|=
block|{
comment|/* [AHCP1_OPT_PAD]                    = */
name|NULL
block|,
comment|/* [AHCP1_OPT_MANDATORY]              = */
name|NULL
block|,
comment|/* [AHCP1_OPT_ORIGIN_TIME]            = */
name|ahcp_time_print
block|,
comment|/* [AHCP1_OPT_EXPIRES]                = */
name|ahcp_seconds_print
block|,
comment|/* [AHCP1_OPT_MY_IPV6_ADDRESS]        = */
name|ahcp_ipv6_addresses_print
block|,
comment|/* [AHCP1_OPT_MY_IPV4_ADDRESS]        = */
name|ahcp_ipv4_addresses_print
block|,
comment|/* [AHCP1_OPT_IPV6_PREFIX]            = */
name|ahcp_ipv6_prefixes_print
block|,
comment|/* [AHCP1_OPT_IPV4_PREFIX]            = */
name|NULL
block|,
comment|/* [AHCP1_OPT_IPV6_ADDRESS]           = */
name|ahcp_ipv6_addresses_print
block|,
comment|/* [AHCP1_OPT_IPV4_ADDRESS]           = */
name|ahcp_ipv4_addresses_print
block|,
comment|/* [AHCP1_OPT_IPV6_PREFIX_DELEGATION] = */
name|ahcp_ipv6_prefixes_print
block|,
comment|/* [AHCP1_OPT_IPV4_PREFIX_DELEGATION] = */
name|ahcp_ipv4_prefixes_print
block|,
comment|/* [AHCP1_OPT_NAME_SERVER]            = */
name|ahcp_ipv6_addresses_print
block|,
comment|/* [AHCP1_OPT_NTP_SERVER]             = */
name|ahcp_ipv6_addresses_print
block|, }
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|ahcp1_options_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|)
block|{
name|uint8_t
name|option_no
decl_stmt|,
name|option_len
decl_stmt|;
while|while
condition|(
name|cp
operator|<
name|ep
condition|)
block|{
comment|/* Option no */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|option_no
operator|=
operator|*
name|cp
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t %s"
operator|,
name|tok2str
argument_list|(
name|ahcp1_opt_str
argument_list|,
literal|"Unknown-%u"
argument_list|,
name|option_no
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|option_no
operator|==
name|AHCP1_OPT_PAD
operator|||
name|option_no
operator|==
name|AHCP1_OPT_MANDATORY
condition|)
continue|continue;
comment|/* Length */
if|if
condition|(
name|cp
operator|+
literal|1
operator|>
name|ep
condition|)
goto|goto
name|corrupt
goto|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|option_len
operator|=
operator|*
name|cp
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
name|cp
operator|+
name|option_len
operator|>
name|ep
condition|)
goto|goto
name|corrupt
goto|;
comment|/* Value */
if|if
condition|(
name|option_no
operator|<=
name|AHCP1_OPT_MAX
operator|&&
name|data_decoders
index|[
name|option_no
index|]
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|data_decoders
index|[
name|option_no
index|]
operator|(
name|ndo
operator|,
name|cp
operator|,
name|cp
operator|+
name|option_len
operator|)
operator|<
literal|0
condition|)
break|break;
comment|/* truncated and already marked up */
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" (Length %u)"
operator|,
name|option_len
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|option_len
argument_list|)
expr_stmt|;
block|}
name|cp
operator|+=
name|option_len
expr_stmt|;
block|}
return|return;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" %s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ahcp1_body_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|)
block|{
name|uint8_t
name|type
decl_stmt|,
name|mbz
decl_stmt|;
name|uint16_t
name|body_len
decl_stmt|;
if|if
condition|(
name|cp
operator|+
name|AHCP1_BODY_MIN_LEN
operator|>
name|ep
condition|)
goto|goto
name|corrupt
goto|;
comment|/* Type */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|type
operator|=
operator|*
name|cp
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* MBZ */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|mbz
operator|=
operator|*
name|cp
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* Length */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|body_len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t%s"
operator|,
name|tok2str
argument_list|(
name|ahcp1_msg_str
argument_list|,
literal|"Unknown-%u"
argument_list|,
name|type
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbz
operator|!=
literal|0
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", MBZ %u"
operator|,
name|mbz
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Length %u"
operator|,
name|body_len
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cp
operator|+
name|body_len
operator|>
name|ep
condition|)
goto|goto
name|corrupt
goto|;
comment|/* Options */
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>=
literal|2
condition|)
name|ahcp1_options_print
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
name|cp
operator|+
name|body_len
argument_list|)
expr_stmt|;
comment|/* not ep (ignore extra data) */
else|else
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|body_len
argument_list|)
expr_stmt|;
return|return;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" %s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ahcp_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|ep
init|=
name|cp
operator|+
name|len
decl_stmt|;
name|uint8_t
name|version
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"AHCP"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
condition|)
goto|goto
name|corrupt
goto|;
comment|/* Magic */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|!=
name|AHCP_MAGIC_NUMBER
condition|)
goto|goto
name|corrupt
goto|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* Version */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|version
operator|=
operator|*
name|cp
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
switch|switch
condition|(
name|version
condition|)
block|{
case|case
name|AHCP_VERSION_1
case|:
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" Version 1"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|AHCP1_HEADER_FIX_LEN
condition|)
goto|goto
name|corrupt
goto|;
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|AHCP1_HEADER_FIX_LEN
operator|-
literal|2
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|AHCP1_HEADER_FIX_LEN
operator|-
literal|2
expr_stmt|;
block|}
else|else
block|{
comment|/* Hopcount */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tHopcount %u"
operator|,
operator|*
name|cp
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* Original Hopcount */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Original Hopcount %u"
operator|,
operator|*
name|cp
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* Nonce */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Nonce 0x%08x"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|4
expr_stmt|;
comment|/* Source Id */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Source Id %s"
operator|,
name|linkaddr_string
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|8
expr_stmt|;
comment|/* Destination Id */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Destination Id %s"
operator|,
name|linkaddr_string
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|8
expr_stmt|;
block|}
comment|/* Body */
name|ahcp1_body_print
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
name|ep
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" Version %u (unknown)"
operator|,
name|version
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" %s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


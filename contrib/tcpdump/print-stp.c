begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000 Lennert Buytenhek  *  * This software may be distributed either under the terms of the  * BSD-style license that accompanies tcpdump or the GNU General  * Public License  *  * Format and print IEEE 802.1d spanning tree protocol packets.  * Contributed by Lennert Buytenhek<buytenh@gnu.org>  */
end_comment

begin_define
define|#
directive|define
name|NETDISSECT_REWORKED
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_define
define|#
directive|define
name|RSTP_EXTRACT_PORT_ROLE
parameter_list|(
name|x
parameter_list|)
value|(((x)&0x0C)>>2)
end_define

begin_comment
comment|/* STP timers are expressed in multiples of 1/256th second */
end_comment

begin_define
define|#
directive|define
name|STP_TIME_BASE
value|256
end_define

begin_define
define|#
directive|define
name|STP_BPDU_MSTP_MIN_LEN
value|102
end_define

begin_struct
struct|struct
name|stp_bpdu_
block|{
name|uint8_t
name|protocol_id
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|protocol_version
decl_stmt|;
name|uint8_t
name|bpdu_type
decl_stmt|;
name|uint8_t
name|flags
decl_stmt|;
name|uint8_t
name|root_id
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|root_path_cost
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|bridge_id
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|port_id
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|message_age
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|max_age
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|hello_time
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|forward_delay
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|v1_length
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|STP_PROTO_REGULAR
value|0x00
end_define

begin_define
define|#
directive|define
name|STP_PROTO_RAPID
value|0x02
end_define

begin_define
define|#
directive|define
name|STP_PROTO_MSTP
value|0x03
end_define

begin_define
define|#
directive|define
name|STP_PROTO_SPB
value|0x04
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|stp_proto_values
index|[]
init|=
block|{
block|{
name|STP_PROTO_REGULAR
block|,
literal|"802.1d"
block|}
block|,
block|{
name|STP_PROTO_RAPID
block|,
literal|"802.1w"
block|}
block|,
block|{
name|STP_PROTO_MSTP
block|,
literal|"802.1s"
block|}
block|,
block|{
name|STP_PROTO_SPB
block|,
literal|"802.1aq"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|STP_BPDU_TYPE_CONFIG
value|0x00
end_define

begin_define
define|#
directive|define
name|STP_BPDU_TYPE_RSTP
value|0x02
end_define

begin_define
define|#
directive|define
name|STP_BPDU_TYPE_TOPO_CHANGE
value|0x80
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|stp_bpdu_flag_values
index|[]
init|=
block|{
block|{
literal|0x01
block|,
literal|"Topology change"
block|}
block|,
block|{
literal|0x02
block|,
literal|"Proposal"
block|}
block|,
block|{
literal|0x10
block|,
literal|"Learn"
block|}
block|,
block|{
literal|0x20
block|,
literal|"Forward"
block|}
block|,
block|{
literal|0x40
block|,
literal|"Agreement"
block|}
block|,
block|{
literal|0x80
block|,
literal|"Topology change ACK"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|stp_bpdu_type_values
index|[]
init|=
block|{
block|{
name|STP_BPDU_TYPE_CONFIG
block|,
literal|"Config"
block|}
block|,
block|{
name|STP_BPDU_TYPE_RSTP
block|,
literal|"Rapid STP"
block|}
block|,
block|{
name|STP_BPDU_TYPE_TOPO_CHANGE
block|,
literal|"Topology Change"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|rstp_obj_port_role_values
index|[]
init|=
block|{
block|{
literal|0x00
block|,
literal|"Unknown"
block|}
block|,
block|{
literal|0x01
block|,
literal|"Alternate"
block|}
block|,
block|{
literal|0x02
block|,
literal|"Root"
block|}
block|,
block|{
literal|0x03
block|,
literal|"Designated"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|char
modifier|*
name|stp_print_bridge_id
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
specifier|static
name|char
name|bridge_id_str
index|[
sizeof|sizeof
argument_list|(
literal|"pppp.aa:bb:cc:dd:ee:ff"
argument_list|)
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|bridge_id_str
argument_list|,
sizeof|sizeof
argument_list|(
name|bridge_id_str
argument_list|)
argument_list|,
literal|"%.2x%.2x.%.2x:%.2x:%.2x:%.2x:%.2x:%.2x"
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|,
name|p
index|[
literal|1
index|]
argument_list|,
name|p
index|[
literal|2
index|]
argument_list|,
name|p
index|[
literal|3
index|]
argument_list|,
name|p
index|[
literal|4
index|]
argument_list|,
name|p
index|[
literal|5
index|]
argument_list|,
name|p
index|[
literal|6
index|]
argument_list|,
name|p
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
return|return
name|bridge_id_str
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|stp_print_config_bpdu
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|stp_bpdu_
modifier|*
name|stp_bpdu
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Flags [%s]"
operator|,
name|bittok2str
argument_list|(
name|stp_bpdu_flag_values
argument_list|,
literal|"none"
argument_list|,
name|stp_bpdu
operator|->
name|flags
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", bridge-id %s.%04x, length %u"
operator|,
name|stp_print_bridge_id
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|&
name|stp_bpdu
operator|->
name|bridge_id
argument_list|)
operator|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|port_id
argument_list|)
operator|,
name|length
operator|)
argument_list|)
expr_stmt|;
comment|/* in non-verbose mode just print the bridge-id */
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
return|return;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tmessage-age %.2fs, max-age %.2fs"
literal|", hello-time %.2fs, forwarding-delay %.2fs"
operator|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|message_age
argument_list|)
operator|/
name|STP_TIME_BASE
operator|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|max_age
argument_list|)
operator|/
name|STP_TIME_BASE
operator|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|hello_time
argument_list|)
operator|/
name|STP_TIME_BASE
operator|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|forward_delay
argument_list|)
operator|/
name|STP_TIME_BASE
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\troot-id %s, root-pathcost %u"
operator|,
name|stp_print_bridge_id
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|&
name|stp_bpdu
operator|->
name|root_id
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|root_path_cost
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Port role is only valid for 802.1w */
if|if
condition|(
name|stp_bpdu
operator|->
name|protocol_version
operator|==
name|STP_PROTO_RAPID
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", port-role %s"
operator|,
name|tok2str
argument_list|(
name|rstp_obj_port_role_values
argument_list|,
literal|"Unknown"
argument_list|,
name|RSTP_EXTRACT_PORT_ROLE
argument_list|(
name|stp_bpdu
operator|->
name|flags
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * MSTP packet format  * Ref. IEEE 802.1Q 2003 Ed. Section 14  *  * MSTP BPDU  *  * 2 -  bytes Protocol Id  * 1 -  byte  Protocol Ver.  * 1 -  byte  BPDU tye  * 1 -  byte  Flags  * 8 -  bytes CIST Root Identifier  * 4 -  bytes CIST External Path Cost  * 8 -  bytes CIST Regional Root Identifier  * 2 -  bytes CIST Port Identifier  * 2 -  bytes Message Age  * 2 -  bytes Max age  * 2 -  bytes Hello Time  * 2 -  bytes Forward delay  * 1 -  byte  Version 1 length. Must be 0  * 2 -  bytes Version 3 length  * 1 -  byte  Config Identifier  * 32 - bytes Config Name  * 2 -  bytes Revision level  * 16 - bytes Config Digest [MD5]  * 4 -  bytes CIST Internal Root Path Cost  * 8 -  bytes CIST Bridge Identifier  * 1 -  byte  CIST Remaining Hops  * 16 - bytes MSTI information [Max 64 MSTI, each 16 bytes]  *  *  * SPB BPDU  * Ref. IEEE 802.1aq. Section 14  *  * 2 -  bytes Version 4 length  * 1 -  byte  Aux Config Identifier  * 32 - bytes Aux Config Name  * 2 -  bytes Aux Revision level  * 16 - bytes Aux Config Digest [MD5]  * 1 -  byte  (1 - 2) Agreement Number  *            (3 - 4) Discarded Agreement Number  *            (5) Agreement Valid Flag  *            (6) Restricted Role Flag  *            (7 - 8) Unused sent zero  * 1 -  byte Unused  * 1 -  byte (1 - 4) Agreement Digest Format Identifier  *           (5 - 8) Agreement Digest Format Capabilities  * 1 -  byte (1 - 4) Agreement Digest Convention Identifier  *           (5 - 8) Agreement Digest Convention Capabilities  * 2 -  bytes Agreement Digest Edge Count  * 8 -  byte Reserved Set  * 20 - bytes Computed Topology Digest  *  *  * MSTI Payload  *  * 1 - byte  MSTI flag  * 8 - bytes MSTI Regional Root Identifier  * 4 - bytes MSTI Regional Path Cost  * 1 - byte  MSTI Bridge Priority  * 1 - byte  MSTI Port Priority  * 1 - byte  MSTI Remaining Hops  *  */
end_comment

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_LENGTH
value|16
end_define

begin_define
define|#
directive|define
name|MST_BPDU_CONFIG_INFO_LENGTH
value|64
end_define

begin_comment
comment|/* Offsets of fields from the begginning for the packet */
end_comment

begin_define
define|#
directive|define
name|MST_BPDU_VER3_LEN_OFFSET
value|36
end_define

begin_define
define|#
directive|define
name|MST_BPDU_CONFIG_NAME_OFFSET
value|39
end_define

begin_define
define|#
directive|define
name|MST_BPDU_CONFIG_DIGEST_OFFSET
value|73
end_define

begin_define
define|#
directive|define
name|MST_BPDU_CIST_INT_PATH_COST_OFFSET
value|89
end_define

begin_define
define|#
directive|define
name|MST_BPDU_CIST_BRIDGE_ID_OFFSET
value|93
end_define

begin_define
define|#
directive|define
name|MST_BPDU_CIST_REMAIN_HOPS_OFFSET
value|101
end_define

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_OFFSET
value|102
end_define

begin_comment
comment|/* Offsets within  an MSTI */
end_comment

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_ROOT_PRIO_OFFSET
value|1
end_define

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_ROOT_PATH_COST_OFFSET
value|9
end_define

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_BRIDGE_PRIO_OFFSET
value|13
end_define

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_PORT_PRIO_OFFSET
value|14
end_define

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_REMAIN_HOPS_OFFSET
value|15
end_define

begin_define
define|#
directive|define
name|SPB_BPDU_MIN_LEN
value|87
end_define

begin_define
define|#
directive|define
name|SPB_BPDU_CONFIG_NAME_OFFSET
value|3
end_define

begin_define
define|#
directive|define
name|SPB_BPDU_CONFIG_REV_OFFSET
value|SPB_BPDU_CONFIG_NAME_OFFSET + 32
end_define

begin_define
define|#
directive|define
name|SPB_BPDU_CONFIG_DIGEST_OFFSET
value|SPB_BPDU_CONFIG_REV_OFFSET + 2
end_define

begin_define
define|#
directive|define
name|SPB_BPDU_AGREEMENT_OFFSET
value|SPB_BPDU_CONFIG_DIGEST_OFFSET + 16
end_define

begin_define
define|#
directive|define
name|SPB_BPDU_AGREEMENT_UNUSED_OFFSET
value|SPB_BPDU_AGREEMENT_OFFSET + 1
end_define

begin_define
define|#
directive|define
name|SPB_BPDU_AGREEMENT_FORMAT_OFFSET
value|SPB_BPDU_AGREEMENT_UNUSED_OFFSET + 1
end_define

begin_define
define|#
directive|define
name|SPB_BPDU_AGREEMENT_CON_OFFSET
value|SPB_BPDU_AGREEMENT_FORMAT_OFFSET + 1
end_define

begin_define
define|#
directive|define
name|SPB_BPDU_AGREEMENT_EDGE_OFFSET
value|SPB_BPDU_AGREEMENT_CON_OFFSET + 1
end_define

begin_define
define|#
directive|define
name|SPB_BPDU_AGREEMENT_RES1_OFFSET
value|SPB_BPDU_AGREEMENT_EDGE_OFFSET + 2
end_define

begin_define
define|#
directive|define
name|SPB_BPDU_AGREEMENT_RES2_OFFSET
value|SPB_BPDU_AGREEMENT_RES1_OFFSET + 4
end_define

begin_define
define|#
directive|define
name|SPB_BPDU_AGREEMENT_DIGEST_OFFSET
value|SPB_BPDU_AGREEMENT_RES2_OFFSET + 4
end_define

begin_function
specifier|static
name|void
name|stp_print_mstp_bpdu
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|stp_bpdu_
modifier|*
name|stp_bpdu
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|ptr
decl_stmt|;
name|uint16_t
name|v3len
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|uint16_t
name|msti
decl_stmt|;
name|u_int
name|offset
decl_stmt|;
name|ptr
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|stp_bpdu
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", CIST Flags [%s], length %u"
operator|,
name|bittok2str
argument_list|(
name|stp_bpdu_flag_values
argument_list|,
literal|"none"
argument_list|,
name|stp_bpdu
operator|->
name|flags
argument_list|)
operator|,
name|length
operator|)
argument_list|)
expr_stmt|;
comment|/*      * in non-verbose mode just print the flags.      */
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
return|return;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tport-role %s, "
operator|,
name|tok2str
argument_list|(
name|rstp_obj_port_role_values
argument_list|,
literal|"Unknown"
argument_list|,
name|RSTP_EXTRACT_PORT_ROLE
argument_list|(
name|stp_bpdu
operator|->
name|flags
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"CIST root-id %s, CIST ext-pathcost %u "
operator|,
name|stp_print_bridge_id
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|&
name|stp_bpdu
operator|->
name|root_id
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|root_path_cost
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tCIST regional-root-id %s, "
operator|,
name|stp_print_bridge_id
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|&
name|stp_bpdu
operator|->
name|bridge_id
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"CIST port-id %04x, "
operator|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|port_id
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tmessage-age %.2fs, max-age %.2fs"
literal|", hello-time %.2fs, forwarding-delay %.2fs"
operator|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|message_age
argument_list|)
operator|/
name|STP_TIME_BASE
operator|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|max_age
argument_list|)
operator|/
name|STP_TIME_BASE
operator|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|hello_time
argument_list|)
operator|/
name|STP_TIME_BASE
operator|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|forward_delay
argument_list|)
operator|/
name|STP_TIME_BASE
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tv3len %d, "
operator|,
name|EXTRACT_16BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_VER3_LEN_OFFSET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"MCID Name %s, rev %u, "
literal|"\n\t\tdigest %08x%08x%08x%08x, "
operator|,
name|ptr
operator|+
name|MST_BPDU_CONFIG_NAME_OFFSET
operator|,
name|EXTRACT_16BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CONFIG_NAME_OFFSET
operator|+
literal|32
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CONFIG_DIGEST_OFFSET
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CONFIG_DIGEST_OFFSET
operator|+
literal|4
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CONFIG_DIGEST_OFFSET
operator|+
literal|8
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CONFIG_DIGEST_OFFSET
operator|+
literal|12
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"CIST int-root-pathcost %u, "
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CIST_INT_PATH_COST_OFFSET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tCIST bridge-id %s, "
operator|,
name|stp_print_bridge_id
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CIST_BRIDGE_ID_OFFSET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"CIST remaining-hops %d"
operator|,
name|ptr
index|[
name|MST_BPDU_CIST_REMAIN_HOPS_OFFSET
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/* Dump all MSTI's */
name|v3len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_VER3_LEN_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|v3len
operator|>
name|MST_BPDU_CONFIG_INFO_LENGTH
condition|)
block|{
name|len
operator|=
name|v3len
operator|-
name|MST_BPDU_CONFIG_INFO_LENGTH
expr_stmt|;
name|offset
operator|=
name|MST_BPDU_MSTI_OFFSET
expr_stmt|;
while|while
condition|(
name|len
operator|>=
name|MST_BPDU_MSTI_LENGTH
condition|)
block|{
name|msti
operator|=
name|EXTRACT_16BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|MST_BPDU_MSTI_ROOT_PRIO_OFFSET
argument_list|)
expr_stmt|;
name|msti
operator|=
name|msti
operator|&
literal|0x0FFF
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tMSTI %d, Flags [%s], port-role %s"
operator|,
name|msti
operator|,
name|bittok2str
argument_list|(
name|stp_bpdu_flag_values
argument_list|,
literal|"none"
argument_list|,
name|ptr
index|[
name|offset
index|]
argument_list|)
operator|,
name|tok2str
argument_list|(
name|rstp_obj_port_role_values
argument_list|,
literal|"Unknown"
argument_list|,
name|RSTP_EXTRACT_PORT_ROLE
argument_list|(
name|ptr
index|[
name|offset
index|]
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t\tMSTI regional-root-id %s, pathcost %u"
operator|,
name|stp_print_bridge_id
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|MST_BPDU_MSTI_ROOT_PRIO_OFFSET
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|MST_BPDU_MSTI_ROOT_PATH_COST_OFFSET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t\tMSTI bridge-prio %d, port-prio %d, hops %d"
operator|,
name|ptr
index|[
name|offset
operator|+
name|MST_BPDU_MSTI_BRIDGE_PRIO_OFFSET
index|]
operator|>>
literal|4
operator|,
name|ptr
index|[
name|offset
operator|+
name|MST_BPDU_MSTI_PORT_PRIO_OFFSET
index|]
operator|>>
literal|4
operator|,
name|ptr
index|[
name|offset
operator|+
name|MST_BPDU_MSTI_REMAIN_HOPS_OFFSET
index|]
operator|)
argument_list|)
expr_stmt|;
name|len
operator|-=
name|MST_BPDU_MSTI_LENGTH
expr_stmt|;
name|offset
operator|+=
name|MST_BPDU_MSTI_LENGTH
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|stp_print_spb_bpdu
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|stp_bpdu_
modifier|*
name|stp_bpdu
parameter_list|,
name|u_int
name|offset
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|ptr
decl_stmt|;
comment|/*      * in non-verbose mode don't print anything.      */
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
return|return;
block|}
name|ptr
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|stp_bpdu
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tv4len %d AUXMCID Name %s, Rev %u, \n\t\tdigest %08x%08x%08x%08x"
operator|,
name|EXTRACT_16BITS
argument_list|(
name|ptr
operator|+
name|offset
argument_list|)
operator|,
name|ptr
operator|+
name|offset
operator|+
name|SPB_BPDU_CONFIG_NAME_OFFSET
operator|,
name|EXTRACT_16BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|SPB_BPDU_CONFIG_REV_OFFSET
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|SPB_BPDU_CONFIG_DIGEST_OFFSET
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|SPB_BPDU_CONFIG_DIGEST_OFFSET
operator|+
literal|4
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|SPB_BPDU_CONFIG_DIGEST_OFFSET
operator|+
literal|8
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|SPB_BPDU_CONFIG_DIGEST_OFFSET
operator|+
literal|12
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tAgreement num %d, Discarded Agreement num %d, Agreement valid-"
literal|"flag %d, \n\tRestricted role-flag: %d, Format id %d cap %d, "
literal|"Convention id %d cap %d, \n\tEdge count %d, "
literal|"Agreement digest %08x%08x%08x%08x%08x\n"
operator|,
name|ptr
index|[
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_OFFSET
index|]
operator|>>
literal|6
operator|,
name|ptr
index|[
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_OFFSET
index|]
operator|>>
literal|4
operator|&
literal|0x3
operator|,
name|ptr
index|[
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_OFFSET
index|]
operator|>>
literal|3
operator|&
literal|0x1
operator|,
name|ptr
index|[
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_OFFSET
index|]
operator|>>
literal|2
operator|&
literal|0x1
operator|,
name|ptr
index|[
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_FORMAT_OFFSET
index|]
operator|>>
literal|4
operator|,
name|ptr
index|[
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_FORMAT_OFFSET
index|]
operator|&
literal|0x00ff
operator|,
name|ptr
index|[
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_CON_OFFSET
index|]
operator|>>
literal|4
operator|,
name|ptr
index|[
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_CON_OFFSET
index|]
operator|&
literal|0x00ff
operator|,
name|EXTRACT_16BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_EDGE_OFFSET
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_DIGEST_OFFSET
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_DIGEST_OFFSET
argument_list|)
operator|+
literal|4
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_DIGEST_OFFSET
argument_list|)
operator|+
literal|8
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_DIGEST_OFFSET
argument_list|)
operator|+
literal|12
operator|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|SPB_BPDU_AGREEMENT_DIGEST_OFFSET
argument_list|)
operator|+
literal|16
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print 802.1d / 802.1w / 802.1q (mstp) / 802.1aq (spb) packets.  */
end_comment

begin_function
name|void
name|stp_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
specifier|const
name|struct
name|stp_bpdu_
modifier|*
name|stp_bpdu
decl_stmt|;
name|u_int
name|mstp_len
decl_stmt|;
name|u_int
name|spb_len
decl_stmt|;
name|stp_bpdu
operator|=
operator|(
expr|struct
name|stp_bpdu_
operator|*
operator|)
name|p
expr_stmt|;
comment|/* Minimum STP Frame size. */
if|if
condition|(
name|length
operator|<
literal|4
condition|)
goto|goto
name|trunc
goto|;
if|if
condition|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|protocol_id
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"unknown STP version, length %u"
operator|,
name|length
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"STP %s"
operator|,
name|tok2str
argument_list|(
name|stp_proto_values
argument_list|,
literal|"Unknown STP protocol (0x%02x)"
argument_list|,
name|stp_bpdu
operator|->
name|protocol_version
argument_list|)
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|stp_bpdu
operator|->
name|protocol_version
condition|)
block|{
case|case
name|STP_PROTO_REGULAR
case|:
case|case
name|STP_PROTO_RAPID
case|:
case|case
name|STP_PROTO_MSTP
case|:
case|case
name|STP_PROTO_SPB
case|:
break|break;
default|default:
return|return;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", %s"
operator|,
name|tok2str
argument_list|(
name|stp_bpdu_type_values
argument_list|,
literal|"Unknown BPDU Type (0x%02x)"
argument_list|,
name|stp_bpdu
operator|->
name|bpdu_type
argument_list|)
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|stp_bpdu
operator|->
name|bpdu_type
condition|)
block|{
case|case
name|STP_BPDU_TYPE_CONFIG
case|:
if|if
condition|(
name|length
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|stp_bpdu_
argument_list|)
operator|-
literal|1
condition|)
block|{
goto|goto
name|trunc
goto|;
block|}
name|stp_print_config_bpdu
argument_list|(
name|ndo
argument_list|,
name|stp_bpdu
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|STP_BPDU_TYPE_RSTP
case|:
if|if
condition|(
name|stp_bpdu
operator|->
name|protocol_version
operator|==
name|STP_PROTO_RAPID
condition|)
block|{
if|if
condition|(
name|length
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|stp_bpdu_
argument_list|)
condition|)
block|{
goto|goto
name|trunc
goto|;
block|}
name|stp_print_config_bpdu
argument_list|(
name|ndo
argument_list|,
name|stp_bpdu
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|stp_bpdu
operator|->
name|protocol_version
operator|==
name|STP_PROTO_MSTP
operator|||
name|stp_bpdu
operator|->
name|protocol_version
operator|==
name|STP_PROTO_SPB
condition|)
block|{
if|if
condition|(
name|length
operator|<
name|STP_BPDU_MSTP_MIN_LEN
condition|)
block|{
goto|goto
name|trunc
goto|;
block|}
if|if
condition|(
name|stp_bpdu
operator|->
name|v1_length
operator|!=
literal|0
condition|)
block|{
comment|/* FIX ME: Emit a message here ? */
goto|goto
name|trunc
goto|;
block|}
comment|/* Validate v3 length */
name|mstp_len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
operator|+
name|MST_BPDU_VER3_LEN_OFFSET
argument_list|)
expr_stmt|;
name|mstp_len
operator|+=
literal|2
expr_stmt|;
comment|/* length encoding itself is 2 bytes */
if|if
condition|(
name|length
operator|<
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|stp_bpdu_
argument_list|)
operator|+
name|mstp_len
operator|)
condition|)
block|{
goto|goto
name|trunc
goto|;
block|}
name|stp_print_mstp_bpdu
argument_list|(
name|ndo
argument_list|,
name|stp_bpdu
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|stp_bpdu
operator|->
name|protocol_version
operator|==
name|STP_PROTO_SPB
condition|)
block|{
comment|/* Validate v4 length */
name|spb_len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
operator|+
name|MST_BPDU_VER3_LEN_OFFSET
operator|+
name|mstp_len
argument_list|)
expr_stmt|;
name|spb_len
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|length
operator|<
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|stp_bpdu_
argument_list|)
operator|+
name|mstp_len
operator|+
name|spb_len
operator|)
operator|||
name|spb_len
operator|<
name|SPB_BPDU_MIN_LEN
condition|)
block|{
goto|goto
name|trunc
goto|;
block|}
name|stp_print_spb_bpdu
argument_list|(
name|ndo
argument_list|,
name|stp_bpdu
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|stp_bpdu_
argument_list|)
operator|+
name|mstp_len
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|STP_BPDU_TYPE_TOPO_CHANGE
case|:
comment|/* always empty message - just break out */
break|break;
default|default:
break|break;
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|stp %d]"
operator|,
name|length
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Local Variables:  * c-style: whitesmith  * c-basic-offset: 4  * End:  */
end_comment

end_unit


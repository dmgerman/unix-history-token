begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000 Lennert Buytenhek  *  * This software may be distributed either under the terms of the  * BSD-style license that accompanies tcpdump or the GNU General  * Public License  *  * Format and print IEEE 802.1d spanning tree protocol packets.  * Contributed by Lennert Buytenhek<buytenh@gnu.org>  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
name|_U_
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-stp.c,v 1.20 2007-03-18 17:11:46 hannes Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_define
define|#
directive|define
name|RSTP_EXTRACT_PORT_ROLE
parameter_list|(
name|x
parameter_list|)
value|(((x)&0x0C)>>2)
end_define

begin_comment
comment|/* STP timers are expressed in multiples of 1/256th second */
end_comment

begin_define
define|#
directive|define
name|STP_TIME_BASE
value|256
end_define

begin_define
define|#
directive|define
name|STP_BPDU_MSTP_MIN_LEN
value|102
end_define

begin_struct
struct|struct
name|stp_bpdu_
block|{
name|u_int8_t
name|protocol_id
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|protocol_version
decl_stmt|;
name|u_int8_t
name|bpdu_type
decl_stmt|;
name|u_int8_t
name|flags
decl_stmt|;
name|u_int8_t
name|root_id
index|[
literal|8
index|]
decl_stmt|;
name|u_int8_t
name|root_path_cost
index|[
literal|4
index|]
decl_stmt|;
name|u_int8_t
name|bridge_id
index|[
literal|8
index|]
decl_stmt|;
name|u_int8_t
name|port_id
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|message_age
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|max_age
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|hello_time
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|forward_delay
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|v1_length
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|STP_PROTO_REGULAR
value|0x00
end_define

begin_define
define|#
directive|define
name|STP_PROTO_RAPID
value|0x02
end_define

begin_define
define|#
directive|define
name|STP_PROTO_MSTP
value|0x03
end_define

begin_decl_stmt
name|struct
name|tok
name|stp_proto_values
index|[]
init|=
block|{
block|{
name|STP_PROTO_REGULAR
block|,
literal|"802.1d"
block|}
block|,
block|{
name|STP_PROTO_RAPID
block|,
literal|"802.1w"
block|}
block|,
block|{
name|STP_PROTO_MSTP
block|,
literal|"802.1s"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|STP_BPDU_TYPE_CONFIG
value|0x00
end_define

begin_define
define|#
directive|define
name|STP_BPDU_TYPE_RSTP
value|0x02
end_define

begin_define
define|#
directive|define
name|STP_BPDU_TYPE_TOPO_CHANGE
value|0x80
end_define

begin_decl_stmt
name|struct
name|tok
name|stp_bpdu_flag_values
index|[]
init|=
block|{
block|{
literal|0x01
block|,
literal|"Topology change"
block|}
block|,
block|{
literal|0x02
block|,
literal|"Proposal"
block|}
block|,
block|{
literal|0x10
block|,
literal|"Learn"
block|}
block|,
block|{
literal|0x20
block|,
literal|"Forward"
block|}
block|,
block|{
literal|0x40
block|,
literal|"Agreement"
block|}
block|,
block|{
literal|0x80
block|,
literal|"Topology change ACK"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|tok
name|stp_bpdu_type_values
index|[]
init|=
block|{
block|{
name|STP_BPDU_TYPE_CONFIG
block|,
literal|"Config"
block|}
block|,
block|{
name|STP_BPDU_TYPE_RSTP
block|,
literal|"Rapid STP"
block|}
block|,
block|{
name|STP_BPDU_TYPE_TOPO_CHANGE
block|,
literal|"Topology Change"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|tok
name|rstp_obj_port_role_values
index|[]
init|=
block|{
block|{
literal|0x00
block|,
literal|"Unknown"
block|}
block|,
block|{
literal|0x01
block|,
literal|"Alternate"
block|}
block|,
block|{
literal|0x02
block|,
literal|"Root"
block|}
block|,
block|{
literal|0x03
block|,
literal|"Designated"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|char
modifier|*
name|stp_print_bridge_id
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
specifier|static
name|char
name|bridge_id_str
index|[
sizeof|sizeof
argument_list|(
literal|"pppp.aa:bb:cc:dd:ee:ff"
argument_list|)
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|bridge_id_str
argument_list|,
sizeof|sizeof
argument_list|(
name|bridge_id_str
argument_list|)
argument_list|,
literal|"%.2x%.2x.%.2x:%.2x:%.2x:%.2x:%.2x:%.2x"
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|,
name|p
index|[
literal|1
index|]
argument_list|,
name|p
index|[
literal|2
index|]
argument_list|,
name|p
index|[
literal|3
index|]
argument_list|,
name|p
index|[
literal|4
index|]
argument_list|,
name|p
index|[
literal|5
index|]
argument_list|,
name|p
index|[
literal|6
index|]
argument_list|,
name|p
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
return|return
name|bridge_id_str
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|stp_print_config_bpdu
parameter_list|(
specifier|const
name|struct
name|stp_bpdu_
modifier|*
name|stp_bpdu
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
name|printf
argument_list|(
literal|", Flags [%s]"
argument_list|,
name|bittok2str
argument_list|(
name|stp_bpdu_flag_values
argument_list|,
literal|"none"
argument_list|,
name|stp_bpdu
operator|->
name|flags
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", bridge-id %s.%04x, length %u"
argument_list|,
name|stp_print_bridge_id
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|&
name|stp_bpdu
operator|->
name|bridge_id
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|port_id
argument_list|)
argument_list|,
name|length
argument_list|)
expr_stmt|;
comment|/* in non-verbose mode just print the bridge-id */
if|if
condition|(
operator|!
name|vflag
condition|)
block|{
return|return;
block|}
name|printf
argument_list|(
literal|"\n\tmessage-age %.2fs, max-age %.2fs"
literal|", hello-time %.2fs, forwarding-delay %.2fs"
argument_list|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|message_age
argument_list|)
operator|/
name|STP_TIME_BASE
argument_list|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|max_age
argument_list|)
operator|/
name|STP_TIME_BASE
argument_list|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|hello_time
argument_list|)
operator|/
name|STP_TIME_BASE
argument_list|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|forward_delay
argument_list|)
operator|/
name|STP_TIME_BASE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\troot-id %s, root-pathcost %u"
argument_list|,
name|stp_print_bridge_id
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|&
name|stp_bpdu
operator|->
name|root_id
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|root_path_cost
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Port role is only valid for 802.1w */
if|if
condition|(
name|stp_bpdu
operator|->
name|protocol_version
operator|==
name|STP_PROTO_RAPID
condition|)
block|{
name|printf
argument_list|(
literal|", port-role %s"
argument_list|,
name|tok2str
argument_list|(
name|rstp_obj_port_role_values
argument_list|,
literal|"Unknown"
argument_list|,
name|RSTP_EXTRACT_PORT_ROLE
argument_list|(
name|stp_bpdu
operator|->
name|flags
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * MSTP packet format  * Ref. IEEE 802.1Q 2003 Ed. Section 14  *  * MSTP BPDU  *  * 2 -  bytes Protocol Id  * 1 -  byte  Protocol Ver.   * 1 -  byte  BPDU tye  * 1 -  byte  Flags  * 8 -  bytes CIST Root Identifier  * 4 -  bytes CIST External Path Cost  * 8 -  bytes CIST Regional Root Identifier  * 2 -  bytes CIST Port Identifier  * 2 -  bytes Message Age  * 2 -  bytes Max age  * 2 -  bytes Hello Time  * 2 -  bytes Forward delay  * 1 -  byte  Version 1 length. Must be 0  * 2 -  bytes Version 3 length  * 1 -  byte  Config Identifier  * 32 - bytes Config Name  * 2 -  bytes Revision level  * 16 - bytes Config Digest [MD5]  * 4 -  bytes CIST Internal Root Path Cost  * 8 -  bytes CIST Bridge Identifier  * 1 -  byte  CIST Remaining Hops  * 16 - bytes MSTI information [Max 64 MSTI, each 16 bytes]  *  * MSTI Payload  *  * 1 - byte  MSTI flag  * 8 - bytes MSTI Regional Root Identifier  * 4 - bytes MSTI Regional Path Cost  * 1 - byte  MSTI Bridge Priority  * 1 - byte  MSTI Port Priority  * 1 - byte  MSTI Remaining Hops  */
end_comment

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_LENGTH
value|16
end_define

begin_define
define|#
directive|define
name|MST_BPDU_CONFIG_INFO_LENGTH
value|64
end_define

begin_comment
comment|/* Offsets of fields from the begginning for the packet */
end_comment

begin_define
define|#
directive|define
name|MST_BPDU_VER3_LEN_OFFSET
value|36
end_define

begin_define
define|#
directive|define
name|MST_BPDU_CONFIG_NAME_OFFSET
value|39
end_define

begin_define
define|#
directive|define
name|MST_BPDU_CONFIG_DIGEST_OFFSET
value|73
end_define

begin_define
define|#
directive|define
name|MST_BPDU_CIST_INT_PATH_COST_OFFSET
value|89
end_define

begin_define
define|#
directive|define
name|MST_BPDU_CIST_BRIDGE_ID_OFFSET
value|93
end_define

begin_define
define|#
directive|define
name|MST_BPDU_CIST_REMAIN_HOPS_OFFSET
value|101
end_define

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_OFFSET
value|102
end_define

begin_comment
comment|/* Offsets within  an MSTI */
end_comment

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_ROOT_PRIO_OFFSET
value|1
end_define

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_ROOT_PATH_COST_OFFSET
value|9
end_define

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_BRIDGE_PRIO_OFFSET
value|13
end_define

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_PORT_PRIO_OFFSET
value|14
end_define

begin_define
define|#
directive|define
name|MST_BPDU_MSTI_REMAIN_HOPS_OFFSET
value|15
end_define

begin_function
specifier|static
name|void
name|stp_print_mstp_bpdu
parameter_list|(
specifier|const
name|struct
name|stp_bpdu_
modifier|*
name|stp_bpdu
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|ptr
decl_stmt|;
name|u_int16_t
name|v3len
decl_stmt|;
name|u_int16_t
name|len
decl_stmt|;
name|u_int16_t
name|msti
decl_stmt|;
name|u_int16_t
name|offset
decl_stmt|;
name|ptr
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|stp_bpdu
expr_stmt|;
name|printf
argument_list|(
literal|", CIST Flags [%s]"
argument_list|,
name|bittok2str
argument_list|(
name|stp_bpdu_flag_values
argument_list|,
literal|"none"
argument_list|,
name|stp_bpdu
operator|->
name|flags
argument_list|)
argument_list|)
expr_stmt|;
comment|/*      * in non-verbose mode just print the flags. We dont read that much      * of the packet (DEFAULT_SNAPLEN) to print out cist bridge-id      */
if|if
condition|(
operator|!
name|vflag
condition|)
block|{
return|return;
block|}
name|printf
argument_list|(
literal|", CIST bridge-id %s.%04x, length %u"
argument_list|,
name|stp_print_bridge_id
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CIST_BRIDGE_ID_OFFSET
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|port_id
argument_list|)
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\tmessage-age %.2fs, max-age %.2fs"
literal|", hello-time %.2fs, forwarding-delay %.2fs"
argument_list|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|message_age
argument_list|)
operator|/
name|STP_TIME_BASE
argument_list|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|max_age
argument_list|)
operator|/
name|STP_TIME_BASE
argument_list|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|hello_time
argument_list|)
operator|/
name|STP_TIME_BASE
argument_list|,
operator|(
name|float
operator|)
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|forward_delay
argument_list|)
operator|/
name|STP_TIME_BASE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\tCIST root-id %s, ext-pathcost %u int-pathcost %u"
argument_list|,
name|stp_print_bridge_id
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|&
name|stp_bpdu
operator|->
name|root_id
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|root_path_cost
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CIST_INT_PATH_COST_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", port-role %s"
argument_list|,
name|tok2str
argument_list|(
name|rstp_obj_port_role_values
argument_list|,
literal|"Unknown"
argument_list|,
name|RSTP_EXTRACT_PORT_ROLE
argument_list|(
name|stp_bpdu
operator|->
name|flags
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\tCIST regional-root-id %s"
argument_list|,
name|stp_print_bridge_id
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|&
name|stp_bpdu
operator|->
name|bridge_id
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\tMSTP Configuration Name %s, revision %u, digest %08x%08x%08x%08x"
argument_list|,
name|ptr
operator|+
name|MST_BPDU_CONFIG_NAME_OFFSET
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CONFIG_NAME_OFFSET
operator|+
literal|32
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CONFIG_DIGEST_OFFSET
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CONFIG_DIGEST_OFFSET
operator|+
literal|4
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CONFIG_DIGEST_OFFSET
operator|+
literal|8
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_CONFIG_DIGEST_OFFSET
operator|+
literal|12
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\tCIST remaining-hops %d"
argument_list|,
name|ptr
index|[
name|MST_BPDU_CIST_REMAIN_HOPS_OFFSET
index|]
argument_list|)
expr_stmt|;
comment|/* Dump all MSTI's */
name|v3len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|ptr
operator|+
name|MST_BPDU_VER3_LEN_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|v3len
operator|>
name|MST_BPDU_CONFIG_INFO_LENGTH
condition|)
block|{
name|len
operator|=
name|v3len
operator|-
name|MST_BPDU_CONFIG_INFO_LENGTH
expr_stmt|;
name|offset
operator|=
name|MST_BPDU_MSTI_OFFSET
expr_stmt|;
while|while
condition|(
name|len
operator|>=
name|MST_BPDU_MSTI_LENGTH
condition|)
block|{
name|msti
operator|=
name|EXTRACT_16BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|MST_BPDU_MSTI_ROOT_PRIO_OFFSET
argument_list|)
expr_stmt|;
name|msti
operator|=
name|msti
operator|&
literal|0x0FFF
expr_stmt|;
name|printf
argument_list|(
literal|"\n\tMSTI %d, Flags [%s], port-role %s"
argument_list|,
name|msti
argument_list|,
name|bittok2str
argument_list|(
name|stp_bpdu_flag_values
argument_list|,
literal|"none"
argument_list|,
name|ptr
index|[
name|offset
index|]
argument_list|)
argument_list|,
name|tok2str
argument_list|(
name|rstp_obj_port_role_values
argument_list|,
literal|"Unknown"
argument_list|,
name|RSTP_EXTRACT_PORT_ROLE
argument_list|(
name|ptr
index|[
name|offset
index|]
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\t\tMSTI regional-root-id %s, pathcost %u"
argument_list|,
name|stp_print_bridge_id
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|MST_BPDU_MSTI_ROOT_PRIO_OFFSET
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|ptr
operator|+
name|offset
operator|+
name|MST_BPDU_MSTI_ROOT_PATH_COST_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\t\tMSTI bridge-prio %d, port-prio %d, hops %d"
argument_list|,
name|ptr
index|[
name|offset
operator|+
name|MST_BPDU_MSTI_BRIDGE_PRIO_OFFSET
index|]
operator|>>
literal|4
argument_list|,
name|ptr
index|[
name|offset
operator|+
name|MST_BPDU_MSTI_PORT_PRIO_OFFSET
index|]
operator|>>
literal|4
argument_list|,
name|ptr
index|[
name|offset
operator|+
name|MST_BPDU_MSTI_REMAIN_HOPS_OFFSET
index|]
argument_list|)
expr_stmt|;
name|len
operator|-=
name|MST_BPDU_MSTI_LENGTH
expr_stmt|;
name|offset
operator|+=
name|MST_BPDU_MSTI_LENGTH
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Print 802.1d / 802.1w / 802.1q (mstp) packets.  */
end_comment

begin_function
name|void
name|stp_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
specifier|const
name|struct
name|stp_bpdu_
modifier|*
name|stp_bpdu
decl_stmt|;
name|u_int16_t
name|mstp_len
decl_stmt|;
name|stp_bpdu
operator|=
operator|(
expr|struct
name|stp_bpdu_
operator|*
operator|)
name|p
expr_stmt|;
comment|/* Minimum STP Frame size. */
if|if
condition|(
name|length
operator|<
literal|4
condition|)
goto|goto
name|trunc
goto|;
if|if
condition|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|stp_bpdu
operator|->
name|protocol_id
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"unknown STP version, length %u"
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"STP %s"
argument_list|,
name|tok2str
argument_list|(
name|stp_proto_values
argument_list|,
literal|"Unknown STP protocol (0x%02x)"
argument_list|,
name|stp_bpdu
operator|->
name|protocol_version
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|stp_bpdu
operator|->
name|protocol_version
condition|)
block|{
case|case
name|STP_PROTO_REGULAR
case|:
case|case
name|STP_PROTO_RAPID
case|:
case|case
name|STP_PROTO_MSTP
case|:
break|break;
default|default:
return|return;
block|}
name|printf
argument_list|(
literal|", %s"
argument_list|,
name|tok2str
argument_list|(
name|stp_bpdu_type_values
argument_list|,
literal|"Unknown BPDU Type (0x%02x)"
argument_list|,
name|stp_bpdu
operator|->
name|bpdu_type
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|stp_bpdu
operator|->
name|bpdu_type
condition|)
block|{
case|case
name|STP_BPDU_TYPE_CONFIG
case|:
if|if
condition|(
name|length
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|stp_bpdu_
argument_list|)
operator|-
literal|1
condition|)
block|{
goto|goto
name|trunc
goto|;
block|}
name|stp_print_config_bpdu
argument_list|(
name|stp_bpdu
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|STP_BPDU_TYPE_RSTP
case|:
if|if
condition|(
name|stp_bpdu
operator|->
name|protocol_version
operator|==
name|STP_PROTO_RAPID
condition|)
block|{
if|if
condition|(
name|length
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|stp_bpdu_
argument_list|)
condition|)
block|{
goto|goto
name|trunc
goto|;
block|}
name|stp_print_config_bpdu
argument_list|(
name|stp_bpdu
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|stp_bpdu
operator|->
name|protocol_version
operator|==
name|STP_PROTO_MSTP
condition|)
block|{
if|if
condition|(
name|length
operator|<
name|STP_BPDU_MSTP_MIN_LEN
condition|)
block|{
goto|goto
name|trunc
goto|;
block|}
if|if
condition|(
name|stp_bpdu
operator|->
name|v1_length
operator|!=
literal|0
condition|)
block|{
comment|/* FIX ME: Emit a message here ? */
goto|goto
name|trunc
goto|;
block|}
comment|/* Validate v3 length */
name|mstp_len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
operator|+
name|MST_BPDU_VER3_LEN_OFFSET
argument_list|)
expr_stmt|;
name|mstp_len
operator|+=
literal|2
expr_stmt|;
comment|/* length encoding itself is 2 bytes */
if|if
condition|(
name|length
operator|<
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|stp_bpdu_
argument_list|)
operator|+
name|mstp_len
operator|)
condition|)
block|{
goto|goto
name|trunc
goto|;
block|}
name|stp_print_mstp_bpdu
argument_list|(
name|stp_bpdu
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|STP_BPDU_TYPE_TOPO_CHANGE
case|:
comment|/* always empty message - just break out */
break|break;
default|default:
break|break;
block|}
return|return;
name|trunc
label|:
name|printf
argument_list|(
literal|"[|stp %d]"
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Local Variables:  * c-style: whitesmith  * c-basic-offset: 4  * End:  */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*     Copyright (C) Andrew Tridgell 1995-1999     This software may be distributed either under the terms of the    BSD-style license that accompanies tcpdump or the GNU GPL version 2    or later */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-smb.c,v 1.7 2000/12/05 06:42:47 guy Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"smb.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|request
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|uchar
modifier|*
name|startbuf
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|smbdescript
block|{
name|char
modifier|*
name|req_f1
decl_stmt|;
name|char
modifier|*
name|req_f2
decl_stmt|;
name|char
modifier|*
name|rep_f1
decl_stmt|;
name|char
modifier|*
name|rep_f2
decl_stmt|;
name|void
function_decl|(
modifier|*
name|fn
function_decl|)
parameter_list|()
function_decl|;
comment|/* sometimes (u_char *, u_char *, u_char *, u_char *) 		and sometimes (u_char *, u_char *, int, int) */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|smbfns
block|{
name|int
name|id
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|struct
name|smbdescript
name|descript
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|DEFDESCRIPT
value|{NULL,NULL,NULL,NULL,NULL}
end_define

begin_define
define|#
directive|define
name|FLG_CHAIN
value|(1<<0)
end_define

begin_function
specifier|static
name|struct
name|smbfns
modifier|*
name|smbfind
parameter_list|(
name|int
name|id
parameter_list|,
name|struct
name|smbfns
modifier|*
name|list
parameter_list|)
block|{
name|int
name|sindex
decl_stmt|;
for|for
control|(
name|sindex
operator|=
literal|0
init|;
name|list
index|[
name|sindex
index|]
operator|.
name|name
condition|;
name|sindex
operator|++
control|)
if|if
condition|(
name|list
index|[
name|sindex
index|]
operator|.
name|id
operator|==
name|id
condition|)
return|return
operator|(
operator|&
name|list
index|[
name|sindex
index|]
operator|)
return|;
return|return
operator|(
operator|&
name|list
index|[
literal|0
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|trans2_findfirst
parameter_list|(
name|uchar
modifier|*
name|param
parameter_list|,
name|uchar
modifier|*
name|data
parameter_list|,
name|int
name|pcnt
parameter_list|,
name|int
name|dcnt
parameter_list|)
block|{
name|char
modifier|*
name|fmt
decl_stmt|;
if|if
condition|(
name|request
condition|)
block|{
name|fmt
operator|=
literal|"Attribute=[A]\nSearchCount=[d]\nFlags=[w]\nLevel=[dP5]\nFile=[S]\n"
expr_stmt|;
block|}
else|else
block|{
name|fmt
operator|=
literal|"Handle=[w]\nCount=[d]\nEOS=[w]\nEoffset=[d]\nLastNameOfs=[w]\n"
expr_stmt|;
block|}
name|fdata
argument_list|(
name|param
argument_list|,
name|fmt
argument_list|,
name|param
operator|+
name|pcnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|dcnt
condition|)
block|{
name|printf
argument_list|(
literal|"data:\n"
argument_list|)
expr_stmt|;
name|print_data
argument_list|(
name|data
argument_list|,
name|dcnt
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|trans2_qfsinfo
parameter_list|(
name|uchar
modifier|*
name|param
parameter_list|,
name|uchar
modifier|*
name|data
parameter_list|,
name|int
name|pcnt
parameter_list|,
name|int
name|dcnt
parameter_list|)
block|{
specifier|static
name|int
name|level
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|fmt
init|=
literal|""
decl_stmt|;
if|if
condition|(
name|request
condition|)
block|{
name|level
operator|=
name|SVAL
argument_list|(
name|param
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fmt
operator|=
literal|"InfoLevel=[d]\n"
expr_stmt|;
name|fdata
argument_list|(
name|param
argument_list|,
name|fmt
argument_list|,
name|param
operator|+
name|pcnt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|level
condition|)
block|{
case|case
literal|1
case|:
name|fmt
operator|=
literal|"idFileSystem=[W]\nSectorUnit=[D]\nUnit=[D]\nAvail=[D]\nSectorSize=[d]\n"
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|fmt
operator|=
literal|"CreationTime=[T2]VolNameLength=[B]\nVolumeLabel=[s12]\n"
expr_stmt|;
break|break;
case|case
literal|0x105
case|:
name|fmt
operator|=
literal|"Capabilities=[W]\nMaxFileLen=[D]\nVolNameLen=[D]\nVolume=[S]\n"
expr_stmt|;
break|break;
default|default:
name|fmt
operator|=
literal|"UnknownLevel\n"
expr_stmt|;
block|}
name|fdata
argument_list|(
name|data
argument_list|,
name|fmt
argument_list|,
name|data
operator|+
name|dcnt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dcnt
condition|)
block|{
name|printf
argument_list|(
literal|"data:\n"
argument_list|)
expr_stmt|;
name|print_data
argument_list|(
name|data
argument_list|,
name|dcnt
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
name|struct
name|smbfns
name|trans2_fns
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"TRANSACT2_OPEN"
block|,
literal|0
block|,
block|{
literal|"Flags2=[w]\nMode=[w]\nSearchAttrib=[A]\nAttrib=[A]\nTime=[T2]\nOFun=[w]\nSize=[D]\nRes=([w,w,w,w,w])\nPath=[S]"
block|,
name|NULL
block|,
literal|"Handle=[d]\nAttrib=[A]\nTime=[T2]\nSize=[D]\nAccess=[w]\nType=[w]\nState=[w]\nAction=[w]\nInode=[W]\nOffErr=[d]\n|EALength=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
literal|1
block|,
literal|"TRANSACT2_FINDFIRST"
block|,
literal|0
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|trans2_findfirst
block|}
block|}
block|,
block|{
literal|2
block|,
literal|"TRANSACT2_FINDNEXT"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
literal|3
block|,
literal|"TRANSACT2_QFSINFO"
block|,
literal|0
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|trans2_qfsinfo
block|}
block|}
block|,
block|{
literal|4
block|,
literal|"TRANSACT2_SETFSINFO"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
literal|5
block|,
literal|"TRANSACT2_QPATHINFO"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
literal|6
block|,
literal|"TRANSACT2_SETPATHINFO"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
literal|7
block|,
literal|"TRANSACT2_QFILEINFO"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
literal|8
block|,
literal|"TRANSACT2_SETFILEINFO"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
literal|9
block|,
literal|"TRANSACT2_FSCTL"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
literal|10
block|,
literal|"TRANSACT2_IOCTL"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
literal|11
block|,
literal|"TRANSACT2_FINDNOTIFYFIRST"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
literal|12
block|,
literal|"TRANSACT2_FINDNOTIFYNEXT"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
literal|13
block|,
literal|"TRANSACT2_MKDIR"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
operator|-
literal|1
block|,
name|NULL
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|print_trans2
parameter_list|(
name|uchar
modifier|*
name|words
parameter_list|,
name|uchar
modifier|*
name|dat
parameter_list|,
name|uchar
modifier|*
name|buf
parameter_list|,
name|uchar
modifier|*
name|maxbuf
parameter_list|)
block|{
specifier|static
name|struct
name|smbfns
modifier|*
name|fn
init|=
operator|&
name|trans2_fns
index|[
literal|0
index|]
decl_stmt|;
name|uchar
modifier|*
name|data
decl_stmt|,
modifier|*
name|param
decl_stmt|;
name|uchar
modifier|*
name|f1
init|=
name|NULL
decl_stmt|,
modifier|*
name|f2
init|=
name|NULL
decl_stmt|;
name|int
name|pcnt
decl_stmt|,
name|dcnt
decl_stmt|;
if|if
condition|(
name|request
condition|)
block|{
name|fn
operator|=
name|smbfind
argument_list|(
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|14
operator|*
literal|2
argument_list|)
argument_list|,
name|trans2_fns
argument_list|)
expr_stmt|;
name|data
operator|=
name|buf
operator|+
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|12
operator|*
literal|2
argument_list|)
expr_stmt|;
name|param
operator|=
name|buf
operator|+
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|10
operator|*
literal|2
argument_list|)
expr_stmt|;
name|pcnt
operator|=
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|9
operator|*
literal|2
argument_list|)
expr_stmt|;
name|dcnt
operator|=
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|11
operator|*
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|data
operator|=
name|buf
operator|+
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|7
operator|*
literal|2
argument_list|)
expr_stmt|;
name|param
operator|=
name|buf
operator|+
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|4
operator|*
literal|2
argument_list|)
expr_stmt|;
name|pcnt
operator|=
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|3
operator|*
literal|2
argument_list|)
expr_stmt|;
name|dcnt
operator|=
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|6
operator|*
literal|2
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s param_length=%d data_length=%d\n"
argument_list|,
name|fn
operator|->
name|name
argument_list|,
name|pcnt
argument_list|,
name|dcnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
condition|)
block|{
if|if
condition|(
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|==
literal|8
condition|)
block|{
name|fdata
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|"Trans2Secondary\nTotParam=[d]\nTotData=[d]\nParamCnt=[d]\nParamOff=[d]\nParamDisp=[d]\nDataCnt=[d]\nDataOff=[d]\nDataDisp=[d]\nHandle=[d]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|fdata
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|"TotParam=[d]\nTotData=[d]\nMaxParam=[d]\nMaxData=[d]\nMaxSetup=[d]\nFlags=[w]\nTimeOut=[D]\nRes1=[w]\nParamCnt=[d]\nParamOff=[d]\nDataCnt=[d]\nDataOff=[d]\nSetupCnt=[d]\n"
argument_list|,
name|words
operator|+
literal|1
operator|+
literal|14
operator|*
literal|2
argument_list|)
expr_stmt|;
name|fdata
argument_list|(
name|data
operator|+
literal|1
argument_list|,
literal|"TransactionName=[S]\n%"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
block|}
name|f1
operator|=
name|fn
operator|->
name|descript
operator|.
name|req_f1
expr_stmt|;
name|f2
operator|=
name|fn
operator|->
name|descript
operator|.
name|req_f2
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Trans2Interim\n"
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|fdata
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|"TotParam=[d]\nTotData=[d]\nRes1=[w]\nParamCnt=[d]\nParamOff=[d]\nParamDisp[d]\nDataCnt=[d]\nDataOff=[d]\nDataDisp=[d]\nSetupCnt=[d]\n"
argument_list|,
name|words
operator|+
literal|1
operator|+
literal|10
operator|*
literal|2
argument_list|)
expr_stmt|;
block|}
name|f1
operator|=
name|fn
operator|->
name|descript
operator|.
name|rep_f1
expr_stmt|;
name|f2
operator|=
name|fn
operator|->
name|descript
operator|.
name|rep_f2
expr_stmt|;
block|}
if|if
condition|(
name|fn
operator|->
name|descript
operator|.
name|fn
condition|)
block|{
name|fn
operator|->
name|descript
operator|.
name|fn
argument_list|(
name|param
argument_list|,
name|data
argument_list|,
name|pcnt
argument_list|,
name|dcnt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fdata
argument_list|(
name|param
argument_list|,
name|f1
condition|?
name|f1
else|:
operator|(
name|uchar
operator|*
operator|)
literal|"Paramaters=\n"
argument_list|,
name|param
operator|+
name|pcnt
argument_list|)
expr_stmt|;
name|fdata
argument_list|(
name|data
argument_list|,
name|f2
condition|?
name|f2
else|:
operator|(
name|uchar
operator|*
operator|)
literal|"Data=\n"
argument_list|,
name|data
operator|+
name|dcnt
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_browse
parameter_list|(
name|uchar
modifier|*
name|param
parameter_list|,
name|int
name|paramlen
parameter_list|,
specifier|const
name|uchar
modifier|*
name|data
parameter_list|,
name|int
name|datalen
parameter_list|)
block|{
specifier|const
name|uchar
modifier|*
name|maxbuf
init|=
name|data
operator|+
name|datalen
decl_stmt|;
name|int
name|command
init|=
name|CVAL
argument_list|(
name|data
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|fdata
argument_list|(
name|param
argument_list|,
literal|"BROWSE PACKET\n|Param "
argument_list|,
name|param
operator|+
name|paramlen
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
literal|0xF
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"BROWSE PACKET:\nType=[B] (LocalMasterAnnouncement)\nUpdateCount=[w]\nRes1=[B]\nAnnounceInterval=[d]\nName=[n2]\nMajorVersion=[B]\nMinorVersion=[B]\nServerType=[W]\nElectionVersion=[w]\nBrowserConstant=[w]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x1
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"BROWSE PACKET:\nType=[B] (HostAnnouncement)\nUpdateCount=[w]\nRes1=[B]\nAnnounceInterval=[d]\nName=[n2]\nMajorVersion=[B]\nMinorVersion=[B]\nServerType=[W]\nElectionVersion=[w]\nBrowserConstant=[w]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x2
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"BROWSE PACKET:\nType=[B] (AnnouncementRequest)\nFlags=[B]\nReplySystemName=[S]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xc
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"BROWSE PACKET:\nType=[B] (WorkgroupAnnouncement)\nUpdateCount=[w]\nRes1=[B]\nAnnounceInterval=[d]\nName=[n2]\nMajorVersion=[B]\nMinorVersion=[B]\nServerType=[W]\nCommentPointer=[W]\nServerName=[S]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"BROWSE PACKET:\nType=[B] (ElectionFrame)\nElectionVersion=[B]\nOSSummary=[W]\nUptime=[(W,W)]\nServerName=[S]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"BROWSE PACKET:\nType=[B] (BecomeBackupBrowser)\nName=[S]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x9
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"BROWSE PACKET:\nType=[B] (GetBackupList)\nListCount?=[B]\nToken?=[B]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"BROWSE PACKET:\nType=[B] (BackupListResponse)\nServerCount?=[B]\nToken?=[B]*Name=[S]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xd
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"BROWSE PACKET:\nType=[B] (MasterAnnouncement)\nMasterName=[S]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xe
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"BROWSE PACKET:\nType=[B] (ResetBrowser)\nOptions=[B]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
default|default:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"Unknown Browser Frame "
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_ipc
parameter_list|(
name|uchar
modifier|*
name|param
parameter_list|,
name|int
name|paramlen
parameter_list|,
name|uchar
modifier|*
name|data
parameter_list|,
name|int
name|datalen
parameter_list|)
block|{
if|if
condition|(
name|paramlen
condition|)
name|fdata
argument_list|(
name|param
argument_list|,
literal|"Command=[w]\nStr1=[S]\nStr2=[S]\n"
argument_list|,
name|param
operator|+
name|paramlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|datalen
condition|)
name|fdata
argument_list|(
name|data
argument_list|,
literal|"IPC "
argument_list|,
name|data
operator|+
name|datalen
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_trans
parameter_list|(
name|uchar
modifier|*
name|words
parameter_list|,
name|uchar
modifier|*
name|data1
parameter_list|,
name|uchar
modifier|*
name|buf
parameter_list|,
name|uchar
modifier|*
name|maxbuf
parameter_list|)
block|{
name|uchar
modifier|*
name|f1
decl_stmt|,
modifier|*
name|f2
decl_stmt|,
modifier|*
name|f3
decl_stmt|,
modifier|*
name|f4
decl_stmt|;
name|uchar
modifier|*
name|data
decl_stmt|,
modifier|*
name|param
decl_stmt|;
name|int
name|datalen
decl_stmt|,
name|paramlen
decl_stmt|;
if|if
condition|(
name|request
condition|)
block|{
name|paramlen
operator|=
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|9
operator|*
literal|2
argument_list|)
expr_stmt|;
name|param
operator|=
name|buf
operator|+
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|10
operator|*
literal|2
argument_list|)
expr_stmt|;
name|datalen
operator|=
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|11
operator|*
literal|2
argument_list|)
expr_stmt|;
name|data
operator|=
name|buf
operator|+
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|12
operator|*
literal|2
argument_list|)
expr_stmt|;
name|f1
operator|=
literal|"TotParamCnt=[d] \nTotDataCnt=[d] \nMaxParmCnt=[d] \nMaxDataCnt=[d]\nMaxSCnt=[d] \nTransFlags=[w] \nRes1=[w] \nRes2=[w] \nRes3=[w]\nParamCnt=[d] \nParamOff=[d] \nDataCnt=[d] \nDataOff=[d] \nSUCnt=[d]\n"
expr_stmt|;
name|f2
operator|=
literal|"|Name=[S]\n"
expr_stmt|;
name|f3
operator|=
literal|"|Param "
expr_stmt|;
name|f4
operator|=
literal|"|Data "
expr_stmt|;
block|}
else|else
block|{
name|paramlen
operator|=
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|3
operator|*
literal|2
argument_list|)
expr_stmt|;
name|param
operator|=
name|buf
operator|+
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|4
operator|*
literal|2
argument_list|)
expr_stmt|;
name|datalen
operator|=
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|6
operator|*
literal|2
argument_list|)
expr_stmt|;
name|data
operator|=
name|buf
operator|+
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|7
operator|*
literal|2
argument_list|)
expr_stmt|;
name|f1
operator|=
literal|"TotParamCnt=[d] \nTotDataCnt=[d] \nRes1=[d]\nParamCnt=[d] \nParamOff=[d] \nRes2=[d] \nDataCnt=[d] \nDataOff=[d] \nRes3=[d]\nLsetup=[d]\n"
expr_stmt|;
name|f2
operator|=
literal|"|Unknown "
expr_stmt|;
name|f3
operator|=
literal|"|Param "
expr_stmt|;
name|f4
operator|=
literal|"|Data "
expr_stmt|;
block|}
name|fdata
argument_list|(
name|words
operator|+
literal|1
argument_list|,
name|f1
argument_list|,
name|MIN
argument_list|(
name|words
operator|+
literal|1
operator|+
literal|2
operator|*
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
argument_list|,
name|maxbuf
argument_list|)
argument_list|)
expr_stmt|;
name|fdata
argument_list|(
name|data1
operator|+
literal|2
argument_list|,
name|f2
argument_list|,
name|maxbuf
operator|-
operator|(
name|paramlen
operator|+
name|datalen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|data1
operator|+
literal|2
argument_list|,
literal|"\\MAILSLOT\\BROWSE"
argument_list|)
condition|)
block|{
name|print_browse
argument_list|(
name|param
argument_list|,
name|paramlen
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|data1
operator|+
literal|2
argument_list|,
literal|"\\PIPE\\LANMAN"
argument_list|)
condition|)
block|{
name|print_ipc
argument_list|(
name|param
argument_list|,
name|paramlen
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|paramlen
condition|)
name|fdata
argument_list|(
name|param
argument_list|,
name|f3
argument_list|,
name|MIN
argument_list|(
name|param
operator|+
name|paramlen
argument_list|,
name|maxbuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|datalen
condition|)
name|fdata
argument_list|(
name|data
argument_list|,
name|f4
argument_list|,
name|MIN
argument_list|(
name|data
operator|+
name|datalen
argument_list|,
name|maxbuf
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_negprot
parameter_list|(
name|uchar
modifier|*
name|words
parameter_list|,
name|uchar
modifier|*
name|data
parameter_list|,
name|uchar
modifier|*
name|buf
parameter_list|,
name|uchar
modifier|*
name|maxbuf
parameter_list|)
block|{
name|uchar
modifier|*
name|f1
init|=
name|NULL
decl_stmt|,
modifier|*
name|f2
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|request
condition|)
block|{
name|f2
operator|=
literal|"*|Dialect=[Z]\n"
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|==
literal|1
condition|)
block|{
name|f1
operator|=
literal|"Core Protocol\nDialectIndex=[d]"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|==
literal|17
condition|)
block|{
name|f1
operator|=
literal|"NT1 Protocol\nDialectIndex=[d]\nSecMode=[B]\nMaxMux=[d]\nNumVcs=[d]\nMaxBuffer=[D]\nRawSize=[D]\nSessionKey=[W]\nCapabilities=[W]\nServerTime=[T3]TimeZone=[d]\nCryptKey="
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|==
literal|13
condition|)
block|{
name|f1
operator|=
literal|"Coreplus/Lanman1/Lanman2 Protocol\nDialectIndex=[d]\nSecMode=[w]\nMaxXMit=[d]\nMaxMux=[d]\nMaxVcs=[d]\nBlkMode=[w]\nSessionKey=[W]\nServerTime=[T1]TimeZone=[d]\nRes=[W]\nCryptKey="
expr_stmt|;
block|}
block|}
if|if
condition|(
name|f1
condition|)
name|fdata
argument_list|(
name|words
operator|+
literal|1
argument_list|,
name|f1
argument_list|,
name|MIN
argument_list|(
name|words
operator|+
literal|1
operator|+
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|*
literal|2
argument_list|,
name|maxbuf
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|print_data
argument_list|(
name|words
operator|+
literal|1
argument_list|,
name|MIN
argument_list|(
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|*
literal|2
argument_list|,
name|PTR_DIFF
argument_list|(
name|maxbuf
argument_list|,
name|words
operator|+
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|f2
condition|)
name|fdata
argument_list|(
name|data
operator|+
literal|2
argument_list|,
name|f2
argument_list|,
name|MIN
argument_list|(
name|data
operator|+
literal|2
operator|+
name|SVAL
argument_list|(
name|data
argument_list|,
literal|0
argument_list|)
argument_list|,
name|maxbuf
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|print_data
argument_list|(
name|data
operator|+
literal|2
argument_list|,
name|MIN
argument_list|(
name|SVAL
argument_list|(
name|data
argument_list|,
literal|0
argument_list|)
argument_list|,
name|PTR_DIFF
argument_list|(
name|maxbuf
argument_list|,
name|data
operator|+
literal|2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_sesssetup
parameter_list|(
name|uchar
modifier|*
name|words
parameter_list|,
name|uchar
modifier|*
name|data
parameter_list|,
name|uchar
modifier|*
name|buf
parameter_list|,
name|uchar
modifier|*
name|maxbuf
parameter_list|)
block|{
name|int
name|wcnt
init|=
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|uchar
modifier|*
name|f1
init|=
name|NULL
decl_stmt|,
modifier|*
name|f2
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|request
condition|)
block|{
if|if
condition|(
name|wcnt
operator|==
literal|10
condition|)
block|{
name|f1
operator|=
literal|"Com2=[w]\nOff2=[d]\nBufSize=[d]\nMpxMax=[d]\nVcNum=[d]\nSessionKey=[W]\nPassLen=[d]\nCryptLen=[d]\nCryptOff=[d]\nPass&Name=\n"
expr_stmt|;
block|}
else|else
block|{
name|f1
operator|=
literal|"Com2=[B]\nRes1=[B]\nOff2=[d]\nMaxBuffer=[d]\nMaxMpx=[d]\nVcNumber=[d]\nSessionKey=[W]\nCaseInsensitivePasswordLength=[d]\nCaseSensitivePasswordLength=[d]\nRes=[W]\nCapabilities=[W]\nPass1&Pass2&Account&Domain&OS&LanMan=\n"
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|==
literal|3
condition|)
block|{
name|f1
operator|=
literal|"Com2=[w]\nOff2=[d]\nAction=[w]\n"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|==
literal|13
condition|)
block|{
name|f1
operator|=
literal|"Com2=[B]\nRes=[B]\nOff2=[d]\nAction=[w]\n"
expr_stmt|;
name|f2
operator|=
literal|"NativeOS=[S]\nNativeLanMan=[S]\nPrimaryDomain=[S]\n"
expr_stmt|;
block|}
block|}
if|if
condition|(
name|f1
condition|)
name|fdata
argument_list|(
name|words
operator|+
literal|1
argument_list|,
name|f1
argument_list|,
name|MIN
argument_list|(
name|words
operator|+
literal|1
operator|+
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|*
literal|2
argument_list|,
name|maxbuf
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|print_data
argument_list|(
name|words
operator|+
literal|1
argument_list|,
name|MIN
argument_list|(
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|*
literal|2
argument_list|,
name|PTR_DIFF
argument_list|(
name|maxbuf
argument_list|,
name|words
operator|+
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|f2
condition|)
name|fdata
argument_list|(
name|data
operator|+
literal|2
argument_list|,
name|f2
argument_list|,
name|MIN
argument_list|(
name|data
operator|+
literal|2
operator|+
name|SVAL
argument_list|(
name|data
argument_list|,
literal|0
argument_list|)
argument_list|,
name|maxbuf
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|print_data
argument_list|(
name|data
operator|+
literal|2
argument_list|,
name|MIN
argument_list|(
name|SVAL
argument_list|(
name|data
argument_list|,
literal|0
argument_list|)
argument_list|,
name|PTR_DIFF
argument_list|(
name|maxbuf
argument_list|,
name|data
operator|+
literal|2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|smbfns
name|smb_fns
index|[]
init|=
block|{
block|{
operator|-
literal|1
block|,
literal|"SMBunknown"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBtcon
block|,
literal|"SMBtcon"
block|,
literal|0
block|,
block|{
name|NULL
block|,
literal|"Path=[Z]\nPassword=[Z]\nDevice=[Z]\n"
block|,
literal|"MaxXmit=[d]\nTreeId=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBtdis
block|,
literal|"SMBtdis"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBexit
block|,
literal|"SMBexit"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBioctl
block|,
literal|"SMBioctl"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBecho
block|,
literal|"SMBecho"
block|,
literal|0
block|,
block|{
literal|"ReverbCount=[d]\n"
block|,
name|NULL
block|,
literal|"SequenceNum=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBulogoffX
block|,
literal|"SMBulogoffX"
block|,
name|FLG_CHAIN
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBgetatr
block|,
literal|"SMBgetatr"
block|,
literal|0
block|,
block|{
name|NULL
block|,
literal|"Path=[Z]\n"
block|,
literal|"Attribute=[A]\nTime=[T2]Size=[D]\nRes=([w,w,w,w,w])\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBsetatr
block|,
literal|"SMBsetatr"
block|,
literal|0
block|,
block|{
literal|"Attribute=[A]\nTime=[T2]Res=([w,w,w,w,w])\n"
block|,
literal|"Path=[Z]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBchkpth
block|,
literal|"SMBchkpth"
block|,
literal|0
block|,
block|{
name|NULL
block|,
literal|"Path=[Z]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBsearch
block|,
literal|"SMBsearch"
block|,
literal|0
block|,
block|{
literal|"Count=[d]\nAttrib=[A]\n"
block|,
literal|"Path=[Z]\nBlkType=[B]\nBlkLen=[d]\n|Res1=[B]\nMask=[s11]\nSrv1=[B]\nDirIndex=[d]\nSrv2=[w]\nRes2=[W]\n"
block|,
literal|"Count=[d]\n"
block|,
literal|"BlkType=[B]\nBlkLen=[d]\n*\nRes1=[B]\nMask=[s11]\nSrv1=[B]\nDirIndex=[d]\nSrv2=[w]\nRes2=[W]\nAttrib=[a]\nTime=[T1]Size=[D]\nName=[s13]\n"
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBopen
block|,
literal|"SMBopen"
block|,
literal|0
block|,
block|{
literal|"Mode=[w]\nAttribute=[A]\n"
block|,
literal|"Path=[Z]\n"
block|,
literal|"Handle=[d]\nOAttrib=[A]\nTime=[T2]Size=[D]\nAccess=[w]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBcreate
block|,
literal|"SMBcreate"
block|,
literal|0
block|,
block|{
literal|"Attrib=[A]\nTime=[T2]"
block|,
literal|"Path=[Z]\n"
block|,
literal|"Handle=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBmknew
block|,
literal|"SMBmknew"
block|,
literal|0
block|,
block|{
literal|"Attrib=[A]\nTime=[T2]"
block|,
literal|"Path=[Z]\n"
block|,
literal|"Handle=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBunlink
block|,
literal|"SMBunlink"
block|,
literal|0
block|,
block|{
literal|"Attrib=[A]\n"
block|,
literal|"Path=[Z]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBread
block|,
literal|"SMBread"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nByteCount=[d]\nOffset=[D]\nCountLeft=[d]\n"
block|,
name|NULL
block|,
literal|"Count=[d]\nRes=([w,w,w,w])\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBwrite
block|,
literal|"SMBwrite"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nByteCount=[d]\nOffset=[D]\nCountLeft=[d]\n"
block|,
name|NULL
block|,
literal|"Count=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBclose
block|,
literal|"SMBclose"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nTime=[T2]"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBmkdir
block|,
literal|"SMBmkdir"
block|,
literal|0
block|,
block|{
name|NULL
block|,
literal|"Path=[Z]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBrmdir
block|,
literal|"SMBrmdir"
block|,
literal|0
block|,
block|{
name|NULL
block|,
literal|"Path=[Z]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBdskattr
block|,
literal|"SMBdskattr"
block|,
literal|0
block|,
block|{
name|NULL
block|,
name|NULL
block|,
literal|"TotalUnits=[d]\nBlocksPerUnit=[d]\nBlockSize=[d]\nFreeUnits=[d]\nMedia=[w]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBmv
block|,
literal|"SMBmv"
block|,
literal|0
block|,
block|{
literal|"Attrib=[A]\n"
block|,
literal|"OldPath=[Z]\nNewPath=[Z]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
comment|/* this is a Pathworks specific call, allowing the     changing of the root path */
block|{
name|pSETDIR
block|,
literal|"SMBsetdir"
block|,
literal|0
block|,
block|{
name|NULL
block|,
literal|"Path=[Z]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBlseek
block|,
literal|"SMBlseek"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nMode=[w]\nOffset=[D]\n"
block|,
literal|"Offset=[D]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBflush
block|,
literal|"SMBflush"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBsplopen
block|,
literal|"SMBsplopen"
block|,
literal|0
block|,
block|{
literal|"SetupLen=[d]\nMode=[w]\n"
block|,
literal|"Ident=[Z]\n"
block|,
literal|"Handle=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBsplclose
block|,
literal|"SMBsplclose"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBsplretq
block|,
literal|"SMBsplretq"
block|,
literal|0
block|,
block|{
literal|"MaxCount=[d]\nStartIndex=[d]\n"
block|,
name|NULL
block|,
literal|"Count=[d]\nIndex=[d]\n"
block|,
literal|"*Time=[T2]Status=[B]\nJobID=[d]\nSize=[D]\nRes=[B]Name=[s16]\n"
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBsplwr
block|,
literal|"SMBsplwr"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBlock
block|,
literal|"SMBlock"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nCount=[D]\nOffset=[D]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBunlock
block|,
literal|"SMBunlock"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nCount=[D]\nOffset=[D]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
comment|/* CORE+ PROTOCOL FOLLOWS */
block|{
name|SMBreadbraw
block|,
literal|"SMBreadbraw"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nOffset=[D]\nMaxCount=[d]\nMinCount=[d]\nTimeOut=[D]\nRes=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBwritebraw
block|,
literal|"SMBwritebraw"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nTotalCount=[d]\nRes=[w]\nOffset=[D]\nTimeOut=[D]\nWMode=[w]\nRes2=[W]\n|DataSize=[d]\nDataOff=[d]\n"
block|,
name|NULL
block|,
literal|"WriteRawAck"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBwritec
block|,
literal|"SMBwritec"
block|,
literal|0
block|,
block|{
name|NULL
block|,
name|NULL
block|,
literal|"Count=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBwriteclose
block|,
literal|"SMBwriteclose"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nCount=[d]\nOffset=[D]\nTime=[T2]Res=([w,w,w,w,w,w])"
block|,
name|NULL
block|,
literal|"Count=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBlockread
block|,
literal|"SMBlockread"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nByteCount=[d]\nOffset=[D]\nCountLeft=[d]\n"
block|,
name|NULL
block|,
literal|"Count=[d]\nRes=([w,w,w,w])\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBwriteunlock
block|,
literal|"SMBwriteunlock"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nByteCount=[d]\nOffset=[D]\nCountLeft=[d]\n"
block|,
name|NULL
block|,
literal|"Count=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBreadBmpx
block|,
literal|"SMBreadBmpx"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nOffset=[D]\nMaxCount=[d]\nMinCount=[d]\nTimeOut=[D]\nRes=[w]\n"
block|,
name|NULL
block|,
literal|"Offset=[D]\nTotCount=[d]\nRemaining=[d]\nRes=([w,w])\nDataSize=[d]\nDataOff=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBwriteBmpx
block|,
literal|"SMBwriteBmpx"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nTotCount=[d]\nRes=[w]\nOffset=[D]\nTimeOut=[D]\nWMode=[w]\nRes2=[W]\nDataSize=[d]\nDataOff=[d]\n"
block|,
name|NULL
block|,
literal|"Remaining=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBwriteBs
block|,
literal|"SMBwriteBs"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nTotCount=[d]\nOffset=[D]\nRes=[W]\nDataSize=[d]\nDataOff=[d]\n"
block|,
name|NULL
block|,
literal|"Count=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBsetattrE
block|,
literal|"SMBsetattrE"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\nCreationTime=[T2]AccessTime=[T2]ModifyTime=[T2]"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBgetattrE
block|,
literal|"SMBgetattrE"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\n"
block|,
name|NULL
block|,
literal|"CreationTime=[T2]AccessTime=[T2]ModifyTime=[T2]Size=[D]\nAllocSize=[D]\nAttribute=[A]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBtranss
block|,
literal|"SMBtranss"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBioctls
block|,
literal|"SMBioctls"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBcopy
block|,
literal|"SMBcopy"
block|,
literal|0
block|,
block|{
literal|"TreeID2=[d]\nOFun=[w]\nFlags=[w]\n"
block|,
literal|"Path=[S]\nNewPath=[S]\n"
block|,
literal|"CopyCount=[d]\n"
block|,
literal|"|ErrStr=[S]\n"
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBmove
block|,
literal|"SMBmove"
block|,
literal|0
block|,
block|{
literal|"TreeID2=[d]\nOFun=[w]\nFlags=[w]\n"
block|,
literal|"Path=[S]\nNewPath=[S]\n"
block|,
literal|"MoveCount=[d]\n"
block|,
literal|"|ErrStr=[S]\n"
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBopenX
block|,
literal|"SMBopenX"
block|,
name|FLG_CHAIN
block|,
block|{
literal|"Com2=[w]\nOff2=[d]\nFlags=[w]\nMode=[w]\nSearchAttrib=[A]\nAttrib=[A]\nTime=[T2]OFun=[w]\nSize=[D]\nTimeOut=[D]\nRes=[W]\n"
block|,
literal|"Path=[S]\n"
block|,
literal|"Com2=[w]\nOff2=[d]\nHandle=[d]\nAttrib=[A]\nTime=[T2]Size=[D]\nAccess=[w]\nType=[w]\nState=[w]\nAction=[w]\nFileID=[W]\nRes=[w]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBreadX
block|,
literal|"SMBreadX"
block|,
name|FLG_CHAIN
block|,
block|{
literal|"Com2=[w]\nOff2=[d]\nHandle=[d]\nOffset=[D]\nMaxCount=[d]\nMinCount=[d]\nTimeOut=[D]\nCountLeft=[d]\n"
block|,
name|NULL
block|,
literal|"Com2=[w]\nOff2=[d]\nRemaining=[d]\nRes=[W]\nDataSize=[d]\nDataOff=[d]\nRes=([w,w,w,w])\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBwriteX
block|,
literal|"SMBwriteX"
block|,
name|FLG_CHAIN
block|,
block|{
literal|"Com2=[w]\nOff2=[d]\nHandle=[d]\nOffset=[D]\nTimeOut=[D]\nWMode=[w]\nCountLeft=[d]\nRes=[w]\nDataSize=[d]\nDataOff=[d]\n"
block|,
name|NULL
block|,
literal|"Com2=[w]\nOff2=[d]\nCount=[d]\nRemaining=[d]\nRes=[W]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBlockingX
block|,
literal|"SMBlockingX"
block|,
name|FLG_CHAIN
block|,
block|{
literal|"Com2=[w]\nOff2=[d]\nHandle=[d]\nLockType=[w]\nTimeOut=[D]\nUnlockCount=[d]\nLockCount=[d]\n"
block|,
literal|"*Process=[d]\nOffset=[D]\nLength=[D]\n"
block|,
literal|"Com2=[w]\nOff2=[d]\n"
block|}
block|}
block|,
block|{
name|SMBffirst
block|,
literal|"SMBffirst"
block|,
literal|0
block|,
block|{
literal|"Count=[d]\nAttrib=[A]\n"
block|,
literal|"Path=[Z]\nBlkType=[B]\nBlkLen=[d]\n|Res1=[B]\nMask=[s11]\nSrv1=[B]\nDirIndex=[d]\nSrv2=[w]\n"
block|,
literal|"Count=[d]\n"
block|,
literal|"BlkType=[B]\nBlkLen=[d]\n*\nRes1=[B]\nMask=[s11]\nSrv1=[B]\nDirIndex=[d]\nSrv2=[w]\nRes2=[W]\nAttrib=[a]\nTime=[T1]Size=[D]\nName=[s13]\n"
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBfunique
block|,
literal|"SMBfunique"
block|,
literal|0
block|,
block|{
literal|"Count=[d]\nAttrib=[A]\n"
block|,
literal|"Path=[Z]\nBlkType=[B]\nBlkLen=[d]\n|Res1=[B]\nMask=[s11]\nSrv1=[B]\nDirIndex=[d]\nSrv2=[w]\n"
block|,
literal|"Count=[d]\n"
block|,
literal|"BlkType=[B]\nBlkLen=[d]\n*\nRes1=[B]\nMask=[s11]\nSrv1=[B]\nDirIndex=[d]\nSrv2=[w]\nRes2=[W]\nAttrib=[a]\nTime=[T1]Size=[D]\nName=[s13]\n"
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBfclose
block|,
literal|"SMBfclose"
block|,
literal|0
block|,
block|{
literal|"Count=[d]\nAttrib=[A]\n"
block|,
literal|"Path=[Z]\nBlkType=[B]\nBlkLen=[d]\n|Res1=[B]\nMask=[s11]\nSrv1=[B]\nDirIndex=[d]\nSrv2=[w]\n"
block|,
literal|"Count=[d]\n"
block|,
literal|"BlkType=[B]\nBlkLen=[d]\n*\nRes1=[B]\nMask=[s11]\nSrv1=[B]\nDirIndex=[d]\nSrv2=[w]\nRes2=[W]\nAttrib=[a]\nTime=[T1]Size=[D]\nName=[s13]\n"
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBfindnclose
block|,
literal|"SMBfindnclose"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBfindclose
block|,
literal|"SMBfindclose"
block|,
literal|0
block|,
block|{
literal|"Handle=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBsends
block|,
literal|"SMBsends"
block|,
literal|0
block|,
block|{
name|NULL
block|,
literal|"Source=[Z]\nDest=[Z]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBsendstrt
block|,
literal|"SMBsendstrt"
block|,
literal|0
block|,
block|{
name|NULL
block|,
literal|"Source=[Z]\nDest=[Z]\n"
block|,
literal|"GroupID=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBsendend
block|,
literal|"SMBsendend"
block|,
literal|0
block|,
block|{
literal|"GroupID=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBsendtxt
block|,
literal|"SMBsendtxt"
block|,
literal|0
block|,
block|{
literal|"GroupID=[d]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBsendb
block|,
literal|"SMBsendb"
block|,
literal|0
block|,
block|{
name|NULL
block|,
literal|"Source=[Z]\nDest=[Z]\n"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBfwdname
block|,
literal|"SMBfwdname"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBcancelf
block|,
literal|"SMBcancelf"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBgetmac
block|,
literal|"SMBgetmac"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBnegprot
block|,
literal|"SMBnegprot"
block|,
literal|0
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|print_negprot
block|}
block|}
block|,
block|{
name|SMBsesssetupX
block|,
literal|"SMBsesssetupX"
block|,
name|FLG_CHAIN
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|print_sesssetup
block|}
block|}
block|,
block|{
name|SMBtconX
block|,
literal|"SMBtconX"
block|,
name|FLG_CHAIN
block|,
block|{
literal|"Com2=[w]\nOff2=[d]\nFlags=[w]\nPassLen=[d]\nPasswd&Path&Device=\n"
block|,
name|NULL
block|,
literal|"Com2=[w]\nOff2=[d]\n"
block|,
literal|"ServiceType=[S]\n"
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBtrans2
block|,
literal|"SMBtrans2"
block|,
literal|0
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|print_trans2
block|}
block|}
block|,
block|{
name|SMBtranss2
block|,
literal|"SMBtranss2"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBctemp
block|,
literal|"SMBctemp"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBreadBs
block|,
literal|"SMBreadBs"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBtrans
block|,
literal|"SMBtrans"
block|,
literal|0
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|print_trans
block|}
block|}
block|,
block|{
name|SMBnttrans
block|,
literal|"SMBnttrans"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBnttranss
block|,
literal|"SMBnttranss"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
name|SMBntcreateX
block|,
literal|"SMBntcreateX"
block|,
name|FLG_CHAIN
block|,
block|{
literal|"Com2=[w]\nOff2=[d]\nRes=[b]\nNameLen=[d]\nFlags=[W]\nRootDirectoryFid=[D]\nAccessMask=[W]\nAllocationSize=[L]\nExtFileAttributes=[W]\nShareAccess=[W]\nCreateDisposition=[W]\nCreateOptions=[W]\nImpersonationLevel=[W]\nSecurityFlags=[b]\n"
block|,
literal|"Path=[S]\n"
block|,
literal|"Com2=[w]\nOff2=[d]\nOplockLevel=[b]\nFid=[d]\nCreateAction=[W]\nCreateTime=[T3]LastAccessTime=[T3]LastWriteTime=[T3]ChangeTime=[T3]ExtFileAttributes=[W]\nAllocationSize=[L]\nEndOfFile=[L]\nFileType=[w]\nDeviceState=[w]\nDirectory=[b]\n"
block|,
name|NULL
block|}
block|}
block|,
block|{
name|SMBntcancel
block|,
literal|"SMBntcancel"
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|,
block|{
operator|-
literal|1
block|,
name|NULL
block|,
literal|0
block|,
name|DEFDESCRIPT
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/******************************************************************* print a SMB message ********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|print_smb
parameter_list|(
specifier|const
name|uchar
modifier|*
name|buf
parameter_list|,
specifier|const
name|uchar
modifier|*
name|maxbuf
parameter_list|)
block|{
name|int
name|command
decl_stmt|;
specifier|const
name|uchar
modifier|*
name|words
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|struct
name|smbfns
modifier|*
name|fn
decl_stmt|;
name|char
modifier|*
name|fmt_smbheader
init|=
literal|"[P4]SMB Command   =  [B]\nError class   =  [BP1]\nError code    =  [d]\nFlags1        =  [B]\nFlags2        =  [B][P13]\nTree ID       =  [d]\nProc ID       =  [d]\nUID           =  [d]\nMID           =  [d]\nWord Count    =  [b]\n"
decl_stmt|;
name|request
operator|=
operator|(
name|CVAL
argument_list|(
name|buf
argument_list|,
literal|9
argument_list|)
operator|&
literal|0x80
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|command
operator|=
name|CVAL
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|fn
operator|=
name|smbfind
argument_list|(
name|command
argument_list|,
name|smb_fns
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nSMB PACKET: %s (%s)\n"
argument_list|,
name|fn
operator|->
name|name
argument_list|,
name|request
condition|?
literal|"REQUEST"
else|:
literal|"REPLY"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|==
literal|0
condition|)
return|return;
comment|/* print out the header */
name|fdata
argument_list|(
name|buf
argument_list|,
name|fmt_smbheader
argument_list|,
name|buf
operator|+
literal|33
argument_list|)
expr_stmt|;
if|if
condition|(
name|CVAL
argument_list|(
name|buf
argument_list|,
literal|5
argument_list|)
condition|)
block|{
name|int
name|class
init|=
name|CVAL
argument_list|(
name|buf
argument_list|,
literal|5
argument_list|)
decl_stmt|;
name|int
name|num
init|=
name|SVAL
argument_list|(
name|buf
argument_list|,
literal|7
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"SMBError = %s\n"
argument_list|,
name|smb_errstr
argument_list|(
name|class
argument_list|,
name|num
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|words
operator|=
name|buf
operator|+
literal|32
expr_stmt|;
name|data
operator|=
name|words
operator|+
literal|1
operator|+
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|*
literal|2
expr_stmt|;
while|while
condition|(
name|words
operator|&&
name|data
condition|)
block|{
name|char
modifier|*
name|f1
decl_stmt|,
modifier|*
name|f2
decl_stmt|;
name|int
name|wct
init|=
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|request
condition|)
block|{
name|f1
operator|=
name|fn
operator|->
name|descript
operator|.
name|req_f1
expr_stmt|;
name|f2
operator|=
name|fn
operator|->
name|descript
operator|.
name|req_f2
expr_stmt|;
block|}
else|else
block|{
name|f1
operator|=
name|fn
operator|->
name|descript
operator|.
name|rep_f1
expr_stmt|;
name|f2
operator|=
name|fn
operator|->
name|descript
operator|.
name|rep_f2
expr_stmt|;
block|}
if|if
condition|(
name|fn
operator|->
name|descript
operator|.
name|fn
condition|)
block|{
name|fn
operator|->
name|descript
operator|.
name|fn
argument_list|(
name|words
argument_list|,
name|data
argument_list|,
name|buf
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|f1
condition|)
block|{
name|printf
argument_list|(
literal|"smbvwv[]=\n"
argument_list|)
expr_stmt|;
name|fdata
argument_list|(
name|words
operator|+
literal|1
argument_list|,
name|f1
argument_list|,
name|words
operator|+
literal|1
operator|+
name|wct
operator|*
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wct
condition|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|v
decl_stmt|;
name|printf
argument_list|(
literal|"smbvwv[]=\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wct
condition|;
name|i
operator|++
control|)
block|{
name|v
operator|=
name|SVAL
argument_list|(
name|words
operator|+
literal|1
argument_list|,
literal|2
operator|*
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"smb_vwv[%d]=%d (0x%X)\n"
argument_list|,
name|i
argument_list|,
name|v
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|f2
condition|)
block|{
name|printf
argument_list|(
literal|"smbbuf[]=\n"
argument_list|)
expr_stmt|;
name|fdata
argument_list|(
name|data
operator|+
literal|2
argument_list|,
name|f2
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|bcc
init|=
name|SVAL
argument_list|(
name|data
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"smb_bcc=%d\n"
argument_list|,
name|bcc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bcc
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"smb_buf[]=\n"
argument_list|)
expr_stmt|;
name|print_data
argument_list|(
name|data
operator|+
literal|2
argument_list|,
name|MIN
argument_list|(
name|bcc
argument_list|,
name|PTR_DIFF
argument_list|(
name|maxbuf
argument_list|,
name|data
operator|+
literal|2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|(
name|fn
operator|->
name|flags
operator|&
name|FLG_CHAIN
operator|)
operator|&&
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|&&
name|SVAL
argument_list|(
name|words
argument_list|,
literal|1
argument_list|)
operator|!=
literal|0xFF
condition|)
block|{
name|command
operator|=
name|SVAL
argument_list|(
name|words
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|words
operator|=
name|buf
operator|+
name|SVAL
argument_list|(
name|words
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|data
operator|=
name|words
operator|+
literal|1
operator|+
name|CVAL
argument_list|(
name|words
argument_list|,
literal|0
argument_list|)
operator|*
literal|2
expr_stmt|;
name|fn
operator|=
name|smbfind
argument_list|(
name|command
argument_list|,
name|smb_fns
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nSMB PACKET: %s (%s) (CHAINED)\n"
argument_list|,
name|fn
operator|->
name|name
argument_list|,
name|request
condition|?
literal|"REQUEST"
else|:
literal|"REPLY"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|words
operator|=
name|data
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*    print a NBT packet received across tcp on port 139 */
end_comment

begin_function
name|void
name|nbt_tcp_print
parameter_list|(
specifier|const
name|uchar
modifier|*
name|data
parameter_list|,
name|int
name|length
parameter_list|)
block|{
specifier|const
name|uchar
modifier|*
name|maxbuf
init|=
name|data
operator|+
name|length
decl_stmt|;
name|int
name|flags
init|=
name|CVAL
argument_list|(
name|data
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|int
name|nbt_len
init|=
name|RSVAL
argument_list|(
name|data
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|startbuf
operator|=
name|data
expr_stmt|;
if|if
condition|(
name|maxbuf
operator|<=
name|data
condition|)
return|return;
name|printf
argument_list|(
literal|"\n>>> NBT Packet\n"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|flags
condition|)
block|{
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"flags=0x%x\n"
argument_list|,
name|flags
argument_list|)
expr_stmt|;
case|case
literal|0
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"NBT Session Packet\nFlags=[rw]\nLength=[rd]\n"
argument_list|,
name|data
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|memcmp
argument_list|(
name|data
argument_list|,
literal|"\377SMB"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|nbt_len
operator|>
name|PTR_DIFF
argument_list|(
name|maxbuf
argument_list|,
name|data
argument_list|)
condition|)
name|printf
argument_list|(
literal|"WARNING: Short packet. Try increasing the snap length (%ld)\n"
argument_list|,
name|PTR_DIFF
argument_list|(
name|maxbuf
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|print_smb
argument_list|(
name|data
argument_list|,
name|maxbuf
operator|>
name|data
operator|+
name|nbt_len
condition|?
name|data
operator|+
name|nbt_len
else|:
name|maxbuf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Session packet:(raw data?)\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0x81
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"NBT Session Request\nFlags=[rW]\nDestination=[n1]\nSource=[n1]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x82
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"NBT Session Granted\nFlags=[rW]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x83
case|:
block|{
name|int
name|ecode
init|=
name|CVAL
argument_list|(
name|data
argument_list|,
literal|4
argument_list|)
decl_stmt|;
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"NBT SessionReject\nFlags=[rW]\nReason=[B]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ecode
condition|)
block|{
case|case
literal|0x80
case|:
name|printf
argument_list|(
literal|"Not listening on called name\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x81
case|:
name|printf
argument_list|(
literal|"Not listening for calling name\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x82
case|:
name|printf
argument_list|(
literal|"Called name not present\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x83
case|:
name|printf
argument_list|(
literal|"Called name present, but insufficient resources\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unspecified error 0x%X\n"
argument_list|,
name|ecode
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
break|break;
case|case
literal|0x85
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"NBT Session Keepalive\nFlags=[rW]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"flags=0x%x\n"
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"NBT - Unknown packet type\nType=[rW]\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*    print a NBT packet received across udp on port 137 */
end_comment

begin_function
name|void
name|nbt_udp137_print
parameter_list|(
specifier|const
name|uchar
modifier|*
name|data
parameter_list|,
name|int
name|length
parameter_list|)
block|{
specifier|const
name|uchar
modifier|*
name|maxbuf
init|=
name|data
operator|+
name|length
decl_stmt|;
name|int
name|name_trn_id
init|=
name|RSVAL
argument_list|(
name|data
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|int
name|response
init|=
operator|(
name|CVAL
argument_list|(
name|data
argument_list|,
literal|2
argument_list|)
operator|>>
literal|7
operator|)
decl_stmt|;
name|int
name|opcode
init|=
operator|(
name|CVAL
argument_list|(
name|data
argument_list|,
literal|2
argument_list|)
operator|>>
literal|3
operator|)
operator|&
literal|0xF
decl_stmt|;
name|int
name|nm_flags
init|=
operator|(
operator|(
name|CVAL
argument_list|(
name|data
argument_list|,
literal|2
argument_list|)
operator|&
literal|0x7
operator|)
operator|<<
literal|4
operator|)
operator|+
operator|(
name|CVAL
argument_list|(
name|data
argument_list|,
literal|3
argument_list|)
operator|>>
literal|4
operator|)
decl_stmt|;
name|int
name|rcode
init|=
name|CVAL
argument_list|(
name|data
argument_list|,
literal|3
argument_list|)
operator|&
literal|0xF
decl_stmt|;
name|int
name|qdcount
init|=
name|RSVAL
argument_list|(
name|data
argument_list|,
literal|4
argument_list|)
decl_stmt|;
name|int
name|ancount
init|=
name|RSVAL
argument_list|(
name|data
argument_list|,
literal|6
argument_list|)
decl_stmt|;
name|int
name|nscount
init|=
name|RSVAL
argument_list|(
name|data
argument_list|,
literal|8
argument_list|)
decl_stmt|;
name|int
name|arcount
init|=
name|RSVAL
argument_list|(
name|data
argument_list|,
literal|10
argument_list|)
decl_stmt|;
name|char
modifier|*
name|opcodestr
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
name|startbuf
operator|=
name|data
expr_stmt|;
if|if
condition|(
name|maxbuf
operator|<=
name|data
condition|)
return|return;
name|printf
argument_list|(
literal|"\n>>> NBT UDP PACKET(137): "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|opcode
condition|)
block|{
case|case
literal|0
case|:
name|opcodestr
operator|=
literal|"QUERY"
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|opcodestr
operator|=
literal|"REGISTRATION"
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|opcodestr
operator|=
literal|"RELEASE"
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|opcodestr
operator|=
literal|"WACK"
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|opcodestr
operator|=
literal|"REFRESH(8)"
expr_stmt|;
break|break;
case|case
literal|9
case|:
name|opcodestr
operator|=
literal|"REFRESH"
expr_stmt|;
break|break;
default|default:
name|opcodestr
operator|=
literal|"OPUNKNOWN"
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|opcodestr
argument_list|)
expr_stmt|;
if|if
condition|(
name|response
condition|)
block|{
if|if
condition|(
name|rcode
condition|)
name|printf
argument_list|(
literal|"; NEGATIVE"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"; POSITIVE"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|response
condition|)
name|printf
argument_list|(
literal|"; RESPONSE"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"; REQUEST"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nm_flags
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|"; BROADCAST"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"; UNICAST"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|==
literal|0
condition|)
return|return;
name|printf
argument_list|(
literal|"\nTrnID=0x%X\nOpCode=%d\nNmFlags=0x%X\nRcode=%d\nQueryCount=%d\nAnswerCount=%d\nAuthorityCount=%d\nAddressRecCount=%d\n"
argument_list|,
name|name_trn_id
argument_list|,
name|opcode
argument_list|,
name|nm_flags
argument_list|,
name|rcode
argument_list|,
name|qdcount
argument_list|,
name|ancount
argument_list|,
name|nscount
argument_list|,
name|arcount
argument_list|)
expr_stmt|;
name|p
operator|=
name|data
operator|+
literal|12
expr_stmt|;
block|{
name|int
name|total
init|=
name|ancount
operator|+
name|nscount
operator|+
name|arcount
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|qdcount
operator|>
literal|100
operator|||
name|total
operator|>
literal|100
condition|)
block|{
name|printf
argument_list|(
literal|"Corrupt packet??\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|qdcount
condition|)
block|{
name|printf
argument_list|(
literal|"QuestionRecords:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|qdcount
condition|;
name|i
operator|++
control|)
name|p
operator|=
name|fdata
argument_list|(
name|p
argument_list|,
literal|"|Name=[n1]\nQuestionType=[rw]\nQuestionClass=[rw]\n#"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|total
condition|)
block|{
name|printf
argument_list|(
literal|"\nResourceRecords:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|total
condition|;
name|i
operator|++
control|)
block|{
name|int
name|rdlen
decl_stmt|;
name|int
name|restype
decl_stmt|;
name|p
operator|=
name|fdata
argument_list|(
name|p
argument_list|,
literal|"Name=[n1]\n#"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|restype
operator|=
name|RSVAL
argument_list|(
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|p
operator|=
name|fdata
argument_list|(
name|p
argument_list|,
literal|"ResType=[rw]\nResClass=[rw]\nTTL=[rD]\n"
argument_list|,
name|p
operator|+
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|rdlen
operator|=
name|RSVAL
argument_list|(
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ResourceLength=%d\nResourceData=\n"
argument_list|,
name|rdlen
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|rdlen
operator|==
literal|6
condition|)
block|{
name|p
operator|=
name|fdata
argument_list|(
name|p
argument_list|,
literal|"AddrType=[rw]\nAddress=[b.b.b.b]\n"
argument_list|,
name|p
operator|+
name|rdlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
block|}
else|else
block|{
if|if
condition|(
name|restype
operator|==
literal|0x21
condition|)
block|{
name|int
name|numnames
init|=
name|CVAL
argument_list|(
name|p
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|p
operator|=
name|fdata
argument_list|(
name|p
argument_list|,
literal|"NumNames=[B]\n"
argument_list|,
name|p
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
while|while
condition|(
name|numnames
operator|--
condition|)
block|{
name|p
operator|=
name|fdata
argument_list|(
name|p
argument_list|,
literal|"Name=[n2]\t#"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|&
literal|0x80
condition|)
name|printf
argument_list|(
literal|"<GROUP> "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|p
index|[
literal|0
index|]
operator|&
literal|0x60
condition|)
block|{
case|case
literal|0x00
case|:
name|printf
argument_list|(
literal|"B "
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x20
case|:
name|printf
argument_list|(
literal|"P "
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x40
case|:
name|printf
argument_list|(
literal|"M "
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x60
case|:
name|printf
argument_list|(
literal|"_ "
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|&
literal|0x10
condition|)
name|printf
argument_list|(
literal|"<DEREGISTERING> "
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|&
literal|0x08
condition|)
name|printf
argument_list|(
literal|"<CONFLICT> "
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|&
literal|0x04
condition|)
name|printf
argument_list|(
literal|"<ACTIVE> "
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|&
literal|0x02
condition|)
name|printf
argument_list|(
literal|"<PERMANENT> "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
name|print_data
argument_list|(
name|p
argument_list|,
name|min
argument_list|(
name|rdlen
argument_list|,
name|length
operator|-
operator|(
operator|(
specifier|const
name|uchar
operator|*
operator|)
name|p
operator|-
name|data
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
name|rdlen
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
if|if
condition|(
operator|(
name|uchar
operator|*
operator|)
name|p
operator|<
name|maxbuf
condition|)
block|{
name|fdata
argument_list|(
name|p
argument_list|,
literal|"AdditionalData:\n"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*    print a NBT packet received across udp on port 138 */
end_comment

begin_function
name|void
name|nbt_udp138_print
parameter_list|(
specifier|const
name|uchar
modifier|*
name|data
parameter_list|,
name|int
name|length
parameter_list|)
block|{
specifier|const
name|uchar
modifier|*
name|maxbuf
init|=
name|data
operator|+
name|length
decl_stmt|;
name|startbuf
operator|=
name|data
expr_stmt|;
if|if
condition|(
name|maxbuf
operator|<=
name|data
condition|)
return|return;
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"\n>>> NBT UDP PACKET(138) Res=[rw] ID=[rw] IP=[b.b.b.b] Port=[rd] Length=[rd] Res2=[rw]\nSourceName=[n1]\nDestName=[n1]\n#"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
name|print_smb
argument_list|(
name|data
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*    print netbeui frames  */
end_comment

begin_function
name|void
name|netbeui_print
parameter_list|(
name|u_short
name|control
parameter_list|,
specifier|const
name|uchar
modifier|*
name|data
parameter_list|,
specifier|const
name|uchar
modifier|*
name|maxbuf
parameter_list|)
block|{
name|int
name|len
init|=
name|SVAL
argument_list|(
name|data
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|int
name|command
init|=
name|CVAL
argument_list|(
name|data
argument_list|,
literal|4
argument_list|)
decl_stmt|;
specifier|const
name|uchar
modifier|*
name|data2
init|=
name|data
operator|+
name|len
decl_stmt|;
name|int
name|is_truncated
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|data2
operator|>=
name|maxbuf
condition|)
block|{
name|data2
operator|=
name|maxbuf
expr_stmt|;
name|is_truncated
operator|=
literal|1
expr_stmt|;
block|}
name|startbuf
operator|=
name|data
expr_stmt|;
name|printf
argument_list|(
literal|"\n>>> NetBeui Packet\nType=0x%X "
argument_list|,
name|control
argument_list|)
expr_stmt|;
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"Length=[d] Signature=[w] Command=[B]\n#"
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
literal|0xA
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"NameQuery:[P1]\nSessionNumber=[B]\nNameType=[B][P2]\nResponseCorrelator=[w]\nDestination=[n2]\nSource=[n2]\n"
argument_list|,
name|data2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"NetbiosDataGram:[P7]\nDestination=[n2]\nSource=[n2]\n"
argument_list|,
name|data2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xE
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"NameRecognise:\n[P1]\nData2=[w]\nTransmitCorrelator=[w]\nResponseCorelator=[w]\nDestination=[n2]\nSource=[n2]\n"
argument_list|,
name|data2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x19
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"SessionInitialise:\nData1=[B]\nData2=[w]\nTransmitCorrelator=[w]\nResponseCorelator=[w]\nRemoteSessionNumber=[B]\nLocalSessionNumber=[B]\n"
argument_list|,
name|data2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x17
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"SessionConfirm:\nData1=[B]\nData2=[w]\nTransmitCorrelator=[w]\nResponseCorelator=[w]\nRemoteSessionNumber=[B]\nLocalSessionNumber=[B]\n"
argument_list|,
name|data2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x16
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"NetbiosDataOnlyLast:\nFlags=[{|NO_ACK|PIGGYBACK_ACK_ALLOWED|PIGGYBACK_ACK_INCLUDED|}]\nResyncIndicator=[w][P2]\nResponseCorelator=[w]\nRemoteSessionNumber=[B]\nLocalSessionNumber=[B]\n"
argument_list|,
name|data2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x14
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"NetbiosDataAck:\n[P3]TransmitCorrelator=[w][P2]\nRemoteSessionNumber=[B]\nLocalSessionNumber=[B]\n"
argument_list|,
name|data2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x18
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"SessionEnd:\n[P1]Data2=[w][P4]\nRemoteSessionNumber=[B]\nLocalSessionNumber=[B]\n"
argument_list|,
name|data2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x1f
case|:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"SessionAlive\n"
argument_list|,
name|data2
argument_list|)
expr_stmt|;
break|break;
default|default:
name|data
operator|=
name|fdata
argument_list|(
name|data
argument_list|,
literal|"Unknown Netbios Command "
argument_list|,
name|data2
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|is_truncated
condition|)
block|{
comment|/* data2 was past the end of the buffer */
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|data2
argument_list|,
literal|"\377SMB"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|print_smb
argument_list|(
name|data2
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|128
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|&
name|data2
index|[
name|i
index|]
operator|>=
name|maxbuf
condition|)
break|break;
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|data2
index|[
name|i
index|]
argument_list|,
literal|"\377SMB"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"found SMB packet at %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|print_smb
argument_list|(
operator|&
name|data2
index|[
name|i
index|]
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
name|out
label|:
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*    print IPX-Netbios frames  */
end_comment

begin_function
name|void
name|ipx_netbios_print
parameter_list|(
specifier|const
name|uchar
modifier|*
name|data
parameter_list|,
specifier|const
name|uchar
modifier|*
name|maxbuf
parameter_list|)
block|{
comment|/* this is a hack till I work out how to parse the rest of the IPX stuff */
name|int
name|i
decl_stmt|;
name|startbuf
operator|=
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|128
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|data
index|[
name|i
index|]
argument_list|,
literal|"\377SMB"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fdata
argument_list|(
name|data
argument_list|,
literal|"\n>>> IPX transport "
argument_list|,
operator|&
name|data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
name|print_smb
argument_list|(
operator|&
name|data
index|[
name|i
index|]
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|i
operator|==
literal|128
condition|)
name|fdata
argument_list|(
name|data
argument_list|,
literal|"\n>>> Unknown IPX "
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


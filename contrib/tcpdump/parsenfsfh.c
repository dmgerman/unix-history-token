begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * parsenfsfh.c - portable parser for NFS file handles  *			uses all sorts of heuristics  *  * Jeffrey C. Mogul  * Digital Equipment Corporation  * Western Research Laboratory  *  * $FreeBSD$  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/parsenfsfh.c,v 1.18 2000/07/01 03:39:00 assar Exp $ (LBL)"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"nfsfh.h"
end_include

begin_comment
comment|/*  * This routine attempts to parse a file handle (in network byte order),  * using heuristics to guess what kind of format it is in.  See the  * file "fhandle_layouts" for a detailed description of the various  * patterns we know about.  *  * The file handle is parsed into our internal representation of a  * file-system id, and an internal representation of an inode-number.  */
end_comment

begin_define
define|#
directive|define
name|FHT_UNKNOWN
value|0
end_define

begin_define
define|#
directive|define
name|FHT_AUSPEX
value|1
end_define

begin_define
define|#
directive|define
name|FHT_DECOSF
value|2
end_define

begin_define
define|#
directive|define
name|FHT_IRIX4
value|3
end_define

begin_define
define|#
directive|define
name|FHT_IRIX5
value|4
end_define

begin_define
define|#
directive|define
name|FHT_SUNOS3
value|5
end_define

begin_define
define|#
directive|define
name|FHT_SUNOS4
value|6
end_define

begin_define
define|#
directive|define
name|FHT_ULTRIX
value|7
end_define

begin_define
define|#
directive|define
name|FHT_VMSUCX
value|8
end_define

begin_define
define|#
directive|define
name|FHT_SUNOS5
value|9
end_define

begin_define
define|#
directive|define
name|FHT_AIX32
value|10
end_define

begin_define
define|#
directive|define
name|FHT_HPUX9
value|11
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|ultrix
end_ifdef

begin_comment
comment|/* Nasty hack to keep the Ultrix C compiler from emitting bogus warnings */
end_comment

begin_define
define|#
directive|define
name|XFF
parameter_list|(
name|x
parameter_list|)
value|((u_int32_t)(x))
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|XFF
parameter_list|(
name|x
parameter_list|)
value|(x)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|make_uint32
parameter_list|(
name|msb
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|,
name|lsb
parameter_list|)
define|\
value|(XFF(lsb) + (XFF(c)<<8) + (XFF(b)<<16) + (XFF(msb)<<24))
end_define

begin_define
define|#
directive|define
name|make_uint24
parameter_list|(
name|msb
parameter_list|,
name|b
parameter_list|,
name|lsb
parameter_list|)
define|\
value|(XFF(lsb) + (XFF(b)<<8) + (XFF(msb)<<16))
end_define

begin_define
define|#
directive|define
name|make_uint16
parameter_list|(
name|msb
parameter_list|,
name|lsb
parameter_list|)
define|\
value|(XFF(lsb) + (XFF(msb)<<8))
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|__alpha
end_ifdef

begin_comment
comment|/* or other 64-bit systems */
end_comment

begin_define
define|#
directive|define
name|make_uint48
parameter_list|(
name|msb
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|,
name|d
parameter_list|,
name|e
parameter_list|,
name|lsb
parameter_list|)
define|\
value|((lsb) + ((e)<<8) + ((d)<<16) + ((c)<<24) + ((b)<<32) + ((msb)<<40))
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* on 32-bit systems ignore high-order bits */
end_comment

begin_define
define|#
directive|define
name|make_uint48
parameter_list|(
name|msb
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|,
name|d
parameter_list|,
name|e
parameter_list|,
name|lsb
parameter_list|)
define|\
value|((lsb) + ((e)<<8) + ((d)<<16) + ((c)<<24))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|is_UCX
parameter_list|(
name|unsigned
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|Parse_fh
parameter_list|(
name|fh
parameter_list|,
name|len
parameter_list|,
name|fsidp
parameter_list|,
name|inop
parameter_list|,
name|osnamep
parameter_list|,
name|fsnamep
parameter_list|,
name|ourself
parameter_list|)
specifier|register
name|caddr_t
modifier|*
name|fh
decl_stmt|;
name|int
name|len
decl_stmt|;
name|my_fsid
modifier|*
name|fsidp
decl_stmt|;
name|ino_t
modifier|*
name|inop
decl_stmt|;
name|char
modifier|*
modifier|*
name|osnamep
decl_stmt|;
comment|/* if non-NULL, return OS name here */
name|char
modifier|*
modifier|*
name|fsnamep
decl_stmt|;
comment|/* if non-NULL, return server fs name here (for VMS) */
name|int
name|ourself
decl_stmt|;
comment|/* true if file handle was generated on this host */
block|{
specifier|register
name|unsigned
name|char
modifier|*
name|fhp
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|fh
decl_stmt|;
name|u_int32_t
name|temp
decl_stmt|;
name|int
name|fhtype
init|=
name|FHT_UNKNOWN
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ourself
condition|)
block|{
comment|/* File handle generated on this host, no need for guessing */
if|#
directive|if
name|defined
argument_list|(
name|IRIX40
argument_list|)
name|fhtype
operator|=
name|FHT_IRIX4
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|IRIX50
argument_list|)
name|fhtype
operator|=
name|FHT_IRIX5
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|IRIX51
argument_list|)
name|fhtype
operator|=
name|FHT_IRIX5
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|SUNOS4
argument_list|)
name|fhtype
operator|=
name|FHT_SUNOS4
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|SUNOS5
argument_list|)
name|fhtype
operator|=
name|FHT_SUNOS5
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|ultrix
argument_list|)
name|fhtype
operator|=
name|FHT_ULTRIX
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|__osf__
argument_list|)
name|fhtype
operator|=
name|FHT_DECOSF
expr_stmt|;
endif|#
directive|endif
block|}
comment|/* 	 * This is basically a big decision tree 	 */
elseif|else
if|if
condition|(
operator|(
name|fhp
index|[
literal|0
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|1
index|]
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* bytes[0,1] == (0,0); rules out Ultrix, IRIX5, SUNOS5 */
comment|/* probably rules out HP-UX, AIX unless they allow major=0 */
if|if
condition|(
operator|(
name|fhp
index|[
literal|2
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|3
index|]
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* bytes[2,3] == (0,0); must be Auspex */
comment|/* XXX or could be Ultrix+MASSBUS "hp" disk? */
name|fhtype
operator|=
name|FHT_AUSPEX
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * bytes[2,3] != (0,0); rules out Auspex, could be 		 * DECOSF, SUNOS4, or IRIX4 		 */
if|if
condition|(
operator|(
name|fhp
index|[
literal|4
index|]
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|5
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|8
index|]
operator|==
literal|12
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|9
index|]
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* seems to be DECOSF, with minor == 0 */
name|fhtype
operator|=
name|FHT_DECOSF
expr_stmt|;
block|}
else|else
block|{
comment|/* could be SUNOS4 or IRIX4 */
comment|/* XXX the test of fhp[5] == 8 could be wrong */
if|if
condition|(
operator|(
name|fhp
index|[
literal|4
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|5
index|]
operator|==
literal|8
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|6
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|7
index|]
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* looks like a length, not a file system typecode */
name|fhtype
operator|=
name|FHT_IRIX4
expr_stmt|;
block|}
else|else
block|{
comment|/* by elimination */
name|fhtype
operator|=
name|FHT_SUNOS4
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
comment|/* 	     * bytes[0,1] != (0,0); rules out Auspex, IRIX4, SUNOS4 	     * could be IRIX5, DECOSF, UCX, Ultrix, SUNOS5 	     * could be AIX, HP-UX 	     */
if|if
condition|(
operator|(
name|fhp
index|[
literal|2
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|3
index|]
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* 		 * bytes[2,3] == (0,0); rules out OSF, probably not UCX 		 * (unless the exported device name is just one letter!), 		 * could be Ultrix, IRIX5, AIX, or SUNOS5 		 * might be HP-UX (depends on their values for minor devs) 		 */
comment|/*XXX we probably only need to test of these two bytes */
if|if
condition|(
operator|(
name|fhp
index|[
literal|21
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|23
index|]
operator|==
literal|0
operator|)
condition|)
block|{
name|fhtype
operator|=
name|FHT_ULTRIX
expr_stmt|;
block|}
else|else
block|{
comment|/* Could be SUNOS5/IRIX5, maybe AIX */
comment|/* XXX no obvious difference between SUNOS5 and IRIX5 */
if|if
condition|(
name|fhp
index|[
literal|9
index|]
operator|==
literal|10
condition|)
name|fhtype
operator|=
name|FHT_SUNOS5
expr_stmt|;
comment|/* XXX what about AIX? */
block|}
block|}
else|else
block|{
comment|/* 		 * bytes[2,3] != (0,0); rules out Ultrix, could be 		 * DECOSF, SUNOS5, IRIX5, AIX, HP-UX, or UCX 		 */
if|if
condition|(
operator|(
name|fhp
index|[
literal|8
index|]
operator|==
literal|12
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|9
index|]
operator|==
literal|0
operator|)
condition|)
block|{
name|fhtype
operator|=
name|FHT_DECOSF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|fhp
index|[
literal|8
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|9
index|]
operator|==
literal|10
operator|)
condition|)
block|{
comment|/* could be SUNOS5/IRIX5, AIX, HP-UX */
if|if
condition|(
operator|(
name|fhp
index|[
literal|7
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|6
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|5
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|fhp
index|[
literal|4
index|]
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* XXX is this always true of HP-UX? */
name|fhtype
operator|=
name|FHT_HPUX9
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fhp
index|[
literal|7
index|]
operator|==
literal|2
condition|)
block|{
comment|/* This would be MNT_NFS on AIX, which is impossible */
name|fhtype
operator|=
name|FHT_SUNOS5
expr_stmt|;
comment|/* or maybe IRIX5 */
block|}
else|else
block|{
comment|/* 			 * XXX Could be SUNOS5/IRIX5 or AIX.  I don't 			 * XXX see any way to disambiguate these, so 			 * XXX I'm going with the more likely guess. 			 * XXX Sorry, Big Blue. 			 */
name|fhtype
operator|=
name|FHT_SUNOS5
expr_stmt|;
comment|/* or maybe IRIX5 */
block|}
block|}
else|else
block|{
if|if
condition|(
name|is_UCX
argument_list|(
name|fhp
argument_list|)
condition|)
block|{
name|fhtype
operator|=
name|FHT_VMSUCX
expr_stmt|;
block|}
else|else
block|{
name|fhtype
operator|=
name|FHT_UNKNOWN
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/* XXX still needs to handle SUNOS3 */
switch|switch
condition|(
name|fhtype
condition|)
block|{
case|case
name|FHT_AUSPEX
case|:
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Minor
operator|=
name|fhp
index|[
literal|7
index|]
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Major
operator|=
name|fhp
index|[
literal|6
index|]
expr_stmt|;
name|fsidp
operator|->
name|fsid_code
operator|=
literal|0
expr_stmt|;
name|temp
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|12
index|]
argument_list|,
name|fhp
index|[
literal|13
index|]
argument_list|,
name|fhp
index|[
literal|14
index|]
argument_list|,
name|fhp
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
operator|*
name|inop
operator|=
name|temp
expr_stmt|;
if|if
condition|(
name|osnamep
condition|)
operator|*
name|osnamep
operator|=
literal|"Auspex"
expr_stmt|;
break|break;
case|case
name|FHT_DECOSF
case|:
name|fsidp
operator|->
name|fsid_code
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|7
index|]
argument_list|,
name|fhp
index|[
literal|6
index|]
argument_list|,
name|fhp
index|[
literal|5
index|]
argument_list|,
name|fhp
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
comment|/* XXX could ignore 3 high-order bytes */
name|temp
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|3
index|]
argument_list|,
name|fhp
index|[
literal|2
index|]
argument_list|,
name|fhp
index|[
literal|1
index|]
argument_list|,
name|fhp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Minor
operator|=
name|temp
operator|&
literal|0xFFFFF
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Major
operator|=
operator|(
name|temp
operator|>>
literal|20
operator|)
operator|&
literal|0xFFF
expr_stmt|;
name|temp
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|15
index|]
argument_list|,
name|fhp
index|[
literal|14
index|]
argument_list|,
name|fhp
index|[
literal|13
index|]
argument_list|,
name|fhp
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
operator|*
name|inop
operator|=
name|temp
expr_stmt|;
if|if
condition|(
name|osnamep
condition|)
operator|*
name|osnamep
operator|=
literal|"OSF"
expr_stmt|;
break|break;
case|case
name|FHT_IRIX4
case|:
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Minor
operator|=
name|fhp
index|[
literal|3
index|]
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Major
operator|=
name|fhp
index|[
literal|2
index|]
expr_stmt|;
name|fsidp
operator|->
name|fsid_code
operator|=
literal|0
expr_stmt|;
name|temp
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|8
index|]
argument_list|,
name|fhp
index|[
literal|9
index|]
argument_list|,
name|fhp
index|[
literal|10
index|]
argument_list|,
name|fhp
index|[
literal|11
index|]
argument_list|)
expr_stmt|;
operator|*
name|inop
operator|=
name|temp
expr_stmt|;
if|if
condition|(
name|osnamep
condition|)
operator|*
name|osnamep
operator|=
literal|"IRIX4"
expr_stmt|;
break|break;
case|case
name|FHT_IRIX5
case|:
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Minor
operator|=
name|make_uint16
argument_list|(
name|fhp
index|[
literal|2
index|]
argument_list|,
name|fhp
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Major
operator|=
name|make_uint16
argument_list|(
name|fhp
index|[
literal|0
index|]
argument_list|,
name|fhp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|fsidp
operator|->
name|fsid_code
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|4
index|]
argument_list|,
name|fhp
index|[
literal|5
index|]
argument_list|,
name|fhp
index|[
literal|6
index|]
argument_list|,
name|fhp
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|temp
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|12
index|]
argument_list|,
name|fhp
index|[
literal|13
index|]
argument_list|,
name|fhp
index|[
literal|14
index|]
argument_list|,
name|fhp
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
operator|*
name|inop
operator|=
name|temp
expr_stmt|;
if|if
condition|(
name|osnamep
condition|)
operator|*
name|osnamep
operator|=
literal|"IRIX5"
expr_stmt|;
break|break;
case|case
name|FHT_SUNOS3
case|:
if|if
condition|(
name|osnamep
condition|)
operator|*
name|osnamep
operator|=
literal|"SUNOS3"
expr_stmt|;
break|break;
case|case
name|FHT_SUNOS4
case|:
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Minor
operator|=
name|fhp
index|[
literal|3
index|]
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Major
operator|=
name|fhp
index|[
literal|2
index|]
expr_stmt|;
name|fsidp
operator|->
name|fsid_code
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|4
index|]
argument_list|,
name|fhp
index|[
literal|5
index|]
argument_list|,
name|fhp
index|[
literal|6
index|]
argument_list|,
name|fhp
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|temp
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|12
index|]
argument_list|,
name|fhp
index|[
literal|13
index|]
argument_list|,
name|fhp
index|[
literal|14
index|]
argument_list|,
name|fhp
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
operator|*
name|inop
operator|=
name|temp
expr_stmt|;
if|if
condition|(
name|osnamep
condition|)
operator|*
name|osnamep
operator|=
literal|"SUNOS4"
expr_stmt|;
break|break;
case|case
name|FHT_SUNOS5
case|:
name|temp
operator|=
name|make_uint16
argument_list|(
name|fhp
index|[
literal|0
index|]
argument_list|,
name|fhp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Major
operator|=
operator|(
name|temp
operator|>>
literal|2
operator|)
operator|&
literal|0x3FFF
expr_stmt|;
name|temp
operator|=
name|make_uint24
argument_list|(
name|fhp
index|[
literal|1
index|]
argument_list|,
name|fhp
index|[
literal|2
index|]
argument_list|,
name|fhp
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Minor
operator|=
name|temp
operator|&
literal|0x3FFFF
expr_stmt|;
name|fsidp
operator|->
name|fsid_code
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|4
index|]
argument_list|,
name|fhp
index|[
literal|5
index|]
argument_list|,
name|fhp
index|[
literal|6
index|]
argument_list|,
name|fhp
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|temp
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|12
index|]
argument_list|,
name|fhp
index|[
literal|13
index|]
argument_list|,
name|fhp
index|[
literal|14
index|]
argument_list|,
name|fhp
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
operator|*
name|inop
operator|=
name|temp
expr_stmt|;
if|if
condition|(
name|osnamep
condition|)
operator|*
name|osnamep
operator|=
literal|"SUNOS5"
expr_stmt|;
break|break;
case|case
name|FHT_ULTRIX
case|:
name|fsidp
operator|->
name|fsid_code
operator|=
literal|0
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Minor
operator|=
name|fhp
index|[
literal|0
index|]
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Major
operator|=
name|fhp
index|[
literal|1
index|]
expr_stmt|;
name|temp
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|7
index|]
argument_list|,
name|fhp
index|[
literal|6
index|]
argument_list|,
name|fhp
index|[
literal|5
index|]
argument_list|,
name|fhp
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
operator|*
name|inop
operator|=
name|temp
expr_stmt|;
if|if
condition|(
name|osnamep
condition|)
operator|*
name|osnamep
operator|=
literal|"Ultrix"
expr_stmt|;
break|break;
case|case
name|FHT_VMSUCX
case|:
comment|/* No numeric file system ID, so hash on the device-name */
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|fsidp
argument_list|)
operator|>=
literal|14
condition|)
block|{
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|fsidp
argument_list|)
operator|>
literal|14
condition|)
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fsidp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fsidp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* just use the whole thing */
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fsidp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|fh
argument_list|,
literal|14
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u_int32_t
name|tempa
index|[
literal|4
index|]
decl_stmt|;
comment|/* at least 16 bytes, maybe more */
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tempa
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tempa
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tempa
argument_list|,
operator|(
name|char
operator|*
operator|)
name|fh
argument_list|,
literal|14
argument_list|)
expr_stmt|;
comment|/* ensure alignment */
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Minor
operator|=
name|tempa
index|[
literal|0
index|]
operator|+
operator|(
name|tempa
index|[
literal|1
index|]
operator|<<
literal|1
operator|)
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Major
operator|=
name|tempa
index|[
literal|2
index|]
operator|+
operator|(
name|tempa
index|[
literal|3
index|]
operator|<<
literal|1
operator|)
expr_stmt|;
name|fsidp
operator|->
name|fsid_code
operator|=
literal|0
expr_stmt|;
block|}
comment|/* VMS file ID is: (RVN, FidHi, FidLo) */
operator|*
name|inop
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|26
index|]
argument_list|,
name|fhp
index|[
literal|27
index|]
argument_list|,
name|fhp
index|[
literal|23
index|]
argument_list|,
name|fhp
index|[
literal|22
index|]
argument_list|)
expr_stmt|;
comment|/* Caller must save (and null-terminate?) this value */
if|if
condition|(
name|fsnamep
condition|)
operator|*
name|fsnamep
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|fhp
index|[
literal|1
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|osnamep
condition|)
operator|*
name|osnamep
operator|=
literal|"VMS"
expr_stmt|;
break|break;
case|case
name|FHT_AIX32
case|:
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Minor
operator|=
name|make_uint16
argument_list|(
name|fhp
index|[
literal|2
index|]
argument_list|,
name|fhp
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Major
operator|=
name|make_uint16
argument_list|(
name|fhp
index|[
literal|0
index|]
argument_list|,
name|fhp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|fsidp
operator|->
name|fsid_code
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|4
index|]
argument_list|,
name|fhp
index|[
literal|5
index|]
argument_list|,
name|fhp
index|[
literal|6
index|]
argument_list|,
name|fhp
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|temp
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|12
index|]
argument_list|,
name|fhp
index|[
literal|13
index|]
argument_list|,
name|fhp
index|[
literal|14
index|]
argument_list|,
name|fhp
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
operator|*
name|inop
operator|=
name|temp
expr_stmt|;
if|if
condition|(
name|osnamep
condition|)
operator|*
name|osnamep
operator|=
literal|"AIX32"
expr_stmt|;
break|break;
case|case
name|FHT_HPUX9
case|:
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Major
operator|=
name|fhp
index|[
literal|0
index|]
expr_stmt|;
name|temp
operator|=
name|make_uint24
argument_list|(
name|fhp
index|[
literal|1
index|]
argument_list|,
name|fhp
index|[
literal|2
index|]
argument_list|,
name|fhp
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Minor
operator|=
name|temp
expr_stmt|;
name|fsidp
operator|->
name|fsid_code
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|4
index|]
argument_list|,
name|fhp
index|[
literal|5
index|]
argument_list|,
name|fhp
index|[
literal|6
index|]
argument_list|,
name|fhp
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|temp
operator|=
name|make_uint32
argument_list|(
name|fhp
index|[
literal|12
index|]
argument_list|,
name|fhp
index|[
literal|13
index|]
argument_list|,
name|fhp
index|[
literal|14
index|]
argument_list|,
name|fhp
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
operator|*
name|inop
operator|=
name|temp
expr_stmt|;
if|if
condition|(
name|osnamep
condition|)
operator|*
name|osnamep
operator|=
literal|"HPUX9"
expr_stmt|;
break|break;
case|case
name|FHT_UNKNOWN
case|:
ifdef|#
directive|ifdef
name|DEBUG
comment|/* XXX debugging */
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%x."
argument_list|,
name|fhp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* XXX for now, give "bogus" values to aid debugging */
comment|/* Save the actual handle, so it can be display with -u */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
operator|&
operator|(
name|fsidp
operator|->
name|Opaque_Handle
index|[
name|i
operator|*
literal|2
index|]
operator|)
argument_list|,
literal|"%.2X"
argument_list|,
name|fhp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fsidp
operator|->
name|fsid_code
operator|=
literal|0
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Minor
operator|=
literal|257
expr_stmt|;
name|fsidp
operator|->
name|Fsid_dev
operator|.
name|Major
operator|=
literal|257
expr_stmt|;
operator|*
name|inop
operator|=
literal|1
expr_stmt|;
comment|/* display will show this string instead of (257,257) */
if|if
condition|(
name|fsnamep
condition|)
operator|*
name|fsnamep
operator|=
literal|"Unknown"
expr_stmt|;
if|if
condition|(
name|osnamep
condition|)
operator|*
name|osnamep
operator|=
literal|"Unknown"
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Is this a VMS UCX file handle?  *	Check for:  *	(1) leading code byte	[XXX not yet]  *	(2) followed by string of printing chars& spaces  *	(3) followed by string of nulls  */
end_comment

begin_function
specifier|static
name|int
name|is_UCX
parameter_list|(
name|fhp
parameter_list|)
name|unsigned
name|char
modifier|*
name|fhp
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|seen_null
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|14
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|isprint
argument_list|(
name|fhp
index|[
name|i
index|]
argument_list|)
condition|)
block|{
if|if
condition|(
name|seen_null
condition|)
return|return
operator|(
literal|0
operator|)
return|;
else|else
continue|continue;
block|}
elseif|else
if|if
condition|(
name|fhp
index|[
name|i
index|]
operator|==
literal|0
condition|)
block|{
name|seen_null
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

end_unit


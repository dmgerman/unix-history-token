begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 1995, 1996, 1997, and 1998 WIDE Project.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the project nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_define
define|#
directive|define
name|NETDISSECT_REWORKED
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* The functions from print-esp.c used in this file are only defined when both  * OpenSSL and evp.h are detected. Employ the same preprocessor device here.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|HAVE_OPENSSL_EVP_H
end_ifndef

begin_undef
undef|#
directive|undef
name|HAVE_LIBCRYPTO
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_comment
comment|/* must come after interface.h */
end_comment

begin_include
include|#
directive|include
file|"ip.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_include
include|#
directive|include
file|"ip6.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* refer to RFC 2408 */
end_comment

begin_typedef
typedef|typedef
name|u_char
name|cookie_t
index|[
literal|8
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|u_char
name|msgid_t
index|[
literal|4
index|]
typedef|;
end_typedef

begin_define
define|#
directive|define
name|PORT_ISAKMP
value|500
end_define

begin_comment
comment|/* 3.1 ISAKMP Header Format (IKEv1 and IKEv2)          0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+         !                          Initiator                            !         !                            Cookie                             !         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+         !                          Responder                            !         !                            Cookie                             !         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+         !  Next Payload ! MjVer ! MnVer ! Exchange Type !     Flags     !         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+         !                          Message ID                           !         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+         !                            Length                             !         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ */
end_comment

begin_struct
struct|struct
name|isakmp
block|{
name|cookie_t
name|i_ck
decl_stmt|;
comment|/* Initiator Cookie */
name|cookie_t
name|r_ck
decl_stmt|;
comment|/* Responder Cookie */
name|uint8_t
name|np
decl_stmt|;
comment|/* Next Payload Type */
name|uint8_t
name|vers
decl_stmt|;
define|#
directive|define
name|ISAKMP_VERS_MAJOR
value|0xf0
define|#
directive|define
name|ISAKMP_VERS_MAJOR_SHIFT
value|4
define|#
directive|define
name|ISAKMP_VERS_MINOR
value|0x0f
define|#
directive|define
name|ISAKMP_VERS_MINOR_SHIFT
value|0
name|uint8_t
name|etype
decl_stmt|;
comment|/* Exchange Type */
name|uint8_t
name|flags
decl_stmt|;
comment|/* Flags */
name|msgid_t
name|msgid
decl_stmt|;
name|uint32_t
name|len
decl_stmt|;
comment|/* Length */
block|}
struct|;
end_struct

begin_comment
comment|/* Next Payload Type */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_NONE
value|0
end_define

begin_comment
comment|/* NONE*/
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_SA
value|1
end_define

begin_comment
comment|/* Security Association */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_P
value|2
end_define

begin_comment
comment|/* Proposal */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_T
value|3
end_define

begin_comment
comment|/* Transform */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_KE
value|4
end_define

begin_comment
comment|/* Key Exchange */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_ID
value|5
end_define

begin_comment
comment|/* Identification */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_CERT
value|6
end_define

begin_comment
comment|/* Certificate */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_CR
value|7
end_define

begin_comment
comment|/* Certificate Request */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_HASH
value|8
end_define

begin_comment
comment|/* Hash */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_SIG
value|9
end_define

begin_comment
comment|/* Signature */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_NONCE
value|10
end_define

begin_comment
comment|/* Nonce */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_N
value|11
end_define

begin_comment
comment|/* Notification */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_D
value|12
end_define

begin_comment
comment|/* Delete */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_VID
value|13
end_define

begin_comment
comment|/* Vendor ID */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NPTYPE_v2E
value|46
end_define

begin_comment
comment|/* v2 Encrypted payload */
end_comment

begin_define
define|#
directive|define
name|IKEv1_MAJOR_VERSION
value|1
end_define

begin_define
define|#
directive|define
name|IKEv1_MINOR_VERSION
value|0
end_define

begin_define
define|#
directive|define
name|IKEv2_MAJOR_VERSION
value|2
end_define

begin_define
define|#
directive|define
name|IKEv2_MINOR_VERSION
value|0
end_define

begin_comment
comment|/* Flags */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_FLAG_E
value|0x01
end_define

begin_comment
comment|/* Encryption Bit */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_FLAG_C
value|0x02
end_define

begin_comment
comment|/* Commit Bit */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_FLAG_extra
value|0x04
end_define

begin_comment
comment|/* IKEv2 */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_FLAG_I
value|(1<< 3)
end_define

begin_comment
comment|/* (I)nitiator */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_FLAG_V
value|(1<< 4)
end_define

begin_comment
comment|/* (V)ersion   */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_FLAG_R
value|(1<< 5)
end_define

begin_comment
comment|/* (R)esponse  */
end_comment

begin_comment
comment|/* 3.2 Payload Generic Header          0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+         ! Next Payload  !   RESERVED    !         Payload Length        !         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ */
end_comment

begin_struct
struct|struct
name|isakmp_gen
block|{
name|uint8_t
name|np
decl_stmt|;
comment|/* Next Payload */
name|uint8_t
name|critical
decl_stmt|;
comment|/* bit 7 - critical, rest is RESERVED */
name|uint16_t
name|len
decl_stmt|;
comment|/* Payload Length */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.3 Data Attributes          0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+         !A!       Attribute Type        !    AF=0  Attribute Length     !         !F!                             !    AF=1  Attribute Value      !         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+         .                   AF=0  Attribute Value                       .         .                   AF=1  Not Transmitted                       .         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ */
end_comment

begin_struct
struct|struct
name|isakmp_data
block|{
name|uint16_t
name|type
decl_stmt|;
comment|/* defined by DOI-spec, and Attribute Format */
name|uint16_t
name|lorv
decl_stmt|;
comment|/* if f equal 1, Attribute Length */
comment|/* if f equal 0, Attribute Value */
comment|/* if f equal 1, Attribute Value */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.4 Security Association Payload */
end_comment

begin_comment
comment|/* MAY NOT be used, because of being defined in ipsec-doi. */
end_comment

begin_comment
comment|/* 	If the current payload is the last in the message, 	then the value of the next payload field will be 0. 	This field MUST NOT contain the 	values for the Proposal or Transform payloads as they are considered 	part of the security association negotiation.  For example, this 	field would contain the value "10" (Nonce payload) in the first 	message of a Base Exchange (see Section 4.4) and the value "0" in the 	first message of an Identity Protect Exchange (see Section 4.5). 	*/
end_comment

begin_struct
struct|struct
name|ikev1_pl_sa
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint32_t
name|doi
decl_stmt|;
comment|/* Domain of Interpretation */
name|uint32_t
name|sit
decl_stmt|;
comment|/* Situation */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.5 Proposal Payload */
end_comment

begin_comment
comment|/* 	The value of the next payload field MUST only contain the value "2" 	or "0".  If there are additional Proposal payloads in the message, 	then this field will be 2.  If the current Proposal payload is the 	last within the security association proposal, then this field will 	be 0. 	*/
end_comment

begin_struct
struct|struct
name|ikev1_pl_p
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint8_t
name|p_no
decl_stmt|;
comment|/* Proposal # */
name|uint8_t
name|prot_id
decl_stmt|;
comment|/* Protocol */
name|uint8_t
name|spi_size
decl_stmt|;
comment|/* SPI Size */
name|uint8_t
name|num_t
decl_stmt|;
comment|/* Number of Transforms */
comment|/* SPI */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.6 Transform Payload */
end_comment

begin_comment
comment|/* 	The value of the next payload field MUST only contain the value "3" 	or "0".  If there are additional Transform payloads in the proposal, 	then this field will be 3.  If the current Transform payload is the 	last within the proposal, then this field will be 0. 	*/
end_comment

begin_struct
struct|struct
name|ikev1_pl_t
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint8_t
name|t_no
decl_stmt|;
comment|/* Transform # */
name|uint8_t
name|t_id
decl_stmt|;
comment|/* Transform-Id */
name|uint16_t
name|reserved
decl_stmt|;
comment|/* RESERVED2 */
comment|/* SA Attributes */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.7 Key Exchange Payload */
end_comment

begin_struct
struct|struct
name|ikev1_pl_ke
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
comment|/* Key Exchange Data */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.8 Identification Payload */
end_comment

begin_comment
comment|/* MUST NOT to be used, because of being defined in ipsec-doi. */
end_comment

begin_struct
struct|struct
name|ikev1_pl_id
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
union|union
block|{
name|uint8_t
name|id_type
decl_stmt|;
comment|/* ID Type */
name|uint32_t
name|doi_data
decl_stmt|;
comment|/* DOI Specific ID Data */
block|}
name|d
union|;
comment|/* Identification Data */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.9 Certificate Payload */
end_comment

begin_struct
struct|struct
name|ikev1_pl_cert
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint8_t
name|encode
decl_stmt|;
comment|/* Cert Encoding */
name|char
name|cert
decl_stmt|;
comment|/* Certificate Data */
comment|/* 		This field indicates the type of 		certificate or certificate-related information contained in the 		Certificate Data field. 		*/
block|}
struct|;
end_struct

begin_comment
comment|/* 3.10 Certificate Request Payload */
end_comment

begin_struct
struct|struct
name|ikev1_pl_cr
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint8_t
name|num_cert
decl_stmt|;
comment|/* # Cert. Types */
comment|/* 	Certificate Types (variable length) 	  -- Contains a list of the types of certificates requested, 	  sorted in order of preference.  Each individual certificate 	  type is 1 octet.  This field is NOT requiredo 	*/
comment|/* # Certificate Authorities (1 octet) */
comment|/* Certificate Authorities (variable length) */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.11 Hash Payload */
end_comment

begin_comment
comment|/* may not be used, because of having only data. */
end_comment

begin_struct
struct|struct
name|ikev1_pl_hash
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
comment|/* Hash Data */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.12 Signature Payload */
end_comment

begin_comment
comment|/* may not be used, because of having only data. */
end_comment

begin_struct
struct|struct
name|ikev1_pl_sig
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
comment|/* Signature Data */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.13 Nonce Payload */
end_comment

begin_comment
comment|/* may not be used, because of having only data. */
end_comment

begin_struct
struct|struct
name|ikev1_pl_nonce
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
comment|/* Nonce Data */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.14 Notification Payload */
end_comment

begin_struct
struct|struct
name|ikev1_pl_n
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint32_t
name|doi
decl_stmt|;
comment|/* Domain of Interpretation */
name|uint8_t
name|prot_id
decl_stmt|;
comment|/* Protocol-ID */
name|uint8_t
name|spi_size
decl_stmt|;
comment|/* SPI Size */
name|uint16_t
name|type
decl_stmt|;
comment|/* Notify Message Type */
comment|/* SPI */
comment|/* Notification Data */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.14.1 Notify Message Types */
end_comment

begin_comment
comment|/* NOTIFY MESSAGES - ERROR TYPES */
end_comment

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_PAYLOAD_TYPE
value|1
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_DOI_NOT_SUPPORTED
value|2
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_SITUATION_NOT_SUPPORTED
value|3
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_COOKIE
value|4
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_MAJOR_VERSION
value|5
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_MINOR_VERSION
value|6
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_EXCHANGE_TYPE
value|7
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_FLAGS
value|8
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_MESSAGE_ID
value|9
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_PROTOCOL_ID
value|10
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_SPI
value|11
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_TRANSFORM_ID
value|12
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_ATTRIBUTES_NOT_SUPPORTED
value|13
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_NO_PROPOSAL_CHOSEN
value|14
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_BAD_PROPOSAL_SYNTAX
value|15
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_PAYLOAD_MALFORMED
value|16
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_KEY_INFORMATION
value|17
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_ID_INFORMATION
value|18
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_CERT_ENCODING
value|19
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_CERTIFICATE
value|20
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_BAD_CERT_REQUEST_SYNTAX
value|21
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_CERT_AUTHORITY
value|22
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_HASH_INFORMATION
value|23
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_AUTHENTICATION_FAILED
value|24
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_INVALID_SIGNATURE
value|25
end_define

begin_define
define|#
directive|define
name|ISAKMP_NTYPE_ADDRESS_NOTIFICATION
value|26
end_define

begin_comment
comment|/* 3.15 Delete Payload */
end_comment

begin_struct
struct|struct
name|ikev1_pl_d
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint32_t
name|doi
decl_stmt|;
comment|/* Domain of Interpretation */
name|uint8_t
name|prot_id
decl_stmt|;
comment|/* Protocol-Id */
name|uint8_t
name|spi_size
decl_stmt|;
comment|/* SPI Size */
name|uint16_t
name|num_spi
decl_stmt|;
comment|/* # of SPIs */
comment|/* SPI(es) */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ikev1_ph1tab
block|{
name|struct
name|ikev1_ph1
modifier|*
name|head
decl_stmt|;
name|struct
name|ikev1_ph1
modifier|*
name|tail
decl_stmt|;
name|int
name|len
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|isakmp_ph2tab
block|{
name|struct
name|ikev1_ph2
modifier|*
name|head
decl_stmt|;
name|struct
name|ikev1_ph2
modifier|*
name|tail
decl_stmt|;
name|int
name|len
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* IKEv2 (RFC4306) */
end_comment

begin_comment
comment|/* 3.3  Security Association Payload -- generic header */
end_comment

begin_comment
comment|/* 3.3.1.  Proposal Substructure */
end_comment

begin_struct
struct|struct
name|ikev2_p
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint8_t
name|p_no
decl_stmt|;
comment|/* Proposal # */
name|uint8_t
name|prot_id
decl_stmt|;
comment|/* Protocol */
name|uint8_t
name|spi_size
decl_stmt|;
comment|/* SPI Size */
name|uint8_t
name|num_t
decl_stmt|;
comment|/* Number of Transforms */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.3.2.  Transform Substructure */
end_comment

begin_struct
struct|struct
name|ikev2_t
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint8_t
name|t_type
decl_stmt|;
comment|/* Transform Type (ENCR,PRF,INTEG,etc.*/
name|uint8_t
name|res2
decl_stmt|;
comment|/* reserved byte */
name|uint16_t
name|t_id
decl_stmt|;
comment|/* Transform ID */
block|}
struct|;
end_struct

begin_enum
enum|enum
name|ikev2_t_type
block|{
name|IV2_T_ENCR
init|=
literal|1
block|,
name|IV2_T_PRF
init|=
literal|2
block|,
name|IV2_T_INTEG
init|=
literal|3
block|,
name|IV2_T_DH
init|=
literal|4
block|,
name|IV2_T_ESN
init|=
literal|5
block|, }
enum|;
end_enum

begin_comment
comment|/* 3.4.  Key Exchange Payload */
end_comment

begin_struct
struct|struct
name|ikev2_ke
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint16_t
name|ke_group
decl_stmt|;
name|uint16_t
name|ke_res1
decl_stmt|;
comment|/* KE data */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.5.  Identification Payloads */
end_comment

begin_enum
enum|enum
name|ikev2_id_type
block|{
name|ID_IPV4_ADDR
init|=
literal|1
block|,
name|ID_FQDN
init|=
literal|2
block|,
name|ID_RFC822_ADDR
init|=
literal|3
block|,
name|ID_IPV6_ADDR
init|=
literal|5
block|,
name|ID_DER_ASN1_DN
init|=
literal|9
block|,
name|ID_DER_ASN1_GN
init|=
literal|10
block|,
name|ID_KEY_ID
init|=
literal|11
block|, }
enum|;
end_enum

begin_struct
struct|struct
name|ikev2_id
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint8_t
name|type
decl_stmt|;
comment|/* ID type */
name|uint8_t
name|res1
decl_stmt|;
name|uint16_t
name|res2
decl_stmt|;
comment|/* SPI */
comment|/* Notification Data */
block|}
struct|;
end_struct

begin_comment
comment|/* 3.10 Notification Payload */
end_comment

begin_struct
struct|struct
name|ikev2_n
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint8_t
name|prot_id
decl_stmt|;
comment|/* Protocol-ID */
name|uint8_t
name|spi_size
decl_stmt|;
comment|/* SPI Size */
name|uint16_t
name|type
decl_stmt|;
comment|/* Notify Message Type */
block|}
struct|;
end_struct

begin_enum
enum|enum
name|ikev2_n_type
block|{
name|IV2_NOTIFY_UNSUPPORTED_CRITICAL_PAYLOAD
init|=
literal|1
block|,
name|IV2_NOTIFY_INVALID_IKE_SPI
init|=
literal|4
block|,
name|IV2_NOTIFY_INVALID_MAJOR_VERSION
init|=
literal|5
block|,
name|IV2_NOTIFY_INVALID_SYNTAX
init|=
literal|7
block|,
name|IV2_NOTIFY_INVALID_MESSAGE_ID
init|=
literal|9
block|,
name|IV2_NOTIFY_INVALID_SPI
init|=
literal|11
block|,
name|IV2_NOTIFY_NO_PROPOSAL_CHOSEN
init|=
literal|14
block|,
name|IV2_NOTIFY_INVALID_KE_PAYLOAD
init|=
literal|17
block|,
name|IV2_NOTIFY_AUTHENTICATION_FAILED
init|=
literal|24
block|,
name|IV2_NOTIFY_SINGLE_PAIR_REQUIRED
init|=
literal|34
block|,
name|IV2_NOTIFY_NO_ADDITIONAL_SAS
init|=
literal|35
block|,
name|IV2_NOTIFY_INTERNAL_ADDRESS_FAILURE
init|=
literal|36
block|,
name|IV2_NOTIFY_FAILED_CP_REQUIRED
init|=
literal|37
block|,
name|IV2_NOTIFY_INVALID_SELECTORS
init|=
literal|39
block|,
name|IV2_NOTIFY_INITIAL_CONTACT
init|=
literal|16384
block|,
name|IV2_NOTIFY_SET_WINDOW_SIZE
init|=
literal|16385
block|,
name|IV2_NOTIFY_ADDITIONAL_TS_POSSIBLE
init|=
literal|16386
block|,
name|IV2_NOTIFY_IPCOMP_SUPPORTED
init|=
literal|16387
block|,
name|IV2_NOTIFY_NAT_DETECTION_SOURCE_IP
init|=
literal|16388
block|,
name|IV2_NOTIFY_NAT_DETECTION_DESTINATION_IP
init|=
literal|16389
block|,
name|IV2_NOTIFY_COOKIE
init|=
literal|16390
block|,
name|IV2_NOTIFY_USE_TRANSPORT_MODE
init|=
literal|16391
block|,
name|IV2_NOTIFY_HTTP_CERT_LOOKUP_SUPPORTED
init|=
literal|16392
block|,
name|IV2_NOTIFY_REKEY_SA
init|=
literal|16393
block|,
name|IV2_NOTIFY_ESP_TFC_PADDING_NOT_SUPPORTED
init|=
literal|16394
block|,
name|IV2_NOTIFY_NON_FIRST_FRAGMENTS_ALSO
init|=
literal|16395
block|}
enum|;
end_enum

begin_struct
struct|struct
name|notify_messages
block|{
name|uint16_t
name|type
decl_stmt|;
name|char
modifier|*
name|msg
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* 3.8 Notification Payload */
end_comment

begin_struct
struct|struct
name|ikev2_auth
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint8_t
name|auth_method
decl_stmt|;
comment|/* Protocol-ID */
name|uint8_t
name|reserved
index|[
literal|3
index|]
decl_stmt|;
comment|/* authentication data */
block|}
struct|;
end_struct

begin_enum
enum|enum
name|ikev2_auth_type
block|{
name|IV2_RSA_SIG
init|=
literal|1
block|,
name|IV2_SHARED
init|=
literal|2
block|,
name|IV2_DSS_SIG
init|=
literal|3
block|, }
enum|;
end_enum

begin_comment
comment|/* refer to RFC 2409 */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* isakmp sa structure */
end_comment

begin_comment
unit|struct oakley_sa { 	uint8_t  proto_id;
comment|/* OAKLEY */
end_comment

begin_comment
unit|vchar_t   *spi;
comment|/* spi */
end_comment

begin_comment
unit|uint8_t  dhgrp;
comment|/* DH; group */
end_comment

begin_comment
unit|uint8_t  auth_t;
comment|/* method of authentication */
end_comment

begin_comment
unit|uint8_t  prf_t;
comment|/* type of prf */
end_comment

begin_comment
unit|uint8_t  hash_t;
comment|/* type of hash */
end_comment

begin_comment
unit|uint8_t  enc_t;
comment|/* type of cipher */
end_comment

begin_comment
unit|uint8_t  life_t;
comment|/* type of duration of lifetime */
end_comment

begin_comment
unit|uint32_t ldur;
comment|/* life duration */
end_comment

begin_endif
unit|};
endif|#
directive|endif
end_endif

begin_comment
comment|/* refer to RFC 2407 */
end_comment

begin_define
define|#
directive|define
name|IPSEC_DOI
value|1
end_define

begin_comment
comment|/* 4.2 IPSEC Situation Definition */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_SIT_IDENTITY_ONLY
value|0x00000001
end_define

begin_define
define|#
directive|define
name|IPSECDOI_SIT_SECRECY
value|0x00000002
end_define

begin_define
define|#
directive|define
name|IPSECDOI_SIT_INTEGRITY
value|0x00000004
end_define

begin_comment
comment|/* 4.4.1 IPSEC Security Protocol Identifiers */
end_comment

begin_comment
comment|/* 4.4.2 IPSEC ISAKMP Transform Values */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_PROTO_ISAKMP
value|1
end_define

begin_define
define|#
directive|define
name|IPSECDOI_KEY_IKE
value|1
end_define

begin_comment
comment|/* 4.4.1 IPSEC Security Protocol Identifiers */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_PROTO_IPSEC_AH
value|2
end_define

begin_comment
comment|/* 4.4.3 IPSEC AH Transform Values */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_AH_MD5
value|2
end_define

begin_define
define|#
directive|define
name|IPSECDOI_AH_SHA
value|3
end_define

begin_define
define|#
directive|define
name|IPSECDOI_AH_DES
value|4
end_define

begin_define
define|#
directive|define
name|IPSECDOI_AH_SHA2_256
value|5
end_define

begin_define
define|#
directive|define
name|IPSECDOI_AH_SHA2_384
value|6
end_define

begin_define
define|#
directive|define
name|IPSECDOI_AH_SHA2_512
value|7
end_define

begin_comment
comment|/* 4.4.1 IPSEC Security Protocol Identifiers */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_PROTO_IPSEC_ESP
value|3
end_define

begin_comment
comment|/* 4.4.4 IPSEC ESP Transform Identifiers */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_ESP_DES_IV64
value|1
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ESP_DES
value|2
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ESP_3DES
value|3
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ESP_RC5
value|4
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ESP_IDEA
value|5
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ESP_CAST
value|6
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ESP_BLOWFISH
value|7
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ESP_3IDEA
value|8
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ESP_DES_IV32
value|9
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ESP_RC4
value|10
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ESP_NULL
value|11
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ESP_RIJNDAEL
value|12
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ESP_AES
value|12
end_define

begin_comment
comment|/* 4.4.1 IPSEC Security Protocol Identifiers */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_PROTO_IPCOMP
value|4
end_define

begin_comment
comment|/* 4.4.5 IPSEC IPCOMP Transform Identifiers */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_IPCOMP_OUI
value|1
end_define

begin_define
define|#
directive|define
name|IPSECDOI_IPCOMP_DEFLATE
value|2
end_define

begin_define
define|#
directive|define
name|IPSECDOI_IPCOMP_LZS
value|3
end_define

begin_comment
comment|/* 4.5 IPSEC Security Association Attributes */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_SA_LTYPE
value|1
end_define

begin_comment
comment|/* B */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_SA_LTYPE_DEFAULT
value|1
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_SA_LTYPE_SEC
value|1
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_SA_LTYPE_KB
value|2
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_SA_LDUR
value|2
end_define

begin_comment
comment|/* V */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_SA_LDUR_DEFAULT
value|28800
end_define

begin_comment
comment|/* 8 hours */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_GRP_DESC
value|3
end_define

begin_comment
comment|/* B */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_ENC_MODE
value|4
end_define

begin_comment
comment|/* B */
end_comment

begin_comment
comment|/* default value: host dependent */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_ENC_MODE_TUNNEL
value|1
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_ENC_MODE_TRNS
value|2
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_AUTH
value|5
end_define

begin_comment
comment|/* B */
end_comment

begin_comment
comment|/* 0 means not to use authentication. */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_AUTH_HMAC_MD5
value|1
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_AUTH_HMAC_SHA1
value|2
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_AUTH_DES_MAC
value|3
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_AUTH_KPDK
value|4
end_define

begin_comment
comment|/*RFC-1826(Key/Pad/Data/Key)*/
end_comment

begin_comment
comment|/* 	 * When negotiating ESP without authentication, the Auth 	 * Algorithm attribute MUST NOT be included in the proposal. 	 * When negotiating ESP without confidentiality, the Auth 	 * Algorithm attribute MUST be included in the proposal and 	 * the ESP transform ID must be ESP_NULL. 	*/
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_KEY_LENGTH
value|6
end_define

begin_comment
comment|/* B */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_KEY_ROUNDS
value|7
end_define

begin_comment
comment|/* B */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_COMP_DICT_SIZE
value|8
end_define

begin_comment
comment|/* B */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_ATTR_COMP_PRIVALG
value|9
end_define

begin_comment
comment|/* V */
end_comment

begin_comment
comment|/* 4.6.1 Security Association Payload */
end_comment

begin_struct
struct|struct
name|ipsecdoi_sa
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint32_t
name|doi
decl_stmt|;
comment|/* Domain of Interpretation */
name|uint32_t
name|sit
decl_stmt|;
comment|/* Situation */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ipsecdoi_secrecy_h
block|{
name|uint16_t
name|len
decl_stmt|;
name|uint16_t
name|reserved
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* 4.6.2.1 Identification Type Values */
end_comment

begin_struct
struct|struct
name|ipsecdoi_id
block|{
name|struct
name|isakmp_gen
name|h
decl_stmt|;
name|uint8_t
name|type
decl_stmt|;
comment|/* ID Type */
name|uint8_t
name|proto_id
decl_stmt|;
comment|/* Protocol ID */
name|uint16_t
name|port
decl_stmt|;
comment|/* Port */
comment|/* Identification Data */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|IPSECDOI_ID_IPV4_ADDR
value|1
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ID_FQDN
value|2
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ID_USER_FQDN
value|3
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ID_IPV4_ADDR_SUBNET
value|4
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ID_IPV6_ADDR
value|5
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ID_IPV6_ADDR_SUBNET
value|6
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ID_IPV4_ADDR_RANGE
value|7
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ID_IPV6_ADDR_RANGE
value|8
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ID_DER_ASN1_DN
value|9
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ID_DER_ASN1_GN
value|10
end_define

begin_define
define|#
directive|define
name|IPSECDOI_ID_KEY_ID
value|11
end_define

begin_comment
comment|/* 4.6.3 IPSEC DOI Notify Message Types */
end_comment

begin_comment
comment|/* Notify Messages - Status Types */
end_comment

begin_define
define|#
directive|define
name|IPSECDOI_NTYPE_RESPONDER_LIFETIME
value|24576
end_define

begin_define
define|#
directive|define
name|IPSECDOI_NTYPE_REPLAY_STATUS
value|24577
end_define

begin_define
define|#
directive|define
name|IPSECDOI_NTYPE_INITIAL_CONTACT
value|24578
end_define

begin_define
define|#
directive|define
name|DECLARE_PRINTER
parameter_list|(
name|func
parameter_list|)
value|static const u_char *ike##func##_print( \ 		netdissect_options *ndo, u_char tpay,	              \ 		const struct isakmp_gen *ext,			      \ 		u_int item_len, \ 		const u_char *end_pointer, \ 		uint32_t phase,\ 		uint32_t doi0, \ 		uint32_t proto0, int depth)
end_define

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v1_sa
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v1_p
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v1_t
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v1_ke
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v1_id
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v1_cert
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v1_cr
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v1_sig
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v1_hash
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v1_nonce
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v1_n
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v1_d
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v1_vid
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v2_sa
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v2_ke
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v2_ID
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v2_cert
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v2_cr
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v2_auth
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v2_nonce
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v2_n
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v2_d
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v2_vid
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v2_TS
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v2_cp
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_PRINTER
argument_list|(
name|v2_eap
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_e_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|struct
name|isakmp
modifier|*
name|base
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
parameter_list|,
specifier|const
name|u_char
modifier|*
name|end_pointer
parameter_list|,
name|uint32_t
name|phase
parameter_list|,
name|uint32_t
name|doi0
parameter_list|,
name|uint32_t
name|proto0
parameter_list|,
name|int
name|depth
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|u_char
modifier|*
name|ike_sub0_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
parameter_list|,
specifier|const
name|u_char
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_sub_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
parameter_list|,
specifier|const
name|u_char
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_sub_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|struct
name|isakmp
modifier|*
name|base
parameter_list|,
name|u_char
name|np
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|phase
parameter_list|,
name|uint32_t
name|doi
parameter_list|,
name|uint32_t
name|proto
parameter_list|,
name|int
name|depth
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|numstr
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ikev1_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
name|length
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp2
parameter_list|,
name|struct
name|isakmp
modifier|*
name|base
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|MAXINITIATORS
value|20
end_define

begin_decl_stmt
name|int
name|ninitiator
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_union
union|union
name|inaddr_u
block|{
name|struct
name|in_addr
name|in4
decl_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|struct
name|in6_addr
name|in6
decl_stmt|;
endif|#
directive|endif
block|}
union|;
end_union

begin_struct
struct|struct
block|{
name|cookie_t
name|initiator
decl_stmt|;
name|u_int
name|version
decl_stmt|;
name|union
name|inaddr_u
name|iaddr
decl_stmt|;
name|union
name|inaddr_u
name|raddr
decl_stmt|;
block|}
name|cookiecache
index|[
name|MAXINITIATORS
index|]
struct|;
end_struct

begin_comment
comment|/* protocol id */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|protoidstr
index|[]
init|=
block|{
name|NULL
block|,
literal|"isakmp"
block|,
literal|"ipsec-ah"
block|,
literal|"ipsec-esp"
block|,
literal|"ipcomp"
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* isakmp->np */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|npstr
index|[]
init|=
block|{
literal|"none"
block|,
literal|"sa"
block|,
literal|"p"
block|,
literal|"t"
block|,
literal|"ke"
block|,
literal|"id"
block|,
literal|"cert"
block|,
literal|"cr"
block|,
literal|"hash"
block|,
comment|/* 0 - 8 */
literal|"sig"
block|,
literal|"nonce"
block|,
literal|"n"
block|,
literal|"d"
block|,
literal|"vid"
block|,
comment|/* 9 - 13 */
literal|"pay14"
block|,
literal|"pay15"
block|,
literal|"pay16"
block|,
literal|"pay17"
block|,
literal|"pay18"
block|,
comment|/* 14- 18 */
literal|"pay19"
block|,
literal|"pay20"
block|,
literal|"pay21"
block|,
literal|"pay22"
block|,
literal|"pay23"
block|,
comment|/* 19- 23 */
literal|"pay24"
block|,
literal|"pay25"
block|,
literal|"pay26"
block|,
literal|"pay27"
block|,
literal|"pay28"
block|,
comment|/* 24- 28 */
literal|"pay29"
block|,
literal|"pay30"
block|,
literal|"pay31"
block|,
literal|"pay32"
block|,
comment|/* 29- 32 */
literal|"v2sa"
block|,
literal|"v2ke"
block|,
literal|"v2IDi"
block|,
literal|"v2IDr"
block|,
literal|"v2cert"
block|,
comment|/* 33- 37 */
literal|"v2cr"
block|,
literal|"v2auth"
block|,
literal|"v2nonce"
block|,
literal|"v2n"
block|,
literal|"v2d"
block|,
comment|/* 38- 42 */
literal|"v2vid"
block|,
literal|"v2TSi"
block|,
literal|"v2TSr"
block|,
literal|"v2e"
block|,
literal|"v2cp"
block|,
comment|/* 43- 47 */
literal|"v2eap"
block|,
comment|/* 48 */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* isakmp->np */
end_comment

begin_function_decl
specifier|static
specifier|const
name|u_char
modifier|*
function_decl|(
modifier|*
name|npfunc
index|[]
function_decl|)
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
parameter_list|,
specifier|const
name|u_char
modifier|*
name|end_pointer
parameter_list|,
name|uint32_t
name|phase
parameter_list|,
name|uint32_t
name|doi0
parameter_list|,
name|uint32_t
name|proto0
parameter_list|,
name|int
name|depth
parameter_list|)
init|=
block|{
name|NULL
operator|,
function_decl|ikev1_sa_print
operator|,
function_decl|ikev1_p_print
operator|,
function_decl|ikev1_t_print
operator|,
function_decl|ikev1_ke_print
operator|,
function_decl|ikev1_id_print
operator|,
function_decl|ikev1_cert_print
operator|,
function_decl|ikev1_cr_print
operator|,
function_decl|ikev1_hash_print
operator|,
function_decl|ikev1_sig_print
operator|,
function_decl|ikev1_nonce_print
operator|,
function_decl|ikev1_n_print
operator|,
function_decl|ikev1_d_print
operator|,
function_decl|ikev1_vid_print
operator|,
comment|/* 13 */
function_decl|NULL
operator|,
function_decl|NULL
operator|,
function_decl|NULL
operator|,
function_decl|NULL
operator|,
function_decl|NULL
operator|,
comment|/* 14- 18 */
function_decl|NULL
operator|,
function_decl|NULL
operator|,
function_decl|NULL
operator|,
function_decl|NULL
operator|,
function_decl|NULL
operator|,
comment|/* 19- 23 */
function_decl|NULL
operator|,
function_decl|NULL
operator|,
function_decl|NULL
operator|,
function_decl|NULL
operator|,
function_decl|NULL
operator|,
comment|/* 24- 28 */
function_decl|NULL
operator|,
function_decl|NULL
operator|,
function_decl|NULL
operator|,
function_decl|NULL
operator|,
comment|/* 29- 32 */
function_decl|ikev2_sa_print
operator|,
comment|/* 33 */
function_decl|ikev2_ke_print
operator|,
comment|/* 34 */
function_decl|ikev2_ID_print
operator|,
comment|/* 35 */
function_decl|ikev2_ID_print
operator|,
comment|/* 36 */
function_decl|ikev2_cert_print
operator|,
comment|/* 37 */
function_decl|ikev2_cr_print
operator|,
comment|/* 38 */
function_decl|ikev2_auth_print
operator|,
comment|/* 39 */
function_decl|ikev2_nonce_print
operator|,
comment|/* 40 */
function_decl|ikev2_n_print
operator|,
comment|/* 41 */
function_decl|ikev2_d_print
operator|,
comment|/* 42 */
function_decl|ikev2_vid_print
operator|,
comment|/* 43 */
function_decl|ikev2_TS_print
operator|,
comment|/* 44 */
function_decl|ikev2_TS_print
operator|,
comment|/* 45 */
function_decl|NULL
operator|,
comment|/* ikev2_e_print,*/
comment|/* 46 - special */
function_decl|ikev2_cp_print
operator|,
comment|/* 47 */
function_decl|ikev2_eap_print
operator|,
end_function_decl

begin_comment
comment|/* 48 */
end_comment

begin_comment
unit|};
comment|/* isakmp->etype */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|etypestr
index|[]
init|=
block|{
comment|/* IKEv1 exchange types */
literal|"none"
block|,
literal|"base"
block|,
literal|"ident"
block|,
literal|"auth"
block|,
literal|"agg"
block|,
literal|"inf"
block|,
name|NULL
block|,
name|NULL
block|,
comment|/* 0-7 */
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
comment|/*  8-15 */
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
comment|/* 16-23 */
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
comment|/* 24-31 */
literal|"oakley-quick"
block|,
literal|"oakley-newgroup"
block|,
comment|/* 32-33 */
comment|/* IKEv2 exchange types */
literal|"ikev2_init"
block|,
literal|"ikev2_auth"
block|,
literal|"child_sa"
block|,
literal|"inf2"
comment|/* 34-37 */
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|STR_OR_ID
parameter_list|(
name|x
parameter_list|,
name|tab
parameter_list|)
define|\
value|(((x)< sizeof(tab)/sizeof(tab[0])&& tab[(x)])	? tab[(x)] : numstr(x))
end_define

begin_define
define|#
directive|define
name|PROTOIDSTR
parameter_list|(
name|x
parameter_list|)
value|STR_OR_ID(x, protoidstr)
end_define

begin_define
define|#
directive|define
name|NPSTR
parameter_list|(
name|x
parameter_list|)
value|STR_OR_ID(x, npstr)
end_define

begin_define
define|#
directive|define
name|ETYPESTR
parameter_list|(
name|x
parameter_list|)
value|STR_OR_ID(x, etypestr)
end_define

begin_define
define|#
directive|define
name|CHECKLEN
parameter_list|(
name|p
parameter_list|,
name|np
parameter_list|)
define|\
value|if (ep< (u_char *)(p)) {				\ 			ND_PRINT((ndo," [|%s]", NPSTR(np)));		\ 			goto done;					\ 		}
end_define

begin_define
define|#
directive|define
name|NPFUNC
parameter_list|(
name|x
parameter_list|)
define|\
value|(((x)< sizeof(npfunc)/sizeof(npfunc[0])&& npfunc[(x)]) \ 		? npfunc[(x)] : NULL)
end_define

begin_function
specifier|static
name|int
name|iszero
parameter_list|(
name|u_char
modifier|*
name|p
parameter_list|,
name|size_t
name|l
parameter_list|)
block|{
while|while
condition|(
name|l
operator|--
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|++
condition|)
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* find cookie from initiator cache */
end_comment

begin_function
specifier|static
name|int
name|cookie_find
parameter_list|(
name|cookie_t
modifier|*
name|in
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXINITIATORS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|in
argument_list|,
operator|&
name|cookiecache
index|[
name|i
index|]
operator|.
name|initiator
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return
name|i
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/* record initiator */
end_comment

begin_function
specifier|static
name|void
name|cookie_record
parameter_list|(
name|cookie_t
modifier|*
name|in
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp2
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|struct
name|ip6_hdr
modifier|*
name|ip6
decl_stmt|;
endif|#
directive|endif
name|i
operator|=
name|cookie_find
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
operator|<=
name|i
condition|)
block|{
name|ninitiator
operator|=
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
name|MAXINITIATORS
expr_stmt|;
return|return;
block|}
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|bp2
expr_stmt|;
switch|switch
condition|(
name|IP_V
argument_list|(
name|ip
argument_list|)
condition|)
block|{
case|case
literal|4
case|:
name|cookiecache
index|[
name|ninitiator
index|]
operator|.
name|version
operator|=
literal|4
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|cookiecache
index|[
name|ninitiator
index|]
operator|.
name|iaddr
operator|.
name|in4
argument_list|,
operator|&
name|ip
operator|->
name|ip_src
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|cookiecache
index|[
name|ninitiator
index|]
operator|.
name|raddr
operator|.
name|in4
argument_list|,
operator|&
name|ip
operator|->
name|ip_dst
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
literal|6
case|:
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
name|bp2
expr_stmt|;
name|cookiecache
index|[
name|ninitiator
index|]
operator|.
name|version
operator|=
literal|6
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|cookiecache
index|[
name|ninitiator
index|]
operator|.
name|iaddr
operator|.
name|in6
argument_list|,
operator|&
name|ip6
operator|->
name|ip6_src
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|cookiecache
index|[
name|ninitiator
index|]
operator|.
name|raddr
operator|.
name|in6
argument_list|,
operator|&
name|ip6
operator|->
name|ip6_dst
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
return|return;
block|}
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|cookiecache
index|[
name|ninitiator
index|]
operator|.
name|initiator
argument_list|,
name|in
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|ninitiator
operator|=
operator|(
name|ninitiator
operator|+
literal|1
operator|)
operator|%
name|MAXINITIATORS
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|cookie_isinitiator
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|cookie_sidecheck((x), (y), 1)
end_define

begin_define
define|#
directive|define
name|cookie_isresponder
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|cookie_sidecheck((x), (y), 0)
end_define

begin_function
specifier|static
name|int
name|cookie_sidecheck
parameter_list|(
name|int
name|i
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp2
parameter_list|,
name|int
name|initiator
parameter_list|)
block|{
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|struct
name|ip6_hdr
modifier|*
name|ip6
decl_stmt|;
endif|#
directive|endif
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|bp2
expr_stmt|;
switch|switch
condition|(
name|IP_V
argument_list|(
name|ip
argument_list|)
condition|)
block|{
case|case
literal|4
case|:
if|if
condition|(
name|cookiecache
index|[
name|i
index|]
operator|.
name|version
operator|!=
literal|4
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|initiator
condition|)
block|{
if|if
condition|(
name|UNALIGNED_MEMCMP
argument_list|(
operator|&
name|ip
operator|->
name|ip_src
argument_list|,
operator|&
name|cookiecache
index|[
name|i
index|]
operator|.
name|iaddr
operator|.
name|in4
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
name|UNALIGNED_MEMCMP
argument_list|(
operator|&
name|ip
operator|->
name|ip_src
argument_list|,
operator|&
name|cookiecache
index|[
name|i
index|]
operator|.
name|raddr
operator|.
name|in4
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
literal|6
case|:
if|if
condition|(
name|cookiecache
index|[
name|i
index|]
operator|.
name|version
operator|!=
literal|6
condition|)
return|return
literal|0
return|;
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
name|bp2
expr_stmt|;
if|if
condition|(
name|initiator
condition|)
block|{
if|if
condition|(
name|UNALIGNED_MEMCMP
argument_list|(
operator|&
name|ip6
operator|->
name|ip6_src
argument_list|,
operator|&
name|cookiecache
index|[
name|i
index|]
operator|.
name|iaddr
operator|.
name|in6
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
name|UNALIGNED_MEMCMP
argument_list|(
operator|&
name|ip6
operator|->
name|ip6_src
argument_list|,
operator|&
name|cookiecache
index|[
name|i
index|]
operator|.
name|raddr
operator|.
name|in6
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
break|break;
endif|#
directive|endif
comment|/* INET6 */
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hexprint
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|caddr_t
name|loc
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|p
operator|=
operator|(
name|u_char
operator|*
operator|)
name|loc
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%02x"
operator|,
name|p
index|[
name|i
index|]
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rawprint
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|caddr_t
name|loc
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|ND_TCHECK2
argument_list|(
operator|*
name|loc
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|hexprint
argument_list|(
name|ndo
argument_list|,
name|loc
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
name|trunc
label|:
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * returns false if we run out of data buffer  */
end_comment

begin_function
specifier|static
name|int
name|ike_show_somedata
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|)
block|{
comment|/* there is too much data, just show some of it */
specifier|const
name|u_char
modifier|*
name|end
init|=
name|ep
operator|-
literal|20
decl_stmt|;
name|int
name|elen
init|=
literal|20
decl_stmt|;
name|int
name|len
init|=
name|ep
operator|-
name|cp
decl_stmt|;
if|if
condition|(
name|len
operator|>
literal|10
condition|)
block|{
name|len
operator|=
literal|10
expr_stmt|;
block|}
comment|/* really shouldn't happen because of above */
if|if
condition|(
name|end
operator|<
name|cp
operator|+
name|len
condition|)
block|{
name|end
operator|=
name|cp
operator|+
name|len
expr_stmt|;
name|elen
operator|=
name|ep
operator|-
name|end
expr_stmt|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" data=("
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|cp
argument_list|)
argument_list|,
name|len
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|elen
condition|)
block|{
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|end
argument_list|)
argument_list|,
name|elen
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|")"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
name|trunc
label|:
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
name|attrmap
block|{
specifier|const
name|char
modifier|*
name|type
decl_stmt|;
name|u_int
name|nvalue
decl_stmt|;
specifier|const
name|char
modifier|*
name|value
index|[
literal|30
index|]
decl_stmt|;
comment|/*XXX*/
block|}
struct|;
end_struct

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_attrmap_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|,
specifier|const
name|struct
name|attrmap
modifier|*
name|map
parameter_list|,
name|size_t
name|nmap
parameter_list|)
block|{
name|int
name|totlen
decl_stmt|;
name|uint32_t
name|t
decl_stmt|,
name|v
decl_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|&
literal|0x80
condition|)
name|totlen
operator|=
literal|4
expr_stmt|;
else|else
name|totlen
operator|=
literal|4
operator|+
name|EXTRACT_16BITS
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ep
operator|<
name|p
operator|+
name|totlen
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|attr]"
operator|)
argument_list|)
expr_stmt|;
return|return
name|ep
operator|+
literal|1
return|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"("
operator|)
argument_list|)
expr_stmt|;
name|t
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|p
index|[
literal|0
index|]
argument_list|)
operator|&
literal|0x7fff
expr_stmt|;
if|if
condition|(
name|map
operator|&&
name|t
operator|<
name|nmap
operator|&&
name|map
index|[
name|t
index|]
operator|.
name|type
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"type=%s "
operator|,
name|map
index|[
name|t
index|]
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"type=#%d "
operator|,
name|t
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|&
literal|0x80
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"value="
operator|)
argument_list|)
expr_stmt|;
name|v
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|map
operator|&&
name|t
operator|<
name|nmap
operator|&&
name|v
operator|<
name|map
index|[
name|t
index|]
operator|.
name|nvalue
operator|&&
name|map
index|[
name|t
index|]
operator|.
name|value
index|[
name|v
index|]
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|map
index|[
name|t
index|]
operator|.
name|value
index|[
name|v
index|]
operator|)
argument_list|)
expr_stmt|;
else|else
name|rawprint
argument_list|(
name|ndo
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|p
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"len=%d value="
operator|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|rawprint
argument_list|(
name|ndo
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|p
index|[
literal|4
index|]
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|")"
operator|)
argument_list|)
expr_stmt|;
return|return
name|p
operator|+
name|totlen
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_attr_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|)
block|{
name|int
name|totlen
decl_stmt|;
name|uint32_t
name|t
decl_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|&
literal|0x80
condition|)
name|totlen
operator|=
literal|4
expr_stmt|;
else|else
name|totlen
operator|=
literal|4
operator|+
name|EXTRACT_16BITS
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ep
operator|<
name|p
operator|+
name|totlen
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|attr]"
operator|)
argument_list|)
expr_stmt|;
return|return
name|ep
operator|+
literal|1
return|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"("
operator|)
argument_list|)
expr_stmt|;
name|t
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|p
index|[
literal|0
index|]
argument_list|)
operator|&
literal|0x7fff
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"type=#%d "
operator|,
name|t
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|&
literal|0x80
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"value="
operator|)
argument_list|)
expr_stmt|;
name|t
operator|=
name|p
index|[
literal|2
index|]
expr_stmt|;
name|rawprint
argument_list|(
name|ndo
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|p
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"len=%d value="
operator|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|rawprint
argument_list|(
name|ndo
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|p
index|[
literal|4
index|]
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|")"
operator|)
argument_list|)
expr_stmt|;
return|return
name|p
operator|+
name|totlen
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_sa_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|phase
parameter_list|,
name|uint32_t
name|doi0
name|_U_
parameter_list|,
name|uint32_t
name|proto0
parameter_list|,
name|int
name|depth
parameter_list|)
block|{
specifier|const
name|struct
name|ikev1_pl_sa
modifier|*
name|p
decl_stmt|;
name|struct
name|ikev1_pl_sa
name|sa
decl_stmt|;
name|uint32_t
name|doi
decl_stmt|,
name|sit
decl_stmt|,
name|ident
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|np
decl_stmt|;
name|int
name|t
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s:"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_SA
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
expr|struct
name|ikev1_pl_sa
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|sa
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|doi
operator|=
name|ntohl
argument_list|(
name|sa
operator|.
name|doi
argument_list|)
expr_stmt|;
name|sit
operator|=
name|ntohl
argument_list|(
name|sa
operator|.
name|sit
argument_list|)
expr_stmt|;
if|if
condition|(
name|doi
operator|!=
literal|1
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" doi=%d"
operator|,
name|doi
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" situation=%u"
operator|,
operator|(
name|uint32_t
operator|)
name|ntohl
argument_list|(
name|sa
operator|.
name|sit
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|u_char
operator|*
operator|)
operator|(
name|p
operator|+
literal|1
operator|)
return|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" doi=ipsec"
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" situation="
operator|)
argument_list|)
expr_stmt|;
name|t
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sit
operator|&
literal|0x01
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"identity"
operator|)
argument_list|)
expr_stmt|;
name|t
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|sit
operator|&
literal|0x02
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%ssecrecy"
operator|,
name|t
condition|?
literal|"+"
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
name|t
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|sit
operator|&
literal|0x04
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%sintegrity"
operator|,
name|t
condition|?
literal|"+"
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
name|np
operator|=
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
sizeof|sizeof
argument_list|(
name|sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|sit
operator|!=
literal|0x01
condition|)
block|{
name|ND_TCHECK2
argument_list|(
operator|*
operator|(
name|ext
operator|+
literal|1
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|ident
argument_list|)
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|ident
argument_list|,
name|ext
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ident
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" ident=%u"
operator|,
operator|(
name|uint32_t
operator|)
name|ntohl
argument_list|(
name|ident
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|np
operator|+=
sizeof|sizeof
argument_list|(
name|ident
argument_list|)
expr_stmt|;
block|}
name|ext
operator|=
operator|(
expr|struct
name|isakmp_gen
operator|*
operator|)
name|np
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|cp
operator|=
name|ikev1_sub_print
argument_list|(
name|ndo
argument_list|,
name|ISAKMP_NPTYPE_P
argument_list|,
name|ext
argument_list|,
name|ep
argument_list|,
name|phase
argument_list|,
name|doi
argument_list|,
name|proto0
argument_list|,
name|depth
argument_list|)
expr_stmt|;
return|return
name|cp
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_SA
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_p_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|phase
parameter_list|,
name|uint32_t
name|doi0
parameter_list|,
name|uint32_t
name|proto0
name|_U_
parameter_list|,
name|int
name|depth
parameter_list|)
block|{
specifier|const
name|struct
name|ikev1_pl_p
modifier|*
name|p
decl_stmt|;
name|struct
name|ikev1_pl_p
name|prop
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s:"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_P
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
expr|struct
name|ikev1_pl_p
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|prop
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|prop
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" #%d protoid=%s transform=%d"
operator|,
name|prop
operator|.
name|p_no
operator|,
name|PROTOIDSTR
argument_list|(
name|prop
operator|.
name|prot_id
argument_list|)
operator|,
name|prop
operator|.
name|num_t
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|prop
operator|.
name|spi_size
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" spi="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|p
operator|+
literal|1
argument_list|)
argument_list|,
name|prop
operator|.
name|spi_size
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
name|ext
operator|=
operator|(
expr|struct
name|isakmp_gen
operator|*
operator|)
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|(
name|p
operator|+
literal|1
operator|)
operator|+
name|prop
operator|.
name|spi_size
operator|)
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|cp
operator|=
name|ikev1_sub_print
argument_list|(
name|ndo
argument_list|,
name|ISAKMP_NPTYPE_T
argument_list|,
name|ext
argument_list|,
name|ep
argument_list|,
name|phase
argument_list|,
name|doi0
argument_list|,
name|prop
operator|.
name|prot_id
argument_list|,
name|depth
argument_list|)
expr_stmt|;
return|return
name|cp
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_P
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|ikev1_p_map
index|[]
init|=
block|{
name|NULL
block|,
literal|"ike"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|ikev2_t_type_map
index|[]
init|=
block|{
name|NULL
block|,
literal|"encr"
block|,
literal|"prf"
block|,
literal|"integ"
block|,
literal|"dh"
block|,
literal|"esn"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|ah_p_map
index|[]
init|=
block|{
name|NULL
block|,
literal|"(reserved)"
block|,
literal|"md5"
block|,
literal|"sha"
block|,
literal|"1des"
block|,
literal|"sha2-256"
block|,
literal|"sha2-384"
block|,
literal|"sha2-512"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|prf_p_map
index|[]
init|=
block|{
name|NULL
block|,
literal|"hmac-md5"
block|,
literal|"hmac-sha"
block|,
literal|"hmac-tiger"
block|,
literal|"aes128_xcbc"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|integ_p_map
index|[]
init|=
block|{
name|NULL
block|,
literal|"hmac-md5"
block|,
literal|"hmac-sha"
block|,
literal|"dec-mac"
block|,
literal|"kpdk-md5"
block|,
literal|"aes-xcbc"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|esn_p_map
index|[]
init|=
block|{
literal|"no-esn"
block|,
literal|"esn"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|dh_p_map
index|[]
init|=
block|{
name|NULL
block|,
literal|"modp768"
block|,
literal|"modp1024"
block|,
comment|/* group 2 */
literal|"EC2N 2^155"
block|,
comment|/* group 3 */
literal|"EC2N 2^185"
block|,
comment|/* group 4 */
literal|"modp1536"
block|,
comment|/* group 5 */
literal|"iana-grp06"
block|,
literal|"iana-grp07"
block|,
comment|/* reserved */
literal|"iana-grp08"
block|,
literal|"iana-grp09"
block|,
literal|"iana-grp10"
block|,
literal|"iana-grp11"
block|,
literal|"iana-grp12"
block|,
literal|"iana-grp13"
block|,
literal|"modp2048"
block|,
comment|/* group 14 */
literal|"modp3072"
block|,
comment|/* group 15 */
literal|"modp4096"
block|,
comment|/* group 16 */
literal|"modp6144"
block|,
comment|/* group 17 */
literal|"modp8192"
block|,
comment|/* group 18 */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|esp_p_map
index|[]
init|=
block|{
name|NULL
block|,
literal|"1des-iv64"
block|,
literal|"1des"
block|,
literal|"3des"
block|,
literal|"rc5"
block|,
literal|"idea"
block|,
literal|"cast"
block|,
literal|"blowfish"
block|,
literal|"3idea"
block|,
literal|"1des-iv32"
block|,
literal|"rc4"
block|,
literal|"null"
block|,
literal|"aes"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|ipcomp_p_map
index|[]
init|=
block|{
name|NULL
block|,
literal|"oui"
block|,
literal|"deflate"
block|,
literal|"lzs"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|attrmap
name|ipsec_t_map
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"lifetype"
block|,
literal|3
block|,
block|{
name|NULL
block|,
literal|"sec"
block|,
literal|"kb"
block|, }
block|, }
block|,
block|{
literal|"life"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"group desc"
block|,
literal|18
block|,
block|{
name|NULL
block|,
literal|"modp768"
block|,
literal|"modp1024"
block|,
comment|/* group 2 */
literal|"EC2N 2^155"
block|,
comment|/* group 3 */
literal|"EC2N 2^185"
block|,
comment|/* group 4 */
literal|"modp1536"
block|,
comment|/* group 5 */
literal|"iana-grp06"
block|,
literal|"iana-grp07"
block|,
comment|/* reserved */
literal|"iana-grp08"
block|,
literal|"iana-grp09"
block|,
literal|"iana-grp10"
block|,
literal|"iana-grp11"
block|,
literal|"iana-grp12"
block|,
literal|"iana-grp13"
block|,
literal|"modp2048"
block|,
comment|/* group 14 */
literal|"modp3072"
block|,
comment|/* group 15 */
literal|"modp4096"
block|,
comment|/* group 16 */
literal|"modp6144"
block|,
comment|/* group 17 */
literal|"modp8192"
block|,
comment|/* group 18 */
block|}
block|, }
block|,
block|{
literal|"enc mode"
block|,
literal|3
block|,
block|{
name|NULL
block|,
literal|"tunnel"
block|,
literal|"transport"
block|, }
block|, }
block|,
block|{
literal|"auth"
block|,
literal|5
block|,
block|{
name|NULL
block|,
literal|"hmac-md5"
block|,
literal|"hmac-sha1"
block|,
literal|"1des-mac"
block|,
literal|"keyed"
block|, }
block|, }
block|,
block|{
literal|"keylen"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"rounds"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"dictsize"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"privalg"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|attrmap
name|encr_t_map
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
comment|/* 0, 1 */
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
comment|/* 2, 3 */
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
comment|/* 4, 5 */
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
comment|/* 6, 7 */
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
comment|/* 8, 9 */
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
comment|/* 10,11*/
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
comment|/* 12,13*/
block|{
literal|"keylen"
block|,
literal|14
block|,
block|{
name|NULL
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|attrmap
name|oakley_t_map
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"enc"
block|,
literal|8
block|,
block|{
name|NULL
block|,
literal|"1des"
block|,
literal|"idea"
block|,
literal|"blowfish"
block|,
literal|"rc5"
block|,
literal|"3des"
block|,
literal|"cast"
block|,
literal|"aes"
block|, }
block|, }
block|,
block|{
literal|"hash"
block|,
literal|7
block|,
block|{
name|NULL
block|,
literal|"md5"
block|,
literal|"sha1"
block|,
literal|"tiger"
block|,
literal|"sha2-256"
block|,
literal|"sha2-384"
block|,
literal|"sha2-512"
block|, }
block|, }
block|,
block|{
literal|"auth"
block|,
literal|6
block|,
block|{
name|NULL
block|,
literal|"preshared"
block|,
literal|"dss"
block|,
literal|"rsa sig"
block|,
literal|"rsa enc"
block|,
literal|"rsa enc revised"
block|, }
block|, }
block|,
block|{
literal|"group desc"
block|,
literal|18
block|,
block|{
name|NULL
block|,
literal|"modp768"
block|,
literal|"modp1024"
block|,
comment|/* group 2 */
literal|"EC2N 2^155"
block|,
comment|/* group 3 */
literal|"EC2N 2^185"
block|,
comment|/* group 4 */
literal|"modp1536"
block|,
comment|/* group 5 */
literal|"iana-grp06"
block|,
literal|"iana-grp07"
block|,
comment|/* reserved */
literal|"iana-grp08"
block|,
literal|"iana-grp09"
block|,
literal|"iana-grp10"
block|,
literal|"iana-grp11"
block|,
literal|"iana-grp12"
block|,
literal|"iana-grp13"
block|,
literal|"modp2048"
block|,
comment|/* group 14 */
literal|"modp3072"
block|,
comment|/* group 15 */
literal|"modp4096"
block|,
comment|/* group 16 */
literal|"modp6144"
block|,
comment|/* group 17 */
literal|"modp8192"
block|,
comment|/* group 18 */
block|}
block|, }
block|,
block|{
literal|"group type"
block|,
literal|4
block|,
block|{
name|NULL
block|,
literal|"MODP"
block|,
literal|"ECP"
block|,
literal|"EC2N"
block|, }
block|, }
block|,
block|{
literal|"group prime"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"group gen1"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"group gen2"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"group curve A"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"group curve B"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"lifetype"
block|,
literal|3
block|,
block|{
name|NULL
block|,
literal|"sec"
block|,
literal|"kb"
block|, }
block|, }
block|,
block|{
literal|"lifeduration"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"prf"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"keylen"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"field"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|,
block|{
literal|"order"
block|,
literal|0
block|,
block|{
name|NULL
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_t_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
specifier|const
name|struct
name|ikev1_pl_t
modifier|*
name|p
decl_stmt|;
name|struct
name|ikev1_pl_t
name|t
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
specifier|const
name|char
modifier|*
name|idstr
decl_stmt|;
specifier|const
name|struct
name|attrmap
modifier|*
name|map
decl_stmt|;
name|size_t
name|nmap
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|ep2
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s:"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_T
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
expr|struct
name|ikev1_pl_t
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|t
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|proto
condition|)
block|{
case|case
literal|1
case|:
name|idstr
operator|=
name|STR_OR_ID
argument_list|(
name|t
operator|.
name|t_id
argument_list|,
name|ikev1_p_map
argument_list|)
expr_stmt|;
name|map
operator|=
name|oakley_t_map
expr_stmt|;
name|nmap
operator|=
sizeof|sizeof
argument_list|(
name|oakley_t_map
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|oakley_t_map
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|idstr
operator|=
name|STR_OR_ID
argument_list|(
name|t
operator|.
name|t_id
argument_list|,
name|ah_p_map
argument_list|)
expr_stmt|;
name|map
operator|=
name|ipsec_t_map
expr_stmt|;
name|nmap
operator|=
sizeof|sizeof
argument_list|(
name|ipsec_t_map
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|ipsec_t_map
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|idstr
operator|=
name|STR_OR_ID
argument_list|(
name|t
operator|.
name|t_id
argument_list|,
name|esp_p_map
argument_list|)
expr_stmt|;
name|map
operator|=
name|ipsec_t_map
expr_stmt|;
name|nmap
operator|=
sizeof|sizeof
argument_list|(
name|ipsec_t_map
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|ipsec_t_map
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|idstr
operator|=
name|STR_OR_ID
argument_list|(
name|t
operator|.
name|t_id
argument_list|,
name|ipcomp_p_map
argument_list|)
expr_stmt|;
name|map
operator|=
name|ipsec_t_map
expr_stmt|;
name|nmap
operator|=
sizeof|sizeof
argument_list|(
name|ipsec_t_map
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|ipsec_t_map
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|idstr
operator|=
name|NULL
expr_stmt|;
name|map
operator|=
name|NULL
expr_stmt|;
name|nmap
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|idstr
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" #%d id=%s "
operator|,
name|t
operator|.
name|t_no
operator|,
name|idstr
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" #%d id=%d "
operator|,
name|t
operator|.
name|t_no
operator|,
name|t
operator|.
name|t_id
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|(
name|p
operator|+
literal|1
operator|)
expr_stmt|;
name|ep2
operator|=
operator|(
name|u_char
operator|*
operator|)
name|p
operator|+
name|item_len
expr_stmt|;
while|while
condition|(
name|cp
operator|<
name|ep
operator|&&
name|cp
operator|<
name|ep2
condition|)
block|{
if|if
condition|(
name|map
operator|&&
name|nmap
condition|)
block|{
name|cp
operator|=
name|ikev1_attrmap_print
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
operator|(
name|ep
operator|<
name|ep2
operator|)
condition|?
name|ep
else|:
name|ep2
argument_list|,
name|map
argument_list|,
name|nmap
argument_list|)
expr_stmt|;
block|}
else|else
name|cp
operator|=
name|ikev1_attr_print
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
operator|(
name|ep
operator|<
name|ep2
operator|)
condition|?
name|ep
else|:
name|ep2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ep
operator|<
name|ep2
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
return|return
name|cp
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_T
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_ke_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
name|struct
name|isakmp_gen
name|e
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s:"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_KE
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" key len=%d"
operator|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|2
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_KE
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_id_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
define|#
directive|define
name|USE_IPSECDOI_IN_PHASE1
value|1
specifier|const
name|struct
name|ikev1_pl_id
modifier|*
name|p
decl_stmt|;
name|struct
name|ikev1_pl_id
name|id
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|idtypestr
index|[]
init|=
block|{
literal|"IPv4"
block|,
literal|"IPv4net"
block|,
literal|"IPv6"
block|,
literal|"IPv6net"
block|, 	}
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|ipsecidtypestr
index|[]
init|=
block|{
name|NULL
block|,
literal|"IPv4"
block|,
literal|"FQDN"
block|,
literal|"user FQDN"
block|,
literal|"IPv4net"
block|,
literal|"IPv6"
block|,
literal|"IPv6net"
block|,
literal|"IPv4range"
block|,
literal|"IPv6range"
block|,
literal|"ASN1 DN"
block|,
literal|"ASN1 GN"
block|,
literal|"keyid"
block|, 	}
decl_stmt|;
name|int
name|len
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|data
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s:"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_ID
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
expr|struct
name|ikev1_pl_id
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|id
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|id
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
operator|<
name|item_len
condition|)
block|{
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|(
name|p
operator|+
literal|1
operator|)
expr_stmt|;
name|len
operator|=
name|item_len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|data
operator|=
name|NULL
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
block|}
if|#
directive|if
literal|0
comment|/*debug*/
block|ND_PRINT((ndo," [phase=%d doi=%d proto=%d]", phase, doi, proto));
endif|#
directive|endif
switch|switch
condition|(
name|phase
condition|)
block|{
ifndef|#
directive|ifndef
name|USE_IPSECDOI_IN_PHASE1
case|case
literal|1
case|:
endif|#
directive|endif
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" idtype=%s"
operator|,
name|STR_OR_ID
argument_list|(
name|id
operator|.
name|d
operator|.
name|id_type
argument_list|,
name|idtypestr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" doi_data=%u"
operator|,
call|(
name|uint32_t
call|)
argument_list|(
name|ntohl
argument_list|(
name|id
operator|.
name|d
operator|.
name|doi_data
argument_list|)
operator|&
literal|0xffffff
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|USE_IPSECDOI_IN_PHASE1
case|case
literal|1
case|:
endif|#
directive|endif
case|case
literal|2
case|:
block|{
specifier|const
name|struct
name|ipsecdoi_id
modifier|*
name|p
decl_stmt|;
name|struct
name|ipsecdoi_id
name|id
decl_stmt|;
name|struct
name|protoent
modifier|*
name|pe
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|ipsecdoi_id
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|id
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|id
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" idtype=%s"
operator|,
name|STR_OR_ID
argument_list|(
name|id
operator|.
name|type
argument_list|,
name|ipsecidtypestr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* A protocol ID of 0 DOES NOT mean IPPROTO_IP! */
name|pe
operator|=
name|id
operator|.
name|proto_id
condition|?
name|getprotobynumber
argument_list|(
name|id
operator|.
name|proto_id
argument_list|)
else|:
name|NULL
expr_stmt|;
if|if
condition|(
name|pe
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" protoid=%s"
operator|,
name|pe
operator|->
name|p_name
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" protoid=%u"
operator|,
name|id
operator|.
name|proto_id
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" port=%d"
operator|,
name|ntohs
argument_list|(
name|id
operator|.
name|port
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|len
condition|)
break|break;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
goto|goto
name|trunc
goto|;
name|ND_TCHECK2
argument_list|(
operator|*
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|id
operator|.
name|type
condition|)
block|{
case|case
name|IPSECDOI_ID_IPV4_ADDR
case|:
if|if
condition|(
name|len
operator|<
literal|4
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d [bad:< 4]"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d %s"
operator|,
name|len
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|data
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IPSECDOI_ID_FQDN
case|:
case|case
name|IPSECDOI_ID_USER_FQDN
case|:
block|{
name|int
name|i
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d "
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|safeputchar
argument_list|(
name|ndo
argument_list|,
name|data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
break|break;
block|}
case|case
name|IPSECDOI_ID_IPV4_ADDR_SUBNET
case|:
block|{
specifier|const
name|u_char
modifier|*
name|mask
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|8
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d [bad:< 8]"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
else|else
block|{
name|mask
operator|=
name|data
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d %s/%u.%u.%u.%u"
operator|,
name|len
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|data
argument_list|)
operator|,
name|mask
index|[
literal|0
index|]
operator|,
name|mask
index|[
literal|1
index|]
operator|,
name|mask
index|[
literal|2
index|]
operator|,
name|mask
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
name|len
operator|=
literal|0
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|INET6
case|case
name|IPSECDOI_ID_IPV6_ADDR
case|:
if|if
condition|(
name|len
operator|<
literal|16
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d [bad:< 16]"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d %s"
operator|,
name|len
operator|,
name|ip6addr_string
argument_list|(
name|ndo
argument_list|,
name|data
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IPSECDOI_ID_IPV6_ADDR_SUBNET
case|:
block|{
specifier|const
name|u_char
modifier|*
name|mask
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|20
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d [bad:< 20]"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
else|else
block|{
name|mask
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|(
name|data
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|)
expr_stmt|;
comment|/*XXX*/
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d %s/0x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x"
operator|,
name|len
operator|,
name|ip6addr_string
argument_list|(
name|ndo
argument_list|,
name|data
argument_list|)
operator|,
name|mask
index|[
literal|0
index|]
operator|,
name|mask
index|[
literal|1
index|]
operator|,
name|mask
index|[
literal|2
index|]
operator|,
name|mask
index|[
literal|3
index|]
operator|,
name|mask
index|[
literal|4
index|]
operator|,
name|mask
index|[
literal|5
index|]
operator|,
name|mask
index|[
literal|6
index|]
operator|,
name|mask
index|[
literal|7
index|]
operator|,
name|mask
index|[
literal|8
index|]
operator|,
name|mask
index|[
literal|9
index|]
operator|,
name|mask
index|[
literal|10
index|]
operator|,
name|mask
index|[
literal|11
index|]
operator|,
name|mask
index|[
literal|12
index|]
operator|,
name|mask
index|[
literal|13
index|]
operator|,
name|mask
index|[
literal|14
index|]
operator|,
name|mask
index|[
literal|15
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
name|len
operator|=
literal|0
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/*INET6*/
case|case
name|IPSECDOI_ID_IPV4_ADDR_RANGE
case|:
if|if
condition|(
name|len
operator|<
literal|8
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d [bad:< 8]"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d %s-%s"
operator|,
name|len
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|data
argument_list|)
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|data
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|len
operator|=
literal|0
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|IPSECDOI_ID_IPV6_ADDR_RANGE
case|:
if|if
condition|(
name|len
operator|<
literal|32
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d [bad:< 32]"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d %s-%s"
operator|,
name|len
operator|,
name|ip6addr_string
argument_list|(
name|ndo
argument_list|,
name|data
argument_list|)
operator|,
name|ip6addr_string
argument_list|(
name|ndo
argument_list|,
name|data
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|len
operator|=
literal|0
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/*INET6*/
case|case
name|IPSECDOI_ID_DER_ASN1_DN
case|:
case|case
name|IPSECDOI_ID_DER_ASN1_GN
case|:
case|case
name|IPSECDOI_ID_KEY_ID
case|:
break|break;
block|}
break|break;
block|}
block|}
if|if
condition|(
name|data
operator|&&
name|len
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|2
operator|<
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
operator|(
name|caddr_t
operator|)
name|data
argument_list|,
name|len
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|item_len
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_ID
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_cert_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi0
name|_U_
parameter_list|,
name|uint32_t
name|proto0
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
specifier|const
name|struct
name|ikev1_pl_cert
modifier|*
name|p
decl_stmt|;
name|struct
name|ikev1_pl_cert
name|cert
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|certstr
index|[]
init|=
block|{
literal|"none"
block|,
literal|"pkcs7"
block|,
literal|"pgp"
block|,
literal|"dns"
block|,
literal|"x509sign"
block|,
literal|"x509ke"
block|,
literal|"kerberos"
block|,
literal|"crl"
block|,
literal|"arl"
block|,
literal|"spki"
block|,
literal|"x509attr"
block|, 	}
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s:"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_CERT
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
expr|struct
name|ikev1_pl_cert
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|cert
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|cert
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d"
operator|,
name|item_len
operator|-
literal|4
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" type=%s"
operator|,
name|STR_OR_ID
argument_list|(
operator|(
name|cert
operator|.
name|encode
operator|)
argument_list|,
name|certstr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|2
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|item_len
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
argument_list|,
name|item_len
operator|-
literal|4
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|item_len
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_CERT
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_cr_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi0
name|_U_
parameter_list|,
name|uint32_t
name|proto0
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
specifier|const
name|struct
name|ikev1_pl_cert
modifier|*
name|p
decl_stmt|;
name|struct
name|ikev1_pl_cert
name|cert
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|certstr
index|[]
init|=
block|{
literal|"none"
block|,
literal|"pkcs7"
block|,
literal|"pgp"
block|,
literal|"dns"
block|,
literal|"x509sign"
block|,
literal|"x509ke"
block|,
literal|"kerberos"
block|,
literal|"crl"
block|,
literal|"arl"
block|,
literal|"spki"
block|,
literal|"x509attr"
block|, 	}
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s:"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_CR
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
expr|struct
name|ikev1_pl_cert
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|cert
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|cert
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d"
operator|,
name|item_len
operator|-
literal|4
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" type=%s"
operator|,
name|STR_OR_ID
argument_list|(
operator|(
name|cert
operator|.
name|encode
operator|)
argument_list|,
name|certstr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|2
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|item_len
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
argument_list|,
name|item_len
operator|-
literal|4
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|item_len
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_CR
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_hash_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
name|struct
name|isakmp_gen
name|e
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s:"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_HASH
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d"
operator|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|2
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_HASH
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_sig_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
name|struct
name|isakmp_gen
name|e
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s:"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_SIG
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d"
operator|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|2
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_SIG
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_nonce_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
name|struct
name|isakmp_gen
name|e
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s:"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_NONCE
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" n len=%d"
operator|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|2
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
elseif|else
if|if
condition|(
literal|1
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ike_show_somedata
argument_list|(
name|ndo
argument_list|,
operator|(
name|u_char
operator|*
operator|)
call|(
name|caddr_t
call|)
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
argument_list|,
name|ep
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_NONCE
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_n_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|phase
parameter_list|,
name|uint32_t
name|doi0
name|_U_
parameter_list|,
name|uint32_t
name|proto0
name|_U_
parameter_list|,
name|int
name|depth
parameter_list|)
block|{
name|struct
name|ikev1_pl_n
modifier|*
name|p
decl_stmt|,
name|n
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
name|u_char
modifier|*
name|ep2
decl_stmt|;
name|uint32_t
name|doi
decl_stmt|;
name|uint32_t
name|proto
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|notify_error_str
index|[]
init|=
block|{
name|NULL
block|,
literal|"INVALID-PAYLOAD-TYPE"
block|,
literal|"DOI-NOT-SUPPORTED"
block|,
literal|"SITUATION-NOT-SUPPORTED"
block|,
literal|"INVALID-COOKIE"
block|,
literal|"INVALID-MAJOR-VERSION"
block|,
literal|"INVALID-MINOR-VERSION"
block|,
literal|"INVALID-EXCHANGE-TYPE"
block|,
literal|"INVALID-FLAGS"
block|,
literal|"INVALID-MESSAGE-ID"
block|,
literal|"INVALID-PROTOCOL-ID"
block|,
literal|"INVALID-SPI"
block|,
literal|"INVALID-TRANSFORM-ID"
block|,
literal|"ATTRIBUTES-NOT-SUPPORTED"
block|,
literal|"NO-PROPOSAL-CHOSEN"
block|,
literal|"BAD-PROPOSAL-SYNTAX"
block|,
literal|"PAYLOAD-MALFORMED"
block|,
literal|"INVALID-KEY-INFORMATION"
block|,
literal|"INVALID-ID-INFORMATION"
block|,
literal|"INVALID-CERT-ENCODING"
block|,
literal|"INVALID-CERTIFICATE"
block|,
literal|"CERT-TYPE-UNSUPPORTED"
block|,
literal|"INVALID-CERT-AUTHORITY"
block|,
literal|"INVALID-HASH-INFORMATION"
block|,
literal|"AUTHENTICATION-FAILED"
block|,
literal|"INVALID-SIGNATURE"
block|,
literal|"ADDRESS-NOTIFICATION"
block|,
literal|"NOTIFY-SA-LIFETIME"
block|,
literal|"CERTIFICATE-UNAVAILABLE"
block|,
literal|"UNSUPPORTED-EXCHANGE-TYPE"
block|,
literal|"UNEQUAL-PAYLOAD-LENGTHS"
block|, 	}
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|ipsec_notify_error_str
index|[]
init|=
block|{
literal|"RESERVED"
block|, 	}
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|notify_status_str
index|[]
init|=
block|{
literal|"CONNECTED"
block|, 	}
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|ipsec_notify_status_str
index|[]
init|=
block|{
literal|"RESPONDER-LIFETIME"
block|,
literal|"REPLAY-STATUS"
block|,
literal|"INITIAL-CONTACT"
block|, 	}
decl_stmt|;
comment|/* NOTE: these macro must be called with x in proper range */
comment|/* 0 - 8191 */
define|#
directive|define
name|NOTIFY_ERROR_STR
parameter_list|(
name|x
parameter_list|)
define|\
value|STR_OR_ID((x), notify_error_str)
comment|/* 8192 - 16383 */
define|#
directive|define
name|IPSEC_NOTIFY_ERROR_STR
parameter_list|(
name|x
parameter_list|)
define|\
value|STR_OR_ID((u_int)((x) - 8192), ipsec_notify_error_str)
comment|/* 16384 - 24575 */
define|#
directive|define
name|NOTIFY_STATUS_STR
parameter_list|(
name|x
parameter_list|)
define|\
value|STR_OR_ID((u_int)((x) - 16384), notify_status_str)
comment|/* 24576 - 32767 */
define|#
directive|define
name|IPSEC_NOTIFY_STATUS_STR
parameter_list|(
name|x
parameter_list|)
define|\
value|STR_OR_ID((u_int)((x) - 24576), ipsec_notify_status_str)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s:"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_N
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
expr|struct
name|ikev1_pl_n
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|n
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|n
argument_list|)
argument_list|)
expr_stmt|;
name|doi
operator|=
name|ntohl
argument_list|(
name|n
operator|.
name|doi
argument_list|)
expr_stmt|;
name|proto
operator|=
name|n
operator|.
name|prot_id
expr_stmt|;
if|if
condition|(
name|doi
operator|!=
literal|1
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" doi=%d"
operator|,
name|doi
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" proto=%d"
operator|,
name|proto
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
operator|<
literal|8192
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" type=%s"
operator|,
name|NOTIFY_ERROR_STR
argument_list|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
operator|<
literal|16384
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" type=%s"
operator|,
name|numstr
argument_list|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
operator|<
literal|24576
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" type=%s"
operator|,
name|NOTIFY_STATUS_STR
argument_list|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" type=%s"
operator|,
name|numstr
argument_list|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|.
name|spi_size
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" spi="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|p
operator|+
literal|1
argument_list|)
argument_list|,
name|n
operator|.
name|spi_size
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
operator|(
name|p
operator|+
literal|1
operator|)
operator|+
name|n
operator|.
name|spi_size
return|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" doi=ipsec"
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" proto=%s"
operator|,
name|PROTOIDSTR
argument_list|(
name|proto
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
operator|<
literal|8192
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" type=%s"
operator|,
name|NOTIFY_ERROR_STR
argument_list|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
operator|<
literal|16384
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" type=%s"
operator|,
name|IPSEC_NOTIFY_ERROR_STR
argument_list|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
operator|<
literal|24576
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" type=%s"
operator|,
name|NOTIFY_STATUS_STR
argument_list|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
operator|<
literal|32768
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" type=%s"
operator|,
name|IPSEC_NOTIFY_STATUS_STR
argument_list|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" type=%s"
operator|,
name|numstr
argument_list|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|.
name|spi_size
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" spi="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|p
operator|+
literal|1
argument_list|)
argument_list|,
name|n
operator|.
name|spi_size
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
name|cp
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|(
name|p
operator|+
literal|1
operator|)
operator|+
name|n
operator|.
name|spi_size
expr_stmt|;
name|ep2
operator|=
operator|(
name|u_char
operator|*
operator|)
name|p
operator|+
name|item_len
expr_stmt|;
if|if
condition|(
name|cp
operator|<
name|ep
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" orig=("
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
condition|)
block|{
case|case
name|IPSECDOI_NTYPE_RESPONDER_LIFETIME
case|:
block|{
specifier|const
name|struct
name|attrmap
modifier|*
name|map
init|=
name|oakley_t_map
decl_stmt|;
name|size_t
name|nmap
init|=
sizeof|sizeof
argument_list|(
name|oakley_t_map
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|oakley_t_map
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
while|while
condition|(
name|cp
operator|<
name|ep
operator|&&
name|cp
operator|<
name|ep2
condition|)
block|{
name|cp
operator|=
name|ikev1_attrmap_print
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
operator|(
name|ep
operator|<
name|ep2
operator|)
condition|?
name|ep
else|:
name|ep2
argument_list|,
name|map
argument_list|,
name|nmap
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|IPSECDOI_NTYPE_REPLAY_STATUS
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"replay detection %sabled"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|cp
argument_list|)
condition|?
literal|"en"
else|:
literal|"dis"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISAKMP_NTYPE_NO_PROPOSAL_CHOSEN
case|:
if|if
condition|(
name|ikev1_sub_print
argument_list|(
name|ndo
argument_list|,
name|ISAKMP_NPTYPE_SA
argument_list|,
operator|(
expr|struct
name|isakmp_gen
operator|*
operator|)
name|cp
argument_list|,
name|ep
argument_list|,
name|phase
argument_list|,
name|doi
argument_list|,
name|proto
argument_list|,
name|depth
argument_list|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
break|break;
default|default:
comment|/* NULL is dummy */
name|isakmp_print
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
name|item_len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
operator|-
name|n
operator|.
name|spi_size
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|")"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|item_len
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_N
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_d_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi0
name|_U_
parameter_list|,
name|uint32_t
name|proto0
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
specifier|const
name|struct
name|ikev1_pl_d
modifier|*
name|p
decl_stmt|;
name|struct
name|ikev1_pl_d
name|d
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|q
decl_stmt|;
name|uint32_t
name|doi
decl_stmt|;
name|uint32_t
name|proto
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s:"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_D
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
expr|struct
name|ikev1_pl_d
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|d
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|d
argument_list|)
argument_list|)
expr_stmt|;
name|doi
operator|=
name|ntohl
argument_list|(
name|d
operator|.
name|doi
argument_list|)
expr_stmt|;
name|proto
operator|=
name|d
operator|.
name|prot_id
expr_stmt|;
if|if
condition|(
name|doi
operator|!=
literal|1
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" doi=%u"
operator|,
name|doi
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" proto=%u"
operator|,
name|proto
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" doi=ipsec"
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" proto=%s"
operator|,
name|PROTOIDSTR
argument_list|(
name|proto
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" spilen=%u"
operator|,
name|d
operator|.
name|spi_size
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" nspi=%u"
operator|,
name|ntohs
argument_list|(
name|d
operator|.
name|num_spi
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" spi="
operator|)
argument_list|)
expr_stmt|;
name|q
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|p
operator|+
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntohs
argument_list|(
name|d
operator|.
name|num_spi
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|","
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
operator|(
name|caddr_t
operator|)
name|q
argument_list|,
name|d
operator|.
name|spi_size
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
name|q
operator|+=
name|d
operator|.
name|spi_size
expr_stmt|;
block|}
return|return
name|q
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_D
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_vid_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
name|struct
name|isakmp_gen
name|e
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s:"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_VID
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d"
operator|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|2
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_VID
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/************************************************************/
end_comment

begin_comment
comment|/*                                                          */
end_comment

begin_comment
comment|/*              IKE v2 - rfc4306 - dissector                */
end_comment

begin_comment
comment|/*                                                          */
end_comment

begin_comment
comment|/************************************************************/
end_comment

begin_function
specifier|static
name|void
name|ikev2_pay_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|char
modifier|*
name|payname
parameter_list|,
name|int
name|critical
parameter_list|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s%s:"
operator|,
name|payname
operator|,
name|critical
operator|&
literal|0x80
condition|?
literal|"[C]"
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_gen_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|)
block|{
name|struct
name|isakmp_gen
name|e
decl_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|ikev2_pay_print
argument_list|(
name|ndo
argument_list|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
argument_list|,
name|e
operator|.
name|critical
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d"
operator|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|2
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_t_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
name|int
name|pcount
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
specifier|const
name|struct
name|ikev2_t
modifier|*
name|p
decl_stmt|;
name|struct
name|ikev2_t
name|t
decl_stmt|;
name|uint16_t
name|t_id
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
specifier|const
name|char
modifier|*
name|idstr
decl_stmt|;
specifier|const
name|struct
name|attrmap
modifier|*
name|map
decl_stmt|;
name|size_t
name|nmap
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|ep2
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|ikev2_t
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|t
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|ikev2_pay_print
argument_list|(
name|ndo
argument_list|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_T
argument_list|)
argument_list|,
name|t
operator|.
name|h
operator|.
name|critical
argument_list|)
expr_stmt|;
name|t_id
operator|=
name|ntohs
argument_list|(
name|t
operator|.
name|t_id
argument_list|)
expr_stmt|;
name|map
operator|=
name|NULL
expr_stmt|;
name|nmap
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|t
operator|.
name|t_type
condition|)
block|{
case|case
name|IV2_T_ENCR
case|:
name|idstr
operator|=
name|STR_OR_ID
argument_list|(
name|t_id
argument_list|,
name|esp_p_map
argument_list|)
expr_stmt|;
name|map
operator|=
name|encr_t_map
expr_stmt|;
name|nmap
operator|=
sizeof|sizeof
argument_list|(
name|encr_t_map
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|encr_t_map
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|IV2_T_PRF
case|:
name|idstr
operator|=
name|STR_OR_ID
argument_list|(
name|t_id
argument_list|,
name|prf_p_map
argument_list|)
expr_stmt|;
break|break;
case|case
name|IV2_T_INTEG
case|:
name|idstr
operator|=
name|STR_OR_ID
argument_list|(
name|t_id
argument_list|,
name|integ_p_map
argument_list|)
expr_stmt|;
break|break;
case|case
name|IV2_T_DH
case|:
name|idstr
operator|=
name|STR_OR_ID
argument_list|(
name|t_id
argument_list|,
name|dh_p_map
argument_list|)
expr_stmt|;
break|break;
case|case
name|IV2_T_ESN
case|:
name|idstr
operator|=
name|STR_OR_ID
argument_list|(
name|t_id
argument_list|,
name|esn_p_map
argument_list|)
expr_stmt|;
break|break;
default|default:
name|idstr
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|idstr
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" #%u type=%s id=%s "
operator|,
name|pcount
operator|,
name|STR_OR_ID
argument_list|(
name|t
operator|.
name|t_type
argument_list|,
name|ikev2_t_type_map
argument_list|)
operator|,
name|idstr
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" #%u type=%s id=%u "
operator|,
name|pcount
operator|,
name|STR_OR_ID
argument_list|(
name|t
operator|.
name|t_type
argument_list|,
name|ikev2_t_type_map
argument_list|)
operator|,
name|t
operator|.
name|t_id
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|(
name|p
operator|+
literal|1
operator|)
expr_stmt|;
name|ep2
operator|=
operator|(
name|u_char
operator|*
operator|)
name|p
operator|+
name|item_len
expr_stmt|;
while|while
condition|(
name|cp
operator|<
name|ep
operator|&&
name|cp
operator|<
name|ep2
condition|)
block|{
if|if
condition|(
name|map
operator|&&
name|nmap
condition|)
block|{
name|cp
operator|=
name|ikev1_attrmap_print
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
operator|(
name|ep
operator|<
name|ep2
operator|)
condition|?
name|ep
else|:
name|ep2
argument_list|,
name|map
argument_list|,
name|nmap
argument_list|)
expr_stmt|;
block|}
else|else
name|cp
operator|=
name|ikev1_attr_print
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
operator|(
name|ep
operator|<
name|ep2
operator|)
condition|?
name|ep
else|:
name|ep2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ep
operator|<
name|ep2
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
return|return
name|cp
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_T
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_p_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
name|int
name|pcount
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|phase
parameter_list|,
name|uint32_t
name|doi0
parameter_list|,
name|uint32_t
name|proto0
name|_U_
parameter_list|,
name|int
name|depth
parameter_list|)
block|{
specifier|const
name|struct
name|ikev2_p
modifier|*
name|p
decl_stmt|;
name|struct
name|ikev2_p
name|prop
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|ikev2_p
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|prop
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|prop
argument_list|)
argument_list|)
expr_stmt|;
name|ikev2_pay_print
argument_list|(
name|ndo
argument_list|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_P
argument_list|)
argument_list|,
name|prop
operator|.
name|h
operator|.
name|critical
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" #%u protoid=%s transform=%d len=%u"
operator|,
name|prop
operator|.
name|p_no
operator|,
name|PROTOIDSTR
argument_list|(
name|prop
operator|.
name|prot_id
argument_list|)
operator|,
name|prop
operator|.
name|num_t
operator|,
name|ntohs
argument_list|(
name|prop
operator|.
name|h
operator|.
name|len
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|prop
operator|.
name|spi_size
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" spi="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|p
operator|+
literal|1
argument_list|)
argument_list|,
name|prop
operator|.
name|spi_size
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
name|ext
operator|=
operator|(
expr|struct
name|isakmp_gen
operator|*
operator|)
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|(
name|p
operator|+
literal|1
operator|)
operator|+
name|prop
operator|.
name|spi_size
operator|)
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|cp
operator|=
name|ikev2_sub_print
argument_list|(
name|ndo
argument_list|,
name|NULL
argument_list|,
name|ISAKMP_NPTYPE_T
argument_list|,
name|ext
argument_list|,
name|ep
argument_list|,
name|phase
argument_list|,
name|doi0
argument_list|,
name|prop
operator|.
name|prot_id
argument_list|,
name|depth
argument_list|)
expr_stmt|;
return|return
name|cp
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_P
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_sa_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext1
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
name|struct
name|isakmp_gen
name|e
decl_stmt|;
name|int
name|osa_length
decl_stmt|,
name|sa_length
decl_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext1
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext1
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|ikev2_pay_print
argument_list|(
name|ndo
argument_list|,
literal|"sa"
argument_list|,
name|e
operator|.
name|critical
argument_list|)
expr_stmt|;
name|osa_length
operator|=
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
expr_stmt|;
name|sa_length
operator|=
name|osa_length
operator|-
literal|4
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d"
operator|,
name|sa_length
operator|)
argument_list|)
expr_stmt|;
name|ikev2_sub_print
argument_list|(
name|ndo
argument_list|,
name|NULL
argument_list|,
name|ISAKMP_NPTYPE_P
argument_list|,
name|ext1
operator|+
literal|1
argument_list|,
name|ep
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|depth
argument_list|)
expr_stmt|;
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext1
operator|+
name|osa_length
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_ke_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
name|struct
name|ikev2_ke
name|ke
decl_stmt|;
name|struct
name|ikev2_ke
modifier|*
name|k
decl_stmt|;
name|k
operator|=
operator|(
expr|struct
name|ikev2_ke
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|ke
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|ke
argument_list|)
argument_list|)
expr_stmt|;
name|ikev2_pay_print
argument_list|(
name|ndo
argument_list|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
argument_list|,
name|ke
operator|.
name|h
operator|.
name|critical
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%u group=%s"
operator|,
name|ntohs
argument_list|(
name|ke
operator|.
name|h
operator|.
name|len
argument_list|)
operator|-
literal|8
operator|,
name|STR_OR_ID
argument_list|(
name|ntohs
argument_list|(
name|ke
operator|.
name|ke_group
argument_list|)
argument_list|,
name|dh_p_map
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|2
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|8
operator|<
name|ntohs
argument_list|(
name|ke
operator|.
name|h
operator|.
name|len
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|k
operator|+
literal|1
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|ke
operator|.
name|h
operator|.
name|len
argument_list|)
operator|-
literal|8
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|ntohs
argument_list|(
name|ke
operator|.
name|h
operator|.
name|len
argument_list|)
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_ID_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
name|struct
name|ikev2_id
name|id
decl_stmt|;
name|int
name|id_len
decl_stmt|,
name|idtype_len
decl_stmt|,
name|i
decl_stmt|;
name|unsigned
name|int
name|dumpascii
decl_stmt|,
name|dumphex
decl_stmt|;
name|unsigned
name|char
modifier|*
name|typedata
decl_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|id
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|id
argument_list|)
argument_list|)
expr_stmt|;
name|ikev2_pay_print
argument_list|(
name|ndo
argument_list|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
argument_list|,
name|id
operator|.
name|h
operator|.
name|critical
argument_list|)
expr_stmt|;
name|id_len
operator|=
name|ntohs
argument_list|(
name|id
operator|.
name|h
operator|.
name|len
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d"
operator|,
name|id_len
operator|-
literal|4
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|2
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|id_len
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
argument_list|,
name|id_len
operator|-
literal|4
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
name|idtype_len
operator|=
name|id_len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ikev2_id
argument_list|)
expr_stmt|;
name|dumpascii
operator|=
literal|0
expr_stmt|;
name|dumphex
operator|=
literal|0
expr_stmt|;
name|typedata
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|ext
operator|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ikev2_id
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|id
operator|.
name|type
condition|)
block|{
case|case
name|ID_IPV4_ADDR
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" ipv4:"
operator|)
argument_list|)
expr_stmt|;
name|dumphex
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ID_FQDN
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" fqdn:"
operator|)
argument_list|)
expr_stmt|;
name|dumpascii
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ID_RFC822_ADDR
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" rfc822:"
operator|)
argument_list|)
expr_stmt|;
name|dumpascii
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ID_IPV6_ADDR
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" ipv6:"
operator|)
argument_list|)
expr_stmt|;
name|dumphex
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ID_DER_ASN1_DN
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" dn:"
operator|)
argument_list|)
expr_stmt|;
name|dumphex
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ID_DER_ASN1_GN
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" gn:"
operator|)
argument_list|)
expr_stmt|;
name|dumphex
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ID_KEY_ID
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" keyid:"
operator|)
argument_list|)
expr_stmt|;
name|dumphex
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|dumpascii
condition|)
block|{
name|ND_TCHECK2
argument_list|(
operator|*
name|typedata
argument_list|,
name|idtype_len
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|idtype_len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ND_ISPRINT
argument_list|(
name|typedata
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%c"
operator|,
name|typedata
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"."
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|dumphex
condition|)
block|{
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
operator|(
name|caddr_t
operator|)
name|typedata
argument_list|,
name|idtype_len
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|id_len
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_cert_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
return|return
name|ikev2_gen_print
argument_list|(
name|ndo
argument_list|,
name|tpay
argument_list|,
name|ext
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_cr_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
return|return
name|ikev2_gen_print
argument_list|(
name|ndo
argument_list|,
name|tpay
argument_list|,
name|ext
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_auth_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
name|struct
name|ikev2_auth
name|a
decl_stmt|;
specifier|const
name|char
modifier|*
name|v2_auth
index|[]
init|=
block|{
literal|"invalid"
block|,
literal|"rsasig"
block|,
literal|"shared-secret"
block|,
literal|"dsssig"
block|}
decl_stmt|;
name|u_char
modifier|*
name|authdata
init|=
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
sizeof|sizeof
argument_list|(
name|a
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|len
decl_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|a
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|a
argument_list|)
argument_list|)
expr_stmt|;
name|ikev2_pay_print
argument_list|(
name|ndo
argument_list|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
argument_list|,
name|a
operator|.
name|h
operator|.
name|critical
argument_list|)
expr_stmt|;
name|len
operator|=
name|ntohs
argument_list|(
name|a
operator|.
name|h
operator|.
name|len
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d method=%s"
operator|,
name|len
operator|-
literal|4
operator|,
name|STR_OR_ID
argument_list|(
name|a
operator|.
name|auth_method
argument_list|,
name|v2_auth
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|len
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" authdata=("
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
operator|(
name|caddr_t
operator|)
name|authdata
argument_list|,
name|len
operator|-
sizeof|sizeof
argument_list|(
name|a
argument_list|)
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|") "
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|len
condition|)
block|{
if|if
condition|(
operator|!
name|ike_show_somedata
argument_list|(
name|ndo
argument_list|,
name|authdata
argument_list|,
name|ep
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|len
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_nonce_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
name|struct
name|isakmp_gen
name|e
decl_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|ikev2_pay_print
argument_list|(
name|ndo
argument_list|,
literal|"nonce"
argument_list|,
name|e
operator|.
name|critical
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d"
operator|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" nonce=("
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|") "
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|ike_show_somedata
argument_list|(
name|ndo
argument_list|,
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|(
name|ext
operator|+
literal|1
operator|)
argument_list|,
name|ep
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* notify payloads */
end_comment

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_n_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
name|_U_
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
name|struct
name|ikev2_n
modifier|*
name|p
decl_stmt|,
name|n
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
name|u_char
name|showspi
decl_stmt|,
name|showdata
decl_stmt|,
name|showsomedata
decl_stmt|;
specifier|const
name|char
modifier|*
name|notify_name
decl_stmt|;
name|uint32_t
name|type
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|ikev2_n
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|n
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|n
argument_list|)
argument_list|)
expr_stmt|;
name|ikev2_pay_print
argument_list|(
name|ndo
argument_list|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_N
argument_list|)
argument_list|,
name|n
operator|.
name|h
operator|.
name|critical
argument_list|)
expr_stmt|;
name|showspi
operator|=
literal|1
expr_stmt|;
name|showdata
operator|=
literal|0
expr_stmt|;
name|showsomedata
operator|=
literal|0
expr_stmt|;
name|notify_name
operator|=
name|NULL
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" prot_id=%s"
operator|,
name|PROTOIDSTR
argument_list|(
name|n
operator|.
name|prot_id
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|type
operator|=
name|ntohs
argument_list|(
name|n
operator|.
name|type
argument_list|)
expr_stmt|;
comment|/* notify space is annoying sparse */
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|IV2_NOTIFY_UNSUPPORTED_CRITICAL_PAYLOAD
case|:
name|notify_name
operator|=
literal|"unsupported_critical_payload"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_INVALID_IKE_SPI
case|:
name|notify_name
operator|=
literal|"invalid_ike_spi"
expr_stmt|;
name|showspi
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_INVALID_MAJOR_VERSION
case|:
name|notify_name
operator|=
literal|"invalid_major_version"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_INVALID_SYNTAX
case|:
name|notify_name
operator|=
literal|"invalid_syntax"
expr_stmt|;
name|showspi
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_INVALID_MESSAGE_ID
case|:
name|notify_name
operator|=
literal|"invalid_message_id"
expr_stmt|;
name|showspi
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_INVALID_SPI
case|:
name|notify_name
operator|=
literal|"invalid_spi"
expr_stmt|;
name|showspi
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_NO_PROPOSAL_CHOSEN
case|:
name|notify_name
operator|=
literal|"no_protocol_chosen"
expr_stmt|;
name|showspi
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_INVALID_KE_PAYLOAD
case|:
name|notify_name
operator|=
literal|"invalid_ke_payload"
expr_stmt|;
name|showspi
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_AUTHENTICATION_FAILED
case|:
name|notify_name
operator|=
literal|"authentication_failed"
expr_stmt|;
name|showspi
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_SINGLE_PAIR_REQUIRED
case|:
name|notify_name
operator|=
literal|"single_pair_required"
expr_stmt|;
name|showspi
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_NO_ADDITIONAL_SAS
case|:
name|notify_name
operator|=
literal|"no_additional_sas"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_INTERNAL_ADDRESS_FAILURE
case|:
name|notify_name
operator|=
literal|"internal_address_failure"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_FAILED_CP_REQUIRED
case|:
name|notify_name
operator|=
literal|"failed:cp_required"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_INVALID_SELECTORS
case|:
name|notify_name
operator|=
literal|"invalid_selectors"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_INITIAL_CONTACT
case|:
name|notify_name
operator|=
literal|"initial_contact"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_SET_WINDOW_SIZE
case|:
name|notify_name
operator|=
literal|"set_window_size"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_ADDITIONAL_TS_POSSIBLE
case|:
name|notify_name
operator|=
literal|"additional_ts_possible"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_IPCOMP_SUPPORTED
case|:
name|notify_name
operator|=
literal|"ipcomp_supported"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_NAT_DETECTION_SOURCE_IP
case|:
name|notify_name
operator|=
literal|"nat_detection_source_ip"
expr_stmt|;
name|showspi
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_NAT_DETECTION_DESTINATION_IP
case|:
name|notify_name
operator|=
literal|"nat_detection_destination_ip"
expr_stmt|;
name|showspi
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_COOKIE
case|:
name|notify_name
operator|=
literal|"cookie"
expr_stmt|;
name|showspi
operator|=
literal|1
expr_stmt|;
name|showsomedata
operator|=
literal|1
expr_stmt|;
name|showdata
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_USE_TRANSPORT_MODE
case|:
name|notify_name
operator|=
literal|"use_transport_mode"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_HTTP_CERT_LOOKUP_SUPPORTED
case|:
name|notify_name
operator|=
literal|"http_cert_lookup_supported"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_REKEY_SA
case|:
name|notify_name
operator|=
literal|"rekey_sa"
expr_stmt|;
name|showspi
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_ESP_TFC_PADDING_NOT_SUPPORTED
case|:
name|notify_name
operator|=
literal|"tfc_padding_not_supported"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IV2_NOTIFY_NON_FIRST_FRAGMENTS_ALSO
case|:
name|notify_name
operator|=
literal|"non_first_fragment_also"
expr_stmt|;
name|showspi
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|type
operator|<
literal|8192
condition|)
block|{
name|notify_name
operator|=
literal|"error"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|<
literal|16384
condition|)
block|{
name|notify_name
operator|=
literal|"private-error"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|<
literal|40960
condition|)
block|{
name|notify_name
operator|=
literal|"status"
expr_stmt|;
block|}
else|else
block|{
name|notify_name
operator|=
literal|"private-status"
expr_stmt|;
block|}
block|}
if|if
condition|(
name|notify_name
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" type=%u(%s)"
operator|,
name|type
operator|,
name|notify_name
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|showspi
operator|&&
name|n
operator|.
name|spi_size
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" spi="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|p
operator|+
literal|1
argument_list|)
argument_list|,
name|n
operator|.
name|spi_size
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
name|cp
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|(
name|p
operator|+
literal|1
operator|)
operator|+
name|n
operator|.
name|spi_size
expr_stmt|;
if|if
condition|(
literal|3
operator|<
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
name|showdata
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|showdata
operator|||
operator|(
name|showsomedata
operator|&&
name|ep
operator|-
name|cp
operator|<
literal|30
operator|)
operator|)
operator|&&
name|cp
operator|<
name|ep
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" data=("
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|cp
argument_list|)
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|")"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|showsomedata
operator|&&
name|cp
operator|<
name|ep
condition|)
block|{
if|if
condition|(
operator|!
name|ike_show_somedata
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
name|ep
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|item_len
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|ISAKMP_NPTYPE_N
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_d_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
return|return
name|ikev2_gen_print
argument_list|(
name|ndo
argument_list|,
name|tpay
argument_list|,
name|ext
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_vid_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
name|struct
name|isakmp_gen
name|e
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|vid
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|ikev2_pay_print
argument_list|(
name|ndo
argument_list|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
argument_list|,
name|e
operator|.
name|critical
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d vid="
operator|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
operator|)
argument_list|)
expr_stmt|;
name|vid
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|(
name|ext
operator|+
literal|1
operator|)
expr_stmt|;
name|len
operator|=
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|vid
argument_list|,
name|len
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ND_ISPRINT
argument_list|(
name|vid
index|[
name|i
index|]
argument_list|)
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%c"
operator|,
name|vid
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"."
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
literal|2
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|len
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return
operator|(
name|u_char
operator|*
operator|)
name|ext
operator|+
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_TS_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
return|return
name|ikev2_gen_print
argument_list|(
name|ndo
argument_list|,
name|tpay
argument_list|,
name|ext
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_e_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
ifndef|#
directive|ifndef
name|HAVE_LIBCRYPTO
name|_U_
endif|#
directive|endif
name|struct
name|isakmp
modifier|*
name|base
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
ifndef|#
directive|ifndef
name|HAVE_LIBCRYPTO
name|_U_
endif|#
directive|endif
name|uint32_t
name|phase
parameter_list|,
ifndef|#
directive|ifndef
name|HAVE_LIBCRYPTO
name|_U_
endif|#
directive|endif
name|uint32_t
name|doi
parameter_list|,
ifndef|#
directive|ifndef
name|HAVE_LIBCRYPTO
name|_U_
endif|#
directive|endif
name|uint32_t
name|proto
parameter_list|,
ifndef|#
directive|ifndef
name|HAVE_LIBCRYPTO
name|_U_
endif|#
directive|endif
name|int
name|depth
parameter_list|)
block|{
name|struct
name|isakmp_gen
name|e
decl_stmt|;
name|u_char
modifier|*
name|dat
decl_stmt|;
specifier|volatile
name|int
name|dlen
decl_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|ikev2_pay_print
argument_list|(
name|ndo
argument_list|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
argument_list|,
name|e
operator|.
name|critical
argument_list|)
expr_stmt|;
name|dlen
operator|=
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
operator|-
literal|4
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" len=%d"
operator|,
name|dlen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|2
operator|<
name|ndo
operator|->
name|ndo_vflag
operator|&&
literal|4
operator|<
name|dlen
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rawprint
argument_list|(
name|ndo
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|ext
operator|+
literal|1
argument_list|)
argument_list|,
name|dlen
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
name|dat
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|(
name|ext
operator|+
literal|1
operator|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|dat
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBCRYPTO
comment|/* try to decypt it! */
if|if
condition|(
name|esp_print_decrypt_buffer_by_ikev2
argument_list|(
name|ndo
argument_list|,
name|base
operator|->
name|flags
operator|&
name|ISAKMP_FLAG_I
argument_list|,
name|base
operator|->
name|i_ck
argument_list|,
name|base
operator|->
name|r_ck
argument_list|,
name|dat
argument_list|,
name|dat
operator|+
name|dlen
argument_list|)
condition|)
block|{
name|ext
operator|=
operator|(
specifier|const
expr|struct
name|isakmp_gen
operator|*
operator|)
name|ndo
operator|->
name|ndo_packetp
expr_stmt|;
comment|/* got it decrypted, print stuff inside. */
name|ikev2_sub_print
argument_list|(
name|ndo
argument_list|,
name|base
argument_list|,
name|e
operator|.
name|np
argument_list|,
name|ext
argument_list|,
name|ndo
operator|->
name|ndo_snapend
argument_list|,
name|phase
argument_list|,
name|doi
argument_list|,
name|proto
argument_list|,
name|depth
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* always return NULL, because E must be at end, and NP refers 	 * to what was inside. 	 */
return|return
name|NULL
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|tpay
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_cp_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
return|return
name|ikev2_gen_print
argument_list|(
name|ndo
argument_list|,
name|tpay
argument_list|,
name|ext
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_eap_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|tpay
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
name|u_int
name|item_len
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
name|_U_
parameter_list|,
name|uint32_t
name|phase
name|_U_
parameter_list|,
name|uint32_t
name|doi
name|_U_
parameter_list|,
name|uint32_t
name|proto
name|_U_
parameter_list|,
name|int
name|depth
name|_U_
parameter_list|)
block|{
return|return
name|ikev2_gen_print
argument_list|(
name|ndo
argument_list|,
name|tpay
argument_list|,
name|ext
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ike_sub0_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|np
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|phase
parameter_list|,
name|uint32_t
name|doi
parameter_list|,
name|uint32_t
name|proto
parameter_list|,
name|int
name|depth
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
name|struct
name|isakmp_gen
name|e
decl_stmt|;
name|u_int
name|item_len
decl_stmt|;
name|cp
operator|=
operator|(
name|u_char
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Since we can't have a payload length of less than 4 bytes, 	 * we need to bail out here if the generic header is nonsensical 	 * or truncated, otherwise we could loop forever processing 	 * zero-length items or otherwise misdissect the packet. 	 */
name|item_len
operator|=
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|item_len
operator|<=
literal|4
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|NPFUNC
argument_list|(
name|np
argument_list|)
condition|)
block|{
comment|/* 		 * XXX - what if item_len is too short, or too long, 		 * for this payload type? 		 */
name|cp
operator|=
call|(
modifier|*
name|npfunc
index|[
name|np
index|]
call|)
argument_list|(
name|ndo
argument_list|,
name|np
argument_list|,
name|ext
argument_list|,
name|item_len
argument_list|,
name|ep
argument_list|,
name|phase
argument_list|,
name|doi
argument_list|,
name|proto
argument_list|,
name|depth
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|NPSTR
argument_list|(
name|np
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|item_len
expr_stmt|;
block|}
return|return
name|cp
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|isakmp]"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev1_sub_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_char
name|np
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|phase
parameter_list|,
name|uint32_t
name|doi
parameter_list|,
name|uint32_t
name|proto
parameter_list|,
name|int
name|depth
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|isakmp_gen
name|e
decl_stmt|;
name|cp
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|ext
expr_stmt|;
while|while
condition|(
name|np
condition|)
block|{
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|ext
argument_list|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|depth
operator|++
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|depth
condition|;
name|i
operator|++
control|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"    "
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"("
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|=
name|ike_sub0_print
argument_list|(
name|ndo
argument_list|,
name|np
argument_list|,
name|ext
argument_list|,
name|ep
argument_list|,
name|phase
argument_list|,
name|doi
argument_list|,
name|proto
argument_list|,
name|depth
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|")"
operator|)
argument_list|)
expr_stmt|;
name|depth
operator|--
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
block|{
comment|/* Zero-length subitem */
return|return
name|NULL
return|;
block|}
name|np
operator|=
name|e
operator|.
name|np
expr_stmt|;
name|ext
operator|=
operator|(
expr|struct
name|isakmp_gen
operator|*
operator|)
name|cp
expr_stmt|;
block|}
return|return
name|cp
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|np
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|numstr
parameter_list|(
name|int
name|x
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"#%d"
argument_list|,
name|x
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ikev1_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
name|length
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp2
parameter_list|,
name|struct
name|isakmp
modifier|*
name|base
parameter_list|)
block|{
specifier|const
name|struct
name|isakmp
modifier|*
name|p
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
name|u_char
name|np
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|phase
decl_stmt|;
name|p
operator|=
operator|(
specifier|const
expr|struct
name|isakmp
operator|*
operator|)
name|bp
expr_stmt|;
name|ep
operator|=
name|ndo
operator|->
name|ndo_snapend
expr_stmt|;
name|phase
operator|=
operator|(
name|EXTRACT_32BITS
argument_list|(
name|base
operator|->
name|msgid
argument_list|)
operator|==
literal|0
operator|)
condition|?
literal|1
else|:
literal|2
expr_stmt|;
if|if
condition|(
name|phase
operator|==
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" phase %d"
operator|,
name|phase
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" phase %d/others"
operator|,
name|phase
operator|)
argument_list|)
expr_stmt|;
name|i
operator|=
name|cookie_find
argument_list|(
operator|&
name|base
operator|->
name|i_ck
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|iszero
argument_list|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|base
operator|->
name|r_ck
argument_list|,
sizeof|sizeof
argument_list|(
name|base
operator|->
name|r_ck
argument_list|)
argument_list|)
condition|)
block|{
comment|/* the first packet */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" I"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp2
condition|)
name|cookie_record
argument_list|(
operator|&
name|base
operator|->
name|i_ck
argument_list|,
name|bp2
argument_list|)
expr_stmt|;
block|}
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" ?"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bp2
operator|&&
name|cookie_isinitiator
argument_list|(
name|i
argument_list|,
name|bp2
argument_list|)
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" I"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bp2
operator|&&
name|cookie_isresponder
argument_list|(
name|i
argument_list|,
name|bp2
argument_list|)
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" R"
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" ?"
operator|)
argument_list|)
expr_stmt|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" %s"
operator|,
name|ETYPESTR
argument_list|(
name|base
operator|->
name|etype
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|base
operator|->
name|flags
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[%s%s]"
operator|,
name|base
operator|->
name|flags
operator|&
name|ISAKMP_FLAG_E
condition|?
literal|"E"
else|:
literal|""
operator|,
name|base
operator|->
name|flags
operator|&
name|ISAKMP_FLAG_C
condition|?
literal|"C"
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|":"
operator|)
argument_list|)
expr_stmt|;
comment|/* regardless of phase... */
if|if
condition|(
name|base
operator|->
name|flags
operator|&
name|ISAKMP_FLAG_E
condition|)
block|{
comment|/* 			 * encrypted, nothing we can do right now. 			 * we hope to decrypt the packet in the future... 			 */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [encrypted %s]"
operator|,
name|NPSTR
argument_list|(
name|base
operator|->
name|np
argument_list|)
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|CHECKLEN
argument_list|(
name|p
operator|+
literal|1
argument_list|,
name|base
operator|->
name|np
argument_list|)
expr_stmt|;
name|np
operator|=
name|base
operator|->
name|np
expr_stmt|;
name|ext
operator|=
operator|(
expr|struct
name|isakmp_gen
operator|*
operator|)
operator|(
name|p
operator|+
literal|1
operator|)
expr_stmt|;
name|ikev1_sub_print
argument_list|(
name|ndo
argument_list|,
name|np
argument_list|,
name|ext
argument_list|,
name|ep
argument_list|,
name|phase
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|done
label|:
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
if|if
condition|(
name|ntohl
argument_list|(
name|base
operator|->
name|len
argument_list|)
operator|!=
name|length
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" (len mismatch: isakmp %u/ip %u)"
operator|,
operator|(
name|uint32_t
operator|)
name|ntohl
argument_list|(
name|base
operator|->
name|len
argument_list|)
operator|,
name|length
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_sub0_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|struct
name|isakmp
modifier|*
name|base
parameter_list|,
name|u_char
name|np
parameter_list|,
name|int
name|pcount
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|phase
parameter_list|,
name|uint32_t
name|doi
parameter_list|,
name|uint32_t
name|proto
parameter_list|,
name|int
name|depth
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
name|struct
name|isakmp_gen
name|e
decl_stmt|;
name|u_int
name|item_len
decl_stmt|;
name|cp
operator|=
operator|(
name|u_char
operator|*
operator|)
name|ext
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Since we can't have a payload length of less than 4 bytes, 	 * we need to bail out here if the generic header is nonsensical 	 * or truncated, otherwise we could loop forever processing 	 * zero-length items or otherwise misdissect the packet. 	 */
name|item_len
operator|=
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|item_len
operator|<=
literal|4
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|np
operator|==
name|ISAKMP_NPTYPE_P
condition|)
block|{
name|cp
operator|=
name|ikev2_p_print
argument_list|(
name|ndo
argument_list|,
name|np
argument_list|,
name|pcount
argument_list|,
name|ext
argument_list|,
name|item_len
argument_list|,
name|ep
argument_list|,
name|phase
argument_list|,
name|doi
argument_list|,
name|proto
argument_list|,
name|depth
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|np
operator|==
name|ISAKMP_NPTYPE_T
condition|)
block|{
name|cp
operator|=
name|ikev2_t_print
argument_list|(
name|ndo
argument_list|,
name|np
argument_list|,
name|pcount
argument_list|,
name|ext
argument_list|,
name|item_len
argument_list|,
name|ep
argument_list|,
name|phase
argument_list|,
name|doi
argument_list|,
name|proto
argument_list|,
name|depth
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|np
operator|==
name|ISAKMP_NPTYPE_v2E
condition|)
block|{
name|cp
operator|=
name|ikev2_e_print
argument_list|(
name|ndo
argument_list|,
name|base
argument_list|,
name|np
argument_list|,
name|ext
argument_list|,
name|item_len
argument_list|,
name|ep
argument_list|,
name|phase
argument_list|,
name|doi
argument_list|,
name|proto
argument_list|,
name|depth
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|NPFUNC
argument_list|(
name|np
argument_list|)
condition|)
block|{
comment|/* 		 * XXX - what if item_len is too short, or too long, 		 * for this payload type? 		 */
name|cp
operator|=
call|(
modifier|*
name|npfunc
index|[
name|np
index|]
call|)
argument_list|(
name|ndo
argument_list|,
name|np
argument_list|,
comment|/*pcount,*/
name|ext
argument_list|,
name|item_len
argument_list|,
name|ep
argument_list|,
name|phase
argument_list|,
name|doi
argument_list|,
name|proto
argument_list|,
name|depth
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|NPSTR
argument_list|(
name|np
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|item_len
expr_stmt|;
block|}
return|return
name|cp
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|isakmp]"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u_char
modifier|*
name|ikev2_sub_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|struct
name|isakmp
modifier|*
name|base
parameter_list|,
name|u_char
name|np
parameter_list|,
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|,
name|uint32_t
name|phase
parameter_list|,
name|uint32_t
name|doi
parameter_list|,
name|uint32_t
name|proto
parameter_list|,
name|int
name|depth
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|pcount
decl_stmt|;
name|struct
name|isakmp_gen
name|e
decl_stmt|;
name|cp
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|ext
expr_stmt|;
name|pcount
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|np
condition|)
block|{
name|pcount
operator|++
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|ext
argument_list|)
expr_stmt|;
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|e
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|ext
argument_list|,
name|ntohs
argument_list|(
name|e
operator|.
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|depth
operator|++
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|depth
condition|;
name|i
operator|++
control|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"    "
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"("
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|=
name|ikev2_sub0_print
argument_list|(
name|ndo
argument_list|,
name|base
argument_list|,
name|np
argument_list|,
name|pcount
argument_list|,
name|ext
argument_list|,
name|ep
argument_list|,
name|phase
argument_list|,
name|doi
argument_list|,
name|proto
argument_list|,
name|depth
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|")"
operator|)
argument_list|)
expr_stmt|;
name|depth
operator|--
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
block|{
comment|/* Zero-length subitem */
return|return
name|NULL
return|;
block|}
name|np
operator|=
name|e
operator|.
name|np
expr_stmt|;
name|ext
operator|=
operator|(
expr|struct
name|isakmp_gen
operator|*
operator|)
name|cp
expr_stmt|;
block|}
return|return
name|cp
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|%s]"
operator|,
name|NPSTR
argument_list|(
name|np
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ikev2_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
name|length
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp2
name|_U_
parameter_list|,
name|struct
name|isakmp
modifier|*
name|base
parameter_list|)
block|{
specifier|const
name|struct
name|isakmp
modifier|*
name|p
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
name|u_char
name|np
decl_stmt|;
name|int
name|phase
decl_stmt|;
name|p
operator|=
operator|(
specifier|const
expr|struct
name|isakmp
operator|*
operator|)
name|bp
expr_stmt|;
name|ep
operator|=
name|ndo
operator|->
name|ndo_snapend
expr_stmt|;
name|phase
operator|=
operator|(
name|EXTRACT_32BITS
argument_list|(
name|base
operator|->
name|msgid
argument_list|)
operator|==
literal|0
operator|)
condition|?
literal|1
else|:
literal|2
expr_stmt|;
if|if
condition|(
name|phase
operator|==
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" parent_sa"
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" child_sa "
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" %s"
operator|,
name|ETYPESTR
argument_list|(
name|base
operator|->
name|etype
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|base
operator|->
name|flags
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[%s%s%s]"
operator|,
name|base
operator|->
name|flags
operator|&
name|ISAKMP_FLAG_I
condition|?
literal|"I"
else|:
literal|""
operator|,
name|base
operator|->
name|flags
operator|&
name|ISAKMP_FLAG_V
condition|?
literal|"V"
else|:
literal|""
operator|,
name|base
operator|->
name|flags
operator|&
name|ISAKMP_FLAG_R
condition|?
literal|"R"
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
specifier|const
name|struct
name|isakmp_gen
modifier|*
name|ext
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|":"
operator|)
argument_list|)
expr_stmt|;
comment|/* regardless of phase... */
if|if
condition|(
name|base
operator|->
name|flags
operator|&
name|ISAKMP_FLAG_E
condition|)
block|{
comment|/* 			 * encrypted, nothing we can do right now. 			 * we hope to decrypt the packet in the future... 			 */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [encrypted %s]"
operator|,
name|NPSTR
argument_list|(
name|base
operator|->
name|np
argument_list|)
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|CHECKLEN
argument_list|(
argument|p +
literal|1
argument_list|,
argument|base->np
argument_list|)
name|np
operator|=
name|base
operator|->
name|np
expr_stmt|;
name|ext
operator|=
operator|(
expr|struct
name|isakmp_gen
operator|*
operator|)
operator|(
name|p
operator|+
literal|1
operator|)
expr_stmt|;
name|ikev2_sub_print
argument_list|(
name|ndo
argument_list|,
name|base
argument_list|,
name|np
argument_list|,
name|ext
argument_list|,
name|ep
argument_list|,
name|phase
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|done
label|:
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
if|if
condition|(
name|ntohl
argument_list|(
name|base
operator|->
name|len
argument_list|)
operator|!=
name|length
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" (len mismatch: isakmp %u/ip %u)"
operator|,
operator|(
name|uint32_t
operator|)
name|ntohl
argument_list|(
name|base
operator|->
name|len
argument_list|)
operator|,
name|length
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|isakmp_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
name|length
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp2
parameter_list|)
block|{
specifier|const
name|struct
name|isakmp
modifier|*
name|p
decl_stmt|;
name|struct
name|isakmp
name|base
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
name|int
name|major
decl_stmt|,
name|minor
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBCRYPTO
comment|/* initialize SAs */
if|if
condition|(
name|ndo
operator|->
name|ndo_sa_list_head
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ndo
operator|->
name|ndo_espsecret
condition|)
name|esp_print_decodesecret
argument_list|(
name|ndo
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|p
operator|=
operator|(
specifier|const
expr|struct
name|isakmp
operator|*
operator|)
name|bp
expr_stmt|;
name|ep
operator|=
name|ndo
operator|->
name|ndo_snapend
expr_stmt|;
if|if
condition|(
operator|(
expr|struct
name|isakmp
operator|*
operator|)
name|ep
operator|<
name|p
operator|+
literal|1
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|isakmp]"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|UNALIGNED_MEMCPY
argument_list|(
operator|&
name|base
argument_list|,
name|p
argument_list|,
sizeof|sizeof
argument_list|(
name|base
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"isakmp"
operator|)
argument_list|)
expr_stmt|;
name|major
operator|=
operator|(
name|base
operator|.
name|vers
operator|&
name|ISAKMP_VERS_MAJOR
operator|)
operator|>>
name|ISAKMP_VERS_MAJOR_SHIFT
expr_stmt|;
name|minor
operator|=
operator|(
name|base
operator|.
name|vers
operator|&
name|ISAKMP_VERS_MINOR
operator|)
operator|>>
name|ISAKMP_VERS_MINOR_SHIFT
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" %d.%d"
operator|,
name|major
operator|,
name|minor
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" msgid "
operator|)
argument_list|)
expr_stmt|;
name|hexprint
argument_list|(
name|ndo
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|base
operator|.
name|msgid
argument_list|,
sizeof|sizeof
argument_list|(
name|base
operator|.
name|msgid
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
literal|1
operator|<
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" cookie "
operator|)
argument_list|)
expr_stmt|;
name|hexprint
argument_list|(
name|ndo
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|base
operator|.
name|i_ck
argument_list|,
sizeof|sizeof
argument_list|(
name|base
operator|.
name|i_ck
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"->"
operator|)
argument_list|)
expr_stmt|;
name|hexprint
argument_list|(
name|ndo
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|base
operator|.
name|r_ck
argument_list|,
sizeof|sizeof
argument_list|(
name|base
operator|.
name|r_ck
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|":"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|major
condition|)
block|{
case|case
name|IKEv1_MAJOR_VERSION
case|:
name|ikev1_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|length
argument_list|,
name|bp2
argument_list|,
operator|&
name|base
argument_list|)
expr_stmt|;
break|break;
case|case
name|IKEv2_MAJOR_VERSION
case|:
name|ikev2_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|length
argument_list|,
name|bp2
argument_list|,
operator|&
name|base
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|isakmp_rfc3948_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
name|length
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp2
parameter_list|)
block|{
if|if
condition|(
name|length
operator|==
literal|1
operator|&&
name|bp
index|[
literal|0
index|]
operator|==
literal|0xff
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"isakmp-nat-keep-alive"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|length
operator|<
literal|4
condition|)
block|{
goto|goto
name|trunc
goto|;
block|}
comment|/* 	 * see if this is an IKE packet 	 */
if|if
condition|(
name|bp
index|[
literal|0
index|]
operator|==
literal|0
operator|&&
name|bp
index|[
literal|1
index|]
operator|==
literal|0
operator|&&
name|bp
index|[
literal|2
index|]
operator|==
literal|0
operator|&&
name|bp
index|[
literal|3
index|]
operator|==
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"NONESP-encap: "
operator|)
argument_list|)
expr_stmt|;
name|isakmp_print
argument_list|(
name|ndo
argument_list|,
name|bp
operator|+
literal|4
argument_list|,
name|length
operator|-
literal|4
argument_list|,
name|bp2
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* must be an ESP packet */
block|{
name|int
name|nh
decl_stmt|,
name|enh
decl_stmt|,
name|padlen
decl_stmt|;
name|int
name|advance
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"UDP-encap: "
operator|)
argument_list|)
expr_stmt|;
name|advance
operator|=
name|esp_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|length
argument_list|,
name|bp2
argument_list|,
operator|&
name|enh
argument_list|,
operator|&
name|padlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<=
literal|0
condition|)
return|return;
name|bp
operator|+=
name|advance
expr_stmt|;
name|length
operator|-=
name|advance
operator|+
name|padlen
expr_stmt|;
name|nh
operator|=
name|enh
operator|&
literal|0xff
expr_stmt|;
name|ip_print_inner
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|length
argument_list|,
name|nh
argument_list|,
name|bp2
argument_list|)
expr_stmt|;
return|return;
block|}
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|isakmp]"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Local Variables:  * c-style: whitesmith  * c-basic-offset: 8  * End:  */
end_comment

end_unit


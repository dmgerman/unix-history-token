begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2001  *	Fortress Technologies, Inc.  All rights reserved.  *      Charlie Lenahan (clenahan@fortresstech.com)  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code distributions  * retain the above copyright notice and this paragraph in its entirety, (2)  * distributions including binary code include the above copyright notice and  * this paragraph in its entirety in the documentation or other materials  * provided with the distribution, and (3) all advertising materials mentioning  * features or use of this software display the following acknowledgement:  * ``This product includes software developed by the University of California,  * Lawrence Berkeley Laboratory and its contributors.'' Neither the name of  * the University nor the names of its contributors may be used to endorse  * or promote products derived from this software without specific prior  * written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-802_11.c,v 1.6 2001/09/17 21:57:53 fenner Exp $ (LBL)"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<pcap.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"ethertype.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11.h"
end_include

begin_define
define|#
directive|define
name|RATEStoBUF
parameter_list|(
name|p
parameter_list|,
name|buf
parameter_list|)
define|\
value|do { \ 	int z = 0; \ 	for (z = 0 ; z< p.rates.length ; z++) \ 		snprintf(buf, sizeof(buf), "%s %2.1f", buf, (.5 * (p.rates.rate[z]& 0x7f))); \ } while (0)
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|auth_alg_text
index|[]
init|=
block|{
literal|"Open System"
block|,
literal|"Shared Key"
block|,
literal|"EAP"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|subtype_text
index|[]
init|=
block|{
literal|"Assoc Request"
block|,
literal|"Assoc Response"
block|,
literal|"ReAssoc Request"
block|,
literal|"ReAssoc Response"
block|,
literal|"Probe Request"
block|,
literal|"Probe Response"
block|,
literal|"RESERVED"
block|,
literal|"RESERVED"
block|,
literal|"Beacon"
block|,
literal|"ATIM"
block|,
literal|"Disassociation"
block|,
literal|"Authentication"
block|,
literal|"DeAuthentication"
block|,
literal|"RESERVED"
block|,
literal|"RESERVED"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|status_text
index|[]
init|=
block|{
literal|"Succesful"
block|,
comment|/*  0  */
literal|"Unspecified failure"
block|,
comment|/*  1  */
literal|"Reserved"
block|,
comment|/*  2  */
literal|"Reserved"
block|,
comment|/*  3  */
literal|"Reserved"
block|,
comment|/*  4  */
literal|"Reserved"
block|,
comment|/*  5  */
literal|"Reserved"
block|,
comment|/*  6  */
literal|"Reserved"
block|,
comment|/*  7  */
literal|"Reserved"
block|,
comment|/*  8  */
literal|"Reserved"
block|,
comment|/*  9  */
literal|"Cannot Support all requested capabilities in the Capability Information field"
block|,
comment|/*  10  */
literal|"Reassociation denied due to inability to confirm that association exists"
block|,
comment|/*  11  */
literal|"Association denied due to reason outside the scope of the standard"
block|,
comment|/*  12  */
literal|"Responding station does not support the specified authentication algorithm "
block|,
comment|/*  13  */
literal|"Received an Authentication frame with authentication transaction "
expr|\
literal|"sequence number out of expected sequence"
block|,
comment|/*  14  */
literal|"Authentication rejected because of challenge failure"
block|,
comment|/*  15 */
literal|"Authentication rejected due to timeout waiting for next frame in sequence"
block|,
comment|/*  16 */
literal|"Association denied because AP is unable to handle additional associated stations"
block|,
comment|/*  17 */
literal|"Association denied due to requesting station not supporting all of the "
expr|\
literal|"data rates in BSSBasicRateSet parameter"
block|,
comment|/*  18 */
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|reason_text
index|[]
init|=
block|{
literal|"Reserved"
block|,
comment|/* 0 */
literal|"Unspecified reason"
block|,
comment|/* 1 */
literal|"Previous authentication no longer valid"
block|,
comment|/* 2 */
literal|"Deauthenticated because sending station is leaving (or has left) IBSS or ESS"
block|,
comment|/* 3 */
literal|"Disassociated due to inactivity"
block|,
comment|/* 4 */
literal|"Disassociated because AP is unable to handle all currently associated stations"
block|,
comment|/* 5 */
literal|"Class 2 frame receivedfrom nonauthenticated station"
block|,
comment|/* 6 */
literal|"Class 3 frame received from nonassociated station"
block|,
comment|/* 7 */
literal|"Disassociated because sending station is leaving (or has left) BSS"
block|,
comment|/* 8 */
literal|"Station requesting (re)association is not authenticated with responding station"
block|,
comment|/* 9 */
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|wep_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
name|u_int32_t
name|iv
decl_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
literal|4
argument_list|)
condition|)
return|return
literal|0
return|;
name|iv
operator|=
name|EXTRACT_LE_32BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Data IV:%3x Pad %x KeyID %x"
argument_list|,
name|IV_IV
argument_list|(
name|iv
argument_list|)
argument_list|,
name|IV_PAD
argument_list|(
name|iv
argument_list|)
argument_list|,
name|IV_KEYID
argument_list|(
name|iv
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_elements
parameter_list|(
name|struct
name|mgmt_body_t
modifier|*
name|pbody
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|offset
parameter_list|)
block|{
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|1
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
operator|==
literal|0xff
condition|)
break|break;
switch|switch
condition|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
condition|)
block|{
case|case
name|E_SSID
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|2
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
operator|(
name|pbody
operator|->
name|ssid
operator|)
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pbody
operator|->
name|ssid
operator|.
name|length
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
name|pbody
operator|->
name|ssid
operator|.
name|length
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
operator|(
name|pbody
operator|->
name|ssid
operator|.
name|ssid
operator|)
argument_list|,
name|p
operator|+
name|offset
argument_list|,
name|pbody
operator|->
name|ssid
operator|.
name|length
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|pbody
operator|->
name|ssid
operator|.
name|length
expr_stmt|;
name|pbody
operator|->
name|ssid
operator|.
name|ssid
index|[
name|pbody
operator|->
name|ssid
operator|.
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
break|break;
case|case
name|E_CHALLENGE
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|2
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
operator|(
name|pbody
operator|->
name|challenge
operator|)
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pbody
operator|->
name|challenge
operator|.
name|length
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
name|pbody
operator|->
name|challenge
operator|.
name|length
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
operator|(
name|pbody
operator|->
name|challenge
operator|.
name|text
operator|)
argument_list|,
name|p
operator|+
name|offset
argument_list|,
name|pbody
operator|->
name|challenge
operator|.
name|length
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|pbody
operator|->
name|challenge
operator|.
name|length
expr_stmt|;
name|pbody
operator|->
name|challenge
operator|.
name|text
index|[
name|pbody
operator|->
name|challenge
operator|.
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
break|break;
case|case
name|E_RATES
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|2
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
operator|(
name|pbody
operator|->
name|rates
operator|)
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pbody
operator|->
name|rates
operator|.
name|length
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
name|pbody
operator|->
name|rates
operator|.
name|length
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
operator|(
name|pbody
operator|->
name|rates
operator|.
name|rate
operator|)
argument_list|,
name|p
operator|+
name|offset
argument_list|,
name|pbody
operator|->
name|rates
operator|.
name|length
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|pbody
operator|->
name|rates
operator|.
name|length
expr_stmt|;
block|}
break|break;
case|case
name|E_DS
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|3
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
operator|(
name|pbody
operator|->
name|ds
operator|)
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|3
expr_stmt|;
break|break;
case|case
name|E_CF
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|8
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
operator|(
name|pbody
operator|->
name|cf
operator|)
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|8
expr_stmt|;
break|break;
case|case
name|E_TIM
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|2
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
operator|(
name|pbody
operator|->
name|tim
operator|)
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|3
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
operator|(
name|pbody
operator|->
name|tim
operator|.
name|count
operator|)
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
operator|(
name|pbody
operator|->
name|tim
operator|.
name|length
operator|-
literal|3
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
name|pbody
operator|->
name|tim
operator|.
name|length
operator|-
literal|3
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|(
name|pbody
operator|->
name|tim
operator|.
name|bitmap
operator|)
argument_list|,
name|p
operator|+
operator|(
name|pbody
operator|->
name|tim
operator|.
name|length
operator|-
literal|3
operator|)
argument_list|,
operator|(
name|pbody
operator|->
name|tim
operator|.
name|length
operator|-
literal|3
operator|)
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|pbody
operator|->
name|tim
operator|.
name|length
operator|-
literal|3
expr_stmt|;
block|}
break|break;
default|default:
if|#
directive|if
literal|0
block|printf("(1) unhandled element_id (%d)  ", *(p+offset) );
endif|#
directive|endif
name|offset
operator|+=
operator|*
operator|(
name|p
operator|+
name|offset
operator|+
literal|1
operator|)
operator|+
literal|2
expr_stmt|;
break|break;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*********************************************************************************  * Print Handle functions for the management frame types  *********************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|handle_beacon
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
literal|12
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|.
name|timestamp
argument_list|,
name|p
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|8
expr_stmt|;
name|pbody
operator|.
name|beacon_interval
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|pbody
operator|.
name|capability_info
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
name|RATEStoBUF
argument_list|(
name|pbody
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s (%s) [%s Mbit] %s CH: %x %s"
argument_list|,
name|subtype_text
index|[
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
index|]
argument_list|,
name|pbody
operator|.
name|ssid
operator|.
name|ssid
argument_list|,
name|buf
argument_list|,
name|CAPABILITY_ESS
argument_list|(
name|pbody
operator|.
name|capability_info
argument_list|)
condition|?
literal|"ESS"
else|:
literal|"IBSS"
argument_list|,
name|pbody
operator|.
name|ds
operator|.
name|channel
argument_list|,
name|CAPABILITY_PRIVACY
argument_list|(
name|pbody
operator|.
name|capability_info
argument_list|)
condition|?
literal|", PRIVACY"
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_assoc_request
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
literal|4
argument_list|)
condition|)
return|return
literal|0
return|;
name|pbody
operator|.
name|capability_info
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|pbody
operator|.
name|listen_interval
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
name|RATEStoBUF
argument_list|(
name|pbody
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s (%s) [%s Mbit] "
argument_list|,
name|subtype_text
index|[
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
index|]
argument_list|,
name|pbody
operator|.
name|ssid
operator|.
name|ssid
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_assoc_response
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
literal|6
argument_list|)
condition|)
return|return
literal|0
return|;
name|pbody
operator|.
name|capability_info
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|pbody
operator|.
name|status_code
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|pbody
operator|.
name|aid
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
name|printf
argument_list|(
literal|"%s AID(%x) :%s: %s   "
argument_list|,
name|subtype_text
index|[
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
index|]
argument_list|,
operator|(
call|(
name|u_int16_t
call|)
argument_list|(
name|pbody
operator|.
name|aid
operator|<<
literal|2
argument_list|)
operator|)
operator|>>
literal|2
argument_list|,
name|CAPABILITY_PRIVACY
argument_list|(
name|pbody
operator|.
name|capability_info
argument_list|)
condition|?
literal|" PRIVACY "
else|:
literal|""
argument_list|,
operator|(
name|pbody
operator|.
name|status_code
operator|<
literal|19
condition|?
name|status_text
index|[
name|pbody
operator|.
name|status_code
index|]
else|:
literal|"n/a"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_reassoc_request
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
literal|10
argument_list|)
condition|)
return|return
literal|0
return|;
name|pbody
operator|.
name|capability_info
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|pbody
operator|.
name|listen_interval
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|.
name|ap
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|6
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
name|printf
argument_list|(
literal|"%s (%s) AP : %s"
argument_list|,
name|subtype_text
index|[
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
index|]
argument_list|,
name|pbody
operator|.
name|ssid
operator|.
name|ssid
argument_list|,
name|etheraddr_string
argument_list|(
name|pbody
operator|.
name|ap
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_reassoc_response
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
comment|/* Same as a Association Reponse */
return|return
name|handle_assoc_response
argument_list|(
name|fc
argument_list|,
name|pmh
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_probe_request
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
name|RATEStoBUF
argument_list|(
name|pbody
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s (%s) [%s Mbit] "
argument_list|,
name|subtype_text
index|[
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
index|]
argument_list|,
name|pbody
operator|.
name|ssid
operator|.
name|ssid
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_probe_response
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
literal|12
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|.
name|timestamp
argument_list|,
name|p
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|8
expr_stmt|;
name|pbody
operator|.
name|beacon_interval
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|pbody
operator|.
name|capability_info
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
name|printf
argument_list|(
literal|"%s (%s) CH: %x %s"
argument_list|,
name|subtype_text
index|[
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
index|]
argument_list|,
name|pbody
operator|.
name|ssid
operator|.
name|ssid
argument_list|,
name|pbody
operator|.
name|ds
operator|.
name|channel
argument_list|,
name|CAPABILITY_PRIVACY
argument_list|(
name|pbody
operator|.
name|capability_info
argument_list|)
condition|?
literal|",PRIVACY "
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_atim
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
comment|/* the frame body for ATIM is null. */
name|printf
argument_list|(
literal|"ATIM"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_disassoc
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
literal|2
argument_list|)
condition|)
return|return
literal|0
return|;
name|pbody
operator|.
name|reason_code
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|printf
argument_list|(
literal|"%s: %s "
argument_list|,
name|subtype_text
index|[
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
index|]
argument_list|,
name|pbody
operator|.
name|reason_code
operator|<
literal|10
condition|?
name|reason_text
index|[
name|pbody
operator|.
name|reason_code
index|]
else|:
literal|"Reserved"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_auth
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
literal|6
argument_list|)
condition|)
return|return
literal|0
return|;
name|pbody
operator|.
name|auth_alg
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|pbody
operator|.
name|auth_trans_seq_num
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|pbody
operator|.
name|status_code
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|pbody
operator|.
name|auth_alg
operator|==
literal|1
operator|)
operator|&&
operator|(
operator|(
name|pbody
operator|.
name|auth_trans_seq_num
operator|==
literal|2
operator|)
operator|||
operator|(
name|pbody
operator|.
name|auth_trans_seq_num
operator|==
literal|3
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s (%s)-%x [Challenge Text] %s"
argument_list|,
name|subtype_text
index|[
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
index|]
argument_list|,
name|pbody
operator|.
name|auth_alg
operator|<
literal|4
condition|?
name|auth_alg_text
index|[
name|pbody
operator|.
name|auth_alg
index|]
else|:
literal|"Reserved"
argument_list|,
name|pbody
operator|.
name|auth_trans_seq_num
argument_list|,
operator|(
operator|(
name|pbody
operator|.
name|auth_trans_seq_num
operator|%
literal|2
operator|)
condition|?
operator|(
name|pbody
operator|.
name|status_code
operator|<
literal|19
condition|?
name|status_text
index|[
name|pbody
operator|.
name|status_code
index|]
else|:
literal|"n/a"
operator|)
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s (%s)-%x: %s"
argument_list|,
name|subtype_text
index|[
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
index|]
argument_list|,
name|pbody
operator|.
name|auth_alg
operator|<
literal|4
condition|?
name|auth_alg_text
index|[
name|pbody
operator|.
name|auth_alg
index|]
else|:
literal|"Reserved"
argument_list|,
name|pbody
operator|.
name|auth_trans_seq_num
argument_list|,
operator|(
operator|(
name|pbody
operator|.
name|auth_trans_seq_num
operator|%
literal|2
operator|)
condition|?
operator|(
name|pbody
operator|.
name|status_code
operator|<
literal|19
condition|?
name|status_text
index|[
name|pbody
operator|.
name|status_code
index|]
else|:
literal|"n/a"
operator|)
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_deauth
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
literal|2
argument_list|)
condition|)
return|return
literal|0
return|;
name|pbody
operator|.
name|reason_code
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|eflag
condition|)
block|{
name|printf
argument_list|(
literal|"%s: %s"
argument_list|,
name|subtype_text
index|[
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
index|]
argument_list|,
name|pbody
operator|.
name|reason_code
operator|<
literal|10
condition|?
name|reason_text
index|[
name|pbody
operator|.
name|reason_code
index|]
else|:
literal|"Reserved"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s (%s): %s"
argument_list|,
name|subtype_text
index|[
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
index|]
argument_list|,
name|etheraddr_string
argument_list|(
name|pmh
operator|->
name|sa
argument_list|)
argument_list|,
name|pbody
operator|.
name|reason_code
operator|<
literal|10
condition|?
name|reason_text
index|[
name|pbody
operator|.
name|reason_code
index|]
else|:
literal|"Reserved"
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*********************************************************************************  * Print Body funcs  *********************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|mgmt_body_print
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
switch|switch
condition|(
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|ST_ASSOC_REQUEST
case|:
return|return
operator|(
name|handle_assoc_request
argument_list|(
name|fc
argument_list|,
name|pmh
argument_list|,
name|p
argument_list|)
operator|)
return|;
case|case
name|ST_ASSOC_RESPONSE
case|:
return|return
operator|(
name|handle_assoc_response
argument_list|(
name|fc
argument_list|,
name|pmh
argument_list|,
name|p
argument_list|)
operator|)
return|;
case|case
name|ST_REASSOC_REQUEST
case|:
return|return
operator|(
name|handle_reassoc_request
argument_list|(
name|fc
argument_list|,
name|pmh
argument_list|,
name|p
argument_list|)
operator|)
return|;
case|case
name|ST_REASSOC_RESPONSE
case|:
return|return
operator|(
name|handle_reassoc_response
argument_list|(
name|fc
argument_list|,
name|pmh
argument_list|,
name|p
argument_list|)
operator|)
return|;
case|case
name|ST_PROBE_REQUEST
case|:
return|return
operator|(
name|handle_probe_request
argument_list|(
name|fc
argument_list|,
name|pmh
argument_list|,
name|p
argument_list|)
operator|)
return|;
case|case
name|ST_PROBE_RESPONSE
case|:
return|return
operator|(
name|handle_probe_response
argument_list|(
name|fc
argument_list|,
name|pmh
argument_list|,
name|p
argument_list|)
operator|)
return|;
case|case
name|ST_BEACON
case|:
return|return
operator|(
name|handle_beacon
argument_list|(
name|fc
argument_list|,
name|pmh
argument_list|,
name|p
argument_list|)
operator|)
return|;
case|case
name|ST_ATIM
case|:
return|return
operator|(
name|handle_atim
argument_list|(
name|fc
argument_list|,
name|pmh
argument_list|,
name|p
argument_list|)
operator|)
return|;
case|case
name|ST_DISASSOC
case|:
return|return
operator|(
name|handle_disassoc
argument_list|(
name|fc
argument_list|,
name|pmh
argument_list|,
name|p
argument_list|)
operator|)
return|;
case|case
name|ST_AUTH
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
literal|3
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|p
index|[
literal|0
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|p
index|[
literal|1
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|p
index|[
literal|2
index|]
operator|==
literal|0
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Authentication (Shared-Key)-3 "
argument_list|)
expr_stmt|;
return|return
operator|(
name|wep_print
argument_list|(
name|p
argument_list|,
name|length
argument_list|)
operator|)
return|;
block|}
else|else
return|return
operator|(
name|handle_auth
argument_list|(
name|fc
argument_list|,
name|pmh
argument_list|,
name|p
argument_list|)
operator|)
return|;
case|case
name|ST_DEAUTH
case|:
return|return
operator|(
name|handle_deauth
argument_list|(
name|fc
argument_list|,
name|pmh
argument_list|,
name|p
argument_list|)
operator|)
return|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unhandled Managment subtype(%x)"
argument_list|,
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
end_function

begin_comment
comment|/*********************************************************************************  * Handles printing all the control frame types  *********************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|ctrl_body_print
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
switch|switch
condition|(
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|CTRL_PS_POLL
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|CTRL_PS_POLL_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
name|printf
argument_list|(
literal|"Power Save-Poll AID(%x)"
argument_list|,
name|EXTRACT_LE_16BITS
argument_list|(
operator|&
operator|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_ps_poll_t
operator|*
operator|)
name|p
operator|)
operator|->
name|aid
operator|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_RTS
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|CTRL_RTS_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|"Request-To-Send"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Request-To-Send TA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_rts_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ta
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_CTS
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|CTRL_CTS_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|"Clear-To-Send"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Clear-To-Send RA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_cts_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_ACK
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|CTRL_ACK_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|"Acknowledgment"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Acknowledgment RA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_ack_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_CF_END
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|CTRL_END_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|"CF-End"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"CF-End RA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_end_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_END_ACK
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|CTRL_END_ACK_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|"CF-End+CF-Ack"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"CF-End+CF-Ack RA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_end_ack_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"(B) Unknown Ctrl Subtype"
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Print Header funcs  */
end_comment

begin_comment
comment|/*  *  Data Frame - Address field contents  *  *  To Ds  | From DS | Addr 1 | Addr 2 | Addr 3 | Addr 4  *    0    |  0      |  DA    | SA     | BSSID  | n/a  *    0    |  1      |  DA    | BSSID  | SA     | n/a  *    1    |  0      |  BSSID | SA     | DA     | n/a  *    1    |  1      |  RA    | TA     | DA     | SA  */
end_comment

begin_function
specifier|static
name|void
name|data_header_print
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
define|#
directive|define
name|ADDR1
value|(p + 4)
define|#
directive|define
name|ADDR2
value|(p + 10)
define|#
directive|define
name|ADDR3
value|(p + 16)
define|#
directive|define
name|ADDR4
value|(p + 24)
if|if
condition|(
operator|!
name|FC_TO_DS
argument_list|(
name|fc
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|FC_FROM_DS
argument_list|(
name|fc
argument_list|)
condition|)
name|printf
argument_list|(
literal|"DA:%s SA:%s BSSID:%s "
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR1
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR2
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR3
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"DA:%s BSSID:%s SA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR1
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR2
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR3
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|FC_FROM_DS
argument_list|(
name|fc
argument_list|)
condition|)
name|printf
argument_list|(
literal|"BSSID:%s SA:%s DA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR1
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR2
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR3
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"RA:%s TA:%s DA:%s SA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR1
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR2
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR3
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR4
argument_list|)
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|ADDR1
undef|#
directive|undef
name|ADDR2
undef|#
directive|undef
name|ADDR3
undef|#
directive|undef
name|ADDR4
block|}
end_function

begin_function
specifier|static
name|void
name|mgmt_header_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|hp
init|=
operator|(
specifier|const
expr|struct
name|mgmt_header_t
operator|*
operator|)
name|p
decl_stmt|;
name|printf
argument_list|(
literal|"BSSID:%s DA:%s SA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
name|hp
operator|)
operator|->
name|bssid
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
name|hp
operator|)
operator|->
name|da
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
name|hp
operator|)
operator|->
name|sa
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctrl_header_print
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
switch|switch
condition|(
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|CTRL_PS_POLL
case|:
name|printf
argument_list|(
literal|"BSSID:%s TA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_ps_poll_t
operator|*
operator|)
name|p
operator|)
operator|->
name|bssid
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_ps_poll_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ta
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_RTS
case|:
name|printf
argument_list|(
literal|"RA:%s TA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_rts_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_rts_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ta
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_CTS
case|:
name|printf
argument_list|(
literal|"RA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_cts_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_ACK
case|:
name|printf
argument_list|(
literal|"RA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_ack_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_CF_END
case|:
name|printf
argument_list|(
literal|"RA:%s BSSID:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_end_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_end_t
operator|*
operator|)
name|p
operator|)
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_END_ACK
case|:
name|printf
argument_list|(
literal|"RA:%s BSSID:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_end_ack_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_end_ack_t
operator|*
operator|)
name|p
operator|)
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"(H) Unknown Ctrl Subtype"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|GetHeaderLength
parameter_list|(
name|u_int16_t
name|fc
parameter_list|)
block|{
name|int
name|iLength
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|FC_TYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|T_MGMT
case|:
name|iLength
operator|=
name|MGMT_HEADER_LEN
expr_stmt|;
break|break;
case|case
name|T_CTRL
case|:
switch|switch
condition|(
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|CTRL_PS_POLL
case|:
name|iLength
operator|=
name|CTRL_PS_POLL_LEN
expr_stmt|;
break|break;
case|case
name|CTRL_RTS
case|:
name|iLength
operator|=
name|CTRL_RTS_LEN
expr_stmt|;
break|break;
case|case
name|CTRL_CTS
case|:
name|iLength
operator|=
name|CTRL_CTS_LEN
expr_stmt|;
break|break;
case|case
name|CTRL_ACK
case|:
name|iLength
operator|=
name|CTRL_ACK_LEN
expr_stmt|;
break|break;
case|case
name|CTRL_CF_END
case|:
name|iLength
operator|=
name|CTRL_END_LEN
expr_stmt|;
break|break;
case|case
name|CTRL_END_ACK
case|:
name|iLength
operator|=
name|CTRL_END_ACK_LEN
expr_stmt|;
break|break;
default|default:
name|iLength
operator|=
literal|0
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|T_DATA
case|:
if|if
condition|(
name|FC_TO_DS
argument_list|(
name|fc
argument_list|)
operator|&&
name|FC_FROM_DS
argument_list|(
name|fc
argument_list|)
condition|)
name|iLength
operator|=
literal|30
expr_stmt|;
else|else
name|iLength
operator|=
literal|24
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown IEEE802.11 frame type (%d)"
argument_list|,
name|FC_TYPE
argument_list|(
name|fc
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|iLength
return|;
block|}
end_function

begin_comment
comment|/*  * Print the 802.11 MAC header  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|ieee_802_11_print
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
switch|switch
condition|(
name|FC_TYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|T_MGMT
case|:
name|mgmt_header_print
argument_list|(
name|p
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_CTRL
case|:
name|ctrl_header_print
argument_list|(
name|fc
argument_list|,
name|p
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_DATA
case|:
name|data_header_print
argument_list|(
name|fc
argument_list|,
name|p
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"(header) unknown IEEE802.11 frame type (%d)"
argument_list|,
name|FC_TYPE
argument_list|(
name|fc
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * This is the top level routine of the printer.  'p' is the points  * to the ether header of the packet, 'h->tv' is the timestamp,  * 'h->length' is the length of the packet off the wire, and 'h->caplen'  * is the number of bytes actually captured.  */
end_comment

begin_function
name|void
name|ieee802_11_if_print
parameter_list|(
name|u_char
modifier|*
name|user
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|u_int
name|caplen
init|=
name|h
operator|->
name|caplen
decl_stmt|;
name|u_int
name|length
init|=
name|h
operator|->
name|len
decl_stmt|;
name|u_int16_t
name|fc
decl_stmt|;
name|u_int
name|HEADER_LENGTH
decl_stmt|;
name|u_short
name|extracted_ethertype
decl_stmt|;
operator|++
name|infodelay
expr_stmt|;
name|ts_print
argument_list|(
operator|&
name|h
operator|->
name|ts
argument_list|)
expr_stmt|;
if|if
condition|(
name|caplen
operator|<
name|IEEE802_11_FC_LEN
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|fc
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|eflag
condition|)
name|ieee_802_11_print
argument_list|(
name|fc
argument_list|,
name|p
argument_list|,
name|length
argument_list|)
expr_stmt|;
comment|/* 	 * Some printers want to get back at the ethernet addresses, 	 * and/or check that they're not walking off the end of the packet. 	 * Rather than pass them all the way down, we set these globals. 	 */
name|packetp
operator|=
name|p
expr_stmt|;
name|snapend
operator|=
name|p
operator|+
name|caplen
expr_stmt|;
name|HEADER_LENGTH
operator|=
name|GetHeaderLength
argument_list|(
name|fc
argument_list|)
expr_stmt|;
name|length
operator|-=
name|HEADER_LENGTH
expr_stmt|;
name|caplen
operator|-=
name|HEADER_LENGTH
expr_stmt|;
name|p
operator|+=
name|HEADER_LENGTH
expr_stmt|;
switch|switch
condition|(
name|FC_TYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|T_MGMT
case|:
if|if
condition|(
operator|!
name|mgmt_body_print
argument_list|(
name|fc
argument_list|,
operator|(
specifier|const
expr|struct
name|mgmt_header_t
operator|*
operator|)
name|packetp
argument_list|,
name|p
argument_list|,
name|length
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
break|break;
case|case
name|T_CTRL
case|:
if|if
condition|(
operator|!
name|ctrl_body_print
argument_list|(
name|fc
argument_list|,
name|p
operator|-
name|HEADER_LENGTH
argument_list|,
name|length
operator|+
name|HEADER_LENGTH
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
break|break;
case|case
name|T_DATA
case|:
comment|/* There may be a problem w/ AP not having this bit set */
if|if
condition|(
name|FC_WEP
argument_list|(
name|fc
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wep_print
argument_list|(
name|p
argument_list|,
name|length
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|llc_print
argument_list|(
name|p
argument_list|,
name|length
argument_list|,
name|caplen
argument_list|,
name|packetp
operator|+
literal|10
argument_list|,
name|packetp
operator|+
literal|4
argument_list|,
operator|&
name|extracted_ethertype
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 				 * Some kinds of LLC packet we cannot 				 * handle intelligently 				 */
if|if
condition|(
operator|!
name|eflag
condition|)
name|ieee_802_11_print
argument_list|(
name|fc
argument_list|,
name|p
operator|-
name|HEADER_LENGTH
argument_list|,
name|length
operator|+
name|HEADER_LENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|extracted_ethertype
condition|)
block|{
name|printf
argument_list|(
literal|"(LLC %s) "
argument_list|,
name|etherproto_string
argument_list|(
name|htons
argument_list|(
name|extracted_ethertype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|xflag
operator|&&
operator|!
name|qflag
condition|)
name|default_print
argument_list|(
name|p
argument_list|,
name|caplen
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
default|default:
name|printf
argument_list|(
literal|"(body) unhandled IEEE802.11 frame type (%d)"
argument_list|,
name|FC_TYPE
argument_list|(
name|fc
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|xflag
condition|)
name|default_print
argument_list|(
name|p
argument_list|,
name|caplen
argument_list|)
expr_stmt|;
name|out
label|:
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
operator|--
name|infodelay
expr_stmt|;
if|if
condition|(
name|infoprint
condition|)
name|info
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


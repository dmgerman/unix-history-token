begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2001  *	Fortress Technologies, Inc.  All rights reserved.  *      Charlie Lenahan (clenahan@fortresstech.com)  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code distributions  * retain the above copyright notice and this paragraph in its entirety, (2)  * distributions including binary code include the above copyright notice and  * this paragraph in its entirety in the documentation or other materials  * provided with the distribution, and (3) all advertising materials mentioning  * features or use of this software display the following acknowledgement:  * ``This product includes software developed by the University of California,  * Lawrence Berkeley Laboratory and its contributors.'' Neither the name of  * the University nor the names of its contributors may be used to endorse  * or promote products derived from this software without specific prior  * written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
name|_U_
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-802_11.c,v 1.31.2.1 2005/04/20 19:32:41 guy Exp $ (LBL)"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<pcap.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"ethertype.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"cpack.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_radio.h"
end_include

begin_define
define|#
directive|define
name|PRINT_RATE
parameter_list|(
name|_sep
parameter_list|,
name|_r
parameter_list|,
name|_suf
parameter_list|)
define|\
value|printf("%s%2.1f%s", _sep, (.5 * ((_r)& 0x7f)), _suf)
end_define

begin_define
define|#
directive|define
name|PRINT_RATES
parameter_list|(
name|p
parameter_list|)
define|\
value|do { \ 	int z; \ 	const char *sep = " ["; \ 	for (z = 0; z< p.rates.length ; z++) { \ 		PRINT_RATE(sep, p.rates.rate[z], \ 			(p.rates.rate[z]& 0x80 ? "*" : "")); \ 		sep = " "; \ 	} \ 	if (p.rates.length != 0) \ 		printf(" Mbit]"); \ } while (0)
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|auth_alg_text
index|[]
init|=
block|{
literal|"Open System"
block|,
literal|"Shared Key"
block|,
literal|"EAP"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|subtype_text
index|[]
init|=
block|{
literal|"Assoc Request"
block|,
literal|"Assoc Response"
block|,
literal|"ReAssoc Request"
block|,
literal|"ReAssoc Response"
block|,
literal|"Probe Request"
block|,
literal|"Probe Response"
block|,
literal|""
block|,
literal|""
block|,
literal|"Beacon"
block|,
literal|"ATIM"
block|,
literal|"Disassociation"
block|,
literal|"Authentication"
block|,
literal|"DeAuthentication"
block|,
literal|""
block|,
literal|""
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|status_text
index|[]
init|=
block|{
literal|"Succesful"
block|,
comment|/*  0  */
literal|"Unspecified failure"
block|,
comment|/*  1  */
literal|"Reserved"
block|,
comment|/*  2  */
literal|"Reserved"
block|,
comment|/*  3  */
literal|"Reserved"
block|,
comment|/*  4  */
literal|"Reserved"
block|,
comment|/*  5  */
literal|"Reserved"
block|,
comment|/*  6  */
literal|"Reserved"
block|,
comment|/*  7  */
literal|"Reserved"
block|,
comment|/*  8  */
literal|"Reserved"
block|,
comment|/*  9  */
literal|"Cannot Support all requested capabilities in the Capability Information field"
block|,
comment|/*  10  */
literal|"Reassociation denied due to inability to confirm that association exists"
block|,
comment|/*  11  */
literal|"Association denied due to reason outside the scope of the standard"
block|,
comment|/*  12  */
literal|"Responding station does not support the specified authentication algorithm "
block|,
comment|/*  13  */
literal|"Received an Authentication frame with authentication transaction "
expr|\
literal|"sequence number out of expected sequence"
block|,
comment|/*  14  */
literal|"Authentication rejected because of challenge failure"
block|,
comment|/*  15 */
literal|"Authentication rejected due to timeout waiting for next frame in sequence"
block|,
comment|/*  16 */
literal|"Association denied because AP is unable to handle additional associated stations"
block|,
comment|/*  17 */
literal|"Association denied due to requesting station not supporting all of the "
expr|\
literal|"data rates in BSSBasicRateSet parameter"
block|,
comment|/*  18 */
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|reason_text
index|[]
init|=
block|{
literal|"Reserved"
block|,
comment|/* 0 */
literal|"Unspecified reason"
block|,
comment|/* 1 */
literal|"Previous authentication no longer valid"
block|,
comment|/* 2 */
literal|"Deauthenticated because sending station is leaving (or has left) IBSS or ESS"
block|,
comment|/* 3 */
literal|"Disassociated due to inactivity"
block|,
comment|/* 4 */
literal|"Disassociated because AP is unable to handle all currently associated stations"
block|,
comment|/* 5 */
literal|"Class 2 frame receivedfrom nonauthenticated station"
block|,
comment|/* 6 */
literal|"Class 3 frame received from nonassociated station"
block|,
comment|/* 7 */
literal|"Disassociated because sending station is leaving (or has left) BSS"
block|,
comment|/* 8 */
literal|"Station requesting (re)association is not authenticated with responding station"
block|,
comment|/* 9 */
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|wep_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|u_int32_t
name|iv
decl_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|IEEE802_11_IV_LEN
operator|+
name|IEEE802_11_KID_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
name|iv
operator|=
name|EXTRACT_LE_32BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Data IV:%3x Pad %x KeyID %x"
argument_list|,
name|IV_IV
argument_list|(
name|iv
argument_list|)
argument_list|,
name|IV_PAD
argument_list|(
name|iv
argument_list|)
argument_list|,
name|IV_KEYID
argument_list|(
name|iv
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_elements
parameter_list|(
name|struct
name|mgmt_body_t
modifier|*
name|pbody
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|int
name|offset
parameter_list|)
block|{
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|1
argument_list|)
condition|)
return|return
literal|1
return|;
switch|switch
condition|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
condition|)
block|{
case|case
name|E_SSID
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|2
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|->
name|ssid
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pbody
operator|->
name|ssid
operator|.
name|length
operator|<=
literal|0
condition|)
break|break;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
name|pbody
operator|->
name|ssid
operator|.
name|length
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|->
name|ssid
operator|.
name|ssid
argument_list|,
name|p
operator|+
name|offset
argument_list|,
name|pbody
operator|->
name|ssid
operator|.
name|length
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|pbody
operator|->
name|ssid
operator|.
name|length
expr_stmt|;
name|pbody
operator|->
name|ssid
operator|.
name|ssid
index|[
name|pbody
operator|->
name|ssid
operator|.
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
name|E_CHALLENGE
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|2
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|->
name|challenge
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pbody
operator|->
name|challenge
operator|.
name|length
operator|<=
literal|0
condition|)
break|break;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
name|pbody
operator|->
name|challenge
operator|.
name|length
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|->
name|challenge
operator|.
name|text
argument_list|,
name|p
operator|+
name|offset
argument_list|,
name|pbody
operator|->
name|challenge
operator|.
name|length
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|pbody
operator|->
name|challenge
operator|.
name|length
expr_stmt|;
name|pbody
operator|->
name|challenge
operator|.
name|text
index|[
name|pbody
operator|->
name|challenge
operator|.
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
name|E_RATES
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|2
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
operator|(
name|pbody
operator|->
name|rates
operator|)
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pbody
operator|->
name|rates
operator|.
name|length
operator|<=
literal|0
condition|)
break|break;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
name|pbody
operator|->
name|rates
operator|.
name|length
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|->
name|rates
operator|.
name|rate
argument_list|,
name|p
operator|+
name|offset
argument_list|,
name|pbody
operator|->
name|rates
operator|.
name|length
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|pbody
operator|->
name|rates
operator|.
name|length
expr_stmt|;
break|break;
case|case
name|E_DS
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|3
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|->
name|ds
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|3
expr_stmt|;
break|break;
case|case
name|E_CF
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|8
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|->
name|cf
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|8
expr_stmt|;
break|break;
case|case
name|E_TIM
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|2
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|->
name|tim
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
literal|3
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|->
name|tim
operator|.
name|count
argument_list|,
name|p
operator|+
name|offset
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
name|pbody
operator|->
name|tim
operator|.
name|length
operator|<=
literal|3
condition|)
break|break;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
operator|(
name|p
operator|+
name|offset
operator|)
argument_list|,
name|pbody
operator|->
name|tim
operator|.
name|length
operator|-
literal|3
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
name|pbody
operator|->
name|tim
operator|.
name|bitmap
argument_list|,
name|p
operator|+
operator|(
name|pbody
operator|->
name|tim
operator|.
name|length
operator|-
literal|3
operator|)
argument_list|,
operator|(
name|pbody
operator|->
name|tim
operator|.
name|length
operator|-
literal|3
operator|)
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|pbody
operator|->
name|tim
operator|.
name|length
operator|-
literal|3
expr_stmt|;
break|break;
default|default:
if|#
directive|if
literal|0
block|printf("(1) unhandled element_id (%d)  ", 			    *(p + offset) );
endif|#
directive|endif
name|offset
operator|+=
operator|*
operator|(
name|p
operator|+
name|offset
operator|+
literal|1
operator|)
operator|+
literal|2
expr_stmt|;
break|break;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*********************************************************************************  * Print Handle functions for the management frame types  *********************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|handle_beacon
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|IEEE802_11_TSTAMP_LEN
operator|+
name|IEEE802_11_BCNINT_LEN
operator|+
name|IEEE802_11_CAPINFO_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|.
name|timestamp
argument_list|,
name|p
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_TSTAMP_LEN
expr_stmt|;
name|pbody
operator|.
name|beacon_interval
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_BCNINT_LEN
expr_stmt|;
name|pbody
operator|.
name|capability_info
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_CAPINFO_LEN
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
name|printf
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
name|fn_print
argument_list|(
name|pbody
operator|.
name|ssid
operator|.
name|ssid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
name|PRINT_RATES
argument_list|(
name|pbody
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s CH: %u%s"
argument_list|,
name|CAPABILITY_ESS
argument_list|(
name|pbody
operator|.
name|capability_info
argument_list|)
condition|?
literal|"ESS"
else|:
literal|"IBSS"
argument_list|,
name|pbody
operator|.
name|ds
operator|.
name|channel
argument_list|,
name|CAPABILITY_PRIVACY
argument_list|(
name|pbody
operator|.
name|capability_info
argument_list|)
condition|?
literal|", PRIVACY"
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_assoc_request
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|IEEE802_11_CAPINFO_LEN
operator|+
name|IEEE802_11_LISTENINT_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
name|pbody
operator|.
name|capability_info
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_CAPINFO_LEN
expr_stmt|;
name|pbody
operator|.
name|listen_interval
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_LISTENINT_LEN
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
name|printf
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
name|fn_print
argument_list|(
name|pbody
operator|.
name|ssid
operator|.
name|ssid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
name|PRINT_RATES
argument_list|(
name|pbody
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_assoc_response
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|IEEE802_11_CAPINFO_LEN
operator|+
name|IEEE802_11_STATUS_LEN
operator|+
name|IEEE802_11_AID_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
name|pbody
operator|.
name|capability_info
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_CAPINFO_LEN
expr_stmt|;
name|pbody
operator|.
name|status_code
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_STATUS_LEN
expr_stmt|;
name|pbody
operator|.
name|aid
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_AID_LEN
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
name|printf
argument_list|(
literal|" AID(%x) :%s: %s"
argument_list|,
operator|(
call|(
name|u_int16_t
call|)
argument_list|(
name|pbody
operator|.
name|aid
operator|<<
literal|2
argument_list|)
operator|)
operator|>>
literal|2
argument_list|,
name|CAPABILITY_PRIVACY
argument_list|(
name|pbody
operator|.
name|capability_info
argument_list|)
condition|?
literal|" PRIVACY "
else|:
literal|""
argument_list|,
operator|(
name|pbody
operator|.
name|status_code
operator|<
literal|19
condition|?
name|status_text
index|[
name|pbody
operator|.
name|status_code
index|]
else|:
literal|"n/a"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_reassoc_request
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|IEEE802_11_CAPINFO_LEN
operator|+
name|IEEE802_11_LISTENINT_LEN
operator|+
name|IEEE802_11_AP_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
name|pbody
operator|.
name|capability_info
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_CAPINFO_LEN
expr_stmt|;
name|pbody
operator|.
name|listen_interval
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_LISTENINT_LEN
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|.
name|ap
argument_list|,
name|p
operator|+
name|offset
argument_list|,
name|IEEE802_11_AP_LEN
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_AP_LEN
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
name|printf
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
name|fn_print
argument_list|(
name|pbody
operator|.
name|ssid
operator|.
name|ssid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|") AP : %s"
argument_list|,
name|etheraddr_string
argument_list|(
name|pbody
operator|.
name|ap
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_reassoc_response
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
comment|/* Same as a Association Reponse */
return|return
name|handle_assoc_response
argument_list|(
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_probe_request
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
name|printf
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
name|fn_print
argument_list|(
name|pbody
operator|.
name|ssid
operator|.
name|ssid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
name|PRINT_RATES
argument_list|(
name|pbody
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_probe_response
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|IEEE802_11_TSTAMP_LEN
operator|+
name|IEEE802_11_BCNINT_LEN
operator|+
name|IEEE802_11_CAPINFO_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|&
name|pbody
operator|.
name|timestamp
argument_list|,
name|p
argument_list|,
name|IEEE802_11_TSTAMP_LEN
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_TSTAMP_LEN
expr_stmt|;
name|pbody
operator|.
name|beacon_interval
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_BCNINT_LEN
expr_stmt|;
name|pbody
operator|.
name|capability_info
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_CAPINFO_LEN
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
name|printf
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
name|fn_print
argument_list|(
name|pbody
operator|.
name|ssid
operator|.
name|ssid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|") "
argument_list|)
expr_stmt|;
name|PRINT_RATES
argument_list|(
name|pbody
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" CH: %u%s"
argument_list|,
name|pbody
operator|.
name|ds
operator|.
name|channel
argument_list|,
name|CAPABILITY_PRIVACY
argument_list|(
name|pbody
operator|.
name|capability_info
argument_list|)
condition|?
literal|", PRIVACY"
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_atim
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* the frame body for ATIM is null. */
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_disassoc
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|IEEE802_11_REASON_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
name|pbody
operator|.
name|reason_code
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|": %s"
argument_list|,
operator|(
name|pbody
operator|.
name|reason_code
operator|<
literal|10
operator|)
condition|?
name|reason_text
index|[
name|pbody
operator|.
name|reason_code
index|]
else|:
literal|"Reserved"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_auth
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
literal|6
argument_list|)
condition|)
return|return
literal|0
return|;
name|pbody
operator|.
name|auth_alg
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|pbody
operator|.
name|auth_trans_seq_num
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|pbody
operator|.
name|status_code
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|parse_elements
argument_list|(
operator|&
name|pbody
argument_list|,
name|p
argument_list|,
name|offset
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|pbody
operator|.
name|auth_alg
operator|==
literal|1
operator|)
operator|&&
operator|(
operator|(
name|pbody
operator|.
name|auth_trans_seq_num
operator|==
literal|2
operator|)
operator|||
operator|(
name|pbody
operator|.
name|auth_trans_seq_num
operator|==
literal|3
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|" (%s)-%x [Challenge Text] %s"
argument_list|,
operator|(
name|pbody
operator|.
name|auth_alg
operator|<
literal|4
operator|)
condition|?
name|auth_alg_text
index|[
name|pbody
operator|.
name|auth_alg
index|]
else|:
literal|"Reserved"
argument_list|,
name|pbody
operator|.
name|auth_trans_seq_num
argument_list|,
operator|(
operator|(
name|pbody
operator|.
name|auth_trans_seq_num
operator|%
literal|2
operator|)
condition|?
operator|(
operator|(
name|pbody
operator|.
name|status_code
operator|<
literal|19
operator|)
condition|?
name|status_text
index|[
name|pbody
operator|.
name|status_code
index|]
else|:
literal|"n/a"
operator|)
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|printf
argument_list|(
literal|" (%s)-%x: %s"
argument_list|,
operator|(
name|pbody
operator|.
name|auth_alg
operator|<
literal|4
operator|)
condition|?
name|auth_alg_text
index|[
name|pbody
operator|.
name|auth_alg
index|]
else|:
literal|"Reserved"
argument_list|,
name|pbody
operator|.
name|auth_trans_seq_num
argument_list|,
operator|(
name|pbody
operator|.
name|auth_trans_seq_num
operator|%
literal|2
operator|)
condition|?
operator|(
operator|(
name|pbody
operator|.
name|status_code
operator|<
literal|19
operator|)
condition|?
name|status_text
index|[
name|pbody
operator|.
name|status_code
index|]
else|:
literal|"n/a"
operator|)
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_deauth
parameter_list|(
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mgmt_body_t
name|pbody
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|reason
init|=
name|NULL
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pbody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pbody
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|IEEE802_11_REASON_LEN
argument_list|)
condition|)
return|return
literal|0
return|;
name|pbody
operator|.
name|reason_code
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|IEEE802_11_REASON_LEN
expr_stmt|;
name|reason
operator|=
operator|(
name|pbody
operator|.
name|reason_code
operator|<
literal|10
operator|)
condition|?
name|reason_text
index|[
name|pbody
operator|.
name|reason_code
index|]
else|:
literal|"Reserved"
expr_stmt|;
if|if
condition|(
name|eflag
condition|)
block|{
name|printf
argument_list|(
literal|": %s"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" (%s): %s"
argument_list|,
name|etheraddr_string
argument_list|(
name|pmh
operator|->
name|sa
argument_list|)
argument_list|,
name|reason
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*********************************************************************************  * Print Body funcs  *********************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|mgmt_body_print
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|pmh
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|subtype_text
index|[
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|ST_ASSOC_REQUEST
case|:
return|return
name|handle_assoc_request
argument_list|(
name|p
argument_list|)
return|;
case|case
name|ST_ASSOC_RESPONSE
case|:
return|return
name|handle_assoc_response
argument_list|(
name|p
argument_list|)
return|;
case|case
name|ST_REASSOC_REQUEST
case|:
return|return
name|handle_reassoc_request
argument_list|(
name|p
argument_list|)
return|;
case|case
name|ST_REASSOC_RESPONSE
case|:
return|return
name|handle_reassoc_response
argument_list|(
name|p
argument_list|)
return|;
case|case
name|ST_PROBE_REQUEST
case|:
return|return
name|handle_probe_request
argument_list|(
name|p
argument_list|)
return|;
case|case
name|ST_PROBE_RESPONSE
case|:
return|return
name|handle_probe_response
argument_list|(
name|p
argument_list|)
return|;
case|case
name|ST_BEACON
case|:
return|return
name|handle_beacon
argument_list|(
name|p
argument_list|)
return|;
case|case
name|ST_ATIM
case|:
return|return
name|handle_atim
argument_list|()
return|;
case|case
name|ST_DISASSOC
case|:
return|return
name|handle_disassoc
argument_list|(
name|p
argument_list|)
return|;
case|case
name|ST_AUTH
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
literal|3
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|p
index|[
literal|0
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|p
index|[
literal|1
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|p
index|[
literal|2
index|]
operator|==
literal|0
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Authentication (Shared-Key)-3 "
argument_list|)
expr_stmt|;
return|return
name|wep_print
argument_list|(
name|p
argument_list|)
return|;
block|}
return|return
name|handle_auth
argument_list|(
name|p
argument_list|)
return|;
case|case
name|ST_DEAUTH
case|:
return|return
name|handle_deauth
argument_list|(
name|pmh
argument_list|,
name|p
argument_list|)
return|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unhandled Management subtype(%x)"
argument_list|,
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
end_function

begin_comment
comment|/*********************************************************************************  * Handles printing all the control frame types  *********************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|ctrl_body_print
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
switch|switch
condition|(
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|CTRL_PS_POLL
case|:
name|printf
argument_list|(
literal|"Power Save-Poll"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|CTRL_PS_POLL_HDRLEN
argument_list|)
condition|)
return|return
literal|0
return|;
name|printf
argument_list|(
literal|" AID(%x)"
argument_list|,
name|EXTRACT_LE_16BITS
argument_list|(
operator|&
operator|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_ps_poll_t
operator|*
operator|)
name|p
operator|)
operator|->
name|aid
operator|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_RTS
case|:
name|printf
argument_list|(
literal|"Request-To-Send"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|CTRL_RTS_HDRLEN
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|eflag
condition|)
name|printf
argument_list|(
literal|" TA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_rts_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ta
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_CTS
case|:
name|printf
argument_list|(
literal|"Clear-To-Send"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|CTRL_CTS_HDRLEN
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|eflag
condition|)
name|printf
argument_list|(
literal|" RA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_cts_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_ACK
case|:
name|printf
argument_list|(
literal|"Acknowledgment"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|CTRL_ACK_HDRLEN
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|eflag
condition|)
name|printf
argument_list|(
literal|" RA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_ack_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_CF_END
case|:
name|printf
argument_list|(
literal|"CF-End"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|CTRL_END_HDRLEN
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|eflag
condition|)
name|printf
argument_list|(
literal|" RA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_end_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_END_ACK
case|:
name|printf
argument_list|(
literal|"CF-End+CF-Ack"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|p
argument_list|,
name|CTRL_END_ACK_HDRLEN
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|eflag
condition|)
name|printf
argument_list|(
literal|" RA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_end_ack_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown Ctrl Subtype"
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Print Header funcs  */
end_comment

begin_comment
comment|/*  *  Data Frame - Address field contents  *  *  To Ds  | From DS | Addr 1 | Addr 2 | Addr 3 | Addr 4  *    0    |  0      |  DA    | SA     | BSSID  | n/a  *    0    |  1      |  DA    | BSSID  | SA     | n/a  *    1    |  0      |  BSSID | SA     | DA     | n/a  *    1    |  1      |  RA    | TA     | DA     | SA  */
end_comment

begin_function
specifier|static
name|void
name|data_header_print
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
modifier|*
name|srcp
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
modifier|*
name|dstp
parameter_list|)
block|{
switch|switch
condition|(
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|DATA_DATA
case|:
case|case
name|DATA_NODATA
case|:
break|break;
case|case
name|DATA_DATA_CF_ACK
case|:
case|case
name|DATA_NODATA_CF_ACK
case|:
name|printf
argument_list|(
literal|"CF Ack "
argument_list|)
expr_stmt|;
break|break;
case|case
name|DATA_DATA_CF_POLL
case|:
case|case
name|DATA_NODATA_CF_POLL
case|:
name|printf
argument_list|(
literal|"CF Poll "
argument_list|)
expr_stmt|;
break|break;
case|case
name|DATA_DATA_CF_ACK_POLL
case|:
case|case
name|DATA_NODATA_CF_ACK_POLL
case|:
name|printf
argument_list|(
literal|"CF Ack/Poll "
argument_list|)
expr_stmt|;
break|break;
block|}
define|#
directive|define
name|ADDR1
value|(p + 4)
define|#
directive|define
name|ADDR2
value|(p + 10)
define|#
directive|define
name|ADDR3
value|(p + 16)
define|#
directive|define
name|ADDR4
value|(p + 24)
if|if
condition|(
operator|!
name|FC_TO_DS
argument_list|(
name|fc
argument_list|)
operator|&&
operator|!
name|FC_FROM_DS
argument_list|(
name|fc
argument_list|)
condition|)
block|{
if|if
condition|(
name|srcp
operator|!=
name|NULL
condition|)
operator|*
name|srcp
operator|=
name|ADDR2
expr_stmt|;
if|if
condition|(
name|dstp
operator|!=
name|NULL
condition|)
operator|*
name|dstp
operator|=
name|ADDR1
expr_stmt|;
if|if
condition|(
operator|!
name|eflag
condition|)
return|return;
name|printf
argument_list|(
literal|"DA:%s SA:%s BSSID:%s "
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR1
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR2
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR3
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|FC_TO_DS
argument_list|(
name|fc
argument_list|)
operator|&&
name|FC_FROM_DS
argument_list|(
name|fc
argument_list|)
condition|)
block|{
if|if
condition|(
name|srcp
operator|!=
name|NULL
condition|)
operator|*
name|srcp
operator|=
name|ADDR3
expr_stmt|;
if|if
condition|(
name|dstp
operator|!=
name|NULL
condition|)
operator|*
name|dstp
operator|=
name|ADDR1
expr_stmt|;
if|if
condition|(
operator|!
name|eflag
condition|)
return|return;
name|printf
argument_list|(
literal|"DA:%s BSSID:%s SA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR1
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR2
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR3
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FC_TO_DS
argument_list|(
name|fc
argument_list|)
operator|&&
operator|!
name|FC_FROM_DS
argument_list|(
name|fc
argument_list|)
condition|)
block|{
if|if
condition|(
name|srcp
operator|!=
name|NULL
condition|)
operator|*
name|srcp
operator|=
name|ADDR2
expr_stmt|;
if|if
condition|(
name|dstp
operator|!=
name|NULL
condition|)
operator|*
name|dstp
operator|=
name|ADDR3
expr_stmt|;
if|if
condition|(
operator|!
name|eflag
condition|)
return|return;
name|printf
argument_list|(
literal|"BSSID:%s SA:%s DA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR1
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR2
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR3
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FC_TO_DS
argument_list|(
name|fc
argument_list|)
operator|&&
name|FC_FROM_DS
argument_list|(
name|fc
argument_list|)
condition|)
block|{
if|if
condition|(
name|srcp
operator|!=
name|NULL
condition|)
operator|*
name|srcp
operator|=
name|ADDR4
expr_stmt|;
if|if
condition|(
name|dstp
operator|!=
name|NULL
condition|)
operator|*
name|dstp
operator|=
name|ADDR3
expr_stmt|;
if|if
condition|(
operator|!
name|eflag
condition|)
return|return;
name|printf
argument_list|(
literal|"RA:%s TA:%s DA:%s SA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR1
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR2
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR3
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
name|ADDR4
argument_list|)
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|ADDR1
undef|#
directive|undef
name|ADDR2
undef|#
directive|undef
name|ADDR3
undef|#
directive|undef
name|ADDR4
block|}
end_function

begin_function
specifier|static
name|void
name|mgmt_header_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
modifier|*
name|srcp
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
modifier|*
name|dstp
parameter_list|)
block|{
specifier|const
name|struct
name|mgmt_header_t
modifier|*
name|hp
init|=
operator|(
specifier|const
expr|struct
name|mgmt_header_t
operator|*
operator|)
name|p
decl_stmt|;
if|if
condition|(
name|srcp
operator|!=
name|NULL
condition|)
operator|*
name|srcp
operator|=
name|hp
operator|->
name|sa
expr_stmt|;
if|if
condition|(
name|dstp
operator|!=
name|NULL
condition|)
operator|*
name|dstp
operator|=
name|hp
operator|->
name|da
expr_stmt|;
if|if
condition|(
operator|!
name|eflag
condition|)
return|return;
name|printf
argument_list|(
literal|"BSSID:%s DA:%s SA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
name|hp
operator|)
operator|->
name|bssid
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
name|hp
operator|)
operator|->
name|da
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
name|hp
operator|)
operator|->
name|sa
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctrl_header_print
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
modifier|*
name|srcp
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
modifier|*
name|dstp
parameter_list|)
block|{
if|if
condition|(
name|srcp
operator|!=
name|NULL
condition|)
operator|*
name|srcp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|dstp
operator|!=
name|NULL
condition|)
operator|*
name|dstp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|eflag
condition|)
return|return;
switch|switch
condition|(
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|CTRL_PS_POLL
case|:
name|printf
argument_list|(
literal|"BSSID:%s TA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_ps_poll_t
operator|*
operator|)
name|p
operator|)
operator|->
name|bssid
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_ps_poll_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ta
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_RTS
case|:
name|printf
argument_list|(
literal|"RA:%s TA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_rts_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_rts_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ta
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_CTS
case|:
name|printf
argument_list|(
literal|"RA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_cts_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_ACK
case|:
name|printf
argument_list|(
literal|"RA:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_ack_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_CF_END
case|:
name|printf
argument_list|(
literal|"RA:%s BSSID:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_end_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_end_t
operator|*
operator|)
name|p
operator|)
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_END_ACK
case|:
name|printf
argument_list|(
literal|"RA:%s BSSID:%s "
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_end_ack_t
operator|*
operator|)
name|p
operator|)
operator|->
name|ra
argument_list|)
argument_list|,
name|etheraddr_string
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|ctrl_end_ack_t
operator|*
operator|)
name|p
operator|)
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"(H) Unknown Ctrl Subtype"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|extract_header_length
parameter_list|(
name|u_int16_t
name|fc
parameter_list|)
block|{
switch|switch
condition|(
name|FC_TYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|T_MGMT
case|:
return|return
name|MGMT_HDRLEN
return|;
case|case
name|T_CTRL
case|:
switch|switch
condition|(
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|CTRL_PS_POLL
case|:
return|return
name|CTRL_PS_POLL_HDRLEN
return|;
case|case
name|CTRL_RTS
case|:
return|return
name|CTRL_RTS_HDRLEN
return|;
case|case
name|CTRL_CTS
case|:
return|return
name|CTRL_CTS_HDRLEN
return|;
case|case
name|CTRL_ACK
case|:
return|return
name|CTRL_ACK_HDRLEN
return|;
case|case
name|CTRL_CF_END
case|:
return|return
name|CTRL_END_HDRLEN
return|;
case|case
name|CTRL_END_ACK
case|:
return|return
name|CTRL_END_ACK_HDRLEN
return|;
default|default:
return|return
literal|0
return|;
block|}
case|case
name|T_DATA
case|:
return|return
operator|(
name|FC_TO_DS
argument_list|(
name|fc
argument_list|)
operator|&&
name|FC_FROM_DS
argument_list|(
name|fc
argument_list|)
operator|)
condition|?
literal|30
else|:
literal|24
return|;
default|default:
name|printf
argument_list|(
literal|"unknown IEEE802.11 frame type (%d)"
argument_list|,
name|FC_TYPE
argument_list|(
name|fc
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * Print the 802.11 MAC header if eflag is set, and set "*srcp" and "*dstp"  * to point to the source and destination MAC addresses in any case if  * "srcp" and "dstp" aren't null.  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|ieee_802_11_hdr_print
parameter_list|(
name|u_int16_t
name|fc
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
modifier|*
name|srcp
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
modifier|*
name|dstp
parameter_list|)
block|{
if|if
condition|(
name|vflag
condition|)
block|{
if|if
condition|(
name|FC_MORE_DATA
argument_list|(
name|fc
argument_list|)
condition|)
name|printf
argument_list|(
literal|"More Data "
argument_list|)
expr_stmt|;
if|if
condition|(
name|FC_MORE_FLAG
argument_list|(
name|fc
argument_list|)
condition|)
name|printf
argument_list|(
literal|"More Fragments "
argument_list|)
expr_stmt|;
if|if
condition|(
name|FC_POWER_MGMT
argument_list|(
name|fc
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Pwr Mgmt "
argument_list|)
expr_stmt|;
if|if
condition|(
name|FC_RETRY
argument_list|(
name|fc
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Retry "
argument_list|)
expr_stmt|;
if|if
condition|(
name|FC_ORDER
argument_list|(
name|fc
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Strictly Ordered "
argument_list|)
expr_stmt|;
if|if
condition|(
name|FC_WEP
argument_list|(
name|fc
argument_list|)
condition|)
name|printf
argument_list|(
literal|"WEP Encrypted "
argument_list|)
expr_stmt|;
if|if
condition|(
name|FC_TYPE
argument_list|(
name|fc
argument_list|)
operator|!=
name|T_CTRL
operator|||
name|FC_SUBTYPE
argument_list|(
name|fc
argument_list|)
operator|!=
name|CTRL_PS_POLL
condition|)
name|printf
argument_list|(
literal|"%dus "
argument_list|,
name|EXTRACT_LE_16BITS
argument_list|(
operator|&
operator|(
operator|(
specifier|const
expr|struct
name|mgmt_header_t
operator|*
operator|)
name|p
operator|)
operator|->
name|duration
argument_list|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|FC_TYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|T_MGMT
case|:
name|mgmt_header_print
argument_list|(
name|p
argument_list|,
name|srcp
argument_list|,
name|dstp
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_CTRL
case|:
name|ctrl_header_print
argument_list|(
name|fc
argument_list|,
name|p
argument_list|,
name|srcp
argument_list|,
name|dstp
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_DATA
case|:
name|data_header_print
argument_list|(
name|fc
argument_list|,
name|p
argument_list|,
name|srcp
argument_list|,
name|dstp
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"(header) unknown IEEE802.11 frame type (%d)"
argument_list|,
name|FC_TYPE
argument_list|(
name|fc
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|srcp
operator|=
name|NULL
expr_stmt|;
operator|*
name|dstp
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|u_int
name|ieee802_11_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|,
name|u_int
name|caplen
parameter_list|)
block|{
name|u_int16_t
name|fc
decl_stmt|;
name|u_int
name|hdrlen
decl_stmt|;
specifier|const
name|u_int8_t
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|;
name|u_short
name|extracted_ethertype
decl_stmt|;
if|if
condition|(
name|caplen
operator|<
name|IEEE802_11_FC_LEN
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|caplen
return|;
block|}
name|fc
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|hdrlen
operator|=
name|extract_header_length
argument_list|(
name|fc
argument_list|)
expr_stmt|;
if|if
condition|(
name|caplen
operator|<
name|hdrlen
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|hdrlen
return|;
block|}
name|ieee_802_11_hdr_print
argument_list|(
name|fc
argument_list|,
name|p
argument_list|,
operator|&
name|src
argument_list|,
operator|&
name|dst
argument_list|)
expr_stmt|;
comment|/* 	 * Go past the 802.11 header. 	 */
name|length
operator|-=
name|hdrlen
expr_stmt|;
name|caplen
operator|-=
name|hdrlen
expr_stmt|;
name|p
operator|+=
name|hdrlen
expr_stmt|;
switch|switch
condition|(
name|FC_TYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|T_MGMT
case|:
if|if
condition|(
operator|!
name|mgmt_body_print
argument_list|(
name|fc
argument_list|,
operator|(
specifier|const
expr|struct
name|mgmt_header_t
operator|*
operator|)
operator|(
name|p
operator|-
name|hdrlen
operator|)
argument_list|,
name|p
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|hdrlen
return|;
block|}
break|break;
case|case
name|T_CTRL
case|:
if|if
condition|(
operator|!
name|ctrl_body_print
argument_list|(
name|fc
argument_list|,
name|p
operator|-
name|hdrlen
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|hdrlen
return|;
block|}
break|break;
case|case
name|T_DATA
case|:
comment|/* There may be a problem w/ AP not having this bit set */
if|if
condition|(
name|FC_WEP
argument_list|(
name|fc
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wep_print
argument_list|(
name|p
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|hdrlen
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|llc_print
argument_list|(
name|p
argument_list|,
name|length
argument_list|,
name|caplen
argument_list|,
name|dst
argument_list|,
name|src
argument_list|,
operator|&
name|extracted_ethertype
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 			 * Some kinds of LLC packet we cannot 			 * handle intelligently 			 */
if|if
condition|(
operator|!
name|eflag
condition|)
name|ieee_802_11_hdr_print
argument_list|(
name|fc
argument_list|,
name|p
operator|-
name|hdrlen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|extracted_ethertype
condition|)
name|printf
argument_list|(
literal|"(LLC %s) "
argument_list|,
name|etherproto_string
argument_list|(
name|htons
argument_list|(
name|extracted_ethertype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|xflag
operator|&&
operator|!
name|qflag
condition|)
name|default_print
argument_list|(
name|p
argument_list|,
name|caplen
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown 802.11 frame type (%d)"
argument_list|,
name|FC_TYPE
argument_list|(
name|fc
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|hdrlen
return|;
block|}
end_function

begin_comment
comment|/*  * This is the top level routine of the printer.  'p' points  * to the 802.11 header of the packet, 'h->ts' is the timestamp,  * 'h->len' is the length of the packet off the wire, and 'h->caplen'  * is the number of bytes actually captured.  */
end_comment

begin_function
name|u_int
name|ieee802_11_if_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
return|return
name|ieee802_11_print
argument_list|(
name|p
argument_list|,
name|h
operator|->
name|len
argument_list|,
name|h
operator|->
name|caplen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_radiotap_field
parameter_list|(
name|struct
name|cpack_state
modifier|*
name|s
parameter_list|,
name|u_int32_t
name|bit
parameter_list|)
block|{
union|union
block|{
name|int8_t
name|i8
decl_stmt|;
name|u_int8_t
name|u8
decl_stmt|;
name|int16_t
name|i16
decl_stmt|;
name|u_int16_t
name|u16
decl_stmt|;
name|u_int32_t
name|u32
decl_stmt|;
name|u_int64_t
name|u64
decl_stmt|;
block|}
name|u
union|,
name|u2
union|;
name|int
name|rc
decl_stmt|;
switch|switch
condition|(
name|bit
condition|)
block|{
case|case
name|IEEE80211_RADIOTAP_FLAGS
case|:
case|case
name|IEEE80211_RADIOTAP_RATE
case|:
case|case
name|IEEE80211_RADIOTAP_DB_ANTSIGNAL
case|:
case|case
name|IEEE80211_RADIOTAP_DB_ANTNOISE
case|:
case|case
name|IEEE80211_RADIOTAP_ANTENNA
case|:
name|rc
operator|=
name|cpack_uint8
argument_list|(
name|s
argument_list|,
operator|&
name|u
operator|.
name|u8
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DBM_ANTSIGNAL
case|:
case|case
name|IEEE80211_RADIOTAP_DBM_ANTNOISE
case|:
name|rc
operator|=
name|cpack_int8
argument_list|(
name|s
argument_list|,
operator|&
name|u
operator|.
name|i8
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_CHANNEL
case|:
name|rc
operator|=
name|cpack_uint16
argument_list|(
name|s
argument_list|,
operator|&
name|u
operator|.
name|u16
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
break|break;
name|rc
operator|=
name|cpack_uint16
argument_list|(
name|s
argument_list|,
operator|&
name|u2
operator|.
name|u16
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_FHSS
case|:
case|case
name|IEEE80211_RADIOTAP_LOCK_QUALITY
case|:
case|case
name|IEEE80211_RADIOTAP_TX_ATTENUATION
case|:
name|rc
operator|=
name|cpack_uint16
argument_list|(
name|s
argument_list|,
operator|&
name|u
operator|.
name|u16
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DB_TX_ATTENUATION
case|:
name|rc
operator|=
name|cpack_uint8
argument_list|(
name|s
argument_list|,
operator|&
name|u
operator|.
name|u8
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DBM_TX_POWER
case|:
name|rc
operator|=
name|cpack_int8
argument_list|(
name|s
argument_list|,
operator|&
name|u
operator|.
name|i8
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_TSFT
case|:
name|rc
operator|=
name|cpack_uint64
argument_list|(
name|s
argument_list|,
operator|&
name|u
operator|.
name|u64
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* this bit indicates a field whose 		 * size we do not know, so we cannot 		 * proceed. 		 */
name|printf
argument_list|(
literal|"[0x%08x] "
argument_list|,
name|bit
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
switch|switch
condition|(
name|bit
condition|)
block|{
case|case
name|IEEE80211_RADIOTAP_CHANNEL
case|:
name|printf
argument_list|(
literal|"%u MHz "
argument_list|,
name|u
operator|.
name|u16
argument_list|)
expr_stmt|;
if|if
condition|(
name|u2
operator|.
name|u16
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"(0x%04x) "
argument_list|,
name|u2
operator|.
name|u16
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_FHSS
case|:
name|printf
argument_list|(
literal|"fhset %d fhpat %d "
argument_list|,
name|u
operator|.
name|u16
operator|&
literal|0xff
argument_list|,
operator|(
name|u
operator|.
name|u16
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_RATE
case|:
name|PRINT_RATE
argument_list|(
literal|""
argument_list|,
name|u
operator|.
name|u8
argument_list|,
literal|" Mb/s "
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DBM_ANTSIGNAL
case|:
name|printf
argument_list|(
literal|"%ddB signal "
argument_list|,
name|u
operator|.
name|i8
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DBM_ANTNOISE
case|:
name|printf
argument_list|(
literal|"%ddB noise "
argument_list|,
name|u
operator|.
name|i8
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DB_ANTSIGNAL
case|:
name|printf
argument_list|(
literal|"%ddB signal "
argument_list|,
name|u
operator|.
name|u8
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DB_ANTNOISE
case|:
name|printf
argument_list|(
literal|"%ddB noise "
argument_list|,
name|u
operator|.
name|u8
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_LOCK_QUALITY
case|:
name|printf
argument_list|(
literal|"%u sq "
argument_list|,
name|u
operator|.
name|u16
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_TX_ATTENUATION
case|:
name|printf
argument_list|(
literal|"%d tx power "
argument_list|,
operator|-
operator|(
name|int
operator|)
name|u
operator|.
name|u16
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DB_TX_ATTENUATION
case|:
name|printf
argument_list|(
literal|"%ddB tx power "
argument_list|,
operator|-
operator|(
name|int
operator|)
name|u
operator|.
name|u8
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DBM_TX_POWER
case|:
name|printf
argument_list|(
literal|"%ddBm tx power "
argument_list|,
name|u
operator|.
name|i8
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_FLAGS
case|:
if|if
condition|(
name|u
operator|.
name|u8
operator|&
name|IEEE80211_RADIOTAP_F_CFP
condition|)
name|printf
argument_list|(
literal|"cfp "
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|.
name|u8
operator|&
name|IEEE80211_RADIOTAP_F_SHORTPRE
condition|)
name|printf
argument_list|(
literal|"short preamble "
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|.
name|u8
operator|&
name|IEEE80211_RADIOTAP_F_WEP
condition|)
name|printf
argument_list|(
literal|"wep "
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|.
name|u8
operator|&
name|IEEE80211_RADIOTAP_F_FRAG
condition|)
name|printf
argument_list|(
literal|"fragmented "
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_ANTENNA
case|:
name|printf
argument_list|(
literal|"antenna %d "
argument_list|,
name|u
operator|.
name|u8
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_TSFT
case|:
name|printf
argument_list|(
literal|"%"
name|PRIu64
literal|"us tsft "
argument_list|,
name|u
operator|.
name|u64
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|ieee802_11_radio_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|,
name|u_int
name|caplen
parameter_list|)
block|{
define|#
directive|define
name|BITNO_32
parameter_list|(
name|x
parameter_list|)
value|(((x)>> 16) ? 16 + BITNO_16((x)>> 16) : BITNO_16((x)))
define|#
directive|define
name|BITNO_16
parameter_list|(
name|x
parameter_list|)
value|(((x)>> 8) ? 8 + BITNO_8((x)>> 8) : BITNO_8((x)))
define|#
directive|define
name|BITNO_8
parameter_list|(
name|x
parameter_list|)
value|(((x)>> 4) ? 4 + BITNO_4((x)>> 4) : BITNO_4((x)))
define|#
directive|define
name|BITNO_4
parameter_list|(
name|x
parameter_list|)
value|(((x)>> 2) ? 2 + BITNO_2((x)>> 2) : BITNO_2((x)))
define|#
directive|define
name|BITNO_2
parameter_list|(
name|x
parameter_list|)
value|(((x)& 2) ? 1 : 0)
define|#
directive|define
name|BIT
parameter_list|(
name|n
parameter_list|)
value|(1<< n)
define|#
directive|define
name|IS_EXTENDED
parameter_list|(
name|__p
parameter_list|)
define|\
value|(EXTRACT_LE_32BITS(__p)& BIT(IEEE80211_RADIOTAP_EXT)) != 0
name|struct
name|cpack_state
name|cpacker
decl_stmt|;
name|struct
name|ieee80211_radiotap_header
modifier|*
name|hdr
decl_stmt|;
name|u_int32_t
name|present
decl_stmt|,
name|next_present
decl_stmt|;
name|u_int32_t
modifier|*
name|presentp
decl_stmt|,
modifier|*
name|last_presentp
decl_stmt|;
name|enum
name|ieee80211_radiotap_type
name|bit
decl_stmt|;
name|int
name|bit0
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|iter
decl_stmt|;
name|u_int
name|len
decl_stmt|;
if|if
condition|(
name|caplen
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|caplen
return|;
block|}
name|hdr
operator|=
operator|(
expr|struct
name|ieee80211_radiotap_header
operator|*
operator|)
name|p
expr_stmt|;
name|len
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
operator|&
name|hdr
operator|->
name|it_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|caplen
operator|<
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|caplen
return|;
block|}
for|for
control|(
name|last_presentp
operator|=
operator|&
name|hdr
operator|->
name|it_present
init|;
name|IS_EXTENDED
argument_list|(
name|last_presentp
argument_list|)
operator|&&
operator|(
name|u_char
operator|*
operator|)
operator|(
name|last_presentp
operator|+
literal|1
operator|)
operator|<=
name|p
operator|+
name|len
condition|;
name|last_presentp
operator|++
control|)
empty_stmt|;
comment|/* are there more bitmap extensions than bytes in header? */
if|if
condition|(
name|IS_EXTENDED
argument_list|(
name|last_presentp
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|caplen
return|;
block|}
name|iter
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|(
name|last_presentp
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|cpack_init
argument_list|(
operator|&
name|cpacker
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
name|iter
argument_list|,
name|len
operator|-
operator|(
name|iter
operator|-
name|p
operator|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* XXX */
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|caplen
return|;
block|}
for|for
control|(
name|bit0
operator|=
literal|0
operator|,
name|presentp
operator|=
operator|&
name|hdr
operator|->
name|it_present
init|;
name|presentp
operator|<=
name|last_presentp
condition|;
name|presentp
operator|++
operator|,
name|bit0
operator|+=
literal|32
control|)
block|{
for|for
control|(
name|present
operator|=
name|EXTRACT_LE_32BITS
argument_list|(
name|presentp
argument_list|)
init|;
name|present
condition|;
name|present
operator|=
name|next_present
control|)
block|{
comment|/* clear the least significant bit that is set */
name|next_present
operator|=
name|present
operator|&
operator|(
name|present
operator|-
literal|1
operator|)
expr_stmt|;
comment|/* extract the least significant bit that is set */
name|bit
operator|=
operator|(
expr|enum
name|ieee80211_radiotap_type
operator|)
operator|(
name|bit0
operator|+
name|BITNO_32
argument_list|(
name|present
operator|^
name|next_present
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|print_radiotap_field
argument_list|(
operator|&
name|cpacker
argument_list|,
name|bit
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
block|}
block|}
name|out
label|:
return|return
name|len
operator|+
name|ieee802_11_print
argument_list|(
name|p
operator|+
name|len
argument_list|,
name|length
operator|-
name|len
argument_list|,
name|caplen
operator|-
name|len
argument_list|)
return|;
undef|#
directive|undef
name|BITNO_32
undef|#
directive|undef
name|BITNO_16
undef|#
directive|undef
name|BITNO_8
undef|#
directive|undef
name|BITNO_4
undef|#
directive|undef
name|BITNO_2
undef|#
directive|undef
name|BIT
block|}
end_function

begin_function
specifier|static
name|u_int
name|ieee802_11_avs_radio_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|,
name|u_int
name|caplen
parameter_list|)
block|{
name|u_int32_t
name|caphdr_len
decl_stmt|;
name|caphdr_len
operator|=
name|EXTRACT_32BITS
argument_list|(
name|p
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|caphdr_len
operator|<
literal|8
condition|)
block|{
comment|/* 		 * Yow!  The capture header length is claimed not 		 * to be large enough to include even the version 		 * cookie or capture header length! 		 */
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|caplen
return|;
block|}
if|if
condition|(
name|caplen
operator|<
name|caphdr_len
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|caplen
return|;
block|}
return|return
name|caphdr_len
operator|+
name|ieee802_11_print
argument_list|(
name|p
operator|+
name|caphdr_len
argument_list|,
name|length
operator|-
name|caphdr_len
argument_list|,
name|caplen
operator|-
name|caphdr_len
argument_list|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|PRISM_HDR_LEN
value|144
end_define

begin_define
define|#
directive|define
name|WLANCAP_MAGIC_COOKIE_V1
value|0x80211001
end_define

begin_comment
comment|/*  * For DLT_PRISM_HEADER; like DLT_IEEE802_11, but with an extra header,  * containing information such as radio information, which we  * currently ignore.  *  * If, however, the packet begins with WLANCAP_MAGIC_COOKIE_V1, it's  * really DLT_IEEE802_11_RADIO (currently, on Linux, there's no  * ARPHRD_ type for DLT_IEEE802_11_RADIO, as there is a  * ARPHRD_IEEE80211_PRISM for DLT_PRISM_HEADER, so  * ARPHRD_IEEE80211_PRISM is used for DLT_IEEE802_11_RADIO, and  * the first 4 bytes of the header are used to indicate which it is).  */
end_comment

begin_function
name|u_int
name|prism_if_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|u_int
name|caplen
init|=
name|h
operator|->
name|caplen
decl_stmt|;
name|u_int
name|length
init|=
name|h
operator|->
name|len
decl_stmt|;
if|if
condition|(
name|caplen
operator|<
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|caplen
return|;
block|}
if|if
condition|(
name|EXTRACT_32BITS
argument_list|(
name|p
argument_list|)
operator|==
name|WLANCAP_MAGIC_COOKIE_V1
condition|)
return|return
name|ieee802_11_avs_radio_print
argument_list|(
name|p
argument_list|,
name|length
argument_list|,
name|caplen
argument_list|)
return|;
if|if
condition|(
name|caplen
operator|<
name|PRISM_HDR_LEN
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|caplen
return|;
block|}
return|return
name|PRISM_HDR_LEN
operator|+
name|ieee802_11_print
argument_list|(
name|p
operator|+
name|PRISM_HDR_LEN
argument_list|,
name|length
operator|-
name|PRISM_HDR_LEN
argument_list|,
name|caplen
operator|-
name|PRISM_HDR_LEN
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * For DLT_IEEE802_11_RADIO; like DLT_IEEE802_11, but with an extra  * header, containing information such as radio information, which we  * currently ignore.  */
end_comment

begin_function
name|u_int
name|ieee802_11_radio_if_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|u_int
name|caplen
init|=
name|h
operator|->
name|caplen
decl_stmt|;
name|u_int
name|length
init|=
name|h
operator|->
name|len
decl_stmt|;
if|if
condition|(
name|caplen
operator|<
literal|8
condition|)
block|{
name|printf
argument_list|(
literal|"[|802.11]"
argument_list|)
expr_stmt|;
return|return
name|caplen
return|;
block|}
return|return
name|ieee802_11_radio_print
argument_list|(
name|p
argument_list|,
name|length
argument_list|,
name|caplen
argument_list|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1995, 1996  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code distributions  * retain the above copyright notice and this paragraph in its entirety, (2)  * distributions including binary code include the above copyright notice and  * this paragraph in its entirety in the documentation or other materials  * provided with the distribution, and (3) all advertising materials mentioning  * features or use of this software display the following acknowledgement:  * ``This product includes software developed by the University of California,  * Lawrence Berkeley Laboratory and its contributors.'' Neither the name of  * the University nor the names of its contributors may be used to endorse  * or promote products derived from this software without specific prior  * written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * $FreeBSD$  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-pim.c,v 1.23 2000/10/03 02:55:00 itojun Exp $ (LBL)"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_comment
comment|/*  * XXX: We consider a case where IPv6 is not ready yet for portability,  * but PIM dependent defintions should be independent of IPv6...  */
end_comment

begin_struct
struct|struct
name|pim
block|{
name|u_int8_t
name|pim_typever
decl_stmt|;
comment|/* upper 4bit: PIM version number; 2 for PIMv2 */
comment|/* lower 4bit: the PIM message type, currently they are: 			 * Hello, Register, Register-Stop, Join/Prune, 			 * Bootstrap, Assert, Graft (PIM-DM only), 			 * Graft-Ack (PIM-DM only), C-RP-Adv 			 */
define|#
directive|define
name|PIM_VER
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xf0)>> 4)
define|#
directive|define
name|PIM_TYPE
parameter_list|(
name|x
parameter_list|)
value|((x)& 0x0f)
name|u_char
name|pim_rsv
decl_stmt|;
comment|/* Reserved */
name|u_short
name|pim_cksum
decl_stmt|;
comment|/* IP style check sum */
block|}
struct|;
end_struct

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"ip.h"
end_include

begin_function_decl
specifier|static
name|void
name|pimv2_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|pimv1_join_prune_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|)
block|{
name|int
name|maddrlen
decl_stmt|,
name|addrlen
decl_stmt|,
name|ngroups
decl_stmt|,
name|njoin
decl_stmt|,
name|nprune
decl_stmt|;
name|int
name|njp
decl_stmt|;
comment|/* If it's a single group and a single source, use 1-line output. */
if|if
condition|(
name|TTEST2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|30
argument_list|)
operator|&&
name|bp
index|[
literal|11
index|]
operator|==
literal|1
operator|&&
operator|(
operator|(
name|njoin
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|20
index|]
argument_list|)
operator|)
operator|+
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|22
index|]
argument_list|)
operator|)
operator|==
literal|1
condition|)
block|{
name|int
name|hold
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" RPF %s "
argument_list|,
name|ipaddr_string
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
name|hold
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|hold
operator|!=
literal|180
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Hold "
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|hold
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s (%s/%d, %s"
argument_list|,
name|njoin
condition|?
literal|"Join"
else|:
literal|"Prune"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|26
index|]
argument_list|)
argument_list|,
name|bp
index|[
literal|25
index|]
operator|&
literal|0x3f
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|12
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|16
index|]
argument_list|)
operator|!=
literal|0xffffffff
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"/%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|16
index|]
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|") %s%s %s"
argument_list|,
operator|(
name|bp
index|[
literal|24
index|]
operator|&
literal|0x01
operator|)
condition|?
literal|"Sparse"
else|:
literal|"Dense"
argument_list|,
operator|(
name|bp
index|[
literal|25
index|]
operator|&
literal|0x80
operator|)
condition|?
literal|" WC"
else|:
literal|""
argument_list|,
operator|(
name|bp
index|[
literal|25
index|]
operator|&
literal|0x40
operator|)
condition|?
literal|"RP"
else|:
literal|"SPT"
argument_list|)
expr_stmt|;
return|return;
block|}
name|TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n Upstream Nbr: %s"
argument_list|,
name|ipaddr_string
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
name|TCHECK2
argument_list|(
name|bp
index|[
literal|6
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n Hold time: "
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|6
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|8
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
name|TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|maddrlen
operator|=
name|bp
index|[
literal|1
index|]
expr_stmt|;
name|addrlen
operator|=
name|bp
index|[
literal|2
index|]
expr_stmt|;
name|ngroups
operator|=
name|bp
index|[
literal|3
index|]
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
while|while
condition|(
name|ngroups
operator|--
condition|)
block|{
name|TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n\tGroup: %s"
argument_list|,
name|ipaddr_string
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|4
index|]
argument_list|)
operator|!=
literal|0xffffffff
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"/%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|TCHECK2
argument_list|(
name|bp
index|[
literal|8
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|njoin
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
name|nprune
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|10
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" joined: %d pruned: %d"
argument_list|,
name|njoin
argument_list|,
name|nprune
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|12
expr_stmt|;
name|len
operator|-=
literal|12
expr_stmt|;
for|for
control|(
name|njp
operator|=
literal|0
init|;
name|njp
operator|<
operator|(
name|njoin
operator|+
name|nprune
operator|)
condition|;
name|njp
operator|++
control|)
block|{
name|char
modifier|*
name|type
decl_stmt|;
if|if
condition|(
name|njp
operator|<
name|njoin
condition|)
block|{
name|type
operator|=
literal|"Join "
expr_stmt|;
block|}
else|else
block|{
name|type
operator|=
literal|"Prune"
expr_stmt|;
block|}
name|TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|6
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n\t%s %s%s%s%s/%d"
argument_list|,
name|type
argument_list|,
operator|(
name|bp
index|[
literal|0
index|]
operator|&
literal|0x01
operator|)
condition|?
literal|"Sparse "
else|:
literal|"Dense "
argument_list|,
operator|(
name|bp
index|[
literal|1
index|]
operator|&
literal|0x80
operator|)
condition|?
literal|"WC "
else|:
literal|""
argument_list|,
operator|(
name|bp
index|[
literal|1
index|]
operator|&
literal|0x40
operator|)
condition|?
literal|"RP "
else|:
literal|"SPT "
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|bp
index|[
literal|1
index|]
operator|&
literal|0x3f
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|6
expr_stmt|;
name|len
operator|-=
literal|6
expr_stmt|;
block|}
block|}
return|return;
name|trunc
label|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"[|pim]"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|pimv1_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|)
block|{
specifier|register
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
specifier|register
name|u_char
name|type
decl_stmt|;
name|ep
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|snapend
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
return|return;
name|type
operator|=
name|bp
index|[
literal|1
index|]
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
literal|0
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Query"
argument_list|)
expr_stmt|;
if|if
condition|(
name|TTEST
argument_list|(
name|bp
index|[
literal|8
index|]
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|bp
index|[
literal|8
index|]
operator|>>
literal|4
condition|)
block|{
case|case
literal|0
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Dense-mode"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Sparse-mode"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Sparse-Dense-mode"
argument_list|)
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" mode-%d"
argument_list|,
name|bp
index|[
literal|8
index|]
operator|>>
literal|4
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|vflag
condition|)
block|{
name|TCHECK2
argument_list|(
name|bp
index|[
literal|10
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (Hold-time "
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|10
index|]
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Register"
argument_list|)
expr_stmt|;
name|TCHECK2
argument_list|(
name|bp
index|[
literal|8
index|]
argument_list|,
literal|20
argument_list|)
expr_stmt|;
comment|/* ip header */
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" for %s> %s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|20
index|]
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|24
index|]
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Register-Stop"
argument_list|)
expr_stmt|;
name|TCHECK2
argument_list|(
name|bp
index|[
literal|12
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" for %s> %s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|8
index|]
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|12
index|]
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Join/Prune"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
name|pimv1_join_prune_print
argument_list|(
operator|&
name|bp
index|[
literal|8
index|]
argument_list|,
name|len
operator|-
literal|8
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" RP-reachable"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
name|TCHECK2
argument_list|(
name|bp
index|[
literal|22
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" group %s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|8
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|12
index|]
argument_list|)
operator|!=
literal|0xffffffff
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"/%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|12
index|]
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" RP %s hold "
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|16
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|22
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|5
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Assert"
argument_list|)
expr_stmt|;
name|TCHECK2
argument_list|(
name|bp
index|[
literal|16
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" for %s> %s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|16
index|]
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|8
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|12
index|]
argument_list|)
operator|!=
literal|0xffffffff
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"/%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|12
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|TCHECK2
argument_list|(
name|bp
index|[
literal|24
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" %s pref %d metric %d"
argument_list|,
operator|(
name|bp
index|[
literal|20
index|]
operator|&
literal|0x80
operator|)
condition|?
literal|"RP-tree"
else|:
literal|"SPT"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|20
index|]
argument_list|)
operator|&
literal|0x7fffffff
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|24
index|]
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Graft"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
name|pimv1_join_prune_print
argument_list|(
operator|&
name|bp
index|[
literal|8
index|]
argument_list|,
name|len
operator|-
literal|8
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|7
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Graft-ACK"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
name|pimv1_join_prune_print
argument_list|(
operator|&
name|bp
index|[
literal|8
index|]
argument_list|,
name|len
operator|-
literal|8
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|8
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Mode"
argument_list|)
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" [type %d]"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|bp
index|[
literal|4
index|]
operator|>>
literal|4
operator|)
operator|!=
literal|1
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" [v%d]"
argument_list|,
name|bp
index|[
literal|4
index|]
operator|>>
literal|4
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"[|pim]"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * auto-RP is a cisco protocol, documented at  * ftp://ftpeng.cisco.com/ipmulticast/pim-autorp-spec01.txt  */
end_comment

begin_function
name|void
name|cisco_autorp_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|)
block|{
name|int
name|type
decl_stmt|;
name|int
name|numrps
decl_stmt|;
name|int
name|hold
decl_stmt|;
name|TCHECK
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" auto-rp "
argument_list|)
expr_stmt|;
name|type
operator|=
name|bp
index|[
literal|0
index|]
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
literal|0x11
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"candidate-advert"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x12
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"mapping"
argument_list|)
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"type-0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
name|TCHECK
argument_list|(
name|bp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|numrps
operator|=
name|bp
index|[
literal|1
index|]
expr_stmt|;
name|TCHECK2
argument_list|(
name|bp
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Hold "
argument_list|)
expr_stmt|;
name|hold
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|hold
condition|)
name|relts_print
argument_list|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"FOREVER"
argument_list|)
expr_stmt|;
comment|/* Next 4 bytes are reserved. */
name|bp
operator|+=
literal|8
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
comment|/*XXX skip unless -v? */
comment|/*      * Rest of packet:      * numrps entries of the form:      * 32 bits: RP      * 6 bits: reserved      * 2 bits: PIM version supported, bit 0 is "supports v1", 1 is "v2".      * 8 bits: # of entries for this RP      * each entry: 7 bits: reserved, 1 bit: negative,      *			8 bits: mask 32 bits: source      * lather, rinse, repeat.      */
while|while
condition|(
name|numrps
operator|--
condition|)
block|{
name|int
name|nentries
decl_stmt|;
name|char
name|s
decl_stmt|;
name|TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" RP %s"
argument_list|,
name|ipaddr_string
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
name|TCHECK
argument_list|(
name|bp
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|bp
index|[
literal|4
index|]
operator|&
literal|0x3
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|" PIMv?"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|" PIMv1"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|" PIMv2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|printf
argument_list|(
literal|" PIMv1+2"
argument_list|)
expr_stmt|;
break|break;
block|}
name|TCHECK
argument_list|(
name|bp
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|nentries
operator|=
name|bp
index|[
literal|5
index|]
expr_stmt|;
name|bp
operator|+=
literal|6
expr_stmt|;
name|len
operator|-=
literal|6
expr_stmt|;
name|s
operator|=
literal|' '
expr_stmt|;
for|for
control|(
init|;
name|nentries
condition|;
name|nentries
operator|--
control|)
block|{
name|TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|6
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%c%s%s/%d"
argument_list|,
name|s
argument_list|,
name|bp
index|[
literal|0
index|]
operator|&
literal|1
condition|?
literal|"!"
else|:
literal|""
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|bp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|s
operator|=
literal|','
expr_stmt|;
name|bp
operator|+=
literal|6
expr_stmt|;
name|len
operator|-=
literal|6
expr_stmt|;
block|}
block|}
return|return;
name|trunc
label|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"[|autorp]"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|pim_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|)
block|{
specifier|register
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
specifier|register
name|struct
name|pim
modifier|*
name|pim
init|=
operator|(
expr|struct
name|pim
operator|*
operator|)
name|bp
decl_stmt|;
name|ep
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|snapend
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
return|return;
ifdef|#
directive|ifdef
name|notyet
comment|/* currently we see only version and type */
name|TCHECK
argument_list|(
name|pim
operator|->
name|pim_rsv
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|PIM_VER
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
condition|)
block|{
case|case
literal|2
case|:
comment|/* avoid hardcoding? */
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"pim v2"
argument_list|)
expr_stmt|;
name|pimv2_print
argument_list|(
name|bp
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"pim v%d"
argument_list|,
name|PIM_VER
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*  * PIMv2 uses encoded address representations.  *  * The last PIM-SM I-D before RFC2117 was published specified the  * following representation for unicast addresses.  However, RFC2117  * specified no encoding for unicast addresses with the unicast  * address length specified in the header.  Therefore, we have to  * guess which encoding is being used (Cisco's PIMv2 implementation  * uses the non-RFC encoding).  RFC2117 turns a previously "Reserved"  * field into a 'unicast-address-length-in-bytes' field.  We guess  * that it's the draft encoding if this reserved field is zero.  *  * RFC2362 goes back to the encoded format, and calls the addr length  * field "reserved" again.  *  * The first byte is the address family, from:  *  *    0    Reserved  *    1    IP (IP version 4)  *    2    IP6 (IP version 6)  *    3    NSAP  *    4    HDLC (8-bit multidrop)  *    5    BBN 1822  *    6    802 (includes all 802 media plus Ethernet "canonical format")  *    7    E.163  *    8    E.164 (SMDS, Frame Relay, ATM)  *    9    F.69 (Telex)  *   10    X.121 (X.25, Frame Relay)  *   11    IPX  *   12    Appletalk  *   13    Decnet IV  *   14    Banyan Vines  *   15    E.164 with NSAP format subaddress  *  * In addition, the second byte is an "Encoding".  0 is the default  * encoding for the address family, and no other encodings are currently  * specified.  *  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|pimv2_addr_len
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
name|pimv2_addrtype
block|{
name|pimv2_unicast
block|,
name|pimv2_group
block|,
name|pimv2_source
block|}
enum|;
end_enum

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static char *addrtypestr[] = { 	"unicast", "group", "source" };
endif|#
directive|endif
end_endif

begin_comment
comment|/*  0                   1                   2                   3  *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * | Addr Family   | Encoding Type |     Unicast Address           |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+++++++  *  0                   1                   2                   3  *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * | Addr Family   | Encoding Type |   Reserved    |  Mask Len     |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                Group multicast Address                        |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  *  0                   1                   2                   3  *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * | Addr Family   | Encoding Type | Rsrvd   |S|W|R|  Mask Len     |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                        Source Address                         |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  */
end_comment

begin_function
specifier|static
name|int
name|pimv2_addr_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|enum
name|pimv2_addrtype
name|at
parameter_list|,
name|int
name|silent
parameter_list|)
block|{
name|int
name|af
decl_stmt|;
name|char
modifier|*
name|afstr
decl_stmt|;
name|int
name|len
decl_stmt|,
name|hdrlen
decl_stmt|;
name|TCHECK
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|pimv2_addr_len
operator|==
literal|0
condition|)
block|{
name|TCHECK
argument_list|(
name|bp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|bp
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|1
case|:
name|af
operator|=
name|AF_INET
expr_stmt|;
name|afstr
operator|=
literal|"IPv4"
expr_stmt|;
name|len
operator|=
literal|4
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
literal|2
case|:
name|af
operator|=
name|AF_INET6
expr_stmt|;
name|afstr
operator|=
literal|"IPv6"
expr_stmt|;
name|len
operator|=
literal|16
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|bp
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|hdrlen
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|pimv2_addr_len
condition|)
block|{
case|case
literal|4
case|:
name|af
operator|=
name|AF_INET
expr_stmt|;
name|afstr
operator|=
literal|"IPv4"
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
literal|16
case|:
name|af
operator|=
name|AF_INET6
expr_stmt|;
name|afstr
operator|=
literal|"IPv6"
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
return|return
operator|-
literal|1
return|;
break|break;
block|}
name|len
operator|=
name|pimv2_addr_len
expr_stmt|;
name|hdrlen
operator|=
literal|0
expr_stmt|;
block|}
name|bp
operator|+=
name|hdrlen
expr_stmt|;
switch|switch
condition|(
name|at
condition|)
block|{
case|case
name|pimv2_unicast
case|:
name|TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|af
operator|==
name|AF_INET
condition|)
block|{
if|if
condition|(
operator|!
name|silent
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|ipaddr_string
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|INET6
elseif|else
if|if
condition|(
name|af
operator|==
name|AF_INET6
condition|)
block|{
if|if
condition|(
operator|!
name|silent
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|ip6addr_string
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|hdrlen
operator|+
name|len
return|;
case|case
name|pimv2_group
case|:
case|case
name|pimv2_source
case|:
name|TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
name|len
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|af
operator|==
name|AF_INET
condition|)
block|{
if|if
condition|(
operator|!
name|silent
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|ipaddr_string
argument_list|(
name|bp
operator|+
literal|2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
index|[
literal|1
index|]
operator|!=
literal|32
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"/%u"
argument_list|,
name|bp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|INET6
elseif|else
if|if
condition|(
name|af
operator|==
name|AF_INET6
condition|)
block|{
if|if
condition|(
operator|!
name|silent
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|ip6addr_string
argument_list|(
name|bp
operator|+
literal|2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
index|[
literal|1
index|]
operator|!=
literal|128
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"/%u"
argument_list|,
name|bp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|bp
index|[
literal|0
index|]
operator|&&
operator|!
name|silent
condition|)
block|{
if|if
condition|(
name|at
operator|==
name|pimv2_group
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"(0x%02x)"
argument_list|,
name|bp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"(%s%s%s"
argument_list|,
name|bp
index|[
literal|0
index|]
operator|&
literal|0x04
condition|?
literal|"S"
else|:
literal|""
argument_list|,
name|bp
index|[
literal|0
index|]
operator|&
literal|0x02
condition|?
literal|"W"
else|:
literal|""
argument_list|,
name|bp
index|[
literal|0
index|]
operator|&
literal|0x01
condition|?
literal|"R"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
index|[
literal|0
index|]
operator|&
literal|0xf8
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"+0x%02x"
argument_list|,
name|bp
index|[
literal|0
index|]
operator|&
literal|0xf8
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|hdrlen
operator|+
literal|2
operator|+
name|len
return|;
default|default:
return|return
operator|-
literal|1
return|;
block|}
name|trunc
label|:
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pimv2_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|)
block|{
specifier|register
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
specifier|register
name|struct
name|pim
modifier|*
name|pim
init|=
operator|(
expr|struct
name|pim
operator|*
operator|)
name|bp
decl_stmt|;
name|int
name|advance
decl_stmt|;
name|ep
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|snapend
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
return|return;
if|if
condition|(
name|ep
operator|>
name|bp
operator|+
name|len
condition|)
name|ep
operator|=
name|bp
operator|+
name|len
expr_stmt|;
name|TCHECK
argument_list|(
name|pim
operator|->
name|pim_rsv
argument_list|)
expr_stmt|;
name|pimv2_addr_len
operator|=
name|pim
operator|->
name|pim_rsv
expr_stmt|;
if|if
condition|(
name|pimv2_addr_len
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"[RFC2117-encoding] "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|PIM_TYPE
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
block|{
name|u_int16_t
name|otype
decl_stmt|,
name|olen
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Hello"
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
while|while
condition|(
name|bp
operator|<
name|ep
condition|)
block|{
name|TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|otype
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|olen
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|4
operator|+
name|olen
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|otype
condition|)
block|{
case|case
literal|1
case|:
comment|/* Hold time */
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (Hold-time "
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
break|break;
comment|/* XXX 			 * draft-ietf-idmr-pimv2-dr-priority-00.txt 			 * says that DR-Priority is option 19. 			 * draft-ietf-pim-v2-sm-00.txt says it's 18. 			 */
case|case
literal|18
case|:
comment|/* DR-Priority */
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (DR-Priority: %d)"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|19
case|:
comment|/* Bidir-Capable */
if|if
condition|(
name|olen
operator|==
literal|4
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (OLD-DR-Priority: %d)"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (bidir-capable)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|20
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (Genid: 0x%08x)"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|21
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (State Refresh Capable"
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|4
index|]
argument_list|)
operator|!=
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" ?0x%x?"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|vflag
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" [Hello option %d]"
argument_list|,
name|otype
argument_list|)
expr_stmt|;
block|}
name|bp
operator|+=
literal|4
operator|+
name|olen
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|1
case|:
block|{
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Register"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|&&
name|bp
operator|+
literal|8
operator|<=
name|ep
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" %s%s"
argument_list|,
name|bp
index|[
literal|4
index|]
operator|&
literal|0x80
condition|?
literal|"B"
else|:
literal|""
argument_list|,
name|bp
index|[
literal|4
index|]
operator|&
literal|0x40
condition|?
literal|"N"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|bp
operator|+=
literal|8
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
comment|/* encapsulated multicast packet */
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|bp
expr_stmt|;
switch|switch
condition|(
name|IP_V
argument_list|(
name|ip
argument_list|)
condition|)
block|{
case|case
literal|4
case|:
comment|/* IPv4 */
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|ip_print
argument_list|(
name|bp
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
literal|6
case|:
comment|/* IPv6 */
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|ip6_print
argument_list|(
name|bp
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" IP ver %d"
argument_list|,
name|IP_V
argument_list|(
name|ip
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
block|}
case|case
literal|2
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Register-Stop"
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" group="
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_group
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"..."
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" source="
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"..."
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
break|break;
case|case
literal|3
case|:
case|case
literal|6
case|:
case|case
literal|7
case|:
block|{
name|u_int8_t
name|ngroup
decl_stmt|;
name|u_int16_t
name|holdtime
decl_stmt|;
name|u_int16_t
name|njoin
decl_stmt|;
name|u_int16_t
name|nprune
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
switch|switch
condition|(
name|PIM_TYPE
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
condition|)
block|{
case|case
literal|3
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Join/Prune"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Graft"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Graft-ACK"
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|PIM_TYPE
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
operator|!=
literal|7
condition|)
block|{
comment|/*not for Graft-ACK*/
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" upstream-neighbor="
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"..."
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
block|}
if|if
condition|(
name|bp
operator|+
literal|4
operator|>
name|ep
condition|)
break|break;
name|ngroup
operator|=
name|bp
index|[
literal|1
index|]
expr_stmt|;
name|holdtime
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" groups=%u"
argument_list|,
name|ngroup
argument_list|)
expr_stmt|;
if|if
condition|(
name|PIM_TYPE
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
operator|!=
literal|7
condition|)
block|{
comment|/*not for Graft-ACK*/
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" holdtime="
argument_list|)
expr_stmt|;
if|if
condition|(
name|holdtime
operator|==
literal|0xffff
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"infty"
argument_list|)
expr_stmt|;
else|else
name|relts_print
argument_list|(
name|holdtime
argument_list|)
expr_stmt|;
block|}
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ngroup
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
goto|goto
name|jp_done
goto|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (group%d: "
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_group
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"...)"
argument_list|)
expr_stmt|;
goto|goto
name|jp_done
goto|;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|4
operator|>
name|ep
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"...)"
argument_list|)
expr_stmt|;
goto|goto
name|jp_done
goto|;
block|}
name|njoin
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|nprune
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" join=%u"
argument_list|,
name|njoin
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|njoin
condition|;
name|j
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_source
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"...)"
argument_list|)
expr_stmt|;
goto|goto
name|jp_done
goto|;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" prune=%u"
argument_list|,
name|nprune
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nprune
condition|;
name|j
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_source
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"...)"
argument_list|)
expr_stmt|;
goto|goto
name|jp_done
goto|;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
name|jp_done
label|:
break|break;
block|}
case|case
literal|4
case|:
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|frpcnt
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Bootstrap"
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
comment|/* Fragment Tag, Hash Mask len, and BSR-priority */
if|if
condition|(
name|bp
operator|+
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|>=
name|ep
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" tag=%x"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" hashmlen=%d"
argument_list|,
name|bp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|1
operator|>=
name|ep
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" BSRprio=%d"
argument_list|,
name|bp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|2
expr_stmt|;
comment|/* Encoded-Unicast-BSR-Address */
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" BSR="
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"..."
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|bp
operator|<
name|ep
condition|;
name|i
operator|++
control|)
block|{
comment|/* Encoded-Group Address */
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (group%d: "
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_group
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"...)"
argument_list|)
expr_stmt|;
goto|goto
name|bs_done
goto|;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
comment|/* RP-Count, Frag RP-Cnt, and rsvd */
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"...)"
argument_list|)
expr_stmt|;
goto|goto
name|bs_done
goto|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" RPcnt=%d"
argument_list|,
name|bp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|1
operator|>=
name|ep
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"...)"
argument_list|)
expr_stmt|;
goto|goto
name|bs_done
goto|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" FRPcnt=%d"
argument_list|,
name|frpcnt
operator|=
name|bp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|frpcnt
operator|&&
name|bp
operator|<
name|ep
condition|;
name|j
operator|++
control|)
block|{
comment|/* each RP info */
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" RP%d="
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"...)"
argument_list|)
expr_stmt|;
goto|goto
name|bs_done
goto|;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|1
operator|>=
name|ep
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"...)"
argument_list|)
expr_stmt|;
goto|goto
name|bs_done
goto|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|",holdtime="
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|EXTRACT_16BITS
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|2
operator|>=
name|ep
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"...)"
argument_list|)
expr_stmt|;
goto|goto
name|bs_done
goto|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|",prio=%d"
argument_list|,
name|bp
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
name|bs_done
label|:
break|break;
block|}
case|case
literal|5
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Assert"
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" group="
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_group
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"..."
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" src="
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"..."
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|8
operator|>
name|ep
condition|)
break|break;
if|if
condition|(
name|bp
index|[
literal|0
index|]
operator|&
literal|0x80
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" RPT"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" pref=%u"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|0
index|]
argument_list|)
operator|&
literal|0x7fffffff
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" metric=%u"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
block|{
name|int
name|i
decl_stmt|,
name|pfxcnt
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Candidate-RP-Advertisement"
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
comment|/* Prefix-Cnt, Priority, and Holdtime */
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" prefix-cnt=%d"
argument_list|,
name|bp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|pfxcnt
operator|=
name|bp
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|1
operator|>=
name|ep
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" prio=%d"
argument_list|,
name|bp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|3
operator|>=
name|ep
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" holdtime="
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
comment|/* Encoded-Unicast-RP-Address */
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" RP="
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"..."
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
comment|/* Encoded-Group Addresses */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pfxcnt
operator|&&
name|bp
operator|<
name|ep
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Group%d="
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_group
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"..."
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
block|}
break|break;
block|}
case|case
literal|9
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" Prune-Refresh"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" src="
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"..."
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" grp="
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_group
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"..."
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" forwarder="
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"..."
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" TUNR "
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|EXTRACT_16BITS
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" [type %d]"
argument_list|,
name|PIM_TYPE
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
name|trunc
label|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"[|pim]"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


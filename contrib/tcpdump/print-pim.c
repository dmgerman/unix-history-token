begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1995, 1996  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code distributions  * retain the above copyright notice and this paragraph in its entirety, (2)  * distributions including binary code include the above copyright notice and  * this paragraph in its entirety in the documentation or other materials  * provided with the distribution, and (3) all advertising materials mentioning  * features or use of this software display the following acknowledgement:  * ``This product includes software developed by the University of California,  * Lawrence Berkeley Laboratory and its contributors.'' Neither the name of  * the University nor the names of its contributors may be used to endorse  * or promote products derived from this software without specific prior  * written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * $FreeBSD$  */
end_comment

begin_define
define|#
directive|define
name|NETDISSECT_REWORKED
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"ip.h"
end_include

begin_define
define|#
directive|define
name|PIMV1_TYPE_QUERY
value|0
end_define

begin_define
define|#
directive|define
name|PIMV1_TYPE_REGISTER
value|1
end_define

begin_define
define|#
directive|define
name|PIMV1_TYPE_REGISTER_STOP
value|2
end_define

begin_define
define|#
directive|define
name|PIMV1_TYPE_JOIN_PRUNE
value|3
end_define

begin_define
define|#
directive|define
name|PIMV1_TYPE_RP_REACHABILITY
value|4
end_define

begin_define
define|#
directive|define
name|PIMV1_TYPE_ASSERT
value|5
end_define

begin_define
define|#
directive|define
name|PIMV1_TYPE_GRAFT
value|6
end_define

begin_define
define|#
directive|define
name|PIMV1_TYPE_GRAFT_ACK
value|7
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|pimv1_type_str
index|[]
init|=
block|{
block|{
name|PIMV1_TYPE_QUERY
block|,
literal|"Query"
block|}
block|,
block|{
name|PIMV1_TYPE_REGISTER
block|,
literal|"Register"
block|}
block|,
block|{
name|PIMV1_TYPE_REGISTER_STOP
block|,
literal|"Register-Stop"
block|}
block|,
block|{
name|PIMV1_TYPE_JOIN_PRUNE
block|,
literal|"Join/Prune"
block|}
block|,
block|{
name|PIMV1_TYPE_RP_REACHABILITY
block|,
literal|"RP-reachable"
block|}
block|,
block|{
name|PIMV1_TYPE_ASSERT
block|,
literal|"Assert"
block|}
block|,
block|{
name|PIMV1_TYPE_GRAFT
block|,
literal|"Graft"
block|}
block|,
block|{
name|PIMV1_TYPE_GRAFT_ACK
block|,
literal|"Graft-ACK"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PIMV2_TYPE_HELLO
value|0
end_define

begin_define
define|#
directive|define
name|PIMV2_TYPE_REGISTER
value|1
end_define

begin_define
define|#
directive|define
name|PIMV2_TYPE_REGISTER_STOP
value|2
end_define

begin_define
define|#
directive|define
name|PIMV2_TYPE_JOIN_PRUNE
value|3
end_define

begin_define
define|#
directive|define
name|PIMV2_TYPE_BOOTSTRAP
value|4
end_define

begin_define
define|#
directive|define
name|PIMV2_TYPE_ASSERT
value|5
end_define

begin_define
define|#
directive|define
name|PIMV2_TYPE_GRAFT
value|6
end_define

begin_define
define|#
directive|define
name|PIMV2_TYPE_GRAFT_ACK
value|7
end_define

begin_define
define|#
directive|define
name|PIMV2_TYPE_CANDIDATE_RP
value|8
end_define

begin_define
define|#
directive|define
name|PIMV2_TYPE_PRUNE_REFRESH
value|9
end_define

begin_define
define|#
directive|define
name|PIMV2_TYPE_DF_ELECTION
value|10
end_define

begin_define
define|#
directive|define
name|PIMV2_TYPE_ECMP_REDIRECT
value|11
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|pimv2_type_values
index|[]
init|=
block|{
block|{
name|PIMV2_TYPE_HELLO
block|,
literal|"Hello"
block|}
block|,
block|{
name|PIMV2_TYPE_REGISTER
block|,
literal|"Register"
block|}
block|,
block|{
name|PIMV2_TYPE_REGISTER_STOP
block|,
literal|"Register Stop"
block|}
block|,
block|{
name|PIMV2_TYPE_JOIN_PRUNE
block|,
literal|"Join / Prune"
block|}
block|,
block|{
name|PIMV2_TYPE_BOOTSTRAP
block|,
literal|"Bootstrap"
block|}
block|,
block|{
name|PIMV2_TYPE_ASSERT
block|,
literal|"Assert"
block|}
block|,
block|{
name|PIMV2_TYPE_GRAFT
block|,
literal|"Graft"
block|}
block|,
block|{
name|PIMV2_TYPE_GRAFT_ACK
block|,
literal|"Graft Acknowledgement"
block|}
block|,
block|{
name|PIMV2_TYPE_CANDIDATE_RP
block|,
literal|"Candidate RP Advertisement"
block|}
block|,
block|{
name|PIMV2_TYPE_PRUNE_REFRESH
block|,
literal|"Prune Refresh"
block|}
block|,
block|{
name|PIMV2_TYPE_DF_ELECTION
block|,
literal|"DF Election"
block|}
block|,
block|{
name|PIMV2_TYPE_ECMP_REDIRECT
block|,
literal|"ECMP Redirect"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PIMV2_HELLO_OPTION_HOLDTIME
value|1
end_define

begin_define
define|#
directive|define
name|PIMV2_HELLO_OPTION_LANPRUNEDELAY
value|2
end_define

begin_define
define|#
directive|define
name|PIMV2_HELLO_OPTION_DR_PRIORITY_OLD
value|18
end_define

begin_define
define|#
directive|define
name|PIMV2_HELLO_OPTION_DR_PRIORITY
value|19
end_define

begin_define
define|#
directive|define
name|PIMV2_HELLO_OPTION_GENID
value|20
end_define

begin_define
define|#
directive|define
name|PIMV2_HELLO_OPTION_REFRESH_CAP
value|21
end_define

begin_define
define|#
directive|define
name|PIMV2_HELLO_OPTION_BIDIR_CAP
value|22
end_define

begin_define
define|#
directive|define
name|PIMV2_HELLO_OPTION_ADDRESS_LIST
value|24
end_define

begin_define
define|#
directive|define
name|PIMV2_HELLO_OPTION_ADDRESS_LIST_OLD
value|65001
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|pimv2_hello_option_values
index|[]
init|=
block|{
block|{
name|PIMV2_HELLO_OPTION_HOLDTIME
block|,
literal|"Hold Time"
block|}
block|,
block|{
name|PIMV2_HELLO_OPTION_LANPRUNEDELAY
block|,
literal|"LAN Prune Delay"
block|}
block|,
block|{
name|PIMV2_HELLO_OPTION_DR_PRIORITY_OLD
block|,
literal|"DR Priority (Old)"
block|}
block|,
block|{
name|PIMV2_HELLO_OPTION_DR_PRIORITY
block|,
literal|"DR Priority"
block|}
block|,
block|{
name|PIMV2_HELLO_OPTION_GENID
block|,
literal|"Generation ID"
block|}
block|,
block|{
name|PIMV2_HELLO_OPTION_REFRESH_CAP
block|,
literal|"State Refresh Capability"
block|}
block|,
block|{
name|PIMV2_HELLO_OPTION_BIDIR_CAP
block|,
literal|"Bi-Directional Capability"
block|}
block|,
block|{
name|PIMV2_HELLO_OPTION_ADDRESS_LIST
block|,
literal|"Address List"
block|}
block|,
block|{
name|PIMV2_HELLO_OPTION_ADDRESS_LIST_OLD
block|,
literal|"Address List (Old)"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PIMV2_REGISTER_FLAG_LEN
value|4
end_define

begin_define
define|#
directive|define
name|PIMV2_REGISTER_FLAG_BORDER
value|0x80000000
end_define

begin_define
define|#
directive|define
name|PIMV2_REGISTER_FLAG_NULL
value|0x40000000
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|pimv2_register_flag_values
index|[]
init|=
block|{
block|{
name|PIMV2_REGISTER_FLAG_BORDER
block|,
literal|"Border"
block|}
block|,
block|{
name|PIMV2_REGISTER_FLAG_NULL
block|,
literal|"Null"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * XXX: We consider a case where IPv6 is not ready yet for portability,  * but PIM dependent defintions should be independent of IPv6...  */
end_comment

begin_struct
struct|struct
name|pim
block|{
name|uint8_t
name|pim_typever
decl_stmt|;
comment|/* upper 4bit: PIM version number; 2 for PIMv2 */
comment|/* lower 4bit: the PIM message type, currently they are: 			 * Hello, Register, Register-Stop, Join/Prune, 			 * Bootstrap, Assert, Graft (PIM-DM only), 			 * Graft-Ack (PIM-DM only), C-RP-Adv 			 */
define|#
directive|define
name|PIM_VER
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xf0)>> 4)
define|#
directive|define
name|PIM_TYPE
parameter_list|(
name|x
parameter_list|)
value|((x)& 0x0f)
name|u_char
name|pim_rsv
decl_stmt|;
comment|/* Reserved */
name|u_short
name|pim_cksum
decl_stmt|;
comment|/* IP style check sum */
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|pimv2_print
parameter_list|(
name|netdissect_options
modifier|*
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|,
name|u_int
name|cksum
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|pimv1_join_prune_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|)
block|{
name|int
name|ngroups
decl_stmt|,
name|njoin
decl_stmt|,
name|nprune
decl_stmt|;
name|int
name|njp
decl_stmt|;
comment|/* If it's a single group and a single source, use 1-line output. */
if|if
condition|(
name|ND_TTEST2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|30
argument_list|)
operator|&&
name|bp
index|[
literal|11
index|]
operator|==
literal|1
operator|&&
operator|(
operator|(
name|njoin
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|20
index|]
argument_list|)
operator|)
operator|+
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|22
index|]
argument_list|)
operator|)
operator|==
literal|1
condition|)
block|{
name|int
name|hold
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" RPF %s "
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|hold
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|hold
operator|!=
literal|180
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"Hold "
operator|)
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|ndo
argument_list|,
name|hold
argument_list|)
expr_stmt|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s (%s/%d, %s"
operator|,
name|njoin
condition|?
literal|"Join"
else|:
literal|"Prune"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|26
index|]
argument_list|)
operator|,
name|bp
index|[
literal|25
index|]
operator|&
literal|0x3f
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|12
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|16
index|]
argument_list|)
operator|!=
literal|0xffffffff
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"/%s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|16
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|") %s%s %s"
operator|,
operator|(
name|bp
index|[
literal|24
index|]
operator|&
literal|0x01
operator|)
condition|?
literal|"Sparse"
else|:
literal|"Dense"
operator|,
operator|(
name|bp
index|[
literal|25
index|]
operator|&
literal|0x80
operator|)
condition|?
literal|" WC"
else|:
literal|""
operator|,
operator|(
name|bp
index|[
literal|25
index|]
operator|&
literal|0x40
operator|)
condition|?
literal|"RP"
else|:
literal|"SPT"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" Upstream Nbr: %s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|6
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" Hold time: "
operator|)
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|ndo
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|6
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<
literal|2
condition|)
return|return;
name|bp
operator|+=
literal|8
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ngroups
operator|=
name|bp
index|[
literal|3
index|]
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
while|while
condition|(
name|ngroups
operator|--
condition|)
block|{
comment|/* 		 * XXX - does the address have length "addrlen" and the 		 * mask length "maddrlen"? 		 */
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tGroup: %s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|4
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|4
index|]
argument_list|)
operator|!=
literal|0xffffffff
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"/%s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|4
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|8
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|njoin
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
name|nprune
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|10
index|]
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" joined: %d pruned: %d"
operator|,
name|njoin
operator|,
name|nprune
operator|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|12
expr_stmt|;
name|len
operator|-=
literal|12
expr_stmt|;
for|for
control|(
name|njp
operator|=
literal|0
init|;
name|njp
operator|<
operator|(
name|njoin
operator|+
name|nprune
operator|)
condition|;
name|njp
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|type
decl_stmt|;
if|if
condition|(
name|njp
operator|<
name|njoin
condition|)
name|type
operator|=
literal|"Join "
expr_stmt|;
else|else
name|type
operator|=
literal|"Prune"
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t%s %s%s%s%s/%d"
operator|,
name|type
operator|,
operator|(
name|bp
index|[
literal|0
index|]
operator|&
literal|0x01
operator|)
condition|?
literal|"Sparse "
else|:
literal|"Dense "
operator|,
operator|(
name|bp
index|[
literal|1
index|]
operator|&
literal|0x80
operator|)
condition|?
literal|"WC "
else|:
literal|""
operator|,
operator|(
name|bp
index|[
literal|1
index|]
operator|&
literal|0x40
operator|)
condition|?
literal|"RP "
else|:
literal|"SPT "
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
operator|,
name|bp
index|[
literal|1
index|]
operator|&
literal|0x3f
operator|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|6
expr_stmt|;
name|len
operator|-=
literal|6
expr_stmt|;
block|}
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|pim]"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|pimv1_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|)
block|{
specifier|register
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
specifier|register
name|u_char
name|type
decl_stmt|;
name|ep
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|ndo
operator|->
name|ndo_snapend
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
return|return;
name|ND_TCHECK
argument_list|(
name|bp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|type
operator|=
name|bp
index|[
literal|1
index|]
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" %s"
operator|,
name|tok2str
argument_list|(
name|pimv1_type_str
argument_list|,
literal|"[type %u]"
argument_list|,
name|type
argument_list|)
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|PIMV1_TYPE_QUERY
case|:
if|if
condition|(
name|ND_TTEST
argument_list|(
name|bp
index|[
literal|8
index|]
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|bp
index|[
literal|8
index|]
operator|>>
literal|4
condition|)
block|{
case|case
literal|0
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" Dense-mode"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" Sparse-mode"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" Sparse-Dense-mode"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" mode-%d"
operator|,
name|bp
index|[
literal|8
index|]
operator|>>
literal|4
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|10
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" (Hold-time "
operator|)
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|ndo
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|10
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|")"
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PIMV1_TYPE_REGISTER
case|:
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|8
index|]
argument_list|,
literal|20
argument_list|)
expr_stmt|;
comment|/* ip header */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" for %s> %s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|20
index|]
argument_list|)
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|24
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PIMV1_TYPE_REGISTER_STOP
case|:
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|12
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" for %s> %s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|8
index|]
argument_list|)
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|12
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PIMV1_TYPE_RP_REACHABILITY
case|:
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|22
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" group %s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|8
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|12
index|]
argument_list|)
operator|!=
literal|0xffffffff
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"/%s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|12
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" RP %s hold "
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|16
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|ndo
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|22
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PIMV1_TYPE_ASSERT
case|:
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|16
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" for %s> %s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|16
index|]
argument_list|)
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|8
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|12
index|]
argument_list|)
operator|!=
literal|0xffffffff
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"/%s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|12
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|24
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" %s pref %d metric %d"
operator|,
operator|(
name|bp
index|[
literal|20
index|]
operator|&
literal|0x80
operator|)
condition|?
literal|"RP-tree"
else|:
literal|"SPT"
operator|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|20
index|]
argument_list|)
operator|&
literal|0x7fffffff
operator|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|24
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PIMV1_TYPE_JOIN_PRUNE
case|:
case|case
name|PIMV1_TYPE_GRAFT
case|:
case|case
name|PIMV1_TYPE_GRAFT_ACK
case|:
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
name|pimv1_join_prune_print
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|8
index|]
argument_list|,
name|len
operator|-
literal|8
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|bp
index|[
literal|4
index|]
operator|>>
literal|4
operator|)
operator|!=
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [v%d]"
operator|,
name|bp
index|[
literal|4
index|]
operator|>>
literal|4
operator|)
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|pim]"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * auto-RP is a cisco protocol, documented at  * ftp://ftpeng.cisco.com/ipmulticast/specs/pim-autorp-spec01.txt  *  * This implements version 1+, dated Sept 9, 1998.  */
end_comment

begin_function
name|void
name|cisco_autorp_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|)
block|{
name|int
name|type
decl_stmt|;
name|int
name|numrps
decl_stmt|;
name|int
name|hold
decl_stmt|;
name|ND_TCHECK
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" auto-rp "
operator|)
argument_list|)
expr_stmt|;
name|type
operator|=
name|bp
index|[
literal|0
index|]
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
literal|0x11
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"candidate-advert"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x12
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"mapping"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"type-0x%02x"
operator|,
name|type
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|ND_TCHECK
argument_list|(
name|bp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|numrps
operator|=
name|bp
index|[
literal|1
index|]
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" Hold "
operator|)
argument_list|)
expr_stmt|;
name|hold
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|hold
condition|)
name|relts_print
argument_list|(
name|ndo
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"FOREVER"
operator|)
argument_list|)
expr_stmt|;
comment|/* Next 4 bytes are reserved. */
name|bp
operator|+=
literal|8
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
comment|/*XXX skip unless -v? */
comment|/* 	 * Rest of packet: 	 * numrps entries of the form: 	 * 32 bits: RP 	 * 6 bits: reserved 	 * 2 bits: PIM version supported, bit 0 is "supports v1", 1 is "v2". 	 * 8 bits: # of entries for this RP 	 * each entry: 7 bits: reserved, 1 bit: negative, 	 *	       8 bits: mask 32 bits: source 	 * lather, rinse, repeat. 	 */
while|while
condition|(
name|numrps
operator|--
condition|)
block|{
name|int
name|nentries
decl_stmt|;
name|char
name|s
decl_stmt|;
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" RP %s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK
argument_list|(
name|bp
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|bp
index|[
literal|4
index|]
operator|&
literal|0x3
condition|)
block|{
case|case
literal|0
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" PIMv?"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" PIMv1"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" PIMv2"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" PIMv1+2"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|bp
index|[
literal|4
index|]
operator|&
literal|0xfc
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [rsvd=0x%02x]"
operator|,
name|bp
index|[
literal|4
index|]
operator|&
literal|0xfc
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK
argument_list|(
name|bp
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|nentries
operator|=
name|bp
index|[
literal|5
index|]
expr_stmt|;
name|bp
operator|+=
literal|6
expr_stmt|;
name|len
operator|-=
literal|6
expr_stmt|;
name|s
operator|=
literal|' '
expr_stmt|;
for|for
control|(
init|;
name|nentries
condition|;
name|nentries
operator|--
control|)
block|{
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%c%s%s/%d"
operator|,
name|s
operator|,
name|bp
index|[
literal|0
index|]
operator|&
literal|1
condition|?
literal|"!"
else|:
literal|""
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
operator|,
name|bp
index|[
literal|1
index|]
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
index|[
literal|0
index|]
operator|&
literal|0x02
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" bidir"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bp
index|[
literal|0
index|]
operator|&
literal|0xfc
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[rsvd=0x%02x]"
operator|,
name|bp
index|[
literal|0
index|]
operator|&
literal|0xfc
operator|)
argument_list|)
expr_stmt|;
block|}
name|s
operator|=
literal|','
expr_stmt|;
name|bp
operator|+=
literal|6
expr_stmt|;
name|len
operator|-=
literal|6
expr_stmt|;
block|}
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|autorp]"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|pim_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|,
name|u_int
name|cksum
parameter_list|)
block|{
specifier|register
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
specifier|register
name|struct
name|pim
modifier|*
name|pim
init|=
operator|(
expr|struct
name|pim
operator|*
operator|)
name|bp
decl_stmt|;
name|ep
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|ndo
operator|->
name|ndo_snapend
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
return|return;
ifdef|#
directive|ifdef
name|notyet
comment|/* currently we see only version and type */
name|ND_TCHECK
argument_list|(
name|pim
operator|->
name|pim_rsv
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|PIM_VER
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
condition|)
block|{
case|case
literal|2
case|:
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"PIMv%u, %s, length %u"
operator|,
name|PIM_VER
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
operator|,
name|tok2str
argument_list|(
name|pimv2_type_values
argument_list|,
literal|"Unknown Type"
argument_list|,
name|PIM_TYPE
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
argument_list|)
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"PIMv%u, length %u\n\t%s"
operator|,
name|PIM_VER
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
operator|,
name|len
operator|,
name|tok2str
argument_list|(
name|pimv2_type_values
argument_list|,
literal|"Unknown Type"
argument_list|,
name|PIM_TYPE
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|pimv2_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|len
argument_list|,
name|cksum
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"PIMv%u, length %u"
operator|,
name|PIM_VER
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*  * PIMv2 uses encoded address representations.  *  * The last PIM-SM I-D before RFC2117 was published specified the  * following representation for unicast addresses.  However, RFC2117  * specified no encoding for unicast addresses with the unicast  * address length specified in the header.  Therefore, we have to  * guess which encoding is being used (Cisco's PIMv2 implementation  * uses the non-RFC encoding).  RFC2117 turns a previously "Reserved"  * field into a 'unicast-address-length-in-bytes' field.  We guess  * that it's the draft encoding if this reserved field is zero.  *  * RFC2362 goes back to the encoded format, and calls the addr length  * field "reserved" again.  *  * The first byte is the address family, from:  *  *    0    Reserved  *    1    IP (IP version 4)  *    2    IP6 (IP version 6)  *    3    NSAP  *    4    HDLC (8-bit multidrop)  *    5    BBN 1822  *    6    802 (includes all 802 media plus Ethernet "canonical format")  *    7    E.163  *    8    E.164 (SMDS, Frame Relay, ATM)  *    9    F.69 (Telex)  *   10    X.121 (X.25, Frame Relay)  *   11    IPX  *   12    Appletalk  *   13    Decnet IV  *   14    Banyan Vines  *   15    E.164 with NSAP format subaddress  *  * In addition, the second byte is an "Encoding".  0 is the default  * encoding for the address family, and no other encodings are currently  * specified.  *  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|pimv2_addr_len
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
name|pimv2_addrtype
block|{
name|pimv2_unicast
block|,
name|pimv2_group
block|,
name|pimv2_source
block|}
enum|;
end_enum

begin_comment
comment|/*  0                   1                   2                   3  *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * | Addr Family   | Encoding Type |     Unicast Address           |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+++++++  *  0                   1                   2                   3  *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * | Addr Family   | Encoding Type |   Reserved    |  Mask Len     |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                Group multicast Address                        |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  *  0                   1                   2                   3  *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * | Addr Family   | Encoding Type | Rsrvd   |S|W|R|  Mask Len     |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                        Source Address                         |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  */
end_comment

begin_function
specifier|static
name|int
name|pimv2_addr_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|enum
name|pimv2_addrtype
name|at
parameter_list|,
name|int
name|silent
parameter_list|)
block|{
name|int
name|af
decl_stmt|;
name|int
name|len
decl_stmt|,
name|hdrlen
decl_stmt|;
name|ND_TCHECK
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|pimv2_addr_len
operator|==
literal|0
condition|)
block|{
name|ND_TCHECK
argument_list|(
name|bp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|bp
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|1
case|:
name|af
operator|=
name|AF_INET
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
literal|2
case|:
name|af
operator|=
name|AF_INET6
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|bp
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|hdrlen
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|pimv2_addr_len
condition|)
block|{
case|case
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
case|:
name|af
operator|=
name|AF_INET
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
case|:
name|af
operator|=
name|AF_INET6
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
return|return
operator|-
literal|1
return|;
break|break;
block|}
name|len
operator|=
name|pimv2_addr_len
expr_stmt|;
name|hdrlen
operator|=
literal|0
expr_stmt|;
block|}
name|bp
operator|+=
name|hdrlen
expr_stmt|;
switch|switch
condition|(
name|at
condition|)
block|{
case|case
name|pimv2_unicast
case|:
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|af
operator|==
name|AF_INET
condition|)
block|{
if|if
condition|(
operator|!
name|silent
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|INET6
elseif|else
if|if
condition|(
name|af
operator|==
name|AF_INET6
condition|)
block|{
if|if
condition|(
operator|!
name|silent
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|ip6addr_string
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|hdrlen
operator|+
name|len
return|;
case|case
name|pimv2_group
case|:
case|case
name|pimv2_source
case|:
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
name|len
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|af
operator|==
name|AF_INET
condition|)
block|{
if|if
condition|(
operator|!
name|silent
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|bp
operator|+
literal|2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
index|[
literal|1
index|]
operator|!=
literal|32
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"/%u"
operator|,
name|bp
index|[
literal|1
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|INET6
elseif|else
if|if
condition|(
name|af
operator|==
name|AF_INET6
condition|)
block|{
if|if
condition|(
operator|!
name|silent
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|ip6addr_string
argument_list|(
name|ndo
argument_list|,
name|bp
operator|+
literal|2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
index|[
literal|1
index|]
operator|!=
literal|128
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"/%u"
operator|,
name|bp
index|[
literal|1
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|bp
index|[
literal|0
index|]
operator|&&
operator|!
name|silent
condition|)
block|{
if|if
condition|(
name|at
operator|==
name|pimv2_group
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"(0x%02x)"
operator|,
name|bp
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"(%s%s%s"
operator|,
name|bp
index|[
literal|0
index|]
operator|&
literal|0x04
condition|?
literal|"S"
else|:
literal|""
operator|,
name|bp
index|[
literal|0
index|]
operator|&
literal|0x02
condition|?
literal|"W"
else|:
literal|""
operator|,
name|bp
index|[
literal|0
index|]
operator|&
literal|0x01
condition|?
literal|"R"
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
index|[
literal|0
index|]
operator|&
literal|0xf8
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"+0x%02x"
operator|,
name|bp
index|[
literal|0
index|]
operator|&
literal|0xf8
operator|)
argument_list|)
expr_stmt|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|")"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|hdrlen
operator|+
literal|2
operator|+
name|len
return|;
default|default:
return|return
operator|-
literal|1
return|;
block|}
name|trunc
label|:
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pimv2_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|,
name|u_int
name|cksum
parameter_list|)
block|{
specifier|register
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
specifier|register
name|struct
name|pim
modifier|*
name|pim
init|=
operator|(
expr|struct
name|pim
operator|*
operator|)
name|bp
decl_stmt|;
name|int
name|advance
decl_stmt|;
name|ep
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|ndo
operator|->
name|ndo_snapend
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
return|return;
if|if
condition|(
name|ep
operator|>
name|bp
operator|+
name|len
condition|)
name|ep
operator|=
name|bp
operator|+
name|len
expr_stmt|;
name|ND_TCHECK
argument_list|(
name|pim
operator|->
name|pim_rsv
argument_list|)
expr_stmt|;
name|pimv2_addr_len
operator|=
name|pim
operator|->
name|pim_rsv
expr_stmt|;
if|if
condition|(
name|pimv2_addr_len
operator|!=
literal|0
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", RFC2117-encoding"
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", cksum 0x%04x "
operator|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|pim
operator|->
name|pim_cksum
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|pim
operator|->
name|pim_cksum
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"(unverified)"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"(%scorrect)"
operator|,
name|ND_TTEST2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
operator|&&
name|cksum
condition|?
literal|"in"
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|PIM_TYPE
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
condition|)
block|{
case|case
name|PIMV2_TYPE_HELLO
case|:
block|{
name|uint16_t
name|otype
decl_stmt|,
name|olen
decl_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
while|while
condition|(
name|bp
operator|<
name|ep
condition|)
block|{
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|otype
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|olen
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|4
operator|+
name|olen
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t  %s Option (%u), length %u, Value: "
operator|,
name|tok2str
argument_list|(
name|pimv2_hello_option_values
argument_list|,
literal|"Unknown"
argument_list|,
name|otype
argument_list|)
operator|,
name|otype
operator|,
name|olen
operator|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
switch|switch
condition|(
name|otype
condition|)
block|{
case|case
name|PIMV2_HELLO_OPTION_HOLDTIME
case|:
name|relts_print
argument_list|(
name|ndo
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PIMV2_HELLO_OPTION_LANPRUNEDELAY
case|:
if|if
condition|(
name|olen
operator|!=
literal|4
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"ERROR: Option Length != 4 Bytes (%u)"
operator|,
name|olen
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
name|t_bit
decl_stmt|;
name|uint16_t
name|lan_delay
decl_stmt|,
name|override_interval
decl_stmt|;
name|lan_delay
operator|=
name|EXTRACT_16BITS
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|override_interval
operator|=
name|EXTRACT_16BITS
argument_list|(
name|bp
operator|+
literal|2
argument_list|)
expr_stmt|;
name|t_bit
operator|=
operator|(
name|lan_delay
operator|&
literal|0x8000
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|lan_delay
operator|&=
operator|~
literal|0x8000
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    T-bit=%d, LAN delay %dms, Override interval %dms"
operator|,
name|t_bit
operator|,
name|lan_delay
operator|,
name|override_interval
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PIMV2_HELLO_OPTION_DR_PRIORITY_OLD
case|:
case|case
name|PIMV2_HELLO_OPTION_DR_PRIORITY
case|:
switch|switch
condition|(
name|olen
condition|)
block|{
case|case
literal|0
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"Bi-Directional Capability (Old)"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|bp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"ERROR: Option Length != 4 Bytes (%u)"
operator|,
name|olen
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|PIMV2_HELLO_OPTION_GENID
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"0x%08x"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|bp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PIMV2_HELLO_OPTION_REFRESH_CAP
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"v%d"
operator|,
operator|*
name|bp
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|(
name|bp
operator|+
literal|1
operator|)
operator|!=
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", interval "
operator|)
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|ndo
argument_list|,
operator|*
operator|(
name|bp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|EXTRACT_16BITS
argument_list|(
name|bp
operator|+
literal|2
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" ?0x%04x?"
operator|,
name|EXTRACT_16BITS
argument_list|(
name|bp
operator|+
literal|2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PIMV2_HELLO_OPTION_BIDIR_CAP
case|:
break|break;
case|case
name|PIMV2_HELLO_OPTION_ADDRESS_LIST_OLD
case|:
case|case
name|PIMV2_HELLO_OPTION_ADDRESS_LIST
case|:
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
condition|)
block|{
specifier|const
name|u_char
modifier|*
name|ptr
init|=
name|bp
decl_stmt|;
while|while
condition|(
name|ptr
operator|<
operator|(
name|bp
operator|+
name|olen
operator|)
condition|)
block|{
name|int
name|advance
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    "
operator|)
argument_list|)
expr_stmt|;
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|ptr
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|ptr
operator|+=
name|advance
expr_stmt|;
block|}
block|}
break|break;
default|default:
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
literal|"\n\t    "
argument_list|,
name|olen
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* do we want to see an additionally hexdump ? */
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
literal|"\n\t    "
argument_list|,
name|olen
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|olen
expr_stmt|;
block|}
break|break;
block|}
case|case
name|PIMV2_TYPE_REGISTER
case|:
block|{
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
operator|(
name|bp
operator|+
literal|4
operator|)
argument_list|,
name|PIMV2_REGISTER_FLAG_LEN
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Flags [ %s ]\n\t"
operator|,
name|tok2str
argument_list|(
name|pimv2_register_flag_values
argument_list|,
literal|"none"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|bp
operator|+
literal|4
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|8
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
comment|/* encapsulated multicast packet */
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|bp
expr_stmt|;
switch|switch
condition|(
name|IP_V
argument_list|(
name|ip
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
comment|/* Null header */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"IP-Null-header %s> %s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|ip
operator|->
name|ip_src
argument_list|)
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|ip
operator|->
name|ip_dst
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* IPv4 */
name|ip_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* IPv6 */
name|ip6_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"IP ver %d"
operator|,
name|IP_V
argument_list|(
name|ip
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
block|}
case|case
name|PIMV2_TYPE_REGISTER_STOP
case|:
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" group="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_group
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" source="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
break|break;
case|case
name|PIMV2_TYPE_JOIN_PRUNE
case|:
case|case
name|PIMV2_TYPE_GRAFT
case|:
case|case
name|PIMV2_TYPE_GRAFT_ACK
case|:
comment|/*          * 0                   1                   2                   3          *   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          *  |PIM Ver| Type  | Addr length   |           Checksum            |          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          *  |             Unicast-Upstream Neighbor Address                 |          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          *  |  Reserved     | Num groups    |          Holdtime             |          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          *  |            Encoded-Multicast Group Address-1                  |          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          *  |   Number of Joined  Sources   |   Number of Pruned Sources    |          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          *  |               Encoded-Joined Source Address-1                 |          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          *  |                             .                                 |          *  |                             .                                 |          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          *  |               Encoded-Joined Source Address-n                 |          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          *  |               Encoded-Pruned Source Address-1                 |          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          *  |                             .                                 |          *  |                             .                                 |          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          *  |               Encoded-Pruned Source Address-n                 |          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          *  |                           .                                   |          *  |                           .                                   |          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          *  |                Encoded-Multicast Group Address-n              |          *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          */
block|{
name|uint8_t
name|ngroup
decl_stmt|;
name|uint16_t
name|holdtime
decl_stmt|;
name|uint16_t
name|njoin
decl_stmt|;
name|uint16_t
name|nprune
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|PIM_TYPE
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
operator|!=
literal|7
condition|)
block|{
comment|/*not for Graft-ACK*/
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", upstream-neighbor: "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
block|}
if|if
condition|(
name|bp
operator|+
literal|4
operator|>
name|ep
condition|)
break|break;
name|ngroup
operator|=
name|bp
index|[
literal|1
index|]
expr_stmt|;
name|holdtime
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t  %u group(s)"
operator|,
name|ngroup
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PIM_TYPE
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
operator|!=
literal|7
condition|)
block|{
comment|/*not for Graft-ACK*/
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", holdtime: "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|holdtime
operator|==
literal|0xffff
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"infinite"
operator|)
argument_list|)
expr_stmt|;
else|else
name|relts_print
argument_list|(
name|ndo
argument_list|,
name|holdtime
argument_list|)
expr_stmt|;
block|}
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ngroup
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
goto|goto
name|jp_done
goto|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    group #%u: "
operator|,
name|i
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_group
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"...)"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|jp_done
goto|;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|4
operator|>
name|ep
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"...)"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|jp_done
goto|;
block|}
name|njoin
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|nprune
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", joined sources: %u, pruned sources: %u"
operator|,
name|njoin
operator|,
name|nprune
operator|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|njoin
condition|;
name|j
operator|++
control|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      joined source #%u: "
operator|,
name|j
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_source
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"...)"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|jp_done
goto|;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nprune
condition|;
name|j
operator|++
control|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      pruned source #%u: "
operator|,
name|j
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_source
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"...)"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|jp_done
goto|;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
block|}
block|}
name|jp_done
label|:
break|break;
block|}
case|case
name|PIMV2_TYPE_BOOTSTRAP
case|:
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|frpcnt
decl_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
comment|/* Fragment Tag, Hash Mask len, and BSR-priority */
if|if
condition|(
name|bp
operator|+
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
operator|>=
name|ep
condition|)
break|break;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" tag=%x"
operator|,
name|EXTRACT_16BITS
argument_list|(
name|bp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" hashmlen=%d"
operator|,
name|bp
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|1
operator|>=
name|ep
condition|)
break|break;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" BSRprio=%d"
operator|,
name|bp
index|[
literal|1
index|]
operator|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|2
expr_stmt|;
comment|/* Encoded-Unicast-BSR-Address */
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" BSR="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|bp
operator|<
name|ep
condition|;
name|i
operator|++
control|)
block|{
comment|/* Encoded-Group Address */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" (group%d: "
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_group
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"...)"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|bs_done
goto|;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
comment|/* RP-Count, Frag RP-Cnt, and rsvd */
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"...)"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|bs_done
goto|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" RPcnt=%d"
operator|,
name|bp
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|1
operator|>=
name|ep
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"...)"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|bs_done
goto|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" FRPcnt=%d"
operator|,
name|frpcnt
operator|=
name|bp
index|[
literal|1
index|]
operator|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|frpcnt
operator|&&
name|bp
operator|<
name|ep
condition|;
name|j
operator|++
control|)
block|{
comment|/* each RP info */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" RP%d="
operator|,
name|j
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"...)"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|bs_done
goto|;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|1
operator|>=
name|ep
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"...)"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|bs_done
goto|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|",holdtime="
operator|)
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|ndo
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|2
operator|>=
name|ep
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"...)"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|bs_done
goto|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|",prio=%d"
operator|,
name|bp
index|[
literal|2
index|]
operator|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|")"
operator|)
argument_list|)
expr_stmt|;
block|}
name|bs_done
label|:
break|break;
block|}
case|case
name|PIMV2_TYPE_ASSERT
case|:
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" group="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_group
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" src="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|len
operator|-=
name|advance
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|8
operator|>
name|ep
condition|)
break|break;
if|if
condition|(
name|bp
index|[
literal|0
index|]
operator|&
literal|0x80
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" RPT"
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" pref=%u"
operator|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|0
index|]
argument_list|)
operator|&
literal|0x7fffffff
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" metric=%u"
operator|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|bp
index|[
literal|4
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PIMV2_TYPE_CANDIDATE_RP
case|:
block|{
name|int
name|i
decl_stmt|,
name|pfxcnt
decl_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
comment|/* Prefix-Cnt, Priority, and Holdtime */
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" prefix-cnt=%d"
operator|,
name|bp
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
name|pfxcnt
operator|=
name|bp
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|1
operator|>=
name|ep
condition|)
break|break;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" prio=%d"
operator|,
name|bp
index|[
literal|1
index|]
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|+
literal|3
operator|>=
name|ep
condition|)
break|break;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" holdtime="
operator|)
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|ndo
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
comment|/* Encoded-Unicast-RP-Address */
if|if
condition|(
name|bp
operator|>=
name|ep
condition|)
break|break;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" RP="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
comment|/* Encoded-Group Addresses */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pfxcnt
operator|&&
name|bp
operator|<
name|ep
condition|;
name|i
operator|++
control|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" Group%d="
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_group
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
block|}
break|break;
block|}
case|case
name|PIMV2_TYPE_PRUNE_REFRESH
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" src="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" grp="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_group
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" forwarder="
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|advance
operator|=
name|pimv2_addr_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|pimv2_unicast
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"..."
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|bp
operator|+=
name|advance
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" TUNR "
operator|)
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|ndo
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [type %d]"
operator|,
name|PIM_TYPE
argument_list|(
name|pim
operator|->
name|pim_typever
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|pim]"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Local Variables:  * c-style: whitesmith  * c-basic-offset: 8  * End:  */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1988, 1989, 1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code distributions  * retain the above copyright notice and this paragraph in its entirety, (2)  * distributions including binary code include the above copyright notice and  * this paragraph in its entirety in the documentation or other materials  * provided with the distribution, and (3) all advertising materials mentioning  * features or use of this software display the following acknowledgement:  * ``This product includes software developed by the University of California,  * Lawrence Berkeley Laboratory and its contributors.'' Neither the name of  * the University nor the names of its contributors may be used to endorse  * or promote products derived from this software without specific prior  * written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-lcp.c,v 1.9 2000/10/06 04:23:12 guy Exp $ (LBL)"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_comment
comment|/* must come after interface.h */
end_comment

begin_include
include|#
directive|include
file|"ppp.h"
end_include

begin_comment
comment|/* Codes */
end_comment

begin_enum
enum|enum
block|{
name|LCP_CONFREQ
init|=
literal|1
block|,
name|LCP_CONFACK
init|=
literal|2
block|,
name|LCP_CONFNAK
init|=
literal|3
block|,
name|LCP_CONFREJ
init|=
literal|4
block|,
name|LCP_TERMREQ
init|=
literal|5
block|,
name|LCP_TERMACK
init|=
literal|6
block|,
name|LCP_CODEREJ
init|=
literal|7
block|,
name|LCP_PROTREJ
init|=
literal|8
block|,
name|LCP_ECHOREQ
init|=
literal|9
block|,
name|LCP_ECHOREP
init|=
literal|10
block|,
name|LCP_DISCARD
init|=
literal|11
block|}
enum|;
end_enum

begin_decl_stmt
specifier|static
name|struct
name|tok
name|lcpcode2str
index|[]
init|=
block|{
block|{
name|LCP_CONFREQ
block|,
literal|"ConfReq"
block|}
block|,
block|{
name|LCP_CONFACK
block|,
literal|"ConfAck"
block|}
block|,
block|{
name|LCP_CONFNAK
block|,
literal|"ConfNak"
block|}
block|,
block|{
name|LCP_CONFREJ
block|,
literal|"ConfRej"
block|}
block|,
block|{
name|LCP_TERMREQ
block|,
literal|"TermReq"
block|}
block|,
block|{
name|LCP_TERMACK
block|,
literal|"TermAck"
block|}
block|,
block|{
name|LCP_CODEREJ
block|,
literal|"CodeRej"
block|}
block|,
block|{
name|LCP_PROTREJ
block|,
literal|"ProtRej"
block|}
block|,
block|{
name|LCP_ECHOREQ
block|,
literal|"EchoReq"
block|}
block|,
block|{
name|LCP_ECHOREP
block|,
literal|"EchoRep"
block|}
block|,
block|{
name|LCP_DISCARD
block|,
literal|"Discard"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
block|{
name|LCP_RESERVED
init|=
literal|0
block|,
name|LCP_MRU
init|=
literal|1
block|,
name|LCP_ASYNCMAP
init|=
literal|2
block|,
name|LCP_AUTHPROTO
init|=
literal|3
block|,
name|LCP_QUALPROTO
init|=
literal|4
block|,
name|LCP_MAGICNUM
init|=
literal|5
block|,
name|LCP_PCOMP
init|=
literal|7
block|,
name|LCP_ACFCOMP
init|=
literal|8
block|,
name|LCP_CALLBACK
init|=
literal|13
block|}
enum|;
end_enum

begin_decl_stmt
specifier|static
name|struct
name|tok
name|lcpoption2str
index|[]
init|=
block|{
block|{
name|LCP_RESERVED
block|,
literal|"reserved"
block|}
block|,
block|{
name|LCP_MRU
block|,
literal|"mru"
block|}
block|,
block|{
name|LCP_ASYNCMAP
block|,
literal|"asyncmap"
block|}
block|,
block|{
name|LCP_AUTHPROTO
block|,
literal|"auth"
block|}
block|,
block|{
name|LCP_QUALPROTO
block|,
literal|"qual"
block|}
block|,
block|{
name|LCP_MAGICNUM
block|,
literal|"magic"
block|}
block|,
block|{
name|LCP_PCOMP
block|,
literal|"pcomp"
block|}
block|,
block|{
name|LCP_ACFCOMP
block|,
literal|"acfcomp"
block|}
block|,
block|{
name|LCP_CALLBACK
block|,
literal|"callback"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tok
name|lcpauth2str
index|[]
init|=
block|{
block|{
literal|0xc023
block|,
literal|"PAP"
block|}
block|,
block|{
literal|0xc223
block|,
literal|"CHAP"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tok
name|lcpqual2str
index|[]
init|=
block|{
block|{
literal|0xc025
block|,
literal|"LQR"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tok
name|lcpchap2str
index|[]
init|=
block|{
block|{
literal|0x05
block|,
literal|"MD5"
block|}
block|,
block|{
literal|0x80
block|,
literal|"MS"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|lcp_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
name|u_short
name|lcp_code
decl_stmt|,
name|lcp_id
decl_stmt|,
name|lcp_length
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|lcp_data
decl_stmt|;
name|lcp_data
operator|=
name|bp
operator|+
literal|4
expr_stmt|;
if|if
condition|(
name|snapend
operator|<
name|lcp_data
condition|)
block|{
name|printf
argument_list|(
literal|" [LCP|]"
argument_list|)
expr_stmt|;
return|return;
block|}
name|lcp_code
operator|=
name|bp
index|[
literal|0
index|]
expr_stmt|;
name|lcp_id
operator|=
name|bp
index|[
literal|1
index|]
expr_stmt|;
name|lcp_length
operator|=
name|EXTRACT_16BITS
argument_list|(
name|bp
operator|+
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"LCP %s id=0x%x"
argument_list|,
name|tok2str
argument_list|(
name|lcpcode2str
argument_list|,
literal|"LCP-#%d"
argument_list|,
name|lcp_code
argument_list|)
argument_list|,
name|lcp_id
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|lcp_code
condition|)
block|{
case|case
name|LCP_CONFREQ
case|:
case|case
name|LCP_CONFACK
case|:
case|case
name|LCP_CONFNAK
case|:
case|case
name|LCP_CONFREJ
case|:
comment|/* Print Options */
block|{
name|u_char
name|lcpopt_type
decl_stmt|,
name|lcpopt_length
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|p
init|=
name|lcp_data
decl_stmt|;
while|while
condition|(
name|p
operator|+
literal|2
operator|<
name|lcp_data
operator|+
name|lcp_length
operator|&&
name|p
operator|+
literal|2
operator|<
name|snapend
condition|)
block|{
name|lcpopt_type
operator|=
name|p
index|[
literal|0
index|]
expr_stmt|;
name|lcpopt_length
operator|=
name|p
index|[
literal|1
index|]
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
name|printf
argument_list|(
literal|"<%s "
argument_list|,
name|tok2str
argument_list|(
name|lcpoption2str
argument_list|,
literal|"option-#%d"
argument_list|,
name|lcpopt_type
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcpopt_length
condition|)
switch|switch
condition|(
name|lcpopt_type
condition|)
block|{
case|case
name|LCP_MRU
case|:
if|if
condition|(
name|snapend
operator|<
name|p
operator|+
literal|2
condition|)
return|return;
name|printf
argument_list|(
literal|"%d"
argument_list|,
name|ntohs
argument_list|(
operator|*
operator|(
name|u_short
operator|*
operator|)
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcpopt_length
operator|!=
literal|4
condition|)
name|printf
argument_list|(
literal|" len=%d!"
argument_list|,
name|lcpopt_length
argument_list|)
expr_stmt|;
break|break;
case|case
name|LCP_AUTHPROTO
case|:
if|if
condition|(
name|snapend
operator|<
name|p
operator|+
literal|2
condition|)
return|return;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|tok2str
argument_list|(
name|lcpauth2str
argument_list|,
literal|"AUTH-%#x"
argument_list|,
name|ntohs
argument_list|(
operator|*
operator|(
name|u_short
operator|*
operator|)
name|p
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcpopt_length
operator|<
literal|4
condition|)
name|printf
argument_list|(
literal|" len=%d!"
argument_list|,
name|lcpopt_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcpopt_length
operator|>=
literal|5
operator|&&
name|p
operator|<
name|snapend
condition|)
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|tok2str
argument_list|(
name|lcpchap2str
argument_list|,
literal|"%#x"
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|LCP_QUALPROTO
case|:
if|if
condition|(
name|snapend
operator|<
name|p
operator|+
literal|2
condition|)
return|return;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|tok2str
argument_list|(
name|lcpqual2str
argument_list|,
literal|"QUAL-%#x"
argument_list|,
name|ntohs
argument_list|(
operator|*
operator|(
name|u_short
operator|*
operator|)
name|p
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcpopt_length
operator|<
literal|4
condition|)
name|printf
argument_list|(
literal|" len=%d!"
argument_list|,
name|lcpopt_length
argument_list|)
expr_stmt|;
comment|/* Print data field of auth? */
break|break;
case|case
name|LCP_ASYNCMAP
case|:
case|case
name|LCP_MAGICNUM
case|:
if|if
condition|(
name|snapend
operator|<
name|p
operator|+
literal|4
condition|)
return|return;
name|printf
argument_list|(
literal|"%#x"
argument_list|,
operator|(
name|unsigned
operator|)
name|ntohl
argument_list|(
operator|*
operator|(
name|u_long
operator|*
operator|)
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcpopt_length
operator|!=
literal|6
condition|)
name|printf
argument_list|(
literal|" len=%d!"
argument_list|,
name|lcpopt_length
argument_list|)
expr_stmt|;
break|break;
case|case
name|LCP_PCOMP
case|:
case|case
name|LCP_ACFCOMP
case|:
case|case
name|LCP_RESERVED
case|:
if|if
condition|(
name|lcpopt_length
operator|!=
literal|2
condition|)
name|printf
argument_list|(
literal|" len=%d!"
argument_list|,
name|lcpopt_length
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|lcpopt_length
operator|!=
literal|2
condition|)
name|printf
argument_list|(
literal|" len=%d"
argument_list|,
name|lcpopt_length
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
name|p
operator|+=
name|lcpopt_length
operator|-
literal|2
expr_stmt|;
block|}
block|}
break|break;
case|case
name|LCP_ECHOREQ
case|:
case|case
name|LCP_ECHOREP
case|:
case|case
name|LCP_DISCARD
case|:
if|if
condition|(
name|snapend
operator|<
name|lcp_data
operator|+
literal|4
condition|)
return|return;
name|printf
argument_list|(
literal|" magic=%#x"
argument_list|,
operator|(
name|unsigned
operator|)
name|ntohl
argument_list|(
operator|*
operator|(
name|u_long
operator|*
operator|)
name|lcp_data
argument_list|)
argument_list|)
expr_stmt|;
name|lcp_data
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
name|LCP_PROTREJ
case|:
if|if
condition|(
name|snapend
operator|<
name|lcp_data
operator|+
literal|2
condition|)
return|return;
name|printf
argument_list|(
literal|" prot=%s"
argument_list|,
name|tok2str
argument_list|(
name|ppptype2str
argument_list|,
literal|"PROT-%#x"
argument_list|,
name|ntohs
argument_list|(
operator|*
operator|(
name|u_short
operator|*
operator|)
name|lcp_data
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* TODO print rejected packet too ? */
break|break;
case|case
name|LCP_CODEREJ
case|:
if|if
condition|(
name|snapend
operator|<
name|lcp_data
operator|+
literal|4
condition|)
return|return;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|lcp_print
argument_list|(
name|lcp_data
argument_list|,
operator|(
name|lcp_length
operator|+
name|lcp_data
operator|>
name|snapend
condition|?
name|snapend
operator|-
name|lcp_data
else|:
name|lcp_length
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|LCP_TERMREQ
case|:
case|case
name|LCP_TERMACK
case|:
break|break;
default|default:
break|break;
block|}
return|return;
block|}
end_function

end_unit


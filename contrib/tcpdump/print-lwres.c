begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2001 WIDE Project.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the project nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
name|_U_
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-lwres.c,v 1.13 2004/03/24 01:54:29 guy Exp $ (LBL)"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|"nameser.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_comment
comment|/* must come after interface.h */
end_comment

begin_comment
comment|/* BIND9 lib/lwres/include/lwres */
end_comment

begin_typedef
typedef|typedef
name|u_int32_t
name|lwres_uint32_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|u_int16_t
name|lwres_uint16_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|u_int8_t
name|lwres_uint8_t
typedef|;
end_typedef

begin_struct
struct|struct
name|lwres_lwpacket
block|{
name|lwres_uint32_t
name|length
decl_stmt|;
name|lwres_uint16_t
name|version
decl_stmt|;
name|lwres_uint16_t
name|pktflags
decl_stmt|;
name|lwres_uint32_t
name|serial
decl_stmt|;
name|lwres_uint32_t
name|opcode
decl_stmt|;
name|lwres_uint32_t
name|result
decl_stmt|;
name|lwres_uint32_t
name|recvlength
decl_stmt|;
name|lwres_uint16_t
name|authtype
decl_stmt|;
name|lwres_uint16_t
name|authlength
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|LWRES_LWPACKETFLAG_RESPONSE
value|0x0001U
end_define

begin_comment
comment|/* if set, pkt is a response */
end_comment

begin_define
define|#
directive|define
name|LWRES_LWPACKETVERSION_0
value|0
end_define

begin_define
define|#
directive|define
name|LWRES_FLAG_TRUSTNOTREQUIRED
value|0x00000001U
end_define

begin_define
define|#
directive|define
name|LWRES_FLAG_SECUREDATA
value|0x00000002U
end_define

begin_comment
comment|/*  * no-op  */
end_comment

begin_define
define|#
directive|define
name|LWRES_OPCODE_NOOP
value|0x00000000U
end_define

begin_typedef
typedef|typedef
struct|struct
block|{
comment|/* public */
name|lwres_uint16_t
name|datalength
decl_stmt|;
comment|/* data follows */
block|}
name|lwres_nooprequest_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
comment|/* public */
name|lwres_uint16_t
name|datalength
decl_stmt|;
comment|/* data follows */
block|}
name|lwres_noopresponse_t
typedef|;
end_typedef

begin_comment
comment|/*  * get addresses by name  */
end_comment

begin_define
define|#
directive|define
name|LWRES_OPCODE_GETADDRSBYNAME
value|0x00010001U
end_define

begin_typedef
typedef|typedef
name|struct
name|lwres_addr
name|lwres_addr_t
typedef|;
end_typedef

begin_struct
struct|struct
name|lwres_addr
block|{
name|lwres_uint32_t
name|family
decl_stmt|;
name|lwres_uint16_t
name|length
decl_stmt|;
comment|/* address folows */
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
struct|struct
block|{
comment|/* public */
name|lwres_uint32_t
name|flags
decl_stmt|;
name|lwres_uint32_t
name|addrtypes
decl_stmt|;
name|lwres_uint16_t
name|namelen
decl_stmt|;
comment|/* name follows */
block|}
name|lwres_gabnrequest_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
comment|/* public */
name|lwres_uint32_t
name|flags
decl_stmt|;
name|lwres_uint16_t
name|naliases
decl_stmt|;
name|lwres_uint16_t
name|naddrs
decl_stmt|;
name|lwres_uint16_t
name|realnamelen
decl_stmt|;
comment|/* aliases follows */
comment|/* addrs follows */
comment|/* realname follows */
block|}
name|lwres_gabnresponse_t
typedef|;
end_typedef

begin_comment
comment|/*  * get name by address  */
end_comment

begin_define
define|#
directive|define
name|LWRES_OPCODE_GETNAMEBYADDR
value|0x00010002U
end_define

begin_typedef
typedef|typedef
struct|struct
block|{
comment|/* public */
name|lwres_uint32_t
name|flags
decl_stmt|;
name|lwres_addr_t
name|addr
decl_stmt|;
comment|/* addr body follows */
block|}
name|lwres_gnbarequest_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
comment|/* public */
name|lwres_uint32_t
name|flags
decl_stmt|;
name|lwres_uint16_t
name|naliases
decl_stmt|;
name|lwres_uint16_t
name|realnamelen
decl_stmt|;
comment|/* aliases follows */
comment|/* realname follows */
block|}
name|lwres_gnbaresponse_t
typedef|;
end_typedef

begin_comment
comment|/*  * get rdata by name  */
end_comment

begin_define
define|#
directive|define
name|LWRES_OPCODE_GETRDATABYNAME
value|0x00010003U
end_define

begin_typedef
typedef|typedef
struct|struct
block|{
comment|/* public */
name|lwres_uint32_t
name|flags
decl_stmt|;
name|lwres_uint16_t
name|rdclass
decl_stmt|;
name|lwres_uint16_t
name|rdtype
decl_stmt|;
name|lwres_uint16_t
name|namelen
decl_stmt|;
comment|/* name follows */
block|}
name|lwres_grbnrequest_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
comment|/* public */
name|lwres_uint32_t
name|flags
decl_stmt|;
name|lwres_uint16_t
name|rdclass
decl_stmt|;
name|lwres_uint16_t
name|rdtype
decl_stmt|;
name|lwres_uint32_t
name|ttl
decl_stmt|;
name|lwres_uint16_t
name|nrdatas
decl_stmt|;
name|lwres_uint16_t
name|nsigs
decl_stmt|;
comment|/* realname here (len + name) */
comment|/* rdata here (len + name) */
comment|/* signatures here (len + name) */
block|}
name|lwres_grbnresponse_t
typedef|;
end_typedef

begin_define
define|#
directive|define
name|LWRDATA_VALIDATED
value|0x00000001
end_define

begin_define
define|#
directive|define
name|LWRES_ADDRTYPE_V4
value|0x00000001U
end_define

begin_comment
comment|/* ipv4 */
end_comment

begin_define
define|#
directive|define
name|LWRES_ADDRTYPE_V6
value|0x00000002U
end_define

begin_comment
comment|/* ipv6 */
end_comment

begin_define
define|#
directive|define
name|LWRES_MAX_ALIASES
value|16
end_define

begin_comment
comment|/* max # of aliases */
end_comment

begin_define
define|#
directive|define
name|LWRES_MAX_ADDRS
value|64
end_define

begin_comment
comment|/* max # of addrs */
end_comment

begin_decl_stmt
name|struct
name|tok
name|opcode
index|[]
init|=
block|{
block|{
name|LWRES_OPCODE_NOOP
block|,
literal|"noop"
block|, }
block|,
block|{
name|LWRES_OPCODE_GETADDRSBYNAME
block|,
literal|"getaddrsbyname"
block|, }
block|,
block|{
name|LWRES_OPCODE_GETNAMEBYADDR
block|,
literal|"getnamebyaddr"
block|, }
block|,
block|{
name|LWRES_OPCODE_GETRDATABYNAME
block|,
literal|"getrdatabyname"
block|, }
block|,
block|{
literal|0
block|,
name|NULL
block|, }
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* print-domain.c */
end_comment

begin_decl_stmt
specifier|extern
name|struct
name|tok
name|ns_type2str
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|tok
name|ns_class2str
index|[]
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|lwres_printname
parameter_list|(
name|size_t
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lwres_printnamelen
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lwres_printbinlen
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lwres_printaddr
parameter_list|(
name|lwres_addr_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|lwres_printname
parameter_list|(
name|size_t
name|l
parameter_list|,
specifier|const
name|char
modifier|*
name|p0
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|p
operator|=
name|p0
expr_stmt|;
comment|/* + 1 for terminating \0 */
if|if
condition|(
name|p
operator|+
name|l
operator|+
literal|1
operator|>
operator|(
specifier|const
name|char
operator|*
operator|)
name|snapend
condition|)
goto|goto
name|trunc
goto|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|l
condition|;
name|i
operator|++
control|)
name|safeputchar
argument_list|(
operator|*
name|p
operator|++
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
comment|/* skip terminating \0 */
return|return
name|p
operator|-
name|p0
return|;
name|trunc
label|:
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lwres_printnamelen
parameter_list|(
specifier|const
name|char
modifier|*
name|p
parameter_list|)
block|{
name|u_int16_t
name|l
decl_stmt|;
name|int
name|advance
decl_stmt|;
if|if
condition|(
name|p
operator|+
literal|2
operator|>
operator|(
specifier|const
name|char
operator|*
operator|)
name|snapend
condition|)
goto|goto
name|trunc
goto|;
name|l
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|advance
operator|=
name|lwres_printname
argument_list|(
name|l
argument_list|,
name|p
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
return|return
literal|2
operator|+
name|advance
return|;
name|trunc
label|:
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lwres_printbinlen
parameter_list|(
specifier|const
name|char
modifier|*
name|p0
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
name|u_int16_t
name|l
decl_stmt|;
name|int
name|i
decl_stmt|;
name|p
operator|=
name|p0
expr_stmt|;
if|if
condition|(
name|p
operator|+
literal|2
operator|>
operator|(
specifier|const
name|char
operator|*
operator|)
name|snapend
condition|)
goto|goto
name|trunc
goto|;
name|l
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|+
literal|2
operator|+
name|l
operator|>
operator|(
specifier|const
name|char
operator|*
operator|)
name|snapend
condition|)
goto|goto
name|trunc
goto|;
name|p
operator|+=
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|l
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
operator|*
name|p
operator|++
argument_list|)
expr_stmt|;
return|return
name|p
operator|-
name|p0
return|;
name|trunc
label|:
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lwres_printaddr
parameter_list|(
name|lwres_addr_t
modifier|*
name|ap
parameter_list|)
block|{
name|u_int16_t
name|l
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|;
name|TCHECK
argument_list|(
name|ap
operator|->
name|length
argument_list|)
expr_stmt|;
name|l
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ap
operator|->
name|length
argument_list|)
expr_stmt|;
comment|/* XXX ap points to packed struct */
name|p
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
operator|&
name|ap
operator|->
name|length
operator|+
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|length
argument_list|)
expr_stmt|;
name|TCHECK2
argument_list|(
operator|*
name|p
argument_list|,
name|l
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|ap
operator|->
name|family
argument_list|)
condition|)
block|{
case|case
literal|1
case|:
comment|/* IPv4 */
if|if
condition|(
name|l
operator|<
literal|4
condition|)
return|return
operator|-
literal|1
return|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|ipaddr_string
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
literal|2
case|:
comment|/* IPv6 */
if|if
condition|(
name|l
operator|<
literal|16
condition|)
return|return
operator|-
literal|1
return|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|ip6addr_string
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|printf
argument_list|(
literal|" %u/"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|ap
operator|->
name|family
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|l
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
operator|*
name|p
operator|++
argument_list|)
expr_stmt|;
block|}
return|return
name|p
operator|-
operator|(
specifier|const
name|char
operator|*
operator|)
name|ap
return|;
name|trunc
label|:
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|lwres_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
specifier|const
name|struct
name|lwres_lwpacket
modifier|*
name|np
decl_stmt|;
name|u_int32_t
name|v
decl_stmt|;
specifier|const
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|response
decl_stmt|;
name|int
name|advance
decl_stmt|;
name|int
name|unsupported
init|=
literal|0
decl_stmt|;
name|np
operator|=
operator|(
specifier|const
expr|struct
name|lwres_lwpacket
operator|*
operator|)
name|bp
expr_stmt|;
name|TCHECK
argument_list|(
name|np
operator|->
name|authlength
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" lwres"
argument_list|)
expr_stmt|;
name|v
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|np
operator|->
name|version
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|||
name|v
operator|!=
name|LWRES_LWPACKETVERSION_0
condition|)
name|printf
argument_list|(
literal|" v%u"
argument_list|,
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|!=
name|LWRES_LWPACKETVERSION_0
condition|)
block|{
name|s
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|np
operator|+
name|EXTRACT_32BITS
argument_list|(
operator|&
name|np
operator|->
name|length
argument_list|)
expr_stmt|;
goto|goto
name|tail
goto|;
block|}
name|response
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|np
operator|->
name|pktflags
argument_list|)
operator|&
name|LWRES_LWPACKETFLAG_RESPONSE
expr_stmt|;
comment|/* opcode and pktflags */
name|v
operator|=
name|EXTRACT_32BITS
argument_list|(
operator|&
name|np
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|s
operator|=
name|tok2str
argument_list|(
name|opcode
argument_list|,
literal|"#0x%x"
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s%s"
argument_list|,
name|s
argument_list|,
name|response
condition|?
literal|""
else|:
literal|"?"
argument_list|)
expr_stmt|;
comment|/* pktflags */
name|v
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|np
operator|->
name|pktflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|&
operator|~
name|LWRES_LWPACKETFLAG_RESPONSE
condition|)
name|printf
argument_list|(
literal|"[0x%x]"
argument_list|,
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|>
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
comment|/*)*/
name|printf
argument_list|(
literal|"serial:0x%x"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|np
operator|->
name|serial
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" result:0x%x"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|np
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" recvlen:%u"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|np
operator|->
name|recvlength
argument_list|)
argument_list|)
expr_stmt|;
comment|/* BIND910: not used */
if|if
condition|(
name|vflag
operator|>
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|" authtype:0x%x"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|np
operator|->
name|authtype
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" authlen:%u"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|np
operator|->
name|authlength
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/*(*/
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
comment|/* per-opcode content */
if|if
condition|(
operator|!
name|response
condition|)
block|{
comment|/* 		 * queries 		 */
name|lwres_gabnrequest_t
modifier|*
name|gabn
decl_stmt|;
name|lwres_gnbarequest_t
modifier|*
name|gnba
decl_stmt|;
name|lwres_grbnrequest_t
modifier|*
name|grbn
decl_stmt|;
name|u_int32_t
name|l
decl_stmt|;
name|gabn
operator|=
name|NULL
expr_stmt|;
name|gnba
operator|=
name|NULL
expr_stmt|;
name|grbn
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|np
operator|->
name|opcode
argument_list|)
condition|)
block|{
case|case
name|LWRES_OPCODE_NOOP
case|:
break|break;
case|case
name|LWRES_OPCODE_GETADDRSBYNAME
case|:
name|gabn
operator|=
operator|(
name|lwres_gabnrequest_t
operator|*
operator|)
operator|(
name|np
operator|+
literal|1
operator|)
expr_stmt|;
name|TCHECK
argument_list|(
name|gabn
operator|->
name|namelen
argument_list|)
expr_stmt|;
comment|/* XXX gabn points to packed struct */
name|s
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
operator|&
name|gabn
operator|->
name|namelen
operator|+
sizeof|sizeof
argument_list|(
name|gabn
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|l
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|gabn
operator|->
name|namelen
argument_list|)
expr_stmt|;
comment|/* BIND910: not used */
if|if
condition|(
name|vflag
operator|>
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|" flags:0x%x"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|gabn
operator|->
name|flags
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|v
operator|=
name|EXTRACT_32BITS
argument_list|(
operator|&
name|gabn
operator|->
name|addrtypes
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|v
operator|&
operator|(
name|LWRES_ADDRTYPE_V4
operator||
name|LWRES_ADDRTYPE_V6
operator|)
condition|)
block|{
case|case
name|LWRES_ADDRTYPE_V4
case|:
name|printf
argument_list|(
literal|" IPv4"
argument_list|)
expr_stmt|;
break|break;
case|case
name|LWRES_ADDRTYPE_V6
case|:
name|printf
argument_list|(
literal|" IPv6"
argument_list|)
expr_stmt|;
break|break;
case|case
name|LWRES_ADDRTYPE_V4
operator||
name|LWRES_ADDRTYPE_V6
case|:
name|printf
argument_list|(
literal|" IPv4/6"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|v
operator|&
operator|~
operator|(
name|LWRES_ADDRTYPE_V4
operator||
name|LWRES_ADDRTYPE_V6
operator|)
condition|)
name|printf
argument_list|(
literal|"[0x%x]"
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|advance
operator|=
name|lwres_printname
argument_list|(
name|l
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
name|s
operator|+=
name|advance
expr_stmt|;
break|break;
case|case
name|LWRES_OPCODE_GETNAMEBYADDR
case|:
name|gnba
operator|=
operator|(
name|lwres_gnbarequest_t
operator|*
operator|)
operator|(
name|np
operator|+
literal|1
operator|)
expr_stmt|;
name|TCHECK
argument_list|(
name|gnba
operator|->
name|addr
argument_list|)
expr_stmt|;
comment|/* BIND910: not used */
if|if
condition|(
name|vflag
operator|>
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|" flags:0x%x"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|gnba
operator|->
name|flags
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|s
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
operator|&
name|gnba
operator|->
name|addr
expr_stmt|;
name|advance
operator|=
name|lwres_printaddr
argument_list|(
operator|&
name|gnba
operator|->
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
name|s
operator|+=
name|advance
expr_stmt|;
break|break;
case|case
name|LWRES_OPCODE_GETRDATABYNAME
case|:
comment|/* XXX no trace, not tested */
name|grbn
operator|=
operator|(
name|lwres_grbnrequest_t
operator|*
operator|)
operator|(
name|np
operator|+
literal|1
operator|)
expr_stmt|;
name|TCHECK
argument_list|(
name|grbn
operator|->
name|namelen
argument_list|)
expr_stmt|;
comment|/* BIND910: not used */
if|if
condition|(
name|vflag
operator|>
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|" flags:0x%x"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|grbn
operator|->
name|flags
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|tok2str
argument_list|(
name|ns_type2str
argument_list|,
literal|"Type%d"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|grbn
operator|->
name|rdtype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|grbn
operator|->
name|rdclass
argument_list|)
operator|!=
name|C_IN
condition|)
block|{
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|tok2str
argument_list|(
name|ns_class2str
argument_list|,
literal|"Class%d"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|grbn
operator|->
name|rdclass
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* XXX grbn points to packed struct */
name|s
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
operator|&
name|grbn
operator|->
name|namelen
operator|+
sizeof|sizeof
argument_list|(
name|grbn
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|l
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|grbn
operator|->
name|namelen
argument_list|)
expr_stmt|;
name|advance
operator|=
name|lwres_printname
argument_list|(
name|l
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
name|s
operator|+=
name|advance
expr_stmt|;
break|break;
default|default:
name|unsupported
operator|++
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
comment|/* 		 * responses 		 */
name|lwres_gabnresponse_t
modifier|*
name|gabn
decl_stmt|;
name|lwres_gnbaresponse_t
modifier|*
name|gnba
decl_stmt|;
name|lwres_grbnresponse_t
modifier|*
name|grbn
decl_stmt|;
name|u_int32_t
name|l
decl_stmt|,
name|na
decl_stmt|;
name|u_int32_t
name|i
decl_stmt|;
name|gabn
operator|=
name|NULL
expr_stmt|;
name|gnba
operator|=
name|NULL
expr_stmt|;
name|grbn
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|np
operator|->
name|opcode
argument_list|)
condition|)
block|{
case|case
name|LWRES_OPCODE_NOOP
case|:
break|break;
case|case
name|LWRES_OPCODE_GETADDRSBYNAME
case|:
name|gabn
operator|=
operator|(
name|lwres_gabnresponse_t
operator|*
operator|)
operator|(
name|np
operator|+
literal|1
operator|)
expr_stmt|;
name|TCHECK
argument_list|(
name|gabn
operator|->
name|realnamelen
argument_list|)
expr_stmt|;
comment|/* XXX gabn points to packed struct */
name|s
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
operator|&
name|gabn
operator|->
name|realnamelen
operator|+
sizeof|sizeof
argument_list|(
name|gabn
operator|->
name|realnamelen
argument_list|)
expr_stmt|;
name|l
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|gabn
operator|->
name|realnamelen
argument_list|)
expr_stmt|;
comment|/* BIND910: not used */
if|if
condition|(
name|vflag
operator|>
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|" flags:0x%x"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|gabn
operator|->
name|flags
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" %u/%u"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|gabn
operator|->
name|naliases
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|gabn
operator|->
name|naddrs
argument_list|)
argument_list|)
expr_stmt|;
name|advance
operator|=
name|lwres_printname
argument_list|(
name|l
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
name|s
operator|+=
name|advance
expr_stmt|;
comment|/* aliases */
name|na
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|gabn
operator|->
name|naliases
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|na
condition|;
name|i
operator|++
control|)
block|{
name|advance
operator|=
name|lwres_printnamelen
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
name|s
operator|+=
name|advance
expr_stmt|;
block|}
comment|/* addrs */
name|na
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|gabn
operator|->
name|naddrs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|na
condition|;
name|i
operator|++
control|)
block|{
name|advance
operator|=
name|lwres_printaddr
argument_list|(
operator|(
name|lwres_addr_t
operator|*
operator|)
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
name|s
operator|+=
name|advance
expr_stmt|;
block|}
break|break;
case|case
name|LWRES_OPCODE_GETNAMEBYADDR
case|:
name|gnba
operator|=
operator|(
name|lwres_gnbaresponse_t
operator|*
operator|)
operator|(
name|np
operator|+
literal|1
operator|)
expr_stmt|;
name|TCHECK
argument_list|(
name|gnba
operator|->
name|realnamelen
argument_list|)
expr_stmt|;
comment|/* XXX gnba points to packed struct */
name|s
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
operator|&
name|gnba
operator|->
name|realnamelen
operator|+
sizeof|sizeof
argument_list|(
name|gnba
operator|->
name|realnamelen
argument_list|)
expr_stmt|;
name|l
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|gnba
operator|->
name|realnamelen
argument_list|)
expr_stmt|;
comment|/* BIND910: not used */
if|if
condition|(
name|vflag
operator|>
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|" flags:0x%x"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|gnba
operator|->
name|flags
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" %u"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|gnba
operator|->
name|naliases
argument_list|)
argument_list|)
expr_stmt|;
name|advance
operator|=
name|lwres_printname
argument_list|(
name|l
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
name|s
operator|+=
name|advance
expr_stmt|;
comment|/* aliases */
name|na
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|gnba
operator|->
name|naliases
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|na
condition|;
name|i
operator|++
control|)
block|{
name|advance
operator|=
name|lwres_printnamelen
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
name|s
operator|+=
name|advance
expr_stmt|;
block|}
break|break;
case|case
name|LWRES_OPCODE_GETRDATABYNAME
case|:
comment|/* XXX no trace, not tested */
name|grbn
operator|=
operator|(
name|lwres_grbnresponse_t
operator|*
operator|)
operator|(
name|np
operator|+
literal|1
operator|)
expr_stmt|;
name|TCHECK
argument_list|(
name|grbn
operator|->
name|nsigs
argument_list|)
expr_stmt|;
comment|/* BIND910: not used */
if|if
condition|(
name|vflag
operator|>
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|" flags:0x%x"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|grbn
operator|->
name|flags
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|tok2str
argument_list|(
name|ns_type2str
argument_list|,
literal|"Type%d"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|grbn
operator|->
name|rdtype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|grbn
operator|->
name|rdclass
argument_list|)
operator|!=
name|C_IN
condition|)
block|{
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|tok2str
argument_list|(
name|ns_class2str
argument_list|,
literal|"Class%d"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|grbn
operator|->
name|rdclass
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" TTL "
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|grbn
operator|->
name|ttl
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %u/%u"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|grbn
operator|->
name|nrdatas
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|grbn
operator|->
name|nsigs
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXX grbn points to packed struct */
name|s
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
operator|&
name|grbn
operator|->
name|nsigs
operator|+
sizeof|sizeof
argument_list|(
name|grbn
operator|->
name|nsigs
argument_list|)
expr_stmt|;
name|advance
operator|=
name|lwres_printnamelen
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
name|s
operator|+=
name|advance
expr_stmt|;
comment|/* rdatas */
name|na
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|grbn
operator|->
name|nrdatas
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|na
condition|;
name|i
operator|++
control|)
block|{
comment|/* XXX should decode resource data */
name|advance
operator|=
name|lwres_printbinlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
name|s
operator|+=
name|advance
expr_stmt|;
block|}
comment|/* sigs */
name|na
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|grbn
operator|->
name|nsigs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|na
condition|;
name|i
operator|++
control|)
block|{
comment|/* XXX how should we print it? */
name|advance
operator|=
name|lwres_printbinlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
name|s
operator|+=
name|advance
expr_stmt|;
block|}
break|break;
default|default:
name|unsupported
operator|++
expr_stmt|;
break|break;
block|}
block|}
name|tail
label|:
comment|/* length mismatch */
if|if
condition|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|np
operator|->
name|length
argument_list|)
operator|!=
name|length
condition|)
block|{
name|printf
argument_list|(
literal|" [len: %u != %u]"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|np
operator|->
name|length
argument_list|)
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|unsupported
operator|&&
name|s
operator|<
operator|(
specifier|const
name|char
operator|*
operator|)
name|np
operator|+
name|EXTRACT_32BITS
argument_list|(
operator|&
name|np
operator|->
name|length
argument_list|)
condition|)
name|printf
argument_list|(
literal|"[extra]"
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|printf
argument_list|(
literal|"[|lwres]"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|NETDISSECT_REWORKED
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_typedef
typedef|typedef
struct|struct
name|ipnet_hdr
block|{
name|uint8_t
name|iph_version
decl_stmt|;
name|uint8_t
name|iph_family
decl_stmt|;
name|uint16_t
name|iph_htype
decl_stmt|;
name|uint32_t
name|iph_pktlen
decl_stmt|;
name|uint32_t
name|iph_ifindex
decl_stmt|;
name|uint32_t
name|iph_grifindex
decl_stmt|;
name|uint32_t
name|iph_zsrc
decl_stmt|;
name|uint32_t
name|iph_zdst
decl_stmt|;
block|}
name|ipnet_hdr_t
typedef|;
end_typedef

begin_define
define|#
directive|define
name|IPH_AF_INET
value|2
end_define

begin_comment
comment|/* Matches Solaris's AF_INET */
end_comment

begin_define
define|#
directive|define
name|IPH_AF_INET6
value|26
end_define

begin_comment
comment|/* Matches Solaris's AF_INET6 */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_IPNET
end_ifdef

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|ipnet_values
index|[]
init|=
block|{
block|{
name|IPH_AF_INET
block|,
literal|"IPv4"
block|}
block|,
block|{
name|IPH_AF_INET6
block|,
literal|"IPv6"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|inline
name|void
name|ipnet_hdr_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
specifier|const
name|ipnet_hdr_t
modifier|*
name|hdr
decl_stmt|;
name|hdr
operator|=
operator|(
specifier|const
name|ipnet_hdr_t
operator|*
operator|)
name|bp
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%d> %d"
operator|,
name|hdr
operator|->
name|iph_zsrc
operator|,
name|hdr
operator|->
name|iph_zdst
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_qflag
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", family %s (%d)"
operator|,
name|tok2str
argument_list|(
name|ipnet_values
argument_list|,
literal|"Unknown"
argument_list|,
name|hdr
operator|->
name|iph_family
argument_list|)
operator|,
name|hdr
operator|->
name|iph_family
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", %s"
operator|,
name|tok2str
argument_list|(
name|ipnet_values
argument_list|,
literal|"Unknown Ethertype (0x%04x)"
argument_list|,
name|hdr
operator|->
name|iph_family
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", length %u: "
operator|,
name|length
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipnet_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|,
name|u_int
name|caplen
parameter_list|)
block|{
name|ipnet_hdr_t
modifier|*
name|hdr
decl_stmt|;
if|if
condition|(
name|caplen
operator|<
sizeof|sizeof
argument_list|(
name|ipnet_hdr_t
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|ipnet]"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ipnet_hdr_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|length
operator|-=
sizeof|sizeof
argument_list|(
name|ipnet_hdr_t
argument_list|)
expr_stmt|;
name|caplen
operator|-=
sizeof|sizeof
argument_list|(
name|ipnet_hdr_t
argument_list|)
expr_stmt|;
name|hdr
operator|=
operator|(
name|ipnet_hdr_t
operator|*
operator|)
name|p
expr_stmt|;
name|p
operator|+=
sizeof|sizeof
argument_list|(
name|ipnet_hdr_t
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hdr
operator|->
name|iph_family
condition|)
block|{
case|case
name|IPH_AF_INET
case|:
name|ip_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPH_AF_INET6
case|:
name|ip6_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ipnet_hdr_print
argument_list|(
name|ndo
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|hdr
argument_list|,
name|length
operator|+
sizeof|sizeof
argument_list|(
name|ipnet_hdr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_suppress_default_print
condition|)
name|ND_DEFAULTPRINT
argument_list|(
name|p
argument_list|,
name|caplen
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * This is the top level routine of the printer.  'p' points  * to the ether header of the packet, 'h->ts' is the timestamp,  * 'h->len' is the length of the packet off the wire, and 'h->caplen'  * is the number of bytes actually captured.  */
end_comment

begin_function
name|u_int
name|ipnet_if_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|ipnet_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
operator|->
name|len
argument_list|,
name|h
operator|->
name|caplen
argument_list|)
expr_stmt|;
return|return
operator|(
sizeof|sizeof
argument_list|(
name|ipnet_hdr_t
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Local Variables:  * c-style: whitesmith  * c-basic-offset: 8  * End:  */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DLT_IPNET */
end_comment

end_unit


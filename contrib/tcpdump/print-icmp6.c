begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1988, 1989, 1990, 1991, 1993, 1994  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code distributions  * retain the above copyright notice and this paragraph in its entirety, (2)  * distributions including binary code include the above copyright notice and  * this paragraph in its entirety in the documentation or other materials  * provided with the distribution, and (3) all advertising materials mentioning  * features or use of this software display the following acknowledgement:  * ``This product includes software developed by the University of California,  * Lawrence Berkeley Laboratory and its contributors.'' Neither the name of  * the University nor the names of its contributors may be used to endorse  * or promote products derived from this software without specific prior  * written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
name|_U_
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-icmp6.c,v 1.86 2008-02-05 19:36:13 guy Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"ip6.h"
end_include

begin_include
include|#
directive|include
file|"icmp6.h"
end_include

begin_include
include|#
directive|include
file|"ipproto.h"
end_include

begin_include
include|#
directive|include
file|"udp.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_function_decl
specifier|static
specifier|const
name|char
modifier|*
name|get_rtpref
parameter_list|(
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|char
modifier|*
name|get_lifetime
parameter_list|(
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_lladdr
parameter_list|(
specifier|const
name|u_char
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|icmp6_opt_print
parameter_list|(
specifier|const
name|u_char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mld6_print
parameter_list|(
specifier|const
name|u_char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mldv2_report_print
parameter_list|(
specifier|const
name|u_char
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mldv2_query_print
parameter_list|(
specifier|const
name|u_char
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|udphdr
modifier|*
name|get_upperlayer
parameter_list|(
name|u_char
modifier|*
parameter_list|,
name|u_int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dnsname_print
parameter_list|(
specifier|const
name|u_char
modifier|*
parameter_list|,
specifier|const
name|u_char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|icmp6_nodeinfo_print
parameter_list|(
name|u_int
parameter_list|,
specifier|const
name|u_char
modifier|*
parameter_list|,
specifier|const
name|u_char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|icmp6_rrenum_print
parameter_list|(
specifier|const
name|u_char
modifier|*
parameter_list|,
specifier|const
name|u_char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|abs
end_ifndef

begin_define
define|#
directive|define
name|abs
parameter_list|(
name|a
parameter_list|)
value|((0< (a)) ? (a) : -(a))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* inline the various RPL definitions */
end_comment

begin_define
define|#
directive|define
name|ND_RPL_MESSAGE
value|0x9B
end_define

begin_decl_stmt
specifier|static
name|struct
name|tok
name|icmp6_type_values
index|[]
init|=
block|{
block|{
name|ICMP6_DST_UNREACH
block|,
literal|"destination unreachable"
block|}
block|,
block|{
name|ICMP6_PACKET_TOO_BIG
block|,
literal|"packet too big"
block|}
block|,
block|{
name|ICMP6_TIME_EXCEEDED
block|,
literal|"time exceeded in-transit"
block|}
block|,
block|{
name|ICMP6_PARAM_PROB
block|,
literal|"parameter problem"
block|}
block|,
block|{
name|ICMP6_ECHO_REQUEST
block|,
literal|"echo request"
block|}
block|,
block|{
name|ICMP6_ECHO_REPLY
block|,
literal|"echo reply"
block|}
block|,
block|{
name|MLD6_LISTENER_QUERY
block|,
literal|"multicast listener query"
block|}
block|,
block|{
name|MLD6_LISTENER_REPORT
block|,
literal|"multicast listener report"
block|}
block|,
block|{
name|MLD6_LISTENER_DONE
block|,
literal|"multicast listener done"
block|}
block|,
block|{
name|ND_ROUTER_SOLICIT
block|,
literal|"router solicitation"
block|}
block|,
block|{
name|ND_ROUTER_ADVERT
block|,
literal|"router advertisement"
block|}
block|,
block|{
name|ND_NEIGHBOR_SOLICIT
block|,
literal|"neighbor solicitation"
block|}
block|,
block|{
name|ND_NEIGHBOR_ADVERT
block|,
literal|"neighbor advertisement"
block|}
block|,
block|{
name|ND_REDIRECT
block|,
literal|"redirect"
block|}
block|,
block|{
name|ICMP6_ROUTER_RENUMBERING
block|,
literal|"router renumbering"
block|}
block|,
block|{
name|IND_SOLICIT
block|,
literal|"inverse neighbor solicitation"
block|}
block|,
block|{
name|IND_ADVERT
block|,
literal|"inverse neighbor advertisement"
block|}
block|,
block|{
name|MLDV2_LISTENER_REPORT
block|,
literal|"multicast listener report v2"
block|}
block|,
block|{
name|ICMP6_HADISCOV_REQUEST
block|,
literal|"ha discovery request"
block|}
block|,
block|{
name|ICMP6_HADISCOV_REPLY
block|,
literal|"ha discovery reply"
block|}
block|,
block|{
name|ICMP6_MOBILEPREFIX_SOLICIT
block|,
literal|"mobile router solicitation"
block|}
block|,
block|{
name|ICMP6_MOBILEPREFIX_ADVERT
block|,
literal|"mobile router advertisement"
block|}
block|,
block|{
name|ICMP6_WRUREQUEST
block|,
literal|"who-are-you request"
block|}
block|,
block|{
name|ICMP6_WRUREPLY
block|,
literal|"who-are-you reply"
block|}
block|,
block|{
name|ICMP6_NI_QUERY
block|,
literal|"node information query"
block|}
block|,
block|{
name|ICMP6_NI_REPLY
block|,
literal|"node information reply"
block|}
block|,
block|{
name|MLD6_MTRACE
block|,
literal|"mtrace message"
block|}
block|,
block|{
name|MLD6_MTRACE_RESP
block|,
literal|"mtrace response"
block|}
block|,
block|{
name|ND_RPL_MESSAGE
block|,
literal|"RPL"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tok
name|icmp6_dst_unreach_code_values
index|[]
init|=
block|{
block|{
name|ICMP6_DST_UNREACH_NOROUTE
block|,
literal|"unreachable route"
block|}
block|,
block|{
name|ICMP6_DST_UNREACH_ADMIN
block|,
literal|" unreachable prohibited"
block|}
block|,
block|{
name|ICMP6_DST_UNREACH_BEYONDSCOPE
block|,
literal|"beyond scope"
block|}
block|,
block|{
name|ICMP6_DST_UNREACH_ADDR
block|,
literal|"unreachable address"
block|}
block|,
block|{
name|ICMP6_DST_UNREACH_NOPORT
block|,
literal|"unreachable port"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tok
name|icmp6_opt_pi_flag_values
index|[]
init|=
block|{
block|{
name|ND_OPT_PI_FLAG_ONLINK
block|,
literal|"onlink"
block|}
block|,
block|{
name|ND_OPT_PI_FLAG_AUTO
block|,
literal|"auto"
block|}
block|,
block|{
name|ND_OPT_PI_FLAG_ROUTER
block|,
literal|"router"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tok
name|icmp6_opt_ra_flag_values
index|[]
init|=
block|{
block|{
name|ND_RA_FLAG_MANAGED
block|,
literal|"managed"
block|}
block|,
block|{
name|ND_RA_FLAG_OTHER
block|,
literal|"other stateful"
block|}
block|,
block|{
name|ND_RA_FLAG_HOME_AGENT
block|,
literal|"home agent"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tok
name|icmp6_nd_na_flag_values
index|[]
init|=
block|{
block|{
name|ND_NA_FLAG_ROUTER
block|,
literal|"router"
block|}
block|,
block|{
name|ND_NA_FLAG_SOLICITED
block|,
literal|"solicited"
block|}
block|,
block|{
name|ND_NA_FLAG_OVERRIDE
block|,
literal|"override"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tok
name|icmp6_opt_values
index|[]
init|=
block|{
block|{
name|ND_OPT_SOURCE_LINKADDR
block|,
literal|"source link-address"
block|}
block|,
block|{
name|ND_OPT_TARGET_LINKADDR
block|,
literal|"destination link-address"
block|}
block|,
block|{
name|ND_OPT_PREFIX_INFORMATION
block|,
literal|"prefix info"
block|}
block|,
block|{
name|ND_OPT_REDIRECTED_HEADER
block|,
literal|"redirected header"
block|}
block|,
block|{
name|ND_OPT_MTU
block|,
literal|"mtu"
block|}
block|,
block|{
name|ND_OPT_RDNSS
block|,
literal|"rdnss"
block|}
block|,
block|{
name|ND_OPT_ADVINTERVAL
block|,
literal|"advertisement interval"
block|}
block|,
block|{
name|ND_OPT_HOMEAGENT_INFO
block|,
literal|"homeagent information"
block|}
block|,
block|{
name|ND_OPT_ROUTE_INFO
block|,
literal|"route info"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* mldv2 report types */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|tok
name|mldv2report2str
index|[]
init|=
block|{
block|{
literal|1
block|,
literal|"is_in"
block|}
block|,
block|{
literal|2
block|,
literal|"is_ex"
block|}
block|,
block|{
literal|3
block|,
literal|"to_in"
block|}
block|,
block|{
literal|4
block|,
literal|"to_ex"
block|}
block|,
block|{
literal|5
block|,
literal|"allow"
block|}
block|,
block|{
literal|6
block|,
literal|"block"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|get_rtpref
parameter_list|(
name|u_int
name|v
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|rtpref_str
index|[]
init|=
block|{
literal|"medium"
block|,
comment|/* 00 */
literal|"high"
block|,
comment|/* 01 */
literal|"rsv"
block|,
comment|/* 10 */
literal|"low"
comment|/* 11 */
block|}
decl_stmt|;
return|return
name|rtpref_str
index|[
operator|(
operator|(
name|v
operator|&
name|ND_RA_FLAG_RTPREF_MASK
operator|)
operator|>>
literal|3
operator|)
operator|&
literal|0xff
index|]
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|get_lifetime
parameter_list|(
name|u_int32_t
name|v
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
if|if
condition|(
name|v
operator|==
operator|(
name|u_int32_t
operator|)
operator|~
literal|0UL
condition|)
return|return
literal|"infinity"
return|;
else|else
block|{
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%u"
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_lladdr
parameter_list|(
specifier|const
name|u_int8_t
modifier|*
name|p
parameter_list|,
name|size_t
name|l
parameter_list|)
block|{
specifier|const
name|u_int8_t
modifier|*
name|ep
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|q
operator|=
name|p
expr_stmt|;
name|ep
operator|=
name|p
operator|+
name|l
expr_stmt|;
while|while
condition|(
name|l
operator|>
literal|0
operator|&&
name|q
operator|<
name|ep
condition|)
block|{
if|if
condition|(
name|q
operator|>
name|p
condition|)
name|printf
argument_list|(
literal|":"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02x"
argument_list|,
operator|*
name|q
operator|++
argument_list|)
expr_stmt|;
name|l
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|icmp6_cksum
parameter_list|(
specifier|const
name|struct
name|ip6_hdr
modifier|*
name|ip6
parameter_list|,
specifier|const
name|struct
name|icmp6_hdr
modifier|*
name|icp
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
return|return
operator|(
name|nextproto6_cksum
argument_list|(
name|ip6
argument_list|,
operator|(
specifier|const
name|u_int8_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|icp
argument_list|,
name|len
argument_list|,
name|IPPROTO_ICMPV6
argument_list|)
operator|)
return|;
block|}
end_function

begin_enum
enum|enum
name|ND_RPL_CODE
block|{
name|ND_RPL_DIS
init|=
literal|0x00
block|,
name|ND_RPL_DIO
init|=
literal|0x01
block|,
name|ND_RPL_DAO
init|=
literal|0x02
block|,
name|ND_RPL_DAO_ACK
init|=
literal|0x03
block|,
name|ND_RPL_SDIS
init|=
literal|0x80
block|,
name|ND_RPL_SDIO
init|=
literal|0x81
block|,
name|ND_RPL_SDAO
init|=
literal|0x82
block|,
name|ND_RPL_SDAO_ACK
init|=
literal|0x83
block|,
name|ND_RPL_SCC
init|=
literal|0x8A
block|, }
enum|;
end_enum

begin_enum
enum|enum
name|ND_RPL_DIO_FLAGS
block|{
name|ND_RPL_DIO_GROUNDED
init|=
literal|0x80
block|,
name|ND_RPL_DIO_DATRIG
init|=
literal|0x40
block|,
name|ND_RPL_DIO_DASUPPORT
init|=
literal|0x20
block|,
name|ND_RPL_DIO_RES4
init|=
literal|0x10
block|,
name|ND_RPL_DIO_RES3
init|=
literal|0x08
block|,
name|ND_RPL_DIO_PRF_MASK
init|=
literal|0x07
block|,
comment|/* 3-bit preference */
block|}
enum|;
end_enum

begin_struct
struct|struct
name|nd_rpl_dio
block|{
name|u_int8_t
name|rpl_flags
decl_stmt|;
name|u_int8_t
name|rpl_seq
decl_stmt|;
name|u_int8_t
name|rpl_instanceid
decl_stmt|;
name|u_int8_t
name|rpl_dagrank
decl_stmt|;
name|u_int8_t
name|rpl_dagid
index|[
literal|16
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|rpl_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|icmp6_hdr
modifier|*
name|hdr
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
name|length
name|_U_
parameter_list|)
block|{
name|struct
name|nd_rpl_dio
modifier|*
name|dio
init|=
operator|(
expr|struct
name|nd_rpl_dio
operator|*
operator|)
name|bp
decl_stmt|;
name|int
name|secured
init|=
name|hdr
operator|->
name|icmp6_code
operator|&
literal|0x80
decl_stmt|;
name|int
name|basecode
init|=
name|hdr
operator|->
name|icmp6_code
operator|&
literal|0x7f
decl_stmt|;
name|ND_TCHECK
argument_list|(
name|dio
operator|->
name|rpl_dagid
argument_list|)
expr_stmt|;
if|if
condition|(
name|secured
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", (SEC)"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", (CLR)"
operator|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|basecode
condition|)
block|{
case|case
name|ND_RPL_DIS
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"DODAG Information Solicitation"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{                 }
break|break;
case|case
name|ND_RPL_DIO
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"DODAG Information Object"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{
name|char
name|dagid
index|[
literal|65
index|]
decl_stmt|;
name|char
modifier|*
name|d
init|=
name|dagid
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|isprint
argument_list|(
name|dio
operator|->
name|rpl_dagid
index|[
name|i
index|]
argument_list|)
condition|)
block|{
operator|*
name|d
operator|++
operator|=
name|dio
operator|->
name|rpl_dagid
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
name|int
name|cnt
init|=
name|snprintf
argument_list|(
name|d
argument_list|,
literal|4
argument_list|,
literal|"0x%02x"
argument_list|,
name|dio
operator|->
name|rpl_dagid
index|[
name|i
index|]
argument_list|)
decl_stmt|;
name|d
operator|+=
name|cnt
expr_stmt|;
block|}
block|}
operator|*
name|d
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [seq:%u,instance:%u,rank:%u,dagid:%s]"
operator|,
name|dio
operator|->
name|rpl_seq
operator|,
name|dio
operator|->
name|rpl_instanceid
operator|,
name|dio
operator|->
name|rpl_dagrank
operator|,
name|dagid
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ND_RPL_DAO
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"Destination Advertisement Object"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{                 }
break|break;
case|case
name|ND_RPL_DAO_ACK
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"Destination Advertisement Object Ack"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
condition|)
block|{                 }
break|break;
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"RPL message, unknown code %u"
operator|,
name|hdr
operator|->
name|icmp6_code
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|truncated]"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|icmp6_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
name|length
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp2
parameter_list|,
name|int
name|fragmented
parameter_list|)
block|{
specifier|const
name|struct
name|icmp6_hdr
modifier|*
name|dp
decl_stmt|;
specifier|const
name|struct
name|ip6_hdr
modifier|*
name|ip
decl_stmt|;
specifier|const
name|struct
name|ip6_hdr
modifier|*
name|oip
decl_stmt|;
specifier|const
name|struct
name|udphdr
modifier|*
name|ouh
decl_stmt|;
name|int
name|dport
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
name|u_int
name|prot
decl_stmt|;
name|dp
operator|=
operator|(
expr|struct
name|icmp6_hdr
operator|*
operator|)
name|bp
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
name|bp2
expr_stmt|;
name|oip
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
operator|(
name|dp
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* 'ep' points to the end of available data. */
name|ep
operator|=
name|snapend
expr_stmt|;
name|TCHECK
argument_list|(
name|dp
operator|->
name|icmp6_cksum
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|&&
operator|!
name|fragmented
condition|)
block|{
name|u_int16_t
name|sum
decl_stmt|,
name|udp_sum
decl_stmt|;
if|if
condition|(
name|TTEST2
argument_list|(
name|bp
index|[
literal|0
index|]
argument_list|,
name|length
argument_list|)
condition|)
block|{
name|udp_sum
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|dp
operator|->
name|icmp6_cksum
argument_list|)
expr_stmt|;
name|sum
operator|=
name|icmp6_cksum
argument_list|(
name|ip
argument_list|,
name|dp
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|sum
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"[bad icmp6 cksum 0x%04x -> 0x%04x!] "
argument_list|,
name|udp_sum
argument_list|,
name|in_cksum_shouldbe
argument_list|(
name|udp_sum
argument_list|,
name|sum
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"[icmp6 sum ok] "
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"ICMP6, %s"
argument_list|,
name|tok2str
argument_list|(
name|icmp6_type_values
argument_list|,
literal|"unknown icmp6 type (%u)"
argument_list|,
name|dp
operator|->
name|icmp6_type
argument_list|)
argument_list|)
expr_stmt|;
comment|/* display cosmetics: print the packet length for printer that use the vflag now */
if|if
condition|(
name|vflag
operator|&&
operator|(
name|dp
operator|->
name|icmp6_type
operator|==
name|ND_ROUTER_SOLICIT
operator|||
name|dp
operator|->
name|icmp6_type
operator|==
name|ND_ROUTER_ADVERT
operator|||
name|dp
operator|->
name|icmp6_type
operator|==
name|ND_NEIGHBOR_ADVERT
operator|||
name|dp
operator|->
name|icmp6_type
operator|==
name|ND_NEIGHBOR_SOLICIT
operator|||
name|dp
operator|->
name|icmp6_type
operator|==
name|ND_REDIRECT
operator|||
name|dp
operator|->
name|icmp6_type
operator|==
name|ICMP6_HADISCOV_REPLY
operator|||
name|dp
operator|->
name|icmp6_type
operator|==
name|ICMP6_MOBILEPREFIX_ADVERT
operator|)
condition|)
name|printf
argument_list|(
literal|", length %u"
argument_list|,
name|length
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dp
operator|->
name|icmp6_type
condition|)
block|{
case|case
name|ICMP6_DST_UNREACH
case|:
name|TCHECK
argument_list|(
name|oip
operator|->
name|ip6_dst
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %s"
argument_list|,
name|tok2str
argument_list|(
name|icmp6_dst_unreach_code_values
argument_list|,
literal|"unknown unreach code (%u)"
argument_list|,
name|dp
operator|->
name|icmp6_code
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dp
operator|->
name|icmp6_code
condition|)
block|{
case|case
name|ICMP6_DST_UNREACH_NOROUTE
case|:
comment|/* fall through */
case|case
name|ICMP6_DST_UNREACH_ADMIN
case|:
case|case
name|ICMP6_DST_UNREACH_ADDR
case|:
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|oip
operator|->
name|ip6_dst
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_DST_UNREACH_BEYONDSCOPE
case|:
name|printf
argument_list|(
literal|" %s, source address %s"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|oip
operator|->
name|ip6_dst
argument_list|)
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|oip
operator|->
name|ip6_src
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_DST_UNREACH_NOPORT
case|:
if|if
condition|(
operator|(
name|ouh
operator|=
name|get_upperlayer
argument_list|(
operator|(
name|u_char
operator|*
operator|)
name|oip
argument_list|,
operator|&
name|prot
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|trunc
goto|;
name|dport
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ouh
operator|->
name|uh_dport
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|prot
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
name|printf
argument_list|(
literal|", %s tcp port %s"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|oip
operator|->
name|ip6_dst
argument_list|)
argument_list|,
name|tcpport_string
argument_list|(
name|dport
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_UDP
case|:
name|printf
argument_list|(
literal|", %s udp port %s"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|oip
operator|->
name|ip6_dst
argument_list|)
argument_list|,
name|udpport_string
argument_list|(
name|dport
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|", %s protocol %d port %d unreachable"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|oip
operator|->
name|ip6_dst
argument_list|)
argument_list|,
name|oip
operator|->
name|ip6_nxt
argument_list|,
name|dport
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
if|if
condition|(
name|vflag
operator|<=
literal|1
condition|)
block|{
name|print_unknown_data
argument_list|(
name|bp
argument_list|,
literal|"\n\t"
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
block|}
break|break;
case|case
name|ICMP6_PACKET_TOO_BIG
case|:
name|TCHECK
argument_list|(
name|dp
operator|->
name|icmp6_mtu
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", mtu %u"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|dp
operator|->
name|icmp6_mtu
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_TIME_EXCEEDED
case|:
name|TCHECK
argument_list|(
name|oip
operator|->
name|ip6_dst
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dp
operator|->
name|icmp6_code
condition|)
block|{
case|case
name|ICMP6_TIME_EXCEED_TRANSIT
case|:
name|printf
argument_list|(
literal|" for %s"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|oip
operator|->
name|ip6_dst
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_TIME_EXCEED_REASSEMBLY
case|:
name|printf
argument_list|(
literal|" (reassembly)"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|", unknown code (%u)"
argument_list|,
name|dp
operator|->
name|icmp6_code
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|ICMP6_PARAM_PROB
case|:
name|TCHECK
argument_list|(
name|oip
operator|->
name|ip6_dst
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dp
operator|->
name|icmp6_code
condition|)
block|{
case|case
name|ICMP6_PARAMPROB_HEADER
case|:
name|printf
argument_list|(
literal|", errorneous - octet %u"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|dp
operator|->
name|icmp6_pptr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_PARAMPROB_NEXTHEADER
case|:
name|printf
argument_list|(
literal|", next header - octet %u"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|dp
operator|->
name|icmp6_pptr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_PARAMPROB_OPTION
case|:
name|printf
argument_list|(
literal|", option - octet %u"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|dp
operator|->
name|icmp6_pptr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|", code-#%d"
argument_list|,
name|dp
operator|->
name|icmp6_code
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|ICMP6_ECHO_REQUEST
case|:
case|case
name|ICMP6_ECHO_REPLY
case|:
name|TCHECK
argument_list|(
name|dp
operator|->
name|icmp6_seq
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", seq %u"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|dp
operator|->
name|icmp6_seq
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_MEMBERSHIP_QUERY
case|:
if|if
condition|(
name|length
operator|==
name|MLD_MINLEN
condition|)
block|{
name|mld6_print
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|dp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|length
operator|>=
name|MLDV2_MINLEN
condition|)
block|{
name|printf
argument_list|(
literal|"v2 "
argument_list|)
expr_stmt|;
name|mldv2_query_print
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|dp
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" unknown-version (len %u) "
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ICMP6_MEMBERSHIP_REPORT
case|:
name|mld6_print
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|dp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_MEMBERSHIP_REDUCTION
case|:
name|mld6_print
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|dp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ND_ROUTER_SOLICIT
case|:
define|#
directive|define
name|RTSOLLEN
value|8
if|if
condition|(
name|vflag
condition|)
block|{
name|icmp6_opt_print
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|dp
operator|+
name|RTSOLLEN
argument_list|,
name|length
operator|-
name|RTSOLLEN
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ND_ROUTER_ADVERT
case|:
define|#
directive|define
name|RTADVLEN
value|16
if|if
condition|(
name|vflag
condition|)
block|{
name|struct
name|nd_router_advert
modifier|*
name|p
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|nd_router_advert
operator|*
operator|)
name|dp
expr_stmt|;
name|TCHECK
argument_list|(
name|p
operator|->
name|nd_ra_retransmit
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\thop limit %u, Flags [%s]"
expr|\
literal|", pref %s, router lifetime %us, reachable time %us, retrans time %us"
argument_list|,
operator|(
name|u_int
operator|)
name|p
operator|->
name|nd_ra_curhoplimit
argument_list|,
name|bittok2str
argument_list|(
name|icmp6_opt_ra_flag_values
argument_list|,
literal|"none"
argument_list|,
operator|(
name|p
operator|->
name|nd_ra_flags_reserved
operator|)
argument_list|)
argument_list|,
name|get_rtpref
argument_list|(
name|p
operator|->
name|nd_ra_flags_reserved
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|p
operator|->
name|nd_ra_router_lifetime
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|p
operator|->
name|nd_ra_reachable
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|p
operator|->
name|nd_ra_retransmit
argument_list|)
argument_list|)
expr_stmt|;
name|icmp6_opt_print
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|dp
operator|+
name|RTADVLEN
argument_list|,
name|length
operator|-
name|RTADVLEN
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ND_NEIGHBOR_SOLICIT
case|:
block|{
name|struct
name|nd_neighbor_solicit
modifier|*
name|p
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|nd_neighbor_solicit
operator|*
operator|)
name|dp
expr_stmt|;
name|TCHECK
argument_list|(
name|p
operator|->
name|nd_ns_target
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", who has %s"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|p
operator|->
name|nd_ns_target
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
define|#
directive|define
name|NDSOLLEN
value|24
name|icmp6_opt_print
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|dp
operator|+
name|NDSOLLEN
argument_list|,
name|length
operator|-
name|NDSOLLEN
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|ND_NEIGHBOR_ADVERT
case|:
block|{
name|struct
name|nd_neighbor_advert
modifier|*
name|p
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|nd_neighbor_advert
operator|*
operator|)
name|dp
expr_stmt|;
name|TCHECK
argument_list|(
name|p
operator|->
name|nd_na_target
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", tgt is %s"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|p
operator|->
name|nd_na_target
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
name|printf
argument_list|(
literal|", Flags [%s]"
argument_list|,
name|bittok2str
argument_list|(
name|icmp6_nd_na_flag_values
argument_list|,
literal|"none"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|p
operator|->
name|nd_na_flags_reserved
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
define|#
directive|define
name|NDADVLEN
value|24
name|icmp6_opt_print
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|dp
operator|+
name|NDADVLEN
argument_list|,
name|length
operator|-
name|NDADVLEN
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|NDADVLEN
block|}
block|}
break|break;
case|case
name|ND_REDIRECT
case|:
define|#
directive|define
name|RDR
parameter_list|(
name|i
parameter_list|)
value|((struct nd_redirect *)(i))
name|TCHECK
argument_list|(
name|RDR
argument_list|(
name|dp
argument_list|)
operator|->
name|nd_rd_dst
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %s"
argument_list|,
name|getname6
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|&
name|RDR
argument_list|(
name|dp
argument_list|)
operator|->
name|nd_rd_dst
argument_list|)
argument_list|)
expr_stmt|;
name|TCHECK
argument_list|(
name|RDR
argument_list|(
name|dp
argument_list|)
operator|->
name|nd_rd_target
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" to %s"
argument_list|,
name|getname6
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|&
name|RDR
argument_list|(
name|dp
argument_list|)
operator|->
name|nd_rd_target
argument_list|)
argument_list|)
expr_stmt|;
define|#
directive|define
name|REDIRECTLEN
value|40
if|if
condition|(
name|vflag
condition|)
block|{
name|icmp6_opt_print
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|dp
operator|+
name|REDIRECTLEN
argument_list|,
name|length
operator|-
name|REDIRECTLEN
argument_list|)
expr_stmt|;
block|}
break|break;
undef|#
directive|undef
name|REDIRECTLEN
undef|#
directive|undef
name|RDR
case|case
name|ICMP6_ROUTER_RENUMBERING
case|:
name|icmp6_rrenum_print
argument_list|(
name|bp
argument_list|,
name|ep
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_NI_QUERY
case|:
case|case
name|ICMP6_NI_REPLY
case|:
name|icmp6_nodeinfo_print
argument_list|(
name|length
argument_list|,
name|bp
argument_list|,
name|ep
argument_list|)
expr_stmt|;
break|break;
case|case
name|IND_SOLICIT
case|:
case|case
name|IND_ADVERT
case|:
break|break;
case|case
name|ICMP6_V2_MEMBERSHIP_REPORT
case|:
name|mldv2_report_print
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|dp
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_MOBILEPREFIX_SOLICIT
case|:
comment|/* fall through */
case|case
name|ICMP6_HADISCOV_REQUEST
case|:
name|TCHECK
argument_list|(
name|dp
operator|->
name|icmp6_data16
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", id 0x%04x"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|dp
operator|->
name|icmp6_data16
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_HADISCOV_REPLY
case|:
if|if
condition|(
name|vflag
condition|)
block|{
name|struct
name|in6_addr
modifier|*
name|in6
decl_stmt|;
name|u_char
modifier|*
name|cp
decl_stmt|;
name|TCHECK
argument_list|(
name|dp
operator|->
name|icmp6_data16
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", id 0x%04x"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|dp
operator|->
name|icmp6_data16
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|cp
operator|=
operator|(
name|u_char
operator|*
operator|)
name|dp
operator|+
name|length
expr_stmt|;
name|in6
operator|=
operator|(
expr|struct
name|in6_addr
operator|*
operator|)
operator|(
name|dp
operator|+
literal|1
operator|)
expr_stmt|;
for|for
control|(
init|;
operator|(
name|u_char
operator|*
operator|)
name|in6
operator|<
name|cp
condition|;
name|in6
operator|++
control|)
block|{
name|TCHECK
argument_list|(
operator|*
name|in6
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %s"
argument_list|,
name|ip6addr_string
argument_list|(
name|in6
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|ICMP6_MOBILEPREFIX_ADVERT
case|:
if|if
condition|(
name|vflag
condition|)
block|{
name|TCHECK
argument_list|(
name|dp
operator|->
name|icmp6_data16
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", id 0x%04x"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|dp
operator|->
name|icmp6_data16
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|icmp6_data16
index|[
literal|1
index|]
operator|&
literal|0xc0
condition|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|icmp6_data16
index|[
literal|1
index|]
operator|&
literal|0x80
condition|)
name|printf
argument_list|(
literal|"M"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|icmp6_data16
index|[
literal|1
index|]
operator|&
literal|0x40
condition|)
name|printf
argument_list|(
literal|"O"
argument_list|)
expr_stmt|;
define|#
directive|define
name|MPADVLEN
value|8
name|icmp6_opt_print
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|dp
operator|+
name|MPADVLEN
argument_list|,
name|length
operator|-
name|MPADVLEN
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ND_RPL_MESSAGE
case|:
name|rpl_print
argument_list|(
name|ndo
argument_list|,
name|dp
argument_list|,
operator|&
name|dp
operator|->
name|icmp6_data8
index|[
literal|0
index|]
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|", length %u"
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|bp
argument_list|,
literal|"\n\t"
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|vflag
condition|)
name|printf
argument_list|(
literal|", length %u"
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|fputs
argument_list|(
literal|"[|icmp6]"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|udphdr
modifier|*
name|get_upperlayer
parameter_list|(
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
modifier|*
name|prot
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6
init|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
name|bp
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|uh
decl_stmt|;
name|struct
name|ip6_hbh
modifier|*
name|hbh
decl_stmt|;
name|struct
name|ip6_frag
modifier|*
name|fragh
decl_stmt|;
name|struct
name|ah
modifier|*
name|ah
decl_stmt|;
name|u_int
name|nh
decl_stmt|;
name|int
name|hlen
decl_stmt|;
comment|/* 'ep' points to the end of available data. */
name|ep
operator|=
name|snapend
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST
argument_list|(
name|ip6
operator|->
name|ip6_nxt
argument_list|)
condition|)
return|return
name|NULL
return|;
name|nh
operator|=
name|ip6
operator|->
name|ip6_nxt
expr_stmt|;
name|hlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
expr_stmt|;
while|while
condition|(
name|bp
operator|<
name|ep
condition|)
block|{
name|bp
operator|+=
name|hlen
expr_stmt|;
switch|switch
condition|(
name|nh
condition|)
block|{
case|case
name|IPPROTO_UDP
case|:
case|case
name|IPPROTO_TCP
case|:
name|uh
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
name|bp
expr_stmt|;
if|if
condition|(
name|TTEST
argument_list|(
name|uh
operator|->
name|uh_dport
argument_list|)
condition|)
block|{
operator|*
name|prot
operator|=
name|nh
expr_stmt|;
return|return
operator|(
name|uh
operator|)
return|;
block|}
else|else
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* NOTREACHED */
case|case
name|IPPROTO_HOPOPTS
case|:
case|case
name|IPPROTO_DSTOPTS
case|:
case|case
name|IPPROTO_ROUTING
case|:
name|hbh
operator|=
operator|(
expr|struct
name|ip6_hbh
operator|*
operator|)
name|bp
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST
argument_list|(
name|hbh
operator|->
name|ip6h_len
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|nh
operator|=
name|hbh
operator|->
name|ip6h_nxt
expr_stmt|;
name|hlen
operator|=
operator|(
name|hbh
operator|->
name|ip6h_len
operator|+
literal|1
operator|)
operator|<<
literal|3
expr_stmt|;
break|break;
case|case
name|IPPROTO_FRAGMENT
case|:
comment|/* this should be odd, but try anyway */
name|fragh
operator|=
operator|(
expr|struct
name|ip6_frag
operator|*
operator|)
name|bp
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST
argument_list|(
name|fragh
operator|->
name|ip6f_offlg
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* fragments with non-zero offset are meaningless */
if|if
condition|(
operator|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|fragh
operator|->
name|ip6f_offlg
argument_list|)
operator|&
name|IP6F_OFF_MASK
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|nh
operator|=
name|fragh
operator|->
name|ip6f_nxt
expr_stmt|;
name|hlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_frag
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_AH
case|:
name|ah
operator|=
operator|(
expr|struct
name|ah
operator|*
operator|)
name|bp
expr_stmt|;
if|if
condition|(
operator|!
name|TTEST
argument_list|(
name|ah
operator|->
name|ah_len
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|nh
operator|=
name|ah
operator|->
name|ah_nxt
expr_stmt|;
name|hlen
operator|=
operator|(
name|ah
operator|->
name|ah_len
operator|+
literal|2
operator|)
operator|<<
literal|2
expr_stmt|;
break|break;
default|default:
comment|/* unknown or undecodable header */
operator|*
name|prot
operator|=
name|nh
expr_stmt|;
comment|/* meaningless, but set here anyway */
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* should be notreached, though */
block|}
end_function

begin_function
specifier|static
name|void
name|icmp6_opt_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|int
name|resid
parameter_list|)
block|{
specifier|const
name|struct
name|nd_opt_hdr
modifier|*
name|op
decl_stmt|;
specifier|const
name|struct
name|nd_opt_hdr
modifier|*
name|opl
decl_stmt|;
comment|/* why there's no struct? */
specifier|const
name|struct
name|nd_opt_prefix_info
modifier|*
name|opp
decl_stmt|;
specifier|const
name|struct
name|icmp6_opts_redirect
modifier|*
name|opr
decl_stmt|;
specifier|const
name|struct
name|nd_opt_mtu
modifier|*
name|opm
decl_stmt|;
specifier|const
name|struct
name|nd_opt_rdnss
modifier|*
name|oprd
decl_stmt|;
specifier|const
name|struct
name|nd_opt_advinterval
modifier|*
name|opa
decl_stmt|;
specifier|const
name|struct
name|nd_opt_homeagent_info
modifier|*
name|oph
decl_stmt|;
specifier|const
name|struct
name|nd_opt_route_info
modifier|*
name|opri
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|ep
decl_stmt|;
name|struct
name|in6_addr
name|in6
decl_stmt|,
modifier|*
name|in6p
decl_stmt|;
name|size_t
name|l
decl_stmt|;
name|u_int
name|i
decl_stmt|;
define|#
directive|define
name|ECHECK
parameter_list|(
name|var
parameter_list|)
value|if ((u_char *)&(var)> ep - sizeof(var)) return
name|cp
operator|=
name|bp
expr_stmt|;
comment|/* 'ep' points to the end of available data. */
name|ep
operator|=
name|snapend
expr_stmt|;
while|while
condition|(
name|cp
operator|<
name|ep
condition|)
block|{
name|op
operator|=
operator|(
expr|struct
name|nd_opt_hdr
operator|*
operator|)
name|cp
expr_stmt|;
name|ECHECK
argument_list|(
name|op
operator|->
name|nd_opt_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|resid
operator|<=
literal|0
condition|)
return|return;
if|if
condition|(
name|op
operator|->
name|nd_opt_len
operator|==
literal|0
condition|)
goto|goto
name|trunc
goto|;
if|if
condition|(
name|cp
operator|+
operator|(
name|op
operator|->
name|nd_opt_len
operator|<<
literal|3
operator|)
operator|>
name|ep
condition|)
goto|goto
name|trunc
goto|;
name|printf
argument_list|(
literal|"\n\t  %s option (%u), length %u (%u): "
argument_list|,
name|tok2str
argument_list|(
name|icmp6_opt_values
argument_list|,
literal|"unknown"
argument_list|,
name|op
operator|->
name|nd_opt_type
argument_list|)
argument_list|,
name|op
operator|->
name|nd_opt_type
argument_list|,
name|op
operator|->
name|nd_opt_len
operator|<<
literal|3
argument_list|,
name|op
operator|->
name|nd_opt_len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|op
operator|->
name|nd_opt_type
condition|)
block|{
case|case
name|ND_OPT_SOURCE_LINKADDR
case|:
name|opl
operator|=
operator|(
expr|struct
name|nd_opt_hdr
operator|*
operator|)
name|op
expr_stmt|;
name|l
operator|=
operator|(
name|op
operator|->
name|nd_opt_len
operator|<<
literal|3
operator|)
operator|-
literal|2
expr_stmt|;
name|print_lladdr
argument_list|(
name|cp
operator|+
literal|2
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
case|case
name|ND_OPT_TARGET_LINKADDR
case|:
name|opl
operator|=
operator|(
expr|struct
name|nd_opt_hdr
operator|*
operator|)
name|op
expr_stmt|;
name|l
operator|=
operator|(
name|op
operator|->
name|nd_opt_len
operator|<<
literal|3
operator|)
operator|-
literal|2
expr_stmt|;
name|print_lladdr
argument_list|(
name|cp
operator|+
literal|2
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
case|case
name|ND_OPT_PREFIX_INFORMATION
case|:
name|opp
operator|=
operator|(
expr|struct
name|nd_opt_prefix_info
operator|*
operator|)
name|op
expr_stmt|;
name|TCHECK
argument_list|(
name|opp
operator|->
name|nd_opt_pi_prefix
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s/%u%s, Flags [%s], valid time %ss"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|opp
operator|->
name|nd_opt_pi_prefix
argument_list|)
argument_list|,
name|opp
operator|->
name|nd_opt_pi_prefix_len
argument_list|,
operator|(
name|op
operator|->
name|nd_opt_len
operator|!=
literal|4
operator|)
condition|?
literal|"badlen"
else|:
literal|""
argument_list|,
name|bittok2str
argument_list|(
name|icmp6_opt_pi_flag_values
argument_list|,
literal|"none"
argument_list|,
name|opp
operator|->
name|nd_opt_pi_flags_reserved
argument_list|)
argument_list|,
name|get_lifetime
argument_list|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|opp
operator|->
name|nd_opt_pi_valid_time
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", pref. time %ss"
argument_list|,
name|get_lifetime
argument_list|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|opp
operator|->
name|nd_opt_pi_preferred_time
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ND_OPT_REDIRECTED_HEADER
case|:
name|opr
operator|=
operator|(
expr|struct
name|icmp6_opts_redirect
operator|*
operator|)
name|op
expr_stmt|;
name|print_unknown_data
argument_list|(
name|bp
argument_list|,
literal|"\n\t    "
argument_list|,
name|op
operator|->
name|nd_opt_len
operator|<<
literal|3
argument_list|)
expr_stmt|;
comment|/* xxx */
break|break;
case|case
name|ND_OPT_MTU
case|:
name|opm
operator|=
operator|(
expr|struct
name|nd_opt_mtu
operator|*
operator|)
name|op
expr_stmt|;
name|TCHECK
argument_list|(
name|opm
operator|->
name|nd_opt_mtu_mtu
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %u%s"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|opm
operator|->
name|nd_opt_mtu_mtu
argument_list|)
argument_list|,
operator|(
name|op
operator|->
name|nd_opt_len
operator|!=
literal|1
operator|)
condition|?
literal|"bad option length"
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|ND_OPT_RDNSS
case|:
name|oprd
operator|=
operator|(
expr|struct
name|nd_opt_rdnss
operator|*
operator|)
name|op
expr_stmt|;
name|l
operator|=
operator|(
name|op
operator|->
name|nd_opt_len
operator|-
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
name|printf
argument_list|(
literal|" lifetime %us,"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|oprd
operator|->
name|nd_opt_rdnss_lifetime
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|l
condition|;
name|i
operator|++
control|)
block|{
name|TCHECK
argument_list|(
name|oprd
operator|->
name|nd_opt_rdnss_addr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" addr: %s"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|oprd
operator|->
name|nd_opt_rdnss_addr
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ND_OPT_ADVINTERVAL
case|:
name|opa
operator|=
operator|(
expr|struct
name|nd_opt_advinterval
operator|*
operator|)
name|op
expr_stmt|;
name|TCHECK
argument_list|(
name|opa
operator|->
name|nd_opt_adv_interval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %ums"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|opa
operator|->
name|nd_opt_adv_interval
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ND_OPT_HOMEAGENT_INFO
case|:
name|oph
operator|=
operator|(
expr|struct
name|nd_opt_homeagent_info
operator|*
operator|)
name|op
expr_stmt|;
name|TCHECK
argument_list|(
name|oph
operator|->
name|nd_opt_hai_lifetime
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" preference %u, lifetime %u"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|oph
operator|->
name|nd_opt_hai_preference
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|oph
operator|->
name|nd_opt_hai_lifetime
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ND_OPT_ROUTE_INFO
case|:
name|opri
operator|=
operator|(
expr|struct
name|nd_opt_route_info
operator|*
operator|)
name|op
expr_stmt|;
name|TCHECK
argument_list|(
name|opri
operator|->
name|nd_opt_rti_lifetime
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|in6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in6
argument_list|)
argument_list|)
expr_stmt|;
name|in6p
operator|=
operator|(
expr|struct
name|in6_addr
operator|*
operator|)
operator|(
name|opri
operator|+
literal|1
operator|)
expr_stmt|;
switch|switch
condition|(
name|op
operator|->
name|nd_opt_len
condition|)
block|{
case|case
literal|1
case|:
break|break;
case|case
literal|2
case|:
name|TCHECK2
argument_list|(
operator|*
name|in6p
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|in6
argument_list|,
name|opri
operator|+
literal|1
argument_list|,
literal|8
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|TCHECK
argument_list|(
operator|*
name|in6p
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|in6
argument_list|,
name|opri
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|in6
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
goto|goto
name|trunc
goto|;
block|}
name|printf
argument_list|(
literal|" %s/%u"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|in6
argument_list|)
argument_list|,
name|opri
operator|->
name|nd_opt_rti_prefixlen
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", pref=%s"
argument_list|,
name|get_rtpref
argument_list|(
name|opri
operator|->
name|nd_opt_rti_flags
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", lifetime=%s"
argument_list|,
name|get_lifetime
argument_list|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|opri
operator|->
name|nd_opt_rti_lifetime
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|vflag
operator|<=
literal|1
condition|)
block|{
name|print_unknown_data
argument_list|(
name|cp
operator|+
literal|2
argument_list|,
literal|"\n\t  "
argument_list|,
operator|(
name|op
operator|->
name|nd_opt_len
operator|<<
literal|3
operator|)
operator|-
literal|2
argument_list|)
expr_stmt|;
comment|/* skip option header */
return|return;
block|}
break|break;
block|}
comment|/* do we want to see an additional hexdump ? */
if|if
condition|(
name|vflag
operator|>
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|cp
operator|+
literal|2
argument_list|,
literal|"\n\t    "
argument_list|,
operator|(
name|op
operator|->
name|nd_opt_len
operator|<<
literal|3
operator|)
operator|-
literal|2
argument_list|)
expr_stmt|;
comment|/* skip option header */
name|cp
operator|+=
name|op
operator|->
name|nd_opt_len
operator|<<
literal|3
expr_stmt|;
name|resid
operator|-=
name|op
operator|->
name|nd_opt_len
operator|<<
literal|3
expr_stmt|;
block|}
return|return;
name|trunc
label|:
name|fputs
argument_list|(
literal|"[ndp opt]"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
return|return;
undef|#
directive|undef
name|ECHECK
block|}
end_function

begin_function
specifier|static
name|void
name|mld6_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|)
block|{
name|struct
name|mld6_hdr
modifier|*
name|mp
init|=
operator|(
expr|struct
name|mld6_hdr
operator|*
operator|)
name|bp
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
comment|/* 'ep' points to the end of available data. */
name|ep
operator|=
name|snapend
expr_stmt|;
if|if
condition|(
operator|(
name|u_char
operator|*
operator|)
name|mp
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|mp
argument_list|)
operator|>
name|ep
condition|)
return|return;
name|printf
argument_list|(
literal|"max resp delay: %d "
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|mp
operator|->
name|mld6_maxdelay
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"addr: %s"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|mp
operator|->
name|mld6_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mldv2_report_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|struct
name|icmp6_hdr
modifier|*
name|icp
init|=
operator|(
expr|struct
name|icmp6_hdr
operator|*
operator|)
name|bp
decl_stmt|;
name|u_int
name|group
decl_stmt|,
name|nsrcs
decl_stmt|,
name|ngroups
decl_stmt|;
name|u_int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* Minimum len is 8 */
if|if
condition|(
name|len
operator|<
literal|8
condition|)
block|{
name|printf
argument_list|(
literal|" [invalid len %d]"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|TCHECK
argument_list|(
name|icp
operator|->
name|icmp6_data16
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|ngroups
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|icp
operator|->
name|icmp6_data16
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d group record(s)"
argument_list|,
name|ngroups
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|>
literal|0
condition|)
block|{
comment|/* Print the group records */
name|group
operator|=
literal|8
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ngroups
condition|;
name|i
operator|++
control|)
block|{
comment|/* type(1) + auxlen(1) + numsrc(2) + grp(16) */
if|if
condition|(
name|len
operator|<
name|group
operator|+
literal|20
condition|)
block|{
name|printf
argument_list|(
literal|" [invalid number of groups]"
argument_list|)
expr_stmt|;
return|return;
block|}
name|TCHECK2
argument_list|(
name|bp
index|[
name|group
operator|+
literal|4
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" [gaddr %s"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|bp
index|[
name|group
operator|+
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|tok2str
argument_list|(
name|mldv2report2str
argument_list|,
literal|" [v2-report-#%d]"
argument_list|,
name|bp
index|[
name|group
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|nsrcs
operator|=
operator|(
name|bp
index|[
name|group
operator|+
literal|2
index|]
operator|<<
literal|8
operator|)
operator|+
name|bp
index|[
name|group
operator|+
literal|3
index|]
expr_stmt|;
comment|/* Check the number of sources and print them */
if|if
condition|(
name|len
operator|<
name|group
operator|+
literal|20
operator|+
operator|(
name|nsrcs
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|" [invalid number of sources %d]"
argument_list|,
name|nsrcs
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|vflag
operator|==
literal|1
condition|)
name|printf
argument_list|(
literal|", %d source(s)"
argument_list|,
name|nsrcs
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* Print the sources */
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" {"
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nsrcs
condition|;
name|j
operator|++
control|)
block|{
name|TCHECK2
argument_list|(
name|bp
index|[
name|group
operator|+
literal|20
operator|+
name|j
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|bp
index|[
name|group
operator|+
literal|20
operator|+
name|j
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" }"
argument_list|)
expr_stmt|;
block|}
comment|/* Next group record */
name|group
operator|+=
literal|20
operator|+
name|nsrcs
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
name|trunc
label|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"[|icmp6]"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|mldv2_query_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|struct
name|icmp6_hdr
modifier|*
name|icp
init|=
operator|(
expr|struct
name|icmp6_hdr
operator|*
operator|)
name|bp
decl_stmt|;
name|u_int
name|mrc
decl_stmt|;
name|int
name|mrt
decl_stmt|,
name|qqi
decl_stmt|;
name|u_int
name|nsrcs
decl_stmt|;
specifier|register
name|u_int
name|i
decl_stmt|;
comment|/* Minimum len is 28 */
if|if
condition|(
name|len
operator|<
literal|28
condition|)
block|{
name|printf
argument_list|(
literal|" [invalid len %d]"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|TCHECK
argument_list|(
name|icp
operator|->
name|icmp6_data16
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|mrc
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|icp
operator|->
name|icmp6_data16
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|mrc
operator|<
literal|32768
condition|)
block|{
name|mrt
operator|=
name|mrc
expr_stmt|;
block|}
else|else
block|{
name|mrt
operator|=
operator|(
operator|(
name|mrc
operator|&
literal|0x0fff
operator|)
operator||
literal|0x1000
operator|)
operator|<<
operator|(
operator|(
operator|(
name|mrc
operator|&
literal|0x7000
operator|)
operator|>>
literal|12
operator|)
operator|+
literal|3
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|vflag
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" [max resp delay=%d]"
argument_list|,
name|mrt
argument_list|)
expr_stmt|;
block|}
name|TCHECK2
argument_list|(
name|bp
index|[
literal|8
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" [gaddr %s"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|bp
index|[
literal|8
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
name|TCHECK
argument_list|(
name|bp
index|[
literal|25
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
index|[
literal|24
index|]
operator|&
literal|0x08
condition|)
block|{
name|printf
argument_list|(
literal|" sflag"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bp
index|[
literal|24
index|]
operator|&
literal|0x07
condition|)
block|{
name|printf
argument_list|(
literal|" robustness=%d"
argument_list|,
name|bp
index|[
literal|24
index|]
operator|&
literal|0x07
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bp
index|[
literal|25
index|]
operator|<
literal|128
condition|)
block|{
name|qqi
operator|=
name|bp
index|[
literal|25
index|]
expr_stmt|;
block|}
else|else
block|{
name|qqi
operator|=
operator|(
operator|(
name|bp
index|[
literal|25
index|]
operator|&
literal|0x0f
operator|)
operator||
literal|0x10
operator|)
operator|<<
operator|(
operator|(
operator|(
name|bp
index|[
literal|25
index|]
operator|&
literal|0x70
operator|)
operator|>>
literal|4
operator|)
operator|+
literal|3
operator|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" qqi=%d"
argument_list|,
name|qqi
argument_list|)
expr_stmt|;
block|}
name|TCHECK2
argument_list|(
name|bp
index|[
literal|26
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|nsrcs
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bp
index|[
literal|26
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsrcs
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|len
operator|<
literal|28
operator|+
name|nsrcs
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
condition|)
name|printf
argument_list|(
literal|" [invalid number of sources]"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|vflag
operator|>
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|" {"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsrcs
condition|;
name|i
operator|++
control|)
block|{
name|TCHECK2
argument_list|(
name|bp
index|[
literal|28
operator|+
name|i
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|bp
index|[
literal|28
operator|+
name|i
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" }"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|", %d source(s)"
argument_list|,
name|nsrcs
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"[|icmp6]"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|dnsname_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* DNS name decoding - no decompression */
name|printf
argument_list|(
literal|", \""
argument_list|)
expr_stmt|;
while|while
condition|(
name|cp
operator|<
name|ep
condition|)
block|{
name|i
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
name|i
operator|>
name|ep
operator|-
name|cp
condition|)
block|{
name|printf
argument_list|(
literal|"???"
argument_list|)
expr_stmt|;
break|break;
block|}
while|while
condition|(
name|i
operator|--
operator|&&
name|cp
operator|<
name|ep
condition|)
block|{
name|safeputchar
argument_list|(
operator|*
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|cp
operator|+
literal|1
operator|<
name|ep
operator|&&
operator|*
name|cp
condition|)
name|printf
argument_list|(
literal|"."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|cp
operator|==
name|ep
condition|)
block|{
comment|/* FQDN */
name|printf
argument_list|(
literal|"."
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cp
operator|+
literal|1
operator|==
name|ep
operator|&&
operator|*
name|cp
operator|==
literal|'\0'
condition|)
block|{
comment|/* truncated */
block|}
else|else
block|{
comment|/* invalid */
name|printf
argument_list|(
literal|"???"
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
name|printf
argument_list|(
literal|"\""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|icmp6_nodeinfo_print
parameter_list|(
name|u_int
name|icmp6len
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|)
block|{
name|struct
name|icmp6_nodeinfo
modifier|*
name|ni6
decl_stmt|;
name|struct
name|icmp6_hdr
modifier|*
name|dp
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
name|size_t
name|siz
decl_stmt|,
name|i
decl_stmt|;
name|int
name|needcomma
decl_stmt|;
if|if
condition|(
name|ep
operator|<
name|bp
condition|)
return|return;
name|dp
operator|=
operator|(
expr|struct
name|icmp6_hdr
operator|*
operator|)
name|bp
expr_stmt|;
name|ni6
operator|=
operator|(
expr|struct
name|icmp6_nodeinfo
operator|*
operator|)
name|bp
expr_stmt|;
name|siz
operator|=
name|ep
operator|-
name|bp
expr_stmt|;
switch|switch
condition|(
name|ni6
operator|->
name|ni_type
condition|)
block|{
case|case
name|ICMP6_NI_QUERY
case|:
if|if
condition|(
name|siz
operator|==
sizeof|sizeof
argument_list|(
operator|*
name|dp
argument_list|)
operator|+
literal|4
condition|)
block|{
comment|/* KAME who-are-you */
name|printf
argument_list|(
literal|" who-are-you request"
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|" node information query"
argument_list|)
expr_stmt|;
name|TCHECK2
argument_list|(
operator|*
name|dp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ni6
argument_list|)
argument_list|)
expr_stmt|;
name|ni6
operator|=
operator|(
expr|struct
name|icmp6_nodeinfo
operator|*
operator|)
name|dp
expr_stmt|;
name|printf
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
comment|/*)*/
switch|switch
condition|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ni6
operator|->
name|ni_qtype
argument_list|)
condition|)
block|{
case|case
name|NI_QTYPE_NOOP
case|:
name|printf
argument_list|(
literal|"noop"
argument_list|)
expr_stmt|;
break|break;
case|case
name|NI_QTYPE_SUPTYPES
case|:
name|printf
argument_list|(
literal|"supported qtypes"
argument_list|)
expr_stmt|;
name|i
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ni6
operator|->
name|ni_flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
name|printf
argument_list|(
literal|" [%s]"
argument_list|,
operator|(
name|i
operator|&
literal|0x01
operator|)
condition|?
literal|"C"
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
break|break;
case|case
name|NI_QTYPE_FQDN
case|:
name|printf
argument_list|(
literal|"DNS name"
argument_list|)
expr_stmt|;
break|break;
case|case
name|NI_QTYPE_NODEADDR
case|:
name|printf
argument_list|(
literal|"node addresses"
argument_list|)
expr_stmt|;
name|i
operator|=
name|ni6
operator|->
name|ni_flags
expr_stmt|;
if|if
condition|(
operator|!
name|i
condition|)
break|break;
comment|/* NI_NODEADDR_FLAG_TRUNCATE undefined for query */
name|printf
argument_list|(
literal|" [%s%s%s%s%s%s]"
argument_list|,
operator|(
name|i
operator|&
name|NI_NODEADDR_FLAG_ANYCAST
operator|)
condition|?
literal|"a"
else|:
literal|""
argument_list|,
operator|(
name|i
operator|&
name|NI_NODEADDR_FLAG_GLOBAL
operator|)
condition|?
literal|"G"
else|:
literal|""
argument_list|,
operator|(
name|i
operator|&
name|NI_NODEADDR_FLAG_SITELOCAL
operator|)
condition|?
literal|"S"
else|:
literal|""
argument_list|,
operator|(
name|i
operator|&
name|NI_NODEADDR_FLAG_LINKLOCAL
operator|)
condition|?
literal|"L"
else|:
literal|""
argument_list|,
operator|(
name|i
operator|&
name|NI_NODEADDR_FLAG_COMPAT
operator|)
condition|?
literal|"C"
else|:
literal|""
argument_list|,
operator|(
name|i
operator|&
name|NI_NODEADDR_FLAG_ALL
operator|)
condition|?
literal|"A"
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ni6
operator|->
name|ni_qtype
operator|==
name|NI_QTYPE_NOOP
operator|||
name|ni6
operator|->
name|ni_qtype
operator|==
name|NI_QTYPE_SUPTYPES
condition|)
block|{
if|if
condition|(
name|siz
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ni6
argument_list|)
condition|)
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|", invalid len"
argument_list|)
expr_stmt|;
comment|/*(*/
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* XXX backward compat, icmp-name-lookup-03 */
if|if
condition|(
name|siz
operator|==
sizeof|sizeof
argument_list|(
operator|*
name|ni6
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|", 03 draft"
argument_list|)
expr_stmt|;
comment|/*(*/
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|ni6
operator|->
name|ni_code
condition|)
block|{
case|case
name|ICMP6_NI_SUBJ_IPV6
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|dp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ni6
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
condition|)
break|break;
if|if
condition|(
name|siz
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ni6
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
condition|)
block|{
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|", invalid subject len"
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|", subject=%s"
argument_list|,
name|getname6
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|(
name|ni6
operator|+
literal|1
operator|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_NI_SUBJ_FQDN
case|:
name|printf
argument_list|(
literal|", subject=DNS name"
argument_list|)
expr_stmt|;
name|cp
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|(
name|ni6
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|cp
index|[
literal|0
index|]
operator|==
name|ep
operator|-
name|cp
operator|-
literal|1
condition|)
block|{
comment|/* icmp-name-lookup-03, pascal string */
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|", 03 draft"
argument_list|)
expr_stmt|;
name|cp
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|", \""
argument_list|)
expr_stmt|;
while|while
condition|(
name|cp
operator|<
name|ep
condition|)
block|{
name|safeputchar
argument_list|(
operator|*
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|++
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\""
argument_list|)
expr_stmt|;
block|}
else|else
name|dnsname_print
argument_list|(
name|cp
argument_list|,
name|ep
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_NI_SUBJ_IPV4
case|:
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
operator|*
name|dp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ni6
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
condition|)
break|break;
if|if
condition|(
name|siz
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ni6
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
condition|)
block|{
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|", invalid subject len"
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|", subject=%s"
argument_list|,
name|getname
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|(
name|ni6
operator|+
literal|1
operator|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|", unknown subject"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*(*/
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_NI_REPLY
case|:
if|if
condition|(
name|icmp6len
operator|>
name|siz
condition|)
block|{
name|printf
argument_list|(
literal|"[|icmp6: node information reply]"
argument_list|)
expr_stmt|;
break|break;
block|}
name|needcomma
operator|=
literal|0
expr_stmt|;
name|ni6
operator|=
operator|(
expr|struct
name|icmp6_nodeinfo
operator|*
operator|)
name|dp
expr_stmt|;
name|printf
argument_list|(
literal|" node information reply"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
comment|/*)*/
switch|switch
condition|(
name|ni6
operator|->
name|ni_code
condition|)
block|{
case|case
name|ICMP6_NI_SUCCESS
case|:
if|if
condition|(
name|vflag
condition|)
block|{
name|printf
argument_list|(
literal|"success"
argument_list|)
expr_stmt|;
name|needcomma
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|ICMP6_NI_REFUSED
case|:
name|printf
argument_list|(
literal|"refused"
argument_list|)
expr_stmt|;
name|needcomma
operator|++
expr_stmt|;
if|if
condition|(
name|siz
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ni6
argument_list|)
condition|)
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|", invalid length"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_NI_UNKNOWN
case|:
name|printf
argument_list|(
literal|"unknown"
argument_list|)
expr_stmt|;
name|needcomma
operator|++
expr_stmt|;
if|if
condition|(
name|siz
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ni6
argument_list|)
condition|)
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|", invalid length"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ni6
operator|->
name|ni_code
operator|!=
name|ICMP6_NI_SUCCESS
condition|)
block|{
comment|/*(*/
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ni6
operator|->
name|ni_qtype
argument_list|)
condition|)
block|{
case|case
name|NI_QTYPE_NOOP
case|:
if|if
condition|(
name|needcomma
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"noop"
argument_list|)
expr_stmt|;
if|if
condition|(
name|siz
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ni6
argument_list|)
condition|)
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|", invalid length"
argument_list|)
expr_stmt|;
break|break;
case|case
name|NI_QTYPE_SUPTYPES
case|:
if|if
condition|(
name|needcomma
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"supported qtypes"
argument_list|)
expr_stmt|;
name|i
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ni6
operator|->
name|ni_flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
name|printf
argument_list|(
literal|" [%s]"
argument_list|,
operator|(
name|i
operator|&
literal|0x01
operator|)
condition|?
literal|"C"
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|NI_QTYPE_FQDN
case|:
if|if
condition|(
name|needcomma
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"DNS name"
argument_list|)
expr_stmt|;
name|cp
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|(
name|ni6
operator|+
literal|1
operator|)
operator|+
literal|4
expr_stmt|;
if|if
condition|(
name|cp
index|[
literal|0
index|]
operator|==
name|ep
operator|-
name|cp
operator|-
literal|1
condition|)
block|{
comment|/* icmp-name-lookup-03, pascal string */
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|", 03 draft"
argument_list|)
expr_stmt|;
name|cp
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|", \""
argument_list|)
expr_stmt|;
while|while
condition|(
name|cp
operator|<
name|ep
condition|)
block|{
name|safeputchar
argument_list|(
operator|*
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|++
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\""
argument_list|)
expr_stmt|;
block|}
else|else
name|dnsname_print
argument_list|(
name|cp
argument_list|,
name|ep
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ni6
operator|->
name|ni_flags
argument_list|)
operator|&
literal|0x01
operator|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|" [TTL=%u]"
argument_list|,
operator|*
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|ni6
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|NI_QTYPE_NODEADDR
case|:
if|if
condition|(
name|needcomma
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"node addresses"
argument_list|)
expr_stmt|;
name|i
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ni6
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|siz
condition|)
block|{
if|if
condition|(
name|i
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
operator|>
name|siz
condition|)
break|break;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|getname6
argument_list|(
name|bp
operator|+
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(%d)"
argument_list|,
operator|(
name|int32_t
operator|)
name|EXTRACT_32BITS
argument_list|(
name|bp
operator|+
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
expr_stmt|;
block|}
name|i
operator|=
name|ni6
operator|->
name|ni_flags
expr_stmt|;
if|if
condition|(
operator|!
name|i
condition|)
break|break;
name|printf
argument_list|(
literal|" [%s%s%s%s%s%s%s]"
argument_list|,
operator|(
name|i
operator|&
name|NI_NODEADDR_FLAG_ANYCAST
operator|)
condition|?
literal|"a"
else|:
literal|""
argument_list|,
operator|(
name|i
operator|&
name|NI_NODEADDR_FLAG_GLOBAL
operator|)
condition|?
literal|"G"
else|:
literal|""
argument_list|,
operator|(
name|i
operator|&
name|NI_NODEADDR_FLAG_SITELOCAL
operator|)
condition|?
literal|"S"
else|:
literal|""
argument_list|,
operator|(
name|i
operator|&
name|NI_NODEADDR_FLAG_LINKLOCAL
operator|)
condition|?
literal|"L"
else|:
literal|""
argument_list|,
operator|(
name|i
operator|&
name|NI_NODEADDR_FLAG_COMPAT
operator|)
condition|?
literal|"C"
else|:
literal|""
argument_list|,
operator|(
name|i
operator|&
name|NI_NODEADDR_FLAG_ALL
operator|)
condition|?
literal|"A"
else|:
literal|""
argument_list|,
operator|(
name|i
operator|&
name|NI_NODEADDR_FLAG_TRUNCATE
operator|)
condition|?
literal|"T"
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|needcomma
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*(*/
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
name|trunc
label|:
name|fputs
argument_list|(
literal|"[|icmp6]"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|icmp6_rrenum_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|const
name|u_char
modifier|*
name|ep
parameter_list|)
block|{
name|struct
name|icmp6_router_renum
modifier|*
name|rr6
decl_stmt|;
specifier|const
name|char
modifier|*
name|cp
decl_stmt|;
name|struct
name|rr_pco_match
modifier|*
name|match
decl_stmt|;
name|struct
name|rr_pco_use
modifier|*
name|use
decl_stmt|;
name|char
name|hbuf
index|[
name|NI_MAXHOST
index|]
decl_stmt|;
name|int
name|n
decl_stmt|;
if|if
condition|(
name|ep
operator|<
name|bp
condition|)
return|return;
name|rr6
operator|=
operator|(
expr|struct
name|icmp6_router_renum
operator|*
operator|)
name|bp
expr_stmt|;
name|cp
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
operator|(
name|rr6
operator|+
literal|1
operator|)
expr_stmt|;
name|TCHECK
argument_list|(
name|rr6
operator|->
name|rr_reserved
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rr6
operator|->
name|rr_code
condition|)
block|{
case|case
name|ICMP6_ROUTER_RENUMBERING_COMMAND
case|:
name|printf
argument_list|(
literal|"router renum: command"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_ROUTER_RENUMBERING_RESULT
case|:
name|printf
argument_list|(
literal|"router renum: result"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP6_ROUTER_RENUMBERING_SEQNUM_RESET
case|:
name|printf
argument_list|(
literal|"router renum: sequence number reset"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"router renum: code-#%d"
argument_list|,
name|rr6
operator|->
name|rr_code
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|", seq=%u"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|rr6
operator|->
name|rr_seqnum
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
define|#
directive|define
name|F
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|((rr6->rr_flags)& (x) ? (y) : "")
name|printf
argument_list|(
literal|"["
argument_list|)
expr_stmt|;
comment|/*]*/
if|if
condition|(
name|rr6
operator|->
name|rr_flags
condition|)
block|{
name|printf
argument_list|(
literal|"%s%s%s%s%s,"
argument_list|,
name|F
argument_list|(
name|ICMP6_RR_FLAGS_TEST
argument_list|,
literal|"T"
argument_list|)
argument_list|,
name|F
argument_list|(
name|ICMP6_RR_FLAGS_REQRESULT
argument_list|,
literal|"R"
argument_list|)
argument_list|,
name|F
argument_list|(
name|ICMP6_RR_FLAGS_FORCEAPPLY
argument_list|,
literal|"A"
argument_list|)
argument_list|,
name|F
argument_list|(
name|ICMP6_RR_FLAGS_SPECSITE
argument_list|,
literal|"S"
argument_list|)
argument_list|,
name|F
argument_list|(
name|ICMP6_RR_FLAGS_PREVDONE
argument_list|,
literal|"P"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"seg=%u,"
argument_list|,
name|rr6
operator|->
name|rr_segnum
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"maxdelay=%u"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|rr6
operator|->
name|rr_maxdelay
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rr6
operator|->
name|rr_reserved
condition|)
name|printf
argument_list|(
literal|"rsvd=0x%x"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|rr6
operator|->
name|rr_reserved
argument_list|)
argument_list|)
expr_stmt|;
comment|/*[*/
name|printf
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|F
block|}
if|if
condition|(
name|rr6
operator|->
name|rr_code
operator|==
name|ICMP6_ROUTER_RENUMBERING_COMMAND
condition|)
block|{
name|match
operator|=
operator|(
expr|struct
name|rr_pco_match
operator|*
operator|)
name|cp
expr_stmt|;
name|cp
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
operator|(
name|match
operator|+
literal|1
operator|)
expr_stmt|;
name|TCHECK
argument_list|(
name|match
operator|->
name|rpm_prefix
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"\n\t"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"match("
argument_list|)
expr_stmt|;
comment|/*)*/
switch|switch
condition|(
name|match
operator|->
name|rpm_code
condition|)
block|{
case|case
name|RPM_PCO_ADD
case|:
name|printf
argument_list|(
literal|"add"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPM_PCO_CHANGE
case|:
name|printf
argument_list|(
literal|"change"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPM_PCO_SETGLOBAL
case|:
name|printf
argument_list|(
literal|"setglobal"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"#%u"
argument_list|,
name|match
operator|->
name|rpm_code
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vflag
condition|)
block|{
name|printf
argument_list|(
literal|",ord=%u"
argument_list|,
name|match
operator|->
name|rpm_ordinal
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|",min=%u"
argument_list|,
name|match
operator|->
name|rpm_minlen
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|",max=%u"
argument_list|,
name|match
operator|->
name|rpm_maxlen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
name|match
operator|->
name|rpm_prefix
argument_list|,
name|hbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|hbuf
argument_list|)
argument_list|)
condition|)
name|printf
argument_list|(
literal|",%s/%u"
argument_list|,
name|hbuf
argument_list|,
name|match
operator|->
name|rpm_matchlen
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|",?/%u"
argument_list|,
name|match
operator|->
name|rpm_matchlen
argument_list|)
expr_stmt|;
comment|/*(*/
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
name|n
operator|=
name|match
operator|->
name|rpm_len
operator|-
literal|3
expr_stmt|;
if|if
condition|(
name|n
operator|%
literal|4
condition|)
goto|goto
name|trunc
goto|;
name|n
operator|/=
literal|4
expr_stmt|;
while|while
condition|(
name|n
operator|--
operator|>
literal|0
condition|)
block|{
name|use
operator|=
operator|(
expr|struct
name|rr_pco_use
operator|*
operator|)
name|cp
expr_stmt|;
name|cp
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
operator|(
name|use
operator|+
literal|1
operator|)
expr_stmt|;
name|TCHECK
argument_list|(
name|use
operator|->
name|rpu_prefix
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"\n\t"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"use("
argument_list|)
expr_stmt|;
comment|/*)*/
if|if
condition|(
name|use
operator|->
name|rpu_flags
condition|)
block|{
define|#
directive|define
name|F
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|((use->rpu_flags)& (x) ? (y) : "")
name|printf
argument_list|(
literal|"%s%s,"
argument_list|,
name|F
argument_list|(
name|ICMP6_RR_PCOUSE_FLAGS_DECRVLTIME
argument_list|,
literal|"V"
argument_list|)
argument_list|,
name|F
argument_list|(
name|ICMP6_RR_PCOUSE_FLAGS_DECRPLTIME
argument_list|,
literal|"P"
argument_list|)
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|F
block|}
if|if
condition|(
name|vflag
condition|)
block|{
name|printf
argument_list|(
literal|"mask=0x%x,"
argument_list|,
name|use
operator|->
name|rpu_ramask
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raflags=0x%x,"
argument_list|,
name|use
operator|->
name|rpu_raflags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|~
name|use
operator|->
name|rpu_vltime
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"vltime=infty,"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"vltime=%u,"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|use
operator|->
name|rpu_vltime
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|~
name|use
operator|->
name|rpu_pltime
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"pltime=infty,"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"pltime=%u,"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|use
operator|->
name|rpu_pltime
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
name|use
operator|->
name|rpu_prefix
argument_list|,
name|hbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|hbuf
argument_list|)
argument_list|)
condition|)
name|printf
argument_list|(
literal|"%s/%u/%u"
argument_list|,
name|hbuf
argument_list|,
name|use
operator|->
name|rpu_uselen
argument_list|,
name|use
operator|->
name|rpu_keeplen
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"?/%u/%u"
argument_list|,
name|use
operator|->
name|rpu_uselen
argument_list|,
name|use
operator|->
name|rpu_keeplen
argument_list|)
expr_stmt|;
comment|/*(*/
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
name|trunc
label|:
name|fputs
argument_list|(
literal|"[|icmp6]"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INET6 */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1988, 1989, 1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code distributions  * retain the above copyright notice and this paragraph in its entirety, (2)  * distributions including binary code include the above copyright notice and  * this paragraph in its entirety in the documentation or other materials  * provided with the distribution, and (3) all advertising materials mentioning  * features or use of this software display the following acknowledgement:  * ``This product includes software developed by the University of California,  * Lawrence Berkeley Laboratory and its contributors.'' Neither the name of  * the University nor the names of its contributors may be used to endorse  * or promote products derived from this software without specific prior  * written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_comment
comment|/* \summary: Marvell Extended Distributed Switch Architecture (MEDSA) printer */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<netdissect-stdinc.h>
end_include

begin_include
include|#
directive|include
file|"netdissect.h"
end_include

begin_include
include|#
directive|include
file|"ether.h"
end_include

begin_include
include|#
directive|include
file|"ethertype.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
name|tstr
index|[]
init|=
literal|"[|MEDSA]"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Marvell Extended Distributed Switch Archiecture.  *  * A Marvell propriatary header used for passing packets to/from  * specific ports of a switch. There is no open specification of this  * header, but is documented in the Marvell Switch data sheets. For  * background, see:  *  * https://lwn.net/Articles/302333/  */
end_comment

begin_struct
struct|struct
name|medsa_pkthdr
block|{
name|u_char
name|bytes
index|[
literal|6
index|]
decl_stmt|;
name|u_short
name|ether_type
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Bytes 0 and 1 are reserved and should contain 0 */
end_comment

begin_define
define|#
directive|define
name|TAG
parameter_list|(
name|medsa
parameter_list|)
value|(medsa->bytes[2]>> 6)
end_define

begin_define
define|#
directive|define
name|TAG_TO_CPU
value|0
end_define

begin_define
define|#
directive|define
name|TAG_FROM_CPU
value|1
end_define

begin_define
define|#
directive|define
name|TAG_FORWARD
value|3
end_define

begin_define
define|#
directive|define
name|SRC_TAG
parameter_list|(
name|medsa
parameter_list|)
value|((medsa->bytes[2]>> 5)& 0x01)
end_define

begin_define
define|#
directive|define
name|SRC_DEV
parameter_list|(
name|medsa
parameter_list|)
value|(medsa->bytes[2]& 0x1f)
end_define

begin_define
define|#
directive|define
name|SRC_PORT
parameter_list|(
name|medsa
parameter_list|)
value|((medsa->bytes[3]>> 3)& 0x01f)
end_define

begin_define
define|#
directive|define
name|TRUNK
parameter_list|(
name|medsa
parameter_list|)
value|((medsa->bytes[3]>> 2)& 0x01)
end_define

begin_define
define|#
directive|define
name|CODE
parameter_list|(
name|medsa
parameter_list|)
value|((medsa->bytes[3]& 0x06) |	\ 			 ((medsa->bytes[4]>> 4)& 0x01))
end_define

begin_define
define|#
directive|define
name|CODE_BDPU
value|0
end_define

begin_define
define|#
directive|define
name|CODE_IGMP_MLD
value|2
end_define

begin_define
define|#
directive|define
name|CODE_ARP_MIRROR
value|4
end_define

begin_define
define|#
directive|define
name|CFI
parameter_list|(
name|medsa
parameter_list|)
value|(medsa->bytes[3]& 0x01)
end_define

begin_define
define|#
directive|define
name|PRI
parameter_list|(
name|medsa
parameter_list|)
value|(medsa->bytes[4]>> 5)
end_define

begin_define
define|#
directive|define
name|VID
parameter_list|(
name|medsa
parameter_list|)
value|(((u_short)(medsa->bytes[4]& 0xf)<< 8 |	\ 			  medsa->bytes[5]))
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|tag_values
index|[]
init|=
block|{
block|{
name|TAG_TO_CPU
block|,
literal|"To_CPU"
block|}
block|,
block|{
name|TAG_FROM_CPU
block|,
literal|"From_CPU"
block|}
block|,
block|{
name|TAG_FORWARD
block|,
literal|"Forward"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|code_values
index|[]
init|=
block|{
block|{
name|CODE_BDPU
block|,
literal|"BDPU"
block|}
block|,
block|{
name|CODE_IGMP_MLD
block|,
literal|"IGMP/MLD"
block|}
block|,
block|{
name|CODE_ARP_MIRROR
block|,
literal|"APR_Mirror"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|medsa_print_full
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|medsa_pkthdr
modifier|*
name|medsa
parameter_list|,
name|u_int
name|caplen
parameter_list|)
block|{
name|u_char
name|tag
init|=
name|TAG
argument_list|(
name|medsa
argument_list|)
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tok2str
argument_list|(
name|tag_values
argument_list|,
literal|"Unknown (%u)"
argument_list|,
name|tag
argument_list|)
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|tag
condition|)
block|{
case|case
name|TAG_TO_CPU
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", %stagged"
operator|,
name|SRC_TAG
argument_list|(
name|medsa
argument_list|)
condition|?
literal|""
else|:
literal|"un"
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", dev.port:vlan %d.%d:%d"
operator|,
name|SRC_DEV
argument_list|(
name|medsa
argument_list|)
operator|,
name|SRC_PORT
argument_list|(
name|medsa
argument_list|)
operator|,
name|VID
argument_list|(
name|medsa
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", %s"
operator|,
name|tok2str
argument_list|(
name|code_values
argument_list|,
literal|"Unknown (%u)"
argument_list|,
name|CODE
argument_list|(
name|medsa
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CFI
argument_list|(
name|medsa
argument_list|)
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", CFI"
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", pri %d: "
operator|,
name|PRI
argument_list|(
name|medsa
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|TAG_FROM_CPU
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", %stagged"
operator|,
name|SRC_TAG
argument_list|(
name|medsa
argument_list|)
condition|?
literal|""
else|:
literal|"un"
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", dev.port:vlan %d.%d:%d"
operator|,
name|SRC_DEV
argument_list|(
name|medsa
argument_list|)
operator|,
name|SRC_PORT
argument_list|(
name|medsa
argument_list|)
operator|,
name|VID
argument_list|(
name|medsa
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CFI
argument_list|(
name|medsa
argument_list|)
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", CFI"
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", pri %d: "
operator|,
name|PRI
argument_list|(
name|medsa
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|TAG_FORWARD
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", %stagged"
operator|,
name|SRC_TAG
argument_list|(
name|medsa
argument_list|)
condition|?
literal|""
else|:
literal|"un"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TRUNK
argument_list|(
name|medsa
argument_list|)
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", dev.trunk:vlan %d.%d:%d"
operator|,
name|SRC_DEV
argument_list|(
name|medsa
argument_list|)
operator|,
name|SRC_PORT
argument_list|(
name|medsa
argument_list|)
operator|,
name|VID
argument_list|(
name|medsa
argument_list|)
operator|)
argument_list|)
expr_stmt|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", dev.port:vlan %d.%d:%d"
operator|,
name|SRC_DEV
argument_list|(
name|medsa
argument_list|)
operator|,
name|SRC_PORT
argument_list|(
name|medsa
argument_list|)
operator|,
name|VID
argument_list|(
name|medsa
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CFI
argument_list|(
name|medsa
argument_list|)
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", CFI"
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", pri %d: "
operator|,
name|PRI
argument_list|(
name|medsa
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ND_DEFAULTPRINT
argument_list|(
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|medsa
argument_list|,
name|caplen
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
name|void
name|medsa_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
name|u_int
name|length
parameter_list|,
name|u_int
name|caplen
parameter_list|,
specifier|const
name|struct
name|lladdr_info
modifier|*
name|src
parameter_list|,
specifier|const
name|struct
name|lladdr_info
modifier|*
name|dst
parameter_list|)
block|{
specifier|const
name|struct
name|medsa_pkthdr
modifier|*
name|medsa
decl_stmt|;
name|u_short
name|ether_type
decl_stmt|;
name|medsa
operator|=
operator|(
specifier|const
expr|struct
name|medsa_pkthdr
operator|*
operator|)
name|bp
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|medsa
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"MEDSA %d.%d:%d: "
operator|,
name|SRC_DEV
argument_list|(
name|medsa
argument_list|)
operator|,
name|SRC_PORT
argument_list|(
name|medsa
argument_list|)
operator|,
name|VID
argument_list|(
name|medsa
argument_list|)
operator|)
argument_list|)
expr_stmt|;
else|else
name|medsa_print_full
argument_list|(
name|ndo
argument_list|,
name|medsa
argument_list|,
name|caplen
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|8
expr_stmt|;
name|length
operator|-=
literal|8
expr_stmt|;
name|caplen
operator|-=
literal|8
expr_stmt|;
name|ether_type
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|medsa
operator|->
name|ether_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|ether_type
operator|<=
name|ETHERMTU
condition|)
block|{
comment|/* Try to print the LLC-layer header& higher layers */
if|if
condition|(
name|llc_print
argument_list|(
name|ndo
argument_list|,
name|bp
argument_list|,
name|length
argument_list|,
name|caplen
argument_list|,
name|src
argument_list|,
name|dst
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* packet type not known, print raw packet */
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_suppress_default_print
condition|)
name|ND_DEFAULTPRINT
argument_list|(
name|bp
argument_list|,
name|caplen
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"ethertype %s (0x%04x) "
operator|,
name|tok2str
argument_list|(
name|ethertype_values
argument_list|,
literal|"Unknown"
argument_list|,
name|ether_type
argument_list|)
operator|,
name|ether_type
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ethertype_print
argument_list|(
name|ndo
argument_list|,
name|ether_type
argument_list|,
name|bp
argument_list|,
name|length
argument_list|,
name|caplen
argument_list|,
name|src
argument_list|,
name|dst
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* ether_type not known, print raw packet */
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"ethertype %s (0x%04x) "
operator|,
name|tok2str
argument_list|(
name|ethertype_values
argument_list|,
literal|"Unknown"
argument_list|,
name|ether_type
argument_list|)
operator|,
name|ether_type
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_suppress_default_print
condition|)
name|ND_DEFAULTPRINT
argument_list|(
name|bp
argument_list|,
name|caplen
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Local Variables:  * c-style: bsd  * End:  */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2001 Julian Cowley  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the project nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/* Cisco Hot Standby Router Protocol (HSRP). */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
name|_U_
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-hsrp.c,v 1.10 2005-05-06 07:56:52 guy Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_comment
comment|/* HSRP op code types. */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|op_code_str
index|[]
init|=
block|{
literal|"hello"
block|,
literal|"coup"
block|,
literal|"resign"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* HSRP states and associated names. */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|tok
name|states
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"initial"
block|}
block|,
block|{
literal|1
block|,
literal|"learn"
block|}
block|,
block|{
literal|2
block|,
literal|"listen"
block|}
block|,
block|{
literal|4
block|,
literal|"speak"
block|}
block|,
block|{
literal|8
block|,
literal|"standby"
block|}
block|,
block|{
literal|16
block|,
literal|"active"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * RFC 2281:  *  *  0                   1                   2                   3  *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |   Version     |   Op Code     |     State     |   Hellotime   |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |   Holdtime    |   Priority    |     Group     |   Reserved    |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                      Authentication  Data                     |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                      Authentication  Data                     |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                      Virtual IP Address                       |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  */
end_comment

begin_define
define|#
directive|define
name|HSRP_AUTH_SIZE
value|8
end_define

begin_comment
comment|/* HSRP protocol header. */
end_comment

begin_struct
struct|struct
name|hsrp
block|{
name|u_int8_t
name|hsrp_version
decl_stmt|;
name|u_int8_t
name|hsrp_op_code
decl_stmt|;
name|u_int8_t
name|hsrp_state
decl_stmt|;
name|u_int8_t
name|hsrp_hellotime
decl_stmt|;
name|u_int8_t
name|hsrp_holdtime
decl_stmt|;
name|u_int8_t
name|hsrp_priority
decl_stmt|;
name|u_int8_t
name|hsrp_group
decl_stmt|;
name|u_int8_t
name|hsrp_reserved
decl_stmt|;
name|u_int8_t
name|hsrp_authdata
index|[
name|HSRP_AUTH_SIZE
index|]
decl_stmt|;
name|struct
name|in_addr
name|hsrp_virtaddr
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|hsrp_print
parameter_list|(
specifier|register
specifier|const
name|u_int8_t
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|)
block|{
name|struct
name|hsrp
modifier|*
name|hp
init|=
operator|(
expr|struct
name|hsrp
operator|*
operator|)
name|bp
decl_stmt|;
name|TCHECK
argument_list|(
name|hp
operator|->
name|hsrp_version
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"HSRPv%d"
argument_list|,
name|hp
operator|->
name|hsrp_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|->
name|hsrp_version
operator|!=
literal|0
condition|)
return|return;
name|TCHECK
argument_list|(
name|hp
operator|->
name|hsrp_op_code
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s "
argument_list|,
name|tok2strary
argument_list|(
name|op_code_str
argument_list|,
literal|"unknown (%d)"
argument_list|,
name|hp
operator|->
name|hsrp_op_code
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d: "
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|TCHECK
argument_list|(
name|hp
operator|->
name|hsrp_state
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"state=%s "
argument_list|,
name|tok2str
argument_list|(
name|states
argument_list|,
literal|"Unknown (%d)"
argument_list|,
name|hp
operator|->
name|hsrp_state
argument_list|)
argument_list|)
expr_stmt|;
name|TCHECK
argument_list|(
name|hp
operator|->
name|hsrp_group
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"group=%d "
argument_list|,
name|hp
operator|->
name|hsrp_group
argument_list|)
expr_stmt|;
name|TCHECK
argument_list|(
name|hp
operator|->
name|hsrp_reserved
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|->
name|hsrp_reserved
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"[reserved=%d!] "
argument_list|,
name|hp
operator|->
name|hsrp_reserved
argument_list|)
expr_stmt|;
block|}
name|TCHECK
argument_list|(
name|hp
operator|->
name|hsrp_virtaddr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"addr=%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|hp
operator|->
name|hsrp_virtaddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
name|printf
argument_list|(
literal|" hellotime="
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|hp
operator|->
name|hsrp_hellotime
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" holdtime="
argument_list|)
expr_stmt|;
name|relts_print
argument_list|(
name|hp
operator|->
name|hsrp_holdtime
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" priority=%d"
argument_list|,
name|hp
operator|->
name|hsrp_priority
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" auth=\""
argument_list|)
expr_stmt|;
if|if
condition|(
name|fn_printn
argument_list|(
name|hp
operator|->
name|hsrp_authdata
argument_list|,
sizeof|sizeof
argument_list|(
name|hp
operator|->
name|hsrp_authdata
argument_list|)
argument_list|,
name|snapend
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\""
argument_list|)
expr_stmt|;
goto|goto
name|trunc
goto|;
block|}
name|printf
argument_list|(
literal|"\""
argument_list|)
expr_stmt|;
block|}
return|return;
name|trunc
label|:
name|printf
argument_list|(
literal|"[|hsrp]"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


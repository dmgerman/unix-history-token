begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * This module implements decoding of the ATA over Ethernet (AoE) protocol  * according to the following specification:  * http://support.coraid.com/documents/AoEr11.txt  *  * Copyright (c) 2014 The TCPDUMP project  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE  * COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN  * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_define
define|#
directive|define
name|NETDISSECT_REWORKED
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"ether.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
name|tstr
index|[]
init|=
literal|" [|aoe]"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|cstr
index|[]
init|=
literal|" (corrupt)"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AOE_V1
value|1
end_define

begin_define
define|#
directive|define
name|ATA_SECTOR_SIZE
value|512
end_define

begin_define
define|#
directive|define
name|AOEV1_CMD_ISSUE_ATA_COMMAND
value|0
end_define

begin_define
define|#
directive|define
name|AOEV1_CMD_QUERY_CONFIG_INFORMATION
value|1
end_define

begin_define
define|#
directive|define
name|AOEV1_CMD_MAC_MASK_LIST
value|2
end_define

begin_define
define|#
directive|define
name|AOEV1_CMD_RESERVE_RELEASE
value|3
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|cmdcode_str
index|[]
init|=
block|{
block|{
name|AOEV1_CMD_ISSUE_ATA_COMMAND
block|,
literal|"Issue ATA Command"
block|}
block|,
block|{
name|AOEV1_CMD_QUERY_CONFIG_INFORMATION
block|,
literal|"Query Config Information"
block|}
block|,
block|{
name|AOEV1_CMD_MAC_MASK_LIST
block|,
literal|"MAC Mask List"
block|}
block|,
block|{
name|AOEV1_CMD_RESERVE_RELEASE
block|,
literal|"Reserve/Release"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AOEV1_COMMON_HDR_LEN
value|10U
end_define

begin_comment
comment|/* up to but w/o Arg                */
end_comment

begin_define
define|#
directive|define
name|AOEV1_ISSUE_ARG_LEN
value|12U
end_define

begin_comment
comment|/* up to but w/o Data               */
end_comment

begin_define
define|#
directive|define
name|AOEV1_QUERY_ARG_LEN
value|8U
end_define

begin_comment
comment|/* up to but w/o Config String      */
end_comment

begin_define
define|#
directive|define
name|AOEV1_MAC_ARG_LEN
value|4U
end_define

begin_comment
comment|/* up to but w/o Directive 0        */
end_comment

begin_define
define|#
directive|define
name|AOEV1_RESERVE_ARG_LEN
value|2U
end_define

begin_comment
comment|/* up to but w/o Ethernet address 0 */
end_comment

begin_define
define|#
directive|define
name|AOEV1_MAX_CONFSTR_LEN
value|1024U
end_define

begin_define
define|#
directive|define
name|AOEV1_FLAG_R
value|0x08
end_define

begin_define
define|#
directive|define
name|AOEV1_FLAG_E
value|0x04
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|aoev1_flag_str
index|[]
init|=
block|{
block|{
name|AOEV1_FLAG_R
block|,
literal|"Response"
block|}
block|,
block|{
name|AOEV1_FLAG_E
block|,
literal|"Error"
block|}
block|,
block|{
literal|0x02
block|,
literal|"MBZ-0x02"
block|}
block|,
block|{
literal|0x01
block|,
literal|"MBZ-0x01"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|aoev1_errcode_str
index|[]
init|=
block|{
block|{
literal|1
block|,
literal|"Unrecognized command code"
block|}
block|,
block|{
literal|2
block|,
literal|"Bad argument parameter"
block|}
block|,
block|{
literal|3
block|,
literal|"Device unavailable"
block|}
block|,
block|{
literal|4
block|,
literal|"Config string present"
block|}
block|,
block|{
literal|5
block|,
literal|"Unsupported version"
block|}
block|,
block|{
literal|6
block|,
literal|"Target is reserved"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AOEV1_AFLAG_E
value|0x40
end_define

begin_define
define|#
directive|define
name|AOEV1_AFLAG_D
value|0x10
end_define

begin_define
define|#
directive|define
name|AOEV1_AFLAG_A
value|0x02
end_define

begin_define
define|#
directive|define
name|AOEV1_AFLAG_W
value|0x01
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|aoev1_aflag_str
index|[]
init|=
block|{
block|{
literal|0x08
block|,
literal|"MBZ-0x08"
block|}
block|,
block|{
name|AOEV1_AFLAG_E
block|,
literal|"Ext48"
block|}
block|,
block|{
literal|0x06
block|,
literal|"MBZ-0x06"
block|}
block|,
block|{
name|AOEV1_AFLAG_D
block|,
literal|"Device"
block|}
block|,
block|{
literal|0x04
block|,
literal|"MBZ-0x04"
block|}
block|,
block|{
literal|0x03
block|,
literal|"MBZ-0x03"
block|}
block|,
block|{
name|AOEV1_AFLAG_A
block|,
literal|"Async"
block|}
block|,
block|{
name|AOEV1_AFLAG_W
block|,
literal|"Write"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|aoev1_ccmd_str
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"read config string"
block|}
block|,
block|{
literal|1
block|,
literal|"test config string"
block|}
block|,
block|{
literal|2
block|,
literal|"test config string prefix"
block|}
block|,
block|{
literal|3
block|,
literal|"set config string"
block|}
block|,
block|{
literal|4
block|,
literal|"force set config string"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|aoev1_mcmd_str
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"Read Mac Mask List"
block|}
block|,
block|{
literal|1
block|,
literal|"Edit Mac Mask List"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|aoev1_merror_str
index|[]
init|=
block|{
block|{
literal|1
block|,
literal|"Unspecified Error"
block|}
block|,
block|{
literal|2
block|,
literal|"Bad DCmd directive"
block|}
block|,
block|{
literal|3
block|,
literal|"Mask list full"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|aoev1_dcmd_str
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"No Directive"
block|}
block|,
block|{
literal|1
block|,
literal|"Add mac address to mask list"
block|}
block|,
block|{
literal|2
block|,
literal|"Delete mac address from mask list"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|aoev1_rcmd_str
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"Read reserve list"
block|}
block|,
block|{
literal|1
block|,
literal|"Set reserve list"
block|}
block|,
block|{
literal|2
block|,
literal|"Force set reserve list"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|aoev1_issue_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|ep
init|=
name|cp
operator|+
name|len
decl_stmt|;
if|if
condition|(
name|len
operator|<
name|AOEV1_ISSUE_ARG_LEN
condition|)
goto|goto
name|corrupt
goto|;
comment|/* AFlags */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tAFlags: [%s]"
operator|,
name|bittok2str
argument_list|(
name|aoev1_aflag_str
argument_list|,
literal|"none"
argument_list|,
operator|*
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* Err/Feature */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Err/Feature: %u"
operator|,
operator|*
name|cp
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* Sector Count (not correlated with the length) */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Sector Count: %u"
operator|,
operator|*
name|cp
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* Cmd/Status */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Cmd/Status: %u"
operator|,
operator|*
name|cp
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* lba0 */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tlba0: %u"
operator|,
operator|*
name|cp
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* lba1 */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", lba1: %u"
operator|,
operator|*
name|cp
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* lba2 */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", lba2: %u"
operator|,
operator|*
name|cp
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* lba3 */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", lba3: %u"
operator|,
operator|*
name|cp
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* lba4 */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", lba4: %u"
operator|,
operator|*
name|cp
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* lba5 */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", lba5: %u"
operator|,
operator|*
name|cp
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* Reserved */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|2
expr_stmt|;
comment|/* Data */
if|if
condition|(
name|len
operator|>
name|AOEV1_ISSUE_ARG_LEN
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tData: %u bytes"
operator|,
name|len
operator|-
name|AOEV1_ISSUE_ARG_LEN
operator|)
argument_list|)
expr_stmt|;
return|return;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|aoev1_query_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|ep
init|=
name|cp
operator|+
name|len
decl_stmt|;
name|uint16_t
name|cslen
decl_stmt|;
if|if
condition|(
name|len
operator|<
name|AOEV1_QUERY_ARG_LEN
condition|)
goto|goto
name|corrupt
goto|;
comment|/* Buffer Count */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tBuffer Count: %u"
operator|,
name|EXTRACT_16BITS
argument_list|(
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|2
expr_stmt|;
comment|/* Firmware Version */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Firmware Version: %u"
operator|,
name|EXTRACT_16BITS
argument_list|(
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|2
expr_stmt|;
comment|/* Sector Count */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Sector Count: %u"
operator|,
operator|*
name|cp
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* AoE/CCmd */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", AoE: %u, CCmd: %s"
operator|,
operator|(
operator|*
name|cp
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
operator|,
name|tok2str
argument_list|(
name|aoev1_ccmd_str
argument_list|,
literal|"Unknown (0x02x)"
argument_list|,
operator|*
name|cp
operator|&
literal|0x0F
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* Config String Length */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|cslen
operator|=
name|EXTRACT_16BITS
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|cslen
operator|>
name|AOEV1_MAX_CONFSTR_LEN
operator|||
name|AOEV1_QUERY_ARG_LEN
operator|+
name|cslen
operator|>
name|len
condition|)
goto|goto
name|corrupt
goto|;
comment|/* Config String */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|cslen
argument_list|)
expr_stmt|;
if|if
condition|(
name|cslen
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tConfig String (length %u): "
operator|,
name|cslen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fn_printn
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
name|cslen
argument_list|,
name|ndo
operator|->
name|ndo_snapend
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
block|}
return|return;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|aoev1_mac_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|ep
init|=
name|cp
operator|+
name|len
decl_stmt|;
name|uint8_t
name|dircount
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|len
operator|<
name|AOEV1_MAC_ARG_LEN
condition|)
goto|goto
name|corrupt
goto|;
comment|/* Reserved */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* MCmd */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tMCmd: %s"
operator|,
name|tok2str
argument_list|(
name|aoev1_mcmd_str
argument_list|,
literal|"Unknown (0x%02x)"
argument_list|,
operator|*
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* MError */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", MError: %s"
operator|,
name|tok2str
argument_list|(
name|aoev1_merror_str
argument_list|,
literal|"Unknown (0x%02x)"
argument_list|,
operator|*
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* Dir Count */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dircount
operator|=
operator|*
name|cp
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Dir Count: %u"
operator|,
name|dircount
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AOEV1_MAC_ARG_LEN
operator|+
name|dircount
operator|*
literal|8
operator|>
name|len
condition|)
goto|goto
name|corrupt
goto|;
comment|/* directives */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dircount
condition|;
name|i
operator|++
control|)
block|{
comment|/* Reserved */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* DCmd */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t DCmd: %s"
operator|,
name|tok2str
argument_list|(
name|aoev1_dcmd_str
argument_list|,
literal|"Unknown (0x%02x)"
argument_list|,
operator|*
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* Ethernet Address */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Ethernet Address: %s"
operator|,
name|etheraddr_string
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|ETHER_ADDR_LEN
expr_stmt|;
block|}
return|return;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|aoev1_reserve_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|ep
init|=
name|cp
operator|+
name|len
decl_stmt|;
name|uint8_t
name|nmacs
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|len
operator|<
name|AOEV1_RESERVE_ARG_LEN
operator|||
operator|(
name|len
operator|-
name|AOEV1_RESERVE_ARG_LEN
operator|)
operator|%
name|ETHER_ADDR_LEN
condition|)
goto|goto
name|corrupt
goto|;
comment|/* RCmd */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tRCmd: %s"
operator|,
name|tok2str
argument_list|(
name|aoev1_rcmd_str
argument_list|,
literal|"Unknown (0x%02x)"
argument_list|,
operator|*
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* NMacs (correlated with the length) */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nmacs
operator|=
operator|*
name|cp
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", NMacs: %u"
operator|,
name|nmacs
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AOEV1_RESERVE_ARG_LEN
operator|+
name|nmacs
operator|*
name|ETHER_ADDR_LEN
operator|!=
name|len
condition|)
goto|goto
name|corrupt
goto|;
comment|/* addresses */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nmacs
condition|;
name|i
operator|++
control|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tEthernet Address %u: %s"
operator|,
name|i
operator|,
name|etheraddr_string
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|ETHER_ADDR_LEN
expr_stmt|;
block|}
return|return;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* cp points to the Ver/Flags octet */
end_comment

begin_function
specifier|static
name|void
name|aoev1_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|ep
init|=
name|cp
operator|+
name|len
decl_stmt|;
name|uint8_t
name|flags
decl_stmt|,
name|command
decl_stmt|;
name|void
function_decl|(
modifier|*
name|cmd_decoder
function_decl|)
parameter_list|(
name|netdissect_options
modifier|*
parameter_list|,
specifier|const
name|u_char
modifier|*
parameter_list|,
specifier|const
name|u_int
parameter_list|)
function_decl|;
if|if
condition|(
name|len
operator|<
name|AOEV1_COMMON_HDR_LEN
condition|)
goto|goto
name|corrupt
goto|;
comment|/* Flags */
name|flags
operator|=
operator|*
name|cp
operator|&
literal|0x0F
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Flags: [%s]"
operator|,
name|bittok2str
argument_list|(
name|aoev1_flag_str
argument_list|,
literal|"none"
argument_list|,
name|flags
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_vflag
condition|)
return|return;
comment|/* Error */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|AOEV1_FLAG_E
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tError: %s"
operator|,
name|tok2str
argument_list|(
name|aoev1_errcode_str
argument_list|,
literal|"Invalid (%u)"
argument_list|,
operator|*
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* Major */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tMajor: 0x%04x"
operator|,
name|EXTRACT_16BITS
argument_list|(
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|2
expr_stmt|;
comment|/* Minor */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Minor: 0x%02x"
operator|,
operator|*
name|cp
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
comment|/* Command */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|command
operator|=
operator|*
name|cp
expr_stmt|;
name|cp
operator|+=
literal|1
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Command: %s"
operator|,
name|tok2str
argument_list|(
name|cmdcode_str
argument_list|,
literal|"Unknown (0x%02x)"
argument_list|,
name|command
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Tag */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Tag: 0x%08x"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|cp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|4
expr_stmt|;
comment|/* Arg */
name|cmd_decoder
operator|=
name|command
operator|==
name|AOEV1_CMD_ISSUE_ATA_COMMAND
condition|?
name|aoev1_issue_print
else|:
name|command
operator|==
name|AOEV1_CMD_QUERY_CONFIG_INFORMATION
condition|?
name|aoev1_query_print
else|:
name|command
operator|==
name|AOEV1_CMD_MAC_MASK_LIST
condition|?
name|aoev1_mac_print
else|:
name|command
operator|==
name|AOEV1_CMD_RESERVE_RELEASE
condition|?
name|aoev1_reserve_print
else|:
name|NULL
expr_stmt|;
if|if
condition|(
name|cmd_decoder
operator|!=
name|NULL
condition|)
name|cmd_decoder
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
name|len
operator|-
name|AOEV1_COMMON_HDR_LEN
argument_list|)
expr_stmt|;
return|return;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|aoe_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
specifier|const
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|ep
init|=
name|cp
operator|+
name|len
decl_stmt|;
name|uint8_t
name|ver
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"AoE length %u"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|1
condition|)
goto|goto
name|corrupt
goto|;
comment|/* Ver/Flags */
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ver
operator|=
operator|(
operator|*
name|cp
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
expr_stmt|;
comment|/* Don't advance cp yet: low order 4 bits are version-specific. */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Ver %u"
operator|,
name|ver
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ver
condition|)
block|{
case|case
name|AOE_V1
case|:
name|aoev1_print
argument_list|(
name|ndo
argument_list|,
name|cp
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
name|corrupt
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|cstr
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|cp
argument_list|,
name|ep
operator|-
name|cp
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tstr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code  * distributions retain the above copyright notice and this paragraph  * in its entirety, and (2) distributions including binary code include  * the above copyright notice and this paragraph in its entirety in  * the documentation or other materials provided with the distribution.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND  * WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, WITHOUT  * LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE.  *  * Original code by Hannes Gredler (hannes@juniper.net)  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
name|_U_
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-juniper.c,v 1.8.2.13 2005/06/20 07:45:05 hannes Exp $ (LBL)"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|<pcap.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"ppp.h"
end_include

begin_include
include|#
directive|include
file|"llc.h"
end_include

begin_include
include|#
directive|include
file|"nlpid.h"
end_include

begin_include
include|#
directive|include
file|"ethertype.h"
end_include

begin_include
include|#
directive|include
file|"atm.h"
end_include

begin_define
define|#
directive|define
name|JUNIPER_BPF_OUT
value|0
end_define

begin_comment
comment|/* Outgoing packet */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_BPF_IN
value|1
end_define

begin_comment
comment|/* Incoming packet */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_BPF_PKT_IN
value|0x1
end_define

begin_comment
comment|/* Incoming packet */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_BPF_NO_L2
value|0x2
end_define

begin_comment
comment|/* L2 header stripped */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_MGC_NUMBER
value|0x4d4743
end_define

begin_comment
comment|/* = "MGC" */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_LSQ_L3_PROTO_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|JUNIPER_LSQ_L3_PROTO_MASK
value|(0x17<< JUNIPER_LSQ_L3_PROTO_SHIFT)
end_define

begin_define
define|#
directive|define
name|JUNIPER_LSQ_L3_PROTO_IPV4
value|(0<< JUNIPER_LSQ_L3_PROTO_SHIFT)
end_define

begin_define
define|#
directive|define
name|JUNIPER_LSQ_L3_PROTO_IPV6
value|(1<< JUNIPER_LSQ_L3_PROTO_SHIFT)
end_define

begin_define
define|#
directive|define
name|JUNIPER_LSQ_L3_PROTO_MPLS
value|(2<< JUNIPER_LSQ_L3_PROTO_SHIFT)
end_define

begin_define
define|#
directive|define
name|JUNIPER_LSQ_L3_PROTO_ISO
value|(3<< JUNIPER_LSQ_L3_PROTO_SHIFT)
end_define

begin_define
define|#
directive|define
name|JUNIPER_IPSEC_O_ESP_ENCRYPT_ESP_AUTHEN_TYPE
value|1
end_define

begin_define
define|#
directive|define
name|JUNIPER_IPSEC_O_ESP_ENCRYPT_AH_AUTHEN_TYPE
value|2
end_define

begin_define
define|#
directive|define
name|JUNIPER_IPSEC_O_ESP_AUTHENTICATION_TYPE
value|3
end_define

begin_define
define|#
directive|define
name|JUNIPER_IPSEC_O_AH_AUTHENTICATION_TYPE
value|4
end_define

begin_define
define|#
directive|define
name|JUNIPER_IPSEC_O_ESP_ENCRYPTION_TYPE
value|5
end_define

begin_decl_stmt
specifier|static
name|struct
name|tok
name|juniper_ipsec_type_values
index|[]
init|=
block|{
block|{
name|JUNIPER_IPSEC_O_ESP_ENCRYPT_ESP_AUTHEN_TYPE
block|,
literal|"ESP ENCR-AUTH"
block|}
block|,
block|{
name|JUNIPER_IPSEC_O_ESP_ENCRYPT_AH_AUTHEN_TYPE
block|,
literal|"ESP ENCR-AH AUTH"
block|}
block|,
block|{
name|JUNIPER_IPSEC_O_ESP_AUTHENTICATION_TYPE
block|,
literal|"ESP AUTH"
block|}
block|,
block|{
name|JUNIPER_IPSEC_O_AH_AUTHENTICATION_TYPE
block|,
literal|"AH AUTH"
block|}
block|,
block|{
name|JUNIPER_IPSEC_O_ESP_ENCRYPTION_TYPE
block|,
literal|"ESP ENCR"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tok
name|juniper_direction_values
index|[]
init|=
block|{
block|{
name|JUNIPER_BPF_IN
block|,
literal|"In"
block|}
block|,
block|{
name|JUNIPER_BPF_OUT
block|,
literal|"Out"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|juniper_cookie_table_t
block|{
name|u_int32_t
name|pictype
decl_stmt|;
comment|/* pic type */
name|u_int8_t
name|cookie_len
decl_stmt|;
comment|/* cookie len */
specifier|const
name|char
modifier|*
name|s
decl_stmt|;
comment|/* pic name */
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|juniper_cookie_table_t
name|juniper_cookie_table
index|[]
init|=
block|{
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ATM1
block|{
name|DLT_JUNIPER_ATM1
block|,
literal|4
block|,
literal|"ATM1"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ATM2
block|{
name|DLT_JUNIPER_ATM2
block|,
literal|8
block|,
literal|"ATM2"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MLPPP
block|{
name|DLT_JUNIPER_MLPPP
block|,
literal|2
block|,
literal|"MLPPP"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MLFR
block|{
name|DLT_JUNIPER_MLFR
block|,
literal|2
block|,
literal|"MLFR"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MFR
block|{
name|DLT_JUNIPER_MFR
block|,
literal|4
block|,
literal|"MFR"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_PPPOE
block|{
name|DLT_JUNIPER_PPPOE
block|,
literal|0
block|,
literal|"PPPoE"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_PPPOE_ATM
block|{
name|DLT_JUNIPER_PPPOE_ATM
block|,
literal|0
block|,
literal|"PPPoE ATM"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_GGSN
block|{
name|DLT_JUNIPER_GGSN
block|,
literal|8
block|,
literal|"GGSN"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MONITOR
block|{
name|DLT_JUNIPER_MONITOR
block|,
literal|8
block|,
literal|"MONITOR"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_SERVICES
block|{
name|DLT_JUNIPER_SERVICES
block|,
literal|8
block|,
literal|"AS"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ES
block|{
name|DLT_JUNIPER_ES
block|,
literal|0
block|,
literal|"ES"
block|}
block|,
endif|#
directive|endif
block|{
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|juniper_l2info_t
block|{
name|u_int32_t
name|length
decl_stmt|;
name|u_int32_t
name|caplen
decl_stmt|;
name|u_int32_t
name|pictype
decl_stmt|;
name|u_int8_t
name|direction
decl_stmt|;
name|u_int8_t
name|header_len
decl_stmt|;
name|u_int8_t
name|cookie_len
decl_stmt|;
name|u_int8_t
name|cookie_type
decl_stmt|;
name|u_int8_t
name|cookie
index|[
literal|8
index|]
decl_stmt|;
name|u_int8_t
name|bundle
decl_stmt|;
name|u_int16_t
name|proto
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|LS_COOKIE_ID
value|0x54
end_define

begin_define
define|#
directive|define
name|AS_COOKIE_ID
value|0x47
end_define

begin_define
define|#
directive|define
name|LS_MLFR_COOKIE_LEN
value|4
end_define

begin_define
define|#
directive|define
name|ML_MLFR_COOKIE_LEN
value|2
end_define

begin_define
define|#
directive|define
name|LS_MFR_COOKIE_LEN
value|6
end_define

begin_define
define|#
directive|define
name|ATM1_COOKIE_LEN
value|4
end_define

begin_define
define|#
directive|define
name|ATM2_COOKIE_LEN
value|8
end_define

begin_define
define|#
directive|define
name|ATM2_PKT_TYPE_MASK
value|0x70
end_define

begin_define
define|#
directive|define
name|ATM2_GAP_COUNT_MASK
value|0x3F
end_define

begin_define
define|#
directive|define
name|JUNIPER_PROTO_NULL
value|1
end_define

begin_define
define|#
directive|define
name|JUNIPER_PROTO_IPV4
value|2
end_define

begin_define
define|#
directive|define
name|JUNIPER_PROTO_IPV6
value|6
end_define

begin_decl_stmt
specifier|static
name|struct
name|tok
name|juniper_protocol_values
index|[]
init|=
block|{
block|{
name|JUNIPER_PROTO_NULL
block|,
literal|"Null"
block|}
block|,
block|{
name|JUNIPER_PROTO_IPV4
block|,
literal|"IPv4"
block|}
block|,
block|{
name|JUNIPER_PROTO_IPV6
block|,
literal|"IPv6"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|ip_heuristic_guess
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|juniper_ppp_heuristic_guess
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|juniper_parse_header
parameter_list|(
specifier|const
name|u_char
modifier|*
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
parameter_list|,
name|struct
name|juniper_l2info_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_GGSN
end_ifdef

begin_function
name|u_int
name|juniper_ggsn_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
struct|struct
name|juniper_ggsn_header
block|{
name|u_int8_t
name|svc_id
decl_stmt|;
name|u_int8_t
name|flags_len
decl_stmt|;
name|u_int8_t
name|proto
decl_stmt|;
name|u_int8_t
name|flags
decl_stmt|;
name|u_int8_t
name|vlan_id
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|res
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
specifier|const
name|struct
name|juniper_ggsn_header
modifier|*
name|gh
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_GGSN
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
name|gh
operator|=
operator|(
expr|struct
name|juniper_ggsn_header
operator|*
operator|)
name|p
expr_stmt|;
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|"proto %s (%u), vlan %u: "
argument_list|,
name|tok2str
argument_list|(
name|juniper_protocol_values
argument_list|,
literal|"Unknown"
argument_list|,
name|gh
operator|->
name|proto
argument_list|)
argument_list|,
name|gh
operator|->
name|proto
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|gh
operator|->
name|vlan_id
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|gh
operator|->
name|proto
condition|)
block|{
case|case
name|JUNIPER_PROTO_IPV4
case|:
name|ip_print
argument_list|(
name|gndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|JUNIPER_PROTO_IPV6
case|:
name|ip6_print
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
default|default:
if|if
condition|(
operator|!
name|eflag
condition|)
name|printf
argument_list|(
literal|"unknown GGSN proto (%u)"
argument_list|,
name|gh
operator|->
name|proto
argument_list|)
expr_stmt|;
block|}
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ES
end_ifdef

begin_function
name|u_int
name|juniper_es_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
struct|struct
name|juniper_ipsec_header
block|{
name|u_int8_t
name|sa_index
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|ttl
decl_stmt|;
name|u_int8_t
name|type
decl_stmt|;
name|u_int8_t
name|spi
index|[
literal|4
index|]
decl_stmt|;
name|u_int8_t
name|src_ip
index|[
literal|4
index|]
decl_stmt|;
name|u_int8_t
name|dst_ip
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
name|u_int
name|rewrite_len
decl_stmt|,
name|es_type_bundle
decl_stmt|;
specifier|const
name|struct
name|juniper_ipsec_header
modifier|*
name|ih
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_ES
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
name|ih
operator|=
operator|(
expr|struct
name|juniper_ipsec_header
operator|*
operator|)
name|p
expr_stmt|;
switch|switch
condition|(
name|ih
operator|->
name|type
condition|)
block|{
case|case
name|JUNIPER_IPSEC_O_ESP_ENCRYPT_ESP_AUTHEN_TYPE
case|:
case|case
name|JUNIPER_IPSEC_O_ESP_ENCRYPT_AH_AUTHEN_TYPE
case|:
name|rewrite_len
operator|=
literal|0
expr_stmt|;
name|es_type_bundle
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|JUNIPER_IPSEC_O_ESP_AUTHENTICATION_TYPE
case|:
case|case
name|JUNIPER_IPSEC_O_AH_AUTHENTICATION_TYPE
case|:
case|case
name|JUNIPER_IPSEC_O_ESP_ENCRYPTION_TYPE
case|:
name|rewrite_len
operator|=
literal|16
expr_stmt|;
name|es_type_bundle
operator|=
literal|0
expr_stmt|;
default|default:
name|printf
argument_list|(
literal|"ES Invalid type %u, length %u"
argument_list|,
name|ih
operator|->
name|type
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
name|l2info
operator|.
name|length
operator|-=
name|rewrite_len
expr_stmt|;
name|p
operator|+=
name|rewrite_len
expr_stmt|;
if|if
condition|(
name|eflag
condition|)
block|{
if|if
condition|(
operator|!
name|es_type_bundle
condition|)
block|{
name|printf
argument_list|(
literal|"ES SA, index %u, ttl %u type %s (%u), spi %u, Tunnel %s> %s, length %u\n"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ih
operator|->
name|sa_index
argument_list|)
argument_list|,
name|ih
operator|->
name|ttl
argument_list|,
name|tok2str
argument_list|(
name|juniper_ipsec_type_values
argument_list|,
literal|"Unknown"
argument_list|,
name|ih
operator|->
name|type
argument_list|)
argument_list|,
name|ih
operator|->
name|type
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|ih
operator|->
name|spi
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|ih
operator|->
name|src_ip
argument_list|)
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
name|EXTRACT_32BITS
argument_list|(
operator|&
name|ih
operator|->
name|dst_ip
argument_list|)
argument_list|)
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"ES SA, index %u, ttl %u type %s (%u), length %u\n"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ih
operator|->
name|sa_index
argument_list|)
argument_list|,
name|ih
operator|->
name|ttl
argument_list|,
name|tok2str
argument_list|(
name|juniper_ipsec_type_values
argument_list|,
literal|"Unknown"
argument_list|,
name|ih
operator|->
name|type
argument_list|)
argument_list|,
name|ih
operator|->
name|type
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
block|}
name|ip_print
argument_list|(
name|gndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MONITOR
end_ifdef

begin_function
name|u_int
name|juniper_monitor_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
struct|struct
name|juniper_monitor_header
block|{
name|u_int8_t
name|pkt_type
decl_stmt|;
name|u_int8_t
name|padding
decl_stmt|;
name|u_int8_t
name|iif
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|service_id
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
specifier|const
name|struct
name|juniper_monitor_header
modifier|*
name|mh
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_MONITOR
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
name|mh
operator|=
operator|(
expr|struct
name|juniper_monitor_header
operator|*
operator|)
name|p
expr_stmt|;
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|"service-id %u, iif %u, pkt-type %u: "
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|mh
operator|->
name|service_id
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|mh
operator|->
name|iif
argument_list|)
argument_list|,
name|mh
operator|->
name|pkt_type
argument_list|)
expr_stmt|;
comment|/* no proto field - lets guess by first byte of IP header*/
name|ip_heuristic_guess
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_SERVICES
end_ifdef

begin_function
name|u_int
name|juniper_services_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
struct|struct
name|juniper_services_header
block|{
name|u_int8_t
name|svc_id
decl_stmt|;
name|u_int8_t
name|flags_len
decl_stmt|;
name|u_int8_t
name|svc_set_id
index|[
literal|2
index|]
decl_stmt|;
name|u_int8_t
name|dir_iif
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
specifier|const
name|struct
name|juniper_services_header
modifier|*
name|sh
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_SERVICES
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
name|sh
operator|=
operator|(
expr|struct
name|juniper_services_header
operator|*
operator|)
name|p
expr_stmt|;
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|"service-id %u flags 0x%02x service-set-id 0x%04x iif %u: "
argument_list|,
name|sh
operator|->
name|svc_id
argument_list|,
name|sh
operator|->
name|flags_len
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|sh
operator|->
name|svc_set_id
argument_list|)
argument_list|,
name|EXTRACT_24BITS
argument_list|(
operator|&
name|sh
operator|->
name|dir_iif
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* no proto field - lets guess by first byte of IP header*/
name|ip_heuristic_guess
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_PPPOE
end_ifdef

begin_function
name|u_int
name|juniper_pppoe_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_PPPOE
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
comment|/* this DLT contains nothing but raw ethernet frames */
name|ether_print
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_PPPOE_ATM
end_ifdef

begin_function
name|u_int
name|juniper_pppoe_atm_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|u_int16_t
name|extracted_ethertype
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_PPPOE_ATM
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
name|extracted_ethertype
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
comment|/* this DLT contains nothing but raw PPPoE frames,          * prepended with a type field*/
if|if
condition|(
name|ether_encap_print
argument_list|(
name|extracted_ethertype
argument_list|,
name|p
operator|+
name|ETHERTYPE_LEN
argument_list|,
name|l2info
operator|.
name|length
operator|-
name|ETHERTYPE_LEN
argument_list|,
name|l2info
operator|.
name|caplen
operator|-
name|ETHERTYPE_LEN
argument_list|,
operator|&
name|extracted_ethertype
argument_list|)
operator|==
literal|0
condition|)
comment|/* ether_type not known, probably it wasn't one */
name|printf
argument_list|(
literal|"unknown ethertype 0x%04x"
argument_list|,
name|extracted_ethertype
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MLPPP
end_ifdef

begin_function
name|u_int
name|juniper_mlppp_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_MLPPP
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
comment|/* suppress Bundle-ID if frame was captured on a child-link          * best indicator if the cookie looks like a proto */
if|if
condition|(
name|eflag
operator|&&
name|EXTRACT_16BITS
argument_list|(
operator|&
name|l2info
operator|.
name|cookie
argument_list|)
operator|!=
name|PPP_OSI
operator|&&
name|EXTRACT_16BITS
argument_list|(
operator|&
name|l2info
operator|.
name|cookie
argument_list|)
operator|!=
operator|(
name|PPP_ADDRESS
operator|<<
literal|8
operator||
name|PPP_CONTROL
operator|)
condition|)
name|printf
argument_list|(
literal|"Bundle-ID %u: "
argument_list|,
name|l2info
operator|.
name|bundle
argument_list|)
expr_stmt|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
comment|/* first try the LSQ protos */
switch|switch
condition|(
name|l2info
operator|.
name|proto
condition|)
block|{
case|case
name|JUNIPER_LSQ_L3_PROTO_IPV4
case|:
name|ip_print
argument_list|(
name|gndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
ifdef|#
directive|ifdef
name|INET6
case|case
name|JUNIPER_LSQ_L3_PROTO_IPV6
case|:
name|ip6_print
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
endif|#
directive|endif
case|case
name|JUNIPER_LSQ_L3_PROTO_MPLS
case|:
name|mpls_print
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
case|case
name|JUNIPER_LSQ_L3_PROTO_ISO
case|:
name|isoclns_print
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
default|default:
break|break;
block|}
comment|/* zero length cookie ? */
switch|switch
condition|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|l2info
operator|.
name|cookie
argument_list|)
condition|)
block|{
case|case
name|PPP_OSI
case|:
name|ppp_print
argument_list|(
name|p
operator|-
literal|2
argument_list|,
name|l2info
operator|.
name|length
operator|+
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|PPP_ADDRESS
operator|<<
literal|8
operator||
name|PPP_CONTROL
operator|)
case|:
comment|/* fall through */
default|default:
name|ppp_print
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MFR
end_ifdef

begin_function
name|u_int
name|juniper_mfr_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_MFR
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
comment|/* suppress Bundle-ID if frame was captured on a child-link */
if|if
condition|(
name|eflag
operator|&&
name|EXTRACT_32BITS
argument_list|(
name|l2info
operator|.
name|cookie
argument_list|)
operator|!=
literal|1
condition|)
name|printf
argument_list|(
literal|"Bundle-ID %u, "
argument_list|,
name|l2info
operator|.
name|bundle
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|l2info
operator|.
name|proto
condition|)
block|{
case|case
operator|(
name|LLCSAP_ISONS
operator|<<
literal|8
operator||
name|LLCSAP_ISONS
operator|)
case|:
name|isoclns_print
argument_list|(
name|p
operator|+
literal|1
argument_list|,
name|l2info
operator|.
name|length
operator|-
literal|1
argument_list|,
name|l2info
operator|.
name|caplen
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator||
name|NLPID_Q933
operator|)
case|:
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator||
name|NLPID_IP
operator|)
case|:
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator||
name|NLPID_IP6
operator|)
case|:
comment|/* pass IP{4,6} to the OSI layer for proper link-layer printing */
name|isoclns_print
argument_list|(
name|p
operator|-
literal|1
argument_list|,
name|l2info
operator|.
name|length
operator|+
literal|1
argument_list|,
name|l2info
operator|.
name|caplen
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown protocol 0x%04x, length %u"
argument_list|,
name|l2info
operator|.
name|proto
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MLFR
end_ifdef

begin_function
name|u_int
name|juniper_mlfr_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_MLFR
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
comment|/* suppress Bundle-ID if frame was captured on a child-link */
if|if
condition|(
name|eflag
operator|&&
name|EXTRACT_32BITS
argument_list|(
name|l2info
operator|.
name|cookie
argument_list|)
operator|!=
literal|1
condition|)
name|printf
argument_list|(
literal|"Bundle-ID %u, "
argument_list|,
name|l2info
operator|.
name|bundle
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|l2info
operator|.
name|proto
condition|)
block|{
case|case
operator|(
name|LLC_UI
operator|)
case|:
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator|)
case|:
name|isoclns_print
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator||
name|NLPID_Q933
operator|)
case|:
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator||
name|NLPID_IP
operator|)
case|:
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator||
name|NLPID_IP6
operator|)
case|:
comment|/* pass IP{4,6} to the OSI layer for proper link-layer printing */
name|isoclns_print
argument_list|(
name|p
operator|-
literal|1
argument_list|,
name|l2info
operator|.
name|length
operator|+
literal|1
argument_list|,
name|l2info
operator|.
name|caplen
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown protocol 0x%04x, length %u"
argument_list|,
name|l2info
operator|.
name|proto
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  *     ATM1 PIC cookie format  *  *     +-----+-------------------------+-------------------------------+  *     |fmtid|     vc index            |  channel  ID                  |  *     +-----+-------------------------+-------------------------------+  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ATM1
end_ifdef

begin_function
name|u_int
name|juniper_atm1_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|u_int16_t
name|extracted_ethertype
decl_stmt|;
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_ATM1
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
if|if
condition|(
name|l2info
operator|.
name|cookie
index|[
literal|0
index|]
operator|==
literal|0x80
condition|)
block|{
comment|/* OAM cell ? */
name|oam_print
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|ATM_OAM_NOHEC
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|EXTRACT_24BITS
argument_list|(
name|p
argument_list|)
operator|==
literal|0xfefe03
operator|||
comment|/* NLPID encaps ? */
name|EXTRACT_24BITS
argument_list|(
name|p
argument_list|)
operator|==
literal|0xaaaa03
condition|)
block|{
comment|/* SNAP encaps ? */
if|if
condition|(
name|llc_print
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|extracted_ethertype
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
literal|0x03
condition|)
block|{
comment|/* Cisco style NLPID encaps ? */
name|isoclns_print
argument_list|(
name|p
operator|+
literal|1
argument_list|,
name|l2info
operator|.
name|length
operator|-
literal|1
argument_list|,
name|l2info
operator|.
name|caplen
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* FIXME check if frame was recognized */
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|ip_heuristic_guess
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
comment|/* last try - vcmux encaps ? */
return|return
name|l2info
operator|.
name|header_len
return|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  *     ATM2 PIC cookie format  *  *     +-------------------------------+---------+---+-----+-----------+  *     |     channel ID                |  reserv |AAL| CCRQ| gap cnt   |  *     +-------------------------------+---------+---+-----+-----------+  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ATM2
end_ifdef

begin_function
name|u_int
name|juniper_atm2_print
parameter_list|(
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|u_int16_t
name|extracted_ethertype
decl_stmt|;
name|u_int32_t
name|control_word
decl_stmt|;
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_ATM2
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
if|if
condition|(
name|l2info
operator|.
name|cookie
index|[
literal|7
index|]
operator|&
name|ATM2_PKT_TYPE_MASK
condition|)
block|{
comment|/* OAM cell ? */
name|control_word
operator|=
name|EXTRACT_32BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|control_word
operator|==
literal|0
operator|||
name|control_word
operator|==
literal|0x08000000
condition|)
block|{
name|l2info
operator|.
name|header_len
operator|+=
literal|4
expr_stmt|;
name|l2info
operator|.
name|length
operator|-=
literal|4
expr_stmt|;
name|p
operator|+=
literal|4
expr_stmt|;
block|}
name|oam_print
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|ATM_OAM_NOHEC
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|EXTRACT_24BITS
argument_list|(
name|p
argument_list|)
operator|==
literal|0xfefe03
operator|||
comment|/* NLPID encaps ? */
name|EXTRACT_24BITS
argument_list|(
name|p
argument_list|)
operator|==
literal|0xaaaa03
condition|)
block|{
comment|/* SNAP encaps ? */
if|if
condition|(
name|llc_print
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|extracted_ethertype
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|l2info
operator|.
name|direction
operator|!=
name|JUNIPER_BPF_PKT_IN
operator|&&
comment|/* ether-over-1483 encaps ? */
operator|(
name|EXTRACT_32BITS
argument_list|(
name|l2info
operator|.
name|cookie
argument_list|)
operator|&
name|ATM2_GAP_COUNT_MASK
operator|)
condition|)
block|{
name|ether_print
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
literal|0x03
condition|)
block|{
comment|/* Cisco style NLPID encaps ? */
name|isoclns_print
argument_list|(
name|p
operator|+
literal|1
argument_list|,
name|l2info
operator|.
name|length
operator|-
literal|1
argument_list|,
name|l2info
operator|.
name|caplen
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* FIXME check if frame was recognized */
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|juniper_ppp_heuristic_guess
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
comment|/* PPPoA vcmux encaps ? */
return|return
name|l2info
operator|.
name|header_len
return|;
if|if
condition|(
name|ip_heuristic_guess
argument_list|(
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
comment|/* last try - vcmux encaps ? */
return|return
name|l2info
operator|.
name|header_len
return|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* try to guess, based on all PPP protos that are supported in  * a juniper router if the payload data is encapsulated using PPP */
end_comment

begin_function
name|int
name|juniper_ppp_heuristic_guess
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
switch|switch
condition|(
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
condition|)
block|{
case|case
name|PPP_IP
case|:
case|case
name|PPP_OSI
case|:
case|case
name|PPP_MPLS_UCAST
case|:
case|case
name|PPP_MPLS_MCAST
case|:
case|case
name|PPP_IPCP
case|:
case|case
name|PPP_OSICP
case|:
case|case
name|PPP_MPLSCP
case|:
case|case
name|PPP_LCP
case|:
case|case
name|PPP_PAP
case|:
case|case
name|PPP_CHAP
case|:
case|case
name|PPP_ML
case|:
ifdef|#
directive|ifdef
name|INET6
case|case
name|PPP_IPV6
case|:
case|case
name|PPP_IPV6CP
case|:
endif|#
directive|endif
name|ppp_print
argument_list|(
name|p
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
literal|0
return|;
comment|/* did not find a ppp header */
break|break;
block|}
return|return
literal|1
return|;
comment|/* we printed a ppp packet */
block|}
end_function

begin_function
name|int
name|ip_heuristic_guess
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
switch|switch
condition|(
name|p
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0x45
case|:
case|case
literal|0x46
case|:
case|case
literal|0x47
case|:
case|case
literal|0x48
case|:
case|case
literal|0x49
case|:
case|case
literal|0x4a
case|:
case|case
literal|0x4b
case|:
case|case
literal|0x4c
case|:
case|case
literal|0x4d
case|:
case|case
literal|0x4e
case|:
case|case
literal|0x4f
case|:
name|ip_print
argument_list|(
name|gndo
argument_list|,
name|p
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
literal|0x60
case|:
case|case
literal|0x61
case|:
case|case
literal|0x62
case|:
case|case
literal|0x63
case|:
case|case
literal|0x64
case|:
case|case
literal|0x65
case|:
case|case
literal|0x66
case|:
case|case
literal|0x67
case|:
case|case
literal|0x68
case|:
case|case
literal|0x69
case|:
case|case
literal|0x6a
case|:
case|case
literal|0x6b
case|:
case|case
literal|0x6c
case|:
case|case
literal|0x6d
case|:
case|case
literal|0x6e
case|:
case|case
literal|0x6f
case|:
name|ip6_print
argument_list|(
name|p
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
return|return
literal|0
return|;
comment|/* did not find a ip header */
break|break;
block|}
return|return
literal|1
return|;
comment|/* we printed an v4/v6 packet */
block|}
end_function

begin_function
specifier|static
name|int
name|juniper_parse_header
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
name|struct
name|juniper_l2info_t
modifier|*
name|l2info
parameter_list|)
block|{
name|struct
name|juniper_cookie_table_t
modifier|*
name|lp
init|=
name|juniper_cookie_table
decl_stmt|;
name|u_int
name|idx
decl_stmt|;
name|l2info
operator|->
name|header_len
operator|=
literal|0
expr_stmt|;
name|l2info
operator|->
name|cookie_len
operator|=
literal|0
expr_stmt|;
name|l2info
operator|->
name|proto
operator|=
literal|0
expr_stmt|;
name|l2info
operator|->
name|length
operator|=
name|h
operator|->
name|len
expr_stmt|;
name|l2info
operator|->
name|caplen
operator|=
name|h
operator|->
name|caplen
expr_stmt|;
name|l2info
operator|->
name|direction
operator|=
name|p
index|[
literal|3
index|]
operator|&
name|JUNIPER_BPF_PKT_IN
expr_stmt|;
name|TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|EXTRACT_24BITS
argument_list|(
name|p
argument_list|)
operator|!=
name|JUNIPER_MGC_NUMBER
condition|)
comment|/* magic number found ? */
return|return
literal|0
return|;
else|else
name|l2info
operator|->
name|header_len
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|eflag
condition|)
comment|/* print direction */
name|printf
argument_list|(
literal|"%3s "
argument_list|,
name|tok2str
argument_list|(
name|juniper_direction_values
argument_list|,
literal|"---"
argument_list|,
name|l2info
operator|->
name|direction
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
index|[
literal|3
index|]
operator|&
name|JUNIPER_BPF_NO_L2
operator|)
operator|==
name|JUNIPER_BPF_NO_L2
condition|)
block|{
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|"no-L2-hdr, "
argument_list|)
expr_stmt|;
comment|/* there is no link-layer present -          * perform the v4/v6 heuristics          * to figure out what it is          */
name|TCHECK2
argument_list|(
name|p
index|[
literal|8
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip_heuristic_guess
argument_list|(
name|p
operator|+
literal|8
argument_list|,
name|l2info
operator|->
name|length
operator|-
literal|8
argument_list|)
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"no IP-hdr found!"
argument_list|)
expr_stmt|;
name|l2info
operator|->
name|header_len
operator|+=
literal|4
expr_stmt|;
return|return
literal|0
return|;
comment|/* stop parsing the output further */
block|}
name|p
operator|+=
name|l2info
operator|->
name|header_len
expr_stmt|;
name|l2info
operator|->
name|length
operator|-=
name|l2info
operator|->
name|header_len
expr_stmt|;
name|l2info
operator|->
name|caplen
operator|-=
name|l2info
operator|->
name|header_len
expr_stmt|;
comment|/* search through the cookie table and copy values matching for our PIC type */
while|while
condition|(
name|lp
operator|->
name|s
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|lp
operator|->
name|pictype
operator|==
name|l2info
operator|->
name|pictype
condition|)
block|{
name|l2info
operator|->
name|cookie_len
operator|=
name|lp
operator|->
name|cookie_len
expr_stmt|;
name|l2info
operator|->
name|header_len
operator|+=
name|lp
operator|->
name|cookie_len
expr_stmt|;
switch|switch
condition|(
name|p
index|[
literal|0
index|]
condition|)
block|{
case|case
name|LS_COOKIE_ID
case|:
name|l2info
operator|->
name|cookie_type
operator|=
name|LS_COOKIE_ID
expr_stmt|;
name|l2info
operator|->
name|cookie_len
operator|+=
literal|2
expr_stmt|;
name|l2info
operator|->
name|header_len
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
name|AS_COOKIE_ID
case|:
name|l2info
operator|->
name|cookie_type
operator|=
name|AS_COOKIE_ID
expr_stmt|;
name|l2info
operator|->
name|cookie_len
operator|+=
literal|6
expr_stmt|;
name|l2info
operator|->
name|header_len
operator|+=
literal|6
expr_stmt|;
break|break;
default|default:
name|l2info
operator|->
name|bundle
operator|=
name|l2info
operator|->
name|cookie
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|"%s-PIC, cookie-len %u"
argument_list|,
name|lp
operator|->
name|s
argument_list|,
name|l2info
operator|->
name|cookie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|l2info
operator|->
name|cookie_len
operator|>
literal|0
condition|)
block|{
name|TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
name|l2info
operator|->
name|cookie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|", cookie 0x"
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|l2info
operator|->
name|cookie_len
condition|;
name|idx
operator|++
control|)
block|{
name|l2info
operator|->
name|cookie
index|[
name|idx
index|]
operator|=
name|p
index|[
name|idx
index|]
expr_stmt|;
comment|/* copy cookie data */
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|p
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|": "
argument_list|)
expr_stmt|;
comment|/* print demarc b/w L2/L3*/
name|l2info
operator|->
name|proto
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
operator|+
name|l2info
operator|->
name|cookie_len
argument_list|)
expr_stmt|;
break|break;
block|}
operator|++
name|lp
expr_stmt|;
block|}
name|p
operator|+=
name|l2info
operator|->
name|cookie_len
expr_stmt|;
comment|/* DLT_ specific parsing */
switch|switch
condition|(
name|l2info
operator|->
name|pictype
condition|)
block|{
case|case
name|DLT_JUNIPER_MLPPP
case|:
switch|switch
condition|(
name|l2info
operator|->
name|cookie_type
condition|)
block|{
case|case
name|LS_COOKIE_ID
case|:
name|l2info
operator|->
name|bundle
operator|=
name|l2info
operator|->
name|cookie
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|AS_COOKIE_ID
case|:
name|l2info
operator|->
name|bundle
operator|=
operator|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|l2info
operator|->
name|cookie
index|[
literal|6
index|]
argument_list|)
operator|>>
literal|3
operator|)
operator|&
literal|0xfff
expr_stmt|;
name|l2info
operator|->
name|proto
operator|=
operator|(
name|l2info
operator|->
name|cookie
index|[
literal|5
index|]
operator|)
operator|&
name|JUNIPER_LSQ_L3_PROTO_MASK
expr_stmt|;
break|break;
default|default:
name|l2info
operator|->
name|bundle
operator|=
name|l2info
operator|->
name|cookie
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|DLT_JUNIPER_MLFR
case|:
comment|/* fall through */
case|case
name|DLT_JUNIPER_MFR
case|:
switch|switch
condition|(
name|l2info
operator|->
name|cookie_type
condition|)
block|{
case|case
name|LS_COOKIE_ID
case|:
name|l2info
operator|->
name|bundle
operator|=
name|l2info
operator|->
name|cookie
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|AS_COOKIE_ID
case|:
name|l2info
operator|->
name|bundle
operator|=
operator|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|l2info
operator|->
name|cookie
index|[
literal|6
index|]
argument_list|)
operator|>>
literal|3
operator|)
operator|&
literal|0xfff
expr_stmt|;
break|break;
default|default:
name|l2info
operator|->
name|bundle
operator|=
name|l2info
operator|->
name|cookie
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
name|l2info
operator|->
name|proto
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|l2info
operator|->
name|header_len
operator|+=
literal|2
expr_stmt|;
name|l2info
operator|->
name|length
operator|-=
literal|2
expr_stmt|;
name|l2info
operator|->
name|caplen
operator|-=
literal|2
expr_stmt|;
break|break;
case|case
name|DLT_JUNIPER_ATM2
case|:
name|TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* ATM cell relay control word present ? */
if|if
condition|(
name|l2info
operator|->
name|cookie
index|[
literal|7
index|]
operator|&
name|ATM2_PKT_TYPE_MASK
operator|&&
operator|*
name|p
operator|&
literal|0x08
condition|)
block|{
name|l2info
operator|->
name|header_len
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|eflag
condition|)
name|printf
argument_list|(
literal|"control-word 0x%08x "
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|DLT_JUNIPER_ATM1
case|:
default|default:
break|break;
block|}
if|if
condition|(
name|eflag
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"hlen %u, proto 0x%04x, "
argument_list|,
name|l2info
operator|->
name|header_len
argument_list|,
name|l2info
operator|->
name|proto
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
comment|/* everything went ok so far. continue parsing */
name|trunc
label|:
name|printf
argument_list|(
literal|"[|juniper_hdr], length %u"
argument_list|,
name|h
operator|->
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Local Variables:  * c-style: whitesmith  * c-basic-offset: 4  * End:  */
end_comment

end_unit


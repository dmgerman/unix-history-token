begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*     NetBSD: print-juniper.c,v 1.2 2007/07/24 11:53:45 drochner Exp        */
end_comment

begin_comment
comment|/*  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code  * distributions retain the above copyright notice and this paragraph  * in its entirety, and (2) distributions including binary code include  * the above copyright notice and this paragraph in its entirety in  * the documentation or other materials provided with the distribution.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND  * WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, WITHOUT  * LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE.  *  * Original code by Hannes Gredler (hannes@juniper.net)  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_else
else|#
directive|else
end_else

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"NetBSD: print-juniper.c,v 1.3 2007/07/25 06:31:32 dogcow Exp "
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|NETDISSECT_REWORKED
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"ppp.h"
end_include

begin_include
include|#
directive|include
file|"llc.h"
end_include

begin_include
include|#
directive|include
file|"nlpid.h"
end_include

begin_include
include|#
directive|include
file|"ethertype.h"
end_include

begin_include
include|#
directive|include
file|"atm.h"
end_include

begin_define
define|#
directive|define
name|JUNIPER_BPF_OUT
value|0
end_define

begin_comment
comment|/* Outgoing packet */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_BPF_IN
value|1
end_define

begin_comment
comment|/* Incoming packet */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_BPF_PKT_IN
value|0x1
end_define

begin_comment
comment|/* Incoming packet */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_BPF_NO_L2
value|0x2
end_define

begin_comment
comment|/* L2 header stripped */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_BPF_IIF
value|0x4
end_define

begin_comment
comment|/* IIF is valid */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_BPF_FILTER
value|0x40
end_define

begin_comment
comment|/* BPF filtering is supported */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_BPF_EXT
value|0x80
end_define

begin_comment
comment|/* extensions present */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_MGC_NUMBER
value|0x4d4743
end_define

begin_comment
comment|/* = "MGC" */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_LSQ_COOKIE_RE
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|JUNIPER_LSQ_COOKIE_DIR
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|JUNIPER_LSQ_L3_PROTO_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|JUNIPER_LSQ_L3_PROTO_MASK
value|(0x17<< JUNIPER_LSQ_L3_PROTO_SHIFT)
end_define

begin_define
define|#
directive|define
name|JUNIPER_LSQ_L3_PROTO_IPV4
value|(0<< JUNIPER_LSQ_L3_PROTO_SHIFT)
end_define

begin_define
define|#
directive|define
name|JUNIPER_LSQ_L3_PROTO_IPV6
value|(1<< JUNIPER_LSQ_L3_PROTO_SHIFT)
end_define

begin_define
define|#
directive|define
name|JUNIPER_LSQ_L3_PROTO_MPLS
value|(2<< JUNIPER_LSQ_L3_PROTO_SHIFT)
end_define

begin_define
define|#
directive|define
name|JUNIPER_LSQ_L3_PROTO_ISO
value|(3<< JUNIPER_LSQ_L3_PROTO_SHIFT)
end_define

begin_define
define|#
directive|define
name|AS_PIC_COOKIE_LEN
value|8
end_define

begin_define
define|#
directive|define
name|JUNIPER_IPSEC_O_ESP_ENCRYPT_ESP_AUTHEN_TYPE
value|1
end_define

begin_define
define|#
directive|define
name|JUNIPER_IPSEC_O_ESP_ENCRYPT_AH_AUTHEN_TYPE
value|2
end_define

begin_define
define|#
directive|define
name|JUNIPER_IPSEC_O_ESP_AUTHENTICATION_TYPE
value|3
end_define

begin_define
define|#
directive|define
name|JUNIPER_IPSEC_O_AH_AUTHENTICATION_TYPE
value|4
end_define

begin_define
define|#
directive|define
name|JUNIPER_IPSEC_O_ESP_ENCRYPTION_TYPE
value|5
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|juniper_ipsec_type_values
index|[]
init|=
block|{
block|{
name|JUNIPER_IPSEC_O_ESP_ENCRYPT_ESP_AUTHEN_TYPE
block|,
literal|"ESP ENCR-AUTH"
block|}
block|,
block|{
name|JUNIPER_IPSEC_O_ESP_ENCRYPT_AH_AUTHEN_TYPE
block|,
literal|"ESP ENCR-AH AUTH"
block|}
block|,
block|{
name|JUNIPER_IPSEC_O_ESP_AUTHENTICATION_TYPE
block|,
literal|"ESP AUTH"
block|}
block|,
block|{
name|JUNIPER_IPSEC_O_AH_AUTHENTICATION_TYPE
block|,
literal|"AH AUTH"
block|}
block|,
block|{
name|JUNIPER_IPSEC_O_ESP_ENCRYPTION_TYPE
block|,
literal|"ESP ENCR"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|juniper_direction_values
index|[]
init|=
block|{
block|{
name|JUNIPER_BPF_IN
block|,
literal|"In"
block|}
block|,
block|{
name|JUNIPER_BPF_OUT
block|,
literal|"Out"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* codepoints for encoding extensions to a .pcap file */
end_comment

begin_enum
enum|enum
block|{
name|JUNIPER_EXT_TLV_IFD_IDX
init|=
literal|1
block|,
name|JUNIPER_EXT_TLV_IFD_NAME
init|=
literal|2
block|,
name|JUNIPER_EXT_TLV_IFD_MEDIATYPE
init|=
literal|3
block|,
name|JUNIPER_EXT_TLV_IFL_IDX
init|=
literal|4
block|,
name|JUNIPER_EXT_TLV_IFL_UNIT
init|=
literal|5
block|,
name|JUNIPER_EXT_TLV_IFL_ENCAPS
init|=
literal|6
block|,
name|JUNIPER_EXT_TLV_TTP_IFD_MEDIATYPE
init|=
literal|7
block|,
name|JUNIPER_EXT_TLV_TTP_IFL_ENCAPS
init|=
literal|8
block|}
enum|;
end_enum

begin_comment
comment|/* 1 byte type and 1-byte length */
end_comment

begin_define
define|#
directive|define
name|JUNIPER_EXT_TLV_OVERHEAD
value|2
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|jnx_ext_tlv_values
index|[]
init|=
block|{
block|{
name|JUNIPER_EXT_TLV_IFD_IDX
block|,
literal|"Device Interface Index"
block|}
block|,
block|{
name|JUNIPER_EXT_TLV_IFD_NAME
block|,
literal|"Device Interface Name"
block|}
block|,
block|{
name|JUNIPER_EXT_TLV_IFD_MEDIATYPE
block|,
literal|"Device Media Type"
block|}
block|,
block|{
name|JUNIPER_EXT_TLV_IFL_IDX
block|,
literal|"Logical Interface Index"
block|}
block|,
block|{
name|JUNIPER_EXT_TLV_IFL_UNIT
block|,
literal|"Logical Unit Number"
block|}
block|,
block|{
name|JUNIPER_EXT_TLV_IFL_ENCAPS
block|,
literal|"Logical Interface Encapsulation"
block|}
block|,
block|{
name|JUNIPER_EXT_TLV_TTP_IFD_MEDIATYPE
block|,
literal|"TTP derived Device Media Type"
block|}
block|,
block|{
name|JUNIPER_EXT_TLV_TTP_IFL_ENCAPS
block|,
literal|"TTP derived Logical Interface Encapsulation"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|jnx_flag_values
index|[]
init|=
block|{
block|{
name|JUNIPER_BPF_EXT
block|,
literal|"Ext"
block|}
block|,
block|{
name|JUNIPER_BPF_FILTER
block|,
literal|"Filter"
block|}
block|,
block|{
name|JUNIPER_BPF_IIF
block|,
literal|"IIF"
block|}
block|,
block|{
name|JUNIPER_BPF_NO_L2
block|,
literal|"no-L2"
block|}
block|,
block|{
name|JUNIPER_BPF_PKT_IN
block|,
literal|"In"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|JUNIPER_IFML_ETHER
value|1
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_FDDI
value|2
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_TOKENRING
value|3
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_PPP
value|4
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_FRAMERELAY
value|5
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_CISCOHDLC
value|6
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_SMDSDXI
value|7
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_ATMPVC
value|8
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_PPP_CCC
value|9
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_FRAMERELAY_CCC
value|10
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_IPIP
value|11
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_GRE
value|12
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_PIM
value|13
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_PIMD
value|14
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_CISCOHDLC_CCC
value|15
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_VLAN_CCC
value|16
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_MLPPP
value|17
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_MLFR
value|18
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_ML
value|19
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_LSI
value|20
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_DFE
value|21
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_ATM_CELLRELAY_CCC
value|22
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_CRYPTO
value|23
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_GGSN
value|24
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_LSI_PPP
value|25
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_LSI_CISCOHDLC
value|26
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_PPP_TCC
value|27
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_FRAMERELAY_TCC
value|28
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_CISCOHDLC_TCC
value|29
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_ETHERNET_CCC
value|30
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_VT
value|31
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_EXTENDED_VLAN_CCC
value|32
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_ETHER_OVER_ATM
value|33
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_MONITOR
value|34
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_ETHERNET_TCC
value|35
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_VLAN_TCC
value|36
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_EXTENDED_VLAN_TCC
value|37
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_CONTROLLER
value|38
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_MFR
value|39
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_LS
value|40
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_ETHERNET_VPLS
value|41
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_ETHERNET_VLAN_VPLS
value|42
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_ETHERNET_EXTENDED_VLAN_VPLS
value|43
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_LT
value|44
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_SERVICES
value|45
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_ETHER_VPLS_OVER_ATM
value|46
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_FR_PORT_CCC
value|47
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_FRAMERELAY_EXT_CCC
value|48
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_FRAMERELAY_EXT_TCC
value|49
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_FRAMERELAY_FLEX
value|50
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_GGSNI
value|51
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_ETHERNET_FLEX
value|52
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_COLLECTOR
value|53
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_AGGREGATOR
value|54
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_LAPD
value|55
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_PPPOE
value|56
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_PPP_SUBORDINATE
value|57
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_CISCOHDLC_SUBORDINATE
value|58
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_DFC
value|59
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFML_PICPEER
value|60
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|juniper_ifmt_values
index|[]
init|=
block|{
block|{
name|JUNIPER_IFML_ETHER
block|,
literal|"Ethernet"
block|}
block|,
block|{
name|JUNIPER_IFML_FDDI
block|,
literal|"FDDI"
block|}
block|,
block|{
name|JUNIPER_IFML_TOKENRING
block|,
literal|"Token-Ring"
block|}
block|,
block|{
name|JUNIPER_IFML_PPP
block|,
literal|"PPP"
block|}
block|,
block|{
name|JUNIPER_IFML_PPP_SUBORDINATE
block|,
literal|"PPP-Subordinate"
block|}
block|,
block|{
name|JUNIPER_IFML_FRAMERELAY
block|,
literal|"Frame-Relay"
block|}
block|,
block|{
name|JUNIPER_IFML_CISCOHDLC
block|,
literal|"Cisco-HDLC"
block|}
block|,
block|{
name|JUNIPER_IFML_SMDSDXI
block|,
literal|"SMDS-DXI"
block|}
block|,
block|{
name|JUNIPER_IFML_ATMPVC
block|,
literal|"ATM-PVC"
block|}
block|,
block|{
name|JUNIPER_IFML_PPP_CCC
block|,
literal|"PPP-CCC"
block|}
block|,
block|{
name|JUNIPER_IFML_FRAMERELAY_CCC
block|,
literal|"Frame-Relay-CCC"
block|}
block|,
block|{
name|JUNIPER_IFML_FRAMERELAY_EXT_CCC
block|,
literal|"Extended FR-CCC"
block|}
block|,
block|{
name|JUNIPER_IFML_IPIP
block|,
literal|"IP-over-IP"
block|}
block|,
block|{
name|JUNIPER_IFML_GRE
block|,
literal|"GRE"
block|}
block|,
block|{
name|JUNIPER_IFML_PIM
block|,
literal|"PIM-Encapsulator"
block|}
block|,
block|{
name|JUNIPER_IFML_PIMD
block|,
literal|"PIM-Decapsulator"
block|}
block|,
block|{
name|JUNIPER_IFML_CISCOHDLC_CCC
block|,
literal|"Cisco-HDLC-CCC"
block|}
block|,
block|{
name|JUNIPER_IFML_VLAN_CCC
block|,
literal|"VLAN-CCC"
block|}
block|,
block|{
name|JUNIPER_IFML_EXTENDED_VLAN_CCC
block|,
literal|"Extended-VLAN-CCC"
block|}
block|,
block|{
name|JUNIPER_IFML_MLPPP
block|,
literal|"Multilink-PPP"
block|}
block|,
block|{
name|JUNIPER_IFML_MLFR
block|,
literal|"Multilink-FR"
block|}
block|,
block|{
name|JUNIPER_IFML_MFR
block|,
literal|"Multilink-FR-UNI-NNI"
block|}
block|,
block|{
name|JUNIPER_IFML_ML
block|,
literal|"Multilink"
block|}
block|,
block|{
name|JUNIPER_IFML_LS
block|,
literal|"LinkService"
block|}
block|,
block|{
name|JUNIPER_IFML_LSI
block|,
literal|"LSI"
block|}
block|,
block|{
name|JUNIPER_IFML_ATM_CELLRELAY_CCC
block|,
literal|"ATM-CCC-Cell-Relay"
block|}
block|,
block|{
name|JUNIPER_IFML_CRYPTO
block|,
literal|"IPSEC-over-IP"
block|}
block|,
block|{
name|JUNIPER_IFML_GGSN
block|,
literal|"GGSN"
block|}
block|,
block|{
name|JUNIPER_IFML_PPP_TCC
block|,
literal|"PPP-TCC"
block|}
block|,
block|{
name|JUNIPER_IFML_FRAMERELAY_TCC
block|,
literal|"Frame-Relay-TCC"
block|}
block|,
block|{
name|JUNIPER_IFML_FRAMERELAY_EXT_TCC
block|,
literal|"Extended FR-TCC"
block|}
block|,
block|{
name|JUNIPER_IFML_CISCOHDLC_TCC
block|,
literal|"Cisco-HDLC-TCC"
block|}
block|,
block|{
name|JUNIPER_IFML_ETHERNET_CCC
block|,
literal|"Ethernet-CCC"
block|}
block|,
block|{
name|JUNIPER_IFML_VT
block|,
literal|"VPN-Loopback-tunnel"
block|}
block|,
block|{
name|JUNIPER_IFML_ETHER_OVER_ATM
block|,
literal|"Ethernet-over-ATM"
block|}
block|,
block|{
name|JUNIPER_IFML_ETHER_VPLS_OVER_ATM
block|,
literal|"Ethernet-VPLS-over-ATM"
block|}
block|,
block|{
name|JUNIPER_IFML_MONITOR
block|,
literal|"Monitor"
block|}
block|,
block|{
name|JUNIPER_IFML_ETHERNET_TCC
block|,
literal|"Ethernet-TCC"
block|}
block|,
block|{
name|JUNIPER_IFML_VLAN_TCC
block|,
literal|"VLAN-TCC"
block|}
block|,
block|{
name|JUNIPER_IFML_EXTENDED_VLAN_TCC
block|,
literal|"Extended-VLAN-TCC"
block|}
block|,
block|{
name|JUNIPER_IFML_CONTROLLER
block|,
literal|"Controller"
block|}
block|,
block|{
name|JUNIPER_IFML_ETHERNET_VPLS
block|,
literal|"VPLS"
block|}
block|,
block|{
name|JUNIPER_IFML_ETHERNET_VLAN_VPLS
block|,
literal|"VLAN-VPLS"
block|}
block|,
block|{
name|JUNIPER_IFML_ETHERNET_EXTENDED_VLAN_VPLS
block|,
literal|"Extended-VLAN-VPLS"
block|}
block|,
block|{
name|JUNIPER_IFML_LT
block|,
literal|"Logical-tunnel"
block|}
block|,
block|{
name|JUNIPER_IFML_SERVICES
block|,
literal|"General-Services"
block|}
block|,
block|{
name|JUNIPER_IFML_PPPOE
block|,
literal|"PPPoE"
block|}
block|,
block|{
name|JUNIPER_IFML_ETHERNET_FLEX
block|,
literal|"Flexible-Ethernet-Services"
block|}
block|,
block|{
name|JUNIPER_IFML_FRAMERELAY_FLEX
block|,
literal|"Flexible-FrameRelay"
block|}
block|,
block|{
name|JUNIPER_IFML_COLLECTOR
block|,
literal|"Flow-collection"
block|}
block|,
block|{
name|JUNIPER_IFML_PICPEER
block|,
literal|"PIC Peer"
block|}
block|,
block|{
name|JUNIPER_IFML_DFC
block|,
literal|"Dynamic-Flow-Capture"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_SNAP
value|2
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_NLPID
value|3
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_VCMUX
value|4
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_LLC
value|5
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_PPP_VCMUX
value|6
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_PPP_LLC
value|7
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_PPP_FUNI
value|8
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_CCC
value|9
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_FR_NLPID
value|10
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_FR_SNAP
value|11
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_FR_PPP
value|12
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_FR_CCC
value|13
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ENET2
value|14
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_IEEE8023_SNAP
value|15
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_IEEE8023_LLC
value|16
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_PPP
value|17
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_CISCOHDLC
value|18
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_PPP_CCC
value|19
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_IPIP_NULL
value|20
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_PIM_NULL
value|21
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_GRE_NULL
value|22
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_GRE_PPP
value|23
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_PIMD_DECAPS
value|24
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_CISCOHDLC_CCC
value|25
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_CISCO_NLPID
value|26
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_VLAN_CCC
value|27
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_MLPPP
value|28
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_MLFR
value|29
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_LSI_NULL
value|30
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_AGGREGATE_UNUSED
value|31
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_CELLRELAY_CCC
value|32
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_CRYPTO
value|33
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_GGSN
value|34
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_TCC
value|35
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_FR_TCC
value|36
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_PPP_TCC
value|37
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_CISCOHDLC_TCC
value|38
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ETHERNET_CCC
value|39
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_VT
value|40
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_EOA_LLC
value|41
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_EXTENDED_VLAN_CCC
value|42
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_SNAP_TCC
value|43
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_MONITOR
value|44
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ETHERNET_TCC
value|45
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_VLAN_TCC
value|46
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_EXTENDED_VLAN_TCC
value|47
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_MFR
value|48
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ETHERNET_VPLS
value|49
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ETHERNET_VLAN_VPLS
value|50
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ETHERNET_EXTENDED_VLAN_VPLS
value|51
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_SERVICES
value|52
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_ETHER_VPLS_ATM_LLC
value|53
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_FR_PORT_CCC
value|54
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_MLPPP_LLC
value|55
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_EOA_CCC
value|56
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_LT_VLAN
value|57
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_COLLECTOR
value|58
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_AGGREGATOR
value|59
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_LAPD
value|60
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ATM_PPPOE_LLC
value|61
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_ETHERNET_PPPOE
value|62
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_PPPOE
value|63
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_PPP_SUBORDINATE
value|64
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_CISCOHDLC_SUBORDINATE
value|65
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_DFC
value|66
end_define

begin_define
define|#
directive|define
name|JUNIPER_IFLE_PICPEER
value|67
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|juniper_ifle_values
index|[]
init|=
block|{
block|{
name|JUNIPER_IFLE_AGGREGATOR
block|,
literal|"Aggregator"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_CCC
block|,
literal|"CCC over ATM"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_CELLRELAY_CCC
block|,
literal|"ATM CCC Cell Relay"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_CISCO_NLPID
block|,
literal|"CISCO compatible NLPID"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_EOA_CCC
block|,
literal|"Ethernet over ATM CCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_EOA_LLC
block|,
literal|"Ethernet over ATM LLC"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_ETHER_VPLS_ATM_LLC
block|,
literal|"Ethernet VPLS over ATM LLC"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_LLC
block|,
literal|"ATM LLC"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_MLPPP_LLC
block|,
literal|"MLPPP over ATM LLC"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_NLPID
block|,
literal|"ATM NLPID"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_PPPOE_LLC
block|,
literal|"PPPoE over ATM LLC"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_PPP_FUNI
block|,
literal|"PPP over FUNI"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_PPP_LLC
block|,
literal|"PPP over ATM LLC"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_PPP_VCMUX
block|,
literal|"PPP over ATM VCMUX"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_SNAP
block|,
literal|"ATM SNAP"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_SNAP_TCC
block|,
literal|"ATM SNAP TCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_TCC
block|,
literal|"ATM VCMUX TCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_ATM_VCMUX
block|,
literal|"ATM VCMUX"
block|}
block|,
block|{
name|JUNIPER_IFLE_CISCOHDLC
block|,
literal|"C-HDLC"
block|}
block|,
block|{
name|JUNIPER_IFLE_CISCOHDLC_CCC
block|,
literal|"C-HDLC CCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_CISCOHDLC_SUBORDINATE
block|,
literal|"C-HDLC via dialer"
block|}
block|,
block|{
name|JUNIPER_IFLE_CISCOHDLC_TCC
block|,
literal|"C-HDLC TCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_COLLECTOR
block|,
literal|"Collector"
block|}
block|,
block|{
name|JUNIPER_IFLE_CRYPTO
block|,
literal|"Crypto"
block|}
block|,
block|{
name|JUNIPER_IFLE_ENET2
block|,
literal|"Ethernet"
block|}
block|,
block|{
name|JUNIPER_IFLE_ETHERNET_CCC
block|,
literal|"Ethernet CCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_ETHERNET_EXTENDED_VLAN_VPLS
block|,
literal|"Extended VLAN VPLS"
block|}
block|,
block|{
name|JUNIPER_IFLE_ETHERNET_PPPOE
block|,
literal|"PPPoE over Ethernet"
block|}
block|,
block|{
name|JUNIPER_IFLE_ETHERNET_TCC
block|,
literal|"Ethernet TCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_ETHERNET_VLAN_VPLS
block|,
literal|"VLAN VPLS"
block|}
block|,
block|{
name|JUNIPER_IFLE_ETHERNET_VPLS
block|,
literal|"VPLS"
block|}
block|,
block|{
name|JUNIPER_IFLE_EXTENDED_VLAN_CCC
block|,
literal|"Extended VLAN CCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_EXTENDED_VLAN_TCC
block|,
literal|"Extended VLAN TCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_FR_CCC
block|,
literal|"FR CCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_FR_NLPID
block|,
literal|"FR NLPID"
block|}
block|,
block|{
name|JUNIPER_IFLE_FR_PORT_CCC
block|,
literal|"FR CCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_FR_PPP
block|,
literal|"FR PPP"
block|}
block|,
block|{
name|JUNIPER_IFLE_FR_SNAP
block|,
literal|"FR SNAP"
block|}
block|,
block|{
name|JUNIPER_IFLE_FR_TCC
block|,
literal|"FR TCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_GGSN
block|,
literal|"GGSN"
block|}
block|,
block|{
name|JUNIPER_IFLE_GRE_NULL
block|,
literal|"GRE NULL"
block|}
block|,
block|{
name|JUNIPER_IFLE_GRE_PPP
block|,
literal|"PPP over GRE"
block|}
block|,
block|{
name|JUNIPER_IFLE_IPIP_NULL
block|,
literal|"IPIP"
block|}
block|,
block|{
name|JUNIPER_IFLE_LAPD
block|,
literal|"LAPD"
block|}
block|,
block|{
name|JUNIPER_IFLE_LSI_NULL
block|,
literal|"LSI Null"
block|}
block|,
block|{
name|JUNIPER_IFLE_LT_VLAN
block|,
literal|"LT VLAN"
block|}
block|,
block|{
name|JUNIPER_IFLE_MFR
block|,
literal|"MFR"
block|}
block|,
block|{
name|JUNIPER_IFLE_MLFR
block|,
literal|"MLFR"
block|}
block|,
block|{
name|JUNIPER_IFLE_MLPPP
block|,
literal|"MLPPP"
block|}
block|,
block|{
name|JUNIPER_IFLE_MONITOR
block|,
literal|"Monitor"
block|}
block|,
block|{
name|JUNIPER_IFLE_PIMD_DECAPS
block|,
literal|"PIMd"
block|}
block|,
block|{
name|JUNIPER_IFLE_PIM_NULL
block|,
literal|"PIM Null"
block|}
block|,
block|{
name|JUNIPER_IFLE_PPP
block|,
literal|"PPP"
block|}
block|,
block|{
name|JUNIPER_IFLE_PPPOE
block|,
literal|"PPPoE"
block|}
block|,
block|{
name|JUNIPER_IFLE_PPP_CCC
block|,
literal|"PPP CCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_PPP_SUBORDINATE
block|,
literal|""
block|}
block|,
block|{
name|JUNIPER_IFLE_PPP_TCC
block|,
literal|"PPP TCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_SERVICES
block|,
literal|"General Services"
block|}
block|,
block|{
name|JUNIPER_IFLE_VLAN_CCC
block|,
literal|"VLAN CCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_VLAN_TCC
block|,
literal|"VLAN TCC"
block|}
block|,
block|{
name|JUNIPER_IFLE_VT
block|,
literal|"VT"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|juniper_cookie_table_t
block|{
name|uint32_t
name|pictype
decl_stmt|;
comment|/* pic type */
name|uint8_t
name|cookie_len
decl_stmt|;
comment|/* cookie len */
specifier|const
name|char
modifier|*
name|s
decl_stmt|;
comment|/* pic name */
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|juniper_cookie_table_t
name|juniper_cookie_table
index|[]
init|=
block|{
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ATM1
block|{
name|DLT_JUNIPER_ATM1
block|,
literal|4
block|,
literal|"ATM1"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ATM2
block|{
name|DLT_JUNIPER_ATM2
block|,
literal|8
block|,
literal|"ATM2"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MLPPP
block|{
name|DLT_JUNIPER_MLPPP
block|,
literal|2
block|,
literal|"MLPPP"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MLFR
block|{
name|DLT_JUNIPER_MLFR
block|,
literal|2
block|,
literal|"MLFR"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MFR
block|{
name|DLT_JUNIPER_MFR
block|,
literal|4
block|,
literal|"MFR"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_PPPOE
block|{
name|DLT_JUNIPER_PPPOE
block|,
literal|0
block|,
literal|"PPPoE"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_PPPOE_ATM
block|{
name|DLT_JUNIPER_PPPOE_ATM
block|,
literal|0
block|,
literal|"PPPoE ATM"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_GGSN
block|{
name|DLT_JUNIPER_GGSN
block|,
literal|8
block|,
literal|"GGSN"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MONITOR
block|{
name|DLT_JUNIPER_MONITOR
block|,
literal|8
block|,
literal|"MONITOR"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_SERVICES
block|{
name|DLT_JUNIPER_SERVICES
block|,
literal|8
block|,
literal|"AS"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ES
block|{
name|DLT_JUNIPER_ES
block|,
literal|0
block|,
literal|"ES"
block|}
block|,
endif|#
directive|endif
block|{
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|juniper_l2info_t
block|{
name|uint32_t
name|length
decl_stmt|;
name|uint32_t
name|caplen
decl_stmt|;
name|uint32_t
name|pictype
decl_stmt|;
name|uint8_t
name|direction
decl_stmt|;
name|uint8_t
name|header_len
decl_stmt|;
name|uint8_t
name|cookie_len
decl_stmt|;
name|uint8_t
name|cookie_type
decl_stmt|;
name|uint8_t
name|cookie
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|bundle
decl_stmt|;
name|uint16_t
name|proto
decl_stmt|;
name|uint8_t
name|flags
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|LS_COOKIE_ID
value|0x54
end_define

begin_define
define|#
directive|define
name|AS_COOKIE_ID
value|0x47
end_define

begin_define
define|#
directive|define
name|LS_MLFR_COOKIE_LEN
value|4
end_define

begin_define
define|#
directive|define
name|ML_MLFR_COOKIE_LEN
value|2
end_define

begin_define
define|#
directive|define
name|LS_MFR_COOKIE_LEN
value|6
end_define

begin_define
define|#
directive|define
name|ATM1_COOKIE_LEN
value|4
end_define

begin_define
define|#
directive|define
name|ATM2_COOKIE_LEN
value|8
end_define

begin_define
define|#
directive|define
name|ATM2_PKT_TYPE_MASK
value|0x70
end_define

begin_define
define|#
directive|define
name|ATM2_GAP_COUNT_MASK
value|0x3F
end_define

begin_define
define|#
directive|define
name|JUNIPER_PROTO_NULL
value|1
end_define

begin_define
define|#
directive|define
name|JUNIPER_PROTO_IPV4
value|2
end_define

begin_define
define|#
directive|define
name|JUNIPER_PROTO_IPV6
value|6
end_define

begin_define
define|#
directive|define
name|MFR_BE_MASK
value|0xc0
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|juniper_protocol_values
index|[]
init|=
block|{
block|{
name|JUNIPER_PROTO_NULL
block|,
literal|"Null"
block|}
block|,
block|{
name|JUNIPER_PROTO_IPV4
block|,
literal|"IPv4"
block|}
block|,
block|{
name|JUNIPER_PROTO_IPV6
block|,
literal|"IPv6"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|ip_heuristic_guess
parameter_list|(
name|netdissect_options
modifier|*
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|juniper_ppp_heuristic_guess
parameter_list|(
name|netdissect_options
modifier|*
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|juniper_parse_header
parameter_list|(
name|netdissect_options
modifier|*
parameter_list|,
specifier|const
name|u_char
modifier|*
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
parameter_list|,
name|struct
name|juniper_l2info_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_GGSN
end_ifdef

begin_function
name|u_int
name|juniper_ggsn_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
struct|struct
name|juniper_ggsn_header
block|{
name|uint8_t
name|svc_id
decl_stmt|;
name|uint8_t
name|flags_len
decl_stmt|;
name|uint8_t
name|proto
decl_stmt|;
name|uint8_t
name|flags
decl_stmt|;
name|uint8_t
name|vlan_id
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|res
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
specifier|const
name|struct
name|juniper_ggsn_header
modifier|*
name|gh
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_GGSN
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
name|gh
operator|=
operator|(
expr|struct
name|juniper_ggsn_header
operator|*
operator|)
operator|&
name|l2info
operator|.
name|cookie
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"proto %s (%u), vlan %u: "
operator|,
name|tok2str
argument_list|(
name|juniper_protocol_values
argument_list|,
literal|"Unknown"
argument_list|,
name|gh
operator|->
name|proto
argument_list|)
operator|,
name|gh
operator|->
name|proto
operator|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|gh
operator|->
name|vlan_id
index|[
literal|0
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|gh
operator|->
name|proto
condition|)
block|{
case|case
name|JUNIPER_PROTO_IPV4
case|:
name|ip_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|JUNIPER_PROTO_IPV6
case|:
name|ip6_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
default|default:
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"unknown GGSN proto (%u)"
operator|,
name|gh
operator|->
name|proto
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ES
end_ifdef

begin_function
name|u_int
name|juniper_es_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
struct|struct
name|juniper_ipsec_header
block|{
name|uint8_t
name|sa_index
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|ttl
decl_stmt|;
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|spi
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|src_ip
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|dst_ip
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
name|u_int
name|rewrite_len
decl_stmt|,
name|es_type_bundle
decl_stmt|;
specifier|const
name|struct
name|juniper_ipsec_header
modifier|*
name|ih
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_ES
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
name|ih
operator|=
operator|(
expr|struct
name|juniper_ipsec_header
operator|*
operator|)
name|p
expr_stmt|;
switch|switch
condition|(
name|ih
operator|->
name|type
condition|)
block|{
case|case
name|JUNIPER_IPSEC_O_ESP_ENCRYPT_ESP_AUTHEN_TYPE
case|:
case|case
name|JUNIPER_IPSEC_O_ESP_ENCRYPT_AH_AUTHEN_TYPE
case|:
name|rewrite_len
operator|=
literal|0
expr_stmt|;
name|es_type_bundle
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|JUNIPER_IPSEC_O_ESP_AUTHENTICATION_TYPE
case|:
case|case
name|JUNIPER_IPSEC_O_AH_AUTHENTICATION_TYPE
case|:
case|case
name|JUNIPER_IPSEC_O_ESP_ENCRYPTION_TYPE
case|:
name|rewrite_len
operator|=
literal|16
expr_stmt|;
name|es_type_bundle
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"ES Invalid type %u, length %u"
operator|,
name|ih
operator|->
name|type
operator|,
name|l2info
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
name|l2info
operator|.
name|length
operator|-=
name|rewrite_len
expr_stmt|;
name|p
operator|+=
name|rewrite_len
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
condition|)
block|{
if|if
condition|(
operator|!
name|es_type_bundle
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"ES SA, index %u, ttl %u type %s (%u), spi %u, Tunnel %s> %s, length %u\n"
operator|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ih
operator|->
name|sa_index
argument_list|)
operator|,
name|ih
operator|->
name|ttl
operator|,
name|tok2str
argument_list|(
name|juniper_ipsec_type_values
argument_list|,
literal|"Unknown"
argument_list|,
name|ih
operator|->
name|type
argument_list|)
operator|,
name|ih
operator|->
name|type
operator|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|ih
operator|->
name|spi
argument_list|)
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|ih
operator|->
name|src_ip
argument_list|)
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
operator|&
name|ih
operator|->
name|dst_ip
argument_list|)
operator|,
name|l2info
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"ES SA, index %u, ttl %u type %s (%u), length %u\n"
operator|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|ih
operator|->
name|sa_index
argument_list|)
operator|,
name|ih
operator|->
name|ttl
operator|,
name|tok2str
argument_list|(
name|juniper_ipsec_type_values
argument_list|,
literal|"Unknown"
argument_list|,
name|ih
operator|->
name|type
argument_list|)
operator|,
name|ih
operator|->
name|type
operator|,
name|l2info
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|ip_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MONITOR
end_ifdef

begin_function
name|u_int
name|juniper_monitor_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
struct|struct
name|juniper_monitor_header
block|{
name|uint8_t
name|pkt_type
decl_stmt|;
name|uint8_t
name|padding
decl_stmt|;
name|uint8_t
name|iif
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|service_id
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
specifier|const
name|struct
name|juniper_monitor_header
modifier|*
name|mh
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_MONITOR
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
name|mh
operator|=
operator|(
expr|struct
name|juniper_monitor_header
operator|*
operator|)
name|p
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"service-id %u, iif %u, pkt-type %u: "
operator|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|mh
operator|->
name|service_id
argument_list|)
operator|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|mh
operator|->
name|iif
argument_list|)
operator|,
name|mh
operator|->
name|pkt_type
operator|)
argument_list|)
expr_stmt|;
comment|/* no proto field - lets guess by first byte of IP header*/
name|ip_heuristic_guess
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_SERVICES
end_ifdef

begin_function
name|u_int
name|juniper_services_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
struct|struct
name|juniper_services_header
block|{
name|uint8_t
name|svc_id
decl_stmt|;
name|uint8_t
name|flags_len
decl_stmt|;
name|uint8_t
name|svc_set_id
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|dir_iif
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
specifier|const
name|struct
name|juniper_services_header
modifier|*
name|sh
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_SERVICES
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
name|sh
operator|=
operator|(
expr|struct
name|juniper_services_header
operator|*
operator|)
name|p
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"service-id %u flags 0x%02x service-set-id 0x%04x iif %u: "
operator|,
name|sh
operator|->
name|svc_id
operator|,
name|sh
operator|->
name|flags_len
operator|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|sh
operator|->
name|svc_set_id
argument_list|)
operator|,
name|EXTRACT_24BITS
argument_list|(
operator|&
name|sh
operator|->
name|dir_iif
index|[
literal|1
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* no proto field - lets guess by first byte of IP header*/
name|ip_heuristic_guess
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_PPPOE
end_ifdef

begin_function
name|u_int
name|juniper_pppoe_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_PPPOE
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
comment|/* this DLT contains nothing but raw ethernet frames */
name|ether_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ETHER
end_ifdef

begin_function
name|u_int
name|juniper_ether_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_ETHER
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
comment|/* this DLT contains nothing but raw Ethernet frames */
name|ether_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_PPP
end_ifdef

begin_function
name|u_int
name|juniper_ppp_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_PPP
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
comment|/* this DLT contains nothing but raw ppp frames */
name|ppp_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_FRELAY
end_ifdef

begin_function
name|u_int
name|juniper_frelay_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_FRELAY
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
comment|/* this DLT contains nothing but raw frame-relay frames */
name|fr_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_CHDLC
end_ifdef

begin_function
name|u_int
name|juniper_chdlc_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_CHDLC
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
comment|/* this DLT contains nothing but raw c-hdlc frames */
name|chdlc_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_PPPOE_ATM
end_ifdef

begin_function
name|u_int
name|juniper_pppoe_atm_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|uint16_t
name|extracted_ethertype
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_PPPOE_ATM
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
name|extracted_ethertype
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
comment|/* this DLT contains nothing but raw PPPoE frames,          * prepended with a type field*/
if|if
condition|(
name|ethertype_print
argument_list|(
name|ndo
argument_list|,
name|extracted_ethertype
argument_list|,
name|p
operator|+
name|ETHERTYPE_LEN
argument_list|,
name|l2info
operator|.
name|length
operator|-
name|ETHERTYPE_LEN
argument_list|,
name|l2info
operator|.
name|caplen
operator|-
name|ETHERTYPE_LEN
argument_list|)
operator|==
literal|0
condition|)
comment|/* ether_type not known, probably it wasn't one */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"unknown ethertype 0x%04x"
operator|,
name|extracted_ethertype
operator|)
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MLPPP
end_ifdef

begin_function
name|u_int
name|juniper_mlppp_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_MLPPP
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
comment|/* suppress Bundle-ID if frame was captured on a child-link          * best indicator if the cookie looks like a proto */
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
operator|&&
name|EXTRACT_16BITS
argument_list|(
operator|&
name|l2info
operator|.
name|cookie
argument_list|)
operator|!=
name|PPP_OSI
operator|&&
name|EXTRACT_16BITS
argument_list|(
operator|&
name|l2info
operator|.
name|cookie
argument_list|)
operator|!=
operator|(
name|PPP_ADDRESS
operator|<<
literal|8
operator||
name|PPP_CONTROL
operator|)
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"Bundle-ID %u: "
operator|,
name|l2info
operator|.
name|bundle
operator|)
argument_list|)
expr_stmt|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
comment|/* first try the LSQ protos */
switch|switch
condition|(
name|l2info
operator|.
name|proto
condition|)
block|{
case|case
name|JUNIPER_LSQ_L3_PROTO_IPV4
case|:
comment|/* IP traffic going to the RE would not have a cookie              * -> this must be incoming IS-IS over PPP              */
if|if
condition|(
name|l2info
operator|.
name|cookie
index|[
literal|4
index|]
operator|==
operator|(
name|JUNIPER_LSQ_COOKIE_RE
operator||
name|JUNIPER_LSQ_COOKIE_DIR
operator|)
condition|)
name|ppp_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
else|else
name|ip_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
ifdef|#
directive|ifdef
name|INET6
case|case
name|JUNIPER_LSQ_L3_PROTO_IPV6
case|:
name|ip6_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
endif|#
directive|endif
case|case
name|JUNIPER_LSQ_L3_PROTO_MPLS
case|:
name|mpls_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
case|case
name|JUNIPER_LSQ_L3_PROTO_ISO
case|:
name|isoclns_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
default|default:
break|break;
block|}
comment|/* zero length cookie ? */
switch|switch
condition|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|l2info
operator|.
name|cookie
argument_list|)
condition|)
block|{
case|case
name|PPP_OSI
case|:
name|ppp_print
argument_list|(
name|ndo
argument_list|,
name|p
operator|-
literal|2
argument_list|,
name|l2info
operator|.
name|length
operator|+
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|PPP_ADDRESS
operator|<<
literal|8
operator||
name|PPP_CONTROL
operator|)
case|:
comment|/* fall through */
default|default:
name|ppp_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MFR
end_ifdef

begin_function
name|u_int
name|juniper_mfr_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_MFR
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
comment|/* child-link ? */
if|if
condition|(
name|l2info
operator|.
name|cookie_len
operator|==
literal|0
condition|)
block|{
name|mfr_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
comment|/* first try the LSQ protos */
if|if
condition|(
name|l2info
operator|.
name|cookie_len
operator|==
name|AS_PIC_COOKIE_LEN
condition|)
block|{
switch|switch
condition|(
name|l2info
operator|.
name|proto
condition|)
block|{
case|case
name|JUNIPER_LSQ_L3_PROTO_IPV4
case|:
name|ip_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
ifdef|#
directive|ifdef
name|INET6
case|case
name|JUNIPER_LSQ_L3_PROTO_IPV6
case|:
name|ip6_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
endif|#
directive|endif
case|case
name|JUNIPER_LSQ_L3_PROTO_MPLS
case|:
name|mpls_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
case|case
name|JUNIPER_LSQ_L3_PROTO_ISO
case|:
name|isoclns_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
default|default:
break|break;
block|}
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
comment|/* suppress Bundle-ID if frame was captured on a child-link */
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
operator|&&
name|EXTRACT_32BITS
argument_list|(
name|l2info
operator|.
name|cookie
argument_list|)
operator|!=
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"Bundle-ID %u, "
operator|,
name|l2info
operator|.
name|bundle
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|l2info
operator|.
name|proto
condition|)
block|{
case|case
operator|(
name|LLCSAP_ISONS
operator|<<
literal|8
operator||
name|LLCSAP_ISONS
operator|)
case|:
name|isoclns_print
argument_list|(
name|ndo
argument_list|,
name|p
operator|+
literal|1
argument_list|,
name|l2info
operator|.
name|length
operator|-
literal|1
argument_list|,
name|l2info
operator|.
name|caplen
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator||
name|NLPID_Q933
operator|)
case|:
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator||
name|NLPID_IP
operator|)
case|:
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator||
name|NLPID_IP6
operator|)
case|:
comment|/* pass IP{4,6} to the OSI layer for proper link-layer printing */
name|isoclns_print
argument_list|(
name|ndo
argument_list|,
name|p
operator|-
literal|1
argument_list|,
name|l2info
operator|.
name|length
operator|+
literal|1
argument_list|,
name|l2info
operator|.
name|caplen
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"unknown protocol 0x%04x, length %u"
operator|,
name|l2info
operator|.
name|proto
operator|,
name|l2info
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MLFR
end_ifdef

begin_function
name|u_int
name|juniper_mlfr_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_MLFR
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
comment|/* suppress Bundle-ID if frame was captured on a child-link */
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
operator|&&
name|EXTRACT_32BITS
argument_list|(
name|l2info
operator|.
name|cookie
argument_list|)
operator|!=
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"Bundle-ID %u, "
operator|,
name|l2info
operator|.
name|bundle
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|l2info
operator|.
name|proto
condition|)
block|{
case|case
operator|(
name|LLC_UI
operator|)
case|:
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator|)
case|:
name|isoclns_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator||
name|NLPID_Q933
operator|)
case|:
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator||
name|NLPID_IP
operator|)
case|:
case|case
operator|(
name|LLC_UI
operator|<<
literal|8
operator||
name|NLPID_IP6
operator|)
case|:
comment|/* pass IP{4,6} to the OSI layer for proper link-layer printing */
name|isoclns_print
argument_list|(
name|ndo
argument_list|,
name|p
operator|-
literal|1
argument_list|,
name|l2info
operator|.
name|length
operator|+
literal|1
argument_list|,
name|l2info
operator|.
name|caplen
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"unknown protocol 0x%04x, length %u"
operator|,
name|l2info
operator|.
name|proto
operator|,
name|l2info
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  *     ATM1 PIC cookie format  *  *     +-----+-------------------------+-------------------------------+  *     |fmtid|     vc index            |  channel  ID                  |  *     +-----+-------------------------+-------------------------------+  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ATM1
end_ifdef

begin_function
name|u_int
name|juniper_atm1_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|uint16_t
name|extracted_ethertype
decl_stmt|;
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_ATM1
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
if|if
condition|(
name|l2info
operator|.
name|cookie
index|[
literal|0
index|]
operator|==
literal|0x80
condition|)
block|{
comment|/* OAM cell ? */
name|oam_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|ATM_OAM_NOHEC
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|EXTRACT_24BITS
argument_list|(
name|p
argument_list|)
operator|==
literal|0xfefe03
operator|||
comment|/* NLPID encaps ? */
name|EXTRACT_24BITS
argument_list|(
name|p
argument_list|)
operator|==
literal|0xaaaa03
condition|)
block|{
comment|/* SNAP encaps ? */
if|if
condition|(
name|llc_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|extracted_ethertype
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
literal|0x03
condition|)
block|{
comment|/* Cisco style NLPID encaps ? */
name|isoclns_print
argument_list|(
name|ndo
argument_list|,
name|p
operator|+
literal|1
argument_list|,
name|l2info
operator|.
name|length
operator|-
literal|1
argument_list|,
name|l2info
operator|.
name|caplen
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* FIXME check if frame was recognized */
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|ip_heuristic_guess
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
comment|/* last try - vcmux encaps ? */
return|return
name|l2info
operator|.
name|header_len
return|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  *     ATM2 PIC cookie format  *  *     +-------------------------------+---------+---+-----+-----------+  *     |     channel ID                |  reserv |AAL| CCRQ| gap cnt   |  *     +-------------------------------+---------+---+-----+-----------+  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ATM2
end_ifdef

begin_function
name|u_int
name|juniper_atm2_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|)
block|{
name|uint16_t
name|extracted_ethertype
decl_stmt|;
name|struct
name|juniper_l2info_t
name|l2info
decl_stmt|;
name|l2info
operator|.
name|pictype
operator|=
name|DLT_JUNIPER_ATM2
expr_stmt|;
if|if
condition|(
name|juniper_parse_header
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|h
argument_list|,
operator|&
name|l2info
argument_list|)
operator|==
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
name|p
operator|+=
name|l2info
operator|.
name|header_len
expr_stmt|;
if|if
condition|(
name|l2info
operator|.
name|cookie
index|[
literal|7
index|]
operator|&
name|ATM2_PKT_TYPE_MASK
condition|)
block|{
comment|/* OAM cell ? */
name|oam_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|ATM_OAM_NOHEC
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|EXTRACT_24BITS
argument_list|(
name|p
argument_list|)
operator|==
literal|0xfefe03
operator|||
comment|/* NLPID encaps ? */
name|EXTRACT_24BITS
argument_list|(
name|p
argument_list|)
operator|==
literal|0xaaaa03
condition|)
block|{
comment|/* SNAP encaps ? */
if|if
condition|(
name|llc_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|extracted_ethertype
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|l2info
operator|.
name|direction
operator|!=
name|JUNIPER_BPF_PKT_IN
operator|&&
comment|/* ether-over-1483 encaps ? */
operator|(
name|EXTRACT_32BITS
argument_list|(
name|l2info
operator|.
name|cookie
argument_list|)
operator|&
name|ATM2_GAP_COUNT_MASK
operator|)
condition|)
block|{
name|ether_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|,
name|l2info
operator|.
name|caplen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
literal|0x03
condition|)
block|{
comment|/* Cisco style NLPID encaps ? */
name|isoclns_print
argument_list|(
name|ndo
argument_list|,
name|p
operator|+
literal|1
argument_list|,
name|l2info
operator|.
name|length
operator|-
literal|1
argument_list|,
name|l2info
operator|.
name|caplen
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* FIXME check if frame was recognized */
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
if|if
condition|(
name|juniper_ppp_heuristic_guess
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
comment|/* PPPoA vcmux encaps ? */
return|return
name|l2info
operator|.
name|header_len
return|;
if|if
condition|(
name|ip_heuristic_guess
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|l2info
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
comment|/* last try - vcmux encaps ? */
return|return
name|l2info
operator|.
name|header_len
return|;
return|return
name|l2info
operator|.
name|header_len
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* try to guess, based on all PPP protos that are supported in  * a juniper router if the payload data is encapsulated using PPP */
end_comment

begin_function
specifier|static
name|int
name|juniper_ppp_heuristic_guess
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
switch|switch
condition|(
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
condition|)
block|{
case|case
name|PPP_IP
case|:
case|case
name|PPP_OSI
case|:
case|case
name|PPP_MPLS_UCAST
case|:
case|case
name|PPP_MPLS_MCAST
case|:
case|case
name|PPP_IPCP
case|:
case|case
name|PPP_OSICP
case|:
case|case
name|PPP_MPLSCP
case|:
case|case
name|PPP_LCP
case|:
case|case
name|PPP_PAP
case|:
case|case
name|PPP_CHAP
case|:
case|case
name|PPP_ML
case|:
ifdef|#
directive|ifdef
name|INET6
case|case
name|PPP_IPV6
case|:
case|case
name|PPP_IPV6CP
case|:
endif|#
directive|endif
name|ppp_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
literal|0
return|;
comment|/* did not find a ppp header */
break|break;
block|}
return|return
literal|1
return|;
comment|/* we printed a ppp packet */
block|}
end_function

begin_function
specifier|static
name|int
name|ip_heuristic_guess
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
switch|switch
condition|(
name|p
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0x45
case|:
case|case
literal|0x46
case|:
case|case
literal|0x47
case|:
case|case
literal|0x48
case|:
case|case
literal|0x49
case|:
case|case
literal|0x4a
case|:
case|case
literal|0x4b
case|:
case|case
literal|0x4c
case|:
case|case
literal|0x4d
case|:
case|case
literal|0x4e
case|:
case|case
literal|0x4f
case|:
name|ip_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
literal|0x60
case|:
case|case
literal|0x61
case|:
case|case
literal|0x62
case|:
case|case
literal|0x63
case|:
case|case
literal|0x64
case|:
case|case
literal|0x65
case|:
case|case
literal|0x66
case|:
case|case
literal|0x67
case|:
case|case
literal|0x68
case|:
case|case
literal|0x69
case|:
case|case
literal|0x6a
case|:
case|case
literal|0x6b
case|:
case|case
literal|0x6c
case|:
case|case
literal|0x6d
case|:
case|case
literal|0x6e
case|:
case|case
literal|0x6f
case|:
name|ip6_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
return|return
literal|0
return|;
comment|/* did not find a ip header */
break|break;
block|}
return|return
literal|1
return|;
comment|/* we printed an v4/v6 packet */
block|}
end_function

begin_function
specifier|static
name|int
name|juniper_read_tlv_value
parameter_list|(
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
name|u_int
name|tlv_type
parameter_list|,
name|u_int
name|tlv_len
parameter_list|)
block|{
name|int
name|tlv_value
decl_stmt|;
comment|/* TLVs< 128 are little endian encoded */
if|if
condition|(
name|tlv_type
operator|<
literal|128
condition|)
block|{
switch|switch
condition|(
name|tlv_len
condition|)
block|{
case|case
literal|1
case|:
name|tlv_value
operator|=
operator|*
name|p
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tlv_value
operator|=
name|EXTRACT_LE_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|tlv_value
operator|=
name|EXTRACT_LE_24BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|tlv_value
operator|=
name|EXTRACT_LE_32BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
default|default:
name|tlv_value
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
comment|/* TLVs>= 128 are big endian encoded */
switch|switch
condition|(
name|tlv_len
condition|)
block|{
case|case
literal|1
case|:
name|tlv_value
operator|=
operator|*
name|p
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tlv_value
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|tlv_value
operator|=
name|EXTRACT_24BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|tlv_value
operator|=
name|EXTRACT_32BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
default|default:
name|tlv_value
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
return|return
name|tlv_value
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|juniper_parse_header
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|p
parameter_list|,
specifier|const
name|struct
name|pcap_pkthdr
modifier|*
name|h
parameter_list|,
name|struct
name|juniper_l2info_t
modifier|*
name|l2info
parameter_list|)
block|{
specifier|const
name|struct
name|juniper_cookie_table_t
modifier|*
name|lp
init|=
name|juniper_cookie_table
decl_stmt|;
name|u_int
name|idx
decl_stmt|,
name|jnx_ext_len
decl_stmt|,
name|jnx_header_len
init|=
literal|0
decl_stmt|;
name|uint8_t
name|tlv_type
decl_stmt|,
name|tlv_len
decl_stmt|;
name|uint32_t
name|control_word
decl_stmt|;
name|int
name|tlv_value
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|tptr
decl_stmt|;
name|l2info
operator|->
name|header_len
operator|=
literal|0
expr_stmt|;
name|l2info
operator|->
name|cookie_len
operator|=
literal|0
expr_stmt|;
name|l2info
operator|->
name|proto
operator|=
literal|0
expr_stmt|;
name|l2info
operator|->
name|length
operator|=
name|h
operator|->
name|len
expr_stmt|;
name|l2info
operator|->
name|caplen
operator|=
name|h
operator|->
name|caplen
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|l2info
operator|->
name|flags
operator|=
name|p
index|[
literal|3
index|]
expr_stmt|;
name|l2info
operator|->
name|direction
operator|=
name|p
index|[
literal|3
index|]
operator|&
name|JUNIPER_BPF_PKT_IN
expr_stmt|;
if|if
condition|(
name|EXTRACT_24BITS
argument_list|(
name|p
argument_list|)
operator|!=
name|JUNIPER_MGC_NUMBER
condition|)
block|{
comment|/* magic number found ? */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"no magic-number found!"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
condition|)
comment|/* print direction */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%3s "
operator|,
name|tok2str
argument_list|(
name|juniper_direction_values
argument_list|,
literal|"---"
argument_list|,
name|l2info
operator|->
name|direction
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* magic number + flags */
name|jnx_header_len
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tJuniper PCAP Flags [%s]"
operator|,
name|bittok2str
argument_list|(
name|jnx_flag_values
argument_list|,
literal|"none"
argument_list|,
name|l2info
operator|->
name|flags
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* extensions present ?  - calculate how much bytes to skip */
if|if
condition|(
operator|(
name|l2info
operator|->
name|flags
operator|&
name|JUNIPER_BPF_EXT
operator|)
operator|==
name|JUNIPER_BPF_EXT
condition|)
block|{
name|tptr
operator|=
name|p
operator|+
name|jnx_header_len
expr_stmt|;
comment|/* ok to read extension length ? */
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|jnx_ext_len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
expr_stmt|;
name|jnx_header_len
operator|+=
literal|2
expr_stmt|;
name|tptr
operator|+=
literal|2
expr_stmt|;
comment|/* nail up the total length -          * just in case something goes wrong          * with TLV parsing */
name|jnx_header_len
operator|+=
name|jnx_ext_len
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", PCAP Extension(s) total length %u"
operator|,
name|jnx_ext_len
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
name|jnx_ext_len
argument_list|)
expr_stmt|;
while|while
condition|(
name|jnx_ext_len
operator|>
name|JUNIPER_EXT_TLV_OVERHEAD
condition|)
block|{
name|tlv_type
operator|=
operator|*
operator|(
name|tptr
operator|++
operator|)
expr_stmt|;
name|tlv_len
operator|=
operator|*
operator|(
name|tptr
operator|++
operator|)
expr_stmt|;
name|tlv_value
operator|=
literal|0
expr_stmt|;
comment|/* sanity check */
if|if
condition|(
name|tlv_type
operator|==
literal|0
operator|||
name|tlv_len
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t  %s Extension TLV #%u, length %u, value "
operator|,
name|tok2str
argument_list|(
name|jnx_ext_tlv_values
argument_list|,
literal|"Unknown"
argument_list|,
name|tlv_type
argument_list|)
operator|,
name|tlv_type
operator|,
name|tlv_len
operator|)
argument_list|)
expr_stmt|;
name|tlv_value
operator|=
name|juniper_read_tlv_value
argument_list|(
name|tptr
argument_list|,
name|tlv_type
argument_list|,
name|tlv_len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|tlv_type
condition|)
block|{
case|case
name|JUNIPER_EXT_TLV_IFD_NAME
case|:
comment|/* FIXME */
break|break;
case|case
name|JUNIPER_EXT_TLV_IFD_MEDIATYPE
case|:
case|case
name|JUNIPER_EXT_TLV_TTP_IFD_MEDIATYPE
case|:
if|if
condition|(
name|tlv_value
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s (%u)"
operator|,
name|tok2str
argument_list|(
name|juniper_ifmt_values
argument_list|,
literal|"Unknown"
argument_list|,
name|tlv_value
argument_list|)
operator|,
name|tlv_value
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|JUNIPER_EXT_TLV_IFL_ENCAPS
case|:
case|case
name|JUNIPER_EXT_TLV_TTP_IFL_ENCAPS
case|:
if|if
condition|(
name|tlv_value
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s (%u)"
operator|,
name|tok2str
argument_list|(
name|juniper_ifle_values
argument_list|,
literal|"Unknown"
argument_list|,
name|tlv_value
argument_list|)
operator|,
name|tlv_value
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|JUNIPER_EXT_TLV_IFL_IDX
case|:
comment|/* fall through */
case|case
name|JUNIPER_EXT_TLV_IFL_UNIT
case|:
case|case
name|JUNIPER_EXT_TLV_IFD_IDX
case|:
default|default:
if|if
condition|(
name|tlv_value
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%u"
operator|,
name|tlv_value
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|tptr
operator|+=
name|tlv_len
expr_stmt|;
name|jnx_ext_len
operator|-=
name|tlv_len
operator|+
name|JUNIPER_EXT_TLV_OVERHEAD
expr_stmt|;
block|}
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t-----original packet-----\n\t"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|l2info
operator|->
name|flags
operator|&
name|JUNIPER_BPF_NO_L2
operator|)
operator|==
name|JUNIPER_BPF_NO_L2
condition|)
block|{
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"no-L2-hdr, "
operator|)
argument_list|)
expr_stmt|;
comment|/* there is no link-layer present -          * perform the v4/v6 heuristics          * to figure out what it is          */
name|ND_TCHECK2
argument_list|(
name|p
index|[
name|jnx_header_len
operator|+
literal|4
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip_heuristic_guess
argument_list|(
name|ndo
argument_list|,
name|p
operator|+
name|jnx_header_len
operator|+
literal|4
argument_list|,
name|l2info
operator|->
name|length
operator|-
operator|(
name|jnx_header_len
operator|+
literal|4
operator|)
argument_list|)
operator|==
literal|0
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"no IP-hdr found!"
operator|)
argument_list|)
expr_stmt|;
name|l2info
operator|->
name|header_len
operator|=
name|jnx_header_len
operator|+
literal|4
expr_stmt|;
return|return
literal|0
return|;
comment|/* stop parsing the output further */
block|}
name|l2info
operator|->
name|header_len
operator|=
name|jnx_header_len
expr_stmt|;
name|p
operator|+=
name|l2info
operator|->
name|header_len
expr_stmt|;
name|l2info
operator|->
name|length
operator|-=
name|l2info
operator|->
name|header_len
expr_stmt|;
name|l2info
operator|->
name|caplen
operator|-=
name|l2info
operator|->
name|header_len
expr_stmt|;
comment|/* search through the cookie table and copy values matching for our PIC type */
while|while
condition|(
name|lp
operator|->
name|s
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|lp
operator|->
name|pictype
operator|==
name|l2info
operator|->
name|pictype
condition|)
block|{
name|l2info
operator|->
name|cookie_len
operator|+=
name|lp
operator|->
name|cookie_len
expr_stmt|;
switch|switch
condition|(
name|p
index|[
literal|0
index|]
condition|)
block|{
case|case
name|LS_COOKIE_ID
case|:
name|l2info
operator|->
name|cookie_type
operator|=
name|LS_COOKIE_ID
expr_stmt|;
name|l2info
operator|->
name|cookie_len
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
name|AS_COOKIE_ID
case|:
name|l2info
operator|->
name|cookie_type
operator|=
name|AS_COOKIE_ID
expr_stmt|;
name|l2info
operator|->
name|cookie_len
operator|=
literal|8
expr_stmt|;
break|break;
default|default:
name|l2info
operator|->
name|bundle
operator|=
name|l2info
operator|->
name|cookie
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MFR
comment|/* MFR child links don't carry cookies */
if|if
condition|(
name|l2info
operator|->
name|pictype
operator|==
name|DLT_JUNIPER_MFR
operator|&&
operator|(
name|p
index|[
literal|0
index|]
operator|&
name|MFR_BE_MASK
operator|)
operator|==
name|MFR_BE_MASK
condition|)
block|{
name|l2info
operator|->
name|cookie_len
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
name|l2info
operator|->
name|header_len
operator|+=
name|l2info
operator|->
name|cookie_len
expr_stmt|;
name|l2info
operator|->
name|length
operator|-=
name|l2info
operator|->
name|cookie_len
expr_stmt|;
name|l2info
operator|->
name|caplen
operator|-=
name|l2info
operator|->
name|cookie_len
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s-PIC, cookie-len %u"
operator|,
name|lp
operator|->
name|s
operator|,
name|l2info
operator|->
name|cookie_len
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|l2info
operator|->
name|cookie_len
operator|>
literal|0
condition|)
block|{
name|ND_TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
name|l2info
operator|->
name|cookie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", cookie 0x"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|l2info
operator|->
name|cookie_len
condition|;
name|idx
operator|++
control|)
block|{
name|l2info
operator|->
name|cookie
index|[
name|idx
index|]
operator|=
name|p
index|[
name|idx
index|]
expr_stmt|;
comment|/* copy cookie data */
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%02x"
operator|,
name|p
index|[
name|idx
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": "
operator|)
argument_list|)
expr_stmt|;
comment|/* print demarc b/w L2/L3*/
name|l2info
operator|->
name|proto
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
operator|+
name|l2info
operator|->
name|cookie_len
argument_list|)
expr_stmt|;
break|break;
block|}
operator|++
name|lp
expr_stmt|;
block|}
name|p
operator|+=
name|l2info
operator|->
name|cookie_len
expr_stmt|;
comment|/* DLT_ specific parsing */
switch|switch
condition|(
name|l2info
operator|->
name|pictype
condition|)
block|{
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MLPPP
case|case
name|DLT_JUNIPER_MLPPP
case|:
switch|switch
condition|(
name|l2info
operator|->
name|cookie_type
condition|)
block|{
case|case
name|LS_COOKIE_ID
case|:
name|l2info
operator|->
name|bundle
operator|=
name|l2info
operator|->
name|cookie
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|AS_COOKIE_ID
case|:
name|l2info
operator|->
name|bundle
operator|=
operator|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|l2info
operator|->
name|cookie
index|[
literal|6
index|]
argument_list|)
operator|>>
literal|3
operator|)
operator|&
literal|0xfff
expr_stmt|;
name|l2info
operator|->
name|proto
operator|=
operator|(
name|l2info
operator|->
name|cookie
index|[
literal|5
index|]
operator|)
operator|&
name|JUNIPER_LSQ_L3_PROTO_MASK
expr_stmt|;
break|break;
default|default:
name|l2info
operator|->
name|bundle
operator|=
name|l2info
operator|->
name|cookie
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MLFR
case|case
name|DLT_JUNIPER_MLFR
case|:
switch|switch
condition|(
name|l2info
operator|->
name|cookie_type
condition|)
block|{
case|case
name|LS_COOKIE_ID
case|:
name|l2info
operator|->
name|bundle
operator|=
name|l2info
operator|->
name|cookie
index|[
literal|1
index|]
expr_stmt|;
name|l2info
operator|->
name|proto
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|l2info
operator|->
name|header_len
operator|+=
literal|2
expr_stmt|;
name|l2info
operator|->
name|length
operator|-=
literal|2
expr_stmt|;
name|l2info
operator|->
name|caplen
operator|-=
literal|2
expr_stmt|;
break|break;
case|case
name|AS_COOKIE_ID
case|:
name|l2info
operator|->
name|bundle
operator|=
operator|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|l2info
operator|->
name|cookie
index|[
literal|6
index|]
argument_list|)
operator|>>
literal|3
operator|)
operator|&
literal|0xfff
expr_stmt|;
name|l2info
operator|->
name|proto
operator|=
operator|(
name|l2info
operator|->
name|cookie
index|[
literal|5
index|]
operator|)
operator|&
name|JUNIPER_LSQ_L3_PROTO_MASK
expr_stmt|;
break|break;
default|default:
name|l2info
operator|->
name|bundle
operator|=
name|l2info
operator|->
name|cookie
index|[
literal|0
index|]
expr_stmt|;
name|l2info
operator|->
name|header_len
operator|+=
literal|2
expr_stmt|;
name|l2info
operator|->
name|length
operator|-=
literal|2
expr_stmt|;
name|l2info
operator|->
name|caplen
operator|-=
literal|2
expr_stmt|;
break|break;
block|}
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_MFR
case|case
name|DLT_JUNIPER_MFR
case|:
switch|switch
condition|(
name|l2info
operator|->
name|cookie_type
condition|)
block|{
case|case
name|LS_COOKIE_ID
case|:
name|l2info
operator|->
name|bundle
operator|=
name|l2info
operator|->
name|cookie
index|[
literal|1
index|]
expr_stmt|;
name|l2info
operator|->
name|proto
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|l2info
operator|->
name|header_len
operator|+=
literal|2
expr_stmt|;
name|l2info
operator|->
name|length
operator|-=
literal|2
expr_stmt|;
name|l2info
operator|->
name|caplen
operator|-=
literal|2
expr_stmt|;
break|break;
case|case
name|AS_COOKIE_ID
case|:
name|l2info
operator|->
name|bundle
operator|=
operator|(
name|EXTRACT_16BITS
argument_list|(
operator|&
name|l2info
operator|->
name|cookie
index|[
literal|6
index|]
argument_list|)
operator|>>
literal|3
operator|)
operator|&
literal|0xfff
expr_stmt|;
name|l2info
operator|->
name|proto
operator|=
operator|(
name|l2info
operator|->
name|cookie
index|[
literal|5
index|]
operator|)
operator|&
name|JUNIPER_LSQ_L3_PROTO_MASK
expr_stmt|;
break|break;
default|default:
name|l2info
operator|->
name|bundle
operator|=
name|l2info
operator|->
name|cookie
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ATM2
case|case
name|DLT_JUNIPER_ATM2
case|:
name|ND_TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* ATM cell relay control word present ? */
if|if
condition|(
name|l2info
operator|->
name|cookie
index|[
literal|7
index|]
operator|&
name|ATM2_PKT_TYPE_MASK
condition|)
block|{
name|control_word
operator|=
name|EXTRACT_32BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
comment|/* some control word heuristics */
switch|switch
condition|(
name|control_word
condition|)
block|{
case|case
literal|0
case|:
comment|/* zero control word */
case|case
literal|0x08000000
case|:
comment|/*< JUNOS 7.4 control-word */
case|case
literal|0x08380000
case|:
comment|/* cntl word plus cell length (56)>= JUNOS 7.4*/
name|l2info
operator|->
name|header_len
operator|+=
literal|4
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"control-word 0x%08x "
operator|,
name|control_word
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_GGSN
case|case
name|DLT_JUNIPER_GGSN
case|:
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ATM1
case|case
name|DLT_JUNIPER_ATM1
case|:
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_PPP
case|case
name|DLT_JUNIPER_PPP
case|:
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_CHDLC
case|case
name|DLT_JUNIPER_CHDLC
case|:
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_ETHER
case|case
name|DLT_JUNIPER_ETHER
case|:
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DLT_JUNIPER_FRELAY
case|case
name|DLT_JUNIPER_FRELAY
case|:
break|break;
endif|#
directive|endif
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"Unknown Juniper DLT_ type %u: "
operator|,
name|l2info
operator|->
name|pictype
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ndo
operator|->
name|ndo_eflag
operator|>
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"hlen %u, proto 0x%04x, "
operator|,
name|l2info
operator|->
name|header_len
operator|,
name|l2info
operator|->
name|proto
operator|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
comment|/* everything went ok so far. continue parsing */
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|juniper_hdr], length %u"
operator|,
name|h
operator|->
name|len
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Local Variables:  * c-style: whitesmith  * c-basic-offset: 4  * End:  */
end_comment

end_unit


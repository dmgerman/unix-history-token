begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2007 - Andrey "nording" Chernyak<andrew@nording.ru>  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code distributions  * retain the above copyright notice and this paragraph in its entirety, (2)  * distributions including binary code include the above copyright notice and  * this paragraph in its entirety in the documentation or other materials  * provided with the distribution, and (3) all advertising materials mentioning  * features or use of this software display the following acknowledgement:  * ``This product includes software developed by the University of California,  * Lawrence Berkeley Laboratory and its contributors.'' Neither the name of  * the University nor the names of its contributors may be used to endorse  * or promote products derived from this software without specific prior  * written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * Format and print Realtek Remote Control Protocol (RRCP)  * and Realtek Echo Protocol (RRCP-REP) packets.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
name|_U_
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-rrcp.c,v 1.1.2.2 2008-04-11 17:00:00 gianluca Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"netdissect.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"ether.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|ETH_ALEN
end_ifndef

begin_define
define|#
directive|define
name|ETH_ALEN
value|6
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|rrcp_packet_t
block|{
name|u_int16_t
name|rrcp_ethertype
decl_stmt|;
comment|/* 0x8899 */
name|u_int8_t
name|rrcp_proto
decl_stmt|;
comment|/* must be 0x01         */
name|u_int8_t
name|rrcp_opcode
range|:
literal|7
decl_stmt|;
comment|/* 0x00 = hello, 0x01 = get, 0x02 = set */
name|u_int8_t
name|rrcp_isreply
range|:
literal|1
decl_stmt|;
comment|/* 0 = request to switch, 1 = reply from switch */
name|u_int16_t
name|rrcp_authkey
decl_stmt|;
comment|/* 0x2379 by default */
name|u_int16_t
name|rrcp_reg_addr
decl_stmt|;
comment|/* register address */
name|u_int32_t
name|rrcp_reg_data
decl_stmt|;
comment|/* register data */
name|u_int32_t
name|cookie1
decl_stmt|;
name|u_int32_t
name|cookie2
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rrcp_helloreply_packet_t
block|{
name|u_int16_t
name|rrcp_ethertype
decl_stmt|;
comment|/* 0x8899 */
name|u_int8_t
name|rrcp_proto
decl_stmt|;
comment|/* must be 0x01         */
name|u_int8_t
name|rrcp_opcode
range|:
literal|7
decl_stmt|;
comment|/* 0x00 = hello, 0x01 = get, 0x02 = set */
name|u_int8_t
name|rrcp_isreply
range|:
literal|1
decl_stmt|;
comment|/* 0 = request to switch, 1 = reply from switch */
name|u_int16_t
name|rrcp_authkey
decl_stmt|;
comment|/* 0x2379 by default */
name|u_int8_t
name|rrcp_downlink_port
decl_stmt|;
comment|/*  */
name|u_int8_t
name|rrcp_uplink_port
decl_stmt|;
comment|/*  */
name|u_int8_t
name|rrcp_uplink_mac
index|[
name|ETH_ALEN
index|]
decl_stmt|;
comment|/*  */
name|u_int16_t
name|rrcp_chip_id
decl_stmt|;
comment|/*  */
name|u_int32_t
name|rrcp_vendor_id
decl_stmt|;
comment|/*  */
block|}
struct|;
end_struct

begin_comment
comment|/*  * Print RRCP requests  */
end_comment

begin_function
name|void
name|rrcp_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|cp
parameter_list|,
name|u_int
name|length
name|_U_
parameter_list|)
block|{
specifier|const
name|struct
name|rrcp_packet_t
modifier|*
name|rrcp
decl_stmt|;
specifier|const
name|struct
name|rrcp_helloreply_packet_t
modifier|*
name|rrcp_hello
decl_stmt|;
specifier|register
specifier|const
name|struct
name|ether_header
modifier|*
name|ep
decl_stmt|;
name|char
name|proto_str
index|[
literal|16
index|]
decl_stmt|;
name|char
name|opcode_str
index|[
literal|32
index|]
decl_stmt|;
name|ep
operator|=
operator|(
specifier|const
expr|struct
name|ether_header
operator|*
operator|)
name|cp
expr_stmt|;
name|rrcp
operator|=
operator|(
specifier|const
expr|struct
name|rrcp_packet_t
operator|*
operator|)
operator|(
name|cp
operator|+
literal|12
operator|)
expr_stmt|;
name|rrcp_hello
operator|=
operator|(
specifier|const
expr|struct
name|rrcp_helloreply_packet_t
operator|*
operator|)
operator|(
name|cp
operator|+
literal|12
operator|)
expr_stmt|;
if|if
condition|(
name|rrcp
operator|->
name|rrcp_proto
operator|==
literal|1
condition|)
block|{
name|strcpy
argument_list|(
name|proto_str
argument_list|,
literal|"RRCP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rrcp
operator|->
name|rrcp_proto
operator|==
literal|2
condition|)
block|{
name|strcpy
argument_list|(
name|proto_str
argument_list|,
literal|"RRCP-REP"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|proto_str
argument_list|,
literal|"RRCP-0x%02d"
argument_list|,
name|rrcp
operator|->
name|rrcp_proto
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rrcp
operator|->
name|rrcp_opcode
operator|==
literal|0
condition|)
block|{
name|strcpy
argument_list|(
name|opcode_str
argument_list|,
literal|"hello"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rrcp
operator|->
name|rrcp_opcode
operator|==
literal|1
condition|)
block|{
name|strcpy
argument_list|(
name|opcode_str
argument_list|,
literal|"get"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rrcp
operator|->
name|rrcp_opcode
operator|==
literal|2
condition|)
block|{
name|strcpy
argument_list|(
name|opcode_str
argument_list|,
literal|"set"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|opcode_str
argument_list|,
literal|"unknown opcode (0x%02d)"
argument_list|,
name|rrcp
operator|->
name|rrcp_opcode
argument_list|)
expr_stmt|;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s> %s, %s %s"
operator|,
name|etheraddr_string
argument_list|(
name|ESRC
argument_list|(
name|ep
argument_list|)
argument_list|)
operator|,
name|etheraddr_string
argument_list|(
name|EDST
argument_list|(
name|ep
argument_list|)
argument_list|)
operator|,
name|proto_str
operator|,
name|rrcp
operator|->
name|rrcp_isreply
condition|?
literal|"reply"
else|:
literal|"query"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rrcp
operator|->
name|rrcp_proto
operator|==
literal|1
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": %s"
operator|,
name|opcode_str
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rrcp
operator|->
name|rrcp_opcode
operator|==
literal|1
operator|||
name|rrcp
operator|->
name|rrcp_opcode
operator|==
literal|2
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" addr=0x%04x, data=0x%04x"
operator|,
name|rrcp
operator|->
name|rrcp_reg_addr
operator|,
name|rrcp
operator|->
name|rrcp_reg_data
operator|,
name|rrcp
operator|->
name|rrcp_authkey
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rrcp
operator|->
name|rrcp_proto
operator|==
literal|1
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", auth=0x%04x"
operator|,
name|ntohs
argument_list|(
name|rrcp
operator|->
name|rrcp_authkey
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rrcp
operator|->
name|rrcp_proto
operator|==
literal|1
operator|&&
name|rrcp
operator|->
name|rrcp_opcode
operator|==
literal|0
operator|&&
name|rrcp
operator|->
name|rrcp_isreply
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" downlink_port=%d, uplink_port=%d, uplink_mac=%s, vendor_id=%08x ,chip_id=%04x "
operator|,
name|rrcp_hello
operator|->
name|rrcp_downlink_port
operator|,
name|rrcp_hello
operator|->
name|rrcp_uplink_port
operator|,
name|etheraddr_string
argument_list|(
name|rrcp_hello
operator|->
name|rrcp_uplink_mac
argument_list|)
operator|,
name|rrcp_hello
operator|->
name|rrcp_vendor_id
operator|,
name|rrcp_hello
operator|->
name|rrcp_chip_id
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rrcp
operator|->
name|rrcp_opcode
operator|==
literal|1
operator|||
name|rrcp
operator|->
name|rrcp_opcode
operator|==
literal|2
operator|||
name|rrcp
operator|->
name|rrcp_proto
operator|==
literal|2
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", cookie=0x%08x%08x "
operator|,
name|rrcp
operator|->
name|cookie2
operator|,
name|rrcp
operator|->
name|cookie1
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_vflag
condition|)
return|return;
block|}
end_function

end_unit


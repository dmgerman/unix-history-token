begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1993, 1994, 1995, 1996  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code distributions  * retain the above copyright notice and this paragraph in its entirety, (2)  * distributions including binary code include the above copyright notice and  * this paragraph in its entirety in the documentation or other materials  * provided with the distribution, and (3) all advertising materials mentioning  * features or use of this software display the following acknowledgement:  * ``This product includes software developed by the University of California,  * Lawrence Berkeley Laboratory and its contributors.'' Neither the name of  * the University nor the names of its contributors may be used to endorse  * or promote products derived from this software without specific prior  * written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-wb.c,v 1.26 2001/06/27 05:37:19 guy Exp $ (LBL)"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_comment
comment|/* XXX need to add byte-swapping macros! */
end_comment

begin_comment
comment|/*  * Largest packet size.  Everything should fit within this space.  * For instance, multiline objects are sent piecewise.  */
end_comment

begin_define
define|#
directive|define
name|MAXFRAMESIZE
value|1024
end_define

begin_comment
comment|/*  * Multiple drawing ops can be sent in one packet.  Each one starts on a  * an even multiple of DOP_ALIGN bytes, which must be a power of two.  */
end_comment

begin_define
define|#
directive|define
name|DOP_ALIGN
value|4
end_define

begin_define
define|#
directive|define
name|DOP_ROUNDUP
parameter_list|(
name|x
parameter_list|)
value|((((int)(x)) + (DOP_ALIGN - 1))& ~(DOP_ALIGN - 1))
end_define

begin_define
define|#
directive|define
name|DOP_NEXT
parameter_list|(
name|d
parameter_list|)
define|\
value|((struct dophdr *)((u_char *)(d) + \ 			  DOP_ROUNDUP(ntohs((d)->dh_len) + sizeof(*(d)))))
end_define

begin_comment
comment|/*  * Format of the whiteboard packet header.  * The transport level header.  */
end_comment

begin_struct
struct|struct
name|pkt_hdr
block|{
name|u_int32_t
name|ph_src
decl_stmt|;
comment|/* site id of source */
name|u_int32_t
name|ph_ts
decl_stmt|;
comment|/* time stamp (for skew computation) */
name|u_short
name|ph_version
decl_stmt|;
comment|/* version number */
name|u_char
name|ph_type
decl_stmt|;
comment|/* message type */
name|u_char
name|ph_flags
decl_stmt|;
comment|/* message flags */
block|}
struct|;
end_struct

begin_comment
comment|/* Packet types */
end_comment

begin_define
define|#
directive|define
name|PT_DRAWOP
value|0
end_define

begin_comment
comment|/* drawing operation */
end_comment

begin_define
define|#
directive|define
name|PT_ID
value|1
end_define

begin_comment
comment|/* announcement packet */
end_comment

begin_define
define|#
directive|define
name|PT_RREQ
value|2
end_define

begin_comment
comment|/* repair request */
end_comment

begin_define
define|#
directive|define
name|PT_RREP
value|3
end_define

begin_comment
comment|/* repair reply */
end_comment

begin_define
define|#
directive|define
name|PT_KILL
value|4
end_define

begin_comment
comment|/* terminate participation */
end_comment

begin_define
define|#
directive|define
name|PT_PREQ
value|5
end_define

begin_comment
comment|/* page vector request */
end_comment

begin_define
define|#
directive|define
name|PT_PREP
value|7
end_define

begin_comment
comment|/* page vector reply */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|PF_USER
end_ifdef

begin_undef
undef|#
directive|undef
name|PF_USER
end_undef

begin_comment
comment|/* {Digital,Tru64} UNIX define this, alas */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* flags */
end_comment

begin_define
define|#
directive|define
name|PF_USER
value|0x01
end_define

begin_comment
comment|/* hint that packet has interactive data */
end_comment

begin_define
define|#
directive|define
name|PF_VIS
value|0x02
end_define

begin_comment
comment|/* only visible ops wanted */
end_comment

begin_struct
struct|struct
name|PageID
block|{
name|u_int32_t
name|p_sid
decl_stmt|;
comment|/* session id of initiator */
name|u_int32_t
name|p_uid
decl_stmt|;
comment|/* page number */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|dophdr
block|{
name|u_int32_t
name|dh_ts
decl_stmt|;
comment|/* sender's timestamp */
name|u_short
name|dh_len
decl_stmt|;
comment|/* body length */
name|u_char
name|dh_flags
decl_stmt|;
name|u_char
name|dh_type
decl_stmt|;
comment|/* body type */
comment|/* body follows */
block|}
struct|;
end_struct

begin_comment
comment|/*  * Drawing op sub-types.  */
end_comment

begin_define
define|#
directive|define
name|DT_RECT
value|2
end_define

begin_define
define|#
directive|define
name|DT_LINE
value|3
end_define

begin_define
define|#
directive|define
name|DT_ML
value|4
end_define

begin_define
define|#
directive|define
name|DT_DEL
value|5
end_define

begin_define
define|#
directive|define
name|DT_XFORM
value|6
end_define

begin_define
define|#
directive|define
name|DT_ELL
value|7
end_define

begin_define
define|#
directive|define
name|DT_CHAR
value|8
end_define

begin_define
define|#
directive|define
name|DT_STR
value|9
end_define

begin_define
define|#
directive|define
name|DT_NOP
value|10
end_define

begin_define
define|#
directive|define
name|DT_PSCODE
value|11
end_define

begin_define
define|#
directive|define
name|DT_PSCOMP
value|12
end_define

begin_define
define|#
directive|define
name|DT_REF
value|13
end_define

begin_define
define|#
directive|define
name|DT_SKIP
value|14
end_define

begin_define
define|#
directive|define
name|DT_HOLE
value|15
end_define

begin_define
define|#
directive|define
name|DT_MAXTYPE
value|15
end_define

begin_comment
comment|/*  * A drawing operation.  */
end_comment

begin_struct
struct|struct
name|pkt_dop
block|{
name|struct
name|PageID
name|pd_page
decl_stmt|;
comment|/* page that operations apply to */
name|u_int32_t
name|pd_sseq
decl_stmt|;
comment|/* start sequence number */
name|u_int32_t
name|pd_eseq
decl_stmt|;
comment|/* end sequence number */
comment|/* drawing ops follow */
block|}
struct|;
end_struct

begin_comment
comment|/*  * A repair request.  */
end_comment

begin_struct
struct|struct
name|pkt_rreq
block|{
name|u_int32_t
name|pr_id
decl_stmt|;
comment|/* source id of drawops to be repaired */
name|struct
name|PageID
name|pr_page
decl_stmt|;
comment|/* page of drawops */
name|u_int32_t
name|pr_sseq
decl_stmt|;
comment|/* start seqno */
name|u_int32_t
name|pr_eseq
decl_stmt|;
comment|/* end seqno */
block|}
struct|;
end_struct

begin_comment
comment|/*  * A repair reply.  */
end_comment

begin_struct
struct|struct
name|pkt_rrep
block|{
name|u_int32_t
name|pr_id
decl_stmt|;
comment|/* original site id of ops  */
name|struct
name|pkt_dop
name|pr_dop
decl_stmt|;
comment|/* drawing ops follow */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|id_off
block|{
name|u_int32_t
name|id
decl_stmt|;
name|u_int32_t
name|off
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|pgstate
block|{
name|u_int32_t
name|slot
decl_stmt|;
name|struct
name|PageID
name|page
decl_stmt|;
name|u_short
name|nid
decl_stmt|;
name|u_short
name|rsvd
decl_stmt|;
comment|/* seqptr's */
block|}
struct|;
end_struct

begin_comment
comment|/*  * An announcement packet.  */
end_comment

begin_struct
struct|struct
name|pkt_id
block|{
name|u_int32_t
name|pi_mslot
decl_stmt|;
name|struct
name|PageID
name|pi_mpage
decl_stmt|;
comment|/* current page */
name|struct
name|pgstate
name|pi_ps
decl_stmt|;
comment|/* seqptr's */
comment|/* null-terminated site name */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|pkt_preq
block|{
name|struct
name|PageID
name|pp_page
decl_stmt|;
name|u_int32_t
name|pp_low
decl_stmt|;
name|u_int32_t
name|pp_high
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|pkt_prep
block|{
name|u_int32_t
name|pp_n
decl_stmt|;
comment|/* size of pageid array */
comment|/* pgstate's follow */
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|wb_id
parameter_list|(
specifier|const
name|struct
name|pkt_id
modifier|*
name|id
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
name|cp
decl_stmt|;
specifier|const
name|struct
name|id_off
modifier|*
name|io
decl_stmt|;
name|char
name|c
decl_stmt|;
name|int
name|nid
decl_stmt|;
name|printf
argument_list|(
literal|" wb-id:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|id
argument_list|)
operator|||
operator|(
name|u_char
operator|*
operator|)
operator|(
name|id
operator|+
literal|1
operator|)
operator|>
name|snapend
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|len
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %u/%s:%u (max %u/%s:%u) "
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|id
operator|->
name|pi_ps
operator|.
name|slot
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|id
operator|->
name|pi_ps
operator|.
name|page
operator|.
name|p_sid
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|id
operator|->
name|pi_ps
operator|.
name|page
operator|.
name|p_uid
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|id
operator|->
name|pi_mslot
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|id
operator|->
name|pi_mpage
operator|.
name|p_sid
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|id
operator|->
name|pi_mpage
operator|.
name|p_uid
argument_list|)
argument_list|)
expr_stmt|;
name|nid
operator|=
name|ntohs
argument_list|(
name|id
operator|->
name|pi_ps
operator|.
name|nid
argument_list|)
expr_stmt|;
name|len
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|io
argument_list|)
operator|*
name|nid
expr_stmt|;
name|io
operator|=
operator|(
expr|struct
name|id_off
operator|*
operator|)
operator|(
name|id
operator|+
literal|1
operator|)
expr_stmt|;
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|io
operator|+
name|nid
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|u_char
operator|*
operator|)
name|cp
operator|+
name|len
operator|<=
name|snapend
condition|)
block|{
name|putchar
argument_list|(
literal|'"'
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fn_print
argument_list|(
operator|(
name|u_char
operator|*
operator|)
name|cp
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|cp
operator|+
name|len
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'"'
argument_list|)
expr_stmt|;
block|}
name|c
operator|=
literal|'<'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nid
operator|&&
operator|(
name|u_char
operator|*
operator|)
name|io
operator|<
name|snapend
condition|;
operator|++
name|io
operator|,
operator|++
name|i
control|)
block|{
name|printf
argument_list|(
literal|"%c%s:%u"
argument_list|,
name|c
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|io
operator|->
name|id
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|io
operator|->
name|off
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|>=
name|nid
condition|)
block|{
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wb_rreq
parameter_list|(
specifier|const
name|struct
name|pkt_rreq
modifier|*
name|rreq
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|printf
argument_list|(
literal|" wb-rreq:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|rreq
argument_list|)
operator|||
operator|(
name|u_char
operator|*
operator|)
operator|(
name|rreq
operator|+
literal|1
operator|)
operator|>
name|snapend
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|printf
argument_list|(
literal|" please repair %s %s:%u<%u:%u>"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|rreq
operator|->
name|pr_id
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|rreq
operator|->
name|pr_page
operator|.
name|p_sid
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|rreq
operator|->
name|pr_page
operator|.
name|p_uid
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|rreq
operator|->
name|pr_sseq
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|rreq
operator|->
name|pr_eseq
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wb_preq
parameter_list|(
specifier|const
name|struct
name|pkt_preq
modifier|*
name|preq
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|printf
argument_list|(
literal|" wb-preq:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|preq
argument_list|)
operator|||
operator|(
name|u_char
operator|*
operator|)
operator|(
name|preq
operator|+
literal|1
operator|)
operator|>
name|snapend
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|printf
argument_list|(
literal|" need %u/%s:%u"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|preq
operator|->
name|pp_low
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|preq
operator|->
name|pp_page
operator|.
name|p_sid
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|preq
operator|->
name|pp_page
operator|.
name|p_uid
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wb_prep
parameter_list|(
specifier|const
name|struct
name|pkt_prep
modifier|*
name|prep
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
specifier|const
name|struct
name|pgstate
modifier|*
name|ps
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|ep
init|=
name|snapend
decl_stmt|;
name|printf
argument_list|(
literal|" wb-prep:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|prep
argument_list|)
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|n
operator|=
name|ntohl
argument_list|(
name|prep
operator|->
name|pp_n
argument_list|)
expr_stmt|;
name|ps
operator|=
operator|(
specifier|const
expr|struct
name|pgstate
operator|*
operator|)
operator|(
name|prep
operator|+
literal|1
operator|)
expr_stmt|;
while|while
condition|(
operator|--
name|n
operator|>=
literal|0
operator|&&
operator|(
name|u_char
operator|*
operator|)
name|ps
operator|<
name|ep
condition|)
block|{
specifier|const
name|struct
name|id_off
modifier|*
name|io
decl_stmt|,
modifier|*
name|ie
decl_stmt|;
name|char
name|c
init|=
literal|'<'
decl_stmt|;
name|printf
argument_list|(
literal|" %u/%s:%u"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|ps
operator|->
name|slot
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|ps
operator|->
name|page
operator|.
name|p_sid
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|ps
operator|->
name|page
operator|.
name|p_uid
argument_list|)
argument_list|)
expr_stmt|;
name|io
operator|=
operator|(
expr|struct
name|id_off
operator|*
operator|)
operator|(
name|ps
operator|+
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|ie
operator|=
name|io
operator|+
name|ps
operator|->
name|nid
init|;
name|io
operator|<
name|ie
operator|&&
operator|(
name|u_char
operator|*
operator|)
name|io
operator|<
name|ep
condition|;
operator|++
name|io
control|)
block|{
name|printf
argument_list|(
literal|"%c%s:%u"
argument_list|,
name|c
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|io
operator|->
name|id
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|io
operator|->
name|off
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
name|ps
operator|=
operator|(
expr|struct
name|pgstate
operator|*
operator|)
name|io
expr_stmt|;
block|}
return|return
operator|(
operator|(
name|u_char
operator|*
operator|)
name|ps
operator|<=
name|ep
condition|?
literal|0
else|:
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|char
modifier|*
name|dopstr
index|[]
init|=
block|{
literal|"dop-0!"
block|,
literal|"dop-1!"
block|,
literal|"RECT"
block|,
literal|"LINE"
block|,
literal|"ML"
block|,
literal|"DEL"
block|,
literal|"XFORM"
block|,
literal|"ELL"
block|,
literal|"CHAR"
block|,
literal|"STR"
block|,
literal|"NOP"
block|,
literal|"PSCODE"
block|,
literal|"PSCOMP"
block|,
literal|"REF"
block|,
literal|"SKIP"
block|,
literal|"HOLE"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|wb_dops
parameter_list|(
specifier|const
name|struct
name|dophdr
modifier|*
name|dh
parameter_list|,
name|u_int32_t
name|ss
parameter_list|,
name|u_int32_t
name|es
parameter_list|)
block|{
name|printf
argument_list|(
literal|"<"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|ss
operator|<=
name|es
condition|;
operator|++
name|ss
control|)
block|{
specifier|register
name|int
name|t
init|=
name|dh
operator|->
name|dh_type
decl_stmt|;
if|if
condition|(
name|t
operator|>
name|DT_MAXTYPE
condition|)
name|printf
argument_list|(
literal|" dop-%d!"
argument_list|,
name|t
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|dopstr
index|[
name|t
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|DT_SKIP
operator|||
name|t
operator|==
name|DT_HOLE
condition|)
block|{
name|int
name|ts
init|=
name|ntohl
argument_list|(
name|dh
operator|->
name|dh_ts
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"%d"
argument_list|,
name|ts
operator|-
name|ss
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss
operator|>
name|ts
operator|||
name|ts
operator|>
name|es
condition|)
block|{
name|printf
argument_list|(
literal|"[|]"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ts
operator|<
name|ss
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|ss
operator|=
name|ts
expr_stmt|;
block|}
block|}
name|dh
operator|=
name|DOP_NEXT
argument_list|(
name|dh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|u_char
operator|*
operator|)
name|dh
operator|>
name|snapend
condition|)
block|{
name|printf
argument_list|(
literal|"[|wb]"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wb_rrep
parameter_list|(
specifier|const
name|struct
name|pkt_rrep
modifier|*
name|rrep
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|pkt_dop
modifier|*
name|dop
init|=
operator|&
name|rrep
operator|->
name|pr_dop
decl_stmt|;
name|printf
argument_list|(
literal|" wb-rrep:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|rrep
argument_list|)
operator|||
operator|(
name|u_char
operator|*
operator|)
operator|(
name|rrep
operator|+
literal|1
operator|)
operator|>
name|snapend
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|len
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|rrep
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" for %s %s:%u<%u:%u>"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|rrep
operator|->
name|pr_id
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|dop
operator|->
name|pd_page
operator|.
name|p_sid
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|dop
operator|->
name|pd_page
operator|.
name|p_uid
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|dop
operator|->
name|pd_sseq
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|dop
operator|->
name|pd_eseq
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
return|return
operator|(
name|wb_dops
argument_list|(
operator|(
specifier|const
expr|struct
name|dophdr
operator|*
operator|)
operator|(
name|dop
operator|+
literal|1
operator|)
argument_list|,
name|ntohl
argument_list|(
name|dop
operator|->
name|pd_sseq
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|dop
operator|->
name|pd_eseq
argument_list|)
argument_list|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wb_drawop
parameter_list|(
specifier|const
name|struct
name|pkt_dop
modifier|*
name|dop
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|printf
argument_list|(
literal|" wb-dop:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|dop
argument_list|)
operator|||
operator|(
name|u_char
operator|*
operator|)
operator|(
name|dop
operator|+
literal|1
operator|)
operator|>
name|snapend
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|len
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|dop
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s:%u<%u:%u>"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|dop
operator|->
name|pd_page
operator|.
name|p_sid
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|dop
operator|->
name|pd_page
operator|.
name|p_uid
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|dop
operator|->
name|pd_sseq
argument_list|)
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
name|dop
operator|->
name|pd_eseq
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
return|return
operator|(
name|wb_dops
argument_list|(
operator|(
specifier|const
expr|struct
name|dophdr
operator|*
operator|)
operator|(
name|dop
operator|+
literal|1
operator|)
argument_list|,
name|ntohl
argument_list|(
name|dop
operator|->
name|pd_sseq
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|dop
operator|->
name|pd_eseq
argument_list|)
argument_list|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Print whiteboard multicast packets.  */
end_comment

begin_function
name|void
name|wb_print
parameter_list|(
specifier|register
specifier|const
name|void
modifier|*
name|hdr
parameter_list|,
specifier|register
name|u_int
name|len
parameter_list|)
block|{
specifier|register
specifier|const
name|struct
name|pkt_hdr
modifier|*
name|ph
decl_stmt|;
name|ph
operator|=
operator|(
specifier|const
expr|struct
name|pkt_hdr
operator|*
operator|)
name|hdr
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|ph
argument_list|)
operator|||
operator|(
name|u_char
operator|*
operator|)
operator|(
name|ph
operator|+
literal|1
operator|)
operator|>
name|snapend
condition|)
block|{
name|printf
argument_list|(
literal|"[|wb]"
argument_list|)
expr_stmt|;
return|return;
block|}
name|len
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|ph
argument_list|)
expr_stmt|;
if|if
condition|(
name|ph
operator|->
name|ph_flags
condition|)
name|printf
argument_list|(
literal|"*"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ph
operator|->
name|ph_type
condition|)
block|{
case|case
name|PT_KILL
case|:
name|printf
argument_list|(
literal|" wb-kill"
argument_list|)
expr_stmt|;
return|return;
case|case
name|PT_ID
case|:
if|if
condition|(
name|wb_id
argument_list|(
operator|(
expr|struct
name|pkt_id
operator|*
operator|)
operator|(
name|ph
operator|+
literal|1
operator|)
argument_list|,
name|len
argument_list|)
operator|>=
literal|0
condition|)
return|return;
break|break;
case|case
name|PT_RREQ
case|:
if|if
condition|(
name|wb_rreq
argument_list|(
operator|(
expr|struct
name|pkt_rreq
operator|*
operator|)
operator|(
name|ph
operator|+
literal|1
operator|)
argument_list|,
name|len
argument_list|)
operator|>=
literal|0
condition|)
return|return;
break|break;
case|case
name|PT_RREP
case|:
if|if
condition|(
name|wb_rrep
argument_list|(
operator|(
expr|struct
name|pkt_rrep
operator|*
operator|)
operator|(
name|ph
operator|+
literal|1
operator|)
argument_list|,
name|len
argument_list|)
operator|>=
literal|0
condition|)
return|return;
break|break;
case|case
name|PT_DRAWOP
case|:
if|if
condition|(
name|wb_drawop
argument_list|(
operator|(
expr|struct
name|pkt_dop
operator|*
operator|)
operator|(
name|ph
operator|+
literal|1
operator|)
argument_list|,
name|len
argument_list|)
operator|>=
literal|0
condition|)
return|return;
break|break;
case|case
name|PT_PREQ
case|:
if|if
condition|(
name|wb_preq
argument_list|(
operator|(
expr|struct
name|pkt_preq
operator|*
operator|)
operator|(
name|ph
operator|+
literal|1
operator|)
argument_list|,
name|len
argument_list|)
operator|>=
literal|0
condition|)
return|return;
break|break;
case|case
name|PT_PREP
case|:
if|if
condition|(
name|wb_prep
argument_list|(
operator|(
expr|struct
name|pkt_prep
operator|*
operator|)
operator|(
name|ph
operator|+
literal|1
operator|)
argument_list|,
name|len
argument_list|)
operator|>=
literal|0
condition|)
return|return;
break|break;
default|default:
name|printf
argument_list|(
literal|" wb-%d!"
argument_list|,
name|ph
operator|->
name|ph_type
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

end_unit


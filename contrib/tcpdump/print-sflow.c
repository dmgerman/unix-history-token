begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1998-2007 The TCPDUMP project  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code  * distributions retain the above copyright notice and this paragraph  * in its entirety, and (2) distributions including binary code include  * the above copyright notice and this paragraph in its entirety in  * the documentation or other materials provided with the distribution.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND  * WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, WITHOUT  * LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE.  *  * The SFLOW protocol as per http://www.sflow.org/developers/specifications.php  *  * Original code by Carles Kishimoto<carles.kishimoto@gmail.com>  *  * Expansion and refactoring by Rick Jones<rick.jones2@hp.com>  */
end_comment

begin_define
define|#
directive|define
name|NETDISSECT_REWORKED
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_comment
comment|/*  * sFlow datagram  *  * 0                   1                   2                   3  * 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                     Sflow version (2,4,5)                     |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |               IP version (1 for IPv4 | 2 for IPv6)            |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                     IP Address AGENT (4 or 16 bytes)          |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                          Sub agent ID                         |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                      Datagram sequence number                 |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                      Switch uptime in ms                      |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |                    num samples in datagram                    |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  *  */
end_comment

begin_struct
struct|struct
name|sflow_datagram_t
block|{
name|uint8_t
name|version
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ip_version
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|agent
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|agent_id
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|seqnum
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|uptime
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|samples
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sflow_sample_header
block|{
name|uint8_t
name|format
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|len
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|SFLOW_FLOW_SAMPLE
value|1
end_define

begin_define
define|#
directive|define
name|SFLOW_COUNTER_SAMPLE
value|2
end_define

begin_define
define|#
directive|define
name|SFLOW_EXPANDED_FLOW_SAMPLE
value|3
end_define

begin_define
define|#
directive|define
name|SFLOW_EXPANDED_COUNTER_SAMPLE
value|4
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|sflow_format_values
index|[]
init|=
block|{
block|{
name|SFLOW_FLOW_SAMPLE
block|,
literal|"flow sample"
block|}
block|,
block|{
name|SFLOW_COUNTER_SAMPLE
block|,
literal|"counter sample"
block|}
block|,
block|{
name|SFLOW_EXPANDED_FLOW_SAMPLE
block|,
literal|"expanded flow sample"
block|}
block|,
block|{
name|SFLOW_EXPANDED_COUNTER_SAMPLE
block|,
literal|"expanded counter sample"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|sflow_flow_sample_t
block|{
name|uint8_t
name|seqnum
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|typesource
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|rate
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|pool
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|drops
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|in_interface
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|out_interface
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|records
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sflow_expanded_flow_sample_t
block|{
name|uint8_t
name|seqnum
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|type
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|index
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|rate
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|pool
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|drops
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|in_interface_format
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|in_interface_value
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|out_interface_format
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|out_interface_value
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|records
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|SFLOW_FLOW_RAW_PACKET
value|1
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_ETHERNET_FRAME
value|2
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_IPV4_DATA
value|3
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_IPV6_DATA
value|4
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_EXTENDED_SWITCH_DATA
value|1001
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_EXTENDED_ROUTER_DATA
value|1002
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_EXTENDED_GATEWAY_DATA
value|1003
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_EXTENDED_USER_DATA
value|1004
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_EXTENDED_URL_DATA
value|1005
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_EXTENDED_MPLS_DATA
value|1006
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_EXTENDED_NAT_DATA
value|1007
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_EXTENDED_MPLS_TUNNEL
value|1008
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_EXTENDED_MPLS_VC
value|1009
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_EXTENDED_MPLS_FEC
value|1010
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_EXTENDED_MPLS_LVP_FEC
value|1011
end_define

begin_define
define|#
directive|define
name|SFLOW_FLOW_EXTENDED_VLAN_TUNNEL
value|1012
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|sflow_flow_type_values
index|[]
init|=
block|{
block|{
name|SFLOW_FLOW_RAW_PACKET
block|,
literal|"Raw packet"
block|}
block|,
block|{
name|SFLOW_FLOW_ETHERNET_FRAME
block|,
literal|"Ethernet frame"
block|}
block|,
block|{
name|SFLOW_FLOW_IPV4_DATA
block|,
literal|"IPv4 Data"
block|}
block|,
block|{
name|SFLOW_FLOW_IPV6_DATA
block|,
literal|"IPv6 Data"
block|}
block|,
block|{
name|SFLOW_FLOW_EXTENDED_SWITCH_DATA
block|,
literal|"Extended Switch data"
block|}
block|,
block|{
name|SFLOW_FLOW_EXTENDED_ROUTER_DATA
block|,
literal|"Extended Router data"
block|}
block|,
block|{
name|SFLOW_FLOW_EXTENDED_GATEWAY_DATA
block|,
literal|"Extended Gateway data"
block|}
block|,
block|{
name|SFLOW_FLOW_EXTENDED_USER_DATA
block|,
literal|"Extended User data"
block|}
block|,
block|{
name|SFLOW_FLOW_EXTENDED_URL_DATA
block|,
literal|"Extended URL data"
block|}
block|,
block|{
name|SFLOW_FLOW_EXTENDED_MPLS_DATA
block|,
literal|"Extended MPLS data"
block|}
block|,
block|{
name|SFLOW_FLOW_EXTENDED_NAT_DATA
block|,
literal|"Extended NAT data"
block|}
block|,
block|{
name|SFLOW_FLOW_EXTENDED_MPLS_TUNNEL
block|,
literal|"Extended MPLS tunnel"
block|}
block|,
block|{
name|SFLOW_FLOW_EXTENDED_MPLS_VC
block|,
literal|"Extended MPLS VC"
block|}
block|,
block|{
name|SFLOW_FLOW_EXTENDED_MPLS_FEC
block|,
literal|"Extended MPLS FEC"
block|}
block|,
block|{
name|SFLOW_FLOW_EXTENDED_MPLS_LVP_FEC
block|,
literal|"Extended MPLS LVP FEC"
block|}
block|,
block|{
name|SFLOW_FLOW_EXTENDED_VLAN_TUNNEL
block|,
literal|"Extended VLAN Tunnel"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SFLOW_HEADER_PROTOCOL_ETHERNET
value|1
end_define

begin_define
define|#
directive|define
name|SFLOW_HEADER_PROTOCOL_IPV4
value|11
end_define

begin_define
define|#
directive|define
name|SFLOW_HEADER_PROTOCOL_IPV6
value|12
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|sflow_flow_raw_protocol_values
index|[]
init|=
block|{
block|{
name|SFLOW_HEADER_PROTOCOL_ETHERNET
block|,
literal|"Ethernet"
block|}
block|,
block|{
name|SFLOW_HEADER_PROTOCOL_IPV4
block|,
literal|"IPv4"
block|}
block|,
block|{
name|SFLOW_HEADER_PROTOCOL_IPV6
block|,
literal|"IPv6"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|sflow_expanded_flow_raw_t
block|{
name|uint8_t
name|protocol
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|length
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|stripped_bytes
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|header_size
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sflow_ethernet_frame_t
block|{
name|uint8_t
name|length
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|src_mac
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|dst_mac
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|type
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sflow_extended_switch_data_t
block|{
name|uint8_t
name|src_vlan
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|src_pri
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|dst_vlan
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|dst_pri
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sflow_counter_record_t
block|{
name|uint8_t
name|format
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|length
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sflow_flow_record_t
block|{
name|uint8_t
name|format
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|length
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sflow_counter_sample_t
block|{
name|uint8_t
name|seqnum
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|typesource
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|records
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sflow_expanded_counter_sample_t
block|{
name|uint8_t
name|seqnum
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|type
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|index
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|records
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|SFLOW_COUNTER_GENERIC
value|1
end_define

begin_define
define|#
directive|define
name|SFLOW_COUNTER_ETHERNET
value|2
end_define

begin_define
define|#
directive|define
name|SFLOW_COUNTER_TOKEN_RING
value|3
end_define

begin_define
define|#
directive|define
name|SFLOW_COUNTER_BASEVG
value|4
end_define

begin_define
define|#
directive|define
name|SFLOW_COUNTER_VLAN
value|5
end_define

begin_define
define|#
directive|define
name|SFLOW_COUNTER_PROCESSOR
value|1001
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|sflow_counter_type_values
index|[]
init|=
block|{
block|{
name|SFLOW_COUNTER_GENERIC
block|,
literal|"Generic counter"
block|}
block|,
block|{
name|SFLOW_COUNTER_ETHERNET
block|,
literal|"Ethernet counter"
block|}
block|,
block|{
name|SFLOW_COUNTER_TOKEN_RING
block|,
literal|"Token ring counter"
block|}
block|,
block|{
name|SFLOW_COUNTER_BASEVG
block|,
literal|"100 BaseVG counter"
block|}
block|,
block|{
name|SFLOW_COUNTER_VLAN
block|,
literal|"Vlan counter"
block|}
block|,
block|{
name|SFLOW_COUNTER_PROCESSOR
block|,
literal|"Processor counter"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SFLOW_IFACE_DIRECTION_UNKNOWN
value|0
end_define

begin_define
define|#
directive|define
name|SFLOW_IFACE_DIRECTION_FULLDUPLEX
value|1
end_define

begin_define
define|#
directive|define
name|SFLOW_IFACE_DIRECTION_HALFDUPLEX
value|2
end_define

begin_define
define|#
directive|define
name|SFLOW_IFACE_DIRECTION_IN
value|3
end_define

begin_define
define|#
directive|define
name|SFLOW_IFACE_DIRECTION_OUT
value|4
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|sflow_iface_direction_values
index|[]
init|=
block|{
block|{
name|SFLOW_IFACE_DIRECTION_UNKNOWN
block|,
literal|"unknown"
block|}
block|,
block|{
name|SFLOW_IFACE_DIRECTION_FULLDUPLEX
block|,
literal|"full-duplex"
block|}
block|,
block|{
name|SFLOW_IFACE_DIRECTION_HALFDUPLEX
block|,
literal|"half-duplex"
block|}
block|,
block|{
name|SFLOW_IFACE_DIRECTION_IN
block|,
literal|"in"
block|}
block|,
block|{
name|SFLOW_IFACE_DIRECTION_OUT
block|,
literal|"out"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|sflow_generic_counter_t
block|{
name|uint8_t
name|ifindex
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|iftype
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifspeed
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|ifdirection
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifstatus
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifinoctets
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|ifinunicastpkts
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifinmulticastpkts
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifinbroadcastpkts
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifindiscards
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifinerrors
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifinunkownprotos
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifoutoctets
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|ifoutunicastpkts
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifoutmulticastpkts
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifoutbroadcastpkts
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifoutdiscards
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifouterrors
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|ifpromiscmode
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sflow_ethernet_counter_t
block|{
name|uint8_t
name|alignerrors
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|fcserrors
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|single_collision_frames
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|multiple_collision_frames
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|test_errors
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|deferred_transmissions
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|late_collisions
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|excessive_collisions
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|mac_transmit_errors
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|carrier_sense_errors
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|frame_too_longs
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|mac_receive_errors
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|symbol_errors
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sflow_100basevg_counter_t
block|{
name|uint8_t
name|in_highpriority_frames
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|in_highpriority_octets
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|in_normpriority_frames
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|in_normpriority_octets
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|in_ipmerrors
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|in_oversized
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|in_data_errors
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|in_null_addressed_frames
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|out_highpriority_frames
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|out_highpriority_octets
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|transitioninto_frames
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|hc_in_highpriority_octets
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|hc_in_normpriority_octets
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|hc_out_highpriority_octets
index|[
literal|8
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sflow_vlan_counter_t
block|{
name|uint8_t
name|vlan_id
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|octets
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|unicast_pkt
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|multicast_pkt
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|broadcast_pkt
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|discards
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|print_sflow_counter_generic
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sflow_generic_counter_t
modifier|*
name|sflow_gen_counter
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_generic_counter_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_gen_counter
operator|=
operator|(
specifier|const
expr|struct
name|sflow_generic_counter_t
operator|*
operator|)
name|pointer
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      ifindex %u, iftype %u, ifspeed %"
name|PRIu64
literal|", ifdirection %u (%s)"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifindex
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|iftype
argument_list|)
operator|,
name|EXTRACT_64BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifspeed
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifdirection
argument_list|)
operator|,
name|tok2str
argument_list|(
name|sflow_iface_direction_values
argument_list|,
literal|"Unknown"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifdirection
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      ifstatus %u, adminstatus: %s, operstatus: %s"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifstatus
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifstatus
argument_list|)
operator|&
literal|1
condition|?
literal|"up"
else|:
literal|"down"
operator|,
operator|(
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifstatus
argument_list|)
operator|>>
literal|1
operator|)
operator|&
literal|1
condition|?
literal|"up"
else|:
literal|"down"
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      In octets %"
name|PRIu64
literal|", unicast pkts %u, multicast pkts %u, broadcast pkts %u, discards %u"
operator|,
name|EXTRACT_64BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifinoctets
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifinunicastpkts
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifinmulticastpkts
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifinbroadcastpkts
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifindiscards
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      In errors %u, unknown protos %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifinerrors
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifinunkownprotos
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      Out octets %"
name|PRIu64
literal|", unicast pkts %u, multicast pkts %u, broadcast pkts %u, discards %u"
operator|,
name|EXTRACT_64BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifoutoctets
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifoutunicastpkts
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifoutmulticastpkts
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifoutbroadcastpkts
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifoutdiscards
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      Out errors %u, promisc mode %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifouterrors
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_gen_counter
operator|->
name|ifpromiscmode
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_sflow_counter_ethernet
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sflow_ethernet_counter_t
modifier|*
name|sflow_eth_counter
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_ethernet_counter_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_eth_counter
operator|=
operator|(
specifier|const
expr|struct
name|sflow_ethernet_counter_t
operator|*
operator|)
name|pointer
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      align errors %u, fcs errors %u, single collision %u, multiple collision %u, test error %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_eth_counter
operator|->
name|alignerrors
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_eth_counter
operator|->
name|fcserrors
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_eth_counter
operator|->
name|single_collision_frames
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_eth_counter
operator|->
name|multiple_collision_frames
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_eth_counter
operator|->
name|test_errors
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      deferred %u, late collision %u, excessive collision %u, mac trans error %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_eth_counter
operator|->
name|deferred_transmissions
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_eth_counter
operator|->
name|late_collisions
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_eth_counter
operator|->
name|excessive_collisions
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_eth_counter
operator|->
name|mac_transmit_errors
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      carrier error %u, frames too long %u, mac receive errors %u, symbol errors %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_eth_counter
operator|->
name|carrier_sense_errors
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_eth_counter
operator|->
name|frame_too_longs
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_eth_counter
operator|->
name|mac_receive_errors
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_eth_counter
operator|->
name|symbol_errors
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_sflow_counter_token_ring
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
name|_U_
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
name|_U_
parameter_list|,
name|u_int
name|len
name|_U_
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_sflow_counter_basevg
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sflow_100basevg_counter_t
modifier|*
name|sflow_100basevg_counter
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_100basevg_counter_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_100basevg_counter
operator|=
operator|(
specifier|const
expr|struct
name|sflow_100basevg_counter_t
operator|*
operator|)
name|pointer
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      in high prio frames %u, in high prio octets %"
name|PRIu64
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|in_highpriority_frames
argument_list|)
operator|,
name|EXTRACT_64BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|in_highpriority_octets
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      in norm prio frames %u, in norm prio octets %"
name|PRIu64
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|in_normpriority_frames
argument_list|)
operator|,
name|EXTRACT_64BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|in_normpriority_octets
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      in ipm errors %u, oversized %u, in data errors %u, null addressed frames %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|in_ipmerrors
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|in_oversized
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|in_data_errors
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|in_null_addressed_frames
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      out high prio frames %u, out high prio octets %"
name|PRIu64
literal|", trans into frames %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|out_highpriority_frames
argument_list|)
operator|,
name|EXTRACT_64BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|out_highpriority_octets
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|transitioninto_frames
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      in hc high prio octets %"
name|PRIu64
literal|", in hc norm prio octets %"
name|PRIu64
literal|", out hc high prio octets %"
name|PRIu64
operator|,
name|EXTRACT_64BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|hc_in_highpriority_octets
argument_list|)
operator|,
name|EXTRACT_64BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|hc_in_normpriority_octets
argument_list|)
operator|,
name|EXTRACT_64BITS
argument_list|(
name|sflow_100basevg_counter
operator|->
name|hc_out_highpriority_octets
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_sflow_counter_vlan
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sflow_vlan_counter_t
modifier|*
name|sflow_vlan_counter
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_vlan_counter_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_vlan_counter
operator|=
operator|(
specifier|const
expr|struct
name|sflow_vlan_counter_t
operator|*
operator|)
name|pointer
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      vlan_id %u, octets %"
name|PRIu64
literal|", unicast_pkt %u, multicast_pkt %u, broadcast_pkt %u, discards %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_vlan_counter
operator|->
name|vlan_id
argument_list|)
operator|,
name|EXTRACT_64BITS
argument_list|(
name|sflow_vlan_counter
operator|->
name|octets
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_vlan_counter
operator|->
name|unicast_pkt
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_vlan_counter
operator|->
name|multicast_pkt
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_vlan_counter
operator|->
name|broadcast_pkt
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_vlan_counter
operator|->
name|discards
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
name|sflow_processor_counter_t
block|{
name|uint8_t
name|five_sec_util
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|one_min_util
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|five_min_util
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|total_memory
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
name|free_memory
index|[
literal|8
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|print_sflow_counter_processor
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sflow_processor_counter_t
modifier|*
name|sflow_processor_counter
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_processor_counter_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_processor_counter
operator|=
operator|(
specifier|const
expr|struct
name|sflow_processor_counter_t
operator|*
operator|)
name|pointer
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      5sec %u, 1min %u, 5min %u, total_mem %"
name|PRIu64
literal|", total_mem %"
name|PRIu64
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_processor_counter
operator|->
name|five_sec_util
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_processor_counter
operator|->
name|one_min_util
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_processor_counter
operator|->
name|five_min_util
argument_list|)
operator|,
name|EXTRACT_64BITS
argument_list|(
name|sflow_processor_counter
operator|->
name|total_memory
argument_list|)
operator|,
name|EXTRACT_64BITS
argument_list|(
name|sflow_processor_counter
operator|->
name|free_memory
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sflow_print_counter_records
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|,
name|u_int
name|records
parameter_list|)
block|{
name|u_int
name|nrecords
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|tptr
decl_stmt|;
name|u_int
name|tlen
decl_stmt|;
name|u_int
name|counter_type
decl_stmt|;
name|u_int
name|counter_len
decl_stmt|;
name|u_int
name|enterprise
decl_stmt|;
specifier|const
name|struct
name|sflow_counter_record_t
modifier|*
name|sflow_counter_record
decl_stmt|;
name|nrecords
operator|=
name|records
expr_stmt|;
name|tptr
operator|=
name|pointer
expr_stmt|;
name|tlen
operator|=
name|len
expr_stmt|;
while|while
condition|(
name|nrecords
operator|>
literal|0
condition|)
block|{
comment|/* do we have the "header?" */
if|if
condition|(
name|tlen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_counter_record_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_counter_record
operator|=
operator|(
specifier|const
expr|struct
name|sflow_counter_record_t
operator|*
operator|)
name|tptr
expr_stmt|;
name|enterprise
operator|=
name|EXTRACT_32BITS
argument_list|(
name|sflow_counter_record
operator|->
name|format
argument_list|)
expr_stmt|;
name|counter_type
operator|=
name|enterprise
operator|&
literal|0x0FFF
expr_stmt|;
name|enterprise
operator|=
name|enterprise
operator|>>
literal|20
expr_stmt|;
name|counter_len
operator|=
name|EXTRACT_32BITS
argument_list|(
name|sflow_counter_record
operator|->
name|length
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    enterprise %u, %s (%u) length %u"
operator|,
name|enterprise
operator|,
operator|(
name|enterprise
operator|==
literal|0
operator|)
condition|?
name|tok2str
argument_list|(
name|sflow_counter_type_values
argument_list|,
literal|"Unknown"
argument_list|,
name|counter_type
argument_list|)
else|:
literal|"Unknown"
operator|,
name|counter_type
operator|,
name|counter_len
operator|)
argument_list|)
expr_stmt|;
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_counter_record_t
argument_list|)
expr_stmt|;
name|tlen
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_counter_record_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlen
operator|<
name|counter_len
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|enterprise
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|counter_type
condition|)
block|{
case|case
name|SFLOW_COUNTER_GENERIC
case|:
if|if
condition|(
name|print_sflow_counter_generic
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|tlen
argument_list|)
condition|)
return|return
literal|1
return|;
break|break;
case|case
name|SFLOW_COUNTER_ETHERNET
case|:
if|if
condition|(
name|print_sflow_counter_ethernet
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|tlen
argument_list|)
condition|)
return|return
literal|1
return|;
break|break;
case|case
name|SFLOW_COUNTER_TOKEN_RING
case|:
if|if
condition|(
name|print_sflow_counter_token_ring
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|tlen
argument_list|)
condition|)
return|return
literal|1
return|;
break|break;
case|case
name|SFLOW_COUNTER_BASEVG
case|:
if|if
condition|(
name|print_sflow_counter_basevg
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|tlen
argument_list|)
condition|)
return|return
literal|1
return|;
break|break;
case|case
name|SFLOW_COUNTER_VLAN
case|:
if|if
condition|(
name|print_sflow_counter_vlan
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|tlen
argument_list|)
condition|)
return|return
literal|1
return|;
break|break;
case|case
name|SFLOW_COUNTER_PROCESSOR
case|:
if|if
condition|(
name|print_sflow_counter_processor
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|tlen
argument_list|)
condition|)
return|return
literal|1
return|;
break|break;
default|default:
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
literal|"\n\t\t"
argument_list|,
name|counter_len
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|tptr
operator|+=
name|counter_len
expr_stmt|;
name|tlen
operator|-=
name|counter_len
expr_stmt|;
name|nrecords
operator|--
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sflow_print_counter_sample
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sflow_counter_sample_t
modifier|*
name|sflow_counter_sample
decl_stmt|;
name|u_int
name|nrecords
decl_stmt|;
name|u_int
name|typesource
decl_stmt|;
name|u_int
name|type
decl_stmt|;
name|u_int
name|index
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_counter_sample_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_counter_sample
operator|=
operator|(
specifier|const
expr|struct
name|sflow_counter_sample_t
operator|*
operator|)
name|pointer
expr_stmt|;
name|typesource
operator|=
name|EXTRACT_32BITS
argument_list|(
name|sflow_counter_sample
operator|->
name|typesource
argument_list|)
expr_stmt|;
name|nrecords
operator|=
name|EXTRACT_32BITS
argument_list|(
name|sflow_counter_sample
operator|->
name|records
argument_list|)
expr_stmt|;
name|type
operator|=
name|typesource
operator|>>
literal|24
expr_stmt|;
name|index
operator|=
name|typesource
operator|&
literal|0x0FFF
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" seqnum %u, type %u, idx %u, records %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_counter_sample
operator|->
name|seqnum
argument_list|)
operator|,
name|type
operator|,
name|index
operator|,
name|nrecords
operator|)
argument_list|)
expr_stmt|;
return|return
name|sflow_print_counter_records
argument_list|(
name|ndo
argument_list|,
name|pointer
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_counter_sample_t
argument_list|)
argument_list|,
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_counter_sample_t
argument_list|)
argument_list|,
name|nrecords
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sflow_print_expanded_counter_sample
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sflow_expanded_counter_sample_t
modifier|*
name|sflow_expanded_counter_sample
decl_stmt|;
name|u_int
name|nrecords
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_expanded_counter_sample_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_expanded_counter_sample
operator|=
operator|(
specifier|const
expr|struct
name|sflow_expanded_counter_sample_t
operator|*
operator|)
name|pointer
expr_stmt|;
name|nrecords
operator|=
name|EXTRACT_32BITS
argument_list|(
name|sflow_expanded_counter_sample
operator|->
name|records
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" seqnum %u, type %u, idx %u, records %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_expanded_counter_sample
operator|->
name|seqnum
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_expanded_counter_sample
operator|->
name|type
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_expanded_counter_sample
operator|->
name|index
argument_list|)
operator|,
name|nrecords
operator|)
argument_list|)
expr_stmt|;
return|return
name|sflow_print_counter_records
argument_list|(
name|ndo
argument_list|,
name|pointer
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_expanded_counter_sample_t
argument_list|)
argument_list|,
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_expanded_counter_sample_t
argument_list|)
argument_list|,
name|nrecords
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_sflow_raw_packet
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sflow_expanded_flow_raw_t
modifier|*
name|sflow_flow_raw
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_expanded_flow_raw_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_flow_raw
operator|=
operator|(
specifier|const
expr|struct
name|sflow_expanded_flow_raw_t
operator|*
operator|)
name|pointer
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      protocol %s (%u), length %u, stripped bytes %u, header_size %u"
operator|,
name|tok2str
argument_list|(
name|sflow_flow_raw_protocol_values
argument_list|,
literal|"Unknown"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_raw
operator|->
name|protocol
argument_list|)
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_raw
operator|->
name|protocol
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_raw
operator|->
name|length
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_raw
operator|->
name|stripped_bytes
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_raw
operator|->
name|header_size
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* QUESTION - should we attempt to print the raw header itself?        assuming of course there is wnough data present to do so... */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_sflow_ethernet_frame
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sflow_ethernet_frame_t
modifier|*
name|sflow_ethernet_frame
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_ethernet_frame_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_ethernet_frame
operator|=
operator|(
specifier|const
expr|struct
name|sflow_ethernet_frame_t
operator|*
operator|)
name|pointer
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      frame len %u, type %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_ethernet_frame
operator|->
name|length
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_ethernet_frame
operator|->
name|type
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_sflow_extended_switch_data
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sflow_extended_switch_data_t
modifier|*
name|sflow_extended_sw_data
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_extended_switch_data_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_extended_sw_data
operator|=
operator|(
specifier|const
expr|struct
name|sflow_extended_switch_data_t
operator|*
operator|)
name|pointer
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      src vlan %u, src pri %u, dst vlan %u, dst pri %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_extended_sw_data
operator|->
name|src_vlan
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_extended_sw_data
operator|->
name|src_pri
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_extended_sw_data
operator|->
name|dst_vlan
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_extended_sw_data
operator|->
name|dst_pri
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sflow_print_flow_records
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|,
name|u_int
name|records
parameter_list|)
block|{
name|u_int
name|nrecords
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|tptr
decl_stmt|;
name|u_int
name|tlen
decl_stmt|;
name|u_int
name|flow_type
decl_stmt|;
name|u_int
name|enterprise
decl_stmt|;
name|u_int
name|flow_len
decl_stmt|;
specifier|const
name|struct
name|sflow_flow_record_t
modifier|*
name|sflow_flow_record
decl_stmt|;
name|nrecords
operator|=
name|records
expr_stmt|;
name|tptr
operator|=
name|pointer
expr_stmt|;
name|tlen
operator|=
name|len
expr_stmt|;
while|while
condition|(
name|nrecords
operator|>
literal|0
condition|)
block|{
comment|/* do we have the "header?" */
if|if
condition|(
name|tlen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_flow_record_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_flow_record
operator|=
operator|(
specifier|const
expr|struct
name|sflow_flow_record_t
operator|*
operator|)
name|tptr
expr_stmt|;
comment|/* so, the funky encoding means we cannot blythly mask-off 	   bits, we must also check the enterprise. */
name|enterprise
operator|=
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_record
operator|->
name|format
argument_list|)
expr_stmt|;
name|flow_type
operator|=
name|enterprise
operator|&
literal|0x0FFF
expr_stmt|;
name|enterprise
operator|=
name|enterprise
operator|>>
literal|12
expr_stmt|;
name|flow_len
operator|=
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_record
operator|->
name|length
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    enterprise %u %s (%u) length %u"
operator|,
name|enterprise
operator|,
operator|(
name|enterprise
operator|==
literal|0
operator|)
condition|?
name|tok2str
argument_list|(
name|sflow_flow_type_values
argument_list|,
literal|"Unknown"
argument_list|,
name|flow_type
argument_list|)
else|:
literal|"Unknown"
operator|,
name|flow_type
operator|,
name|flow_len
operator|)
argument_list|)
expr_stmt|;
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_flow_record_t
argument_list|)
expr_stmt|;
name|tlen
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_flow_record_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlen
operator|<
name|flow_len
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|enterprise
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|flow_type
condition|)
block|{
case|case
name|SFLOW_FLOW_RAW_PACKET
case|:
if|if
condition|(
name|print_sflow_raw_packet
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|tlen
argument_list|)
condition|)
return|return
literal|1
return|;
break|break;
case|case
name|SFLOW_FLOW_EXTENDED_SWITCH_DATA
case|:
if|if
condition|(
name|print_sflow_extended_switch_data
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|tlen
argument_list|)
condition|)
return|return
literal|1
return|;
break|break;
case|case
name|SFLOW_FLOW_ETHERNET_FRAME
case|:
if|if
condition|(
name|print_sflow_ethernet_frame
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|tlen
argument_list|)
condition|)
return|return
literal|1
return|;
break|break;
comment|/* FIXME these need a decoder */
case|case
name|SFLOW_FLOW_IPV4_DATA
case|:
case|case
name|SFLOW_FLOW_IPV6_DATA
case|:
case|case
name|SFLOW_FLOW_EXTENDED_ROUTER_DATA
case|:
case|case
name|SFLOW_FLOW_EXTENDED_GATEWAY_DATA
case|:
case|case
name|SFLOW_FLOW_EXTENDED_USER_DATA
case|:
case|case
name|SFLOW_FLOW_EXTENDED_URL_DATA
case|:
case|case
name|SFLOW_FLOW_EXTENDED_MPLS_DATA
case|:
case|case
name|SFLOW_FLOW_EXTENDED_NAT_DATA
case|:
case|case
name|SFLOW_FLOW_EXTENDED_MPLS_TUNNEL
case|:
case|case
name|SFLOW_FLOW_EXTENDED_MPLS_VC
case|:
case|case
name|SFLOW_FLOW_EXTENDED_MPLS_FEC
case|:
case|case
name|SFLOW_FLOW_EXTENDED_MPLS_LVP_FEC
case|:
case|case
name|SFLOW_FLOW_EXTENDED_VLAN_TUNNEL
case|:
break|break;
default|default:
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
literal|"\n\t\t"
argument_list|,
name|flow_len
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|tptr
operator|+=
name|flow_len
expr_stmt|;
name|tlen
operator|-=
name|flow_len
expr_stmt|;
name|nrecords
operator|--
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sflow_print_flow_sample
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sflow_flow_sample_t
modifier|*
name|sflow_flow_sample
decl_stmt|;
name|u_int
name|nrecords
decl_stmt|;
name|u_int
name|typesource
decl_stmt|;
name|u_int
name|type
decl_stmt|;
name|u_int
name|index
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_flow_sample_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_flow_sample
operator|=
operator|(
expr|struct
name|sflow_flow_sample_t
operator|*
operator|)
name|pointer
expr_stmt|;
name|typesource
operator|=
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_sample
operator|->
name|typesource
argument_list|)
expr_stmt|;
name|nrecords
operator|=
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_sample
operator|->
name|records
argument_list|)
expr_stmt|;
name|type
operator|=
name|typesource
operator|>>
literal|24
expr_stmt|;
name|index
operator|=
name|typesource
operator|&
literal|0x0FFF
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" seqnum %u, type %u, idx %u, rate %u, pool %u, drops %u, input %u output %u records %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_sample
operator|->
name|seqnum
argument_list|)
operator|,
name|type
operator|,
name|index
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_sample
operator|->
name|rate
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_sample
operator|->
name|pool
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_sample
operator|->
name|drops
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_sample
operator|->
name|in_interface
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_flow_sample
operator|->
name|out_interface
argument_list|)
operator|,
name|nrecords
operator|)
argument_list|)
expr_stmt|;
return|return
name|sflow_print_flow_records
argument_list|(
name|ndo
argument_list|,
name|pointer
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_flow_sample_t
argument_list|)
argument_list|,
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_flow_sample_t
argument_list|)
argument_list|,
name|nrecords
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sflow_print_expanded_flow_sample
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pointer
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sflow_expanded_flow_sample_t
modifier|*
name|sflow_expanded_flow_sample
decl_stmt|;
name|u_int
name|nrecords
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_expanded_flow_sample_t
argument_list|)
condition|)
return|return
literal|1
return|;
name|sflow_expanded_flow_sample
operator|=
operator|(
specifier|const
expr|struct
name|sflow_expanded_flow_sample_t
operator|*
operator|)
name|pointer
expr_stmt|;
name|nrecords
operator|=
name|EXTRACT_32BITS
argument_list|(
name|sflow_expanded_flow_sample
operator|->
name|records
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" seqnum %u, type %u, idx %u, rate %u, pool %u, drops %u, records %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_expanded_flow_sample
operator|->
name|seqnum
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_expanded_flow_sample
operator|->
name|type
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_expanded_flow_sample
operator|->
name|index
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_expanded_flow_sample
operator|->
name|rate
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_expanded_flow_sample
operator|->
name|pool
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_expanded_flow_sample
operator|->
name|drops
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_expanded_flow_sample
operator|->
name|records
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|sflow_print_flow_records
argument_list|(
name|ndo
argument_list|,
name|pointer
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_expanded_flow_sample_t
argument_list|)
argument_list|,
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_expanded_flow_sample_t
argument_list|)
argument_list|,
name|nrecords
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|sflow_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sflow_datagram_t
modifier|*
name|sflow_datagram
decl_stmt|;
specifier|const
name|struct
name|sflow_sample_header
modifier|*
name|sflow_sample
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|tptr
decl_stmt|;
name|u_int
name|tlen
decl_stmt|;
name|uint32_t
name|sflow_sample_type
decl_stmt|,
name|sflow_sample_len
decl_stmt|;
name|uint32_t
name|nsamples
decl_stmt|;
name|tptr
operator|=
name|pptr
expr_stmt|;
name|tlen
operator|=
name|len
expr_stmt|;
name|sflow_datagram
operator|=
operator|(
specifier|const
expr|struct
name|sflow_datagram_t
operator|*
operator|)
name|pptr
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|sflow_datagram
argument_list|)
expr_stmt|;
comment|/*      * Sanity checking of the header.      */
if|if
condition|(
name|EXTRACT_32BITS
argument_list|(
name|sflow_datagram
operator|->
name|version
argument_list|)
operator|!=
literal|5
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"sFlow version %u packet not supported"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_datagram
operator|->
name|version
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<
literal|1
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"sFlowv%u, %s agent %s, agent-id %u, length %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_datagram
operator|->
name|version
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_datagram
operator|->
name|ip_version
argument_list|)
operator|==
literal|1
condition|?
literal|"IPv4"
else|:
literal|"IPv6"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|sflow_datagram
operator|->
name|agent
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_datagram
operator|->
name|agent_id
argument_list|)
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* ok they seem to want to know everything - lets fully decode it */
name|nsamples
operator|=
name|EXTRACT_32BITS
argument_list|(
name|sflow_datagram
operator|->
name|samples
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"sFlowv%u, %s agent %s, agent-id %u, seqnum %u, uptime %u, samples %u, length %u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_datagram
operator|->
name|version
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_datagram
operator|->
name|ip_version
argument_list|)
operator|==
literal|1
condition|?
literal|"IPv4"
else|:
literal|"IPv6"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|sflow_datagram
operator|->
name|agent
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_datagram
operator|->
name|agent_id
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_datagram
operator|->
name|seqnum
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|sflow_datagram
operator|->
name|uptime
argument_list|)
operator|,
name|nsamples
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
comment|/* skip Common header */
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
specifier|const
expr|struct
name|sflow_datagram_t
argument_list|)
expr_stmt|;
name|tlen
operator|-=
sizeof|sizeof
argument_list|(
specifier|const
expr|struct
name|sflow_datagram_t
argument_list|)
expr_stmt|;
while|while
condition|(
name|nsamples
operator|>
literal|0
operator|&&
name|tlen
operator|>
literal|0
condition|)
block|{
name|sflow_sample
operator|=
operator|(
specifier|const
expr|struct
name|sflow_sample_header
operator|*
operator|)
name|tptr
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|sflow_sample
argument_list|)
expr_stmt|;
name|sflow_sample_type
operator|=
operator|(
name|EXTRACT_32BITS
argument_list|(
name|sflow_sample
operator|->
name|format
argument_list|)
operator|&
literal|0x0FFF
operator|)
expr_stmt|;
name|sflow_sample_len
operator|=
name|EXTRACT_32BITS
argument_list|(
name|sflow_sample
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_sample_header
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_sample_header
argument_list|)
expr_stmt|;
name|tlen
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|sflow_sample_header
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t%s (%u), length %u,"
operator|,
name|tok2str
argument_list|(
name|sflow_format_values
argument_list|,
literal|"Unknown"
argument_list|,
name|sflow_sample_type
argument_list|)
operator|,
name|sflow_sample_type
operator|,
name|sflow_sample_len
operator|)
argument_list|)
expr_stmt|;
comment|/* basic sanity check */
if|if
condition|(
name|sflow_sample_type
operator|==
literal|0
operator|||
name|sflow_sample_len
operator|==
literal|0
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|tlen
operator|<
name|sflow_sample_len
condition|)
goto|goto
name|trunc
goto|;
comment|/* did we capture enough for fully decoding the sample ? */
name|ND_TCHECK2
argument_list|(
operator|*
name|tptr
argument_list|,
name|sflow_sample_len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sflow_sample_type
condition|)
block|{
case|case
name|SFLOW_FLOW_SAMPLE
case|:
if|if
condition|(
name|sflow_print_flow_sample
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|tlen
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
break|break;
case|case
name|SFLOW_COUNTER_SAMPLE
case|:
if|if
condition|(
name|sflow_print_counter_sample
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|tlen
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
break|break;
case|case
name|SFLOW_EXPANDED_FLOW_SAMPLE
case|:
if|if
condition|(
name|sflow_print_expanded_flow_sample
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|tlen
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
break|break;
case|case
name|SFLOW_EXPANDED_COUNTER_SAMPLE
case|:
if|if
condition|(
name|sflow_print_expanded_counter_sample
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|tlen
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
break|break;
default|default:
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
literal|"\n\t    "
argument_list|,
name|sflow_sample_len
argument_list|)
expr_stmt|;
break|break;
block|}
name|tptr
operator|+=
name|sflow_sample_len
expr_stmt|;
name|tlen
operator|-=
name|sflow_sample_len
expr_stmt|;
name|nsamples
operator|--
expr_stmt|;
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|SFLOW]"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Local Variables:  * c-style: whitesmith  * c-basic-offset: 4  * End:  */
end_comment

end_unit


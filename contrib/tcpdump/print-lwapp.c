begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1998-2007 The TCPDUMP project  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that: (1) source code  * distributions retain the above copyright notice and this paragraph  * in its entirety, and (2) distributions including binary code include  * the above copyright notice and this paragraph in its entirety in  * the documentation or other materials provided with the distribution.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND  * WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, WITHOUT  * LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE.  *  * Support for the Light Weight Access Point Protocol as per draft-ohara-capwap-lwapp-04  *  * Original code by Carles Kishimoto<carles.kishimoto@gmail.com>  */
end_comment

begin_define
define|#
directive|define
name|NETDISSECT_REWORKED
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_comment
comment|/*  * LWAPP transport (common) header  *      0                   1                   2                   3  *     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  *    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  *    |VER| RID |C|F|L|    Frag ID    |            Length             |  *    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  *    |          Status/WLANs         |   Payload...  |  *    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  *  */
end_comment

begin_struct
struct|struct
name|lwapp_transport_header
block|{
name|uint8_t
name|version
decl_stmt|;
name|uint8_t
name|frag_id
decl_stmt|;
name|uint8_t
name|length
index|[
literal|2
index|]
decl_stmt|;
name|uint16_t
name|status
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * LWAPP control header  *      0                   1                   2                   3  *      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  *     |  Message Type |    Seq Num    |      Msg Element Length       |  *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  *     |                           Session ID                          |  *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  *     |      Msg Element [0..N]       |  *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  */
end_comment

begin_struct
struct|struct
name|lwapp_control_header
block|{
name|uint8_t
name|msg_type
decl_stmt|;
name|uint8_t
name|seq_num
decl_stmt|;
name|uint8_t
name|len
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|session_id
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|LWAPP_VERSION
value|0
end_define

begin_define
define|#
directive|define
name|LWAPP_EXTRACT_VERSION
parameter_list|(
name|x
parameter_list|)
value|(((x)&0xC0)>>6)
end_define

begin_define
define|#
directive|define
name|LWAPP_EXTRACT_RID
parameter_list|(
name|x
parameter_list|)
value|(((x)&0x38)>>3)
end_define

begin_define
define|#
directive|define
name|LWAPP_EXTRACT_CONTROL_BIT
parameter_list|(
name|x
parameter_list|)
value|(((x)&0x04)>>2)
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|lwapp_header_bits_values
index|[]
init|=
block|{
block|{
literal|0x01
block|,
literal|"Last Fragment Bit"
block|}
block|,
block|{
literal|0x02
block|,
literal|"Fragment Bit"
block|}
block|,
block|{
literal|0x04
block|,
literal|"Control Bit"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_DISCOVERY_REQUEST
value|1
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_DISCOVERY_RESPONSE
value|2
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_JOIN_REQUEST
value|3
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_JOIN_RESPONSE
value|4
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_JOIN_ACK
value|5
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_JOIN_CONFIRM
value|6
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_CONFIGURE_REQUEST
value|10
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_CONFIGURE_RESPONSE
value|11
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_CONF_UPDATE_REQUEST
value|12
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_CONF_UPDATE_RESPONSE
value|13
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_WTP_EVENT_REQUEST
value|14
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_WTP_EVENT_RESPONSE
value|15
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_CHANGE_STATE_EVENT_REQUEST
value|16
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_CHANGE_STATE_EVENT_RESPONSE
value|17
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_ECHO_REQUEST
value|22
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_ECHO_RESPONSE
value|23
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_IMAGE_DATA_REQUEST
value|24
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_IMAGE_DATA_RESPONSE
value|25
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_RESET_REQUEST
value|26
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_RESET_RESPONSE
value|27
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_KEY_UPDATE_REQUEST
value|30
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_KEY_UPDATE_RESPONSE
value|31
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_PRIMARY_DISCOVERY_REQUEST
value|32
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_PRIMARY_DISCOVERY_RESPONSE
value|33
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_DATA_TRANSFER_REQUEST
value|34
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_DATA_TRANSFER_RESPONSE
value|35
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_CLEAR_CONFIG_INDICATION
value|36
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_WLAN_CONFIG_REQUEST
value|37
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_WLAN_CONFIG_RESPONSE
value|38
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_MOBILE_CONFIG_REQUEST
value|39
end_define

begin_define
define|#
directive|define
name|LWAPP_MSGTYPE_MOBILE_CONFIG_RESPONSE
value|40
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|lwapp_msg_type_values
index|[]
init|=
block|{
block|{
name|LWAPP_MSGTYPE_DISCOVERY_REQUEST
block|,
literal|"Discovery req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_DISCOVERY_RESPONSE
block|,
literal|"Discovery resp"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_JOIN_REQUEST
block|,
literal|"Join req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_JOIN_RESPONSE
block|,
literal|"Join resp"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_JOIN_ACK
block|,
literal|"Join ack"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_JOIN_CONFIRM
block|,
literal|"Join confirm"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_CONFIGURE_REQUEST
block|,
literal|"Configure req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_CONFIGURE_RESPONSE
block|,
literal|"Configure resp"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_CONF_UPDATE_REQUEST
block|,
literal|"Update req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_CONF_UPDATE_RESPONSE
block|,
literal|"Update resp"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_WTP_EVENT_REQUEST
block|,
literal|"WTP event req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_WTP_EVENT_RESPONSE
block|,
literal|"WTP event resp"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_CHANGE_STATE_EVENT_REQUEST
block|,
literal|"Change state event req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_CHANGE_STATE_EVENT_RESPONSE
block|,
literal|"Change state event resp"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_ECHO_REQUEST
block|,
literal|"Echo req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_ECHO_RESPONSE
block|,
literal|"Echo resp"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_IMAGE_DATA_REQUEST
block|,
literal|"Image data req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_IMAGE_DATA_RESPONSE
block|,
literal|"Image data resp"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_RESET_REQUEST
block|,
literal|"Channel status req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_RESET_RESPONSE
block|,
literal|"Channel status resp"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_KEY_UPDATE_REQUEST
block|,
literal|"Key update req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_KEY_UPDATE_RESPONSE
block|,
literal|"Key update resp"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_PRIMARY_DISCOVERY_REQUEST
block|,
literal|"Primary discovery req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_PRIMARY_DISCOVERY_RESPONSE
block|,
literal|"Primary discovery resp"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_DATA_TRANSFER_REQUEST
block|,
literal|"Data transfer req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_DATA_TRANSFER_RESPONSE
block|,
literal|"Data transfer resp"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_CLEAR_CONFIG_INDICATION
block|,
literal|"Clear config ind"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_WLAN_CONFIG_REQUEST
block|,
literal|"Wlan config req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_WLAN_CONFIG_RESPONSE
block|,
literal|"Wlan config resp"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_MOBILE_CONFIG_REQUEST
block|,
literal|"Mobile config req"
block|}
block|,
block|{
name|LWAPP_MSGTYPE_MOBILE_CONFIG_RESPONSE
block|,
literal|"Mobile config resp"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * LWAPP message elements  *  * 0                   1                   2                   3  * 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  * |      Type     |             Length            |   Value ...   |  * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  */
end_comment

begin_struct
struct|struct
name|lwapp_message_header
block|{
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|length
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|lwapp_control_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|u_int
name|len
parameter_list|,
name|int
name|has_ap_ident
parameter_list|)
block|{
specifier|const
name|struct
name|lwapp_transport_header
modifier|*
name|lwapp_trans_header
decl_stmt|;
specifier|const
name|struct
name|lwapp_control_header
modifier|*
name|lwapp_control_header
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|tptr
decl_stmt|;
name|int
name|tlen
decl_stmt|;
name|int
name|msg_tlen
decl_stmt|;
name|tptr
operator|=
name|pptr
expr_stmt|;
if|if
condition|(
name|has_ap_ident
condition|)
block|{
comment|/* check if enough bytes for AP identity */
name|ND_TCHECK2
argument_list|(
operator|*
name|tptr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|lwapp_trans_header
operator|=
operator|(
specifier|const
expr|struct
name|lwapp_transport_header
operator|*
operator|)
operator|(
name|pptr
operator|+
literal|6
operator|)
expr_stmt|;
block|}
else|else
block|{
name|lwapp_trans_header
operator|=
operator|(
specifier|const
expr|struct
name|lwapp_transport_header
operator|*
operator|)
name|pptr
expr_stmt|;
block|}
name|ND_TCHECK
argument_list|(
operator|*
name|lwapp_trans_header
argument_list|)
expr_stmt|;
comment|/*      * Sanity checking of the header.      */
if|if
condition|(
name|LWAPP_EXTRACT_VERSION
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
operator|!=
name|LWAPP_VERSION
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"LWAPP version %u packet not supported"
operator|,
name|LWAPP_EXTRACT_VERSION
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* non-verbose */
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<
literal|1
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"LWAPPv%u, %s frame, Flags [%s], length %u"
operator|,
name|LWAPP_EXTRACT_VERSION
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
operator|,
name|LWAPP_EXTRACT_CONTROL_BIT
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
condition|?
literal|"Control"
else|:
literal|"Data"
operator|,
name|bittok2str
argument_list|(
name|lwapp_header_bits_values
argument_list|,
literal|"none"
argument_list|,
operator|(
name|lwapp_trans_header
operator|->
name|version
operator|)
operator|&
literal|0x07
argument_list|)
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* ok they seem to want to know everything - lets fully decode it */
name|tlen
operator|=
name|EXTRACT_16BITS
argument_list|(
name|lwapp_trans_header
operator|->
name|length
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"LWAPPv%u, %s frame, Radio-id %u, Flags [%s], Frag-id %u, length %u"
operator|,
name|LWAPP_EXTRACT_VERSION
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
operator|,
name|LWAPP_EXTRACT_CONTROL_BIT
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
condition|?
literal|"Control"
else|:
literal|"Data"
operator|,
name|LWAPP_EXTRACT_RID
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
operator|,
name|bittok2str
argument_list|(
name|lwapp_header_bits_values
argument_list|,
literal|"none"
argument_list|,
operator|(
name|lwapp_trans_header
operator|->
name|version
operator|)
operator|&
literal|0x07
argument_list|)
operator|,
name|lwapp_trans_header
operator|->
name|frag_id
operator|,
name|tlen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|has_ap_ident
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\tAP identity: %s"
operator|,
name|etheraddr_string
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
specifier|const
expr|struct
name|lwapp_transport_header
argument_list|)
operator|+
literal|6
expr_stmt|;
block|}
else|else
block|{
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
specifier|const
expr|struct
name|lwapp_transport_header
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|tlen
operator|>
literal|0
condition|)
block|{
comment|/* did we capture enough for fully decoding the object header ? */
name|ND_TCHECK2
argument_list|(
operator|*
name|tptr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|lwapp_control_header
argument_list|)
argument_list|)
expr_stmt|;
name|lwapp_control_header
operator|=
operator|(
specifier|const
expr|struct
name|lwapp_control_header
operator|*
operator|)
name|tptr
expr_stmt|;
name|msg_tlen
operator|=
name|EXTRACT_16BITS
argument_list|(
name|lwapp_control_header
operator|->
name|len
argument_list|)
expr_stmt|;
comment|/* print message header */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t  Msg type: %s (%u), Seqnum: %u, Msg len: %d, Session: 0x%08x"
operator|,
name|tok2str
argument_list|(
name|lwapp_msg_type_values
argument_list|,
literal|"Unknown"
argument_list|,
name|lwapp_control_header
operator|->
name|msg_type
argument_list|)
operator|,
name|lwapp_control_header
operator|->
name|msg_type
operator|,
name|lwapp_control_header
operator|->
name|seq_num
operator|,
name|msg_tlen
operator|,
name|EXTRACT_32BITS
argument_list|(
name|lwapp_control_header
operator|->
name|session_id
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* did we capture enough for fully decoding the message */
name|ND_TCHECK2
argument_list|(
operator|*
name|tptr
argument_list|,
name|msg_tlen
argument_list|)
expr_stmt|;
comment|/* XXX - Decode sub messages for each message */
switch|switch
condition|(
name|lwapp_control_header
operator|->
name|msg_type
condition|)
block|{
case|case
name|LWAPP_MSGTYPE_DISCOVERY_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_DISCOVERY_RESPONSE
case|:
case|case
name|LWAPP_MSGTYPE_JOIN_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_JOIN_RESPONSE
case|:
case|case
name|LWAPP_MSGTYPE_JOIN_ACK
case|:
case|case
name|LWAPP_MSGTYPE_JOIN_CONFIRM
case|:
case|case
name|LWAPP_MSGTYPE_CONFIGURE_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_CONFIGURE_RESPONSE
case|:
case|case
name|LWAPP_MSGTYPE_CONF_UPDATE_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_CONF_UPDATE_RESPONSE
case|:
case|case
name|LWAPP_MSGTYPE_WTP_EVENT_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_WTP_EVENT_RESPONSE
case|:
case|case
name|LWAPP_MSGTYPE_CHANGE_STATE_EVENT_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_CHANGE_STATE_EVENT_RESPONSE
case|:
case|case
name|LWAPP_MSGTYPE_ECHO_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_ECHO_RESPONSE
case|:
case|case
name|LWAPP_MSGTYPE_IMAGE_DATA_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_IMAGE_DATA_RESPONSE
case|:
case|case
name|LWAPP_MSGTYPE_RESET_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_RESET_RESPONSE
case|:
case|case
name|LWAPP_MSGTYPE_KEY_UPDATE_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_KEY_UPDATE_RESPONSE
case|:
case|case
name|LWAPP_MSGTYPE_PRIMARY_DISCOVERY_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_PRIMARY_DISCOVERY_RESPONSE
case|:
case|case
name|LWAPP_MSGTYPE_DATA_TRANSFER_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_DATA_TRANSFER_RESPONSE
case|:
case|case
name|LWAPP_MSGTYPE_CLEAR_CONFIG_INDICATION
case|:
case|case
name|LWAPP_MSGTYPE_WLAN_CONFIG_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_WLAN_CONFIG_RESPONSE
case|:
case|case
name|LWAPP_MSGTYPE_MOBILE_CONFIG_REQUEST
case|:
case|case
name|LWAPP_MSGTYPE_MOBILE_CONFIG_RESPONSE
case|:
default|default:
break|break;
block|}
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|lwapp_control_header
argument_list|)
operator|+
name|msg_tlen
expr_stmt|;
name|tlen
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|lwapp_control_header
argument_list|)
operator|+
name|msg_tlen
expr_stmt|;
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t\t packet exceeded snapshot"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|lwapp_data_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|lwapp_transport_header
modifier|*
name|lwapp_trans_header
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|tptr
decl_stmt|;
name|int
name|tlen
decl_stmt|;
name|tptr
operator|=
name|pptr
expr_stmt|;
comment|/* check if enough bytes for AP identity */
name|ND_TCHECK2
argument_list|(
operator|*
name|tptr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|lwapp_trans_header
operator|=
operator|(
specifier|const
expr|struct
name|lwapp_transport_header
operator|*
operator|)
name|pptr
expr_stmt|;
name|ND_TCHECK
argument_list|(
operator|*
name|lwapp_trans_header
argument_list|)
expr_stmt|;
comment|/*      * Sanity checking of the header.      */
if|if
condition|(
name|LWAPP_EXTRACT_VERSION
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
operator|!=
name|LWAPP_VERSION
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"LWAPP version %u packet not supported"
operator|,
name|LWAPP_EXTRACT_VERSION
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* non-verbose */
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<
literal|1
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"LWAPPv%u, %s frame, Flags [%s], length %u"
operator|,
name|LWAPP_EXTRACT_VERSION
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
operator|,
name|LWAPP_EXTRACT_CONTROL_BIT
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
condition|?
literal|"Control"
else|:
literal|"Data"
operator|,
name|bittok2str
argument_list|(
name|lwapp_header_bits_values
argument_list|,
literal|"none"
argument_list|,
operator|(
name|lwapp_trans_header
operator|->
name|version
operator|)
operator|&
literal|0x07
argument_list|)
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* ok they seem to want to know everything - lets fully decode it */
name|tlen
operator|=
name|EXTRACT_16BITS
argument_list|(
name|lwapp_trans_header
operator|->
name|length
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"LWAPPv%u, %s frame, Radio-id  %u, Flags [%s], Frag-id  %u, length %u"
operator|,
name|LWAPP_EXTRACT_VERSION
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
operator|,
name|LWAPP_EXTRACT_CONTROL_BIT
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
condition|?
literal|"Control"
else|:
literal|"Data"
operator|,
name|LWAPP_EXTRACT_RID
argument_list|(
name|lwapp_trans_header
operator|->
name|version
argument_list|)
operator|,
name|bittok2str
argument_list|(
name|lwapp_header_bits_values
argument_list|,
literal|"none"
argument_list|,
operator|(
name|lwapp_trans_header
operator|->
name|version
operator|)
operator|&
literal|0x07
argument_list|)
operator|,
name|lwapp_trans_header
operator|->
name|frag_id
operator|,
name|tlen
operator|)
argument_list|)
expr_stmt|;
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
specifier|const
expr|struct
name|lwapp_transport_header
argument_list|)
expr_stmt|;
name|tlen
operator|-=
sizeof|sizeof
argument_list|(
specifier|const
expr|struct
name|lwapp_transport_header
argument_list|)
expr_stmt|;
comment|/* FIX - An IEEE 802.11 frame follows - hexdump for now */
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
literal|"\n\t"
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t\t packet exceeded snapshot"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Local Variables:  * c-style: whitesmith  * c-basic-offset: 8  * End:  */
end_comment

end_unit


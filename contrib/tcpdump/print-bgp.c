begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 1999 WIDE Project.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the project nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * Extensively modified by Hannes Gredler (hannes@juniper.net) for more  * complete BGP support.  */
end_comment

begin_define
define|#
directive|define
name|NETDISSECT_REWORKED
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_include
include|#
directive|include
file|"af.h"
end_include

begin_include
include|#
directive|include
file|"l2vpn.h"
end_include

begin_struct
struct|struct
name|bgp
block|{
name|uint8_t
name|bgp_marker
index|[
literal|16
index|]
decl_stmt|;
name|uint16_t
name|bgp_len
decl_stmt|;
name|uint8_t
name|bgp_type
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|BGP_SIZE
value|19
end_define

begin_comment
comment|/* unaligned */
end_comment

begin_define
define|#
directive|define
name|BGP_OPEN
value|1
end_define

begin_define
define|#
directive|define
name|BGP_UPDATE
value|2
end_define

begin_define
define|#
directive|define
name|BGP_NOTIFICATION
value|3
end_define

begin_define
define|#
directive|define
name|BGP_KEEPALIVE
value|4
end_define

begin_define
define|#
directive|define
name|BGP_ROUTE_REFRESH
value|5
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_msg_values
index|[]
init|=
block|{
block|{
name|BGP_OPEN
block|,
literal|"Open"
block|}
block|,
block|{
name|BGP_UPDATE
block|,
literal|"Update"
block|}
block|,
block|{
name|BGP_NOTIFICATION
block|,
literal|"Notification"
block|}
block|,
block|{
name|BGP_KEEPALIVE
block|,
literal|"Keepalive"
block|}
block|,
block|{
name|BGP_ROUTE_REFRESH
block|,
literal|"Route Refresh"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|bgp_open
block|{
name|uint8_t
name|bgpo_marker
index|[
literal|16
index|]
decl_stmt|;
name|uint16_t
name|bgpo_len
decl_stmt|;
name|uint8_t
name|bgpo_type
decl_stmt|;
name|uint8_t
name|bgpo_version
decl_stmt|;
name|uint16_t
name|bgpo_myas
decl_stmt|;
name|uint16_t
name|bgpo_holdtime
decl_stmt|;
name|uint32_t
name|bgpo_id
decl_stmt|;
name|uint8_t
name|bgpo_optlen
decl_stmt|;
comment|/* options should follow */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|BGP_OPEN_SIZE
value|29
end_define

begin_comment
comment|/* unaligned */
end_comment

begin_struct
struct|struct
name|bgp_opt
block|{
name|uint8_t
name|bgpopt_type
decl_stmt|;
name|uint8_t
name|bgpopt_len
decl_stmt|;
comment|/* variable length */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|BGP_OPT_SIZE
value|2
end_define

begin_comment
comment|/* some compilers may pad to 4 bytes */
end_comment

begin_define
define|#
directive|define
name|BGP_CAP_HEADER_SIZE
value|2
end_define

begin_comment
comment|/* some compilers may pad to 4 bytes */
end_comment

begin_struct
struct|struct
name|bgp_notification
block|{
name|uint8_t
name|bgpn_marker
index|[
literal|16
index|]
decl_stmt|;
name|uint16_t
name|bgpn_len
decl_stmt|;
name|uint8_t
name|bgpn_type
decl_stmt|;
name|uint8_t
name|bgpn_major
decl_stmt|;
name|uint8_t
name|bgpn_minor
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|BGP_NOTIFICATION_SIZE
value|21
end_define

begin_comment
comment|/* unaligned */
end_comment

begin_struct
struct|struct
name|bgp_route_refresh
block|{
name|uint8_t
name|bgp_marker
index|[
literal|16
index|]
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|afi
index|[
literal|2
index|]
decl_stmt|;
comment|/* the compiler messes this structure up               */
name|uint8_t
name|res
decl_stmt|;
comment|/* when doing misaligned sequences of int8 and int16   */
name|uint8_t
name|safi
decl_stmt|;
comment|/* afi should be int16 - so we have to access it using */
block|}
struct|;
end_struct

begin_comment
comment|/* EXTRACT_16BITS(&bgp_route_refresh->afi) (sigh)      */
end_comment

begin_define
define|#
directive|define
name|BGP_ROUTE_REFRESH_SIZE
value|23
end_define

begin_define
define|#
directive|define
name|bgp_attr_lenlen
parameter_list|(
name|flags
parameter_list|,
name|p
parameter_list|)
define|\
value|(((flags)& 0x10) ? 2 : 1)
end_define

begin_define
define|#
directive|define
name|bgp_attr_len
parameter_list|(
name|flags
parameter_list|,
name|p
parameter_list|)
define|\
value|(((flags)& 0x10) ? EXTRACT_16BITS(p) : *(p))
end_define

begin_define
define|#
directive|define
name|BGPTYPE_ORIGIN
value|1
end_define

begin_define
define|#
directive|define
name|BGPTYPE_AS_PATH
value|2
end_define

begin_define
define|#
directive|define
name|BGPTYPE_NEXT_HOP
value|3
end_define

begin_define
define|#
directive|define
name|BGPTYPE_MULTI_EXIT_DISC
value|4
end_define

begin_define
define|#
directive|define
name|BGPTYPE_LOCAL_PREF
value|5
end_define

begin_define
define|#
directive|define
name|BGPTYPE_ATOMIC_AGGREGATE
value|6
end_define

begin_define
define|#
directive|define
name|BGPTYPE_AGGREGATOR
value|7
end_define

begin_define
define|#
directive|define
name|BGPTYPE_COMMUNITIES
value|8
end_define

begin_comment
comment|/* RFC1997 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_ORIGINATOR_ID
value|9
end_define

begin_comment
comment|/* RFC1998 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_CLUSTER_LIST
value|10
end_define

begin_comment
comment|/* RFC1998 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_DPA
value|11
end_define

begin_comment
comment|/* draft-ietf-idr-bgp-dpa */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_ADVERTISERS
value|12
end_define

begin_comment
comment|/* RFC1863 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_RCID_PATH
value|13
end_define

begin_comment
comment|/* RFC1863 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_MP_REACH_NLRI
value|14
end_define

begin_comment
comment|/* RFC2283 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_MP_UNREACH_NLRI
value|15
end_define

begin_comment
comment|/* RFC2283 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_EXTD_COMMUNITIES
value|16
end_define

begin_comment
comment|/* draft-ietf-idr-bgp-ext-communities */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_AS4_PATH
value|17
end_define

begin_comment
comment|/* RFC4893 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_AGGREGATOR4
value|18
end_define

begin_comment
comment|/* RFC4893 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_PMSI_TUNNEL
value|22
end_define

begin_comment
comment|/* draft-ietf-l3vpn-2547bis-mcast-bgp-02.txt */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_ATTR_SET
value|128
end_define

begin_comment
comment|/* draft-marques-ppvpn-ibgp */
end_comment

begin_define
define|#
directive|define
name|BGP_MP_NLRI_MINSIZE
value|3
end_define

begin_comment
comment|/* End of RIB Marker detection */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_attr_values
index|[]
init|=
block|{
block|{
name|BGPTYPE_ORIGIN
block|,
literal|"Origin"
block|}
block|,
block|{
name|BGPTYPE_AS_PATH
block|,
literal|"AS Path"
block|}
block|,
block|{
name|BGPTYPE_AS4_PATH
block|,
literal|"AS4 Path"
block|}
block|,
block|{
name|BGPTYPE_NEXT_HOP
block|,
literal|"Next Hop"
block|}
block|,
block|{
name|BGPTYPE_MULTI_EXIT_DISC
block|,
literal|"Multi Exit Discriminator"
block|}
block|,
block|{
name|BGPTYPE_LOCAL_PREF
block|,
literal|"Local Preference"
block|}
block|,
block|{
name|BGPTYPE_ATOMIC_AGGREGATE
block|,
literal|"Atomic Aggregate"
block|}
block|,
block|{
name|BGPTYPE_AGGREGATOR
block|,
literal|"Aggregator"
block|}
block|,
block|{
name|BGPTYPE_AGGREGATOR4
block|,
literal|"Aggregator4"
block|}
block|,
block|{
name|BGPTYPE_COMMUNITIES
block|,
literal|"Community"
block|}
block|,
block|{
name|BGPTYPE_ORIGINATOR_ID
block|,
literal|"Originator ID"
block|}
block|,
block|{
name|BGPTYPE_CLUSTER_LIST
block|,
literal|"Cluster List"
block|}
block|,
block|{
name|BGPTYPE_DPA
block|,
literal|"DPA"
block|}
block|,
block|{
name|BGPTYPE_ADVERTISERS
block|,
literal|"Advertisers"
block|}
block|,
block|{
name|BGPTYPE_RCID_PATH
block|,
literal|"RCID Path / Cluster ID"
block|}
block|,
block|{
name|BGPTYPE_MP_REACH_NLRI
block|,
literal|"Multi-Protocol Reach NLRI"
block|}
block|,
block|{
name|BGPTYPE_MP_UNREACH_NLRI
block|,
literal|"Multi-Protocol Unreach NLRI"
block|}
block|,
block|{
name|BGPTYPE_EXTD_COMMUNITIES
block|,
literal|"Extended Community"
block|}
block|,
block|{
name|BGPTYPE_PMSI_TUNNEL
block|,
literal|"PMSI Tunnel"
block|}
block|,
block|{
name|BGPTYPE_ATTR_SET
block|,
literal|"Attribute Set"
block|}
block|,
block|{
literal|255
block|,
literal|"Reserved for development"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|BGP_AS_SET
value|1
end_define

begin_define
define|#
directive|define
name|BGP_AS_SEQUENCE
value|2
end_define

begin_define
define|#
directive|define
name|BGP_CONFED_AS_SEQUENCE
value|3
end_define

begin_comment
comment|/* draft-ietf-idr-rfc3065bis-01 */
end_comment

begin_define
define|#
directive|define
name|BGP_CONFED_AS_SET
value|4
end_define

begin_comment
comment|/* draft-ietf-idr-rfc3065bis-01  */
end_comment

begin_define
define|#
directive|define
name|BGP_AS_SEG_TYPE_MIN
value|BGP_AS_SET
end_define

begin_define
define|#
directive|define
name|BGP_AS_SEG_TYPE_MAX
value|BGP_CONFED_AS_SET
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_as_path_segment_open_values
index|[]
init|=
block|{
block|{
name|BGP_AS_SEQUENCE
block|,
literal|""
block|}
block|,
block|{
name|BGP_AS_SET
block|,
literal|"{ "
block|}
block|,
block|{
name|BGP_CONFED_AS_SEQUENCE
block|,
literal|"( "
block|}
block|,
block|{
name|BGP_CONFED_AS_SET
block|,
literal|"({ "
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_as_path_segment_close_values
index|[]
init|=
block|{
block|{
name|BGP_AS_SEQUENCE
block|,
literal|""
block|}
block|,
block|{
name|BGP_AS_SET
block|,
literal|"}"
block|}
block|,
block|{
name|BGP_CONFED_AS_SEQUENCE
block|,
literal|")"
block|}
block|,
block|{
name|BGP_CONFED_AS_SET
block|,
literal|"})"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|BGP_OPT_AUTH
value|1
end_define

begin_define
define|#
directive|define
name|BGP_OPT_CAP
value|2
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_opt_values
index|[]
init|=
block|{
block|{
name|BGP_OPT_AUTH
block|,
literal|"Authentication Information"
block|}
block|,
block|{
name|BGP_OPT_CAP
block|,
literal|"Capabilities Advertisement"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|BGP_CAPCODE_MP
value|1
end_define

begin_define
define|#
directive|define
name|BGP_CAPCODE_RR
value|2
end_define

begin_define
define|#
directive|define
name|BGP_CAPCODE_ORF
value|3
end_define

begin_comment
comment|/* XXX */
end_comment

begin_define
define|#
directive|define
name|BGP_CAPCODE_RESTART
value|64
end_define

begin_comment
comment|/* draft-ietf-idr-restart-05  */
end_comment

begin_define
define|#
directive|define
name|BGP_CAPCODE_AS_NEW
value|65
end_define

begin_comment
comment|/* XXX */
end_comment

begin_define
define|#
directive|define
name|BGP_CAPCODE_DYN_CAP
value|67
end_define

begin_comment
comment|/* XXX */
end_comment

begin_define
define|#
directive|define
name|BGP_CAPCODE_RR_CISCO
value|128
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_capcode_values
index|[]
init|=
block|{
block|{
name|BGP_CAPCODE_MP
block|,
literal|"Multiprotocol Extensions"
block|}
block|,
block|{
name|BGP_CAPCODE_RR
block|,
literal|"Route Refresh"
block|}
block|,
block|{
name|BGP_CAPCODE_ORF
block|,
literal|"Cooperative Route Filtering"
block|}
block|,
block|{
name|BGP_CAPCODE_RESTART
block|,
literal|"Graceful Restart"
block|}
block|,
block|{
name|BGP_CAPCODE_AS_NEW
block|,
literal|"32-Bit AS Number"
block|}
block|,
block|{
name|BGP_CAPCODE_DYN_CAP
block|,
literal|"Dynamic Capability"
block|}
block|,
block|{
name|BGP_CAPCODE_RR_CISCO
block|,
literal|"Route Refresh (Cisco)"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|BGP_NOTIFY_MAJOR_MSG
value|1
end_define

begin_define
define|#
directive|define
name|BGP_NOTIFY_MAJOR_OPEN
value|2
end_define

begin_define
define|#
directive|define
name|BGP_NOTIFY_MAJOR_UPDATE
value|3
end_define

begin_define
define|#
directive|define
name|BGP_NOTIFY_MAJOR_HOLDTIME
value|4
end_define

begin_define
define|#
directive|define
name|BGP_NOTIFY_MAJOR_FSM
value|5
end_define

begin_define
define|#
directive|define
name|BGP_NOTIFY_MAJOR_CEASE
value|6
end_define

begin_define
define|#
directive|define
name|BGP_NOTIFY_MAJOR_CAP
value|7
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_notify_major_values
index|[]
init|=
block|{
block|{
name|BGP_NOTIFY_MAJOR_MSG
block|,
literal|"Message Header Error"
block|}
block|,
block|{
name|BGP_NOTIFY_MAJOR_OPEN
block|,
literal|"OPEN Message Error"
block|}
block|,
block|{
name|BGP_NOTIFY_MAJOR_UPDATE
block|,
literal|"UPDATE Message Error"
block|}
block|,
block|{
name|BGP_NOTIFY_MAJOR_HOLDTIME
block|,
literal|"Hold Timer Expired"
block|}
block|,
block|{
name|BGP_NOTIFY_MAJOR_FSM
block|,
literal|"Finite State Machine Error"
block|}
block|,
block|{
name|BGP_NOTIFY_MAJOR_CEASE
block|,
literal|"Cease"
block|}
block|,
block|{
name|BGP_NOTIFY_MAJOR_CAP
block|,
literal|"Capability Message Error"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* draft-ietf-idr-cease-subcode-02 */
end_comment

begin_define
define|#
directive|define
name|BGP_NOTIFY_MINOR_CEASE_MAXPRFX
value|1
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_notify_minor_cease_values
index|[]
init|=
block|{
block|{
name|BGP_NOTIFY_MINOR_CEASE_MAXPRFX
block|,
literal|"Maximum Number of Prefixes Reached"
block|}
block|,
block|{
literal|2
block|,
literal|"Administratively Shutdown"
block|}
block|,
block|{
literal|3
block|,
literal|"Peer Unconfigured"
block|}
block|,
block|{
literal|4
block|,
literal|"Administratively Reset"
block|}
block|,
block|{
literal|5
block|,
literal|"Connection Rejected"
block|}
block|,
block|{
literal|6
block|,
literal|"Other Configuration Change"
block|}
block|,
block|{
literal|7
block|,
literal|"Connection Collision Resolution"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_notify_minor_msg_values
index|[]
init|=
block|{
block|{
literal|1
block|,
literal|"Connection Not Synchronized"
block|}
block|,
block|{
literal|2
block|,
literal|"Bad Message Length"
block|}
block|,
block|{
literal|3
block|,
literal|"Bad Message Type"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_notify_minor_open_values
index|[]
init|=
block|{
block|{
literal|1
block|,
literal|"Unsupported Version Number"
block|}
block|,
block|{
literal|2
block|,
literal|"Bad Peer AS"
block|}
block|,
block|{
literal|3
block|,
literal|"Bad BGP Identifier"
block|}
block|,
block|{
literal|4
block|,
literal|"Unsupported Optional Parameter"
block|}
block|,
block|{
literal|5
block|,
literal|"Authentication Failure"
block|}
block|,
block|{
literal|6
block|,
literal|"Unacceptable Hold Time"
block|}
block|,
block|{
literal|7
block|,
literal|"Capability Message Error"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_notify_minor_update_values
index|[]
init|=
block|{
block|{
literal|1
block|,
literal|"Malformed Attribute List"
block|}
block|,
block|{
literal|2
block|,
literal|"Unrecognized Well-known Attribute"
block|}
block|,
block|{
literal|3
block|,
literal|"Missing Well-known Attribute"
block|}
block|,
block|{
literal|4
block|,
literal|"Attribute Flags Error"
block|}
block|,
block|{
literal|5
block|,
literal|"Attribute Length Error"
block|}
block|,
block|{
literal|6
block|,
literal|"Invalid ORIGIN Attribute"
block|}
block|,
block|{
literal|7
block|,
literal|"AS Routing Loop"
block|}
block|,
block|{
literal|8
block|,
literal|"Invalid NEXT_HOP Attribute"
block|}
block|,
block|{
literal|9
block|,
literal|"Optional Attribute Error"
block|}
block|,
block|{
literal|10
block|,
literal|"Invalid Network Field"
block|}
block|,
block|{
literal|11
block|,
literal|"Malformed AS_PATH"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_notify_minor_cap_values
index|[]
init|=
block|{
block|{
literal|1
block|,
literal|"Invalid Action Value"
block|}
block|,
block|{
literal|2
block|,
literal|"Invalid Capability Length"
block|}
block|,
block|{
literal|3
block|,
literal|"Malformed Capability Value"
block|}
block|,
block|{
literal|4
block|,
literal|"Unsupported Capability Code"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_origin_values
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"IGP"
block|}
block|,
block|{
literal|1
block|,
literal|"EGP"
block|}
block|,
block|{
literal|2
block|,
literal|"Incomplete"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|BGP_PMSI_TUNNEL_RSVP_P2MP
value|1
end_define

begin_define
define|#
directive|define
name|BGP_PMSI_TUNNEL_LDP_P2MP
value|2
end_define

begin_define
define|#
directive|define
name|BGP_PMSI_TUNNEL_PIM_SSM
value|3
end_define

begin_define
define|#
directive|define
name|BGP_PMSI_TUNNEL_PIM_SM
value|4
end_define

begin_define
define|#
directive|define
name|BGP_PMSI_TUNNEL_PIM_BIDIR
value|5
end_define

begin_define
define|#
directive|define
name|BGP_PMSI_TUNNEL_INGRESS
value|6
end_define

begin_define
define|#
directive|define
name|BGP_PMSI_TUNNEL_LDP_MP2MP
value|7
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_pmsi_tunnel_values
index|[]
init|=
block|{
block|{
name|BGP_PMSI_TUNNEL_RSVP_P2MP
block|,
literal|"RSVP-TE P2MP LSP"
block|}
block|,
block|{
name|BGP_PMSI_TUNNEL_LDP_P2MP
block|,
literal|"LDP P2MP LSP"
block|}
block|,
block|{
name|BGP_PMSI_TUNNEL_PIM_SSM
block|,
literal|"PIM-SSM Tree"
block|}
block|,
block|{
name|BGP_PMSI_TUNNEL_PIM_SM
block|,
literal|"PIM-SM Tree"
block|}
block|,
block|{
name|BGP_PMSI_TUNNEL_PIM_BIDIR
block|,
literal|"PIM-Bidir Tree"
block|}
block|,
block|{
name|BGP_PMSI_TUNNEL_INGRESS
block|,
literal|"Ingress Replication"
block|}
block|,
block|{
name|BGP_PMSI_TUNNEL_LDP_MP2MP
block|,
literal|"LDP MP2MP LSP"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_pmsi_flag_values
index|[]
init|=
block|{
block|{
literal|0x01
block|,
literal|"Leaf Information required"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Subsequent address family identifier, RFC2283 section 7 */
end_comment

begin_define
define|#
directive|define
name|SAFNUM_RES
value|0
end_define

begin_define
define|#
directive|define
name|SAFNUM_UNICAST
value|1
end_define

begin_define
define|#
directive|define
name|SAFNUM_MULTICAST
value|2
end_define

begin_define
define|#
directive|define
name|SAFNUM_UNIMULTICAST
value|3
end_define

begin_comment
comment|/* labeled BGP RFC3107 */
end_comment

begin_define
define|#
directive|define
name|SAFNUM_LABUNICAST
value|4
end_define

begin_comment
comment|/* draft-ietf-l3vpn-2547bis-mcast-bgp-02.txt */
end_comment

begin_define
define|#
directive|define
name|SAFNUM_MULTICAST_VPN
value|5
end_define

begin_define
define|#
directive|define
name|SAFNUM_TUNNEL
value|64
end_define

begin_comment
comment|/* XXX */
end_comment

begin_define
define|#
directive|define
name|SAFNUM_VPLS
value|65
end_define

begin_comment
comment|/* XXX */
end_comment

begin_comment
comment|/* draft-nalawade-idr-mdt-safi-03 */
end_comment

begin_define
define|#
directive|define
name|SAFNUM_MDT
value|66
end_define

begin_comment
comment|/* Section 4.3.4 of draft-rosen-rfc2547bis-03.txt  */
end_comment

begin_define
define|#
directive|define
name|SAFNUM_VPNUNICAST
value|128
end_define

begin_define
define|#
directive|define
name|SAFNUM_VPNMULTICAST
value|129
end_define

begin_define
define|#
directive|define
name|SAFNUM_VPNUNIMULTICAST
value|130
end_define

begin_comment
comment|/* draft-marques-ppvpn-rt-constrain-01.txt */
end_comment

begin_define
define|#
directive|define
name|SAFNUM_RT_ROUTING_INFO
value|132
end_define

begin_define
define|#
directive|define
name|BGP_VPN_RD_LEN
value|8
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_safi_values
index|[]
init|=
block|{
block|{
name|SAFNUM_RES
block|,
literal|"Reserved"
block|}
block|,
block|{
name|SAFNUM_UNICAST
block|,
literal|"Unicast"
block|}
block|,
block|{
name|SAFNUM_MULTICAST
block|,
literal|"Multicast"
block|}
block|,
block|{
name|SAFNUM_UNIMULTICAST
block|,
literal|"Unicast+Multicast"
block|}
block|,
block|{
name|SAFNUM_LABUNICAST
block|,
literal|"labeled Unicast"
block|}
block|,
block|{
name|SAFNUM_TUNNEL
block|,
literal|"Tunnel"
block|}
block|,
block|{
name|SAFNUM_VPLS
block|,
literal|"VPLS"
block|}
block|,
block|{
name|SAFNUM_MDT
block|,
literal|"MDT"
block|}
block|,
block|{
name|SAFNUM_VPNUNICAST
block|,
literal|"labeled VPN Unicast"
block|}
block|,
block|{
name|SAFNUM_VPNMULTICAST
block|,
literal|"labeled VPN Multicast"
block|}
block|,
block|{
name|SAFNUM_VPNUNIMULTICAST
block|,
literal|"labeled VPN Unicast+Multicast"
block|}
block|,
block|{
name|SAFNUM_RT_ROUTING_INFO
block|,
literal|"Route Target Routing Information"
block|}
block|,
block|{
name|SAFNUM_MULTICAST_VPN
block|,
literal|"Multicast VPN"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* well-known community */
end_comment

begin_define
define|#
directive|define
name|BGP_COMMUNITY_NO_EXPORT
value|0xffffff01
end_define

begin_define
define|#
directive|define
name|BGP_COMMUNITY_NO_ADVERT
value|0xffffff02
end_define

begin_define
define|#
directive|define
name|BGP_COMMUNITY_NO_EXPORT_SUBCONFED
value|0xffffff03
end_define

begin_comment
comment|/* Extended community type - draft-ietf-idr-bgp-ext-communities-05 */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_RT_0
value|0x0002
end_define

begin_comment
comment|/* Route Target,Format AS(2bytes):AN(4bytes) */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_RT_1
value|0x0102
end_define

begin_comment
comment|/* Route Target,Format IP address:AN(2bytes) */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_RT_2
value|0x0202
end_define

begin_comment
comment|/* Route Target,Format AN(4bytes):local(2bytes) */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_RO_0
value|0x0003
end_define

begin_comment
comment|/* Route Origin,Format AS(2bytes):AN(4bytes) */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_RO_1
value|0x0103
end_define

begin_comment
comment|/* Route Origin,Format IP address:AN(2bytes) */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_RO_2
value|0x0203
end_define

begin_comment
comment|/* Route Origin,Format AN(4bytes):local(2bytes) */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_LINKBAND
value|0x4004
end_define

begin_comment
comment|/* Link Bandwidth,Format AS(2B):Bandwidth(4B) */
end_comment

begin_comment
comment|/* rfc2547 bgp-mpls-vpns */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_VPN_ORIGIN
value|0x0005
end_define

begin_comment
comment|/* OSPF Domain ID / VPN of Origin  - draft-rosen-vpns-ospf-bgp-mpls */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_VPN_ORIGIN2
value|0x0105
end_define

begin_comment
comment|/* duplicate - keep for backwards compatability */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_VPN_ORIGIN3
value|0x0205
end_define

begin_comment
comment|/* duplicate - keep for backwards compatability */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_VPN_ORIGIN4
value|0x8005
end_define

begin_comment
comment|/* duplicate - keep for backwards compatability */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_OSPF_RTYPE
value|0x0306
end_define

begin_comment
comment|/* OSPF Route Type,Format Area(4B):RouteType(1B):Options(1B) */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_OSPF_RTYPE2
value|0x8000
end_define

begin_comment
comment|/* duplicate - keep for backwards compatability */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_OSPF_RID
value|0x0107
end_define

begin_comment
comment|/* OSPF Router ID,Format RouterID(4B):Unused(2B) */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_OSPF_RID2
value|0x8001
end_define

begin_comment
comment|/* duplicate - keep for backwards compatability */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_L2INFO
value|0x800a
end_define

begin_comment
comment|/* draft-kompella-ppvpn-l2vpn */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_SOURCE_AS
value|0x0009
end_define

begin_comment
comment|/* RFC-ietf-l3vpn-2547bis-mcast-bgp-08.txt */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_VRF_RT_IMP
value|0x010b
end_define

begin_comment
comment|/* RFC-ietf-l3vpn-2547bis-mcast-bgp-08.txt */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_L2VPN_RT_0
value|0x000a
end_define

begin_comment
comment|/* L2VPN Identifier,Format AS(2bytes):AN(4bytes) */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_L2VPN_RT_1
value|0xF10a
end_define

begin_comment
comment|/* L2VPN Identifier,Format IP address:AN(2bytes) */
end_comment

begin_comment
comment|/* http://www.cisco.com/en/US/tech/tk436/tk428/technologies_tech_note09186a00801eb09a.shtml  */
end_comment

begin_define
define|#
directive|define
name|BGP_EXT_COM_EIGRP_GEN
value|0x8800
end_define

begin_define
define|#
directive|define
name|BGP_EXT_COM_EIGRP_METRIC_AS_DELAY
value|0x8801
end_define

begin_define
define|#
directive|define
name|BGP_EXT_COM_EIGRP_METRIC_REL_NH_BW
value|0x8802
end_define

begin_define
define|#
directive|define
name|BGP_EXT_COM_EIGRP_METRIC_LOAD_MTU
value|0x8803
end_define

begin_define
define|#
directive|define
name|BGP_EXT_COM_EIGRP_EXT_REMAS_REMID
value|0x8804
end_define

begin_define
define|#
directive|define
name|BGP_EXT_COM_EIGRP_EXT_REMPROTO_REMMETRIC
value|0x8805
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_extd_comm_flag_values
index|[]
init|=
block|{
block|{
literal|0x8000
block|,
literal|"vendor-specific"
block|}
block|,
block|{
literal|0x4000
block|,
literal|"non-transitive"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_extd_comm_subtype_values
index|[]
init|=
block|{
block|{
name|BGP_EXT_COM_RT_0
block|,
literal|"target"
block|}
block|,
block|{
name|BGP_EXT_COM_RT_1
block|,
literal|"target"
block|}
block|,
block|{
name|BGP_EXT_COM_RT_2
block|,
literal|"target"
block|}
block|,
block|{
name|BGP_EXT_COM_RO_0
block|,
literal|"origin"
block|}
block|,
block|{
name|BGP_EXT_COM_RO_1
block|,
literal|"origin"
block|}
block|,
block|{
name|BGP_EXT_COM_RO_2
block|,
literal|"origin"
block|}
block|,
block|{
name|BGP_EXT_COM_LINKBAND
block|,
literal|"link-BW"
block|}
block|,
block|{
name|BGP_EXT_COM_VPN_ORIGIN
block|,
literal|"ospf-domain"
block|}
block|,
block|{
name|BGP_EXT_COM_VPN_ORIGIN2
block|,
literal|"ospf-domain"
block|}
block|,
block|{
name|BGP_EXT_COM_VPN_ORIGIN3
block|,
literal|"ospf-domain"
block|}
block|,
block|{
name|BGP_EXT_COM_VPN_ORIGIN4
block|,
literal|"ospf-domain"
block|}
block|,
block|{
name|BGP_EXT_COM_OSPF_RTYPE
block|,
literal|"ospf-route-type"
block|}
block|,
block|{
name|BGP_EXT_COM_OSPF_RTYPE2
block|,
literal|"ospf-route-type"
block|}
block|,
block|{
name|BGP_EXT_COM_OSPF_RID
block|,
literal|"ospf-router-id"
block|}
block|,
block|{
name|BGP_EXT_COM_OSPF_RID2
block|,
literal|"ospf-router-id"
block|}
block|,
block|{
name|BGP_EXT_COM_L2INFO
block|,
literal|"layer2-info"
block|}
block|,
block|{
name|BGP_EXT_COM_EIGRP_GEN
block|,
literal|"eigrp-general-route (flag, tag)"
block|}
block|,
block|{
name|BGP_EXT_COM_EIGRP_METRIC_AS_DELAY
block|,
literal|"eigrp-route-metric (AS, delay)"
block|}
block|,
block|{
name|BGP_EXT_COM_EIGRP_METRIC_REL_NH_BW
block|,
literal|"eigrp-route-metric (reliability, nexthop, bandwidth)"
block|}
block|,
block|{
name|BGP_EXT_COM_EIGRP_METRIC_LOAD_MTU
block|,
literal|"eigrp-route-metric (load, MTU)"
block|}
block|,
block|{
name|BGP_EXT_COM_EIGRP_EXT_REMAS_REMID
block|,
literal|"eigrp-external-route (remote-AS, remote-ID)"
block|}
block|,
block|{
name|BGP_EXT_COM_EIGRP_EXT_REMPROTO_REMMETRIC
block|,
literal|"eigrp-external-route (remote-proto, remote-metric)"
block|}
block|,
block|{
name|BGP_EXT_COM_SOURCE_AS
block|,
literal|"source-AS"
block|}
block|,
block|{
name|BGP_EXT_COM_VRF_RT_IMP
block|,
literal|"vrf-route-import"
block|}
block|,
block|{
name|BGP_EXT_COM_L2VPN_RT_0
block|,
literal|"l2vpn-id"
block|}
block|,
block|{
name|BGP_EXT_COM_L2VPN_RT_1
block|,
literal|"l2vpn-id"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* OSPF codes for  BGP_EXT_COM_OSPF_RTYPE draft-rosen-vpns-ospf-bgp-mpls  */
end_comment

begin_define
define|#
directive|define
name|BGP_OSPF_RTYPE_RTR
value|1
end_define

begin_comment
comment|/* OSPF Router LSA */
end_comment

begin_define
define|#
directive|define
name|BGP_OSPF_RTYPE_NET
value|2
end_define

begin_comment
comment|/* OSPF Network LSA */
end_comment

begin_define
define|#
directive|define
name|BGP_OSPF_RTYPE_SUM
value|3
end_define

begin_comment
comment|/* OSPF Summary LSA */
end_comment

begin_define
define|#
directive|define
name|BGP_OSPF_RTYPE_EXT
value|5
end_define

begin_comment
comment|/* OSPF External LSA, note that ASBR doesn't apply to MPLS-VPN */
end_comment

begin_define
define|#
directive|define
name|BGP_OSPF_RTYPE_NSSA
value|7
end_define

begin_comment
comment|/* OSPF NSSA External*/
end_comment

begin_define
define|#
directive|define
name|BGP_OSPF_RTYPE_SHAM
value|129
end_define

begin_comment
comment|/* OSPF-MPLS-VPN Sham link */
end_comment

begin_define
define|#
directive|define
name|BGP_OSPF_RTYPE_METRIC_TYPE
value|0x1
end_define

begin_comment
comment|/* LSB of RTYPE Options Field */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_extd_comm_ospf_rtype_values
index|[]
init|=
block|{
block|{
name|BGP_OSPF_RTYPE_RTR
block|,
literal|"Router"
block|}
block|,
block|{
name|BGP_OSPF_RTYPE_NET
block|,
literal|"Network"
block|}
block|,
block|{
name|BGP_OSPF_RTYPE_SUM
block|,
literal|"Summary"
block|}
block|,
block|{
name|BGP_OSPF_RTYPE_EXT
block|,
literal|"External"
block|}
block|,
block|{
name|BGP_OSPF_RTYPE_NSSA
block|,
literal|"NSSA External"
block|}
block|,
block|{
name|BGP_OSPF_RTYPE_SHAM
block|,
literal|"MPLS-VPN Sham"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|TOKBUFSIZE
value|128
end_define

begin_decl_stmt
specifier|static
name|char
name|astostr
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * as_printf  *  * Convert an AS number into a string and return string pointer.  *  * Depending on bflag is set or not, AS number is converted into ASDOT notation  * or plain number notation.  *  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|as_printf
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|int
name|size
parameter_list|,
name|u_int
name|asnum
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ndo
operator|->
name|ndo_bflag
operator|||
name|asnum
operator|<=
literal|0xFFFF
condition|)
block|{
name|snprintf
argument_list|(
name|str
argument_list|,
name|size
argument_list|,
literal|"%u"
argument_list|,
name|asnum
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|snprintf
argument_list|(
name|str
argument_list|,
name|size
argument_list|,
literal|"%u.%u"
argument_list|,
name|asnum
operator|>>
literal|16
argument_list|,
name|asnum
operator|&
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
return|return
name|str
return|;
block|}
end_function

begin_define
define|#
directive|define
name|ITEMCHECK
parameter_list|(
name|minlen
parameter_list|)
value|if (itemlen< minlen) goto badtlv;
end_define

begin_function
name|int
name|decode_prefix4
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|u_int
name|itemlen
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|struct
name|in_addr
name|addr
decl_stmt|;
name|u_int
name|plen
decl_stmt|,
name|plenbytes
decl_stmt|;
name|ND_TCHECK
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ITEMCHECK
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|plen
operator|=
name|pptr
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
literal|32
operator|<
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|itemlen
operator|-=
literal|1
expr_stmt|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|plenbytes
operator|=
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|1
index|]
argument_list|,
name|plenbytes
argument_list|)
expr_stmt|;
name|ITEMCHECK
argument_list|(
name|plenbytes
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|pptr
index|[
literal|1
index|]
argument_list|,
name|plenbytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|%
literal|8
condition|)
block|{
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|addr
operator|)
index|[
name|plenbytes
operator|-
literal|1
index|]
operator|&=
operator|(
operator|(
literal|0xff00
operator|>>
operator|(
name|plen
operator|%
literal|8
operator|)
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s/%d"
argument_list|,
name|getname
argument_list|(
name|ndo
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|addr
argument_list|)
argument_list|,
name|plen
argument_list|)
expr_stmt|;
return|return
literal|1
operator|+
name|plenbytes
return|;
name|trunc
label|:
return|return
operator|-
literal|2
return|;
name|badtlv
label|:
return|return
operator|-
literal|3
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|decode_labeled_prefix4
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|u_int
name|itemlen
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|struct
name|in_addr
name|addr
decl_stmt|;
name|u_int
name|plen
decl_stmt|,
name|plenbytes
decl_stmt|;
comment|/* prefix length and label = 4 bytes */
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ITEMCHECK
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|plen
operator|=
name|pptr
index|[
literal|0
index|]
expr_stmt|;
comment|/* get prefix length */
comment|/* this is one of the weirdnesses of rfc3107            the label length (actually the label + COS bits)            is added to the prefix length;            we also do only read out just one label -            there is no real application for advertisement of            stacked labels in a a single BGP message         */
if|if
condition|(
literal|24
operator|>
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|plen
operator|-=
literal|24
expr_stmt|;
comment|/* adjust prefixlen - labellength */
if|if
condition|(
literal|32
operator|<
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|itemlen
operator|-=
literal|4
expr_stmt|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|plenbytes
operator|=
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|4
index|]
argument_list|,
name|plenbytes
argument_list|)
expr_stmt|;
name|ITEMCHECK
argument_list|(
name|plenbytes
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|pptr
index|[
literal|4
index|]
argument_list|,
name|plenbytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|%
literal|8
condition|)
block|{
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|addr
operator|)
index|[
name|plenbytes
operator|-
literal|1
index|]
operator|&=
operator|(
operator|(
literal|0xff00
operator|>>
operator|(
name|plen
operator|%
literal|8
operator|)
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
comment|/* the label may get offsetted by 4 bits so lets shift it right */
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s/%d, label:%u %s"
argument_list|,
name|getname
argument_list|(
name|ndo
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|addr
argument_list|)
argument_list|,
name|plen
argument_list|,
name|EXTRACT_24BITS
argument_list|(
name|pptr
operator|+
literal|1
argument_list|)
operator|>>
literal|4
argument_list|,
operator|(
operator|(
name|pptr
index|[
literal|3
index|]
operator|&
literal|1
operator|)
operator|==
literal|0
operator|)
condition|?
literal|"(BOGUS: Bottom of Stack NOT set!)"
else|:
literal|"(bottom)"
argument_list|)
expr_stmt|;
return|return
literal|4
operator|+
name|plenbytes
return|;
name|trunc
label|:
return|return
operator|-
literal|2
return|;
name|badtlv
label|:
return|return
operator|-
literal|3
return|;
block|}
end_function

begin_comment
comment|/*  * bgp_vpn_ip_print  *  * print an ipv4 or ipv6 address into a buffer dependend on address length.  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|bgp_vpn_ip_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|u_int
name|addr_length
parameter_list|)
block|{
comment|/* worst case string is s fully formatted v6 address */
specifier|static
name|char
name|addr
index|[
sizeof|sizeof
argument_list|(
literal|"1234:5678:89ab:cdef:1234:5678:89ab:cdef"
argument_list|)
index|]
decl_stmt|;
name|char
modifier|*
name|pos
init|=
name|addr
decl_stmt|;
switch|switch
condition|(
name|addr_length
condition|)
block|{
case|case
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
operator|<<
literal|3
operator|)
case|:
comment|/* 32 */
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|<<
literal|3
operator|)
case|:
comment|/* 128 */
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|ip6addr_string
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|snprintf
argument_list|(
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|,
literal|"bogus address length %u"
argument_list|,
name|addr_length
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|+=
name|strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|trunc
label|:
operator|*
operator|(
name|pos
operator|)
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|addr
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * bgp_vpn_sg_print  *  * print an multicast s,g entry into a buffer.  * the s,g entry is encoded like this.  *  * +-----------------------------------+  * | Multicast Source Length (1 octet) |  * +-----------------------------------+  * |   Multicast Source (Variable)     |  * +-----------------------------------+  * |  Multicast Group Length (1 octet) |  * +-----------------------------------+  * |  Multicast Group   (Variable)     |  * +-----------------------------------+  *  * return the number of bytes read from the wire.  */
end_comment

begin_function
specifier|static
name|int
name|bgp_vpn_sg_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|uint8_t
name|addr_length
decl_stmt|;
name|u_int
name|total_length
decl_stmt|,
name|offset
decl_stmt|;
name|total_length
operator|=
literal|0
expr_stmt|;
comment|/* Source address length, encoded in bits */
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|addr_length
operator|=
operator|*
name|pptr
operator|++
expr_stmt|;
comment|/* Source address */
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
operator|(
name|addr_length
operator|>>
literal|3
operator|)
argument_list|)
expr_stmt|;
name|total_length
operator|+=
operator|(
name|addr_length
operator|>>
literal|3
operator|)
operator|+
literal|1
expr_stmt|;
name|offset
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr_length
condition|)
block|{
name|snprintf
argument_list|(
name|buf
operator|+
name|offset
argument_list|,
name|buflen
operator|-
name|offset
argument_list|,
literal|", Source %s"
argument_list|,
name|bgp_vpn_ip_print
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|,
name|addr_length
argument_list|)
argument_list|)
expr_stmt|;
name|pptr
operator|+=
operator|(
name|addr_length
operator|>>
literal|3
operator|)
expr_stmt|;
block|}
comment|/* Group address length, encoded in bits */
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|addr_length
operator|=
operator|*
name|pptr
operator|++
expr_stmt|;
comment|/* Group address */
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
operator|(
name|addr_length
operator|>>
literal|3
operator|)
argument_list|)
expr_stmt|;
name|total_length
operator|+=
operator|(
name|addr_length
operator|>>
literal|3
operator|)
operator|+
literal|1
expr_stmt|;
name|offset
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr_length
condition|)
block|{
name|snprintf
argument_list|(
name|buf
operator|+
name|offset
argument_list|,
name|buflen
operator|-
name|offset
argument_list|,
literal|", Group %s"
argument_list|,
name|bgp_vpn_ip_print
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|,
name|addr_length
argument_list|)
argument_list|)
expr_stmt|;
name|pptr
operator|+=
operator|(
name|addr_length
operator|>>
literal|3
operator|)
expr_stmt|;
block|}
name|trunc
label|:
return|return
operator|(
name|total_length
operator|)
return|;
block|}
end_function

begin_comment
comment|/* RDs and RTs share the same semantics  * we use bgp_vpn_rd_print for  * printing route targets inside a NLRI */
end_comment

begin_function
name|char
modifier|*
name|bgp_vpn_rd_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|)
block|{
comment|/* allocate space for the largest possible string */
specifier|static
name|char
name|rd
index|[
sizeof|sizeof
argument_list|(
literal|"xxxxxxxxxx:xxxxx (xxx.xxx.xxx.xxx:xxxxx)"
argument_list|)
index|]
decl_stmt|;
name|char
modifier|*
name|pos
init|=
name|rd
decl_stmt|;
comment|/* ok lets load the RD format */
switch|switch
condition|(
name|EXTRACT_16BITS
argument_list|(
name|pptr
argument_list|)
condition|)
block|{
comment|/* 2-byte-AS:number fmt*/
case|case
literal|0
case|:
name|snprintf
argument_list|(
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|rd
argument_list|)
operator|-
operator|(
name|pos
operator|-
name|rd
operator|)
argument_list|,
literal|"%u:%u (= %u.%u.%u.%u)"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|pptr
operator|+
literal|2
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|pptr
operator|+
literal|4
argument_list|)
argument_list|,
operator|*
operator|(
name|pptr
operator|+
literal|4
operator|)
argument_list|,
operator|*
operator|(
name|pptr
operator|+
literal|5
operator|)
argument_list|,
operator|*
operator|(
name|pptr
operator|+
literal|6
operator|)
argument_list|,
operator|*
operator|(
name|pptr
operator|+
literal|7
operator|)
argument_list|)
expr_stmt|;
break|break;
comment|/* IP-address:AS fmt*/
case|case
literal|1
case|:
name|snprintf
argument_list|(
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|rd
argument_list|)
operator|-
operator|(
name|pos
operator|-
name|rd
operator|)
argument_list|,
literal|"%u.%u.%u.%u:%u"
argument_list|,
operator|*
operator|(
name|pptr
operator|+
literal|2
operator|)
argument_list|,
operator|*
operator|(
name|pptr
operator|+
literal|3
operator|)
argument_list|,
operator|*
operator|(
name|pptr
operator|+
literal|4
operator|)
argument_list|,
operator|*
operator|(
name|pptr
operator|+
literal|5
operator|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|pptr
operator|+
literal|6
argument_list|)
argument_list|)
expr_stmt|;
break|break;
comment|/* 4-byte-AS:number fmt*/
case|case
literal|2
case|:
name|snprintf
argument_list|(
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|rd
argument_list|)
operator|-
operator|(
name|pos
operator|-
name|rd
operator|)
argument_list|,
literal|"%s:%u (%u.%u.%u.%u:%u)"
argument_list|,
name|as_printf
argument_list|(
name|ndo
argument_list|,
name|astostr
argument_list|,
sizeof|sizeof
argument_list|(
name|astostr
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|pptr
operator|+
literal|2
argument_list|)
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|pptr
operator|+
literal|6
argument_list|)
argument_list|,
operator|*
operator|(
name|pptr
operator|+
literal|2
operator|)
argument_list|,
operator|*
operator|(
name|pptr
operator|+
literal|3
operator|)
argument_list|,
operator|*
operator|(
name|pptr
operator|+
literal|4
operator|)
argument_list|,
operator|*
operator|(
name|pptr
operator|+
literal|5
operator|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|pptr
operator|+
literal|6
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|snprintf
argument_list|(
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|rd
argument_list|)
operator|-
operator|(
name|pos
operator|-
name|rd
operator|)
argument_list|,
literal|"unknown RD format"
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|+=
name|strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pos
operator|)
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|rd
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|decode_rt_routing_info
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|uint8_t
name|route_target
index|[
literal|8
index|]
decl_stmt|;
name|u_int
name|plen
decl_stmt|;
name|ND_TCHECK
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|plen
operator|=
name|pptr
index|[
literal|0
index|]
expr_stmt|;
comment|/* get prefix length */
if|if
condition|(
literal|0
operator|==
name|plen
condition|)
return|return
literal|1
return|;
comment|/* default route target */
if|if
condition|(
literal|32
operator|>
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|plen
operator|-=
literal|32
expr_stmt|;
comment|/* adjust prefix length */
if|if
condition|(
literal|64
operator|<
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|route_target
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|route_target
argument_list|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|1
index|]
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|route_target
argument_list|,
operator|&
name|pptr
index|[
literal|1
index|]
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|%
literal|8
condition|)
block|{
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|route_target
operator|)
index|[
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
operator|-
literal|1
index|]
operator|&=
operator|(
operator|(
literal|0xff00
operator|>>
operator|(
name|plen
operator|%
literal|8
operator|)
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"origin AS: %s, route target %s"
argument_list|,
name|as_printf
argument_list|(
name|ndo
argument_list|,
name|astostr
argument_list|,
sizeof|sizeof
argument_list|(
name|astostr
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|pptr
operator|+
literal|1
argument_list|)
argument_list|)
argument_list|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|route_target
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|5
operator|+
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
return|;
name|trunc
label|:
return|return
operator|-
literal|2
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|decode_labeled_vpn_prefix4
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|struct
name|in_addr
name|addr
decl_stmt|;
name|u_int
name|plen
decl_stmt|;
name|ND_TCHECK
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|plen
operator|=
name|pptr
index|[
literal|0
index|]
expr_stmt|;
comment|/* get prefix length */
if|if
condition|(
operator|(
literal|24
operator|+
literal|64
operator|)
operator|>
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|plen
operator|-=
operator|(
literal|24
operator|+
literal|64
operator|)
expr_stmt|;
comment|/* adjust prefixlen - labellength - RD len*/
if|if
condition|(
literal|32
operator|<
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|12
index|]
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|pptr
index|[
literal|12
index|]
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|%
literal|8
condition|)
block|{
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|addr
operator|)
index|[
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
operator|-
literal|1
index|]
operator|&=
operator|(
operator|(
literal|0xff00
operator|>>
operator|(
name|plen
operator|%
literal|8
operator|)
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
comment|/* the label may get offsetted by 4 bits so lets shift it right */
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"RD: %s, %s/%d, label:%u %s"
argument_list|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|pptr
operator|+
literal|4
argument_list|)
argument_list|,
name|getname
argument_list|(
name|ndo
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|addr
argument_list|)
argument_list|,
name|plen
argument_list|,
name|EXTRACT_24BITS
argument_list|(
name|pptr
operator|+
literal|1
argument_list|)
operator|>>
literal|4
argument_list|,
operator|(
operator|(
name|pptr
index|[
literal|3
index|]
operator|&
literal|1
operator|)
operator|==
literal|0
operator|)
condition|?
literal|"(BOGUS: Bottom of Stack NOT set!)"
else|:
literal|"(bottom)"
argument_list|)
expr_stmt|;
return|return
literal|12
operator|+
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
return|;
name|trunc
label|:
return|return
operator|-
literal|2
return|;
block|}
end_function

begin_comment
comment|/*  * +-------------------------------+  * |                               |  * |  RD:IPv4-address (12 octets)  |  * |                               |  * +-------------------------------+  * |  MDT Group-address (4 octets) |  * +-------------------------------+  */
end_comment

begin_define
define|#
directive|define
name|MDT_VPN_NLRI_LEN
value|16
end_define

begin_function
specifier|static
name|int
name|decode_mdt_vpn_nlri
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|rd
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|vpn_ip
decl_stmt|;
name|ND_TCHECK
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* if the NLRI is not predefined length, quit.*/
if|if
condition|(
operator|*
name|pptr
operator|!=
name|MDT_VPN_NLRI_LEN
operator|*
literal|8
condition|)
return|return
operator|-
literal|1
return|;
name|pptr
operator|++
expr_stmt|;
comment|/* RD */
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|rd
operator|=
name|pptr
expr_stmt|;
name|pptr
operator|+=
literal|8
expr_stmt|;
comment|/* IPv4 address */
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|vpn_ip
operator|=
name|pptr
expr_stmt|;
name|pptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
expr_stmt|;
comment|/* MDT Group Address */
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"RD: %s, VPN IP Address: %s, MC Group Address: %s"
argument_list|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|rd
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|vpn_ip
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|MDT_VPN_NLRI_LEN
operator|+
literal|1
return|;
name|trunc
label|:
return|return
operator|-
literal|2
return|;
block|}
end_function

begin_define
define|#
directive|define
name|BGP_MULTICAST_VPN_ROUTE_TYPE_INTRA_AS_I_PMSI
value|1
end_define

begin_define
define|#
directive|define
name|BGP_MULTICAST_VPN_ROUTE_TYPE_INTER_AS_I_PMSI
value|2
end_define

begin_define
define|#
directive|define
name|BGP_MULTICAST_VPN_ROUTE_TYPE_S_PMSI
value|3
end_define

begin_define
define|#
directive|define
name|BGP_MULTICAST_VPN_ROUTE_TYPE_INTRA_AS_SEG_LEAF
value|4
end_define

begin_define
define|#
directive|define
name|BGP_MULTICAST_VPN_ROUTE_TYPE_SOURCE_ACTIVE
value|5
end_define

begin_define
define|#
directive|define
name|BGP_MULTICAST_VPN_ROUTE_TYPE_SHARED_TREE_JOIN
value|6
end_define

begin_define
define|#
directive|define
name|BGP_MULTICAST_VPN_ROUTE_TYPE_SOURCE_TREE_JOIN
value|7
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tok
name|bgp_multicast_vpn_route_type_values
index|[]
init|=
block|{
block|{
name|BGP_MULTICAST_VPN_ROUTE_TYPE_INTRA_AS_I_PMSI
block|,
literal|"Intra-AS I-PMSI"
block|}
block|,
block|{
name|BGP_MULTICAST_VPN_ROUTE_TYPE_INTER_AS_I_PMSI
block|,
literal|"Inter-AS I-PMSI"
block|}
block|,
block|{
name|BGP_MULTICAST_VPN_ROUTE_TYPE_S_PMSI
block|,
literal|"S-PMSI"
block|}
block|,
block|{
name|BGP_MULTICAST_VPN_ROUTE_TYPE_INTRA_AS_SEG_LEAF
block|,
literal|"Intra-AS Segment-Leaf"
block|}
block|,
block|{
name|BGP_MULTICAST_VPN_ROUTE_TYPE_SOURCE_ACTIVE
block|,
literal|"Source-Active"
block|}
block|,
block|{
name|BGP_MULTICAST_VPN_ROUTE_TYPE_SHARED_TREE_JOIN
block|,
literal|"Shared Tree Join"
block|}
block|,
block|{
name|BGP_MULTICAST_VPN_ROUTE_TYPE_SOURCE_TREE_JOIN
block|,
literal|"Source Tree Join"
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|decode_multicast_vpn
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|uint8_t
name|route_type
decl_stmt|,
name|route_length
decl_stmt|,
name|addr_length
decl_stmt|,
name|sg_length
decl_stmt|;
name|u_int
name|offset
decl_stmt|;
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|route_type
operator|=
operator|*
name|pptr
operator|++
expr_stmt|;
name|route_length
operator|=
operator|*
name|pptr
operator|++
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"Route-Type: %s (%u), length: %u"
argument_list|,
name|tok2str
argument_list|(
name|bgp_multicast_vpn_route_type_values
argument_list|,
literal|"Unknown"
argument_list|,
name|route_type
argument_list|)
argument_list|,
name|route_type
argument_list|,
name|route_length
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|route_type
condition|)
block|{
case|case
name|BGP_MULTICAST_VPN_ROUTE_TYPE_INTRA_AS_I_PMSI
case|:
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
name|BGP_VPN_RD_LEN
argument_list|)
expr_stmt|;
name|offset
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
operator|+
name|offset
argument_list|,
name|buflen
operator|-
name|offset
argument_list|,
literal|", RD: %s, Originator %s"
argument_list|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|)
argument_list|,
name|bgp_vpn_ip_print
argument_list|(
name|ndo
argument_list|,
name|pptr
operator|+
name|BGP_VPN_RD_LEN
argument_list|,
operator|(
name|route_length
operator|-
name|BGP_VPN_RD_LEN
operator|)
operator|<<
literal|3
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_MULTICAST_VPN_ROUTE_TYPE_INTER_AS_I_PMSI
case|:
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
name|BGP_VPN_RD_LEN
operator|+
literal|4
argument_list|)
expr_stmt|;
name|offset
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
operator|+
name|offset
argument_list|,
name|buflen
operator|-
name|offset
argument_list|,
literal|", RD: %s, Source-AS %s"
argument_list|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|)
argument_list|,
name|as_printf
argument_list|(
name|ndo
argument_list|,
name|astostr
argument_list|,
sizeof|sizeof
argument_list|(
name|astostr
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|pptr
operator|+
name|BGP_VPN_RD_LEN
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_MULTICAST_VPN_ROUTE_TYPE_S_PMSI
case|:
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
name|BGP_VPN_RD_LEN
argument_list|)
expr_stmt|;
name|offset
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
operator|+
name|offset
argument_list|,
name|buflen
operator|-
name|offset
argument_list|,
literal|", RD: %s"
argument_list|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|)
argument_list|)
expr_stmt|;
name|pptr
operator|+=
name|BGP_VPN_RD_LEN
expr_stmt|;
name|sg_length
operator|=
name|bgp_vpn_sg_print
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|addr_length
operator|=
name|route_length
operator|-
name|sg_length
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
name|addr_length
argument_list|)
expr_stmt|;
name|offset
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
operator|+
name|offset
argument_list|,
name|buflen
operator|-
name|offset
argument_list|,
literal|", Originator %s"
argument_list|,
name|bgp_vpn_ip_print
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|,
name|addr_length
operator|<<
literal|3
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_MULTICAST_VPN_ROUTE_TYPE_SOURCE_ACTIVE
case|:
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
name|BGP_VPN_RD_LEN
argument_list|)
expr_stmt|;
name|offset
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
operator|+
name|offset
argument_list|,
name|buflen
operator|-
name|offset
argument_list|,
literal|", RD: %s"
argument_list|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|)
argument_list|)
expr_stmt|;
name|pptr
operator|+=
name|BGP_VPN_RD_LEN
expr_stmt|;
name|bgp_vpn_sg_print
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_MULTICAST_VPN_ROUTE_TYPE_SHARED_TREE_JOIN
case|:
comment|/* fall through */
case|case
name|BGP_MULTICAST_VPN_ROUTE_TYPE_SOURCE_TREE_JOIN
case|:
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
name|BGP_VPN_RD_LEN
argument_list|)
expr_stmt|;
name|offset
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
operator|+
name|offset
argument_list|,
name|buflen
operator|-
name|offset
argument_list|,
literal|", RD: %s, Source-AS %s"
argument_list|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|)
argument_list|,
name|as_printf
argument_list|(
name|ndo
argument_list|,
name|astostr
argument_list|,
sizeof|sizeof
argument_list|(
name|astostr
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|pptr
operator|+
name|BGP_VPN_RD_LEN
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|pptr
operator|+=
name|BGP_VPN_RD_LEN
expr_stmt|;
name|bgp_vpn_sg_print
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
break|break;
comment|/*              * no per route-type printing yet.              */
case|case
name|BGP_MULTICAST_VPN_ROUTE_TYPE_INTRA_AS_SEG_LEAF
case|:
default|default:
break|break;
block|}
return|return
name|route_length
operator|+
literal|2
return|;
name|trunc
label|:
return|return
operator|-
literal|2
return|;
block|}
end_function

begin_comment
comment|/*  * As I remember, some versions of systems have an snprintf() that  * returns -1 if the buffer would have overflowed.  If the return  * value is negative, set buflen to 0, to indicate that we've filled  * the buffer up.  *  * If the return value is greater than buflen, that means that  * the buffer would have overflowed; again, set buflen to 0 in  * that case.  */
end_comment

begin_define
define|#
directive|define
name|UPDATE_BUF_BUFLEN
parameter_list|(
name|buf
parameter_list|,
name|buflen
parameter_list|,
name|strlen
parameter_list|)
define|\
value|if (strlen<0) \        	buflen=0; \     else if ((u_int)strlen>buflen) \         buflen=0; \     else { \         buflen-=strlen; \ 	buf+=strlen; \     }
end_define

begin_function
specifier|static
name|int
name|decode_labeled_vpn_l2
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|int
name|plen
decl_stmt|,
name|tlen
decl_stmt|,
name|strlen
decl_stmt|,
name|tlv_type
decl_stmt|,
name|tlv_len
decl_stmt|,
name|ttlv_len
decl_stmt|;
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|plen
operator|=
name|EXTRACT_16BITS
argument_list|(
name|pptr
argument_list|)
expr_stmt|;
name|tlen
operator|=
name|plen
expr_stmt|;
name|pptr
operator|+=
literal|2
expr_stmt|;
comment|/* Old and new L2VPN NLRI share AFI/SAFI          *   -> Assume a 12 Byte-length NLRI is auto-discovery-only          *      and> 17 as old format. Complain for the middle case          */
if|if
condition|(
name|plen
operator|==
literal|12
condition|)
block|{
comment|/* assume AD-only with RD, BGPNH */
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|strlen
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"RD: %s, BGPNH: %s"
argument_list|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|)
argument_list|,
comment|/* need something like getname(ndo, ) here */
name|getname
argument_list|(
name|ndo
argument_list|,
name|pptr
operator|+
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|UPDATE_BUF_BUFLEN
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
name|strlen
argument_list|)
expr_stmt|;
name|pptr
operator|+=
literal|12
expr_stmt|;
name|tlen
operator|-=
literal|12
expr_stmt|;
return|return
name|plen
return|;
block|}
elseif|else
if|if
condition|(
name|plen
operator|>
literal|17
condition|)
block|{
comment|/* assume old format */
comment|/* RD, ID, LBLKOFF, LBLBASE */
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|strlen
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"RD: %s, CE-ID: %u, Label-Block Offset: %u, Label Base %u"
argument_list|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|pptr
operator|+
literal|8
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|pptr
operator|+
literal|10
argument_list|)
argument_list|,
name|EXTRACT_24BITS
argument_list|(
name|pptr
operator|+
literal|12
argument_list|)
operator|>>
literal|4
argument_list|)
expr_stmt|;
comment|/* the label is offsetted by 4 bits so lets shift it right */
name|UPDATE_BUF_BUFLEN
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
name|strlen
argument_list|)
expr_stmt|;
name|pptr
operator|+=
literal|15
expr_stmt|;
name|tlen
operator|-=
literal|15
expr_stmt|;
comment|/* ok now the variable part - lets read out TLVs*/
while|while
condition|(
name|tlen
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|tlen
operator|<
literal|3
condition|)
return|return
operator|-
literal|1
return|;
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|tlv_type
operator|=
operator|*
name|pptr
operator|++
expr_stmt|;
name|tlv_len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|pptr
argument_list|)
expr_stmt|;
name|ttlv_len
operator|=
name|tlv_len
expr_stmt|;
name|pptr
operator|+=
literal|2
expr_stmt|;
switch|switch
condition|(
name|tlv_type
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|buflen
operator|!=
literal|0
condition|)
block|{
name|strlen
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"\n\t\tcircuit status vector (%u) length: %u: 0x"
argument_list|,
name|tlv_type
argument_list|,
name|tlv_len
argument_list|)
expr_stmt|;
name|UPDATE_BUF_BUFLEN
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
name|strlen
argument_list|)
expr_stmt|;
block|}
name|ttlv_len
operator|=
name|ttlv_len
operator|/
literal|8
operator|+
literal|1
expr_stmt|;
comment|/* how many bytes do we need to read ? */
while|while
condition|(
name|ttlv_len
operator|>
literal|0
condition|)
block|{
name|ND_TCHECK
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|buflen
operator|!=
literal|0
condition|)
block|{
name|strlen
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%02x"
argument_list|,
operator|*
name|pptr
operator|++
argument_list|)
expr_stmt|;
name|UPDATE_BUF_BUFLEN
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
name|strlen
argument_list|)
expr_stmt|;
block|}
name|ttlv_len
operator|--
expr_stmt|;
block|}
break|break;
default|default:
if|if
condition|(
name|buflen
operator|!=
literal|0
condition|)
block|{
name|strlen
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"\n\t\tunknown TLV #%u, length: %u"
argument_list|,
name|tlv_type
argument_list|,
name|tlv_len
argument_list|)
expr_stmt|;
name|UPDATE_BUF_BUFLEN
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
name|strlen
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|tlen
operator|-=
operator|(
name|tlv_len
operator|<<
literal|3
operator|)
expr_stmt|;
comment|/* the tlv-length is expressed in bits so lets shift it right */
block|}
return|return
name|plen
operator|+
literal|2
return|;
block|}
else|else
block|{
comment|/* complain bitterly ? */
comment|/* fall through */
goto|goto
name|trunc
goto|;
block|}
name|trunc
label|:
return|return
operator|-
literal|2
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function
name|int
name|decode_prefix6
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pd
parameter_list|,
name|u_int
name|itemlen
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|struct
name|in6_addr
name|addr
decl_stmt|;
name|u_int
name|plen
decl_stmt|,
name|plenbytes
decl_stmt|;
name|ND_TCHECK
argument_list|(
name|pd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ITEMCHECK
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|plen
operator|=
name|pd
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
literal|128
operator|<
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|itemlen
operator|-=
literal|1
expr_stmt|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|plenbytes
operator|=
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|pd
index|[
literal|1
index|]
argument_list|,
name|plenbytes
argument_list|)
expr_stmt|;
name|ITEMCHECK
argument_list|(
name|plenbytes
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|pd
index|[
literal|1
index|]
argument_list|,
name|plenbytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|%
literal|8
condition|)
block|{
name|addr
operator|.
name|s6_addr
index|[
name|plenbytes
operator|-
literal|1
index|]
operator|&=
operator|(
operator|(
literal|0xff00
operator|>>
operator|(
name|plen
operator|%
literal|8
operator|)
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s/%d"
argument_list|,
name|getname6
argument_list|(
name|ndo
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|addr
argument_list|)
argument_list|,
name|plen
argument_list|)
expr_stmt|;
return|return
literal|1
operator|+
name|plenbytes
return|;
name|trunc
label|:
return|return
operator|-
literal|2
return|;
name|badtlv
label|:
return|return
operator|-
literal|3
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|decode_labeled_prefix6
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|u_int
name|itemlen
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|struct
name|in6_addr
name|addr
decl_stmt|;
name|u_int
name|plen
decl_stmt|,
name|plenbytes
decl_stmt|;
comment|/* prefix length and label = 4 bytes */
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ITEMCHECK
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|plen
operator|=
name|pptr
index|[
literal|0
index|]
expr_stmt|;
comment|/* get prefix length */
if|if
condition|(
literal|24
operator|>
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|plen
operator|-=
literal|24
expr_stmt|;
comment|/* adjust prefixlen - labellength */
if|if
condition|(
literal|128
operator|<
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|itemlen
operator|-=
literal|4
expr_stmt|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|plenbytes
operator|=
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|4
index|]
argument_list|,
name|plenbytes
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|pptr
index|[
literal|4
index|]
argument_list|,
name|plenbytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|%
literal|8
condition|)
block|{
name|addr
operator|.
name|s6_addr
index|[
name|plenbytes
operator|-
literal|1
index|]
operator|&=
operator|(
operator|(
literal|0xff00
operator|>>
operator|(
name|plen
operator|%
literal|8
operator|)
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
comment|/* the label may get offsetted by 4 bits so lets shift it right */
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s/%d, label:%u %s"
argument_list|,
name|getname6
argument_list|(
name|ndo
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|addr
argument_list|)
argument_list|,
name|plen
argument_list|,
name|EXTRACT_24BITS
argument_list|(
name|pptr
operator|+
literal|1
argument_list|)
operator|>>
literal|4
argument_list|,
operator|(
operator|(
name|pptr
index|[
literal|3
index|]
operator|&
literal|1
operator|)
operator|==
literal|0
operator|)
condition|?
literal|"(BOGUS: Bottom of Stack NOT set!)"
else|:
literal|"(bottom)"
argument_list|)
expr_stmt|;
return|return
literal|4
operator|+
name|plenbytes
return|;
name|trunc
label|:
return|return
operator|-
literal|2
return|;
name|badtlv
label|:
return|return
operator|-
literal|3
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|decode_labeled_vpn_prefix6
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|struct
name|in6_addr
name|addr
decl_stmt|;
name|u_int
name|plen
decl_stmt|;
name|ND_TCHECK
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|plen
operator|=
name|pptr
index|[
literal|0
index|]
expr_stmt|;
comment|/* get prefix length */
if|if
condition|(
operator|(
literal|24
operator|+
literal|64
operator|)
operator|>
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|plen
operator|-=
operator|(
literal|24
operator|+
literal|64
operator|)
expr_stmt|;
comment|/* adjust prefixlen - labellength - RD len*/
if|if
condition|(
literal|128
operator|<
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|12
index|]
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|pptr
index|[
literal|12
index|]
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|%
literal|8
condition|)
block|{
name|addr
operator|.
name|s6_addr
index|[
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
operator|-
literal|1
index|]
operator|&=
operator|(
operator|(
literal|0xff00
operator|>>
operator|(
name|plen
operator|%
literal|8
operator|)
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
comment|/* the label may get offsetted by 4 bits so lets shift it right */
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"RD: %s, %s/%d, label:%u %s"
argument_list|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|pptr
operator|+
literal|4
argument_list|)
argument_list|,
name|getname6
argument_list|(
name|ndo
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|addr
argument_list|)
argument_list|,
name|plen
argument_list|,
name|EXTRACT_24BITS
argument_list|(
name|pptr
operator|+
literal|1
argument_list|)
operator|>>
literal|4
argument_list|,
operator|(
operator|(
name|pptr
index|[
literal|3
index|]
operator|&
literal|1
operator|)
operator|==
literal|0
operator|)
condition|?
literal|"(BOGUS: Bottom of Stack NOT set!)"
else|:
literal|"(bottom)"
argument_list|)
expr_stmt|;
return|return
literal|12
operator|+
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
return|;
name|trunc
label|:
return|return
operator|-
literal|2
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|decode_clnp_prefix
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|uint8_t
name|addr
index|[
literal|19
index|]
decl_stmt|;
name|u_int
name|plen
decl_stmt|;
name|ND_TCHECK
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|plen
operator|=
name|pptr
index|[
literal|0
index|]
expr_stmt|;
comment|/* get prefix length */
if|if
condition|(
literal|152
operator|<
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|4
index|]
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|pptr
index|[
literal|4
index|]
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|%
literal|8
condition|)
block|{
name|addr
index|[
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
operator|-
literal|1
index|]
operator|&=
operator|(
operator|(
literal|0xff00
operator|>>
operator|(
name|plen
operator|%
literal|8
operator|)
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s/%d"
argument_list|,
name|isonsap_string
argument_list|(
name|addr
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
argument_list|,
name|plen
argument_list|)
expr_stmt|;
return|return
literal|1
operator|+
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
return|;
name|trunc
label|:
return|return
operator|-
literal|2
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|decode_labeled_vpn_clnp_prefix
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|uint8_t
name|addr
index|[
literal|19
index|]
decl_stmt|;
name|u_int
name|plen
decl_stmt|;
name|ND_TCHECK
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|plen
operator|=
name|pptr
index|[
literal|0
index|]
expr_stmt|;
comment|/* get prefix length */
if|if
condition|(
operator|(
literal|24
operator|+
literal|64
operator|)
operator|>
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|plen
operator|-=
operator|(
literal|24
operator|+
literal|64
operator|)
expr_stmt|;
comment|/* adjust prefixlen - labellength - RD len*/
if|if
condition|(
literal|152
operator|<
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|12
index|]
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|pptr
index|[
literal|12
index|]
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|%
literal|8
condition|)
block|{
name|addr
index|[
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
operator|-
literal|1
index|]
operator|&=
operator|(
operator|(
literal|0xff00
operator|>>
operator|(
name|plen
operator|%
literal|8
operator|)
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
comment|/* the label may get offsetted by 4 bits so lets shift it right */
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"RD: %s, %s/%d, label:%u %s"
argument_list|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|pptr
operator|+
literal|4
argument_list|)
argument_list|,
name|isonsap_string
argument_list|(
name|addr
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
argument_list|,
name|plen
argument_list|,
name|EXTRACT_24BITS
argument_list|(
name|pptr
operator|+
literal|1
argument_list|)
operator|>>
literal|4
argument_list|,
operator|(
operator|(
name|pptr
index|[
literal|3
index|]
operator|&
literal|1
operator|)
operator|==
literal|0
operator|)
condition|?
literal|"(BOGUS: Bottom of Stack NOT set!)"
else|:
literal|"(bottom)"
argument_list|)
expr_stmt|;
return|return
literal|12
operator|+
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
return|;
name|trunc
label|:
return|return
operator|-
literal|2
return|;
block|}
end_function

begin_comment
comment|/*  * bgp_attr_get_as_size  *  * Try to find the size of the ASs encoded in an as-path. It is not obvious, as  * both Old speakers that do not support 4 byte AS, and the new speakers that do  * support, exchange AS-Path with the same path-attribute type value 0x02.  */
end_comment

begin_function
specifier|static
name|int
name|bgp_attr_get_as_size
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|uint8_t
name|bgpa_type
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|tptr
init|=
name|pptr
decl_stmt|;
comment|/*      * If the path attribute is the optional AS4 path type, then we already      * know, that ASs must be encoded in 4 byte format.      */
if|if
condition|(
name|bgpa_type
operator|==
name|BGPTYPE_AS4_PATH
condition|)
block|{
return|return
literal|4
return|;
block|}
comment|/*      * Let us assume that ASs are of 2 bytes in size, and check if the AS-Path      * TLV is good. If not, ask the caller to try with AS encoded as 4 bytes      * each.      */
while|while
condition|(
name|tptr
operator|<
name|pptr
operator|+
name|len
condition|)
block|{
name|ND_TCHECK
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/*          * If we do not find a valid segment type, our guess might be wrong.          */
if|if
condition|(
name|tptr
index|[
literal|0
index|]
operator|<
name|BGP_AS_SEG_TYPE_MIN
operator|||
name|tptr
index|[
literal|0
index|]
operator|>
name|BGP_AS_SEG_TYPE_MAX
condition|)
block|{
goto|goto
name|trunc
goto|;
block|}
name|ND_TCHECK
argument_list|(
name|tptr
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|2
operator|+
name|tptr
index|[
literal|1
index|]
operator|*
literal|2
expr_stmt|;
block|}
comment|/*      * If we correctly reached end of the AS path attribute data content,      * then most likely ASs were indeed encoded as 2 bytes.      */
if|if
condition|(
name|tptr
operator|==
name|pptr
operator|+
name|len
condition|)
block|{
return|return
literal|2
return|;
block|}
name|trunc
label|:
comment|/*      * We can come here, either we did not have enough data, or if we      * try to decode 4 byte ASs in 2 byte format. Either way, return 4,      * so that calller can try to decode each AS as of 4 bytes. If indeed      * there was not enough data, it will crib and end the parse anyways.      */
return|return
literal|4
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bgp_attr_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
name|u_int
name|atype
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint16_t
name|af
decl_stmt|;
name|uint8_t
name|safi
decl_stmt|,
name|snpa
decl_stmt|,
name|nhlen
decl_stmt|;
union|union
block|{
comment|/* copy buffer for bandwidth values */
name|float
name|f
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
block|}
name|bw
union|;
name|int
name|advance
decl_stmt|;
name|u_int
name|tlen
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|tptr
decl_stmt|;
name|char
name|buf
index|[
name|MAXHOSTNAMELEN
operator|+
literal|100
index|]
decl_stmt|;
name|char
name|tokbuf
index|[
name|TOKBUFSIZE
index|]
decl_stmt|;
name|int
name|as_size
decl_stmt|;
name|tptr
operator|=
name|pptr
expr_stmt|;
name|tlen
operator|=
name|len
expr_stmt|;
switch|switch
condition|(
name|atype
condition|)
block|{
case|case
name|BGPTYPE_ORIGIN
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
else|else
block|{
name|ND_TCHECK
argument_list|(
operator|*
name|tptr
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_origin_values
argument_list|,
literal|"Unknown Origin Typecode"
argument_list|,
name|tptr
index|[
literal|0
index|]
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
comment|/*          * Process AS4 byte path and AS2 byte path attributes here.          */
case|case
name|BGPTYPE_AS4_PATH
case|:
case|case
name|BGPTYPE_AS_PATH
case|:
if|if
condition|(
name|len
operator|%
literal|2
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|len
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"empty"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*                  * BGP updates exchanged between New speakers that support 4                  * byte AS, ASs are always encoded in 4 bytes. There is no                  * definitive way to find this, just by the packet's                  * contents. So, check for packet's TLV's sanity assuming                  * 2 bytes first, and it does not pass, assume that ASs are                  * encoded in 4 bytes format and move on.                  */
name|as_size
operator|=
name|bgp_attr_get_as_size
argument_list|(
name|ndo
argument_list|,
name|atype
argument_list|,
name|pptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
while|while
condition|(
name|tptr
operator|<
name|pptr
operator|+
name|len
condition|)
block|{
name|ND_TCHECK
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_as_path_segment_open_values
argument_list|,
literal|"?"
argument_list|,
name|tptr
index|[
literal|0
index|]
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tptr
index|[
literal|1
index|]
operator|*
name|as_size
condition|;
name|i
operator|+=
name|as_size
control|)
block|{
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|2
operator|+
name|i
index|]
argument_list|,
name|as_size
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s "
operator|,
name|as_printf
argument_list|(
name|ndo
argument_list|,
name|astostr
argument_list|,
sizeof|sizeof
argument_list|(
name|astostr
argument_list|)
argument_list|,
name|as_size
operator|==
literal|2
condition|?
name|EXTRACT_16BITS
argument_list|(
operator|&
name|tptr
index|[
literal|2
operator|+
name|i
index|]
argument_list|)
else|:
name|EXTRACT_32BITS
argument_list|(
operator|&
name|tptr
index|[
literal|2
operator|+
name|i
index|]
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|ND_TCHECK
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_as_path_segment_close_values
argument_list|,
literal|"?"
argument_list|,
name|tptr
index|[
literal|0
index|]
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK
argument_list|(
name|tptr
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|2
operator|+
name|tptr
index|[
literal|1
index|]
operator|*
name|as_size
expr_stmt|;
block|}
break|break;
case|case
name|BGPTYPE_NEXT_HOP
case|:
if|if
condition|(
name|len
operator|!=
literal|4
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
else|else
block|{
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|BGPTYPE_MULTI_EXIT_DISC
case|:
case|case
name|BGPTYPE_LOCAL_PREF
case|:
if|if
condition|(
name|len
operator|!=
literal|4
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
else|else
block|{
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%u"
operator|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|BGPTYPE_ATOMIC_AGGREGATE
case|:
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGPTYPE_AGGREGATOR
case|:
comment|/*                  * Depending on the AS encoded is of 2 bytes or of 4 bytes,                  * the length of this PA can be either 6 bytes or 8 bytes.                  */
if|if
condition|(
name|len
operator|!=
literal|6
operator|&&
name|len
operator|!=
literal|8
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|6
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" AS #%s, origin %s"
operator|,
name|as_printf
argument_list|(
name|ndo
argument_list|,
name|astostr
argument_list|,
sizeof|sizeof
argument_list|(
name|astostr
argument_list|)
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
argument_list|)
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|+
literal|2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" AS #%s, origin %s"
operator|,
name|as_printf
argument_list|(
name|ndo
argument_list|,
name|astostr
argument_list|,
sizeof|sizeof
argument_list|(
name|astostr
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
argument_list|)
argument_list|)
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|+
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|BGPTYPE_AGGREGATOR4
case|:
if|if
condition|(
name|len
operator|!=
literal|8
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" AS #%s, origin %s"
operator|,
name|as_printf
argument_list|(
name|ndo
argument_list|,
name|astostr
argument_list|,
sizeof|sizeof
argument_list|(
name|astostr
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
argument_list|)
argument_list|)
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|+
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGPTYPE_COMMUNITIES
case|:
if|if
condition|(
name|len
operator|%
literal|4
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
while|while
condition|(
name|tlen
operator|>
literal|0
condition|)
block|{
name|uint32_t
name|comm
decl_stmt|;
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|comm
operator|=
name|EXTRACT_32BITS
argument_list|(
name|tptr
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|comm
condition|)
block|{
case|case
name|BGP_COMMUNITY_NO_EXPORT
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" NO_EXPORT"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_COMMUNITY_NO_ADVERT
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" NO_ADVERTISE"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_COMMUNITY_NO_EXPORT_SUBCONFED
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" NO_EXPORT_SUBCONFED"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%u:%u%s"
operator|,
operator|(
name|comm
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
operator|,
name|comm
operator|&
literal|0xffff
operator|,
operator|(
name|tlen
operator|>
literal|4
operator|)
condition|?
literal|", "
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|tlen
operator|-=
literal|4
expr_stmt|;
name|tptr
operator|+=
literal|4
expr_stmt|;
block|}
break|break;
case|case
name|BGPTYPE_ORIGINATOR_ID
case|:
if|if
condition|(
name|len
operator|!=
literal|4
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGPTYPE_CLUSTER_LIST
case|:
if|if
condition|(
name|len
operator|%
literal|4
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
while|while
condition|(
name|tlen
operator|>
literal|0
condition|)
block|{
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s%s"
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|,
operator|(
name|tlen
operator|>
literal|4
operator|)
condition|?
literal|", "
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
name|tlen
operator|-=
literal|4
expr_stmt|;
name|tptr
operator|+=
literal|4
expr_stmt|;
block|}
break|break;
case|case
name|BGPTYPE_MP_REACH_NLRI
case|:
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|af
operator|=
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
expr_stmt|;
name|safi
operator|=
name|tptr
index|[
literal|2
index|]
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    AFI: %s (%u), %sSAFI: %s (%u)"
operator|,
name|tok2strbuf
argument_list|(
name|af_values
argument_list|,
literal|"Unknown AFI"
argument_list|,
name|af
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|af
operator|,
operator|(
name|safi
operator|>
literal|128
operator|)
condition|?
literal|"vendor specific "
else|:
literal|""
operator|,
comment|/* 128 is meanwhile wellknown */
name|tok2strbuf
argument_list|(
name|bgp_safi_values
argument_list|,
literal|"Unknown SAFI"
argument_list|,
name|safi
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|safi
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|af
operator|<<
literal|8
operator||
name|safi
condition|)
block|{
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_UNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_UNIMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_LABUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_RT_ROUTING_INFO
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST_VPN
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_MDT
operator|)
case|:
ifdef|#
directive|ifdef
name|INET6
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_UNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_UNIMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_LABUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
endif|#
directive|endif
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_UNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_UNIMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_L2VPN
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_L2VPN
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_L2VPN
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_VPLS
operator|<<
literal|8
operator||
name|SAFNUM_VPLS
operator|)
case|:
break|break;
default|default:
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    no AFI %u / SAFI %u decoder"
operator|,
name|af
operator|,
name|safi
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
literal|"\n\t    "
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
break|break;
block|}
name|tptr
operator|+=
literal|3
expr_stmt|;
name|ND_TCHECK
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|nhlen
operator|=
name|tptr
index|[
literal|0
index|]
expr_stmt|;
name|tlen
operator|=
name|nhlen
expr_stmt|;
name|tptr
operator|++
expr_stmt|;
if|if
condition|(
name|tlen
condition|)
block|{
name|int
name|nnh
init|=
literal|0
decl_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    nexthop: "
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|tlen
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|nnh
operator|++
operator|>
literal|0
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", "
operator|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|af
operator|<<
literal|8
operator||
name|safi
condition|)
block|{
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_UNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_UNIMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_LABUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_RT_ROUTING_INFO
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST_VPN
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_MDT
operator|)
case|:
if|if
condition|(
name|tlen
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
name|tlen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tlen
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
expr_stmt|;
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
if|if
condition|(
name|tlen
operator|<
call|(
name|int
call|)
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
operator|+
name|BGP_VPN_RD_LEN
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
name|tlen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
operator|+
name|BGP_VPN_RD_LEN
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"RD: %s, %s"
operator|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|+
name|BGP_VPN_RD_LEN
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tlen
operator|-=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
operator|+
name|BGP_VPN_RD_LEN
operator|)
expr_stmt|;
name|tptr
operator|+=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
operator|+
name|BGP_VPN_RD_LEN
operator|)
expr_stmt|;
block|}
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_UNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_UNIMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_LABUNICAST
operator|)
case|:
if|if
condition|(
name|tlen
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
name|tlen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|getname6
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tlen
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
expr_stmt|;
name|tptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
if|if
condition|(
name|tlen
operator|<
call|(
name|int
call|)
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|+
name|BGP_VPN_RD_LEN
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
name|tlen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|+
name|BGP_VPN_RD_LEN
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"RD: %s, %s"
operator|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|,
name|getname6
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|+
name|BGP_VPN_RD_LEN
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tlen
operator|-=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|+
name|BGP_VPN_RD_LEN
operator|)
expr_stmt|;
name|tptr
operator|+=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|+
name|BGP_VPN_RD_LEN
operator|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
case|case
operator|(
name|AFNUM_VPLS
operator|<<
literal|8
operator||
name|SAFNUM_VPLS
operator|)
case|:
case|case
operator|(
name|AFNUM_L2VPN
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_L2VPN
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_L2VPN
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
if|if
condition|(
name|tlen
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
name|tlen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tlen
operator|-=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
operator|)
expr_stmt|;
name|tptr
operator|+=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
operator|)
expr_stmt|;
block|}
break|break;
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_UNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_UNIMULTICAST
operator|)
case|:
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|isonsap_string
argument_list|(
name|tptr
argument_list|,
name|tlen
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tptr
operator|+=
name|tlen
expr_stmt|;
name|tlen
operator|=
literal|0
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
if|if
condition|(
name|tlen
operator|<
name|BGP_VPN_RD_LEN
operator|+
literal|1
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
name|tlen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"RD: %s, %s"
operator|,
name|bgp_vpn_rd_print
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|,
name|isonsap_string
argument_list|(
name|tptr
operator|+
name|BGP_VPN_RD_LEN
argument_list|,
name|tlen
operator|-
name|BGP_VPN_RD_LEN
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* rfc986 mapped IPv4 address ? */
if|if
condition|(
name|EXTRACT_32BITS
argument_list|(
name|tptr
operator|+
name|BGP_VPN_RD_LEN
argument_list|)
operator|==
literal|0x47000601
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" = %s"
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|+
name|BGP_VPN_RD_LEN
operator|+
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
comment|/* rfc1888 mapped IPv6 address ? */
elseif|else
if|if
condition|(
name|EXTRACT_24BITS
argument_list|(
name|tptr
operator|+
name|BGP_VPN_RD_LEN
argument_list|)
operator|==
literal|0x350000
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" = %s"
operator|,
name|getname6
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|+
name|BGP_VPN_RD_LEN
operator|+
literal|3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|tptr
operator|+=
name|tlen
expr_stmt|;
name|tlen
operator|=
literal|0
expr_stmt|;
block|}
break|break;
default|default:
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"no AFI %u/SAFI %u decoder"
operator|,
name|af
operator|,
name|safi
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
literal|"\n\t    "
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|tptr
operator|+=
name|tlen
expr_stmt|;
name|tlen
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
break|break;
block|}
block|}
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", nh-length: %u"
operator|,
name|nhlen
operator|)
argument_list|)
expr_stmt|;
name|tptr
operator|+=
name|tlen
expr_stmt|;
name|ND_TCHECK
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|snpa
operator|=
name|tptr
index|[
literal|0
index|]
expr_stmt|;
name|tptr
operator|++
expr_stmt|;
if|if
condition|(
name|snpa
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    %u SNPA"
operator|,
name|snpa
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
comment|/*nothing*/
init|;
name|snpa
operator|>
literal|0
condition|;
name|snpa
operator|--
control|)
block|{
name|ND_TCHECK
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %d bytes"
operator|,
name|tptr
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
name|tptr
operator|+=
name|tptr
index|[
literal|0
index|]
operator|+
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", no SNPA"
operator|)
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|len
operator|-
operator|(
name|tptr
operator|-
name|pptr
operator|)
operator|>
literal|0
condition|)
block|{
switch|switch
condition|(
name|af
operator|<<
literal|8
operator||
name|safi
condition|)
block|{
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_UNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_UNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_prefix4
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|len
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|3
condition|)
break|break;
comment|/* bytes left, but not enough */
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_LABUNICAST
operator|)
case|:
name|advance
operator|=
name|decode_labeled_prefix4
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|len
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|3
condition|)
break|break;
comment|/* bytes left, but not enough */
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_labeled_vpn_prefix4
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_RT_ROUTING_INFO
operator|)
case|:
name|advance
operator|=
name|decode_rt_routing_info
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST_VPN
operator|)
case|:
comment|/* fall through */
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST_VPN
operator|)
case|:
name|advance
operator|=
name|decode_multicast_vpn
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_MDT
operator|)
case|:
name|advance
operator|=
name|decode_mdt_vpn_nlri
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_UNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_UNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_prefix6
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|len
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|3
condition|)
break|break;
comment|/* bytes left, but not enough */
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_LABUNICAST
operator|)
case|:
name|advance
operator|=
name|decode_labeled_prefix6
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|len
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|3
condition|)
break|break;
comment|/* bytes left, but not enough */
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_labeled_vpn_prefix6
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
operator|(
name|AFNUM_VPLS
operator|<<
literal|8
operator||
name|SAFNUM_VPLS
operator|)
case|:
case|case
operator|(
name|AFNUM_L2VPN
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_L2VPN
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_L2VPN
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_labeled_vpn_l2
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_UNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_UNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_clnp_prefix
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_labeled_vpn_clnp_prefix
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ND_TCHECK2
argument_list|(
operator|*
name|tptr
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    no AFI %u / SAFI %u decoder"
operator|,
name|af
operator|,
name|safi
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
literal|"\n\t    "
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|advance
operator|=
literal|0
expr_stmt|;
name|tptr
operator|=
name|pptr
operator|+
name|len
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
break|break;
name|tptr
operator|+=
name|advance
expr_stmt|;
block|}
name|done
label|:
break|break;
case|case
name|BGPTYPE_MP_UNREACH_NLRI
case|:
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
name|BGP_MP_NLRI_MINSIZE
argument_list|)
expr_stmt|;
name|af
operator|=
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
expr_stmt|;
name|safi
operator|=
name|tptr
index|[
literal|2
index|]
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    AFI: %s (%u), %sSAFI: %s (%u)"
operator|,
name|tok2strbuf
argument_list|(
name|af_values
argument_list|,
literal|"Unknown AFI"
argument_list|,
name|af
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|af
operator|,
operator|(
name|safi
operator|>
literal|128
operator|)
condition|?
literal|"vendor specific "
else|:
literal|""
operator|,
comment|/* 128 is meanwhile wellknown */
name|tok2strbuf
argument_list|(
name|bgp_safi_values
argument_list|,
literal|"Unknown SAFI"
argument_list|,
name|safi
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|safi
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
name|BGP_MP_NLRI_MINSIZE
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      End-of-Rib Marker (empty NLRI)"
operator|)
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|3
expr_stmt|;
while|while
condition|(
name|len
operator|-
operator|(
name|tptr
operator|-
name|pptr
operator|)
operator|>
literal|0
condition|)
block|{
switch|switch
condition|(
name|af
operator|<<
literal|8
operator||
name|safi
condition|)
block|{
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_UNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_UNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_prefix4
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|len
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|3
condition|)
break|break;
comment|/* bytes left, but not enough */
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_LABUNICAST
operator|)
case|:
name|advance
operator|=
name|decode_labeled_prefix4
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|len
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|3
condition|)
break|break;
comment|/* bytes left, but not enough */
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_labeled_vpn_prefix4
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_UNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_UNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_prefix6
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|len
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|3
condition|)
break|break;
comment|/* bytes left, but not enough */
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_LABUNICAST
operator|)
case|:
name|advance
operator|=
name|decode_labeled_prefix6
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|len
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|3
condition|)
break|break;
comment|/* bytes left, but not enough */
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_labeled_vpn_prefix6
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
operator|(
name|AFNUM_VPLS
operator|<<
literal|8
operator||
name|SAFNUM_VPLS
operator|)
case|:
case|case
operator|(
name|AFNUM_L2VPN
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_L2VPN
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_L2VPN
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_labeled_vpn_l2
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_UNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_UNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_clnp_prefix
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_VPNMULTICAST
operator|)
case|:
case|case
operator|(
name|AFNUM_NSAP
operator|<<
literal|8
operator||
name|SAFNUM_VPNUNIMULTICAST
operator|)
case|:
name|advance
operator|=
name|decode_labeled_vpn_clnp_prefix
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_MDT
operator|)
case|:
name|advance
operator|=
name|decode_mdt_vpn_nlri
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|AFNUM_INET
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST_VPN
operator|)
case|:
comment|/* fall through */
case|case
operator|(
name|AFNUM_INET6
operator|<<
literal|8
operator||
name|SAFNUM_MULTICAST_VPN
operator|)
case|:
name|advance
operator|=
name|decode_multicast_vpn
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|advance
operator|==
operator|-
literal|1
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|advance
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
else|else
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ND_TCHECK2
argument_list|(
operator|*
operator|(
name|tptr
operator|-
literal|3
operator|)
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"no AFI %u / SAFI %u decoder"
operator|,
name|af
operator|,
name|safi
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|-
literal|3
argument_list|,
literal|"\n\t    "
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|advance
operator|=
literal|0
expr_stmt|;
name|tptr
operator|=
name|pptr
operator|+
name|len
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|advance
operator|<
literal|0
condition|)
break|break;
name|tptr
operator|+=
name|advance
expr_stmt|;
block|}
break|break;
case|case
name|BGPTYPE_EXTD_COMMUNITIES
case|:
if|if
condition|(
name|len
operator|%
literal|8
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"invalid len"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
while|while
condition|(
name|tlen
operator|>
literal|0
condition|)
block|{
name|uint16_t
name|extd_comm
decl_stmt|;
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|extd_comm
operator|=
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    %s (0x%04x), Flags [%s]"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_extd_comm_subtype_values
argument_list|,
literal|"unknown extd community typecode"
argument_list|,
name|extd_comm
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|extd_comm
operator|,
name|bittok2str
argument_list|(
name|bgp_extd_comm_flag_values
argument_list|,
literal|"none"
argument_list|,
name|extd_comm
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
operator|(
name|tptr
operator|+
literal|2
operator|)
argument_list|,
literal|6
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|extd_comm
condition|)
block|{
case|case
name|BGP_EXT_COM_RT_0
case|:
case|case
name|BGP_EXT_COM_RO_0
case|:
case|case
name|BGP_EXT_COM_L2VPN_RT_0
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": %u:%u (= %s)"
operator|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
operator|+
literal|2
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
operator|+
literal|4
argument_list|)
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|+
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_EXT_COM_RT_1
case|:
case|case
name|BGP_EXT_COM_RO_1
case|:
case|case
name|BGP_EXT_COM_L2VPN_RT_1
case|:
case|case
name|BGP_EXT_COM_VRF_RT_IMP
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": %s:%u"
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|+
literal|2
argument_list|)
operator|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
operator|+
literal|6
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_EXT_COM_RT_2
case|:
case|case
name|BGP_EXT_COM_RO_2
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": %s:%u"
operator|,
name|as_printf
argument_list|(
name|ndo
argument_list|,
name|astostr
argument_list|,
sizeof|sizeof
argument_list|(
name|astostr
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
operator|+
literal|2
argument_list|)
argument_list|)
operator|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
operator|+
literal|6
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_EXT_COM_LINKBAND
case|:
name|bw
operator|.
name|i
operator|=
name|EXTRACT_32BITS
argument_list|(
name|tptr
operator|+
literal|2
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": bandwidth: %.3f Mbps"
operator|,
name|bw
operator|.
name|f
operator|*
literal|8
operator|/
literal|1000000
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_EXT_COM_VPN_ORIGIN
case|:
case|case
name|BGP_EXT_COM_VPN_ORIGIN2
case|:
case|case
name|BGP_EXT_COM_VPN_ORIGIN3
case|:
case|case
name|BGP_EXT_COM_VPN_ORIGIN4
case|:
case|case
name|BGP_EXT_COM_OSPF_RID
case|:
case|case
name|BGP_EXT_COM_OSPF_RID2
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"%s"
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|+
literal|2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_EXT_COM_OSPF_RTYPE
case|:
case|case
name|BGP_EXT_COM_OSPF_RTYPE2
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": area:%s, router-type:%s, metric-type:%s%s"
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|+
literal|2
argument_list|)
operator|,
name|tok2strbuf
argument_list|(
name|bgp_extd_comm_ospf_rtype_values
argument_list|,
literal|"unknown (0x%02x)"
argument_list|,
operator|*
operator|(
name|tptr
operator|+
literal|6
operator|)
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
operator|(
operator|*
operator|(
name|tptr
operator|+
literal|7
operator|)
operator|&
name|BGP_OSPF_RTYPE_METRIC_TYPE
operator|)
condition|?
literal|"E2"
else|:
literal|""
operator|,
operator|(
operator|(
operator|*
operator|(
name|tptr
operator|+
literal|6
operator|)
operator|==
name|BGP_OSPF_RTYPE_EXT
operator|)
operator|||
operator|(
operator|*
operator|(
name|tptr
operator|+
literal|6
operator|)
operator|==
name|BGP_OSPF_RTYPE_NSSA
operator|)
operator|)
condition|?
literal|"E1"
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_EXT_COM_L2INFO
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": %s Control Flags [0x%02x]:MTU %u"
operator|,
name|tok2strbuf
argument_list|(
name|l2vpn_encaps_values
argument_list|,
literal|"unknown encaps"
argument_list|,
operator|*
operator|(
name|tptr
operator|+
literal|2
operator|)
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
operator|*
operator|(
name|tptr
operator|+
literal|3
operator|)
operator|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
operator|+
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_EXT_COM_SOURCE_AS
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": AS %u"
operator|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
operator|+
literal|2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ND_TCHECK2
argument_list|(
operator|*
name|tptr
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
literal|"\n\t      "
argument_list|,
literal|8
argument_list|)
expr_stmt|;
break|break;
block|}
name|tlen
operator|-=
literal|8
expr_stmt|;
name|tptr
operator|+=
literal|8
expr_stmt|;
block|}
break|break;
case|case
name|BGPTYPE_PMSI_TUNNEL
case|:
block|{
name|uint8_t
name|tunnel_type
decl_stmt|,
name|flags
decl_stmt|;
name|tunnel_type
operator|=
operator|*
operator|(
name|tptr
operator|+
literal|1
operator|)
expr_stmt|;
name|flags
operator|=
operator|*
name|tptr
expr_stmt|;
name|tlen
operator|=
name|len
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    Tunnel-type %s (%u), Flags [%s], MPLS Label %u"
operator|,
name|tok2str
argument_list|(
name|bgp_pmsi_tunnel_values
argument_list|,
literal|"Unknown"
argument_list|,
name|tunnel_type
argument_list|)
operator|,
name|tunnel_type
operator|,
name|bittok2str
argument_list|(
name|bgp_pmsi_flag_values
argument_list|,
literal|"none"
argument_list|,
name|flags
argument_list|)
operator|,
name|EXTRACT_24BITS
argument_list|(
name|tptr
operator|+
literal|2
argument_list|)
operator|>>
literal|4
operator|)
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|5
expr_stmt|;
name|tlen
operator|-=
literal|5
expr_stmt|;
switch|switch
condition|(
name|tunnel_type
condition|)
block|{
case|case
name|BGP_PMSI_TUNNEL_PIM_SM
case|:
comment|/* fall through */
case|case
name|BGP_PMSI_TUNNEL_PIM_BIDIR
case|:
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      Sender %s, P-Group %s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|+
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_PMSI_TUNNEL_PIM_SSM
case|:
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      Root-Node %s, P-Group %s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|tptr
operator|+
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_PMSI_TUNNEL_INGRESS
case|:
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      Tunnel-Endpoint %s"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_PMSI_TUNNEL_LDP_P2MP
case|:
comment|/* fall through */
case|case
name|BGP_PMSI_TUNNEL_LDP_MP2MP
case|:
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      Root-Node %s, LSP-ID 0x%08x"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
operator|+
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_PMSI_TUNNEL_RSVP_P2MP
case|:
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      Extended-Tunnel-ID %s, P2MP-ID 0x%08x"
operator|,
name|ipaddr_string
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
operator|+
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<=
literal|1
condition|)
block|{
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|tptr
argument_list|,
literal|"\n\t      "
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
block|}
case|case
name|BGPTYPE_ATTR_SET
case|:
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|4
condition|)
goto|goto
name|trunc
goto|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    Origin AS: %s"
operator|,
name|as_printf
argument_list|(
name|ndo
argument_list|,
name|astostr
argument_list|,
sizeof|sizeof
argument_list|(
name|astostr
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tptr
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
while|while
condition|(
name|len
condition|)
block|{
name|u_int
name|aflags
decl_stmt|,
name|atype
decl_stmt|,
name|alenlen
decl_stmt|,
name|alen
decl_stmt|;
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
condition|)
goto|goto
name|trunc
goto|;
name|aflags
operator|=
operator|*
name|tptr
expr_stmt|;
name|atype
operator|=
operator|*
operator|(
name|tptr
operator|+
literal|1
operator|)
expr_stmt|;
name|tptr
operator|+=
literal|2
expr_stmt|;
name|len
operator|-=
literal|2
expr_stmt|;
name|alenlen
operator|=
name|bgp_attr_lenlen
argument_list|(
name|aflags
argument_list|,
name|tptr
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|tptr
index|[
literal|0
index|]
argument_list|,
name|alenlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|alenlen
condition|)
goto|goto
name|trunc
goto|;
name|alen
operator|=
name|bgp_attr_len
argument_list|(
name|aflags
argument_list|,
name|tptr
argument_list|)
expr_stmt|;
name|tptr
operator|+=
name|alenlen
expr_stmt|;
name|len
operator|-=
name|alenlen
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s (%u), length: %u"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_attr_values
argument_list|,
literal|"Unknown Attribute"
argument_list|,
name|atype
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|atype
operator|,
name|alen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|aflags
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Flags [%s%s%s%s"
operator|,
name|aflags
operator|&
literal|0x80
condition|?
literal|"O"
else|:
literal|""
operator|,
name|aflags
operator|&
literal|0x40
condition|?
literal|"T"
else|:
literal|""
operator|,
name|aflags
operator|&
literal|0x20
condition|?
literal|"P"
else|:
literal|""
operator|,
name|aflags
operator|&
literal|0x10
condition|?
literal|"E"
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|aflags
operator|&
literal|0xf
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"+%x"
operator|,
name|aflags
operator|&
literal|0xf
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"]: "
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* FIXME check for recursion */
if|if
condition|(
operator|!
name|bgp_attr_print
argument_list|(
name|ndo
argument_list|,
name|atype
argument_list|,
name|tptr
argument_list|,
name|alen
argument_list|)
condition|)
return|return
literal|0
return|;
name|tptr
operator|+=
name|alen
expr_stmt|;
name|len
operator|-=
name|alen
expr_stmt|;
block|}
break|break;
default|default:
name|ND_TCHECK2
argument_list|(
operator|*
name|pptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    no Attribute %u decoder"
operator|,
name|atype
operator|)
argument_list|)
expr_stmt|;
comment|/* we have no decoder for the attribute */
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|,
literal|"\n\t    "
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
operator|&&
name|len
condition|)
block|{
comment|/* omit zero length attributes*/
name|ND_TCHECK2
argument_list|(
operator|*
name|pptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|,
literal|"\n\t    "
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
name|trunc
label|:
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgp_capabilities_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|opt
parameter_list|,
name|int
name|caps_len
parameter_list|)
block|{
name|char
name|tokbuf
index|[
name|TOKBUFSIZE
index|]
decl_stmt|;
name|char
name|tokbuf2
index|[
name|TOKBUFSIZE
index|]
decl_stmt|;
name|int
name|cap_type
decl_stmt|,
name|cap_len
decl_stmt|,
name|tcap_len
decl_stmt|,
name|cap_offset
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|i
operator|<
name|caps_len
condition|)
block|{
name|ND_TCHECK2
argument_list|(
name|opt
index|[
name|i
index|]
argument_list|,
name|BGP_CAP_HEADER_SIZE
argument_list|)
expr_stmt|;
name|cap_type
operator|=
name|opt
index|[
name|i
index|]
expr_stmt|;
name|cap_len
operator|=
name|opt
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|tcap_len
operator|=
name|cap_len
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      %s (%u), length: %u"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_capcode_values
argument_list|,
literal|"Unknown"
argument_list|,
name|cap_type
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|cap_type
operator|,
name|cap_len
operator|)
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|opt
index|[
name|i
operator|+
literal|2
index|]
argument_list|,
name|cap_len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cap_type
condition|)
block|{
case|case
name|BGP_CAPCODE_MP
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t\tAFI %s (%u), SAFI %s (%u)"
operator|,
name|tok2strbuf
argument_list|(
name|af_values
argument_list|,
literal|"Unknown"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|opt
operator|+
name|i
operator|+
literal|2
argument_list|)
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|EXTRACT_16BITS
argument_list|(
name|opt
operator|+
name|i
operator|+
literal|2
argument_list|)
operator|,
name|tok2strbuf
argument_list|(
name|bgp_safi_values
argument_list|,
literal|"Unknown"
argument_list|,
name|opt
index|[
name|i
operator|+
literal|5
index|]
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|opt
index|[
name|i
operator|+
literal|5
index|]
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_CAPCODE_RESTART
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t\tRestart Flags: [%s], Restart Time %us"
operator|,
operator|(
operator|(
name|opt
index|[
name|i
operator|+
literal|2
index|]
operator|)
operator|&
literal|0x80
operator|)
condition|?
literal|"R"
else|:
literal|"none"
operator|,
name|EXTRACT_16BITS
argument_list|(
name|opt
operator|+
name|i
operator|+
literal|2
argument_list|)
operator|&
literal|0xfff
operator|)
argument_list|)
expr_stmt|;
name|tcap_len
operator|-=
literal|2
expr_stmt|;
name|cap_offset
operator|=
literal|4
expr_stmt|;
while|while
condition|(
name|tcap_len
operator|>=
literal|4
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t\t  AFI %s (%u), SAFI %s (%u), Forwarding state preserved: %s"
operator|,
name|tok2strbuf
argument_list|(
name|af_values
argument_list|,
literal|"Unknown"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|opt
operator|+
name|i
operator|+
name|cap_offset
argument_list|)
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|EXTRACT_16BITS
argument_list|(
name|opt
operator|+
name|i
operator|+
name|cap_offset
argument_list|)
operator|,
name|tok2strbuf
argument_list|(
name|bgp_safi_values
argument_list|,
literal|"Unknown"
argument_list|,
name|opt
index|[
name|i
operator|+
name|cap_offset
operator|+
literal|2
index|]
argument_list|,
name|tokbuf2
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf2
argument_list|)
argument_list|)
operator|,
name|opt
index|[
name|i
operator|+
name|cap_offset
operator|+
literal|2
index|]
operator|,
operator|(
operator|(
name|opt
index|[
name|i
operator|+
name|cap_offset
operator|+
literal|3
index|]
operator|)
operator|&
literal|0x80
operator|)
condition|?
literal|"yes"
else|:
literal|"no"
operator|)
argument_list|)
expr_stmt|;
name|tcap_len
operator|-=
literal|4
expr_stmt|;
name|cap_offset
operator|+=
literal|4
expr_stmt|;
block|}
break|break;
case|case
name|BGP_CAPCODE_RR
case|:
case|case
name|BGP_CAPCODE_RR_CISCO
case|:
break|break;
case|case
name|BGP_CAPCODE_AS_NEW
case|:
comment|/*                      * Extract the 4 byte AS number encoded.                      */
if|if
condition|(
name|cap_len
operator|==
literal|4
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t\t 4 Byte AS %s"
operator|,
name|as_printf
argument_list|(
name|ndo
argument_list|,
name|astostr
argument_list|,
sizeof|sizeof
argument_list|(
name|astostr
argument_list|)
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|opt
operator|+
name|i
operator|+
literal|2
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t\tno decoder for Capability %u"
operator|,
name|cap_type
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<=
literal|1
condition|)
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
operator|&
name|opt
index|[
name|i
operator|+
literal|2
index|]
argument_list|,
literal|"\n\t\t"
argument_list|,
name|cap_len
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
operator|&&
name|cap_len
operator|>
literal|0
condition|)
block|{
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
operator|&
name|opt
index|[
name|i
operator|+
literal|2
index|]
argument_list|,
literal|"\n\t\t"
argument_list|,
name|cap_len
argument_list|)
expr_stmt|;
block|}
name|i
operator|+=
name|BGP_CAP_HEADER_SIZE
operator|+
name|cap_len
expr_stmt|;
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|BGP]"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgp_open_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|length
parameter_list|)
block|{
name|struct
name|bgp_open
name|bgpo
decl_stmt|;
name|struct
name|bgp_opt
name|bgpopt
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|opt
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
name|tokbuf
index|[
name|TOKBUFSIZE
index|]
decl_stmt|;
name|ND_TCHECK2
argument_list|(
name|dat
index|[
literal|0
index|]
argument_list|,
name|BGP_OPEN_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|bgpo
argument_list|,
name|dat
argument_list|,
name|BGP_OPEN_SIZE
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t  Version %d, "
operator|,
name|bgpo
operator|.
name|bgpo_version
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"my AS %s, "
operator|,
name|as_printf
argument_list|(
name|ndo
argument_list|,
name|astostr
argument_list|,
sizeof|sizeof
argument_list|(
name|astostr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|bgpo
operator|.
name|bgpo_myas
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"Holdtime %us, "
operator|,
name|ntohs
argument_list|(
name|bgpo
operator|.
name|bgpo_holdtime
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"ID %s"
operator|,
name|getname
argument_list|(
name|ndo
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|bgpo
operator|.
name|bgpo_id
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t  Optional parameters, length: %u"
operator|,
name|bgpo
operator|.
name|bgpo_optlen
operator|)
argument_list|)
expr_stmt|;
comment|/* some little sanity checking */
if|if
condition|(
name|length
operator|<
name|bgpo
operator|.
name|bgpo_optlen
operator|+
name|BGP_OPEN_SIZE
condition|)
return|return;
comment|/* ugly! */
name|opt
operator|=
operator|&
operator|(
operator|(
specifier|const
expr|struct
name|bgp_open
operator|*
operator|)
name|dat
operator|)
operator|->
name|bgpo_optlen
expr_stmt|;
name|opt
operator|++
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|bgpo
operator|.
name|bgpo_optlen
condition|)
block|{
name|ND_TCHECK2
argument_list|(
name|opt
index|[
name|i
index|]
argument_list|,
name|BGP_OPT_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|bgpopt
argument_list|,
operator|&
name|opt
index|[
name|i
index|]
argument_list|,
name|BGP_OPT_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|+
literal|2
operator|+
name|bgpopt
operator|.
name|bgpopt_len
operator|>
name|bgpo
operator|.
name|bgpo_optlen
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t     Option %d, length: %u"
operator|,
name|bgpopt
operator|.
name|bgpopt_type
operator|,
name|bgpopt
operator|.
name|bgpopt_len
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    Option %s (%u), length: %u"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_opt_values
argument_list|,
literal|"Unknown"
argument_list|,
name|bgpopt
operator|.
name|bgpopt_type
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|bgpopt
operator|.
name|bgpopt_type
operator|,
name|bgpopt
operator|.
name|bgpopt_len
operator|)
argument_list|)
expr_stmt|;
comment|/* now let's decode the options we know*/
switch|switch
condition|(
name|bgpopt
operator|.
name|bgpopt_type
condition|)
block|{
case|case
name|BGP_OPT_CAP
case|:
name|bgp_capabilities_print
argument_list|(
name|ndo
argument_list|,
operator|&
name|opt
index|[
name|i
operator|+
name|BGP_OPT_SIZE
index|]
argument_list|,
name|bgpopt
operator|.
name|bgpopt_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_OPT_AUTH
case|:
default|default:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t      no decoder for option %u"
operator|,
name|bgpopt
operator|.
name|bgpopt_type
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|i
operator|+=
name|BGP_OPT_SIZE
operator|+
name|bgpopt
operator|.
name|bgpopt_len
expr_stmt|;
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|BGP]"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgp_update_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|length
parameter_list|)
block|{
name|struct
name|bgp
name|bgp
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|withdrawn_routes_len
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
name|tokbuf
index|[
name|TOKBUFSIZE
index|]
decl_stmt|;
ifndef|#
directive|ifndef
name|INET6
name|char
name|buf
index|[
name|MAXHOSTNAMELEN
operator|+
literal|100
index|]
decl_stmt|;
name|int
name|wpfx
decl_stmt|;
endif|#
directive|endif
name|ND_TCHECK2
argument_list|(
name|dat
index|[
literal|0
index|]
argument_list|,
name|BGP_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|<
name|BGP_SIZE
condition|)
goto|goto
name|trunc
goto|;
name|memcpy
argument_list|(
operator|&
name|bgp
argument_list|,
name|dat
argument_list|,
name|BGP_SIZE
argument_list|)
expr_stmt|;
name|p
operator|=
name|dat
operator|+
name|BGP_SIZE
expr_stmt|;
comment|/*XXX*/
name|length
operator|-=
name|BGP_SIZE
expr_stmt|;
comment|/* Unfeasible routes */
name|ND_TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|<
literal|2
condition|)
goto|goto
name|trunc
goto|;
name|withdrawn_routes_len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
name|length
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|withdrawn_routes_len
condition|)
block|{
comment|/* 		 * Without keeping state from the original NLRI message, 		 * it's not possible to tell if this a v4 or v6 route, 		 * so only try to decode it if we're not v6 enabled. 	         */
name|ND_TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
name|withdrawn_routes_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|<
name|withdrawn_routes_len
condition|)
goto|goto
name|trunc
goto|;
ifdef|#
directive|ifdef
name|INET6
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t  Withdrawn routes: %d bytes"
operator|,
name|withdrawn_routes_len
operator|)
argument_list|)
expr_stmt|;
name|p
operator|+=
name|withdrawn_routes_len
expr_stmt|;
name|length
operator|-=
name|withdrawn_routes_len
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|withdrawn_routes_len
operator|<
literal|2
condition|)
goto|goto
name|trunc
goto|;
name|length
operator|-=
literal|2
expr_stmt|;
name|withdrawn_routes_len
operator|-=
literal|2
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t  Withdrawn routes:"
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|withdrawn_routes_len
operator|>
literal|0
condition|)
block|{
name|wpfx
operator|=
name|decode_prefix4
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|withdrawn_routes_len
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpfx
operator|==
operator|-
literal|1
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|wpfx
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
elseif|else
if|if
condition|(
name|wpfx
operator|==
operator|-
literal|3
condition|)
goto|goto
name|trunc
goto|;
comment|/* bytes left, but not enough */
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
name|p
operator|+=
name|wpfx
expr_stmt|;
name|length
operator|-=
name|wpfx
expr_stmt|;
name|withdrawn_routes_len
operator|-=
name|wpfx
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
name|ND_TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|<
literal|2
condition|)
goto|goto
name|trunc
goto|;
name|len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
name|length
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|withdrawn_routes_len
operator|==
literal|0
operator|&&
name|len
operator|==
literal|0
operator|&&
name|length
operator|==
literal|0
condition|)
block|{
comment|/* No withdrawn routes, no path attributes, no NLRI */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t  End-of-Rib Marker (empty NLRI)"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
condition|)
block|{
comment|/* do something more useful!*/
while|while
condition|(
name|len
condition|)
block|{
name|int
name|aflags
decl_stmt|,
name|atype
decl_stmt|,
name|alenlen
decl_stmt|,
name|alen
decl_stmt|;
name|ND_TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
condition|)
goto|goto
name|trunc
goto|;
if|if
condition|(
name|length
operator|<
literal|2
condition|)
goto|goto
name|trunc
goto|;
name|aflags
operator|=
operator|*
name|p
expr_stmt|;
name|atype
operator|=
operator|*
operator|(
name|p
operator|+
literal|1
operator|)
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
name|len
operator|-=
literal|2
expr_stmt|;
name|length
operator|-=
literal|2
expr_stmt|;
name|alenlen
operator|=
name|bgp_attr_lenlen
argument_list|(
name|aflags
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ND_TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
name|alenlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|alenlen
condition|)
goto|goto
name|trunc
goto|;
if|if
condition|(
name|length
operator|<
name|alenlen
condition|)
goto|goto
name|trunc
goto|;
name|alen
operator|=
name|bgp_attr_len
argument_list|(
name|aflags
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|p
operator|+=
name|alenlen
expr_stmt|;
name|len
operator|-=
name|alenlen
expr_stmt|;
name|length
operator|-=
name|alenlen
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t  %s (%u), length: %u"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_attr_values
argument_list|,
literal|"Unknown Attribute"
argument_list|,
name|atype
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|atype
operator|,
name|alen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|aflags
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", Flags [%s%s%s%s"
operator|,
name|aflags
operator|&
literal|0x80
condition|?
literal|"O"
else|:
literal|""
operator|,
name|aflags
operator|&
literal|0x40
condition|?
literal|"T"
else|:
literal|""
operator|,
name|aflags
operator|&
literal|0x20
condition|?
literal|"P"
else|:
literal|""
operator|,
name|aflags
operator|&
literal|0x10
condition|?
literal|"E"
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|aflags
operator|&
literal|0xf
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"+%x"
operator|,
name|aflags
operator|&
literal|0xf
operator|)
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"]: "
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|<
name|alen
condition|)
goto|goto
name|trunc
goto|;
if|if
condition|(
name|length
operator|<
name|alen
condition|)
goto|goto
name|trunc
goto|;
if|if
condition|(
operator|!
name|bgp_attr_print
argument_list|(
name|ndo
argument_list|,
name|atype
argument_list|,
name|p
argument_list|,
name|alen
argument_list|)
condition|)
goto|goto
name|trunc
goto|;
name|p
operator|+=
name|alen
expr_stmt|;
name|len
operator|-=
name|alen
expr_stmt|;
name|length
operator|-=
name|alen
expr_stmt|;
block|}
block|}
if|if
condition|(
name|length
condition|)
block|{
comment|/* 		 * XXX - what if they're using the "Advertisement of 		 * Multiple Paths in BGP" feature: 		 * 		 * https://datatracker.ietf.org/doc/draft-ietf-idr-add-paths/ 		 * 		 * http://tools.ietf.org/html/draft-ietf-idr-add-paths-06 		 */
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t  Updated routes:"
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|length
condition|)
block|{
name|char
name|buf
index|[
name|MAXHOSTNAMELEN
operator|+
literal|100
index|]
decl_stmt|;
name|i
operator|=
name|decode_prefix4
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|length
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|-
literal|1
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    (illegal prefix length)"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
operator|-
literal|2
condition|)
goto|goto
name|trunc
goto|;
elseif|else
if|if
condition|(
name|i
operator|==
operator|-
literal|3
condition|)
goto|goto
name|trunc
goto|;
comment|/* bytes left, but not enough */
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t    %s"
operator|,
name|buf
operator|)
argument_list|)
expr_stmt|;
name|p
operator|+=
name|i
expr_stmt|;
name|length
operator|-=
name|i
expr_stmt|;
block|}
block|}
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|BGP]"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgp_notification_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|length
parameter_list|)
block|{
name|struct
name|bgp_notification
name|bgpn
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|tptr
decl_stmt|;
name|char
name|tokbuf
index|[
name|TOKBUFSIZE
index|]
decl_stmt|;
name|char
name|tokbuf2
index|[
name|TOKBUFSIZE
index|]
decl_stmt|;
name|ND_TCHECK2
argument_list|(
name|dat
index|[
literal|0
index|]
argument_list|,
name|BGP_NOTIFICATION_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|bgpn
argument_list|,
name|dat
argument_list|,
name|BGP_NOTIFICATION_SIZE
argument_list|)
expr_stmt|;
comment|/* some little sanity checking */
if|if
condition|(
name|length
operator|<
name|BGP_NOTIFICATION_SIZE
condition|)
return|return;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", %s (%u)"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_notify_major_values
argument_list|,
literal|"Unknown Error"
argument_list|,
name|bgpn
operator|.
name|bgpn_major
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|bgpn
operator|.
name|bgpn_major
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|bgpn
operator|.
name|bgpn_major
condition|)
block|{
case|case
name|BGP_NOTIFY_MAJOR_MSG
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", subcode %s (%u)"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_notify_minor_msg_values
argument_list|,
literal|"Unknown"
argument_list|,
name|bgpn
operator|.
name|bgpn_minor
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|bgpn
operator|.
name|bgpn_minor
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_NOTIFY_MAJOR_OPEN
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", subcode %s (%u)"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_notify_minor_open_values
argument_list|,
literal|"Unknown"
argument_list|,
name|bgpn
operator|.
name|bgpn_minor
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|bgpn
operator|.
name|bgpn_minor
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_NOTIFY_MAJOR_UPDATE
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", subcode %s (%u)"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_notify_minor_update_values
argument_list|,
literal|"Unknown"
argument_list|,
name|bgpn
operator|.
name|bgpn_minor
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|bgpn
operator|.
name|bgpn_minor
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_NOTIFY_MAJOR_CAP
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" subcode %s (%u)"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_notify_minor_cap_values
argument_list|,
literal|"Unknown"
argument_list|,
name|bgpn
operator|.
name|bgpn_minor
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|bgpn
operator|.
name|bgpn_minor
operator|)
argument_list|)
expr_stmt|;
case|case
name|BGP_NOTIFY_MAJOR_CEASE
case|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", subcode %s (%u)"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_notify_minor_cease_values
argument_list|,
literal|"Unknown"
argument_list|,
name|bgpn
operator|.
name|bgpn_minor
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|bgpn
operator|.
name|bgpn_minor
operator|)
argument_list|)
expr_stmt|;
comment|/* draft-ietf-idr-cease-subcode-02 mentions optionally 7 bytes              * for the maxprefix subtype, which may contain AFI, SAFI and MAXPREFIXES              */
if|if
condition|(
name|bgpn
operator|.
name|bgpn_minor
operator|==
name|BGP_NOTIFY_MINOR_CEASE_MAXPRFX
operator|&&
name|length
operator|>=
name|BGP_NOTIFICATION_SIZE
operator|+
literal|7
condition|)
block|{
name|tptr
operator|=
name|dat
operator|+
name|BGP_NOTIFICATION_SIZE
expr_stmt|;
name|ND_TCHECK2
argument_list|(
operator|*
name|tptr
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|", AFI %s (%u), SAFI %s (%u), Max Prefixes: %u"
operator|,
name|tok2strbuf
argument_list|(
name|af_values
argument_list|,
literal|"Unknown"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|EXTRACT_16BITS
argument_list|(
name|tptr
argument_list|)
operator|,
name|tok2strbuf
argument_list|(
name|bgp_safi_values
argument_list|,
literal|"Unknown"
argument_list|,
operator|*
operator|(
name|tptr
operator|+
literal|2
operator|)
argument_list|,
name|tokbuf2
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
operator|*
operator|(
name|tptr
operator|+
literal|2
operator|)
operator|,
name|EXTRACT_32BITS
argument_list|(
name|tptr
operator|+
literal|3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|BGP]"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgp_route_refresh_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|pptr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|bgp_route_refresh
modifier|*
name|bgp_route_refresh_header
decl_stmt|;
name|char
name|tokbuf
index|[
name|TOKBUFSIZE
index|]
decl_stmt|;
name|char
name|tokbuf2
index|[
name|TOKBUFSIZE
index|]
decl_stmt|;
name|ND_TCHECK2
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|,
name|BGP_ROUTE_REFRESH_SIZE
argument_list|)
expr_stmt|;
comment|/* some little sanity checking */
if|if
condition|(
name|len
operator|<
name|BGP_ROUTE_REFRESH_SIZE
condition|)
return|return;
name|bgp_route_refresh_header
operator|=
operator|(
specifier|const
expr|struct
name|bgp_route_refresh
operator|*
operator|)
name|pptr
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t  AFI %s (%u), SAFI %s (%u)"
operator|,
name|tok2strbuf
argument_list|(
name|af_values
argument_list|,
literal|"Unknown"
argument_list|,
comment|/* this stinks but the compiler pads the structure 			   * weird */
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bgp_route_refresh_header
operator|->
name|afi
argument_list|)
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|bgp_route_refresh_header
operator|->
name|afi
argument_list|)
operator|,
name|tok2strbuf
argument_list|(
name|bgp_safi_values
argument_list|,
literal|"Unknown"
argument_list|,
name|bgp_route_refresh_header
operator|->
name|safi
argument_list|,
name|tokbuf2
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf2
argument_list|)
argument_list|)
operator|,
name|bgp_route_refresh_header
operator|->
name|safi
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|>
literal|1
condition|)
block|{
name|ND_TCHECK2
argument_list|(
operator|*
name|pptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|pptr
argument_list|,
literal|"\n\t  "
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|BGP]"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bgp_header_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|length
parameter_list|)
block|{
name|struct
name|bgp
name|bgp
decl_stmt|;
name|char
name|tokbuf
index|[
name|TOKBUFSIZE
index|]
decl_stmt|;
name|ND_TCHECK2
argument_list|(
name|dat
index|[
literal|0
index|]
argument_list|,
name|BGP_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|bgp
argument_list|,
name|dat
argument_list|,
name|BGP_SIZE
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t%s Message (%u), length: %u"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_msg_values
argument_list|,
literal|"Unknown"
argument_list|,
name|bgp
operator|.
name|bgp_type
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|,
name|bgp
operator|.
name|bgp_type
operator|,
name|length
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|bgp
operator|.
name|bgp_type
condition|)
block|{
case|case
name|BGP_OPEN
case|:
name|bgp_open_print
argument_list|(
name|ndo
argument_list|,
name|dat
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_UPDATE
case|:
name|bgp_update_print
argument_list|(
name|ndo
argument_list|,
name|dat
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_NOTIFICATION
case|:
name|bgp_notification_print
argument_list|(
name|ndo
argument_list|,
name|dat
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_KEEPALIVE
case|:
break|break;
case|case
name|BGP_ROUTE_REFRESH
case|:
name|bgp_route_refresh_print
argument_list|(
name|ndo
argument_list|,
name|dat
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* we have no decoder for the BGP message */
name|ND_TCHECK2
argument_list|(
operator|*
name|dat
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n\t  no Message %u decoder"
operator|,
name|bgp
operator|.
name|bgp_type
operator|)
argument_list|)
expr_stmt|;
name|print_unknown_data
argument_list|(
name|ndo
argument_list|,
name|dat
argument_list|,
literal|"\n\t  "
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|1
return|;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"[|BGP]"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|bgp_print
parameter_list|(
name|netdissect_options
modifier|*
name|ndo
parameter_list|,
specifier|const
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|length
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|p
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|start
decl_stmt|;
specifier|const
name|u_char
name|marker
index|[]
init|=
block|{
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|, 	}
decl_stmt|;
name|struct
name|bgp
name|bgp
decl_stmt|;
name|uint16_t
name|hlen
decl_stmt|;
name|char
name|tokbuf
index|[
name|TOKBUFSIZE
index|]
decl_stmt|;
name|ep
operator|=
name|dat
operator|+
name|length
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_snapend
operator|<
name|dat
operator|+
name|length
condition|)
name|ep
operator|=
name|ndo
operator|->
name|ndo_snapend
expr_stmt|;
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|": BGP, length: %u"
operator|,
name|length
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndo
operator|->
name|ndo_vflag
operator|<
literal|1
condition|)
comment|/* lets be less chatty */
return|return;
name|p
operator|=
name|dat
expr_stmt|;
name|start
operator|=
name|p
expr_stmt|;
while|while
condition|(
name|p
operator|<
name|ep
condition|)
block|{
if|if
condition|(
operator|!
name|ND_TTEST2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
condition|)
break|break;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|!=
literal|0xff
condition|)
block|{
name|p
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|ND_TTEST2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|marker
argument_list|)
argument_list|)
condition|)
break|break;
if|if
condition|(
name|memcmp
argument_list|(
name|p
argument_list|,
name|marker
argument_list|,
sizeof|sizeof
argument_list|(
name|marker
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|p
operator|++
expr_stmt|;
continue|continue;
block|}
comment|/* found BGP header */
name|ND_TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
name|BGP_SIZE
argument_list|)
expr_stmt|;
comment|/*XXX*/
name|memcpy
argument_list|(
operator|&
name|bgp
argument_list|,
name|p
argument_list|,
name|BGP_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|!=
name|p
condition|)
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|BGP]"
operator|)
argument_list|)
expr_stmt|;
name|hlen
operator|=
name|ntohs
argument_list|(
name|bgp
operator|.
name|bgp_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|hlen
operator|<
name|BGP_SIZE
condition|)
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n[|BGP Bogus header length %u< %u]"
operator|,
name|hlen
operator|,
name|BGP_SIZE
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ND_TTEST2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
name|hlen
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|bgp_header_print
argument_list|(
name|ndo
argument_list|,
name|p
argument_list|,
name|hlen
argument_list|)
condition|)
return|return;
name|p
operator|+=
name|hlen
expr_stmt|;
name|start
operator|=
name|p
expr_stmt|;
block|}
else|else
block|{
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|"\n[|BGP %s]"
operator|,
name|tok2strbuf
argument_list|(
name|bgp_msg_values
argument_list|,
literal|"Unknown Message Type"
argument_list|,
name|bgp
operator|.
name|bgp_type
argument_list|,
name|tokbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tokbuf
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return;
name|trunc
label|:
name|ND_PRINT
argument_list|(
operator|(
name|ndo
operator|,
literal|" [|BGP]"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Local Variables:  * c-style: whitesmith  * c-basic-offset: 4  * End:  */
end_comment

end_unit


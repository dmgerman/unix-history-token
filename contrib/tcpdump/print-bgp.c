begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 1999 WIDE Project.  * All rights reserved.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the project nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *   * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-bgp.c,v 1.27 2001/10/18 09:52:17 itojun Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_struct
struct|struct
name|bgp
block|{
name|u_int8_t
name|bgp_marker
index|[
literal|16
index|]
decl_stmt|;
name|u_int16_t
name|bgp_len
decl_stmt|;
name|u_int8_t
name|bgp_type
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|BGP_SIZE
value|19
end_define

begin_comment
comment|/* unaligned */
end_comment

begin_define
define|#
directive|define
name|BGP_OPEN
value|1
end_define

begin_define
define|#
directive|define
name|BGP_UPDATE
value|2
end_define

begin_define
define|#
directive|define
name|BGP_NOTIFICATION
value|3
end_define

begin_define
define|#
directive|define
name|BGP_KEEPALIVE
value|4
end_define

begin_struct
struct|struct
name|bgp_open
block|{
name|u_int8_t
name|bgpo_marker
index|[
literal|16
index|]
decl_stmt|;
name|u_int16_t
name|bgpo_len
decl_stmt|;
name|u_int8_t
name|bgpo_type
decl_stmt|;
name|u_int8_t
name|bgpo_version
decl_stmt|;
name|u_int16_t
name|bgpo_myas
decl_stmt|;
name|u_int16_t
name|bgpo_holdtime
decl_stmt|;
name|u_int32_t
name|bgpo_id
decl_stmt|;
name|u_int8_t
name|bgpo_optlen
decl_stmt|;
comment|/* options should follow */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|BGP_OPEN_SIZE
value|29
end_define

begin_comment
comment|/* unaligned */
end_comment

begin_struct
struct|struct
name|bgp_opt
block|{
name|u_int8_t
name|bgpopt_type
decl_stmt|;
name|u_int8_t
name|bgpopt_len
decl_stmt|;
comment|/* variable length */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|BGP_OPT_SIZE
value|2
end_define

begin_comment
comment|/* some compilers may pad to 4 bytes */
end_comment

begin_struct
struct|struct
name|bgp_notification
block|{
name|u_int8_t
name|bgpn_marker
index|[
literal|16
index|]
decl_stmt|;
name|u_int16_t
name|bgpn_len
decl_stmt|;
name|u_int8_t
name|bgpn_type
decl_stmt|;
name|u_int8_t
name|bgpn_major
decl_stmt|;
name|u_int8_t
name|bgpn_minor
decl_stmt|;
comment|/* data should follow */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|BGP_NOTIFICATION_SIZE
value|21
end_define

begin_comment
comment|/* unaligned */
end_comment

begin_struct
struct|struct
name|bgp_attr
block|{
name|u_int8_t
name|bgpa_flags
decl_stmt|;
name|u_int8_t
name|bgpa_type
decl_stmt|;
union|union
block|{
name|u_int8_t
name|len
decl_stmt|;
name|u_int16_t
name|elen
decl_stmt|;
block|}
name|bgpa_len
union|;
define|#
directive|define
name|bgp_attr_len
parameter_list|(
name|p
parameter_list|)
define|\
value|(((p)->bgpa_flags& 0x10) ? \ 		ntohs((p)->bgpa_len.elen) : (p)->bgpa_len.len)
define|#
directive|define
name|bgp_attr_off
parameter_list|(
name|p
parameter_list|)
define|\
value|(((p)->bgpa_flags& 0x10) ? 4 : 3)
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|BGPTYPE_ORIGIN
value|1
end_define

begin_define
define|#
directive|define
name|BGPTYPE_AS_PATH
value|2
end_define

begin_define
define|#
directive|define
name|BGPTYPE_NEXT_HOP
value|3
end_define

begin_define
define|#
directive|define
name|BGPTYPE_MULTI_EXIT_DISC
value|4
end_define

begin_define
define|#
directive|define
name|BGPTYPE_LOCAL_PREF
value|5
end_define

begin_define
define|#
directive|define
name|BGPTYPE_ATOMIC_AGGREGATE
value|6
end_define

begin_define
define|#
directive|define
name|BGPTYPE_AGGREGATOR
value|7
end_define

begin_define
define|#
directive|define
name|BGPTYPE_COMMUNITIES
value|8
end_define

begin_comment
comment|/* RFC1997 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_ORIGINATOR_ID
value|9
end_define

begin_comment
comment|/* RFC1998 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_CLUSTER_LIST
value|10
end_define

begin_comment
comment|/* RFC1998 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_DPA
value|11
end_define

begin_comment
comment|/* work in progress */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_ADVERTISERS
value|12
end_define

begin_comment
comment|/* RFC1863 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_RCID_PATH
value|13
end_define

begin_comment
comment|/* RFC1863 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_MP_REACH_NLRI
value|14
end_define

begin_comment
comment|/* RFC2283 */
end_comment

begin_define
define|#
directive|define
name|BGPTYPE_MP_UNREACH_NLRI
value|15
end_define

begin_comment
comment|/* RFC2283 */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|bgptype
index|[]
init|=
block|{
name|NULL
block|,
literal|"OPEN"
block|,
literal|"UPDATE"
block|,
literal|"NOTIFICATION"
block|,
literal|"KEEPALIVE"
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|bgp_type
parameter_list|(
name|x
parameter_list|)
value|num_or_str(bgptype, sizeof(bgptype)/sizeof(bgptype[0]), (x))
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|bgpopt_type
index|[]
init|=
block|{
name|NULL
block|,
literal|"Authentication Information"
block|,
literal|"Capabilities Advertisement"
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|bgp_opttype
parameter_list|(
name|x
parameter_list|)
define|\
value|num_or_str(bgpopt_type, sizeof(bgpopt_type)/sizeof(bgpopt_type[0]), (x))
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|bgpnotify_major
index|[]
init|=
block|{
name|NULL
block|,
literal|"Message Header Error"
block|,
literal|"OPEN Message Error"
block|,
literal|"UPDATE Message Error"
block|,
literal|"Hold Timer Expired"
block|,
literal|"Finite State Machine Error"
block|,
literal|"Cease"
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|bgp_notify_major
parameter_list|(
name|x
parameter_list|)
define|\
value|num_or_str(bgpnotify_major, \ 		sizeof(bgpnotify_major)/sizeof(bgpnotify_major[0]), (x))
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|bgpnotify_minor_1
index|[]
init|=
block|{
name|NULL
block|,
literal|"Connection Not Synchronized"
block|,
literal|"Bad Message Length"
block|,
literal|"Bad Message Type"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|bgpnotify_minor_2
index|[]
init|=
block|{
name|NULL
block|,
literal|"Unsupported Version Number"
block|,
literal|"Bad Peer AS"
block|,
literal|"Bad BGP Identifier"
block|,
literal|"Unsupported Optional Parameter"
block|,
literal|"Authentication Failure"
block|,
literal|"Unacceptable Hold Time"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|bgpnotify_minor_3
index|[]
init|=
block|{
name|NULL
block|,
literal|"Malformed Attribute List"
block|,
literal|"Unrecognized Well-known Attribute"
block|,
literal|"Missing Well-known Attribute"
block|,
literal|"Attribute Flags Error"
block|,
literal|"Attribute Length Error"
block|,
literal|"Invalid ORIGIN Attribute"
block|,
literal|"AS Routing Loop"
block|,
literal|"Invalid NEXT_HOP Attribute"
block|,
literal|"Optional Attribute Error"
block|,
literal|"Invalid Network Field"
block|,
literal|"Malformed AS_PATH"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
modifier|*
name|bgpnotify_minor
index|[]
init|=
block|{
name|NULL
block|,
name|bgpnotify_minor_1
block|,
name|bgpnotify_minor_2
block|,
name|bgpnotify_minor_3
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|int
name|bgpnotify_minor_siz
index|[]
init|=
block|{
literal|0
block|,
sizeof|sizeof
argument_list|(
name|bgpnotify_minor_1
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|bgpnotify_minor_1
index|[
literal|0
index|]
argument_list|)
block|,
sizeof|sizeof
argument_list|(
name|bgpnotify_minor_2
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|bgpnotify_minor_2
index|[
literal|0
index|]
argument_list|)
block|,
sizeof|sizeof
argument_list|(
name|bgpnotify_minor_3
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|bgpnotify_minor_3
index|[
literal|0
index|]
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|bgpattr_origin
index|[]
init|=
block|{
literal|"IGP"
block|,
literal|"EGP"
block|,
literal|"INCOMPLETE"
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|bgp_attr_origin
parameter_list|(
name|x
parameter_list|)
define|\
value|num_or_str(bgpattr_origin, \ 		sizeof(bgpattr_origin)/sizeof(bgpattr_origin[0]), (x))
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|bgpattr_type
index|[]
init|=
block|{
name|NULL
block|,
literal|"ORIGIN"
block|,
literal|"AS_PATH"
block|,
literal|"NEXT_HOP"
block|,
literal|"MULTI_EXIT_DISC"
block|,
literal|"LOCAL_PREF"
block|,
literal|"ATOMIC_AGGREGATE"
block|,
literal|"AGGREGATOR"
block|,
literal|"COMMUNITIES"
block|,
literal|"ORIGINATOR_ID"
block|,
literal|"CLUSTER_LIST"
block|,
literal|"DPA"
block|,
literal|"ADVERTISERS"
block|,
literal|"RCID_PATH"
block|,
literal|"MP_REACH_NLRI"
block|,
literal|"MP_UNREACH_NLRI"
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|bgp_attr_type
parameter_list|(
name|x
parameter_list|)
define|\
value|num_or_str(bgpattr_type, \ 		sizeof(bgpattr_type)/sizeof(bgpattr_type[0]), (x))
end_define

begin_comment
comment|/* Subsequent address family identifier, RFC2283 section 7 */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|bgpattr_nlri_safi
index|[]
init|=
block|{
literal|"Reserved"
block|,
literal|"Unicast"
block|,
literal|"Multicast"
block|,
literal|"Unicast+Multicast"
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|bgp_attr_nlri_safi
parameter_list|(
name|x
parameter_list|)
define|\
value|num_or_str(bgpattr_nlri_safi, \ 		sizeof(bgpattr_nlri_safi)/sizeof(bgpattr_nlri_safi[0]), (x))
end_define

begin_comment
comment|/* well-known community */
end_comment

begin_define
define|#
directive|define
name|BGP_COMMUNITY_NO_EXPORT
value|0xffffff01
end_define

begin_define
define|#
directive|define
name|BGP_COMMUNITY_NO_ADVERT
value|0xffffff02
end_define

begin_define
define|#
directive|define
name|BGP_COMMUNITY_NO_EXPORT_SUBCONFED
value|0xffffff03
end_define

begin_comment
comment|/* RFC1700 address family numbers */
end_comment

begin_define
define|#
directive|define
name|AFNUM_INET
value|1
end_define

begin_define
define|#
directive|define
name|AFNUM_INET6
value|2
end_define

begin_define
define|#
directive|define
name|AFNUM_NSAP
value|3
end_define

begin_define
define|#
directive|define
name|AFNUM_HDLC
value|4
end_define

begin_define
define|#
directive|define
name|AFNUM_BBN1822
value|5
end_define

begin_define
define|#
directive|define
name|AFNUM_802
value|6
end_define

begin_define
define|#
directive|define
name|AFNUM_E163
value|7
end_define

begin_define
define|#
directive|define
name|AFNUM_E164
value|8
end_define

begin_define
define|#
directive|define
name|AFNUM_F69
value|9
end_define

begin_define
define|#
directive|define
name|AFNUM_X121
value|10
end_define

begin_define
define|#
directive|define
name|AFNUM_IPX
value|11
end_define

begin_define
define|#
directive|define
name|AFNUM_ATALK
value|12
end_define

begin_define
define|#
directive|define
name|AFNUM_DECNET
value|13
end_define

begin_define
define|#
directive|define
name|AFNUM_BANYAN
value|14
end_define

begin_define
define|#
directive|define
name|AFNUM_E164NSAP
value|15
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|afnumber
index|[]
init|=
block|{
literal|"Reserved"
block|,
literal|"IPv4"
block|,
literal|"IPv6"
block|,
literal|"NSAP"
block|,
literal|"HDLC"
block|,
literal|"BBN 1822"
block|,
literal|"802"
block|,
literal|"E.163"
block|,
literal|"E.164"
block|,
literal|"F.69"
block|,
literal|"X.121"
block|,
literal|"IPX"
block|,
literal|"Appletalk"
block|,
literal|"Decnet IV"
block|,
literal|"Banyan Vines"
block|,
literal|"E.164 with NSAP subaddress"
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|af_name
parameter_list|(
name|x
parameter_list|)
define|\
value|(((x) == 65535) ? afnumber[0] : \ 		num_or_str(afnumber, \ 			sizeof(afnumber)/sizeof(afnumber[0]), (x)))
end_define

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|num_or_str
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|table
parameter_list|,
name|size_t
name|siz
parameter_list|,
name|int
name|value
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
if|if
condition|(
name|value
operator|<
literal|0
operator|||
name|siz
operator|<=
name|value
operator|||
name|table
index|[
name|value
index|]
operator|==
name|NULL
condition|)
block|{
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"#%d"
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
else|else
return|return
name|table
index|[
name|value
index|]
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|bgp_notify_minor
parameter_list|(
name|int
name|major
parameter_list|,
name|int
name|minor
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
modifier|*
name|table
decl_stmt|;
name|int
name|siz
decl_stmt|;
specifier|static
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
literal|0
operator|<=
name|major
operator|&&
name|major
operator|<
sizeof|sizeof
argument_list|(
name|bgpnotify_minor
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|bgpnotify_minor
index|[
literal|0
index|]
argument_list|)
operator|&&
name|bgpnotify_minor
index|[
name|major
index|]
condition|)
block|{
name|table
operator|=
name|bgpnotify_minor
index|[
name|major
index|]
expr_stmt|;
name|siz
operator|=
name|bgpnotify_minor_siz
index|[
name|major
index|]
expr_stmt|;
if|if
condition|(
literal|0
operator|<=
name|minor
operator|&&
name|minor
operator|<
name|siz
operator|&&
name|table
index|[
name|minor
index|]
condition|)
name|p
operator|=
name|table
index|[
name|minor
index|]
expr_stmt|;
else|else
name|p
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|p
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"#%d"
argument_list|,
name|minor
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
else|else
return|return
name|p
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|decode_prefix4
parameter_list|(
specifier|const
name|u_char
modifier|*
name|pd
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|struct
name|in_addr
name|addr
decl_stmt|;
name|u_int
name|plen
decl_stmt|;
name|plen
operator|=
name|pd
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|plen
operator|<
literal|0
operator|||
literal|32
operator|<
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|pd
index|[
literal|1
index|]
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|%
literal|8
condition|)
block|{
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|addr
operator|)
index|[
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
operator|-
literal|1
index|]
operator|&=
operator|(
operator|(
literal|0xff00
operator|>>
operator|(
name|plen
operator|%
literal|8
operator|)
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s/%d"
argument_list|,
name|getname
argument_list|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|addr
argument_list|)
argument_list|,
name|plen
argument_list|)
expr_stmt|;
return|return
literal|1
operator|+
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function
specifier|static
name|int
name|decode_prefix6
parameter_list|(
specifier|const
name|u_char
modifier|*
name|pd
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|u_int
name|buflen
parameter_list|)
block|{
name|struct
name|in6_addr
name|addr
decl_stmt|;
name|u_int
name|plen
decl_stmt|;
name|plen
operator|=
name|pd
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|plen
operator|<
literal|0
operator|||
literal|128
operator|<
name|plen
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|pd
index|[
literal|1
index|]
argument_list|,
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|%
literal|8
condition|)
block|{
name|addr
operator|.
name|s6_addr
index|[
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
operator|-
literal|1
index|]
operator|&=
operator|(
operator|(
literal|0xff00
operator|>>
operator|(
name|plen
operator|%
literal|8
operator|)
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s/%d"
argument_list|,
name|getname6
argument_list|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|addr
argument_list|)
argument_list|,
name|plen
argument_list|)
expr_stmt|;
return|return
literal|1
operator|+
operator|(
name|plen
operator|+
literal|7
operator|)
operator|/
literal|8
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|bgp_attr_print
parameter_list|(
specifier|const
name|struct
name|bgp_attr
modifier|*
name|attr
parameter_list|,
specifier|const
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int16_t
name|af
decl_stmt|;
name|u_int8_t
name|safi
decl_stmt|,
name|snpa
decl_stmt|;
name|int
name|advance
decl_stmt|;
name|int
name|tlen
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|p
decl_stmt|;
name|char
name|buf
index|[
name|MAXHOSTNAMELEN
operator|+
literal|100
index|]
decl_stmt|;
name|p
operator|=
name|dat
expr_stmt|;
switch|switch
condition|(
name|attr
operator|->
name|bgpa_type
condition|)
block|{
case|case
name|BGPTYPE_ORIGIN
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
name|printf
argument_list|(
literal|" invalid len"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|bgp_attr_origin
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGPTYPE_AS_PATH
case|:
if|if
condition|(
name|len
operator|%
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|" invalid len"
argument_list|)
expr_stmt|;
break|break;
block|}
while|while
condition|(
name|p
operator|<
name|dat
operator|+
name|len
condition|)
block|{
comment|/* 			 * under RFC1965, p[0] means: 			 * 1: AS_SET 2: AS_SEQUENCE 			 * 3: AS_CONFED_SET 4: AS_CONFED_SEQUENCE 			 */
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
literal|3
operator|||
name|p
index|[
literal|0
index|]
operator|==
literal|4
condition|)
name|printf
argument_list|(
literal|"confed"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
operator|(
name|p
index|[
literal|0
index|]
operator|&
literal|1
operator|)
condition|?
literal|"{"
else|:
literal|""
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
index|[
literal|1
index|]
operator|*
literal|2
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|printf
argument_list|(
literal|"%s%u"
argument_list|,
name|i
operator|==
literal|0
condition|?
literal|""
else|:
literal|" "
argument_list|,
name|EXTRACT_16BITS
argument_list|(
operator|&
name|p
index|[
literal|2
operator|+
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s"
argument_list|,
operator|(
name|p
index|[
literal|0
index|]
operator|&
literal|1
operator|)
condition|?
literal|"}"
else|:
literal|""
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|2
operator|+
name|p
index|[
literal|1
index|]
operator|*
literal|2
expr_stmt|;
block|}
break|break;
case|case
name|BGPTYPE_NEXT_HOP
case|:
if|if
condition|(
name|len
operator|!=
literal|4
condition|)
name|printf
argument_list|(
literal|" invalid len"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|getname
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGPTYPE_MULTI_EXIT_DISC
case|:
case|case
name|BGPTYPE_LOCAL_PREF
case|:
if|if
condition|(
name|len
operator|!=
literal|4
condition|)
name|printf
argument_list|(
literal|" invalid len"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" %u"
argument_list|,
name|EXTRACT_32BITS
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGPTYPE_ATOMIC_AGGREGATE
case|:
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|" invalid len"
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGPTYPE_AGGREGATOR
case|:
if|if
condition|(
name|len
operator|!=
literal|6
condition|)
block|{
name|printf
argument_list|(
literal|" invalid len"
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|" AS #%u, origin %s"
argument_list|,
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
argument_list|,
name|getname
argument_list|(
name|p
operator|+
literal|2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGPTYPE_COMMUNITIES
case|:
if|if
condition|(
name|len
operator|%
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|" invalid len"
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|+=
literal|4
control|)
block|{
name|u_int32_t
name|comm
decl_stmt|;
name|comm
operator|=
name|EXTRACT_32BITS
argument_list|(
operator|&
name|p
index|[
name|i
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|comm
condition|)
block|{
case|case
name|BGP_COMMUNITY_NO_EXPORT
case|:
name|printf
argument_list|(
literal|" NO_EXPORT"
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_COMMUNITY_NO_ADVERT
case|:
name|printf
argument_list|(
literal|" NO_ADVERTISE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_COMMUNITY_NO_EXPORT_SUBCONFED
case|:
name|printf
argument_list|(
literal|" NO_EXPORT_SUBCONFED"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|" (AS #%d value 0x%04x)"
argument_list|,
operator|(
name|comm
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
argument_list|,
name|comm
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
break|break;
case|case
name|BGPTYPE_MP_REACH_NLRI
case|:
name|af
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|safi
operator|=
name|p
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|safi
operator|>=
literal|128
condition|)
name|printf
argument_list|(
literal|" %s vendor specific,"
argument_list|,
name|af_name
argument_list|(
name|af
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|" %s %s,"
argument_list|,
name|af_name
argument_list|(
name|af
argument_list|)
argument_list|,
name|bgp_attr_nlri_safi
argument_list|(
name|safi
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|p
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
name|af
operator|==
name|AFNUM_INET
condition|)
empty_stmt|;
ifdef|#
directive|ifdef
name|INET6
elseif|else
if|if
condition|(
name|af
operator|==
name|AFNUM_INET6
condition|)
empty_stmt|;
endif|#
directive|endif
else|else
break|break;
name|tlen
operator|=
name|p
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|tlen
condition|)
block|{
name|printf
argument_list|(
literal|" nexthop"
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|tlen
condition|)
block|{
switch|switch
condition|(
name|af
condition|)
block|{
case|case
name|AFNUM_INET
case|:
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|getname
argument_list|(
name|p
operator|+
literal|1
operator|+
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|AFNUM_INET6
case|:
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|getname6
argument_list|(
name|p
operator|+
literal|1
operator|+
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|printf
argument_list|(
literal|" (unknown af)"
argument_list|)
expr_stmt|;
name|i
operator|=
name|tlen
expr_stmt|;
comment|/*exit loop*/
break|break;
block|}
block|}
name|printf
argument_list|(
literal|","
argument_list|)
expr_stmt|;
block|}
name|p
operator|+=
literal|1
operator|+
name|tlen
expr_stmt|;
name|snpa
operator|=
name|p
index|[
literal|0
index|]
expr_stmt|;
name|p
operator|++
expr_stmt|;
if|if
condition|(
name|snpa
condition|)
block|{
name|printf
argument_list|(
literal|" %u snpa"
argument_list|,
name|snpa
argument_list|)
expr_stmt|;
for|for
control|(
comment|/*nothing*/
init|;
name|snpa
operator|>
literal|0
condition|;
name|snpa
operator|--
control|)
block|{
name|printf
argument_list|(
literal|"(%d bytes)"
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|p
operator|+=
name|p
index|[
literal|0
index|]
operator|+
literal|1
expr_stmt|;
block|}
name|printf
argument_list|(
literal|","
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" NLRI"
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|-
operator|(
name|p
operator|-
name|dat
operator|)
operator|>
literal|0
condition|)
block|{
switch|switch
condition|(
name|af
condition|)
block|{
case|case
name|AFNUM_INET
case|:
name|advance
operator|=
name|decode_prefix4
argument_list|(
name|p
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|AFNUM_INET6
case|:
name|advance
operator|=
name|decode_prefix6
argument_list|(
name|p
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|printf
argument_list|(
literal|" (unknown af)"
argument_list|)
expr_stmt|;
name|advance
operator|=
literal|0
expr_stmt|;
name|p
operator|=
name|dat
operator|+
name|len
expr_stmt|;
break|break;
block|}
name|p
operator|+=
name|advance
expr_stmt|;
block|}
break|break;
case|case
name|BGPTYPE_MP_UNREACH_NLRI
case|:
name|af
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|safi
operator|=
name|p
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|safi
operator|>=
literal|128
condition|)
name|printf
argument_list|(
literal|" %s vendor specific,"
argument_list|,
name|af_name
argument_list|(
name|af
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|" %s %s,"
argument_list|,
name|af_name
argument_list|(
name|af
argument_list|)
argument_list|,
name|bgp_attr_nlri_safi
argument_list|(
name|safi
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|p
operator|+=
literal|3
expr_stmt|;
name|printf
argument_list|(
literal|" Withdraw"
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|-
operator|(
name|p
operator|-
name|dat
operator|)
operator|>
literal|0
condition|)
block|{
switch|switch
condition|(
name|af
condition|)
block|{
case|case
name|AFNUM_INET
case|:
name|advance
operator|=
name|decode_prefix4
argument_list|(
name|p
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|AFNUM_INET6
case|:
name|advance
operator|=
name|decode_prefix6
argument_list|(
name|p
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|printf
argument_list|(
literal|" (unknown af)"
argument_list|)
expr_stmt|;
name|advance
operator|=
literal|0
expr_stmt|;
name|p
operator|=
name|dat
operator|+
name|len
expr_stmt|;
break|break;
block|}
name|p
operator|+=
name|advance
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bgp_open_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|length
parameter_list|)
block|{
name|struct
name|bgp_open
name|bgpo
decl_stmt|;
name|struct
name|bgp_opt
name|bgpopt
decl_stmt|;
name|int
name|hlen
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|opt
decl_stmt|;
name|int
name|i
decl_stmt|;
name|TCHECK2
argument_list|(
name|dat
index|[
literal|0
index|]
argument_list|,
name|BGP_OPEN_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|bgpo
argument_list|,
name|dat
argument_list|,
name|BGP_OPEN_SIZE
argument_list|)
expr_stmt|;
name|hlen
operator|=
name|ntohs
argument_list|(
name|bgpo
operator|.
name|bgpo_len
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|": Version %d,"
argument_list|,
name|bgpo
operator|.
name|bgpo_version
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" AS #%u,"
argument_list|,
name|ntohs
argument_list|(
name|bgpo
operator|.
name|bgpo_myas
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Holdtime %u,"
argument_list|,
name|ntohs
argument_list|(
name|bgpo
operator|.
name|bgpo_holdtime
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" ID %s,"
argument_list|,
name|getname
argument_list|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|bgpo
operator|.
name|bgpo_id
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Option length %u"
argument_list|,
name|bgpo
operator|.
name|bgpo_optlen
argument_list|)
expr_stmt|;
comment|/* ugly! */
name|opt
operator|=
operator|&
operator|(
operator|(
specifier|const
expr|struct
name|bgp_open
operator|*
operator|)
name|dat
operator|)
operator|->
name|bgpo_optlen
expr_stmt|;
name|opt
operator|++
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|bgpo
operator|.
name|bgpo_optlen
condition|)
block|{
name|TCHECK2
argument_list|(
name|opt
index|[
name|i
index|]
argument_list|,
name|BGP_OPT_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|bgpopt
argument_list|,
operator|&
name|opt
index|[
name|i
index|]
argument_list|,
name|BGP_OPT_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|+
literal|2
operator|+
name|bgpopt
operator|.
name|bgpopt_len
operator|>
name|bgpo
operator|.
name|bgpo_optlen
condition|)
block|{
name|printf
argument_list|(
literal|" [|opt %d %d]"
argument_list|,
name|bgpopt
operator|.
name|bgpopt_len
argument_list|,
name|bgpopt
operator|.
name|bgpopt_type
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|" (option %s, len=%d)"
argument_list|,
name|bgp_opttype
argument_list|(
name|bgpopt
operator|.
name|bgpopt_type
argument_list|)
argument_list|,
name|bgpopt
operator|.
name|bgpopt_len
argument_list|)
expr_stmt|;
name|i
operator|+=
name|BGP_OPT_SIZE
operator|+
name|bgpopt
operator|.
name|bgpopt_len
expr_stmt|;
block|}
return|return;
name|trunc
label|:
name|printf
argument_list|(
literal|"[|BGP]"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgp_update_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|length
parameter_list|)
block|{
name|struct
name|bgp
name|bgp
decl_stmt|;
name|struct
name|bgp_attr
name|bgpa
decl_stmt|;
name|int
name|hlen
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|newline
decl_stmt|;
name|TCHECK2
argument_list|(
name|dat
index|[
literal|0
index|]
argument_list|,
name|BGP_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|bgp
argument_list|,
name|dat
argument_list|,
name|BGP_SIZE
argument_list|)
expr_stmt|;
name|hlen
operator|=
name|ntohs
argument_list|(
name|bgp
operator|.
name|bgp_len
argument_list|)
expr_stmt|;
name|p
operator|=
name|dat
operator|+
name|BGP_SIZE
expr_stmt|;
comment|/*XXX*/
name|printf
argument_list|(
literal|":"
argument_list|)
expr_stmt|;
comment|/* Unfeasible routes */
name|len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
condition|)
block|{
comment|/* 		 * Without keeping state from the original NLRI message, 		 * it's not possible to tell if this a v4 or v6 route, 		 * so only try to decode it if we're not v6 enabled. 	         */
ifdef|#
directive|ifdef
name|INET6
name|printf
argument_list|(
literal|" (Withdrawn routes: %d bytes)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
else|#
directive|else
name|char
name|buf
index|[
name|MAXHOSTNAMELEN
operator|+
literal|100
index|]
decl_stmt|;
name|TCHECK2
argument_list|(
name|p
index|[
literal|2
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|i
operator|=
literal|2
expr_stmt|;
name|printf
argument_list|(
literal|" (Withdrawn routes:"
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|<
literal|2
operator|+
name|len
condition|)
block|{
name|i
operator|+=
name|decode_prefix4
argument_list|(
operator|&
name|p
index|[
name|i
index|]
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|")\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|p
operator|+=
literal|2
operator|+
name|len
expr_stmt|;
name|TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|len
operator|=
name|EXTRACT_16BITS
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
condition|)
block|{
comment|/* do something more useful!*/
name|i
operator|=
literal|2
expr_stmt|;
name|printf
argument_list|(
literal|" (Path attributes:"
argument_list|)
expr_stmt|;
comment|/* ) */
name|newline
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|<
literal|2
operator|+
name|len
condition|)
block|{
name|int
name|alen
decl_stmt|,
name|aoff
decl_stmt|;
name|TCHECK2
argument_list|(
name|p
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|bgpa
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|bgpa
argument_list|,
operator|&
name|p
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|bgpa
argument_list|)
argument_list|)
expr_stmt|;
name|alen
operator|=
name|bgp_attr_len
argument_list|(
operator|&
name|bgpa
argument_list|)
expr_stmt|;
name|aoff
operator|=
name|bgp_attr_off
argument_list|(
operator|&
name|bgpa
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|&&
name|newline
condition|)
name|printf
argument_list|(
literal|"\n\t\t"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"("
argument_list|)
expr_stmt|;
comment|/* ) */
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|bgp_attr_type
argument_list|(
name|bgpa
operator|.
name|bgpa_type
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bgpa
operator|.
name|bgpa_flags
condition|)
block|{
name|printf
argument_list|(
literal|"[%s%s%s%s"
argument_list|,
name|bgpa
operator|.
name|bgpa_flags
operator|&
literal|0x80
condition|?
literal|"O"
else|:
literal|""
argument_list|,
name|bgpa
operator|.
name|bgpa_flags
operator|&
literal|0x40
condition|?
literal|"T"
else|:
literal|""
argument_list|,
name|bgpa
operator|.
name|bgpa_flags
operator|&
literal|0x20
condition|?
literal|"P"
else|:
literal|""
argument_list|,
name|bgpa
operator|.
name|bgpa_flags
operator|&
literal|0x10
condition|?
literal|"E"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|bgpa
operator|.
name|bgpa_flags
operator|&
literal|0xf
condition|)
name|printf
argument_list|(
literal|"+%x"
argument_list|,
name|bgpa
operator|.
name|bgpa_flags
operator|&
literal|0xf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
block|}
name|bgp_attr_print
argument_list|(
operator|&
name|bgpa
argument_list|,
operator|&
name|p
index|[
name|i
operator|+
name|aoff
index|]
argument_list|,
name|alen
argument_list|)
expr_stmt|;
name|newline
operator|=
literal|1
expr_stmt|;
comment|/* ( */
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
name|i
operator|+=
name|aoff
operator|+
name|alen
expr_stmt|;
block|}
comment|/* ( */
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
name|p
operator|+=
literal|2
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|len
operator|&&
name|dat
operator|+
name|length
operator|>
name|p
condition|)
name|printf
argument_list|(
literal|"\n\t\t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dat
operator|+
name|length
operator|>
name|p
condition|)
block|{
name|printf
argument_list|(
literal|"(NLRI:"
argument_list|)
expr_stmt|;
comment|/* ) */
while|while
condition|(
name|dat
operator|+
name|length
operator|>
name|p
condition|)
block|{
name|char
name|buf
index|[
name|MAXHOSTNAMELEN
operator|+
literal|100
index|]
decl_stmt|;
name|i
operator|=
name|decode_prefix4
argument_list|(
name|p
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
break|break;
name|p
operator|+=
name|i
expr_stmt|;
block|}
comment|/* ( */
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
return|return;
name|trunc
label|:
name|printf
argument_list|(
literal|"[|BGP]"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgp_notification_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|length
parameter_list|)
block|{
name|struct
name|bgp_notification
name|bgpn
decl_stmt|;
name|int
name|hlen
decl_stmt|;
name|TCHECK2
argument_list|(
name|dat
index|[
literal|0
index|]
argument_list|,
name|BGP_NOTIFICATION_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|bgpn
argument_list|,
name|dat
argument_list|,
name|BGP_NOTIFICATION_SIZE
argument_list|)
expr_stmt|;
name|hlen
operator|=
name|ntohs
argument_list|(
name|bgpn
operator|.
name|bgpn_len
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|": error %s,"
argument_list|,
name|bgp_notify_major
argument_list|(
name|bgpn
operator|.
name|bgpn_major
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" subcode %s"
argument_list|,
name|bgp_notify_minor
argument_list|(
name|bgpn
operator|.
name|bgpn_major
argument_list|,
name|bgpn
operator|.
name|bgpn_minor
argument_list|)
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|printf
argument_list|(
literal|"[|BGP]"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgp_header_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|length
parameter_list|)
block|{
name|struct
name|bgp
name|bgp
decl_stmt|;
name|TCHECK2
argument_list|(
name|dat
index|[
literal|0
index|]
argument_list|,
name|BGP_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|bgp
argument_list|,
name|dat
argument_list|,
name|BGP_SIZE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(%s"
argument_list|,
name|bgp_type
argument_list|(
name|bgp
operator|.
name|bgp_type
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ) */
switch|switch
condition|(
name|bgp
operator|.
name|bgp_type
condition|)
block|{
case|case
name|BGP_OPEN
case|:
name|bgp_open_print
argument_list|(
name|dat
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_UPDATE
case|:
name|bgp_update_print
argument_list|(
name|dat
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|BGP_NOTIFICATION
case|:
name|bgp_notification_print
argument_list|(
name|dat
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* ( */
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|printf
argument_list|(
literal|"[|BGP]"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bgp_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|length
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|p
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|ep
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|start
decl_stmt|;
specifier|const
name|u_char
name|marker
index|[]
init|=
block|{
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,  	}
decl_stmt|;
name|struct
name|bgp
name|bgp
decl_stmt|;
name|u_int16_t
name|hlen
decl_stmt|;
name|int
name|newline
decl_stmt|;
name|ep
operator|=
name|dat
operator|+
name|length
expr_stmt|;
if|if
condition|(
name|snapend
operator|<
name|dat
operator|+
name|length
condition|)
name|ep
operator|=
name|snapend
expr_stmt|;
name|printf
argument_list|(
literal|": BGP"
argument_list|)
expr_stmt|;
name|p
operator|=
name|dat
expr_stmt|;
name|newline
operator|=
literal|0
expr_stmt|;
name|start
operator|=
name|p
expr_stmt|;
while|while
condition|(
name|p
operator|<
name|snapend
condition|)
block|{
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
condition|)
break|break;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|!=
literal|0xff
condition|)
block|{
name|p
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|TTEST2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|marker
argument_list|)
argument_list|)
condition|)
break|break;
if|if
condition|(
name|memcmp
argument_list|(
name|p
argument_list|,
name|marker
argument_list|,
sizeof|sizeof
argument_list|(
name|marker
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|p
operator|++
expr_stmt|;
continue|continue;
block|}
comment|/* found BGP header */
name|TCHECK2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
name|BGP_SIZE
argument_list|)
expr_stmt|;
comment|/*XXX*/
name|memcpy
argument_list|(
operator|&
name|bgp
argument_list|,
name|p
argument_list|,
name|BGP_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|!=
name|p
condition|)
name|printf
argument_list|(
literal|" [|BGP]"
argument_list|)
expr_stmt|;
name|hlen
operator|=
name|ntohs
argument_list|(
name|bgp
operator|.
name|bgp_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|&&
name|newline
condition|)
name|printf
argument_list|(
literal|"\n\t"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|TTEST2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
name|hlen
argument_list|)
condition|)
block|{
name|bgp_header_print
argument_list|(
name|p
argument_list|,
name|hlen
argument_list|)
expr_stmt|;
name|newline
operator|=
literal|1
expr_stmt|;
name|p
operator|+=
name|hlen
expr_stmt|;
name|start
operator|=
name|p
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"[|BGP %s]"
argument_list|,
name|bgp_type
argument_list|(
name|bgp
operator|.
name|bgp_type
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return;
name|trunc
label|:
name|printf
argument_list|(
literal|" [|BGP]"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1991, 1992, 1993, 1994, 1995, 1996  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the University of California, Lawrence Berkeley Laboratory,  * Berkeley, CA.  The name of the University may not be used to  * endorse or promote products derived from this software without  * specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * Initial contribution from Jeff Honig (jch@MITCHELL.CIT.CORNELL.EDU).  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-egp.c,v 1.24 1999/11/21 09:36:51 fenner Exp $ (LBL)"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_struct
struct|struct
name|egp_packet
block|{
name|u_char
name|egp_version
decl_stmt|;
define|#
directive|define
name|EGP_VERSION
value|2
name|u_char
name|egp_type
decl_stmt|;
define|#
directive|define
name|EGPT_ACQUIRE
value|3
define|#
directive|define
name|EGPT_REACH
value|5
define|#
directive|define
name|EGPT_POLL
value|2
define|#
directive|define
name|EGPT_UPDATE
value|1
define|#
directive|define
name|EGPT_ERROR
value|8
name|u_char
name|egp_code
decl_stmt|;
define|#
directive|define
name|EGPC_REQUEST
value|0
define|#
directive|define
name|EGPC_CONFIRM
value|1
define|#
directive|define
name|EGPC_REFUSE
value|2
define|#
directive|define
name|EGPC_CEASE
value|3
define|#
directive|define
name|EGPC_CEASEACK
value|4
define|#
directive|define
name|EGPC_HELLO
value|0
define|#
directive|define
name|EGPC_HEARDU
value|1
name|u_char
name|egp_status
decl_stmt|;
define|#
directive|define
name|EGPS_UNSPEC
value|0
define|#
directive|define
name|EGPS_ACTIVE
value|1
define|#
directive|define
name|EGPS_PASSIVE
value|2
define|#
directive|define
name|EGPS_NORES
value|3
define|#
directive|define
name|EGPS_ADMIN
value|4
define|#
directive|define
name|EGPS_GODOWN
value|5
define|#
directive|define
name|EGPS_PARAM
value|6
define|#
directive|define
name|EGPS_PROTO
value|7
define|#
directive|define
name|EGPS_INDET
value|0
define|#
directive|define
name|EGPS_UP
value|1
define|#
directive|define
name|EGPS_DOWN
value|2
define|#
directive|define
name|EGPS_UNSOL
value|0x80
name|u_short
name|egp_checksum
decl_stmt|;
name|u_short
name|egp_as
decl_stmt|;
name|u_short
name|egp_sequence
decl_stmt|;
union|union
block|{
name|u_short
name|egpu_hello
decl_stmt|;
name|u_char
name|egpu_gws
index|[
literal|2
index|]
decl_stmt|;
name|u_short
name|egpu_reason
decl_stmt|;
define|#
directive|define
name|EGPR_UNSPEC
value|0
define|#
directive|define
name|EGPR_BADHEAD
value|1
define|#
directive|define
name|EGPR_BADDATA
value|2
define|#
directive|define
name|EGPR_NOREACH
value|3
define|#
directive|define
name|EGPR_XSPOLL
value|4
define|#
directive|define
name|EGPR_NORESP
value|5
define|#
directive|define
name|EGPR_UVERSION
value|6
block|}
name|egp_handg
union|;
define|#
directive|define
name|egp_hello
value|egp_handg.egpu_hello
define|#
directive|define
name|egp_intgw
value|egp_handg.egpu_gws[0]
define|#
directive|define
name|egp_extgw
value|egp_handg.egpu_gws[1]
define|#
directive|define
name|egp_reason
value|egp_handg.egpu_reason
union|union
block|{
name|u_short
name|egpu_poll
decl_stmt|;
name|u_int32_t
name|egpu_sourcenet
decl_stmt|;
block|}
name|egp_pands
union|;
define|#
directive|define
name|egp_poll
value|egp_pands.egpu_poll
define|#
directive|define
name|egp_sourcenet
value|egp_pands.egpu_sourcenet
block|}
struct|;
end_struct

begin_decl_stmt
name|char
modifier|*
name|egp_acquire_codes
index|[]
init|=
block|{
literal|"request"
block|,
literal|"confirm"
block|,
literal|"refuse"
block|,
literal|"cease"
block|,
literal|"cease_ack"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|egp_acquire_status
index|[]
init|=
block|{
literal|"unspecified"
block|,
literal|"active_mode"
block|,
literal|"passive_mode"
block|,
literal|"insufficient_resources"
block|,
literal|"administratively_prohibited"
block|,
literal|"going_down"
block|,
literal|"parameter_violation"
block|,
literal|"protocol_violation"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|egp_reach_codes
index|[]
init|=
block|{
literal|"hello"
block|,
literal|"i-h-u"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|egp_status_updown
index|[]
init|=
block|{
literal|"indeterminate"
block|,
literal|"up"
block|,
literal|"down"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|egp_reasons
index|[]
init|=
block|{
literal|"unspecified"
block|,
literal|"bad_EGP_header_format"
block|,
literal|"bad_EGP_data_field_format"
block|,
literal|"reachability_info_unavailable"
block|,
literal|"excessive_polling_rate"
block|,
literal|"no_response"
block|,
literal|"unsupported_version"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|egpnrprint
parameter_list|(
specifier|register
specifier|const
name|struct
name|egp_packet
modifier|*
name|egp
parameter_list|,
specifier|register
name|u_int
name|length
parameter_list|)
block|{
specifier|register
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
name|u_int32_t
name|addr
decl_stmt|;
specifier|register
name|u_int32_t
name|net
decl_stmt|;
specifier|register
name|u_int
name|netlen
decl_stmt|;
name|int
name|gateways
decl_stmt|,
name|distances
decl_stmt|,
name|networks
decl_stmt|;
name|int
name|t_gateways
decl_stmt|;
name|char
modifier|*
name|comma
decl_stmt|;
name|addr
operator|=
name|egp
operator|->
name|egp_sourcenet
expr_stmt|;
if|if
condition|(
name|IN_CLASSA
argument_list|(
name|addr
argument_list|)
condition|)
block|{
name|net
operator|=
name|addr
operator|&
name|IN_CLASSA_NET
expr_stmt|;
name|netlen
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IN_CLASSB
argument_list|(
name|addr
argument_list|)
condition|)
block|{
name|net
operator|=
name|addr
operator|&
name|IN_CLASSB_NET
expr_stmt|;
name|netlen
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IN_CLASSC
argument_list|(
name|addr
argument_list|)
condition|)
block|{
name|net
operator|=
name|addr
operator|&
name|IN_CLASSC_NET
expr_stmt|;
name|netlen
operator|=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|net
operator|=
literal|0
expr_stmt|;
name|netlen
operator|=
literal|0
expr_stmt|;
block|}
name|cp
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|(
name|egp
operator|+
literal|1
operator|)
expr_stmt|;
name|t_gateways
operator|=
name|egp
operator|->
name|egp_intgw
operator|+
name|egp
operator|->
name|egp_extgw
expr_stmt|;
for|for
control|(
name|gateways
operator|=
literal|0
init|;
name|gateways
operator|<
name|t_gateways
condition|;
operator|++
name|gateways
control|)
block|{
comment|/* Pickup host part of gateway address */
name|addr
operator|=
literal|0
expr_stmt|;
name|TCHECK2
argument_list|(
name|cp
index|[
literal|0
index|]
argument_list|,
literal|4
operator|-
name|netlen
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|netlen
condition|)
block|{
case|case
literal|1
case|:
name|addr
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
comment|/* fall through */
case|case
literal|2
case|:
name|addr
operator|=
operator|(
name|addr
operator|<<
literal|8
operator|)
operator||
operator|*
name|cp
operator|++
expr_stmt|;
comment|/* fall through */
case|case
literal|3
case|:
name|addr
operator|=
operator|(
name|addr
operator|<<
literal|8
operator|)
operator||
operator|*
name|cp
operator|++
expr_stmt|;
block|}
name|addr
operator||=
name|net
expr_stmt|;
name|TCHECK2
argument_list|(
name|cp
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|distances
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|" %s %s "
argument_list|,
name|gateways
operator|<
operator|(
name|int
operator|)
name|egp
operator|->
name|egp_intgw
condition|?
literal|"int"
else|:
literal|"ext"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|""
expr_stmt|;
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|distances
operator|>=
literal|0
condition|)
block|{
name|TCHECK2
argument_list|(
name|cp
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%sd%d:"
argument_list|,
name|comma
argument_list|,
operator|(
name|int
operator|)
operator|*
name|cp
operator|++
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|", "
expr_stmt|;
name|networks
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
while|while
condition|(
operator|--
name|networks
operator|>=
literal|0
condition|)
block|{
comment|/* Pickup network number */
name|TCHECK2
argument_list|(
name|cp
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|addr
operator|=
operator|(
name|u_int32_t
operator|)
operator|*
name|cp
operator|++
operator|<<
literal|24
expr_stmt|;
if|if
condition|(
name|IN_CLASSB
argument_list|(
name|addr
argument_list|)
condition|)
block|{
name|TCHECK2
argument_list|(
name|cp
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|addr
operator||=
operator|(
name|u_int32_t
operator|)
operator|*
name|cp
operator|++
operator|<<
literal|16
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|IN_CLASSA
argument_list|(
name|addr
argument_list|)
condition|)
block|{
name|TCHECK2
argument_list|(
name|cp
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|addr
operator||=
operator|(
name|u_int32_t
operator|)
operator|*
name|cp
operator|++
operator|<<
literal|16
expr_stmt|;
name|addr
operator||=
operator|(
name|u_int32_t
operator|)
operator|*
name|cp
operator|++
operator|<<
literal|8
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|putchar
argument_list|(
literal|')'
argument_list|)
expr_stmt|;
block|}
return|return;
name|trunc
label|:
name|fputs
argument_list|(
literal|"[|]"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|egp_print
parameter_list|(
specifier|register
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|register
name|u_int
name|length
parameter_list|,
specifier|register
specifier|const
name|u_char
modifier|*
name|bp2
parameter_list|)
block|{
specifier|register
specifier|const
name|struct
name|egp_packet
modifier|*
name|egp
decl_stmt|;
specifier|register
specifier|const
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
specifier|register
name|int
name|status
decl_stmt|;
specifier|register
name|int
name|code
decl_stmt|;
specifier|register
name|int
name|type
decl_stmt|;
name|egp
operator|=
operator|(
expr|struct
name|egp_packet
operator|*
operator|)
name|bp
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|bp2
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s> %s: egp: "
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|ip
operator|->
name|ip_src
argument_list|)
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|ip
operator|->
name|ip_dst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|egp
operator|->
name|egp_version
operator|!=
name|EGP_VERSION
condition|)
block|{
name|printf
argument_list|(
literal|"[version %d]"
argument_list|,
name|egp
operator|->
name|egp_version
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"as:%d seq:%d"
argument_list|,
name|ntohs
argument_list|(
name|egp
operator|->
name|egp_as
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|egp
operator|->
name|egp_sequence
argument_list|)
argument_list|)
expr_stmt|;
name|type
operator|=
name|egp
operator|->
name|egp_type
expr_stmt|;
name|code
operator|=
name|egp
operator|->
name|egp_code
expr_stmt|;
name|status
operator|=
name|egp
operator|->
name|egp_status
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|EGPT_ACQUIRE
case|:
name|printf
argument_list|(
literal|" acquire"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|EGPC_REQUEST
case|:
case|case
name|EGPC_CONFIRM
case|:
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|egp_acquire_codes
index|[
name|code
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|EGPS_UNSPEC
case|:
case|case
name|EGPS_ACTIVE
case|:
case|case
name|EGPS_PASSIVE
case|:
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|egp_acquire_status
index|[
name|status
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|" [status %d]"
argument_list|,
name|status
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|" hello:%d poll:%d"
argument_list|,
name|ntohs
argument_list|(
name|egp
operator|->
name|egp_hello
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|egp
operator|->
name|egp_poll
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|EGPC_REFUSE
case|:
case|case
name|EGPC_CEASE
case|:
case|case
name|EGPC_CEASEACK
case|:
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|egp_acquire_codes
index|[
name|code
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|EGPS_UNSPEC
case|:
case|case
name|EGPS_NORES
case|:
case|case
name|EGPS_ADMIN
case|:
case|case
name|EGPS_GODOWN
case|:
case|case
name|EGPS_PARAM
case|:
case|case
name|EGPS_PROTO
case|:
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|egp_acquire_status
index|[
name|status
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"[status %d]"
argument_list|,
name|status
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|printf
argument_list|(
literal|"[code %d]"
argument_list|,
name|code
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|EGPT_REACH
case|:
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|EGPC_HELLO
case|:
case|case
name|EGPC_HEARDU
case|:
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|egp_reach_codes
index|[
name|code
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|<=
name|EGPS_DOWN
condition|)
name|printf
argument_list|(
literal|" state:%s"
argument_list|,
name|egp_status_updown
index|[
name|status
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" [status %d]"
argument_list|,
name|status
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"[reach code %d]"
argument_list|,
name|code
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|EGPT_POLL
case|:
name|printf
argument_list|(
literal|" poll"
argument_list|)
expr_stmt|;
if|if
condition|(
name|egp
operator|->
name|egp_status
operator|<=
name|EGPS_DOWN
condition|)
name|printf
argument_list|(
literal|" state:%s"
argument_list|,
name|egp_status_updown
index|[
name|status
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" [status %d]"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" net:%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|egp
operator|->
name|egp_sourcenet
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|EGPT_UPDATE
case|:
name|printf
argument_list|(
literal|" update"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|EGPS_UNSOL
condition|)
block|{
name|status
operator|&=
operator|~
name|EGPS_UNSOL
expr_stmt|;
name|printf
argument_list|(
literal|" unsolicited"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|<=
name|EGPS_DOWN
condition|)
name|printf
argument_list|(
literal|" state:%s"
argument_list|,
name|egp_status_updown
index|[
name|status
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" [status %d]"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s int %d ext %d"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|egp
operator|->
name|egp_sourcenet
argument_list|)
argument_list|,
name|egp
operator|->
name|egp_intgw
argument_list|,
name|egp
operator|->
name|egp_extgw
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
name|egpnrprint
argument_list|(
name|egp
argument_list|,
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
name|EGPT_ERROR
case|:
name|printf
argument_list|(
literal|" error"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|<=
name|EGPS_DOWN
condition|)
name|printf
argument_list|(
literal|" state:%s"
argument_list|,
name|egp_status_updown
index|[
name|status
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" [status %d]"
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntohs
argument_list|(
name|egp
operator|->
name|egp_reason
argument_list|)
operator|<=
name|EGPR_UVERSION
condition|)
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|egp_reasons
index|[
name|ntohs
argument_list|(
name|egp
operator|->
name|egp_reason
argument_list|)
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" [reason %d]"
argument_list|,
name|ntohs
argument_list|(
name|egp
operator|->
name|egp_reason
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"[type %d]"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

end_unit


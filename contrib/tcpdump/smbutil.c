begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*     Copyright (C) Andrew Tridgell 1995-1999     This software may be distributed either under the terms of the    BSD-style license that accompanies tcpdump or the GNU GPL version 2    or later */
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/smbutil.c,v 1.12 2000/12/04 00:35:45 guy Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"smb.h"
end_include

begin_decl_stmt
specifier|extern
specifier|const
name|uchar
modifier|*
name|startbuf
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*******************************************************************   interpret a 32 bit dos packed date/time to some parameters ********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|interpret_dos_date
parameter_list|(
name|uint32
name|date
parameter_list|,
name|int
modifier|*
name|year
parameter_list|,
name|int
modifier|*
name|month
parameter_list|,
name|int
modifier|*
name|day
parameter_list|,
name|int
modifier|*
name|hour
parameter_list|,
name|int
modifier|*
name|minute
parameter_list|,
name|int
modifier|*
name|second
parameter_list|)
block|{
name|uint32
name|p0
decl_stmt|,
name|p1
decl_stmt|,
name|p2
decl_stmt|,
name|p3
decl_stmt|;
name|p0
operator|=
name|date
operator|&
literal|0xFF
expr_stmt|;
name|p1
operator|=
operator|(
operator|(
name|date
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|p2
operator|=
operator|(
operator|(
name|date
operator|&
literal|0xFF0000
operator|)
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|p3
operator|=
operator|(
operator|(
name|date
operator|&
literal|0xFF000000
operator|)
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
operator|*
name|second
operator|=
literal|2
operator|*
operator|(
name|p0
operator|&
literal|0x1F
operator|)
expr_stmt|;
operator|*
name|minute
operator|=
operator|(
operator|(
name|p0
operator|>>
literal|5
operator|)
operator|&
literal|0xFF
operator|)
operator|+
operator|(
operator|(
name|p1
operator|&
literal|0x7
operator|)
operator|<<
literal|3
operator|)
expr_stmt|;
operator|*
name|hour
operator|=
operator|(
name|p1
operator|>>
literal|3
operator|)
operator|&
literal|0xFF
expr_stmt|;
operator|*
name|day
operator|=
operator|(
name|p2
operator|&
literal|0x1F
operator|)
expr_stmt|;
operator|*
name|month
operator|=
operator|(
operator|(
name|p2
operator|>>
literal|5
operator|)
operator|&
literal|0xFF
operator|)
operator|+
operator|(
operator|(
name|p3
operator|&
literal|0x1
operator|)
operator|<<
literal|3
operator|)
operator|-
literal|1
expr_stmt|;
operator|*
name|year
operator|=
operator|(
operator|(
name|p3
operator|>>
literal|1
operator|)
operator|&
literal|0xFF
operator|)
operator|+
literal|80
expr_stmt|;
block|}
end_function

begin_comment
comment|/*******************************************************************   create a unix date from a dos date ********************************************************************/
end_comment

begin_function
specifier|static
name|time_t
name|make_unix_date
parameter_list|(
specifier|const
name|void
modifier|*
name|date_ptr
parameter_list|)
block|{
name|uint32
name|dos_date
init|=
literal|0
decl_stmt|;
name|struct
name|tm
name|t
decl_stmt|;
name|dos_date
operator|=
name|IVAL
argument_list|(
name|date_ptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dos_date
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|interpret_dos_date
argument_list|(
name|dos_date
argument_list|,
operator|&
name|t
operator|.
name|tm_year
argument_list|,
operator|&
name|t
operator|.
name|tm_mon
argument_list|,
operator|&
name|t
operator|.
name|tm_mday
argument_list|,
operator|&
name|t
operator|.
name|tm_hour
argument_list|,
operator|&
name|t
operator|.
name|tm_min
argument_list|,
operator|&
name|t
operator|.
name|tm_sec
argument_list|)
expr_stmt|;
name|t
operator|.
name|tm_wday
operator|=
literal|1
expr_stmt|;
name|t
operator|.
name|tm_yday
operator|=
literal|1
expr_stmt|;
name|t
operator|.
name|tm_isdst
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|mktime
argument_list|(
operator|&
name|t
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*******************************************************************   create a unix date from a dos date ********************************************************************/
end_comment

begin_function
specifier|static
name|time_t
name|make_unix_date2
parameter_list|(
specifier|const
name|void
modifier|*
name|date_ptr
parameter_list|)
block|{
name|uint32
name|x
decl_stmt|,
name|x2
decl_stmt|;
name|x
operator|=
name|IVAL
argument_list|(
name|date_ptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|x2
operator|=
operator|(
operator|(
name|x
operator|&
literal|0xFFFF
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|x
operator|&
literal|0xFFFF0000
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
name|SIVAL
argument_list|(
operator|&
name|x
argument_list|,
literal|0
argument_list|,
name|x2
argument_list|)
expr_stmt|;
return|return
operator|(
name|make_unix_date
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|x
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************** interpret an 8 byte "filetime" structure to a time_t It's originally in "100ns units since jan 1st 1601" ****************************************************************************/
end_comment

begin_function
specifier|static
name|time_t
name|interpret_long_date
parameter_list|(
specifier|const
name|char
modifier|*
name|p
parameter_list|)
block|{
name|double
name|d
decl_stmt|;
name|time_t
name|ret
decl_stmt|;
comment|/* this gives us seconds since jan 1st 1601 (approx) */
name|d
operator|=
operator|(
name|IVAL
argument_list|(
name|p
argument_list|,
literal|4
argument_list|)
operator|*
literal|256.0
operator|+
name|CVAL
argument_list|(
name|p
argument_list|,
literal|3
argument_list|)
operator|)
operator|*
operator|(
literal|1.0e-7
operator|*
operator|(
literal|1
operator|<<
literal|24
operator|)
operator|)
expr_stmt|;
comment|/* now adjust by 369 years to make the secs since 1970 */
name|d
operator|-=
literal|369.0
operator|*
literal|365.25
operator|*
literal|24
operator|*
literal|60
operator|*
literal|60
expr_stmt|;
comment|/* and a fudge factor as we got it wrong by a few days */
name|d
operator|+=
operator|(
literal|3
operator|*
literal|24
operator|*
literal|60
operator|*
literal|60
operator|+
literal|6
operator|*
literal|60
operator|*
literal|60
operator|+
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|d
operator|<
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|ret
operator|=
operator|(
name|time_t
operator|)
name|d
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************** interpret the weird netbios "name". Return the name type, or -1 if we run past the end of the buffer ****************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|name_interpret
parameter_list|(
specifier|const
name|uchar
modifier|*
name|in
parameter_list|,
specifier|const
name|uchar
modifier|*
name|maxbuf
parameter_list|,
name|char
modifier|*
name|out
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|in
operator|>=
name|maxbuf
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* name goes past the end of the buffer */
name|TCHECK2
argument_list|(
operator|*
name|in
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|len
operator|=
operator|(
operator|*
name|in
operator|++
operator|)
operator|/
literal|2
expr_stmt|;
operator|*
name|out
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|30
operator|||
name|len
operator|<
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
while|while
condition|(
name|len
operator|--
condition|)
block|{
if|if
condition|(
name|in
operator|+
literal|1
operator|>=
name|maxbuf
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* name goes past the end of the buffer */
name|TCHECK2
argument_list|(
operator|*
name|in
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
index|[
literal|0
index|]
operator|<
literal|'A'
operator|||
name|in
index|[
literal|0
index|]
operator|>
literal|'P'
operator|||
name|in
index|[
literal|1
index|]
operator|<
literal|'A'
operator|||
name|in
index|[
literal|1
index|]
operator|>
literal|'P'
condition|)
block|{
operator|*
name|out
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
operator|*
name|out
operator|=
operator|(
operator|(
name|in
index|[
literal|0
index|]
operator|-
literal|'A'
operator|)
operator|<<
literal|4
operator|)
operator|+
operator|(
name|in
index|[
literal|1
index|]
operator|-
literal|'A'
operator|)
expr_stmt|;
name|in
operator|+=
literal|2
expr_stmt|;
name|out
operator|++
expr_stmt|;
block|}
operator|*
name|out
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|out
index|[
operator|-
literal|1
index|]
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
name|trunc
label|:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************** find a pointer to a netbios name ****************************************************************************/
end_comment

begin_function
specifier|static
specifier|const
name|uchar
modifier|*
name|name_ptr
parameter_list|(
specifier|const
name|uchar
modifier|*
name|buf
parameter_list|,
name|int
name|ofs
parameter_list|,
specifier|const
name|uchar
modifier|*
name|maxbuf
parameter_list|)
block|{
specifier|const
name|uchar
modifier|*
name|p
decl_stmt|;
name|uchar
name|c
decl_stmt|;
name|p
operator|=
name|buf
operator|+
name|ofs
expr_stmt|;
if|if
condition|(
name|p
operator|>=
name|maxbuf
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* name goes past the end of the buffer */
name|TCHECK2
argument_list|(
operator|*
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|c
operator|=
operator|*
name|p
expr_stmt|;
comment|/* XXX - this should use the same code that the DNS dissector does */
if|if
condition|(
operator|(
name|c
operator|&
literal|0xC0
operator|)
operator|==
literal|0xC0
condition|)
block|{
name|uint16
name|l
init|=
name|RSVAL
argument_list|(
name|buf
argument_list|,
name|ofs
argument_list|)
operator|&
literal|0x3FFF
decl_stmt|;
if|if
condition|(
name|l
operator|==
literal|0
condition|)
block|{
comment|/* We have a pointer that points to itself. */
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|p
operator|=
name|buf
operator|+
name|l
expr_stmt|;
if|if
condition|(
name|p
operator|>=
name|maxbuf
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* name goes past the end of the buffer */
name|TCHECK2
argument_list|(
operator|*
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|buf
operator|+
name|l
operator|)
return|;
block|}
else|else
return|return
operator|(
name|buf
operator|+
name|ofs
operator|)
return|;
name|trunc
label|:
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* name goes past the end of the buffer */
block|}
end_function

begin_comment
comment|/**************************************************************************** extract a netbios name from a buf ****************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|name_extract
parameter_list|(
specifier|const
name|uchar
modifier|*
name|buf
parameter_list|,
name|int
name|ofs
parameter_list|,
specifier|const
name|uchar
modifier|*
name|maxbuf
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
specifier|const
name|uchar
modifier|*
name|p
init|=
name|name_ptr
argument_list|(
name|buf
argument_list|,
name|ofs
argument_list|,
name|maxbuf
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* error (probably name going past end of buffer) */
name|strcpy
argument_list|(
name|name
argument_list|,
literal|""
argument_list|)
expr_stmt|;
return|return
operator|(
name|name_interpret
argument_list|(
name|p
argument_list|,
name|maxbuf
argument_list|,
name|name
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************** return the total storage length of a mangled name ****************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|name_len
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|s
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|maxbuf
parameter_list|)
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|s0
init|=
name|s
decl_stmt|;
name|unsigned
name|char
name|c
decl_stmt|;
if|if
condition|(
name|s
operator|>=
name|maxbuf
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* name goes past the end of the buffer */
name|TCHECK2
argument_list|(
operator|*
name|s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|c
operator|=
operator|*
name|s
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|&
literal|0xC0
operator|)
operator|==
literal|0xC0
condition|)
return|return
operator|(
literal|2
operator|)
return|;
while|while
condition|(
operator|*
name|s
condition|)
block|{
if|if
condition|(
name|s
operator|>=
name|maxbuf
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* name goes past the end of the buffer */
name|TCHECK2
argument_list|(
operator|*
name|s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|s
operator|+=
operator|(
operator|*
name|s
operator|)
operator|+
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|PTR_DIFF
argument_list|(
name|s
argument_list|,
name|s0
argument_list|)
operator|+
literal|1
operator|)
return|;
name|trunc
label|:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* name goes past the end of the buffer */
block|}
end_function

begin_function
specifier|static
name|void
name|print_asc
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|isprint
argument_list|(
name|buf
index|[
name|i
index|]
argument_list|)
condition|?
name|buf
index|[
name|i
index|]
else|:
literal|'.'
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|name_type_str
parameter_list|(
name|int
name|name_type
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|f
init|=
name|NULL
decl_stmt|;
switch|switch
condition|(
name|name_type
condition|)
block|{
case|case
literal|0
case|:
name|f
operator|=
literal|"Workstation"
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
name|f
operator|=
literal|"Client?"
expr_stmt|;
break|break;
case|case
literal|0x20
case|:
name|f
operator|=
literal|"Server"
expr_stmt|;
break|break;
case|case
literal|0x1d
case|:
name|f
operator|=
literal|"Master Browser"
expr_stmt|;
break|break;
case|case
literal|0x1b
case|:
name|f
operator|=
literal|"Domain Controller"
expr_stmt|;
break|break;
case|case
literal|0x1e
case|:
name|f
operator|=
literal|"Browser Server"
expr_stmt|;
break|break;
default|default:
name|f
operator|=
literal|"Unknown"
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|f
operator|)
return|;
block|}
end_function

begin_function
name|void
name|print_data
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|len
operator|<=
literal|0
condition|)
return|return;
name|printf
argument_list|(
literal|"[%03X] "
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
control|)
block|{
name|printf
argument_list|(
literal|"%02X "
argument_list|,
operator|(
name|int
operator|)
name|buf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|%
literal|8
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|%
literal|16
operator|==
literal|0
condition|)
block|{
name|print_asc
argument_list|(
operator|&
name|buf
index|[
name|i
operator|-
literal|16
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|print_asc
argument_list|(
operator|&
name|buf
index|[
name|i
operator|-
literal|8
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|len
condition|)
name|printf
argument_list|(
literal|"[%03X] "
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|i
operator|%
literal|16
condition|)
block|{
name|int
name|n
decl_stmt|;
name|n
operator|=
literal|16
operator|-
operator|(
name|i
operator|%
literal|16
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|8
condition|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
name|printf
argument_list|(
literal|"   "
argument_list|)
expr_stmt|;
name|n
operator|=
name|MIN
argument_list|(
literal|8
argument_list|,
name|i
operator|%
literal|16
argument_list|)
expr_stmt|;
name|print_asc
argument_list|(
operator|&
name|buf
index|[
name|i
operator|-
operator|(
name|i
operator|%
literal|16
operator|)
index|]
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|n
operator|=
operator|(
name|i
operator|%
literal|16
operator|)
operator|-
name|n
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|0
condition|)
name|print_asc
argument_list|(
operator|&
name|buf
index|[
name|i
operator|-
name|n
index|]
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|write_bits
parameter_list|(
name|unsigned
name|int
name|val
parameter_list|,
name|char
modifier|*
name|fmt
parameter_list|)
block|{
name|char
modifier|*
name|p
init|=
name|fmt
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|(
name|p
operator|=
name|strchr
argument_list|(
name|fmt
argument_list|,
literal|'|'
argument_list|)
operator|)
condition|)
block|{
name|int
name|l
init|=
name|PTR_DIFF
argument_list|(
name|p
argument_list|,
name|fmt
argument_list|)
decl_stmt|;
if|if
condition|(
name|l
operator|&&
operator|(
name|val
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
condition|)
name|printf
argument_list|(
literal|"%.*s "
argument_list|,
name|l
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|fmt
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* convert a unicode string */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|unistr
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|int
modifier|*
name|len
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|1000
index|]
decl_stmt|;
name|int
name|l
init|=
literal|0
decl_stmt|;
specifier|static
name|int
name|use_unicode
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|use_unicode
operator|==
operator|-
literal|1
condition|)
block|{
name|char
modifier|*
name|p
init|=
name|getenv
argument_list|(
literal|"USE_UNICODE"
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
operator|&&
operator|(
name|atoi
argument_list|(
name|p
argument_list|)
operator|==
literal|1
operator|)
condition|)
name|use_unicode
operator|=
literal|1
expr_stmt|;
else|else
name|use_unicode
operator|=
literal|0
expr_stmt|;
block|}
comment|/* maybe it isn't unicode - a cheap trick */
if|if
condition|(
operator|!
name|use_unicode
operator|||
operator|(
name|s
index|[
literal|0
index|]
operator|&&
name|s
index|[
literal|1
index|]
operator|)
condition|)
block|{
operator|*
name|len
operator|=
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
literal|1
expr_stmt|;
return|return
name|s
return|;
block|}
operator|*
name|len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|s
index|[
literal|0
index|]
operator|==
literal|0
operator|&&
name|s
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
block|{
name|s
operator|++
expr_stmt|;
operator|*
name|len
operator|=
literal|1
expr_stmt|;
block|}
while|while
condition|(
name|l
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
operator|)
operator|&&
name|s
index|[
literal|0
index|]
operator|&&
name|s
index|[
literal|1
index|]
operator|==
literal|0
condition|)
block|{
name|buf
index|[
name|l
index|]
operator|=
name|s
index|[
literal|0
index|]
expr_stmt|;
name|s
operator|+=
literal|2
expr_stmt|;
name|l
operator|++
expr_stmt|;
operator|*
name|len
operator|+=
literal|2
expr_stmt|;
block|}
name|buf
index|[
name|l
index|]
operator|=
literal|0
expr_stmt|;
operator|*
name|len
operator|+=
literal|2
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|uchar
modifier|*
name|fdata1
parameter_list|(
specifier|const
name|uchar
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
specifier|const
name|uchar
modifier|*
name|maxbuf
parameter_list|)
block|{
name|int
name|reverse
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|attrib_fmt
init|=
literal|"READONLY|HIDDEN|SYSTEM|VOLUME|DIR|ARCHIVE|"
decl_stmt|;
name|int
name|len
decl_stmt|;
while|while
condition|(
operator|*
name|fmt
operator|&&
name|buf
operator|<
name|maxbuf
condition|)
block|{
switch|switch
condition|(
operator|*
name|fmt
condition|)
block|{
case|case
literal|'a'
case|:
name|write_bits
argument_list|(
name|CVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
argument_list|,
name|attrib_fmt
argument_list|)
expr_stmt|;
name|buf
operator|++
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
name|write_bits
argument_list|(
name|SVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
argument_list|,
name|attrib_fmt
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
break|break;
case|case
literal|'{'
case|:
block|{
name|char
name|bitfmt
index|[
literal|128
index|]
decl_stmt|;
name|char
modifier|*
name|p
init|=
name|strchr
argument_list|(
operator|++
name|fmt
argument_list|,
literal|'}'
argument_list|)
decl_stmt|;
name|int
name|l
init|=
name|PTR_DIFF
argument_list|(
name|p
argument_list|,
name|fmt
argument_list|)
decl_stmt|;
name|strncpy
argument_list|(
name|bitfmt
argument_list|,
name|fmt
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|bitfmt
index|[
name|l
index|]
operator|=
literal|0
expr_stmt|;
name|fmt
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|write_bits
argument_list|(
name|CVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
argument_list|,
name|bitfmt
argument_list|)
expr_stmt|;
name|buf
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'P'
case|:
block|{
name|int
name|l
init|=
name|atoi
argument_list|(
name|fmt
operator|+
literal|1
argument_list|)
decl_stmt|;
name|buf
operator|+=
name|l
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
while|while
condition|(
name|isdigit
argument_list|(
operator|*
name|fmt
argument_list|)
condition|)
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'r'
case|:
name|reverse
operator|=
operator|!
name|reverse
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
block|{
name|unsigned
name|int
name|x
init|=
name|reverse
condition|?
name|RIVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
else|:
name|IVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"%d (0x%x)"
argument_list|,
name|x
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|4
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'L'
case|:
block|{
name|unsigned
name|int
name|x1
init|=
name|reverse
condition|?
name|RIVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
else|:
name|IVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|x2
init|=
name|reverse
condition|?
name|RIVAL
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|)
else|:
name|IVAL
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|)
decl_stmt|;
if|if
condition|(
name|x2
condition|)
block|{
name|printf
argument_list|(
literal|"0x%08x:%08x"
argument_list|,
name|x2
argument_list|,
name|x1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%d (0x%08x%08x)"
argument_list|,
name|x1
argument_list|,
name|x2
argument_list|,
name|x1
argument_list|)
expr_stmt|;
block|}
name|buf
operator|+=
literal|8
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'d'
case|:
block|{
name|unsigned
name|int
name|x
init|=
name|reverse
condition|?
name|RSVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
else|:
name|SVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"%d (0x%x)"
argument_list|,
name|x
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'W'
case|:
block|{
name|unsigned
name|int
name|x
init|=
name|reverse
condition|?
name|RIVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
else|:
name|IVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"0x%X"
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|4
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'w'
case|:
block|{
name|unsigned
name|int
name|x
init|=
name|reverse
condition|?
name|RSVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
else|:
name|SVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"0x%X"
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'B'
case|:
block|{
name|unsigned
name|int
name|x
init|=
name|CVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"0x%X"
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|1
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'b'
case|:
block|{
name|unsigned
name|int
name|x
init|=
name|CVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"%d (0x%x)"
argument_list|,
name|x
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|1
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'S'
case|:
block|{
name|printf
argument_list|(
literal|"%.*s"
argument_list|,
operator|(
name|int
operator|)
name|PTR_DIFF
argument_list|(
name|maxbuf
argument_list|,
name|buf
argument_list|)
argument_list|,
name|unistr
argument_list|(
name|buf
argument_list|,
operator|&
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|buf
operator|+=
name|len
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'Z'
case|:
block|{
if|if
condition|(
operator|*
name|buf
operator|!=
literal|4
operator|&&
operator|*
name|buf
operator|!=
literal|2
condition|)
name|printf
argument_list|(
literal|"Error! ASCIIZ buffer of type %d (safety=%d)\n"
argument_list|,
operator|*
name|buf
argument_list|,
operator|(
name|int
operator|)
name|PTR_DIFF
argument_list|(
name|maxbuf
argument_list|,
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%.*s"
argument_list|,
operator|(
name|int
operator|)
name|PTR_DIFF
argument_list|(
name|maxbuf
argument_list|,
name|buf
operator|+
literal|1
argument_list|)
argument_list|,
name|unistr
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
operator|&
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|buf
operator|+=
name|len
operator|+
literal|1
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'s'
case|:
block|{
name|int
name|l
init|=
name|atoi
argument_list|(
name|fmt
operator|+
literal|1
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"%-*.*s"
argument_list|,
name|l
argument_list|,
name|l
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|+=
name|l
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
while|while
condition|(
name|isdigit
argument_list|(
operator|*
name|fmt
argument_list|)
condition|)
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'h'
case|:
block|{
name|int
name|l
init|=
name|atoi
argument_list|(
name|fmt
operator|+
literal|1
argument_list|)
decl_stmt|;
while|while
condition|(
name|l
operator|--
condition|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
operator|*
name|buf
operator|++
argument_list|)
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
while|while
condition|(
name|isdigit
argument_list|(
operator|*
name|fmt
argument_list|)
condition|)
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'n'
case|:
block|{
name|int
name|t
init|=
name|atoi
argument_list|(
name|fmt
operator|+
literal|1
argument_list|)
decl_stmt|;
name|char
name|nbuf
index|[
literal|255
index|]
decl_stmt|;
name|int
name|name_type
decl_stmt|;
name|int
name|len
decl_stmt|;
switch|switch
condition|(
name|t
condition|)
block|{
case|case
literal|1
case|:
name|name_type
operator|=
name|name_extract
argument_list|(
name|startbuf
argument_list|,
name|PTR_DIFF
argument_list|(
name|buf
argument_list|,
name|startbuf
argument_list|)
argument_list|,
name|maxbuf
argument_list|,
name|nbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|name_type
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
name|len
operator|=
name|name_len
argument_list|(
name|buf
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
goto|goto
name|trunc
goto|;
name|buf
operator|+=
name|len
expr_stmt|;
name|printf
argument_list|(
literal|"%-15.15s NameType=0x%02X (%s)"
argument_list|,
name|nbuf
argument_list|,
name|name_type
argument_list|,
name|name_type_str
argument_list|(
name|name_type
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|name_type
operator|=
name|buf
index|[
literal|15
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"%-15.15s NameType=0x%02X (%s)"
argument_list|,
name|buf
argument_list|,
name|name_type
argument_list|,
name|name_type_str
argument_list|(
name|name_type
argument_list|)
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|16
expr_stmt|;
break|break;
block|}
name|fmt
operator|++
expr_stmt|;
while|while
condition|(
name|isdigit
argument_list|(
operator|*
name|fmt
argument_list|)
condition|)
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
case|case
literal|'T'
case|:
block|{
name|time_t
name|t
decl_stmt|;
name|int
name|x
init|=
name|IVAL
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|atoi
argument_list|(
name|fmt
operator|+
literal|1
argument_list|)
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|x
operator|==
literal|0
operator|||
name|x
operator|==
operator|-
literal|1
operator|||
name|x
operator|==
literal|0xFFFFFFFF
condition|)
name|t
operator|=
literal|0
expr_stmt|;
else|else
name|t
operator|=
name|make_unix_date
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|x
operator|==
literal|0
operator|||
name|x
operator|==
operator|-
literal|1
operator|||
name|x
operator|==
literal|0xFFFFFFFF
condition|)
name|t
operator|=
literal|0
expr_stmt|;
else|else
name|t
operator|=
name|make_unix_date2
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|t
operator|=
name|interpret_long_date
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|8
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|t
condition|?
name|asctime
argument_list|(
name|localtime
argument_list|(
operator|&
name|t
argument_list|)
argument_list|)
else|:
literal|"NULL\n"
argument_list|)
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
while|while
condition|(
name|isdigit
argument_list|(
operator|*
name|fmt
argument_list|)
condition|)
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
default|default:
name|putchar
argument_list|(
operator|*
name|fmt
argument_list|)
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|buf
operator|>=
name|maxbuf
operator|&&
operator|*
name|fmt
condition|)
name|printf
argument_list|(
literal|"END OF BUFFER\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|buf
operator|)
return|;
name|trunc
label|:
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"WARNING: Short packet. Try increasing the snap length\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|const
name|uchar
modifier|*
name|fdata
parameter_list|(
specifier|const
name|uchar
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
specifier|const
name|uchar
modifier|*
name|maxbuf
parameter_list|)
block|{
specifier|static
name|int
name|depth
init|=
literal|0
decl_stmt|;
name|char
name|s
index|[
literal|128
index|]
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
while|while
condition|(
operator|*
name|fmt
condition|)
block|{
switch|switch
condition|(
operator|*
name|fmt
condition|)
block|{
case|case
literal|'*'
case|:
name|fmt
operator|++
expr_stmt|;
while|while
condition|(
name|buf
operator|<
name|maxbuf
condition|)
block|{
specifier|const
name|uchar
modifier|*
name|buf2
decl_stmt|;
name|depth
operator|++
expr_stmt|;
name|buf2
operator|=
name|fdata
argument_list|(
name|buf
argument_list|,
name|fmt
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
name|depth
operator|--
expr_stmt|;
if|if
condition|(
name|buf2
operator|==
name|buf
condition|)
return|return
operator|(
name|buf
operator|)
return|;
name|buf
operator|=
name|buf2
expr_stmt|;
block|}
break|break;
case|case
literal|'|'
case|:
name|fmt
operator|++
expr_stmt|;
if|if
condition|(
name|buf
operator|>=
name|maxbuf
condition|)
return|return
operator|(
name|buf
operator|)
return|;
break|break;
case|case
literal|'%'
case|:
name|fmt
operator|++
expr_stmt|;
name|buf
operator|=
name|maxbuf
expr_stmt|;
break|break;
case|case
literal|'#'
case|:
name|fmt
operator|++
expr_stmt|;
return|return
operator|(
name|buf
operator|)
return|;
break|break;
case|case
literal|'['
case|:
name|fmt
operator|++
expr_stmt|;
if|if
condition|(
name|buf
operator|>=
name|maxbuf
condition|)
return|return
operator|(
name|buf
operator|)
return|;
name|memset
argument_list|(
name|s
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|fmt
argument_list|,
literal|']'
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|s
argument_list|,
name|fmt
argument_list|,
name|p
operator|-
name|fmt
argument_list|)
expr_stmt|;
name|fmt
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|buf
operator|=
name|fdata1
argument_list|(
name|buf
argument_list|,
name|s
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
break|break;
default|default:
name|putchar
argument_list|(
operator|*
name|fmt
argument_list|)
expr_stmt|;
name|fmt
operator|++
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|depth
operator|&&
name|buf
operator|<
name|maxbuf
condition|)
block|{
name|int
name|len
init|=
name|PTR_DIFF
argument_list|(
name|maxbuf
argument_list|,
name|buf
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Data: (%d bytes)\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|print_data
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|buf
operator|+
name|len
operator|)
return|;
block|}
return|return
operator|(
name|buf
operator|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|code
decl_stmt|;
name|char
modifier|*
name|message
decl_stmt|;
block|}
name|err_code_struct
typedef|;
end_typedef

begin_comment
comment|/* Dos Error Messages */
end_comment

begin_decl_stmt
specifier|static
name|err_code_struct
name|dos_msgs
index|[]
init|=
block|{
block|{
literal|"ERRbadfunc"
block|,
literal|1
block|,
literal|"Invalid function."
block|}
block|,
block|{
literal|"ERRbadfile"
block|,
literal|2
block|,
literal|"File not found."
block|}
block|,
block|{
literal|"ERRbadpath"
block|,
literal|3
block|,
literal|"Directory invalid."
block|}
block|,
block|{
literal|"ERRnofids"
block|,
literal|4
block|,
literal|"No file descriptors available"
block|}
block|,
block|{
literal|"ERRnoaccess"
block|,
literal|5
block|,
literal|"Access denied."
block|}
block|,
block|{
literal|"ERRbadfid"
block|,
literal|6
block|,
literal|"Invalid file handle."
block|}
block|,
block|{
literal|"ERRbadmcb"
block|,
literal|7
block|,
literal|"Memory control blocks destroyed."
block|}
block|,
block|{
literal|"ERRnomem"
block|,
literal|8
block|,
literal|"Insufficient server memory to perform the requested function."
block|}
block|,
block|{
literal|"ERRbadmem"
block|,
literal|9
block|,
literal|"Invalid memory block address."
block|}
block|,
block|{
literal|"ERRbadenv"
block|,
literal|10
block|,
literal|"Invalid environment."
block|}
block|,
block|{
literal|"ERRbadformat"
block|,
literal|11
block|,
literal|"Invalid format."
block|}
block|,
block|{
literal|"ERRbadaccess"
block|,
literal|12
block|,
literal|"Invalid open mode."
block|}
block|,
block|{
literal|"ERRbaddata"
block|,
literal|13
block|,
literal|"Invalid data."
block|}
block|,
block|{
literal|"ERR"
block|,
literal|14
block|,
literal|"reserved."
block|}
block|,
block|{
literal|"ERRbaddrive"
block|,
literal|15
block|,
literal|"Invalid drive specified."
block|}
block|,
block|{
literal|"ERRremcd"
block|,
literal|16
block|,
literal|"A Delete Directory request attempted  to  remove  the  server's  current directory."
block|}
block|,
block|{
literal|"ERRdiffdevice"
block|,
literal|17
block|,
literal|"Not same device."
block|}
block|,
block|{
literal|"ERRnofiles"
block|,
literal|18
block|,
literal|"A File Search command can find no more files matching the specified criteria."
block|}
block|,
block|{
literal|"ERRbadshare"
block|,
literal|32
block|,
literal|"The sharing mode specified for an Open conflicts with existing  FIDs  on the file."
block|}
block|,
block|{
literal|"ERRlock"
block|,
literal|33
block|,
literal|"A Lock request conflicted with an existing lock or specified an  invalid mode,  or an Unlock requested attempted to remove a lock held by another process."
block|}
block|,
block|{
literal|"ERRfilexists"
block|,
literal|80
block|,
literal|"The file named in a Create Directory, Make  New  File  or  Link  request already exists."
block|}
block|,
block|{
literal|"ERRbadpipe"
block|,
literal|230
block|,
literal|"Pipe invalid."
block|}
block|,
block|{
literal|"ERRpipebusy"
block|,
literal|231
block|,
literal|"All instances of the requested pipe are busy."
block|}
block|,
block|{
literal|"ERRpipeclosing"
block|,
literal|232
block|,
literal|"Pipe close in progress."
block|}
block|,
block|{
literal|"ERRnotconnected"
block|,
literal|233
block|,
literal|"No process on other end of pipe."
block|}
block|,
block|{
literal|"ERRmoredata"
block|,
literal|234
block|,
literal|"There is more data to be returned."
block|}
block|,
block|{
name|NULL
block|,
operator|-
literal|1
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Server Error Messages */
end_comment

begin_decl_stmt
name|err_code_struct
name|server_msgs
index|[]
init|=
block|{
block|{
literal|"ERRerror"
block|,
literal|1
block|,
literal|"Non-specific error code."
block|}
block|,
block|{
literal|"ERRbadpw"
block|,
literal|2
block|,
literal|"Bad password - name/password pair in a Tree Connect or Session Setup are invalid."
block|}
block|,
block|{
literal|"ERRbadtype"
block|,
literal|3
block|,
literal|"reserved."
block|}
block|,
block|{
literal|"ERRaccess"
block|,
literal|4
block|,
literal|"The requester does not have  the  necessary  access  rights  within  the specified  context for the requested function. The context is defined by the TID or the UID."
block|}
block|,
block|{
literal|"ERRinvnid"
block|,
literal|5
block|,
literal|"The tree ID (TID) specified in a command was invalid."
block|}
block|,
block|{
literal|"ERRinvnetname"
block|,
literal|6
block|,
literal|"Invalid network name in tree connect."
block|}
block|,
block|{
literal|"ERRinvdevice"
block|,
literal|7
block|,
literal|"Invalid device - printer request made to non-printer connection or  non-printer request made to printer connection."
block|}
block|,
block|{
literal|"ERRqfull"
block|,
literal|49
block|,
literal|"Print queue full (files) -- returned by open print file."
block|}
block|,
block|{
literal|"ERRqtoobig"
block|,
literal|50
block|,
literal|"Print queue full -- no space."
block|}
block|,
block|{
literal|"ERRqeof"
block|,
literal|51
block|,
literal|"EOF on print queue dump."
block|}
block|,
block|{
literal|"ERRinvpfid"
block|,
literal|52
block|,
literal|"Invalid print file FID."
block|}
block|,
block|{
literal|"ERRsmbcmd"
block|,
literal|64
block|,
literal|"The server did not recognize the command received."
block|}
block|,
block|{
literal|"ERRsrverror"
block|,
literal|65
block|,
literal|"The server encountered an internal error, e.g., system file unavailable."
block|}
block|,
block|{
literal|"ERRfilespecs"
block|,
literal|67
block|,
literal|"The file handle (FID) and pathname parameters contained an invalid  combination of values."
block|}
block|,
block|{
literal|"ERRreserved"
block|,
literal|68
block|,
literal|"reserved."
block|}
block|,
block|{
literal|"ERRbadpermits"
block|,
literal|69
block|,
literal|"The access permissions specified for a file or directory are not a valid combination.  The server cannot set the requested attribute."
block|}
block|,
block|{
literal|"ERRreserved"
block|,
literal|70
block|,
literal|"reserved."
block|}
block|,
block|{
literal|"ERRsetattrmode"
block|,
literal|71
block|,
literal|"The attribute mode in the Set File Attribute request is invalid."
block|}
block|,
block|{
literal|"ERRpaused"
block|,
literal|81
block|,
literal|"Server is paused."
block|}
block|,
block|{
literal|"ERRmsgoff"
block|,
literal|82
block|,
literal|"Not receiving messages."
block|}
block|,
block|{
literal|"ERRnoroom"
block|,
literal|83
block|,
literal|"No room to buffer message."
block|}
block|,
block|{
literal|"ERRrmuns"
block|,
literal|87
block|,
literal|"Too many remote user names."
block|}
block|,
block|{
literal|"ERRtimeout"
block|,
literal|88
block|,
literal|"Operation timed out."
block|}
block|,
block|{
literal|"ERRnoresource"
block|,
literal|89
block|,
literal|"No resources currently available for request."
block|}
block|,
block|{
literal|"ERRtoomanyuids"
block|,
literal|90
block|,
literal|"Too many UIDs active on this session."
block|}
block|,
block|{
literal|"ERRbaduid"
block|,
literal|91
block|,
literal|"The UID is not known as a valid ID on this session."
block|}
block|,
block|{
literal|"ERRusempx"
block|,
literal|250
block|,
literal|"Temp unable to support Raw, use MPX mode."
block|}
block|,
block|{
literal|"ERRusestd"
block|,
literal|251
block|,
literal|"Temp unable to support Raw, use standard read/write."
block|}
block|,
block|{
literal|"ERRcontmpx"
block|,
literal|252
block|,
literal|"Continue in MPX mode."
block|}
block|,
block|{
literal|"ERRreserved"
block|,
literal|253
block|,
literal|"reserved."
block|}
block|,
block|{
literal|"ERRreserved"
block|,
literal|254
block|,
literal|"reserved."
block|}
block|,
block|{
literal|"ERRnosupport"
block|,
literal|0xFFFF
block|,
literal|"Function not supported."
block|}
block|,
block|{
name|NULL
block|,
operator|-
literal|1
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Hard Error Messages */
end_comment

begin_decl_stmt
name|err_code_struct
name|hard_msgs
index|[]
init|=
block|{
block|{
literal|"ERRnowrite"
block|,
literal|19
block|,
literal|"Attempt to write on write-protected diskette."
block|}
block|,
block|{
literal|"ERRbadunit"
block|,
literal|20
block|,
literal|"Unknown unit."
block|}
block|,
block|{
literal|"ERRnotready"
block|,
literal|21
block|,
literal|"Drive not ready."
block|}
block|,
block|{
literal|"ERRbadcmd"
block|,
literal|22
block|,
literal|"Unknown command."
block|}
block|,
block|{
literal|"ERRdata"
block|,
literal|23
block|,
literal|"Data error (CRC)."
block|}
block|,
block|{
literal|"ERRbadreq"
block|,
literal|24
block|,
literal|"Bad request structure length."
block|}
block|,
block|{
literal|"ERRseek"
block|,
literal|25
block|,
literal|"Seek error."
block|}
block|,
block|{
literal|"ERRbadmedia"
block|,
literal|26
block|,
literal|"Unknown media type."
block|}
block|,
block|{
literal|"ERRbadsector"
block|,
literal|27
block|,
literal|"Sector not found."
block|}
block|,
block|{
literal|"ERRnopaper"
block|,
literal|28
block|,
literal|"Printer out of paper."
block|}
block|,
block|{
literal|"ERRwrite"
block|,
literal|29
block|,
literal|"Write fault."
block|}
block|,
block|{
literal|"ERRread"
block|,
literal|30
block|,
literal|"Read fault."
block|}
block|,
block|{
literal|"ERRgeneral"
block|,
literal|31
block|,
literal|"General failure."
block|}
block|,
block|{
literal|"ERRbadshare"
block|,
literal|32
block|,
literal|"A open conflicts with an existing open."
block|}
block|,
block|{
literal|"ERRlock"
block|,
literal|33
block|,
literal|"A Lock request conflicted with an existing lock or specified an invalid mode, or an Unlock requested attempted to remove a lock held by another process."
block|}
block|,
block|{
literal|"ERRwrongdisk"
block|,
literal|34
block|,
literal|"The wrong disk was found in a drive."
block|}
block|,
block|{
literal|"ERRFCBUnavail"
block|,
literal|35
block|,
literal|"No FCBs are available to process request."
block|}
block|,
block|{
literal|"ERRsharebufexc"
block|,
literal|36
block|,
literal|"A sharing buffer has been exceeded."
block|}
block|,
block|{
name|NULL
block|,
operator|-
literal|1
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
block|{
name|int
name|code
decl_stmt|;
name|char
modifier|*
name|class
decl_stmt|;
name|err_code_struct
modifier|*
name|err_msgs
decl_stmt|;
block|}
name|err_classes
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"SUCCESS"
block|,
name|NULL
block|}
block|,
block|{
literal|0x01
block|,
literal|"ERRDOS"
block|,
name|dos_msgs
block|}
block|,
block|{
literal|0x02
block|,
literal|"ERRSRV"
block|,
name|server_msgs
block|}
block|,
block|{
literal|0x03
block|,
literal|"ERRHRD"
block|,
name|hard_msgs
block|}
block|,
block|{
literal|0x04
block|,
literal|"ERRXOS"
block|,
name|NULL
block|}
block|,
block|{
literal|0xE1
block|,
literal|"ERRRMX1"
block|,
name|NULL
block|}
block|,
block|{
literal|0xE2
block|,
literal|"ERRRMX2"
block|,
name|NULL
block|}
block|,
block|{
literal|0xE3
block|,
literal|"ERRRMX3"
block|,
name|NULL
block|}
block|,
block|{
literal|0xFF
block|,
literal|"ERRCMD"
block|,
name|NULL
block|}
block|,
block|{
operator|-
literal|1
block|,
name|NULL
block|,
name|NULL
block|}
block|}
struct|;
end_struct

begin_comment
comment|/**************************************************************************** return a SMB error string from a SMB buffer ****************************************************************************/
end_comment

begin_function
name|char
modifier|*
name|smb_errstr
parameter_list|(
name|int
name|class
parameter_list|,
name|int
name|num
parameter_list|)
block|{
specifier|static
name|char
name|ret
index|[
literal|128
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|ret
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|err_classes
index|[
name|i
index|]
operator|.
name|class
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|err_classes
index|[
name|i
index|]
operator|.
name|code
operator|==
name|class
condition|)
block|{
if|if
condition|(
name|err_classes
index|[
name|i
index|]
operator|.
name|err_msgs
condition|)
block|{
name|err_code_struct
modifier|*
name|err
init|=
name|err_classes
index|[
name|i
index|]
operator|.
name|err_msgs
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|err
index|[
name|j
index|]
operator|.
name|name
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|num
operator|==
name|err
index|[
name|j
index|]
operator|.
name|code
condition|)
block|{
name|snprintf
argument_list|(
name|ret
argument_list|,
sizeof|sizeof
argument_list|(
name|ret
argument_list|)
argument_list|,
literal|"%s - %s (%s)"
argument_list|,
name|err_classes
index|[
name|i
index|]
operator|.
name|class
argument_list|,
name|err
index|[
name|j
index|]
operator|.
name|name
argument_list|,
name|err
index|[
name|j
index|]
operator|.
name|message
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|snprintf
argument_list|(
name|ret
argument_list|,
sizeof|sizeof
argument_list|(
name|ret
argument_list|)
argument_list|,
literal|"%s - %d"
argument_list|,
name|err_classes
index|[
name|i
index|]
operator|.
name|class
argument_list|,
name|num
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|snprintf
argument_list|(
name|ret
argument_list|,
sizeof|sizeof
argument_list|(
name|ret
argument_list|)
argument_list|,
literal|"ERROR: Unknown error (%d,%d)"
argument_list|,
name|class
argument_list|,
name|num
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

end_unit


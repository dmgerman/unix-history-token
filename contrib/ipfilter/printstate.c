begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2002 by Darren Reed.  *  * See the IPFILTER.LICENCE file for details on licencing.  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__sgi
argument_list|)
operator|&&
operator|(
name|IRIX
operator|>
literal|602
operator|)
end_if

begin_include
include|#
directive|include
file|<sys/ptimers.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|300000
end_if

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"kmem.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_compat.h"
end_include

begin_include
include|#
directive|include
file|"ipf.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_fil.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_state.h"
end_include

begin_define
define|#
directive|define
name|PRINTF
value|(void)printf
end_define

begin_define
define|#
directive|define
name|FPRINTF
value|(void)fprintf
end_define

begin_function
name|ipstate_t
modifier|*
name|printstate
parameter_list|(
name|sp
parameter_list|,
name|opts
parameter_list|)
name|ipstate_t
modifier|*
name|sp
decl_stmt|;
name|int
name|opts
decl_stmt|;
block|{
name|ipstate_t
name|ips
decl_stmt|;
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ips
argument_list|,
operator|(
name|u_long
operator|)
name|sp
argument_list|,
sizeof|sizeof
argument_list|(
name|ips
argument_list|)
argument_list|)
condition|)
return|return
name|NULL
return|;
name|PRINTF
argument_list|(
literal|"%s -> "
argument_list|,
name|hostname
argument_list|(
name|ips
operator|.
name|is_v
argument_list|,
operator|&
name|ips
operator|.
name|is_src
operator|.
name|in4
argument_list|)
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%s ttl %ld pass %#x pr %d state %d/%d\n"
argument_list|,
name|hostname
argument_list|(
name|ips
operator|.
name|is_v
argument_list|,
operator|&
name|ips
operator|.
name|is_dst
operator|.
name|in4
argument_list|)
argument_list|,
name|ips
operator|.
name|is_age
argument_list|,
name|ips
operator|.
name|is_pass
argument_list|,
name|ips
operator|.
name|is_p
argument_list|,
name|ips
operator|.
name|is_state
index|[
literal|0
index|]
argument_list|,
name|ips
operator|.
name|is_state
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|PRINTF
argument_list|(
literal|"\tpkts %qu bytes %qu"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|ips
operator|.
name|is_pkts
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|ips
operator|.
name|is_bytes
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"\tpkts %ld bytes %ld"
argument_list|,
name|ips
operator|.
name|is_pkts
argument_list|,
name|ips
operator|.
name|is_bytes
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_TCP
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|NetBSD
argument_list|)
operator|&&
operator|(
name|NetBSD
operator|>=
literal|199905
operator|)
operator|&&
operator|(
name|NetBSD
operator|<
literal|1991011
operator|)
operator|||
expr|\
operator|(
name|__FreeBSD_version
operator|>=
literal|220000
operator|)
operator|||
name|defined
argument_list|(
name|__OpenBSD__
argument_list|)
name|PRINTF
argument_list|(
literal|"\t%hu -> %hu %x:%x (max %x:%x)\n"
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_sport
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_dport
argument_list|)
argument_list|,
name|ips
operator|.
name|is_send
argument_list|,
name|ips
operator|.
name|is_dend
argument_list|,
name|ips
operator|.
name|is_maxsend
argument_list|,
name|ips
operator|.
name|is_maxdend
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\t%u<<%d:%u<<%d"
argument_list|,
name|ips
operator|.
name|is_maxswin
operator|>>
name|ips
operator|.
name|is_swscale
argument_list|,
name|ips
operator|.
name|is_swscale
argument_list|,
name|ips
operator|.
name|is_maxdwin
operator|>>
name|ips
operator|.
name|is_dwscale
argument_list|,
name|ips
operator|.
name|is_dwscale
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"\t%hu -> %hu %x:%x (max %x:%x)\n"
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_sport
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_dport
argument_list|)
argument_list|,
name|ips
operator|.
name|is_send
argument_list|,
name|ips
operator|.
name|is_dend
argument_list|,
name|ips
operator|.
name|is_maxsend
argument_list|,
name|ips
operator|.
name|is_maxdend
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\t%u<<%d:%u<<%d"
argument_list|,
name|ips
operator|.
name|is_maxswin
operator|>>
name|ips
operator|.
name|is_swscale
argument_list|,
name|ips
operator|.
name|is_swscale
argument_list|,
name|ips
operator|.
name|is_maxdwin
operator|>>
name|ips
operator|.
name|is_dwscale
argument_list|,
name|ips
operator|.
name|is_dwscale
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_UDP
condition|)
name|PRINTF
argument_list|(
literal|" %hu -> %hu"
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_sport
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_dport
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_ICMP
ifdef|#
directive|ifdef
name|USE_INET6
operator|||
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_ICMPV6
endif|#
directive|endif
condition|)
name|PRINTF
argument_list|(
literal|" id %hu seq %hu type %d"
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_icmp
operator|.
name|ics_id
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_icmp
operator|.
name|ics_seq
argument_list|)
argument_list|,
name|ips
operator|.
name|is_icmp
operator|.
name|ics_type
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\n\t"
argument_list|)
expr_stmt|;
comment|/* 	 * Print out bits set in the result code for the state being 	 * kept as they would for a rule. 	 */
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_PASS
condition|)
block|{
name|PRINTF
argument_list|(
literal|"pass"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_BLOCK
condition|)
block|{
name|PRINTF
argument_list|(
literal|"block"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_RETMASK
condition|)
block|{
case|case
name|FR_RETICMP
case|:
name|PRINTF
argument_list|(
literal|" return-icmp"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FR_FAKEICMP
case|:
name|PRINTF
argument_list|(
literal|" return-icmp-as-dest"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FR_RETRST
case|:
name|PRINTF
argument_list|(
literal|" return-rst"
argument_list|)
expr_stmt|;
break|break;
default|default :
break|break;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGMASK
operator|)
operator|==
name|FR_LOG
condition|)
block|{
name|PRINTF
argument_list|(
literal|"log"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGBODY
condition|)
name|PRINTF
argument_list|(
literal|" body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGFIRST
condition|)
name|PRINTF
argument_list|(
literal|" first"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_ACCOUNT
condition|)
name|PRINTF
argument_list|(
literal|"count"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_OUTQUE
condition|)
name|PRINTF
argument_list|(
literal|" out"
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|" in"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOG
operator|)
operator|!=
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|" log"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGBODY
condition|)
name|PRINTF
argument_list|(
literal|" body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGFIRST
condition|)
name|PRINTF
argument_list|(
literal|" first"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGORBLOCK
condition|)
name|PRINTF
argument_list|(
literal|" or-block"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_QUICK
condition|)
name|PRINTF
argument_list|(
literal|" quick"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_KEEPFRAG
condition|)
name|PRINTF
argument_list|(
literal|" keep frags"
argument_list|)
expr_stmt|;
comment|/* a given; no? */
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_KEEPSTATE
condition|)
name|PRINTF
argument_list|(
literal|" keep state"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tIPv%d"
argument_list|,
name|ips
operator|.
name|is_v
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tpkt_flags& %x(%x) = %x,\t"
argument_list|,
name|ips
operator|.
name|is_flags
operator|&
literal|0xf
argument_list|,
name|ips
operator|.
name|is_flags
argument_list|,
name|ips
operator|.
name|is_flags
operator|>>
literal|4
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tpkt_options& %x = %x\n"
argument_list|,
name|ips
operator|.
name|is_optmsk
argument_list|,
name|ips
operator|.
name|is_opt
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tpkt_security& %x = %x, pkt_auth& %x = %x\n"
argument_list|,
name|ips
operator|.
name|is_secmsk
argument_list|,
name|ips
operator|.
name|is_sec
argument_list|,
name|ips
operator|.
name|is_authmsk
argument_list|,
name|ips
operator|.
name|is_auth
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tinterfaces: in %s"
argument_list|,
name|getifname
argument_list|(
name|ips
operator|.
name|is_ifp
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|",%s"
argument_list|,
name|getifname
argument_list|(
name|ips
operator|.
name|is_ifp
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" out %s"
argument_list|,
name|getifname
argument_list|(
name|ips
operator|.
name|is_ifp
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|",%s\n"
argument_list|,
name|getifname
argument_list|(
name|ips
operator|.
name|is_ifp
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ips
operator|.
name|is_next
return|;
block|}
end_function

end_unit


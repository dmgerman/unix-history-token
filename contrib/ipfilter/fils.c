begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 1993-2000 by Darren Reed.  *  * Redistribution and use in source and binary forms are permitted  * provided that this notice is preserved and due credit is given  * to the original author and the contributors.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<osreldate.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|__SVR4
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__svr4__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|STATETOP
argument_list|)
operator|&&
name|defined
argument_list|(
name|sun
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__svr4__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__SVR4
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/select.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|STATETOP
end_ifdef

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<ncurses.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|300000
end_if

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<arpa/nameser.h>
end_include

begin_include
include|#
directive|include
file|<resolv.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|STATETOP
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|linux
argument_list|)
end_if

begin_include
include|#
directive|include
file|<netinet/ip_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp_fsm.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"netinet/ip_compat.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_fil.h"
end_include

begin_include
include|#
directive|include
file|"ipf.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_proxy.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_nat.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_frag.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_state.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_auth.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|STATETOP
end_ifdef

begin_include
include|#
directive|include
file|"netinet/ipl.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"kmem.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
operator|(
name|__OpenBSD__
operator|)
end_if

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
end_if

begin_decl_stmt
specifier|static
specifier|const
name|char
name|sccsid
index|[]
init|=
literal|"@(#)fils.c	1.21 4/20/96 (C) 1993-2000 Darren Reed"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#)$Id: fils.c,v 2.21.2.5 2000/07/20 14:13:30 darrenr Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PRINTF
value|(void)printf
end_define

begin_define
define|#
directive|define
name|FPRINTF
value|(void)fprintf
end_define

begin_define
define|#
directive|define
name|F_IN
value|0
end_define

begin_define
define|#
directive|define
name|F_OUT
value|1
end_define

begin_define
define|#
directive|define
name|F_AC
value|2
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|filters
index|[
literal|4
index|]
init|=
block|{
literal|"ipfilter(in)"
block|,
literal|"ipfilter(out)"
block|,
literal|"ipacct(in)"
block|,
literal|"ipacct(out)"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|opts
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|USE_INET6
end_ifdef

begin_decl_stmt
name|int
name|use_inet6
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|STATETOP
end_ifdef

begin_define
define|#
directive|define
name|STSTRSIZE
value|80
end_define

begin_define
define|#
directive|define
name|STGROWSIZE
value|16
end_define

begin_define
define|#
directive|define
name|STSORT_PR
value|0
end_define

begin_define
define|#
directive|define
name|STSORT_PKTS
value|1
end_define

begin_define
define|#
directive|define
name|STSORT_BYTES
value|2
end_define

begin_define
define|#
directive|define
name|STSORT_TTL
value|3
end_define

begin_define
define|#
directive|define
name|STSORT_MAX
value|STSORT_TTL
end_define

begin_define
define|#
directive|define
name|STSORT_DEFAULT
value|STSORT_BYTES
end_define

begin_typedef
typedef|typedef
struct|struct
name|statetop
block|{
name|union
name|i6addr
name|st_src
decl_stmt|;
name|union
name|i6addr
name|st_dst
decl_stmt|;
name|u_short
name|st_sport
decl_stmt|;
name|u_short
name|st_dport
decl_stmt|;
name|u_char
name|st_p
decl_stmt|;
name|u_char
name|st_state
index|[
literal|2
index|]
decl_stmt|;
name|U_QUAD_T
name|st_pkts
decl_stmt|;
name|U_QUAD_T
name|st_bytes
decl_stmt|;
name|u_long
name|st_age
decl_stmt|;
block|}
name|statetop_t
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|int
decl|main
name|__P
argument_list|(
operator|(
name|int
operator|,
name|char
operator|*
index|[]
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showstats
name|__P
argument_list|(
operator|(
name|int
operator|,
name|friostat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showfrstates
name|__P
argument_list|(
operator|(
name|int
operator|,
name|ipfrstat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showlist
name|__P
argument_list|(
operator|(
name|friostat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showipstates
name|__P
argument_list|(
operator|(
name|int
operator|,
name|ips_stat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showauthstates
name|__P
argument_list|(
operator|(
name|int
operator|,
name|fr_authstat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showgroups
name|__P
argument_list|(
operator|(
name|friostat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|Usage
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|printlist
name|__P
argument_list|(
operator|(
name|frentry_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|get_ifname
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|hostname
name|__P
argument_list|(
operator|(
name|int
operator|,
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|parse_ipportstr
name|__P
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|,
expr|struct
name|in_addr
operator|*
operator|,
name|int
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|STATETOP
end_ifdef

begin_decl_stmt
specifier|static
name|void
name|topipstates
name|__P
argument_list|(
operator|(
name|int
operator|,
expr|struct
name|in_addr
operator|,
expr|struct
name|in_addr
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ttl_to_string
name|__P
argument_list|(
operator|(
name|long
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sort_p
name|__P
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|,
specifier|const
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sort_pkts
name|__P
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|,
specifier|const
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sort_bytes
name|__P
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|,
specifier|const
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sort_ttl
name|__P
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|,
specifier|const
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|char
modifier|*
name|hostname
parameter_list|(
name|v
parameter_list|,
name|ip
parameter_list|)
name|int
name|v
decl_stmt|;
name|void
modifier|*
name|ip
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|USE_INET6
specifier|static
name|char
name|hostbuf
index|[
name|MAXHOSTNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
endif|#
directive|endif
name|struct
name|in_addr
name|ipa
decl_stmt|;
if|if
condition|(
name|v
operator|==
literal|4
condition|)
block|{
name|ipa
operator|.
name|s_addr
operator|=
operator|*
operator|(
name|u_32_t
operator|*
operator|)
name|ip
expr_stmt|;
return|return
name|inet_ntoa
argument_list|(
name|ipa
argument_list|)
return|;
block|}
ifdef|#
directive|ifdef
name|USE_INET6
operator|(
name|void
operator|)
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|ip
argument_list|,
name|hostbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|hostbuf
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|hostbuf
index|[
name|MAXHOSTNAMELEN
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|hostbuf
return|;
else|#
directive|else
return|return
literal|"IPv6"
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|Usage
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|USE_INET6
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-6aAfhIinosv] [-d<device>]\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-aAfhIinosv] [-d<device>]\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       %s -t [-S source address] [-D destination address] [-P protocol] [-T refreshtime] [-C] [-d<device>]\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|fr_authstat_t
name|frauthst
decl_stmt|;
name|fr_authstat_t
modifier|*
name|frauthstp
init|=
operator|&
name|frauthst
decl_stmt|;
name|friostat_t
name|fio
decl_stmt|;
name|friostat_t
modifier|*
name|fiop
init|=
operator|&
name|fio
decl_stmt|;
name|ips_stat_t
name|ipsst
decl_stmt|;
name|ips_stat_t
modifier|*
name|ipsstp
init|=
operator|&
name|ipsst
decl_stmt|;
name|ipfrstat_t
name|ifrst
decl_stmt|;
name|ipfrstat_t
modifier|*
name|ifrstp
init|=
operator|&
name|ifrst
decl_stmt|;
name|char
modifier|*
name|name
init|=
name|NULL
decl_stmt|,
modifier|*
name|device
init|=
name|IPL_NAME
decl_stmt|;
name|int
name|c
decl_stmt|,
name|fd
decl_stmt|;
name|struct
name|protoent
modifier|*
name|proto
decl_stmt|;
name|int
name|protocol
init|=
operator|-
literal|1
decl_stmt|;
comment|/* -1 = wild card for any protocol */
name|int
name|refreshtime
init|=
literal|1
decl_stmt|;
comment|/* default update time */
name|int
name|sport
init|=
operator|-
literal|1
decl_stmt|;
comment|/* -1 = wild card for any source port */
name|int
name|dport
init|=
operator|-
literal|1
decl_stmt|;
comment|/* -1 = wild card for any dest port */
name|int
name|topclosed
init|=
literal|0
decl_stmt|;
comment|/* do not show closed tcp sessions */
name|struct
name|in_addr
name|saddr
decl_stmt|,
name|daddr
decl_stmt|;
name|saddr
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
comment|/* default any source addr */
name|daddr
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
comment|/* default any dest addr */
if|if
condition|(
name|openkmem
argument_list|()
operator|==
operator|-
literal|1
condition|)
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setgid
argument_list|(
name|getgid
argument_list|()
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"6aACfghIilnostvd:D:P:S:T:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
ifdef|#
directive|ifdef
name|USE_INET6
case|case
literal|'6'
case|:
name|use_inet6
operator|=
literal|1
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
literal|'a'
case|:
name|opts
operator||=
name|OPT_ACCNT
operator||
name|OPT_SHOWLIST
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
name|device
operator|=
name|IPAUTH_NAME
expr_stmt|;
name|opts
operator||=
name|OPT_AUTHSTATS
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|topclosed
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|device
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|parse_ipportstr
argument_list|(
name|optarg
argument_list|,
operator|&
name|daddr
argument_list|,
operator|&
name|dport
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|opts
operator||=
name|OPT_FRSTATES
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|opts
operator||=
name|OPT_GROUPS
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|opts
operator||=
name|OPT_HITS
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|opts
operator||=
name|OPT_INQUE
operator||
name|OPT_SHOWLIST
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|opts
operator||=
name|OPT_INACTIVE
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|opts
operator||=
name|OPT_SHOWLIST
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|opts
operator||=
name|OPT_SHOWLINENO
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|opts
operator||=
name|OPT_OUTQUE
operator||
name|OPT_SHOWLIST
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
if|if
condition|(
operator|(
name|proto
operator|=
name|getprotobyname
argument_list|(
name|optarg
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|protocol
operator|=
name|proto
operator|->
name|p_proto
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|sscanf
argument_list|(
name|optarg
argument_list|,
literal|"%ud"
argument_list|,
operator|&
name|protocol
argument_list|)
operator|||
operator|(
name|protocol
operator|<
literal|0
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s : Invalid protocol: %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'s'
case|:
name|opts
operator||=
name|OPT_IPSTATES
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|parse_ipportstr
argument_list|(
name|optarg
argument_list|,
operator|&
name|saddr
argument_list|,
operator|&
name|sport
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
ifdef|#
directive|ifdef
name|STATETOP
name|opts
operator||=
name|OPT_STATETOP
expr_stmt|;
break|break;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s : state top facility not compiled in\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|2
argument_list|)
expr_stmt|;
endif|#
directive|endif
case|case
literal|'T'
case|:
if|if
condition|(
operator|!
name|sscanf
argument_list|(
name|optarg
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|refreshtime
argument_list|)
operator|||
operator|(
name|refreshtime
operator|<=
literal|0
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s : Invalid refreshtime< 1 : %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'v'
case|:
name|opts
operator||=
name|OPT_VERBOSE
expr_stmt|;
break|break;
default|default :
name|Usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|device
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"open"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fio
argument_list|,
sizeof|sizeof
argument_list|(
name|fio
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ipsst
argument_list|,
sizeof|sizeof
argument_list|(
name|ipsst
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ifrst
argument_list|,
sizeof|sizeof
argument_list|(
name|ifrst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|opts
operator|&
name|OPT_AUTHSTATS
operator|)
operator|&&
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCGETFS
argument_list|,
operator|&
name|fiop
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(ipf:SIOCGETFS)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_IPSTATES
operator|)
condition|)
block|{
name|int
name|sfd
init|=
name|open
argument_list|(
name|IPL_STATE
argument_list|,
name|O_RDONLY
argument_list|)
decl_stmt|;
if|if
condition|(
name|sfd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"open"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|sfd
argument_list|,
name|SIOCGETFS
argument_list|,
operator|&
name|ipsstp
argument_list|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(state:SIOCGETFS)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|sfd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_FRSTATES
operator|)
operator|&&
operator|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCGFRST
argument_list|,
operator|&
name|ifrstp
argument_list|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCGFRST)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opts
operator|&
name|OPT_VERBOSE
condition|)
name|PRINTF
argument_list|(
literal|"opts %#x name %s\n"
argument_list|,
name|opts
argument_list|,
name|name
condition|?
name|name
else|:
literal|"<>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_AUTHSTATS
operator|)
operator|&&
operator|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCATHST
argument_list|,
operator|&
name|frauthstp
argument_list|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCATHST)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opts
operator|&
name|OPT_IPSTATES
condition|)
block|{
name|showipstates
argument_list|(
name|fd
argument_list|,
name|ipsstp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_SHOWLIST
condition|)
block|{
name|showlist
argument_list|(
operator|&
name|fio
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_OUTQUE
operator|)
operator|&&
operator|(
name|opts
operator|&
name|OPT_INQUE
operator|)
condition|)
block|{
name|opts
operator|&=
operator|~
name|OPT_OUTQUE
expr_stmt|;
name|showlist
argument_list|(
operator|&
name|fio
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|opts
operator|&
name|OPT_FRSTATES
condition|)
name|showfrstates
argument_list|(
name|fd
argument_list|,
name|ifrstp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|STATETOP
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_STATETOP
condition|)
name|topipstates
argument_list|(
name|fd
argument_list|,
name|saddr
argument_list|,
name|daddr
argument_list|,
name|sport
argument_list|,
name|dport
argument_list|,
name|protocol
argument_list|,
name|refreshtime
argument_list|,
name|topclosed
argument_list|)
expr_stmt|;
endif|#
directive|endif
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_AUTHSTATS
condition|)
name|showauthstates
argument_list|(
name|fd
argument_list|,
name|frauthstp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_GROUPS
condition|)
name|showgroups
argument_list|(
operator|&
name|fio
argument_list|)
expr_stmt|;
else|else
name|showstats
argument_list|(
name|fd
argument_list|,
operator|&
name|fio
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * read the kernel stats for packets blocked and passed  */
end_comment

begin_function
specifier|static
name|void
name|showstats
parameter_list|(
name|fd
parameter_list|,
name|fp
parameter_list|)
name|int
name|fd
decl_stmt|;
name|struct
name|friostat
modifier|*
name|fp
decl_stmt|;
block|{
name|u_32_t
name|frf
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCGETFF
argument_list|,
operator|&
name|frf
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|perror
argument_list|(
literal|"ioctl(SIOCGETFF)"
argument_list|)
expr_stmt|;
if|#
directive|if
name|SOLARIS
name|PRINTF
argument_list|(
literal|"dropped packets:\tin %lu\tout %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_drop
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_drop
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"non-data packets:\tin %lu\tout %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_notdata
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_notdata
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"no-data packets:\tin %lu\tout %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_nodata
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_nodata
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"non-ip packets:\t\tin %lu\tout %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_notip
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_notip
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"   bad packets:\t\tin %lu\tout %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_bad
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_bad
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"copied messages:\tin %lu\tout %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_copy
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_copy
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|USE_INET6
name|PRINTF
argument_list|(
literal|" IPv6 packets:\t\tin %lu out %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_ipv6
index|[
literal|0
index|]
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_ipv6
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|PRINTF
argument_list|(
literal|" input packets:\t\tblocked %lu passed %lu nomatch %lu"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_block
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_pass
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_nom
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" counted %lu short %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_acct
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_short
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"output packets:\t\tblocked %lu passed %lu nomatch %lu"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_block
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_pass
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_nom
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" counted %lu short %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_acct
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_short
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" input packets logged:\tblocked %lu passed %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_bpkl
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_ppkl
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"output packets logged:\tblocked %lu passed %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_bpkl
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_ppkl
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" packets logged:\tinput %lu output %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_pkl
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_pkl
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" log failures:\t\tinput %lu output %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_skip
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_skip
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"fragment state(in):\tkept %lu\tlost %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_nfr
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_bnfr
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"fragment state(out):\tkept %lu\tlost %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_nfr
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_bnfr
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"packet state(in):\tkept %lu\tlost %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_ads
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_bads
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"packet state(out):\tkept %lu\tlost %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_ads
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_bads
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"ICMP replies:\t%lu\tTCP RSTs sent:\t%lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_ret
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_ret
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"Invalid source(in):\t%lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_badsrc
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"Result cache hits(in):\t%lu\t(out):\t%lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_chit
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_chit
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"IN Pullups succeeded:\t%lu\tfailed:\t%lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_pull
index|[
literal|0
index|]
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_pull
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"OUT Pullups succeeded:\t%lu\tfailed:\t%lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_pull
index|[
literal|0
index|]
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_pull
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"Fastroute successes:\t%lu\tfailures:\t%lu\n"
argument_list|,
name|fp
operator|->
name|f_froute
index|[
literal|0
index|]
argument_list|,
name|fp
operator|->
name|f_froute
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"TCP cksum fails(in):\t%lu\t(out):\t%lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_tcpbad
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_tcpbad
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"Packet log flags set: (%#x)\n"
argument_list|,
name|frf
argument_list|)
expr_stmt|;
if|if
condition|(
name|frf
operator|&
name|FF_LOGPASS
condition|)
name|PRINTF
argument_list|(
literal|"\tpackets passed through filter\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|frf
operator|&
name|FF_LOGBLOCK
condition|)
name|PRINTF
argument_list|(
literal|"\tpackets blocked by filter\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|frf
operator|&
name|FF_LOGNOMATCH
condition|)
name|PRINTF
argument_list|(
literal|"\tpackets not matched by filter\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|frf
condition|)
name|PRINTF
argument_list|(
literal|"\tnone\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|printlist
parameter_list|(
name|fp
parameter_list|)
name|frentry_t
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|frentry
name|fb
decl_stmt|;
name|int
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|1
init|;
name|fp
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fb
argument_list|,
operator|(
name|u_long
operator|)
name|fp
argument_list|,
sizeof|sizeof
argument_list|(
name|fb
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"kmemcpy"
argument_list|)
expr_stmt|;
return|return;
block|}
name|fp
operator|=
operator|&
name|fb
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_OUTQUE
condition|)
name|fp
operator|->
name|fr_flags
operator||=
name|FR_OUTQUE
expr_stmt|;
if|if
condition|(
name|opts
operator|&
operator|(
name|OPT_HITS
operator||
name|OPT_VERBOSE
operator|)
condition|)
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|PRINTF
argument_list|(
literal|"%qu "
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|fp
operator|->
name|fr_hits
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"%lu "
argument_list|,
name|fp
operator|->
name|fr_hits
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|opts
operator|&
operator|(
name|OPT_ACCNT
operator||
name|OPT_VERBOSE
operator|)
condition|)
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|PRINTF
argument_list|(
literal|"%qu "
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|fp
operator|->
name|fr_bytes
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"%lu "
argument_list|,
name|fp
operator|->
name|fr_bytes
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|opts
operator|&
name|OPT_SHOWLINENO
condition|)
name|PRINTF
argument_list|(
literal|"@%d "
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|printfr
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_VERBOSE
condition|)
name|binprint
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_grp
condition|)
name|printlist
argument_list|(
name|fp
operator|->
name|fr_grp
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fp
operator|->
name|fr_next
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * print out filter rule list  */
end_comment

begin_function
specifier|static
name|void
name|showlist
parameter_list|(
name|fiop
parameter_list|)
name|struct
name|friostat
modifier|*
name|fiop
decl_stmt|;
block|{
name|struct
name|frentry
modifier|*
name|fp
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|set
decl_stmt|;
name|set
operator|=
name|fiop
operator|->
name|f_active
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_INACTIVE
condition|)
name|set
operator|=
literal|1
operator|-
name|set
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_ACCNT
condition|)
block|{
name|i
operator|=
name|F_AC
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_OUTQUE
condition|)
block|{
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_acctout
index|[
name|set
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_INQUE
condition|)
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_acctin
index|[
name|set
index|]
expr_stmt|;
else|else
block|{
name|FPRINTF
argument_list|(
name|stderr
argument_list|,
literal|"No -i or -o given with -a\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|USE_INET6
if|if
condition|(
operator|(
name|use_inet6
operator|)
operator|&&
operator|(
name|opts
operator|&
name|OPT_OUTQUE
operator|)
condition|)
block|{
name|i
operator|=
name|F_OUT
expr_stmt|;
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_fout6
index|[
name|set
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|use_inet6
operator|)
operator|&&
operator|(
name|opts
operator|&
name|OPT_INQUE
operator|)
condition|)
block|{
name|i
operator|=
name|F_IN
expr_stmt|;
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_fin6
index|[
name|set
index|]
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
if|if
condition|(
name|opts
operator|&
name|OPT_OUTQUE
condition|)
block|{
name|i
operator|=
name|F_OUT
expr_stmt|;
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_fout
index|[
name|set
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_INQUE
condition|)
block|{
name|i
operator|=
name|F_IN
expr_stmt|;
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_fin
index|[
name|set
index|]
expr_stmt|;
block|}
else|else
return|return;
block|}
if|if
condition|(
name|opts
operator|&
name|OPT_VERBOSE
condition|)
name|FPRINTF
argument_list|(
name|stderr
argument_list|,
literal|"showlist:opts %#x i %d\n"
argument_list|,
name|opts
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_VERBOSE
condition|)
name|PRINTF
argument_list|(
literal|"fp %p set %d\n"
argument_list|,
name|fp
argument_list|,
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|FPRINTF
argument_list|(
name|stderr
argument_list|,
literal|"empty list for %s%s\n"
argument_list|,
operator|(
name|opts
operator|&
name|OPT_INACTIVE
operator|)
condition|?
literal|"inactive "
else|:
literal|""
argument_list|,
name|filters
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|printlist
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|showipstates
parameter_list|(
name|fd
parameter_list|,
name|ipsp
parameter_list|)
name|int
name|fd
decl_stmt|;
name|ips_stat_t
modifier|*
name|ipsp
decl_stmt|;
block|{
name|ipstate_t
modifier|*
name|istab
index|[
name|IPSTATE_SIZE
index|]
decl_stmt|,
name|ips
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|opts
operator|&
name|OPT_SHOWLIST
operator|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|"IP states added:\n\t%lu TCP\n\t%lu UDP\n\t%lu ICMP\n"
argument_list|,
name|ipsp
operator|->
name|iss_tcp
argument_list|,
name|ipsp
operator|->
name|iss_udp
argument_list|,
name|ipsp
operator|->
name|iss_icmp
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\t%lu hits\n\t%lu misses\n"
argument_list|,
name|ipsp
operator|->
name|iss_hits
argument_list|,
name|ipsp
operator|->
name|iss_miss
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\t%lu maximum\n\t%lu no memory\n\t%lu bkts in use\n"
argument_list|,
name|ipsp
operator|->
name|iss_max
argument_list|,
name|ipsp
operator|->
name|iss_nomem
argument_list|,
name|ipsp
operator|->
name|iss_inuse
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\t%lu active\n\t%lu expired\n\t%lu closed\n"
argument_list|,
name|ipsp
operator|->
name|iss_active
argument_list|,
name|ipsp
operator|->
name|iss_expire
argument_list|,
name|ipsp
operator|->
name|iss_fin
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|istab
argument_list|,
operator|(
name|u_long
operator|)
name|ipsp
operator|->
name|iss_table
argument_list|,
sizeof|sizeof
argument_list|(
name|istab
argument_list|)
argument_list|)
condition|)
return|return;
while|while
condition|(
name|ipsp
operator|->
name|iss_list
condition|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ips
argument_list|,
operator|(
name|u_long
operator|)
name|ipsp
operator|->
name|iss_list
argument_list|,
sizeof|sizeof
argument_list|(
name|ips
argument_list|)
argument_list|)
condition|)
break|break;
name|ipsp
operator|->
name|iss_list
operator|=
name|ips
operator|.
name|is_next
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%s -> "
argument_list|,
name|hostname
argument_list|(
name|ips
operator|.
name|is_v
argument_list|,
operator|&
name|ips
operator|.
name|is_src
operator|.
name|in4
argument_list|)
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%s ttl %ld pass %#x pr %d state %d/%d\n"
argument_list|,
name|hostname
argument_list|(
name|ips
operator|.
name|is_v
argument_list|,
operator|&
name|ips
operator|.
name|is_dst
operator|.
name|in4
argument_list|)
argument_list|,
name|ips
operator|.
name|is_age
argument_list|,
name|ips
operator|.
name|is_pass
argument_list|,
name|ips
operator|.
name|is_p
argument_list|,
name|ips
operator|.
name|is_state
index|[
literal|0
index|]
argument_list|,
name|ips
operator|.
name|is_state
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|PRINTF
argument_list|(
literal|"\tpkts %qu bytes %qu"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|ips
operator|.
name|is_pkts
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|ips
operator|.
name|is_bytes
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"\tpkts %ld bytes %ld"
argument_list|,
name|ips
operator|.
name|is_pkts
argument_list|,
name|ips
operator|.
name|is_bytes
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_TCP
condition|)
if|#
directive|if
name|defined
argument_list|(
name|NetBSD
argument_list|)
operator|&&
operator|(
name|NetBSD
operator|>=
literal|199905
operator|)
operator|&&
operator|(
name|NetBSD
operator|<
literal|1991011
operator|)
operator|||
expr|\
operator|(
name|__FreeBSD_version
operator|>=
literal|220000
operator|)
operator|||
name|defined
argument_list|(
name|__OpenBSD__
argument_list|)
name|PRINTF
argument_list|(
literal|"\t%hu -> %hu %x:%x %hu:%hu"
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_sport
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_dport
argument_list|)
argument_list|,
name|ips
operator|.
name|is_send
argument_list|,
name|ips
operator|.
name|is_dend
argument_list|,
name|ips
operator|.
name|is_maxswin
argument_list|,
name|ips
operator|.
name|is_maxdwin
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"\t%hu -> %hu %x:%x %hu:%hu"
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_sport
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_dport
argument_list|)
argument_list|,
name|ips
operator|.
name|is_send
argument_list|,
name|ips
operator|.
name|is_dend
argument_list|,
name|ips
operator|.
name|is_maxswin
argument_list|,
name|ips
operator|.
name|is_maxdwin
argument_list|)
expr_stmt|;
endif|#
directive|endif
elseif|else
if|if
condition|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_UDP
condition|)
name|PRINTF
argument_list|(
literal|" %hu -> %hu"
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_sport
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_dport
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_ICMP
ifdef|#
directive|ifdef
name|USE_INET6
operator|||
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_ICMPV6
endif|#
directive|endif
condition|)
name|PRINTF
argument_list|(
literal|" %hu %hu %d"
argument_list|,
name|ips
operator|.
name|is_icmp
operator|.
name|ics_id
argument_list|,
name|ips
operator|.
name|is_icmp
operator|.
name|ics_seq
argument_list|,
name|ips
operator|.
name|is_icmp
operator|.
name|ics_type
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\n\t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_PASS
condition|)
block|{
name|PRINTF
argument_list|(
literal|"pass"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_BLOCK
condition|)
block|{
name|PRINTF
argument_list|(
literal|"block"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_RETMASK
condition|)
block|{
case|case
name|FR_RETICMP
case|:
name|PRINTF
argument_list|(
literal|" return-icmp"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FR_FAKEICMP
case|:
name|PRINTF
argument_list|(
literal|" return-icmp-as-dest"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FR_RETRST
case|:
name|PRINTF
argument_list|(
literal|" return-rst"
argument_list|)
expr_stmt|;
break|break;
default|default :
break|break;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGMASK
operator|)
operator|==
name|FR_LOG
condition|)
block|{
name|PRINTF
argument_list|(
literal|"log"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGBODY
condition|)
name|PRINTF
argument_list|(
literal|" body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGFIRST
condition|)
name|PRINTF
argument_list|(
literal|" first"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_ACCOUNT
condition|)
name|PRINTF
argument_list|(
literal|"count"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_OUTQUE
condition|)
name|PRINTF
argument_list|(
literal|" out"
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|" in"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOG
operator|)
operator|!=
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|" log"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGBODY
condition|)
name|PRINTF
argument_list|(
literal|" body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGFIRST
condition|)
name|PRINTF
argument_list|(
literal|" first"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGORBLOCK
condition|)
name|PRINTF
argument_list|(
literal|" or-block"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_QUICK
condition|)
name|PRINTF
argument_list|(
literal|" quick"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_KEEPFRAG
condition|)
name|PRINTF
argument_list|(
literal|" keep frags"
argument_list|)
expr_stmt|;
comment|/* a given; no? */
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_KEEPSTATE
condition|)
name|PRINTF
argument_list|(
literal|" keep state"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tIPv%d"
argument_list|,
name|ips
operator|.
name|is_v
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tpkt_flags& %x(%x) = %x,\t"
argument_list|,
name|ips
operator|.
name|is_flags
operator|&
literal|0xf
argument_list|,
name|ips
operator|.
name|is_flags
argument_list|,
name|ips
operator|.
name|is_flags
operator|>>
literal|4
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tpkt_options& %x = %x\n"
argument_list|,
name|ips
operator|.
name|is_optmsk
argument_list|,
name|ips
operator|.
name|is_opt
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tpkt_security& %x = %x, pkt_auth& %x = %x\n"
argument_list|,
name|ips
operator|.
name|is_secmsk
argument_list|,
name|ips
operator|.
name|is_sec
argument_list|,
name|ips
operator|.
name|is_authmsk
argument_list|,
name|ips
operator|.
name|is_auth
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"interfaces: in %s[%p] "
argument_list|,
name|get_ifname
argument_list|(
name|ips
operator|.
name|is_ifpin
argument_list|)
argument_list|,
name|ips
operator|.
name|is_ifpin
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"out %s[%p]\n"
argument_list|,
name|get_ifname
argument_list|(
name|ips
operator|.
name|is_ifpout
argument_list|)
argument_list|,
name|ips
operator|.
name|is_ifpout
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|STATETOP
end_ifdef

begin_function
specifier|static
name|void
name|topipstates
parameter_list|(
name|fd
parameter_list|,
name|saddr
parameter_list|,
name|daddr
parameter_list|,
name|sport
parameter_list|,
name|dport
parameter_list|,
name|protocol
parameter_list|,
name|refreshtime
parameter_list|,
name|topclosed
parameter_list|)
name|int
name|fd
decl_stmt|;
name|struct
name|in_addr
name|saddr
decl_stmt|;
name|struct
name|in_addr
name|daddr
decl_stmt|;
name|int
name|sport
decl_stmt|;
name|int
name|dport
decl_stmt|;
name|int
name|protocol
decl_stmt|;
name|int
name|refreshtime
decl_stmt|;
name|int
name|topclosed
decl_stmt|;
block|{
name|char
name|str1
index|[
name|STSTRSIZE
index|]
decl_stmt|,
name|str2
index|[
name|STSTRSIZE
index|]
decl_stmt|,
name|str3
index|[
name|STSTRSIZE
index|]
decl_stmt|,
name|str4
index|[
name|STSTRSIZE
index|]
decl_stmt|;
name|int
name|maxtsentries
init|=
literal|0
decl_stmt|,
name|reverse
init|=
literal|0
decl_stmt|,
name|sorting
init|=
name|STSORT_DEFAULT
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|sfd
decl_stmt|,
name|winx
decl_stmt|,
name|tsentry
decl_stmt|,
name|maxx
decl_stmt|,
name|maxy
decl_stmt|,
name|redraw
init|=
literal|0
decl_stmt|;
name|ipstate_t
modifier|*
name|istab
index|[
name|IPSTATE_SIZE
index|]
decl_stmt|,
name|ips
decl_stmt|;
name|ips_stat_t
name|ipsst
decl_stmt|,
modifier|*
name|ipsstp
init|=
operator|&
name|ipsst
decl_stmt|;
name|statetop_t
modifier|*
name|tstable
init|=
name|NULL
decl_stmt|,
modifier|*
name|tp
decl_stmt|;
name|struct
name|timeval
name|selecttimeout
decl_stmt|;
name|struct
name|protoent
modifier|*
name|proto
decl_stmt|;
name|fd_set
name|readfd
decl_stmt|;
name|char
name|c
init|=
literal|'\0'
decl_stmt|;
name|time_t
name|t
decl_stmt|;
comment|/* open state device */
if|if
condition|(
operator|(
name|sfd
operator|=
name|open
argument_list|(
name|IPL_STATE
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"open"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* init ncurses stuff */
name|initscr
argument_list|()
expr_stmt|;
name|cbreak
argument_list|()
expr_stmt|;
name|noecho
argument_list|()
expr_stmt|;
name|nodelay
argument_list|(
name|stdscr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* repeat until user aborts */
while|while
condition|(
literal|1
condition|)
block|{
comment|/* get state table */
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ipsst
argument_list|,
sizeof|sizeof
argument_list|(
operator|&
name|ipsst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|sfd
argument_list|,
name|SIOCGETFS
argument_list|,
operator|&
name|ipsstp
argument_list|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCGETFS)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|istab
argument_list|,
operator|(
name|u_long
operator|)
name|ipsstp
operator|->
name|iss_table
argument_list|,
sizeof|sizeof
argument_list|(
name|ips
argument_list|)
argument_list|)
condition|)
return|return;
comment|/* clear the history */
name|tsentry
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* read the state table and store in tstable */
while|while
condition|(
name|ipsstp
operator|->
name|iss_list
condition|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ips
argument_list|,
operator|(
name|u_long
operator|)
name|ipsstp
operator|->
name|iss_list
argument_list|,
sizeof|sizeof
argument_list|(
name|ips
argument_list|)
argument_list|)
condition|)
break|break;
name|ipsstp
operator|->
name|iss_list
operator|=
name|ips
operator|.
name|is_next
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|saddr
operator|.
name|s_addr
operator|==
name|INADDR_ANY
operator|)
operator|||
operator|(
name|saddr
operator|.
name|s_addr
operator|==
name|ips
operator|.
name|is_saddr
operator|)
operator|)
operator|&&
operator|(
operator|(
name|daddr
operator|.
name|s_addr
operator|==
name|INADDR_ANY
operator|)
operator|||
operator|(
name|daddr
operator|.
name|s_addr
operator|==
name|ips
operator|.
name|is_daddr
operator|)
operator|)
operator|&&
operator|(
operator|(
name|protocol
operator|<
literal|0
operator|)
operator|||
operator|(
name|protocol
operator|==
name|ips
operator|.
name|is_p
operator|)
operator|)
operator|&&
operator|(
operator|(
operator|(
name|ips
operator|.
name|is_p
operator|!=
name|IPPROTO_TCP
operator|)
operator|&&
operator|(
name|ips
operator|.
name|is_p
operator|!=
name|IPPROTO_UDP
operator|)
operator|)
operator|||
operator|(
operator|(
operator|(
name|sport
operator|<
literal|0
operator|)
operator|||
operator|(
name|htons
argument_list|(
name|sport
argument_list|)
operator|==
name|ips
operator|.
name|is_sport
operator|)
operator|)
operator|&&
operator|(
operator|(
name|dport
operator|<
literal|0
operator|)
operator|||
operator|(
name|htons
argument_list|(
name|dport
argument_list|)
operator|==
name|ips
operator|.
name|is_dport
operator|)
operator|)
operator|)
operator|)
operator|&&
operator|(
name|topclosed
operator|||
operator|(
name|ips
operator|.
name|is_p
operator|!=
name|IPPROTO_TCP
operator|)
operator|||
operator|(
name|ips
operator|.
name|is_state
index|[
literal|0
index|]
operator|<
name|TCPS_CLOSE_WAIT
operator|)
operator|||
operator|(
name|ips
operator|.
name|is_state
index|[
literal|1
index|]
operator|<
name|TCPS_CLOSE_WAIT
operator|)
operator|)
condition|)
block|{
comment|/* 				 * if necessary make room for this state 				 * entry 				 */
name|tsentry
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|maxtsentries
operator|||
operator|(
name|tsentry
operator|==
name|maxtsentries
operator|)
condition|)
block|{
name|maxtsentries
operator|+=
name|STGROWSIZE
expr_stmt|;
name|tstable
operator|=
name|realloc
argument_list|(
name|tstable
argument_list|,
name|maxtsentries
operator|*
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tstable
condition|)
block|{
name|perror
argument_list|(
literal|"malloc"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* fill structure */
name|tp
operator|=
name|tstable
operator|+
name|tsentry
expr_stmt|;
name|tp
operator|->
name|st_src
operator|=
name|ips
operator|.
name|is_src
expr_stmt|;
name|tp
operator|->
name|st_dst
operator|=
name|ips
operator|.
name|is_dst
expr_stmt|;
name|tp
operator|->
name|st_p
operator|=
name|ips
operator|.
name|is_p
expr_stmt|;
name|tp
operator|->
name|st_state
index|[
literal|0
index|]
operator|=
name|ips
operator|.
name|is_state
index|[
literal|0
index|]
expr_stmt|;
name|tp
operator|->
name|st_state
index|[
literal|1
index|]
operator|=
name|ips
operator|.
name|is_state
index|[
literal|1
index|]
expr_stmt|;
name|tp
operator|->
name|st_pkts
operator|=
name|ips
operator|.
name|is_pkts
expr_stmt|;
name|tp
operator|->
name|st_bytes
operator|=
name|ips
operator|.
name|is_bytes
expr_stmt|;
name|tp
operator|->
name|st_age
operator|=
name|ips
operator|.
name|is_age
expr_stmt|;
if|if
condition|(
operator|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_TCP
operator|)
operator|||
operator|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_UDP
operator|)
condition|)
block|{
name|tp
operator|->
name|st_sport
operator|=
name|ips
operator|.
name|is_sport
expr_stmt|;
name|tp
operator|->
name|st_dport
operator|=
name|ips
operator|.
name|is_dport
expr_stmt|;
block|}
block|}
block|}
comment|/* sort the array */
if|if
condition|(
name|tsentry
operator|!=
operator|-
literal|1
condition|)
switch|switch
condition|(
name|sorting
condition|)
block|{
case|case
name|STSORT_PR
case|:
name|qsort
argument_list|(
name|tstable
argument_list|,
name|tsentry
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|,
name|sort_p
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_PKTS
case|:
name|qsort
argument_list|(
name|tstable
argument_list|,
name|tsentry
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|,
name|sort_pkts
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_BYTES
case|:
name|qsort
argument_list|(
name|tstable
argument_list|,
name|tsentry
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|,
name|sort_bytes
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_TTL
case|:
name|qsort
argument_list|(
name|tstable
argument_list|,
name|tsentry
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|,
name|sort_ttl
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* print title */
name|erase
argument_list|()
expr_stmt|;
name|getmaxyx
argument_list|(
name|stdscr
argument_list|,
name|maxy
argument_list|,
name|maxx
argument_list|)
expr_stmt|;
name|attron
argument_list|(
name|A_BOLD
argument_list|)
expr_stmt|;
name|winx
operator|=
literal|0
expr_stmt|;
name|move
argument_list|(
name|winx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%s - state top"
argument_list|,
name|IPL_VERSION
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
operator|(
name|maxx
operator|-
literal|8
operator|-
name|strlen
argument_list|(
name|str1
argument_list|)
operator|)
operator|/
literal|2
condition|;
name|j
operator|++
control|)
name|printw
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"%s"
argument_list|,
name|str1
argument_list|)
expr_stmt|;
name|attroff
argument_list|(
name|A_BOLD
argument_list|)
expr_stmt|;
comment|/* just for fun add a clock */
name|move
argument_list|(
name|winx
argument_list|,
name|maxx
operator|-
literal|8
argument_list|)
expr_stmt|;
name|t
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|strftime
argument_list|(
name|str1
argument_list|,
literal|80
argument_list|,
literal|"%T"
argument_list|,
name|localtime
argument_list|(
operator|&
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"%s\n"
argument_list|,
name|str1
argument_list|)
expr_stmt|;
comment|/* 		 * print the display filters, this is placed in the loop,  		 * because someday I might add code for changing these 		 * while the programming is running :-) 		 */
if|if
condition|(
name|sport
operator|>=
literal|0
condition|)
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%s,%d"
argument_list|,
name|inet_ntoa
argument_list|(
name|saddr
argument_list|)
argument_list|,
name|sport
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%s"
argument_list|,
name|inet_ntoa
argument_list|(
name|saddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dport
operator|>=
literal|0
condition|)
name|sprintf
argument_list|(
name|str2
argument_list|,
literal|"%s,%d"
argument_list|,
name|inet_ntoa
argument_list|(
name|daddr
argument_list|)
argument_list|,
name|dport
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|str2
argument_list|,
literal|"%s"
argument_list|,
name|inet_ntoa
argument_list|(
name|daddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|protocol
operator|<
literal|0
condition|)
name|strcpy
argument_list|(
name|str3
argument_list|,
literal|"any"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|proto
operator|=
name|getprotobynumber
argument_list|(
name|protocol
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|sprintf
argument_list|(
name|str3
argument_list|,
literal|"%s"
argument_list|,
name|proto
operator|->
name|p_name
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|str3
argument_list|,
literal|"%d"
argument_list|,
name|protocol
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sorting
condition|)
block|{
case|case
name|STSORT_PR
case|:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"proto"
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_PKTS
case|:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"# pkts"
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_BYTES
case|:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"# bytes"
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_TTL
case|:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"ttl"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|reverse
condition|)
name|strcat
argument_list|(
name|str4
argument_list|,
literal|" (reverse)"
argument_list|)
expr_stmt|;
name|winx
operator|+=
literal|2
expr_stmt|;
name|move
argument_list|(
name|winx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"Src = %s  Dest = %s  Proto = %s  Sorted by = %s\n\n"
argument_list|,
name|str1
argument_list|,
name|str2
argument_list|,
name|str3
argument_list|,
name|str4
argument_list|)
expr_stmt|;
comment|/* print column description */
name|winx
operator|+=
literal|2
expr_stmt|;
name|move
argument_list|(
name|winx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|attron
argument_list|(
name|A_BOLD
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"%-21s %-21s %3s %4s %7s %9s %9s\n"
argument_list|,
literal|"Source IP"
argument_list|,
literal|"Destination IP"
argument_list|,
literal|"ST"
argument_list|,
literal|"PR"
argument_list|,
literal|"#pkts"
argument_list|,
literal|"#bytes"
argument_list|,
literal|"ttl"
argument_list|)
expr_stmt|;
name|attroff
argument_list|(
name|A_BOLD
argument_list|)
expr_stmt|;
comment|/* print all the entries */
name|tp
operator|=
name|tstable
expr_stmt|;
if|if
condition|(
name|reverse
condition|)
name|tp
operator|+=
name|tsentry
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|tsentry
condition|;
name|i
operator|++
control|)
block|{
comment|/* print src/dest and port */
if|if
condition|(
operator|(
name|tp
operator|->
name|st_p
operator|==
name|IPPROTO_TCP
operator|)
operator|||
operator|(
name|tp
operator|->
name|st_p
operator|==
name|IPPROTO_UDP
operator|)
condition|)
block|{
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%s,%hu"
argument_list|,
name|inet_ntoa
argument_list|(
name|tp
operator|->
name|st_src
operator|.
name|in4
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|tp
operator|->
name|st_sport
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|str2
argument_list|,
literal|"%s,%hu"
argument_list|,
name|inet_ntoa
argument_list|(
name|tp
operator|->
name|st_dst
operator|.
name|in4
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|tp
operator|->
name|st_dport
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%s"
argument_list|,
name|inet_ntoa
argument_list|(
name|tp
operator|->
name|st_src
operator|.
name|in4
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|str2
argument_list|,
literal|"%s"
argument_list|,
name|inet_ntoa
argument_list|(
name|tp
operator|->
name|st_dst
operator|.
name|in4
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|winx
operator|++
expr_stmt|;
name|move
argument_list|(
name|winx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"%-21s %-21s"
argument_list|,
name|str1
argument_list|,
name|str2
argument_list|)
expr_stmt|;
comment|/* print state */
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%d/%d"
argument_list|,
name|tp
operator|->
name|st_state
index|[
literal|0
index|]
argument_list|,
name|tp
operator|->
name|st_state
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|" %3s"
argument_list|,
name|str1
argument_list|)
expr_stmt|;
comment|/* print proto */
name|proto
operator|=
name|getprotobynumber
argument_list|(
name|tp
operator|->
name|st_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
condition|)
block|{
name|strncpy
argument_list|(
name|str1
argument_list|,
name|proto
operator|->
name|p_name
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|str1
index|[
literal|4
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%d"
argument_list|,
name|tp
operator|->
name|st_p
argument_list|)
expr_stmt|;
block|}
name|printw
argument_list|(
literal|" %4s"
argument_list|,
name|str1
argument_list|)
expr_stmt|;
comment|/* print #pkt/#bytes */
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|printw
argument_list|(
literal|" %7qu %9qu"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|tp
operator|->
name|st_pkts
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|tp
operator|->
name|st_bytes
argument_list|)
expr_stmt|;
else|#
directive|else
name|printw
argument_list|(
literal|" %7lu %9lu"
argument_list|,
name|tp
operator|->
name|st_pkts
argument_list|,
name|tp
operator|->
name|st_bytes
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printw
argument_list|(
literal|" %9s"
argument_list|,
name|ttl_to_string
argument_list|(
name|tp
operator|->
name|st_age
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reverse
condition|)
name|tp
operator|--
expr_stmt|;
else|else
name|tp
operator|++
expr_stmt|;
block|}
comment|/* screen data structure is filled, now update the screen */
if|if
condition|(
name|redraw
condition|)
name|clearok
argument_list|(
name|stdscr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
if|if
condition|(
name|redraw
condition|)
block|{
name|clearok
argument_list|(
name|stdscr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|redraw
operator|=
literal|0
expr_stmt|;
block|}
comment|/* wait for key press or a 1 second time out period */
name|selecttimeout
operator|.
name|tv_sec
operator|=
name|refreshtime
expr_stmt|;
name|selecttimeout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|readfd
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
literal|0
argument_list|,
operator|&
name|readfd
argument_list|)
expr_stmt|;
name|select
argument_list|(
literal|1
argument_list|,
operator|&
name|readfd
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|selecttimeout
argument_list|)
expr_stmt|;
comment|/* if key pressed, read all waiting keys */
if|if
condition|(
name|FD_ISSET
argument_list|(
literal|0
argument_list|,
operator|&
name|readfd
argument_list|)
condition|)
while|while
condition|(
operator|(
name|c
operator|=
name|wgetch
argument_list|(
name|stdscr
argument_list|)
operator|)
operator|!=
name|ERR
condition|)
block|{
if|if
condition|(
name|tolower
argument_list|(
name|c
argument_list|)
operator|==
literal|'l'
condition|)
block|{
name|redraw
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tolower
argument_list|(
name|c
argument_list|)
operator|==
literal|'q'
condition|)
block|{
name|nocbreak
argument_list|()
expr_stmt|;
name|endwin
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tolower
argument_list|(
name|c
argument_list|)
operator|==
literal|'r'
condition|)
block|{
name|reverse
operator|=
operator|!
name|reverse
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tolower
argument_list|(
name|c
argument_list|)
operator|==
literal|'s'
condition|)
block|{
name|sorting
operator|++
expr_stmt|;
if|if
condition|(
name|sorting
operator|>
name|STSORT_MAX
condition|)
name|sorting
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
comment|/* while */
name|close
argument_list|(
name|sfd
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|nocbreak
argument_list|()
expr_stmt|;
name|endwin
argument_list|()
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|showfrstates
parameter_list|(
name|fd
parameter_list|,
name|ifsp
parameter_list|)
name|int
name|fd
decl_stmt|;
name|ipfrstat_t
modifier|*
name|ifsp
decl_stmt|;
block|{
name|struct
name|ipfr
modifier|*
name|ipfrtab
index|[
name|IPFT_SIZE
index|]
decl_stmt|,
name|ifr
decl_stmt|;
name|frentry_t
name|fr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|PRINTF
argument_list|(
literal|"IP fragment states:\n\t%lu new\n\t%lu expired\n\t%lu hits\n"
argument_list|,
name|ifsp
operator|->
name|ifs_new
argument_list|,
name|ifsp
operator|->
name|ifs_expire
argument_list|,
name|ifsp
operator|->
name|ifs_hits
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\t%lu no memory\n\t%lu already exist\n"
argument_list|,
name|ifsp
operator|->
name|ifs_nomem
argument_list|,
name|ifsp
operator|->
name|ifs_exists
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\t%lu inuse\n"
argument_list|,
name|ifsp
operator|->
name|ifs_inuse
argument_list|)
expr_stmt|;
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ipfrtab
argument_list|,
operator|(
name|u_long
operator|)
name|ifsp
operator|->
name|ifs_table
argument_list|,
sizeof|sizeof
argument_list|(
name|ipfrtab
argument_list|)
argument_list|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IPFT_SIZE
condition|;
name|i
operator|++
control|)
while|while
condition|(
name|ipfrtab
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ifr
argument_list|,
operator|(
name|u_long
operator|)
name|ipfrtab
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
break|break;
name|PRINTF
argument_list|(
literal|"%s -> "
argument_list|,
name|hostname
argument_list|(
literal|4
argument_list|,
operator|&
name|ifr
operator|.
name|ipfr_src
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fr
argument_list|,
operator|(
name|u_long
operator|)
name|ifr
operator|.
name|ipfr_rule
argument_list|,
sizeof|sizeof
argument_list|(
name|fr
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
break|break;
name|PRINTF
argument_list|(
literal|"%s %d %d %d %#02x = %#x\n"
argument_list|,
name|hostname
argument_list|(
literal|4
argument_list|,
operator|&
name|ifr
operator|.
name|ipfr_dst
argument_list|)
argument_list|,
name|ifr
operator|.
name|ipfr_id
argument_list|,
name|ifr
operator|.
name|ipfr_ttl
argument_list|,
name|ifr
operator|.
name|ipfr_p
argument_list|,
name|ifr
operator|.
name|ipfr_tos
argument_list|,
name|fr
operator|.
name|fr_flags
argument_list|)
expr_stmt|;
name|ipfrtab
index|[
name|i
index|]
operator|=
name|ifr
operator|.
name|ipfr_next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|showauthstates
parameter_list|(
name|fd
parameter_list|,
name|asp
parameter_list|)
name|int
name|fd
decl_stmt|;
name|fr_authstat_t
modifier|*
name|asp
decl_stmt|;
block|{
name|frauthent_t
modifier|*
name|frap
decl_stmt|,
name|fra
decl_stmt|;
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|printf
argument_list|(
literal|"Authorisation hits: %qu\tmisses %qu\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|asp
operator|->
name|fas_hits
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|asp
operator|->
name|fas_miss
argument_list|)
expr_stmt|;
else|#
directive|else
name|printf
argument_list|(
literal|"Authorisation hits: %ld\tmisses %ld\n"
argument_list|,
name|asp
operator|->
name|fas_hits
argument_list|,
name|asp
operator|->
name|fas_miss
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"nospace %ld\nadded %ld\nsendfail %ld\nsendok %ld\n"
argument_list|,
name|asp
operator|->
name|fas_nospace
argument_list|,
name|asp
operator|->
name|fas_added
argument_list|,
name|asp
operator|->
name|fas_sendfail
argument_list|,
name|asp
operator|->
name|fas_sendok
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"queok %ld\nquefail %ld\nexpire %ld\n"
argument_list|,
name|asp
operator|->
name|fas_queok
argument_list|,
name|asp
operator|->
name|fas_quefail
argument_list|,
name|asp
operator|->
name|fas_expire
argument_list|)
expr_stmt|;
name|frap
operator|=
name|asp
operator|->
name|fas_faelist
expr_stmt|;
while|while
condition|(
name|frap
condition|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fra
argument_list|,
operator|(
name|u_long
operator|)
name|frap
argument_list|,
sizeof|sizeof
argument_list|(
name|fra
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
break|break;
name|printf
argument_list|(
literal|"age %ld\t"
argument_list|,
name|fra
operator|.
name|fae_age
argument_list|)
expr_stmt|;
name|printfr
argument_list|(
operator|&
name|fra
operator|.
name|fae_fr
argument_list|)
expr_stmt|;
name|frap
operator|=
name|fra
operator|.
name|fae_next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|get_ifname
parameter_list|(
name|ptr
parameter_list|)
name|void
modifier|*
name|ptr
decl_stmt|;
block|{
if|#
directive|if
name|SOLARIS
name|char
modifier|*
name|ifname
decl_stmt|;
name|ill_t
name|ill
decl_stmt|;
if|if
condition|(
name|ptr
operator|==
operator|(
name|void
operator|*
operator|)
operator|-
literal|1
condition|)
return|return
literal|"!"
return|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return
literal|"-"
return|;
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ill
argument_list|,
operator|(
name|u_long
operator|)
name|ptr
argument_list|,
sizeof|sizeof
argument_list|(
name|ill
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
literal|"X"
return|;
name|ifname
operator|=
name|malloc
argument_list|(
name|ill
operator|.
name|ill_name_length
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|kmemcpy
argument_list|(
name|ifname
argument_list|,
operator|(
name|u_long
operator|)
name|ill
operator|.
name|ill_name
argument_list|,
name|ill
operator|.
name|ill_name_length
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
literal|"X"
return|;
return|return
name|ifname
return|;
else|#
directive|else
if|#
directive|if
name|defined
argument_list|(
name|NetBSD
argument_list|)
operator|&&
operator|(
name|NetBSD
operator|>=
literal|199905
operator|)
operator|&&
operator|(
name|NetBSD
operator|<
literal|1991011
operator|)
operator|||
expr|\
name|defined
argument_list|(
name|__OpenBSD__
argument_list|)
else|#
directive|else
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
endif|#
directive|endif
name|struct
name|ifnet
name|netif
decl_stmt|;
if|if
condition|(
name|ptr
operator|==
operator|(
name|void
operator|*
operator|)
operator|-
literal|1
condition|)
return|return
literal|"!"
return|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return
literal|"-"
return|;
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|netif
argument_list|,
operator|(
name|u_long
operator|)
name|ptr
argument_list|,
sizeof|sizeof
argument_list|(
name|netif
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
literal|"X"
return|;
if|#
directive|if
name|defined
argument_list|(
name|NetBSD
argument_list|)
operator|&&
operator|(
name|NetBSD
operator|>=
literal|199905
operator|)
operator|&&
operator|(
name|NetBSD
operator|<
literal|1991011
operator|)
operator|||
expr|\
name|defined
argument_list|(
name|__OpenBSD__
argument_list|)
return|return
name|strdup
argument_list|(
name|netif
operator|.
name|if_xname
argument_list|)
return|;
else|#
directive|else
if|if
condition|(
name|kstrncpy
argument_list|(
name|buf
argument_list|,
operator|(
name|u_long
operator|)
name|netif
operator|.
name|if_name
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
literal|"X"
return|;
if|if
condition|(
name|netif
operator|.
name|if_unit
operator|<
literal|10
condition|)
name|len
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|netif
operator|.
name|if_unit
operator|<
literal|1000
condition|)
name|len
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|netif
operator|.
name|if_unit
operator|<
literal|10000
condition|)
name|len
operator|=
literal|4
expr_stmt|;
else|else
name|len
operator|=
literal|5
expr_stmt|;
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|netif
operator|.
name|if_unit
operator|%
literal|10000
argument_list|)
expr_stmt|;
return|return
name|strdup
argument_list|(
name|buf
argument_list|)
return|;
endif|#
directive|endif
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|showgroups
parameter_list|(
name|fiop
parameter_list|)
name|struct
name|friostat
modifier|*
name|fiop
decl_stmt|;
block|{
specifier|static
name|char
modifier|*
name|gnames
index|[
literal|3
index|]
init|=
block|{
literal|"Filter"
block|,
literal|"Accounting"
block|,
literal|"Authentication"
block|}
decl_stmt|;
name|frgroup_t
modifier|*
name|fp
decl_stmt|,
name|grp
decl_stmt|;
name|int
name|on
decl_stmt|,
name|off
decl_stmt|,
name|i
decl_stmt|;
name|on
operator|=
name|fiop
operator|->
name|f_active
expr_stmt|;
name|off
operator|=
literal|1
operator|-
name|on
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%s groups (active):\n"
argument_list|,
name|gnames
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|fiop
operator|->
name|f_groups
index|[
name|i
index|]
index|[
name|on
index|]
init|;
name|fp
condition|;
name|fp
operator|=
name|grp
operator|.
name|fg_next
control|)
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|grp
argument_list|,
operator|(
name|u_long
operator|)
name|fp
argument_list|,
sizeof|sizeof
argument_list|(
name|grp
argument_list|)
argument_list|)
condition|)
break|break;
else|else
name|printf
argument_list|(
literal|"%hu\n"
argument_list|,
name|grp
operator|.
name|fg_num
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s groups (inactive):\n"
argument_list|,
name|gnames
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|fiop
operator|->
name|f_groups
index|[
name|i
index|]
index|[
name|off
index|]
init|;
name|fp
condition|;
name|fp
operator|=
name|grp
operator|.
name|fg_next
control|)
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|grp
argument_list|,
operator|(
name|u_long
operator|)
name|fp
argument_list|,
sizeof|sizeof
argument_list|(
name|grp
argument_list|)
argument_list|)
condition|)
break|break;
else|else
name|printf
argument_list|(
literal|"%hu\n"
argument_list|,
name|grp
operator|.
name|fg_num
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|parse_ipportstr
parameter_list|(
name|argument
parameter_list|,
name|ip
parameter_list|,
name|port
parameter_list|)
specifier|const
name|char
modifier|*
name|argument
decl_stmt|;
name|struct
name|in_addr
modifier|*
name|ip
decl_stmt|;
name|int
modifier|*
name|port
decl_stmt|;
block|{
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|comma
decl_stmt|;
comment|/* make working copy of argument, Theoretically you must be able 	 * to write to optarg, but that seems very ugly to me.... 	 */
if|if
condition|(
operator|(
name|s
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|argument
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|perror
argument_list|(
literal|"malloc"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|s
argument_list|,
name|argument
argument_list|)
expr_stmt|;
comment|/* get port */
if|if
condition|(
operator|(
name|comma
operator|=
name|strchr
argument_list|(
name|s
argument_list|,
literal|','
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|s
argument_list|,
literal|"any"
argument_list|)
condition|)
block|{
operator|*
name|port
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|sscanf
argument_list|(
name|comma
operator|+
literal|1
argument_list|,
literal|"%d"
argument_list|,
name|port
argument_list|)
operator|||
operator|(
operator|*
name|port
operator|<
literal|0
operator|)
operator|||
operator|(
operator|*
name|port
operator|>
literal|65535
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid port specfication in %s\n"
argument_list|,
name|argument
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
operator|*
name|comma
operator|=
literal|'\0'
expr_stmt|;
block|}
comment|/* get ip address */
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|s
argument_list|,
literal|"any"
argument_list|)
condition|)
block|{
name|ip
operator|->
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|inet_aton
argument_list|(
name|s
argument_list|,
name|ip
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid IP address: %s\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* free allocated memory */
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|STATETOP
end_ifdef

begin_decl_stmt
specifier|static
name|char
name|ttlbuf
index|[
name|STSTRSIZE
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|char
modifier|*
name|ttl_to_string
parameter_list|(
name|ttl
parameter_list|)
name|long
name|int
name|ttl
decl_stmt|;
block|{
name|int
name|hours
decl_stmt|,
name|minutes
decl_stmt|,
name|seconds
decl_stmt|;
comment|/* ttl is in half seconds */
name|ttl
operator|/=
literal|2
expr_stmt|;
name|hours
operator|=
name|ttl
operator|/
literal|3600
expr_stmt|;
name|ttl
operator|=
name|ttl
operator|%
literal|3600
expr_stmt|;
name|minutes
operator|=
name|ttl
operator|/
literal|60
expr_stmt|;
name|seconds
operator|=
name|ttl
operator|%
literal|60
expr_stmt|;
if|if
condition|(
name|hours
operator|>
literal|0
condition|)
name|sprintf
argument_list|(
name|ttlbuf
argument_list|,
literal|"%2d:%02d:%02d"
argument_list|,
name|hours
argument_list|,
name|minutes
argument_list|,
name|seconds
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|ttlbuf
argument_list|,
literal|"%2d:%02d"
argument_list|,
name|minutes
argument_list|,
name|seconds
argument_list|)
expr_stmt|;
return|return
name|ttlbuf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sort_pkts
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
specifier|const
name|void
modifier|*
name|a
decl_stmt|;
specifier|const
name|void
modifier|*
name|b
decl_stmt|;
block|{
specifier|register
specifier|const
name|statetop_t
modifier|*
name|ap
init|=
name|a
decl_stmt|;
specifier|register
specifier|const
name|statetop_t
modifier|*
name|bp
init|=
name|b
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|st_pkts
operator|==
name|bp
operator|->
name|st_pkts
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|ap
operator|->
name|st_pkts
operator|<
name|bp
operator|->
name|st_pkts
condition|)
return|return
literal|1
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sort_bytes
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
specifier|const
name|void
modifier|*
name|a
decl_stmt|;
specifier|const
name|void
modifier|*
name|b
decl_stmt|;
block|{
specifier|register
specifier|const
name|statetop_t
modifier|*
name|ap
init|=
name|a
decl_stmt|;
specifier|register
specifier|const
name|statetop_t
modifier|*
name|bp
init|=
name|b
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|st_bytes
operator|==
name|bp
operator|->
name|st_bytes
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|ap
operator|->
name|st_bytes
operator|<
name|bp
operator|->
name|st_bytes
condition|)
return|return
literal|1
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sort_p
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
specifier|const
name|void
modifier|*
name|a
decl_stmt|;
specifier|const
name|void
modifier|*
name|b
decl_stmt|;
block|{
specifier|register
specifier|const
name|statetop_t
modifier|*
name|ap
init|=
name|a
decl_stmt|;
specifier|register
specifier|const
name|statetop_t
modifier|*
name|bp
init|=
name|b
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|st_p
operator|==
name|bp
operator|->
name|st_p
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|ap
operator|->
name|st_p
operator|<
name|bp
operator|->
name|st_p
condition|)
return|return
literal|1
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sort_ttl
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
specifier|const
name|void
modifier|*
name|a
decl_stmt|;
specifier|const
name|void
modifier|*
name|b
decl_stmt|;
block|{
specifier|register
specifier|const
name|statetop_t
modifier|*
name|ap
init|=
name|a
decl_stmt|;
specifier|register
specifier|const
name|statetop_t
modifier|*
name|bp
init|=
name|b
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|st_age
operator|==
name|bp
operator|->
name|st_age
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|ap
operator|->
name|st_age
operator|<
name|bp
operator|->
name|st_age
condition|)
return|return
literal|1
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


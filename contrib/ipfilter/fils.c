begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 1993-1997 by Darren Reed.  *  * Redistribution and use in source and binary forms are permitted  * provided that this notice is preserved and due credit is given  * to the original author and the contributors.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|__SVR4
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__svr4__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<arpa/nameser.h>
end_include

begin_include
include|#
directive|include
file|<resolv.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|"netinet/ip_compat.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_fil.h"
end_include

begin_include
include|#
directive|include
file|"ipf.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_proxy.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_nat.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_frag.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_state.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_auth.h"
end_include

begin_include
include|#
directive|include
file|"kmem.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
operator|(
name|__OpenBSD__
operator|)
end_if

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
end_if

begin_decl_stmt
specifier|static
specifier|const
name|char
name|sccsid
index|[]
init|=
literal|"@(#)fils.c	1.21 4/20/96 (C) 1993-1996 Darren Reed"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#)$Id: fils.c,v 2.0.2.25.2.1 1997/11/06 21:21:19 darrenr Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|_PATH_UNIX
end_ifdef

begin_define
define|#
directive|define
name|VMUNIX
value|_PATH_UNIX
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|VMUNIX
value|"/vmunix"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PRINTF
value|(void)printf
end_define

begin_define
define|#
directive|define
name|FPRINTF
value|(void)fprintf
end_define

begin_define
define|#
directive|define
name|F_IN
value|0
end_define

begin_define
define|#
directive|define
name|F_OUT
value|1
end_define

begin_define
define|#
directive|define
name|F_AC
value|2
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|filters
index|[
literal|4
index|]
init|=
block|{
literal|"ipfilter(in)"
block|,
literal|"ipfilter(out)"
block|,
literal|"ipacct(in)"
block|,
literal|"ipacct(out)"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|opts
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
decl|main
name|__P
argument_list|(
operator|(
name|int
operator|,
name|char
operator|*
index|[]
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showstats
name|__P
argument_list|(
operator|(
name|int
operator|,
name|friostat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showfrstates
name|__P
argument_list|(
operator|(
name|int
operator|,
name|ipfrstat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showlist
name|__P
argument_list|(
operator|(
name|friostat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showipstates
name|__P
argument_list|(
operator|(
name|int
operator|,
name|ips_stat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showauthstates
name|__P
argument_list|(
operator|(
name|int
operator|,
name|fr_authstat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|Usage
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|printlist
name|__P
argument_list|(
operator|(
name|frentry_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|Usage
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-aAfhIinosv] [-d<device>]\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|fr_authstat_t
name|frauthst
decl_stmt|;
name|friostat_t
name|fio
decl_stmt|;
name|ips_stat_t
name|ipsst
decl_stmt|;
name|ipfrstat_t
name|ifrst
decl_stmt|;
name|char
modifier|*
name|name
init|=
name|NULL
decl_stmt|,
modifier|*
name|device
init|=
name|IPL_NAME
decl_stmt|;
name|int
name|c
decl_stmt|,
name|fd
decl_stmt|;
if|if
condition|(
name|openkmem
argument_list|()
operator|==
operator|-
literal|1
condition|)
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setgid
argument_list|(
name|getgid
argument_list|()
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"aAfhIinosvd:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'a'
case|:
name|opts
operator||=
name|OPT_ACCNT
operator||
name|OPT_SHOWLIST
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
name|opts
operator||=
name|OPT_AUTHSTATS
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|device
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|opts
operator||=
name|OPT_FRSTATES
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|opts
operator||=
name|OPT_HITS
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|opts
operator||=
name|OPT_INQUE
operator||
name|OPT_SHOWLIST
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|opts
operator||=
name|OPT_INACTIVE
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|opts
operator||=
name|OPT_SHOWLINENO
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|opts
operator||=
name|OPT_OUTQUE
operator||
name|OPT_SHOWLIST
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|opts
operator||=
name|OPT_IPSTATES
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|opts
operator||=
name|OPT_VERBOSE
expr_stmt|;
break|break;
default|default :
name|Usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|device
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"open"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fio
argument_list|,
sizeof|sizeof
argument_list|(
name|fio
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ipsst
argument_list|,
sizeof|sizeof
argument_list|(
name|ipsst
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ifrst
argument_list|,
sizeof|sizeof
argument_list|(
name|ifrst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCGETFS
argument_list|,
operator|&
name|fio
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCGETFS)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_IPSTATES
operator|)
condition|)
block|{
name|int
name|sfd
init|=
name|open
argument_list|(
name|IPL_STATE
argument_list|,
name|O_RDONLY
argument_list|)
decl_stmt|;
if|if
condition|(
name|sfd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"open"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|sfd
argument_list|,
name|SIOCGIPST
argument_list|,
operator|&
name|ipsst
argument_list|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCGIPST)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|sfd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_FRSTATES
operator|)
operator|&&
operator|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCGFRST
argument_list|,
operator|&
name|ifrst
argument_list|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCGFRST)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opts
operator|&
name|OPT_VERBOSE
condition|)
name|PRINTF
argument_list|(
literal|"opts %#x name %s\n"
argument_list|,
name|opts
argument_list|,
name|name
condition|?
name|name
else|:
literal|"<>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_AUTHSTATS
operator|)
operator|&&
operator|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCATHST
argument_list|,
operator|&
name|frauthst
argument_list|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCATHST)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opts
operator|&
name|OPT_SHOWLIST
condition|)
block|{
name|showlist
argument_list|(
operator|&
name|fio
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_OUTQUE
operator|)
operator|&&
operator|(
name|opts
operator|&
name|OPT_INQUE
operator|)
condition|)
block|{
name|opts
operator|&=
operator|~
name|OPT_OUTQUE
expr_stmt|;
name|showlist
argument_list|(
operator|&
name|fio
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|opts
operator|&
name|OPT_IPSTATES
condition|)
name|showipstates
argument_list|(
name|fd
argument_list|,
operator|&
name|ipsst
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_FRSTATES
condition|)
name|showfrstates
argument_list|(
name|fd
argument_list|,
operator|&
name|ifrst
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_AUTHSTATS
condition|)
name|showauthstates
argument_list|(
name|fd
argument_list|,
operator|&
name|frauthst
argument_list|)
expr_stmt|;
else|else
name|showstats
argument_list|(
name|fd
argument_list|,
operator|&
name|fio
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * read the kernel stats for packets blocked and passed  */
end_comment

begin_function
specifier|static
name|void
name|showstats
parameter_list|(
name|fd
parameter_list|,
name|fp
parameter_list|)
name|int
name|fd
decl_stmt|;
name|struct
name|friostat
modifier|*
name|fp
decl_stmt|;
block|{
name|int
name|frf
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCGETFF
argument_list|,
operator|&
name|frf
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|perror
argument_list|(
literal|"ioctl(SIOCGETFF)"
argument_list|)
expr_stmt|;
if|#
directive|if
name|SOLARIS
name|PRINTF
argument_list|(
literal|"dropped packets:\tin %lu\tout %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_drop
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_drop
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"non-ip packets:\t\tin %lu\tout %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_notip
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_notip
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"   bad packets:\t\tin %lu\tout %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_bad
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_bad
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|PRINTF
argument_list|(
literal|" input packets:\t\tblocked %lu passed %lu nomatch %lu"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_block
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_pass
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_nom
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" counted %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_acct
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"output packets:\t\tblocked %lu passed %lu nomatch %lu"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_block
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_pass
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_nom
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" counted %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_acct
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" input packets logged:\tblocked %lu passed %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_bpkl
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_ppkl
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"output packets logged:\tblocked %lu passed %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_bpkl
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_ppkl
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" packets logged:\tinput %lu output %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_pkl
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_pkl
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" log failures:\t\tinput %lu output %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_skip
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_skip
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"fragment state(in):\tkept %lu\tlost %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_nfr
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_bnfr
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"fragment state(out):\tkept %lu\tlost %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_nfr
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_bnfr
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"packet state(in):\tkept %lu\tlost %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_ads
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_bads
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"packet state(out):\tkept %lu\tlost %lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_ads
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_bads
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"ICMP replies:\t%lu\tTCP RSTs sent:\t%lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_ret
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_ret
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"Result cache hits(in):\t%lu\t(out):\t%lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_chit
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_chit
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"IN Pullups succeeded:\t%lu\tfailed:\t%lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_pull
index|[
literal|0
index|]
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_pull
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"OUT Pullups succeeded:\t%lu\tfailed:\t%lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_pull
index|[
literal|0
index|]
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_pull
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"Fastroute successes:\t%lu\tfailures:\t%lu\n"
argument_list|,
name|fp
operator|->
name|f_froute
index|[
literal|0
index|]
argument_list|,
name|fp
operator|->
name|f_froute
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"TCP cksum fails in:\t%lu\tout%lu\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_tcpbad
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_tcpbad
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"Packet log flags set: (%#x)\n"
argument_list|,
name|frf
argument_list|)
expr_stmt|;
if|if
condition|(
name|frf
operator|&
name|FF_LOGPASS
condition|)
name|PRINTF
argument_list|(
literal|"\tpackets passed through filter\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|frf
operator|&
name|FF_LOGBLOCK
condition|)
name|PRINTF
argument_list|(
literal|"\tpackets blocked by filter\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|frf
operator|&
name|FF_LOGNOMATCH
condition|)
name|PRINTF
argument_list|(
literal|"\tpackets not matched by filter\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|frf
condition|)
name|PRINTF
argument_list|(
literal|"\tnone\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|printlist
parameter_list|(
name|fp
parameter_list|)
name|frentry_t
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|frentry
name|fb
decl_stmt|;
name|int
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|1
init|;
name|fp
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fb
argument_list|,
operator|(
name|u_long
operator|)
name|fp
argument_list|,
sizeof|sizeof
argument_list|(
name|fb
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"kmemcpy"
argument_list|)
expr_stmt|;
return|return;
block|}
name|fp
operator|=
operator|&
name|fb
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_OUTQUE
condition|)
name|fp
operator|->
name|fr_flags
operator||=
name|FR_OUTQUE
expr_stmt|;
if|if
condition|(
name|opts
operator|&
operator|(
name|OPT_HITS
operator||
name|OPT_VERBOSE
operator|)
condition|)
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|PRINTF
argument_list|(
literal|"%qd "
argument_list|,
name|fp
operator|->
name|fr_hits
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"%ld "
argument_list|,
name|fp
operator|->
name|fr_hits
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|opts
operator|&
operator|(
name|OPT_ACCNT
operator||
name|OPT_VERBOSE
operator|)
condition|)
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|PRINTF
argument_list|(
literal|"%qd "
argument_list|,
name|fp
operator|->
name|fr_bytes
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"%ld "
argument_list|,
name|fp
operator|->
name|fr_bytes
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|opts
operator|&
name|OPT_SHOWLINENO
condition|)
name|PRINTF
argument_list|(
literal|"@%d "
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|printfr
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_VERBOSE
condition|)
name|binprint
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_grp
condition|)
name|printlist
argument_list|(
name|fp
operator|->
name|fr_grp
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fp
operator|->
name|fr_next
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * print out filter rule list  */
end_comment

begin_function
specifier|static
name|void
name|showlist
parameter_list|(
name|fiop
parameter_list|)
name|struct
name|friostat
modifier|*
name|fiop
decl_stmt|;
block|{
name|struct
name|frentry
modifier|*
name|fp
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|set
decl_stmt|;
name|set
operator|=
name|fiop
operator|->
name|f_active
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_INACTIVE
condition|)
name|set
operator|=
literal|1
operator|-
name|set
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_ACCNT
condition|)
block|{
name|i
operator|=
name|F_AC
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_OUTQUE
condition|)
block|{
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_acctout
index|[
name|set
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_INQUE
condition|)
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_acctin
index|[
name|set
index|]
expr_stmt|;
else|else
block|{
name|FPRINTF
argument_list|(
name|stderr
argument_list|,
literal|"No -i or -o given with -a\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_OUTQUE
condition|)
block|{
name|i
operator|=
name|F_OUT
expr_stmt|;
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_fout
index|[
name|set
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_INQUE
condition|)
block|{
name|i
operator|=
name|F_IN
expr_stmt|;
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_fin
index|[
name|set
index|]
expr_stmt|;
block|}
else|else
return|return;
if|if
condition|(
name|opts
operator|&
name|OPT_VERBOSE
condition|)
name|FPRINTF
argument_list|(
name|stderr
argument_list|,
literal|"showlist:opts %#x i %d\n"
argument_list|,
name|opts
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_VERBOSE
condition|)
name|PRINTF
argument_list|(
literal|"fp %p set %d\n"
argument_list|,
name|fp
argument_list|,
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|FPRINTF
argument_list|(
name|stderr
argument_list|,
literal|"empty list for %s%s\n"
argument_list|,
operator|(
name|opts
operator|&
name|OPT_INACTIVE
operator|)
condition|?
literal|"inactive "
else|:
literal|""
argument_list|,
name|filters
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|printlist
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|showipstates
parameter_list|(
name|fd
parameter_list|,
name|ipsp
parameter_list|)
name|int
name|fd
decl_stmt|;
name|ips_stat_t
modifier|*
name|ipsp
decl_stmt|;
block|{
name|ipstate_t
modifier|*
name|istab
index|[
name|IPSTATE_SIZE
index|]
decl_stmt|,
name|ips
decl_stmt|;
name|int
name|i
decl_stmt|;
name|PRINTF
argument_list|(
literal|"IP states added:\n\t%lu TCP\n\t%lu UDP\n\t%lu ICMP\n"
argument_list|,
name|ipsp
operator|->
name|iss_tcp
argument_list|,
name|ipsp
operator|->
name|iss_udp
argument_list|,
name|ipsp
operator|->
name|iss_icmp
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\t%lu hits\n\t%lu misses\n"
argument_list|,
name|ipsp
operator|->
name|iss_hits
argument_list|,
name|ipsp
operator|->
name|iss_miss
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\t%lu maximum\n\t%lu no memory\n"
argument_list|,
name|ipsp
operator|->
name|iss_max
argument_list|,
name|ipsp
operator|->
name|iss_nomem
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\t%lu active\n\t%lu expired\n\t%lu closed\n"
argument_list|,
name|ipsp
operator|->
name|iss_active
argument_list|,
name|ipsp
operator|->
name|iss_expire
argument_list|,
name|ipsp
operator|->
name|iss_fin
argument_list|)
expr_stmt|;
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|istab
argument_list|,
operator|(
name|u_long
operator|)
name|ipsp
operator|->
name|iss_table
argument_list|,
sizeof|sizeof
argument_list|(
name|istab
argument_list|)
argument_list|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IPSTATE_SIZE
condition|;
name|i
operator|++
control|)
while|while
condition|(
name|istab
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ips
argument_list|,
operator|(
name|u_long
operator|)
name|istab
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ips
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
break|break;
name|PRINTF
argument_list|(
literal|"%s -> "
argument_list|,
name|inet_ntoa
argument_list|(
name|ips
operator|.
name|is_src
argument_list|)
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%s ttl %ld pass %d pr %d state %d/%d\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|ips
operator|.
name|is_dst
argument_list|)
argument_list|,
name|ips
operator|.
name|is_age
argument_list|,
name|ips
operator|.
name|is_pass
argument_list|,
name|ips
operator|.
name|is_p
argument_list|,
name|ips
operator|.
name|is_state
index|[
literal|0
index|]
argument_list|,
name|ips
operator|.
name|is_state
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|PRINTF
argument_list|(
literal|"\tpkts %qd bytes %qd"
argument_list|,
name|ips
operator|.
name|is_pkts
argument_list|,
name|ips
operator|.
name|is_bytes
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"\tpkts %ld bytes %ld"
argument_list|,
name|ips
operator|.
name|is_pkts
argument_list|,
name|ips
operator|.
name|is_bytes
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_TCP
condition|)
name|PRINTF
argument_list|(
literal|"\t%hu -> %hu %lu:%lu %hu:%hu\n"
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_sport
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_dport
argument_list|)
argument_list|,
name|ips
operator|.
name|is_seq
argument_list|,
name|ips
operator|.
name|is_ack
argument_list|,
name|ips
operator|.
name|is_swin
argument_list|,
name|ips
operator|.
name|is_dwin
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_UDP
condition|)
name|PRINTF
argument_list|(
literal|" %hu -> %hu\n"
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_sport
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|ips
operator|.
name|is_dport
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_ICMP
condition|)
name|PRINTF
argument_list|(
literal|" %hu %hu %d\n"
argument_list|,
name|ips
operator|.
name|is_icmp
operator|.
name|ics_id
argument_list|,
name|ips
operator|.
name|is_icmp
operator|.
name|ics_seq
argument_list|,
name|ips
operator|.
name|is_icmp
operator|.
name|ics_type
argument_list|)
expr_stmt|;
comment|/* phil@ultimate.com ... */
name|PRINTF
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
comment|/* from "printfr()" */
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_PASS
condition|)
block|{
name|PRINTF
argument_list|(
literal|"pass"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_BLOCK
condition|)
block|{
name|PRINTF
argument_list|(
literal|"block"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_RETICMP
condition|)
name|PRINTF
argument_list|(
literal|" return-icmp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_RETRST
condition|)
name|PRINTF
argument_list|(
literal|" return-rst"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGMASK
operator|)
operator|==
name|FR_LOG
condition|)
block|{
name|PRINTF
argument_list|(
literal|"log"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGBODY
condition|)
name|PRINTF
argument_list|(
literal|" body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGFIRST
condition|)
name|PRINTF
argument_list|(
literal|" first"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_ACCOUNT
condition|)
name|PRINTF
argument_list|(
literal|"count"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_OUTQUE
condition|)
name|PRINTF
argument_list|(
literal|" out"
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|" in"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ips
operator|.
name|is_pass
operator|&
operator|(
name|FR_LOGB
operator||
name|FR_LOGP
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|" log"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGBODY
condition|)
name|PRINTF
argument_list|(
literal|" body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGFIRST
condition|)
name|PRINTF
argument_list|(
literal|" first"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_LOGORBLOCK
condition|)
name|PRINTF
argument_list|(
literal|" or-block"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_QUICK
condition|)
name|PRINTF
argument_list|(
literal|" quick"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_KEEPFRAG
condition|)
name|PRINTF
argument_list|(
literal|" keep frags"
argument_list|)
expr_stmt|;
comment|/* a given; no? */
if|if
condition|(
name|ips
operator|.
name|is_pass
operator|&
name|FR_KEEPSTATE
condition|)
name|PRINTF
argument_list|(
literal|" keep state"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* ... phil@ultimate.com */
name|istab
index|[
name|i
index|]
operator|=
name|ips
operator|.
name|is_next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|showfrstates
parameter_list|(
name|fd
parameter_list|,
name|ifsp
parameter_list|)
name|int
name|fd
decl_stmt|;
name|ipfrstat_t
modifier|*
name|ifsp
decl_stmt|;
block|{
name|struct
name|ipfr
modifier|*
name|ipfrtab
index|[
name|IPFT_SIZE
index|]
decl_stmt|,
name|ifr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|PRINTF
argument_list|(
literal|"IP fragment states:\n\t%lu new\n\t%lu expired\n\t%lu hits\n"
argument_list|,
name|ifsp
operator|->
name|ifs_new
argument_list|,
name|ifsp
operator|->
name|ifs_expire
argument_list|,
name|ifsp
operator|->
name|ifs_hits
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\t%lu no memory\n\t%lu already exist\n"
argument_list|,
name|ifsp
operator|->
name|ifs_nomem
argument_list|,
name|ifsp
operator|->
name|ifs_exists
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\t%lu inuse\n"
argument_list|,
name|ifsp
operator|->
name|ifs_inuse
argument_list|)
expr_stmt|;
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ipfrtab
argument_list|,
operator|(
name|u_long
operator|)
name|ifsp
operator|->
name|ifs_table
argument_list|,
sizeof|sizeof
argument_list|(
name|ipfrtab
argument_list|)
argument_list|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IPFT_SIZE
condition|;
name|i
operator|++
control|)
while|while
condition|(
name|ipfrtab
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ifr
argument_list|,
operator|(
name|u_long
operator|)
name|ipfrtab
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
break|break;
name|PRINTF
argument_list|(
literal|"%s -> "
argument_list|,
name|inet_ntoa
argument_list|(
name|ifr
operator|.
name|ipfr_src
argument_list|)
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%s %d %d %d %#02x = %#x\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|ifr
operator|.
name|ipfr_dst
argument_list|)
argument_list|,
name|ifr
operator|.
name|ipfr_id
argument_list|,
name|ifr
operator|.
name|ipfr_ttl
argument_list|,
name|ifr
operator|.
name|ipfr_p
argument_list|,
name|ifr
operator|.
name|ipfr_tos
argument_list|,
name|ifr
operator|.
name|ipfr_pass
argument_list|)
expr_stmt|;
name|ipfrtab
index|[
name|i
index|]
operator|=
name|ifr
operator|.
name|ipfr_next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|showauthstates
parameter_list|(
name|fd
parameter_list|,
name|asp
parameter_list|)
name|int
name|fd
decl_stmt|;
name|fr_authstat_t
modifier|*
name|asp
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|printf
argument_list|(
literal|"Authorisation hits: %qd\tmisses %qd\n"
argument_list|,
name|asp
operator|->
name|fas_hits
argument_list|,
name|asp
operator|->
name|fas_miss
argument_list|)
expr_stmt|;
else|#
directive|else
name|printf
argument_list|(
literal|"Authorisation hits: %ld\tmisses %ld\n"
argument_list|,
name|asp
operator|->
name|fas_hits
argument_list|,
name|asp
operator|->
name|fas_miss
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"nospace %ld\nadded %ld\nsendfail %ld\nsendok %ld\n"
argument_list|,
name|asp
operator|->
name|fas_nospace
argument_list|,
name|asp
operator|->
name|fas_added
argument_list|,
name|asp
operator|->
name|fas_sendfail
argument_list|,
name|asp
operator|->
name|fas_sendok
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"queok %ld\nquefail %ld\nexpire %ld\n"
argument_list|,
name|asp
operator|->
name|fas_queok
argument_list|,
name|asp
operator|->
name|fas_quefail
argument_list|,
name|asp
operator|->
name|fas_expire
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


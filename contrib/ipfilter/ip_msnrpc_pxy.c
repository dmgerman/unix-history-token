begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/*  * Copyright (C) 2000-2003 by Darren Reed  *  * See the IPFILTER.LICENCE file for details on licencing.  *  * Simple DCE transparent proxy for MSN RPC.  *  * ******* NOTE: THIS PROXY DOES NOT DO ADDRESS TRANSLATION ********  *  * Id: ip_msnrpc_pxy.c,v 2.17.2.1 2005/02/04 10:22:55 darrenr Exp  */
end_comment

begin_define
define|#
directive|define
name|IPF_MSNRPC_PROXY
end_define

begin_define
define|#
directive|define
name|IPF_MINMSNRPCLEN
value|24
end_define

begin_define
define|#
directive|define
name|IPF_MSNRPCSKIP
value|(2 + 19 + 2 + 2 + 2 + 19 + 2 + 2)
end_define

begin_typedef
typedef|typedef
struct|struct
name|msnrpchdr
block|{
name|u_char
name|mrh_major
decl_stmt|;
comment|/* major # == 5 */
name|u_char
name|mrh_minor
decl_stmt|;
comment|/* minor # == 0 */
name|u_char
name|mrh_type
decl_stmt|;
name|u_char
name|mrh_flags
decl_stmt|;
name|u_32_t
name|mrh_endian
decl_stmt|;
name|u_short
name|mrh_dlen
decl_stmt|;
comment|/* data size */
name|u_short
name|mrh_alen
decl_stmt|;
comment|/* authentication length */
name|u_32_t
name|mrh_cid
decl_stmt|;
comment|/* call identifier */
name|u_32_t
name|mrh_hint
decl_stmt|;
comment|/* allocation hint */
name|u_short
name|mrh_ctxt
decl_stmt|;
comment|/* presentation context hint */
name|u_char
name|mrh_ccnt
decl_stmt|;
comment|/* cancel count */
name|u_char
name|mrh_ans
decl_stmt|;
block|}
name|msnrpchdr_t
typedef|;
end_typedef

begin_decl_stmt
name|int
name|ippr_msnrpc_init
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ippr_msnrpc_fini
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ippr_msnrpc_new
name|__P
argument_list|(
operator|(
name|fr_info_t
operator|*
operator|,
name|ap_session_t
operator|*
operator|,
name|nat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ippr_msnrpc_out
name|__P
argument_list|(
operator|(
name|fr_info_t
operator|*
operator|,
name|ap_session_t
operator|*
operator|,
name|nat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ippr_msnrpc_in
name|__P
argument_list|(
operator|(
name|fr_info_t
operator|*
operator|,
name|ap_session_t
operator|*
operator|,
name|nat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ippr_msnrpc_check
name|__P
argument_list|(
operator|(
name|ip_t
operator|*
operator|,
name|msnrpchdr_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|frentry_t
name|msnfr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|msn_proxy_init
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Initialize local structures.  */
end_comment

begin_function
name|int
name|ippr_msnrpc_init
parameter_list|()
block|{
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|msnfr
argument_list|,
sizeof|sizeof
argument_list|(
name|msnfr
argument_list|)
argument_list|)
expr_stmt|;
name|msnfr
operator|.
name|fr_ref
operator|=
literal|1
expr_stmt|;
name|msnfr
operator|.
name|fr_flags
operator|=
name|FR_INQUE
operator||
name|FR_PASS
operator||
name|FR_QUICK
operator||
name|FR_KEEPSTATE
expr_stmt|;
name|MUTEX_INIT
argument_list|(
operator|&
name|msnfr
operator|.
name|fr_lock
argument_list|,
literal|"MSN RPC proxy rule lock"
argument_list|)
expr_stmt|;
name|msn_proxy_init
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ippr_msnrpc_fini
parameter_list|()
block|{
if|if
condition|(
name|msn_proxy_init
operator|==
literal|1
condition|)
block|{
name|MUTEX_DESTROY
argument_list|(
operator|&
name|msnfr
operator|.
name|fr_lock
argument_list|)
expr_stmt|;
name|msn_proxy_init
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|ippr_msnrpc_new
parameter_list|(
name|fin
parameter_list|,
name|aps
parameter_list|,
name|nat
parameter_list|)
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|ap_session_t
modifier|*
name|aps
decl_stmt|;
name|nat_t
modifier|*
name|nat
decl_stmt|;
block|{
name|msnrpcinfo_t
modifier|*
name|mri
decl_stmt|;
name|KMALLOC
argument_list|(
name|mri
argument_list|,
name|msnrpcinfo_t
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|mri
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|aps
operator|->
name|aps_data
operator|=
name|mri
expr_stmt|;
name|aps
operator|->
name|aps_psiz
operator|=
sizeof|sizeof
argument_list|(
name|msnrpcinfo_t
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|mri
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|mri
argument_list|)
argument_list|)
expr_stmt|;
name|mri
operator|->
name|mri_cmd
index|[
literal|0
index|]
operator|=
literal|0xff
expr_stmt|;
name|mri
operator|->
name|mri_cmd
index|[
literal|1
index|]
operator|=
literal|0xff
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ippr_msnrpc_check
parameter_list|(
name|ip
parameter_list|,
name|mrh
parameter_list|)
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|msnrpchdr_t
modifier|*
name|mrh
decl_stmt|;
block|{
if|if
condition|(
name|mrh
operator|->
name|mrh_major
operator|!=
literal|5
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|mrh
operator|->
name|mrh_minor
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|mrh
operator|->
name|mrh_alen
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|mrh
operator|->
name|mrh_endian
operator|==
literal|0x10
condition|)
block|{
comment|/* Both gateway and packet match endian */
if|if
condition|(
name|mrh
operator|->
name|mrh_dlen
operator|>
name|ip
operator|->
name|ip_len
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|mrh
operator|->
name|mrh_type
operator|==
literal|0
operator|||
name|mrh
operator|->
name|mrh_type
operator|==
literal|2
condition|)
if|if
condition|(
name|mrh
operator|->
name|mrh_hint
operator|>
name|ip
operator|->
name|ip_len
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|mrh
operator|->
name|mrh_endian
operator|==
literal|0x10000000
condition|)
block|{
comment|/* XXX - Endian mismatch - should be swapping! */
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ippr_msnrpc_out
parameter_list|(
name|fin
parameter_list|,
name|ip
parameter_list|,
name|aps
parameter_list|,
name|nat
parameter_list|)
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|ap_session_t
modifier|*
name|aps
decl_stmt|;
name|nat_t
modifier|*
name|nat
decl_stmt|;
block|{
name|msnrpcinfo_t
modifier|*
name|mri
decl_stmt|;
name|msnrpchdr_t
modifier|*
name|mrh
decl_stmt|;
name|tcphdr_t
modifier|*
name|tcp
decl_stmt|;
name|int
name|dlen
decl_stmt|;
name|mri
operator|=
name|aps
operator|->
name|aps_data
expr_stmt|;
if|if
condition|(
name|mri
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|tcp
operator|=
operator|(
name|tcphdr_t
operator|*
operator|)
name|fin
operator|->
name|fin_dp
expr_stmt|;
name|dlen
operator|=
name|fin
operator|->
name|fin_dlen
operator|-
operator|(
name|TCP_OFF
argument_list|(
name|tcp
argument_list|)
operator|<<
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|dlen
operator|<
name|IPF_MINMSNRPCLEN
condition|)
return|return
literal|0
return|;
name|mrh
operator|=
operator|(
name|msnrpchdr_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|tcp
operator|+
operator|(
name|TCP_OFF
argument_list|(
name|tcp
argument_list|)
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|ippr_msnrpc_check
argument_list|(
name|ip
argument_list|,
name|mrh
argument_list|)
condition|)
return|return
literal|0
return|;
name|mri
operator|->
name|mri_valid
operator|++
expr_stmt|;
switch|switch
condition|(
name|mrh
operator|->
name|mrh_type
condition|)
block|{
case|case
literal|0x0b
case|:
comment|/* BIND */
case|case
literal|0x00
case|:
comment|/* REQUEST */
break|break;
case|case
literal|0x0c
case|:
comment|/* BIND ACK */
case|case
literal|0x02
case|:
comment|/* RESPONSE */
default|default:
return|return
literal|0
return|;
block|}
name|mri
operator|->
name|mri_cmd
index|[
literal|1
index|]
operator|=
name|mrh
operator|->
name|mrh_type
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ippr_msnrpc_in
parameter_list|(
name|fin
parameter_list|,
name|ip
parameter_list|,
name|aps
parameter_list|,
name|nat
parameter_list|)
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|ap_session_t
modifier|*
name|aps
decl_stmt|;
name|nat_t
modifier|*
name|nat
decl_stmt|;
block|{
name|tcphdr_t
modifier|*
name|tcp
decl_stmt|,
name|tcph
decl_stmt|,
modifier|*
name|tcp2
init|=
operator|&
name|tcph
decl_stmt|;
name|int
name|dlen
decl_stmt|,
name|sz
decl_stmt|,
name|sz2
decl_stmt|,
name|i
decl_stmt|;
name|msnrpcinfo_t
modifier|*
name|mri
decl_stmt|;
name|msnrpchdr_t
modifier|*
name|mrh
decl_stmt|;
name|fr_info_t
name|fi
decl_stmt|;
name|u_short
name|len
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|mri
operator|=
name|aps
operator|->
name|aps_data
expr_stmt|;
if|if
condition|(
name|mri
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|tcp
operator|=
operator|(
name|tcphdr_t
operator|*
operator|)
name|fin
operator|->
name|fin_dp
expr_stmt|;
name|dlen
operator|=
name|fin
operator|->
name|fin_dlen
operator|-
operator|(
name|TCP_OFF
argument_list|(
name|tcp
argument_list|)
operator|<<
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|dlen
operator|<
name|IPF_MINMSNRPCLEN
condition|)
return|return
literal|0
return|;
name|mrh
operator|=
operator|(
name|msnrpchdr_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|tcp
operator|+
operator|(
name|TCP_OFF
argument_list|(
name|tcp
argument_list|)
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|ippr_msnrpc_check
argument_list|(
name|ip
argument_list|,
name|mrh
argument_list|)
condition|)
return|return
literal|0
return|;
name|mri
operator|->
name|mri_valid
operator|++
expr_stmt|;
switch|switch
condition|(
name|mrh
operator|->
name|mrh_type
condition|)
block|{
case|case
literal|0x0c
case|:
comment|/* BIND ACK */
if|if
condition|(
name|mri
operator|->
name|mri_cmd
index|[
literal|1
index|]
operator|!=
literal|0x0b
condition|)
return|return
literal|0
return|;
break|break;
case|case
literal|0x02
case|:
comment|/* RESPONSE */
if|if
condition|(
name|mri
operator|->
name|mri_cmd
index|[
literal|1
index|]
operator|!=
literal|0x00
condition|)
return|return
literal|0
return|;
break|break;
case|case
literal|0x0b
case|:
comment|/* BIND */
case|case
literal|0x00
case|:
comment|/* REQUEST */
default|default:
return|return
literal|0
return|;
block|}
name|mri
operator|->
name|mri_cmd
index|[
literal|0
index|]
operator|=
name|mrh
operator|->
name|mrh_type
expr_stmt|;
name|dlen
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|mrh
argument_list|)
expr_stmt|;
comment|/* 	 * Only processes RESPONSE's 	 */
if|if
condition|(
name|mrh
operator|->
name|mrh_type
operator|!=
literal|0x02
condition|)
return|return
literal|0
return|;
comment|/* 	 * Skip over some bytes...what are these really ? 	 */
if|if
condition|(
name|dlen
operator|<=
literal|44
condition|)
return|return
literal|0
return|;
name|s
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|mrh
operator|+
literal|1
operator|)
operator|+
literal|20
expr_stmt|;
name|dlen
operator|-=
literal|20
expr_stmt|;
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|1
condition|)
block|{
name|s
operator|+=
literal|20
expr_stmt|;
name|dlen
operator|-=
literal|20
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|len
operator|==
literal|2
condition|)
block|{
name|s
operator|+=
literal|24
expr_stmt|;
name|dlen
operator|-=
literal|24
expr_stmt|;
block|}
else|else
return|return
literal|0
return|;
if|if
condition|(
name|dlen
operator|<=
literal|10
condition|)
return|return
literal|0
return|;
name|dlen
operator|-=
literal|10
expr_stmt|;
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|sz
argument_list|,
sizeof|sizeof
argument_list|(
name|sz
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|sz
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|sz2
argument_list|,
sizeof|sizeof
argument_list|(
name|sz2
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|sz2
argument_list|)
expr_stmt|;
if|if
condition|(
name|sz2
operator|!=
name|sz
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|sz
operator|>
name|dlen
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
name|s
operator|++
operator|!=
literal|5
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
name|s
operator|++
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
name|sz
operator|-=
name|IPF_MSNRPCSKIP
expr_stmt|;
name|s
operator|+=
name|IPF_MSNRPCSKIP
expr_stmt|;
name|dlen
operator|-=
name|IPF_MSNRPCSKIP
expr_stmt|;
do|do
block|{
if|if
condition|(
name|sz
operator|<
literal|7
operator|||
name|dlen
operator|<
literal|7
condition|)
break|break;
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlen
operator|<
name|len
condition|)
break|break;
if|if
condition|(
name|sz
operator|<
name|len
condition|)
break|break;
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
break|break;
name|sz
operator|-=
literal|3
expr_stmt|;
name|i
operator|=
operator|*
operator|(
name|s
operator|+
literal|2
operator|)
expr_stmt|;
name|s
operator|+=
literal|3
expr_stmt|;
name|dlen
operator|-=
literal|3
expr_stmt|;
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlen
operator|<
name|len
condition|)
break|break;
if|if
condition|(
name|sz
operator|<
name|len
condition|)
break|break;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|7
case|:
if|if
condition|(
name|len
operator|==
literal|2
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mri
operator|->
name|mri_rport
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|mri
operator|->
name|mri_flags
operator||=
literal|1
expr_stmt|;
block|}
break|break;
case|case
literal|9
case|:
if|if
condition|(
name|len
operator|==
literal|4
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mri
operator|->
name|mri_raddr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|mri
operator|->
name|mri_flags
operator||=
literal|2
expr_stmt|;
block|}
break|break;
default|default :
break|break;
block|}
name|sz
operator|-=
name|len
expr_stmt|;
name|s
operator|+=
name|len
expr_stmt|;
name|dlen
operator|-=
name|len
expr_stmt|;
block|}
do|while
condition|(
name|sz
operator|>
literal|0
condition|)
do|;
if|if
condition|(
name|mri
operator|->
name|mri_flags
operator|==
literal|3
condition|)
block|{
name|int
name|slen
decl_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fin
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|fi
argument_list|,
sizeof|sizeof
argument_list|(
name|fi
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tcp2
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tcp2
argument_list|)
argument_list|)
expr_stmt|;
name|slen
operator|=
name|ip
operator|->
name|ip_len
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
name|fin
operator|->
name|fin_hlen
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|tcp2
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fin
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|fi
argument_list|,
sizeof|sizeof
argument_list|(
name|fi
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tcp2
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tcp2
argument_list|)
argument_list|)
expr_stmt|;
name|tcp2
operator|->
name|th_win
operator|=
name|htons
argument_list|(
literal|8192
argument_list|)
expr_stmt|;
name|TCP_OFF_A
argument_list|(
name|tcp2
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|fi
operator|.
name|fin_data
index|[
literal|0
index|]
operator|=
name|htons
argument_list|(
name|mri
operator|->
name|mri_rport
argument_list|)
expr_stmt|;
name|tcp2
operator|->
name|th_sport
operator|=
name|mri
operator|->
name|mri_rport
expr_stmt|;
name|fi
operator|.
name|fin_data
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|tcp2
operator|->
name|th_dport
operator|=
literal|0
expr_stmt|;
name|fi
operator|.
name|fin_state
operator|=
name|NULL
expr_stmt|;
name|fi
operator|.
name|fin_nat
operator|=
name|NULL
expr_stmt|;
name|fi
operator|.
name|fin_dlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|tcp2
argument_list|)
expr_stmt|;
name|fi
operator|.
name|fin_plen
operator|=
name|fi
operator|.
name|fin_hlen
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|tcp2
argument_list|)
expr_stmt|;
name|fi
operator|.
name|fin_dp
operator|=
operator|(
name|char
operator|*
operator|)
name|tcp2
expr_stmt|;
name|fi
operator|.
name|fin_fi
operator|.
name|fi_daddr
operator|=
name|ip
operator|->
name|ip_dst
operator|.
name|s_addr
expr_stmt|;
name|fi
operator|.
name|fin_fi
operator|.
name|fi_saddr
operator|=
name|mri
operator|->
name|mri_raddr
operator|.
name|s_addr
expr_stmt|;
if|if
condition|(
operator|!
name|fi
operator|.
name|fin_fr
condition|)
name|fi
operator|.
name|fin_fr
operator|=
operator|&
name|msnfr
expr_stmt|;
if|if
condition|(
name|fr_stlookup
argument_list|(
operator|&
name|fi
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|RWLOCK_EXIT
argument_list|(
operator|&
name|ipf_state
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|fr_addstate
argument_list|(
operator|&
name|fi
argument_list|,
name|NULL
argument_list|,
name|SI_W_DPORT
operator||
name|SI_CLONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|fi
operator|.
name|fin_state
operator|!=
name|NULL
condition|)
name|fr_statederef
argument_list|(
operator|&
name|fi
argument_list|,
operator|(
name|ipstate_t
operator|*
operator|*
operator|)
operator|&
name|fi
operator|.
name|fin_state
argument_list|)
expr_stmt|;
block|}
name|ip
operator|->
name|ip_len
operator|=
name|slen
expr_stmt|;
block|}
name|mri
operator|->
name|mri_flags
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


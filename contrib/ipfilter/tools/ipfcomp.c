begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/*  * Copyright (C) 2012 by Darren Reed.  *  * See the IPFILTER.LICENCE file for details on licencing.  */
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
end_if

begin_decl_stmt
specifier|static
specifier|const
name|char
name|sccsid
index|[]
init|=
literal|"@(#)ip_fil.c	2.41 6/5/96 (C) 1993-2000 Darren Reed"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#)$Id$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"ipf.h"
end_include

begin_typedef
typedef|typedef
struct|struct
block|{
name|int
name|c
decl_stmt|;
name|int
name|e
decl_stmt|;
name|int
name|n
decl_stmt|;
name|int
name|p
decl_stmt|;
name|int
name|s
decl_stmt|;
block|}
name|mc_t
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|portcmp
index|[]
init|=
block|{
literal|"*"
block|,
literal|"=="
block|,
literal|"!="
block|,
literal|"<"
block|,
literal|">"
block|,
literal|"<="
block|,
literal|">="
block|,
literal|"**"
block|,
literal|"***"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|count
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|intcmp
name|__P
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|,
specifier|const
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|indent
name|__P
argument_list|(
operator|(
name|FILE
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|printeq
name|__P
argument_list|(
operator|(
name|FILE
operator|*
operator|,
name|char
operator|*
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|printipeq
name|__P
argument_list|(
operator|(
name|FILE
operator|*
operator|,
name|char
operator|*
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|addrule
name|__P
argument_list|(
operator|(
name|FILE
operator|*
operator|,
name|frentry_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|printhooks
name|__P
argument_list|(
operator|(
name|FILE
operator|*
operator|,
name|int
operator|,
name|int
operator|,
name|frgroup_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|emitheader
name|__P
argument_list|(
operator|(
name|frgroup_t
operator|*
operator|,
name|u_int
operator|,
name|u_int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|emitGroup
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|,
name|void
operator|*
operator|,
name|frentry_t
operator|*
operator|,
name|char
operator|*
operator|,
name|u_int
operator|,
name|u_int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|emittail
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|printCgroup
name|__P
argument_list|(
operator|(
name|int
operator|,
name|frentry_t
operator|*
operator|,
name|mc_t
operator|*
operator|,
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|FRC_IFN
value|0
end_define

begin_define
define|#
directive|define
name|FRC_V
value|1
end_define

begin_define
define|#
directive|define
name|FRC_P
value|2
end_define

begin_define
define|#
directive|define
name|FRC_FL
value|3
end_define

begin_define
define|#
directive|define
name|FRC_TOS
value|4
end_define

begin_define
define|#
directive|define
name|FRC_TTL
value|5
end_define

begin_define
define|#
directive|define
name|FRC_SRC
value|6
end_define

begin_define
define|#
directive|define
name|FRC_DST
value|7
end_define

begin_define
define|#
directive|define
name|FRC_TCP
value|8
end_define

begin_define
define|#
directive|define
name|FRC_SP
value|9
end_define

begin_define
define|#
directive|define
name|FRC_DP
value|10
end_define

begin_define
define|#
directive|define
name|FRC_OPT
value|11
end_define

begin_define
define|#
directive|define
name|FRC_SEC
value|12
end_define

begin_define
define|#
directive|define
name|FRC_ATH
value|13
end_define

begin_define
define|#
directive|define
name|FRC_ICT
value|14
end_define

begin_define
define|#
directive|define
name|FRC_ICC
value|15
end_define

begin_define
define|#
directive|define
name|FRC_MAX
value|16
end_define

begin_decl_stmt
specifier|static
name|FILE
modifier|*
name|cfile
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * This is called once per filter rule being loaded to emit data structures  * required.  */
end_comment

begin_function
name|void
name|printc
parameter_list|(
name|fr
parameter_list|)
name|frentry_t
modifier|*
name|fr
decl_stmt|;
block|{
name|fripf_t
modifier|*
name|ipf
decl_stmt|;
name|u_long
modifier|*
name|ulp
decl_stmt|;
name|char
modifier|*
name|and
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|fr
operator|->
name|fr_family
operator|==
literal|6
condition|)
return|return;
if|if
condition|(
operator|(
name|fr
operator|->
name|fr_type
operator|!=
name|FR_T_IPF
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|!=
name|FR_T_NONE
operator|)
condition|)
return|return;
if|if
condition|(
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
operator|(
name|fr
operator|->
name|fr_datype
operator|!=
name|FRI_NORMAL
operator|)
operator|||
operator|(
name|fr
operator|->
name|fr_satype
operator|!=
name|FRI_NORMAL
operator|)
operator|)
condition|)
return|return;
name|ipf
operator|=
name|fr
operator|->
name|fr_ipf
expr_stmt|;
if|if
condition|(
name|cfile
operator|==
name|NULL
condition|)
name|cfile
operator|=
name|fopen
argument_list|(
literal|"ip_rules.c"
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfile
operator|==
name|NULL
condition|)
return|return;
name|fp
operator|=
name|cfile
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"/*\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"* Copyright (C) 2012 by Darren Reed.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"*\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"* Redistribution and use in source and binary forms are permitted\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"* provided that this notice is preserved and due credit is given\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"* to the original author and the contributors.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"*/\n\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include<sys/param.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include<sys/types.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include<sys/time.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include<sys/socket.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#if (__FreeBSD_version>= 40000)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"# if defined(_KERNEL)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#  include<sys/libkern.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"# else\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#  include<sys/unistd.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"# endif\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#endif\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#if (__NetBSD_Version__>= 399000000)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#else\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"# if !defined(__FreeBSD__)&& !defined(__OpenBSD__)&& !defined(__sgi)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#  include<sys/systm.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"# endif\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#endif\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include<sys/errno.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include<sys/param.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#if !defined(__SVR4)&& !defined(__svr4__)&& !defined(__hpux)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"# include<sys/mbuf.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#endif\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#if defined(__FreeBSD__)&& (__FreeBSD_version> 220000)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"# include<sys/sockio.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#else\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"# include<sys/ioctl.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#endif /* FreeBSD */\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include<net/if.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include<netinet/in.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include<netinet/in_systm.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include<netinet/ip.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include<netinet/tcp.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include \"netinet/ip_compat.h\"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include \"netinet/ip_fil.h\"\n\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#include \"netinet/ip_rules.h\"\n\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#ifndef _KERNEL\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"# include<string.h>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#endif /* _KERNEL */\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"#ifdef IPFILTER_COMPILED\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"extern ipf_main_softc_t ipfmain;\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|addrule
argument_list|(
name|fp
argument_list|,
name|fr
argument_list|)
expr_stmt|;
name|fr
operator|->
name|fr_type
operator||=
name|FR_T_BUILTIN
expr_stmt|;
name|and
operator|=
literal|""
expr_stmt|;
name|fr
operator|->
name|fr_ref
operator|=
literal|1
expr_stmt|;
name|i
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|fr
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|&
operator|-
operator|(
literal|1
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|ulp
argument_list|)
operator|)
condition|)
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|/=
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
operator|,
name|ulp
operator|=
operator|(
name|u_long
operator|*
operator|)
name|fr
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s%#lx"
argument_list|,
name|and
argument_list|,
operator|*
name|ulp
operator|++
argument_list|)
expr_stmt|;
name|and
operator|=
literal|", "
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n};\n"
argument_list|)
expr_stmt|;
name|fr
operator|->
name|fr_type
operator|&=
operator|~
name|FR_T_BUILTIN
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|fflush
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|frgroup_t
modifier|*
name|groups
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|addrule
parameter_list|(
name|fp
parameter_list|,
name|fr
parameter_list|)
name|FILE
modifier|*
name|fp
decl_stmt|;
name|frentry_t
modifier|*
name|fr
decl_stmt|;
block|{
name|frentry_t
modifier|*
name|f
decl_stmt|,
modifier|*
modifier|*
name|fpp
decl_stmt|;
name|frgroup_t
modifier|*
name|g
decl_stmt|;
name|u_long
modifier|*
name|ulp
decl_stmt|;
name|char
modifier|*
name|ghead
decl_stmt|;
name|char
modifier|*
name|gname
decl_stmt|;
name|char
modifier|*
name|and
decl_stmt|;
name|int
name|i
decl_stmt|;
name|f
operator|=
operator|(
name|frentry_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|f
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fr
argument_list|,
operator|(
name|char
operator|*
operator|)
name|f
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fr
operator|->
name|fr_ipf
condition|)
block|{
name|f
operator|->
name|fr_ipf
operator|=
operator|(
name|fripf_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|f
operator|->
name|fr_ipf
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fr
operator|->
name|fr_ipf
argument_list|,
operator|(
name|char
operator|*
operator|)
name|f
operator|->
name|fr_ipf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fr
operator|->
name|fr_ipf
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|f
operator|->
name|fr_next
operator|=
name|NULL
expr_stmt|;
name|gname
operator|=
name|FR_NAME
argument_list|(
name|fr
argument_list|,
name|fr_group
argument_list|)
expr_stmt|;
for|for
control|(
name|g
operator|=
name|groups
init|;
name|g
operator|!=
name|NULL
condition|;
name|g
operator|=
name|g
operator|->
name|fg_next
control|)
if|if
condition|(
operator|(
name|strncmp
argument_list|(
name|g
operator|->
name|fg_name
argument_list|,
name|gname
argument_list|,
name|FR_GROUPLEN
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|g
operator|->
name|fg_flags
operator|==
operator|(
name|f
operator|->
name|fr_flags
operator|&
name|FR_INOUT
operator|)
operator|)
condition|)
break|break;
if|if
condition|(
name|g
operator|==
name|NULL
condition|)
block|{
name|g
operator|=
operator|(
name|frgroup_t
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|g
argument_list|)
argument_list|)
expr_stmt|;
name|g
operator|->
name|fg_next
operator|=
name|groups
expr_stmt|;
name|groups
operator|=
name|g
expr_stmt|;
name|g
operator|->
name|fg_head
operator|=
name|f
expr_stmt|;
name|strncpy
argument_list|(
name|g
operator|->
name|fg_name
argument_list|,
name|gname
argument_list|,
name|FR_GROUPLEN
argument_list|)
expr_stmt|;
name|g
operator|->
name|fg_ref
operator|=
literal|0
expr_stmt|;
name|g
operator|->
name|fg_flags
operator|=
name|f
operator|->
name|fr_flags
operator|&
name|FR_INOUT
expr_stmt|;
block|}
for|for
control|(
name|fpp
operator|=
operator|&
name|g
operator|->
name|fg_start
init|;
operator|*
name|fpp
operator|!=
name|NULL
condition|;
control|)
name|fpp
operator|=
operator|&
operator|(
operator|(
operator|*
name|fpp
operator|)
operator|->
name|fr_next
operator|)
expr_stmt|;
operator|*
name|fpp
operator|=
name|f
expr_stmt|;
if|if
condition|(
name|fr
operator|->
name|fr_dsize
operator|>
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ static u_long ipf%s_rule_data_%s_%u[] = {\n"
argument_list|,
name|f
operator|->
name|fr_flags
operator|&
name|FR_INQUE
condition|?
literal|"in"
else|:
literal|"out"
argument_list|,
name|g
operator|->
name|fg_name
argument_list|,
name|g
operator|->
name|fg_ref
argument_list|)
expr_stmt|;
name|and
operator|=
literal|""
expr_stmt|;
name|i
operator|=
name|fr
operator|->
name|fr_dsize
expr_stmt|;
name|ulp
operator|=
name|fr
operator|->
name|fr_data
expr_stmt|;
for|for
control|(
name|i
operator|/=
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s%#lx"
argument_list|,
name|and
argument_list|,
operator|*
name|ulp
operator|++
argument_list|)
expr_stmt|;
name|and
operator|=
literal|", "
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n};\n"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\nstatic u_long %s_rule_%s_%d[] = {\n"
argument_list|,
name|f
operator|->
name|fr_flags
operator|&
name|FR_INQUE
condition|?
literal|"in"
else|:
literal|"out"
argument_list|,
name|g
operator|->
name|fg_name
argument_list|,
name|g
operator|->
name|fg_ref
argument_list|)
expr_stmt|;
name|g
operator|->
name|fg_ref
operator|++
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|fr_grhead
operator|!=
operator|-
literal|1
condition|)
block|{
name|ghead
operator|=
name|FR_NAME
argument_list|(
name|f
argument_list|,
name|fr_grhead
argument_list|)
expr_stmt|;
for|for
control|(
name|g
operator|=
name|groups
init|;
name|g
operator|!=
name|NULL
condition|;
name|g
operator|=
name|g
operator|->
name|fg_next
control|)
if|if
condition|(
operator|(
name|strncmp
argument_list|(
name|g
operator|->
name|fg_name
argument_list|,
name|ghead
argument_list|,
name|FR_GROUPLEN
argument_list|)
operator|==
literal|0
operator|)
operator|&&
name|g
operator|->
name|fg_flags
operator|==
operator|(
name|f
operator|->
name|fr_flags
operator|&
name|FR_INOUT
operator|)
condition|)
break|break;
if|if
condition|(
name|g
operator|==
name|NULL
condition|)
block|{
name|g
operator|=
operator|(
name|frgroup_t
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|g
argument_list|)
argument_list|)
expr_stmt|;
name|g
operator|->
name|fg_next
operator|=
name|groups
expr_stmt|;
name|groups
operator|=
name|g
expr_stmt|;
name|g
operator|->
name|fg_head
operator|=
name|f
expr_stmt|;
name|strncpy
argument_list|(
name|g
operator|->
name|fg_name
argument_list|,
name|ghead
argument_list|,
name|FR_GROUPLEN
argument_list|)
expr_stmt|;
name|g
operator|->
name|fg_ref
operator|=
literal|0
expr_stmt|;
name|g
operator|->
name|fg_flags
operator|=
name|f
operator|->
name|fr_flags
operator|&
name|FR_INOUT
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|intcmp
parameter_list|(
name|c1
parameter_list|,
name|c2
parameter_list|)
specifier|const
name|void
modifier|*
name|c1
decl_stmt|,
decl|*
name|c2
decl_stmt|;
end_function

begin_block
block|{
specifier|const
name|mc_t
modifier|*
name|i1
init|=
operator|(
specifier|const
name|mc_t
operator|*
operator|)
name|c1
decl_stmt|,
modifier|*
name|i2
init|=
operator|(
specifier|const
name|mc_t
operator|*
operator|)
name|c2
decl_stmt|;
if|if
condition|(
name|i1
operator|->
name|n
operator|==
name|i2
operator|->
name|n
condition|)
block|{
return|return
name|i1
operator|->
name|c
operator|-
name|i2
operator|->
name|c
return|;
block|}
return|return
name|i2
operator|->
name|n
operator|-
name|i1
operator|->
name|n
return|;
block|}
end_block

begin_function
specifier|static
name|void
name|indent
parameter_list|(
name|fp
parameter_list|,
name|in
parameter_list|)
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|in
decl_stmt|;
block|{
for|for
control|(
init|;
name|in
condition|;
name|in
operator|--
control|)
name|fputc
argument_list|(
literal|'\t'
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|printeq
parameter_list|(
name|fp
parameter_list|,
name|var
parameter_list|,
name|m
parameter_list|,
name|max
parameter_list|,
name|v
parameter_list|)
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
modifier|*
name|var
decl_stmt|;
name|int
name|m
decl_stmt|,
name|max
decl_stmt|,
name|v
decl_stmt|;
block|{
if|if
condition|(
name|m
operator|==
name|max
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s == %#x) {\n"
argument_list|,
name|var
argument_list|,
name|v
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"(%s& %#x) == %#x) {\n"
argument_list|,
name|var
argument_list|,
name|m
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Parameters: var - IP# being compared  *             fl - 0 for positive match, 1 for negative match  *             m - netmask  *             v - required address  */
end_comment

begin_function
specifier|static
name|void
name|printipeq
parameter_list|(
name|fp
parameter_list|,
name|var
parameter_list|,
name|fl
parameter_list|,
name|m
parameter_list|,
name|v
parameter_list|)
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
modifier|*
name|var
decl_stmt|;
name|int
name|fl
decl_stmt|,
name|m
decl_stmt|,
name|v
decl_stmt|;
block|{
if|if
condition|(
name|m
operator|==
literal|0xffffffff
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s "
argument_list|,
name|var
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"(%s& %#x) "
argument_list|,
name|var
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%c"
argument_list|,
name|fl
condition|?
literal|'!'
else|:
literal|'='
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"= %#x) {\n"
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|emit
parameter_list|(
name|num
parameter_list|,
name|dir
parameter_list|,
name|v
parameter_list|,
name|fr
parameter_list|)
name|int
name|num
decl_stmt|,
name|dir
decl_stmt|;
name|void
modifier|*
name|v
decl_stmt|;
name|frentry_t
modifier|*
name|fr
decl_stmt|;
block|{
name|u_int
name|incnt
decl_stmt|,
name|outcnt
decl_stmt|;
name|frgroup_t
modifier|*
name|g
decl_stmt|;
name|frentry_t
modifier|*
name|f
decl_stmt|;
for|for
control|(
name|g
operator|=
name|groups
init|;
name|g
operator|!=
name|NULL
condition|;
name|g
operator|=
name|g
operator|->
name|fg_next
control|)
block|{
if|if
condition|(
name|dir
operator|==
literal|0
operator|||
name|dir
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|g
operator|->
name|fg_flags
operator|&
name|FR_INQUE
operator|)
operator|==
literal|0
condition|)
continue|continue;
for|for
control|(
name|incnt
operator|=
literal|0
operator|,
name|f
operator|=
name|g
operator|->
name|fg_start
init|;
name|f
operator|!=
name|NULL
condition|;
name|f
operator|=
name|f
operator|->
name|fr_next
control|)
name|incnt
operator|++
expr_stmt|;
name|emitGroup
argument_list|(
name|num
argument_list|,
name|dir
argument_list|,
name|v
argument_list|,
name|fr
argument_list|,
name|g
operator|->
name|fg_name
argument_list|,
name|incnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dir
operator|==
literal|1
operator|||
name|dir
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|g
operator|->
name|fg_flags
operator|&
name|FR_OUTQUE
operator|)
operator|==
literal|0
condition|)
continue|continue;
for|for
control|(
name|outcnt
operator|=
literal|0
operator|,
name|f
operator|=
name|g
operator|->
name|fg_start
init|;
name|f
operator|!=
name|NULL
condition|;
name|f
operator|=
name|f
operator|->
name|fr_next
control|)
name|outcnt
operator|++
expr_stmt|;
name|emitGroup
argument_list|(
name|num
argument_list|,
name|dir
argument_list|,
name|v
argument_list|,
name|fr
argument_list|,
name|g
operator|->
name|fg_name
argument_list|,
literal|0
argument_list|,
name|outcnt
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|num
operator|==
operator|-
literal|1
operator|&&
name|dir
operator|==
operator|-
literal|1
condition|)
block|{
for|for
control|(
name|g
operator|=
name|groups
init|;
name|g
operator|!=
name|NULL
condition|;
name|g
operator|=
name|g
operator|->
name|fg_next
control|)
block|{
if|if
condition|(
operator|(
name|g
operator|->
name|fg_flags
operator|&
name|FR_INQUE
operator|)
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|incnt
operator|=
literal|0
operator|,
name|f
operator|=
name|g
operator|->
name|fg_start
init|;
name|f
operator|!=
name|NULL
condition|;
name|f
operator|=
name|f
operator|->
name|fr_next
control|)
name|incnt
operator|++
expr_stmt|;
if|if
condition|(
name|incnt
operator|>
literal|0
condition|)
name|emitheader
argument_list|(
name|g
argument_list|,
name|incnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|g
operator|->
name|fg_flags
operator|&
name|FR_OUTQUE
operator|)
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|outcnt
operator|=
literal|0
operator|,
name|f
operator|=
name|g
operator|->
name|fg_start
init|;
name|f
operator|!=
name|NULL
condition|;
name|f
operator|=
name|f
operator|->
name|fr_next
control|)
name|outcnt
operator|++
expr_stmt|;
if|if
condition|(
name|outcnt
operator|>
literal|0
condition|)
name|emitheader
argument_list|(
name|g
argument_list|,
literal|0
argument_list|,
name|outcnt
argument_list|)
expr_stmt|;
block|}
block|}
name|emittail
argument_list|()
expr_stmt|;
name|fprintf
argument_list|(
name|cfile
argument_list|,
literal|"#endif /* IPFILTER_COMPILED */\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|emitheader
parameter_list|(
name|grp
parameter_list|,
name|incount
parameter_list|,
name|outcount
parameter_list|)
name|frgroup_t
modifier|*
name|grp
decl_stmt|;
name|u_int
name|incount
decl_stmt|,
name|outcount
decl_stmt|;
block|{
specifier|static
name|FILE
modifier|*
name|fph
init|=
name|NULL
decl_stmt|;
name|frgroup_t
modifier|*
name|g
decl_stmt|;
if|if
condition|(
name|fph
operator|==
name|NULL
condition|)
block|{
name|fph
operator|=
name|fopen
argument_list|(
literal|"ip_rules.h"
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fph
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|fph
argument_list|,
literal|"extern int ipfrule_add __P((void));\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fph
argument_list|,
literal|"extern int ipfrule_remove __P((void));\n"
argument_list|)
expr_stmt|;
block|}
name|printhooks
argument_list|(
name|cfile
argument_list|,
name|incount
argument_list|,
name|outcount
argument_list|,
name|grp
argument_list|)
expr_stmt|;
if|if
condition|(
name|incount
condition|)
block|{
name|fprintf
argument_list|(
name|fph
argument_list|,
literal|"\n\ extern frentry_t *ipfrule_match_in_%s __P((fr_info_t *, u_32_t *));\n\ extern frentry_t *ipf_rules_in_%s[%d];\n"
argument_list|,
name|grp
operator|->
name|fg_name
argument_list|,
name|grp
operator|->
name|fg_name
argument_list|,
name|incount
argument_list|)
expr_stmt|;
for|for
control|(
name|g
operator|=
name|groups
init|;
name|g
operator|!=
name|grp
condition|;
name|g
operator|=
name|g
operator|->
name|fg_next
control|)
if|if
condition|(
operator|(
name|strncmp
argument_list|(
name|g
operator|->
name|fg_name
argument_list|,
name|grp
operator|->
name|fg_name
argument_list|,
name|FR_GROUPLEN
argument_list|)
operator|==
literal|0
operator|)
operator|&&
name|g
operator|->
name|fg_flags
operator|==
name|grp
operator|->
name|fg_flags
condition|)
break|break;
if|if
condition|(
name|g
operator|==
name|grp
condition|)
block|{
name|fprintf
argument_list|(
name|fph
argument_list|,
literal|"\n\ extern int ipfrule_add_in_%s __P((void));\n\ extern int ipfrule_remove_in_%s __P((void));\n"
argument_list|,
name|grp
operator|->
name|fg_name
argument_list|,
name|grp
operator|->
name|fg_name
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|outcount
condition|)
block|{
name|fprintf
argument_list|(
name|fph
argument_list|,
literal|"\n\ extern frentry_t *ipfrule_match_out_%s __P((fr_info_t *, u_32_t *));\n\ extern frentry_t *ipf_rules_out_%s[%d];\n"
argument_list|,
name|grp
operator|->
name|fg_name
argument_list|,
name|grp
operator|->
name|fg_name
argument_list|,
name|outcount
argument_list|)
expr_stmt|;
for|for
control|(
name|g
operator|=
name|groups
init|;
name|g
operator|!=
name|grp
condition|;
name|g
operator|=
name|g
operator|->
name|fg_next
control|)
if|if
condition|(
operator|(
name|strncmp
argument_list|(
name|g
operator|->
name|fg_name
argument_list|,
name|grp
operator|->
name|fg_name
argument_list|,
name|FR_GROUPLEN
argument_list|)
operator|==
literal|0
operator|)
operator|&&
name|g
operator|->
name|fg_flags
operator|==
name|grp
operator|->
name|fg_flags
condition|)
break|break;
if|if
condition|(
name|g
operator|==
name|grp
condition|)
block|{
name|fprintf
argument_list|(
name|fph
argument_list|,
literal|"\n\ extern int ipfrule_add_out_%s __P((void));\n\ extern int ipfrule_remove_out_%s __P((void));\n"
argument_list|,
name|grp
operator|->
name|fg_name
argument_list|,
name|grp
operator|->
name|fg_name
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|emittail
parameter_list|()
block|{
name|frgroup_t
modifier|*
name|g
decl_stmt|;
name|fprintf
argument_list|(
name|cfile
argument_list|,
literal|"\n\ int ipfrule_add()\n\ {\n\ 	int err;\n\ \n"
argument_list|)
expr_stmt|;
for|for
control|(
name|g
operator|=
name|groups
init|;
name|g
operator|!=
name|NULL
condition|;
name|g
operator|=
name|g
operator|->
name|fg_next
control|)
name|fprintf
argument_list|(
name|cfile
argument_list|,
literal|"\ 	err = ipfrule_add_%s_%s();\n\ 	if (err != 0)\n\ 		return err;\n"
argument_list|,
operator|(
name|g
operator|->
name|fg_flags
operator|&
name|FR_INQUE
operator|)
condition|?
literal|"in"
else|:
literal|"out"
argument_list|,
name|g
operator|->
name|fg_name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|cfile
argument_list|,
literal|"\ 	return 0;\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|cfile
argument_list|,
literal|"}\n\ \n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|cfile
argument_list|,
literal|"\n\ int ipfrule_remove()\n\ {\n\ 	int err;\n\ \n"
argument_list|)
expr_stmt|;
for|for
control|(
name|g
operator|=
name|groups
init|;
name|g
operator|!=
name|NULL
condition|;
name|g
operator|=
name|g
operator|->
name|fg_next
control|)
name|fprintf
argument_list|(
name|cfile
argument_list|,
literal|"\ 	err = ipfrule_remove_%s_%s();\n\ 	if (err != 0)\n\ 		return err;\n"
argument_list|,
operator|(
name|g
operator|->
name|fg_flags
operator|&
name|FR_INQUE
operator|)
condition|?
literal|"in"
else|:
literal|"out"
argument_list|,
name|g
operator|->
name|fg_name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|cfile
argument_list|,
literal|"\ 	return 0;\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|cfile
argument_list|,
literal|"}\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emitGroup
parameter_list|(
name|num
parameter_list|,
name|dir
parameter_list|,
name|v
parameter_list|,
name|fr
parameter_list|,
name|group
parameter_list|,
name|incount
parameter_list|,
name|outcount
parameter_list|)
name|int
name|num
decl_stmt|,
name|dir
decl_stmt|;
name|void
modifier|*
name|v
decl_stmt|;
name|frentry_t
modifier|*
name|fr
decl_stmt|;
name|char
modifier|*
name|group
decl_stmt|;
name|u_int
name|incount
decl_stmt|,
name|outcount
decl_stmt|;
block|{
specifier|static
name|FILE
modifier|*
name|fp
init|=
name|NULL
decl_stmt|;
specifier|static
name|int
name|header
index|[
literal|2
index|]
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
specifier|static
name|char
name|egroup
index|[
name|FR_GROUPLEN
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
specifier|static
name|int
name|openfunc
init|=
literal|0
decl_stmt|;
specifier|static
name|mc_t
modifier|*
name|n
init|=
name|NULL
decl_stmt|;
specifier|static
name|int
name|sin
init|=
literal|0
decl_stmt|;
name|frentry_t
modifier|*
name|f
decl_stmt|;
name|frgroup_t
modifier|*
name|g
decl_stmt|;
name|fripf_t
modifier|*
name|ipf
decl_stmt|;
name|int
name|i
decl_stmt|,
name|in
decl_stmt|,
name|j
decl_stmt|;
name|mc_t
modifier|*
name|m
init|=
name|v
decl_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
name|fp
operator|=
name|cfile
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|strncmp
argument_list|(
name|egroup
argument_list|,
name|group
argument_list|,
name|FR_GROUPLEN
argument_list|)
condition|)
block|{
for|for
control|(
name|sin
operator|--
init|;
name|sin
operator|>
literal|0
condition|;
name|sin
operator|--
control|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|sin
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"}\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|openfunc
operator|==
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\treturn fr;\n}\n"
argument_list|)
expr_stmt|;
name|openfunc
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|n
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|sin
operator|=
literal|0
expr_stmt|;
name|header
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|header
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|strncpy
argument_list|(
name|egroup
argument_list|,
name|group
argument_list|,
name|FR_GROUPLEN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|openfunc
operator|==
literal|1
operator|&&
name|num
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|n
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|n
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
name|sin
operator|--
init|;
name|sin
operator|>
literal|0
condition|;
name|sin
operator|--
control|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|sin
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"}\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|openfunc
operator|==
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\treturn fr;\n}\n"
argument_list|)
expr_stmt|;
name|openfunc
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|dir
operator|==
operator|-
literal|1
condition|)
return|return;
for|for
control|(
name|g
operator|=
name|groups
init|;
name|g
operator|!=
name|NULL
condition|;
name|g
operator|=
name|g
operator|->
name|fg_next
control|)
block|{
if|if
condition|(
name|dir
operator|==
literal|0
operator|&&
operator|(
name|g
operator|->
name|fg_flags
operator|&
name|FR_INQUE
operator|)
operator|==
literal|0
condition|)
continue|continue;
elseif|else
if|if
condition|(
name|dir
operator|==
literal|1
operator|&&
operator|(
name|g
operator|->
name|fg_flags
operator|&
name|FR_OUTQUE
operator|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|strncmp
argument_list|(
name|g
operator|->
name|fg_name
argument_list|,
name|group
argument_list|,
name|FR_GROUPLEN
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
break|break;
block|}
comment|/* 	 * Output the array of pointers to rules for this group. 	 */
if|if
condition|(
name|g
operator|!=
name|NULL
operator|&&
name|num
operator|==
operator|-
literal|2
operator|&&
name|dir
operator|==
literal|0
operator|&&
name|header
index|[
literal|0
index|]
operator|==
literal|0
operator|&&
name|incount
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\nfrentry_t *ipf_rules_in_%s[%d] = {"
argument_list|,
name|group
argument_list|,
name|incount
argument_list|)
expr_stmt|;
for|for
control|(
name|f
operator|=
name|g
operator|->
name|fg_start
operator|,
name|i
operator|=
literal|0
init|;
name|f
operator|!=
name|NULL
condition|;
name|f
operator|=
name|f
operator|->
name|fr_next
control|)
block|{
if|if
condition|(
operator|(
name|f
operator|->
name|fr_flags
operator|&
name|FR_INQUE
operator|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|(
name|i
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n\t"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"(frentry_t *)&in_rule_%s_%d"
argument_list|,
name|FR_NAME
argument_list|(
name|f
argument_list|,
name|fr_group
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|incount
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n};\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|g
operator|!=
name|NULL
operator|&&
name|num
operator|==
operator|-
literal|2
operator|&&
name|dir
operator|==
literal|1
operator|&&
name|header
index|[
literal|0
index|]
operator|==
literal|0
operator|&&
name|outcount
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\nfrentry_t *ipf_rules_out_%s[%d] = {"
argument_list|,
name|group
argument_list|,
name|outcount
argument_list|)
expr_stmt|;
for|for
control|(
name|f
operator|=
name|g
operator|->
name|fg_start
operator|,
name|i
operator|=
literal|0
init|;
name|f
operator|!=
name|NULL
condition|;
name|f
operator|=
name|f
operator|->
name|fr_next
control|)
block|{
if|if
condition|(
operator|(
name|f
operator|->
name|fr_flags
operator|&
name|FR_OUTQUE
operator|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|(
name|i
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n\t"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"(frentry_t *)&out_rule_%s_%d"
argument_list|,
name|FR_NAME
argument_list|(
name|f
argument_list|,
name|fr_group
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|outcount
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n};\n"
argument_list|)
expr_stmt|;
name|fp
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|num
operator|<
literal|0
condition|)
return|return;
name|in
operator|=
literal|0
expr_stmt|;
name|ipf
operator|=
name|fr
operator|->
name|fr_ipf
expr_stmt|;
comment|/* 	 * If the function header has not been printed then print it now. 	 */
if|if
condition|(
name|g
operator|!=
name|NULL
operator|&&
name|header
index|[
name|dir
index|]
operator|==
literal|0
condition|)
block|{
name|int
name|pdst
init|=
literal|0
decl_stmt|,
name|psrc
init|=
literal|0
decl_stmt|;
name|openfunc
operator|=
literal|1
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\nfrentry_t *ipfrule_match_%s_%s(fin, passp)\n"
argument_list|,
operator|(
name|dir
operator|==
literal|0
operator|)
condition|?
literal|"in"
else|:
literal|"out"
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"fr_info_t *fin;\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"u_32_t *passp;\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"{\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\tfrentry_t *fr = NULL;\n"
argument_list|)
expr_stmt|;
comment|/* 		 * Print out any variables that need to be declared. 		 */
for|for
control|(
name|f
operator|=
name|g
operator|->
name|fg_start
operator|,
name|i
operator|=
literal|0
init|;
name|f
operator|!=
name|NULL
condition|;
name|f
operator|=
name|f
operator|->
name|fr_next
control|)
block|{
if|if
condition|(
name|incount
operator|+
name|outcount
operator|>
name|m
index|[
name|FRC_SRC
index|]
operator|.
name|e
operator|+
literal|1
condition|)
name|psrc
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|incount
operator|+
name|outcount
operator|>
name|m
index|[
name|FRC_DST
index|]
operator|.
name|e
operator|+
literal|1
condition|)
name|pdst
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|psrc
operator|==
literal|1
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\tu_32_t src = ntohl(%s);\n"
argument_list|,
literal|"fin->fin_fi.fi_saddr"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdst
operator|==
literal|1
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\tu_32_t dst = ntohl(%s);\n"
argument_list|,
literal|"fin->fin_fi.fi_daddr"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FRC_MAX
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|m
index|[
name|i
index|]
operator|.
name|c
condition|)
block|{
case|case
name|FRC_IFN
case|:
if|if
condition|(
name|fr
operator|->
name|fr_ifnames
index|[
literal|0
index|]
operator|!=
operator|-
literal|1
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_V
case|:
if|if
condition|(
name|ipf
operator|!=
name|NULL
operator|&&
name|ipf
operator|->
name|fri_mip
operator|.
name|fi_v
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_FL
case|:
if|if
condition|(
name|ipf
operator|!=
name|NULL
operator|&&
name|ipf
operator|->
name|fri_mip
operator|.
name|fi_flx
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_P
case|:
if|if
condition|(
name|ipf
operator|!=
name|NULL
operator|&&
name|ipf
operator|->
name|fri_mip
operator|.
name|fi_p
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_TTL
case|:
if|if
condition|(
name|ipf
operator|!=
name|NULL
operator|&&
name|ipf
operator|->
name|fri_mip
operator|.
name|fi_ttl
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_TOS
case|:
if|if
condition|(
name|ipf
operator|!=
name|NULL
operator|&&
name|ipf
operator|->
name|fri_mip
operator|.
name|fi_tos
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_TCP
case|:
if|if
condition|(
name|ipf
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
operator|(
name|ipf
operator|->
name|fri_ip
operator|.
name|fi_p
operator|==
name|IPPROTO_TCP
operator|)
operator|&&
name|fr
operator|->
name|fr_tcpfm
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_SP
case|:
if|if
condition|(
name|ipf
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|fr
operator|->
name|fr_scmp
operator|==
name|FR_INRANGE
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|fr
operator|->
name|fr_scmp
operator|==
name|FR_OUTRANGE
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|fr
operator|->
name|fr_scmp
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_DP
case|:
if|if
condition|(
name|ipf
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|fr
operator|->
name|fr_dcmp
operator|==
name|FR_INRANGE
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|fr
operator|->
name|fr_dcmp
operator|==
name|FR_OUTRANGE
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|fr
operator|->
name|fr_dcmp
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_SRC
case|:
if|if
condition|(
name|ipf
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|fr
operator|->
name|fr_satype
operator|==
name|FRI_LOOKUP
condition|)
block|{
empty_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|fr
operator|->
name|fr_smask
operator|!=
literal|0
operator|)
operator|||
operator|(
name|fr
operator|->
name|fr_flags
operator|&
name|FR_NOTSRCIP
operator|)
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_DST
case|:
if|if
condition|(
name|ipf
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|fr
operator|->
name|fr_datype
operator|==
name|FRI_LOOKUP
condition|)
block|{
empty_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|fr
operator|->
name|fr_dmask
operator|!=
literal|0
operator|)
operator|||
operator|(
name|fr
operator|->
name|fr_flags
operator|&
name|FR_NOTDSTIP
operator|)
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_OPT
case|:
if|if
condition|(
name|ipf
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|fr
operator|->
name|fr_optmask
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_SEC
case|:
if|if
condition|(
name|ipf
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|fr
operator|->
name|fr_secmask
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_ATH
case|:
if|if
condition|(
name|ipf
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|fr
operator|->
name|fr_authmask
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_ICT
case|:
if|if
condition|(
name|ipf
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
operator|(
name|fr
operator|->
name|fr_icmpm
operator|&
literal|0xff00
operator|)
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FRC_ICC
case|:
if|if
condition|(
name|ipf
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
operator|(
name|fr
operator|->
name|fr_icmpm
operator|&
literal|0xff
operator|)
operator|!=
literal|0
condition|)
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|header
index|[
name|dir
index|]
condition|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|header
index|[
name|dir
index|]
operator|=
literal|1
expr_stmt|;
name|sin
operator|=
literal|0
expr_stmt|;
block|}
name|qsort
argument_list|(
name|m
argument_list|,
name|FRC_MAX
argument_list|,
sizeof|sizeof
argument_list|(
name|mc_t
argument_list|)
argument_list|,
name|intcmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
condition|)
block|{
comment|/* 		 * Calculate the indentation interval upto the last common 		 * common comparison being made. 		 */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|in
operator|=
literal|1
init|;
name|i
operator|<
name|FRC_MAX
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|n
index|[
name|i
index|]
operator|.
name|c
operator|!=
name|m
index|[
name|i
index|]
operator|.
name|c
condition|)
break|break;
if|if
condition|(
name|n
index|[
name|i
index|]
operator|.
name|s
operator|!=
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
break|break;
if|if
condition|(
name|n
index|[
name|i
index|]
operator|.
name|s
condition|)
block|{
if|if
condition|(
name|n
index|[
name|i
index|]
operator|.
name|n
operator|&&
operator|(
name|n
index|[
name|i
index|]
operator|.
name|n
operator|>
name|n
index|[
name|i
index|]
operator|.
name|e
operator|)
condition|)
block|{
name|m
index|[
name|i
index|]
operator|.
name|p
operator|++
expr_stmt|;
name|in
operator|+=
name|m
index|[
name|i
index|]
operator|.
name|p
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|n
index|[
name|i
index|]
operator|.
name|e
operator|>
literal|0
condition|)
block|{
name|in
operator|++
expr_stmt|;
block|}
else|else
break|break;
block|}
block|}
if|if
condition|(
name|sin
operator|!=
name|in
condition|)
block|{
for|for
control|(
name|j
operator|=
name|sin
operator|-
literal|1
init|;
name|j
operator|>=
name|in
condition|;
name|j
operator|--
control|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"}\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|in
operator|=
literal|1
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 	 * print out C code that implements a filter rule. 	 */
for|for
control|(
init|;
name|i
operator|<
name|FRC_MAX
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|m
index|[
name|i
index|]
operator|.
name|c
condition|)
block|{
case|case
name|FRC_IFN
case|:
if|if
condition|(
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if (fin->fin_ifp == "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"ipf_rules_%s_%s[%d]->fr_ifa) {\n"
argument_list|,
name|dir
condition|?
literal|"out"
else|:
literal|"in"
argument_list|,
name|group
argument_list|,
name|num
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_V
case|:
if|if
condition|(
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if (fin->fin_v == %d) {\n"
argument_list|,
name|ipf
operator|->
name|fri_ip
operator|.
name|fi_v
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_FL
case|:
if|if
condition|(
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ("
argument_list|)
expr_stmt|;
name|printeq
argument_list|(
name|fp
argument_list|,
literal|"fin->fin_flx"
argument_list|,
name|ipf
operator|->
name|fri_mip
operator|.
name|fi_flx
argument_list|,
literal|0xf
argument_list|,
name|ipf
operator|->
name|fri_ip
operator|.
name|fi_flx
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_P
case|:
if|if
condition|(
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if (fin->fin_p == %d) {\n"
argument_list|,
name|ipf
operator|->
name|fri_ip
operator|.
name|fi_p
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_TTL
case|:
if|if
condition|(
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ("
argument_list|)
expr_stmt|;
name|printeq
argument_list|(
name|fp
argument_list|,
literal|"fin->fin_ttl"
argument_list|,
name|ipf
operator|->
name|fri_mip
operator|.
name|fi_ttl
argument_list|,
literal|0xff
argument_list|,
name|ipf
operator|->
name|fri_ip
operator|.
name|fi_ttl
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_TOS
case|:
if|if
condition|(
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if (fin->fin_tos"
argument_list|)
expr_stmt|;
name|printeq
argument_list|(
name|fp
argument_list|,
literal|"fin->fin_tos"
argument_list|,
name|ipf
operator|->
name|fri_mip
operator|.
name|fi_tos
argument_list|,
literal|0xff
argument_list|,
name|ipf
operator|->
name|fri_ip
operator|.
name|fi_tos
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_TCP
case|:
if|if
condition|(
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ("
argument_list|)
expr_stmt|;
name|printeq
argument_list|(
name|fp
argument_list|,
literal|"fin->fin_tcpf"
argument_list|,
name|fr
operator|->
name|fr_tcpfm
argument_list|,
literal|0xff
argument_list|,
name|fr
operator|->
name|fr_tcpf
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_SP
case|:
if|if
condition|(
operator|!
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
break|break;
if|if
condition|(
name|fr
operator|->
name|fr_scmp
operator|==
name|FR_INRANGE
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ((fin->fin_data[0]> %d)&& "
argument_list|,
name|fr
operator|->
name|fr_sport
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"(fin->fin_data[0]< %d)"
argument_list|,
name|fr
operator|->
name|fr_stop
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|") {\n"
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fr
operator|->
name|fr_scmp
operator|==
name|FR_OUTRANGE
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ((fin->fin_data[0]< %d) || "
argument_list|,
name|fr
operator|->
name|fr_sport
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"(fin->fin_data[0]> %d)"
argument_list|,
name|fr
operator|->
name|fr_stop
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|") {\n"
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fr
operator|->
name|fr_scmp
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if (fin->fin_data[0] %s %d)"
argument_list|,
name|portcmp
index|[
name|fr
operator|->
name|fr_scmp
index|]
argument_list|,
name|fr
operator|->
name|fr_sport
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" {\n"
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_DP
case|:
if|if
condition|(
operator|!
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
break|break;
if|if
condition|(
name|fr
operator|->
name|fr_dcmp
operator|==
name|FR_INRANGE
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ((fin->fin_data[1]> %d)&& "
argument_list|,
name|fr
operator|->
name|fr_dport
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"(fin->fin_data[1]< %d)"
argument_list|,
name|fr
operator|->
name|fr_dtop
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|") {\n"
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fr
operator|->
name|fr_dcmp
operator|==
name|FR_OUTRANGE
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ((fin->fin_data[1]< %d) || "
argument_list|,
name|fr
operator|->
name|fr_dport
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"(fin->fin_data[1]> %d)"
argument_list|,
name|fr
operator|->
name|fr_dtop
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|") {\n"
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fr
operator|->
name|fr_dcmp
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if (fin->fin_data[1] %s %d)"
argument_list|,
name|portcmp
index|[
name|fr
operator|->
name|fr_dcmp
index|]
argument_list|,
name|fr
operator|->
name|fr_dport
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" {\n"
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_SRC
case|:
if|if
condition|(
operator|!
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
break|break;
if|if
condition|(
name|fr
operator|->
name|fr_satype
operator|==
name|FRI_LOOKUP
condition|)
block|{
empty_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|fr
operator|->
name|fr_smask
operator|!=
literal|0
operator|)
operator|||
operator|(
name|fr
operator|->
name|fr_flags
operator|&
name|FR_NOTSRCIP
operator|)
operator|!=
literal|0
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ("
argument_list|)
expr_stmt|;
name|printipeq
argument_list|(
name|fp
argument_list|,
literal|"src"
argument_list|,
name|fr
operator|->
name|fr_flags
operator|&
name|FR_NOTSRCIP
argument_list|,
name|fr
operator|->
name|fr_smask
argument_list|,
name|fr
operator|->
name|fr_saddr
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_DST
case|:
if|if
condition|(
operator|!
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
break|break;
if|if
condition|(
name|fr
operator|->
name|fr_datype
operator|==
name|FRI_LOOKUP
condition|)
block|{
empty_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|fr
operator|->
name|fr_dmask
operator|!=
literal|0
operator|)
operator|||
operator|(
name|fr
operator|->
name|fr_flags
operator|&
name|FR_NOTDSTIP
operator|)
operator|!=
literal|0
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ("
argument_list|)
expr_stmt|;
name|printipeq
argument_list|(
name|fp
argument_list|,
literal|"dst"
argument_list|,
name|fr
operator|->
name|fr_flags
operator|&
name|FR_NOTDSTIP
argument_list|,
name|fr
operator|->
name|fr_dmask
argument_list|,
name|fr
operator|->
name|fr_daddr
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_OPT
case|:
if|if
condition|(
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ("
argument_list|)
expr_stmt|;
name|printeq
argument_list|(
name|fp
argument_list|,
literal|"fin->fin_fi.fi_optmsk"
argument_list|,
name|fr
operator|->
name|fr_optmask
argument_list|,
literal|0xffffffff
argument_list|,
name|fr
operator|->
name|fr_optbits
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_SEC
case|:
if|if
condition|(
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ("
argument_list|)
expr_stmt|;
name|printeq
argument_list|(
name|fp
argument_list|,
literal|"fin->fin_fi.fi_secmsk"
argument_list|,
name|fr
operator|->
name|fr_secmask
argument_list|,
literal|0xffff
argument_list|,
name|fr
operator|->
name|fr_secbits
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_ATH
case|:
if|if
condition|(
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ("
argument_list|)
expr_stmt|;
name|printeq
argument_list|(
name|fp
argument_list|,
literal|"fin->fin_fi.fi_authmsk"
argument_list|,
name|fr
operator|->
name|fr_authmask
argument_list|,
literal|0xffff
argument_list|,
name|fr
operator|->
name|fr_authbits
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_ICT
case|:
if|if
condition|(
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ("
argument_list|)
expr_stmt|;
name|printeq
argument_list|(
name|fp
argument_list|,
literal|"fin->fin_data[0]"
argument_list|,
name|fr
operator|->
name|fr_icmpm
operator|&
literal|0xff00
argument_list|,
literal|0xffff
argument_list|,
name|fr
operator|->
name|fr_icmp
operator|&
literal|0xff00
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|FRC_ICC
case|:
if|if
condition|(
name|m
index|[
name|i
index|]
operator|.
name|s
condition|)
block|{
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"if ("
argument_list|)
expr_stmt|;
name|printeq
argument_list|(
name|fp
argument_list|,
literal|"fin->fin_data[0]"
argument_list|,
name|fr
operator|->
name|fr_icmpm
operator|&
literal|0xff
argument_list|,
literal|0xffff
argument_list|,
name|fr
operator|->
name|fr_icmp
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|in
operator|++
expr_stmt|;
block|}
break|break;
block|}
block|}
name|indent
argument_list|(
name|fp
argument_list|,
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|fr
operator|->
name|fr_flags
operator|&
name|FR_QUICK
condition|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"return (frentry_t *)&%s_rule_%s_%d;\n"
argument_list|,
name|fr
operator|->
name|fr_flags
operator|&
name|FR_INQUE
condition|?
literal|"in"
else|:
literal|"out"
argument_list|,
name|FR_NAME
argument_list|(
name|fr
argument_list|,
name|fr_group
argument_list|)
argument_list|,
name|num
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"fr = (frentry_t *)&%s_rule_%s_%d;\n"
argument_list|,
name|fr
operator|->
name|fr_flags
operator|&
name|FR_INQUE
condition|?
literal|"in"
else|:
literal|"out"
argument_list|,
name|FR_NAME
argument_list|(
name|fr
argument_list|,
name|fr_group
argument_list|)
argument_list|,
name|num
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
name|n
operator|=
operator|(
name|mc_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|n
argument_list|)
operator|*
name|FRC_MAX
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|m
argument_list|,
operator|(
name|char
operator|*
operator|)
name|n
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|n
argument_list|)
operator|*
name|FRC_MAX
argument_list|)
expr_stmt|;
name|sin
operator|=
name|in
expr_stmt|;
block|}
end_function

begin_function
name|void
name|printC
parameter_list|(
name|dir
parameter_list|)
name|int
name|dir
decl_stmt|;
block|{
specifier|static
name|mc_t
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|frgroup_t
modifier|*
name|g
decl_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
name|m
operator|=
operator|(
name|mc_t
operator|*
operator|)
name|calloc
argument_list|(
name|FRC_MAX
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|m
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|g
operator|=
name|groups
init|;
name|g
operator|!=
name|NULL
condition|;
name|g
operator|=
name|g
operator|->
name|fg_next
control|)
block|{
if|if
condition|(
operator|(
name|dir
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|g
operator|->
name|fg_flags
operator|&
name|FR_INQUE
operator|)
operator|!=
literal|0
operator|)
condition|)
name|printCgroup
argument_list|(
name|dir
argument_list|,
name|g
operator|->
name|fg_start
argument_list|,
name|m
argument_list|,
name|g
operator|->
name|fg_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dir
operator|==
literal|1
operator|)
operator|&&
operator|(
operator|(
name|g
operator|->
name|fg_flags
operator|&
name|FR_OUTQUE
operator|)
operator|!=
literal|0
operator|)
condition|)
name|printCgroup
argument_list|(
name|dir
argument_list|,
name|g
operator|->
name|fg_start
argument_list|,
name|m
argument_list|,
name|g
operator|->
name|fg_name
argument_list|)
expr_stmt|;
block|}
name|emit
argument_list|(
operator|-
literal|1
argument_list|,
name|dir
argument_list|,
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Now print out code to implement all of the rules.  */
end_comment

begin_function
specifier|static
name|void
name|printCgroup
parameter_list|(
name|dir
parameter_list|,
name|top
parameter_list|,
name|m
parameter_list|,
name|group
parameter_list|)
name|int
name|dir
decl_stmt|;
name|frentry_t
modifier|*
name|top
decl_stmt|;
name|mc_t
modifier|*
name|m
decl_stmt|;
name|char
modifier|*
name|group
decl_stmt|;
block|{
name|frentry_t
modifier|*
name|fr
decl_stmt|,
modifier|*
name|fr1
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|,
name|rn
decl_stmt|;
name|u_int
name|count
decl_stmt|;
for|for
control|(
name|count
operator|=
literal|0
operator|,
name|fr1
operator|=
name|top
init|;
name|fr1
operator|!=
name|NULL
condition|;
name|fr1
operator|=
name|fr1
operator|->
name|fr_next
control|)
block|{
if|if
condition|(
operator|(
name|dir
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|fr1
operator|->
name|fr_flags
operator|&
name|FR_INQUE
operator|)
operator|!=
literal|0
operator|)
condition|)
name|count
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|dir
operator|==
literal|1
operator|)
operator|&&
operator|(
operator|(
name|fr1
operator|->
name|fr_flags
operator|&
name|FR_OUTQUE
operator|)
operator|!=
literal|0
operator|)
condition|)
name|count
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|dir
operator|==
literal|0
condition|)
name|emitGroup
argument_list|(
operator|-
literal|2
argument_list|,
name|dir
argument_list|,
name|m
argument_list|,
name|fr1
argument_list|,
name|group
argument_list|,
name|count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|dir
operator|==
literal|1
condition|)
name|emitGroup
argument_list|(
operator|-
literal|2
argument_list|,
name|dir
argument_list|,
name|m
argument_list|,
name|fr1
argument_list|,
name|group
argument_list|,
literal|0
argument_list|,
name|count
argument_list|)
expr_stmt|;
comment|/* 	 * Before printing each rule, check to see how many of its fields are 	 * matched by subsequent rules. 	 */
for|for
control|(
name|fr1
operator|=
name|top
operator|,
name|rn
operator|=
literal|0
init|;
name|fr1
operator|!=
name|NULL
condition|;
name|fr1
operator|=
name|fr1
operator|->
name|fr_next
operator|,
name|rn
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|dir
operator|&&
operator|!
operator|(
name|fr1
operator|->
name|fr_flags
operator|&
name|FR_INQUE
operator|)
condition|)
continue|continue;
if|if
condition|(
name|dir
operator|&&
operator|!
operator|(
name|fr1
operator|->
name|fr_flags
operator|&
name|FR_OUTQUE
operator|)
condition|)
continue|continue;
name|n
operator|=
literal|0xfffffff
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FRC_MAX
condition|;
name|i
operator|++
control|)
name|m
index|[
name|i
index|]
operator|.
name|e
operator|=
literal|0
expr_stmt|;
name|qsort
argument_list|(
name|m
argument_list|,
name|FRC_MAX
argument_list|,
sizeof|sizeof
argument_list|(
name|mc_t
argument_list|)
argument_list|,
name|intcmp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FRC_MAX
condition|;
name|i
operator|++
control|)
block|{
name|m
index|[
name|i
index|]
operator|.
name|c
operator|=
name|i
expr_stmt|;
name|m
index|[
name|i
index|]
operator|.
name|e
operator|=
literal|0
expr_stmt|;
name|m
index|[
name|i
index|]
operator|.
name|n
operator|=
literal|0
expr_stmt|;
name|m
index|[
name|i
index|]
operator|.
name|s
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|fr
operator|=
name|fr1
operator|->
name|fr_next
init|;
name|fr
condition|;
name|fr
operator|=
name|fr
operator|->
name|fr_next
control|)
block|{
if|if
condition|(
operator|!
name|dir
operator|&&
operator|!
operator|(
name|fr
operator|->
name|fr_flags
operator|&
name|FR_INQUE
operator|)
condition|)
continue|continue;
if|if
condition|(
name|dir
operator|&&
operator|!
operator|(
name|fr
operator|->
name|fr_flags
operator|&
name|FR_OUTQUE
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0001
operator|)
operator|&&
operator|!
name|strcmp
argument_list|(
name|fr1
operator|->
name|fr_names
operator|+
name|fr1
operator|->
name|fr_ifnames
index|[
literal|0
index|]
argument_list|,
name|fr
operator|->
name|fr_names
operator|+
name|fr
operator|->
name|fr_ifnames
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|m
index|[
name|FRC_IFN
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_IFN
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x0001
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0002
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_family
operator|==
name|fr
operator|->
name|fr_family
operator|)
condition|)
block|{
name|m
index|[
name|FRC_V
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_V
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x0002
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0004
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_mip
operator|.
name|fi_flx
operator|==
name|fr
operator|->
name|fr_mip
operator|.
name|fi_flx
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_ip
operator|.
name|fi_flx
operator|==
name|fr
operator|->
name|fr_ip
operator|.
name|fi_flx
operator|)
condition|)
block|{
name|m
index|[
name|FRC_FL
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_FL
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x0004
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0008
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_proto
operator|==
name|fr
operator|->
name|fr_proto
operator|)
condition|)
block|{
name|m
index|[
name|FRC_P
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_P
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x0008
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0010
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_ttl
operator|==
name|fr
operator|->
name|fr_ttl
operator|)
condition|)
block|{
name|m
index|[
name|FRC_TTL
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_TTL
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x0010
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0020
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_tos
operator|==
name|fr
operator|->
name|fr_tos
operator|)
condition|)
block|{
name|m
index|[
name|FRC_TOS
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_TOS
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x0020
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0040
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
operator|(
name|fr1
operator|->
name|fr_tcpfm
operator|==
name|fr
operator|->
name|fr_tcpfm
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_tcpf
operator|==
name|fr
operator|->
name|fr_tcpf
operator|)
operator|)
condition|)
block|{
name|m
index|[
name|FRC_TCP
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_TCP
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x0040
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0080
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
operator|(
name|fr1
operator|->
name|fr_scmp
operator|==
name|fr
operator|->
name|fr_scmp
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_stop
operator|==
name|fr
operator|->
name|fr_stop
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_sport
operator|==
name|fr
operator|->
name|fr_sport
operator|)
operator|)
condition|)
block|{
name|m
index|[
name|FRC_SP
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_SP
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x0080
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0100
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
operator|(
name|fr1
operator|->
name|fr_dcmp
operator|==
name|fr
operator|->
name|fr_dcmp
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_dtop
operator|==
name|fr
operator|->
name|fr_dtop
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_dport
operator|==
name|fr
operator|->
name|fr_dport
operator|)
operator|)
condition|)
block|{
name|m
index|[
name|FRC_DP
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_DP
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x0100
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0200
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
operator|(
name|fr1
operator|->
name|fr_satype
operator|==
name|FRI_LOOKUP
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_satype
operator|==
name|FRI_LOOKUP
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_srcnum
operator|==
name|fr
operator|->
name|fr_srcnum
operator|)
operator|)
condition|)
block|{
name|m
index|[
name|FRC_SRC
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_SRC
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0200
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
operator|(
operator|(
name|fr1
operator|->
name|fr_flags
operator|&
name|FR_NOTSRCIP
operator|)
operator|==
operator|(
name|fr
operator|->
name|fr_flags
operator|&
name|FR_NOTSRCIP
operator|)
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|fr1
operator|->
name|fr_smask
operator|==
name|fr
operator|->
name|fr_smask
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_saddr
operator|==
name|fr
operator|->
name|fr_saddr
operator|)
condition|)
name|m
index|[
name|FRC_SRC
index|]
operator|.
name|e
operator|++
expr_stmt|;
else|else
name|n
operator|&=
operator|~
literal|0x0200
expr_stmt|;
if|if
condition|(
name|fr1
operator|->
name|fr_smask
operator|&&
operator|(
name|fr1
operator|->
name|fr_saddr
operator|&
name|fr1
operator|->
name|fr_smask
operator|)
operator|==
operator|(
name|fr
operator|->
name|fr_saddr
operator|&
name|fr1
operator|->
name|fr_smask
operator|)
condition|)
block|{
name|m
index|[
name|FRC_SRC
index|]
operator|.
name|n
operator|++
expr_stmt|;
name|n
operator||=
literal|0x0200
expr_stmt|;
block|}
block|}
else|else
block|{
name|n
operator|&=
operator|~
literal|0x0200
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0400
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
operator|(
name|fr1
operator|->
name|fr_datype
operator|==
name|FRI_LOOKUP
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_datype
operator|==
name|FRI_LOOKUP
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_dstnum
operator|==
name|fr
operator|->
name|fr_dstnum
operator|)
operator|)
condition|)
block|{
name|m
index|[
name|FRC_DST
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_DST
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0400
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
operator|(
operator|(
name|fr1
operator|->
name|fr_flags
operator|&
name|FR_NOTDSTIP
operator|)
operator|==
operator|(
name|fr
operator|->
name|fr_flags
operator|&
name|FR_NOTDSTIP
operator|)
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|fr1
operator|->
name|fr_dmask
operator|==
name|fr
operator|->
name|fr_dmask
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_daddr
operator|==
name|fr
operator|->
name|fr_daddr
operator|)
condition|)
name|m
index|[
name|FRC_DST
index|]
operator|.
name|e
operator|++
expr_stmt|;
else|else
name|n
operator|&=
operator|~
literal|0x0400
expr_stmt|;
if|if
condition|(
name|fr1
operator|->
name|fr_dmask
operator|&&
operator|(
name|fr1
operator|->
name|fr_daddr
operator|&
name|fr1
operator|->
name|fr_dmask
operator|)
operator|==
operator|(
name|fr
operator|->
name|fr_daddr
operator|&
name|fr1
operator|->
name|fr_dmask
operator|)
condition|)
block|{
name|m
index|[
name|FRC_DST
index|]
operator|.
name|n
operator|++
expr_stmt|;
name|n
operator||=
literal|0x0400
expr_stmt|;
block|}
block|}
else|else
block|{
name|n
operator|&=
operator|~
literal|0x0400
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|n
operator|&
literal|0x0800
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_optmask
operator|==
name|fr
operator|->
name|fr_optmask
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_optbits
operator|==
name|fr
operator|->
name|fr_optbits
operator|)
condition|)
block|{
name|m
index|[
name|FRC_OPT
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_OPT
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x0800
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x1000
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_secmask
operator|==
name|fr
operator|->
name|fr_secmask
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_secbits
operator|==
name|fr
operator|->
name|fr_secbits
operator|)
condition|)
block|{
name|m
index|[
name|FRC_SEC
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_SEC
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x1000
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x10000
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_authmask
operator|==
name|fr
operator|->
name|fr_authmask
operator|)
operator|&&
operator|(
name|fr1
operator|->
name|fr_authbits
operator|==
name|fr
operator|->
name|fr_authbits
operator|)
condition|)
block|{
name|m
index|[
name|FRC_ATH
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_ATH
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x10000
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x20000
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
operator|(
name|fr1
operator|->
name|fr_icmpm
operator|&
literal|0xff00
operator|)
operator|==
operator|(
name|fr
operator|->
name|fr_icmpm
operator|&
literal|0xff00
operator|)
operator|)
operator|&&
operator|(
operator|(
name|fr1
operator|->
name|fr_icmp
operator|&
literal|0xff00
operator|)
operator|==
operator|(
name|fr
operator|->
name|fr_icmp
operator|&
literal|0xff00
operator|)
operator|)
condition|)
block|{
name|m
index|[
name|FRC_ICT
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_ICT
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x20000
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|&
literal|0x40000
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|fr1
operator|->
name|fr_type
operator|)
operator|&&
operator|(
name|fr
operator|->
name|fr_type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
operator|(
name|fr1
operator|->
name|fr_icmpm
operator|&
literal|0xff
operator|)
operator|==
operator|(
name|fr
operator|->
name|fr_icmpm
operator|&
literal|0xff
operator|)
operator|)
operator|&&
operator|(
operator|(
name|fr1
operator|->
name|fr_icmp
operator|&
literal|0xff
operator|)
operator|==
operator|(
name|fr
operator|->
name|fr_icmp
operator|&
literal|0xff
operator|)
operator|)
condition|)
block|{
name|m
index|[
name|FRC_ICC
index|]
operator|.
name|e
operator|++
expr_stmt|;
name|m
index|[
name|FRC_ICC
index|]
operator|.
name|n
operator|++
expr_stmt|;
block|}
else|else
name|n
operator|&=
operator|~
literal|0x40000
expr_stmt|;
block|}
comment|/*msort(m);*/
if|if
condition|(
name|dir
operator|==
literal|0
condition|)
name|emitGroup
argument_list|(
name|rn
argument_list|,
name|dir
argument_list|,
name|m
argument_list|,
name|fr1
argument_list|,
name|group
argument_list|,
name|count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|dir
operator|==
literal|1
condition|)
name|emitGroup
argument_list|(
name|rn
argument_list|,
name|dir
argument_list|,
name|m
argument_list|,
name|fr1
argument_list|,
name|group
argument_list|,
literal|0
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|printhooks
parameter_list|(
name|fp
parameter_list|,
name|in
parameter_list|,
name|out
parameter_list|,
name|grp
parameter_list|)
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|in
decl_stmt|;
name|int
name|out
decl_stmt|;
name|frgroup_t
modifier|*
name|grp
decl_stmt|;
block|{
name|frentry_t
modifier|*
name|fr
decl_stmt|;
name|char
modifier|*
name|group
decl_stmt|;
name|int
name|dogrp
decl_stmt|,
name|i
decl_stmt|;
name|char
modifier|*
name|instr
decl_stmt|;
name|group
operator|=
name|grp
operator|->
name|fg_name
expr_stmt|;
name|dogrp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|in
operator|&&
name|out
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"printhooks called with both in and out set\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|in
condition|)
block|{
name|instr
operator|=
literal|"in"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|out
condition|)
block|{
name|instr
operator|=
literal|"out"
expr_stmt|;
block|}
else|else
block|{
name|instr
operator|=
literal|"???"
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"static frentry_t ipfrule_%s_%s;\n"
argument_list|,
name|instr
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ \n\ int ipfrule_add_%s_%s()\n"
argument_list|,
name|instr
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ {\n\ 	int i, j, err = 0, max;\n\ 	frentry_t *fp;\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dogrp
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ 	frgroup_t *fg;\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|fr
operator|=
name|grp
operator|->
name|fg_start
init|;
name|fr
operator|!=
name|NULL
condition|;
name|i
operator|++
operator|,
name|fr
operator|=
name|fr
operator|->
name|fr_next
control|)
if|if
condition|(
name|fr
operator|->
name|fr_dsize
operator|>
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ 	ipf_rules_%s_%s[%d]->fr_data =&ipf%s_rule_data_%s_%u;\n"
argument_list|,
name|instr
argument_list|,
name|grp
operator|->
name|fg_name
argument_list|,
name|i
argument_list|,
name|instr
argument_list|,
name|grp
operator|->
name|fg_name
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ 	max = sizeof(ipf_rules_%s_%s)/sizeof(frentry_t *);\n\ 	for (i = 0; i< max; i++) {\n\ 		fp = ipf_rules_%s_%s[i];\n\ 		fp->fr_next = NULL;\n"
argument_list|,
name|instr
argument_list|,
name|group
argument_list|,
name|instr
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ 		for (j = i + 1; j< max; j++)\n\ 			if (strncmp(fp->fr_names + fp->fr_group,\n\ 				    ipf_rules_%s_%s[j]->fr_names +\n\ 				    ipf_rules_%s_%s[j]->fr_group,\n\ 				    FR_GROUPLEN) == 0) {\n\ 				if (ipf_rules_%s_%s[j] != NULL)\n\ 					ipf_rules_%s_%s[j]->fr_pnext =\n\&fp->fr_next;\n\ 				fp->fr_pnext =&ipf_rules_%s_%s[j];\n\ 				fp->fr_next = ipf_rules_%s_%s[j];\n\ 				break;\n\ 			}\n"
argument_list|,
name|instr
argument_list|,
name|group
argument_list|,
name|instr
argument_list|,
name|group
argument_list|,
name|instr
argument_list|,
name|group
argument_list|,
name|instr
argument_list|,
name|group
argument_list|,
name|instr
argument_list|,
name|group
argument_list|,
name|instr
argument_list|,
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|dogrp
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ \n\ 		if (fp->fr_grhead != -1) {\n\ 			fg = fr_addgroup(fp->fr_names + fp->fr_grhead,\n\ 					 fp, FR_INQUE, IPL_LOGIPF, 0);\n\ 			if (fg != NULL)\n\ 				fp->fr_grp =&fg->fg_start;\n\ 		}\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ 	}\n\ \n\ 	fp =&ipfrule_%s_%s;\n"
argument_list|,
name|instr
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ 	bzero((char *)fp, sizeof(*fp));\n\ 	fp->fr_type = FR_T_CALLFUNC_BUILTIN;\n\ 	fp->fr_flags = FR_%sQUE|FR_NOMATCH;\n\ 	fp->fr_data = (void *)ipf_rules_%s_%s[0];\n"
argument_list|,
operator|(
name|in
operator|!=
literal|0
operator|)
condition|?
literal|"IN"
else|:
literal|"OUT"
argument_list|,
name|instr
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ 	fp->fr_dsize = sizeof(ipf_rules_%s_%s[0]);\n"
argument_list|,
name|instr
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ 	fp->fr_family = AF_INET;\n\ 	fp->fr_func = (ipfunc_t)ipfrule_match_%s_%s;\n\ 	err = frrequest(&ipfmain, IPL_LOGIPF, SIOCADDFR, (caddr_t)fp,\n\ 			ipfmain.ipf_active, 0);\n"
argument_list|,
name|instr
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\treturn err;\n}\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n\n\ int ipfrule_remove_%s_%s()\n"
argument_list|,
name|instr
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ {\n\ 	int err = 0, i;\n\ 	frentry_t *fp;\n\ \n\ 	/*\n\ 	 * Try to remove the %sbound rule.\n"
argument_list|,
name|instr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ 	 */\n\ 	if (ipfrule_%s_%s.fr_ref> 0) {\n"
argument_list|,
name|instr
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ 		err = EBUSY;\n\ 	} else {\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ 		i = sizeof(ipf_rules_%s_%s)/sizeof(frentry_t *) - 1;\n\ 		for (; i>= 0; i--) {\n\ 			fp = ipf_rules_%s_%s[i];\n\ 			if (fp->fr_ref> 1) {\n\ 				err = EBUSY;\n\ 				break;\n\ 			}\n\ 		}\n\ 	}\n\ 	if (err == 0)\n\ 		err = frrequest(&ipfmain, IPL_LOGIPF, SIOCDELFR,\n\ 				(caddr_t)&ipfrule_%s_%s,\n\ 				ipfmain.ipf_active, 0);\n"
argument_list|,
name|instr
argument_list|,
name|group
argument_list|,
name|instr
argument_list|,
name|group
argument_list|,
name|instr
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\ 	if (err)\n\ 		return err;\n\ \n\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\treturn err;\n}\n"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


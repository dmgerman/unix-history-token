begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/*  * Copyright (C) 2012 by Darren Reed.  *  * See the IPFILTER.LICENCE file for details on licencing.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|__FreeBSD_cc_version
end_ifndef

begin_include
include|#
directive|include
file|<osreldate.h>
end_include

begin_else
else|#
directive|else
end_else

begin_if
if|#
directive|if
name|__FreeBSD_cc_version
operator|<
literal|430000
end_if

begin_include
include|#
directive|include
file|<osreldate.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|linux
end_ifdef

begin_include
include|#
directive|include
file|<linux/a.out.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|sun
argument_list|)
operator|&&
operator|(
name|defined
argument_list|(
name|__svr4__
argument_list|)
operator|||
name|defined
argument_list|(
name|__SVR4
argument_list|)
operator|)
end_if

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"ipf.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ipl.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|STATETOP
argument_list|)
end_if

begin_if
if|#
directive|if
name|defined
argument_list|(
name|_BSDI_VERSION
argument_list|)
end_if

begin_undef
undef|#
directive|undef
name|STATETOP
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
expr|\
operator|(
operator|!
name|defined
argument_list|(
name|__FreeBSD_version
argument_list|)
operator|||
operator|(
name|__FreeBSD_version
operator|<
literal|430000
operator|)
operator|)
end_if

begin_undef
undef|#
directive|undef
name|STATETOP
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD_Version__
argument_list|)
operator|&&
operator|(
name|__NetBSD_Version__
operator|<
literal|105000000
operator|)
end_if

begin_undef
undef|#
directive|undef
name|STATETOP
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|sun
argument_list|)
end_if

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__svr4__
argument_list|)
operator|||
name|defined
argument_list|(
name|__SVR4
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/select.h>
end_include

begin_else
else|#
directive|else
end_else

begin_undef
undef|#
directive|undef
name|STATETOP
end_undef

begin_comment
comment|/* NOT supported on SunOS4 */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|STATETOP
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|linux
argument_list|)
end_if

begin_include
include|#
directive|include
file|<netinet/ip_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp_fsm.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|STATETOP
end_ifdef

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_if
if|#
directive|if
name|SOLARIS
operator|||
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|_BSDI_VERSION
argument_list|)
operator|||
expr|\
name|defined
argument_list|(
name|__sgi
argument_list|)
end_if

begin_ifdef
ifdef|#
directive|ifdef
name|ERR
end_ifdef

begin_undef
undef|#
directive|undef
name|ERR
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<curses.h>
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* SOLARIS */
end_comment

begin_include
include|#
directive|include
file|<ncurses.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SOLARIS */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* STATETOP */
end_comment

begin_include
include|#
directive|include
file|"kmem.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
operator|(
name|__OpenBSD__
operator|)
end_if

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
end_if

begin_decl_stmt
specifier|static
specifier|const
name|char
name|sccsid
index|[]
init|=
literal|"@(#)fils.c	1.21 4/20/96 (C) 1993-2000 Darren Reed"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#)$Id$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__hpux
end_ifdef

begin_define
define|#
directive|define
name|nlist
value|nlist64
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|optind
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|opterr
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PRINTF
value|(void)printf
end_define

begin_define
define|#
directive|define
name|FPRINTF
value|(void)fprintf
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|filters
index|[
literal|4
index|]
init|=
block|{
literal|"ipfilter(in)"
block|,
literal|"ipfilter(out)"
block|,
literal|"ipacct(in)"
block|,
literal|"ipacct(out)"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|state_logging
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|wordtab_t
modifier|*
name|state_fields
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nohdrfields
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|opts
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|use_inet6
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|live_kernel
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|state_fd
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ipf_fd
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|auth_fd
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nat_fd
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|frgroup_t
modifier|*
name|grtop
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|frgroup_t
modifier|*
name|grtail
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|blockreasons
index|[
name|FRB_MAX_VALUE
operator|+
literal|1
index|]
init|=
block|{
literal|"packet blocked"
block|,
literal|"log rule failure"
block|,
literal|"pps rate exceeded"
block|,
literal|"jumbogram"
block|,
literal|"makefrip failed"
block|,
literal|"cannot add state"
block|,
literal|"IP ID update failed"
block|,
literal|"log-or-block failed"
block|,
literal|"decapsulate failure"
block|,
literal|"cannot create new auth entry"
block|,
literal|"packet queued for auth"
block|,
literal|"buffer coalesce failure"
block|,
literal|"buffer pullup failure"
block|,
literal|"auth feedback"
block|,
literal|"bad fragment"
block|,
literal|"IPv4 NAT failure"
block|,
literal|"IPv6 NAT failure"
block|}
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|STATETOP
end_ifdef

begin_define
define|#
directive|define
name|STSTRSIZE
value|80
end_define

begin_define
define|#
directive|define
name|STGROWSIZE
value|16
end_define

begin_define
define|#
directive|define
name|HOSTNMLEN
value|40
end_define

begin_define
define|#
directive|define
name|STSORT_PR
value|0
end_define

begin_define
define|#
directive|define
name|STSORT_PKTS
value|1
end_define

begin_define
define|#
directive|define
name|STSORT_BYTES
value|2
end_define

begin_define
define|#
directive|define
name|STSORT_TTL
value|3
end_define

begin_define
define|#
directive|define
name|STSORT_SRCIP
value|4
end_define

begin_define
define|#
directive|define
name|STSORT_SRCPT
value|5
end_define

begin_define
define|#
directive|define
name|STSORT_DSTIP
value|6
end_define

begin_define
define|#
directive|define
name|STSORT_DSTPT
value|7
end_define

begin_define
define|#
directive|define
name|STSORT_MAX
value|STSORT_DSTPT
end_define

begin_define
define|#
directive|define
name|STSORT_DEFAULT
value|STSORT_BYTES
end_define

begin_typedef
typedef|typedef
struct|struct
name|statetop
block|{
name|i6addr_t
name|st_src
decl_stmt|;
name|i6addr_t
name|st_dst
decl_stmt|;
name|u_short
name|st_sport
decl_stmt|;
name|u_short
name|st_dport
decl_stmt|;
name|u_char
name|st_p
decl_stmt|;
name|u_char
name|st_v
decl_stmt|;
name|u_char
name|st_state
index|[
literal|2
index|]
decl_stmt|;
name|U_QUAD_T
name|st_pkts
decl_stmt|;
name|U_QUAD_T
name|st_bytes
decl_stmt|;
name|u_long
name|st_age
decl_stmt|;
block|}
name|statetop_t
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|int
decl|main
name|__P
argument_list|(
operator|(
name|int
operator|,
name|char
operator|*
index|[]
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|fetchfrag
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|,
name|ipfr_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showstats
name|__P
argument_list|(
operator|(
name|friostat_t
operator|*
operator|,
name|u_32_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showfrstates
name|__P
argument_list|(
operator|(
name|ipfrstat_t
operator|*
operator|,
name|u_long
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showlist
name|__P
argument_list|(
operator|(
name|friostat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showstatestats
name|__P
argument_list|(
operator|(
name|ips_stat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showipstates
name|__P
argument_list|(
operator|(
name|ips_stat_t
operator|*
operator|,
name|int
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showauthstates
name|__P
argument_list|(
operator|(
name|ipf_authstat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showtqtable_live
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|showgroups
name|__P
argument_list|(
operator|(
name|friostat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|usage
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|state_matcharray
name|__P
argument_list|(
operator|(
name|ipstate_t
operator|*
operator|,
name|int
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|printlivelist
name|__P
argument_list|(
operator|(
name|friostat_t
operator|*
operator|,
name|int
operator|,
name|int
operator|,
name|frentry_t
operator|*
operator|,
name|char
operator|*
operator|,
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|printdeadlist
name|__P
argument_list|(
operator|(
name|friostat_t
operator|*
operator|,
name|int
operator|,
name|int
operator|,
name|frentry_t
operator|*
operator|,
name|char
operator|*
operator|,
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|printside
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|ipf_statistics_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|parse_ipportstr
name|__P
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|,
name|i6addr_t
operator|*
operator|,
name|int
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ipfstate_live
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|friostat_t
operator|*
operator|*
operator|,
name|ips_stat_t
operator|*
operator|*
operator|,
name|ipfrstat_t
operator|*
operator|*
operator|,
name|ipf_authstat_t
operator|*
operator|*
operator|,
name|u_32_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ipfstate_dead
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|friostat_t
operator|*
operator|*
operator|,
name|ips_stat_t
operator|*
operator|*
operator|,
name|ipfrstat_t
operator|*
operator|*
operator|,
name|ipf_authstat_t
operator|*
operator|*
operator|,
name|u_32_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ipstate_t
modifier|*
name|fetchstate
name|__P
argument_list|(
operator|(
name|ipstate_t
operator|*
operator|,
name|ipstate_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|STATETOP
end_ifdef

begin_decl_stmt
specifier|static
name|void
name|topipstates
name|__P
argument_list|(
operator|(
name|i6addr_t
operator|,
name|i6addr_t
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|sig_break
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|sig_resize
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|getip
name|__P
argument_list|(
operator|(
name|int
operator|,
name|i6addr_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ttl_to_string
name|__P
argument_list|(
operator|(
name|long
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sort_p
name|__P
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|,
specifier|const
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sort_pkts
name|__P
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|,
specifier|const
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sort_bytes
name|__P
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|,
specifier|const
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sort_ttl
name|__P
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|,
specifier|const
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sort_srcip
name|__P
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|,
specifier|const
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sort_srcpt
name|__P
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|,
specifier|const
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sort_dstip
name|__P
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|,
specifier|const
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sort_dstpt
name|__P
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|,
specifier|const
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|USE_INET6
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-6aAdfghIilnoRsv]\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-aAdfghIilnoRsv]\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       %s [-M corefile] [-N symbol-list]\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_INET6
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       %s -t [-6C] "
argument_list|,
name|name
argument_list|)
expr_stmt|;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       %s -t [-C] "
argument_list|,
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"[-D destination address] [-P protocol] [-S source address] [-T refresh time]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|ipf_authstat_t
name|frauthst
decl_stmt|;
name|ipf_authstat_t
modifier|*
name|frauthstp
init|=
operator|&
name|frauthst
decl_stmt|;
name|friostat_t
name|fio
decl_stmt|;
name|friostat_t
modifier|*
name|fiop
init|=
operator|&
name|fio
decl_stmt|;
name|ips_stat_t
name|ipsst
decl_stmt|;
name|ips_stat_t
modifier|*
name|ipsstp
init|=
operator|&
name|ipsst
decl_stmt|;
name|ipfrstat_t
name|ifrst
decl_stmt|;
name|ipfrstat_t
modifier|*
name|ifrstp
init|=
operator|&
name|ifrst
decl_stmt|;
name|char
modifier|*
name|options
decl_stmt|;
name|char
modifier|*
name|kern
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|memf
init|=
name|NULL
decl_stmt|;
name|int
name|c
decl_stmt|;
name|int
name|myoptind
decl_stmt|;
name|int
modifier|*
name|filter
init|=
name|NULL
decl_stmt|;
name|int
name|protocol
init|=
operator|-
literal|1
decl_stmt|;
comment|/* -1 = wild card for any protocol */
name|int
name|refreshtime
init|=
literal|1
decl_stmt|;
comment|/* default update time */
name|int
name|sport
init|=
operator|-
literal|1
decl_stmt|;
comment|/* -1 = wild card for any source port */
name|int
name|dport
init|=
operator|-
literal|1
decl_stmt|;
comment|/* -1 = wild card for any dest port */
name|int
name|topclosed
init|=
literal|0
decl_stmt|;
comment|/* do not show closed tcp sessions */
name|i6addr_t
name|saddr
decl_stmt|,
name|daddr
decl_stmt|;
name|u_32_t
name|frf
decl_stmt|;
ifdef|#
directive|ifdef
name|USE_INET6
name|options
operator|=
literal|"6aACdfghIilnostvD:m:M:N:O:P:RS:T:"
expr_stmt|;
else|#
directive|else
name|options
operator|=
literal|"aACdfghIilnostvD:m:M:N:O:P:RS:T:"
expr_stmt|;
endif|#
directive|endif
name|saddr
operator|.
name|in4
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
comment|/* default any v4 source addr */
name|daddr
operator|.
name|in4
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
comment|/* default any v4 dest addr */
ifdef|#
directive|ifdef
name|USE_INET6
name|saddr
operator|.
name|in6
operator|=
name|in6addr_any
expr_stmt|;
comment|/* default any v6 source addr */
name|daddr
operator|.
name|in6
operator|=
name|in6addr_any
expr_stmt|;
comment|/* default any v6 dest addr */
endif|#
directive|endif
comment|/* Don't warn about invalid flags when we run getopt for the 1st time */
name|opterr
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Parse these two arguments now lest there be any buffer overflows 	 * in the parsing of the rest. 	 */
name|myoptind
operator|=
name|optind
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|options
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'M'
case|:
name|memf
operator|=
name|optarg
expr_stmt|;
name|live_kernel
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
name|kern
operator|=
name|optarg
expr_stmt|;
name|live_kernel
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
name|optind
operator|=
name|myoptind
expr_stmt|;
if|if
condition|(
name|live_kernel
operator|==
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|state_fd
operator|=
name|open
argument_list|(
name|IPSTATE_NAME
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"open(IPSTATE_NAME)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|auth_fd
operator|=
name|open
argument_list|(
name|IPAUTH_NAME
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"open(IPAUTH_NAME)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|nat_fd
operator|=
name|open
argument_list|(
name|IPNAT_NAME
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"open(IPAUTH_NAME)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ipf_fd
operator|=
name|open
argument_list|(
name|IPL_NAME
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"open(%s)"
argument_list|,
name|IPL_NAME
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|kern
operator|!=
name|NULL
operator|||
name|memf
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|setgid
argument_list|(
name|getgid
argument_list|()
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|live_kernel
operator|==
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|checkrev
argument_list|(
name|IPL_NAME
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|openkmem
argument_list|(
name|kern
argument_list|,
name|memf
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|setgid
argument_list|(
name|getgid
argument_list|()
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
name|opterr
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|options
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
ifdef|#
directive|ifdef
name|USE_INET6
case|case
literal|'6'
case|:
name|use_inet6
operator|=
literal|1
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
literal|'a'
case|:
name|opts
operator||=
name|OPT_ACCNT
operator||
name|OPT_SHOWLIST
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
name|opts
operator||=
name|OPT_AUTHSTATS
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|topclosed
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|opts
operator||=
name|OPT_DEBUG
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|parse_ipportstr
argument_list|(
name|optarg
argument_list|,
operator|&
name|daddr
argument_list|,
operator|&
name|dport
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|opts
operator||=
name|OPT_FRSTATES
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|opts
operator||=
name|OPT_GROUPS
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|opts
operator||=
name|OPT_HITS
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|opts
operator||=
name|OPT_INQUE
operator||
name|OPT_SHOWLIST
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|opts
operator||=
name|OPT_INACTIVE
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|opts
operator||=
name|OPT_SHOWLIST
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|filter
operator|=
name|parseipfexpr
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|filter
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error parseing '%s'\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'M'
case|:
break|break;
case|case
literal|'N'
case|:
break|break;
case|case
literal|'n'
case|:
name|opts
operator||=
name|OPT_SHOWLINENO
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|opts
operator||=
name|OPT_OUTQUE
operator||
name|OPT_SHOWLIST
expr_stmt|;
break|break;
case|case
literal|'O'
case|:
name|state_fields
operator|=
name|parsefields
argument_list|(
name|statefields
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|protocol
operator|=
name|getproto
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|protocol
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Invalid protocol: %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'R'
case|:
name|opts
operator||=
name|OPT_NORESOLVE
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|opts
operator||=
name|OPT_IPSTATES
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|parse_ipportstr
argument_list|(
name|optarg
argument_list|,
operator|&
name|saddr
argument_list|,
operator|&
name|sport
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
ifdef|#
directive|ifdef
name|STATETOP
name|opts
operator||=
name|OPT_STATETOP
expr_stmt|;
break|break;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: state top facility not compiled in\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|2
argument_list|)
expr_stmt|;
endif|#
directive|endif
case|case
literal|'T'
case|:
if|if
condition|(
operator|!
name|sscanf
argument_list|(
name|optarg
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|refreshtime
argument_list|)
operator|||
operator|(
name|refreshtime
operator|<=
literal|0
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Invalid refreshtime< 1 : %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'v'
case|:
name|opts
operator||=
name|OPT_VERBOSE
expr_stmt|;
break|break;
default|default :
name|usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|live_kernel
operator|==
literal|1
condition|)
block|{
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fio
argument_list|,
sizeof|sizeof
argument_list|(
name|fio
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ipsst
argument_list|,
sizeof|sizeof
argument_list|(
name|ipsst
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ifrst
argument_list|,
sizeof|sizeof
argument_list|(
name|ifrst
argument_list|)
argument_list|)
expr_stmt|;
name|ipfstate_live
argument_list|(
name|IPL_NAME
argument_list|,
operator|&
name|fiop
argument_list|,
operator|&
name|ipsstp
argument_list|,
operator|&
name|ifrstp
argument_list|,
operator|&
name|frauthstp
argument_list|,
operator|&
name|frf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ipfstate_dead
argument_list|(
name|kern
argument_list|,
operator|&
name|fiop
argument_list|,
operator|&
name|ipsstp
argument_list|,
operator|&
name|ifrstp
argument_list|,
operator|&
name|frauthstp
argument_list|,
operator|&
name|frf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opts
operator|&
name|OPT_IPSTATES
condition|)
block|{
name|showipstates
argument_list|(
name|ipsstp
argument_list|,
name|filter
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_SHOWLIST
condition|)
block|{
name|showlist
argument_list|(
name|fiop
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_OUTQUE
operator|)
operator|&&
operator|(
name|opts
operator|&
name|OPT_INQUE
operator|)
condition|)
block|{
name|opts
operator|&=
operator|~
name|OPT_OUTQUE
expr_stmt|;
name|showlist
argument_list|(
name|fiop
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_FRSTATES
condition|)
name|showfrstates
argument_list|(
name|ifrstp
argument_list|,
name|fiop
operator|->
name|f_ticks
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|STATETOP
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_STATETOP
condition|)
name|topipstates
argument_list|(
name|saddr
argument_list|,
name|daddr
argument_list|,
name|sport
argument_list|,
name|dport
argument_list|,
name|protocol
argument_list|,
name|use_inet6
condition|?
literal|6
else|:
literal|4
argument_list|,
name|refreshtime
argument_list|,
name|topclosed
argument_list|,
name|filter
argument_list|)
expr_stmt|;
endif|#
directive|endif
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_AUTHSTATS
condition|)
name|showauthstates
argument_list|(
name|frauthstp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_GROUPS
condition|)
name|showgroups
argument_list|(
name|fiop
argument_list|)
expr_stmt|;
else|else
name|showstats
argument_list|(
name|fiop
argument_list|,
name|frf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Fill in the stats structures from the live kernel, using a combination  * of ioctl's and copying directly from kernel memory.  */
end_comment

begin_function
specifier|static
name|void
name|ipfstate_live
parameter_list|(
name|device
parameter_list|,
name|fiopp
parameter_list|,
name|ipsstpp
parameter_list|,
name|ifrstpp
parameter_list|,
name|frauthstpp
parameter_list|,
name|frfp
parameter_list|)
name|char
modifier|*
name|device
decl_stmt|;
name|friostat_t
modifier|*
modifier|*
name|fiopp
decl_stmt|;
name|ips_stat_t
modifier|*
modifier|*
name|ipsstpp
decl_stmt|;
name|ipfrstat_t
modifier|*
modifier|*
name|ifrstpp
decl_stmt|;
name|ipf_authstat_t
modifier|*
modifier|*
name|frauthstpp
decl_stmt|;
name|u_32_t
modifier|*
name|frfp
decl_stmt|;
block|{
name|ipfobj_t
name|ipfo
decl_stmt|;
if|if
condition|(
name|checkrev
argument_list|(
name|device
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"User/kernel version check failed\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_AUTHSTATS
operator|)
operator|==
literal|0
condition|)
block|{
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|ipfo
argument_list|,
sizeof|sizeof
argument_list|(
name|ipfo
argument_list|)
argument_list|)
expr_stmt|;
name|ipfo
operator|.
name|ipfo_rev
operator|=
name|IPFILTER_VERSION
expr_stmt|;
name|ipfo
operator|.
name|ipfo_type
operator|=
name|IPFOBJ_IPFSTAT
expr_stmt|;
name|ipfo
operator|.
name|ipfo_size
operator|=
sizeof|sizeof
argument_list|(
name|friostat_t
argument_list|)
expr_stmt|;
name|ipfo
operator|.
name|ipfo_ptr
operator|=
operator|(
name|void
operator|*
operator|)
operator|*
name|fiopp
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|ipf_fd
argument_list|,
name|SIOCGETFS
argument_list|,
operator|&
name|ipfo
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ipferror
argument_list|(
name|ipf_fd
argument_list|,
literal|"ioctl(ipf:SIOCGETFS)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|ipf_fd
argument_list|,
name|SIOCGETFF
argument_list|,
name|frfp
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|ipferror
argument_list|(
name|ipf_fd
argument_list|,
literal|"ioctl(SIOCGETFF)"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_IPSTATES
operator|)
operator|!=
literal|0
condition|)
block|{
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|ipfo
argument_list|,
sizeof|sizeof
argument_list|(
name|ipfo
argument_list|)
argument_list|)
expr_stmt|;
name|ipfo
operator|.
name|ipfo_rev
operator|=
name|IPFILTER_VERSION
expr_stmt|;
name|ipfo
operator|.
name|ipfo_type
operator|=
name|IPFOBJ_STATESTAT
expr_stmt|;
name|ipfo
operator|.
name|ipfo_size
operator|=
sizeof|sizeof
argument_list|(
name|ips_stat_t
argument_list|)
expr_stmt|;
name|ipfo
operator|.
name|ipfo_ptr
operator|=
operator|(
name|void
operator|*
operator|)
operator|*
name|ipsstpp
expr_stmt|;
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|state_fd
argument_list|,
name|SIOCGETFS
argument_list|,
operator|&
name|ipfo
argument_list|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|ipferror
argument_list|(
name|state_fd
argument_list|,
literal|"ioctl(state:SIOCGETFS)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|state_fd
argument_list|,
name|SIOCGETLG
argument_list|,
operator|&
name|state_logging
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ipferror
argument_list|(
name|state_fd
argument_list|,
literal|"ioctl(state:SIOCGETLG)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_FRSTATES
operator|)
operator|!=
literal|0
condition|)
block|{
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|ipfo
argument_list|,
sizeof|sizeof
argument_list|(
name|ipfo
argument_list|)
argument_list|)
expr_stmt|;
name|ipfo
operator|.
name|ipfo_rev
operator|=
name|IPFILTER_VERSION
expr_stmt|;
name|ipfo
operator|.
name|ipfo_type
operator|=
name|IPFOBJ_FRAGSTAT
expr_stmt|;
name|ipfo
operator|.
name|ipfo_size
operator|=
sizeof|sizeof
argument_list|(
name|ipfrstat_t
argument_list|)
expr_stmt|;
name|ipfo
operator|.
name|ipfo_ptr
operator|=
operator|(
name|void
operator|*
operator|)
operator|*
name|ifrstpp
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|ipf_fd
argument_list|,
name|SIOCGFRST
argument_list|,
operator|&
name|ipfo
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ipferror
argument_list|(
name|ipf_fd
argument_list|,
literal|"ioctl(SIOCGFRST)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
name|PRINTF
argument_list|(
literal|"opts %#x name %s\n"
argument_list|,
name|opts
argument_list|,
name|device
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_AUTHSTATS
operator|)
operator|!=
literal|0
condition|)
block|{
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|ipfo
argument_list|,
sizeof|sizeof
argument_list|(
name|ipfo
argument_list|)
argument_list|)
expr_stmt|;
name|ipfo
operator|.
name|ipfo_rev
operator|=
name|IPFILTER_VERSION
expr_stmt|;
name|ipfo
operator|.
name|ipfo_type
operator|=
name|IPFOBJ_AUTHSTAT
expr_stmt|;
name|ipfo
operator|.
name|ipfo_size
operator|=
sizeof|sizeof
argument_list|(
name|ipf_authstat_t
argument_list|)
expr_stmt|;
name|ipfo
operator|.
name|ipfo_ptr
operator|=
operator|(
name|void
operator|*
operator|)
operator|*
name|frauthstpp
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|auth_fd
argument_list|,
name|SIOCATHST
argument_list|,
operator|&
name|ipfo
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ipferror
argument_list|(
name|auth_fd
argument_list|,
literal|"ioctl(SIOCATHST)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Build up the stats structures from data held in the "core" memory.  * This is mainly useful when looking at data in crash dumps and ioctl's  * just won't work any more.  */
end_comment

begin_function
specifier|static
name|void
name|ipfstate_dead
parameter_list|(
name|kernel
parameter_list|,
name|fiopp
parameter_list|,
name|ipsstpp
parameter_list|,
name|ifrstpp
parameter_list|,
name|frauthstpp
parameter_list|,
name|frfp
parameter_list|)
name|char
modifier|*
name|kernel
decl_stmt|;
name|friostat_t
modifier|*
modifier|*
name|fiopp
decl_stmt|;
name|ips_stat_t
modifier|*
modifier|*
name|ipsstpp
decl_stmt|;
name|ipfrstat_t
modifier|*
modifier|*
name|ifrstpp
decl_stmt|;
name|ipf_authstat_t
modifier|*
modifier|*
name|frauthstpp
decl_stmt|;
name|u_32_t
modifier|*
name|frfp
decl_stmt|;
block|{
specifier|static
name|ipf_authstat_t
name|frauthst
decl_stmt|,
modifier|*
name|frauthstp
decl_stmt|;
specifier|static
name|ipftq_t
name|ipstcptab
index|[
name|IPF_TCP_NSTATES
index|]
decl_stmt|;
specifier|static
name|ips_stat_t
name|ipsst
decl_stmt|,
modifier|*
name|ipsstp
decl_stmt|;
specifier|static
name|ipfrstat_t
name|ifrst
decl_stmt|,
modifier|*
name|ifrstp
decl_stmt|;
specifier|static
name|friostat_t
name|fio
decl_stmt|,
modifier|*
name|fiop
decl_stmt|;
name|int
name|temp
decl_stmt|;
name|void
modifier|*
name|rules
index|[
literal|2
index|]
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|nlist
name|deadlist
index|[
literal|44
index|]
init|=
block|{
block|{
literal|"ipf_auth_stats"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* 0 */
block|{
literal|"fae_list"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipauth"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_auth_list"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_auth_start"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_auth_end"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* 5 */
block|{
literal|"ipf_auth_next"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_auth"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_auth_used"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_auth_size"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_auth_defaultage"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* 10 */
block|{
literal|"ipf_auth_pkts"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_auth_lock"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"frstats"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ips_stats"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ips_num"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* 15 */
block|{
literal|"ips_wild"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ips_list"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ips_table"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_state_max"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_state_size"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* 20 */
block|{
literal|"ipf_state_doflush"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_state_lock"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipfr_heads"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipfr_nattab"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipfr_stats"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* 25 */
block|{
literal|"ipfr_inuse"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_ipfrttl"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_frag_lock"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipfr_timer_id"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_nat_lock"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* 30 */
block|{
literal|"ipf_rules"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_acct"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipl_frouteok"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_running"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_groups"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* 35 */
block|{
literal|"ipf_active"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_pass"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_flags"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ipf_state_logging"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"ips_tqtqb"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* 40 */
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|frauthstp
operator|=
operator|&
name|frauthst
expr_stmt|;
name|ipsstp
operator|=
operator|&
name|ipsst
expr_stmt|;
name|ifrstp
operator|=
operator|&
name|ifrst
expr_stmt|;
name|fiop
operator|=
operator|&
name|fio
expr_stmt|;
operator|*
name|frfp
operator|=
literal|0
expr_stmt|;
operator|*
name|fiopp
operator|=
name|fiop
expr_stmt|;
operator|*
name|ipsstpp
operator|=
name|ipsstp
expr_stmt|;
operator|*
name|ifrstpp
operator|=
name|ifrstp
expr_stmt|;
operator|*
name|frauthstpp
operator|=
name|frauthstp
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fiop
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fiop
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ipsstp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ipsstp
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ifrstp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ifrstp
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|frauthstp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|frauthstp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nlist
argument_list|(
name|kernel
argument_list|,
name|deadlist
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"nlist error\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * This is for SIOCGETFF. 	 */
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|frfp
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|40
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|frfp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * f_locks is a combination of the lock variable from each part of 	 * ipfilter (state, auth, nat, fragments). 	 */
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fiop
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|13
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fiop
argument_list|)
argument_list|)
expr_stmt|;
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fiop
operator|->
name|f_locks
index|[
literal|0
index|]
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|22
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|fiop
operator|->
name|f_locks
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fiop
operator|->
name|f_locks
index|[
literal|0
index|]
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|30
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|fiop
operator|->
name|f_locks
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fiop
operator|->
name|f_locks
index|[
literal|2
index|]
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|28
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|fiop
operator|->
name|f_locks
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fiop
operator|->
name|f_locks
index|[
literal|3
index|]
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|12
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|fiop
operator|->
name|f_locks
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Get pointers to each list of rules (active, inactive, in, out) 	 */
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|rules
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|31
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|rules
argument_list|)
argument_list|)
expr_stmt|;
name|fiop
operator|->
name|f_fin
index|[
literal|0
index|]
operator|=
name|rules
index|[
literal|0
index|]
index|[
literal|0
index|]
expr_stmt|;
name|fiop
operator|->
name|f_fin
index|[
literal|1
index|]
operator|=
name|rules
index|[
literal|0
index|]
index|[
literal|1
index|]
expr_stmt|;
name|fiop
operator|->
name|f_fout
index|[
literal|0
index|]
operator|=
name|rules
index|[
literal|1
index|]
index|[
literal|0
index|]
expr_stmt|;
name|fiop
operator|->
name|f_fout
index|[
literal|1
index|]
operator|=
name|rules
index|[
literal|1
index|]
index|[
literal|1
index|]
expr_stmt|;
comment|/* 	 * Now get accounting rules pointers. 	 */
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|rules
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|33
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|rules
argument_list|)
argument_list|)
expr_stmt|;
name|fiop
operator|->
name|f_acctin
index|[
literal|0
index|]
operator|=
name|rules
index|[
literal|0
index|]
index|[
literal|0
index|]
expr_stmt|;
name|fiop
operator|->
name|f_acctin
index|[
literal|1
index|]
operator|=
name|rules
index|[
literal|0
index|]
index|[
literal|1
index|]
expr_stmt|;
name|fiop
operator|->
name|f_acctout
index|[
literal|0
index|]
operator|=
name|rules
index|[
literal|1
index|]
index|[
literal|0
index|]
expr_stmt|;
name|fiop
operator|->
name|f_acctout
index|[
literal|1
index|]
operator|=
name|rules
index|[
literal|1
index|]
index|[
literal|1
index|]
expr_stmt|;
comment|/* 	 * A collection of "global" variables used inside the kernel which 	 * are all collected in friostat_t via ioctl. 	 */
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fiop
operator|->
name|f_froute
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|33
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|fiop
operator|->
name|f_froute
argument_list|)
argument_list|)
expr_stmt|;
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fiop
operator|->
name|f_running
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|34
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|fiop
operator|->
name|f_running
argument_list|)
argument_list|)
expr_stmt|;
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fiop
operator|->
name|f_groups
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|35
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|fiop
operator|->
name|f_groups
argument_list|)
argument_list|)
expr_stmt|;
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fiop
operator|->
name|f_active
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|36
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|fiop
operator|->
name|f_active
argument_list|)
argument_list|)
expr_stmt|;
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fiop
operator|->
name|f_defpass
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|37
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|fiop
operator|->
name|f_defpass
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Build up the state information stats structure. 	 */
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ipsstp
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|14
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ipsstp
argument_list|)
argument_list|)
expr_stmt|;
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|temp
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|15
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|temp
argument_list|)
argument_list|)
expr_stmt|;
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ipstcptab
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|40
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|ipstcptab
argument_list|)
argument_list|)
expr_stmt|;
name|ipsstp
operator|->
name|iss_active
operator|=
name|temp
expr_stmt|;
name|ipsstp
operator|->
name|iss_table
operator|=
operator|(
name|void
operator|*
operator|)
name|deadlist
index|[
literal|18
index|]
operator|.
name|n_value
expr_stmt|;
name|ipsstp
operator|->
name|iss_list
operator|=
operator|(
name|void
operator|*
operator|)
name|deadlist
index|[
literal|17
index|]
operator|.
name|n_value
expr_stmt|;
name|ipsstp
operator|->
name|iss_tcptab
operator|=
name|ipstcptab
expr_stmt|;
comment|/* 	 * Build up the authentiation information stats structure. 	 */
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|frauthstp
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|0
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|frauthstp
argument_list|)
argument_list|)
expr_stmt|;
name|frauthstp
operator|->
name|fas_faelist
operator|=
operator|(
name|void
operator|*
operator|)
name|deadlist
index|[
literal|1
index|]
operator|.
name|n_value
expr_stmt|;
comment|/* 	 * Build up the fragment information stats structure. 	 */
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ifrstp
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|25
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ifrstp
argument_list|)
argument_list|)
expr_stmt|;
name|ifrstp
operator|->
name|ifs_table
operator|=
operator|(
name|void
operator|*
operator|)
name|deadlist
index|[
literal|23
index|]
operator|.
name|n_value
expr_stmt|;
name|ifrstp
operator|->
name|ifs_nattab
operator|=
operator|(
name|void
operator|*
operator|)
name|deadlist
index|[
literal|24
index|]
operator|.
name|n_value
expr_stmt|;
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ifrstp
operator|->
name|ifs_inuse
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|26
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|ifrstp
operator|->
name|ifs_inuse
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Get logging on/off switches 	 */
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|state_logging
argument_list|,
operator|(
name|u_long
operator|)
name|deadlist
index|[
literal|41
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|state_logging
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|printside
parameter_list|(
name|side
parameter_list|,
name|frs
parameter_list|)
name|char
modifier|*
name|side
decl_stmt|;
name|ipf_statistics_t
modifier|*
name|frs
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s bad packets\n"
argument_list|,
name|frs
operator|->
name|fr_bad
argument_list|,
name|side
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_INET6
name|PRINTF
argument_list|(
literal|"%lu\t%s IPv6 packets\n"
argument_list|,
name|frs
operator|->
name|fr_ipv6
argument_list|,
name|side
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|PRINTF
argument_list|(
literal|"%lu\t%s packets blocked\n"
argument_list|,
name|frs
operator|->
name|fr_block
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s packets passed\n"
argument_list|,
name|frs
operator|->
name|fr_pass
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s packets not matched\n"
argument_list|,
name|frs
operator|->
name|fr_nom
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s packets counted\n"
argument_list|,
name|frs
operator|->
name|fr_acct
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s packets short\n"
argument_list|,
name|frs
operator|->
name|fr_short
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s packets logged and blocked\n"
argument_list|,
name|frs
operator|->
name|fr_bpkl
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s packets logged and passed\n"
argument_list|,
name|frs
operator|->
name|fr_ppkl
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s fragment state kept\n"
argument_list|,
name|frs
operator|->
name|fr_nfr
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s fragment state lost\n"
argument_list|,
name|frs
operator|->
name|fr_bnfr
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s packet state kept\n"
argument_list|,
name|frs
operator|->
name|fr_ads
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s packet state lost\n"
argument_list|,
name|frs
operator|->
name|fr_bads
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s invalid source\n"
argument_list|,
name|frs
operator|->
name|fr_v4_badsrc
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s cache hits\n"
argument_list|,
name|frs
operator|->
name|fr_chit
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s cache misses\n"
argument_list|,
name|frs
operator|->
name|fr_cmiss
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s bad coalesces\n"
argument_list|,
name|frs
operator|->
name|fr_badcoalesces
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s pullups succeeded\n"
argument_list|,
name|frs
operator|->
name|fr_pull
index|[
literal|0
index|]
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s pullups failed\n"
argument_list|,
name|frs
operator|->
name|fr_pull
index|[
literal|1
index|]
argument_list|,
name|side
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\t%s TCP checksum failures\n"
argument_list|,
name|frs
operator|->
name|fr_tcpbad
argument_list|,
name|side
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|FRB_MAX_VALUE
condition|;
name|i
operator|++
control|)
name|PRINTF
argument_list|(
literal|"%lu\t%s block reason %s\n"
argument_list|,
name|frs
operator|->
name|fr_blocked
index|[
name|i
index|]
argument_list|,
name|side
argument_list|,
name|blockreasons
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Display the kernel stats for packets blocked and passed and other  * associated running totals which are kept.  */
end_comment

begin_function
specifier|static
name|void
name|showstats
parameter_list|(
name|fp
parameter_list|,
name|frf
parameter_list|)
name|struct
name|friostat
modifier|*
name|fp
decl_stmt|;
name|u_32_t
name|frf
decl_stmt|;
block|{
name|printside
argument_list|(
literal|"input"
argument_list|,
operator|&
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printside
argument_list|(
literal|"output"
argument_list|,
operator|&
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tpackets logged\n"
argument_list|,
name|fp
operator|->
name|f_log_ok
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tlog failures\n"
argument_list|,
name|fp
operator|->
name|f_log_fail
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tred-black no memory\n"
argument_list|,
name|fp
operator|->
name|f_rb_no_mem
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tred-black node maximum\n"
argument_list|,
name|fp
operator|->
name|f_rb_node_max
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tICMP replies sent\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|0
index|]
operator|.
name|fr_ret
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tTCP RSTs sent\n"
argument_list|,
name|fp
operator|->
name|f_st
index|[
literal|1
index|]
operator|.
name|fr_ret
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tfastroute successes\n"
argument_list|,
name|fp
operator|->
name|f_froute
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tfastroute failures\n"
argument_list|,
name|fp
operator|->
name|f_froute
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%u\tIPF Ticks\n"
argument_list|,
name|fp
operator|->
name|f_ticks
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%x\tPacket log flags set:\n"
argument_list|,
name|frf
argument_list|)
expr_stmt|;
if|if
condition|(
name|frf
operator|&
name|FF_LOGPASS
condition|)
name|PRINTF
argument_list|(
literal|"\tpackets passed through filter\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|frf
operator|&
name|FF_LOGBLOCK
condition|)
name|PRINTF
argument_list|(
literal|"\tpackets blocked by filter\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|frf
operator|&
name|FF_LOGNOMATCH
condition|)
name|PRINTF
argument_list|(
literal|"\tpackets not matched by filter\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|frf
condition|)
name|PRINTF
argument_list|(
literal|"\tnone\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print out a list of rules from the kernel, starting at the one passed.  */
end_comment

begin_function
specifier|static
name|int
name|printlivelist
parameter_list|(
name|fiop
parameter_list|,
name|out
parameter_list|,
name|set
parameter_list|,
name|fp
parameter_list|,
name|group
parameter_list|,
name|comment
parameter_list|)
name|struct
name|friostat
modifier|*
name|fiop
decl_stmt|;
name|int
name|out
decl_stmt|,
name|set
decl_stmt|;
name|frentry_t
modifier|*
name|fp
decl_stmt|;
name|char
modifier|*
name|group
decl_stmt|,
decl|*
name|comment
decl_stmt|;
end_function

begin_block
block|{
name|struct
name|frentry
name|fb
decl_stmt|;
name|ipfruleiter_t
name|rule
decl_stmt|;
name|frentry_t
name|zero
decl_stmt|;
name|frgroup_t
modifier|*
name|g
decl_stmt|;
name|ipfobj_t
name|obj
decl_stmt|;
name|int
name|rules
decl_stmt|;
name|int
name|num
decl_stmt|;
name|rules
operator|=
literal|0
expr_stmt|;
name|rule
operator|.
name|iri_inout
operator|=
name|out
expr_stmt|;
name|rule
operator|.
name|iri_active
operator|=
name|set
expr_stmt|;
name|rule
operator|.
name|iri_rule
operator|=
operator|&
name|fb
expr_stmt|;
name|rule
operator|.
name|iri_nrules
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|group
operator|!=
name|NULL
condition|)
name|strncpy
argument_list|(
name|rule
operator|.
name|iri_group
argument_list|,
name|group
argument_list|,
name|FR_GROUPLEN
argument_list|)
expr_stmt|;
else|else
name|rule
operator|.
name|iri_group
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|zero
argument_list|,
sizeof|sizeof
argument_list|(
name|zero
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|obj
argument_list|,
sizeof|sizeof
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|.
name|ipfo_rev
operator|=
name|IPFILTER_VERSION
expr_stmt|;
name|obj
operator|.
name|ipfo_type
operator|=
name|IPFOBJ_IPFITER
expr_stmt|;
name|obj
operator|.
name|ipfo_size
operator|=
sizeof|sizeof
argument_list|(
name|rule
argument_list|)
expr_stmt|;
name|obj
operator|.
name|ipfo_ptr
operator|=
operator|&
name|rule
expr_stmt|;
while|while
condition|(
name|rule
operator|.
name|iri_rule
operator|!=
name|NULL
condition|)
block|{
name|u_long
name|array
index|[
literal|1000
index|]
decl_stmt|;
name|memset
argument_list|(
name|array
argument_list|,
literal|0xff
argument_list|,
sizeof|sizeof
argument_list|(
name|array
argument_list|)
argument_list|)
expr_stmt|;
name|fp
operator|=
operator|(
name|frentry_t
operator|*
operator|)
name|array
expr_stmt|;
name|rule
operator|.
name|iri_rule
operator|=
name|fp
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|ipf_fd
argument_list|,
name|SIOCIPFITER
argument_list|,
operator|&
name|obj
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ipferror
argument_list|(
name|ipf_fd
argument_list|,
literal|"ioctl(SIOCIPFITER)"
argument_list|)
expr_stmt|;
name|num
operator|=
name|IPFGENITER_IPF
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
name|ipf_fd
argument_list|,
name|SIOCIPFDELTOK
argument_list|,
operator|&
name|num
argument_list|)
expr_stmt|;
return|return
name|rules
return|;
block|}
if|if
condition|(
name|bcmp
argument_list|(
name|fp
argument_list|,
operator|&
name|zero
argument_list|,
sizeof|sizeof
argument_list|(
name|zero
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|rule
operator|.
name|iri_rule
operator|==
name|NULL
condition|)
break|break;
ifdef|#
directive|ifdef
name|USE_INET6
if|if
condition|(
name|use_inet6
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_family
operator|!=
literal|0
operator|&&
name|fp
operator|->
name|fr_family
operator|!=
name|AF_INET6
condition|)
continue|continue;
block|}
else|else
endif|#
directive|endif
block|{
if|if
condition|(
name|fp
operator|->
name|fr_family
operator|!=
literal|0
operator|&&
name|fp
operator|->
name|fr_family
operator|!=
name|AF_INET
condition|)
continue|continue;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_data
operator|!=
name|NULL
condition|)
name|fp
operator|->
name|fr_data
operator|=
operator|(
name|char
operator|*
operator|)
name|fp
operator|+
name|fp
operator|->
name|fr_size
expr_stmt|;
name|rules
operator|++
expr_stmt|;
if|if
condition|(
name|opts
operator|&
operator|(
name|OPT_HITS
operator||
name|OPT_DEBUG
operator|)
condition|)
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|PRINTF
argument_list|(
literal|"%"
name|PRIu64
literal|" "
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|fp
operator|->
name|fr_hits
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"%lu "
argument_list|,
name|fp
operator|->
name|fr_hits
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|opts
operator|&
operator|(
name|OPT_ACCNT
operator||
name|OPT_DEBUG
operator|)
condition|)
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|PRINTF
argument_list|(
literal|"%"
name|PRIu64
literal|" "
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|fp
operator|->
name|fr_bytes
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"%lu "
argument_list|,
name|fp
operator|->
name|fr_bytes
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|opts
operator|&
name|OPT_SHOWLINENO
condition|)
name|PRINTF
argument_list|(
literal|"@%d "
argument_list|,
name|rules
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_die
operator|!=
literal|0
condition|)
name|fp
operator|->
name|fr_die
operator|-=
name|fiop
operator|->
name|f_ticks
expr_stmt|;
name|printfr
argument_list|(
name|fp
argument_list|,
name|ioctl
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
block|{
name|binprint
argument_list|(
name|fp
argument_list|,
name|fp
operator|->
name|fr_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_data
operator|!=
name|NULL
operator|&&
name|fp
operator|->
name|fr_dsize
operator|>
literal|0
condition|)
name|binprint
argument_list|(
name|fp
operator|->
name|fr_data
argument_list|,
name|fp
operator|->
name|fr_dsize
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_grhead
operator|!=
operator|-
literal|1
condition|)
block|{
for|for
control|(
name|g
operator|=
name|grtop
init|;
name|g
operator|!=
name|NULL
condition|;
name|g
operator|=
name|g
operator|->
name|fg_next
control|)
block|{
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_grhead
argument_list|,
name|g
operator|->
name|fg_name
argument_list|,
name|FR_GROUPLEN
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|g
operator|==
name|NULL
condition|)
block|{
name|g
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|g
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|g
operator|!=
name|NULL
condition|)
block|{
name|strncpy
argument_list|(
name|g
operator|->
name|fg_name
argument_list|,
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_grhead
argument_list|,
name|FR_GROUPLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|grtop
operator|==
name|NULL
condition|)
block|{
name|grtop
operator|=
name|g
expr_stmt|;
name|grtail
operator|=
name|g
expr_stmt|;
block|}
else|else
block|{
name|grtail
operator|->
name|fg_next
operator|=
name|g
expr_stmt|;
name|grtail
operator|=
name|g
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|fp
operator|->
name|fr_type
operator|==
name|FR_T_CALLFUNC
condition|)
block|{
name|rules
operator|+=
name|printlivelist
argument_list|(
name|fiop
argument_list|,
name|out
argument_list|,
name|set
argument_list|,
name|fp
operator|->
name|fr_data
argument_list|,
name|group
argument_list|,
literal|"# callfunc: "
argument_list|)
expr_stmt|;
block|}
block|}
name|num
operator|=
name|IPFGENITER_IPF
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
name|ipf_fd
argument_list|,
name|SIOCIPFDELTOK
argument_list|,
operator|&
name|num
argument_list|)
expr_stmt|;
return|return
name|rules
return|;
block|}
end_block

begin_function
specifier|static
name|void
name|printdeadlist
parameter_list|(
name|fiop
parameter_list|,
name|out
parameter_list|,
name|set
parameter_list|,
name|fp
parameter_list|,
name|group
parameter_list|,
name|comment
parameter_list|)
name|friostat_t
modifier|*
name|fiop
decl_stmt|;
name|int
name|out
decl_stmt|,
name|set
decl_stmt|;
name|frentry_t
modifier|*
name|fp
decl_stmt|;
name|char
modifier|*
name|group
decl_stmt|,
decl|*
name|comment
decl_stmt|;
end_function

begin_block
block|{
name|frgroup_t
modifier|*
name|grtop
decl_stmt|,
modifier|*
name|grtail
decl_stmt|,
modifier|*
name|g
decl_stmt|;
name|struct
name|frentry
name|fb
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|u_32_t
name|type
decl_stmt|;
name|int
name|n
decl_stmt|;
name|fb
operator|.
name|fr_next
operator|=
name|fp
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
name|grtop
operator|=
name|NULL
expr_stmt|;
name|grtail
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|1
init|;
name|fp
condition|;
name|fp
operator|=
name|fb
operator|.
name|fr_next
operator|,
name|n
operator|++
control|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fb
argument_list|,
operator|(
name|u_long
operator|)
name|fb
operator|.
name|fr_next
argument_list|,
name|fb
operator|.
name|fr_size
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"kmemcpy"
argument_list|)
expr_stmt|;
return|return;
block|}
name|fp
operator|=
operator|&
name|fb
expr_stmt|;
if|if
condition|(
name|use_inet6
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_family
operator|!=
literal|0
operator|&&
name|fp
operator|->
name|fr_family
operator|!=
literal|6
condition|)
continue|continue;
block|}
else|else
block|{
if|if
condition|(
name|fp
operator|->
name|fr_family
operator|!=
literal|0
operator|&&
name|fp
operator|->
name|fr_family
operator|!=
literal|4
condition|)
continue|continue;
block|}
name|data
operator|=
name|NULL
expr_stmt|;
name|type
operator|=
name|fb
operator|.
name|fr_type
operator|&
operator|~
name|FR_T_BUILTIN
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|FR_T_IPF
operator|||
name|type
operator|==
name|FR_T_BPFOPC
condition|)
block|{
if|if
condition|(
name|fb
operator|.
name|fr_dsize
condition|)
block|{
name|data
operator|=
name|malloc
argument_list|(
name|fb
operator|.
name|fr_dsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|kmemcpy
argument_list|(
name|data
argument_list|,
operator|(
name|u_long
operator|)
name|fb
operator|.
name|fr_data
argument_list|,
name|fb
operator|.
name|fr_dsize
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"kmemcpy"
argument_list|)
expr_stmt|;
return|return;
block|}
name|fb
operator|.
name|fr_data
operator|=
name|data
expr_stmt|;
block|}
block|}
if|if
condition|(
name|opts
operator|&
name|OPT_HITS
condition|)
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|PRINTF
argument_list|(
literal|"%"
name|PRIu64
literal|" "
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|fb
operator|.
name|fr_hits
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"%lu "
argument_list|,
name|fb
operator|.
name|fr_hits
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|opts
operator|&
name|OPT_ACCNT
condition|)
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|PRINTF
argument_list|(
literal|"%"
name|PRIu64
literal|" "
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|fb
operator|.
name|fr_bytes
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"%lu "
argument_list|,
name|fb
operator|.
name|fr_bytes
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|opts
operator|&
name|OPT_SHOWLINENO
condition|)
name|PRINTF
argument_list|(
literal|"@%d "
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|printfr
argument_list|(
name|fp
argument_list|,
name|ioctl
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
block|{
name|binprint
argument_list|(
name|fp
argument_list|,
name|fp
operator|->
name|fr_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|fb
operator|.
name|fr_data
operator|!=
name|NULL
operator|&&
name|fb
operator|.
name|fr_dsize
operator|>
literal|0
condition|)
name|binprint
argument_list|(
name|fb
operator|.
name|fr_data
argument_list|,
name|fb
operator|.
name|fr_dsize
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|fb
operator|.
name|fr_grhead
operator|!=
operator|-
literal|1
condition|)
block|{
name|g
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|g
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|g
operator|!=
name|NULL
condition|)
block|{
name|strncpy
argument_list|(
name|g
operator|->
name|fg_name
argument_list|,
name|fb
operator|.
name|fr_names
operator|+
name|fb
operator|.
name|fr_grhead
argument_list|,
name|FR_GROUPLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|grtop
operator|==
name|NULL
condition|)
block|{
name|grtop
operator|=
name|g
expr_stmt|;
name|grtail
operator|=
name|g
expr_stmt|;
block|}
else|else
block|{
name|grtail
operator|->
name|fg_next
operator|=
name|g
expr_stmt|;
name|grtail
operator|=
name|g
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|type
operator|==
name|FR_T_CALLFUNC
condition|)
block|{
name|printdeadlist
argument_list|(
name|fiop
argument_list|,
name|out
argument_list|,
name|set
argument_list|,
name|fb
operator|.
name|fr_data
argument_list|,
name|group
argument_list|,
literal|"# callfunc: "
argument_list|)
expr_stmt|;
block|}
block|}
while|while
condition|(
operator|(
name|g
operator|=
name|grtop
operator|)
operator|!=
name|NULL
condition|)
block|{
name|printdeadlist
argument_list|(
name|fiop
argument_list|,
name|out
argument_list|,
name|set
argument_list|,
name|NULL
argument_list|,
name|g
operator|->
name|fg_name
argument_list|,
name|comment
argument_list|)
expr_stmt|;
name|grtop
operator|=
name|g
operator|->
name|fg_next
expr_stmt|;
name|free
argument_list|(
name|g
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  * print out all of the asked for rule sets, using the stats struct as  * the base from which to get the pointers.  */
end_comment

begin_function
specifier|static
name|void
name|showlist
parameter_list|(
name|fiop
parameter_list|)
name|struct
name|friostat
modifier|*
name|fiop
decl_stmt|;
block|{
name|struct
name|frentry
modifier|*
name|fp
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|set
decl_stmt|;
name|set
operator|=
name|fiop
operator|->
name|f_active
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_INACTIVE
condition|)
name|set
operator|=
literal|1
operator|-
name|set
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_ACCNT
condition|)
block|{
if|if
condition|(
name|opts
operator|&
name|OPT_OUTQUE
condition|)
block|{
name|i
operator|=
name|F_ACOUT
expr_stmt|;
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_acctout
index|[
name|set
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_INQUE
condition|)
block|{
name|i
operator|=
name|F_ACIN
expr_stmt|;
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_acctin
index|[
name|set
index|]
expr_stmt|;
block|}
else|else
block|{
name|FPRINTF
argument_list|(
name|stderr
argument_list|,
literal|"No -i or -o given with -a\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
if|if
condition|(
name|opts
operator|&
name|OPT_OUTQUE
condition|)
block|{
name|i
operator|=
name|F_OUT
expr_stmt|;
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_fout
index|[
name|set
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opts
operator|&
name|OPT_INQUE
condition|)
block|{
name|i
operator|=
name|F_IN
expr_stmt|;
name|fp
operator|=
operator|(
expr|struct
name|frentry
operator|*
operator|)
name|fiop
operator|->
name|f_fin
index|[
name|set
index|]
expr_stmt|;
block|}
else|else
return|return;
block|}
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
name|FPRINTF
argument_list|(
name|stderr
argument_list|,
literal|"showlist:opts %#x i %d\n"
argument_list|,
name|opts
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
name|PRINTF
argument_list|(
literal|"fp %p set %d\n"
argument_list|,
name|fp
argument_list|,
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
name|live_kernel
operator|==
literal|1
condition|)
block|{
name|int
name|printed
decl_stmt|;
name|printed
operator|=
name|printlivelist
argument_list|(
name|fiop
argument_list|,
name|i
argument_list|,
name|set
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|printed
operator|==
literal|0
condition|)
block|{
name|FPRINTF
argument_list|(
name|stderr
argument_list|,
literal|"# empty list for %s%s\n"
argument_list|,
operator|(
name|opts
operator|&
name|OPT_INACTIVE
operator|)
condition|?
literal|"inactive "
else|:
literal|""
argument_list|,
name|filters
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|FPRINTF
argument_list|(
name|stderr
argument_list|,
literal|"# empty list for %s%s\n"
argument_list|,
operator|(
name|opts
operator|&
name|OPT_INACTIVE
operator|)
condition|?
literal|"inactive "
else|:
literal|""
argument_list|,
name|filters
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printdeadlist
argument_list|(
name|fiop
argument_list|,
name|i
argument_list|,
name|set
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Display ipfilter stateful filtering information  */
end_comment

begin_function
specifier|static
name|void
name|showipstates
parameter_list|(
name|ipsp
parameter_list|,
name|filter
parameter_list|)
name|ips_stat_t
modifier|*
name|ipsp
decl_stmt|;
name|int
modifier|*
name|filter
decl_stmt|;
block|{
name|ipstate_t
modifier|*
name|is
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* 	 * If a list of states hasn't been asked for, only print out stats 	 */
if|if
condition|(
operator|!
operator|(
name|opts
operator|&
name|OPT_SHOWLIST
operator|)
condition|)
block|{
name|showstatestats
argument_list|(
name|ipsp
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|state_fields
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|nohdrfields
operator|==
literal|0
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|state_fields
index|[
name|i
index|]
operator|.
name|w_value
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
name|printfieldhdr
argument_list|(
name|statefields
argument_list|,
name|state_fields
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|state_fields
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|w_value
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Print out all the state information currently held in the kernel. 	 */
for|for
control|(
name|is
operator|=
name|ipsp
operator|->
name|iss_list
init|;
name|is
operator|!=
name|NULL
condition|;
control|)
block|{
name|ipstate_t
name|ips
decl_stmt|;
name|is
operator|=
name|fetchstate
argument_list|(
name|is
argument_list|,
operator|&
name|ips
argument_list|)
expr_stmt|;
if|if
condition|(
name|is
operator|==
name|NULL
condition|)
break|break;
name|is
operator|=
name|ips
operator|.
name|is_next
expr_stmt|;
if|if
condition|(
operator|(
name|filter
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|state_matcharray
argument_list|(
operator|&
name|ips
argument_list|,
name|filter
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|state_fields
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|state_fields
index|[
name|i
index|]
operator|.
name|w_value
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
name|printstatefield
argument_list|(
operator|&
name|ips
argument_list|,
name|state_fields
index|[
name|i
index|]
operator|.
name|w_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|state_fields
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|w_value
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printstate
argument_list|(
operator|&
name|ips
argument_list|,
name|opts
argument_list|,
name|ipsp
operator|->
name|iss_ticks
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|showstatestats
parameter_list|(
name|ipsp
parameter_list|)
name|ips_stat_t
modifier|*
name|ipsp
decl_stmt|;
block|{
name|int
name|minlen
decl_stmt|,
name|maxlen
decl_stmt|,
name|totallen
decl_stmt|;
name|ipftable_t
name|table
decl_stmt|;
name|u_int
modifier|*
name|buckets
decl_stmt|;
name|ipfobj_t
name|obj
decl_stmt|;
name|int
name|i
decl_stmt|,
name|sz
decl_stmt|;
comment|/* 	 * If a list of states hasn't been asked for, only print out stats 	 */
name|sz
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|buckets
argument_list|)
operator|*
name|ipsp
operator|->
name|iss_state_size
expr_stmt|;
name|buckets
operator|=
operator|(
name|u_int
operator|*
operator|)
name|malloc
argument_list|(
name|sz
argument_list|)
expr_stmt|;
name|obj
operator|.
name|ipfo_rev
operator|=
name|IPFILTER_VERSION
expr_stmt|;
name|obj
operator|.
name|ipfo_type
operator|=
name|IPFOBJ_GTABLE
expr_stmt|;
name|obj
operator|.
name|ipfo_size
operator|=
sizeof|sizeof
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|obj
operator|.
name|ipfo_ptr
operator|=
operator|&
name|table
expr_stmt|;
name|table
operator|.
name|ita_type
operator|=
name|IPFTABLE_BUCKETS
expr_stmt|;
name|table
operator|.
name|ita_table
operator|=
name|buckets
expr_stmt|;
if|if
condition|(
name|live_kernel
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|state_fd
argument_list|,
name|SIOCGTABL
argument_list|,
operator|&
name|obj
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|buckets
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|buckets
argument_list|,
operator|(
name|u_long
operator|)
name|ipsp
operator|->
name|iss_bucketlen
argument_list|,
name|sz
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|buckets
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|PRINTF
argument_list|(
literal|"%u\tactive state table entries\n"
argument_list|,
name|ipsp
operator|->
name|iss_active
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tadd bad\n"
argument_list|,
name|ipsp
operator|->
name|iss_add_bad
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tadd duplicate\n"
argument_list|,
name|ipsp
operator|->
name|iss_add_dup
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tadd locked\n"
argument_list|,
name|ipsp
operator|->
name|iss_add_locked
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tadd oow\n"
argument_list|,
name|ipsp
operator|->
name|iss_add_oow
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tbucket full\n"
argument_list|,
name|ipsp
operator|->
name|iss_bucket_full
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tcheck bad\n"
argument_list|,
name|ipsp
operator|->
name|iss_check_bad
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tcheck miss\n"
argument_list|,
name|ipsp
operator|->
name|iss_check_miss
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tcheck nattag\n"
argument_list|,
name|ipsp
operator|->
name|iss_check_nattag
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tclone nomem\n"
argument_list|,
name|ipsp
operator|->
name|iss_clone_nomem
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tcheck notag\n"
argument_list|,
name|ipsp
operator|->
name|iss_check_notag
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tcheck success\n"
argument_list|,
name|ipsp
operator|->
name|iss_hits
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tcloned\n"
argument_list|,
name|ipsp
operator|->
name|iss_cloned
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\texpired\n"
argument_list|,
name|ipsp
operator|->
name|iss_expire
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tflush all\n"
argument_list|,
name|ipsp
operator|->
name|iss_flush_all
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tflush closing\n"
argument_list|,
name|ipsp
operator|->
name|iss_flush_closing
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tflush queue\n"
argument_list|,
name|ipsp
operator|->
name|iss_flush_queue
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tflush state\n"
argument_list|,
name|ipsp
operator|->
name|iss_flush_state
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tflush timeout\n"
argument_list|,
name|ipsp
operator|->
name|iss_flush_timeout
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%u\thash buckets in use\n"
argument_list|,
name|ipsp
operator|->
name|iss_inuse
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tICMP bad\n"
argument_list|,
name|ipsp
operator|->
name|iss_icmp_bad
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tICMP banned\n"
argument_list|,
name|ipsp
operator|->
name|iss_icmp_banned
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tICMP errors\n"
argument_list|,
name|ipsp
operator|->
name|iss_icmp_icmperr
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tICMP head block\n"
argument_list|,
name|ipsp
operator|->
name|iss_icmp_headblock
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tICMP hits\n"
argument_list|,
name|ipsp
operator|->
name|iss_icmp_hits
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tICMP not query\n"
argument_list|,
name|ipsp
operator|->
name|iss_icmp_notquery
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tICMP short\n"
argument_list|,
name|ipsp
operator|->
name|iss_icmp_short
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tICMP too many\n"
argument_list|,
name|ipsp
operator|->
name|iss_icmp_toomany
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tICMPv6 errors\n"
argument_list|,
name|ipsp
operator|->
name|iss_icmp6_icmperr
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tICMPv6 miss\n"
argument_list|,
name|ipsp
operator|->
name|iss_icmp6_miss
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tICMPv6 not info\n"
argument_list|,
name|ipsp
operator|->
name|iss_icmp6_notinfo
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tICMPv6 not query\n"
argument_list|,
name|ipsp
operator|->
name|iss_icmp6_notquery
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tlog fail\n"
argument_list|,
name|ipsp
operator|->
name|iss_log_fail
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tlog ok\n"
argument_list|,
name|ipsp
operator|->
name|iss_log_ok
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tlookup interface mismatch\n"
argument_list|,
name|ipsp
operator|->
name|iss_lookup_badifp
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tlookup mask mismatch\n"
argument_list|,
name|ipsp
operator|->
name|iss_miss_mask
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tlookup port mismatch\n"
argument_list|,
name|ipsp
operator|->
name|iss_lookup_badport
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tlookup miss\n"
argument_list|,
name|ipsp
operator|->
name|iss_lookup_miss
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tmaximum rule references\n"
argument_list|,
name|ipsp
operator|->
name|iss_max_ref
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tmaximum hosts per rule\n"
argument_list|,
name|ipsp
operator|->
name|iss_max_track
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tno memory\n"
argument_list|,
name|ipsp
operator|->
name|iss_nomem
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tout of window\n"
argument_list|,
name|ipsp
operator|->
name|iss_oow
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\torphans\n"
argument_list|,
name|ipsp
operator|->
name|iss_orphan
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tscan block\n"
argument_list|,
name|ipsp
operator|->
name|iss_scan_block
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tstate table maximum reached\n"
argument_list|,
name|ipsp
operator|->
name|iss_max
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tTCP closing\n"
argument_list|,
name|ipsp
operator|->
name|iss_tcp_closing
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tTCP OOW\n"
argument_list|,
name|ipsp
operator|->
name|iss_tcp_oow
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tTCP RST add\n"
argument_list|,
name|ipsp
operator|->
name|iss_tcp_rstadd
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tTCP too small\n"
argument_list|,
name|ipsp
operator|->
name|iss_tcp_toosmall
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tTCP bad options\n"
argument_list|,
name|ipsp
operator|->
name|iss_tcp_badopt
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tTCP removed\n"
argument_list|,
name|ipsp
operator|->
name|iss_fin
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tTCP FSM\n"
argument_list|,
name|ipsp
operator|->
name|iss_tcp_fsm
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tTCP strict\n"
argument_list|,
name|ipsp
operator|->
name|iss_tcp_strict
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tTCP wild\n"
argument_list|,
name|ipsp
operator|->
name|iss_wild
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tMicrosoft Windows SACK\n"
argument_list|,
name|ipsp
operator|->
name|iss_winsack
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"State logging %sabled\n"
argument_list|,
name|state_logging
condition|?
literal|"en"
else|:
literal|"dis"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"IP states added:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ipsp
operator|->
name|iss_proto
index|[
name|i
index|]
operator|!=
literal|0
condition|)
block|{
name|struct
name|protoent
modifier|*
name|proto
decl_stmt|;
name|proto
operator|=
name|getprotobynumber
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu"
argument_list|,
name|ipsp
operator|->
name|iss_proto
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
operator|!=
name|NULL
condition|)
name|PRINTF
argument_list|(
literal|"\t%s\n"
argument_list|,
name|proto
operator|->
name|p_name
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|"\t%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|PRINTF
argument_list|(
literal|"\nState table bucket statistics:\n"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%u\tin use\n"
argument_list|,
name|ipsp
operator|->
name|iss_inuse
argument_list|)
expr_stmt|;
name|minlen
operator|=
name|ipsp
operator|->
name|iss_max
expr_stmt|;
name|totallen
operator|=
literal|0
expr_stmt|;
name|maxlen
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ipsp
operator|->
name|iss_state_size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|buckets
index|[
name|i
index|]
operator|>
name|maxlen
condition|)
name|maxlen
operator|=
name|buckets
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|buckets
index|[
name|i
index|]
operator|<
name|minlen
condition|)
name|minlen
operator|=
name|buckets
index|[
name|i
index|]
expr_stmt|;
name|totallen
operator|+=
name|buckets
index|[
name|i
index|]
expr_stmt|;
block|}
name|PRINTF
argument_list|(
literal|"%d\thash efficiency\n"
argument_list|,
name|totallen
condition|?
name|ipsp
operator|->
name|iss_inuse
operator|*
literal|100
operator|/
name|totallen
else|:
literal|0
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%2.2f%%\tbucket usage\n%u\tminimal length\n"
argument_list|,
operator|(
operator|(
name|float
operator|)
name|ipsp
operator|->
name|iss_inuse
operator|/
name|ipsp
operator|->
name|iss_state_size
operator|)
operator|*
literal|100.0
argument_list|,
name|minlen
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%u\tmaximal length\n%.3f\taverage length\n"
argument_list|,
name|maxlen
argument_list|,
name|ipsp
operator|->
name|iss_inuse
condition|?
operator|(
name|float
operator|)
name|totallen
operator|/
name|ipsp
operator|->
name|iss_inuse
else|:
literal|0.0
argument_list|)
expr_stmt|;
define|#
directive|define
name|ENTRIES_PER_LINE
value|5
if|if
condition|(
name|opts
operator|&
name|OPT_VERBOSE
condition|)
block|{
name|PRINTF
argument_list|(
literal|"\nCurrent bucket sizes :\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ipsp
operator|->
name|iss_state_size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|i
operator|%
name|ENTRIES_PER_LINE
operator|)
operator|==
literal|0
condition|)
name|PRINTF
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%4d -> %4u"
argument_list|,
name|i
argument_list|,
name|buckets
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|%
name|ENTRIES_PER_LINE
operator|)
operator|==
operator|(
name|ENTRIES_PER_LINE
operator|-
literal|1
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|"  "
argument_list|)
expr_stmt|;
block|}
name|PRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|PRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buckets
argument_list|)
expr_stmt|;
if|if
condition|(
name|live_kernel
operator|==
literal|1
condition|)
block|{
name|showtqtable_live
argument_list|(
name|state_fd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printtqtable
argument_list|(
name|ipsp
operator|->
name|iss_tcptab
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|STATETOP
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|handle_resize
init|=
literal|0
decl_stmt|,
name|handle_break
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|topipstates
parameter_list|(
name|saddr
parameter_list|,
name|daddr
parameter_list|,
name|sport
parameter_list|,
name|dport
parameter_list|,
name|protocol
parameter_list|,
name|ver
parameter_list|,
name|refreshtime
parameter_list|,
name|topclosed
parameter_list|,
name|filter
parameter_list|)
name|i6addr_t
name|saddr
decl_stmt|;
name|i6addr_t
name|daddr
decl_stmt|;
name|int
name|sport
decl_stmt|;
name|int
name|dport
decl_stmt|;
name|int
name|protocol
decl_stmt|;
name|int
name|ver
decl_stmt|;
name|int
name|refreshtime
decl_stmt|;
name|int
name|topclosed
decl_stmt|;
name|int
modifier|*
name|filter
decl_stmt|;
block|{
name|char
name|str1
index|[
name|STSTRSIZE
index|]
decl_stmt|,
name|str2
index|[
name|STSTRSIZE
index|]
decl_stmt|,
name|str3
index|[
name|STSTRSIZE
index|]
decl_stmt|,
name|str4
index|[
name|STSTRSIZE
index|]
decl_stmt|;
name|int
name|maxtsentries
init|=
literal|0
decl_stmt|,
name|reverse
init|=
literal|0
decl_stmt|,
name|sorting
init|=
name|STSORT_DEFAULT
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|winy
decl_stmt|,
name|tsentry
decl_stmt|,
name|maxx
decl_stmt|,
name|maxy
decl_stmt|,
name|redraw
init|=
literal|0
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|len
decl_stmt|,
name|srclen
decl_stmt|,
name|dstlen
decl_stmt|,
name|forward
init|=
literal|1
decl_stmt|,
name|c
init|=
literal|0
decl_stmt|;
name|ips_stat_t
name|ipsst
decl_stmt|,
modifier|*
name|ipsstp
init|=
operator|&
name|ipsst
decl_stmt|;
name|int
name|token_type
init|=
name|IPFGENITER_STATE
decl_stmt|;
name|statetop_t
modifier|*
name|tstable
init|=
name|NULL
decl_stmt|,
modifier|*
name|tp
decl_stmt|;
specifier|const
name|char
modifier|*
name|errstr
init|=
literal|""
decl_stmt|;
name|ipstate_t
name|ips
decl_stmt|;
name|ipfobj_t
name|ipfo
decl_stmt|;
name|struct
name|timeval
name|selecttimeout
decl_stmt|;
name|char
name|hostnm
index|[
name|HOSTNMLEN
index|]
decl_stmt|;
name|struct
name|protoent
modifier|*
name|proto
decl_stmt|;
name|fd_set
name|readfd
decl_stmt|;
name|time_t
name|t
decl_stmt|;
comment|/* install signal handlers */
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|sig_break
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|sig_break
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|sig_break
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGWINCH
argument_list|,
name|sig_resize
argument_list|)
expr_stmt|;
comment|/* init ncurses stuff */
name|initscr
argument_list|()
expr_stmt|;
name|cbreak
argument_list|()
expr_stmt|;
name|noecho
argument_list|()
expr_stmt|;
name|curs_set
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|timeout
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|getmaxyx
argument_list|(
name|stdscr
argument_list|,
name|maxy
argument_list|,
name|maxx
argument_list|)
expr_stmt|;
comment|/* init hostname */
name|gethostname
argument_list|(
name|hostnm
argument_list|,
sizeof|sizeof
argument_list|(
name|hostnm
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|hostnm
index|[
sizeof|sizeof
argument_list|(
name|hostnm
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* init ipfobj_t stuff */
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|ipfo
argument_list|,
sizeof|sizeof
argument_list|(
name|ipfo
argument_list|)
argument_list|)
expr_stmt|;
name|ipfo
operator|.
name|ipfo_rev
operator|=
name|IPFILTER_VERSION
expr_stmt|;
name|ipfo
operator|.
name|ipfo_type
operator|=
name|IPFOBJ_STATESTAT
expr_stmt|;
name|ipfo
operator|.
name|ipfo_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ipsstp
argument_list|)
expr_stmt|;
name|ipfo
operator|.
name|ipfo_ptr
operator|=
operator|(
name|void
operator|*
operator|)
name|ipsstp
expr_stmt|;
comment|/* repeat until user aborts */
while|while
condition|(
literal|1
condition|)
block|{
comment|/* get state table */
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ipsst
argument_list|,
sizeof|sizeof
argument_list|(
name|ipsst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ioctl
argument_list|(
name|state_fd
argument_list|,
name|SIOCGETFS
argument_list|,
operator|&
name|ipfo
argument_list|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|errstr
operator|=
literal|"ioctl(SIOCGETFS)"
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* clear the history */
name|tsentry
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* reset max str len */
name|srclen
operator|=
name|dstlen
operator|=
literal|0
expr_stmt|;
comment|/* read the state table and store in tstable */
for|for
control|(
init|;
name|ipsstp
operator|->
name|iss_list
condition|;
name|ipsstp
operator|->
name|iss_list
operator|=
name|ips
operator|.
name|is_next
control|)
block|{
name|ipsstp
operator|->
name|iss_list
operator|=
name|fetchstate
argument_list|(
name|ipsstp
operator|->
name|iss_list
argument_list|,
operator|&
name|ips
argument_list|)
expr_stmt|;
if|if
condition|(
name|ipsstp
operator|->
name|iss_list
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|ips
operator|.
name|is_v
operator|!=
name|ver
condition|)
continue|continue;
if|if
condition|(
operator|(
name|filter
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|state_matcharray
argument_list|(
operator|&
name|ips
argument_list|,
name|filter
argument_list|)
operator|==
literal|0
operator|)
condition|)
continue|continue;
comment|/* check v4 src/dest addresses */
if|if
condition|(
name|ips
operator|.
name|is_v
operator|==
literal|4
condition|)
block|{
if|if
condition|(
operator|(
name|saddr
operator|.
name|in4
operator|.
name|s_addr
operator|!=
name|INADDR_ANY
operator|&&
name|saddr
operator|.
name|in4
operator|.
name|s_addr
operator|!=
name|ips
operator|.
name|is_saddr
operator|)
operator|||
operator|(
name|daddr
operator|.
name|in4
operator|.
name|s_addr
operator|!=
name|INADDR_ANY
operator|&&
name|daddr
operator|.
name|in4
operator|.
name|s_addr
operator|!=
name|ips
operator|.
name|is_daddr
operator|)
condition|)
continue|continue;
block|}
ifdef|#
directive|ifdef
name|USE_INET6
comment|/* check v6 src/dest addresses */
if|if
condition|(
name|ips
operator|.
name|is_v
operator|==
literal|6
condition|)
block|{
if|if
condition|(
operator|(
name|IP6_NEQ
argument_list|(
operator|&
name|saddr
argument_list|,
operator|&
name|in6addr_any
argument_list|)
operator|&&
name|IP6_NEQ
argument_list|(
operator|&
name|saddr
argument_list|,
operator|&
name|ips
operator|.
name|is_src
argument_list|)
operator|)
operator|||
operator|(
name|IP6_NEQ
argument_list|(
operator|&
name|daddr
argument_list|,
operator|&
name|in6addr_any
argument_list|)
operator|&&
name|IP6_NEQ
argument_list|(
operator|&
name|daddr
argument_list|,
operator|&
name|ips
operator|.
name|is_dst
argument_list|)
operator|)
condition|)
continue|continue;
block|}
endif|#
directive|endif
comment|/* check protocol */
if|if
condition|(
name|protocol
operator|>
literal|0
operator|&&
name|protocol
operator|!=
name|ips
operator|.
name|is_p
condition|)
continue|continue;
comment|/* check ports if protocol is TCP or UDP */
if|if
condition|(
operator|(
operator|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_TCP
operator|)
operator|||
operator|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_UDP
operator|)
operator|)
operator|&&
operator|(
operator|(
operator|(
name|sport
operator|>
literal|0
operator|)
operator|&&
operator|(
name|htons
argument_list|(
name|sport
argument_list|)
operator|!=
name|ips
operator|.
name|is_sport
operator|)
operator|)
operator|||
operator|(
operator|(
name|dport
operator|>
literal|0
operator|)
operator|&&
operator|(
name|htons
argument_list|(
name|dport
argument_list|)
operator|!=
name|ips
operator|.
name|is_dport
operator|)
operator|)
operator|)
condition|)
continue|continue;
comment|/* show closed TCP sessions ? */
if|if
condition|(
operator|(
name|topclosed
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_TCP
operator|)
operator|&&
operator|(
name|ips
operator|.
name|is_state
index|[
literal|0
index|]
operator|>=
name|IPF_TCPS_LAST_ACK
operator|)
operator|&&
operator|(
name|ips
operator|.
name|is_state
index|[
literal|1
index|]
operator|>=
name|IPF_TCPS_LAST_ACK
operator|)
condition|)
continue|continue;
comment|/* 			 * if necessary make room for this state 			 * entry 			 */
name|tsentry
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|maxtsentries
operator|||
name|tsentry
operator|==
name|maxtsentries
condition|)
block|{
name|maxtsentries
operator|+=
name|STGROWSIZE
expr_stmt|;
name|tstable
operator|=
name|reallocarray
argument_list|(
name|tstable
argument_list|,
name|maxtsentries
argument_list|,
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tstable
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
literal|"realloc"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* get max src/dest address string length */
name|len
operator|=
name|strlen
argument_list|(
name|getip
argument_list|(
name|ips
operator|.
name|is_v
argument_list|,
operator|&
name|ips
operator|.
name|is_src
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|srclen
operator|<
name|len
condition|)
name|srclen
operator|=
name|len
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|getip
argument_list|(
name|ips
operator|.
name|is_v
argument_list|,
operator|&
name|ips
operator|.
name|is_dst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dstlen
operator|<
name|len
condition|)
name|dstlen
operator|=
name|len
expr_stmt|;
comment|/* fill structure */
name|tp
operator|=
name|tstable
operator|+
name|tsentry
expr_stmt|;
name|tp
operator|->
name|st_src
operator|=
name|ips
operator|.
name|is_src
expr_stmt|;
name|tp
operator|->
name|st_dst
operator|=
name|ips
operator|.
name|is_dst
expr_stmt|;
name|tp
operator|->
name|st_p
operator|=
name|ips
operator|.
name|is_p
expr_stmt|;
name|tp
operator|->
name|st_v
operator|=
name|ips
operator|.
name|is_v
expr_stmt|;
name|tp
operator|->
name|st_state
index|[
literal|0
index|]
operator|=
name|ips
operator|.
name|is_state
index|[
literal|0
index|]
expr_stmt|;
name|tp
operator|->
name|st_state
index|[
literal|1
index|]
operator|=
name|ips
operator|.
name|is_state
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|forward
condition|)
block|{
name|tp
operator|->
name|st_pkts
operator|=
name|ips
operator|.
name|is_pkts
index|[
literal|0
index|]
operator|+
name|ips
operator|.
name|is_pkts
index|[
literal|1
index|]
expr_stmt|;
name|tp
operator|->
name|st_bytes
operator|=
name|ips
operator|.
name|is_bytes
index|[
literal|0
index|]
operator|+
name|ips
operator|.
name|is_bytes
index|[
literal|1
index|]
expr_stmt|;
block|}
else|else
block|{
name|tp
operator|->
name|st_pkts
operator|=
name|ips
operator|.
name|is_pkts
index|[
literal|2
index|]
operator|+
name|ips
operator|.
name|is_pkts
index|[
literal|3
index|]
expr_stmt|;
name|tp
operator|->
name|st_bytes
operator|=
name|ips
operator|.
name|is_bytes
index|[
literal|2
index|]
operator|+
name|ips
operator|.
name|is_bytes
index|[
literal|3
index|]
expr_stmt|;
block|}
name|tp
operator|->
name|st_age
operator|=
name|ips
operator|.
name|is_die
operator|-
name|ipsstp
operator|->
name|iss_ticks
expr_stmt|;
if|if
condition|(
operator|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_TCP
operator|)
operator|||
operator|(
name|ips
operator|.
name|is_p
operator|==
name|IPPROTO_UDP
operator|)
condition|)
block|{
name|tp
operator|->
name|st_sport
operator|=
name|ips
operator|.
name|is_sport
expr_stmt|;
name|tp
operator|->
name|st_dport
operator|=
name|ips
operator|.
name|is_dport
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|ioctl
argument_list|(
name|state_fd
argument_list|,
name|SIOCIPFDELTOK
argument_list|,
operator|&
name|token_type
argument_list|)
expr_stmt|;
comment|/* sort the array */
if|if
condition|(
name|tsentry
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|sorting
condition|)
block|{
case|case
name|STSORT_PR
case|:
name|qsort
argument_list|(
name|tstable
argument_list|,
name|tsentry
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|,
name|sort_p
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_PKTS
case|:
name|qsort
argument_list|(
name|tstable
argument_list|,
name|tsentry
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|,
name|sort_pkts
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_BYTES
case|:
name|qsort
argument_list|(
name|tstable
argument_list|,
name|tsentry
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|,
name|sort_bytes
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_TTL
case|:
name|qsort
argument_list|(
name|tstable
argument_list|,
name|tsentry
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|,
name|sort_ttl
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_SRCIP
case|:
name|qsort
argument_list|(
name|tstable
argument_list|,
name|tsentry
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|,
name|sort_srcip
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_SRCPT
case|:
name|qsort
argument_list|(
name|tstable
argument_list|,
name|tsentry
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|,
name|sort_srcpt
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_DSTIP
case|:
name|qsort
argument_list|(
name|tstable
argument_list|,
name|tsentry
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|,
name|sort_dstip
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_DSTPT
case|:
name|qsort
argument_list|(
name|tstable
argument_list|,
name|tsentry
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|statetop_t
argument_list|)
argument_list|,
name|sort_dstpt
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
comment|/* handle window resizes */
if|if
condition|(
name|handle_resize
condition|)
block|{
name|endwin
argument_list|()
expr_stmt|;
name|initscr
argument_list|()
expr_stmt|;
name|cbreak
argument_list|()
expr_stmt|;
name|noecho
argument_list|()
expr_stmt|;
name|curs_set
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|timeout
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|getmaxyx
argument_list|(
name|stdscr
argument_list|,
name|maxy
argument_list|,
name|maxx
argument_list|)
expr_stmt|;
name|redraw
operator|=
literal|1
expr_stmt|;
name|handle_resize
operator|=
literal|0
expr_stmt|;
block|}
comment|/* stop program? */
if|if
condition|(
name|handle_break
condition|)
break|break;
comment|/* print title */
name|erase
argument_list|()
expr_stmt|;
name|attron
argument_list|(
name|A_BOLD
argument_list|)
expr_stmt|;
name|winy
operator|=
literal|0
expr_stmt|;
name|move
argument_list|(
name|winy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%s - %s - state top"
argument_list|,
name|hostnm
argument_list|,
name|IPL_VERSION
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
operator|(
name|maxx
operator|-
literal|8
operator|-
name|strlen
argument_list|(
name|str1
argument_list|)
operator|)
operator|/
literal|2
condition|;
name|j
operator|++
control|)
name|printw
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"%s"
argument_list|,
name|str1
argument_list|)
expr_stmt|;
name|attroff
argument_list|(
name|A_BOLD
argument_list|)
expr_stmt|;
comment|/* just for fun add a clock */
name|move
argument_list|(
name|winy
argument_list|,
name|maxx
operator|-
literal|8
argument_list|)
expr_stmt|;
name|t
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|strftime
argument_list|(
name|str1
argument_list|,
literal|80
argument_list|,
literal|"%T"
argument_list|,
name|localtime
argument_list|(
operator|&
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"%s\n"
argument_list|,
name|str1
argument_list|)
expr_stmt|;
comment|/* 		 * print the display filters, this is placed in the loop, 		 * because someday I might add code for changing these 		 * while the programming is running :-) 		 */
if|if
condition|(
name|sport
operator|>=
literal|0
condition|)
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%s,%d"
argument_list|,
name|getip
argument_list|(
name|ver
argument_list|,
operator|&
name|saddr
argument_list|)
argument_list|,
name|sport
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%s"
argument_list|,
name|getip
argument_list|(
name|ver
argument_list|,
operator|&
name|saddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dport
operator|>=
literal|0
condition|)
name|sprintf
argument_list|(
name|str2
argument_list|,
literal|"%s,%d"
argument_list|,
name|getip
argument_list|(
name|ver
argument_list|,
operator|&
name|daddr
argument_list|)
argument_list|,
name|dport
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|str2
argument_list|,
literal|"%s"
argument_list|,
name|getip
argument_list|(
name|ver
argument_list|,
operator|&
name|daddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|protocol
operator|<
literal|0
condition|)
name|strcpy
argument_list|(
name|str3
argument_list|,
literal|"any"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|proto
operator|=
name|getprotobynumber
argument_list|(
name|protocol
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|sprintf
argument_list|(
name|str3
argument_list|,
literal|"%s"
argument_list|,
name|proto
operator|->
name|p_name
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|str3
argument_list|,
literal|"%d"
argument_list|,
name|protocol
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sorting
condition|)
block|{
case|case
name|STSORT_PR
case|:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"proto"
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_PKTS
case|:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"# pkts"
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_BYTES
case|:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"# bytes"
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_TTL
case|:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"ttl"
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_SRCIP
case|:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"src ip"
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_SRCPT
case|:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"src port"
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_DSTIP
case|:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"dest ip"
argument_list|)
expr_stmt|;
break|break;
case|case
name|STSORT_DSTPT
case|:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"dest port"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|sprintf
argument_list|(
name|str4
argument_list|,
literal|"unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|reverse
condition|)
name|strcat
argument_list|(
name|str4
argument_list|,
literal|" (reverse)"
argument_list|)
expr_stmt|;
name|winy
operator|+=
literal|2
expr_stmt|;
name|move
argument_list|(
name|winy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"Src: %s, Dest: %s, Proto: %s, Sorted by: %s\n\n"
argument_list|,
name|str1
argument_list|,
name|str2
argument_list|,
name|str3
argument_list|,
name|str4
argument_list|)
expr_stmt|;
comment|/* 		 * For an IPv4 IP address we need at most 15 characters, 		 * 4 tuples of 3 digits, separated by 3 dots. Enforce this 		 * length, so the colums do not change positions based 		 * on the size of the IP address. This length makes the 		 * output fit in a 80 column terminal. 		 * We are lacking a good solution for IPv6 addresses (that 		 * can be longer that 15 characters), so we do not enforce 		 * a maximum on the IP field size. 		 */
if|if
condition|(
name|srclen
operator|<
literal|15
condition|)
name|srclen
operator|=
literal|15
expr_stmt|;
if|if
condition|(
name|dstlen
operator|<
literal|15
condition|)
name|dstlen
operator|=
literal|15
expr_stmt|;
comment|/* print column description */
name|winy
operator|+=
literal|2
expr_stmt|;
name|move
argument_list|(
name|winy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|attron
argument_list|(
name|A_BOLD
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"%-*s %-*s %3s %4s %7s %9s %9s\n"
argument_list|,
name|srclen
operator|+
literal|6
argument_list|,
literal|"Source IP"
argument_list|,
name|dstlen
operator|+
literal|6
argument_list|,
literal|"Destination IP"
argument_list|,
literal|"ST"
argument_list|,
literal|"PR"
argument_list|,
literal|"#pkts"
argument_list|,
literal|"#bytes"
argument_list|,
literal|"ttl"
argument_list|)
expr_stmt|;
name|attroff
argument_list|(
name|A_BOLD
argument_list|)
expr_stmt|;
comment|/* print all the entries */
name|tp
operator|=
name|tstable
expr_stmt|;
if|if
condition|(
name|reverse
condition|)
name|tp
operator|+=
name|tsentry
expr_stmt|;
if|if
condition|(
name|tsentry
operator|>
name|maxy
operator|-
literal|6
condition|)
name|tsentry
operator|=
name|maxy
operator|-
literal|6
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|tsentry
condition|;
name|i
operator|++
control|)
block|{
comment|/* print src/dest and port */
if|if
condition|(
operator|(
name|tp
operator|->
name|st_p
operator|==
name|IPPROTO_TCP
operator|)
operator|||
operator|(
name|tp
operator|->
name|st_p
operator|==
name|IPPROTO_UDP
operator|)
condition|)
block|{
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%s,%hu"
argument_list|,
name|getip
argument_list|(
name|tp
operator|->
name|st_v
argument_list|,
operator|&
name|tp
operator|->
name|st_src
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|tp
operator|->
name|st_sport
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|str2
argument_list|,
literal|"%s,%hu"
argument_list|,
name|getip
argument_list|(
name|tp
operator|->
name|st_v
argument_list|,
operator|&
name|tp
operator|->
name|st_dst
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|tp
operator|->
name|st_dport
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%s"
argument_list|,
name|getip
argument_list|(
name|tp
operator|->
name|st_v
argument_list|,
operator|&
name|tp
operator|->
name|st_src
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|str2
argument_list|,
literal|"%s"
argument_list|,
name|getip
argument_list|(
name|tp
operator|->
name|st_v
argument_list|,
operator|&
name|tp
operator|->
name|st_dst
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|winy
operator|++
expr_stmt|;
name|move
argument_list|(
name|winy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"%-*s %-*s"
argument_list|,
name|srclen
operator|+
literal|6
argument_list|,
name|str1
argument_list|,
name|dstlen
operator|+
literal|6
argument_list|,
name|str2
argument_list|)
expr_stmt|;
comment|/* print state */
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%X/%X"
argument_list|,
name|tp
operator|->
name|st_state
index|[
literal|0
index|]
argument_list|,
name|tp
operator|->
name|st_state
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|" %3s"
argument_list|,
name|str1
argument_list|)
expr_stmt|;
comment|/* print protocol */
name|proto
operator|=
name|getprotobynumber
argument_list|(
name|tp
operator|->
name|st_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
condition|)
block|{
name|strncpy
argument_list|(
name|str1
argument_list|,
name|proto
operator|->
name|p_name
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|str1
index|[
literal|4
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|str1
argument_list|,
literal|"%d"
argument_list|,
name|tp
operator|->
name|st_p
argument_list|)
expr_stmt|;
block|}
comment|/* just print icmp for IPv6-ICMP */
if|if
condition|(
name|tp
operator|->
name|st_p
operator|==
name|IPPROTO_ICMPV6
condition|)
name|strcpy
argument_list|(
name|str1
argument_list|,
literal|"icmp"
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|" %4s"
argument_list|,
name|str1
argument_list|)
expr_stmt|;
comment|/* print #pkt/#bytes */
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|printw
argument_list|(
literal|" %7qu %9qu"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|tp
operator|->
name|st_pkts
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|tp
operator|->
name|st_bytes
argument_list|)
expr_stmt|;
else|#
directive|else
name|printw
argument_list|(
literal|" %7lu %9lu"
argument_list|,
name|tp
operator|->
name|st_pkts
argument_list|,
name|tp
operator|->
name|st_bytes
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printw
argument_list|(
literal|" %9s"
argument_list|,
name|ttl_to_string
argument_list|(
name|tp
operator|->
name|st_age
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reverse
condition|)
name|tp
operator|--
expr_stmt|;
else|else
name|tp
operator|++
expr_stmt|;
block|}
comment|/* screen data structure is filled, now update the screen */
if|if
condition|(
name|redraw
condition|)
name|clearok
argument_list|(
name|stdscr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|refresh
argument_list|()
operator|==
name|ERR
condition|)
break|break;
if|if
condition|(
name|redraw
condition|)
block|{
name|clearok
argument_list|(
name|stdscr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|redraw
operator|=
literal|0
expr_stmt|;
block|}
comment|/* wait for key press or a 1 second time out period */
name|selecttimeout
operator|.
name|tv_sec
operator|=
name|refreshtime
expr_stmt|;
name|selecttimeout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|readfd
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
literal|0
argument_list|,
operator|&
name|readfd
argument_list|)
expr_stmt|;
name|select
argument_list|(
literal|1
argument_list|,
operator|&
name|readfd
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|selecttimeout
argument_list|)
expr_stmt|;
comment|/* if key pressed, read all waiting keys */
if|if
condition|(
name|FD_ISSET
argument_list|(
literal|0
argument_list|,
operator|&
name|readfd
argument_list|)
condition|)
block|{
name|c
operator|=
name|wgetch
argument_list|(
name|stdscr
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|ERR
condition|)
continue|continue;
if|if
condition|(
name|ISALPHA
argument_list|(
name|c
argument_list|)
operator|&&
name|ISUPPER
argument_list|(
name|c
argument_list|)
condition|)
name|c
operator|=
name|TOLOWER
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'l'
condition|)
block|{
name|redraw
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'q'
condition|)
block|{
break|break;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'r'
condition|)
block|{
name|reverse
operator|=
operator|!
name|reverse
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'b'
condition|)
block|{
name|forward
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'f'
condition|)
block|{
name|forward
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'s'
condition|)
block|{
if|if
condition|(
operator|++
name|sorting
operator|>
name|STSORT_MAX
condition|)
name|sorting
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
comment|/* while */
name|out
label|:
name|printw
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|curs_set
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* nocbreak(); XXX - endwin() should make this redundant */
name|endwin
argument_list|()
expr_stmt|;
name|free
argument_list|(
name|tstable
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
name|perror
argument_list|(
name|errstr
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Show fragment cache information that's held in the kernel.  */
end_comment

begin_function
specifier|static
name|void
name|showfrstates
parameter_list|(
name|ifsp
parameter_list|,
name|ticks
parameter_list|)
name|ipfrstat_t
modifier|*
name|ifsp
decl_stmt|;
name|u_long
name|ticks
decl_stmt|;
block|{
name|struct
name|ipfr
modifier|*
name|ipfrtab
index|[
name|IPFT_SIZE
index|]
decl_stmt|,
name|ifr
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* 	 * print out the numeric statistics 	 */
name|PRINTF
argument_list|(
literal|"IP fragment states:\n%lu\tnew\n%lu\texpired\n%lu\thits\n"
argument_list|,
name|ifsp
operator|->
name|ifs_new
argument_list|,
name|ifsp
operator|->
name|ifs_expire
argument_list|,
name|ifsp
operator|->
name|ifs_hits
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tretrans\n%lu\ttoo short\n"
argument_list|,
name|ifsp
operator|->
name|ifs_retrans0
argument_list|,
name|ifsp
operator|->
name|ifs_short
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tno memory\n%lu\talready exist\n"
argument_list|,
name|ifsp
operator|->
name|ifs_nomem
argument_list|,
name|ifsp
operator|->
name|ifs_exists
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%lu\tinuse\n"
argument_list|,
name|ifsp
operator|->
name|ifs_inuse
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|live_kernel
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ipfrtab
argument_list|,
operator|(
name|u_long
operator|)
name|ifsp
operator|->
name|ifs_table
argument_list|,
sizeof|sizeof
argument_list|(
name|ipfrtab
argument_list|)
argument_list|)
condition|)
return|return;
block|}
comment|/* 	 * Print out the contents (if any) of the fragment cache table. 	 */
if|if
condition|(
name|live_kernel
operator|==
literal|1
condition|)
block|{
do|do
block|{
if|if
condition|(
name|fetchfrag
argument_list|(
name|ipf_fd
argument_list|,
name|IPFGENITER_FRAG
argument_list|,
operator|&
name|ifr
argument_list|)
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
name|ifr
operator|.
name|ipfr_ifp
operator|==
name|NULL
condition|)
break|break;
name|ifr
operator|.
name|ipfr_ttl
operator|-=
name|ticks
expr_stmt|;
name|printfraginfo
argument_list|(
literal|""
argument_list|,
operator|&
name|ifr
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|ifr
operator|.
name|ipfr_next
operator|!=
name|NULL
condition|)
do|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IPFT_SIZE
condition|;
name|i
operator|++
control|)
while|while
condition|(
name|ipfrtab
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ifr
argument_list|,
operator|(
name|u_long
operator|)
name|ipfrtab
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
break|break;
name|printfraginfo
argument_list|(
literal|""
argument_list|,
operator|&
name|ifr
argument_list|)
expr_stmt|;
name|ipfrtab
index|[
name|i
index|]
operator|=
name|ifr
operator|.
name|ipfr_next
expr_stmt|;
block|}
block|}
comment|/* 	 * Print out the contents (if any) of the NAT fragment cache table. 	 */
if|if
condition|(
name|live_kernel
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ipfrtab
argument_list|,
operator|(
name|u_long
operator|)
name|ifsp
operator|->
name|ifs_nattab
argument_list|,
sizeof|sizeof
argument_list|(
name|ipfrtab
argument_list|)
argument_list|)
condition|)
return|return;
block|}
if|if
condition|(
name|live_kernel
operator|==
literal|1
condition|)
block|{
do|do
block|{
if|if
condition|(
name|fetchfrag
argument_list|(
name|nat_fd
argument_list|,
name|IPFGENITER_NATFRAG
argument_list|,
operator|&
name|ifr
argument_list|)
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
name|ifr
operator|.
name|ipfr_ifp
operator|==
name|NULL
condition|)
break|break;
name|ifr
operator|.
name|ipfr_ttl
operator|-=
name|ticks
expr_stmt|;
name|printfraginfo
argument_list|(
literal|"NAT: "
argument_list|,
operator|&
name|ifr
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|ifr
operator|.
name|ipfr_next
operator|!=
name|NULL
condition|)
do|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IPFT_SIZE
condition|;
name|i
operator|++
control|)
while|while
condition|(
name|ipfrtab
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ifr
argument_list|,
operator|(
name|u_long
operator|)
name|ipfrtab
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
break|break;
name|printfraginfo
argument_list|(
literal|"NAT: "
argument_list|,
operator|&
name|ifr
argument_list|)
expr_stmt|;
name|ipfrtab
index|[
name|i
index|]
operator|=
name|ifr
operator|.
name|ipfr_next
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Show stats on how auth within IPFilter has been used  */
end_comment

begin_function
specifier|static
name|void
name|showauthstates
parameter_list|(
name|asp
parameter_list|)
name|ipf_authstat_t
modifier|*
name|asp
decl_stmt|;
block|{
name|frauthent_t
modifier|*
name|frap
decl_stmt|,
name|fra
decl_stmt|;
name|ipfgeniter_t
name|auth
decl_stmt|;
name|ipfobj_t
name|obj
decl_stmt|;
name|obj
operator|.
name|ipfo_rev
operator|=
name|IPFILTER_VERSION
expr_stmt|;
name|obj
operator|.
name|ipfo_type
operator|=
name|IPFOBJ_GENITER
expr_stmt|;
name|obj
operator|.
name|ipfo_size
operator|=
sizeof|sizeof
argument_list|(
name|auth
argument_list|)
expr_stmt|;
name|obj
operator|.
name|ipfo_ptr
operator|=
operator|&
name|auth
expr_stmt|;
name|auth
operator|.
name|igi_type
operator|=
name|IPFGENITER_AUTH
expr_stmt|;
name|auth
operator|.
name|igi_nitems
operator|=
literal|1
expr_stmt|;
name|auth
operator|.
name|igi_data
operator|=
operator|&
name|fra
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|printf
argument_list|(
literal|"Authorisation hits: %"
name|PRIu64
literal|"\tmisses %"
name|PRIu64
literal|"\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|asp
operator|->
name|fas_hits
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|asp
operator|->
name|fas_miss
argument_list|)
expr_stmt|;
else|#
directive|else
name|printf
argument_list|(
literal|"Authorisation hits: %ld\tmisses %ld\n"
argument_list|,
name|asp
operator|->
name|fas_hits
argument_list|,
name|asp
operator|->
name|fas_miss
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"nospace %ld\nadded %ld\nsendfail %ld\nsendok %ld\n"
argument_list|,
name|asp
operator|->
name|fas_nospace
argument_list|,
name|asp
operator|->
name|fas_added
argument_list|,
name|asp
operator|->
name|fas_sendfail
argument_list|,
name|asp
operator|->
name|fas_sendok
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"queok %ld\nquefail %ld\nexpire %ld\n"
argument_list|,
name|asp
operator|->
name|fas_queok
argument_list|,
name|asp
operator|->
name|fas_quefail
argument_list|,
name|asp
operator|->
name|fas_expire
argument_list|)
expr_stmt|;
name|frap
operator|=
name|asp
operator|->
name|fas_faelist
expr_stmt|;
while|while
condition|(
name|frap
condition|)
block|{
if|if
condition|(
name|live_kernel
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|auth_fd
argument_list|,
name|SIOCGENITER
argument_list|,
operator|&
name|obj
argument_list|)
condition|)
break|break;
block|}
else|else
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fra
argument_list|,
operator|(
name|u_long
operator|)
name|frap
argument_list|,
sizeof|sizeof
argument_list|(
name|fra
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
break|break;
block|}
name|printf
argument_list|(
literal|"age %ld\t"
argument_list|,
name|fra
operator|.
name|fae_age
argument_list|)
expr_stmt|;
name|printfr
argument_list|(
operator|&
name|fra
operator|.
name|fae_fr
argument_list|,
name|ioctl
argument_list|)
expr_stmt|;
name|frap
operator|=
name|fra
operator|.
name|fae_next
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Display groups used for each of filter rules, accounting rules and  * authentication, separately.  */
end_comment

begin_function
specifier|static
name|void
name|showgroups
parameter_list|(
name|fiop
parameter_list|)
name|struct
name|friostat
modifier|*
name|fiop
decl_stmt|;
block|{
specifier|static
name|char
modifier|*
name|gnames
index|[
literal|3
index|]
init|=
block|{
literal|"Filter"
block|,
literal|"Accounting"
block|,
literal|"Authentication"
block|}
decl_stmt|;
specifier|static
name|int
name|gnums
index|[
literal|3
index|]
init|=
block|{
name|IPL_LOGIPF
block|,
name|IPL_LOGCOUNT
block|,
name|IPL_LOGAUTH
block|}
decl_stmt|;
name|frgroup_t
modifier|*
name|fp
decl_stmt|,
name|grp
decl_stmt|;
name|int
name|on
decl_stmt|,
name|off
decl_stmt|,
name|i
decl_stmt|;
name|on
operator|=
name|fiop
operator|->
name|f_active
expr_stmt|;
name|off
operator|=
literal|1
operator|-
name|on
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%s groups (active):\n"
argument_list|,
name|gnames
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|fiop
operator|->
name|f_groups
index|[
name|gnums
index|[
name|i
index|]
index|]
index|[
name|on
index|]
init|;
name|fp
operator|!=
name|NULL
condition|;
name|fp
operator|=
name|grp
operator|.
name|fg_next
control|)
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|grp
argument_list|,
operator|(
name|u_long
operator|)
name|fp
argument_list|,
sizeof|sizeof
argument_list|(
name|grp
argument_list|)
argument_list|)
condition|)
break|break;
else|else
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|grp
operator|.
name|fg_name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s groups (inactive):\n"
argument_list|,
name|gnames
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|fiop
operator|->
name|f_groups
index|[
name|gnums
index|[
name|i
index|]
index|]
index|[
name|off
index|]
init|;
name|fp
operator|!=
name|NULL
condition|;
name|fp
operator|=
name|grp
operator|.
name|fg_next
control|)
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|grp
argument_list|,
operator|(
name|u_long
operator|)
name|fp
argument_list|,
sizeof|sizeof
argument_list|(
name|grp
argument_list|)
argument_list|)
condition|)
break|break;
else|else
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|grp
operator|.
name|fg_name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|parse_ipportstr
parameter_list|(
name|argument
parameter_list|,
name|ip
parameter_list|,
name|port
parameter_list|)
specifier|const
name|char
modifier|*
name|argument
decl_stmt|;
name|i6addr_t
modifier|*
name|ip
decl_stmt|;
name|int
modifier|*
name|port
decl_stmt|;
block|{
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|comma
decl_stmt|;
name|int
name|ok
init|=
literal|0
decl_stmt|;
comment|/* make working copy of argument, Theoretically you must be able 	 * to write to optarg, but that seems very ugly to me.... 	 */
name|s
operator|=
name|strdup
argument_list|(
name|argument
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
return|return;
comment|/* get port */
if|if
condition|(
operator|(
name|comma
operator|=
name|strchr
argument_list|(
name|s
argument_list|,
literal|','
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|comma
operator|+
literal|1
argument_list|,
literal|"any"
argument_list|)
condition|)
block|{
operator|*
name|port
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|sscanf
argument_list|(
name|comma
operator|+
literal|1
argument_list|,
literal|"%d"
argument_list|,
name|port
argument_list|)
operator|||
operator|(
operator|*
name|port
operator|<
literal|0
operator|)
operator|||
operator|(
operator|*
name|port
operator|>
literal|65535
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid port specification in %s\n"
argument_list|,
name|argument
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
operator|*
name|comma
operator|=
literal|'\0'
expr_stmt|;
block|}
comment|/* get ip address */
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|s
argument_list|,
literal|"any"
argument_list|)
condition|)
block|{
name|ip
operator|->
name|in4
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_INET6
name|ip
operator|->
name|in6
operator|=
name|in6addr_any
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|use_inet6
operator|&&
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|s
argument_list|,
operator|&
name|ip
operator|->
name|in6
argument_list|)
condition|)
block|{
name|ok
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|inet_aton
argument_list|(
name|s
argument_list|,
operator|&
name|ip
operator|->
name|in4
argument_list|)
condition|)
name|ok
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ok
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid IP address: %s\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* free allocated memory */
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|STATETOP
end_ifdef

begin_function
specifier|static
name|void
name|sig_resize
parameter_list|(
name|s
parameter_list|)
name|int
name|s
decl_stmt|;
block|{
name|handle_resize
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sig_break
parameter_list|(
name|s
parameter_list|)
name|int
name|s
decl_stmt|;
block|{
name|handle_break
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|getip
parameter_list|(
name|v
parameter_list|,
name|addr
parameter_list|)
name|int
name|v
decl_stmt|;
name|i6addr_t
modifier|*
name|addr
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|USE_INET6
specifier|static
name|char
name|hostbuf
index|[
name|MAXHOSTNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|v
operator|==
literal|4
condition|)
return|return
name|inet_ntoa
argument_list|(
name|addr
operator|->
name|in4
argument_list|)
return|;
ifdef|#
directive|ifdef
name|USE_INET6
operator|(
name|void
operator|)
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
name|addr
operator|->
name|in6
argument_list|,
name|hostbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|hostbuf
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|hostbuf
index|[
name|MAXHOSTNAMELEN
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|hostbuf
return|;
else|#
directive|else
return|return
literal|"IPv6"
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ttl_to_string
parameter_list|(
name|ttl
parameter_list|)
name|long
name|int
name|ttl
decl_stmt|;
block|{
specifier|static
name|char
name|ttlbuf
index|[
name|STSTRSIZE
index|]
decl_stmt|;
name|int
name|hours
decl_stmt|,
name|minutes
decl_stmt|,
name|seconds
decl_stmt|;
comment|/* ttl is in half seconds */
name|ttl
operator|/=
literal|2
expr_stmt|;
name|hours
operator|=
name|ttl
operator|/
literal|3600
expr_stmt|;
name|ttl
operator|=
name|ttl
operator|%
literal|3600
expr_stmt|;
name|minutes
operator|=
name|ttl
operator|/
literal|60
expr_stmt|;
name|seconds
operator|=
name|ttl
operator|%
literal|60
expr_stmt|;
if|if
condition|(
name|hours
operator|>
literal|0
condition|)
name|sprintf
argument_list|(
name|ttlbuf
argument_list|,
literal|"%2d:%02d:%02d"
argument_list|,
name|hours
argument_list|,
name|minutes
argument_list|,
name|seconds
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|ttlbuf
argument_list|,
literal|"%2d:%02d"
argument_list|,
name|minutes
argument_list|,
name|seconds
argument_list|)
expr_stmt|;
return|return
name|ttlbuf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sort_pkts
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
specifier|const
name|void
modifier|*
name|a
decl_stmt|;
specifier|const
name|void
modifier|*
name|b
decl_stmt|;
block|{
specifier|register
specifier|const
name|statetop_t
modifier|*
name|ap
init|=
name|a
decl_stmt|;
specifier|register
specifier|const
name|statetop_t
modifier|*
name|bp
init|=
name|b
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|st_pkts
operator|==
name|bp
operator|->
name|st_pkts
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|ap
operator|->
name|st_pkts
operator|<
name|bp
operator|->
name|st_pkts
condition|)
return|return
literal|1
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sort_bytes
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
specifier|const
name|void
modifier|*
name|a
decl_stmt|;
specifier|const
name|void
modifier|*
name|b
decl_stmt|;
block|{
specifier|register
specifier|const
name|statetop_t
modifier|*
name|ap
init|=
name|a
decl_stmt|;
specifier|register
specifier|const
name|statetop_t
modifier|*
name|bp
init|=
name|b
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|st_bytes
operator|==
name|bp
operator|->
name|st_bytes
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|ap
operator|->
name|st_bytes
operator|<
name|bp
operator|->
name|st_bytes
condition|)
return|return
literal|1
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sort_p
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
specifier|const
name|void
modifier|*
name|a
decl_stmt|;
specifier|const
name|void
modifier|*
name|b
decl_stmt|;
block|{
specifier|register
specifier|const
name|statetop_t
modifier|*
name|ap
init|=
name|a
decl_stmt|;
specifier|register
specifier|const
name|statetop_t
modifier|*
name|bp
init|=
name|b
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|st_p
operator|==
name|bp
operator|->
name|st_p
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|ap
operator|->
name|st_p
operator|<
name|bp
operator|->
name|st_p
condition|)
return|return
literal|1
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sort_ttl
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
specifier|const
name|void
modifier|*
name|a
decl_stmt|;
specifier|const
name|void
modifier|*
name|b
decl_stmt|;
block|{
specifier|register
specifier|const
name|statetop_t
modifier|*
name|ap
init|=
name|a
decl_stmt|;
specifier|register
specifier|const
name|statetop_t
modifier|*
name|bp
init|=
name|b
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|st_age
operator|==
name|bp
operator|->
name|st_age
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|ap
operator|->
name|st_age
operator|<
name|bp
operator|->
name|st_age
condition|)
return|return
literal|1
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sort_srcip
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
specifier|const
name|void
modifier|*
name|a
decl_stmt|;
specifier|const
name|void
modifier|*
name|b
decl_stmt|;
block|{
specifier|register
specifier|const
name|statetop_t
modifier|*
name|ap
init|=
name|a
decl_stmt|;
specifier|register
specifier|const
name|statetop_t
modifier|*
name|bp
init|=
name|b
decl_stmt|;
ifdef|#
directive|ifdef
name|USE_INET6
if|if
condition|(
name|use_inet6
condition|)
block|{
if|if
condition|(
name|IP6_EQ
argument_list|(
operator|&
name|ap
operator|->
name|st_src
argument_list|,
operator|&
name|bp
operator|->
name|st_src
argument_list|)
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|IP6_GT
argument_list|(
operator|&
name|ap
operator|->
name|st_src
argument_list|,
operator|&
name|bp
operator|->
name|st_src
argument_list|)
condition|)
return|return
literal|1
return|;
block|}
else|else
endif|#
directive|endif
block|{
if|if
condition|(
name|ntohl
argument_list|(
name|ap
operator|->
name|st_src
operator|.
name|in4
operator|.
name|s_addr
argument_list|)
operator|==
name|ntohl
argument_list|(
name|bp
operator|->
name|st_src
operator|.
name|in4
operator|.
name|s_addr
argument_list|)
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|ntohl
argument_list|(
name|ap
operator|->
name|st_src
operator|.
name|in4
operator|.
name|s_addr
argument_list|)
operator|>
name|ntohl
argument_list|(
name|bp
operator|->
name|st_src
operator|.
name|in4
operator|.
name|s_addr
argument_list|)
condition|)
return|return
literal|1
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sort_srcpt
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
specifier|const
name|void
modifier|*
name|a
decl_stmt|;
specifier|const
name|void
modifier|*
name|b
decl_stmt|;
block|{
specifier|register
specifier|const
name|statetop_t
modifier|*
name|ap
init|=
name|a
decl_stmt|;
specifier|register
specifier|const
name|statetop_t
modifier|*
name|bp
init|=
name|b
decl_stmt|;
if|if
condition|(
name|htons
argument_list|(
name|ap
operator|->
name|st_sport
argument_list|)
operator|==
name|htons
argument_list|(
name|bp
operator|->
name|st_sport
argument_list|)
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|htons
argument_list|(
name|ap
operator|->
name|st_sport
argument_list|)
operator|>
name|htons
argument_list|(
name|bp
operator|->
name|st_sport
argument_list|)
condition|)
return|return
literal|1
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sort_dstip
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
specifier|const
name|void
modifier|*
name|a
decl_stmt|;
specifier|const
name|void
modifier|*
name|b
decl_stmt|;
block|{
specifier|register
specifier|const
name|statetop_t
modifier|*
name|ap
init|=
name|a
decl_stmt|;
specifier|register
specifier|const
name|statetop_t
modifier|*
name|bp
init|=
name|b
decl_stmt|;
ifdef|#
directive|ifdef
name|USE_INET6
if|if
condition|(
name|use_inet6
condition|)
block|{
if|if
condition|(
name|IP6_EQ
argument_list|(
operator|&
name|ap
operator|->
name|st_dst
argument_list|,
operator|&
name|bp
operator|->
name|st_dst
argument_list|)
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|IP6_GT
argument_list|(
operator|&
name|ap
operator|->
name|st_dst
argument_list|,
operator|&
name|bp
operator|->
name|st_dst
argument_list|)
condition|)
return|return
literal|1
return|;
block|}
else|else
endif|#
directive|endif
block|{
if|if
condition|(
name|ntohl
argument_list|(
name|ap
operator|->
name|st_dst
operator|.
name|in4
operator|.
name|s_addr
argument_list|)
operator|==
name|ntohl
argument_list|(
name|bp
operator|->
name|st_dst
operator|.
name|in4
operator|.
name|s_addr
argument_list|)
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|ntohl
argument_list|(
name|ap
operator|->
name|st_dst
operator|.
name|in4
operator|.
name|s_addr
argument_list|)
operator|>
name|ntohl
argument_list|(
name|bp
operator|->
name|st_dst
operator|.
name|in4
operator|.
name|s_addr
argument_list|)
condition|)
return|return
literal|1
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sort_dstpt
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
specifier|const
name|void
modifier|*
name|a
decl_stmt|;
specifier|const
name|void
modifier|*
name|b
decl_stmt|;
block|{
specifier|register
specifier|const
name|statetop_t
modifier|*
name|ap
init|=
name|a
decl_stmt|;
specifier|register
specifier|const
name|statetop_t
modifier|*
name|bp
init|=
name|b
decl_stmt|;
if|if
condition|(
name|htons
argument_list|(
name|ap
operator|->
name|st_dport
argument_list|)
operator|==
name|htons
argument_list|(
name|bp
operator|->
name|st_dport
argument_list|)
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|htons
argument_list|(
name|ap
operator|->
name|st_dport
argument_list|)
operator|>
name|htons
argument_list|(
name|bp
operator|->
name|st_dport
argument_list|)
condition|)
return|return
literal|1
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|ipstate_t
modifier|*
name|fetchstate
parameter_list|(
name|src
parameter_list|,
name|dst
parameter_list|)
name|ipstate_t
modifier|*
name|src
decl_stmt|,
decl|*
name|dst
decl_stmt|;
end_function

begin_block
block|{
if|if
condition|(
name|live_kernel
operator|==
literal|1
condition|)
block|{
name|ipfgeniter_t
name|state
decl_stmt|;
name|ipfobj_t
name|obj
decl_stmt|;
name|obj
operator|.
name|ipfo_rev
operator|=
name|IPFILTER_VERSION
expr_stmt|;
name|obj
operator|.
name|ipfo_type
operator|=
name|IPFOBJ_GENITER
expr_stmt|;
name|obj
operator|.
name|ipfo_size
operator|=
sizeof|sizeof
argument_list|(
name|state
argument_list|)
expr_stmt|;
name|obj
operator|.
name|ipfo_ptr
operator|=
operator|&
name|state
expr_stmt|;
name|state
operator|.
name|igi_type
operator|=
name|IPFGENITER_STATE
expr_stmt|;
name|state
operator|.
name|igi_nitems
operator|=
literal|1
expr_stmt|;
name|state
operator|.
name|igi_data
operator|=
name|dst
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|state_fd
argument_list|,
name|SIOCGENITER
argument_list|,
operator|&
name|obj
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|dst
operator|->
name|is_next
operator|==
name|NULL
condition|)
block|{
name|int
name|n
init|=
name|IPFGENITER_STATE
decl_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
name|ipf_fd
argument_list|,
name|SIOCIPFDELTOK
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dst
argument_list|,
operator|(
name|u_long
operator|)
name|src
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dst
argument_list|)
argument_list|)
condition|)
return|return
name|NULL
return|;
block|}
return|return
name|dst
return|;
block|}
end_block

begin_function
specifier|static
name|int
name|fetchfrag
parameter_list|(
name|fd
parameter_list|,
name|type
parameter_list|,
name|frp
parameter_list|)
name|int
name|fd
decl_stmt|,
name|type
decl_stmt|;
name|ipfr_t
modifier|*
name|frp
decl_stmt|;
block|{
name|ipfgeniter_t
name|frag
decl_stmt|;
name|ipfobj_t
name|obj
decl_stmt|;
name|obj
operator|.
name|ipfo_rev
operator|=
name|IPFILTER_VERSION
expr_stmt|;
name|obj
operator|.
name|ipfo_type
operator|=
name|IPFOBJ_GENITER
expr_stmt|;
name|obj
operator|.
name|ipfo_size
operator|=
sizeof|sizeof
argument_list|(
name|frag
argument_list|)
expr_stmt|;
name|obj
operator|.
name|ipfo_ptr
operator|=
operator|&
name|frag
expr_stmt|;
name|frag
operator|.
name|igi_type
operator|=
name|type
expr_stmt|;
name|frag
operator|.
name|igi_nitems
operator|=
literal|1
expr_stmt|;
name|frag
operator|.
name|igi_data
operator|=
name|frp
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCGENITER
argument_list|,
operator|&
name|obj
argument_list|)
condition|)
return|return
name|EFAULT
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|state_matcharray
parameter_list|(
name|stp
parameter_list|,
name|array
parameter_list|)
name|ipstate_t
modifier|*
name|stp
decl_stmt|;
name|int
modifier|*
name|array
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|n
decl_stmt|,
modifier|*
name|x
decl_stmt|,
name|rv
decl_stmt|,
name|p
decl_stmt|;
name|ipfexp_t
modifier|*
name|e
decl_stmt|;
name|rv
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|n
operator|=
name|array
index|[
literal|0
index|]
operator|,
name|x
operator|=
name|array
operator|+
literal|1
init|;
name|n
operator|>
literal|0
condition|;
name|x
operator|+=
name|e
operator|->
name|ipfe_size
control|)
block|{
name|e
operator|=
operator|(
name|ipfexp_t
operator|*
operator|)
name|x
expr_stmt|;
if|if
condition|(
name|e
operator|->
name|ipfe_cmd
operator|==
name|IPF_EXP_END
condition|)
break|break;
name|n
operator|-=
name|e
operator|->
name|ipfe_size
expr_stmt|;
name|rv
operator|=
literal|0
expr_stmt|;
comment|/* 		 * The upper 16 bits currently store the protocol value. 		 * This is currently used with TCP and UDP port compares and 		 * allows "tcp.port = 80" without requiring an explicit 		 " "ip.pr = tcp" first. 		 */
name|p
operator|=
name|e
operator|->
name|ipfe_cmd
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|p
operator|!=
name|stp
operator|->
name|is_p
operator|)
condition|)
break|break;
switch|switch
condition|(
name|e
operator|->
name|ipfe_cmd
condition|)
block|{
case|case
name|IPF_EXP_IP_PR
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|rv
operator|&&
name|i
operator|<
name|e
operator|->
name|ipfe_narg
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator||=
operator|(
name|stp
operator|->
name|is_p
operator|==
name|e
operator|->
name|ipfe_arg0
index|[
name|i
index|]
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|IPF_EXP_IP_SRCADDR
case|:
if|if
condition|(
name|stp
operator|->
name|is_v
operator|!=
literal|4
condition|)
break|break;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|rv
operator|&&
name|i
operator|<
name|e
operator|->
name|ipfe_narg
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator||=
operator|(
operator|(
name|stp
operator|->
name|is_saddr
operator|&
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|)
operator|==
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|2
index|]
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|IPF_EXP_IP_DSTADDR
case|:
if|if
condition|(
name|stp
operator|->
name|is_v
operator|!=
literal|4
condition|)
break|break;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|rv
operator|&&
name|i
operator|<
name|e
operator|->
name|ipfe_narg
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator||=
operator|(
operator|(
name|stp
operator|->
name|is_daddr
operator|&
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|)
operator|==
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|2
index|]
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|IPF_EXP_IP_ADDR
case|:
if|if
condition|(
name|stp
operator|->
name|is_v
operator|!=
literal|4
condition|)
break|break;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|rv
operator|&&
name|i
operator|<
name|e
operator|->
name|ipfe_narg
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator||=
operator|(
operator|(
name|stp
operator|->
name|is_saddr
operator|&
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|)
operator|==
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|2
index|]
operator|)
operator|||
operator|(
operator|(
name|stp
operator|->
name|is_daddr
operator|&
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|)
operator|==
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|2
index|]
operator|)
expr_stmt|;
block|}
break|break;
ifdef|#
directive|ifdef
name|USE_INET6
case|case
name|IPF_EXP_IP6_SRCADDR
case|:
if|if
condition|(
name|stp
operator|->
name|is_v
operator|!=
literal|6
condition|)
break|break;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|rv
operator|&&
name|i
operator|<
name|e
operator|->
name|ipfe_narg
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator||=
name|IP6_MASKEQ
argument_list|(
operator|&
name|stp
operator|->
name|is_src
argument_list|,
operator|&
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|8
operator|+
literal|4
index|]
argument_list|,
operator|&
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|8
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|IPF_EXP_IP6_DSTADDR
case|:
if|if
condition|(
name|stp
operator|->
name|is_v
operator|!=
literal|6
condition|)
break|break;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|rv
operator|&&
name|i
operator|<
name|e
operator|->
name|ipfe_narg
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator||=
name|IP6_MASKEQ
argument_list|(
operator|&
name|stp
operator|->
name|is_dst
argument_list|,
operator|&
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|8
operator|+
literal|4
index|]
argument_list|,
operator|&
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|8
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|IPF_EXP_IP6_ADDR
case|:
if|if
condition|(
name|stp
operator|->
name|is_v
operator|!=
literal|6
condition|)
break|break;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|rv
operator|&&
name|i
operator|<
name|e
operator|->
name|ipfe_narg
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator||=
name|IP6_MASKEQ
argument_list|(
operator|&
name|stp
operator|->
name|is_src
argument_list|,
operator|&
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|8
operator|+
literal|4
index|]
argument_list|,
operator|&
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|8
index|]
argument_list|)
operator|||
name|IP6_MASKEQ
argument_list|(
operator|&
name|stp
operator|->
name|is_dst
argument_list|,
operator|&
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|8
operator|+
literal|4
index|]
argument_list|,
operator|&
name|e
operator|->
name|ipfe_arg0
index|[
name|i
operator|*
literal|8
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
case|case
name|IPF_EXP_UDP_PORT
case|:
case|case
name|IPF_EXP_TCP_PORT
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|rv
operator|&&
name|i
operator|<
name|e
operator|->
name|ipfe_narg
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator||=
operator|(
name|stp
operator|->
name|is_sport
operator|==
name|e
operator|->
name|ipfe_arg0
index|[
name|i
index|]
operator|)
operator|||
operator|(
name|stp
operator|->
name|is_dport
operator|==
name|e
operator|->
name|ipfe_arg0
index|[
name|i
index|]
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|IPF_EXP_UDP_SPORT
case|:
case|case
name|IPF_EXP_TCP_SPORT
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|rv
operator|&&
name|i
operator|<
name|e
operator|->
name|ipfe_narg
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator||=
operator|(
name|stp
operator|->
name|is_sport
operator|==
name|e
operator|->
name|ipfe_arg0
index|[
name|i
index|]
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|IPF_EXP_UDP_DPORT
case|:
case|case
name|IPF_EXP_TCP_DPORT
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|rv
operator|&&
name|i
operator|<
name|e
operator|->
name|ipfe_narg
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator||=
operator|(
name|stp
operator|->
name|is_dport
operator|==
name|e
operator|->
name|ipfe_arg0
index|[
name|i
index|]
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|IPF_EXP_IDLE_GT
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|rv
operator|&&
name|i
operator|<
name|e
operator|->
name|ipfe_narg
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator||=
operator|(
name|stp
operator|->
name|is_die
operator|<
name|e
operator|->
name|ipfe_arg0
index|[
name|i
index|]
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|IPF_EXP_TCP_STATE
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|rv
operator|&&
name|i
operator|<
name|e
operator|->
name|ipfe_narg
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator||=
operator|(
name|stp
operator|->
name|is_state
index|[
literal|0
index|]
operator|==
name|e
operator|->
name|ipfe_arg0
index|[
name|i
index|]
operator|)
operator|||
operator|(
name|stp
operator|->
name|is_state
index|[
literal|1
index|]
operator|==
name|e
operator|->
name|ipfe_arg0
index|[
name|i
index|]
operator|)
expr_stmt|;
block|}
break|break;
block|}
name|rv
operator|^=
name|e
operator|->
name|ipfe_not
expr_stmt|;
if|if
condition|(
name|rv
operator|==
literal|0
condition|)
break|break;
block|}
return|return
name|rv
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|showtqtable_live
parameter_list|(
name|fd
parameter_list|)
name|int
name|fd
decl_stmt|;
block|{
name|ipftq_t
name|table
index|[
name|IPF_TCP_NSTATES
index|]
decl_stmt|;
name|ipfobj_t
name|obj
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|obj
argument_list|,
sizeof|sizeof
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|.
name|ipfo_rev
operator|=
name|IPFILTER_VERSION
expr_stmt|;
name|obj
operator|.
name|ipfo_size
operator|=
sizeof|sizeof
argument_list|(
name|table
argument_list|)
expr_stmt|;
name|obj
operator|.
name|ipfo_ptr
operator|=
operator|(
name|void
operator|*
operator|)
name|table
expr_stmt|;
name|obj
operator|.
name|ipfo_type
operator|=
name|IPFOBJ_STATETQTAB
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCGTQTAB
argument_list|,
operator|&
name|obj
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printtqtable
argument_list|(
name|table
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


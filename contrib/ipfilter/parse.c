begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 1993-2001 by Darren Reed.  *  * See the IPFILTER.LICENCE file for details on licencing.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__sgi
end_ifdef

begin_include
include|#
directive|include
file|<sys/ptimers.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|__SVR4
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__svr4__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/byteorder.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|300000
end_if

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<arpa/nameser.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<resolv.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|"ip_compat.h"
end_include

begin_include
include|#
directive|include
file|"ip_fil.h"
end_include

begin_include
include|#
directive|include
file|"ipf.h"
end_include

begin_include
include|#
directive|include
file|"facpri.h"
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
end_if

begin_decl_stmt
specifier|static
specifier|const
name|char
name|sccsid
index|[]
init|=
literal|"@(#)parse.c	1.44 6/5/96 (C) 1993-2000 Darren Reed"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#)$IPFilter: parse.c,v 2.8 1999/12/28 10:49:46 darrenr Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|struct
name|ipopt_names
name|ionames
index|[]
decl_stmt|,
name|secclass
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|opts
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|use_inet6
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|addicmp
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|*
operator|*
operator|,
expr|struct
name|frentry
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|extras
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|*
operator|*
operator|,
expr|struct
name|frentry
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|icmpcode
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|)
argument_list|)
decl_stmt|,
name|addkeep
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|*
operator|*
operator|,
expr|struct
name|frentry
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|to_interface
name|__P
argument_list|(
operator|(
name|frdest_t
operator|*
operator|,
name|char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|print_toif
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|frdest_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|optprint
name|__P
argument_list|(
operator|(
name|u_short
operator|*
operator|,
name|u_long
operator|,
name|u_long
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|loglevel
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|*
operator|,
name|u_int
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|printlog
name|__P
argument_list|(
operator|(
name|frentry_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|printifname
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|char
operator|*
operator|,
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|proto
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|flagset
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|u_char
name|flags
index|[]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* parse()  *  * parse a line read from the input filter rule file  */
end_comment

begin_function
name|struct
name|frentry
modifier|*
name|parse
parameter_list|(
name|line
parameter_list|,
name|linenum
parameter_list|)
name|char
modifier|*
name|line
decl_stmt|;
name|int
name|linenum
decl_stmt|;
block|{
specifier|static
name|struct
name|frentry
name|fil
decl_stmt|;
name|char
modifier|*
name|cps
index|[
literal|31
index|]
decl_stmt|,
modifier|*
modifier|*
name|cpp
decl_stmt|,
modifier|*
name|endptr
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|struct
name|protoent
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cnt
init|=
literal|1
decl_stmt|,
name|j
decl_stmt|,
name|ch
decl_stmt|;
name|u_int
name|k
decl_stmt|;
while|while
condition|(
operator|*
name|line
operator|&&
name|isspace
argument_list|(
operator|*
name|line
argument_list|)
condition|)
name|line
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|line
condition|)
return|return
name|NULL
return|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fil
argument_list|,
sizeof|sizeof
argument_list|(
name|fil
argument_list|)
argument_list|)
expr_stmt|;
name|fil
operator|.
name|fr_mip
operator|.
name|fi_v
operator|=
literal|0xf
expr_stmt|;
name|fil
operator|.
name|fr_ip
operator|.
name|fi_v
operator|=
name|use_inet6
condition|?
literal|6
else|:
literal|4
expr_stmt|;
name|fil
operator|.
name|fr_loglevel
operator|=
literal|0xffff
expr_stmt|;
comment|/* 	 * break line up into max of 20 segments 	 */
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"parse [%s]\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
operator|*
name|cps
operator|=
name|strtok
argument_list|(
name|line
argument_list|,
literal|" \b\t\r\n"
argument_list|)
init|;
name|cps
index|[
name|i
index|]
operator|&&
name|i
operator|<
literal|30
condition|;
name|cnt
operator|++
control|)
name|cps
index|[
operator|++
name|i
index|]
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|" \b\t\r\n"
argument_list|)
expr_stmt|;
name|cps
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|cnt
operator|<
literal|3
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: not enough segments in line\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cpp
operator|=
name|cps
expr_stmt|;
comment|/* 	 * The presence of an '@' followed by a number gives the position in 	 * the current rule list to insert this one. 	 */
if|if
condition|(
operator|*
operator|*
name|cpp
operator|==
literal|'@'
condition|)
name|fil
operator|.
name|fr_hits
operator|=
operator|(
name|U_QUAD_T
operator|)
name|atoi
argument_list|(
operator|*
name|cpp
operator|++
operator|+
literal|1
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* 	 * Check the first keyword in the rule and any options that are 	 * expected to follow it. 	 */
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"block"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_BLOCK
expr_stmt|;
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
argument_list|,
literal|"return-icmp-as-dest"
argument_list|,
literal|19
argument_list|)
operator|&&
operator|(
name|i
operator|=
literal|19
operator|)
condition|)
name|fil
operator|.
name|fr_flags
operator||=
name|FR_FAKEICMP
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
argument_list|,
literal|"return-icmp"
argument_list|,
literal|11
argument_list|)
operator|&&
operator|(
name|i
operator|=
literal|11
operator|)
condition|)
name|fil
operator|.
name|fr_flags
operator||=
name|FR_RETICMP
expr_stmt|;
if|if
condition|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_RETICMP
condition|)
block|{
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
operator|*
name|cpp
argument_list|)
operator|==
name|i
condition|)
block|{
if|if
condition|(
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
operator|&&
operator|*
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
operator|==
literal|'('
condition|)
block|{
name|cpp
operator|++
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|i
operator|=
operator|-
literal|1
expr_stmt|;
block|}
comment|/* 			 * The ICMP code is not required to follow in ()'s 			 */
if|if
condition|(
operator|(
name|i
operator|>=
literal|0
operator|)
operator|&&
operator|(
operator|*
operator|(
operator|*
name|cpp
operator|+
name|i
operator|)
operator|==
literal|'('
operator|)
condition|)
block|{
name|i
operator|++
expr_stmt|;
name|j
operator|=
name|icmpcode
argument_list|(
operator|*
name|cpp
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: unrecognised icmp code %s\n"
argument_list|,
name|linenum
argument_list|,
operator|*
name|cpp
operator|+
literal|20
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_icode
operator|=
name|j
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
argument_list|,
literal|"return-rst"
argument_list|,
literal|10
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_RETRST
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"count"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_ACCOUNT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"pass"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_PASS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"nomatch"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_NOMATCH
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"auth"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_AUTH
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"preauth"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_PREAUTH
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"skip"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
name|ratoui
argument_list|(
operator|*
name|cpp
argument_list|,
operator|&
name|k
argument_list|,
literal|0
argument_list|,
name|UINT_MAX
argument_list|)
condition|)
name|fil
operator|.
name|fr_skip
operator|=
name|k
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: integer must follow skip\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"log"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOG
expr_stmt|;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
argument_list|,
literal|"body"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGBODY
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
argument_list|,
literal|"first"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGFIRST
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
argument_list|,
literal|"or-block"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGORBLOCK
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
argument_list|,
literal|"level"
argument_list|)
condition|)
block|{
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
name|loglevel
argument_list|(
name|cpp
argument_list|,
operator|&
name|fil
operator|.
name|fr_loglevel
argument_list|,
name|linenum
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
name|NULL
return|;
name|cpp
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 		 * Doesn't start with one of the action words 		 */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: unknown keyword (%s)\n"
argument_list|,
name|linenum
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: missing 'in'/'out' keyword\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 	 * Get the direction for filtering.  Impose restrictions on direction 	 * if blocking with returning ICMP or an RST has been requested. 	 */
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"in"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
name|fil
operator|.
name|fr_flags
operator||=
name|FR_INQUE
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"out"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_OUTQUE
expr_stmt|;
if|if
condition|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_RETICMP
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: Can only use return-icmp with 'in'\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
elseif|else
if|if
condition|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_RETRST
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: Can only use return-rst with 'in'\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: missing source specification\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"log"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: missing source specification\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_PASS
condition|)
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGP
expr_stmt|;
elseif|else
if|if
condition|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_BLOCK
condition|)
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGB
expr_stmt|;
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"body"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGBODY
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"first"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGFIRST
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"or-block"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_PASS
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: or-block must be used with pass\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGORBLOCK
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"level"
argument_list|)
condition|)
block|{
if|if
condition|(
name|loglevel
argument_list|(
name|cpp
argument_list|,
operator|&
name|fil
operator|.
name|fr_loglevel
argument_list|,
name|linenum
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
name|NULL
return|;
name|cpp
operator|++
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
literal|"quick"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
if|if
condition|(
name|fil
operator|.
name|fr_skip
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: cannot use skip with quick\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cpp
operator|++
expr_stmt|;
name|fil
operator|.
name|fr_flags
operator||=
name|FR_QUICK
expr_stmt|;
block|}
comment|/* 	 * Parse rule options that are available if a rule is tied to an 	 * interface. 	 */
operator|*
name|fil
operator|.
name|fr_ifname
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|fil
operator|.
name|fr_oifname
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"on"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: interface name missing\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|s
operator|=
name|index
argument_list|(
operator|*
name|cpp
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
condition|)
block|{
operator|*
name|s
operator|++
operator|=
literal|'\0'
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|fil
operator|.
name|fr_ifnames
index|[
literal|1
index|]
argument_list|,
name|s
argument_list|,
name|IFNAMSIZ
operator|-
literal|1
argument_list|)
expr_stmt|;
name|fil
operator|.
name|fr_ifnames
index|[
literal|1
index|]
index|[
name|IFNAMSIZ
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
name|strcpy
argument_list|(
name|fil
operator|.
name|fr_ifnames
index|[
literal|1
index|]
argument_list|,
literal|"*"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|fil
operator|.
name|fr_ifnames
index|[
literal|0
index|]
argument_list|,
operator|*
name|cpp
argument_list|,
name|IFNAMSIZ
operator|-
literal|1
argument_list|)
expr_stmt|;
name|fil
operator|.
name|fr_ifnames
index|[
literal|0
index|]
index|[
name|IFNAMSIZ
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|cpp
condition|)
block|{
if|if
condition|(
operator|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_RETMASK
operator|)
operator|==
name|FR_RETRST
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: %s can only be used with TCP\n"
argument_list|,
name|linenum
argument_list|,
literal|"return-rst"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
operator|&
name|fil
return|;
block|}
if|if
condition|(
operator|*
name|cpp
condition|)
block|{
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"dup-to"
argument_list|)
operator|&&
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
condition|)
block|{
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
name|to_interface
argument_list|(
operator|&
name|fil
operator|.
name|fr_dif
argument_list|,
operator|*
name|cpp
argument_list|,
name|linenum
argument_list|)
condition|)
return|return
name|NULL
return|;
name|cpp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"to"
argument_list|)
operator|&&
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
condition|)
block|{
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
name|to_interface
argument_list|(
operator|&
name|fil
operator|.
name|fr_tif
argument_list|,
operator|*
name|cpp
argument_list|,
name|linenum
argument_list|)
condition|)
return|return
name|NULL
return|;
name|cpp
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"fastroute"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_INQUE
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"can only use %s with 'in'\n"
argument_list|,
literal|"fastroute"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_flags
operator||=
name|FR_FASTROUTE
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
block|}
comment|/* 		 * Set the "other" interface name.  Lets you specify both 		 * inbound and outbound interfaces for state rules.  Do not 		 * prevent both interfaces from being the same. 		 */
name|strcpy
argument_list|(
name|fil
operator|.
name|fr_ifnames
index|[
literal|3
index|]
argument_list|,
literal|"*"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|cpp
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|(
operator|(
operator|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_INQUE
operator|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"out-via"
argument_list|)
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
operator|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_OUTQUE
operator|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"in-via"
argument_list|)
operator|==
literal|0
operator|)
operator|)
operator|)
condition|)
block|{
name|cpp
operator|++
expr_stmt|;
name|s
operator|=
name|index
argument_list|(
operator|*
name|cpp
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
condition|)
block|{
operator|*
name|s
operator|++
operator|=
literal|'\0'
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|fil
operator|.
name|fr_ifnames
index|[
literal|3
index|]
argument_list|,
name|s
argument_list|,
name|IFNAMSIZ
operator|-
literal|1
argument_list|)
expr_stmt|;
name|fil
operator|.
name|fr_ifnames
index|[
literal|3
index|]
index|[
name|IFNAMSIZ
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|fil
operator|.
name|fr_ifnames
index|[
literal|2
index|]
argument_list|,
operator|*
name|cpp
argument_list|,
name|IFNAMSIZ
operator|-
literal|1
argument_list|)
expr_stmt|;
name|fil
operator|.
name|fr_ifnames
index|[
literal|2
index|]
index|[
name|IFNAMSIZ
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
else|else
name|strcpy
argument_list|(
name|fil
operator|.
name|fr_ifnames
index|[
literal|2
index|]
argument_list|,
literal|"*"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"tos"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: tos missing value\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_tos
operator|=
name|strtol
argument_list|(
operator|*
name|cpp
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fil
operator|.
name|fr_mip
operator|.
name|fi_tos
operator|=
literal|0xff
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"ttl"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: ttl missing hopcount value\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ratoi
argument_list|(
operator|*
name|cpp
argument_list|,
operator|&
name|i
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
condition|)
name|fil
operator|.
name|fr_ttl
operator|=
name|i
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: invalid ttl (%s)\n"
argument_list|,
name|linenum
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_mip
operator|.
name|fi_ttl
operator|=
literal|0xff
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
comment|/* 	 * check for "proto<protoname>" only decode udp/tcp/icmp as protoname 	 */
name|proto
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"proto"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: protocol name missing\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|proto
operator|=
operator|*
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|proto
argument_list|,
literal|"tcp/udp"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_ip
operator|.
name|fi_fl
operator||=
name|FI_TCPUDP
expr_stmt|;
name|fil
operator|.
name|fr_mip
operator|.
name|fi_fl
operator||=
name|FI_TCPUDP
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|use_inet6
operator|&&
operator|!
name|strcasecmp
argument_list|(
name|proto
argument_list|,
literal|"icmp"
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: use proto ipv6-icmp with IPv6 (or use proto 1 if you really mean icmp)\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|p
operator|=
name|getprotobyname
argument_list|(
name|proto
argument_list|)
operator|)
operator|&&
operator|!
name|isdigit
argument_list|(
operator|*
name|proto
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: unknown protocol (%s)\n"
argument_list|,
name|linenum
argument_list|,
name|proto
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|p
condition|)
name|fil
operator|.
name|fr_proto
operator|=
name|p
operator|->
name|p_proto
expr_stmt|;
elseif|else
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|proto
argument_list|)
condition|)
block|{
name|i
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|proto
argument_list|,
operator|&
name|endptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endptr
operator|!=
literal|'\0'
operator|||
name|i
operator|<
literal|0
operator|||
name|i
operator|>
literal|255
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: unknown protocol (%s)\n"
argument_list|,
name|linenum
argument_list|,
name|proto
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_proto
operator|=
name|i
expr_stmt|;
block|}
name|fil
operator|.
name|fr_mip
operator|.
name|fi_p
operator|=
literal|0xff
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_TCP
operator|)
operator|&&
operator|(
operator|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_RETMASK
operator|)
operator|==
name|FR_RETRST
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: %s can only be used with TCP\n"
argument_list|,
name|linenum
argument_list|,
literal|"return-rst"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 	 * get the from host and bit mask to use against packets 	 */
if|if
condition|(
operator|!
operator|*
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: missing source specification\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"all"
argument_list|)
condition|)
block|{
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|cpp
condition|)
return|return
operator|&
name|fil
return|;
block|}
else|else
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"from"
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: unexpected keyword (%s) - from\n"
argument_list|,
name|linenum
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: missing host after from\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"!"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_NOTSRCIP
expr_stmt|;
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: missing host after from\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
name|cpp
operator|==
literal|'!'
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_NOTSRCIP
expr_stmt|;
operator|(
operator|*
name|cpp
operator|)
operator|++
expr_stmt|;
block|}
name|ch
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|hostmask
argument_list|(
operator|&
name|cpp
argument_list|,
operator|(
name|u_32_t
operator|*
operator|)
operator|&
name|fil
operator|.
name|fr_src
argument_list|,
operator|(
name|u_32_t
operator|*
operator|)
operator|&
name|fil
operator|.
name|fr_smsk
argument_list|,
operator|&
name|fil
operator|.
name|fr_sport
argument_list|,
operator|&
name|ch
argument_list|,
operator|&
name|fil
operator|.
name|fr_stop
argument_list|,
name|linenum
argument_list|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|(
name|ch
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_TCP
operator|)
operator|&&
operator|(
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_UDP
operator|)
operator|&&
operator|!
operator|(
name|fil
operator|.
name|fr_ip
operator|.
name|fi_fl
operator|&
name|FI_TCPUDP
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: cannot use port and neither tcp or udp\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_scmp
operator|=
name|ch
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: missing to fields\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 		 * do the same for the to field (destination host) 		 */
if|if
condition|(
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"to"
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: unexpected keyword (%s) - to\n"
argument_list|,
name|linenum
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: missing host after to\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ch
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"!"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_NOTDSTIP
expr_stmt|;
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: missing host after from\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
name|cpp
operator|==
literal|'!'
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_NOTDSTIP
expr_stmt|;
operator|(
operator|*
name|cpp
operator|)
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|hostmask
argument_list|(
operator|&
name|cpp
argument_list|,
operator|(
name|u_32_t
operator|*
operator|)
operator|&
name|fil
operator|.
name|fr_dst
argument_list|,
operator|(
name|u_32_t
operator|*
operator|)
operator|&
name|fil
operator|.
name|fr_dmsk
argument_list|,
operator|&
name|fil
operator|.
name|fr_dport
argument_list|,
operator|&
name|ch
argument_list|,
operator|&
name|fil
operator|.
name|fr_dtop
argument_list|,
name|linenum
argument_list|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|(
name|ch
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_TCP
operator|)
operator|&&
operator|(
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_UDP
operator|)
operator|&&
operator|!
operator|(
name|fil
operator|.
name|fr_ip
operator|.
name|fi_fl
operator|&
name|FI_TCPUDP
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: cannot use port and neither tcp or udp\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_dcmp
operator|=
name|ch
expr_stmt|;
block|}
comment|/* 	 * check some sanity, make sure we don't have icmp checks with tcp 	 * or udp or visa versa. 	 */
if|if
condition|(
name|fil
operator|.
name|fr_proto
operator|&&
operator|(
name|fil
operator|.
name|fr_dcmp
operator|||
name|fil
operator|.
name|fr_scmp
operator|)
operator|&&
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_TCP
operator|&&
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_UDP
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: port operation on non tcp/udp\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|fil
operator|.
name|fr_icmp
operator|&&
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_ICMP
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: icmp comparisons on wrong protocol\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|*
name|cpp
condition|)
return|return
operator|&
name|fil
return|;
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"flags"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: no flags present\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_tcpf
operator|=
name|tcp_flags
argument_list|(
operator|*
name|cpp
argument_list|,
operator|&
name|fil
operator|.
name|fr_tcpfm
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
comment|/* 	 * extras... 	 */
if|if
condition|(
operator|(
name|fil
operator|.
name|fr_v
operator|==
literal|4
operator|)
operator|&&
operator|*
name|cpp
operator|&&
operator|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"with"
argument_list|)
operator|||
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"and"
argument_list|)
operator|)
condition|)
if|if
condition|(
name|extras
argument_list|(
operator|&
name|cpp
argument_list|,
operator|&
name|fil
argument_list|,
name|linenum
argument_list|)
condition|)
return|return
name|NULL
return|;
comment|/* 	 * icmp types for use with the icmp protocol 	 */
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"icmp-type"
argument_list|)
condition|)
block|{
if|if
condition|(
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_ICMP
operator|&&
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_ICMPV6
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: icmp with wrong protocol (%d)\n"
argument_list|,
name|linenum
argument_list|,
name|fil
operator|.
name|fr_proto
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|addicmp
argument_list|(
operator|&
name|cpp
argument_list|,
operator|&
name|fil
argument_list|,
name|linenum
argument_list|)
condition|)
return|return
name|NULL
return|;
name|fil
operator|.
name|fr_icmp
operator|=
name|htons
argument_list|(
name|fil
operator|.
name|fr_icmp
argument_list|)
expr_stmt|;
name|fil
operator|.
name|fr_icmpm
operator|=
name|htons
argument_list|(
name|fil
operator|.
name|fr_icmpm
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Keep something... 	 */
while|while
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"keep"
argument_list|)
condition|)
if|if
condition|(
name|addkeep
argument_list|(
operator|&
name|cpp
argument_list|,
operator|&
name|fil
argument_list|,
name|linenum
argument_list|)
condition|)
return|return
name|NULL
return|;
comment|/* 	 * This is here to enforce the old interface binding behaviour. 	 * That is, "on X" is equivalent to "<dir> on X<!dir>-via -,X" 	 */
if|if
condition|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_KEEPSTATE
condition|)
block|{
if|if
condition|(
operator|*
name|fil
operator|.
name|fr_ifnames
index|[
literal|0
index|]
operator|&&
operator|!
operator|*
name|fil
operator|.
name|fr_ifnames
index|[
literal|3
index|]
condition|)
block|{
name|bcopy
argument_list|(
name|fil
operator|.
name|fr_ifnames
index|[
literal|0
index|]
argument_list|,
name|fil
operator|.
name|fr_ifnames
index|[
literal|3
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|fil
operator|.
name|fr_ifnames
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|fil
operator|.
name|fr_ifnames
index|[
literal|2
index|]
argument_list|,
literal|"*"
argument_list|,
sizeof|sizeof
argument_list|(
name|fil
operator|.
name|fr_ifnames
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * head of a new group ? 	 */
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"head"
argument_list|)
condition|)
block|{
if|if
condition|(
name|fil
operator|.
name|fr_skip
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: cannot use skip with head\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: head without group #\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ratoui
argument_list|(
operator|*
name|cpp
argument_list|,
operator|&
name|k
argument_list|,
literal|0
argument_list|,
name|UINT_MAX
argument_list|)
condition|)
name|fil
operator|.
name|fr_grhead
operator|=
operator|(
name|u_32_t
operator|)
name|k
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: invalid group (%s)\n"
argument_list|,
name|linenum
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cpp
operator|++
expr_stmt|;
block|}
comment|/* 	 * head of a new group ? 	 */
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"group"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: group without group #\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ratoui
argument_list|(
operator|*
name|cpp
argument_list|,
operator|&
name|k
argument_list|,
literal|0
argument_list|,
name|UINT_MAX
argument_list|)
condition|)
name|fil
operator|.
name|fr_group
operator|=
name|k
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: invalid group (%s)\n"
argument_list|,
name|linenum
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cpp
operator|++
expr_stmt|;
block|}
comment|/* 	 * leftovers...yuck 	 */
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|*
operator|*
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: unknown words at end: ["
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
for|for
control|(
init|;
operator|*
name|cpp
condition|;
name|cpp
operator|++
control|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s "
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"]\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 	 * lazy users... 	 */
if|if
condition|(
operator|(
name|fil
operator|.
name|fr_tcpf
operator|||
name|fil
operator|.
name|fr_tcpfm
operator|)
operator|&&
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_TCP
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: TCP protocol not specified\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|fil
operator|.
name|fr_ip
operator|.
name|fi_fl
operator|&
name|FI_TCPUDP
operator|)
operator|&&
operator|(
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_TCP
operator|)
operator|&&
operator|(
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_UDP
operator|)
operator|&&
operator|(
name|fil
operator|.
name|fr_dcmp
operator|||
name|fil
operator|.
name|fr_scmp
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|fil
operator|.
name|fr_proto
condition|)
block|{
name|fil
operator|.
name|fr_ip
operator|.
name|fi_fl
operator||=
name|FI_TCPUDP
expr_stmt|;
name|fil
operator|.
name|fr_mip
operator|.
name|fi_fl
operator||=
name|FI_TCPUDP
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: port comparisons for non-TCP/UDP\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
comment|/* 	if ((fil.fr_flags& FR_KEEPFRAG)&& 	    (!(fil.fr_ip.fi_fl& FI_FRAG) || !(fil.fr_ip.fi_fl& FI_FRAG))) { 		fprintf(stderr, 			"%d: must use 'with frags' with 'keep frags'\n", 			linenum); 		return NULL; 	} */
return|return
operator|&
name|fil
return|;
block|}
end_function

begin_function
name|int
name|loglevel
parameter_list|(
name|cpp
parameter_list|,
name|facpri
parameter_list|,
name|linenum
parameter_list|)
name|char
modifier|*
modifier|*
name|cpp
decl_stmt|;
name|u_int
modifier|*
name|facpri
decl_stmt|;
name|int
name|linenum
decl_stmt|;
block|{
name|int
name|fac
decl_stmt|,
name|pri
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|fac
operator|=
literal|0
expr_stmt|;
name|pri
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: %s\n"
argument_list|,
name|linenum
argument_list|,
literal|"missing identifier after level"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|s
operator|=
name|index
argument_list|(
operator|*
name|cpp
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
operator|*
name|s
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|fac
operator|=
name|fac_findname
argument_list|(
operator|*
name|cpp
argument_list|)
expr_stmt|;
if|if
condition|(
name|fac
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: %s %s\n"
argument_list|,
name|linenum
argument_list|,
literal|"Unknown facility"
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pri
operator|=
name|pri_findname
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|pri
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: %s %s\n"
argument_list|,
name|linenum
argument_list|,
literal|"Unknown priority"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
else|else
block|{
name|pri
operator|=
name|pri_findname
argument_list|(
operator|*
name|cpp
argument_list|)
expr_stmt|;
if|if
condition|(
name|pri
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: %s %s\n"
argument_list|,
name|linenum
argument_list|,
literal|"Unknown priority"
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
operator|*
name|facpri
operator|=
name|fac
operator||
name|pri
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|to_interface
parameter_list|(
name|fdp
parameter_list|,
name|to
parameter_list|,
name|linenum
parameter_list|)
name|frdest_t
modifier|*
name|fdp
decl_stmt|;
name|char
modifier|*
name|to
decl_stmt|;
name|int
name|linenum
decl_stmt|;
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|s
operator|=
name|index
argument_list|(
name|to
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
name|fdp
operator|->
name|fd_ifp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
operator|*
name|s
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|hostnum
argument_list|(
operator|(
name|u_32_t
operator|*
operator|)
operator|&
name|fdp
operator|->
name|fd_ip
argument_list|,
name|s
argument_list|,
name|linenum
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
block|}
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|fdp
operator|->
name|fd_ifname
argument_list|,
name|to
argument_list|,
sizeof|sizeof
argument_list|(
name|fdp
operator|->
name|fd_ifname
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|fdp
operator|->
name|fd_ifname
index|[
sizeof|sizeof
argument_list|(
name|fdp
operator|->
name|fd_ifname
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|print_toif
parameter_list|(
name|tag
parameter_list|,
name|fdp
parameter_list|)
name|char
modifier|*
name|tag
decl_stmt|;
name|frdest_t
modifier|*
name|fdp
decl_stmt|;
block|{
name|printf
argument_list|(
literal|"%s %s%s"
argument_list|,
name|tag
argument_list|,
name|fdp
operator|->
name|fd_ifname
argument_list|,
operator|(
name|fdp
operator|->
name|fd_ifp
operator|||
operator|(
name|long
operator|)
name|fdp
operator|->
name|fd_ifp
operator|==
operator|-
literal|1
operator|)
condition|?
literal|""
else|:
literal|"(!)"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_INET6
if|if
condition|(
name|use_inet6
operator|&&
name|IP6_NOTZERO
argument_list|(
operator|&
name|fdp
operator|->
name|fd_ip6
operator|.
name|in6
argument_list|)
condition|)
block|{
name|char
name|ipv6addr
index|[
literal|80
index|]
decl_stmt|;
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
name|fdp
operator|->
name|fd_ip6
argument_list|,
name|ipv6addr
argument_list|,
sizeof|sizeof
argument_list|(
name|fdp
operator|->
name|fd_ip6
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|":%s"
argument_list|,
name|ipv6addr
argument_list|)
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
if|if
condition|(
name|fdp
operator|->
name|fd_ip
operator|.
name|s_addr
condition|)
name|printf
argument_list|(
literal|":%s"
argument_list|,
name|inet_ntoa
argument_list|(
name|fdp
operator|->
name|fd_ip
argument_list|)
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * deal with extra bits on end of the line  */
end_comment

begin_function
name|int
name|extras
parameter_list|(
name|cp
parameter_list|,
name|fr
parameter_list|,
name|linenum
parameter_list|)
name|char
modifier|*
modifier|*
modifier|*
name|cp
decl_stmt|;
name|struct
name|frentry
modifier|*
name|fr
decl_stmt|;
name|int
name|linenum
decl_stmt|;
block|{
name|u_short
name|secmsk
decl_stmt|;
name|u_long
name|opts
decl_stmt|;
name|int
name|notopt
decl_stmt|;
name|char
name|oflags
decl_stmt|;
name|opts
operator|=
literal|0
expr_stmt|;
name|secmsk
operator|=
literal|0
expr_stmt|;
name|notopt
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
operator|*
name|cp
condition|)
return|return
operator|-
literal|1
return|;
while|while
condition|(
operator|*
operator|*
name|cp
operator|&&
operator|(
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"ipopt"
argument_list|,
literal|5
argument_list|)
operator|||
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"not"
argument_list|)
operator|||
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"opt"
argument_list|,
literal|3
argument_list|)
operator|||
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"frag"
argument_list|,
literal|4
argument_list|)
operator|||
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"no"
argument_list|)
operator|||
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"short"
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'n'
operator|||
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'N'
condition|)
block|{
name|notopt
operator|=
literal|1
expr_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'i'
operator|||
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'I'
condition|)
block|{
if|if
condition|(
operator|!
name|notopt
condition|)
name|fr
operator|->
name|fr_ip
operator|.
name|fi_fl
operator||=
name|FI_OPTIONS
expr_stmt|;
name|fr
operator|->
name|fr_mip
operator|.
name|fi_fl
operator||=
name|FI_OPTIONS
expr_stmt|;
goto|goto
name|nextopt
goto|;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'f'
operator|||
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'F'
condition|)
block|{
if|if
condition|(
operator|!
name|notopt
condition|)
name|fr
operator|->
name|fr_ip
operator|.
name|fi_fl
operator||=
name|FI_FRAG
expr_stmt|;
name|fr
operator|->
name|fr_mip
operator|.
name|fi_fl
operator||=
name|FI_FRAG
expr_stmt|;
goto|goto
name|nextopt
goto|;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'o'
operator|||
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'O'
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|(
operator|*
name|cp
operator|+
literal|1
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: opt missing arguements\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|opts
operator|=
name|optname
argument_list|(
name|cp
argument_list|,
operator|&
name|secmsk
argument_list|,
name|linenum
argument_list|)
operator|)
condition|)
return|return
operator|-
literal|1
return|;
name|oflags
operator|=
name|FI_OPTIONS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'s'
operator|||
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'S'
condition|)
block|{
if|if
condition|(
name|fr
operator|->
name|fr_tcpf
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: short cannot be used with TCP flags\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|notopt
condition|)
name|fr
operator|->
name|fr_ip
operator|.
name|fi_fl
operator||=
name|FI_SHORT
expr_stmt|;
name|fr
operator|->
name|fr_mip
operator|.
name|fi_fl
operator||=
name|FI_SHORT
expr_stmt|;
goto|goto
name|nextopt
goto|;
block|}
else|else
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|notopt
operator|||
operator|!
name|opts
condition|)
name|fr
operator|->
name|fr_mip
operator|.
name|fi_fl
operator||=
name|oflags
expr_stmt|;
if|if
condition|(
name|notopt
condition|)
block|{
if|if
condition|(
operator|!
name|secmsk
condition|)
block|{
name|fr
operator|->
name|fr_mip
operator|.
name|fi_optmsk
operator||=
name|opts
expr_stmt|;
block|}
else|else
block|{
name|fr
operator|->
name|fr_mip
operator|.
name|fi_optmsk
operator||=
operator|(
name|opts
operator|&
operator|~
literal|0x0100
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|fr
operator|->
name|fr_mip
operator|.
name|fi_optmsk
operator||=
name|opts
expr_stmt|;
block|}
name|fr
operator|->
name|fr_mip
operator|.
name|fi_secmsk
operator||=
name|secmsk
expr_stmt|;
if|if
condition|(
name|notopt
condition|)
block|{
name|fr
operator|->
name|fr_ip
operator|.
name|fi_fl
operator|&=
operator|(
operator|~
name|oflags
operator|&
literal|0xf
operator|)
expr_stmt|;
name|fr
operator|->
name|fr_ip
operator|.
name|fi_optmsk
operator|&=
operator|~
name|opts
expr_stmt|;
name|fr
operator|->
name|fr_ip
operator|.
name|fi_secmsk
operator|&=
operator|~
name|secmsk
expr_stmt|;
block|}
else|else
block|{
name|fr
operator|->
name|fr_ip
operator|.
name|fi_fl
operator||=
name|oflags
expr_stmt|;
name|fr
operator|->
name|fr_ip
operator|.
name|fi_optmsk
operator||=
name|opts
expr_stmt|;
name|fr
operator|->
name|fr_ip
operator|.
name|fi_secmsk
operator||=
name|secmsk
expr_stmt|;
block|}
name|nextopt
label|:
name|notopt
operator|=
literal|0
expr_stmt|;
name|opts
operator|=
literal|0
expr_stmt|;
name|oflags
operator|=
literal|0
expr_stmt|;
name|secmsk
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|u_32_t
name|optname
parameter_list|(
name|cp
parameter_list|,
name|sp
parameter_list|,
name|linenum
parameter_list|)
name|char
modifier|*
modifier|*
modifier|*
name|cp
decl_stmt|;
name|u_short
modifier|*
name|sp
decl_stmt|;
name|int
name|linenum
decl_stmt|;
block|{
name|struct
name|ipopt_names
modifier|*
name|io
decl_stmt|,
modifier|*
name|so
decl_stmt|;
name|u_long
name|msk
init|=
literal|0
decl_stmt|;
name|u_short
name|smsk
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|sec
init|=
literal|0
decl_stmt|;
for|for
control|(
name|s
operator|=
name|strtok
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|","
argument_list|)
init|;
name|s
condition|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|","
argument_list|)
control|)
block|{
for|for
control|(
name|io
operator|=
name|ionames
init|;
name|io
operator|->
name|on_name
condition|;
name|io
operator|++
control|)
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|s
argument_list|,
name|io
operator|->
name|on_name
argument_list|)
condition|)
block|{
name|msk
operator||=
name|io
operator|->
name|on_bit
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|io
operator|->
name|on_name
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: unknown IP option name %s\n"
argument_list|,
name|linenum
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|s
argument_list|,
literal|"sec-class"
argument_list|)
condition|)
name|sec
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|sec
operator|&&
operator|!
operator|*
operator|(
operator|*
name|cp
operator|+
literal|1
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: missing security level after sec-class\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|sec
condition|)
block|{
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
for|for
control|(
name|s
operator|=
name|strtok
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|","
argument_list|)
init|;
name|s
condition|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|","
argument_list|)
control|)
block|{
for|for
control|(
name|so
operator|=
name|secclass
init|;
name|so
operator|->
name|on_name
condition|;
name|so
operator|++
control|)
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|s
argument_list|,
name|so
operator|->
name|on_name
argument_list|)
condition|)
block|{
name|smsk
operator||=
name|so
operator|->
name|on_bit
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|so
operator|->
name|on_name
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: no such security level: %s\n"
argument_list|,
name|linenum
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|smsk
condition|)
operator|*
name|sp
operator|=
name|smsk
expr_stmt|;
block|}
return|return
name|msk
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|__STDC__
end_ifdef

begin_function
name|void
name|optprint
parameter_list|(
name|u_short
modifier|*
name|sec
parameter_list|,
name|u_long
name|optmsk
parameter_list|,
name|u_long
name|optbits
parameter_list|)
else|#
directive|else
function|void optprint
parameter_list|(
name|sec
parameter_list|,
name|optmsk
parameter_list|,
name|optbits
parameter_list|)
name|u_short
modifier|*
name|sec
decl_stmt|;
name|u_long
name|optmsk
decl_stmt|,
name|optbits
decl_stmt|;
endif|#
directive|endif
block|{
name|u_short
name|secmsk
init|=
name|sec
index|[
literal|0
index|]
decl_stmt|,
name|secbits
init|=
name|sec
index|[
literal|1
index|]
decl_stmt|;
name|struct
name|ipopt_names
modifier|*
name|io
decl_stmt|,
modifier|*
name|so
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|secflag
init|=
literal|0
decl_stmt|;
name|s
operator|=
literal|" opt "
expr_stmt|;
for|for
control|(
name|io
operator|=
name|ionames
init|;
name|io
operator|->
name|on_name
condition|;
name|io
operator|++
control|)
if|if
condition|(
operator|(
name|io
operator|->
name|on_bit
operator|&
name|optmsk
operator|)
operator|&&
operator|(
operator|(
name|io
operator|->
name|on_bit
operator|&
name|optmsk
operator|)
operator|==
operator|(
name|io
operator|->
name|on_bit
operator|&
name|optbits
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|io
operator|->
name|on_value
operator|!=
name|IPOPT_SECURITY
operator|)
operator|||
operator|(
operator|!
name|secmsk
operator|&&
operator|!
name|secbits
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|s
argument_list|,
name|io
operator|->
name|on_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|on_value
operator|==
name|IPOPT_SECURITY
condition|)
name|io
operator|++
expr_stmt|;
name|s
operator|=
literal|","
expr_stmt|;
block|}
else|else
name|secflag
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|secmsk
operator|&
name|secbits
condition|)
block|{
name|printf
argument_list|(
literal|"%ssec-class"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
literal|" "
expr_stmt|;
for|for
control|(
name|so
operator|=
name|secclass
init|;
name|so
operator|->
name|on_name
condition|;
name|so
operator|++
control|)
if|if
condition|(
operator|(
name|secmsk
operator|&
name|so
operator|->
name|on_bit
operator|)
operator|&&
operator|(
operator|(
name|so
operator|->
name|on_bit
operator|&
name|secmsk
operator|)
operator|==
operator|(
name|so
operator|->
name|on_bit
operator|&
name|secbits
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|s
argument_list|,
name|so
operator|->
name|on_name
argument_list|)
expr_stmt|;
name|s
operator|=
literal|","
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|optmsk
operator|&&
operator|(
name|optmsk
operator|!=
name|optbits
operator|)
operator|)
operator|||
operator|(
name|secmsk
operator|&&
operator|(
name|secmsk
operator|!=
name|secbits
operator|)
operator|)
condition|)
block|{
name|s
operator|=
literal|" "
expr_stmt|;
name|printf
argument_list|(
literal|" not opt"
argument_list|)
expr_stmt|;
if|if
condition|(
name|optmsk
operator|!=
name|optbits
condition|)
block|{
for|for
control|(
name|io
operator|=
name|ionames
init|;
name|io
operator|->
name|on_name
condition|;
name|io
operator|++
control|)
if|if
condition|(
operator|(
name|io
operator|->
name|on_bit
operator|&
name|optmsk
operator|)
operator|&&
operator|(
operator|(
name|io
operator|->
name|on_bit
operator|&
name|optmsk
operator|)
operator|!=
operator|(
name|io
operator|->
name|on_bit
operator|&
name|optbits
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|io
operator|->
name|on_value
operator|!=
name|IPOPT_SECURITY
operator|)
operator|||
operator|(
operator|!
name|secmsk
operator|&&
operator|!
name|secbits
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|s
argument_list|,
name|io
operator|->
name|on_name
argument_list|)
expr_stmt|;
name|s
operator|=
literal|","
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|on_value
operator|==
name|IPOPT_SECURITY
condition|)
name|io
operator|++
expr_stmt|;
block|}
else|else
name|io
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|secmsk
operator|!=
name|secbits
condition|)
block|{
name|printf
argument_list|(
literal|"%ssec-class"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
literal|" "
expr_stmt|;
for|for
control|(
name|so
operator|=
name|secclass
init|;
name|so
operator|->
name|on_name
condition|;
name|so
operator|++
control|)
if|if
condition|(
operator|(
name|so
operator|->
name|on_bit
operator|&
name|secmsk
operator|)
operator|&&
operator|(
operator|(
name|so
operator|->
name|on_bit
operator|&
name|secmsk
operator|)
operator|!=
operator|(
name|so
operator|->
name|on_bit
operator|&
name|secbits
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|s
argument_list|,
name|so
operator|->
name|on_name
argument_list|)
expr_stmt|;
name|s
operator|=
literal|","
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_decl_stmt
name|char
modifier|*
name|icmptypes
index|[]
init|=
block|{
literal|"echorep"
block|,
operator|(
name|char
operator|*
operator|)
name|NULL
block|,
operator|(
name|char
operator|*
operator|)
name|NULL
block|,
literal|"unreach"
block|,
literal|"squench"
block|,
literal|"redir"
block|,
operator|(
name|char
operator|*
operator|)
name|NULL
block|,
operator|(
name|char
operator|*
operator|)
name|NULL
block|,
literal|"echo"
block|,
literal|"routerad"
block|,
literal|"routersol"
block|,
literal|"timex"
block|,
literal|"paramprob"
block|,
literal|"timest"
block|,
literal|"timestrep"
block|,
literal|"inforeq"
block|,
literal|"inforep"
block|,
literal|"maskreq"
block|,
literal|"maskrep"
block|,
literal|"END"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * set the icmp field to the correct type if "icmp" word is found  */
end_comment

begin_function
name|int
name|addicmp
parameter_list|(
name|cp
parameter_list|,
name|fp
parameter_list|,
name|linenum
parameter_list|)
name|char
modifier|*
modifier|*
modifier|*
name|cp
decl_stmt|;
name|struct
name|frentry
modifier|*
name|fp
decl_stmt|;
name|int
name|linenum
decl_stmt|;
block|{
name|char
modifier|*
modifier|*
name|t
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
operator|*
name|cp
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
operator|*
operator|*
name|cp
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|ratoi
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
operator|&
name|i
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: Invalid icmp-type (%s) specified\n"
argument_list|,
name|linenum
argument_list|,
operator|*
operator|*
name|cp
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_proto
operator|==
name|IPPROTO_ICMPV6
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: Unknown ICMPv6 type (%s) specified, %s"
argument_list|,
name|linenum
argument_list|,
operator|*
operator|*
name|cp
argument_list|,
literal|"(use numeric value instead\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
for|for
control|(
name|t
operator|=
name|icmptypes
operator|,
name|i
operator|=
literal|0
init|;
condition|;
name|t
operator|++
operator|,
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|*
name|t
condition|)
continue|continue;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"END"
argument_list|,
operator|*
name|t
argument_list|)
condition|)
block|{
name|i
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|t
argument_list|,
operator|*
operator|*
name|cp
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: Invalid icmp-type (%s) specified\n"
argument_list|,
name|linenum
argument_list|,
operator|*
operator|*
name|cp
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|fp
operator|->
name|fr_icmp
operator|=
call|(
name|u_short
call|)
argument_list|(
name|i
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|fp
operator|->
name|fr_icmpm
operator|=
operator|(
name|u_short
operator|)
literal|0xff00
expr_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
operator|*
name|cp
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
operator|*
name|cp
operator|&&
name|strcasecmp
argument_list|(
literal|"code"
argument_list|,
operator|*
operator|*
name|cp
argument_list|)
condition|)
return|return
literal|0
return|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
operator|*
operator|*
name|cp
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|ratoi
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
operator|&
name|i
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: Invalid icmp code (%s) specified\n"
argument_list|,
name|linenum
argument_list|,
operator|*
operator|*
name|cp
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
else|else
block|{
name|i
operator|=
name|icmpcode
argument_list|(
operator|*
operator|*
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: Invalid icmp code (%s) specified\n"
argument_list|,
name|linenum
argument_list|,
operator|*
operator|*
name|cp
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|i
operator|&=
literal|0xff
expr_stmt|;
name|fp
operator|->
name|fr_icmp
operator||=
operator|(
name|u_short
operator|)
name|i
expr_stmt|;
name|fp
operator|->
name|fr_icmpm
operator|=
operator|(
name|u_short
operator|)
literal|0xffff
expr_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|MAX_ICMPCODE
value|15
end_define

begin_decl_stmt
name|char
modifier|*
name|icmpcodes
index|[]
init|=
block|{
literal|"net-unr"
block|,
literal|"host-unr"
block|,
literal|"proto-unr"
block|,
literal|"port-unr"
block|,
literal|"needfrag"
block|,
literal|"srcfail"
block|,
literal|"net-unk"
block|,
literal|"host-unk"
block|,
literal|"isolate"
block|,
literal|"net-prohib"
block|,
literal|"host-prohib"
block|,
literal|"net-tos"
block|,
literal|"host-tos"
block|,
literal|"filter-prohib"
block|,
literal|"host-preced"
block|,
literal|"preced-cutoff"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Return the number for the associated ICMP unreachable code.  */
end_comment

begin_function
name|int
name|icmpcode
parameter_list|(
name|str
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
name|strrchr
argument_list|(
name|str
argument_list|,
literal|')'
argument_list|)
operator|)
condition|)
operator|*
name|s
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|str
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|ratoi
argument_list|(
name|str
argument_list|,
operator|&
name|i
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
else|else
return|return
name|i
return|;
block|}
name|len
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|icmpcodes
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
name|str
argument_list|,
name|icmpcodes
index|[
name|i
index|]
argument_list|,
name|MIN
argument_list|(
name|len
argument_list|,
name|strlen
argument_list|(
name|icmpcodes
index|[
name|i
index|]
argument_list|)
argument_list|)
argument_list|)
condition|)
return|return
name|i
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * set the icmp field to the correct type if "icmp" word is found  */
end_comment

begin_function
name|int
name|addkeep
parameter_list|(
name|cp
parameter_list|,
name|fp
parameter_list|,
name|linenum
parameter_list|)
name|char
modifier|*
modifier|*
modifier|*
name|cp
decl_stmt|;
name|struct
name|frentry
modifier|*
name|fp
decl_stmt|;
name|int
name|linenum
decl_stmt|;
block|{
name|char
modifier|*
name|s
decl_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
operator|*
name|cp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: Missing keyword after keep\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"state"
argument_list|)
operator|==
literal|0
condition|)
name|fp
operator|->
name|fr_flags
operator||=
name|FR_KEEPSTATE
expr_stmt|;
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"frag"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|fp
operator|->
name|fr_flags
operator||=
name|FR_KEEPFRAG
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"state-age"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_p
operator|==
name|IPPROTO_TCP
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: cannot use state-age with tcp\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_KEEPSTATE
operator|)
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: state-age with no 'keep state'\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
operator|*
name|cp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: state-age with no arg\n"
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fp
operator|->
name|fr_age
index|[
literal|0
index|]
operator|=
name|atoi
argument_list|(
operator|*
operator|*
name|cp
argument_list|)
expr_stmt|;
name|s
operator|=
name|index
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
condition|)
block|{
name|s
operator|++
expr_stmt|;
name|fp
operator|->
name|fr_age
index|[
literal|1
index|]
operator|=
name|atoi
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
else|else
name|fp
operator|->
name|fr_age
index|[
literal|1
index|]
operator|=
name|fp
operator|->
name|fr_age
index|[
literal|0
index|]
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d: Unrecognised state keyword \"%s\"\n"
argument_list|,
name|linenum
argument_list|,
operator|*
operator|*
name|cp
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|printifname
parameter_list|(
name|format
parameter_list|,
name|name
parameter_list|,
name|ifp
parameter_list|)
name|char
modifier|*
name|format
decl_stmt|,
decl|*
name|name
decl_stmt|;
end_function

begin_decl_stmt
name|void
modifier|*
name|ifp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|format
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|==
name|NULL
operator|)
operator|&&
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"-"
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"*"
argument_list|)
condition|)
name|printf
argument_list|(
literal|"(!)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * print the filter structure in a useful way  */
end_comment

begin_function
name|void
name|printfr
parameter_list|(
name|fp
parameter_list|)
name|struct
name|frentry
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|protoent
modifier|*
name|p
decl_stmt|;
name|u_short
name|sec
index|[
literal|2
index|]
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|u_char
modifier|*
name|t
decl_stmt|;
name|int
name|pr
decl_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_PASS
condition|)
name|printf
argument_list|(
literal|"pass"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_NOMATCH
condition|)
name|printf
argument_list|(
literal|"nomatch"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_BLOCK
condition|)
block|{
name|printf
argument_list|(
literal|"block"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETICMP
condition|)
block|{
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETMASK
operator|)
operator|==
name|FR_FAKEICMP
condition|)
name|printf
argument_list|(
literal|" return-icmp-as-dest"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETMASK
operator|)
operator|==
name|FR_RETICMP
condition|)
name|printf
argument_list|(
literal|" return-icmp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_icode
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_icode
operator|<=
name|MAX_ICMPCODE
condition|)
name|printf
argument_list|(
literal|"(%s)"
argument_list|,
name|icmpcodes
index|[
operator|(
name|int
operator|)
name|fp
operator|->
name|fr_icode
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"(%d)"
argument_list|,
name|fp
operator|->
name|fr_icode
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETMASK
operator|)
operator|==
name|FR_RETRST
condition|)
name|printf
argument_list|(
literal|" return-rst"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGMASK
operator|)
operator|==
name|FR_LOG
condition|)
block|{
name|printlog
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_ACCOUNT
condition|)
name|printf
argument_list|(
literal|"count"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_AUTH
condition|)
name|printf
argument_list|(
literal|"auth"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_PREAUTH
condition|)
name|printf
argument_list|(
literal|"preauth"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_skip
condition|)
name|printf
argument_list|(
literal|"skip %hu"
argument_list|,
name|fp
operator|->
name|fr_skip
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_OUTQUE
condition|)
name|printf
argument_list|(
literal|" out "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" in "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGB
operator|)
operator|==
name|FR_LOGB
operator|)
operator|||
operator|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGP
operator|)
operator|==
name|FR_LOGP
operator|)
condition|)
block|{
name|printlog
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_QUICK
condition|)
name|printf
argument_list|(
literal|"quick "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_ifname
condition|)
block|{
name|printifname
argument_list|(
literal|"on "
argument_list|,
name|fp
operator|->
name|fr_ifname
argument_list|,
name|fp
operator|->
name|fr_ifa
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_ifnames
index|[
literal|1
index|]
operator|&&
name|strcmp
argument_list|(
name|fp
operator|->
name|fr_ifnames
index|[
literal|1
index|]
argument_list|,
literal|"*"
argument_list|)
condition|)
name|printifname
argument_list|(
literal|","
argument_list|,
name|fp
operator|->
name|fr_ifnames
index|[
literal|1
index|]
argument_list|,
name|fp
operator|->
name|fr_ifas
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_dif
operator|.
name|fd_ifname
condition|)
name|print_toif
argument_list|(
literal|"dup-to"
argument_list|,
operator|&
name|fp
operator|->
name|fr_dif
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_tif
operator|.
name|fd_ifname
condition|)
name|print_toif
argument_list|(
literal|"to"
argument_list|,
operator|&
name|fp
operator|->
name|fr_tif
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_FASTROUTE
condition|)
name|printf
argument_list|(
literal|"fastroute "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|fp
operator|->
name|fr_ifnames
index|[
literal|2
index|]
operator|&&
name|strcmp
argument_list|(
name|fp
operator|->
name|fr_ifnames
index|[
literal|2
index|]
argument_list|,
literal|"*"
argument_list|)
operator|)
operator|||
operator|(
operator|*
name|fp
operator|->
name|fr_ifnames
index|[
literal|3
index|]
operator|&&
name|strcmp
argument_list|(
name|fp
operator|->
name|fr_ifnames
index|[
literal|3
index|]
argument_list|,
literal|"*"
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_OUTQUE
condition|)
name|printf
argument_list|(
literal|"in-via "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"out-via "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_ifnames
index|[
literal|2
index|]
condition|)
block|{
name|printifname
argument_list|(
literal|""
argument_list|,
name|fp
operator|->
name|fr_ifnames
index|[
literal|2
index|]
argument_list|,
name|fp
operator|->
name|fr_ifas
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_ifnames
index|[
literal|3
index|]
condition|)
name|printifname
argument_list|(
literal|""
argument_list|,
name|fp
operator|->
name|fr_ifnames
index|[
literal|3
index|]
argument_list|,
name|fp
operator|->
name|fr_ifas
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_tos
condition|)
name|printf
argument_list|(
literal|"tos %#x "
argument_list|,
name|fp
operator|->
name|fr_tos
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_ttl
condition|)
name|printf
argument_list|(
literal|"ttl %d "
argument_list|,
name|fp
operator|->
name|fr_ttl
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_fl
operator|&
name|FI_TCPUDP
condition|)
block|{
name|printf
argument_list|(
literal|"proto tcp/udp "
argument_list|)
expr_stmt|;
name|pr
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pr
operator|=
name|fp
operator|->
name|fr_mip
operator|.
name|fi_p
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|p
operator|=
name|getprotobynumber
argument_list|(
name|fp
operator|->
name|fr_proto
argument_list|)
operator|)
condition|)
name|printf
argument_list|(
literal|"proto %s "
argument_list|,
name|p
operator|->
name|p_name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"proto %d "
argument_list|,
name|fp
operator|->
name|fr_proto
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"from %s"
argument_list|,
name|fp
operator|->
name|fr_flags
operator|&
name|FR_NOTSRCIP
condition|?
literal|"!"
else|:
literal|""
argument_list|)
expr_stmt|;
name|printhostmask
argument_list|(
name|fp
operator|->
name|fr_v
argument_list|,
operator|(
name|u_32_t
operator|*
operator|)
operator|&
name|fp
operator|->
name|fr_src
operator|.
name|s_addr
argument_list|,
operator|(
name|u_32_t
operator|*
operator|)
operator|&
name|fp
operator|->
name|fr_smsk
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_scmp
condition|)
name|printportcmp
argument_list|(
name|pr
argument_list|,
operator|&
name|fp
operator|->
name|fr_tuc
operator|.
name|ftu_src
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" to %s"
argument_list|,
name|fp
operator|->
name|fr_flags
operator|&
name|FR_NOTDSTIP
condition|?
literal|"!"
else|:
literal|""
argument_list|)
expr_stmt|;
name|printhostmask
argument_list|(
name|fp
operator|->
name|fr_v
argument_list|,
operator|(
name|u_32_t
operator|*
operator|)
operator|&
name|fp
operator|->
name|fr_dst
operator|.
name|s_addr
argument_list|,
operator|(
name|u_32_t
operator|*
operator|)
operator|&
name|fp
operator|->
name|fr_dmsk
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_dcmp
condition|)
name|printportcmp
argument_list|(
name|pr
argument_list|,
operator|&
name|fp
operator|->
name|fr_tuc
operator|.
name|ftu_dst
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_fl
operator|&
operator|~
name|FI_TCPUDP
operator|)
operator|||
operator|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_fl
operator|&
operator|~
name|FI_TCPUDP
operator|)
operator|||
name|fp
operator|->
name|fr_ip
operator|.
name|fi_optmsk
operator|||
name|fp
operator|->
name|fr_mip
operator|.
name|fi_optmsk
operator|||
name|fp
operator|->
name|fr_ip
operator|.
name|fi_secmsk
operator|||
name|fp
operator|->
name|fr_mip
operator|.
name|fi_secmsk
condition|)
block|{
name|printf
argument_list|(
literal|" with"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_optmsk
operator|||
name|fp
operator|->
name|fr_mip
operator|.
name|fi_optmsk
operator|||
name|fp
operator|->
name|fr_ip
operator|.
name|fi_secmsk
operator|||
name|fp
operator|->
name|fr_mip
operator|.
name|fi_secmsk
condition|)
block|{
name|sec
index|[
literal|0
index|]
operator|=
name|fp
operator|->
name|fr_mip
operator|.
name|fi_secmsk
expr_stmt|;
name|sec
index|[
literal|1
index|]
operator|=
name|fp
operator|->
name|fr_ip
operator|.
name|fi_secmsk
expr_stmt|;
name|optprint
argument_list|(
name|sec
argument_list|,
name|fp
operator|->
name|fr_mip
operator|.
name|fi_optmsk
argument_list|,
name|fp
operator|->
name|fr_ip
operator|.
name|fi_optmsk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_fl
operator|&
name|FI_OPTIONS
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_fl
operator|&
name|FI_OPTIONS
operator|)
condition|)
name|printf
argument_list|(
literal|" not"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" ipopt"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_fl
operator|&
name|FI_SHORT
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_fl
operator|&
name|FI_SHORT
operator|)
condition|)
name|printf
argument_list|(
literal|" not"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" short"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_fl
operator|&
name|FI_FRAG
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_fl
operator|&
name|FI_FRAG
operator|)
condition|)
name|printf
argument_list|(
literal|" not"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" frag"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fp
operator|->
name|fr_proto
operator|==
name|IPPROTO_ICMP
operator|&&
name|fp
operator|->
name|fr_icmpm
operator|!=
literal|0
condition|)
block|{
name|int
name|type
init|=
name|fp
operator|->
name|fr_icmp
decl_stmt|,
name|code
decl_stmt|;
name|type
operator|=
name|ntohs
argument_list|(
name|fp
operator|->
name|fr_icmp
argument_list|)
expr_stmt|;
name|code
operator|=
name|type
operator|&
literal|0xff
expr_stmt|;
name|type
operator|/=
literal|256
expr_stmt|;
if|if
condition|(
name|type
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|icmptypes
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|-
literal|1
operator|)
operator|&&
name|icmptypes
index|[
name|type
index|]
condition|)
name|printf
argument_list|(
literal|" icmp-type %s"
argument_list|,
name|icmptypes
index|[
name|type
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" icmp-type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntohs
argument_list|(
name|fp
operator|->
name|fr_icmpm
argument_list|)
operator|&
literal|0xff
condition|)
name|printf
argument_list|(
literal|" code %d"
argument_list|,
name|code
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_proto
operator|==
name|IPPROTO_ICMPV6
operator|&&
name|fp
operator|->
name|fr_icmpm
operator|!=
literal|0
condition|)
block|{
name|int
name|type
init|=
name|fp
operator|->
name|fr_icmp
decl_stmt|,
name|code
decl_stmt|;
name|type
operator|=
name|ntohs
argument_list|(
name|fp
operator|->
name|fr_icmp
argument_list|)
expr_stmt|;
name|code
operator|=
name|type
operator|&
literal|0xff
expr_stmt|;
name|type
operator|/=
literal|256
expr_stmt|;
name|printf
argument_list|(
literal|" icmp-type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntohs
argument_list|(
name|fp
operator|->
name|fr_icmpm
argument_list|)
operator|&
literal|0xff
condition|)
name|printf
argument_list|(
literal|" code %d"
argument_list|,
name|code
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_proto
operator|==
name|IPPROTO_TCP
operator|&&
operator|(
name|fp
operator|->
name|fr_tcpf
operator|||
name|fp
operator|->
name|fr_tcpfm
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|" flags "
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_tcpf
operator|&
operator|~
name|TCPF_ALL
condition|)
name|printf
argument_list|(
literal|"0x%x"
argument_list|,
name|fp
operator|->
name|fr_tcpf
argument_list|)
expr_stmt|;
else|else
for|for
control|(
name|s
operator|=
name|flagset
operator|,
name|t
operator|=
name|flags
init|;
operator|*
name|s
condition|;
name|s
operator|++
operator|,
name|t
operator|++
control|)
if|if
condition|(
name|fp
operator|->
name|fr_tcpf
operator|&
operator|*
name|t
condition|)
operator|(
name|void
operator|)
name|putchar
argument_list|(
operator|*
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_tcpfm
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_tcpfm
operator|&
operator|~
name|TCPF_ALL
condition|)
name|printf
argument_list|(
literal|"0x%x"
argument_list|,
name|fp
operator|->
name|fr_tcpfm
argument_list|)
expr_stmt|;
else|else
for|for
control|(
name|s
operator|=
name|flagset
operator|,
name|t
operator|=
name|flags
init|;
operator|*
name|s
condition|;
name|s
operator|++
operator|,
name|t
operator|++
control|)
if|if
condition|(
name|fp
operator|->
name|fr_tcpfm
operator|&
operator|*
name|t
condition|)
operator|(
name|void
operator|)
name|putchar
argument_list|(
operator|*
name|s
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_KEEPSTATE
condition|)
name|printf
argument_list|(
literal|" keep state"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_KEEPFRAG
condition|)
name|printf
argument_list|(
literal|" keep frags"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_age
index|[
literal|0
index|]
operator|!=
literal|0
operator|||
name|fp
operator|->
name|fr_age
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|" state-age %u/%u"
argument_list|,
name|fp
operator|->
name|fr_age
index|[
literal|0
index|]
argument_list|,
name|fp
operator|->
name|fr_age
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_grhead
condition|)
name|printf
argument_list|(
literal|" head %d"
argument_list|,
name|fp
operator|->
name|fr_grhead
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_group
condition|)
name|printf
argument_list|(
literal|" group %d"
argument_list|,
name|fp
operator|->
name|fr_group
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|binprint
parameter_list|(
name|fp
parameter_list|)
name|struct
name|frentry
modifier|*
name|fp
decl_stmt|;
block|{
name|int
name|i
init|=
sizeof|sizeof
argument_list|(
operator|*
name|fp
argument_list|)
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|;
name|u_char
modifier|*
name|s
decl_stmt|;
for|for
control|(
name|s
operator|=
operator|(
name|u_char
operator|*
operator|)
name|fp
init|;
name|i
condition|;
name|i
operator|--
operator|,
name|s
operator|++
control|)
block|{
name|j
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"%02x "
argument_list|,
operator|*
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|==
literal|16
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|printlog
parameter_list|(
name|fp
parameter_list|)
name|frentry_t
modifier|*
name|fp
decl_stmt|;
block|{
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|u
decl_stmt|;
name|printf
argument_list|(
literal|"log"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGBODY
condition|)
name|printf
argument_list|(
literal|" body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGFIRST
condition|)
name|printf
argument_list|(
literal|" first"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGORBLOCK
condition|)
name|printf
argument_list|(
literal|" or-block"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_loglevel
operator|!=
literal|0xffff
condition|)
block|{
name|printf
argument_list|(
literal|" level "
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_loglevel
operator|&
name|LOG_FACMASK
condition|)
block|{
name|s
operator|=
name|fac_toname
argument_list|(
name|fp
operator|->
name|fr_loglevel
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
name|s
operator|=
literal|"!!!"
expr_stmt|;
block|}
else|else
name|s
operator|=
literal|""
expr_stmt|;
name|u
operator|=
name|pri_toname
argument_list|(
name|fp
operator|->
name|fr_loglevel
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|==
name|NULL
condition|)
name|u
operator|=
literal|"!!!"
expr_stmt|;
if|if
condition|(
operator|*
name|s
condition|)
name|printf
argument_list|(
literal|"%s.%s"
argument_list|,
name|s
argument_list|,
name|u
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


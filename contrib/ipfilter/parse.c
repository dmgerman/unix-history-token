begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * (C)opyright 1993-1996 by Darren Reed.  *  * Redistribution and use in source and binary forms are permitted  * provided that this notice is preserved and due credit is given  * to the original author and the contributors.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|__SVR4
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__svr4__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/byteorder.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<arpa/nameser.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<resolv.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"ip_compat.h"
end_include

begin_include
include|#
directive|include
file|"ip_fil.h"
end_include

begin_include
include|#
directive|include
file|"ipf.h"
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
operator|&&
name|defined
argument_list|(
name|LIBC_SCCS
argument_list|)
end_if

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)parse.c	1.44 6/5/96 (C) 1993-1996 Darren Reed"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|rcsid
index|[]
init|=
literal|"$Id: parse.c,v 2.0.2.7 1997/05/08 11:24:09 darrenr Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|struct
name|ipopt_names
name|ionames
index|[]
decl_stmt|,
name|secclass
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|opts
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_short
name|portnum
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|tcp_flags
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|u_char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|addicmp
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|*
operator|*
operator|,
expr|struct
name|frentry
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|extras
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|*
operator|*
operator|,
expr|struct
name|frentry
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
modifier|*
name|seg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_long
modifier|*
name|sa
decl_stmt|,
modifier|*
name|msk
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_short
modifier|*
name|pp
decl_stmt|,
modifier|*
name|tp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|hostmask
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|*
operator|*
operator|,
name|u_long
operator|*
operator|,
name|u_long
operator|*
operator|,
name|u_short
operator|*
operator|,
name|u_char
operator|*
operator|,
name|u_short
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ports
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|*
operator|*
operator|,
name|u_short
operator|*
operator|,
name|u_char
operator|*
operator|,
name|u_short
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|icmpcode
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|)
argument_list|)
decl_stmt|,
name|addkeep
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|*
operator|*
operator|,
expr|struct
name|frentry
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|to_interface
name|__P
argument_list|(
operator|(
name|frdest_t
operator|*
operator|,
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|print_toif
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|frdest_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|optprint
name|__P
argument_list|(
operator|(
name|u_short
operator|,
name|u_short
operator|,
name|u_long
operator|,
name|u_long
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|countbits
name|__P
argument_list|(
operator|(
name|u_long
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|portname
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|proto
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|flagset
index|[]
init|=
literal|"FSRPAU"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|flags
index|[]
init|=
block|{
name|TH_FIN
block|,
name|TH_SYN
block|,
name|TH_RST
block|,
name|TH_PUSH
block|,
name|TH_ACK
block|,
name|TH_URG
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|thishost
index|[
literal|64
index|]
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|initparse
parameter_list|()
block|{
name|gethostname
argument_list|(
name|thishost
argument_list|,
sizeof|sizeof
argument_list|(
name|thishost
argument_list|)
argument_list|)
expr_stmt|;
name|thishost
index|[
sizeof|sizeof
argument_list|(
name|thishost
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_comment
comment|/* parse()  *  * parse a line read from the input filter rule file  */
end_comment

begin_function
name|struct
name|frentry
modifier|*
name|parse
parameter_list|(
name|line
parameter_list|)
name|char
modifier|*
name|line
decl_stmt|;
block|{
specifier|static
name|struct
name|frentry
name|fil
decl_stmt|;
name|struct
name|protoent
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|cps
index|[
literal|31
index|]
decl_stmt|,
modifier|*
modifier|*
name|cpp
decl_stmt|;
name|u_char
name|ch
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cnt
init|=
literal|1
decl_stmt|;
while|while
condition|(
operator|*
name|line
operator|&&
name|isspace
argument_list|(
operator|*
name|line
argument_list|)
condition|)
name|line
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|line
condition|)
return|return
name|NULL
return|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fil
argument_list|,
sizeof|sizeof
argument_list|(
name|fil
argument_list|)
argument_list|)
expr_stmt|;
name|fil
operator|.
name|fr_mip
operator|.
name|fi_v
operator|=
literal|0xf
expr_stmt|;
name|fil
operator|.
name|fr_ip
operator|.
name|fi_v
operator|=
literal|4
expr_stmt|;
comment|/* 	 * break line up into max of 20 segments 	 */
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"parse [%s]\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
operator|*
name|cps
operator|=
name|strtok
argument_list|(
name|line
argument_list|,
literal|" \b\t\r\n"
argument_list|)
init|;
name|cps
index|[
name|i
index|]
operator|&&
name|i
operator|<
literal|30
condition|;
name|cnt
operator|++
control|)
name|cps
index|[
operator|++
name|i
index|]
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|" \b\t\r\n"
argument_list|)
expr_stmt|;
name|cps
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|cnt
operator|<
literal|3
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"not enough segments in line\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cpp
operator|=
name|cps
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|cpp
operator|==
literal|'@'
condition|)
name|fil
operator|.
name|fr_hits
operator|=
operator|(
name|U_QUAD_T
operator|)
name|atoi
argument_list|(
operator|*
name|cpp
operator|++
operator|+
literal|1
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"block"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator|=
name|FR_BLOCK
expr_stmt|;
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
argument_list|,
literal|"return-icmp"
argument_list|,
literal|11
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_RETICMP
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
operator|*
operator|(
operator|*
name|cpp
operator|+
literal|11
operator|)
operator|==
literal|'('
condition|)
block|{
name|fil
operator|.
name|fr_icode
operator|=
name|icmpcode
argument_list|(
operator|*
name|cpp
operator|+
literal|12
argument_list|)
expr_stmt|;
if|if
condition|(
name|fil
operator|.
name|fr_icode
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"uncrecognised icmp code %s\n"
argument_list|,
operator|*
name|cpp
operator|+
literal|12
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
argument_list|,
literal|"return-rst"
argument_list|,
literal|10
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_RETRST
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"count"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator|=
name|FR_ACCOUNT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"pass"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator|=
name|FR_PASS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"log"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator|=
name|FR_LOG
expr_stmt|;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
argument_list|,
literal|"body"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGBODY
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
argument_list|,
literal|"first"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGFIRST
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 		 * Doesn't start with one of the action words 		 */
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown keyword (%s)\n"
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"in"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
name|fil
operator|.
name|fr_flags
operator||=
name|FR_INQUE
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"out"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_OUTQUE
expr_stmt|;
if|if
condition|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_RETICMP
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can only use return-icmp with 'in'\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
elseif|else
if|if
condition|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_RETRST
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can only use return-rst with 'in'\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"missing 'in'/'out' keyword (%s)\n"
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"log"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_PASS
condition|)
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGP
expr_stmt|;
elseif|else
if|if
condition|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_BLOCK
condition|)
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGB
expr_stmt|;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"body"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGBODY
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"first"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGFIRST
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"or-block"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_PASS
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"or-block must be used with pass\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_flags
operator||=
name|FR_LOGORBLOCK
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"quick"
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
block|{
name|cpp
operator|++
expr_stmt|;
name|fil
operator|.
name|fr_flags
operator||=
name|FR_QUICK
expr_stmt|;
block|}
operator|*
name|fil
operator|.
name|fr_ifname
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"on"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"interface name missing\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|fil
operator|.
name|fr_ifname
argument_list|,
operator|*
name|cpp
argument_list|,
name|IFNAMSIZ
operator|-
literal|1
argument_list|)
expr_stmt|;
name|fil
operator|.
name|fr_ifname
index|[
name|IFNAMSIZ
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|cpp
condition|)
block|{
if|if
condition|(
name|fil
operator|.
name|fr_flags
operator|&
name|FR_RETRST
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s can only be used with TCP\n"
argument_list|,
literal|"return-rst"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
operator|&
name|fil
return|;
block|}
if|if
condition|(
operator|*
name|cpp
condition|)
block|{
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"dup-to"
argument_list|)
operator|&&
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
condition|)
block|{
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
name|to_interface
argument_list|(
operator|&
name|fil
operator|.
name|fr_dif
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
return|return
name|NULL
return|;
name|cpp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"to"
argument_list|)
operator|&&
operator|*
operator|(
name|cpp
operator|+
literal|1
operator|)
condition|)
block|{
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
name|to_interface
argument_list|(
operator|&
name|fil
operator|.
name|fr_tif
argument_list|,
operator|*
name|cpp
argument_list|)
condition|)
return|return
name|NULL
return|;
name|cpp
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"fastroute"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_FASTROUTE
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"tos"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"tos missing value\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_tos
operator|=
name|strtol
argument_list|(
operator|*
name|cpp
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fil
operator|.
name|fr_mip
operator|.
name|fi_tos
operator|=
literal|0xff
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"ttl"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ttl missing hopcount value\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_ttl
operator|=
name|atoi
argument_list|(
operator|*
name|cpp
argument_list|)
expr_stmt|;
name|fil
operator|.
name|fr_mip
operator|.
name|fi_ttl
operator|=
literal|0xff
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
comment|/* 	 * check for "proto<protoname>" only decode udp/tcp/icmp as protoname 	 */
name|proto
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"proto"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"protocol name missing\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"tcp/udp"
argument_list|)
condition|)
block|{
name|fil
operator|.
name|fr_ip
operator|.
name|fi_fl
operator||=
name|FI_TCPUDP
expr_stmt|;
name|fil
operator|.
name|fr_mip
operator|.
name|fi_fl
operator||=
name|FI_TCPUDP
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|p
operator|=
name|getprotobyname
argument_list|(
operator|*
name|cpp
argument_list|)
operator|)
operator|&&
operator|!
name|isdigit
argument_list|(
operator|*
operator|*
name|cpp
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown protocol (%s)\n"
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|p
condition|)
name|fil
operator|.
name|fr_proto
operator|=
name|p
operator|->
name|p_proto
expr_stmt|;
elseif|else
if|if
condition|(
name|isdigit
argument_list|(
operator|*
operator|*
name|cpp
argument_list|)
condition|)
name|fil
operator|.
name|fr_proto
operator|=
name|atoi
argument_list|(
operator|*
name|cpp
argument_list|)
expr_stmt|;
name|fil
operator|.
name|fr_mip
operator|.
name|fi_p
operator|=
literal|0xff
expr_stmt|;
block|}
name|proto
operator|=
operator|*
name|cpp
expr_stmt|;
if|if
condition|(
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_TCP
operator|&&
name|fil
operator|.
name|fr_flags
operator|&
name|FR_RETRST
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s can only be used with TCP\n"
argument_list|,
literal|"return-rst"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
return|return
operator|&
name|fil
return|;
block|}
if|if
condition|(
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_TCP
operator|&&
name|fil
operator|.
name|fr_flags
operator|&
name|FR_RETRST
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s can only be used with TCP\n"
argument_list|,
literal|"return-rst"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 	 * get the from host and bit mask to use against packets 	 */
if|if
condition|(
operator|!
operator|*
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"missing source specification\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"all"
argument_list|)
condition|)
block|{
name|cpp
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|cpp
condition|)
return|return
operator|&
name|fil
return|;
block|}
else|else
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"from"
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unexpected keyword (%s) - from\n"
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"missing host after from\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ch
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|cpp
operator|==
literal|'!'
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_NOTSRCIP
expr_stmt|;
operator|(
operator|*
name|cpp
operator|)
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|hostmask
argument_list|(
operator|&
name|cpp
argument_list|,
operator|(
name|u_long
operator|*
operator|)
operator|&
name|fil
operator|.
name|fr_src
argument_list|,
operator|(
name|u_long
operator|*
operator|)
operator|&
name|fil
operator|.
name|fr_smsk
argument_list|,
operator|&
name|fil
operator|.
name|fr_sport
argument_list|,
operator|&
name|ch
argument_list|,
operator|&
name|fil
operator|.
name|fr_stop
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad host (%s)\n"
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_scmp
operator|=
name|ch
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|cpp
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"missing to fields\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 		 * do the same for the to field (destination host) 		 */
if|if
condition|(
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"to"
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unexpected keyword (%s) - to\n"
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"missing host after to\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ch
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|cpp
operator|==
literal|'!'
condition|)
block|{
name|fil
operator|.
name|fr_flags
operator||=
name|FR_NOTDSTIP
expr_stmt|;
operator|(
operator|*
name|cpp
operator|)
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|hostmask
argument_list|(
operator|&
name|cpp
argument_list|,
operator|(
name|u_long
operator|*
operator|)
operator|&
name|fil
operator|.
name|fr_dst
argument_list|,
operator|(
name|u_long
operator|*
operator|)
operator|&
name|fil
operator|.
name|fr_dmsk
argument_list|,
operator|&
name|fil
operator|.
name|fr_dport
argument_list|,
operator|&
name|ch
argument_list|,
operator|&
name|fil
operator|.
name|fr_dtop
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad host (%s)\n"
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_dcmp
operator|=
name|ch
expr_stmt|;
block|}
comment|/* 	 * check some sanity, make sure we don't have icmp checks with tcp 	 * or udp or visa versa. 	 */
if|if
condition|(
name|fil
operator|.
name|fr_proto
operator|&&
operator|(
name|fil
operator|.
name|fr_dcmp
operator|||
name|fil
operator|.
name|fr_scmp
operator|)
operator|&&
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_TCP
operator|&&
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_UDP
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"port operation on non tcp/udp\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|fil
operator|.
name|fr_icmp
operator|&&
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_ICMP
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"icmp comparisons on wrong protocol\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|*
name|cpp
condition|)
return|return
operator|&
name|fil
return|;
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"flags"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|++
name|cpp
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"no flags present\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fil
operator|.
name|fr_tcpf
operator|=
name|tcp_flags
argument_list|(
operator|*
name|cpp
argument_list|,
operator|&
name|fil
operator|.
name|fr_tcpfm
argument_list|)
expr_stmt|;
name|cpp
operator|++
expr_stmt|;
block|}
comment|/* 	 * extras... 	 */
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"with"
argument_list|)
operator|||
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"and"
argument_list|)
operator|)
condition|)
if|if
condition|(
name|extras
argument_list|(
operator|&
name|cpp
argument_list|,
operator|&
name|fil
argument_list|)
condition|)
return|return
name|NULL
return|;
comment|/* 	 * icmp types for use with the icmp protocol 	 */
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"icmp-type"
argument_list|)
condition|)
block|{
if|if
condition|(
name|fil
operator|.
name|fr_proto
operator|!=
name|IPPROTO_ICMP
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"icmp with wrong protocol (%d)\n"
argument_list|,
name|fil
operator|.
name|fr_proto
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|addicmp
argument_list|(
operator|&
name|cpp
argument_list|,
operator|&
name|fil
argument_list|)
condition|)
return|return
name|NULL
return|;
name|fil
operator|.
name|fr_icmp
operator|=
name|htons
argument_list|(
name|fil
operator|.
name|fr_icmp
argument_list|)
expr_stmt|;
name|fil
operator|.
name|fr_icmpm
operator|=
name|htons
argument_list|(
name|fil
operator|.
name|fr_icmpm
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Keep something... 	 */
while|while
condition|(
operator|*
name|cpp
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
name|cpp
argument_list|,
literal|"keep"
argument_list|)
condition|)
if|if
condition|(
name|addkeep
argument_list|(
operator|&
name|cpp
argument_list|,
operator|&
name|fil
argument_list|)
condition|)
return|return
name|NULL
return|;
comment|/* 	 * leftovers...yuck 	 */
if|if
condition|(
operator|*
name|cpp
operator|&&
operator|*
operator|*
name|cpp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown words at end: ["
argument_list|)
expr_stmt|;
for|for
control|(
init|;
operator|*
name|cpp
condition|;
name|cpp
operator|++
control|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s "
argument_list|,
operator|*
name|cpp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"]\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 	 * lazy users... 	 */
if|if
condition|(
operator|!
name|fil
operator|.
name|fr_proto
operator|&&
operator|(
name|fil
operator|.
name|fr_dcmp
operator|||
name|fil
operator|.
name|fr_scmp
operator|||
name|fil
operator|.
name|fr_tcpf
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"no protocol given for TCP/UDP comparisons\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 	if ((fil.fr_flags& FR_KEEPFRAG)&& 	    (!(fil.fr_ip.fi_fl& FI_FRAG) || !(fil.fr_ip.fi_fl& FI_FRAG))) { 		(void)fprintf(stderr, 			"must use 'with frags' with 'keep frags'\n"); 		return NULL; 	} */
return|return
operator|&
name|fil
return|;
block|}
end_function

begin_function
name|int
name|to_interface
parameter_list|(
name|fdp
parameter_list|,
name|to
parameter_list|)
name|frdest_t
modifier|*
name|fdp
decl_stmt|;
name|char
modifier|*
name|to
decl_stmt|;
block|{
name|int
name|r
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|s
operator|=
name|index
argument_list|(
name|to
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
name|fdp
operator|->
name|fd_ifp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
operator|*
name|s
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|fdp
operator|->
name|fd_ip
operator|.
name|s_addr
operator|=
name|hostnum
argument_list|(
name|s
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
block|}
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|fdp
operator|->
name|fd_ifname
argument_list|,
name|to
argument_list|,
sizeof|sizeof
argument_list|(
name|fdp
operator|->
name|fd_ifname
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|fdp
operator|->
name|fd_ifname
index|[
sizeof|sizeof
argument_list|(
name|fdp
operator|->
name|fd_ifname
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|print_toif
parameter_list|(
name|tag
parameter_list|,
name|fdp
parameter_list|)
name|char
modifier|*
name|tag
decl_stmt|;
name|frdest_t
modifier|*
name|fdp
decl_stmt|;
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s %s%s"
argument_list|,
name|tag
argument_list|,
name|fdp
operator|->
name|fd_ifname
argument_list|,
operator|(
name|fdp
operator|->
name|fd_ifp
operator|||
operator|(
name|int
operator|)
name|fdp
operator|->
name|fd_ifp
operator|==
operator|-
literal|1
operator|)
condition|?
literal|""
else|:
literal|"(!)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fdp
operator|->
name|fd_ip
operator|.
name|s_addr
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|":%s"
argument_list|,
name|inet_ntoa
argument_list|(
name|fdp
operator|->
name|fd_ip
argument_list|)
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * returns false if neither "hostmask/num" or "hostmask mask addr" are  * found in the line segments  */
end_comment

begin_function
name|int
name|hostmask
parameter_list|(
name|seg
parameter_list|,
name|sa
parameter_list|,
name|msk
parameter_list|,
name|pp
parameter_list|,
name|cp
parameter_list|,
name|tp
parameter_list|)
name|char
modifier|*
modifier|*
modifier|*
name|seg
decl_stmt|;
name|u_long
modifier|*
name|sa
decl_stmt|,
decl|*
name|msk
decl_stmt|;
end_function

begin_decl_stmt
name|u_short
modifier|*
name|pp
decl_stmt|,
modifier|*
name|tp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|bits
init|=
operator|-
literal|1
decl_stmt|,
name|resolved
decl_stmt|;
comment|/* 	 * is it possibly hostname/num ? 	 */
if|if
condition|(
operator|(
name|s
operator|=
name|index
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|'/'
argument_list|)
operator|)
condition|)
block|{
operator|*
name|s
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|isdigit
argument_list|(
operator|*
name|s
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|index
argument_list|(
name|s
argument_list|,
literal|'.'
argument_list|)
condition|)
operator|*
name|msk
operator|=
name|inet_addr
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|index
argument_list|(
name|s
argument_list|,
literal|'.'
argument_list|)
operator|&&
operator|!
name|index
argument_list|(
name|s
argument_list|,
literal|'x'
argument_list|)
condition|)
block|{
comment|/* 			 * set x most significant bits 			 */
for|for
control|(
name|bits
operator|=
name|atoi
argument_list|(
name|s
argument_list|)
init|;
name|bits
condition|;
name|bits
operator|--
control|)
block|{
operator|*
name|msk
operator|/=
literal|2
expr_stmt|;
operator|*
name|msk
operator||=
name|ntohl
argument_list|(
name|inet_addr
argument_list|(
literal|"128.0.0.0"
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|msk
operator|=
name|htonl
argument_list|(
operator|*
name|msk
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|inet_aton
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|in_addr
operator|*
operator|)
name|msk
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|sa
operator|=
name|hostnum
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
operator|&
name|resolved
argument_list|)
operator|&
operator|*
name|msk
expr_stmt|;
if|if
condition|(
name|resolved
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
operator|(
operator|*
name|seg
operator|)
operator|++
expr_stmt|;
return|return
name|ports
argument_list|(
name|seg
argument_list|,
name|pp
argument_list|,
name|cp
argument_list|,
name|tp
argument_list|)
return|;
block|}
comment|/* 	 * look for extra segments if "mask" found in right spot 	 */
if|if
condition|(
operator|*
operator|(
operator|*
name|seg
operator|+
literal|1
operator|)
operator|&&
operator|*
operator|(
operator|*
name|seg
operator|+
literal|2
operator|)
operator|&&
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|(
operator|*
name|seg
operator|+
literal|1
operator|)
argument_list|,
literal|"mask"
argument_list|)
condition|)
block|{
operator|*
name|sa
operator|=
name|hostnum
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
operator|&
name|resolved
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolved
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
operator|(
operator|*
name|seg
operator|)
operator|++
expr_stmt|;
operator|(
operator|*
name|seg
operator|)
operator|++
expr_stmt|;
if|if
condition|(
name|inet_aton
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
operator|(
expr|struct
name|in_addr
operator|*
operator|)
name|msk
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
operator|(
operator|*
name|seg
operator|)
operator|++
expr_stmt|;
operator|*
name|sa
operator|&=
operator|*
name|msk
expr_stmt|;
return|return
name|ports
argument_list|(
name|seg
argument_list|,
name|pp
argument_list|,
name|cp
argument_list|,
name|tp
argument_list|)
return|;
block|}
if|if
condition|(
operator|*
operator|*
name|seg
condition|)
block|{
operator|*
name|sa
operator|=
name|hostnum
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
operator|&
name|resolved
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolved
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
operator|(
operator|*
name|seg
operator|)
operator|++
expr_stmt|;
operator|*
name|msk
operator|=
operator|(
operator|*
name|sa
condition|?
name|inet_addr
argument_list|(
literal|"255.255.255.255"
argument_list|)
else|:
literal|0L
operator|)
expr_stmt|;
operator|*
name|sa
operator|&=
operator|*
name|msk
expr_stmt|;
return|return
name|ports
argument_list|(
name|seg
argument_list|,
name|pp
argument_list|,
name|cp
argument_list|,
name|tp
argument_list|)
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_block

begin_comment
comment|/*  * returns an ip address as a long var as a result of either a DNS lookup or  * straight inet_addr() call  */
end_comment

begin_function
name|u_long
name|hostnum
parameter_list|(
name|host
parameter_list|,
name|resolved
parameter_list|)
name|char
modifier|*
name|host
decl_stmt|;
name|int
modifier|*
name|resolved
decl_stmt|;
block|{
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|struct
name|netent
modifier|*
name|np
decl_stmt|;
operator|*
name|resolved
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"any"
argument_list|,
name|host
argument_list|)
condition|)
return|return
literal|0L
return|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|host
argument_list|)
condition|)
return|return
name|inet_addr
argument_list|(
name|host
argument_list|)
return|;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"<thishost>"
argument_list|,
name|host
argument_list|)
condition|)
name|host
operator|=
name|thishost
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|hp
operator|=
name|gethostbyname
argument_list|(
name|host
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|np
operator|=
name|getnetbyname
argument_list|(
name|host
argument_list|)
operator|)
condition|)
block|{
operator|*
name|resolved
operator|=
operator|-
literal|1
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"can't resolve hostname: %s\n"
argument_list|,
name|host
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|np
operator|->
name|n_net
return|;
block|}
return|return
operator|*
operator|(
name|u_long
operator|*
operator|)
name|hp
operator|->
name|h_addr
return|;
block|}
end_function

begin_comment
comment|/*  * check for possible presence of the port fields in the line  */
end_comment

begin_function
name|int
name|ports
parameter_list|(
name|seg
parameter_list|,
name|pp
parameter_list|,
name|cp
parameter_list|,
name|tp
parameter_list|)
name|char
modifier|*
modifier|*
modifier|*
name|seg
decl_stmt|;
name|u_short
modifier|*
name|pp
decl_stmt|,
decl|*
name|tp
decl_stmt|;
end_function

begin_decl_stmt
name|u_char
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|comp
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
operator|!
operator|*
name|seg
operator|||
operator|!
operator|*
operator|*
name|seg
operator|||
operator|!
operator|*
operator|*
operator|*
name|seg
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|"port"
argument_list|)
operator|&&
operator|*
operator|(
operator|*
name|seg
operator|+
literal|1
operator|)
operator|&&
operator|*
operator|(
operator|*
name|seg
operator|+
literal|2
operator|)
condition|)
block|{
operator|(
operator|*
name|seg
operator|)
operator|++
expr_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
operator|*
operator|*
name|seg
argument_list|)
operator|&&
operator|*
operator|(
operator|*
name|seg
operator|+
literal|2
operator|)
condition|)
block|{
operator|*
name|pp
operator|=
name|portnum
argument_list|(
operator|*
operator|*
name|seg
argument_list|)
expr_stmt|;
operator|(
operator|*
name|seg
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|"<>"
argument_list|)
condition|)
name|comp
operator|=
name|FR_OUTRANGE
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|"><"
argument_list|)
condition|)
name|comp
operator|=
name|FR_INRANGE
expr_stmt|;
operator|(
operator|*
name|seg
operator|)
operator|++
expr_stmt|;
operator|*
name|tp
operator|=
name|portnum
argument_list|(
operator|*
operator|*
name|seg
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|"="
argument_list|)
operator|||
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|"eq"
argument_list|)
condition|)
name|comp
operator|=
name|FR_EQUAL
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|"!="
argument_list|)
operator|||
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|"ne"
argument_list|)
condition|)
name|comp
operator|=
name|FR_NEQUAL
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|"<"
argument_list|)
operator|||
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|"lt"
argument_list|)
condition|)
name|comp
operator|=
name|FR_LESST
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|">"
argument_list|)
operator|||
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|"gt"
argument_list|)
condition|)
name|comp
operator|=
name|FR_GREATERT
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|"<="
argument_list|)
operator|||
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|"le"
argument_list|)
condition|)
name|comp
operator|=
name|FR_LESSTE
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|">="
argument_list|)
operator|||
operator|!
name|strcasecmp
argument_list|(
operator|*
operator|*
name|seg
argument_list|,
literal|"ge"
argument_list|)
condition|)
name|comp
operator|=
name|FR_GREATERTE
expr_stmt|;
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown comparator (%s)\n"
argument_list|,
operator|*
operator|*
name|seg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|comp
operator|!=
name|FR_OUTRANGE
operator|&&
name|comp
operator|!=
name|FR_INRANGE
condition|)
block|{
operator|(
operator|*
name|seg
operator|)
operator|++
expr_stmt|;
operator|*
name|pp
operator|=
name|portnum
argument_list|(
operator|*
operator|*
name|seg
argument_list|)
expr_stmt|;
block|}
operator|*
name|cp
operator|=
name|comp
expr_stmt|;
operator|(
operator|*
name|seg
operator|)
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_block

begin_comment
comment|/*  * find the port number given by the name, either from getservbyname() or  * straight atoi()  */
end_comment

begin_function
name|u_short
name|portnum
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
name|struct
name|servent
modifier|*
name|sp
decl_stmt|,
modifier|*
name|sp2
decl_stmt|;
name|u_short
name|p1
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|name
argument_list|)
condition|)
return|return
operator|(
name|u_short
operator|)
name|atoi
argument_list|(
name|name
argument_list|)
return|;
if|if
condition|(
operator|!
name|proto
condition|)
name|proto
operator|=
literal|"tcp/udp"
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|proto
argument_list|,
literal|"tcp/udp"
argument_list|)
condition|)
block|{
name|sp
operator|=
name|getservbyname
argument_list|(
name|name
argument_list|,
name|proto
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
condition|)
return|return
name|ntohs
argument_list|(
name|sp
operator|->
name|s_port
argument_list|)
return|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown service \"%s\".\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sp
operator|=
name|getservbyname
argument_list|(
name|name
argument_list|,
literal|"tcp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
condition|)
name|p1
operator|=
name|sp
operator|->
name|s_port
expr_stmt|;
name|sp2
operator|=
name|getservbyname
argument_list|(
name|name
argument_list|,
literal|"udp"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sp
operator|||
operator|!
name|sp2
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown tcp/udp service \"%s\".\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|p1
operator|!=
name|sp2
operator|->
name|s_port
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s %d/tcp is a different port to "
argument_list|,
name|name
argument_list|,
name|p1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s %d/udp\n"
argument_list|,
name|name
argument_list|,
name|sp
operator|->
name|s_port
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ntohs
argument_list|(
name|p1
argument_list|)
return|;
block|}
end_function

begin_function
name|u_char
name|tcp_flags
parameter_list|(
name|flgs
parameter_list|,
name|mask
parameter_list|)
name|char
modifier|*
name|flgs
decl_stmt|;
name|u_char
modifier|*
name|mask
decl_stmt|;
block|{
name|u_char
name|tcpf
init|=
literal|0
decl_stmt|,
name|tcpfm
init|=
literal|0
decl_stmt|,
modifier|*
name|fp
init|=
operator|&
name|tcpf
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|t
decl_stmt|;
for|for
control|(
name|s
operator|=
name|flgs
init|;
operator|*
name|s
condition|;
name|s
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|s
operator|==
literal|'/'
operator|&&
name|fp
operator|==
operator|&
name|tcpf
condition|)
block|{
name|fp
operator|=
operator|&
name|tcpfm
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
operator|(
name|t
operator|=
name|index
argument_list|(
name|flagset
argument_list|,
operator|*
name|s
argument_list|)
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown flag (%c)\n"
argument_list|,
operator|*
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|fp
operator||=
name|flags
index|[
name|t
operator|-
name|flagset
index|]
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|tcpfm
condition|)
name|tcpfm
operator|=
literal|0xff
expr_stmt|;
operator|*
name|mask
operator|=
name|tcpfm
expr_stmt|;
return|return
name|tcpf
return|;
block|}
end_function

begin_comment
comment|/*  * deal with extra bits on end of the line  */
end_comment

begin_function
name|int
name|extras
parameter_list|(
name|cp
parameter_list|,
name|fr
parameter_list|)
name|char
modifier|*
modifier|*
modifier|*
name|cp
decl_stmt|;
name|struct
name|frentry
modifier|*
name|fr
decl_stmt|;
block|{
name|u_short
name|secmsk
decl_stmt|;
name|u_long
name|opts
decl_stmt|;
name|int
name|notopt
decl_stmt|;
name|char
name|oflags
decl_stmt|;
name|opts
operator|=
literal|0
expr_stmt|;
name|secmsk
operator|=
literal|0
expr_stmt|;
name|notopt
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
operator|*
name|cp
condition|)
return|return
operator|-
literal|1
return|;
while|while
condition|(
operator|*
operator|*
name|cp
operator|&&
operator|(
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"ipopt"
argument_list|,
literal|5
argument_list|)
operator|||
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"not"
argument_list|,
literal|3
argument_list|)
operator|||
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"opt"
argument_list|,
literal|4
argument_list|)
operator|||
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"frag"
argument_list|,
literal|3
argument_list|)
operator|||
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"no"
argument_list|,
literal|2
argument_list|)
operator|||
operator|!
name|strncasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"short"
argument_list|,
literal|5
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'n'
operator|||
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'N'
condition|)
block|{
name|notopt
operator|=
literal|1
expr_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'i'
operator|||
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'I'
condition|)
block|{
if|if
condition|(
operator|!
name|notopt
condition|)
name|fr
operator|->
name|fr_ip
operator|.
name|fi_fl
operator||=
name|FI_OPTIONS
expr_stmt|;
name|fr
operator|->
name|fr_mip
operator|.
name|fi_fl
operator||=
name|FI_OPTIONS
expr_stmt|;
goto|goto
name|nextopt
goto|;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'f'
operator|||
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'F'
condition|)
block|{
if|if
condition|(
operator|!
name|notopt
condition|)
name|fr
operator|->
name|fr_ip
operator|.
name|fi_fl
operator||=
name|FI_FRAG
expr_stmt|;
name|fr
operator|->
name|fr_mip
operator|.
name|fi_fl
operator||=
name|FI_FRAG
expr_stmt|;
goto|goto
name|nextopt
goto|;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'o'
operator|||
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'O'
condition|)
block|{
if|if
condition|(
operator|!
operator|*
operator|(
operator|*
name|cp
operator|+
literal|1
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"opt missing arguements\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|opts
operator|=
name|optname
argument_list|(
name|cp
argument_list|,
operator|&
name|secmsk
argument_list|)
operator|)
condition|)
return|return
operator|-
literal|1
return|;
name|oflags
operator|=
name|FI_OPTIONS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'s'
operator|||
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'S'
condition|)
block|{
if|if
condition|(
name|fr
operator|->
name|fr_tcpf
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"short cannot be used with TCP flags\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|notopt
condition|)
name|fr
operator|->
name|fr_ip
operator|.
name|fi_fl
operator||=
name|FI_SHORT
expr_stmt|;
name|fr
operator|->
name|fr_mip
operator|.
name|fi_fl
operator||=
name|FI_SHORT
expr_stmt|;
goto|goto
name|nextopt
goto|;
block|}
else|else
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|notopt
operator|||
operator|!
name|opts
condition|)
name|fr
operator|->
name|fr_mip
operator|.
name|fi_fl
operator||=
name|oflags
expr_stmt|;
if|if
condition|(
name|notopt
condition|)
if|if
condition|(
operator|!
name|secmsk
condition|)
name|fr
operator|->
name|fr_mip
operator|.
name|fi_optmsk
operator||=
name|opts
expr_stmt|;
else|else
name|fr
operator|->
name|fr_mip
operator|.
name|fi_optmsk
operator||=
operator|(
name|opts
operator|&
operator|~
literal|0x0100
operator|)
expr_stmt|;
else|else
name|fr
operator|->
name|fr_mip
operator|.
name|fi_optmsk
operator||=
name|opts
expr_stmt|;
name|fr
operator|->
name|fr_mip
operator|.
name|fi_secmsk
operator||=
name|secmsk
expr_stmt|;
if|if
condition|(
name|notopt
condition|)
block|{
name|fr
operator|->
name|fr_ip
operator|.
name|fi_fl
operator|&=
operator|(
operator|~
name|oflags
operator|&
literal|0xf
operator|)
expr_stmt|;
name|fr
operator|->
name|fr_ip
operator|.
name|fi_optmsk
operator|&=
operator|~
name|opts
expr_stmt|;
name|fr
operator|->
name|fr_ip
operator|.
name|fi_secmsk
operator|&=
operator|~
name|secmsk
expr_stmt|;
block|}
else|else
block|{
name|fr
operator|->
name|fr_ip
operator|.
name|fi_fl
operator||=
name|oflags
expr_stmt|;
name|fr
operator|->
name|fr_ip
operator|.
name|fi_optmsk
operator||=
name|opts
expr_stmt|;
name|fr
operator|->
name|fr_ip
operator|.
name|fi_secmsk
operator||=
name|secmsk
expr_stmt|;
block|}
name|nextopt
label|:
name|notopt
operator|=
literal|0
expr_stmt|;
name|opts
operator|=
literal|0
expr_stmt|;
name|oflags
operator|=
literal|0
expr_stmt|;
name|secmsk
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|u_long
name|optname
parameter_list|(
name|cp
parameter_list|,
name|sp
parameter_list|)
name|char
modifier|*
modifier|*
modifier|*
name|cp
decl_stmt|;
name|u_short
modifier|*
name|sp
decl_stmt|;
block|{
name|struct
name|ipopt_names
modifier|*
name|io
decl_stmt|,
modifier|*
name|so
decl_stmt|;
name|u_long
name|msk
init|=
literal|0
decl_stmt|;
name|u_short
name|smsk
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|sec
init|=
literal|0
decl_stmt|;
for|for
control|(
name|s
operator|=
name|strtok
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|","
argument_list|)
init|;
name|s
condition|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|","
argument_list|)
control|)
block|{
for|for
control|(
name|io
operator|=
name|ionames
init|;
name|io
operator|->
name|on_name
condition|;
name|io
operator|++
control|)
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|s
argument_list|,
name|io
operator|->
name|on_name
argument_list|)
condition|)
block|{
name|msk
operator||=
name|io
operator|->
name|on_bit
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|io
operator|->
name|on_name
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown IP option name %s\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|s
argument_list|,
literal|"sec-class"
argument_list|)
condition|)
name|sec
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|sec
operator|&&
operator|!
operator|*
operator|(
operator|*
name|cp
operator|+
literal|1
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"missing security level after sec-class\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|sec
condition|)
block|{
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
for|for
control|(
name|s
operator|=
name|strtok
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|","
argument_list|)
init|;
name|s
condition|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|","
argument_list|)
control|)
block|{
for|for
control|(
name|so
operator|=
name|secclass
init|;
name|so
operator|->
name|on_name
condition|;
name|so
operator|++
control|)
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|s
argument_list|,
name|so
operator|->
name|on_name
argument_list|)
condition|)
block|{
name|smsk
operator||=
name|so
operator|->
name|on_bit
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|so
operator|->
name|on_name
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"no such security level: %s\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|smsk
condition|)
operator|*
name|sp
operator|=
name|smsk
expr_stmt|;
block|}
return|return
name|msk
return|;
block|}
end_function

begin_function
name|void
name|optprint
parameter_list|(
name|secmsk
parameter_list|,
name|secbits
parameter_list|,
name|optmsk
parameter_list|,
name|optbits
parameter_list|)
name|u_short
name|secmsk
decl_stmt|,
name|secbits
decl_stmt|;
name|u_long
name|optmsk
decl_stmt|,
name|optbits
decl_stmt|;
block|{
name|struct
name|ipopt_names
modifier|*
name|io
decl_stmt|,
modifier|*
name|so
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|secflag
init|=
literal|0
decl_stmt|;
name|s
operator|=
literal|" opt "
expr_stmt|;
for|for
control|(
name|io
operator|=
name|ionames
init|;
name|io
operator|->
name|on_name
condition|;
name|io
operator|++
control|)
if|if
condition|(
operator|(
name|io
operator|->
name|on_bit
operator|&
name|optmsk
operator|)
operator|&&
operator|(
operator|(
name|io
operator|->
name|on_bit
operator|&
name|optmsk
operator|)
operator|==
operator|(
name|io
operator|->
name|on_bit
operator|&
name|optbits
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|io
operator|->
name|on_value
operator|!=
name|IPOPT_SECURITY
operator|)
operator|||
operator|(
operator|!
name|secmsk
operator|&&
operator|!
name|secbits
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|s
argument_list|,
name|io
operator|->
name|on_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|on_value
operator|==
name|IPOPT_SECURITY
condition|)
name|io
operator|++
expr_stmt|;
name|s
operator|=
literal|","
expr_stmt|;
block|}
else|else
name|secflag
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|secmsk
operator|&
name|secbits
condition|)
block|{
name|printf
argument_list|(
literal|"%ssec-class"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
literal|" "
expr_stmt|;
for|for
control|(
name|so
operator|=
name|secclass
init|;
name|so
operator|->
name|on_name
condition|;
name|so
operator|++
control|)
if|if
condition|(
operator|(
name|secmsk
operator|&
name|so
operator|->
name|on_bit
operator|)
operator|&&
operator|(
operator|(
name|so
operator|->
name|on_bit
operator|&
name|secmsk
operator|)
operator|==
operator|(
name|so
operator|->
name|on_bit
operator|&
name|secbits
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|s
argument_list|,
name|so
operator|->
name|on_name
argument_list|)
expr_stmt|;
name|s
operator|=
literal|","
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|optmsk
operator|&&
operator|(
name|optmsk
operator|!=
name|optbits
operator|)
operator|)
operator|||
operator|(
name|secmsk
operator|&&
operator|(
name|secmsk
operator|!=
name|secbits
operator|)
operator|)
condition|)
block|{
name|s
operator|=
literal|" "
expr_stmt|;
name|printf
argument_list|(
literal|" not opt"
argument_list|)
expr_stmt|;
if|if
condition|(
name|optmsk
operator|!=
name|optbits
condition|)
block|{
for|for
control|(
name|io
operator|=
name|ionames
init|;
name|io
operator|->
name|on_name
condition|;
name|io
operator|++
control|)
if|if
condition|(
operator|(
name|io
operator|->
name|on_bit
operator|&
name|optmsk
operator|)
operator|&&
operator|(
operator|(
name|io
operator|->
name|on_bit
operator|&
name|optmsk
operator|)
operator|!=
operator|(
name|io
operator|->
name|on_bit
operator|&
name|optbits
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|io
operator|->
name|on_value
operator|!=
name|IPOPT_SECURITY
operator|)
operator|||
operator|(
operator|!
name|secmsk
operator|&&
operator|!
name|secbits
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|s
argument_list|,
name|io
operator|->
name|on_name
argument_list|)
expr_stmt|;
name|s
operator|=
literal|","
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|on_value
operator|==
name|IPOPT_SECURITY
condition|)
name|io
operator|++
expr_stmt|;
block|}
else|else
name|io
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|secmsk
operator|!=
name|secbits
condition|)
block|{
name|printf
argument_list|(
literal|"%ssec-class"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
literal|" "
expr_stmt|;
for|for
control|(
name|so
operator|=
name|secclass
init|;
name|so
operator|->
name|on_name
condition|;
name|so
operator|++
control|)
if|if
condition|(
operator|(
name|so
operator|->
name|on_bit
operator|&
name|secmsk
operator|)
operator|&&
operator|(
operator|(
name|so
operator|->
name|on_bit
operator|&
name|secmsk
operator|)
operator|!=
operator|(
name|so
operator|->
name|on_bit
operator|&
name|secbits
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|s
argument_list|,
name|so
operator|->
name|on_name
argument_list|)
expr_stmt|;
name|s
operator|=
literal|","
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_decl_stmt
name|char
modifier|*
name|icmptypes
index|[]
init|=
block|{
literal|"echorep"
block|,
operator|(
name|char
operator|*
operator|)
name|NULL
block|,
operator|(
name|char
operator|*
operator|)
name|NULL
block|,
literal|"unreach"
block|,
literal|"squench"
block|,
literal|"redir"
block|,
operator|(
name|char
operator|*
operator|)
name|NULL
block|,
operator|(
name|char
operator|*
operator|)
name|NULL
block|,
literal|"echo"
block|,
operator|(
name|char
operator|*
operator|)
name|NULL
block|,
operator|(
name|char
operator|*
operator|)
name|NULL
block|,
literal|"timex"
block|,
literal|"paramprob"
block|,
literal|"timest"
block|,
literal|"timestrep"
block|,
literal|"inforeq"
block|,
literal|"inforep"
block|,
literal|"maskreq"
block|,
literal|"maskrep"
block|,
literal|"END"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * set the icmp field to the correct type if "icmp" word is found  */
end_comment

begin_function
name|int
name|addicmp
parameter_list|(
name|cp
parameter_list|,
name|fp
parameter_list|)
name|char
modifier|*
modifier|*
modifier|*
name|cp
decl_stmt|;
name|struct
name|frentry
modifier|*
name|fp
decl_stmt|;
block|{
name|char
modifier|*
modifier|*
name|t
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
operator|*
name|cp
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|fp
operator|->
name|fr_proto
condition|)
comment|/* to catch lusers */
name|fp
operator|->
name|fr_proto
operator|=
name|IPPROTO_ICMP
expr_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
operator|*
operator|*
name|cp
argument_list|)
condition|)
block|{
name|i
operator|=
name|atoi
argument_list|(
operator|*
operator|*
name|cp
argument_list|)
expr_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|t
operator|=
name|icmptypes
operator|,
name|i
operator|=
literal|0
init|;
condition|;
name|t
operator|++
operator|,
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|*
name|t
condition|)
continue|continue;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"END"
argument_list|,
operator|*
name|t
argument_list|)
condition|)
block|{
name|i
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
operator|*
name|t
argument_list|,
operator|*
operator|*
name|cp
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
operator|-
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid icmp-type (%s) specified\n"
argument_list|,
operator|*
operator|*
name|cp
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|fp
operator|->
name|fr_icmp
operator|=
call|(
name|u_short
call|)
argument_list|(
name|i
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|fp
operator|->
name|fr_icmpm
operator|=
operator|(
name|u_short
operator|)
literal|0xff00
expr_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
operator|*
name|cp
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
operator|*
name|cp
operator|&&
name|strcasecmp
argument_list|(
literal|"code"
argument_list|,
operator|*
operator|*
name|cp
argument_list|)
condition|)
return|return
literal|0
return|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
operator|*
operator|*
name|cp
argument_list|)
condition|)
block|{
name|i
operator|=
name|atoi
argument_list|(
operator|*
operator|*
name|cp
argument_list|)
expr_stmt|;
name|fp
operator|->
name|fr_icmp
operator||=
operator|(
name|u_short
operator|)
name|i
expr_stmt|;
name|fp
operator|->
name|fr_icmpm
operator|=
operator|(
name|u_short
operator|)
literal|0xffff
expr_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_define
define|#
directive|define
name|MAX_ICMPCODE
value|12
end_define

begin_decl_stmt
name|char
modifier|*
name|icmpcodes
index|[]
init|=
block|{
literal|"net-unr"
block|,
literal|"host-unr"
block|,
literal|"proto-unr"
block|,
literal|"port-unr"
block|,
literal|"needfrag"
block|,
literal|"srcfail"
block|,
literal|"net-unk"
block|,
literal|"host-unk"
block|,
literal|"isolate"
block|,
literal|"net-prohib"
block|,
literal|"host-prohib"
block|,
literal|"net-tos"
block|,
literal|"host-tos"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Return the number for the associated ICMP unreachable code.  */
end_comment

begin_function
name|int
name|icmpcode
parameter_list|(
name|str
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|s
operator|=
name|strrchr
argument_list|(
name|str
argument_list|,
literal|')'
argument_list|)
operator|)
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|s
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|str
argument_list|)
condition|)
return|return
name|atoi
argument_list|(
name|str
argument_list|)
return|;
name|len
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|icmpcodes
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
name|str
argument_list|,
name|icmpcodes
index|[
name|i
index|]
argument_list|,
name|MIN
argument_list|(
name|len
argument_list|,
name|strlen
argument_list|(
name|icmpcodes
index|[
name|i
index|]
argument_list|)
argument_list|)
argument_list|)
condition|)
return|return
name|i
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * set the icmp field to the correct type if "icmp" word is found  */
end_comment

begin_function
name|int
name|addkeep
parameter_list|(
name|cp
parameter_list|,
name|fp
parameter_list|)
name|char
modifier|*
modifier|*
modifier|*
name|cp
decl_stmt|;
name|struct
name|frentry
modifier|*
name|fp
decl_stmt|;
block|{
if|if
condition|(
name|fp
operator|->
name|fr_proto
operator|!=
name|IPPROTO_TCP
operator|&&
name|fp
operator|->
name|fr_proto
operator|!=
name|IPPROTO_UDP
operator|&&
name|fp
operator|->
name|fr_proto
operator|!=
name|IPPROTO_ICMP
operator|&&
operator|!
operator|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_fl
operator|&
name|FI_TCPUDP
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can only use keep with UDP/ICMP/TCP\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|cp
operator|&&
name|strcasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"state"
argument_list|)
operator|&&
name|strcasecmp
argument_list|(
operator|*
operator|*
name|cp
argument_list|,
literal|"frags"
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unrecognised state keyword \"%s\"\n"
argument_list|,
operator|*
operator|*
name|cp
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'s'
operator|||
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'S'
condition|)
name|fp
operator|->
name|fr_flags
operator||=
name|FR_KEEPSTATE
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'f'
operator|||
operator|*
operator|*
operator|*
name|cp
operator|==
literal|'F'
condition|)
name|fp
operator|->
name|fr_flags
operator||=
name|FR_KEEPFRAG
expr_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * count consecutive 1's in bit mask.  If the mask generated by counting  * consecutive 1's is different to that passed, return -1, else return #  * of bits.  */
end_comment

begin_function
name|int
name|countbits
parameter_list|(
name|ip
parameter_list|)
name|u_long
name|ip
decl_stmt|;
block|{
name|u_long
name|ipn
decl_stmt|;
name|int
name|cnt
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|ip
operator|=
name|ipn
operator|=
name|ntohl
argument_list|(
name|ip
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|32
init|;
name|i
condition|;
name|i
operator|--
operator|,
name|ipn
operator|*=
literal|2
control|)
if|if
condition|(
name|ipn
operator|&
literal|0x80000000
condition|)
name|cnt
operator|++
expr_stmt|;
else|else
break|break;
name|ipn
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|32
operator|,
name|j
operator|=
name|cnt
init|;
name|i
condition|;
name|i
operator|--
operator|,
name|j
operator|--
control|)
block|{
name|ipn
operator|*=
literal|2
expr_stmt|;
if|if
condition|(
name|j
operator|>
literal|0
condition|)
name|ipn
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ipn
operator|==
name|ip
condition|)
return|return
name|cnt
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|portname
parameter_list|(
name|pr
parameter_list|,
name|port
parameter_list|)
name|int
name|pr
decl_stmt|,
name|port
decl_stmt|;
block|{
specifier|static
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|struct
name|protoent
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|struct
name|servent
modifier|*
name|sv
init|=
name|NULL
decl_stmt|,
modifier|*
name|sv1
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|pr
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|sv
operator|=
name|getservbyport
argument_list|(
name|port
argument_list|,
literal|"tcp"
argument_list|)
operator|)
condition|)
block|{
name|strncpy
argument_list|(
name|buf
argument_list|,
name|sv
operator|->
name|s_name
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|sv1
operator|=
name|getservbyport
argument_list|(
name|port
argument_list|,
literal|"udp"
argument_list|)
expr_stmt|;
name|sv
operator|=
name|strncasecmp
argument_list|(
name|buf
argument_list|,
name|sv
operator|->
name|s_name
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|)
condition|?
name|NULL
else|:
name|sv1
expr_stmt|;
block|}
if|if
condition|(
name|sv
condition|)
return|return
name|buf
return|;
block|}
elseif|else
if|if
condition|(
name|pr
operator|&&
operator|(
name|p
operator|=
name|getprotobynumber
argument_list|(
name|pr
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|sv
operator|=
name|getservbyport
argument_list|(
name|port
argument_list|,
name|p
operator|->
name|p_name
argument_list|)
operator|)
condition|)
block|{
name|strncpy
argument_list|(
name|buf
argument_list|,
name|sv
operator|->
name|s_name
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|buf
return|;
block|}
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d"
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_comment
comment|/*  * print the filter structure in a useful way  */
end_comment

begin_function
name|void
name|printfr
parameter_list|(
name|fp
parameter_list|)
name|struct
name|frentry
modifier|*
name|fp
decl_stmt|;
block|{
specifier|static
name|char
modifier|*
name|pcmp1
index|[]
init|=
block|{
literal|"*"
block|,
literal|"="
block|,
literal|"!="
block|,
literal|"<"
block|,
literal|">"
block|,
literal|"<="
block|,
literal|">="
block|,
literal|"<>"
block|,
literal|"><"
block|}
decl_stmt|;
name|struct
name|protoent
modifier|*
name|p
decl_stmt|;
name|int
name|ones
init|=
literal|0
decl_stmt|,
name|pr
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|u_char
modifier|*
name|t
decl_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_PASS
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"pass"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_BLOCK
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"block"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETICMP
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" return-icmp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_icode
condition|)
if|if
condition|(
name|fp
operator|->
name|fr_icode
operator|<=
name|MAX_ICMPCODE
condition|)
name|printf
argument_list|(
literal|"(%s)"
argument_list|,
name|icmpcodes
index|[
operator|(
name|int
operator|)
name|fp
operator|->
name|fr_icode
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"(%d)"
argument_list|,
name|fp
operator|->
name|fr_icode
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETRST
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" return-rst"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGMASK
operator|)
operator|==
name|FR_LOG
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"log"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGBODY
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGFIRST
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" first"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_ACCOUNT
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"count"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_OUTQUE
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" out "
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" in "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGB
operator|)
operator|==
name|FR_LOGB
operator|)
operator|||
operator|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGP
operator|)
operator|==
name|FR_LOGP
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"log "
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGBODY
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"body "
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGFIRST
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"first "
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGORBLOCK
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"or-block "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_QUICK
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"quick "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_ifname
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"on %s%s "
argument_list|,
name|fp
operator|->
name|fr_ifname
argument_list|,
operator|(
name|fp
operator|->
name|fr_ifa
operator|||
operator|(
name|int
operator|)
name|fp
operator|->
name|fr_ifa
operator|==
operator|-
literal|1
operator|)
condition|?
literal|""
else|:
literal|"(!)"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_dif
operator|.
name|fd_ifname
condition|)
name|print_toif
argument_list|(
literal|"dup-to"
argument_list|,
operator|&
name|fp
operator|->
name|fr_dif
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_tif
operator|.
name|fd_ifname
condition|)
name|print_toif
argument_list|(
literal|"to"
argument_list|,
operator|&
name|fp
operator|->
name|fr_tif
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_FASTROUTE
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"fastroute "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_tos
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"tos %#x "
argument_list|,
name|fp
operator|->
name|fr_tos
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_ttl
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"ttl %d "
argument_list|,
name|fp
operator|->
name|fr_ttl
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_fl
operator|&
name|FI_TCPUDP
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"proto tcp/udp "
argument_list|)
expr_stmt|;
name|pr
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pr
operator|=
name|fp
operator|->
name|fr_mip
operator|.
name|fi_p
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|p
operator|=
name|getprotobynumber
argument_list|(
name|fp
operator|->
name|fr_proto
argument_list|)
operator|)
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"proto %s "
argument_list|,
name|p
operator|->
name|p_name
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"proto %d "
argument_list|,
name|fp
operator|->
name|fr_proto
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"from %s"
argument_list|,
name|fp
operator|->
name|fr_flags
operator|&
name|FR_NOTSRCIP
condition|?
literal|"!"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
operator|->
name|fr_src
operator|.
name|s_addr
operator|&
operator|!
name|fp
operator|->
name|fr_smsk
operator|.
name|s_addr
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"any "
argument_list|)
expr_stmt|;
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|inet_ntoa
argument_list|(
name|fp
operator|->
name|fr_src
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ones
operator|=
name|countbits
argument_list|(
name|fp
operator|->
name|fr_smsk
operator|.
name|s_addr
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"/%s "
argument_list|,
name|inet_ntoa
argument_list|(
name|fp
operator|->
name|fr_smsk
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"/%d "
argument_list|,
name|ones
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_scmp
condition|)
if|if
condition|(
name|fp
operator|->
name|fr_scmp
operator|==
name|FR_INRANGE
operator|||
name|fp
operator|->
name|fr_scmp
operator|==
name|FR_OUTRANGE
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"port %d %s %d "
argument_list|,
name|fp
operator|->
name|fr_sport
argument_list|,
name|pcmp1
index|[
name|fp
operator|->
name|fr_scmp
index|]
argument_list|,
name|fp
operator|->
name|fr_stop
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"port %s %s "
argument_list|,
name|pcmp1
index|[
name|fp
operator|->
name|fr_scmp
index|]
argument_list|,
name|portname
argument_list|(
name|pr
argument_list|,
name|fp
operator|->
name|fr_sport
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"to %s"
argument_list|,
name|fp
operator|->
name|fr_flags
operator|&
name|FR_NOTDSTIP
condition|?
literal|"!"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
operator|->
name|fr_dst
operator|.
name|s_addr
operator|&
operator|!
name|fp
operator|->
name|fr_dmsk
operator|.
name|s_addr
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"any"
argument_list|)
expr_stmt|;
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|inet_ntoa
argument_list|(
name|fp
operator|->
name|fr_dst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ones
operator|=
name|countbits
argument_list|(
name|fp
operator|->
name|fr_dmsk
operator|.
name|s_addr
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"/%s"
argument_list|,
name|inet_ntoa
argument_list|(
name|fp
operator|->
name|fr_dmsk
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"/%d"
argument_list|,
name|ones
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_dcmp
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_dcmp
operator|==
name|FR_INRANGE
operator|||
name|fp
operator|->
name|fr_dcmp
operator|==
name|FR_OUTRANGE
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" port %d %s %d"
argument_list|,
name|fp
operator|->
name|fr_dport
argument_list|,
name|pcmp1
index|[
name|fp
operator|->
name|fr_dcmp
index|]
argument_list|,
name|fp
operator|->
name|fr_dtop
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" port %s %s"
argument_list|,
name|pcmp1
index|[
name|fp
operator|->
name|fr_dcmp
index|]
argument_list|,
name|portname
argument_list|(
name|pr
argument_list|,
name|fp
operator|->
name|fr_dport
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_fl
operator|&
operator|~
name|FI_TCPUDP
operator|)
operator|||
operator|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_fl
operator|&
operator|~
name|FI_TCPUDP
operator|)
operator|||
name|fp
operator|->
name|fr_ip
operator|.
name|fi_optmsk
operator|||
name|fp
operator|->
name|fr_mip
operator|.
name|fi_optmsk
operator|||
name|fp
operator|->
name|fr_ip
operator|.
name|fi_secmsk
operator|||
name|fp
operator|->
name|fr_mip
operator|.
name|fi_secmsk
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" with"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_optmsk
operator|||
name|fp
operator|->
name|fr_mip
operator|.
name|fi_optmsk
operator|||
name|fp
operator|->
name|fr_ip
operator|.
name|fi_secmsk
operator|||
name|fp
operator|->
name|fr_mip
operator|.
name|fi_secmsk
condition|)
name|optprint
argument_list|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_secmsk
argument_list|,
name|fp
operator|->
name|fr_ip
operator|.
name|fi_secmsk
argument_list|,
name|fp
operator|->
name|fr_mip
operator|.
name|fi_optmsk
argument_list|,
name|fp
operator|->
name|fr_ip
operator|.
name|fi_optmsk
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_fl
operator|&
name|FI_OPTIONS
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_fl
operator|&
name|FI_OPTIONS
operator|)
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" not"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" ipopt"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_fl
operator|&
name|FI_SHORT
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_fl
operator|&
name|FI_SHORT
operator|)
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" not"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" short"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_fl
operator|&
name|FI_FRAG
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_ip
operator|.
name|fi_fl
operator|&
name|FI_FRAG
operator|)
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" not"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" frag"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fp
operator|->
name|fr_proto
operator|==
name|IPPROTO_ICMP
operator|&&
name|fp
operator|->
name|fr_icmpm
condition|)
block|{
name|int
name|type
init|=
name|fp
operator|->
name|fr_icmp
decl_stmt|,
name|code
decl_stmt|;
name|type
operator|=
name|ntohs
argument_list|(
name|fp
operator|->
name|fr_icmp
argument_list|)
expr_stmt|;
name|code
operator|=
name|type
operator|&
literal|0xff
expr_stmt|;
name|type
operator|/=
literal|256
expr_stmt|;
if|if
condition|(
name|type
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|icmptypes
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|)
operator|&&
name|icmptypes
index|[
name|type
index|]
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" icmp-type %s"
argument_list|,
name|icmptypes
index|[
name|type
index|]
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" icmp-type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" code %d"
argument_list|,
name|code
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_proto
operator|==
name|IPPROTO_TCP
operator|&&
operator|(
name|fp
operator|->
name|fr_tcpf
operator|||
name|fp
operator|->
name|fr_tcpfm
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" flags "
argument_list|)
expr_stmt|;
for|for
control|(
name|s
operator|=
name|flagset
operator|,
name|t
operator|=
name|flags
init|;
operator|*
name|s
condition|;
name|s
operator|++
operator|,
name|t
operator|++
control|)
if|if
condition|(
name|fp
operator|->
name|fr_tcpf
operator|&
operator|*
name|t
condition|)
operator|(
name|void
operator|)
name|putchar
argument_list|(
operator|*
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_tcpfm
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'/'
argument_list|)
expr_stmt|;
for|for
control|(
name|s
operator|=
name|flagset
operator|,
name|t
operator|=
name|flags
init|;
operator|*
name|s
condition|;
name|s
operator|++
operator|,
name|t
operator|++
control|)
if|if
condition|(
name|fp
operator|->
name|fr_tcpfm
operator|&
operator|*
name|t
condition|)
operator|(
name|void
operator|)
name|putchar
argument_list|(
operator|*
name|s
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_KEEPSTATE
condition|)
name|printf
argument_list|(
literal|" keep state"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_KEEPFRAG
condition|)
name|printf
argument_list|(
literal|" keep frags"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|binprint
parameter_list|(
name|fp
parameter_list|)
name|struct
name|frentry
modifier|*
name|fp
decl_stmt|;
block|{
name|int
name|i
init|=
sizeof|sizeof
argument_list|(
operator|*
name|fp
argument_list|)
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|;
name|u_char
modifier|*
name|s
decl_stmt|;
for|for
control|(
name|s
operator|=
operator|(
name|u_char
operator|*
operator|)
name|fp
init|;
name|i
condition|;
name|i
operator|--
operator|,
name|s
operator|++
control|)
block|{
name|j
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
operator|*
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|==
literal|16
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


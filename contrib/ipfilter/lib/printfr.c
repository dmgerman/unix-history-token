begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/*  * Copyright (C) 1993-2001 by Darren Reed.  *  * See the IPFILTER.LICENCE file for details on licencing.  *  * $Id: printfr.c,v 1.43.2.16 2006/03/29 11:19:59 darrenr Exp $  */
end_comment

begin_include
include|#
directive|include
file|"ipf.h"
end_include

begin_function_decl
specifier|static
name|void
name|printaddr
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|char
modifier|*
parameter_list|,
name|u_32_t
modifier|*
parameter_list|,
name|u_32_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|printaddr
parameter_list|(
name|v
parameter_list|,
name|type
parameter_list|,
name|ifname
parameter_list|,
name|addr
parameter_list|,
name|mask
parameter_list|)
name|int
name|v
decl_stmt|,
name|type
decl_stmt|;
name|char
modifier|*
name|ifname
decl_stmt|;
name|u_32_t
modifier|*
name|addr
decl_stmt|,
decl|*
name|mask
decl_stmt|;
end_function

begin_block
block|{
name|char
modifier|*
name|suffix
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|FRI_BROADCAST
case|:
name|suffix
operator|=
literal|"bcast"
expr_stmt|;
break|break;
case|case
name|FRI_DYNAMIC
case|:
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|printmask
argument_list|(
name|mask
argument_list|)
expr_stmt|;
name|suffix
operator|=
name|NULL
expr_stmt|;
break|break;
case|case
name|FRI_NETWORK
case|:
name|suffix
operator|=
literal|"net"
expr_stmt|;
break|break;
case|case
name|FRI_NETMASKED
case|:
name|suffix
operator|=
literal|"netmasked"
expr_stmt|;
break|break;
case|case
name|FRI_PEERADDR
case|:
name|suffix
operator|=
literal|"peer"
expr_stmt|;
break|break;
case|case
name|FRI_LOOKUP
case|:
name|suffix
operator|=
name|NULL
expr_stmt|;
name|printlookup
argument_list|(
operator|(
name|i6addr_t
operator|*
operator|)
name|addr
argument_list|,
operator|(
name|i6addr_t
operator|*
operator|)
name|mask
argument_list|)
expr_stmt|;
break|break;
case|case
name|FRI_NORMAL
case|:
name|printhostmask
argument_list|(
name|v
argument_list|,
name|addr
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|suffix
operator|=
name|NULL
expr_stmt|;
break|break;
default|default :
name|printf
argument_list|(
literal|"<%d>"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|printmask
argument_list|(
name|mask
argument_list|)
expr_stmt|;
name|suffix
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|suffix
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s/%s"
argument_list|,
name|ifname
argument_list|,
name|suffix
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
name|void
name|printlookup
parameter_list|(
name|addr
parameter_list|,
name|mask
parameter_list|)
name|i6addr_t
modifier|*
name|addr
decl_stmt|,
decl|*
name|mask
decl_stmt|;
end_function

begin_block
block|{
switch|switch
condition|(
name|addr
operator|->
name|iplookuptype
condition|)
block|{
case|case
name|IPLT_POOL
case|:
name|printf
argument_list|(
literal|"pool/"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPLT_HASH
case|:
name|printf
argument_list|(
literal|"hash/"
argument_list|)
expr_stmt|;
break|break;
default|default :
name|printf
argument_list|(
literal|"lookup(%x)="
argument_list|,
name|addr
operator|->
name|iplookuptype
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"%u"
argument_list|,
name|addr
operator|->
name|iplookupnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|->
name|iplookupptr
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"(!)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * print the filter structure in a useful way  */
end_comment

begin_function
name|void
name|printfr
parameter_list|(
name|fp
parameter_list|,
name|iocfunc
parameter_list|)
name|struct
name|frentry
modifier|*
name|fp
decl_stmt|;
name|ioctlfunc_t
name|iocfunc
decl_stmt|;
block|{
name|struct
name|protoent
modifier|*
name|p
decl_stmt|;
name|u_short
name|sec
index|[
literal|2
index|]
decl_stmt|;
name|u_32_t
name|type
decl_stmt|;
name|u_char
modifier|*
name|t
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|pr
decl_stmt|;
name|pr
operator|=
operator|-
literal|2
expr_stmt|;
name|type
operator|=
name|fp
operator|->
name|fr_type
operator|&
operator|~
name|FR_T_BUILTIN
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_type
operator|&
name|FR_T_BUILTIN
operator|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"# Builtin: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_collect
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%u "
argument_list|,
name|fp
operator|->
name|fr_collect
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_type
operator|==
name|FR_T_CALLFUNC
condition|)
block|{
empty_stmt|;
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_func
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"call"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_CALLNOW
operator|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|" now"
argument_list|)
expr_stmt|;
name|s
operator|=
name|kvatoname
argument_list|(
name|fp
operator|->
name|fr_func
argument_list|,
name|iocfunc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s/%u"
argument_list|,
name|s
condition|?
name|s
else|:
literal|"?"
argument_list|,
name|fp
operator|->
name|fr_arg
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FR_ISPASS
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
name|printf
argument_list|(
literal|"pass"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|FR_ISBLOCK
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"block"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGMASK
operator|)
operator|==
name|FR_LOG
condition|)
block|{
name|printlog
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FR_ISACCOUNT
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
name|printf
argument_list|(
literal|"count"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|FR_ISAUTH
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
name|printf
argument_list|(
literal|"auth"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|FR_ISPREAUTH
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
name|printf
argument_list|(
literal|"preauth"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|FR_ISNOMATCH
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
name|printf
argument_list|(
literal|"nomatch"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|FR_ISSKIP
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
name|printf
argument_list|(
literal|"skip %u"
argument_list|,
name|fp
operator|->
name|fr_arg
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"%x"
argument_list|,
name|fp
operator|->
name|fr_flags
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETICMP
condition|)
block|{
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETMASK
operator|)
operator|==
name|FR_FAKEICMP
condition|)
name|printf
argument_list|(
literal|" return-icmp-as-dest"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETMASK
operator|)
operator|==
name|FR_RETICMP
condition|)
name|printf
argument_list|(
literal|" return-icmp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_icode
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_icode
operator|<=
name|MAX_ICMPCODE
condition|)
name|printf
argument_list|(
literal|"(%s)"
argument_list|,
name|icmpcodes
index|[
operator|(
name|int
operator|)
name|fp
operator|->
name|fr_icode
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"(%d)"
argument_list|,
name|fp
operator|->
name|fr_icode
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETMASK
operator|)
operator|==
name|FR_RETRST
condition|)
name|printf
argument_list|(
literal|" return-rst"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_OUTQUE
condition|)
name|printf
argument_list|(
literal|" out "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" in "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGB
operator|)
operator|==
name|FR_LOGB
operator|)
operator|||
operator|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGP
operator|)
operator|==
name|FR_LOGP
operator|)
condition|)
block|{
name|printlog
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_QUICK
condition|)
name|printf
argument_list|(
literal|"quick "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_ifname
condition|)
block|{
name|printifname
argument_list|(
literal|"on "
argument_list|,
name|fp
operator|->
name|fr_ifname
argument_list|,
name|fp
operator|->
name|fr_ifa
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_ifnames
index|[
literal|1
index|]
operator|&&
name|strcmp
argument_list|(
name|fp
operator|->
name|fr_ifnames
index|[
literal|1
index|]
argument_list|,
literal|"*"
argument_list|)
condition|)
name|printifname
argument_list|(
literal|","
argument_list|,
name|fp
operator|->
name|fr_ifnames
index|[
literal|1
index|]
argument_list|,
name|fp
operator|->
name|fr_ifas
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_dif
operator|.
name|fd_ifname
operator|||
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_DUP
operator|)
condition|)
name|print_toif
argument_list|(
literal|"dup-to"
argument_list|,
operator|&
name|fp
operator|->
name|fr_dif
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_tif
operator|.
name|fd_ifname
condition|)
name|print_toif
argument_list|(
literal|"to"
argument_list|,
operator|&
name|fp
operator|->
name|fr_tif
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_rif
operator|.
name|fd_ifname
condition|)
name|print_toif
argument_list|(
literal|"reply-to"
argument_list|,
operator|&
name|fp
operator|->
name|fr_rif
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_FASTROUTE
condition|)
name|printf
argument_list|(
literal|"fastroute "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|fp
operator|->
name|fr_ifnames
index|[
literal|2
index|]
operator|&&
name|strcmp
argument_list|(
name|fp
operator|->
name|fr_ifnames
index|[
literal|2
index|]
argument_list|,
literal|"*"
argument_list|)
operator|)
operator|||
operator|(
operator|*
name|fp
operator|->
name|fr_ifnames
index|[
literal|3
index|]
operator|&&
name|strcmp
argument_list|(
name|fp
operator|->
name|fr_ifnames
index|[
literal|3
index|]
argument_list|,
literal|"*"
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_OUTQUE
condition|)
name|printf
argument_list|(
literal|"in-via "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"out-via "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_ifnames
index|[
literal|2
index|]
condition|)
block|{
name|printifname
argument_list|(
literal|""
argument_list|,
name|fp
operator|->
name|fr_ifnames
index|[
literal|2
index|]
argument_list|,
name|fp
operator|->
name|fr_ifas
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_ifnames
index|[
literal|3
index|]
condition|)
block|{
name|printifname
argument_list|(
literal|","
argument_list|,
name|fp
operator|->
name|fr_ifnames
index|[
literal|3
index|]
argument_list|,
name|fp
operator|->
name|fr_ifas
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|type
operator|==
name|FR_T_IPF
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_tos
condition|)
name|printf
argument_list|(
literal|"tos %#x "
argument_list|,
name|fp
operator|->
name|fr_tos
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_ttl
condition|)
name|printf
argument_list|(
literal|"ttl %d "
argument_list|,
name|fp
operator|->
name|fr_ttl
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_TCPUDP
condition|)
block|{
name|printf
argument_list|(
literal|"proto tcp/udp "
argument_list|)
expr_stmt|;
name|pr
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_p
condition|)
block|{
name|pr
operator|=
name|fp
operator|->
name|fr_ip
operator|.
name|fi_p
expr_stmt|;
name|p
operator|=
name|getprotobynumber
argument_list|(
name|pr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"proto "
argument_list|)
expr_stmt|;
name|printproto
argument_list|(
name|p
argument_list|,
name|pr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|type
operator|==
name|FR_T_NONE
condition|)
block|{
name|printf
argument_list|(
literal|"all"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|==
name|FR_T_IPF
condition|)
block|{
name|printf
argument_list|(
literal|"from %s"
argument_list|,
name|fp
operator|->
name|fr_flags
operator|&
name|FR_NOTSRCIP
condition|?
literal|"!"
else|:
literal|""
argument_list|)
expr_stmt|;
name|printaddr
argument_list|(
name|fp
operator|->
name|fr_v
argument_list|,
name|fp
operator|->
name|fr_satype
argument_list|,
name|fp
operator|->
name|fr_ifname
argument_list|,
operator|&
name|fp
operator|->
name|fr_src
operator|.
name|s_addr
argument_list|,
operator|&
name|fp
operator|->
name|fr_smsk
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_scmp
condition|)
name|printportcmp
argument_list|(
name|pr
argument_list|,
operator|&
name|fp
operator|->
name|fr_tuc
operator|.
name|ftu_src
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" to %s"
argument_list|,
name|fp
operator|->
name|fr_flags
operator|&
name|FR_NOTDSTIP
condition|?
literal|"!"
else|:
literal|""
argument_list|)
expr_stmt|;
name|printaddr
argument_list|(
name|fp
operator|->
name|fr_v
argument_list|,
name|fp
operator|->
name|fr_datype
argument_list|,
name|fp
operator|->
name|fr_ifname
argument_list|,
operator|&
name|fp
operator|->
name|fr_dst
operator|.
name|s_addr
argument_list|,
operator|&
name|fp
operator|->
name|fr_dmsk
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_dcmp
condition|)
name|printportcmp
argument_list|(
name|pr
argument_list|,
operator|&
name|fp
operator|->
name|fr_tuc
operator|.
name|ftu_dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_proto
operator|==
name|IPPROTO_ICMP
operator|&&
name|fp
operator|->
name|fr_icmpm
condition|)
block|{
name|int
name|type
init|=
name|fp
operator|->
name|fr_icmp
decl_stmt|,
name|code
decl_stmt|;
name|type
operator|=
name|ntohs
argument_list|(
name|fp
operator|->
name|fr_icmp
argument_list|)
expr_stmt|;
name|code
operator|=
name|type
operator|&
literal|0xff
expr_stmt|;
name|type
operator|/=
literal|256
expr_stmt|;
if|if
condition|(
name|type
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|icmptypes
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|-
literal|1
operator|)
operator|&&
name|icmptypes
index|[
name|type
index|]
condition|)
name|printf
argument_list|(
literal|" icmp-type %s"
argument_list|,
name|icmptypes
index|[
name|type
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" icmp-type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntohs
argument_list|(
name|fp
operator|->
name|fr_icmpm
argument_list|)
operator|&
literal|0xff
condition|)
name|printf
argument_list|(
literal|" code %d"
argument_list|,
name|code
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_proto
operator|==
name|IPPROTO_TCP
operator|)
operator|&&
operator|(
name|fp
operator|->
name|fr_tcpf
operator|||
name|fp
operator|->
name|fr_tcpfm
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|" flags "
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_tcpf
operator|&
operator|~
name|TCPF_ALL
condition|)
name|printf
argument_list|(
literal|"0x%x"
argument_list|,
name|fp
operator|->
name|fr_tcpf
argument_list|)
expr_stmt|;
else|else
for|for
control|(
name|s
operator|=
name|flagset
operator|,
name|t
operator|=
name|flags
init|;
operator|*
name|s
condition|;
name|s
operator|++
operator|,
name|t
operator|++
control|)
if|if
condition|(
name|fp
operator|->
name|fr_tcpf
operator|&
operator|*
name|t
condition|)
operator|(
name|void
operator|)
name|putchar
argument_list|(
operator|*
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_tcpfm
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_tcpfm
operator|&
operator|~
name|TCPF_ALL
condition|)
name|printf
argument_list|(
literal|"0x%x"
argument_list|,
name|fp
operator|->
name|fr_tcpfm
argument_list|)
expr_stmt|;
else|else
for|for
control|(
name|s
operator|=
name|flagset
operator|,
name|t
operator|=
name|flags
init|;
operator|*
name|s
condition|;
name|s
operator|++
operator|,
name|t
operator|++
control|)
if|if
condition|(
name|fp
operator|->
name|fr_tcpfm
operator|&
operator|*
name|t
condition|)
operator|(
name|void
operator|)
name|putchar
argument_list|(
operator|*
name|s
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|type
operator|==
name|FR_T_BPFOPC
condition|)
block|{
name|fakebpf_t
modifier|*
name|fb
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"bpf-v%d { \""
argument_list|,
name|fp
operator|->
name|fr_v
argument_list|)
expr_stmt|;
name|i
operator|=
name|fp
operator|->
name|fr_dsize
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|fb
argument_list|)
expr_stmt|;
for|for
control|(
name|fb
operator|=
name|fp
operator|->
name|fr_data
operator|,
name|s
operator|=
literal|""
init|;
name|i
condition|;
name|i
operator|--
operator|,
name|fb
operator|++
operator|,
name|s
operator|=
literal|" "
control|)
name|printf
argument_list|(
literal|"%s%#x %#x %#x %#x"
argument_list|,
name|s
argument_list|,
name|fb
operator|->
name|fb_c
argument_list|,
name|fb
operator|->
name|fb_t
argument_list|,
name|fb
operator|->
name|fb_f
argument_list|,
name|fb
operator|->
name|fb_k
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\" }"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|==
name|FR_T_COMPIPF
condition|)
block|{
empty_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|==
name|FR_T_CALLFUNC
condition|)
block|{
name|printf
argument_list|(
literal|"call function at %p"
argument_list|,
name|fp
operator|->
name|fr_data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"[unknown filter type %#x]"
argument_list|,
name|fp
operator|->
name|fr_type
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_WITH
operator|)
operator|||
operator|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_WITH
operator|)
operator|||
name|fp
operator|->
name|fr_optbits
operator|||
name|fp
operator|->
name|fr_optmask
operator|||
name|fp
operator|->
name|fr_secbits
operator|||
name|fp
operator|->
name|fr_secmask
operator|)
condition|)
block|{
name|char
modifier|*
name|comma
init|=
literal|" "
decl_stmt|;
name|printf
argument_list|(
literal|" with"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_optbits
operator|||
name|fp
operator|->
name|fr_optmask
operator|||
name|fp
operator|->
name|fr_secbits
operator|||
name|fp
operator|->
name|fr_secmask
condition|)
block|{
name|sec
index|[
literal|0
index|]
operator|=
name|fp
operator|->
name|fr_secmask
expr_stmt|;
name|sec
index|[
literal|1
index|]
operator|=
name|fp
operator|->
name|fr_secbits
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_v
operator|==
literal|4
condition|)
name|optprint
argument_list|(
name|sec
argument_list|,
name|fp
operator|->
name|fr_optmask
argument_list|,
name|fp
operator|->
name|fr_optbits
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_INET6
else|else
name|optprintv6
argument_list|(
name|sec
argument_list|,
name|fp
operator|->
name|fr_optmask
argument_list|,
name|fp
operator|->
name|fr_optbits
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_OPTIONS
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_OPTIONS
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ipopts"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_SHORT
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_SHORT
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"short"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_FRAG
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_FRAG
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"frag"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_FRAGBODY
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_FRAGBODY
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"frag-body"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_NATED
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_NATED
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"nat"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_LOWTTL
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_LOWTTL
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"lowttl"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_BAD
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_BAD
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"bad"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_BADSRC
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_BADSRC
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"bad-src"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_BADNAT
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_BADNAT
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"bad-nat"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_OOW
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_OOW
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"oow"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_MBCAST
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_MBCAST
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"mbcast"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_BROADCAST
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_BROADCAST
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"bcast"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_MULTICAST
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_MULTICAST
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"mcast"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_STATE
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_STATE
operator|)
condition|)
name|printf
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"state"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_KEEPSTATE
condition|)
block|{
name|printf
argument_list|(
literal|" keep state"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
operator|(
name|FR_STSTRICT
operator||
name|FR_NEWISN
operator||
name|FR_NOICMPERR
operator||
name|FR_STATESYNC
operator|)
operator|)
operator|||
operator|(
name|fp
operator|->
name|fr_statemax
operator|!=
literal|0
operator|)
operator|||
operator|(
name|fp
operator|->
name|fr_age
index|[
literal|0
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
name|char
modifier|*
name|comma
init|=
literal|""
decl_stmt|;
name|printf
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_statemax
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"limit %u"
argument_list|,
name|fp
operator|->
name|fr_statemax
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_STSTRICT
condition|)
block|{
name|printf
argument_list|(
literal|"%sstrict"
argument_list|,
name|comma
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_NEWISN
condition|)
block|{
name|printf
argument_list|(
literal|"%snewisn"
argument_list|,
name|comma
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_NOICMPERR
condition|)
block|{
name|printf
argument_list|(
literal|"%sno-icmp-err"
argument_list|,
name|comma
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_STATESYNC
condition|)
block|{
name|printf
argument_list|(
literal|"%ssync"
argument_list|,
name|comma
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_age
index|[
literal|0
index|]
operator|||
name|fp
operator|->
name|fr_age
index|[
literal|1
index|]
condition|)
name|printf
argument_list|(
literal|"%sage %d/%d"
argument_list|,
name|comma
argument_list|,
name|fp
operator|->
name|fr_age
index|[
literal|0
index|]
argument_list|,
name|fp
operator|->
name|fr_age
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_KEEPFRAG
condition|)
block|{
name|printf
argument_list|(
literal|" keep frags"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
operator|(
name|FR_FRSTRICT
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_FRSTRICT
condition|)
name|printf
argument_list|(
literal|"strict"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fp
operator|->
name|fr_isc
operator|!=
operator|(
expr|struct
name|ipscan
operator|*
operator|)
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_isctag
index|[
literal|0
index|]
condition|)
name|printf
argument_list|(
literal|" scan %s"
argument_list|,
name|fp
operator|->
name|fr_isctag
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" scan *"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_grhead
operator|!=
literal|'\0'
condition|)
name|printf
argument_list|(
literal|" head %s"
argument_list|,
name|fp
operator|->
name|fr_grhead
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_group
operator|!=
literal|'\0'
condition|)
name|printf
argument_list|(
literal|" group %s"
argument_list|,
name|fp
operator|->
name|fr_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_logtag
operator|!=
name|FR_NOLOGTAG
operator|||
operator|*
name|fp
operator|->
name|fr_nattag
operator|.
name|ipt_tag
condition|)
block|{
name|char
modifier|*
name|s
init|=
literal|""
decl_stmt|;
name|printf
argument_list|(
literal|" set-tag("
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_logtag
operator|!=
name|FR_NOLOGTAG
condition|)
block|{
name|printf
argument_list|(
literal|"log=%u"
argument_list|,
name|fp
operator|->
name|fr_logtag
argument_list|)
expr_stmt|;
name|s
operator|=
literal|", "
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_nattag
operator|.
name|ipt_tag
condition|)
block|{
name|printf
argument_list|(
literal|"%snat=%-.*s"
argument_list|,
name|s
argument_list|,
name|IPFTAG_LEN
argument_list|,
name|fp
operator|->
name|fr_nattag
operator|.
name|ipt_tag
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_pps
condition|)
name|printf
argument_list|(
literal|" pps %d"
argument_list|,
name|fp
operator|->
name|fr_pps
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


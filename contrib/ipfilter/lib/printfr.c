begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/*  * Copyright (C) 2012 by Darren Reed.  *  * See the IPFILTER.LICENCE file for details on licencing.  *  * $Id$  */
end_comment

begin_include
include|#
directive|include
file|"ipf.h"
end_include

begin_comment
comment|/*  * print the filter structure in a useful way  */
end_comment

begin_function
name|void
name|printfr
parameter_list|(
name|fp
parameter_list|,
name|iocfunc
parameter_list|)
name|struct
name|frentry
modifier|*
name|fp
decl_stmt|;
name|ioctlfunc_t
name|iocfunc
decl_stmt|;
block|{
name|struct
name|protoent
modifier|*
name|p
decl_stmt|;
name|u_short
name|sec
index|[
literal|2
index|]
decl_stmt|;
name|u_32_t
name|type
decl_stmt|;
name|int
name|pr
decl_stmt|,
name|af
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|hash
decl_stmt|;
name|pr
operator|=
operator|-
literal|2
expr_stmt|;
name|type
operator|=
name|fp
operator|->
name|fr_type
operator|&
operator|~
name|FR_T_BUILTIN
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_type
operator|&
name|FR_T_BUILTIN
operator|)
operator|!=
literal|0
condition|)
name|PRINTF
argument_list|(
literal|"# Builtin: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_collect
operator|!=
literal|0
condition|)
name|PRINTF
argument_list|(
literal|"%u "
argument_list|,
name|fp
operator|->
name|fr_collect
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_type
operator|==
name|FR_T_CALLFUNC
condition|)
block|{
empty_stmt|;
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_func
operator|!=
name|NULL
condition|)
block|{
name|PRINTF
argument_list|(
literal|"call"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_CALLNOW
operator|)
operator|!=
literal|0
condition|)
name|PRINTF
argument_list|(
literal|" now"
argument_list|)
expr_stmt|;
name|s
operator|=
name|kvatoname
argument_list|(
name|fp
operator|->
name|fr_func
argument_list|,
name|iocfunc
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" %s/%u"
argument_list|,
name|s
condition|?
name|s
else|:
literal|"?"
argument_list|,
name|fp
operator|->
name|fr_arg
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FR_ISPASS
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
name|PRINTF
argument_list|(
literal|"pass"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|FR_ISBLOCK
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|"block"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGMASK
operator|)
operator|==
name|FR_LOG
condition|)
block|{
name|printlog
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FR_ISACCOUNT
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
name|PRINTF
argument_list|(
literal|"count"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|FR_ISAUTH
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
name|PRINTF
argument_list|(
literal|"auth"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|FR_ISPREAUTH
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
name|PRINTF
argument_list|(
literal|"preauth"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|FR_ISNOMATCH
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
name|PRINTF
argument_list|(
literal|"nomatch"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|FR_ISDECAPS
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
name|PRINTF
argument_list|(
literal|"decapsulate"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|FR_ISSKIP
argument_list|(
name|fp
operator|->
name|fr_flags
argument_list|)
condition|)
name|PRINTF
argument_list|(
literal|"skip %u"
argument_list|,
name|fp
operator|->
name|fr_arg
argument_list|)
expr_stmt|;
else|else
block|{
name|PRINTF
argument_list|(
literal|"%x"
argument_list|,
name|fp
operator|->
name|fr_flags
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETICMP
condition|)
block|{
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETMASK
operator|)
operator|==
name|FR_FAKEICMP
condition|)
name|PRINTF
argument_list|(
literal|" return-icmp-as-dest"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETMASK
operator|)
operator|==
name|FR_RETICMP
condition|)
name|PRINTF
argument_list|(
literal|" return-icmp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_icode
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_icode
operator|<=
name|MAX_ICMPCODE
condition|)
name|PRINTF
argument_list|(
literal|"(%s)"
argument_list|,
name|icmpcodes
index|[
operator|(
name|int
operator|)
name|fp
operator|->
name|fr_icode
index|]
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|"(%d)"
argument_list|,
name|fp
operator|->
name|fr_icode
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_RETMASK
operator|)
operator|==
name|FR_RETRST
condition|)
name|PRINTF
argument_list|(
literal|" return-rst"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_OUTQUE
condition|)
name|PRINTF
argument_list|(
literal|" out "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_INQUE
condition|)
name|PRINTF
argument_list|(
literal|" in "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGB
operator|)
operator|==
name|FR_LOGB
operator|)
operator|||
operator|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_LOGP
operator|)
operator|==
name|FR_LOGP
operator|)
condition|)
block|{
name|printlog
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_QUICK
condition|)
name|PRINTF
argument_list|(
literal|"quick "
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_ifnames
index|[
literal|0
index|]
operator|!=
operator|-
literal|1
condition|)
block|{
name|printifname
argument_list|(
literal|"on "
argument_list|,
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_ifnames
index|[
literal|0
index|]
argument_list|,
name|fp
operator|->
name|fr_ifa
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_ifnames
index|[
literal|1
index|]
operator|!=
operator|-
literal|1
operator|&&
name|strcmp
argument_list|(
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_ifnames
index|[
literal|1
index|]
argument_list|,
literal|"*"
argument_list|)
condition|)
name|printifname
argument_list|(
literal|","
argument_list|,
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_ifnames
index|[
literal|1
index|]
argument_list|,
name|fp
operator|->
name|fr_ifas
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_tif
operator|.
name|fd_name
operator|!=
operator|-
literal|1
condition|)
name|print_toif
argument_list|(
name|fp
operator|->
name|fr_family
argument_list|,
literal|"to"
argument_list|,
name|fp
operator|->
name|fr_names
argument_list|,
operator|&
name|fp
operator|->
name|fr_tif
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_dif
operator|.
name|fd_name
operator|!=
operator|-
literal|1
condition|)
name|print_toif
argument_list|(
name|fp
operator|->
name|fr_family
argument_list|,
literal|"dup-to"
argument_list|,
name|fp
operator|->
name|fr_names
argument_list|,
operator|&
name|fp
operator|->
name|fr_dif
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_rif
operator|.
name|fd_name
operator|!=
operator|-
literal|1
condition|)
name|print_toif
argument_list|(
name|fp
operator|->
name|fr_family
argument_list|,
literal|"reply-to"
argument_list|,
name|fp
operator|->
name|fr_names
argument_list|,
operator|&
name|fp
operator|->
name|fr_rif
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_FASTROUTE
condition|)
name|PRINTF
argument_list|(
literal|"fastroute "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_ifnames
index|[
literal|2
index|]
operator|!=
operator|-
literal|1
operator|&&
name|strcmp
argument_list|(
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_ifnames
index|[
literal|2
index|]
argument_list|,
literal|"*"
argument_list|)
operator|)
operator|||
operator|(
name|fp
operator|->
name|fr_ifnames
index|[
literal|3
index|]
operator|!=
operator|-
literal|1
operator|&&
name|strcmp
argument_list|(
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_ifnames
index|[
literal|3
index|]
argument_list|,
literal|"*"
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_OUTQUE
condition|)
name|PRINTF
argument_list|(
literal|"in-via "
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|"out-via "
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_ifnames
index|[
literal|2
index|]
operator|!=
operator|-
literal|1
condition|)
block|{
name|printifname
argument_list|(
literal|""
argument_list|,
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_ifnames
index|[
literal|2
index|]
argument_list|,
name|fp
operator|->
name|fr_ifas
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_ifnames
index|[
literal|3
index|]
operator|!=
operator|-
literal|1
condition|)
block|{
name|printifname
argument_list|(
literal|","
argument_list|,
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_ifnames
index|[
literal|3
index|]
argument_list|,
name|fp
operator|->
name|fr_ifas
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fp
operator|->
name|fr_family
operator|==
name|AF_INET
condition|)
block|{
name|PRINTF
argument_list|(
literal|"inet "
argument_list|)
expr_stmt|;
name|af
operator|=
name|AF_INET
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_INET6
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_family
operator|==
name|AF_INET6
condition|)
block|{
name|PRINTF
argument_list|(
literal|"inet6 "
argument_list|)
expr_stmt|;
name|af
operator|=
name|AF_INET6
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|af
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|==
name|FR_T_IPF
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_tos
condition|)
name|PRINTF
argument_list|(
literal|"tos %#x "
argument_list|,
name|fp
operator|->
name|fr_tos
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_ttl
condition|)
name|PRINTF
argument_list|(
literal|"ttl %d "
argument_list|,
name|fp
operator|->
name|fr_ttl
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_TCPUDP
condition|)
block|{
name|PRINTF
argument_list|(
literal|"proto tcp/udp "
argument_list|)
expr_stmt|;
name|pr
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_mip
operator|.
name|fi_p
condition|)
block|{
name|pr
operator|=
name|fp
operator|->
name|fr_ip
operator|.
name|fi_p
expr_stmt|;
name|p
operator|=
name|getprotobynumber
argument_list|(
name|pr
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"proto "
argument_list|)
expr_stmt|;
name|printproto
argument_list|(
name|p
argument_list|,
name|pr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|FR_T_NONE
case|:
name|PRINTF
argument_list|(
literal|"all"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FR_T_IPF
case|:
name|PRINTF
argument_list|(
literal|"from %s"
argument_list|,
name|fp
operator|->
name|fr_flags
operator|&
name|FR_NOTSRCIP
condition|?
literal|"!"
else|:
literal|""
argument_list|)
expr_stmt|;
name|printaddr
argument_list|(
name|af
argument_list|,
name|fp
operator|->
name|fr_satype
argument_list|,
name|fp
operator|->
name|fr_names
argument_list|,
name|fp
operator|->
name|fr_ifnames
index|[
literal|0
index|]
argument_list|,
operator|&
name|fp
operator|->
name|fr_src
operator|.
name|s_addr
argument_list|,
operator|&
name|fp
operator|->
name|fr_smsk
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_scmp
condition|)
name|printportcmp
argument_list|(
name|pr
argument_list|,
operator|&
name|fp
operator|->
name|fr_tuc
operator|.
name|ftu_src
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" to %s"
argument_list|,
name|fp
operator|->
name|fr_flags
operator|&
name|FR_NOTDSTIP
condition|?
literal|"!"
else|:
literal|""
argument_list|)
expr_stmt|;
name|printaddr
argument_list|(
name|af
argument_list|,
name|fp
operator|->
name|fr_datype
argument_list|,
name|fp
operator|->
name|fr_names
argument_list|,
name|fp
operator|->
name|fr_ifnames
index|[
literal|0
index|]
argument_list|,
operator|&
name|fp
operator|->
name|fr_dst
operator|.
name|s_addr
argument_list|,
operator|&
name|fp
operator|->
name|fr_dmsk
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_dcmp
condition|)
name|printportcmp
argument_list|(
name|pr
argument_list|,
operator|&
name|fp
operator|->
name|fr_tuc
operator|.
name|ftu_dst
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|fp
operator|->
name|fr_proto
operator|==
name|IPPROTO_ICMP
operator|)
operator|||
operator|(
name|fp
operator|->
name|fr_proto
operator|==
name|IPPROTO_ICMPV6
operator|)
operator|)
operator|&&
name|fp
operator|->
name|fr_icmpm
condition|)
block|{
name|int
name|type
init|=
name|fp
operator|->
name|fr_icmp
decl_stmt|,
name|code
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|type
operator|=
name|ntohs
argument_list|(
name|fp
operator|->
name|fr_icmp
argument_list|)
expr_stmt|;
name|code
operator|=
name|type
operator|&
literal|0xff
expr_stmt|;
name|type
operator|/=
literal|256
expr_stmt|;
name|name
operator|=
name|icmptypename
argument_list|(
name|fp
operator|->
name|fr_family
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
name|PRINTF
argument_list|(
literal|" icmp-type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|" icmp-type %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntohs
argument_list|(
name|fp
operator|->
name|fr_icmpm
argument_list|)
operator|&
literal|0xff
condition|)
name|PRINTF
argument_list|(
literal|" code %d"
argument_list|,
name|code
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_proto
operator|==
name|IPPROTO_TCP
operator|)
operator|&&
operator|(
name|fp
operator|->
name|fr_tcpf
operator|||
name|fp
operator|->
name|fr_tcpfm
operator|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|" flags "
argument_list|)
expr_stmt|;
name|printtcpflags
argument_list|(
name|fp
operator|->
name|fr_tcpf
argument_list|,
name|fp
operator|->
name|fr_tcpfm
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|FR_T_BPFOPC
case|:
block|{
name|fakebpf_t
modifier|*
name|fb
decl_stmt|;
name|int
name|i
decl_stmt|;
name|PRINTF
argument_list|(
literal|"bpf-v%d { \""
argument_list|,
name|fp
operator|->
name|fr_family
argument_list|)
expr_stmt|;
name|i
operator|=
name|fp
operator|->
name|fr_dsize
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|fb
argument_list|)
expr_stmt|;
for|for
control|(
name|fb
operator|=
name|fp
operator|->
name|fr_data
operator|,
name|s
operator|=
literal|""
init|;
name|i
condition|;
name|i
operator|--
operator|,
name|fb
operator|++
operator|,
name|s
operator|=
literal|" "
control|)
name|PRINTF
argument_list|(
literal|"%s%#x %#x %#x %#x"
argument_list|,
name|s
argument_list|,
name|fb
operator|->
name|fb_c
argument_list|,
name|fb
operator|->
name|fb_t
argument_list|,
name|fb
operator|->
name|fb_f
argument_list|,
name|fb
operator|->
name|fb_k
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\" }"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|FR_T_COMPIPF
case|:
break|break;
case|case
name|FR_T_CALLFUNC
case|:
name|PRINTF
argument_list|(
literal|"call function at %p"
argument_list|,
name|fp
operator|->
name|fr_data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FR_T_IPFEXPR
case|:
name|PRINTF
argument_list|(
literal|"exp { \""
argument_list|)
expr_stmt|;
name|printipfexpr
argument_list|(
name|fp
operator|->
name|fr_data
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\" } "
argument_list|)
expr_stmt|;
break|break;
default|default :
name|PRINTF
argument_list|(
literal|"[unknown filter type %#x]"
argument_list|,
name|fp
operator|->
name|fr_type
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|type
operator|==
name|FR_T_IPF
operator|)
operator|&&
operator|(
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_WITH
operator|)
operator|||
operator|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_WITH
operator|)
operator|||
name|fp
operator|->
name|fr_optbits
operator|||
name|fp
operator|->
name|fr_optmask
operator|||
name|fp
operator|->
name|fr_secbits
operator|||
name|fp
operator|->
name|fr_secmask
operator|)
condition|)
block|{
name|char
modifier|*
name|comma
init|=
literal|" "
decl_stmt|;
name|PRINTF
argument_list|(
literal|" with"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_optbits
operator|||
name|fp
operator|->
name|fr_optmask
operator|||
name|fp
operator|->
name|fr_secbits
operator|||
name|fp
operator|->
name|fr_secmask
condition|)
block|{
name|sec
index|[
literal|0
index|]
operator|=
name|fp
operator|->
name|fr_secmask
expr_stmt|;
name|sec
index|[
literal|1
index|]
operator|=
name|fp
operator|->
name|fr_secbits
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_family
operator|==
name|AF_INET
condition|)
name|optprint
argument_list|(
name|sec
argument_list|,
name|fp
operator|->
name|fr_optmask
argument_list|,
name|fp
operator|->
name|fr_optbits
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_INET6
else|else
name|optprintv6
argument_list|(
name|sec
argument_list|,
name|fp
operator|->
name|fr_optmask
argument_list|,
name|fp
operator|->
name|fr_optbits
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_OPTIONS
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_OPTIONS
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"ipopts"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_SHORT
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_SHORT
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"short"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_FRAG
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_FRAG
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"frag"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_FRAGBODY
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_FRAGBODY
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"frag-body"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_NATED
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_NATED
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"nat"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_LOWTTL
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_LOWTTL
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"lowttl"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_BAD
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_BAD
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"bad"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_BADSRC
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_BADSRC
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"bad-src"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_BADNAT
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_BADNAT
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"bad-nat"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_OOW
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_OOW
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"oow"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_MBCAST
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_MBCAST
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"mbcast"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_BROADCAST
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_BROADCAST
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"bcast"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_MULTICAST
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_MULTICAST
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"mcast"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_STATE
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_STATE
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"state"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_mflx
operator|&
name|FI_V6EXTHDR
condition|)
block|{
name|fputs
argument_list|(
name|comma
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fp
operator|->
name|fr_flx
operator|&
name|FI_V6EXTHDR
operator|)
condition|)
name|PRINTF
argument_list|(
literal|"not "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"v6hdrs"
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_KEEPSTATE
condition|)
block|{
name|host_track_t
modifier|*
name|src
init|=
operator|&
name|fp
operator|->
name|fr_srctrack
decl_stmt|;
name|PRINTF
argument_list|(
literal|" keep state"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
operator|(
name|FR_STSTRICT
operator||
name|FR_NEWISN
operator||
name|FR_NOICMPERR
operator||
name|FR_STATESYNC
operator|)
operator|)
operator|||
operator|(
name|fp
operator|->
name|fr_statemax
operator|!=
literal|0
operator|)
operator|||
operator|(
name|fp
operator|->
name|fr_age
index|[
literal|0
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|src
operator|->
name|ht_max_nodes
operator|!=
literal|0
operator|)
condition|)
block|{
name|char
modifier|*
name|comma
init|=
literal|""
decl_stmt|;
name|PRINTF
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_statemax
operator|!=
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|"limit %u"
argument_list|,
name|fp
operator|->
name|fr_statemax
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|src
operator|->
name|ht_max_nodes
operator|!=
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%smax-nodes %d"
argument_list|,
name|comma
argument_list|,
name|src
operator|->
name|ht_max_nodes
argument_list|)
expr_stmt|;
if|if
condition|(
name|src
operator|->
name|ht_max_per_node
condition|)
name|PRINTF
argument_list|(
literal|", max-per-src %d/%d"
argument_list|,
name|src
operator|->
name|ht_max_per_node
argument_list|,
name|src
operator|->
name|ht_netmask
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_STSTRICT
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%sstrict"
argument_list|,
name|comma
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_STLOOSE
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%sloose"
argument_list|,
name|comma
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_NEWISN
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%snewisn"
argument_list|,
name|comma
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_NOICMPERR
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%sno-icmp-err"
argument_list|,
name|comma
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_STATESYNC
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%ssync"
argument_list|,
name|comma
argument_list|)
expr_stmt|;
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_age
index|[
literal|0
index|]
operator|||
name|fp
operator|->
name|fr_age
index|[
literal|1
index|]
condition|)
name|PRINTF
argument_list|(
literal|"%sage %d/%d"
argument_list|,
name|comma
argument_list|,
name|fp
operator|->
name|fr_age
index|[
literal|0
index|]
argument_list|,
name|fp
operator|->
name|fr_age
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_KEEPFRAG
condition|)
block|{
name|PRINTF
argument_list|(
literal|" keep frags"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
operator|(
name|FR_FRSTRICT
operator|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_FRSTRICT
condition|)
name|PRINTF
argument_list|(
literal|"strict"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fp
operator|->
name|fr_isc
operator|!=
operator|(
expr|struct
name|ipscan
operator|*
operator|)
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fr_isctag
operator|!=
operator|-
literal|1
condition|)
name|PRINTF
argument_list|(
literal|" scan %s"
argument_list|,
name|fp
operator|->
name|fr_isctag
operator|+
name|fp
operator|->
name|fr_names
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|" scan *"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_grhead
operator|!=
operator|-
literal|1
condition|)
name|PRINTF
argument_list|(
literal|" head %s"
argument_list|,
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_grhead
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_group
operator|!=
operator|-
literal|1
condition|)
name|PRINTF
argument_list|(
literal|" group %s"
argument_list|,
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_logtag
operator|!=
name|FR_NOLOGTAG
operator|||
operator|*
name|fp
operator|->
name|fr_nattag
operator|.
name|ipt_tag
condition|)
block|{
name|char
modifier|*
name|s
init|=
literal|""
decl_stmt|;
name|PRINTF
argument_list|(
literal|" set-tag("
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_logtag
operator|!=
name|FR_NOLOGTAG
condition|)
block|{
name|PRINTF
argument_list|(
literal|"log=%u"
argument_list|,
name|fp
operator|->
name|fr_logtag
argument_list|)
expr_stmt|;
name|s
operator|=
literal|", "
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|fp
operator|->
name|fr_nattag
operator|.
name|ipt_tag
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%snat=%-.*s"
argument_list|,
name|s
argument_list|,
name|IPFTAG_LEN
argument_list|,
name|fp
operator|->
name|fr_nattag
operator|.
name|ipt_tag
argument_list|)
expr_stmt|;
block|}
name|PRINTF
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fr_pps
condition|)
name|PRINTF
argument_list|(
literal|" pps %d"
argument_list|,
name|fp
operator|->
name|fr_pps
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_comment
operator|!=
operator|-
literal|1
condition|)
name|PRINTF
argument_list|(
literal|" comment \"%s\""
argument_list|,
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_comment
argument_list|)
expr_stmt|;
name|hash
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|->
name|fr_flags
operator|&
name|FR_KEEPSTATE
operator|)
operator|&&
operator|(
name|opts
operator|&
name|OPT_VERBOSE
operator|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|" # count %d"
argument_list|,
name|fp
operator|->
name|fr_statecnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_die
operator|!=
literal|0
condition|)
name|PRINTF
argument_list|(
literal|" rule-ttl %u"
argument_list|,
name|fp
operator|->
name|fr_die
argument_list|)
expr_stmt|;
name|hash
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fp
operator|->
name|fr_die
operator|!=
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|" # rule-ttl %u"
argument_list|,
name|fp
operator|->
name|fr_die
argument_list|)
expr_stmt|;
name|hash
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
block|{
if|if
condition|(
name|hash
operator|==
literal|0
condition|)
name|putchar
argument_list|(
literal|'#'
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" ref %d"
argument_list|,
name|fp
operator|->
name|fr_ref
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


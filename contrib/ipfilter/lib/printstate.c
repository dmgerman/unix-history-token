begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/*  * Copyright (C) 2012 by Darren Reed.  *  * See the IPFILTER.LICENCE file for details on licencing.  */
end_comment

begin_include
include|#
directive|include
file|"ipf.h"
end_include

begin_include
include|#
directive|include
file|"kmem.h"
end_include

begin_function
name|ipstate_t
modifier|*
name|printstate
parameter_list|(
name|sp
parameter_list|,
name|opts
parameter_list|,
name|now
parameter_list|)
name|ipstate_t
modifier|*
name|sp
decl_stmt|;
name|int
name|opts
decl_stmt|;
name|u_long
name|now
decl_stmt|;
block|{
name|struct
name|protoent
modifier|*
name|pr
decl_stmt|;
name|synclist_t
name|ipsync
decl_stmt|;
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_NORESOLVE
operator|)
operator|==
literal|0
condition|)
name|pr
operator|=
name|getprotobynumber
argument_list|(
name|sp
operator|->
name|is_p
argument_list|)
expr_stmt|;
else|else
name|pr
operator|=
name|NULL
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%d:"
argument_list|,
name|sp
operator|->
name|is_v
argument_list|)
expr_stmt|;
if|if
condition|(
name|pr
operator|!=
name|NULL
condition|)
name|PRINTF
argument_list|(
literal|"%s"
argument_list|,
name|pr
operator|->
name|p_name
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|"%d"
argument_list|,
name|sp
operator|->
name|is_p
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" src:%s"
argument_list|,
name|hostname
argument_list|(
name|sp
operator|->
name|is_family
argument_list|,
operator|&
name|sp
operator|->
name|is_src
operator|.
name|in4
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_p
operator|==
name|IPPROTO_UDP
operator|||
name|sp
operator|->
name|is_p
operator|==
name|IPPROTO_TCP
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|is_flags
operator|&
name|IS_WSPORT
condition|)
name|PRINTF
argument_list|(
literal|",*"
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|",%d"
argument_list|,
name|ntohs
argument_list|(
name|sp
operator|->
name|is_sport
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|PRINTF
argument_list|(
literal|" dst:%s"
argument_list|,
name|hostname
argument_list|(
name|sp
operator|->
name|is_family
argument_list|,
operator|&
name|sp
operator|->
name|is_dst
operator|.
name|in4
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_p
operator|==
name|IPPROTO_UDP
operator|||
name|sp
operator|->
name|is_p
operator|==
name|IPPROTO_TCP
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|is_flags
operator|&
name|IS_WDPORT
condition|)
name|PRINTF
argument_list|(
literal|",*"
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|",%d"
argument_list|,
name|ntohs
argument_list|(
name|sp
operator|->
name|is_dport
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|is_p
operator|==
name|IPPROTO_TCP
condition|)
block|{
name|PRINTF
argument_list|(
literal|" state:%d/%d"
argument_list|,
name|sp
operator|->
name|is_state
index|[
literal|0
index|]
argument_list|,
name|sp
operator|->
name|is_state
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|PRINTF
argument_list|(
literal|" %ld"
argument_list|,
name|sp
operator|->
name|is_die
operator|-
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_phnext
operator|==
name|NULL
condition|)
name|PRINTF
argument_list|(
literal|" ORPHAN"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_flags
operator|&
name|IS_CLONE
condition|)
name|PRINTF
argument_list|(
literal|" CLONE"
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_p
operator|==
name|IPPROTO_TCP
condition|)
block|{
name|PRINTF
argument_list|(
literal|"\t%x:%x %hu<<%d:%hu<<%d\n"
argument_list|,
name|sp
operator|->
name|is_send
argument_list|,
name|sp
operator|->
name|is_dend
argument_list|,
name|sp
operator|->
name|is_maxswin
argument_list|,
name|sp
operator|->
name|is_swinscale
argument_list|,
name|sp
operator|->
name|is_maxdwin
argument_list|,
name|sp
operator|->
name|is_dwinscale
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_VERBOSE
operator|)
operator|!=
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|"\tcmsk %04x smsk %04x isc %p s0 %08x/%08x\n"
argument_list|,
name|sp
operator|->
name|is_smsk
index|[
literal|0
index|]
argument_list|,
name|sp
operator|->
name|is_smsk
index|[
literal|1
index|]
argument_list|,
name|sp
operator|->
name|is_isc
argument_list|,
name|sp
operator|->
name|is_s0
index|[
literal|0
index|]
argument_list|,
name|sp
operator|->
name|is_s0
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tFWD: ISN inc %x sumd %x\n"
argument_list|,
name|sp
operator|->
name|is_isninc
index|[
literal|0
index|]
argument_list|,
name|sp
operator|->
name|is_sumd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tREV: ISN inc %x sumd %x\n"
argument_list|,
name|sp
operator|->
name|is_isninc
index|[
literal|1
index|]
argument_list|,
name|sp
operator|->
name|is_sumd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IPFILTER_SCAN
name|PRINTF
argument_list|(
literal|"\tsbuf[0] ["
argument_list|)
expr_stmt|;
name|printsbuf
argument_list|(
name|sp
operator|->
name|is_sbuf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"] sbuf[1] ["
argument_list|)
expr_stmt|;
name|printsbuf
argument_list|(
name|sp
operator|->
name|is_sbuf
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"]\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
elseif|else
if|if
condition|(
name|sp
operator|->
name|is_p
operator|==
name|IPPROTO_GRE
condition|)
block|{
name|PRINTF
argument_list|(
literal|"\tcall %hx/%hx\n"
argument_list|,
name|ntohs
argument_list|(
name|sp
operator|->
name|is_gre
operator|.
name|gs_call
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|sp
operator|->
name|is_gre
operator|.
name|gs_call
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sp
operator|->
name|is_p
operator|==
name|IPPROTO_ICMP
ifdef|#
directive|ifdef
name|USE_INET6
operator|||
name|sp
operator|->
name|is_p
operator|==
name|IPPROTO_ICMPV6
endif|#
directive|endif
condition|)
block|{
name|PRINTF
argument_list|(
literal|"\tid %hu seq %hu type %d\n"
argument_list|,
name|sp
operator|->
name|is_icmp
operator|.
name|ici_id
argument_list|,
name|sp
operator|->
name|is_icmp
operator|.
name|ici_seq
argument_list|,
name|sp
operator|->
name|is_icmp
operator|.
name|ici_type
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|USE_QUAD_T
name|PRINTF
argument_list|(
literal|"\tFWD: IN pkts %"
name|PRIu64
literal|" bytes %"
name|PRIu64
literal|" OUT pkts %"
name|PRIu64
literal|" bytes %"
name|PRIu64
literal|"\n\tREV: IN pkts %"
name|PRIu64
literal|" bytes %"
name|PRIu64
literal|" OUT pkts %"
name|PRIu64
literal|" bytes %"
name|PRIu64
literal|"\n"
argument_list|,
name|sp
operator|->
name|is_pkts
index|[
literal|0
index|]
argument_list|,
name|sp
operator|->
name|is_bytes
index|[
literal|0
index|]
argument_list|,
name|sp
operator|->
name|is_pkts
index|[
literal|1
index|]
argument_list|,
name|sp
operator|->
name|is_bytes
index|[
literal|1
index|]
argument_list|,
name|sp
operator|->
name|is_pkts
index|[
literal|2
index|]
argument_list|,
name|sp
operator|->
name|is_bytes
index|[
literal|2
index|]
argument_list|,
name|sp
operator|->
name|is_pkts
index|[
literal|3
index|]
argument_list|,
name|sp
operator|->
name|is_bytes
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
else|#
directive|else
name|PRINTF
argument_list|(
literal|"\tFWD: IN pkts %lu bytes %lu OUT pkts %lu bytes %lu\n\tREV: IN pkts %lu bytes %lu OUT pkts %lu bytes %lu\n"
argument_list|,
name|sp
operator|->
name|is_pkts
index|[
literal|0
index|]
argument_list|,
name|sp
operator|->
name|is_bytes
index|[
literal|0
index|]
argument_list|,
name|sp
operator|->
name|is_pkts
index|[
literal|1
index|]
argument_list|,
name|sp
operator|->
name|is_bytes
index|[
literal|1
index|]
argument_list|,
name|sp
operator|->
name|is_pkts
index|[
literal|2
index|]
argument_list|,
name|sp
operator|->
name|is_bytes
index|[
literal|2
index|]
argument_list|,
name|sp
operator|->
name|is_pkts
index|[
literal|3
index|]
argument_list|,
name|sp
operator|->
name|is_bytes
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|PRINTF
argument_list|(
literal|"\ttag %u pass %#x = "
argument_list|,
name|sp
operator|->
name|is_tag
argument_list|,
name|sp
operator|->
name|is_pass
argument_list|)
expr_stmt|;
comment|/* 	 * Print out bits set in the result code for the state being 	 * kept as they would for a rule. 	 */
if|if
condition|(
name|FR_ISPASS
argument_list|(
name|sp
operator|->
name|is_pass
argument_list|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|"pass"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FR_ISBLOCK
argument_list|(
name|sp
operator|->
name|is_pass
argument_list|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|"block"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_RETMASK
condition|)
block|{
case|case
name|FR_RETICMP
case|:
name|PRINTF
argument_list|(
literal|" return-icmp"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FR_FAKEICMP
case|:
name|PRINTF
argument_list|(
literal|" return-icmp-as-dest"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FR_RETRST
case|:
name|PRINTF
argument_list|(
literal|" return-rst"
argument_list|)
expr_stmt|;
break|break;
default|default :
break|break;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_LOGMASK
operator|)
operator|==
name|FR_LOG
condition|)
block|{
name|PRINTF
argument_list|(
literal|"log"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_LOGBODY
condition|)
name|PRINTF
argument_list|(
literal|" body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_LOGFIRST
condition|)
name|PRINTF
argument_list|(
literal|" first"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FR_ISACCOUNT
argument_list|(
name|sp
operator|->
name|is_pass
argument_list|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|"count"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FR_ISPREAUTH
argument_list|(
name|sp
operator|->
name|is_pass
argument_list|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|"preauth"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FR_ISAUTH
argument_list|(
name|sp
operator|->
name|is_pass
argument_list|)
condition|)
name|PRINTF
argument_list|(
literal|"auth"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_OUTQUE
condition|)
name|PRINTF
argument_list|(
literal|" out"
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|" in"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_LOG
operator|)
operator|!=
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|" log"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_LOGBODY
condition|)
name|PRINTF
argument_list|(
literal|" body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_LOGFIRST
condition|)
name|PRINTF
argument_list|(
literal|" first"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_LOGORBLOCK
condition|)
name|PRINTF
argument_list|(
literal|" or-block"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_QUICK
condition|)
name|PRINTF
argument_list|(
literal|" quick"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_KEEPFRAG
condition|)
name|PRINTF
argument_list|(
literal|" keep frags"
argument_list|)
expr_stmt|;
comment|/* a given; no? */
if|if
condition|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_KEEPSTATE
condition|)
block|{
name|PRINTF
argument_list|(
literal|" keep state"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_pass
operator|&
operator|(
name|FR_STATESYNC
operator||
name|FR_STSTRICT
operator||
name|FR_STLOOSE
operator|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_STATESYNC
condition|)
name|PRINTF
argument_list|(
literal|" sync"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_STSTRICT
condition|)
name|PRINTF
argument_list|(
literal|" strict"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_pass
operator|&
name|FR_STLOOSE
condition|)
name|PRINTF
argument_list|(
literal|" loose"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" )"
argument_list|)
expr_stmt|;
block|}
block|}
name|PRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|opts
operator|&
name|OPT_VERBOSE
operator|)
operator|!=
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|"\tref %d"
argument_list|,
name|sp
operator|->
name|is_ref
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" pkt_flags& %x(%x) = %x\n"
argument_list|,
name|sp
operator|->
name|is_flags
operator|&
literal|0xf
argument_list|,
name|sp
operator|->
name|is_flags
argument_list|,
name|sp
operator|->
name|is_flags
operator|>>
literal|4
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tpkt_options& %x = %x, %x = %x \n"
argument_list|,
name|sp
operator|->
name|is_optmsk
index|[
literal|0
index|]
argument_list|,
name|sp
operator|->
name|is_opt
index|[
literal|0
index|]
argument_list|,
name|sp
operator|->
name|is_optmsk
index|[
literal|1
index|]
argument_list|,
name|sp
operator|->
name|is_opt
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tpkt_security& %x = %x, pkt_auth& %x = %x\n"
argument_list|,
name|sp
operator|->
name|is_secmsk
argument_list|,
name|sp
operator|->
name|is_sec
argument_list|,
name|sp
operator|->
name|is_authmsk
argument_list|,
name|sp
operator|->
name|is_auth
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tis_flx %#x %#x %#x %#x\n"
argument_list|,
name|sp
operator|->
name|is_flx
index|[
literal|0
index|]
index|[
literal|0
index|]
argument_list|,
name|sp
operator|->
name|is_flx
index|[
literal|0
index|]
index|[
literal|1
index|]
argument_list|,
name|sp
operator|->
name|is_flx
index|[
literal|1
index|]
index|[
literal|0
index|]
argument_list|,
name|sp
operator|->
name|is_flx
index|[
literal|1
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|PRINTF
argument_list|(
literal|"\tinterfaces: in %s[%s"
argument_list|,
name|getifname
argument_list|(
name|sp
operator|->
name|is_ifp
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|sp
operator|->
name|is_ifname
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
name|PRINTF
argument_list|(
literal|"/%p"
argument_list|,
name|sp
operator|->
name|is_ifp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|']'
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|",%s[%s"
argument_list|,
name|getifname
argument_list|(
name|sp
operator|->
name|is_ifp
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|sp
operator|->
name|is_ifname
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
name|PRINTF
argument_list|(
literal|"/%p"
argument_list|,
name|sp
operator|->
name|is_ifp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|']'
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" out %s[%s"
argument_list|,
name|getifname
argument_list|(
name|sp
operator|->
name|is_ifp
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|sp
operator|->
name|is_ifname
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
name|PRINTF
argument_list|(
literal|"/%p"
argument_list|,
name|sp
operator|->
name|is_ifp
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|']'
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|",%s[%s"
argument_list|,
name|getifname
argument_list|(
name|sp
operator|->
name|is_ifp
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|sp
operator|->
name|is_ifname
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
name|PRINTF
argument_list|(
literal|"/%p"
argument_list|,
name|sp
operator|->
name|is_ifp
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"]\n"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tSync status: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|is_sync
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ipsync
argument_list|,
operator|(
name|u_long
operator|)
name|sp
operator|->
name|is_sync
argument_list|,
sizeof|sizeof
argument_list|(
name|ipsync
argument_list|)
argument_list|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|"status could not be retrieved\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|PRINTF
argument_list|(
literal|"idx %d num %d v %d pr %d rev %d\n"
argument_list|,
name|ipsync
operator|.
name|sl_idx
argument_list|,
name|ipsync
operator|.
name|sl_num
argument_list|,
name|ipsync
operator|.
name|sl_v
argument_list|,
name|ipsync
operator|.
name|sl_p
argument_list|,
name|ipsync
operator|.
name|sl_rev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PRINTF
argument_list|(
literal|"not synchronized\n"
argument_list|)
expr_stmt|;
block|}
return|return
name|sp
operator|->
name|is_next
return|;
block|}
end_function

end_unit


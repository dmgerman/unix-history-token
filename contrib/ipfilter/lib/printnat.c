begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/*  * Copyright (C) 2012 by Darren Reed.  *  * See the IPFILTER.LICENCE file for details on licencing.  *  * Added redirect stuff and a variety of bug fixes. (mcn@EnGarde.com)  */
end_comment

begin_include
include|#
directive|include
file|"ipf.h"
end_include

begin_include
include|#
directive|include
file|"kmem.h"
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
end_if

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"@(#)$Id$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Print out a NAT rule  */
end_comment

begin_function
name|void
name|printnat
parameter_list|(
name|np
parameter_list|,
name|opts
parameter_list|)
name|ipnat_t
modifier|*
name|np
decl_stmt|;
name|int
name|opts
decl_stmt|;
block|{
name|struct
name|protoent
modifier|*
name|pr
decl_stmt|;
name|char
modifier|*
name|base
decl_stmt|;
name|int
name|family
decl_stmt|;
name|int
name|proto
decl_stmt|;
if|if
condition|(
name|np
operator|->
name|in_v
index|[
literal|0
index|]
operator|==
literal|4
condition|)
name|family
operator|=
name|AF_INET
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_INET6
elseif|else
if|if
condition|(
name|np
operator|->
name|in_v
index|[
literal|0
index|]
operator|==
literal|6
condition|)
name|family
operator|=
name|AF_INET6
expr_stmt|;
endif|#
directive|endif
else|else
name|family
operator|=
name|AF_UNSPEC
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_NO
condition|)
name|PRINTF
argument_list|(
literal|"no "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|np
operator|->
name|in_redir
condition|)
block|{
case|case
name|NAT_REDIRECT
operator||
name|NAT_ENCAP
case|:
name|PRINTF
argument_list|(
literal|"encap in on"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|np
operator|->
name|in_pr
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
name|NAT_MAP
operator||
name|NAT_ENCAP
case|:
name|PRINTF
argument_list|(
literal|"encap out on"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|np
operator|->
name|in_pr
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|NAT_REDIRECT
operator||
name|NAT_DIVERTUDP
case|:
name|PRINTF
argument_list|(
literal|"divert in on"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|np
operator|->
name|in_pr
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
name|NAT_MAP
operator||
name|NAT_DIVERTUDP
case|:
name|PRINTF
argument_list|(
literal|"divert out on"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|np
operator|->
name|in_pr
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|NAT_REDIRECT
operator||
name|NAT_REWRITE
case|:
name|PRINTF
argument_list|(
literal|"rewrite in on"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|np
operator|->
name|in_pr
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
name|NAT_MAP
operator||
name|NAT_REWRITE
case|:
name|PRINTF
argument_list|(
literal|"rewrite out on"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|np
operator|->
name|in_pr
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|NAT_REDIRECT
case|:
name|PRINTF
argument_list|(
literal|"rdr"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|np
operator|->
name|in_pr
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
name|NAT_MAP
case|:
name|PRINTF
argument_list|(
literal|"map"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|np
operator|->
name|in_pr
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|NAT_MAPBLK
case|:
name|PRINTF
argument_list|(
literal|"map-block"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|np
operator|->
name|in_pr
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|NAT_BIMAP
case|:
name|PRINTF
argument_list|(
literal|"bimap"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|np
operator|->
name|in_pr
index|[
literal|0
index|]
expr_stmt|;
break|break;
default|default :
name|FPRINTF
argument_list|(
name|stderr
argument_list|,
literal|"unknown value for in_redir: %#x\n"
argument_list|,
name|np
operator|->
name|in_redir
argument_list|)
expr_stmt|;
name|proto
operator|=
name|np
operator|->
name|in_pr
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
name|pr
operator|=
name|getprotobynumber
argument_list|(
name|proto
argument_list|)
expr_stmt|;
name|base
operator|=
name|np
operator|->
name|in_names
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|base
operator|+
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|,
literal|"-"
argument_list|)
condition|)
name|PRINTF
argument_list|(
literal|" \"%s\""
argument_list|,
name|base
operator|+
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|" %s"
argument_list|,
name|base
operator|+
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|np
operator|->
name|in_ifnames
index|[
literal|1
index|]
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|strcmp
argument_list|(
name|base
operator|+
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|,
name|base
operator|+
name|np
operator|->
name|in_ifnames
index|[
literal|1
index|]
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|base
operator|+
name|np
operator|->
name|in_ifnames
index|[
literal|1
index|]
argument_list|,
literal|"-"
argument_list|)
condition|)
name|PRINTF
argument_list|(
literal|",\"%s\""
argument_list|,
name|base
operator|+
name|np
operator|->
name|in_ifnames
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|",%s"
argument_list|,
name|base
operator|+
name|np
operator|->
name|in_ifnames
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|family
operator|==
name|AF_INET6
condition|)
name|PRINTF
argument_list|(
literal|"inet6 "
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_redir
operator|&
operator|(
name|NAT_REWRITE
operator||
name|NAT_ENCAP
operator||
name|NAT_DIVERTUDP
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|proto
operator|!=
literal|0
operator|)
operator|||
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_TCPUDP
operator|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|"proto "
argument_list|)
expr_stmt|;
name|printproto
argument_list|(
name|pr
argument_list|,
name|proto
argument_list|,
name|np
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_FILTER
condition|)
block|{
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_NOTSRC
condition|)
name|PRINTF
argument_list|(
literal|"! "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"from "
argument_list|)
expr_stmt|;
name|printnataddr
argument_list|(
name|np
operator|->
name|in_v
index|[
literal|0
index|]
argument_list|,
name|np
operator|->
name|in_names
argument_list|,
operator|&
name|np
operator|->
name|in_osrc
argument_list|,
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_scmp
condition|)
name|printportcmp
argument_list|(
name|proto
argument_list|,
operator|&
name|np
operator|->
name|in_tuc
operator|.
name|ftu_src
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_NOTDST
condition|)
name|PRINTF
argument_list|(
literal|" !"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" to "
argument_list|)
expr_stmt|;
name|printnataddr
argument_list|(
name|np
operator|->
name|in_v
index|[
literal|0
index|]
argument_list|,
name|np
operator|->
name|in_names
argument_list|,
operator|&
name|np
operator|->
name|in_odst
argument_list|,
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_dcmp
condition|)
name|printportcmp
argument_list|(
name|proto
argument_list|,
operator|&
name|np
operator|->
name|in_tuc
operator|.
name|ftu_dst
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|np
operator|->
name|in_redir
operator|&
operator|(
name|NAT_ENCAP
operator||
name|NAT_DIVERTUDP
operator|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|" -> src "
argument_list|)
expr_stmt|;
name|printnataddr
argument_list|(
name|np
operator|->
name|in_v
index|[
literal|1
index|]
argument_list|,
name|np
operator|->
name|in_names
argument_list|,
operator|&
name|np
operator|->
name|in_nsrc
argument_list|,
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|np
operator|->
name|in_redir
operator|&
name|NAT_DIVERTUDP
operator|)
operator|!=
literal|0
condition|)
name|PRINTF
argument_list|(
literal|",%u"
argument_list|,
name|np
operator|->
name|in_spmin
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" dst "
argument_list|)
expr_stmt|;
name|printnataddr
argument_list|(
name|np
operator|->
name|in_v
index|[
literal|1
index|]
argument_list|,
name|np
operator|->
name|in_names
argument_list|,
operator|&
name|np
operator|->
name|in_ndst
argument_list|,
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|np
operator|->
name|in_redir
operator|&
name|NAT_DIVERTUDP
operator|)
operator|!=
literal|0
condition|)
name|PRINTF
argument_list|(
literal|",%u udp"
argument_list|,
name|np
operator|->
name|in_dpmin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_PURGE
operator|)
operator|!=
literal|0
condition|)
name|PRINTF
argument_list|(
literal|" purge"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|";\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|np
operator|->
name|in_redir
operator|&
name|NAT_REWRITE
condition|)
block|{
name|PRINTF
argument_list|(
literal|" -> src "
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_nsrc
operator|.
name|na_atype
operator|==
name|FRI_LOOKUP
operator|&&
name|np
operator|->
name|in_nsrc
operator|.
name|na_type
operator|==
name|IPLT_DSTLIST
condition|)
block|{
name|PRINTF
argument_list|(
literal|"dstlist/"
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_nsrc
operator|.
name|na_subtype
operator|==
literal|0
condition|)
name|PRINTF
argument_list|(
literal|"%d"
argument_list|,
name|np
operator|->
name|in_nsrc
operator|.
name|na_num
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|"%s"
argument_list|,
name|base
operator|+
name|np
operator|->
name|in_nsrc
operator|.
name|na_num
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printnataddr
argument_list|(
name|np
operator|->
name|in_v
index|[
literal|1
index|]
argument_list|,
name|np
operator|->
name|in_names
argument_list|,
operator|&
name|np
operator|->
name|in_nsrc
argument_list|,
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_TCPUDP
operator|)
operator|!=
literal|0
operator|)
operator|)
operator|&&
operator|(
name|np
operator|->
name|in_spmin
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_FIXEDSPORT
operator|)
operator|!=
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|",port = %u"
argument_list|,
name|np
operator|->
name|in_spmin
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PRINTF
argument_list|(
literal|",%u"
argument_list|,
name|np
operator|->
name|in_spmin
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_spmax
operator|!=
name|np
operator|->
name|in_spmin
condition|)
name|PRINTF
argument_list|(
literal|"-%u"
argument_list|,
name|np
operator|->
name|in_spmax
argument_list|)
expr_stmt|;
block|}
block|}
name|PRINTF
argument_list|(
literal|" dst "
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_ndst
operator|.
name|na_atype
operator|==
name|FRI_LOOKUP
operator|&&
name|np
operator|->
name|in_ndst
operator|.
name|na_type
operator|==
name|IPLT_DSTLIST
condition|)
block|{
name|PRINTF
argument_list|(
literal|"dstlist/"
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_ndst
operator|.
name|na_subtype
operator|==
literal|0
condition|)
name|PRINTF
argument_list|(
literal|"%d"
argument_list|,
name|np
operator|->
name|in_nsrc
operator|.
name|na_num
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|"%s"
argument_list|,
name|base
operator|+
name|np
operator|->
name|in_ndst
operator|.
name|na_num
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printnataddr
argument_list|(
name|np
operator|->
name|in_v
index|[
literal|1
index|]
argument_list|,
name|np
operator|->
name|in_names
argument_list|,
operator|&
name|np
operator|->
name|in_ndst
argument_list|,
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_TCPUDP
operator|)
operator|!=
literal|0
operator|)
operator|)
operator|&&
operator|(
name|np
operator|->
name|in_dpmin
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_FIXEDDPORT
operator|)
operator|!=
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|",port = %u"
argument_list|,
name|np
operator|->
name|in_dpmin
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PRINTF
argument_list|(
literal|",%u"
argument_list|,
name|np
operator|->
name|in_dpmin
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_dpmax
operator|!=
name|np
operator|->
name|in_dpmin
condition|)
name|PRINTF
argument_list|(
literal|"-%u"
argument_list|,
name|np
operator|->
name|in_dpmax
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_PURGE
operator|)
operator|!=
literal|0
condition|)
name|PRINTF
argument_list|(
literal|" purge"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|";\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|np
operator|->
name|in_redir
operator|==
name|NAT_REDIRECT
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_FILTER
operator|)
condition|)
block|{
name|printnataddr
argument_list|(
name|np
operator|->
name|in_v
index|[
literal|0
index|]
argument_list|,
name|np
operator|->
name|in_names
argument_list|,
operator|&
name|np
operator|->
name|in_odst
argument_list|,
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_TCPUDP
condition|)
block|{
name|PRINTF
argument_list|(
literal|" port %d"
argument_list|,
name|np
operator|->
name|in_odport
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_odport
operator|!=
name|np
operator|->
name|in_dtop
condition|)
name|PRINTF
argument_list|(
literal|"-%d"
argument_list|,
name|np
operator|->
name|in_dtop
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_NO
condition|)
block|{
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|printproto
argument_list|(
name|pr
argument_list|,
name|proto
argument_list|,
name|np
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|";\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|PRINTF
argument_list|(
literal|" -> "
argument_list|)
expr_stmt|;
name|printnataddr
argument_list|(
name|np
operator|->
name|in_v
index|[
literal|1
index|]
argument_list|,
name|np
operator|->
name|in_names
argument_list|,
operator|&
name|np
operator|->
name|in_ndst
argument_list|,
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_TCPUDP
condition|)
block|{
if|if
condition|(
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_FIXEDDPORT
operator|)
operator|!=
literal|0
condition|)
name|PRINTF
argument_list|(
literal|" port = %d"
argument_list|,
name|np
operator|->
name|in_dpmin
argument_list|)
expr_stmt|;
else|else
block|{
name|PRINTF
argument_list|(
literal|" port %d"
argument_list|,
name|np
operator|->
name|in_dpmin
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_dpmin
operator|!=
name|np
operator|->
name|in_dpmax
condition|)
name|PRINTF
argument_list|(
literal|"-%d"
argument_list|,
name|np
operator|->
name|in_dpmax
argument_list|)
expr_stmt|;
block|}
block|}
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|printproto
argument_list|(
name|pr
argument_list|,
name|proto
argument_list|,
name|np
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_ROUNDR
condition|)
name|PRINTF
argument_list|(
literal|" round-robin"
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_FRAG
condition|)
name|PRINTF
argument_list|(
literal|" frag"
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_age
index|[
literal|0
index|]
operator|!=
literal|0
operator|||
name|np
operator|->
name|in_age
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|" age %d/%d"
argument_list|,
name|np
operator|->
name|in_age
index|[
literal|0
index|]
argument_list|,
name|np
operator|->
name|in_age
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_STICKY
condition|)
name|PRINTF
argument_list|(
literal|" sticky"
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_mssclamp
operator|!=
literal|0
condition|)
name|PRINTF
argument_list|(
literal|" mssclamp %d"
argument_list|,
name|np
operator|->
name|in_mssclamp
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_plabel
operator|!=
operator|-
literal|1
condition|)
name|PRINTF
argument_list|(
literal|" proxy %s"
argument_list|,
name|np
operator|->
name|in_names
operator|+
name|np
operator|->
name|in_plabel
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_tag
operator|.
name|ipt_tag
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|PRINTF
argument_list|(
literal|" tag %-.*s"
argument_list|,
name|IPFTAG_LEN
argument_list|,
name|np
operator|->
name|in_tag
operator|.
name|ipt_tag
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_PURGE
operator|)
operator|!=
literal|0
condition|)
name|PRINTF
argument_list|(
literal|" purge"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
name|PRINTF
argument_list|(
literal|"\tpmax %u\n"
argument_list|,
name|np
operator|->
name|in_dpmax
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|protoprinted
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_FILTER
operator|)
condition|)
block|{
name|printnataddr
argument_list|(
name|np
operator|->
name|in_v
index|[
literal|0
index|]
argument_list|,
name|np
operator|->
name|in_names
argument_list|,
operator|&
name|np
operator|->
name|in_osrc
argument_list|,
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_NO
condition|)
block|{
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|printproto
argument_list|(
name|pr
argument_list|,
name|proto
argument_list|,
name|np
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|";\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|PRINTF
argument_list|(
literal|" -> "
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_SIPRANGE
condition|)
block|{
name|PRINTF
argument_list|(
literal|"range "
argument_list|)
expr_stmt|;
name|printnataddr
argument_list|(
name|np
operator|->
name|in_v
index|[
literal|1
index|]
argument_list|,
name|np
operator|->
name|in_names
argument_list|,
operator|&
name|np
operator|->
name|in_nsrc
argument_list|,
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printnataddr
argument_list|(
name|np
operator|->
name|in_v
index|[
literal|1
index|]
argument_list|,
name|np
operator|->
name|in_names
argument_list|,
operator|&
name|np
operator|->
name|in_nsrc
argument_list|,
name|np
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|np
operator|->
name|in_plabel
operator|!=
operator|-
literal|1
condition|)
block|{
name|PRINTF
argument_list|(
literal|" proxy port "
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_odport
operator|!=
literal|0
condition|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|s
operator|=
name|portname
argument_list|(
name|proto
argument_list|,
name|np
operator|->
name|in_odport
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
condition|)
name|fputs
argument_list|(
name|s
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
else|else
name|fputs
argument_list|(
literal|"???"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
name|PRINTF
argument_list|(
literal|" %s/"
argument_list|,
name|np
operator|->
name|in_names
operator|+
name|np
operator|->
name|in_plabel
argument_list|)
expr_stmt|;
name|printproto
argument_list|(
name|pr
argument_list|,
name|proto
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|protoprinted
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|np
operator|->
name|in_redir
operator|==
name|NAT_MAPBLK
condition|)
block|{
if|if
condition|(
operator|(
name|np
operator|->
name|in_spmin
operator|==
literal|0
operator|)
operator|&&
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_AUTOPORTMAP
operator|)
condition|)
name|PRINTF
argument_list|(
literal|" ports auto"
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|" ports %d"
argument_list|,
name|np
operator|->
name|in_spmin
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
name|PRINTF
argument_list|(
literal|"\n\tip modulous %d"
argument_list|,
name|np
operator|->
name|in_spmax
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|np
operator|->
name|in_spmin
operator|||
name|np
operator|->
name|in_spmax
condition|)
block|{
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_ICMPQUERY
condition|)
block|{
name|PRINTF
argument_list|(
literal|" icmpidmap "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PRINTF
argument_list|(
literal|" portmap "
argument_list|)
expr_stmt|;
block|}
name|printproto
argument_list|(
name|pr
argument_list|,
name|proto
argument_list|,
name|np
argument_list|)
expr_stmt|;
name|protoprinted
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_AUTOPORTMAP
condition|)
block|{
name|PRINTF
argument_list|(
literal|" auto"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
name|PRINTF
argument_list|(
literal|" [%d:%d %d %d]"
argument_list|,
name|np
operator|->
name|in_spmin
argument_list|,
name|np
operator|->
name|in_spmax
argument_list|,
name|np
operator|->
name|in_ippip
argument_list|,
name|np
operator|->
name|in_ppip
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PRINTF
argument_list|(
literal|" %d:%d"
argument_list|,
name|np
operator|->
name|in_spmin
argument_list|,
name|np
operator|->
name|in_spmax
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_SEQUENTIAL
condition|)
name|PRINTF
argument_list|(
literal|" sequential"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_FRAG
condition|)
name|PRINTF
argument_list|(
literal|" frag"
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_age
index|[
literal|0
index|]
operator|!=
literal|0
operator|||
name|np
operator|->
name|in_age
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|" age %d/%d"
argument_list|,
name|np
operator|->
name|in_age
index|[
literal|0
index|]
argument_list|,
name|np
operator|->
name|in_age
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|np
operator|->
name|in_mssclamp
operator|!=
literal|0
condition|)
name|PRINTF
argument_list|(
literal|" mssclamp %d"
argument_list|,
name|np
operator|->
name|in_mssclamp
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|in_tag
operator|.
name|ipt_tag
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|PRINTF
argument_list|(
literal|" tag %s"
argument_list|,
name|np
operator|->
name|in_tag
operator|.
name|ipt_tag
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|protoprinted
operator|&&
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_TCPUDP
operator|||
name|proto
operator|)
condition|)
block|{
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|printproto
argument_list|(
name|pr
argument_list|,
name|proto
argument_list|,
name|np
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|np
operator|->
name|in_flags
operator|&
name|IPN_PURGE
operator|)
operator|!=
literal|0
condition|)
name|PRINTF
argument_list|(
literal|" purge"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
block|{
name|PRINTF
argument_list|(
literal|"\tnextip "
argument_list|)
expr_stmt|;
name|printip
argument_list|(
name|family
argument_list|,
operator|&
name|np
operator|->
name|in_snip
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" pnext %d\n"
argument_list|,
name|np
operator|->
name|in_spnext
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|opts
operator|&
name|OPT_DEBUG
condition|)
block|{
name|PRINTF
argument_list|(
literal|"\tspace %lu use %u hits %lu flags %#x proto %d/%d"
argument_list|,
name|np
operator|->
name|in_space
argument_list|,
name|np
operator|->
name|in_use
argument_list|,
name|np
operator|->
name|in_hits
argument_list|,
name|np
operator|->
name|in_flags
argument_list|,
name|np
operator|->
name|in_pr
index|[
literal|0
index|]
argument_list|,
name|np
operator|->
name|in_pr
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" hv %u/%u\n"
argument_list|,
name|np
operator|->
name|in_hv
index|[
literal|0
index|]
argument_list|,
name|np
operator|->
name|in_hv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\tifp[0] %p ifp[1] %p apr %p\n"
argument_list|,
name|np
operator|->
name|in_ifps
index|[
literal|0
index|]
argument_list|,
name|np
operator|->
name|in_ifps
index|[
literal|1
index|]
argument_list|,
name|np
operator|->
name|in_apr
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\ttqehead %p/%p comment %p\n"
argument_list|,
name|np
operator|->
name|in_tqehead
index|[
literal|0
index|]
argument_list|,
name|np
operator|->
name|in_tqehead
index|[
literal|1
index|]
argument_list|,
name|np
operator|->
name|in_comment
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


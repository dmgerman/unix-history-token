begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * (C)opyright 1993, 1994, 1995 by Darren Reed.  *  * This code may be freely distributed as long as it retains this notice  * and is not changed in any way.  The author accepts no responsibility  * for the use of this software.  I hate legaleese, don't you ?  */
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
operator|&&
name|defined
argument_list|(
name|LIBC_SCCS
argument_list|)
end_if

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"%W% %G% (C)1995 Darren Reed"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|solaris
argument_list|)
end_if

begin_define
define|#
directive|define
name|_KERNEL
end_define

begin_define
define|#
directive|define
name|KERNEL
end_define

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_undef
undef|#
directive|undef
name|_KERNEL
end_undef

begin_undef
undef|#
directive|undef
name|KERNEL
end_undef

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_include
include|#
directive|include
file|<sys/user.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<kvm.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|sun
end_ifdef

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/session.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|BSD
operator|>=
literal|199103
end_if

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/filedesc.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_icmp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_pcb.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp_timer.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp_var.h>
end_include

begin_include
include|#
directive|include
file|"ip_compat.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|linux
end_ifdef

begin_include
include|#
directive|include
file|"tcpip.h"
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<netinet/tcpip.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__SVR4
argument_list|)
operator|||
name|defined
argument_list|(
name|__svr4__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/sysmacros.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|PAUSE
parameter_list|()
value|tv.tv_sec = 0; tv.tv_usec = 10000; \ 		  (void) select(0, NULL, NULL, NULL,&tv)
end_define

begin_decl_stmt
specifier|extern
name|int
name|send_ip
argument_list|()
decl_stmt|,
name|send_tcp
argument_list|()
decl_stmt|,
name|send_udp
argument_list|()
decl_stmt|,
name|send_icmp
argument_list|()
decl_stmt|,
name|send_ether
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|initdevice
argument_list|()
decl_stmt|,
name|kmemcpy
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|u_short
name|chksum
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|struct
name|tcpcb
modifier|*
name|find_tcp
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|void
name|ip_test1
parameter_list|(
name|dev
parameter_list|,
name|mtu
parameter_list|,
name|ip
parameter_list|,
name|gwip
parameter_list|,
name|ptest
parameter_list|)
name|char
modifier|*
name|dev
decl_stmt|;
name|int
name|mtu
decl_stmt|;
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|struct
name|in_addr
name|gwip
decl_stmt|;
name|int
name|ptest
decl_stmt|;
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|udphdr_t
modifier|*
name|u
decl_stmt|;
name|int
name|nfd
decl_stmt|,
name|i
decl_stmt|,
name|len
decl_stmt|,
name|id
init|=
name|getpid
argument_list|()
decl_stmt|;
name|ip
operator|->
name|ip_hl
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|ip
operator|->
name|ip_v
operator|=
name|IPVERSION
expr_stmt|;
name|ip
operator|->
name|ip_tos
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_ttl
operator|=
literal|60
expr_stmt|;
name|ip
operator|->
name|ip_p
operator|=
name|IPPROTO_UDP
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|u
operator|=
operator|(
name|udphdr_t
operator|*
operator|)
operator|(
name|ip
operator|+
literal|1
operator|)
expr_stmt|;
name|u
operator|->
name|uh_sport
operator|=
literal|1
expr_stmt|;
name|u
operator|->
name|uh_dport
operator|=
literal|9
expr_stmt|;
name|u
operator|->
name|uh_sum
operator|=
literal|0
expr_stmt|;
name|u
operator|->
name|uh_ulen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|u
argument_list|)
operator|+
literal|4
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|+
name|u
operator|->
name|uh_ulen
expr_stmt|;
name|len
operator|=
name|ip
operator|->
name|ip_len
expr_stmt|;
name|nfd
operator|=
name|initdevice
argument_list|(
name|dev
argument_list|,
name|u
operator|->
name|uh_sport
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_sport
operator|=
name|htons
argument_list|(
name|u
operator|->
name|uh_sport
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_dport
operator|=
name|htons
argument_list|(
name|u
operator|->
name|uh_dport
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_ulen
operator|=
name|htons
argument_list|(
name|u
operator|->
name|uh_ulen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|1
operator|)
condition|)
block|{
comment|/* 		 * Part1: hl< len 		 */
name|ip
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"1.1. sending packets with ip_hl< ip_len\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
operator|(
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|+
name|u
operator|->
name|uh_ulen
operator|)
operator|>>
literal|2
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|ip
operator|->
name|ip_hl
operator|=
name|i
operator|>>
literal|2
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|2
operator|)
condition|)
block|{
comment|/* 		 * Part2: hl> len 		 */
name|ip
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"1.2. sending packets with ip_hl> ip_len\n"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
operator|(
operator|(
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|*
literal|2
operator|+
name|u
operator|->
name|uh_ulen
operator|)
operator|>>
literal|2
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|ip
operator|->
name|ip_hl
operator|=
name|i
operator|>>
literal|2
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|3
operator|)
condition|)
block|{
comment|/* 		 * Part3: v< 4 		 */
name|ip
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"1.3. ip_v< 4\n"
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_hl
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|>>
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|ip
operator|->
name|ip_v
operator|=
name|i
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|4
operator|)
condition|)
block|{
comment|/* 		 * Part4: v> 4 		 */
name|ip
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"1.4. ip_v> 4\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|5
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|ip
operator|->
name|ip_v
operator|=
name|i
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|5
operator|)
condition|)
block|{
comment|/* 		 * Part5: len< packet 		 */
name|ip
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_v
operator|=
name|IPVERSION
expr_stmt|;
name|i
operator|=
name|ip
operator|->
name|ip_len
operator|+
literal|1
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
name|htons
argument_list|(
name|ip
operator|->
name|ip_off
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"1.5.0 ip_len< packet size (size++, long packets)\n"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
operator|(
name|ntohs
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
operator|*
literal|2
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|ip
operator|->
name|ip_id
operator|=
name|htons
argument_list|(
name|id
operator|++
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
name|chksum
argument_list|(
name|ip
argument_list|,
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ether
argument_list|(
name|nfd
argument_list|,
name|ip
argument_list|,
name|i
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"1.5.1 ip_len< packet size (ip_len-, short packets)\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|len
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|ip
operator|->
name|ip_id
operator|=
name|htons
argument_list|(
name|id
operator|++
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
name|chksum
argument_list|(
name|ip
argument_list|,
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ether
argument_list|(
name|nfd
argument_list|,
name|ip
argument_list|,
name|len
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|6
operator|)
condition|)
block|{
comment|/* 		 * Part6: len> packet 		 */
name|ip
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"1.6.0 ip_len> packet size (increase ip_len)\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|len
operator|+
literal|1
init|;
name|i
operator|<
operator|(
name|len
operator|*
literal|2
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|ip
operator|->
name|ip_id
operator|=
name|htons
argument_list|(
name|id
operator|++
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
name|chksum
argument_list|(
name|ip
argument_list|,
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ether
argument_list|(
name|nfd
argument_list|,
name|ip
argument_list|,
name|len
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"1.6.1 ip_len> packet size (size--, short packets)\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|len
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|ip
operator|->
name|ip_id
operator|=
name|htons
argument_list|(
name|id
operator|++
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
name|chksum
argument_list|(
name|ip
argument_list|,
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ether
argument_list|(
name|nfd
argument_list|,
name|ip
argument_list|,
name|i
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|7
operator|)
condition|)
block|{
comment|/* 		 * Part7: 0 length fragment 		 */
name|printf
argument_list|(
literal|"1.7.0 Zero length fragments (ip_off = 0x2000)\n"
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
name|htons
argument_list|(
name|IP_MF
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"1.7.1 Zero length fragments (ip_off = 0x3000)\n"
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
name|htons
argument_list|(
name|IP_MF
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"1.7.2 Zero length fragments (ip_off = 0xa000)\n"
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
name|htons
argument_list|(
literal|0xa000
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"1.7.3 Zero length fragments (ip_off = 0x0100)\n"
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
name|htons
argument_list|(
literal|0x0100
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|8
operator|)
condition|)
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|srand
argument_list|(
name|tv
operator|.
name|tv_sec
operator|^
name|getpid
argument_list|()
operator|^
name|tv
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
comment|/* 		 * Part8.1: 63k packet + 1k fragment at offset 0x1ffe 		 * Mark it as being ICMP (so it doesn't get junked), but 		 * don't bother about the ICMP header, we're not worrying 		 * about that here. 		 */
name|ip
operator|->
name|ip_p
operator|=
name|IPPROTO_ICMP
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
name|IP_MF
expr_stmt|;
name|u
operator|->
name|uh_dport
operator|=
name|htons
argument_list|(
literal|9
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_id
operator|=
name|htons
argument_list|(
name|id
operator|++
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"1.8.1 63k packet + 1k fragment at offset 0x1ffe\n"
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
literal|768
operator|+
literal|20
operator|+
literal|8
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
name|MIN
argument_list|(
literal|768
operator|+
literal|20
argument_list|,
name|mtu
operator|-
literal|68
argument_list|)
expr_stmt|;
name|i
operator|=
literal|512
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
operator|(
literal|63
operator|*
literal|1024
operator|+
literal|768
operator|)
condition|;
name|i
operator|+=
literal|768
control|)
block|{
name|ip
operator|->
name|ip_off
operator|=
name|IP_MF
operator||
operator|(
name|i
operator|>>
literal|3
operator|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|ip
operator|->
name|ip_len
operator|=
literal|896
operator|+
literal|20
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
operator|(
name|i
operator|>>
literal|3
operator|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
comment|/* 		 * Part8.2: 63k packet + 1k fragment at offset 0x1ffe 		 * Mark it as being ICMP (so it doesn't get junked), but 		 * don't bother about the ICMP header, we're not worrying 		 * about that here.  (Lossage here) 		 */
name|ip
operator|->
name|ip_p
operator|=
name|IPPROTO_ICMP
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
name|IP_MF
expr_stmt|;
name|u
operator|->
name|uh_dport
operator|=
name|htons
argument_list|(
literal|9
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_id
operator|=
name|htons
argument_list|(
name|id
operator|++
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"1.8.2 63k packet + 1k fragment at offset 0x1ffe\n"
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
literal|768
operator|+
literal|20
operator|+
literal|8
expr_stmt|;
if|if
condition|(
operator|(
name|rand
argument_list|()
operator|&
literal|0x1f
operator|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"skip 0\n"
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
name|MIN
argument_list|(
literal|768
operator|+
literal|20
argument_list|,
name|mtu
operator|-
literal|68
argument_list|)
expr_stmt|;
name|i
operator|=
literal|512
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
operator|(
literal|63
operator|*
literal|1024
operator|+
literal|768
operator|)
condition|;
name|i
operator|+=
literal|768
control|)
block|{
name|ip
operator|->
name|ip_off
operator|=
name|IP_MF
operator||
operator|(
name|i
operator|>>
literal|3
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|rand
argument_list|()
operator|&
literal|0x1f
operator|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"skip %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|ip
operator|->
name|ip_len
operator|=
literal|896
operator|+
literal|20
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
operator|(
name|i
operator|>>
literal|3
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|rand
argument_list|()
operator|&
literal|0x1f
operator|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"skip\n"
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
comment|/* 		 * Part8.3: 33k packet - test for not dealing with -ve length 		 * Mark it as being ICMP (so it doesn't get junked), but 		 * don't bother about the ICMP header, we're not worrying 		 * about that here. 		 */
name|ip
operator|->
name|ip_p
operator|=
name|IPPROTO_ICMP
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
name|IP_MF
expr_stmt|;
name|u
operator|->
name|uh_dport
operator|=
name|htons
argument_list|(
literal|9
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_id
operator|=
name|htons
argument_list|(
name|id
operator|++
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"1.8.3 33k packet\n"
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
literal|768
operator|+
literal|20
operator|+
literal|8
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
name|MIN
argument_list|(
literal|768
operator|+
literal|20
argument_list|,
name|mtu
operator|-
literal|68
argument_list|)
expr_stmt|;
name|i
operator|=
literal|512
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
operator|(
literal|32
operator|*
literal|1024
operator|+
literal|768
operator|)
condition|;
name|i
operator|+=
literal|768
control|)
block|{
name|ip
operator|->
name|ip_off
operator|=
name|IP_MF
operator||
operator|(
name|i
operator|>>
literal|3
operator|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|ip
operator|->
name|ip_len
operator|=
literal|896
operator|+
literal|20
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
operator|(
name|i
operator|>>
literal|3
operator|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
name|ip
operator|->
name|ip_len
operator|=
name|len
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|9
operator|)
condition|)
block|{
comment|/* 		 * Part9: off& 0x8000 == 0x8000 		 */
name|ip
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
literal|0x8000
expr_stmt|;
name|printf
argument_list|(
literal|"1.9. ip_off& 0x8000 == 0x8000\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|ip
operator|->
name|ip_off
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|10
operator|)
condition|)
block|{
comment|/* 		 * Part10: ttl = 255 		 */
name|ip
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_ttl
operator|=
literal|255
expr_stmt|;
name|printf
argument_list|(
literal|"1.10.0 ip_ttl = 255\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|ip
operator|->
name|ip_ttl
operator|=
literal|128
expr_stmt|;
name|printf
argument_list|(
literal|"1.10.1 ip_ttl = 128\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|ip
operator|->
name|ip_ttl
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"1.10.2 ip_ttl = 0\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|nfd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ip_test2
parameter_list|(
name|dev
parameter_list|,
name|mtu
parameter_list|,
name|ip
parameter_list|,
name|gwip
parameter_list|,
name|ptest
parameter_list|)
name|char
modifier|*
name|dev
decl_stmt|;
name|int
name|mtu
decl_stmt|;
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|struct
name|in_addr
name|gwip
decl_stmt|;
name|int
name|ptest
decl_stmt|;
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|int
name|nfd
decl_stmt|;
name|u_char
modifier|*
name|s
decl_stmt|;
name|s
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|(
name|ip
operator|+
literal|1
operator|)
expr_stmt|;
name|nfd
operator|=
name|initdevice
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_hl
operator|=
literal|6
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
expr_stmt|;
name|s
index|[
name|IPOPT_OPTVAL
index|]
operator|=
name|IPOPT_NOP
expr_stmt|;
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|1
operator|)
condition|)
block|{
comment|/* 		 * Test 1: option length> packet length, 		 *                header length == packet length 		 */
name|s
index|[
name|IPOPT_OPTVAL
index|]
operator|=
name|IPOPT_TS
expr_stmt|;
name|s
index|[
name|IPOPT_OLEN
index|]
operator|=
literal|4
expr_stmt|;
name|s
index|[
name|IPOPT_OFFSET
index|]
operator|=
name|IPOPT_MINOFF
expr_stmt|;
name|ip
operator|->
name|ip_p
operator|=
name|IPPROTO_IP
expr_stmt|;
name|printf
argument_list|(
literal|"2.1 option length> packet length\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|ip
operator|->
name|ip_hl
operator|=
literal|7
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|1
operator|)
condition|)
block|{
comment|/* 		 * Test 2: options have length = 0 		 */
name|printf
argument_list|(
literal|"2.2.1 option length = 0, RR\n"
argument_list|)
expr_stmt|;
name|s
index|[
name|IPOPT_OPTVAL
index|]
operator|=
name|IPOPT_RR
expr_stmt|;
name|s
index|[
name|IPOPT_OLEN
index|]
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"2.2.2 option length = 0, TS\n"
argument_list|)
expr_stmt|;
name|s
index|[
name|IPOPT_OPTVAL
index|]
operator|=
name|IPOPT_TS
expr_stmt|;
name|s
index|[
name|IPOPT_OLEN
index|]
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"2.2.3 option length = 0, SECURITY\n"
argument_list|)
expr_stmt|;
name|s
index|[
name|IPOPT_OPTVAL
index|]
operator|=
name|IPOPT_SECURITY
expr_stmt|;
name|s
index|[
name|IPOPT_OLEN
index|]
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"2.2.4 option length = 0, LSRR\n"
argument_list|)
expr_stmt|;
name|s
index|[
name|IPOPT_OPTVAL
index|]
operator|=
name|IPOPT_LSRR
expr_stmt|;
name|s
index|[
name|IPOPT_OLEN
index|]
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"2.2.5 option length = 0, SATID\n"
argument_list|)
expr_stmt|;
name|s
index|[
name|IPOPT_OPTVAL
index|]
operator|=
name|IPOPT_SATID
expr_stmt|;
name|s
index|[
name|IPOPT_OLEN
index|]
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"2.2.6 option length = 0, SSRR\n"
argument_list|)
expr_stmt|;
name|s
index|[
name|IPOPT_OPTVAL
index|]
operator|=
name|IPOPT_SSRR
expr_stmt|;
name|s
index|[
name|IPOPT_OLEN
index|]
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|nfd
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * test 3 (ICMP)  */
end_comment

begin_function
name|void
name|ip_test3
parameter_list|(
name|dev
parameter_list|,
name|mtu
parameter_list|,
name|ip
parameter_list|,
name|gwip
parameter_list|,
name|ptest
parameter_list|)
name|char
modifier|*
name|dev
decl_stmt|;
name|int
name|mtu
decl_stmt|;
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|struct
name|in_addr
name|gwip
decl_stmt|;
name|int
name|ptest
decl_stmt|;
block|{
specifier|static
name|int
name|ict1
index|[
literal|10
index|]
init|=
block|{
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|13
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|0
block|}
decl_stmt|;
specifier|static
name|int
name|ict2
index|[
literal|8
index|]
init|=
block|{
literal|3
block|,
literal|9
block|,
literal|10
block|,
literal|13
block|,
literal|14
block|,
literal|17
block|,
literal|18
block|,
literal|0
block|}
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|icmp
modifier|*
name|icp
decl_stmt|;
name|int
name|nfd
decl_stmt|,
name|i
decl_stmt|;
name|ip
operator|->
name|ip_hl
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|ip
operator|->
name|ip_v
operator|=
name|IPVERSION
expr_stmt|;
name|ip
operator|->
name|ip_tos
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_ttl
operator|=
literal|60
expr_stmt|;
name|ip
operator|->
name|ip_p
operator|=
name|IPPROTO_ICMP
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|icp
argument_list|)
expr_stmt|;
name|icp
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ip
operator|+
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|nfd
operator|=
name|initdevice
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|1
operator|)
condition|)
block|{
comment|/* 		 * Type 0 - 31, 255, code = 0 		 */
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|icp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|icp
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|icp
operator|->
name|icmp_type
operator|=
name|i
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.1.%d ICMP type %d code 0 (all 0's)\r"
argument_list|,
name|i
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|icp
operator|->
name|icmp_type
operator|=
literal|255
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.1.%d ICMP type %d code 0 (all 0's)\r"
argument_list|,
name|i
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|2
operator|)
condition|)
block|{
comment|/* 		 * Type 3, code = 0 - 31 		 */
name|icp
operator|->
name|icmp_type
operator|=
literal|3
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|icp
operator|->
name|icmp_code
operator|=
name|i
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.2.%d ICMP type 3 code %d (all 0's)\r"
argument_list|,
name|i
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|3
operator|)
condition|)
block|{
comment|/* 		 * Type 4, code = 0,127,128,255 		 */
name|icp
operator|->
name|icmp_type
operator|=
literal|4
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.3.1 ICMP type 4 code 0 (all 0's)\r"
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|127
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.3.2 ICMP type 4 code 127 (all 0's)\r"
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|128
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.3.3 ICMP type 4 code 128 (all 0's)\r"
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|255
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.3.4 ICMP type 4 code 255 (all 0's)\r"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|4
operator|)
condition|)
block|{
comment|/* 		 * Type 5, code = 0,127,128,255 		 */
name|icp
operator|->
name|icmp_type
operator|=
literal|5
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.4.1 ICMP type 5 code 0 (all 0's)\r"
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|127
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.4.2 ICMP type 5 code 127 (all 0's)\r"
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|128
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.4.3 ICMP type 5 code 128 (all 0's)\r"
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|255
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.4.4 ICMP type 5 code 255 (all 0's)\r"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|5
operator|)
condition|)
block|{
comment|/* 		 * Type 8-10;13-18, code - 0,127,128,255 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ict1
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|icp
operator|->
name|icmp_type
operator|=
name|ict1
index|[
name|i
index|]
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.5.%d ICMP type 5 code 0 (all 0's)\r"
argument_list|,
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|127
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.5.%d ICMP type 5 code 127 (all 0's)\r"
argument_list|,
name|i
operator|*
literal|4
operator|+
literal|1
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|128
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.5.%d ICMP type 5 code 128 (all 0's)\r"
argument_list|,
name|i
operator|*
literal|4
operator|+
literal|2
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|255
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.5.%d ICMP type 5 code 255 (all 0's)\r"
argument_list|,
name|i
operator|*
literal|4
operator|+
literal|3
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|6
operator|)
condition|)
block|{
comment|/* 		 * Type 12, code - 0,127,128,129,255 		 */
name|icp
operator|->
name|icmp_type
operator|=
literal|12
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.6.1 ICMP type 12 code 0 (all 0's)\r"
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|127
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.6.2 ICMP type 12 code 127 (all 0's)\r"
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|128
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.6.3 ICMP type 12 code 128 (all 0's)\r"
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|129
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.6.4 ICMP type 12 code 129 (all 0's)\r"
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|255
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.6.5 ICMP type 12 code 255 (all 0's)\r"
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|7
operator|)
condition|)
block|{
comment|/* 		 * Type 3;9-10;13-14;17-18 - shorter packets 		 */
name|ip
operator|->
name|ip_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|icp
argument_list|)
operator|/
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ict2
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|icp
operator|->
name|icmp_type
operator|=
name|ict1
index|[
name|i
index|]
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.5.%d ICMP type %d code 0 (all 0's)\r"
argument_list|,
name|i
operator|*
literal|4
argument_list|,
name|icp
operator|->
name|icmp_type
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|127
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.5.%d ICMP type %d code 127 (all 0's)\r"
argument_list|,
name|i
operator|*
literal|4
operator|+
literal|1
argument_list|,
name|icp
operator|->
name|icmp_type
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|128
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.5.%d ICMP type %d code 128 (all 0's)\r"
argument_list|,
name|i
operator|*
literal|4
operator|+
literal|2
argument_list|,
name|icp
operator|->
name|icmp_type
argument_list|)
expr_stmt|;
name|icp
operator|->
name|icmp_code
operator|=
literal|255
expr_stmt|;
operator|(
name|void
operator|)
name|send_icmp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"3.5.%d ICMP type %d code 127 (all 0's)\r"
argument_list|,
name|i
operator|*
literal|4
operator|+
literal|3
argument_list|,
name|icp
operator|->
name|icmp_type
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Perform test 4 (UDP) */
end_comment

begin_function
name|void
name|ip_test4
parameter_list|(
name|dev
parameter_list|,
name|mtu
parameter_list|,
name|ip
parameter_list|,
name|gwip
parameter_list|,
name|ptest
parameter_list|)
name|char
modifier|*
name|dev
decl_stmt|;
name|int
name|mtu
decl_stmt|;
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|struct
name|in_addr
name|gwip
decl_stmt|;
name|int
name|ptest
decl_stmt|;
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|u
decl_stmt|;
name|int
name|nfd
decl_stmt|,
name|i
decl_stmt|;
name|ip
operator|->
name|ip_hl
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|ip
operator|->
name|ip_v
operator|=
name|IPVERSION
expr_stmt|;
name|ip
operator|->
name|ip_tos
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_ttl
operator|=
literal|60
expr_stmt|;
name|ip
operator|->
name|ip_p
operator|=
name|IPPROTO_UDP
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|u
operator|=
operator|(
name|udphdr_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ip
operator|+
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|u
operator|->
name|uh_sport
operator|=
literal|1
expr_stmt|;
name|u
operator|->
name|uh_dport
operator|=
literal|1
expr_stmt|;
name|u
operator|->
name|uh_ulen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|u
argument_list|)
operator|+
literal|4
expr_stmt|;
name|nfd
operator|=
name|initdevice
argument_list|(
name|dev
argument_list|,
name|u
operator|->
name|uh_sport
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|1
operator|)
condition|)
block|{
comment|/* 		 * Test 1. ulen> packet 		 */
name|u
operator|->
name|uh_ulen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|u
argument_list|)
operator|+
literal|4
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|+
name|u
operator|->
name|uh_ulen
expr_stmt|;
name|printf
argument_list|(
literal|"4.1 UDP uh_ulen> packet size - short packets\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|u
operator|->
name|uh_ulen
operator|*
literal|2
init|;
name|i
operator|>
sizeof|sizeof
argument_list|(
operator|*
name|u
argument_list|)
operator|+
literal|4
condition|;
name|i
operator|--
control|)
block|{
name|u
operator|->
name|uh_ulen
operator|=
name|i
expr_stmt|;
operator|(
name|void
operator|)
name|send_udp
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|2
operator|)
condition|)
block|{
comment|/* 		 * Test 2. ulen< packet 		 */
name|u
operator|->
name|uh_ulen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|u
argument_list|)
operator|+
literal|4
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|+
name|u
operator|->
name|uh_ulen
expr_stmt|;
name|printf
argument_list|(
literal|"4.2 UDP uh_ulen< packet size - short packets\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|u
operator|->
name|uh_ulen
operator|*
literal|2
init|;
name|i
operator|>
sizeof|sizeof
argument_list|(
operator|*
name|u
argument_list|)
operator|+
literal|4
condition|;
name|i
operator|--
control|)
block|{
name|ip
operator|->
name|ip_len
operator|=
name|i
expr_stmt|;
operator|(
name|void
operator|)
name|send_udp
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|3
operator|)
condition|)
block|{
comment|/* 		 * Test 3: sport = 0, sport = 1, sport = 32767 		 *         sport = 32768, sport = 65535 		 */
name|u
operator|->
name|uh_ulen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|u
argument_list|)
operator|+
literal|4
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|+
name|u
operator|->
name|uh_ulen
expr_stmt|;
name|printf
argument_list|(
literal|"4.3.1 UDP sport = 0\n"
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_sport
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_udp
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"0\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"4.3.2 UDP sport = 1\n"
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_sport
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|send_udp
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"1\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"4.3.3 UDP sport = 32767\n"
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_sport
operator|=
literal|32767
expr_stmt|;
operator|(
name|void
operator|)
name|send_udp
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"32767\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"4.3.4 UDP sport = 32768\n"
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_sport
operator|=
literal|32768
expr_stmt|;
operator|(
name|void
operator|)
name|send_udp
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"32768\n"
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"4.3.5 UDP sport = 65535\n"
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_sport
operator|=
literal|65535
expr_stmt|;
operator|(
name|void
operator|)
name|send_udp
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"65535\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|4
operator|)
condition|)
block|{
comment|/* 		 * Test 4: dport = 0, dport = 1, dport = 32767 		 *         dport = 32768, dport = 65535 		 */
name|u
operator|->
name|uh_ulen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|u
argument_list|)
operator|+
literal|4
expr_stmt|;
name|u
operator|->
name|uh_sport
operator|=
literal|1
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|+
name|u
operator|->
name|uh_ulen
expr_stmt|;
name|printf
argument_list|(
literal|"4.4.1 UDP dport = 0\n"
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_dport
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_udp
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"0\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"4.4.2 UDP dport = 1\n"
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_dport
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|send_udp
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"1\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"4.4.3 UDP dport = 32767\n"
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_dport
operator|=
literal|32767
expr_stmt|;
operator|(
name|void
operator|)
name|send_udp
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"32767\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"4.4.4 UDP dport = 32768\n"
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_dport
operator|=
literal|32768
expr_stmt|;
operator|(
name|void
operator|)
name|send_udp
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"32768\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"4.4.5 UDP dport = 65535\n"
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_dport
operator|=
literal|65535
expr_stmt|;
operator|(
name|void
operator|)
name|send_udp
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"65535\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|4
operator|)
condition|)
block|{
comment|/* 		 * Test 5: sizeof(struct ip)<= MTU<= sizeof(struct udphdr) + 		 * sizeof(struct ip) 		 */
name|printf
argument_list|(
literal|"4.5 UDP 20<= MTU<= 32\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
init|;
name|i
operator|<=
name|u
operator|->
name|uh_ulen
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|send_udp
argument_list|(
name|nfd
argument_list|,
name|i
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Perform test 5 (TCP) */
end_comment

begin_function
name|void
name|ip_test5
parameter_list|(
name|dev
parameter_list|,
name|mtu
parameter_list|,
name|ip
parameter_list|,
name|gwip
parameter_list|,
name|ptest
parameter_list|)
name|char
modifier|*
name|dev
decl_stmt|;
name|int
name|mtu
decl_stmt|;
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|struct
name|in_addr
name|gwip
decl_stmt|;
name|int
name|ptest
decl_stmt|;
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|tcphdr_t
modifier|*
name|t
decl_stmt|;
name|int
name|nfd
decl_stmt|,
name|i
decl_stmt|;
name|t
operator|=
operator|(
name|tcphdr_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ip
operator|+
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|t
operator|->
name|th_x2
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|th_off
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|th_sport
operator|=
literal|1
expr_stmt|;
name|t
operator|->
name|th_dport
operator|=
literal|1
expr_stmt|;
name|t
operator|->
name|th_win
operator|=
literal|4096
expr_stmt|;
name|t
operator|->
name|th_urp
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|th_sum
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|th_seq
operator|=
literal|1
expr_stmt|;
name|t
operator|->
name|th_ack
operator|=
literal|0
expr_stmt|;
name|nfd
operator|=
name|initdevice
argument_list|(
name|dev
argument_list|,
name|t
operator|->
name|th_sport
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|1
operator|)
condition|)
block|{
comment|/* 		 * Test 1: flags variations, 0 - 3f 		 */
name|t
operator|->
name|th_off
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|t
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|printf
argument_list|(
literal|"5.1 Test TCP flag combinations\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
operator|(
name|TH_URG
operator||
name|TH_ACK
operator||
name|TH_PUSH
operator||
name|TH_RST
operator||
name|TH_SYN
operator||
name|TH_FIN
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|t
operator|->
name|th_flags
operator|=
name|i
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|2
operator|)
condition|)
block|{
name|t
operator|->
name|th_flags
operator|=
name|TH_SYN
expr_stmt|;
comment|/* 		 * Test 2: seq = 0, seq = 1, seq = 0x7fffffff, seq=0x80000000, 		 *         seq = 0xa000000, seq = 0xffffffff 		 */
name|printf
argument_list|(
literal|"5.2.1 TCP seq = 0\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_seq
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.2.2 TCP seq = 1\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_seq
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.2.3 TCP seq = 0x7fffffff\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_seq
operator|=
literal|0x7fffffff
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.2.4 TCP seq = 0x80000000\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_seq
operator|=
literal|0x80000000
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.2.5 TCP seq = 0xc0000000\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_seq
operator|=
literal|0xc0000000
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.2.6 TCP seq = 0xffffffff\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_seq
operator|=
literal|0xffffffff
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|3
operator|)
condition|)
block|{
name|t
operator|->
name|th_flags
operator|=
name|TH_ACK
expr_stmt|;
comment|/* 		 * Test 3: ack = 0, ack = 1, ack = 0x7fffffff, ack = 0x8000000 		 *         ack = 0xa000000, ack = 0xffffffff 		 */
name|printf
argument_list|(
literal|"5.3.1 TCP ack = 0\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_ack
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.3.2 TCP ack = 1\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_ack
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.3.3 TCP ack = 0x7fffffff\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_ack
operator|=
literal|0x7fffffff
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.3.4 TCP ack = 0x80000000\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_ack
operator|=
literal|0x80000000
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.3.5 TCP ack = 0xc0000000\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_ack
operator|=
literal|0xc0000000
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.3.6 TCP ack = 0xffffffff\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_ack
operator|=
literal|0xffffffff
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|4
operator|)
condition|)
block|{
name|t
operator|->
name|th_flags
operator|=
name|TH_SYN
expr_stmt|;
comment|/* 		 * Test 4: win = 0, win = 32768, win = 65535 		 */
name|printf
argument_list|(
literal|"5.4.1 TCP win = 0\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_seq
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.4.2 TCP win = 32768\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_seq
operator|=
literal|0x7fff
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.4.3 TCP win = 65535\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_win
operator|=
literal|0xffff
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
if|#
directive|if
operator|!
name|defined
argument_list|(
name|linux
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__SVR4
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__svr4__
argument_list|)
block|{
name|struct
name|tcpcb
modifier|*
name|t
decl_stmt|,
name|tcb
decl_stmt|;
name|struct
name|tcpiphdr
name|ti
decl_stmt|;
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|slen
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|sin
argument_list|,
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|63
condition|;
name|i
operator|++
control|)
block|{
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|ip
operator|->
name|ip_dst
operator|.
name|s_addr
expr_stmt|;
name|sin
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|connect
argument_list|(
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin
argument_list|,
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
literal|63
condition|)
block|{
name|printf
argument_list|(
literal|"Couldn't open a TCP socket between ports 1 and 63\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"to host %s for test 5 and 6 - skipping.\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|ip
operator|->
name|ip_dst
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|skip_five_and_six
goto|;
block|}
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ip
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ti
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
argument_list|)
expr_stmt|;
name|ti
operator|.
name|ti_dport
operator|=
name|i
expr_stmt|;
name|slen
operator|=
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|getsockname
argument_list|(
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin
argument_list|,
operator|&
name|slen
argument_list|)
condition|)
name|ti
operator|.
name|ti_sport
operator|=
name|sin
operator|.
name|sin_port
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|t
operator|=
name|find_tcp
argument_list|(
name|fd
argument_list|,
operator|&
name|ti
argument_list|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Can't find PCB\n"
argument_list|)
expr_stmt|;
goto|goto
name|skip_five_and_six
goto|;
block|}
name|kmemcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|tcb
argument_list|,
operator|(
name|void
operator|*
operator|)
name|t
argument_list|,
sizeof|sizeof
argument_list|(
name|tcb
argument_list|)
argument_list|)
expr_stmt|;
name|ti
operator|.
name|ti_win
operator|=
name|tcb
operator|.
name|rcv_adv
expr_stmt|;
name|ti
operator|.
name|ti_seq
operator|=
name|tcb
operator|.
name|snd_nxt
operator|-
literal|1
expr_stmt|;
name|ti
operator|.
name|ti_ack
operator|=
name|tcb
operator|.
name|rcv_nxt
expr_stmt|;
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|5
operator|)
condition|)
block|{
comment|/* 		 * Test 5: urp 		 */
name|printf
argument_list|(
literal|"5.1 TCP Urgent pointer\n"
argument_list|)
expr_stmt|;
name|ti
operator|.
name|ti_urp
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|ti
operator|.
name|ti_urp
operator|=
literal|0x7fff
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|ti
operator|.
name|ti_urp
operator|=
literal|0x8000
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|ti
operator|.
name|ti_urp
operator|=
literal|0xffff
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|6
operator|)
condition|)
block|{
comment|/* 		 * Test 6: data offset, off = 0, off is inside, off is outside 		 */
name|printf
argument_list|(
literal|"6.1 TCP off = 0-15, len = 40\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|ti
operator|.
name|ti_off
operator|=
name|ntohs
argument_list|(
name|i
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
name|skip_five_and_six
label|:
endif|#
directive|endif
name|t
operator|->
name|th_seq
operator|=
literal|1
expr_stmt|;
name|t
operator|->
name|th_ack
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|7
operator|)
condition|)
block|{
name|t
operator|->
name|th_off
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|th_flags
operator|=
name|TH_SYN
expr_stmt|;
comment|/* 		 * Test 7: sport = 0, sport = 1, sport = 32767 		 *         sport = 32768, sport = 65535 		 */
name|printf
argument_list|(
literal|"5.7.1 TCP sport = 0\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_sport
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.7.2 TCP sport = 1\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_sport
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.7.3 TCP sport = 32767\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_sport
operator|=
literal|32767
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.7.4 TCP sport = 32768\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_sport
operator|=
literal|32768
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.7.5 TCP sport = 65535\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_sport
operator|=
literal|65535
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ptest
operator|||
operator|(
name|ptest
operator|==
literal|8
operator|)
condition|)
block|{
name|t
operator|->
name|th_sport
operator|=
literal|1
expr_stmt|;
comment|/* 		 * Test 8: dport = 0, dport = 1, dport = 32767 		 *         dport = 32768, dport = 65535 		 */
name|printf
argument_list|(
literal|"5.8.1 TCP dport = 0\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_dport
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.8.2 TCP dport = 1\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_dport
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.8.3 TCP dport = 32767\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_dport
operator|=
literal|32767
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.8.4 TCP dport = 32768\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_dport
operator|=
literal|32768
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"5.8.5 TCP dport = 65535\n"
argument_list|)
expr_stmt|;
name|t
operator|->
name|th_dport
operator|=
literal|65535
expr_stmt|;
operator|(
name|void
operator|)
name|send_tcp
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
comment|/* TCP options header checking */
comment|/* 0 length options, etc */
block|}
end_function

begin_comment
comment|/* Perform test 6 (exhaust mbuf test) */
end_comment

begin_function
name|void
name|ip_test6
parameter_list|(
name|dev
parameter_list|,
name|mtu
parameter_list|,
name|ip
parameter_list|,
name|gwip
parameter_list|,
name|ptest
parameter_list|)
name|char
modifier|*
name|dev
decl_stmt|;
name|int
name|mtu
decl_stmt|;
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|struct
name|in_addr
name|gwip
decl_stmt|;
name|int
name|ptest
decl_stmt|;
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|udphdr_t
modifier|*
name|u
decl_stmt|;
name|int
name|nfd
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|ip
operator|->
name|ip_v
operator|=
name|IPVERSION
expr_stmt|;
name|ip
operator|->
name|ip_tos
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_ttl
operator|=
literal|60
expr_stmt|;
name|ip
operator|->
name|ip_p
operator|=
name|IPPROTO_UDP
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|u
operator|=
operator|(
name|udphdr_t
operator|*
operator|)
operator|(
name|ip
operator|+
literal|1
operator|)
expr_stmt|;
name|u
operator|->
name|uh_sport
operator|=
literal|1
expr_stmt|;
name|u
operator|->
name|uh_dport
operator|=
literal|9
expr_stmt|;
name|u
operator|->
name|uh_sum
operator|=
literal|0
expr_stmt|;
name|nfd
operator|=
name|initdevice
argument_list|(
name|dev
argument_list|,
name|u
operator|->
name|uh_sport
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_sport
operator|=
name|htons
argument_list|(
name|u
operator|->
name|uh_sport
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_dport
operator|=
name|htons
argument_list|(
name|u
operator|->
name|uh_dport
argument_list|)
expr_stmt|;
name|u
operator|->
name|uh_ulen
operator|=
literal|7168
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|128
condition|;
name|i
operator|++
control|)
block|{
comment|/* 		 * First send the entire packet in 768 byte chunks. 		 */
name|ip
operator|->
name|ip_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|+
literal|768
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|u
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_hl
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
name|IP_MF
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d %d\r"
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
comment|/* 		 * And again using 128 byte chunks. 		 */
name|ip
operator|->
name|ip_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|+
literal|128
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|u
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
name|IP_MF
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d %d\r"
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|768
init|;
name|j
operator|<
literal|3584
condition|;
name|j
operator|+=
literal|768
control|)
block|{
name|ip
operator|->
name|ip_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|+
literal|768
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
name|IP_MF
operator||
operator|(
name|j
operator|>>
literal|3
operator|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d %d\r"
argument_list|,
name|i
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
operator|+
literal|128
expr_stmt|;
for|for
control|(
name|k
operator|=
name|j
operator|-
literal|768
init|;
name|k
operator|<
name|j
condition|;
name|k
operator|+=
literal|128
control|)
block|{
name|ip
operator|->
name|ip_off
operator|=
name|IP_MF
operator||
operator|(
name|k
operator|>>
literal|3
operator|)
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
literal|1500
argument_list|,
name|ip
argument_list|,
name|gwip
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d %d\r"
argument_list|,
name|i
argument_list|,
name|k
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
block|}
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Perform test 7 (random packets) */
end_comment

begin_decl_stmt
specifier|static
name|u_long
name|tbuf
index|[
literal|64
index|]
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|ip_test7
parameter_list|(
name|dev
parameter_list|,
name|mtu
parameter_list|,
name|ip
parameter_list|,
name|gwip
parameter_list|,
name|ptest
parameter_list|)
name|char
modifier|*
name|dev
decl_stmt|;
name|int
name|mtu
decl_stmt|;
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|struct
name|in_addr
name|gwip
decl_stmt|;
name|int
name|ptest
decl_stmt|;
block|{
name|ip_t
modifier|*
name|pip
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|int
name|nfd
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u_char
modifier|*
name|s
decl_stmt|;
name|nfd
operator|=
name|initdevice
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pip
operator|=
operator|(
name|ip_t
operator|*
operator|)
name|tbuf
expr_stmt|;
name|srand
argument_list|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|^
operator|(
name|getpid
argument_list|()
operator|*
name|getppid
argument_list|()
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"7. send 1024 random IP packets.\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|512
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|s
operator|=
operator|(
name|u_char
operator|*
operator|)
name|pip
operator|,
name|j
operator|=
literal|0
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|tbuf
argument_list|)
condition|;
name|j
operator|++
operator|,
name|s
operator|++
control|)
operator|*
name|s
operator|=
operator|(
name|rand
argument_list|()
operator|>>
literal|13
operator|)
operator|&
literal|0xff
expr_stmt|;
name|pip
operator|->
name|ip_v
operator|=
name|IPVERSION
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ip
operator|->
name|ip_dst
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|pip
operator|->
name|ip_len
operator|&=
literal|0xff
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|pip
argument_list|,
name|gwip
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|512
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|s
operator|=
operator|(
name|u_char
operator|*
operator|)
name|pip
operator|,
name|j
operator|=
literal|0
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|tbuf
argument_list|)
condition|;
name|j
operator|++
operator|,
name|s
operator|++
control|)
operator|*
name|s
operator|=
operator|(
name|rand
argument_list|()
operator|>>
literal|13
operator|)
operator|&
literal|0xff
expr_stmt|;
name|pip
operator|->
name|ip_v
operator|=
name|IPVERSION
expr_stmt|;
name|pip
operator|->
name|ip_off
operator|&=
literal|0xc000
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ip
operator|->
name|ip_dst
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|pip
operator|->
name|ip_len
operator|&=
literal|0xff
expr_stmt|;
operator|(
name|void
operator|)
name|send_ip
argument_list|(
name|nfd
argument_list|,
name|mtu
argument_list|,
name|pip
argument_list|,
name|gwip
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\r"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|PAUSE
argument_list|()
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


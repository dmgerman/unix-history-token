begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * auth-cmd.c:  Subversion auth creds cache administration  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_comment
comment|/*** Includes. ***/
end_comment

begin_include
include|#
directive|include
file|<apr_general.h>
end_include

begin_include
include|#
directive|include
file|<apr_getopt.h>
end_include

begin_include
include|#
directive|include
file|<apr_fnmatch.h>
end_include

begin_include
include|#
directive|include
file|<apr_tables.h>
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_opt.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_utf.h"
end_include

begin_include
include|#
directive|include
file|"svn_cmdline.h"
end_include

begin_include
include|#
directive|include
file|"svn_config.h"
end_include

begin_include
include|#
directive|include
file|"svn_auth.h"
end_include

begin_include
include|#
directive|include
file|"svn_sorts.h"
end_include

begin_include
include|#
directive|include
file|"svn_base64.h"
end_include

begin_include
include|#
directive|include
file|"svn_x509.h"
end_include

begin_include
include|#
directive|include
file|"svn_time.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_cmdline_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_token.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_sorts_private.h"
end_include

begin_include
include|#
directive|include
file|"cl.h"
end_include

begin_comment
comment|/* The separator between credentials . */
end_comment

begin_define
define|#
directive|define
name|SEP_STRING
define|\
value|"------------------------------------------------------------------------\n"
end_define

begin_function
specifier|static
name|svn_error_t
modifier|*
name|show_cert_failures
parameter_list|(
specifier|const
name|char
modifier|*
name|failure_string
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|unsigned
name|int
name|failures
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cstring_atoui
argument_list|(
operator|&
name|failures
argument_list|,
name|failure_string
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
operator|==
operator|(
name|failures
operator|&
operator|(
name|SVN_AUTH_SSL_NOTYETVALID
operator||
name|SVN_AUTH_SSL_EXPIRED
operator||
name|SVN_AUTH_SSL_CNMISMATCH
operator||
name|SVN_AUTH_SSL_UNKNOWNCA
operator||
name|SVN_AUTH_SSL_OTHER
operator|)
operator|)
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"Automatic certificate validity check failed "
literal|"because:\n"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|failures
operator|&
name|SVN_AUTH_SSL_NOTYETVALID
condition|)
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"  The certificate is not yet valid.\n"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|failures
operator|&
name|SVN_AUTH_SSL_EXPIRED
condition|)
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"  The certificate has expired.\n"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|failures
operator|&
name|SVN_AUTH_SSL_CNMISMATCH
condition|)
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"  The certificate's Common Name (hostname) "
literal|"does not match the remote hostname.\n"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|failures
operator|&
name|SVN_AUTH_SSL_UNKNOWNCA
condition|)
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"  The certificate issuer is unknown.\n"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|failures
operator|&
name|SVN_AUTH_SSL_OTHER
condition|)
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"  Unknown verification failure.\n"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* decodes from format we store certs in for auth creds and  * turns parsing errors into warnings if PRINT_WARNING is TRUE  * and ignores them otherwise. returns NULL if it couldn't  * parse a cert for any reason. */
end_comment

begin_function
specifier|static
name|svn_x509_certinfo_t
modifier|*
name|parse_certificate
parameter_list|(
specifier|const
name|svn_string_t
modifier|*
name|ascii_cert
parameter_list|,
name|svn_boolean_t
name|print_warning
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_x509_certinfo_t
modifier|*
name|certinfo
decl_stmt|;
specifier|const
name|svn_string_t
modifier|*
name|der_cert
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
comment|/* Convert header-less PEM to DER by undoing base64 encoding. */
name|der_cert
operator|=
name|svn_base64_decode_string
argument_list|(
name|ascii_cert
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_x509_parse_cert
argument_list|(
operator|&
name|certinfo
argument_list|,
name|der_cert
operator|->
name|data
argument_list|,
name|der_cert
operator|->
name|len
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
comment|/* Just display X.509 parsing errors as warnings and continue */
if|if
condition|(
name|print_warning
condition|)
name|svn_handle_warning2
argument_list|(
name|stderr
argument_list|,
name|err
argument_list|,
literal|"svn: "
argument_list|)
expr_stmt|;
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|certinfo
return|;
block|}
end_function

begin_struct
struct|struct
name|walk_credentials_baton_t
block|{
name|int
name|matches
decl_stmt|;
name|svn_boolean_t
name|list
decl_stmt|;
name|svn_boolean_t
name|delete
decl_stmt|;
name|svn_boolean_t
name|show_passwords
decl_stmt|;
name|apr_array_header_t
modifier|*
name|patterns
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|svn_boolean_t
name|match_pattern
parameter_list|(
specifier|const
name|char
modifier|*
name|pattern
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|,
name|svn_boolean_t
name|caseblind
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|p
init|=
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"*%s*"
argument_list|,
name|pattern
argument_list|)
decl_stmt|;
name|int
name|flags
init|=
operator|(
name|caseblind
condition|?
name|APR_FNM_CASE_BLIND
else|:
literal|0
operator|)
decl_stmt|;
return|return
operator|(
name|apr_fnmatch
argument_list|(
name|p
argument_list|,
name|value
argument_list|,
name|flags
argument_list|)
operator|==
name|APR_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_boolean_t
name|match_certificate
parameter_list|(
name|svn_x509_certinfo_t
modifier|*
modifier|*
name|certinfo
parameter_list|,
specifier|const
name|char
modifier|*
name|pattern
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|ascii_cert
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|value
decl_stmt|;
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
specifier|const
name|apr_array_header_t
modifier|*
name|hostnames
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|*
name|certinfo
operator|=
name|parse_certificate
argument_list|(
name|ascii_cert
argument_list|,
name|FALSE
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|certinfo
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
name|value
operator|=
name|svn_x509_certinfo_get_subject
argument_list|(
operator|*
name|certinfo
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|match_pattern
argument_list|(
name|pattern
argument_list|,
name|value
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|)
condition|)
return|return
name|TRUE
return|;
name|value
operator|=
name|svn_x509_certinfo_get_issuer
argument_list|(
operator|*
name|certinfo
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|match_pattern
argument_list|(
name|pattern
argument_list|,
name|value
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|)
condition|)
return|return
name|TRUE
return|;
name|checksum
operator|=
name|svn_x509_certinfo_get_digest
argument_list|(
operator|*
name|certinfo
argument_list|)
expr_stmt|;
name|value
operator|=
name|svn_checksum_to_cstring_display
argument_list|(
name|checksum
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|match_pattern
argument_list|(
name|pattern
argument_list|,
name|value
argument_list|,
name|TRUE
argument_list|,
name|scratch_pool
argument_list|)
condition|)
return|return
name|TRUE
return|;
name|hostnames
operator|=
name|svn_x509_certinfo_get_hostnames
argument_list|(
operator|*
name|certinfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostnames
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hostnames
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|hostname
init|=
name|APR_ARRAY_IDX
argument_list|(
name|hostnames
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|match_pattern
argument_list|(
name|pattern
argument_list|,
name|hostname
argument_list|,
name|TRUE
argument_list|,
name|scratch_pool
argument_list|)
condition|)
return|return
name|TRUE
return|;
block|}
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|match_credential
parameter_list|(
name|svn_boolean_t
modifier|*
name|match
parameter_list|,
name|svn_x509_certinfo_t
modifier|*
modifier|*
name|certinfo
parameter_list|,
specifier|const
name|char
modifier|*
name|cred_kind
parameter_list|,
specifier|const
name|char
modifier|*
name|realmstring
parameter_list|,
name|apr_array_header_t
modifier|*
name|patterns
parameter_list|,
name|apr_array_header_t
modifier|*
name|cred_items
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
operator|*
name|match
operator|=
name|FALSE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|patterns
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|pattern
init|=
name|APR_ARRAY_IDX
argument_list|(
name|patterns
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
name|int
name|j
decl_stmt|;
operator|*
name|match
operator|=
name|match_pattern
argument_list|(
name|pattern
argument_list|,
name|cred_kind
argument_list|,
name|FALSE
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|match
condition|)
operator|*
name|match
operator|=
name|match_pattern
argument_list|(
name|pattern
argument_list|,
name|realmstring
argument_list|,
name|FALSE
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|match
condition|)
block|{
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|cred_items
operator|->
name|nelts
condition|;
name|j
operator|++
control|)
block|{
name|svn_sort__item_t
name|item
decl_stmt|;
specifier|const
name|char
modifier|*
name|key
decl_stmt|;
name|svn_string_t
modifier|*
name|value
decl_stmt|;
name|item
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|cred_items
argument_list|,
name|j
argument_list|,
name|svn_sort__item_t
argument_list|)
expr_stmt|;
name|key
operator|=
name|item
operator|.
name|key
expr_stmt|;
name|value
operator|=
name|item
operator|.
name|value
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|key
argument_list|,
name|SVN_CONFIG_AUTHN_PASSWORD_KEY
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|key
argument_list|,
name|SVN_CONFIG_AUTHN_PASSPHRASE_KEY
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
comment|/* don't match secrets */
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|key
argument_list|,
name|SVN_CONFIG_AUTHN_ASCII_CERT_KEY
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|match
operator|=
name|match_certificate
argument_list|(
name|certinfo
argument_list|,
name|pattern
argument_list|,
name|value
argument_list|,
name|result_pool
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
else|else
operator|*
name|match
operator|=
name|match_pattern
argument_list|(
name|pattern
argument_list|,
name|value
operator|->
name|data
argument_list|,
name|FALSE
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|match
condition|)
break|break;
block|}
block|}
if|if
condition|(
operator|!
operator|*
name|match
condition|)
break|break;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|show_cert
parameter_list|(
name|svn_x509_certinfo_t
modifier|*
name|certinfo
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|pem_cert
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|apr_array_header_t
modifier|*
name|hostnames
decl_stmt|;
if|if
condition|(
name|certinfo
operator|==
name|NULL
condition|)
name|certinfo
operator|=
name|parse_certificate
argument_list|(
name|pem_cert
argument_list|,
name|TRUE
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|certinfo
operator|==
name|NULL
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"Subject: %s\n"
argument_list|)
argument_list|,
name|svn_x509_certinfo_get_subject
argument_list|(
name|certinfo
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"Valid from: %s\n"
argument_list|)
argument_list|,
name|svn_time_to_human_cstring
argument_list|(
name|svn_x509_certinfo_get_valid_from
argument_list|(
name|certinfo
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"Valid until: %s\n"
argument_list|)
argument_list|,
name|svn_time_to_human_cstring
argument_list|(
name|svn_x509_certinfo_get_valid_to
argument_list|(
name|certinfo
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"Issuer: %s\n"
argument_list|)
argument_list|,
name|svn_x509_certinfo_get_issuer
argument_list|(
name|certinfo
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"Fingerprint: %s\n"
argument_list|)
argument_list|,
name|svn_checksum_to_cstring_display
argument_list|(
name|svn_x509_certinfo_get_digest
argument_list|(
name|certinfo
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|hostnames
operator|=
name|svn_x509_certinfo_get_hostnames
argument_list|(
name|certinfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostnames
operator|&&
operator|!
name|apr_is_empty_array
argument_list|(
name|hostnames
argument_list|)
condition|)
block|{
name|int
name|i
decl_stmt|;
name|svn_stringbuf_t
modifier|*
name|buf
init|=
name|svn_stringbuf_create_empty
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hostnames
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
block|{
specifier|const
name|char
modifier|*
name|hostname
init|=
name|APR_ARRAY_IDX
argument_list|(
name|hostnames
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|svn_stringbuf_appendbytes
argument_list|(
name|buf
argument_list|,
literal|", "
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|svn_stringbuf_appendbytes
argument_list|(
name|buf
argument_list|,
name|hostname
argument_list|,
name|strlen
argument_list|(
name|hostname
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"Hostnames: %s\n"
argument_list|)
argument_list|,
name|buf
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|list_credential
parameter_list|(
specifier|const
name|char
modifier|*
name|cred_kind
parameter_list|,
specifier|const
name|char
modifier|*
name|realmstring
parameter_list|,
name|apr_array_header_t
modifier|*
name|cred_items
parameter_list|,
name|svn_boolean_t
name|show_passwords
parameter_list|,
name|svn_x509_certinfo_t
modifier|*
name|certinfo
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|SEP_STRING
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"Credential kind: %s\n"
argument_list|)
argument_list|,
name|cred_kind
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"Authentication realm: %s\n"
argument_list|)
argument_list|,
name|realmstring
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred_items
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|svn_sort__item_t
name|item
decl_stmt|;
specifier|const
name|char
modifier|*
name|key
decl_stmt|;
name|svn_string_t
modifier|*
name|value
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|item
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|cred_items
argument_list|,
name|i
argument_list|,
name|svn_sort__item_t
argument_list|)
expr_stmt|;
name|key
operator|=
name|item
operator|.
name|key
expr_stmt|;
name|value
operator|=
name|item
operator|.
name|value
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|value
operator|->
name|data
argument_list|,
name|realmstring
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
comment|/* realm string was already shown above */
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|key
argument_list|,
name|SVN_CONFIG_AUTHN_PASSWORD_KEY
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|show_passwords
condition|)
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|iterpool
argument_list|,
name|_
argument_list|(
literal|"Password: %s\n"
argument_list|)
argument_list|,
name|value
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|iterpool
argument_list|,
name|_
argument_list|(
literal|"Password: [not shown]\n"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|key
argument_list|,
name|SVN_CONFIG_AUTHN_PASSPHRASE_KEY
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|show_passwords
condition|)
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|iterpool
argument_list|,
name|_
argument_list|(
literal|"Passphrase: %s\n"
argument_list|)
argument_list|,
name|value
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|iterpool
argument_list|,
name|_
argument_list|(
literal|"Passphrase: [not shown]\n"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|key
argument_list|,
name|SVN_CONFIG_AUTHN_PASSTYPE_KEY
argument_list|)
operator|==
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|iterpool
argument_list|,
name|_
argument_list|(
literal|"Password cache: %s\n"
argument_list|)
argument_list|,
name|value
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|key
argument_list|,
name|SVN_CONFIG_AUTHN_USERNAME_KEY
argument_list|)
operator|==
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|iterpool
argument_list|,
name|_
argument_list|(
literal|"Username: %s\n"
argument_list|)
argument_list|,
name|value
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|key
argument_list|,
name|SVN_CONFIG_AUTHN_ASCII_CERT_KEY
argument_list|)
operator|==
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|show_cert
argument_list|(
name|certinfo
argument_list|,
name|value
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|key
argument_list|,
name|SVN_CONFIG_AUTHN_FAILURES_KEY
argument_list|)
operator|==
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|show_cert_failures
argument_list|(
name|value
operator|->
name|data
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|iterpool
argument_list|,
literal|"%s: %s\n"
argument_list|,
name|key
argument_list|,
name|value
operator|->
name|data
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
literal|"\n"
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* This implements `svn_config_auth_walk_func_t` */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|walk_credentials
parameter_list|(
name|svn_boolean_t
modifier|*
name|delete_cred
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|cred_kind
parameter_list|,
specifier|const
name|char
modifier|*
name|realmstring
parameter_list|,
name|apr_hash_t
modifier|*
name|cred_hash
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|walk_credentials_baton_t
modifier|*
name|b
init|=
name|baton
decl_stmt|;
name|apr_array_header_t
modifier|*
name|sorted_cred_items
decl_stmt|;
name|svn_x509_certinfo_t
modifier|*
name|certinfo
init|=
name|NULL
decl_stmt|;
operator|*
name|delete_cred
operator|=
name|FALSE
expr_stmt|;
name|sorted_cred_items
operator|=
name|svn_sort__hash
argument_list|(
name|cred_hash
argument_list|,
name|svn_sort_compare_items_lexically
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|patterns
operator|->
name|nelts
operator|>
literal|0
condition|)
block|{
name|svn_boolean_t
name|match
decl_stmt|;
name|SVN_ERR
argument_list|(
name|match_credential
argument_list|(
operator|&
name|match
argument_list|,
operator|&
name|certinfo
argument_list|,
name|cred_kind
argument_list|,
name|realmstring
argument_list|,
name|b
operator|->
name|patterns
argument_list|,
name|sorted_cred_items
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|match
condition|)
return|return
name|SVN_NO_ERROR
return|;
block|}
name|b
operator|->
name|matches
operator|++
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|list
condition|)
name|SVN_ERR
argument_list|(
name|list_credential
argument_list|(
name|cred_kind
argument_list|,
name|realmstring
argument_list|,
name|sorted_cred_items
argument_list|,
name|b
operator|->
name|show_passwords
argument_list|,
name|certinfo
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|delete
condition|)
block|{
operator|*
name|delete_cred
operator|=
name|TRUE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"Deleting %s credential for realm '%s'\n"
argument_list|)
argument_list|,
name|cred_kind
argument_list|,
name|realmstring
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* This implements `svn_opt_subcommand_t'. */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_cl__auth
parameter_list|(
name|apr_getopt_t
modifier|*
name|os
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_cl__opt_state_t
modifier|*
name|opt_state
init|=
operator|(
operator|(
name|svn_cl__cmd_baton_t
operator|*
operator|)
name|baton
operator|)
operator|->
name|opt_state
decl_stmt|;
specifier|const
name|char
modifier|*
name|config_path
decl_stmt|;
name|struct
name|walk_credentials_baton_t
name|b
decl_stmt|;
name|b
operator|.
name|matches
operator|=
literal|0
expr_stmt|;
name|b
operator|.
name|show_passwords
operator|=
name|opt_state
operator|->
name|show_passwords
expr_stmt|;
name|b
operator|.
name|list
operator|=
operator|!
name|opt_state
operator|->
name|remove
expr_stmt|;
name|b
operator|.
name|delete
operator|=
name|opt_state
operator|->
name|remove
expr_stmt|;
name|b
operator|.
name|patterns
operator|=
name|apr_array_make
argument_list|(
name|pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|os
operator|->
name|ind
operator|<
name|os
operator|->
name|argc
condition|;
name|os
operator|->
name|ind
operator|++
control|)
block|{
comment|/* The apr_getopt targets are still in native encoding. */
specifier|const
name|char
modifier|*
name|raw_target
init|=
name|os
operator|->
name|argv
index|[
name|os
operator|->
name|ind
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|utf8_target
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_utf_cstring_to_utf8
argument_list|(
operator|&
name|utf8_target
argument_list|,
name|raw_target
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|b
operator|.
name|patterns
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
operator|=
name|utf8_target
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_config_get_user_config_path
argument_list|(
operator|&
name|config_path
argument_list|,
name|opt_state
operator|->
name|config_dir
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|.
name|delete
operator|&&
name|b
operator|.
name|patterns
operator|->
name|nelts
operator|<
literal|1
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_CL_INSUFFICIENT_ARGS
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_config_walk_auth_data
argument_list|(
name|config_path
argument_list|,
name|walk_credentials
argument_list|,
operator|&
name|b
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|.
name|list
condition|)
block|{
if|if
condition|(
name|b
operator|.
name|matches
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|b
operator|.
name|patterns
operator|->
name|nelts
operator|==
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"Credentials cache in '%s' is empty\n"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|config_path
argument_list|,
name|pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
else|else
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_ILLEGAL_TARGET
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Credentials cache in '%s' contains "
literal|"no matching credentials"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|config_path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|b
operator|.
name|patterns
operator|->
name|nelts
operator|==
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"Credentials cache in '%s' contains %d credentials\n"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|config_path
argument_list|,
name|pool
argument_list|)
argument_list|,
name|b
operator|.
name|matches
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"Credentials cache in '%s' contains %d matching "
literal|"credentials\n"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|config_path
argument_list|,
name|pool
argument_list|)
argument_list|,
name|b
operator|.
name|matches
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|b
operator|.
name|delete
condition|)
block|{
if|if
condition|(
name|b
operator|.
name|matches
operator|==
literal|0
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_ILLEGAL_TARGET
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"Credentials cache in '%s' contains "
literal|"no matching credentials"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|config_path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
else|else
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"Deleted %d matching credentials "
literal|"from '%s'\n"
argument_list|)
argument_list|,
name|b
operator|.
name|matches
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|config_path
argument_list|,
name|pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


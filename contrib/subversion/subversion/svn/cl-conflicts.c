begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * conflicts.c: Tree conflicts.  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|"cl-conflicts.h"
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_xml.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_token.h"
end_include

begin_include
include|#
directive|include
file|"cl.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_comment
comment|/* A map for svn_wc_conflict_action_t values to XML strings */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|svn_token_map_t
name|map_conflict_action_xml
index|[]
init|=
block|{
block|{
literal|"edit"
block|,
name|svn_wc_conflict_action_edit
block|}
block|,
block|{
literal|"delete"
block|,
name|svn_wc_conflict_action_delete
block|}
block|,
block|{
literal|"add"
block|,
name|svn_wc_conflict_action_add
block|}
block|,
block|{
literal|"replace"
block|,
name|svn_wc_conflict_action_replace
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* A map for svn_wc_conflict_reason_t values to XML strings */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|svn_token_map_t
name|map_conflict_reason_xml
index|[]
init|=
block|{
block|{
literal|"edit"
block|,
name|svn_wc_conflict_reason_edited
block|}
block|,
block|{
literal|"delete"
block|,
name|svn_wc_conflict_reason_deleted
block|}
block|,
block|{
literal|"missing"
block|,
name|svn_wc_conflict_reason_missing
block|}
block|,
block|{
literal|"obstruction"
block|,
name|svn_wc_conflict_reason_obstructed
block|}
block|,
block|{
literal|"add"
block|,
name|svn_wc_conflict_reason_added
block|}
block|,
block|{
literal|"replace"
block|,
name|svn_wc_conflict_reason_replaced
block|}
block|,
block|{
literal|"unversioned"
block|,
name|svn_wc_conflict_reason_unversioned
block|}
block|,
block|{
literal|"moved-away"
block|,
name|svn_wc_conflict_reason_moved_away
block|}
block|,
block|{
literal|"moved-here"
block|,
name|svn_wc_conflict_reason_moved_here
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|svn_token_map_t
name|map_conflict_kind_xml
index|[]
init|=
block|{
block|{
literal|"text"
block|,
name|svn_wc_conflict_kind_text
block|}
block|,
block|{
literal|"property"
block|,
name|svn_wc_conflict_kind_property
block|}
block|,
block|{
literal|"tree"
block|,
name|svn_wc_conflict_kind_tree
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Return a localised string representation of the local part of a conflict;    NULL for non-localised odd cases. */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|local_reason_str
parameter_list|(
name|svn_node_kind_t
name|kind
parameter_list|,
name|svn_wc_conflict_reason_t
name|reason
parameter_list|)
block|{
switch|switch
condition|(
name|kind
condition|)
block|{
case|case
name|svn_node_file
case|:
switch|switch
condition|(
name|reason
condition|)
block|{
case|case
name|svn_wc_conflict_reason_edited
case|:
return|return
name|_
argument_list|(
literal|"local file edit"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_obstructed
case|:
return|return
name|_
argument_list|(
literal|"local file obstruction"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_deleted
case|:
return|return
name|_
argument_list|(
literal|"local file delete"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_missing
case|:
return|return
name|_
argument_list|(
literal|"local file missing"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_unversioned
case|:
return|return
name|_
argument_list|(
literal|"local file unversioned"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_added
case|:
return|return
name|_
argument_list|(
literal|"local file add"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_replaced
case|:
return|return
name|_
argument_list|(
literal|"local file replace"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_moved_away
case|:
return|return
name|_
argument_list|(
literal|"local file moved away"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_moved_here
case|:
return|return
name|_
argument_list|(
literal|"local file moved here"
argument_list|)
return|;
block|}
break|break;
case|case
name|svn_node_dir
case|:
switch|switch
condition|(
name|reason
condition|)
block|{
case|case
name|svn_wc_conflict_reason_edited
case|:
return|return
name|_
argument_list|(
literal|"local dir edit"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_obstructed
case|:
return|return
name|_
argument_list|(
literal|"local dir obstruction"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_deleted
case|:
return|return
name|_
argument_list|(
literal|"local dir delete"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_missing
case|:
return|return
name|_
argument_list|(
literal|"local dir missing"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_unversioned
case|:
return|return
name|_
argument_list|(
literal|"local dir unversioned"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_added
case|:
return|return
name|_
argument_list|(
literal|"local dir add"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_replaced
case|:
return|return
name|_
argument_list|(
literal|"local dir replace"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_moved_away
case|:
return|return
name|_
argument_list|(
literal|"local dir moved away"
argument_list|)
return|;
case|case
name|svn_wc_conflict_reason_moved_here
case|:
return|return
name|_
argument_list|(
literal|"local dir moved here"
argument_list|)
return|;
block|}
break|break;
case|case
name|svn_node_symlink
case|:
case|case
name|svn_node_none
case|:
case|case
name|svn_node_unknown
case|:
break|break;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* Return a localised string representation of the incoming part of a    conflict; NULL for non-localised odd cases. */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|incoming_action_str
parameter_list|(
name|svn_node_kind_t
name|kind
parameter_list|,
name|svn_wc_conflict_action_t
name|action
parameter_list|)
block|{
switch|switch
condition|(
name|kind
condition|)
block|{
case|case
name|svn_node_file
case|:
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|svn_wc_conflict_action_edit
case|:
return|return
name|_
argument_list|(
literal|"incoming file edit"
argument_list|)
return|;
case|case
name|svn_wc_conflict_action_add
case|:
return|return
name|_
argument_list|(
literal|"incoming file add"
argument_list|)
return|;
case|case
name|svn_wc_conflict_action_delete
case|:
return|return
name|_
argument_list|(
literal|"incoming file delete"
argument_list|)
return|;
case|case
name|svn_wc_conflict_action_replace
case|:
return|return
name|_
argument_list|(
literal|"incoming file replace"
argument_list|)
return|;
block|}
break|break;
case|case
name|svn_node_dir
case|:
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|svn_wc_conflict_action_edit
case|:
return|return
name|_
argument_list|(
literal|"incoming dir edit"
argument_list|)
return|;
case|case
name|svn_wc_conflict_action_add
case|:
return|return
name|_
argument_list|(
literal|"incoming dir add"
argument_list|)
return|;
case|case
name|svn_wc_conflict_action_delete
case|:
return|return
name|_
argument_list|(
literal|"incoming dir delete"
argument_list|)
return|;
case|case
name|svn_wc_conflict_action_replace
case|:
return|return
name|_
argument_list|(
literal|"incoming dir replace"
argument_list|)
return|;
block|}
break|break;
case|case
name|svn_node_symlink
case|:
case|case
name|svn_node_none
case|:
case|case
name|svn_node_unknown
case|:
break|break;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* Return a localised string representation of the operation part of a    conflict. */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|operation_str
parameter_list|(
name|svn_wc_operation_t
name|operation
parameter_list|)
block|{
switch|switch
condition|(
name|operation
condition|)
block|{
case|case
name|svn_wc_operation_update
case|:
return|return
name|_
argument_list|(
literal|"upon update"
argument_list|)
return|;
case|case
name|svn_wc_operation_switch
case|:
return|return
name|_
argument_list|(
literal|"upon switch"
argument_list|)
return|;
case|case
name|svn_wc_operation_merge
case|:
return|return
name|_
argument_list|(
literal|"upon merge"
argument_list|)
return|;
case|case
name|svn_wc_operation_none
case|:
return|return
name|_
argument_list|(
literal|"upon none"
argument_list|)
return|;
block|}
name|SVN_ERR_MALFUNCTION_NO_RETURN
argument_list|()
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_cl__get_human_readable_prop_conflict_description
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|desc
parameter_list|,
specifier|const
name|svn_wc_conflict_description2_t
modifier|*
name|conflict
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|reason_str
decl_stmt|,
modifier|*
name|action_str
decl_stmt|;
comment|/* We provide separately translatable strings for the values that we    * know about, and a fall-back in case any other values occur. */
switch|switch
condition|(
name|conflict
operator|->
name|reason
condition|)
block|{
case|case
name|svn_wc_conflict_reason_edited
case|:
name|reason_str
operator|=
name|_
argument_list|(
literal|"local edit"
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_wc_conflict_reason_added
case|:
name|reason_str
operator|=
name|_
argument_list|(
literal|"local add"
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_wc_conflict_reason_deleted
case|:
name|reason_str
operator|=
name|_
argument_list|(
literal|"local delete"
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_wc_conflict_reason_obstructed
case|:
name|reason_str
operator|=
name|_
argument_list|(
literal|"local obstruction"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|reason_str
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"local %s"
argument_list|)
argument_list|,
name|svn_token__to_word
argument_list|(
name|map_conflict_reason_xml
argument_list|,
name|conflict
operator|->
name|reason
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|conflict
operator|->
name|action
condition|)
block|{
case|case
name|svn_wc_conflict_action_edit
case|:
name|action_str
operator|=
name|_
argument_list|(
literal|"incoming edit"
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_wc_conflict_action_add
case|:
name|action_str
operator|=
name|_
argument_list|(
literal|"incoming add"
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_wc_conflict_action_delete
case|:
name|action_str
operator|=
name|_
argument_list|(
literal|"incoming delete"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|action_str
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"incoming %s"
argument_list|)
argument_list|,
name|svn_token__to_word
argument_list|(
name|map_conflict_action_xml
argument_list|,
name|conflict
operator|->
name|action
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|SVN_ERR_ASSERT
argument_list|(
name|reason_str
operator|&&
name|action_str
argument_list|)
expr_stmt|;
operator|*
name|desc
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"%s, %s %s"
argument_list|)
argument_list|,
name|reason_str
argument_list|,
name|action_str
argument_list|,
name|operation_str
argument_list|(
name|conflict
operator|->
name|operation
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_cl__get_human_readable_tree_conflict_description
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|desc
parameter_list|,
specifier|const
name|svn_wc_conflict_description2_t
modifier|*
name|conflict
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|action
decl_stmt|,
modifier|*
name|reason
decl_stmt|,
modifier|*
name|operation
decl_stmt|;
name|svn_node_kind_t
name|incoming_kind
decl_stmt|;
comment|/* Determine the node kind of the incoming change. */
name|incoming_kind
operator|=
name|svn_node_unknown
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|action
operator|==
name|svn_wc_conflict_action_edit
operator|||
name|conflict
operator|->
name|action
operator|==
name|svn_wc_conflict_action_delete
condition|)
block|{
comment|/* Change is acting on 'src_left' version of the node. */
if|if
condition|(
name|conflict
operator|->
name|src_left_version
condition|)
name|incoming_kind
operator|=
name|conflict
operator|->
name|src_left_version
operator|->
name|node_kind
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|conflict
operator|->
name|action
operator|==
name|svn_wc_conflict_action_add
operator|||
name|conflict
operator|->
name|action
operator|==
name|svn_wc_conflict_action_replace
condition|)
block|{
comment|/* Change is acting on 'src_right' version of the node.        *        * ### For 'replace', the node kind is ambiguous. However, src_left        * ### is NULL for replace, so we must use src_right. */
if|if
condition|(
name|conflict
operator|->
name|src_right_version
condition|)
name|incoming_kind
operator|=
name|conflict
operator|->
name|src_right_version
operator|->
name|node_kind
expr_stmt|;
block|}
name|reason
operator|=
name|local_reason_str
argument_list|(
name|conflict
operator|->
name|node_kind
argument_list|,
name|conflict
operator|->
name|reason
argument_list|)
expr_stmt|;
name|action
operator|=
name|incoming_action_str
argument_list|(
name|incoming_kind
argument_list|,
name|conflict
operator|->
name|action
argument_list|)
expr_stmt|;
name|operation
operator|=
name|operation_str
argument_list|(
name|conflict
operator|->
name|operation
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|operation
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|&&
name|reason
condition|)
block|{
operator|*
name|desc
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"%s, %s %s"
argument_list|)
argument_list|,
name|reason
argument_list|,
name|action
argument_list|,
name|operation
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* A catch-all message for very rare or nominally impossible cases.          It will not be pretty, but is closer to an internal error than          an ordinary user-facing string. */
operator|*
name|desc
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"local: %s %s incoming: %s %s %s"
argument_list|)
argument_list|,
name|svn_node_kind_to_word
argument_list|(
name|conflict
operator|->
name|node_kind
argument_list|)
argument_list|,
name|svn_token__to_word
argument_list|(
name|map_conflict_reason_xml
argument_list|,
name|conflict
operator|->
name|reason
argument_list|)
argument_list|,
name|svn_node_kind_to_word
argument_list|(
name|incoming_kind
argument_list|)
argument_list|,
name|svn_token__to_word
argument_list|(
name|map_conflict_action_xml
argument_list|,
name|conflict
operator|->
name|action
argument_list|)
argument_list|,
name|operation
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Helper for svn_cl__append_tree_conflict_info_xml().  * Appends the attributes of the given VERSION to ATT_HASH.  * SIDE is the content of the version tag's side="..." attribute,  * currently one of "source-left" or "source-right".*/
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|add_conflict_version_xml
parameter_list|(
name|svn_stringbuf_t
modifier|*
modifier|*
name|pstr
parameter_list|,
specifier|const
name|char
modifier|*
name|side
parameter_list|,
specifier|const
name|svn_wc_conflict_version_t
modifier|*
name|version
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|att_hash
init|=
name|apr_hash_make
argument_list|(
name|pool
argument_list|)
decl_stmt|;
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"side"
argument_list|,
name|side
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|->
name|repos_url
condition|)
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"repos-url"
argument_list|,
name|version
operator|->
name|repos_url
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|->
name|path_in_repos
condition|)
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"path-in-repos"
argument_list|,
name|version
operator|->
name|path_in_repos
argument_list|)
expr_stmt|;
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|version
operator|->
name|peg_rev
argument_list|)
condition|)
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"revision"
argument_list|,
name|apr_ltoa
argument_list|(
name|pool
argument_list|,
name|version
operator|->
name|peg_rev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|->
name|node_kind
operator|!=
name|svn_node_unknown
condition|)
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"kind"
argument_list|,
name|svn_cl__node_kind_str_xml
argument_list|(
name|version
operator|->
name|node_kind
argument_list|)
argument_list|)
expr_stmt|;
name|svn_xml_make_open_tag_hash
argument_list|(
name|pstr
argument_list|,
name|pool
argument_list|,
name|svn_xml_self_closing
argument_list|,
literal|"version"
argument_list|,
name|att_hash
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|append_tree_conflict_info_xml
parameter_list|(
name|svn_stringbuf_t
modifier|*
name|str
parameter_list|,
specifier|const
name|svn_wc_conflict_description2_t
modifier|*
name|conflict
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|att_hash
init|=
name|apr_hash_make
argument_list|(
name|pool
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|tmp
decl_stmt|;
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"victim"
argument_list|,
name|svn_dirent_basename
argument_list|(
name|conflict
operator|->
name|local_abspath
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"kind"
argument_list|,
name|svn_cl__node_kind_str_xml
argument_list|(
name|conflict
operator|->
name|node_kind
argument_list|)
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"operation"
argument_list|,
name|svn_cl__operation_str_xml
argument_list|(
name|conflict
operator|->
name|operation
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|svn_token__to_word
argument_list|(
name|map_conflict_action_xml
argument_list|,
name|conflict
operator|->
name|action
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"action"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|svn_token__to_word
argument_list|(
name|map_conflict_reason_xml
argument_list|,
name|conflict
operator|->
name|reason
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"reason"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Open the tree-conflict tag. */
name|svn_xml_make_open_tag_hash
argument_list|(
operator|&
name|str
argument_list|,
name|pool
argument_list|,
name|svn_xml_normal
argument_list|,
literal|"tree-conflict"
argument_list|,
name|att_hash
argument_list|)
expr_stmt|;
comment|/* Add child tags for OLDER_VERSION and THEIR_VERSION. */
if|if
condition|(
name|conflict
operator|->
name|src_left_version
condition|)
name|SVN_ERR
argument_list|(
name|add_conflict_version_xml
argument_list|(
operator|&
name|str
argument_list|,
literal|"source-left"
argument_list|,
name|conflict
operator|->
name|src_left_version
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|src_right_version
condition|)
name|SVN_ERR
argument_list|(
name|add_conflict_version_xml
argument_list|(
operator|&
name|str
argument_list|,
literal|"source-right"
argument_list|,
name|conflict
operator|->
name|src_right_version
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|svn_xml_make_close_tag
argument_list|(
operator|&
name|str
argument_list|,
name|pool
argument_list|,
literal|"tree-conflict"
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_cl__append_conflict_info_xml
parameter_list|(
name|svn_stringbuf_t
modifier|*
name|str
parameter_list|,
specifier|const
name|svn_wc_conflict_description2_t
modifier|*
name|conflict
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|att_hash
decl_stmt|;
specifier|const
name|char
modifier|*
name|kind
decl_stmt|;
if|if
condition|(
name|conflict
operator|->
name|kind
operator|==
name|svn_wc_conflict_kind_tree
condition|)
block|{
comment|/* Uses other element type */
return|return
name|svn_error_trace
argument_list|(
name|append_tree_conflict_info_xml
argument_list|(
name|str
argument_list|,
name|conflict
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
name|att_hash
operator|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"operation"
argument_list|,
name|svn_cl__operation_str_xml
argument_list|(
name|conflict
operator|->
name|operation
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|kind
operator|=
name|svn_token__to_word
argument_list|(
name|map_conflict_kind_xml
argument_list|,
name|conflict
operator|->
name|kind
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"type"
argument_list|,
name|kind
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"operation"
argument_list|,
name|svn_cl__operation_str_xml
argument_list|(
name|conflict
operator|->
name|operation
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* "<conflict>" */
name|svn_xml_make_open_tag_hash
argument_list|(
operator|&
name|str
argument_list|,
name|scratch_pool
argument_list|,
name|svn_xml_normal
argument_list|,
literal|"conflict"
argument_list|,
name|att_hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|src_left_version
condition|)
name|SVN_ERR
argument_list|(
name|add_conflict_version_xml
argument_list|(
operator|&
name|str
argument_list|,
literal|"source-left"
argument_list|,
name|conflict
operator|->
name|src_left_version
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|src_right_version
condition|)
name|SVN_ERR
argument_list|(
name|add_conflict_version_xml
argument_list|(
operator|&
name|str
argument_list|,
literal|"source-right"
argument_list|,
name|conflict
operator|->
name|src_right_version
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|conflict
operator|->
name|kind
condition|)
block|{
case|case
name|svn_wc_conflict_kind_text
case|:
comment|/* "<prev-base-file> xx</prev-base-file>" */
name|svn_cl__xml_tagged_cdata
argument_list|(
operator|&
name|str
argument_list|,
name|scratch_pool
argument_list|,
literal|"prev-base-file"
argument_list|,
name|conflict
operator|->
name|base_abspath
argument_list|)
expr_stmt|;
comment|/* "<prev-wc-file> xx</prev-wc-file>" */
name|svn_cl__xml_tagged_cdata
argument_list|(
operator|&
name|str
argument_list|,
name|scratch_pool
argument_list|,
literal|"prev-wc-file"
argument_list|,
name|conflict
operator|->
name|my_abspath
argument_list|)
expr_stmt|;
comment|/* "<cur-base-file> xx</cur-base-file>" */
name|svn_cl__xml_tagged_cdata
argument_list|(
operator|&
name|str
argument_list|,
name|scratch_pool
argument_list|,
literal|"cur-base-file"
argument_list|,
name|conflict
operator|->
name|their_abspath
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_wc_conflict_kind_property
case|:
comment|/* "<prop-file> xx</prop-file>" */
name|svn_cl__xml_tagged_cdata
argument_list|(
operator|&
name|str
argument_list|,
name|scratch_pool
argument_list|,
literal|"prop-file"
argument_list|,
name|conflict
operator|->
name|their_abspath
argument_list|)
expr_stmt|;
break|break;
default|default:
case|case
name|svn_wc_conflict_kind_tree
case|:
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
comment|/* Handled separately */
break|break;
block|}
comment|/* "</conflict>" */
name|svn_xml_make_close_tag
argument_list|(
operator|&
name|str
argument_list|,
name|scratch_pool
argument_list|,
literal|"conflict"
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


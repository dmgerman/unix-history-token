begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * status.c:  the command-line's portion of the "svn status" command  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_comment
comment|/* ==================================================================== */
end_comment

begin_escape
end_escape

begin_comment
comment|/*** Includes. ***/
end_comment

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_cmdline.h"
end_include

begin_include
include|#
directive|include
file|"svn_wc.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_xml.h"
end_include

begin_include
include|#
directive|include
file|"svn_time.h"
end_include

begin_include
include|#
directive|include
file|"cl.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"cl-conflicts.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_wc_private.h"
end_include

begin_escape
end_escape

begin_comment
comment|/* Return the single character representation of STATUS */
end_comment

begin_function
specifier|static
name|char
name|generate_status_code
parameter_list|(
name|enum
name|svn_wc_status_kind
name|status
parameter_list|)
block|{
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|svn_wc_status_none
case|:
return|return
literal|' '
return|;
case|case
name|svn_wc_status_normal
case|:
return|return
literal|' '
return|;
case|case
name|svn_wc_status_added
case|:
return|return
literal|'A'
return|;
case|case
name|svn_wc_status_missing
case|:
return|return
literal|'!'
return|;
case|case
name|svn_wc_status_incomplete
case|:
return|return
literal|'!'
return|;
case|case
name|svn_wc_status_deleted
case|:
return|return
literal|'D'
return|;
case|case
name|svn_wc_status_replaced
case|:
return|return
literal|'R'
return|;
case|case
name|svn_wc_status_modified
case|:
return|return
literal|'M'
return|;
case|case
name|svn_wc_status_conflicted
case|:
return|return
literal|'C'
return|;
case|case
name|svn_wc_status_obstructed
case|:
return|return
literal|'~'
return|;
case|case
name|svn_wc_status_ignored
case|:
return|return
literal|'I'
return|;
case|case
name|svn_wc_status_external
case|:
return|return
literal|'X'
return|;
case|case
name|svn_wc_status_unversioned
case|:
return|return
literal|'?'
return|;
default|default:
return|return
literal|'?'
return|;
block|}
block|}
end_function

begin_comment
comment|/* Return the combined STATUS as shown in 'svn status' based    on the node status and text status */
end_comment

begin_function
specifier|static
name|enum
name|svn_wc_status_kind
name|combined_status
parameter_list|(
specifier|const
name|svn_client_status_t
modifier|*
name|status
parameter_list|)
block|{
name|enum
name|svn_wc_status_kind
name|new_status
init|=
name|status
operator|->
name|node_status
decl_stmt|;
switch|switch
condition|(
name|status
operator|->
name|node_status
condition|)
block|{
case|case
name|svn_wc_status_conflicted
case|:
if|if
condition|(
operator|!
name|status
operator|->
name|versioned
operator|&&
name|status
operator|->
name|conflicted
condition|)
block|{
comment|/* Report unversioned tree conflict victims as missing: '!' */
name|new_status
operator|=
name|svn_wc_status_missing
expr_stmt|;
break|break;
block|}
comment|/* fall through */
case|case
name|svn_wc_status_modified
case|:
comment|/* This value might be the property status */
name|new_status
operator|=
name|status
operator|->
name|text_status
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
name|new_status
return|;
block|}
end_function

begin_comment
comment|/* Return the combined repository STATUS as shown in 'svn status' based    on the repository node status and repository text status */
end_comment

begin_function
specifier|static
name|enum
name|svn_wc_status_kind
name|combined_repos_status
parameter_list|(
specifier|const
name|svn_client_status_t
modifier|*
name|status
parameter_list|)
block|{
if|if
condition|(
name|status
operator|->
name|repos_node_status
operator|==
name|svn_wc_status_modified
condition|)
return|return
name|status
operator|->
name|repos_text_status
return|;
return|return
name|status
operator|->
name|repos_node_status
return|;
block|}
end_function

begin_comment
comment|/* Return the single character representation of the switched column    status. */
end_comment

begin_function
specifier|static
name|char
name|generate_switch_column_code
parameter_list|(
specifier|const
name|svn_client_status_t
modifier|*
name|status
parameter_list|)
block|{
if|if
condition|(
name|status
operator|->
name|switched
condition|)
return|return
literal|'S'
return|;
elseif|else
if|if
condition|(
name|status
operator|->
name|file_external
condition|)
return|return
literal|'X'
return|;
else|else
return|return
literal|' '
return|;
block|}
end_function

begin_comment
comment|/* Return the detailed string representation of STATUS */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|generate_status_desc
parameter_list|(
name|enum
name|svn_wc_status_kind
name|status
parameter_list|)
block|{
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|svn_wc_status_none
case|:
return|return
literal|"none"
return|;
case|case
name|svn_wc_status_normal
case|:
return|return
literal|"normal"
return|;
case|case
name|svn_wc_status_added
case|:
return|return
literal|"added"
return|;
case|case
name|svn_wc_status_missing
case|:
return|return
literal|"missing"
return|;
case|case
name|svn_wc_status_incomplete
case|:
return|return
literal|"incomplete"
return|;
case|case
name|svn_wc_status_deleted
case|:
return|return
literal|"deleted"
return|;
case|case
name|svn_wc_status_replaced
case|:
return|return
literal|"replaced"
return|;
case|case
name|svn_wc_status_modified
case|:
return|return
literal|"modified"
return|;
case|case
name|svn_wc_status_conflicted
case|:
return|return
literal|"conflicted"
return|;
case|case
name|svn_wc_status_obstructed
case|:
return|return
literal|"obstructed"
return|;
case|case
name|svn_wc_status_ignored
case|:
return|return
literal|"ignored"
return|;
case|case
name|svn_wc_status_external
case|:
return|return
literal|"external"
return|;
case|case
name|svn_wc_status_unversioned
case|:
return|return
literal|"unversioned"
return|;
default|default:
name|SVN_ERR_MALFUNCTION_NO_RETURN
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Make a relative path containing '..' elements as needed.    TARGET_ABSPATH shall be the absolute version of TARGET_PATH.    TARGET_ABSPATH, TARGET_PATH and PATH shall be canonical.     If above conditions are met, a relative path that leads to PATH    from TARGET_PATH is returned, but there is no error checking involved.     The returned path is allocated from RESULT_POOL, all other    allocations are made in SCRATCH_POOL.  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|make_relpath
parameter_list|(
specifier|const
name|char
modifier|*
name|target_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|target_path
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|la
decl_stmt|;
specifier|const
name|char
modifier|*
name|parent_dir_els
init|=
literal|""
decl_stmt|;
specifier|const
name|char
modifier|*
name|abspath
decl_stmt|,
modifier|*
name|relative
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|abspath
argument_list|,
name|path
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
condition|)
block|{
comment|/* We probably got passed some invalid path. */
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|path
argument_list|)
return|;
block|}
name|relative
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|target_abspath
argument_list|,
name|abspath
argument_list|)
expr_stmt|;
if|if
condition|(
name|relative
condition|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|target_path
argument_list|,
name|relative
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
comment|/* An example:    *  relative_to_path = /a/b/c    *  path             = /a/x/y/z    *  result           = ../../x/y/z    *    * Another example (Windows specific):    *  relative_to_path = F:/wc    *  path             = C:/wc    *  result           = C:/wc    */
comment|/* Skip the common ancestor of both paths, here '/a'. */
name|la
operator|=
name|svn_dirent_get_longest_ancestor
argument_list|(
name|target_abspath
argument_list|,
name|abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|la
operator|==
literal|'\0'
condition|)
block|{
comment|/* Nothing in common: E.g. C:/ vs F:/ on Windows */
return|return
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|path
argument_list|)
return|;
block|}
name|relative
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|la
argument_list|,
name|target_abspath
argument_list|)
expr_stmt|;
name|path
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|la
argument_list|,
name|path
argument_list|)
expr_stmt|;
comment|/* In above example, we'd now have:    *  relative_to_path = b/c    *  path             = x/y/z */
comment|/* Count the elements of relative_to_path and prepend as many '..' elements    * to path. */
while|while
condition|(
operator|*
name|relative
condition|)
block|{
name|svn_dirent_split
argument_list|(
operator|&
name|relative
argument_list|,
name|NULL
argument_list|,
name|relative
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|parent_dir_els
operator|=
name|svn_dirent_join
argument_list|(
name|parent_dir_els
argument_list|,
literal|".."
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
return|return
name|svn_dirent_join
argument_list|(
name|parent_dir_els
argument_list|,
name|path
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Print STATUS and PATH in a format determined by DETAILED and    SHOW_LAST_COMMITTED. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|print_status
parameter_list|(
specifier|const
name|char
modifier|*
name|target_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|target_path
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_boolean_t
name|detailed
parameter_list|,
name|svn_boolean_t
name|show_last_committed
parameter_list|,
name|svn_boolean_t
name|repos_locks
parameter_list|,
specifier|const
name|svn_client_status_t
modifier|*
name|status
parameter_list|,
name|unsigned
name|int
modifier|*
name|text_conflicts
parameter_list|,
name|unsigned
name|int
modifier|*
name|prop_conflicts
parameter_list|,
name|unsigned
name|int
modifier|*
name|tree_conflicts
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|enum
name|svn_wc_status_kind
name|node_status
init|=
name|status
operator|->
name|node_status
decl_stmt|;
name|enum
name|svn_wc_status_kind
name|prop_status
init|=
name|status
operator|->
name|prop_status
decl_stmt|;
name|char
name|tree_status_code
init|=
literal|' '
decl_stmt|;
specifier|const
name|char
modifier|*
name|tree_desc_line
init|=
literal|""
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_from_line
init|=
literal|""
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_to_line
init|=
literal|""
decl_stmt|;
name|path
operator|=
name|make_relpath
argument_list|(
name|target_abspath
argument_list|,
name|target_path
argument_list|,
name|path
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
expr_stmt|;
comment|/* For historic reasons svn ignores the property status for added nodes, even      if these nodes were copied and have local property changes.       Note that it doesn't do this on replacements, or children of copies.       ### Our test suite would catch more errors if we reported property          changes on copies. */
if|if
condition|(
name|node_status
operator|==
name|svn_wc_status_added
condition|)
name|prop_status
operator|=
name|svn_wc_status_none
expr_stmt|;
comment|/* To indicate this node is the victim of a tree conflict, we show      'C' in the tree-conflict column, overriding any other status.      We also print a separate line describing the nature of the tree      conflict. */
if|if
condition|(
name|status
operator|->
name|conflicted
condition|)
block|{
specifier|const
name|char
modifier|*
name|desc
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_abspath
init|=
name|status
operator|->
name|local_abspath
decl_stmt|;
name|svn_boolean_t
name|text_conflicted
decl_stmt|;
name|svn_boolean_t
name|prop_conflicted
decl_stmt|;
name|svn_boolean_t
name|tree_conflicted
decl_stmt|;
if|if
condition|(
name|status
operator|->
name|versioned
condition|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|err
operator|=
name|svn_wc_conflicted_p3
argument_list|(
operator|&
name|text_conflicted
argument_list|,
operator|&
name|prop_conflicted
argument_list|,
operator|&
name|tree_conflicted
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_WC_UPGRADE_REQUIRED
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|text_conflicted
operator|=
name|FALSE
expr_stmt|;
name|prop_conflicted
operator|=
name|FALSE
expr_stmt|;
name|tree_conflicted
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|text_conflicted
operator|=
name|FALSE
expr_stmt|;
name|prop_conflicted
operator|=
name|FALSE
expr_stmt|;
name|tree_conflicted
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|tree_conflicted
condition|)
block|{
specifier|const
name|svn_wc_conflict_description2_t
modifier|*
name|tree_conflict
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__get_tree_conflict
argument_list|(
operator|&
name|tree_conflict
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|tree_conflict
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tree_status_code
operator|=
literal|'C'
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cl__get_human_readable_tree_conflict_description
argument_list|(
operator|&
name|desc
argument_list|,
name|tree_conflict
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|tree_desc_line
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"\n>   %s"
argument_list|,
name|desc
argument_list|)
expr_stmt|;
operator|(
operator|*
name|tree_conflicts
operator|)
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|text_conflicted
condition|)
operator|(
operator|*
name|text_conflicts
operator|)
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|prop_conflicted
condition|)
operator|(
operator|*
name|prop_conflicts
operator|)
operator|++
expr_stmt|;
block|}
comment|/* Note that moved-from and moved-to information is only available in STATUS    * for (op-)roots of a move. Those are exactly the nodes we want to show    * move info for in 'svn status'. See also comments in svn_wc_status3_t. */
if|if
condition|(
name|status
operator|->
name|moved_from_abspath
operator|&&
name|status
operator|->
name|moved_to_abspath
operator|&&
name|strcmp
argument_list|(
name|status
operator|->
name|moved_from_abspath
argument_list|,
name|status
operator|->
name|moved_to_abspath
argument_list|)
operator|==
literal|0
condition|)
block|{
specifier|const
name|char
modifier|*
name|relpath
decl_stmt|;
name|relpath
operator|=
name|make_relpath
argument_list|(
name|target_abspath
argument_list|,
name|target_path
argument_list|,
name|status
operator|->
name|moved_from_abspath
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|relpath
operator|=
name|svn_dirent_local_style
argument_list|(
name|relpath
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|moved_from_line
operator|=
name|apr_pstrcat
argument_list|(
name|pool
argument_list|,
literal|"\n> "
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"swapped places with %s"
argument_list|)
argument_list|,
name|relpath
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|->
name|moved_from_abspath
operator|||
name|status
operator|->
name|moved_to_abspath
condition|)
block|{
specifier|const
name|char
modifier|*
name|relpath
decl_stmt|;
if|if
condition|(
name|status
operator|->
name|moved_from_abspath
condition|)
block|{
name|relpath
operator|=
name|make_relpath
argument_list|(
name|target_abspath
argument_list|,
name|target_path
argument_list|,
name|status
operator|->
name|moved_from_abspath
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|relpath
operator|=
name|svn_dirent_local_style
argument_list|(
name|relpath
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|moved_from_line
operator|=
name|apr_pstrcat
argument_list|(
name|pool
argument_list|,
literal|"\n> "
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"moved from %s"
argument_list|)
argument_list|,
name|relpath
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|->
name|moved_to_abspath
condition|)
block|{
name|relpath
operator|=
name|make_relpath
argument_list|(
name|target_abspath
argument_list|,
name|target_path
argument_list|,
name|status
operator|->
name|moved_to_abspath
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|relpath
operator|=
name|svn_dirent_local_style
argument_list|(
name|relpath
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|moved_to_line
operator|=
name|apr_pstrcat
argument_list|(
name|pool
argument_list|,
literal|"\n> "
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"moved to %s"
argument_list|)
argument_list|,
name|relpath
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
name|path
operator|=
name|svn_dirent_local_style
argument_list|(
name|path
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|detailed
condition|)
block|{
name|char
name|ood_status
decl_stmt|,
name|lock_status
decl_stmt|;
specifier|const
name|char
modifier|*
name|working_rev
decl_stmt|;
if|if
condition|(
operator|!
name|status
operator|->
name|versioned
condition|)
name|working_rev
operator|=
literal|""
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|->
name|copied
operator|||
operator|!
name|SVN_IS_VALID_REVNUM
argument_list|(
name|status
operator|->
name|revision
argument_list|)
condition|)
name|working_rev
operator|=
literal|"-"
expr_stmt|;
else|else
name|working_rev
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%ld"
argument_list|,
name|status
operator|->
name|revision
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|repos_node_status
operator|!=
name|svn_wc_status_none
condition|)
name|ood_status
operator|=
literal|'*'
expr_stmt|;
else|else
name|ood_status
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
name|repos_locks
condition|)
block|{
if|if
condition|(
name|status
operator|->
name|repos_lock
condition|)
block|{
if|if
condition|(
name|status
operator|->
name|lock
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|status
operator|->
name|repos_lock
operator|->
name|token
argument_list|,
name|status
operator|->
name|lock
operator|->
name|token
argument_list|)
operator|==
literal|0
condition|)
name|lock_status
operator|=
literal|'K'
expr_stmt|;
else|else
name|lock_status
operator|=
literal|'T'
expr_stmt|;
block|}
else|else
name|lock_status
operator|=
literal|'O'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|->
name|lock
condition|)
name|lock_status
operator|=
literal|'B'
expr_stmt|;
else|else
name|lock_status
operator|=
literal|' '
expr_stmt|;
block|}
else|else
name|lock_status
operator|=
operator|(
name|status
operator|->
name|lock
operator|)
condition|?
literal|'K'
else|:
literal|' '
expr_stmt|;
if|if
condition|(
name|show_last_committed
condition|)
block|{
specifier|const
name|char
modifier|*
name|commit_rev
decl_stmt|;
specifier|const
name|char
modifier|*
name|commit_author
decl_stmt|;
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|status
operator|->
name|changed_rev
argument_list|)
condition|)
name|commit_rev
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%ld"
argument_list|,
name|status
operator|->
name|changed_rev
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|->
name|versioned
condition|)
name|commit_rev
operator|=
literal|" ? "
expr_stmt|;
else|else
name|commit_rev
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|changed_author
condition|)
name|commit_author
operator|=
name|status
operator|->
name|changed_author
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|->
name|versioned
condition|)
name|commit_author
operator|=
literal|" ? "
expr_stmt|;
else|else
name|commit_author
operator|=
literal|""
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|pool
argument_list|,
literal|"%c%c%c%c%c%c%c %c %8s %8s %-12s %s%s%s%s\n"
argument_list|,
name|generate_status_code
argument_list|(
name|combined_status
argument_list|(
name|status
argument_list|)
argument_list|)
argument_list|,
name|generate_status_code
argument_list|(
name|prop_status
argument_list|)
argument_list|,
name|status
operator|->
name|wc_is_locked
condition|?
literal|'L'
else|:
literal|' '
argument_list|,
name|status
operator|->
name|copied
condition|?
literal|'+'
else|:
literal|' '
argument_list|,
name|generate_switch_column_code
argument_list|(
name|status
argument_list|)
argument_list|,
name|lock_status
argument_list|,
name|tree_status_code
argument_list|,
name|ood_status
argument_list|,
name|working_rev
argument_list|,
name|commit_rev
argument_list|,
name|commit_author
argument_list|,
name|path
argument_list|,
name|moved_to_line
argument_list|,
name|moved_from_line
argument_list|,
name|tree_desc_line
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|pool
argument_list|,
literal|"%c%c%c%c%c%c%c %c %8s   %s%s%s%s\n"
argument_list|,
name|generate_status_code
argument_list|(
name|combined_status
argument_list|(
name|status
argument_list|)
argument_list|)
argument_list|,
name|generate_status_code
argument_list|(
name|prop_status
argument_list|)
argument_list|,
name|status
operator|->
name|wc_is_locked
condition|?
literal|'L'
else|:
literal|' '
argument_list|,
name|status
operator|->
name|copied
condition|?
literal|'+'
else|:
literal|' '
argument_list|,
name|generate_switch_column_code
argument_list|(
name|status
argument_list|)
argument_list|,
name|lock_status
argument_list|,
name|tree_status_code
argument_list|,
name|ood_status
argument_list|,
name|working_rev
argument_list|,
name|path
argument_list|,
name|moved_to_line
argument_list|,
name|moved_from_line
argument_list|,
name|tree_desc_line
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|pool
argument_list|,
literal|"%c%c%c%c%c%c%c %s%s%s%s\n"
argument_list|,
name|generate_status_code
argument_list|(
name|combined_status
argument_list|(
name|status
argument_list|)
argument_list|)
argument_list|,
name|generate_status_code
argument_list|(
name|prop_status
argument_list|)
argument_list|,
name|status
operator|->
name|wc_is_locked
condition|?
literal|'L'
else|:
literal|' '
argument_list|,
name|status
operator|->
name|copied
condition|?
literal|'+'
else|:
literal|' '
argument_list|,
name|generate_switch_column_code
argument_list|(
name|status
argument_list|)
argument_list|,
operator|(
operator|(
name|status
operator|->
name|lock
operator|)
condition|?
literal|'K'
else|:
literal|' '
operator|)
argument_list|,
name|tree_status_code
argument_list|,
name|path
argument_list|,
name|moved_to_line
argument_list|,
name|moved_from_line
argument_list|,
name|tree_desc_line
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_cmdline_fflush
argument_list|(
name|stdout
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_cl__print_status_xml
parameter_list|(
specifier|const
name|char
modifier|*
name|target_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|target_path
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|svn_client_status_t
modifier|*
name|status
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_stringbuf_t
modifier|*
name|sb
init|=
name|svn_stringbuf_create_empty
argument_list|(
name|pool
argument_list|)
decl_stmt|;
name|apr_hash_t
modifier|*
name|att_hash
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_abspath
init|=
name|status
operator|->
name|local_abspath
decl_stmt|;
name|svn_boolean_t
name|tree_conflicted
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|status
operator|->
name|node_status
operator|==
name|svn_wc_status_none
operator|&&
name|status
operator|->
name|repos_node_status
operator|==
name|svn_wc_status_none
condition|)
return|return
name|SVN_NO_ERROR
return|;
if|if
condition|(
name|status
operator|->
name|conflicted
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc_conflicted_p3
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tree_conflicted
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|path
operator|=
name|make_relpath
argument_list|(
name|target_abspath
argument_list|,
name|target_path
argument_list|,
name|path
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|svn_xml_make_open_tag
argument_list|(
operator|&
name|sb
argument_list|,
name|pool
argument_list|,
name|svn_xml_normal
argument_list|,
literal|"entry"
argument_list|,
literal|"path"
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|path
argument_list|,
name|pool
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|att_hash
operator|=
name|apr_hash_make
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"item"
argument_list|,
name|generate_status_desc
argument_list|(
name|combined_status
argument_list|(
name|status
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"props"
argument_list|,
name|generate_status_desc
argument_list|(
operator|(
name|status
operator|->
name|node_status
operator|!=
name|svn_wc_status_deleted
operator|)
condition|?
name|status
operator|->
name|prop_status
else|:
name|svn_wc_status_none
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|wc_is_locked
condition|)
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"wc-locked"
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|copied
condition|)
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"copied"
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|switched
condition|)
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"switched"
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|file_external
condition|)
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"file-external"
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|versioned
operator|&&
operator|!
name|status
operator|->
name|copied
condition|)
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"revision"
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%ld"
argument_list|,
name|status
operator|->
name|revision
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tree_conflicted
condition|)
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"tree-conflicted"
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|moved_from_abspath
operator|||
name|status
operator|->
name|moved_to_abspath
condition|)
block|{
specifier|const
name|char
modifier|*
name|relpath
decl_stmt|;
if|if
condition|(
name|status
operator|->
name|moved_from_abspath
condition|)
block|{
name|relpath
operator|=
name|make_relpath
argument_list|(
name|target_abspath
argument_list|,
name|target_path
argument_list|,
name|status
operator|->
name|moved_from_abspath
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|relpath
operator|=
name|svn_dirent_local_style
argument_list|(
name|relpath
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"moved-from"
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|->
name|moved_to_abspath
condition|)
block|{
name|relpath
operator|=
name|make_relpath
argument_list|(
name|target_abspath
argument_list|,
name|target_path
argument_list|,
name|status
operator|->
name|moved_to_abspath
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|relpath
operator|=
name|svn_dirent_local_style
argument_list|(
name|relpath
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|att_hash
argument_list|,
literal|"moved-to"
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
block|}
block|}
name|svn_xml_make_open_tag_hash
argument_list|(
operator|&
name|sb
argument_list|,
name|pool
argument_list|,
name|svn_xml_normal
argument_list|,
literal|"wc-status"
argument_list|,
name|att_hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|status
operator|->
name|changed_rev
argument_list|)
condition|)
block|{
name|svn_cl__print_xml_commit
argument_list|(
operator|&
name|sb
argument_list|,
name|status
operator|->
name|changed_rev
argument_list|,
name|status
operator|->
name|changed_author
argument_list|,
name|svn_time_to_cstring
argument_list|(
name|status
operator|->
name|changed_date
argument_list|,
name|pool
argument_list|)
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|->
name|lock
condition|)
name|svn_cl__print_xml_lock
argument_list|(
operator|&
name|sb
argument_list|,
name|status
operator|->
name|lock
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|svn_xml_make_close_tag
argument_list|(
operator|&
name|sb
argument_list|,
name|pool
argument_list|,
literal|"wc-status"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|repos_node_status
operator|!=
name|svn_wc_status_none
operator|||
name|status
operator|->
name|repos_lock
condition|)
block|{
name|svn_xml_make_open_tag
argument_list|(
operator|&
name|sb
argument_list|,
name|pool
argument_list|,
name|svn_xml_normal
argument_list|,
literal|"repos-status"
argument_list|,
literal|"item"
argument_list|,
name|generate_status_desc
argument_list|(
name|combined_repos_status
argument_list|(
name|status
argument_list|)
argument_list|)
argument_list|,
literal|"props"
argument_list|,
name|generate_status_desc
argument_list|(
name|status
operator|->
name|repos_prop_status
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|repos_lock
condition|)
name|svn_cl__print_xml_lock
argument_list|(
operator|&
name|sb
argument_list|,
name|status
operator|->
name|repos_lock
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|svn_xml_make_close_tag
argument_list|(
operator|&
name|sb
argument_list|,
name|pool
argument_list|,
literal|"repos-status"
argument_list|)
expr_stmt|;
block|}
name|svn_xml_make_close_tag
argument_list|(
operator|&
name|sb
argument_list|,
name|pool
argument_list|,
literal|"entry"
argument_list|)
expr_stmt|;
return|return
name|svn_cl__error_checked_fputs
argument_list|(
name|sb
operator|->
name|data
argument_list|,
name|stdout
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Called by status-cmd.c */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_cl__print_status
parameter_list|(
specifier|const
name|char
modifier|*
name|target_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|target_path
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|svn_client_status_t
modifier|*
name|status
parameter_list|,
name|svn_boolean_t
name|suppress_externals_placeholders
parameter_list|,
name|svn_boolean_t
name|detailed
parameter_list|,
name|svn_boolean_t
name|show_last_committed
parameter_list|,
name|svn_boolean_t
name|skip_unrecognized
parameter_list|,
name|svn_boolean_t
name|repos_locks
parameter_list|,
name|unsigned
name|int
modifier|*
name|text_conflicts
parameter_list|,
name|unsigned
name|int
modifier|*
name|prop_conflicts
parameter_list|,
name|unsigned
name|int
modifier|*
name|tree_conflicts
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
if|if
condition|(
operator|!
name|status
operator|||
operator|(
name|skip_unrecognized
operator|&&
operator|!
operator|(
name|status
operator|->
name|versioned
operator|||
name|status
operator|->
name|conflicted
operator|||
name|status
operator|->
name|node_status
operator|==
name|svn_wc_status_external
operator|)
operator|)
operator|||
operator|(
name|status
operator|->
name|node_status
operator|==
name|svn_wc_status_none
operator|&&
name|status
operator|->
name|repos_node_status
operator|==
name|svn_wc_status_none
operator|)
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* If we're trying not to print boring "X  /path/to/external"      lines..." */
if|if
condition|(
name|suppress_externals_placeholders
condition|)
block|{
comment|/* ... skip regular externals unmodified in the repository. */
if|if
condition|(
operator|(
name|status
operator|->
name|node_status
operator|==
name|svn_wc_status_external
operator|)
operator|&&
operator|(
name|status
operator|->
name|repos_node_status
operator|==
name|svn_wc_status_none
operator|)
operator|&&
operator|(
operator|!
name|status
operator|->
name|conflicted
operator|)
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* ... skip file externals that aren't modified locally or          remotely, changelisted, or locked (in either sense of the          word). */
if|if
condition|(
operator|(
name|status
operator|->
name|file_external
operator|)
operator|&&
operator|(
name|status
operator|->
name|repos_node_status
operator|==
name|svn_wc_status_none
operator|)
operator|&&
operator|(
operator|(
name|status
operator|->
name|node_status
operator|==
name|svn_wc_status_normal
operator|)
operator|||
operator|(
name|status
operator|->
name|node_status
operator|==
name|svn_wc_status_none
operator|)
operator|)
operator|&&
operator|(
operator|(
name|status
operator|->
name|prop_status
operator|==
name|svn_wc_status_normal
operator|)
operator|||
operator|(
name|status
operator|->
name|prop_status
operator|==
name|svn_wc_status_none
operator|)
operator|)
operator|&&
operator|(
operator|!
name|status
operator|->
name|changelist
operator|)
operator|&&
operator|(
operator|!
name|status
operator|->
name|lock
operator|)
operator|&&
operator|(
operator|!
name|status
operator|->
name|wc_is_locked
operator|)
operator|&&
operator|(
operator|!
name|status
operator|->
name|conflicted
operator|)
condition|)
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|print_status
argument_list|(
name|target_abspath
argument_list|,
name|target_path
argument_list|,
name|path
argument_list|,
name|detailed
argument_list|,
name|show_last_committed
argument_list|,
name|repos_locks
argument_list|,
name|status
argument_list|,
name|text_conflicts
argument_list|,
name|prop_conflicts
argument_list|,
name|tree_conflicts
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

end_unit


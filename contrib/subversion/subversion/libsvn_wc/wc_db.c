begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wc_db.c :  manipulating the administrative database  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_define
define|#
directive|define
name|SVN_WC__I_AM_WC_DB
end_define

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<apr_pools.h>
end_include

begin_include
include|#
directive|include
file|<apr_hash.h>
end_include

begin_include
include|#
directive|include
file|"svn_types.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_sorts.h"
end_include

begin_include
include|#
directive|include
file|"svn_wc.h"
end_include

begin_include
include|#
directive|include
file|"svn_checksum.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"wc.h"
end_include

begin_include
include|#
directive|include
file|"wc_db.h"
end_include

begin_include
include|#
directive|include
file|"adm_files.h"
end_include

begin_include
include|#
directive|include
file|"wc-queries.h"
end_include

begin_include
include|#
directive|include
file|"entries.h"
end_include

begin_include
include|#
directive|include
file|"lock.h"
end_include

begin_include
include|#
directive|include
file|"conflicts.h"
end_include

begin_include
include|#
directive|include
file|"wc_db_private.h"
end_include

begin_include
include|#
directive|include
file|"workqueue.h"
end_include

begin_include
include|#
directive|include
file|"token-map.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_sqlite.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_skel.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_wc_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_token.h"
end_include

begin_define
define|#
directive|define
name|NOT_IMPLEMENTED
parameter_list|()
value|SVN__NOT_IMPLEMENTED()
end_define

begin_comment
comment|/*  * Some filename constants.  */
end_comment

begin_define
define|#
directive|define
name|SDB_FILE
value|"wc.db"
end_define

begin_define
define|#
directive|define
name|WCROOT_TEMPDIR_RELPATH
value|"tmp"
end_define

begin_comment
comment|/*  * PARAMETER ASSERTIONS  *  * Every (semi-)public entrypoint in this file has a set of assertions on  * the parameters passed into the function. Since this is a brand new API,  * we want to make sure that everybody calls it properly. The original WC  * code had years to catch stray bugs, but we do not have that luxury in  * the wc-nb rewrite. Any extra assurances that we can find will be  * welcome. The asserts will ensure we have no doubt about the values  * passed into the function.  *  * Some parameters are *not* specifically asserted. Typically, these are  * params that will be used immediately, so something like a NULL value  * will be obvious.  *  * ### near 1.7 release, it would be a Good Thing to review the assertions  * ### and decide if any can be removed or switched to assert() in order  * ### to remove their runtime cost in the production release.  *  *  * DATABASE OPERATIONS  *  * Each function should leave the database in a consistent state. If it  * does *not*, then the implication is some other function needs to be  * called to restore consistency. Subtle requirements like that are hard  * to maintain over a long period of time, so this API will not allow it.  *  *  * STANDARD VARIABLE NAMES  *  * db     working copy database (this module)  * sdb    SQLite database (not to be confused with 'db')  * wc_id  a WCROOT id associated with a node  */
end_comment

begin_define
define|#
directive|define
name|INVALID_REPOS_ID
value|((apr_int64_t) -1)
end_define

begin_define
define|#
directive|define
name|UNKNOWN_WC_ID
value|((apr_int64_t) -1)
end_define

begin_define
define|#
directive|define
name|FORMAT_FROM_SDB
value|(-1)
end_define

begin_comment
comment|/* Check if column number I, a property-skel column, contains a non-empty    set of properties. The empty set of properties is stored as "()", so we    have properties if the size of the column is larger than 2. */
end_comment

begin_define
define|#
directive|define
name|SQLITE_PROPERTIES_AVAILABLE
parameter_list|(
name|stmt
parameter_list|,
name|i
parameter_list|)
define|\
value|(svn_sqlite__column_bytes(stmt, i)> 2)
end_define

begin_function
name|int
name|svn_wc__db_op_depth_for_upgrade
parameter_list|(
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|)
block|{
return|return
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Representation of a new base row for the NODES table */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|insert_base_baton_t
block|{
comment|/* common to all insertions into BASE */
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
name|svn_revnum_t
name|revision
decl_stmt|;
comment|/* Only used when repos_id == INVALID_REPOS_ID */
specifier|const
name|char
modifier|*
name|repos_root_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_uuid
decl_stmt|;
comment|/* common to all "normal" presence insertions */
specifier|const
name|apr_hash_t
modifier|*
name|props
decl_stmt|;
name|svn_revnum_t
name|changed_rev
decl_stmt|;
name|apr_time_t
name|changed_date
decl_stmt|;
specifier|const
name|char
modifier|*
name|changed_author
decl_stmt|;
specifier|const
name|apr_hash_t
modifier|*
name|dav_cache
decl_stmt|;
comment|/* for inserting directories */
specifier|const
name|apr_array_header_t
modifier|*
name|children
decl_stmt|;
name|svn_depth_t
name|depth
decl_stmt|;
comment|/* for inserting files */
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
comment|/* for inserting symlinks */
specifier|const
name|char
modifier|*
name|target
decl_stmt|;
name|svn_boolean_t
name|file_external
decl_stmt|;
comment|/* may need to insert/update ACTUAL to record a conflict  */
specifier|const
name|svn_skel_t
modifier|*
name|conflict
decl_stmt|;
comment|/* may need to insert/update ACTUAL to record new properties */
name|svn_boolean_t
name|update_actual_props
decl_stmt|;
specifier|const
name|apr_hash_t
modifier|*
name|new_actual_props
decl_stmt|;
comment|/* A depth-first ordered array of svn_prop_inherited_item_t *      structures representing the properties inherited by the base      node. */
name|apr_array_header_t
modifier|*
name|iprops
decl_stmt|;
comment|/* maybe we should copy information from a previous record? */
name|svn_boolean_t
name|keep_recorded_info
decl_stmt|;
comment|/* insert a base-deleted working node as well as a base node */
name|svn_boolean_t
name|insert_base_deleted
decl_stmt|;
comment|/* delete the current working nodes above BASE */
name|svn_boolean_t
name|delete_working
decl_stmt|;
comment|/* may have work items to queue in this transaction  */
specifier|const
name|svn_skel_t
modifier|*
name|work_items
decl_stmt|;
block|}
name|insert_base_baton_t
typedef|;
end_typedef

begin_comment
comment|/* Representation of a new working row for the NODES table */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|insert_working_baton_t
block|{
comment|/* common to all insertions into WORKING (including NODE_DATA) */
name|svn_wc__db_status_t
name|presence
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|int
name|op_depth
decl_stmt|;
comment|/* common to all "normal" presence insertions */
specifier|const
name|apr_hash_t
modifier|*
name|props
decl_stmt|;
name|svn_revnum_t
name|changed_rev
decl_stmt|;
name|apr_time_t
name|changed_date
decl_stmt|;
specifier|const
name|char
modifier|*
name|changed_author
decl_stmt|;
name|apr_int64_t
name|original_repos_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|original_repos_relpath
decl_stmt|;
name|svn_revnum_t
name|original_revnum
decl_stmt|;
name|svn_boolean_t
name|moved_here
decl_stmt|;
comment|/* for inserting directories */
specifier|const
name|apr_array_header_t
modifier|*
name|children
decl_stmt|;
name|svn_depth_t
name|depth
decl_stmt|;
comment|/* for inserting (copied/moved-here) files */
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
comment|/* for inserting symlinks */
specifier|const
name|char
modifier|*
name|target
decl_stmt|;
name|svn_boolean_t
name|update_actual_props
decl_stmt|;
specifier|const
name|apr_hash_t
modifier|*
name|new_actual_props
decl_stmt|;
comment|/* may have work items to queue in this transaction  */
specifier|const
name|svn_skel_t
modifier|*
name|work_items
decl_stmt|;
comment|/* may have conflict to install in this transaction */
specifier|const
name|svn_skel_t
modifier|*
name|conflict
decl_stmt|;
comment|/* If the value is> 0 and< op_depth, also insert a not-present      at op-depth NOT_PRESENT_OP_DEPTH, based on this same information */
name|int
name|not_present_op_depth
decl_stmt|;
block|}
name|insert_working_baton_t
typedef|;
end_typedef

begin_comment
comment|/* Representation of a new row for the EXTERNALS table */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|insert_external_baton_t
block|{
comment|/* common to all insertions into EXTERNALS */
name|svn_node_kind_t
name|kind
decl_stmt|;
name|svn_wc__db_status_t
name|presence
decl_stmt|;
comment|/* The repository of the external */
name|apr_int64_t
name|repos_id
decl_stmt|;
comment|/* for file and symlink externals */
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
name|svn_revnum_t
name|revision
decl_stmt|;
comment|/* Only used when repos_id == INVALID_REPOS_ID */
specifier|const
name|char
modifier|*
name|repos_root_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_uuid
decl_stmt|;
comment|/* for file and symlink externals */
specifier|const
name|apr_hash_t
modifier|*
name|props
decl_stmt|;
name|apr_array_header_t
modifier|*
name|iprops
decl_stmt|;
name|svn_revnum_t
name|changed_rev
decl_stmt|;
name|apr_time_t
name|changed_date
decl_stmt|;
specifier|const
name|char
modifier|*
name|changed_author
decl_stmt|;
specifier|const
name|apr_hash_t
modifier|*
name|dav_cache
decl_stmt|;
comment|/* for inserting files */
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
comment|/* for inserting symlinks */
specifier|const
name|char
modifier|*
name|target
decl_stmt|;
specifier|const
name|char
modifier|*
name|record_ancestor_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|recorded_repos_relpath
decl_stmt|;
name|svn_revnum_t
name|recorded_peg_revision
decl_stmt|;
name|svn_revnum_t
name|recorded_revision
decl_stmt|;
comment|/* may need to insert/update ACTUAL to record a conflict  */
specifier|const
name|svn_skel_t
modifier|*
name|conflict
decl_stmt|;
comment|/* may need to insert/update ACTUAL to record new properties */
name|svn_boolean_t
name|update_actual_props
decl_stmt|;
specifier|const
name|apr_hash_t
modifier|*
name|new_actual_props
decl_stmt|;
comment|/* maybe we should copy information from a previous record? */
name|svn_boolean_t
name|keep_recorded_info
decl_stmt|;
comment|/* may have work items to queue in this transaction  */
specifier|const
name|svn_skel_t
modifier|*
name|work_items
decl_stmt|;
block|}
name|insert_external_baton_t
typedef|;
end_typedef

begin_comment
comment|/* Forward declarations  */
end_comment

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|add_work_items
parameter_list|(
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|skel
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|set_actual_props
parameter_list|(
name|apr_int64_t
name|wc_id
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_sqlite__db_t
modifier|*
name|db
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|insert_incomplete_children
parameter_list|(
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
name|apr_int64_t
name|wc_id
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_int64_t
name|repos_id
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|children
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|db_read_pristine_props
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_boolean_t
name|deleted_ok
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|read_info
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
name|svn_revnum_t
modifier|*
name|changed_rev
parameter_list|,
name|apr_time_t
modifier|*
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changed_author
parameter_list|,
name|svn_depth_t
modifier|*
name|depth
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
modifier|*
name|checksum
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|target
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|original_repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|original_repos_id
parameter_list|,
name|svn_revnum_t
modifier|*
name|original_revision
parameter_list|,
name|svn_wc__db_lock_t
modifier|*
modifier|*
name|lock
parameter_list|,
name|svn_filesize_t
modifier|*
name|recorded_size
parameter_list|,
name|apr_time_t
modifier|*
name|recorded_time
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changelist
parameter_list|,
name|svn_boolean_t
modifier|*
name|conflicted
parameter_list|,
name|svn_boolean_t
modifier|*
name|op_root
parameter_list|,
name|svn_boolean_t
modifier|*
name|had_props
parameter_list|,
name|svn_boolean_t
modifier|*
name|props_mod
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_base
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_more_work
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_work
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|scan_addition
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|op_root_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|original_repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|original_repos_id
parameter_list|,
name|svn_revnum_t
modifier|*
name|original_revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|moved_from_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|moved_from_op_root_relpath
parameter_list|,
name|int
modifier|*
name|moved_from_op_depth
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|convert_to_working_status
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|working_status
parameter_list|,
name|svn_wc__db_status_t
name|status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|wclock_owns_lock
parameter_list|(
name|svn_boolean_t
modifier|*
name|own_lock
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_boolean_t
name|exact
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|db_is_switched
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_switched
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Return the absolute path, in local path style, of LOCAL_RELPATH    in WCROOT.  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|path_for_error_message
parameter_list|(
specifier|const
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|local_abspath
init|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|)
decl_stmt|;
return|return
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Return a file size from column SLOT of the SQLITE statement STMT, or    SVN_INVALID_FILESIZE if the column value is NULL.  */
end_comment

begin_function
specifier|static
name|svn_filesize_t
name|get_recorded_size
parameter_list|(
name|svn_sqlite__stmt_t
modifier|*
name|stmt
parameter_list|,
name|int
name|slot
parameter_list|)
block|{
if|if
condition|(
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
name|slot
argument_list|)
condition|)
return|return
name|SVN_INVALID_FILESIZE
return|;
return|return
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
name|slot
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Return a lock info structure constructed from the given columns of the    SQLITE statement STMT, or return NULL if the token column value is null.  */
end_comment

begin_function
specifier|static
name|svn_wc__db_lock_t
modifier|*
name|lock_from_columns
parameter_list|(
name|svn_sqlite__stmt_t
modifier|*
name|stmt
parameter_list|,
name|int
name|col_token
parameter_list|,
name|int
name|col_owner
parameter_list|,
name|int
name|col_comment
parameter_list|,
name|int
name|col_date
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_wc__db_lock_t
modifier|*
name|lock
decl_stmt|;
if|if
condition|(
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
name|col_token
argument_list|)
condition|)
block|{
name|lock
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|lock
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_wc__db_lock_t
argument_list|)
argument_list|)
expr_stmt|;
name|lock
operator|->
name|token
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
name|col_token
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|lock
operator|->
name|owner
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
name|col_owner
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|lock
operator|->
name|comment
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
name|col_comment
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|lock
operator|->
name|date
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
name|col_date
argument_list|)
expr_stmt|;
block|}
return|return
name|lock
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_fetch_repos_info
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_uuid
parameter_list|,
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
name|apr_int64_t
name|repos_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
if|if
condition|(
operator|!
name|repos_root_url
operator|&&
operator|!
name|repos_uuid
condition|)
return|return
name|SVN_NO_ERROR
return|;
if|if
condition|(
name|repos_id
operator|==
name|INVALID_REPOS_ID
condition|)
block|{
if|if
condition|(
name|repos_root_url
condition|)
operator|*
name|repos_root_url
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|repos_uuid
condition|)
operator|*
name|repos_uuid
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_SELECT_REPOSITORY_BY_ID
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"i"
argument_list|,
name|repos_id
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CORRUPT
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"No REPOSITORY table entry for id '%ld'"
argument_list|)
argument_list|,
operator|(
name|long
name|int
operator|)
name|repos_id
argument_list|)
return|;
if|if
condition|(
name|repos_root_url
condition|)
operator|*
name|repos_root_url
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|repos_uuid
condition|)
operator|*
name|repos_uuid
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Set *REPOS_ID, *REVISION and *REPOS_RELPATH from the given columns of the    SQLITE statement STMT, or to NULL/SVN_INVALID_REVNUM if the respective    column value is null.  Any of the output parameters may be NULL if not    required.  */
end_comment

begin_function
specifier|static
name|void
name|repos_location_from_columns
parameter_list|(
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
name|svn_sqlite__stmt_t
modifier|*
name|stmt
parameter_list|,
name|int
name|col_repos_id
parameter_list|,
name|int
name|col_revision
parameter_list|,
name|int
name|col_repos_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
if|if
condition|(
name|repos_id
condition|)
block|{
comment|/* Fetch repository information via REPOS_ID. */
if|if
condition|(
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
name|col_repos_id
argument_list|)
condition|)
operator|*
name|repos_id
operator|=
name|INVALID_REPOS_ID
expr_stmt|;
else|else
operator|*
name|repos_id
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
name|col_repos_id
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|revision
condition|)
block|{
operator|*
name|revision
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
name|col_revision
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|repos_relpath
condition|)
block|{
operator|*
name|repos_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
name|col_repos_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Get the statement given by STMT_IDX, and bind the appropriate wc_id and    local_relpath based upon LOCAL_ABSPATH.  Store it in *STMT, and use    SCRATCH_POOL for temporary allocations.     Note: WC_ID and LOCAL_RELPATH must be arguments 1 and 2 in the statement. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_statement_for_path
parameter_list|(
name|svn_sqlite__stmt_t
modifier|*
modifier|*
name|stmt
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|int
name|stmt_idx
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|stmt_idx
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
operator|*
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* For a given REPOS_ROOT_URL/REPOS_UUID pair, return the existing REPOS_ID    value. If one does not exist, then create a new one. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|create_repos_id
parameter_list|(
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|get_stmt
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|insert_stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|get_stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_SELECT_REPOSITORY
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|get_stmt
argument_list|,
literal|"s"
argument_list|,
name|repos_root_url
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|get_stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
operator|*
name|repos_id
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|get_stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|get_stmt
argument_list|)
argument_list|)
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|get_stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* NOTE: strictly speaking, there is a race condition between the      above query and the insertion below. We're simply going to ignore      that, as it means two processes are *modifying* the working copy      at the same time, *and* new repositores are becoming visible.      This is rare enough, let alone the miniscule chance of hitting      this race condition. Further, simply failing out will leave the      database in a consistent state, and the user can just re-run the      failed operation. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|insert_stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_INSERT_REPOSITORY
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|insert_stmt
argument_list|,
literal|"ss"
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__insert
argument_list|(
name|repos_id
argument_list|,
name|insert_stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Initialize the baton with appropriate "blank" values. This allows the    insertion function to leave certain columns null.  */
end_comment

begin_function
specifier|static
name|void
name|blank_ibb
parameter_list|(
name|insert_base_baton_t
modifier|*
name|pibb
parameter_list|)
block|{
name|memset
argument_list|(
name|pibb
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pibb
argument_list|)
argument_list|)
expr_stmt|;
name|pibb
operator|->
name|revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|pibb
operator|->
name|changed_rev
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|pibb
operator|->
name|depth
operator|=
name|svn_depth_infinity
expr_stmt|;
name|pibb
operator|->
name|repos_id
operator|=
name|INVALID_REPOS_ID
expr_stmt|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_extend_parent_delete
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_node_kind_t
name|kind
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|int
name|parent_op_depth
decl_stmt|;
specifier|const
name|char
modifier|*
name|parent_relpath
init|=
name|svn_relpath_dirname
argument_list|(
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|local_relpath
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_LOWEST_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|parent_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
name|parent_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|int
name|existing_op_depth
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
name|existing_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
operator|||
name|parent_op_depth
operator|<
name|existing_op_depth
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSTALL_WORKING_NODE_FOR_DELETE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdst"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|parent_op_depth
argument_list|,
name|parent_relpath
argument_list|,
name|kind_map
argument_list|,
name|kind
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* This is the reverse of svn_wc__db_extend_parent_delete.     When removing a node if the parent has a higher working node then    the parent node and this node are both deleted or replaced and any    delete over this node must be removed.     This function (like most wcroot functions) assumes that its caller    only uses this function within an sqlite transaction if atomic    behavior is needed.  */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_retract_parent_delete
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|working_depth
decl_stmt|;
name|svn_wc__db_status_t
name|presence
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_to
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_LOWEST_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
name|working_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|presence
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
name|moved_to
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|moved_to
condition|)
block|{
comment|/* Turn the move into a copy to keep the NODES table valid */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CLEAR_MOVED_HERE_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|moved_to
argument_list|,
name|relpath_depth
argument_list|(
name|moved_to
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* This leaves just the moved_to information on the origin,          which we will remove in the next step */
block|}
if|if
condition|(
name|presence
operator|==
name|svn_wc__db_status_base_deleted
condition|)
block|{
comment|/* Nothing left to shadow; remove the base-deleted node */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_NODE
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|moved_to
condition|)
block|{
comment|/* Clear moved to information, as this node is no longer base-deleted */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CLEAR_MOVED_TO_RELPATH
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Nothing to update */
return|return
name|SVN_NO_ERROR
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|working_depth
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__update
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Insert the base row represented by (insert_base_baton_t *) BATON. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|insert_base_node
parameter_list|(
specifier|const
name|insert_base_baton_t
modifier|*
name|pibb
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_int64_t
name|repos_id
init|=
name|pibb
operator|->
name|repos_id
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_filesize_t
name|recorded_size
init|=
name|SVN_INVALID_FILESIZE
decl_stmt|;
name|apr_int64_t
name|recorded_time
decl_stmt|;
name|svn_boolean_t
name|present
decl_stmt|;
comment|/* The directory at the WCROOT has a NULL parent_relpath. Otherwise,      bind the appropriate parent_relpath. */
specifier|const
name|char
modifier|*
name|parent_relpath
init|=
operator|(
operator|*
name|local_relpath
operator|==
literal|'\0'
operator|)
condition|?
name|NULL
else|:
name|svn_relpath_dirname
argument_list|(
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|pibb
operator|->
name|repos_id
operator|==
name|INVALID_REPOS_ID
condition|)
name|SVN_ERR
argument_list|(
name|create_repos_id
argument_list|(
operator|&
name|repos_id
argument_list|,
name|pibb
operator|->
name|repos_root_url
argument_list|,
name|pibb
operator|->
name|repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_id
operator|!=
name|INVALID_REPOS_ID
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|pibb
operator|->
name|repos_relpath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pibb
operator|->
name|keep_recorded_info
condition|)
block|{
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_BASE_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
comment|/* Preserve size and modification time if caller asked us to. */
name|recorded_size
operator|=
name|get_recorded_size
argument_list|(
name|stmt
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|recorded_time
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|12
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|present
operator|=
operator|(
name|pibb
operator|->
name|status
operator|==
name|svn_wc__db_status_normal
operator|||
name|pibb
operator|->
name|status
operator|==
name|svn_wc__db_status_incomplete
operator|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdsisr"
literal|"tstr"
comment|/* 8 - 11 */
literal|"isnnnnns"
argument_list|,
comment|/* 12 - 19 */
name|wcroot
operator|->
name|wc_id
argument_list|,
comment|/* 1 */
name|local_relpath
argument_list|,
comment|/* 2 */
literal|0
argument_list|,
comment|/* op_depth is 0 for base */
name|parent_relpath
argument_list|,
comment|/* 4 */
name|repos_id
argument_list|,
name|pibb
operator|->
name|repos_relpath
argument_list|,
name|pibb
operator|->
name|revision
argument_list|,
name|presence_map
argument_list|,
name|pibb
operator|->
name|status
argument_list|,
comment|/* 8 */
operator|(
name|pibb
operator|->
name|kind
operator|==
name|svn_node_dir
operator|&&
name|present
operator|)
comment|/* 9 */
condition|?
name|svn_token__to_word
argument_list|(
name|depth_map
argument_list|,
name|pibb
operator|->
name|depth
argument_list|)
else|:
name|NULL
argument_list|,
name|kind_map
argument_list|,
name|pibb
operator|->
name|kind
argument_list|,
comment|/* 10 */
name|pibb
operator|->
name|changed_rev
argument_list|,
comment|/* 11 */
name|pibb
operator|->
name|changed_date
argument_list|,
comment|/* 12 */
name|pibb
operator|->
name|changed_author
argument_list|,
comment|/* 13 */
operator|(
name|pibb
operator|->
name|kind
operator|==
name|svn_node_symlink
operator|&&
name|present
operator|)
condition|?
name|pibb
operator|->
name|target
else|:
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 19 */
if|if
condition|(
name|pibb
operator|->
name|kind
operator|==
name|svn_node_file
operator|&&
name|present
condition|)
block|{
if|if
condition|(
operator|!
name|pibb
operator|->
name|checksum
operator|&&
name|pibb
operator|->
name|status
operator|!=
name|svn_wc__db_status_not_present
operator|&&
name|pibb
operator|->
name|status
operator|!=
name|svn_wc__db_status_excluded
operator|&&
name|pibb
operator|->
name|status
operator|!=
name|svn_wc__db_status_server_excluded
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CORRUPT
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The file '%s' has no checksum."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_checksum
argument_list|(
name|stmt
argument_list|,
literal|14
argument_list|,
name|pibb
operator|->
name|checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|recorded_size
operator|!=
name|SVN_INVALID_FILESIZE
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int64
argument_list|(
name|stmt
argument_list|,
literal|16
argument_list|,
name|recorded_size
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int64
argument_list|(
name|stmt
argument_list|,
literal|17
argument_list|,
name|recorded_time
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Set properties.  Must be null if presence not normal or incomplete. */
name|assert
argument_list|(
name|pibb
operator|->
name|status
operator|==
name|svn_wc__db_status_normal
operator|||
name|pibb
operator|->
name|status
operator|==
name|svn_wc__db_status_incomplete
operator|||
name|pibb
operator|->
name|props
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|present
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_properties
argument_list|(
name|stmt
argument_list|,
literal|15
argument_list|,
name|pibb
operator|->
name|props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_iprops
argument_list|(
name|stmt
argument_list|,
literal|23
argument_list|,
name|pibb
operator|->
name|iprops
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pibb
operator|->
name|dav_cache
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_properties
argument_list|(
name|stmt
argument_list|,
literal|18
argument_list|,
name|pibb
operator|->
name|dav_cache
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pibb
operator|->
name|file_external
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int
argument_list|(
name|stmt
argument_list|,
literal|20
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__insert
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pibb
operator|->
name|update_actual_props
condition|)
block|{
comment|/* Cast away const, to allow calling property helpers */
name|apr_hash_t
modifier|*
name|base_props
init|=
operator|(
name|apr_hash_t
operator|*
operator|)
name|pibb
operator|->
name|props
decl_stmt|;
name|apr_hash_t
modifier|*
name|new_actual_props
init|=
operator|(
name|apr_hash_t
operator|*
operator|)
name|pibb
operator|->
name|new_actual_props
decl_stmt|;
if|if
condition|(
name|base_props
operator|!=
name|NULL
operator|&&
name|new_actual_props
operator|!=
name|NULL
operator|&&
operator|(
name|apr_hash_count
argument_list|(
name|base_props
argument_list|)
operator|==
name|apr_hash_count
argument_list|(
name|new_actual_props
argument_list|)
operator|)
condition|)
block|{
name|apr_array_header_t
modifier|*
name|diffs
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_prop_diffs
argument_list|(
operator|&
name|diffs
argument_list|,
name|new_actual_props
argument_list|,
name|base_props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|diffs
operator|->
name|nelts
operator|==
literal|0
condition|)
name|new_actual_props
operator|=
name|NULL
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|set_actual_props
argument_list|(
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|new_actual_props
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pibb
operator|->
name|kind
operator|==
name|svn_node_dir
operator|&&
name|pibb
operator|->
name|children
condition|)
name|SVN_ERR
argument_list|(
name|insert_incomplete_children
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|repos_id
argument_list|,
name|pibb
operator|->
name|repos_relpath
argument_list|,
name|pibb
operator|->
name|revision
argument_list|,
name|pibb
operator|->
name|children
argument_list|,
literal|0
comment|/* BASE */
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* When this is not the root node, check shadowing behavior */
if|if
condition|(
operator|*
name|local_relpath
condition|)
block|{
if|if
condition|(
name|parent_relpath
operator|&&
operator|(
operator|(
name|pibb
operator|->
name|status
operator|==
name|svn_wc__db_status_normal
operator|)
operator|||
operator|(
name|pibb
operator|->
name|status
operator|==
name|svn_wc__db_status_incomplete
operator|)
operator|)
operator|&&
operator|!
name|pibb
operator|->
name|file_external
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_extend_parent_delete
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|pibb
operator|->
name|kind
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pibb
operator|->
name|status
operator|==
name|svn_wc__db_status_not_present
operator|||
name|pibb
operator|->
name|status
operator|==
name|svn_wc__db_status_server_excluded
operator|||
name|pibb
operator|->
name|status
operator|==
name|svn_wc__db_status_excluded
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_retract_parent_delete
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pibb
operator|->
name|delete_working
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pibb
operator|->
name|insert_base_deleted
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_DELETE_FROM_BASE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|pibb
operator|->
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pibb
operator|->
name|conflict
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_mark_conflict_internal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|pibb
operator|->
name|conflict
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Initialize the baton with appropriate "blank" values. This allows the    insertion function to leave certain columns null.  */
end_comment

begin_function
specifier|static
name|void
name|blank_iwb
parameter_list|(
name|insert_working_baton_t
modifier|*
name|piwb
parameter_list|)
block|{
name|memset
argument_list|(
name|piwb
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|piwb
argument_list|)
argument_list|)
expr_stmt|;
name|piwb
operator|->
name|changed_rev
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|piwb
operator|->
name|depth
operator|=
name|svn_depth_infinity
expr_stmt|;
comment|/* ORIGINAL_REPOS_ID and ORIGINAL_REVNUM could use some kind of "nil"      value, but... meh. We'll avoid them if ORIGINAL_REPOS_RELPATH==NULL.  */
block|}
end_function

begin_comment
comment|/* Insert a row in NODES for each (const char *) child name in CHILDREN,    whose parent directory is LOCAL_RELPATH, at op_depth=OP_DEPTH.  Set each    child's presence to 'incomplete', kind to 'unknown', repos_id to REPOS_ID,    repos_path by appending the child name to REPOS_PATH, and revision to    REVISION (which should match the parent's revision).     If REPOS_ID is INVALID_REPOS_ID, set each child's repos_id to null. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|insert_incomplete_children
parameter_list|(
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
name|apr_int64_t
name|wc_id
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_int64_t
name|repos_id
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_path
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|children
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|int
name|i
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|apr_hash_t
modifier|*
name|moved_to_relpaths
init|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_path
operator|!=
name|NULL
operator|||
name|op_depth
operator|>
literal|0
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|(
name|repos_id
operator|!=
name|INVALID_REPOS_ID
operator|)
operator|==
operator|(
name|repos_path
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
comment|/* If we're inserting WORKING nodes, we might be replacing existing    * nodes which were moved-away. We need to retain the moved-to relpath of    * such nodes in order not to lose move information during replace. */
if|if
condition|(
name|op_depth
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
name|children
operator|->
name|nelts
init|;
name|i
operator|--
condition|;
control|)
block|{
specifier|const
name|char
modifier|*
name|name
init|=
name|APR_ARRAY_IDX
argument_list|(
name|children
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_SELECT_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wc_id
argument_list|,
name|svn_relpath_join
argument_list|(
name|local_relpath
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
operator|&&
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|14
argument_list|)
condition|)
name|svn_hash_sets
argument_list|(
name|moved_to_relpaths
argument_list|,
name|name
argument_list|,
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|14
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_INSERT_NODE
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|children
operator|->
name|nelts
init|;
name|i
operator|--
condition|;
control|)
block|{
specifier|const
name|char
modifier|*
name|name
init|=
name|APR_ARRAY_IDX
argument_list|(
name|children
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdsnnrsnsnnnnnnnnnnsn"
argument_list|,
name|wc_id
argument_list|,
name|svn_relpath_join
argument_list|(
name|local_relpath
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
argument_list|,
name|op_depth
argument_list|,
name|local_relpath
argument_list|,
name|revision
argument_list|,
literal|"incomplete"
argument_list|,
comment|/* 8, presence */
literal|"unknown"
argument_list|,
comment|/* 10, kind */
comment|/* 21, moved_to */
name|svn_hash_gets
argument_list|(
name|moved_to_relpaths
argument_list|,
name|name
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|repos_id
operator|!=
name|INVALID_REPOS_ID
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int64
argument_list|(
name|stmt
argument_list|,
literal|5
argument_list|,
name|repos_id
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_text
argument_list|(
name|stmt
argument_list|,
literal|6
argument_list|,
name|svn_relpath_join
argument_list|(
name|repos_path
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__insert
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Insert the working row represented by (insert_working_baton_t *) BATON. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|insert_working_node
parameter_list|(
specifier|const
name|insert_working_baton_t
modifier|*
name|piwb
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|parent_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_to_relpath
init|=
name|NULL
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_boolean_t
name|present
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|piwb
operator|->
name|op_depth
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|/* We cannot insert a WORKING_NODE row at the wcroot.  */
name|SVN_ERR_ASSERT
argument_list|(
operator|*
name|local_relpath
operator|!=
literal|'\0'
argument_list|)
expr_stmt|;
name|parent_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* Preserve existing moved-to information for this relpath,    * which might exist in case we're replacing an existing base-deleted    * node. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_TO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|piwb
operator|->
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
name|moved_to_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|present
operator|=
operator|(
name|piwb
operator|->
name|presence
operator|==
name|svn_wc__db_status_normal
operator|||
name|piwb
operator|->
name|presence
operator|==
name|svn_wc__db_status_incomplete
operator|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdsnnntstrisn"
literal|"nnnn"
comment|/* properties translated_size last_mod_time dav_cache */
literal|"sns"
argument_list|,
comment|/* symlink_target, file_external, moved_to */
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|piwb
operator|->
name|op_depth
argument_list|,
name|parent_relpath
argument_list|,
name|presence_map
argument_list|,
name|piwb
operator|->
name|presence
argument_list|,
operator|(
name|piwb
operator|->
name|kind
operator|==
name|svn_node_dir
operator|&&
name|present
operator|)
condition|?
name|svn_token__to_word
argument_list|(
name|depth_map
argument_list|,
name|piwb
operator|->
name|depth
argument_list|)
else|:
name|NULL
argument_list|,
name|kind_map
argument_list|,
name|piwb
operator|->
name|kind
argument_list|,
name|piwb
operator|->
name|changed_rev
argument_list|,
name|piwb
operator|->
name|changed_date
argument_list|,
name|piwb
operator|->
name|changed_author
argument_list|,
comment|/* Note: incomplete nodes may have a NULL target.  */
operator|(
name|piwb
operator|->
name|kind
operator|==
name|svn_node_symlink
operator|&&
name|present
operator|)
condition|?
name|piwb
operator|->
name|target
else|:
name|NULL
argument_list|,
name|moved_to_relpath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|piwb
operator|->
name|moved_here
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int
argument_list|(
name|stmt
argument_list|,
literal|8
argument_list|,
name|TRUE
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|piwb
operator|->
name|kind
operator|==
name|svn_node_file
operator|&&
name|present
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_checksum
argument_list|(
name|stmt
argument_list|,
literal|14
argument_list|,
name|piwb
operator|->
name|checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|piwb
operator|->
name|original_repos_relpath
operator|!=
name|NULL
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int64
argument_list|(
name|stmt
argument_list|,
literal|5
argument_list|,
name|piwb
operator|->
name|original_repos_id
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_text
argument_list|(
name|stmt
argument_list|,
literal|6
argument_list|,
name|piwb
operator|->
name|original_repos_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_revnum
argument_list|(
name|stmt
argument_list|,
literal|7
argument_list|,
name|piwb
operator|->
name|original_revnum
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Set properties.  Must be null if presence not normal or incomplete. */
name|assert
argument_list|(
name|piwb
operator|->
name|presence
operator|==
name|svn_wc__db_status_normal
operator|||
name|piwb
operator|->
name|presence
operator|==
name|svn_wc__db_status_incomplete
operator|||
name|piwb
operator|->
name|props
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|present
operator|&&
name|piwb
operator|->
name|original_repos_relpath
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_properties
argument_list|(
name|stmt
argument_list|,
literal|15
argument_list|,
name|piwb
operator|->
name|props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__insert
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Insert incomplete children, if specified.      The children are part of the same op and so have the same op_depth.      (The only time we'd want a different depth is during a recursive      simple add, but we never insert children here during a simple add.) */
if|if
condition|(
name|piwb
operator|->
name|kind
operator|==
name|svn_node_dir
operator|&&
name|piwb
operator|->
name|children
condition|)
name|SVN_ERR
argument_list|(
name|insert_incomplete_children
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|INVALID_REPOS_ID
comment|/* inherit repos_id */
argument_list|,
name|NULL
comment|/* inherit repos_path */
argument_list|,
name|piwb
operator|->
name|original_revnum
argument_list|,
name|piwb
operator|->
name|children
argument_list|,
name|piwb
operator|->
name|op_depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|piwb
operator|->
name|update_actual_props
condition|)
block|{
comment|/* Cast away const, to allow calling property helpers */
name|apr_hash_t
modifier|*
name|base_props
init|=
operator|(
name|apr_hash_t
operator|*
operator|)
name|piwb
operator|->
name|props
decl_stmt|;
name|apr_hash_t
modifier|*
name|new_actual_props
init|=
operator|(
name|apr_hash_t
operator|*
operator|)
name|piwb
operator|->
name|new_actual_props
decl_stmt|;
if|if
condition|(
name|base_props
operator|!=
name|NULL
operator|&&
name|new_actual_props
operator|!=
name|NULL
operator|&&
operator|(
name|apr_hash_count
argument_list|(
name|base_props
argument_list|)
operator|==
name|apr_hash_count
argument_list|(
name|new_actual_props
argument_list|)
operator|)
condition|)
block|{
name|apr_array_header_t
modifier|*
name|diffs
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_prop_diffs
argument_list|(
operator|&
name|diffs
argument_list|,
name|new_actual_props
argument_list|,
name|base_props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|diffs
operator|->
name|nelts
operator|==
literal|0
condition|)
name|new_actual_props
operator|=
name|NULL
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|set_actual_props
argument_list|(
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|new_actual_props
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|piwb
operator|->
name|kind
operator|==
name|svn_node_dir
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_ACTUAL_CLEAR_CHANGELIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_ACTUAL_EMPTY
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|piwb
operator|->
name|not_present_op_depth
operator|>
literal|0
operator|&&
name|piwb
operator|->
name|not_present_op_depth
operator|<
name|piwb
operator|->
name|op_depth
condition|)
block|{
comment|/* And also insert a not-present node to tell the commit processing that          a child of the parent node was not copied. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdsisrtnt"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|piwb
operator|->
name|not_present_op_depth
argument_list|,
name|parent_relpath
argument_list|,
name|piwb
operator|->
name|original_repos_id
argument_list|,
name|piwb
operator|->
name|original_repos_relpath
argument_list|,
name|piwb
operator|->
name|original_revnum
argument_list|,
name|presence_map
argument_list|,
name|svn_wc__db_status_not_present
argument_list|,
comment|/* NULL */
name|kind_map
argument_list|,
name|piwb
operator|->
name|kind
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|piwb
operator|->
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|piwb
operator|->
name|conflict
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_mark_conflict_internal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|piwb
operator|->
name|conflict
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Each name is allocated in RESULT_POOL and stored into CHILDREN as a key    pointed to the same name.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|add_children_to_hash
parameter_list|(
name|apr_hash_t
modifier|*
name|children
parameter_list|,
name|int
name|stmt_idx
parameter_list|,
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
name|apr_int64_t
name|wc_id
parameter_list|,
specifier|const
name|char
modifier|*
name|parent_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|stmt_idx
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wc_id
argument_list|,
name|parent_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|child_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|svn_relpath_basename
argument_list|(
name|child_relpath
argument_list|,
name|result_pool
argument_list|)
decl_stmt|;
name|svn_hash_sets
argument_list|(
name|children
argument_list|,
name|name
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Set *CHILDREN to a new array of the (const char *) basenames of the    immediate children, whatever their status, of the working node at    LOCAL_RELPATH. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|gather_children2
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|children
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|names_hash
init|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|apr_array_header_t
modifier|*
name|names_array
decl_stmt|;
comment|/* All of the names get allocated in RESULT_POOL.  It      appears to be faster to use the hash to remove duplicates than to      use DISTINCT in the SQL query. */
name|SVN_ERR
argument_list|(
name|add_children_to_hash
argument_list|(
name|names_hash
argument_list|,
name|STMT_SELECT_WORKING_CHILDREN
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_hash_keys
argument_list|(
operator|&
name|names_array
argument_list|,
name|names_hash
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|children
operator|=
name|names_array
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Return in *CHILDREN all of the children of the directory LOCAL_RELPATH,    of any status, in all op-depths in the NODES table. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|gather_children
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|children
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|names_hash
init|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|apr_array_header_t
modifier|*
name|names_array
decl_stmt|;
comment|/* All of the names get allocated in RESULT_POOL.  It      appears to be faster to use the hash to remove duplicates than to      use DISTINCT in the SQL query. */
name|SVN_ERR
argument_list|(
name|add_children_to_hash
argument_list|(
name|names_hash
argument_list|,
name|STMT_SELECT_NODE_CHILDREN
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_hash_keys
argument_list|(
operator|&
name|names_array
argument_list|,
name|names_hash
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|children
operator|=
name|names_array
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Set *CHILDREN to a new array of (const char *) names of the children of    the repository directory corresponding to WCROOT:LOCAL_RELPATH:OP_DEPTH -    that is, only the children that are at the same op-depth as their parent. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|gather_repo_children
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|children
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_array_header_t
modifier|*
name|result
init|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_OP_DEPTH_CHILDREN
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|child_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
comment|/* Allocate the name in RESULT_POOL so we won't have to copy it. */
name|APR_ARRAY_PUSH
argument_list|(
name|result
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
operator|=
name|svn_relpath_basename
argument_list|(
name|child_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|children
operator|=
name|result
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_get_children_op_depth
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|children
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
operator|*
name|children
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_OP_DEPTH_CHILDREN
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|child_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|svn_node_kind_t
modifier|*
name|child_kind
init|=
name|apr_palloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_node_kind_t
argument_list|)
argument_list|)
decl_stmt|;
operator|*
name|child_kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
operator|*
name|children
argument_list|,
name|svn_relpath_basename
argument_list|(
name|child_relpath
argument_list|,
name|result_pool
argument_list|)
argument_list|,
name|child_kind
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Return TRUE if CHILD_ABSPATH is an immediate child of PARENT_ABSPATH.  * Else, return FALSE. */
end_comment

begin_function
specifier|static
name|svn_boolean_t
name|is_immediate_child_path
parameter_list|(
specifier|const
name|char
modifier|*
name|parent_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|child_abspath
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|local_relpath
init|=
name|svn_dirent_skip_ancestor
argument_list|(
name|parent_abspath
argument_list|,
name|child_abspath
argument_list|)
decl_stmt|;
comment|/* To be an immediate child local_relpath should have one (not empty)      component */
return|return
name|local_relpath
operator|&&
operator|*
name|local_relpath
operator|&&
operator|!
name|strchr
argument_list|(
name|local_relpath
argument_list|,
literal|'/'
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Remove the access baton for LOCAL_ABSPATH from ACCESS_CACHE. */
end_comment

begin_function
specifier|static
name|void
name|remove_from_access_cache
parameter_list|(
name|apr_hash_t
modifier|*
name|access_cache
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|)
block|{
name|svn_wc_adm_access_t
modifier|*
name|adm_access
decl_stmt|;
name|adm_access
operator|=
name|svn_hash_gets
argument_list|(
name|access_cache
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
if|if
condition|(
name|adm_access
condition|)
name|svn_wc__adm_access_set_entries
argument_list|(
name|adm_access
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Flush the access baton for LOCAL_ABSPATH, and any of its children up to  * the specified DEPTH, from the access baton cache in WCROOT.  * Also flush the access baton for the parent of LOCAL_ABSPATH.I  *  * This function must be called when the access baton cache goes stale,  * i.e. data about LOCAL_ABSPATH will need to be read again from disk.  *  * Use SCRATCH_POOL for temporary allocations. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|flush_entries
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|parent_abspath
decl_stmt|;
if|if
condition|(
name|apr_hash_count
argument_list|(
name|wcroot
operator|->
name|access_cache
argument_list|)
operator|==
literal|0
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|remove_from_access_cache
argument_list|(
name|wcroot
operator|->
name|access_cache
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
if|if
condition|(
name|depth
operator|>
name|svn_depth_empty
condition|)
block|{
name|apr_hash_index_t
modifier|*
name|hi
decl_stmt|;
comment|/* Flush access batons of children within the specified depth. */
for|for
control|(
name|hi
operator|=
name|apr_hash_first
argument_list|(
name|scratch_pool
argument_list|,
name|wcroot
operator|->
name|access_cache
argument_list|)
init|;
name|hi
condition|;
name|hi
operator|=
name|apr_hash_next
argument_list|(
name|hi
argument_list|)
control|)
block|{
specifier|const
name|char
modifier|*
name|item_abspath
init|=
name|svn__apr_hash_index_key
argument_list|(
name|hi
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|depth
operator|==
name|svn_depth_files
operator|||
name|depth
operator|==
name|svn_depth_immediates
operator|)
operator|&&
name|is_immediate_child_path
argument_list|(
name|local_abspath
argument_list|,
name|item_abspath
argument_list|)
condition|)
block|{
name|remove_from_access_cache
argument_list|(
name|wcroot
operator|->
name|access_cache
argument_list|,
name|item_abspath
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|depth
operator|==
name|svn_depth_infinity
operator|&&
name|svn_dirent_is_ancestor
argument_list|(
name|local_abspath
argument_list|,
name|item_abspath
argument_list|)
condition|)
block|{
name|remove_from_access_cache
argument_list|(
name|wcroot
operator|->
name|access_cache
argument_list|,
name|item_abspath
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* We're going to be overly aggressive here and just flush the parent      without doing much checking.  This may hurt performance for      legacy API consumers, but that's not our problem. :) */
name|parent_abspath
operator|=
name|svn_dirent_dirname
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|remove_from_access_cache
argument_list|(
name|wcroot
operator|->
name|access_cache
argument_list|,
name|parent_abspath
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Add a single WORK_ITEM into the given SDB's WORK_QUEUE table. This does    not perform its work within a transaction, assuming the caller will    manage that.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|add_single_work_item
parameter_list|(
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_item
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_stringbuf_t
modifier|*
name|serialized
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|serialized
operator|=
name|svn_skel__unparse
argument_list|(
name|work_item
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_INSERT_WORK_ITEM
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_blob
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|serialized
operator|->
name|data
argument_list|,
name|serialized
operator|->
name|len
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__insert
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Add work item(s) to the given SDB. Also see add_single_work_item(). This    SKEL is usually passed to the various wc_db operation functions. It may    be NULL, indicating no additional work items are needed, it may be a    single work item, or it may be a list of work items.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|add_work_items
parameter_list|(
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|skel
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
comment|/* Maybe there are no work items to insert.  */
if|if
condition|(
name|skel
operator|==
name|NULL
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Should have a list.  */
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|skel
operator|->
name|is_atom
argument_list|)
expr_stmt|;
comment|/* Is the list a single work item? Or a list of work items?  */
if|if
condition|(
name|SVN_WC__SINGLE_WORK_ITEM
argument_list|(
name|skel
argument_list|)
condition|)
return|return
name|svn_error_trace
argument_list|(
name|add_single_work_item
argument_list|(
name|sdb
argument_list|,
name|skel
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
comment|/* SKEL is a list-of-lists, aka list of work items.  */
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
for|for
control|(
name|skel
operator|=
name|skel
operator|->
name|children
init|;
name|skel
condition|;
name|skel
operator|=
name|skel
operator|->
name|next
control|)
block|{
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|add_single_work_item
argument_list|(
name|sdb
argument_list|,
name|skel
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Determine whether the node exists for a given WCROOT and LOCAL_RELPATH.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|does_node_exist
parameter_list|(
name|svn_boolean_t
modifier|*
name|exists
parameter_list|,
specifier|const
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DOES_NODE_EXIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
name|exists
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_install_schema_statistics
parameter_list|(
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|sdb
argument_list|,
name|STMT_INSTALL_SCHEMA_STATISTICS
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Helper for create_db(). Initializes our wc.db schema.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|init_db
parameter_list|(
comment|/* output values */
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
name|apr_int64_t
modifier|*
name|wc_id
parameter_list|,
comment|/* input values */
name|svn_sqlite__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
specifier|const
name|char
modifier|*
name|root_node_repos_relpath
parameter_list|,
name|svn_revnum_t
name|root_node_revision
parameter_list|,
name|svn_depth_t
name|root_node_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
comment|/* Create the database's schema.  */
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|db
argument_list|,
name|STMT_CREATE_SCHEMA
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|db
argument_list|,
name|STMT_CREATE_NODES
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|db
argument_list|,
name|STMT_CREATE_NODES_TRIGGERS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|db
argument_list|,
name|STMT_CREATE_EXTERNALS
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Insert the repository. */
name|SVN_ERR
argument_list|(
name|create_repos_id
argument_list|(
name|repos_id
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|db
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_install_schema_statistics
argument_list|(
name|db
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Insert the wcroot. */
comment|/* ### Right now, this just assumes wc metadata is being stored locally. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|db
argument_list|,
name|STMT_INSERT_WCROOT
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__insert
argument_list|(
name|wc_id
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|root_node_repos_relpath
condition|)
block|{
name|svn_wc__db_status_t
name|status
init|=
name|svn_wc__db_status_normal
decl_stmt|;
if|if
condition|(
name|root_node_revision
operator|>
literal|0
condition|)
name|status
operator|=
name|svn_wc__db_status_incomplete
expr_stmt|;
comment|/* Will be filled by update */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|db
argument_list|,
name|STMT_INSERT_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdsisrtst"
argument_list|,
operator|*
name|wc_id
argument_list|,
comment|/* 1 */
literal|""
argument_list|,
comment|/* 2 */
literal|0
argument_list|,
comment|/* op_depth is 0 for base */
name|NULL
argument_list|,
comment|/* 4 */
operator|*
name|repos_id
argument_list|,
name|root_node_repos_relpath
argument_list|,
name|root_node_revision
argument_list|,
name|presence_map
argument_list|,
name|status
argument_list|,
comment|/* 8 */
name|svn_token__to_word
argument_list|(
name|depth_map
argument_list|,
name|root_node_depth
argument_list|)
argument_list|,
name|kind_map
argument_list|,
name|svn_node_dir
comment|/* 10 */
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__insert
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Create an sqlite database at DIR_ABSPATH/SDB_FNAME and insert    records for REPOS_ID (using REPOS_ROOT_URL and REPOS_UUID) into    REPOSITORY and for WC_ID into WCROOT.  Return the DB connection    in *SDB.     If ROOT_NODE_REPOS_RELPATH is not NULL, insert a BASE node at    the working copy root with repository relpath ROOT_NODE_REPOS_RELPATH,    revision ROOT_NODE_REVISION and depth ROOT_NODE_DEPTH.    */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|create_db
parameter_list|(
name|svn_sqlite__db_t
modifier|*
modifier|*
name|sdb
parameter_list|,
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
name|apr_int64_t
modifier|*
name|wc_id
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
specifier|const
name|char
modifier|*
name|sdb_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|root_node_repos_relpath
parameter_list|,
name|svn_revnum_t
name|root_node_revision
parameter_list|,
name|svn_depth_t
name|root_node_depth
parameter_list|,
name|svn_boolean_t
name|exclusive
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_util_open_db
argument_list|(
name|sdb
argument_list|,
name|dir_abspath
argument_list|,
name|sdb_fname
argument_list|,
name|svn_sqlite__mode_rwcreate
argument_list|,
name|exclusive
argument_list|,
name|NULL
comment|/* my_statements */
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_SQLITE__WITH_LOCK
argument_list|(
name|init_db
argument_list|(
name|repos_id
argument_list|,
name|wc_id
argument_list|,
operator|*
name|sdb
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|root_node_repos_relpath
argument_list|,
name|root_node_revision
argument_list|,
name|root_node_depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
operator|*
name|sdb
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_init
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|svn_revnum_t
name|initial_rev
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__db_t
modifier|*
name|sdb
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
name|apr_int64_t
name|wc_id
decl_stmt|;
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
name|svn_boolean_t
name|sqlite_exclusive
init|=
name|FALSE
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_relpath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|depth
operator|==
name|svn_depth_empty
operator|||
name|depth
operator|==
name|svn_depth_files
operator|||
name|depth
operator|==
name|svn_depth_immediates
operator|||
name|depth
operator|==
name|svn_depth_infinity
argument_list|)
expr_stmt|;
comment|/* ### REPOS_ROOT_URL and REPOS_UUID may be NULL. ... more doc: tbd  */
name|SVN_ERR
argument_list|(
name|svn_config_get_bool
argument_list|(
operator|(
name|svn_config_t
operator|*
operator|)
name|db
operator|->
name|config
argument_list|,
operator|&
name|sqlite_exclusive
argument_list|,
name|SVN_CONFIG_SECTION_WORKING_COPY
argument_list|,
name|SVN_CONFIG_OPTION_SQLITE_EXCLUSIVE
argument_list|,
name|FALSE
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Create the SDB and insert the basic rows.  */
name|SVN_ERR
argument_list|(
name|create_db
argument_list|(
operator|&
name|sdb
argument_list|,
operator|&
name|repos_id
argument_list|,
operator|&
name|wc_id
argument_list|,
name|local_abspath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|SDB_FILE
argument_list|,
name|repos_relpath
argument_list|,
name|initial_rev
argument_list|,
name|depth
argument_list|,
name|sqlite_exclusive
argument_list|,
name|db
operator|->
name|state_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Create the WCROOT for this directory.  */
name|SVN_ERR
argument_list|(
name|svn_wc__db_pdh_create_wcroot
argument_list|(
operator|&
name|wcroot
argument_list|,
name|apr_pstrdup
argument_list|(
name|db
operator|->
name|state_pool
argument_list|,
name|local_abspath
argument_list|)
argument_list|,
name|sdb
argument_list|,
name|wc_id
argument_list|,
name|FORMAT_FROM_SDB
argument_list|,
name|FALSE
comment|/* auto-upgrade */
argument_list|,
name|FALSE
comment|/* enforce_empty_wq */
argument_list|,
name|db
operator|->
name|state_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* The WCROOT is complete. Stash it into DB.  */
name|svn_hash_sets
argument_list|(
name|db
operator|->
name|dir_data
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_to_relpath
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* This function is indirectly called from the upgrade code, so we      can't verify the wcroot here. Just check that it is not NULL */
name|CHECK_MINIMAL_WCROOT
argument_list|(
name|wcroot
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|svn_dirent_is_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
condition|)
block|{
operator|*
name|local_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* Probably moving from $TMP. Should we allow this? */
operator|*
name|local_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_from_relpath
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|local_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|unused_relpath
decl_stmt|;
if|#
directive|if
literal|0
block|SVN_ERR_ASSERT(svn_relpath_is_canonical(local_relpath));
endif|#
directive|endif
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|unused_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* This function is indirectly called from the upgrade code, so we      can't verify the wcroot here. Just check that it is not NULL */
name|CHECK_MINIMAL_WCROOT
argument_list|(
name|wcroot
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|*
name|local_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_get_wcroot
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|wcroot_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|unused_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|unused_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Can't use VERIFY_USABLE_WCROOT, as this should be usable to detect      where call upgrade */
name|CHECK_MINIMAL_WCROOT
argument_list|(
name|wcroot
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|*
name|wcroot_abspath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_add_directory
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_revnum_t
name|changed_rev
parameter_list|,
name|apr_time_t
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
name|changed_author
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|children
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_hash_t
modifier|*
name|dav_cache
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
name|svn_boolean_t
name|update_actual_props
parameter_list|,
name|apr_hash_t
modifier|*
name|new_actual_props
parameter_list|,
name|apr_array_header_t
modifier|*
name|new_iprops
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|insert_base_baton_t
name|ibb
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_relpath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_uri_is_canonical
argument_list|(
name|repos_root_url
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_uuid
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|props
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|changed_rev
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|SVN_ERR_ASSERT(children != NULL);
endif|#
directive|endif
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
name|blank_ibb
argument_list|(
operator|&
name|ibb
argument_list|)
expr_stmt|;
comment|/* Calculate repos_id in insert_base_node() to avoid extra transaction */
name|ibb
operator|.
name|repos_root_url
operator|=
name|repos_root_url
expr_stmt|;
name|ibb
operator|.
name|repos_uuid
operator|=
name|repos_uuid
expr_stmt|;
name|ibb
operator|.
name|status
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|ibb
operator|.
name|kind
operator|=
name|svn_node_dir
expr_stmt|;
name|ibb
operator|.
name|repos_relpath
operator|=
name|repos_relpath
expr_stmt|;
name|ibb
operator|.
name|revision
operator|=
name|revision
expr_stmt|;
name|ibb
operator|.
name|iprops
operator|=
name|new_iprops
expr_stmt|;
name|ibb
operator|.
name|props
operator|=
name|props
expr_stmt|;
name|ibb
operator|.
name|changed_rev
operator|=
name|changed_rev
expr_stmt|;
name|ibb
operator|.
name|changed_date
operator|=
name|changed_date
expr_stmt|;
name|ibb
operator|.
name|changed_author
operator|=
name|changed_author
expr_stmt|;
name|ibb
operator|.
name|children
operator|=
name|children
expr_stmt|;
name|ibb
operator|.
name|depth
operator|=
name|depth
expr_stmt|;
name|ibb
operator|.
name|dav_cache
operator|=
name|dav_cache
expr_stmt|;
name|ibb
operator|.
name|conflict
operator|=
name|conflict
expr_stmt|;
name|ibb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
if|if
condition|(
name|update_actual_props
condition|)
block|{
name|ibb
operator|.
name|update_actual_props
operator|=
name|TRUE
expr_stmt|;
name|ibb
operator|.
name|new_actual_props
operator|=
name|new_actual_props
expr_stmt|;
block|}
comment|/* Insert the directory and all its children transactionally.       Note: old children can stick around, even if they are no longer present      in this directory's revision.  */
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_base_node
argument_list|(
operator|&
name|ibb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_add_incomplete_directory
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|insert_base_deleted
parameter_list|,
name|svn_boolean_t
name|delete_working
parameter_list|,
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|struct
name|insert_base_baton_t
name|ibb
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_relpath
operator|&&
name|repos_root_url
operator|&&
name|repos_uuid
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|blank_ibb
argument_list|(
operator|&
name|ibb
argument_list|)
expr_stmt|;
comment|/* Calculate repos_id in insert_base_node() to avoid extra transaction */
name|ibb
operator|.
name|repos_root_url
operator|=
name|repos_root_url
expr_stmt|;
name|ibb
operator|.
name|repos_uuid
operator|=
name|repos_uuid
expr_stmt|;
name|ibb
operator|.
name|status
operator|=
name|svn_wc__db_status_incomplete
expr_stmt|;
name|ibb
operator|.
name|kind
operator|=
name|svn_node_dir
expr_stmt|;
name|ibb
operator|.
name|repos_relpath
operator|=
name|repos_relpath
expr_stmt|;
name|ibb
operator|.
name|revision
operator|=
name|revision
expr_stmt|;
name|ibb
operator|.
name|depth
operator|=
name|depth
expr_stmt|;
name|ibb
operator|.
name|insert_base_deleted
operator|=
name|insert_base_deleted
expr_stmt|;
name|ibb
operator|.
name|delete_working
operator|=
name|delete_working
expr_stmt|;
name|ibb
operator|.
name|conflict
operator|=
name|conflict
expr_stmt|;
name|ibb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_base_node
argument_list|(
operator|&
name|ibb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_add_file
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_revnum_t
name|changed_rev
parameter_list|,
name|apr_time_t
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
name|changed_author
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
parameter_list|,
name|apr_hash_t
modifier|*
name|dav_cache
parameter_list|,
name|svn_boolean_t
name|delete_working
parameter_list|,
name|svn_boolean_t
name|update_actual_props
parameter_list|,
name|apr_hash_t
modifier|*
name|new_actual_props
parameter_list|,
name|apr_array_header_t
modifier|*
name|new_iprops
parameter_list|,
name|svn_boolean_t
name|keep_recorded_info
parameter_list|,
name|svn_boolean_t
name|insert_base_deleted
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|insert_base_baton_t
name|ibb
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_relpath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_uri_is_canonical
argument_list|(
name|repos_root_url
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_uuid
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|props
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|changed_rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|checksum
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
name|blank_ibb
argument_list|(
operator|&
name|ibb
argument_list|)
expr_stmt|;
comment|/* Calculate repos_id in insert_base_node() to avoid extra transaction */
name|ibb
operator|.
name|repos_root_url
operator|=
name|repos_root_url
expr_stmt|;
name|ibb
operator|.
name|repos_uuid
operator|=
name|repos_uuid
expr_stmt|;
name|ibb
operator|.
name|status
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|ibb
operator|.
name|kind
operator|=
name|svn_node_file
expr_stmt|;
name|ibb
operator|.
name|repos_relpath
operator|=
name|repos_relpath
expr_stmt|;
name|ibb
operator|.
name|revision
operator|=
name|revision
expr_stmt|;
name|ibb
operator|.
name|props
operator|=
name|props
expr_stmt|;
name|ibb
operator|.
name|changed_rev
operator|=
name|changed_rev
expr_stmt|;
name|ibb
operator|.
name|changed_date
operator|=
name|changed_date
expr_stmt|;
name|ibb
operator|.
name|changed_author
operator|=
name|changed_author
expr_stmt|;
name|ibb
operator|.
name|checksum
operator|=
name|checksum
expr_stmt|;
name|ibb
operator|.
name|dav_cache
operator|=
name|dav_cache
expr_stmt|;
name|ibb
operator|.
name|iprops
operator|=
name|new_iprops
expr_stmt|;
if|if
condition|(
name|update_actual_props
condition|)
block|{
name|ibb
operator|.
name|update_actual_props
operator|=
name|TRUE
expr_stmt|;
name|ibb
operator|.
name|new_actual_props
operator|=
name|new_actual_props
expr_stmt|;
block|}
name|ibb
operator|.
name|keep_recorded_info
operator|=
name|keep_recorded_info
expr_stmt|;
name|ibb
operator|.
name|insert_base_deleted
operator|=
name|insert_base_deleted
expr_stmt|;
name|ibb
operator|.
name|delete_working
operator|=
name|delete_working
expr_stmt|;
name|ibb
operator|.
name|conflict
operator|=
name|conflict
expr_stmt|;
name|ibb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_base_node
argument_list|(
operator|&
name|ibb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
comment|/* If this used to be a directory we should remove children so pass    * depth infinity. */
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_infinity
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_add_symlink
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_revnum_t
name|changed_rev
parameter_list|,
name|apr_time_t
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
name|changed_author
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|,
name|apr_hash_t
modifier|*
name|dav_cache
parameter_list|,
name|svn_boolean_t
name|delete_working
parameter_list|,
name|svn_boolean_t
name|update_actual_props
parameter_list|,
name|apr_hash_t
modifier|*
name|new_actual_props
parameter_list|,
name|apr_array_header_t
modifier|*
name|new_iprops
parameter_list|,
name|svn_boolean_t
name|keep_recorded_info
parameter_list|,
name|svn_boolean_t
name|insert_base_deleted
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|insert_base_baton_t
name|ibb
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_relpath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_uri_is_canonical
argument_list|(
name|repos_root_url
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_uuid
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|props
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|changed_rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|target
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
name|blank_ibb
argument_list|(
operator|&
name|ibb
argument_list|)
expr_stmt|;
comment|/* Calculate repos_id in insert_base_node() to avoid extra transaction */
name|ibb
operator|.
name|repos_root_url
operator|=
name|repos_root_url
expr_stmt|;
name|ibb
operator|.
name|repos_uuid
operator|=
name|repos_uuid
expr_stmt|;
name|ibb
operator|.
name|status
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|ibb
operator|.
name|kind
operator|=
name|svn_node_symlink
expr_stmt|;
name|ibb
operator|.
name|repos_relpath
operator|=
name|repos_relpath
expr_stmt|;
name|ibb
operator|.
name|revision
operator|=
name|revision
expr_stmt|;
name|ibb
operator|.
name|props
operator|=
name|props
expr_stmt|;
name|ibb
operator|.
name|changed_rev
operator|=
name|changed_rev
expr_stmt|;
name|ibb
operator|.
name|changed_date
operator|=
name|changed_date
expr_stmt|;
name|ibb
operator|.
name|changed_author
operator|=
name|changed_author
expr_stmt|;
name|ibb
operator|.
name|target
operator|=
name|target
expr_stmt|;
name|ibb
operator|.
name|dav_cache
operator|=
name|dav_cache
expr_stmt|;
name|ibb
operator|.
name|iprops
operator|=
name|new_iprops
expr_stmt|;
if|if
condition|(
name|update_actual_props
condition|)
block|{
name|ibb
operator|.
name|update_actual_props
operator|=
name|TRUE
expr_stmt|;
name|ibb
operator|.
name|new_actual_props
operator|=
name|new_actual_props
expr_stmt|;
block|}
name|ibb
operator|.
name|keep_recorded_info
operator|=
name|keep_recorded_info
expr_stmt|;
name|ibb
operator|.
name|insert_base_deleted
operator|=
name|insert_base_deleted
expr_stmt|;
name|ibb
operator|.
name|delete_working
operator|=
name|delete_working
expr_stmt|;
name|ibb
operator|.
name|conflict
operator|=
name|conflict
expr_stmt|;
name|ibb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_base_node
argument_list|(
operator|&
name|ibb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
comment|/* If this used to be a directory we should remove children so pass    * depth infinity. */
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_infinity
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|add_excluded_or_not_present_node
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|svn_node_kind_t
name|kind
parameter_list|,
name|svn_wc__db_status_t
name|status
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|insert_base_baton_t
name|ibb
decl_stmt|;
specifier|const
name|char
modifier|*
name|dir_abspath
decl_stmt|,
modifier|*
name|name
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_relpath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_uri_is_canonical
argument_list|(
name|repos_root_url
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_uuid
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|status
operator|==
name|svn_wc__db_status_server_excluded
operator|||
name|status
operator|==
name|svn_wc__db_status_excluded
operator|||
name|status
operator|==
name|svn_wc__db_status_not_present
argument_list|)
expr_stmt|;
comment|/* These absent presence nodes are only useful below a parent node that is      present. To avoid problems with working copies obstructing the child      we calculate the wcroot and local_relpath of the parent and then add      our own relpath. */
name|svn_dirent_split
argument_list|(
operator|&
name|dir_abspath
argument_list|,
operator|&
name|name
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|local_relpath
argument_list|,
name|name
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|blank_ibb
argument_list|(
operator|&
name|ibb
argument_list|)
expr_stmt|;
comment|/* Calculate repos_id in insert_base_node() to avoid extra transaction */
name|ibb
operator|.
name|repos_root_url
operator|=
name|repos_root_url
expr_stmt|;
name|ibb
operator|.
name|repos_uuid
operator|=
name|repos_uuid
expr_stmt|;
name|ibb
operator|.
name|status
operator|=
name|status
expr_stmt|;
name|ibb
operator|.
name|kind
operator|=
name|kind
expr_stmt|;
name|ibb
operator|.
name|repos_relpath
operator|=
name|repos_relpath
expr_stmt|;
name|ibb
operator|.
name|revision
operator|=
name|revision
expr_stmt|;
comment|/* Depending upon KIND, any of these might get used. */
name|ibb
operator|.
name|children
operator|=
name|NULL
expr_stmt|;
name|ibb
operator|.
name|depth
operator|=
name|svn_depth_unknown
expr_stmt|;
name|ibb
operator|.
name|checksum
operator|=
name|NULL
expr_stmt|;
name|ibb
operator|.
name|target
operator|=
name|NULL
expr_stmt|;
name|ibb
operator|.
name|conflict
operator|=
name|conflict
expr_stmt|;
name|ibb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_base_node
argument_list|(
operator|&
name|ibb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
comment|/* If this used to be a directory we should remove children so pass    * depth infinity. */
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_infinity
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_add_excluded_node
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|svn_node_kind_t
name|kind
parameter_list|,
name|svn_wc__db_status_t
name|status
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|SVN_ERR_ASSERT
argument_list|(
name|status
operator|==
name|svn_wc__db_status_server_excluded
operator|||
name|status
operator|==
name|svn_wc__db_status_excluded
argument_list|)
expr_stmt|;
return|return
name|add_excluded_or_not_present_node
argument_list|(
name|db
argument_list|,
name|local_abspath
argument_list|,
name|repos_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|revision
argument_list|,
name|kind
argument_list|,
name|status
argument_list|,
name|conflict
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_add_not_present_node
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|svn_node_kind_t
name|kind
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|add_excluded_or_not_present_node
argument_list|(
name|db
argument_list|,
name|local_abspath
argument_list|,
name|repos_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|revision
argument_list|,
name|kind
argument_list|,
name|svn_wc__db_status_not_present
argument_list|,
name|conflict
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Recursively clear moved-here information at the copy-half of the move  * which moved the node at SRC_RELPATH away. This transforms the move into  * a simple copy. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|clear_moved_here
parameter_list|(
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
specifier|const
name|char
modifier|*
name|dst_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_TO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|src_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|src_relpath
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_row
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|dst_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CLEAR_MOVED_HERE_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|dst_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|dst_relpath
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_base_remove().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_base_remove
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
comment|/* For checking conflicts */
name|svn_boolean_t
name|keep_as_working
parameter_list|,
name|svn_boolean_t
name|queue_deletes
parameter_list|,
name|svn_boolean_t
name|remove_locks
parameter_list|,
name|svn_revnum_t
name|not_present_revision
parameter_list|,
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|svn_boolean_t
name|keep_working
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|kind
argument_list|,
name|NULL
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|remove_locks
condition|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|lock_stmt
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|lock_stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_LOCK_RECURSIVELY
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|lock_stmt
argument_list|,
literal|"is"
argument_list|,
name|repos_id
argument_list|,
name|repos_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|lock_stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_normal
operator|&&
name|keep_as_working
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_op_make_copy
argument_list|(
name|db
argument_list|,
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|keep_working
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
comment|/* Check if there is already a working node */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|keep_working
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Step 1: Create workqueue operations to remove files and dirs in the      local-wc */
if|if
condition|(
operator|!
name|keep_working
operator|&&
name|queue_deletes
operator|&&
operator|(
name|status
operator|==
name|svn_wc__db_status_normal
operator|||
name|status
operator|==
name|svn_wc__db_status_incomplete
operator|)
condition|)
block|{
name|svn_skel_t
modifier|*
name|work_item
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_abspath
decl_stmt|;
name|local_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|==
name|svn_node_dir
condition|)
block|{
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_BASE_PRESENT
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|node_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|svn_node_kind_t
name|node_kind
init|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|kind_map
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|node_abspath
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|node_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|node_relpath
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|node_kind
operator|==
name|svn_node_dir
condition|)
name|err
operator|=
name|svn_wc__wq_build_dir_remove
argument_list|(
operator|&
name|work_item
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|node_abspath
argument_list|,
name|FALSE
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
else|else
name|err
operator|=
name|svn_wc__wq_build_file_remove
argument_list|(
operator|&
name|work_item
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|node_abspath
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_item
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__wq_build_dir_remove
argument_list|(
operator|&
name|work_item
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__wq_build_file_remove
argument_list|(
operator|&
name|work_item
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_item
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Step 2: Delete ACTUAL nodes */
if|if
condition|(
operator|!
name|keep_working
condition|)
block|{
comment|/* There won't be a record in NODE left for this node, so we want          to remove *all* ACTUAL nodes, including ACTUAL ONLY. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_ACTUAL_NODE_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|keep_as_working
condition|)
block|{
comment|/* Delete only the ACTUAL nodes that apply to a delete of a BASE node */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_ACTUAL_FOR_BASE_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Else: Everything has been turned into a copy, so we want to keep all            ACTUAL_NODE records */
comment|/* Step 3: Delete WORKING nodes */
if|if
condition|(
name|conflict
condition|)
block|{
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
comment|/*        * When deleting a conflicted node, moves of any moved-outside children        * of the node must be broken. Else, the destination will still be marked        * moved-here after the move source disappears from the working copy.        *        * ### FIXME: It would be nicer to have the conflict resolver        * break the move instead. It might also be a good idea to        * flag a tree conflict on each moved-away child. But doing so        * might introduce actual-only nodes without direct parents,        * and we're not yet sure if other existing code is prepared        * to handle such nodes. To be revisited post-1.8.        *        * ### In case of a conflict we are most likely creating WORKING nodes        *     describing a copy of what was in BASE. The move information        *     should be updated to describe a move from the WORKING layer.        *     When stored that way the resolver of the tree conflict still has        *     the knowledge of what was moved.        */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_OUTSIDE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|child_relpath
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|child_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|err
operator|=
name|clear_moved_here
argument_list|(
name|child_relpath
argument_list|,
name|wcroot
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|keep_working
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_WORKING_BASE_DELETE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_WORKING_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Step 4: Delete the BASE node descendants */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_BASE_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Step 5: handle the BASE node itself */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_BASE_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_retract_parent_delete
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Step 6: Delete actual node if we don't keep working */
if|if
condition|(
operator|!
name|keep_working
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_ACTUAL_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|not_present_revision
argument_list|)
condition|)
block|{
name|struct
name|insert_base_baton_t
name|ibb
decl_stmt|;
name|blank_ibb
argument_list|(
operator|&
name|ibb
argument_list|)
expr_stmt|;
name|ibb
operator|.
name|repos_id
operator|=
name|repos_id
expr_stmt|;
name|ibb
operator|.
name|status
operator|=
name|svn_wc__db_status_not_present
expr_stmt|;
name|ibb
operator|.
name|kind
operator|=
name|kind
expr_stmt|;
name|ibb
operator|.
name|repos_relpath
operator|=
name|repos_relpath
expr_stmt|;
name|ibb
operator|.
name|revision
operator|=
name|not_present_revision
expr_stmt|;
comment|/* Depending upon KIND, any of these might get used. */
name|ibb
operator|.
name|children
operator|=
name|NULL
expr_stmt|;
name|ibb
operator|.
name|depth
operator|=
name|svn_depth_unknown
expr_stmt|;
name|ibb
operator|.
name|checksum
operator|=
name|NULL
expr_stmt|;
name|ibb
operator|.
name|target
operator|=
name|NULL
expr_stmt|;
name|SVN_ERR
argument_list|(
name|insert_base_node
argument_list|(
operator|&
name|ibb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_mark_conflict_internal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|conflict
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_remove
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|keep_as_working
parameter_list|,
name|svn_boolean_t
name|queue_deletes
parameter_list|,
name|svn_boolean_t
name|remove_locks
parameter_list|,
name|svn_revnum_t
name|not_present_revision
parameter_list|,
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|db_base_remove
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|db
argument_list|,
name|keep_as_working
argument_list|,
name|queue_deletes
argument_list|,
name|remove_locks
argument_list|,
name|not_present_revision
argument_list|,
name|conflict
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
comment|/* If this used to be a directory we should remove children so pass    * depth infinity. */
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_infinity
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_get_info_internal
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
name|svn_revnum_t
modifier|*
name|changed_rev
parameter_list|,
name|apr_time_t
modifier|*
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changed_author
parameter_list|,
name|svn_depth_t
modifier|*
name|depth
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
modifier|*
name|checksum
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|target
parameter_list|,
name|svn_wc__db_lock_t
modifier|*
modifier|*
name|lock
parameter_list|,
name|svn_boolean_t
modifier|*
name|had_props
parameter_list|,
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|svn_boolean_t
modifier|*
name|update_root
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|lock
condition|?
name|STMT_SELECT_BASE_NODE_WITH_LOCK
else|:
name|STMT_SELECT_BASE_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|svn_wc__db_status_t
name|node_status
init|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|presence_map
argument_list|)
decl_stmt|;
name|svn_node_kind_t
name|node_kind
init|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|kind_map
argument_list|)
decl_stmt|;
if|if
condition|(
name|kind
condition|)
block|{
operator|*
name|kind
operator|=
name|node_kind
expr_stmt|;
block|}
if|if
condition|(
name|status
condition|)
block|{
operator|*
name|status
operator|=
name|node_status
expr_stmt|;
block|}
name|repos_location_from_columns
argument_list|(
name|repos_id
argument_list|,
name|revision
argument_list|,
name|repos_relpath
argument_list|,
name|stmt
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|repos_id
operator|||
operator|*
name|repos_id
operator|!=
name|INVALID_REPOS_ID
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|repos_relpath
operator|||
operator|*
name|repos_relpath
argument_list|)
expr_stmt|;
if|if
condition|(
name|lock
condition|)
block|{
operator|*
name|lock
operator|=
name|lock_from_columns
argument_list|(
name|stmt
argument_list|,
literal|15
argument_list|,
literal|16
argument_list|,
literal|17
argument_list|,
literal|18
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|changed_rev
condition|)
block|{
operator|*
name|changed_rev
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|7
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|changed_date
condition|)
block|{
operator|*
name|changed_date
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|changed_author
condition|)
block|{
comment|/* Result may be NULL. */
operator|*
name|changed_author
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|9
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|depth
condition|)
block|{
if|if
condition|(
name|node_kind
operator|!=
name|svn_node_dir
condition|)
block|{
operator|*
name|depth
operator|=
name|svn_depth_unknown
expr_stmt|;
block|}
else|else
block|{
operator|*
name|depth
operator|=
name|svn_sqlite__column_token_null
argument_list|(
name|stmt
argument_list|,
literal|10
argument_list|,
name|depth_map
argument_list|,
name|svn_depth_unknown
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|checksum
condition|)
block|{
if|if
condition|(
name|node_kind
operator|!=
name|svn_node_file
condition|)
block|{
operator|*
name|checksum
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|svn_sqlite__column_checksum
argument_list|(
name|checksum
argument_list|,
name|stmt
argument_list|,
literal|5
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|NULL
condition|)
name|err
operator|=
name|svn_error_createf
argument_list|(
name|err
operator|->
name|apr_err
argument_list|,
name|err
argument_list|,
name|_
argument_list|(
literal|"The node '%s' has a corrupt checksum value."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|target
condition|)
block|{
if|if
condition|(
name|node_kind
operator|!=
name|svn_node_symlink
condition|)
operator|*
name|target
operator|=
name|NULL
expr_stmt|;
else|else
operator|*
name|target
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|11
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|had_props
condition|)
block|{
operator|*
name|had_props
operator|=
name|SQLITE_PROPERTIES_AVAILABLE
argument_list|(
name|stmt
argument_list|,
literal|13
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|props
condition|)
block|{
if|if
condition|(
name|node_status
operator|==
name|svn_wc__db_status_normal
operator|||
name|node_status
operator|==
name|svn_wc__db_status_incomplete
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_properties
argument_list|(
name|props
argument_list|,
name|stmt
argument_list|,
literal|13
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|props
operator|==
name|NULL
condition|)
operator|*
name|props
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|13
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|props
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|update_root
condition|)
block|{
comment|/* It's an update root iff it's a file external. */
operator|*
name|update_root
operator|=
name|svn_sqlite__column_boolean
argument_list|(
name|stmt
argument_list|,
literal|14
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|err
operator|=
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Note: given the composition, no need to wrap for tracing.  */
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_get_info
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_uuid
parameter_list|,
name|svn_revnum_t
modifier|*
name|changed_rev
parameter_list|,
name|apr_time_t
modifier|*
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changed_author
parameter_list|,
name|svn_depth_t
modifier|*
name|depth
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
modifier|*
name|checksum
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|target
parameter_list|,
name|svn_wc__db_lock_t
modifier|*
modifier|*
name|lock
parameter_list|,
name|svn_boolean_t
modifier|*
name|had_props
parameter_list|,
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|svn_boolean_t
modifier|*
name|update_root
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN4
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|status
argument_list|,
name|kind
argument_list|,
name|revision
argument_list|,
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|changed_rev
argument_list|,
name|changed_date
argument_list|,
name|changed_author
argument_list|,
name|depth
argument_list|,
name|checksum
argument_list|,
name|target
argument_list|,
name|lock
argument_list|,
name|had_props
argument_list|,
name|props
argument_list|,
name|update_root
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|svn_wc__db_fetch_repos_info
argument_list|(
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|repos_id
argument_list|,
name|result_pool
argument_list|)
argument_list|,
name|SVN_NO_ERROR
argument_list|,
name|SVN_NO_ERROR
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_id
operator|!=
name|INVALID_REPOS_ID
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_get_children_info
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|nodes
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|dir_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
operator|*
name|nodes
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_BASE_CHILDREN_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|struct
name|svn_wc__db_base_info_t
modifier|*
name|info
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|svn_relpath_basename
argument_list|(
name|child_relpath
argument_list|,
name|result_pool
argument_list|)
decl_stmt|;
name|info
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|repos_id
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|info
operator|->
name|repos_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|info
operator|->
name|status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
name|info
operator|->
name|kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
name|info
operator|->
name|revnum
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|info
operator|->
name|depth
operator|=
name|svn_sqlite__column_token_null
argument_list|(
name|stmt
argument_list|,
literal|6
argument_list|,
name|depth_map
argument_list|,
name|svn_depth_unknown
argument_list|)
expr_stmt|;
name|info
operator|->
name|update_root
operator|=
name|svn_sqlite__column_boolean
argument_list|(
name|stmt
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|info
operator|->
name|lock
operator|=
name|lock_from_columns
argument_list|(
name|stmt
argument_list|,
literal|8
argument_list|,
literal|9
argument_list|,
literal|10
argument_list|,
literal|11
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_wc__db_fetch_repos_info
argument_list|(
operator|&
name|info
operator|->
name|repos_root_url
argument_list|,
name|NULL
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|repos_id
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
return|;
name|svn_hash_sets
argument_list|(
operator|*
name|nodes
argument_list|,
name|name
argument_list|,
name|info
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_get_props
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|presence
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info
argument_list|(
operator|&
name|presence
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|props
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|presence
operator|!=
name|svn_wc__db_status_normal
operator|&&
name|presence
operator|!=
name|svn_wc__db_status_incomplete
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' has a BASE status that"
literal|" has no properties."
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_get_children
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|children
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|gather_repo_children
argument_list|(
name|children
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
literal|0
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_set_dav_cache
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|int
name|affected_rows
decl_stmt|;
name|SVN_ERR
argument_list|(
name|get_statement_for_path
argument_list|(
operator|&
name|stmt
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|STMT_UPDATE_BASE_NODE_DAV_CACHE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_properties
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|affected_rows
operator|!=
literal|1
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_get_dav_cache
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|get_statement_for_path
argument_list|(
operator|&
name|stmt
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|STMT_SELECT_BASE_DAV_CACHE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_properties
argument_list|(
name|props
argument_list|,
name|stmt
argument_list|,
literal|0
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_clear_dav_cache_recursive
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CLEAR_BASE_NODE_RECURSIVE_DAV_CACHE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_depth_get_info
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
name|svn_revnum_t
modifier|*
name|changed_rev
parameter_list|,
name|apr_time_t
modifier|*
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changed_author
parameter_list|,
name|svn_depth_t
modifier|*
name|depth
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
modifier|*
name|checksum
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|target
parameter_list|,
name|svn_boolean_t
modifier|*
name|had_props
parameter_list|,
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_DEPTH_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|svn_wc__db_status_t
name|node_status
init|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|presence_map
argument_list|)
decl_stmt|;
name|svn_node_kind_t
name|node_kind
init|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|kind_map
argument_list|)
decl_stmt|;
if|if
condition|(
name|kind
condition|)
block|{
operator|*
name|kind
operator|=
name|node_kind
expr_stmt|;
block|}
if|if
condition|(
name|status
condition|)
block|{
operator|*
name|status
operator|=
name|node_status
expr_stmt|;
if|if
condition|(
name|op_depth
operator|>
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|convert_to_working_status
argument_list|(
name|status
argument_list|,
operator|*
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|repos_location_from_columns
argument_list|(
name|repos_id
argument_list|,
name|revision
argument_list|,
name|repos_relpath
argument_list|,
name|stmt
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|changed_rev
condition|)
block|{
operator|*
name|changed_rev
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|7
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|changed_date
condition|)
block|{
operator|*
name|changed_date
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|changed_author
condition|)
block|{
comment|/* Result may be NULL. */
operator|*
name|changed_author
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|9
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|depth
condition|)
block|{
if|if
condition|(
name|node_kind
operator|!=
name|svn_node_dir
condition|)
block|{
operator|*
name|depth
operator|=
name|svn_depth_unknown
expr_stmt|;
block|}
else|else
block|{
operator|*
name|depth
operator|=
name|svn_sqlite__column_token_null
argument_list|(
name|stmt
argument_list|,
literal|10
argument_list|,
name|depth_map
argument_list|,
name|svn_depth_unknown
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|checksum
condition|)
block|{
if|if
condition|(
name|node_kind
operator|!=
name|svn_node_file
condition|)
block|{
operator|*
name|checksum
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|svn_sqlite__column_checksum
argument_list|(
name|checksum
argument_list|,
name|stmt
argument_list|,
literal|5
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|NULL
condition|)
name|err
operator|=
name|svn_error_createf
argument_list|(
name|err
operator|->
name|apr_err
argument_list|,
name|err
argument_list|,
name|_
argument_list|(
literal|"The node '%s' has a corrupt checksum value."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|target
condition|)
block|{
if|if
condition|(
name|node_kind
operator|!=
name|svn_node_symlink
condition|)
operator|*
name|target
operator|=
name|NULL
expr_stmt|;
else|else
operator|*
name|target
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|11
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|had_props
condition|)
block|{
operator|*
name|had_props
operator|=
name|SQLITE_PROPERTIES_AVAILABLE
argument_list|(
name|stmt
argument_list|,
literal|13
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|props
condition|)
block|{
if|if
condition|(
name|node_status
operator|==
name|svn_wc__db_status_normal
operator|||
name|node_status
operator|==
name|svn_wc__db_status_incomplete
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_properties
argument_list|(
name|props
argument_list|,
name|stmt
argument_list|,
literal|13
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|props
operator|==
name|NULL
condition|)
operator|*
name|props
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|13
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|props
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|err
operator|=
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Note: given the composition, no need to wrap for tracing.  */
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Baton for passing args to with_triggers(). */
end_comment

begin_struct
struct|struct
name|with_triggers_baton_t
block|{
name|int
name|create_trigger
decl_stmt|;
name|int
name|drop_trigger
decl_stmt|;
name|svn_wc__db_txn_callback_t
name|cb_func
decl_stmt|;
name|void
modifier|*
name|cb_baton
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Helper for creating SQLite triggers, running the main transaction    callback, and then dropping the triggers.  It guarantees that the    triggers will not survive the transaction.  This could be used for    any general prefix/postscript statements where the postscript    *must* be executed if the transaction completes.     Implements svn_wc__db_txn_callback_t. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|with_triggers
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|with_triggers_baton_t
modifier|*
name|b
init|=
name|baton
decl_stmt|;
name|svn_error_t
modifier|*
name|err1
decl_stmt|;
name|svn_error_t
modifier|*
name|err2
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|b
operator|->
name|create_trigger
argument_list|)
argument_list|)
expr_stmt|;
name|err1
operator|=
name|b
operator|->
name|cb_func
argument_list|(
name|b
operator|->
name|cb_baton
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|err2
operator|=
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|b
operator|->
name|drop_trigger
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err1
argument_list|,
name|err2
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Prototype for the "work callback" used by with_finalization().  */
end_comment

begin_typedef
typedef|typedef
name|svn_error_t
modifier|*
function_decl|(
modifier|*
name|work_callback_t
function_decl|)
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_typedef

begin_comment
comment|/* Utility function to provide several features, with a guaranteed    finalization (ie. to drop temporary tables).     1) for WCROOT and LOCAL_RELPATH, run TXN_CB(TXN_BATON) within a       sqlite transaction    2) if (1) is successful and a NOTIFY_FUNC is provided, then run       the "work" step: WORK_CB(WORK_BATON).    3) execute FINALIZE_STMT_IDX no matter what errors may be thrown       from the above two steps.     CANCEL_FUNC, CANCEL_BATON, NOTIFY_FUNC and NOTIFY_BATON are their    typical values. These are passed to the work callback, which typically    provides notification about the work done by TXN_CB.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|with_finalization
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_txn_callback_t
name|txn_cb
parameter_list|,
name|void
modifier|*
name|txn_baton
parameter_list|,
name|work_callback_t
name|work_cb
parameter_list|,
name|void
modifier|*
name|work_baton
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|int
name|finalize_stmt_idx
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err1
decl_stmt|;
name|svn_error_t
modifier|*
name|err2
decl_stmt|;
name|err1
operator|=
name|svn_wc__db_with_txn
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|txn_cb
argument_list|,
name|txn_baton
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err1
operator|==
name|NULL
operator|&&
name|notify_func
operator|!=
name|NULL
condition|)
block|{
name|err2
operator|=
name|work_cb
argument_list|(
name|work_baton
argument_list|,
name|wcroot
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|notify_func
argument_list|,
name|notify_baton
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|err1
operator|=
name|svn_error_compose_create
argument_list|(
name|err1
argument_list|,
name|err2
argument_list|)
expr_stmt|;
block|}
name|err2
operator|=
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|finalize_stmt_idx
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err1
argument_list|,
name|err2
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Initialize the baton with appropriate "blank" values. This allows the    insertion function to leave certain columns null.  */
end_comment

begin_function
specifier|static
name|void
name|blank_ieb
parameter_list|(
name|insert_external_baton_t
modifier|*
name|ieb
parameter_list|)
block|{
name|memset
argument_list|(
name|ieb
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ieb
argument_list|)
argument_list|)
expr_stmt|;
name|ieb
operator|->
name|revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|ieb
operator|->
name|changed_rev
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|ieb
operator|->
name|repos_id
operator|=
name|INVALID_REPOS_ID
expr_stmt|;
name|ieb
operator|->
name|recorded_peg_revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|ieb
operator|->
name|recorded_revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Insert the externals row represented by (insert_external_baton_t *) BATON.  *  * Implements svn_wc__db_txn_callback_t. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|insert_external_node
parameter_list|(
specifier|const
name|insert_external_baton_t
modifier|*
name|ieb
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_boolean_t
name|update_root
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
if|if
condition|(
name|ieb
operator|->
name|repos_id
operator|!=
name|INVALID_REPOS_ID
condition|)
name|repos_id
operator|=
name|ieb
operator|->
name|repos_id
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|create_repos_id
argument_list|(
operator|&
name|repos_id
argument_list|,
name|ieb
operator|->
name|repos_root_url
argument_list|,
name|ieb
operator|->
name|repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* And there must be no existing BASE node or it must be a file external */
name|err
operator|=
name|svn_wc__db_base_get_info_internal
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|update_root
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
name|err
operator|->
name|apr_err
operator|!=
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_normal
operator|&&
operator|!
name|update_root
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
if|if
condition|(
name|ieb
operator|->
name|kind
operator|==
name|svn_node_file
operator|||
name|ieb
operator|->
name|kind
operator|==
name|svn_node_symlink
condition|)
block|{
name|struct
name|insert_base_baton_t
name|ibb
decl_stmt|;
name|blank_ibb
argument_list|(
operator|&
name|ibb
argument_list|)
expr_stmt|;
name|ibb
operator|.
name|status
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|ibb
operator|.
name|kind
operator|=
name|ieb
operator|->
name|kind
expr_stmt|;
name|ibb
operator|.
name|repos_id
operator|=
name|repos_id
expr_stmt|;
name|ibb
operator|.
name|repos_relpath
operator|=
name|ieb
operator|->
name|repos_relpath
expr_stmt|;
name|ibb
operator|.
name|revision
operator|=
name|ieb
operator|->
name|revision
expr_stmt|;
name|ibb
operator|.
name|props
operator|=
name|ieb
operator|->
name|props
expr_stmt|;
name|ibb
operator|.
name|iprops
operator|=
name|ieb
operator|->
name|iprops
expr_stmt|;
name|ibb
operator|.
name|changed_rev
operator|=
name|ieb
operator|->
name|changed_rev
expr_stmt|;
name|ibb
operator|.
name|changed_date
operator|=
name|ieb
operator|->
name|changed_date
expr_stmt|;
name|ibb
operator|.
name|changed_author
operator|=
name|ieb
operator|->
name|changed_author
expr_stmt|;
name|ibb
operator|.
name|dav_cache
operator|=
name|ieb
operator|->
name|dav_cache
expr_stmt|;
name|ibb
operator|.
name|checksum
operator|=
name|ieb
operator|->
name|checksum
expr_stmt|;
name|ibb
operator|.
name|target
operator|=
name|ieb
operator|->
name|target
expr_stmt|;
name|ibb
operator|.
name|conflict
operator|=
name|ieb
operator|->
name|conflict
expr_stmt|;
name|ibb
operator|.
name|update_actual_props
operator|=
name|ieb
operator|->
name|update_actual_props
expr_stmt|;
name|ibb
operator|.
name|new_actual_props
operator|=
name|ieb
operator|->
name|new_actual_props
expr_stmt|;
name|ibb
operator|.
name|keep_recorded_info
operator|=
name|ieb
operator|->
name|keep_recorded_info
expr_stmt|;
name|ibb
operator|.
name|work_items
operator|=
name|ieb
operator|->
name|work_items
expr_stmt|;
name|ibb
operator|.
name|file_external
operator|=
name|TRUE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|insert_base_node
argument_list|(
operator|&
name|ibb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|ieb
operator|->
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* The externals table only support presence normal and excluded */
name|SVN_ERR_ASSERT
argument_list|(
name|ieb
operator|->
name|presence
operator|==
name|svn_wc__db_status_normal
operator|||
name|ieb
operator|->
name|presence
operator|==
name|svn_wc__db_status_excluded
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_EXTERNAL
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"issttsis"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|svn_relpath_dirname
argument_list|(
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|presence_map
argument_list|,
name|ieb
operator|->
name|presence
argument_list|,
name|kind_map
argument_list|,
name|ieb
operator|->
name|kind
argument_list|,
name|ieb
operator|->
name|record_ancestor_relpath
argument_list|,
name|repos_id
argument_list|,
name|ieb
operator|->
name|recorded_repos_relpath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|ieb
operator|->
name|recorded_peg_revision
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_revnum
argument_list|(
name|stmt
argument_list|,
literal|9
argument_list|,
name|ieb
operator|->
name|recorded_peg_revision
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|ieb
operator|->
name|recorded_revision
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_revnum
argument_list|(
name|stmt
argument_list|,
literal|10
argument_list|,
name|ieb
operator|->
name|recorded_revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__insert
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_external_add_file
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|apr_array_header_t
modifier|*
name|iprops
parameter_list|,
name|svn_revnum_t
name|changed_rev
parameter_list|,
name|apr_time_t
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
name|changed_author
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|dav_cache
parameter_list|,
specifier|const
name|char
modifier|*
name|record_ancestor_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|recorded_repos_relpath
parameter_list|,
name|svn_revnum_t
name|recorded_peg_revision
parameter_list|,
name|svn_revnum_t
name|recorded_revision
parameter_list|,
name|svn_boolean_t
name|update_actual_props
parameter_list|,
name|apr_hash_t
modifier|*
name|new_actual_props
parameter_list|,
name|svn_boolean_t
name|keep_recorded_info
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|insert_external_baton_t
name|ieb
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wri_abspath
condition|)
name|wri_abspath
operator|=
name|svn_dirent_dirname
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|record_ancestor_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
name|blank_ieb
argument_list|(
operator|&
name|ieb
argument_list|)
expr_stmt|;
name|ieb
operator|.
name|kind
operator|=
name|svn_node_file
expr_stmt|;
name|ieb
operator|.
name|presence
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|ieb
operator|.
name|repos_root_url
operator|=
name|repos_root_url
expr_stmt|;
name|ieb
operator|.
name|repos_uuid
operator|=
name|repos_uuid
expr_stmt|;
name|ieb
operator|.
name|repos_relpath
operator|=
name|repos_relpath
expr_stmt|;
name|ieb
operator|.
name|revision
operator|=
name|revision
expr_stmt|;
name|ieb
operator|.
name|props
operator|=
name|props
expr_stmt|;
name|ieb
operator|.
name|iprops
operator|=
name|iprops
expr_stmt|;
name|ieb
operator|.
name|changed_rev
operator|=
name|changed_rev
expr_stmt|;
name|ieb
operator|.
name|changed_date
operator|=
name|changed_date
expr_stmt|;
name|ieb
operator|.
name|changed_author
operator|=
name|changed_author
expr_stmt|;
name|ieb
operator|.
name|checksum
operator|=
name|checksum
expr_stmt|;
name|ieb
operator|.
name|dav_cache
operator|=
name|dav_cache
expr_stmt|;
name|ieb
operator|.
name|record_ancestor_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|record_ancestor_abspath
argument_list|)
expr_stmt|;
name|ieb
operator|.
name|recorded_repos_relpath
operator|=
name|recorded_repos_relpath
expr_stmt|;
name|ieb
operator|.
name|recorded_peg_revision
operator|=
name|recorded_peg_revision
expr_stmt|;
name|ieb
operator|.
name|recorded_revision
operator|=
name|recorded_revision
expr_stmt|;
name|ieb
operator|.
name|update_actual_props
operator|=
name|update_actual_props
expr_stmt|;
name|ieb
operator|.
name|new_actual_props
operator|=
name|new_actual_props
expr_stmt|;
name|ieb
operator|.
name|keep_recorded_info
operator|=
name|keep_recorded_info
expr_stmt|;
name|ieb
operator|.
name|conflict
operator|=
name|conflict
expr_stmt|;
name|ieb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_external_node
argument_list|(
operator|&
name|ieb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_external_add_symlink
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_revnum_t
name|changed_rev
parameter_list|,
name|apr_time_t
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
name|changed_author
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|dav_cache
parameter_list|,
specifier|const
name|char
modifier|*
name|record_ancestor_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|recorded_repos_relpath
parameter_list|,
name|svn_revnum_t
name|recorded_peg_revision
parameter_list|,
name|svn_revnum_t
name|recorded_revision
parameter_list|,
name|svn_boolean_t
name|update_actual_props
parameter_list|,
name|apr_hash_t
modifier|*
name|new_actual_props
parameter_list|,
name|svn_boolean_t
name|keep_recorded_info
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|insert_external_baton_t
name|ieb
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wri_abspath
condition|)
name|wri_abspath
operator|=
name|svn_dirent_dirname
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|record_ancestor_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
name|blank_ieb
argument_list|(
operator|&
name|ieb
argument_list|)
expr_stmt|;
name|ieb
operator|.
name|kind
operator|=
name|svn_node_symlink
expr_stmt|;
name|ieb
operator|.
name|presence
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|ieb
operator|.
name|repos_root_url
operator|=
name|repos_root_url
expr_stmt|;
name|ieb
operator|.
name|repos_uuid
operator|=
name|repos_uuid
expr_stmt|;
name|ieb
operator|.
name|repos_relpath
operator|=
name|repos_relpath
expr_stmt|;
name|ieb
operator|.
name|revision
operator|=
name|revision
expr_stmt|;
name|ieb
operator|.
name|props
operator|=
name|props
expr_stmt|;
name|ieb
operator|.
name|changed_rev
operator|=
name|changed_rev
expr_stmt|;
name|ieb
operator|.
name|changed_date
operator|=
name|changed_date
expr_stmt|;
name|ieb
operator|.
name|changed_author
operator|=
name|changed_author
expr_stmt|;
name|ieb
operator|.
name|target
operator|=
name|target
expr_stmt|;
name|ieb
operator|.
name|dav_cache
operator|=
name|dav_cache
expr_stmt|;
name|ieb
operator|.
name|record_ancestor_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|record_ancestor_abspath
argument_list|)
expr_stmt|;
name|ieb
operator|.
name|recorded_repos_relpath
operator|=
name|recorded_repos_relpath
expr_stmt|;
name|ieb
operator|.
name|recorded_peg_revision
operator|=
name|recorded_peg_revision
expr_stmt|;
name|ieb
operator|.
name|recorded_revision
operator|=
name|recorded_revision
expr_stmt|;
name|ieb
operator|.
name|update_actual_props
operator|=
name|update_actual_props
expr_stmt|;
name|ieb
operator|.
name|new_actual_props
operator|=
name|new_actual_props
expr_stmt|;
name|ieb
operator|.
name|keep_recorded_info
operator|=
name|keep_recorded_info
expr_stmt|;
name|ieb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_external_node
argument_list|(
operator|&
name|ieb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_external_add_dir
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
specifier|const
name|char
modifier|*
name|record_ancestor_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|recorded_repos_relpath
parameter_list|,
name|svn_revnum_t
name|recorded_peg_revision
parameter_list|,
name|svn_revnum_t
name|recorded_revision
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|insert_external_baton_t
name|ieb
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wri_abspath
condition|)
name|wri_abspath
operator|=
name|svn_dirent_dirname
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|record_ancestor_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
name|blank_ieb
argument_list|(
operator|&
name|ieb
argument_list|)
expr_stmt|;
name|ieb
operator|.
name|kind
operator|=
name|svn_node_dir
expr_stmt|;
name|ieb
operator|.
name|presence
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|ieb
operator|.
name|repos_root_url
operator|=
name|repos_root_url
expr_stmt|;
name|ieb
operator|.
name|repos_uuid
operator|=
name|repos_uuid
expr_stmt|;
name|ieb
operator|.
name|record_ancestor_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|record_ancestor_abspath
argument_list|)
expr_stmt|;
name|ieb
operator|.
name|recorded_repos_relpath
operator|=
name|recorded_repos_relpath
expr_stmt|;
name|ieb
operator|.
name|recorded_peg_revision
operator|=
name|recorded_peg_revision
expr_stmt|;
name|ieb
operator|.
name|recorded_revision
operator|=
name|recorded_revision
expr_stmt|;
name|ieb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_external_node
argument_list|(
operator|&
name|ieb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_external_remove(). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_external_remove
parameter_list|(
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_EXTERNAL
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### What about actual? */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_external_remove
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wri_abspath
condition|)
name|wri_abspath
operator|=
name|svn_dirent_dirname
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|db_external_remove
argument_list|(
name|work_items
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_external_read
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|definining_abspath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_uuid
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|recorded_repos_relpath
parameter_list|,
name|svn_revnum_t
modifier|*
name|recorded_peg_revision
parameter_list|,
name|svn_revnum_t
modifier|*
name|recorded_revision
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_info
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wri_abspath
condition|)
name|wri_abspath
operator|=
name|svn_dirent_dirname
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_EXTERNAL_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_info
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_info
condition|)
block|{
if|if
condition|(
name|status
condition|)
operator|*
name|status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
condition|)
operator|*
name|kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|definining_abspath
condition|)
block|{
specifier|const
name|char
modifier|*
name|record_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
operator|*
name|definining_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|record_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|repos_root_url
operator|||
name|repos_uuid
condition|)
block|{
name|apr_int64_t
name|repos_id
decl_stmt|;
name|repos_id
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_wc__db_fetch_repos_info
argument_list|(
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|repos_id
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|recorded_repos_relpath
condition|)
operator|*
name|recorded_repos_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|recorded_peg_revision
condition|)
operator|*
name|recorded_peg_revision
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|recorded_revision
condition|)
operator|*
name|recorded_revision
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' is not an external."
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_committable_externals_below
parameter_list|(
name|apr_array_header_t
modifier|*
modifier|*
name|externals
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|immediates_only
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_wc__committable_external_info_t
modifier|*
name|info
decl_stmt|;
name|svn_node_kind_t
name|db_kind
decl_stmt|;
name|apr_array_header_t
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|immediates_only
condition|?
name|STMT_SELECT_COMMITTABLE_EXTERNALS_IMMEDIATELY_BELOW
else|:
name|STMT_SELECT_COMMITTABLE_EXTERNALS_BELOW
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
name|result
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_wc__committable_external_info_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|info
operator|=
name|apr_palloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|info
operator|->
name|local_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|db_kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|db_kind
operator|==
name|svn_node_file
operator|||
name|db_kind
operator|==
name|svn_node_dir
argument_list|)
expr_stmt|;
name|info
operator|->
name|kind
operator|=
name|db_kind
expr_stmt|;
name|info
operator|->
name|repos_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|info
operator|->
name|repos_root_url
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|result
argument_list|,
name|svn_wc__committable_external_info_t
operator|*
argument_list|)
operator|=
name|info
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|externals
operator|=
name|result
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_externals_defined_below
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|externals
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_EXTERNALS_DEFINED
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|externals
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|def_local_relpath
decl_stmt|;
name|local_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|def_local_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
operator|*
name|externals
argument_list|,
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|)
argument_list|,
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|def_local_relpath
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_externals_gather_definitions
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|externals
parameter_list|,
name|apr_hash_t
modifier|*
modifier|*
name|depths
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
operator|*
name|externals
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|depths
operator|!=
name|NULL
condition|)
operator|*
name|depths
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_EXTERNAL_PROPERTIES
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|apr_hash_t
modifier|*
name|node_props
decl_stmt|;
specifier|const
name|char
modifier|*
name|external_value
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_sqlite__column_properties
argument_list|(
operator|&
name|node_props
argument_list|,
name|stmt
argument_list|,
literal|0
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
name|external_value
operator|=
name|svn_prop_get_value
argument_list|(
name|node_props
argument_list|,
name|SVN_PROP_EXTERNALS
argument_list|)
expr_stmt|;
if|if
condition|(
name|external_value
condition|)
block|{
specifier|const
name|char
modifier|*
name|node_abspath
decl_stmt|;
specifier|const
name|char
modifier|*
name|node_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|node_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|node_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
operator|*
name|externals
argument_list|,
name|node_abspath
argument_list|,
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|external_value
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|depths
condition|)
block|{
name|svn_depth_t
name|depth
init|=
name|svn_sqlite__column_token_null
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|depth_map
argument_list|,
name|svn_depth_unknown
argument_list|)
decl_stmt|;
name|svn_hash_sets
argument_list|(
operator|*
name|depths
argument_list|,
name|node_abspath
argument_list|,
comment|/* Use static string */
name|svn_token__to_word
argument_list|(
name|depth_map
argument_list|,
name|depth
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Copy the ACTUAL data for SRC_RELPATH and tweak it to refer to DST_RELPATH.    The new ACTUAL data won't have any conflicts. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|copy_actual
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|src_wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|dst_wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|src_wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ACTUAL_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|src_wcroot
operator|->
name|wc_id
argument_list|,
name|src_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|apr_size_t
name|props_size
decl_stmt|;
specifier|const
name|char
modifier|*
name|changelist
decl_stmt|;
specifier|const
name|char
modifier|*
name|properties
decl_stmt|;
comment|/* Skipping conflict data... */
name|changelist
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* No need to parse the properties when simply copying. */
name|properties
operator|=
name|svn_sqlite__column_blob
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
operator|&
name|props_size
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|changelist
operator|||
name|properties
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|dst_wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_ACTUAL_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"issbs"
argument_list|,
name|dst_wcroot
operator|->
name|wc_id
argument_list|,
name|dst_relpath
argument_list|,
name|svn_relpath_dirname
argument_list|(
name|dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|properties
argument_list|,
name|props_size
argument_list|,
name|changelist
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Helper for svn_wc__db_op_copy to handle copying from one db to    another */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|cross_db_copy
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|src_wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|dst_wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|svn_wc__db_status_t
name|dst_status
parameter_list|,
name|int
name|dst_op_depth
parameter_list|,
name|int
name|dst_np_op_depth
parameter_list|,
name|svn_node_kind_t
name|kind
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|children
parameter_list|,
name|apr_int64_t
name|copyfrom_id
parameter_list|,
specifier|const
name|char
modifier|*
name|copyfrom_relpath
parameter_list|,
name|svn_revnum_t
name|copyfrom_rev
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|insert_working_baton_t
name|iwb
decl_stmt|;
name|svn_revnum_t
name|changed_rev
decl_stmt|;
name|apr_time_t
name|changed_date
decl_stmt|;
specifier|const
name|char
modifier|*
name|changed_author
decl_stmt|;
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
name|apr_hash_t
modifier|*
name|props
decl_stmt|;
name|svn_depth_t
name|depth
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|kind
operator|==
name|svn_node_file
operator|||
name|kind
operator|==
name|svn_node_dir
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|read_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|changed_rev
argument_list|,
operator|&
name|changed_date
argument_list|,
operator|&
name|changed_author
argument_list|,
operator|&
name|depth
argument_list|,
operator|&
name|checksum
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst_status
operator|!=
name|svn_wc__db_status_not_present
operator|&&
name|dst_status
operator|!=
name|svn_wc__db_status_excluded
operator|&&
name|dst_status
operator|!=
name|svn_wc__db_status_server_excluded
condition|)
block|{
name|SVN_ERR
argument_list|(
name|db_read_pristine_props
argument_list|(
operator|&
name|props
argument_list|,
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|props
operator|=
name|NULL
expr_stmt|;
name|blank_iwb
argument_list|(
operator|&
name|iwb
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|presence
operator|=
name|dst_status
expr_stmt|;
name|iwb
operator|.
name|kind
operator|=
name|kind
expr_stmt|;
name|iwb
operator|.
name|props
operator|=
name|props
expr_stmt|;
name|iwb
operator|.
name|changed_rev
operator|=
name|changed_rev
expr_stmt|;
name|iwb
operator|.
name|changed_date
operator|=
name|changed_date
expr_stmt|;
name|iwb
operator|.
name|changed_author
operator|=
name|changed_author
expr_stmt|;
name|iwb
operator|.
name|original_repos_id
operator|=
name|copyfrom_id
expr_stmt|;
name|iwb
operator|.
name|original_repos_relpath
operator|=
name|copyfrom_relpath
expr_stmt|;
name|iwb
operator|.
name|original_revnum
operator|=
name|copyfrom_rev
expr_stmt|;
name|iwb
operator|.
name|moved_here
operator|=
name|FALSE
expr_stmt|;
name|iwb
operator|.
name|op_depth
operator|=
name|dst_op_depth
expr_stmt|;
name|iwb
operator|.
name|checksum
operator|=
name|checksum
expr_stmt|;
name|iwb
operator|.
name|children
operator|=
name|children
expr_stmt|;
name|iwb
operator|.
name|depth
operator|=
name|depth
expr_stmt|;
name|iwb
operator|.
name|not_present_op_depth
operator|=
name|dst_np_op_depth
expr_stmt|;
name|SVN_ERR
argument_list|(
name|insert_working_node
argument_list|(
operator|&
name|iwb
argument_list|,
name|dst_wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|copy_actual
argument_list|(
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|dst_wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Helper for scan_deletion_txn. Extracts the moved-to information, if    any, from STMT.  Sets *SCAN to FALSE if moved-to was available. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_moved_to
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|moved_to_relpath_p
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|moved_to_op_root_relpath_p
parameter_list|,
name|svn_boolean_t
modifier|*
name|scan
parameter_list|,
name|svn_sqlite__stmt_t
modifier|*
name|stmt
parameter_list|,
specifier|const
name|char
modifier|*
name|current_relpath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|moved_to_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|moved_to_relpath
condition|)
block|{
specifier|const
name|char
modifier|*
name|moved_to_op_root_relpath
init|=
name|moved_to_relpath
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|current_relpath
argument_list|,
name|local_relpath
argument_list|)
condition|)
block|{
comment|/* LOCAL_RELPATH is a child inside the move op-root. */
specifier|const
name|char
modifier|*
name|moved_child_relpath
decl_stmt|;
comment|/* The CURRENT_RELPATH is the op_root of the delete-half of            * the move. LOCAL_RELPATH is a child that was moved along.            * Compute the child's new location within the move target. */
name|moved_child_relpath
operator|=
name|svn_relpath_skip_ancestor
argument_list|(
name|current_relpath
argument_list|,
name|local_relpath
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|moved_child_relpath
operator|&&
name|strlen
argument_list|(
name|moved_child_relpath
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|moved_to_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|moved_to_op_root_relpath
argument_list|,
name|moved_child_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|moved_to_op_root_relpath
operator|&&
name|moved_to_op_root_relpath_p
condition|)
operator|*
name|moved_to_op_root_relpath_p
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|moved_to_op_root_relpath
argument_list|)
expr_stmt|;
if|if
condition|(
name|moved_to_relpath
operator|&&
name|moved_to_relpath_p
condition|)
operator|*
name|moved_to_relpath_p
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|moved_to_relpath
argument_list|)
expr_stmt|;
operator|*
name|scan
operator|=
name|FALSE
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_scan_deletion().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|scan_deletion_txn
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|base_del_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|moved_to_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|work_del_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|moved_to_op_root_relpath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|current_relpath
init|=
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_wc__db_status_t
name|work_presence
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|,
name|scan
decl_stmt|,
name|have_base
decl_stmt|;
name|int
name|op_depth
decl_stmt|;
comment|/* Initialize all the OUT parameters.  */
if|if
condition|(
name|base_del_relpath
operator|!=
name|NULL
condition|)
operator|*
name|base_del_relpath
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|moved_to_relpath
operator|!=
name|NULL
condition|)
operator|*
name|moved_to_relpath
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|work_del_relpath
operator|!=
name|NULL
condition|)
operator|*
name|work_del_relpath
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|moved_to_op_root_relpath
operator|!=
name|NULL
condition|)
operator|*
name|moved_to_op_root_relpath
operator|=
name|NULL
expr_stmt|;
comment|/* If looking for moved-to info then we need to scan every path      until we find it.  If not looking for moved-to we only need to      check op-roots and parents of op-roots. */
name|scan
operator|=
operator|(
name|moved_to_op_root_relpath
operator|||
name|moved_to_relpath
operator|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|scan
condition|?
name|STMT_SELECT_DELETION_INFO_SCAN
else|:
name|STMT_SELECT_DELETION_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|current_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|work_presence
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
name|have_base
operator|=
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|work_presence
operator|!=
name|svn_wc__db_status_not_present
operator|&&
name|work_presence
operator|!=
name|svn_wc__db_status_base_deleted
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Expected node '%s' to be deleted."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Special case: LOCAL_RELPATH not-present within a WORKING tree, we      treat this as an op-root.  At commit time we need to explicitly      delete such nodes otherwise they will be present in the      repository copy. */
if|if
condition|(
name|work_presence
operator|==
name|svn_wc__db_status_not_present
operator|&&
name|work_del_relpath
operator|&&
operator|!
operator|*
name|work_del_relpath
condition|)
block|{
operator|*
name|work_del_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|current_relpath
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|scan
operator|&&
operator|!
name|base_del_relpath
condition|)
block|{
comment|/* We have all we need, exit early */
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
while|while
condition|(
name|TRUE
condition|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
specifier|const
name|char
modifier|*
name|parent_relpath
decl_stmt|;
name|int
name|current_depth
init|=
name|relpath_depth
argument_list|(
name|current_relpath
argument_list|)
decl_stmt|;
comment|/* Step CURRENT_RELPATH to op-root */
while|while
condition|(
name|TRUE
condition|)
block|{
if|if
condition|(
name|scan
condition|)
block|{
name|err
operator|=
name|get_moved_to
argument_list|(
name|moved_to_relpath
argument_list|,
name|moved_to_op_root_relpath
argument_list|,
operator|&
name|scan
argument_list|,
name|stmt
argument_list|,
name|current_relpath
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|(
operator|!
name|scan
operator|&&
operator|!
name|base_del_relpath
operator|&&
operator|!
name|work_del_relpath
operator|)
condition|)
block|{
comment|/* We have all we need (or an error occurred) */
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
block|}
if|if
condition|(
name|current_depth
operator|<=
name|op_depth
condition|)
break|break;
name|current_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|current_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|--
name|current_depth
expr_stmt|;
if|if
condition|(
name|scan
operator|||
name|current_depth
operator|==
name|op_depth
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|current_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|have_row
argument_list|)
expr_stmt|;
name|have_base
operator|=
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Now CURRENT_RELPATH is an op-root, have a look at the parent. */
name|SVN_ERR_ASSERT
argument_list|(
name|current_relpath
index|[
literal|0
index|]
operator|!=
literal|'\0'
argument_list|)
expr_stmt|;
comment|/* Catch invalid data */
name|parent_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|current_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|parent_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
comment|/* No row means no WORKING node which mean we just fell off              the WORKING tree, so CURRENT_RELPATH is the op-root              closest to the wc root. */
if|if
condition|(
name|have_base
operator|&&
name|base_del_relpath
condition|)
operator|*
name|base_del_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|current_relpath
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Still in the WORKING tree so the first time we get here          CURRENT_RELPATH is a delete op-root in the WORKING tree. */
if|if
condition|(
name|work_del_relpath
operator|&&
operator|!
operator|*
name|work_del_relpath
condition|)
block|{
operator|*
name|work_del_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|current_relpath
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|scan
operator|&&
operator|!
name|base_del_relpath
condition|)
break|break;
comment|/* We have all we need */
block|}
name|current_relpath
operator|=
name|parent_relpath
expr_stmt|;
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|have_base
operator|=
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_scan_deletion
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|base_del_abspath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|moved_to_abspath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|work_del_abspath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|moved_to_op_root_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|base_del_relpath
decl_stmt|,
modifier|*
name|moved_to_relpath
decl_stmt|,
modifier|*
name|work_del_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_to_op_root_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|scan_deletion_txn
argument_list|(
operator|&
name|base_del_relpath
argument_list|,
operator|&
name|moved_to_relpath
argument_list|,
operator|&
name|work_del_relpath
argument_list|,
operator|&
name|moved_to_op_root_relpath
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
name|base_del_abspath
condition|)
block|{
operator|*
name|base_del_abspath
operator|=
operator|(
name|base_del_relpath
condition|?
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|base_del_relpath
argument_list|,
name|result_pool
argument_list|)
else|:
name|NULL
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|moved_to_abspath
condition|)
block|{
operator|*
name|moved_to_abspath
operator|=
operator|(
name|moved_to_relpath
condition|?
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|moved_to_relpath
argument_list|,
name|result_pool
argument_list|)
else|:
name|NULL
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|work_del_abspath
condition|)
block|{
operator|*
name|work_del_abspath
operator|=
operator|(
name|work_del_relpath
condition|?
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|work_del_relpath
argument_list|,
name|result_pool
argument_list|)
else|:
name|NULL
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|moved_to_op_root_abspath
condition|)
block|{
operator|*
name|moved_to_op_root_abspath
operator|=
operator|(
name|moved_to_op_root_relpath
condition|?
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|moved_to_op_root_relpath
argument_list|,
name|result_pool
argument_list|)
else|:
name|NULL
operator|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Set *COPYFROM_ID, *COPYFROM_RELPATH, *COPYFROM_REV to the values    appropriate for the copy. Also return *STATUS, *KIND and *HAVE_WORK, *OP_ROOT    since they are available.  This is a helper for    svn_wc__db_op_copy. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_info_for_copy
parameter_list|(
name|apr_int64_t
modifier|*
name|copyfrom_id
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|copyfrom_relpath
parameter_list|,
name|svn_revnum_t
modifier|*
name|copyfrom_rev
parameter_list|,
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_boolean_t
modifier|*
name|op_root
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|src_wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|dst_wcroot
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
name|svn_revnum_t
name|revision
decl_stmt|;
name|svn_wc__db_status_t
name|node_status
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
name|svn_boolean_t
name|is_op_root
decl_stmt|;
name|SVN_ERR
argument_list|(
name|read_info
argument_list|(
operator|&
name|node_status
argument_list|,
name|kind
argument_list|,
operator|&
name|revision
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|copyfrom_relpath
argument_list|,
name|copyfrom_id
argument_list|,
name|copyfrom_rev
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|is_op_root
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
comment|/* have_base */
argument_list|,
name|NULL
comment|/* have_more_work */
argument_list|,
name|NULL
comment|/* have_work */
argument_list|,
name|src_wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_root
condition|)
operator|*
name|op_root
operator|=
name|is_op_root
expr_stmt|;
if|if
condition|(
name|node_status
operator|==
name|svn_wc__db_status_excluded
condition|)
block|{
comment|/* The parent cannot be excluded, so look at the parent and then          adjust the relpath */
specifier|const
name|char
modifier|*
name|parent_relpath
decl_stmt|,
modifier|*
name|base_name
decl_stmt|;
name|svn_dirent_split
argument_list|(
operator|&
name|parent_relpath
argument_list|,
operator|&
name|base_name
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|get_info_for_copy
argument_list|(
name|copyfrom_id
argument_list|,
name|copyfrom_relpath
argument_list|,
name|copyfrom_rev
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|src_wcroot
argument_list|,
name|parent_relpath
argument_list|,
name|dst_wcroot
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|copyfrom_relpath
condition|)
operator|*
name|copyfrom_relpath
operator|=
name|svn_relpath_join
argument_list|(
operator|*
name|copyfrom_relpath
argument_list|,
name|base_name
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|node_status
operator|==
name|svn_wc__db_status_added
condition|)
block|{
name|SVN_ERR
argument_list|(
name|scan_addition
argument_list|(
operator|&
name|node_status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|src_wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|node_status
operator|==
name|svn_wc__db_status_deleted
operator|&&
name|is_op_root
condition|)
block|{
specifier|const
name|char
modifier|*
name|base_del_relpath
decl_stmt|,
modifier|*
name|work_del_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|scan_deletion_txn
argument_list|(
operator|&
name|base_del_relpath
argument_list|,
name|NULL
argument_list|,
operator|&
name|work_del_relpath
argument_list|,
name|NULL
argument_list|,
name|src_wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|work_del_relpath
condition|)
block|{
specifier|const
name|char
modifier|*
name|op_root_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|parent_del_relpath
init|=
name|svn_relpath_dirname
argument_list|(
name|work_del_relpath
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
comment|/* Similar to, but not the same as, the _scan_addition and              _join above.  Can we use get_copyfrom here? */
name|SVN_ERR
argument_list|(
name|scan_addition
argument_list|(
name|NULL
argument_list|,
operator|&
name|op_root_relpath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* repos_* */
name|copyfrom_relpath
argument_list|,
name|copyfrom_id
argument_list|,
name|copyfrom_rev
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|src_wcroot
argument_list|,
name|parent_del_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|copyfrom_relpath
operator|=
name|svn_relpath_join
argument_list|(
operator|*
name|copyfrom_relpath
argument_list|,
name|svn_relpath_skip_ancestor
argument_list|(
name|op_root_relpath
argument_list|,
name|local_relpath
argument_list|)
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|base_del_relpath
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|copyfrom_rev
argument_list|,
name|copyfrom_relpath
argument_list|,
name|copyfrom_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|src_wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|node_status
operator|==
name|svn_wc__db_status_deleted
condition|)
block|{
comment|/* Keep original_* from read_info() to allow seeing the difference          between base-deleted and not present */
block|}
else|else
block|{
operator|*
name|copyfrom_relpath
operator|=
name|repos_relpath
expr_stmt|;
operator|*
name|copyfrom_rev
operator|=
name|revision
expr_stmt|;
operator|*
name|copyfrom_id
operator|=
name|repos_id
expr_stmt|;
block|}
if|if
condition|(
name|status
condition|)
operator|*
name|status
operator|=
name|node_status
expr_stmt|;
if|if
condition|(
name|src_wcroot
operator|!=
name|dst_wcroot
operator|&&
operator|*
name|copyfrom_relpath
condition|)
block|{
specifier|const
name|char
modifier|*
name|repos_root_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_uuid
decl_stmt|;
comment|/* Pass the right repos-id for the destination db. We can't just use          the id of the source database, as this value can change after          relocation (and perhaps also when we start storing multiple          working copies in a single db)! */
name|SVN_ERR
argument_list|(
name|svn_wc__db_fetch_repos_info
argument_list|(
operator|&
name|repos_root_url
argument_list|,
operator|&
name|repos_uuid
argument_list|,
name|src_wcroot
operator|->
name|sdb
argument_list|,
operator|*
name|copyfrom_id
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|create_repos_id
argument_list|(
name|copyfrom_id
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|dst_wcroot
operator|->
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Set *OP_DEPTH to the highest op depth of WCROOT:LOCAL_RELPATH. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|op_depth_of
parameter_list|(
name|int
modifier|*
name|op_depth
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|have_row
argument_list|)
expr_stmt|;
operator|*
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Determine at which OP_DEPTH a copy of COPYFROM_REPOS_ID, COPYFROM_RELPATH at    revision COPYFROM_REVISION should be inserted as LOCAL_RELPATH. Do this    by checking if this would be a direct child of a copy of its parent    directory. If it is then set *OP_DEPTH to the op_depth of its parent.     If the node is not a direct copy at the same revision of the parent    *NP_OP_DEPTH will be set to the op_depth of the parent when a not-present    node should be inserted at this op_depth. This will be the case when the    parent already defined an incomplete child with the same name. Otherwise    *NP_OP_DEPTH will be set to -1.     If the parent node is not the parent of the to be copied node, then    *OP_DEPTH will be set to the proper op_depth for a new operation root.     Set *PARENT_OP_DEPTH to the op_depth of the parent.   */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|op_depth_for_copy
parameter_list|(
name|int
modifier|*
name|op_depth
parameter_list|,
name|int
modifier|*
name|np_op_depth
parameter_list|,
name|int
modifier|*
name|parent_op_depth
parameter_list|,
name|apr_int64_t
name|copyfrom_repos_id
parameter_list|,
specifier|const
name|char
modifier|*
name|copyfrom_relpath
parameter_list|,
name|svn_revnum_t
name|copyfrom_revision
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|parent_relpath
decl_stmt|,
modifier|*
name|name
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|incomplete_op_depth
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|min_op_depth
init|=
literal|1
decl_stmt|;
comment|/* Never touch BASE */
operator|*
name|op_depth
operator|=
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
expr_stmt|;
operator|*
name|np_op_depth
operator|=
operator|-
literal|1
expr_stmt|;
name|svn_relpath_split
argument_list|(
operator|&
name|parent_relpath
argument_list|,
operator|&
name|name
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|*
name|parent_op_depth
operator|=
name|relpath_depth
argument_list|(
name|parent_relpath
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|copyfrom_relpath
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|svn_wc__db_status_t
name|status
init|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|presence_map
argument_list|)
decl_stmt|;
name|min_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_incomplete
condition|)
name|incomplete_op_depth
operator|=
name|min_op_depth
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|parent_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|svn_wc__db_status_t
name|presence
init|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|presence_map
argument_list|)
decl_stmt|;
operator|*
name|parent_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|parent_op_depth
operator|<
name|min_op_depth
condition|)
block|{
comment|/* We want to create a copy; not overwrite the lower layers */
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
comment|/* You can only add children below a node that exists.          In WORKING that must be status added, which is represented          as presence normal */
name|SVN_ERR_ASSERT
argument_list|(
name|presence
operator|==
name|svn_wc__db_status_normal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|incomplete_op_depth
operator|<
literal|0
operator|)
operator|||
operator|(
name|incomplete_op_depth
operator|==
operator|*
name|parent_op_depth
operator|)
condition|)
block|{
name|apr_int64_t
name|parent_copyfrom_repos_id
init|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|10
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|parent_copyfrom_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|11
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|svn_revnum_t
name|parent_copyfrom_revision
init|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|12
argument_list|)
decl_stmt|;
if|if
condition|(
name|parent_copyfrom_repos_id
operator|==
name|copyfrom_repos_id
condition|)
block|{
if|if
condition|(
name|copyfrom_revision
operator|==
name|parent_copyfrom_revision
operator|&&
operator|!
name|strcmp
argument_list|(
name|copyfrom_relpath
argument_list|,
name|svn_relpath_join
argument_list|(
name|parent_copyfrom_relpath
argument_list|,
name|name
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
condition|)
operator|*
name|op_depth
operator|=
operator|*
name|parent_op_depth
expr_stmt|;
elseif|else
if|if
condition|(
name|incomplete_op_depth
operator|>
literal|0
condition|)
operator|*
name|np_op_depth
operator|=
name|incomplete_op_depth
expr_stmt|;
block|}
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Like svn_wc__db_op_copy(), but with WCROOT+LOCAL_RELPATH  * instead of DB+LOCAL_ABSPATH. A non-zero MOVE_OP_DEPTH implies that the  * copy operation is part of a move, and indicates the op-depth of the  * move destination op-root. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_op_copy
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|src_wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|dst_wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|int
name|move_op_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|copyfrom_relpath
decl_stmt|;
name|svn_revnum_t
name|copyfrom_rev
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_wc__db_status_t
name|dst_presence
decl_stmt|;
name|svn_boolean_t
name|op_root
decl_stmt|;
name|apr_int64_t
name|copyfrom_id
decl_stmt|;
name|int
name|dst_op_depth
decl_stmt|;
name|int
name|dst_np_op_depth
decl_stmt|;
name|int
name|dst_parent_op_depth
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
specifier|const
name|apr_array_header_t
modifier|*
name|children
decl_stmt|;
name|SVN_ERR
argument_list|(
name|get_info_for_copy
argument_list|(
operator|&
name|copyfrom_id
argument_list|,
operator|&
name|copyfrom_relpath
argument_list|,
operator|&
name|copyfrom_rev
argument_list|,
operator|&
name|status
argument_list|,
operator|&
name|kind
argument_list|,
operator|&
name|op_root
argument_list|,
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|dst_wcroot
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|op_depth_for_copy
argument_list|(
operator|&
name|dst_op_depth
argument_list|,
operator|&
name|dst_np_op_depth
argument_list|,
operator|&
name|dst_parent_op_depth
argument_list|,
name|copyfrom_id
argument_list|,
name|copyfrom_relpath
argument_list|,
name|copyfrom_rev
argument_list|,
name|dst_wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|kind
operator|==
name|svn_node_file
operator|||
name|kind
operator|==
name|svn_node_dir
argument_list|)
expr_stmt|;
comment|/* ### New status, not finished, see notes/wc-ng/copying */
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|svn_wc__db_status_normal
case|:
case|case
name|svn_wc__db_status_added
case|:
case|case
name|svn_wc__db_status_moved_here
case|:
case|case
name|svn_wc__db_status_copied
case|:
name|dst_presence
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
break|break;
case|case
name|svn_wc__db_status_deleted
case|:
if|if
condition|(
name|op_root
condition|)
block|{
comment|/* If the lower layer is already shadowcopied we can skip adding              a not present node. */
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_wc__db_status_t
name|dst_status
decl_stmt|;
name|err
operator|=
name|read_info
argument_list|(
operator|&
name|dst_status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|dst_wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
else|else
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|dst_status
operator|==
name|svn_wc__db_status_deleted
condition|)
block|{
comment|/* Node is already deleted; skip the NODES work, but do                  install wq items if requested */
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|dst_wcroot
operator|->
name|sdb
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
else|else
block|{
comment|/* This node is either a not-present node (which should be copied), or              a base-delete of some lower layer (which shouldn't).              Subversion<= 1.7 always added a not-present node here, which is              safe (as it postpones the hard work until commit time and then we              ask the repository), but it breaks some move scenarios.              */
if|if
condition|(
operator|!
name|copyfrom_relpath
condition|)
block|{
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|dst_wcroot
operator|->
name|sdb
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
comment|/* Fall through. Install not present node */
block|}
case|case
name|svn_wc__db_status_not_present
case|:
case|case
name|svn_wc__db_status_excluded
case|:
comment|/* These presence values should not create a new op depth */
if|if
condition|(
name|dst_np_op_depth
operator|>
literal|0
condition|)
block|{
name|dst_op_depth
operator|=
name|dst_np_op_depth
expr_stmt|;
name|dst_np_op_depth
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_excluded
condition|)
name|dst_presence
operator|=
name|svn_wc__db_status_excluded
expr_stmt|;
else|else
name|dst_presence
operator|=
name|svn_wc__db_status_not_present
expr_stmt|;
break|break;
case|case
name|svn_wc__db_status_server_excluded
case|:
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Cannot copy '%s' excluded by server"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
default|default:
comment|/* Perhaps we should allow incomplete to incomplete? We can't          avoid incomplete working nodes as one step in copying a          directory is to add incomplete children. */
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Cannot handle status of '%s'"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|kind
operator|==
name|svn_node_dir
condition|)
block|{
name|int
name|src_op_depth
decl_stmt|;
name|SVN_ERR
argument_list|(
name|op_depth_of
argument_list|(
operator|&
name|src_op_depth
argument_list|,
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|gather_repo_children
argument_list|(
operator|&
name|children
argument_list|,
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|src_op_depth
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|children
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|src_wcroot
operator|==
name|dst_wcroot
condition|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
specifier|const
name|char
modifier|*
name|dst_parent_relpath
init|=
name|svn_relpath_dirname
argument_list|(
name|dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|src_wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_WORKING_NODE_COPY_FROM
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"issdst"
argument_list|,
name|src_wcroot
operator|->
name|wc_id
argument_list|,
name|src_relpath
argument_list|,
name|dst_relpath
argument_list|,
name|dst_op_depth
argument_list|,
name|dst_parent_relpath
argument_list|,
name|presence_map
argument_list|,
name|dst_presence
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|move_op_depth
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|relpath_depth
argument_list|(
name|dst_relpath
argument_list|)
operator|==
name|move_op_depth
condition|)
block|{
comment|/* We're moving the root of the move operation.                *                * When an added node or the op-root of a copy is moved,                * there is no 'moved-from' corresponding to the moved-here                * node. So the net effect is the same as copy+delete.                * Perform a normal copy operation in these cases. */
if|if
condition|(
operator|!
operator|(
name|status
operator|==
name|svn_wc__db_status_added
operator|||
operator|(
name|status
operator|==
name|svn_wc__db_status_copied
operator|&&
name|op_root
operator|)
operator|)
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int
argument_list|(
name|stmt
argument_list|,
literal|7
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|svn_sqlite__stmt_t
modifier|*
name|info_stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
comment|/* We're moving a child along with the root of the move.                *                * Set moved-here depending on dst_parent, propagating the                * above decision to moved-along children at the same op_depth.                * We can't use scan_addition() to detect moved-here because                * the delete-half of the move might not yet exist. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|info_stmt
argument_list|,
name|dst_wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|info_stmt
argument_list|,
literal|"is"
argument_list|,
name|dst_wcroot
operator|->
name|wc_id
argument_list|,
name|dst_parent_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|info_stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|have_row
argument_list|)
expr_stmt|;
if|if
condition|(
name|svn_sqlite__column_boolean
argument_list|(
name|info_stmt
argument_list|,
literal|15
argument_list|)
operator|&&
name|dst_op_depth
operator|==
name|dst_parent_op_depth
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int
argument_list|(
name|stmt
argument_list|,
literal|7
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|info_stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|info_stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If the child has been moved into the tree we're moving,                    * keep its moved-here bit set. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|info_stmt
argument_list|,
name|dst_wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|info_stmt
argument_list|,
literal|"is"
argument_list|,
name|dst_wcroot
operator|->
name|wc_id
argument_list|,
name|src_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|info_stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|have_row
argument_list|)
expr_stmt|;
if|if
condition|(
name|svn_sqlite__column_boolean
argument_list|(
name|info_stmt
argument_list|,
literal|15
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int
argument_list|(
name|stmt
argument_list|,
literal|7
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|info_stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### Copying changelist is OK for a move but what about a copy? */
name|SVN_ERR
argument_list|(
name|copy_actual
argument_list|(
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|dst_wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst_np_op_depth
operator|>
literal|0
condition|)
block|{
comment|/* We introduce a not-present node at the parent's op_depth to              properly start a new op-depth at our own op_depth. This marks              us as an op_root for commit and allows reverting just this              operation */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|dst_wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdsisrtnt"
argument_list|,
name|src_wcroot
operator|->
name|wc_id
argument_list|,
name|dst_relpath
argument_list|,
name|dst_np_op_depth
argument_list|,
name|dst_parent_relpath
argument_list|,
name|copyfrom_id
argument_list|,
name|copyfrom_relpath
argument_list|,
name|copyfrom_rev
argument_list|,
name|presence_map
argument_list|,
name|svn_wc__db_status_not_present
argument_list|,
comment|/* NULL */
name|kind_map
argument_list|,
name|kind
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Insert incomplete children, if relevant.          The children are part of the same op and so have the same op_depth.          (The only time we'd want a different depth is during a recursive          simple add, but we never insert children here during a simple add.) */
if|if
condition|(
name|kind
operator|==
name|svn_node_dir
operator|&&
name|dst_presence
operator|==
name|svn_wc__db_status_normal
condition|)
name|SVN_ERR
argument_list|(
name|insert_incomplete_children
argument_list|(
name|dst_wcroot
operator|->
name|sdb
argument_list|,
name|dst_wcroot
operator|->
name|wc_id
argument_list|,
name|dst_relpath
argument_list|,
name|copyfrom_id
argument_list|,
name|copyfrom_relpath
argument_list|,
name|copyfrom_rev
argument_list|,
name|children
argument_list|,
name|dst_op_depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|cross_db_copy
argument_list|(
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|dst_wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|dst_presence
argument_list|,
name|dst_op_depth
argument_list|,
name|dst_np_op_depth
argument_list|,
name|kind
argument_list|,
name|children
argument_list|,
name|copyfrom_id
argument_list|,
name|copyfrom_relpath
argument_list|,
name|copyfrom_rev
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|dst_wcroot
operator|->
name|sdb
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Baton for passing args to op_copy_txn(). */
end_comment

begin_struct
struct|struct
name|op_copy_baton
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|src_wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|src_relpath
decl_stmt|;
name|svn_wc__db_wcroot_t
modifier|*
name|dst_wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|dst_relpath
decl_stmt|;
specifier|const
name|svn_skel_t
modifier|*
name|work_items
decl_stmt|;
name|svn_boolean_t
name|is_move
decl_stmt|;
specifier|const
name|char
modifier|*
name|dst_op_root_relpath
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Helper for svn_wc__db_op_copy().  *  * Implements svn_sqlite__transaction_callback_t. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|op_copy_txn
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|op_copy_baton
modifier|*
name|ocb
init|=
name|baton
decl_stmt|;
name|int
name|move_op_depth
decl_stmt|;
if|if
condition|(
name|sdb
operator|!=
name|ocb
operator|->
name|dst_wcroot
operator|->
name|sdb
condition|)
block|{
comment|/* Source and destination databases differ; so also start a lock           in the destination database, by calling ourself in a lock. */
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__with_lock
argument_list|(
name|ocb
operator|->
name|dst_wcroot
operator|->
name|sdb
argument_list|,
name|op_copy_txn
argument_list|,
name|ocb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
comment|/* From this point we can assume a lock in the src and dst databases */
if|if
condition|(
name|ocb
operator|->
name|is_move
condition|)
name|move_op_depth
operator|=
name|relpath_depth
argument_list|(
name|ocb
operator|->
name|dst_op_root_relpath
argument_list|)
expr_stmt|;
else|else
name|move_op_depth
operator|=
literal|0
expr_stmt|;
name|SVN_ERR
argument_list|(
name|db_op_copy
argument_list|(
name|ocb
operator|->
name|src_wcroot
argument_list|,
name|ocb
operator|->
name|src_relpath
argument_list|,
name|ocb
operator|->
name|dst_wcroot
argument_list|,
name|ocb
operator|->
name|dst_relpath
argument_list|,
name|ocb
operator|->
name|work_items
argument_list|,
name|move_op_depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_copy
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|src_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_op_root_abspath
parameter_list|,
name|svn_boolean_t
name|is_move
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|op_copy_baton
name|ocb
init|=
block|{
literal|0
block|}
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|src_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|dst_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|dst_op_root_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|ocb
operator|.
name|src_wcroot
argument_list|,
operator|&
name|ocb
operator|.
name|src_relpath
argument_list|,
name|db
argument_list|,
name|src_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|ocb
operator|.
name|src_wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|ocb
operator|.
name|dst_wcroot
argument_list|,
operator|&
name|ocb
operator|.
name|dst_relpath
argument_list|,
name|db
argument_list|,
name|dst_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|ocb
operator|.
name|dst_wcroot
argument_list|)
expr_stmt|;
name|ocb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|ocb
operator|.
name|is_move
operator|=
name|is_move
expr_stmt|;
name|ocb
operator|.
name|dst_op_root_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|ocb
operator|.
name|dst_wcroot
operator|->
name|abspath
argument_list|,
name|dst_op_root_abspath
argument_list|)
expr_stmt|;
comment|/* Call with the sdb in src_wcroot. It might call itself again to      also obtain a lock in dst_wcroot */
name|SVN_ERR
argument_list|(
name|svn_sqlite__with_lock
argument_list|(
name|ocb
operator|.
name|src_wcroot
operator|->
name|sdb
argument_list|,
name|op_copy_txn
argument_list|,
operator|&
name|ocb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The txn body of svn_wc__db_op_handle_move_back */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|handle_move_back
parameter_list|(
name|svn_boolean_t
modifier|*
name|moved_back
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|moved_from_relpath
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_boolean_t
name|op_root
decl_stmt|;
name|svn_boolean_t
name|have_more_work
decl_stmt|;
name|int
name|from_op_depth
init|=
literal|0
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_boolean_t
name|different
init|=
name|FALSE
decl_stmt|;
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info_internal
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|op_root
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|have_more_work
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|svn_wc__db_status_added
operator|||
operator|!
name|op_root
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* We have two cases here: BASE-move-back and WORKING-move-back */
if|if
condition|(
name|have_more_work
condition|)
name|SVN_ERR
argument_list|(
name|op_depth_of
argument_list|(
operator|&
name|from_op_depth
argument_list|,
name|wcroot
argument_list|,
name|svn_relpath_dirname
argument_list|(
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|from_op_depth
operator|=
literal|0
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_BACK
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|from_op_depth
argument_list|,
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|have_row
argument_list|)
expr_stmt|;
comment|/* We checked that the node is an op-root */
block|{
name|svn_boolean_t
name|moved_here
init|=
name|svn_sqlite__column_boolean
argument_list|(
name|stmt
argument_list|,
literal|9
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_to
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|10
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|moved_here
operator|||
operator|!
name|moved_to
operator|||
name|strcmp
argument_list|(
name|moved_to
argument_list|,
name|moved_from_relpath
argument_list|)
condition|)
block|{
name|different
operator|=
name|TRUE
expr_stmt|;
name|have_row
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
while|while
condition|(
name|have_row
condition|)
block|{
name|svn_wc__db_status_t
name|upper_status
decl_stmt|;
name|svn_wc__db_status_t
name|lower_status
decl_stmt|;
name|upper_status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|5
argument_list|)
condition|)
block|{
comment|/* No lower layer replaced. */
if|if
condition|(
name|upper_status
operator|!=
name|svn_wc__db_status_not_present
condition|)
block|{
name|different
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
continue|continue;
block|}
name|lower_status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|5
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|upper_status
operator|!=
name|lower_status
condition|)
block|{
name|different
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|upper_status
operator|==
name|svn_wc__db_status_not_present
operator|||
name|upper_status
operator|==
name|svn_wc__db_status_excluded
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
comment|/* Nothing to check */
block|}
elseif|else
if|if
condition|(
name|upper_status
operator|!=
name|svn_wc__db_status_normal
condition|)
block|{
comment|/* Not a normal move. Mixed revision move? */
name|different
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|{
specifier|const
name|char
modifier|*
name|upper_repos_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|lower_repos_relpath
decl_stmt|;
name|upper_repos_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|lower_repos_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|7
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|upper_repos_relpath
operator|||
name|strcmp
argument_list|(
name|upper_repos_relpath
argument_list|,
name|lower_repos_relpath
argument_list|)
condition|)
block|{
name|different
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
block|{
name|svn_revnum_t
name|upper_rev
decl_stmt|;
name|svn_revnum_t
name|lower_rev
decl_stmt|;
name|upper_rev
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|lower_rev
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|upper_rev
operator|!=
name|lower_rev
condition|)
block|{
name|different
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
block|{
name|apr_int64_t
name|upper_repos_id
decl_stmt|;
name|apr_int64_t
name|lower_repos_id
decl_stmt|;
name|upper_repos_id
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|lower_repos_id
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|upper_repos_id
operator|!=
name|lower_repos_id
condition|)
block|{
name|different
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
comment|/* Check moved_here? */
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|different
condition|)
block|{
comment|/* Ok, we can now safely remove this complete move, because we          determined that it 100% matches the layer below it. */
comment|/* ### We could copy the recorded timestamps from the higher to the              lower layer in an attempt to improve status performance, but              generally these values should be the same anyway as it was              a no-op move. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_MOVED_BACK
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|moved_back
condition|)
operator|*
name|moved_back
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_handle_move_back
parameter_list|(
name|svn_boolean_t
modifier|*
name|moved_back
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|moved_from_abspath
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_from_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
name|moved_back
condition|)
operator|*
name|moved_back
operator|=
name|FALSE
expr_stmt|;
name|moved_from_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|moved_from_abspath
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|local_relpath
index|[
literal|0
index|]
operator|||
operator|!
name|moved_from_relpath
condition|)
block|{
comment|/* WC-Roots can't be moved */
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|handle_move_back
argument_list|(
name|moved_back
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|moved_from_relpath
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_infinity
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The recursive implementation of svn_wc__db_op_copy_shadowed_layer.  *  * A non-zero MOVE_OP_DEPTH implies that the copy operation is part of  * a move, and indicates the op-depth of the move destination op-root. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_op_copy_shadowed_layer
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|src_wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
name|int
name|src_op_depth
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|dst_wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|int
name|dst_op_depth
parameter_list|,
name|int
name|del_op_depth
parameter_list|,
name|apr_int64_t
name|repos_id
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|int
name|move_op_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|apr_array_header_t
modifier|*
name|children
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|svn_revnum_t
name|node_revision
decl_stmt|;
specifier|const
name|char
modifier|*
name|node_repos_relpath
decl_stmt|;
name|apr_int64_t
name|node_repos_id
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_wc__db_status_t
name|dst_presence
decl_stmt|;
name|int
name|i
decl_stmt|;
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|err
operator|=
name|svn_wc__db_depth_get_info
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|kind
argument_list|,
operator|&
name|node_revision
argument_list|,
operator|&
name|node_repos_relpath
argument_list|,
operator|&
name|node_repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|src_op_depth
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
name|err
operator|->
name|apr_err
operator|!=
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
comment|/* There is no shadowed node at src_op_depth */
block|}
block|}
if|if
condition|(
name|src_op_depth
operator|==
literal|0
condition|)
block|{
comment|/* If the node is switched or has a different revision then its parent          we shouldn't copy it. (We can't as we would have to insert it at          an unshadowed depth) */
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_not_present
operator|||
name|status
operator|==
name|svn_wc__db_status_excluded
operator|||
name|status
operator|==
name|svn_wc__db_status_server_excluded
operator|||
name|node_revision
operator|!=
name|revision
operator|||
name|node_repos_id
operator|!=
name|repos_id
operator|||
name|strcmp
argument_list|(
name|node_repos_relpath
argument_list|,
name|repos_relpath
argument_list|)
condition|)
block|{
comment|/* Add a not-present node in the destination wcroot */
name|struct
name|insert_working_baton_t
name|iwb
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_root_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_uuid
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_fetch_repos_info
argument_list|(
operator|&
name|repos_root_url
argument_list|,
operator|&
name|repos_uuid
argument_list|,
name|src_wcroot
operator|->
name|sdb
argument_list|,
name|node_repos_id
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|create_repos_id
argument_list|(
operator|&
name|node_repos_id
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|dst_wcroot
operator|->
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|blank_iwb
argument_list|(
operator|&
name|iwb
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|op_depth
operator|=
name|dst_op_depth
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|svn_wc__db_status_excluded
condition|)
name|iwb
operator|.
name|presence
operator|=
name|svn_wc__db_status_not_present
expr_stmt|;
else|else
name|iwb
operator|.
name|presence
operator|=
name|svn_wc__db_status_excluded
expr_stmt|;
name|iwb
operator|.
name|kind
operator|=
name|kind
expr_stmt|;
name|iwb
operator|.
name|original_repos_id
operator|=
name|node_repos_id
expr_stmt|;
name|iwb
operator|.
name|original_revnum
operator|=
name|node_revision
expr_stmt|;
name|iwb
operator|.
name|original_repos_relpath
operator|=
name|node_repos_relpath
expr_stmt|;
name|SVN_ERR
argument_list|(
name|insert_working_node
argument_list|(
operator|&
name|iwb
argument_list|,
name|dst_wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|svn_wc__db_status_normal
case|:
case|case
name|svn_wc__db_status_added
case|:
case|case
name|svn_wc__db_status_moved_here
case|:
case|case
name|svn_wc__db_status_copied
case|:
name|dst_presence
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
break|break;
case|case
name|svn_wc__db_status_deleted
case|:
case|case
name|svn_wc__db_status_not_present
case|:
name|dst_presence
operator|=
name|svn_wc__db_status_not_present
expr_stmt|;
break|break;
case|case
name|svn_wc__db_status_excluded
case|:
name|dst_presence
operator|=
name|svn_wc__db_status_excluded
expr_stmt|;
break|break;
case|case
name|svn_wc__db_status_server_excluded
case|:
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Cannot copy '%s' excluded by server"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
default|default:
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Cannot handle status of '%s'"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|dst_presence
operator|==
name|svn_wc__db_status_normal
operator|&&
name|src_wcroot
operator|==
name|dst_wcroot
condition|)
comment|/* ### Remove limitation */
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|src_wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_WORKING_NODE_COPY_FROM_DEPTH
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"issdstd"
argument_list|,
name|src_wcroot
operator|->
name|wc_id
argument_list|,
name|src_relpath
argument_list|,
name|dst_relpath
argument_list|,
name|dst_op_depth
argument_list|,
name|svn_relpath_dirname
argument_list|(
name|dst_relpath
argument_list|,
name|iterpool
argument_list|)
argument_list|,
name|presence_map
argument_list|,
name|dst_presence
argument_list|,
name|src_op_depth
argument_list|)
argument_list|)
expr_stmt|;
comment|/* moved_here */
if|if
condition|(
name|dst_op_depth
operator|==
name|move_op_depth
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int
argument_list|(
name|stmt
argument_list|,
literal|8
argument_list|,
name|TRUE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|{
comment|/* And mark it deleted to allow proper shadowing */
name|struct
name|insert_working_baton_t
name|iwb
decl_stmt|;
name|blank_iwb
argument_list|(
operator|&
name|iwb
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|op_depth
operator|=
name|del_op_depth
expr_stmt|;
name|iwb
operator|.
name|presence
operator|=
name|svn_wc__db_status_base_deleted
expr_stmt|;
name|iwb
operator|.
name|kind
operator|=
name|kind
expr_stmt|;
name|SVN_ERR
argument_list|(
name|insert_working_node
argument_list|(
operator|&
name|iwb
argument_list|,
name|dst_wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|struct
name|insert_working_baton_t
name|iwb
decl_stmt|;
if|if
condition|(
name|dst_presence
operator|==
name|svn_wc__db_status_normal
condition|)
comment|/* Fallback for multi-db */
name|dst_presence
operator|=
name|svn_wc__db_status_not_present
expr_stmt|;
comment|/* And mark it deleted to allow proper shadowing */
name|blank_iwb
argument_list|(
operator|&
name|iwb
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|op_depth
operator|=
name|dst_op_depth
expr_stmt|;
name|iwb
operator|.
name|presence
operator|=
name|dst_presence
expr_stmt|;
name|iwb
operator|.
name|kind
operator|=
name|kind
expr_stmt|;
name|SVN_ERR
argument_list|(
name|insert_working_node
argument_list|(
operator|&
name|iwb
argument_list|,
name|dst_wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dst_presence
operator|==
name|svn_wc__db_status_not_present
condition|)
block|{
comment|/* Don't create descendants of a not present node! */
comment|/* This code is currently still triggered by copying deleted nodes          between separate working copies. See ### comment above. */
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|SVN_ERR
argument_list|(
name|gather_repo_children
argument_list|(
operator|&
name|children
argument_list|,
name|src_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|src_op_depth
argument_list|,
name|scratch_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|children
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|name
init|=
name|APR_ARRAY_IDX
argument_list|(
name|children
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_src_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_dst_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_repos_relpath
init|=
name|NULL
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|child_src_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|src_relpath
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|child_dst_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|dst_relpath
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|repos_relpath
condition|)
name|child_repos_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|repos_relpath
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|db_op_copy_shadowed_layer
argument_list|(
name|src_wcroot
argument_list|,
name|child_src_relpath
argument_list|,
name|src_op_depth
argument_list|,
name|dst_wcroot
argument_list|,
name|child_dst_relpath
argument_list|,
name|dst_op_depth
argument_list|,
name|del_op_depth
argument_list|,
name|repos_id
argument_list|,
name|child_repos_relpath
argument_list|,
name|revision
argument_list|,
name|move_op_depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Helper for svn_wc__db_op_copy_shadowed_layer().  *  * Implements  svn_sqlite__transaction_callback_t. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|op_copy_shadowed_layer_txn
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|op_copy_baton
modifier|*
name|ocb
init|=
name|baton
decl_stmt|;
specifier|const
name|char
modifier|*
name|src_parent_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|dst_parent_relpath
decl_stmt|;
name|int
name|src_op_depth
decl_stmt|;
name|int
name|dst_op_depth
decl_stmt|;
name|int
name|del_op_depth
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath
init|=
name|NULL
decl_stmt|;
name|apr_int64_t
name|repos_id
init|=
name|INVALID_REPOS_ID
decl_stmt|;
name|svn_revnum_t
name|revision
init|=
name|SVN_INVALID_REVNUM
decl_stmt|;
if|if
condition|(
name|sdb
operator|!=
name|ocb
operator|->
name|dst_wcroot
operator|->
name|sdb
condition|)
block|{
comment|/* Source and destination databases differ; so also start a lock           in the destination database, by calling ourself in a lock. */
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__with_lock
argument_list|(
name|ocb
operator|->
name|dst_wcroot
operator|->
name|sdb
argument_list|,
name|op_copy_shadowed_layer_txn
argument_list|,
name|ocb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
comment|/* From this point we can assume a lock in the src and dst databases */
comment|/* src_relpath and dst_relpath can't be wcroot as we need their parents */
name|SVN_ERR_ASSERT
argument_list|(
operator|*
name|ocb
operator|->
name|src_relpath
operator|&&
operator|*
name|ocb
operator|->
name|dst_relpath
argument_list|)
expr_stmt|;
name|src_parent_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|ocb
operator|->
name|src_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|dst_parent_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|ocb
operator|->
name|dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* src_parent must be status normal or added; get its op-depth */
name|SVN_ERR
argument_list|(
name|op_depth_of
argument_list|(
operator|&
name|src_op_depth
argument_list|,
name|ocb
operator|->
name|src_wcroot
argument_list|,
name|src_parent_relpath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* dst_parent must be status added; get its op-depth */
name|SVN_ERR
argument_list|(
name|op_depth_of
argument_list|(
operator|&
name|dst_op_depth
argument_list|,
name|ocb
operator|->
name|dst_wcroot
argument_list|,
name|dst_parent_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|del_op_depth
operator|=
name|relpath_depth
argument_list|(
name|ocb
operator|->
name|dst_relpath
argument_list|)
expr_stmt|;
comment|/* Get some information from the parent */
name|SVN_ERR
argument_list|(
name|svn_wc__db_depth_get_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|revision
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ocb
operator|->
name|src_wcroot
argument_list|,
name|src_parent_relpath
argument_list|,
name|src_op_depth
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|repos_relpath
operator|==
name|NULL
condition|)
block|{
comment|/* The node is a local addition and has no shadowed information */
return|return
name|SVN_NO_ERROR
return|;
block|}
comment|/* And calculate the child repos relpath */
name|repos_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|repos_relpath
argument_list|,
name|svn_relpath_basename
argument_list|(
name|ocb
operator|->
name|src_relpath
argument_list|,
name|NULL
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|db_op_copy_shadowed_layer
argument_list|(
name|ocb
operator|->
name|src_wcroot
argument_list|,
name|ocb
operator|->
name|src_relpath
argument_list|,
name|src_op_depth
argument_list|,
name|ocb
operator|->
name|dst_wcroot
argument_list|,
name|ocb
operator|->
name|dst_relpath
argument_list|,
name|dst_op_depth
argument_list|,
name|del_op_depth
argument_list|,
name|repos_id
argument_list|,
name|repos_relpath
argument_list|,
name|revision
argument_list|,
operator|(
name|ocb
operator|->
name|is_move
condition|?
name|dst_op_depth
else|:
literal|0
operator|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_copy_shadowed_layer
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|src_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_abspath
parameter_list|,
name|svn_boolean_t
name|is_move
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|op_copy_baton
name|ocb
init|=
block|{
literal|0
block|}
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|src_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|dst_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|ocb
operator|.
name|src_wcroot
argument_list|,
operator|&
name|ocb
operator|.
name|src_relpath
argument_list|,
name|db
argument_list|,
name|src_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|ocb
operator|.
name|src_wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|ocb
operator|.
name|dst_wcroot
argument_list|,
operator|&
name|ocb
operator|.
name|dst_relpath
argument_list|,
name|db
argument_list|,
name|dst_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|ocb
operator|.
name|dst_wcroot
argument_list|)
expr_stmt|;
name|ocb
operator|.
name|is_move
operator|=
name|is_move
expr_stmt|;
name|ocb
operator|.
name|dst_op_root_relpath
operator|=
name|NULL
expr_stmt|;
comment|/* not used by op_copy_shadowed_layer_txn */
name|ocb
operator|.
name|work_items
operator|=
name|NULL
expr_stmt|;
comment|/* Call with the sdb in src_wcroot. It might call itself again to      also obtain a lock in dst_wcroot */
name|SVN_ERR
argument_list|(
name|svn_sqlite__with_lock
argument_list|(
name|ocb
operator|.
name|src_wcroot
operator|->
name|sdb
argument_list|,
name|op_copy_shadowed_layer_txn
argument_list|,
operator|&
name|ocb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* If there are any server-excluded base nodes then the copy must fail    as it's not possible to commit such a copy.    Return an error if there are any server-excluded nodes. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|catch_copy_of_server_excluded
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
specifier|const
name|char
modifier|*
name|server_excluded_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_HAS_SERVER_EXCLUDED_DESCENDANTS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
name|server_excluded_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_AUTHZ_UNREADABLE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Cannot copy '%s' excluded by server"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|server_excluded_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_copy_dir
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_revnum_t
name|changed_rev
parameter_list|,
name|apr_time_t
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
name|changed_author
parameter_list|,
specifier|const
name|char
modifier|*
name|original_repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|original_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|original_uuid
parameter_list|,
name|svn_revnum_t
name|original_revision
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|children
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|is_move
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|insert_working_baton_t
name|iwb
decl_stmt|;
name|int
name|parent_op_depth
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|props
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* ### any assertions for CHANGED_* ?  */
comment|/* ### any assertions for ORIGINAL_* ?  */
if|#
directive|if
literal|0
block|SVN_ERR_ASSERT(children != NULL);
endif|#
directive|endif
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|blank_iwb
argument_list|(
operator|&
name|iwb
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|presence
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|iwb
operator|.
name|kind
operator|=
name|svn_node_dir
expr_stmt|;
if|if
condition|(
name|original_root_url
operator|!=
name|NULL
condition|)
block|{
name|SVN_ERR
argument_list|(
name|create_repos_id
argument_list|(
operator|&
name|iwb
operator|.
name|original_repos_id
argument_list|,
name|original_root_url
argument_list|,
name|original_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|original_repos_relpath
operator|=
name|original_repos_relpath
expr_stmt|;
name|iwb
operator|.
name|original_revnum
operator|=
name|original_revision
expr_stmt|;
name|iwb
operator|.
name|props
operator|=
name|props
expr_stmt|;
name|iwb
operator|.
name|changed_rev
operator|=
name|changed_rev
expr_stmt|;
name|iwb
operator|.
name|changed_date
operator|=
name|changed_date
expr_stmt|;
name|iwb
operator|.
name|changed_author
operator|=
name|changed_author
expr_stmt|;
block|}
comment|/* ### Should we do this inside the transaction? */
name|SVN_ERR
argument_list|(
name|op_depth_for_copy
argument_list|(
operator|&
name|iwb
operator|.
name|op_depth
argument_list|,
operator|&
name|iwb
operator|.
name|not_present_op_depth
argument_list|,
operator|&
name|parent_op_depth
argument_list|,
name|iwb
operator|.
name|original_repos_id
argument_list|,
name|original_repos_relpath
argument_list|,
name|original_revision
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|children
operator|=
name|children
expr_stmt|;
name|iwb
operator|.
name|depth
operator|=
name|depth
expr_stmt|;
name|iwb
operator|.
name|moved_here
operator|=
name|is_move
operator|&&
operator|(
name|parent_op_depth
operator|==
literal|0
operator|||
name|iwb
operator|.
name|op_depth
operator|==
name|parent_op_depth
operator|)
expr_stmt|;
name|iwb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|iwb
operator|.
name|conflict
operator|=
name|conflict
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_working_node
argument_list|(
operator|&
name|iwb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_copy_file
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_revnum_t
name|changed_rev
parameter_list|,
name|apr_time_t
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
name|changed_author
parameter_list|,
specifier|const
name|char
modifier|*
name|original_repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|original_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|original_uuid
parameter_list|,
name|svn_revnum_t
name|original_revision
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
parameter_list|,
name|svn_boolean_t
name|update_actual_props
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|new_actual_props
parameter_list|,
name|svn_boolean_t
name|is_move
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|insert_working_baton_t
name|iwb
decl_stmt|;
name|int
name|parent_op_depth
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|props
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* ### any assertions for CHANGED_* ?  */
name|SVN_ERR_ASSERT
argument_list|(
operator|(
operator|!
name|original_repos_relpath
operator|&&
operator|!
name|original_root_url
operator|&&
operator|!
name|original_uuid
operator|&&
operator|!
name|checksum
operator|&&
name|original_revision
operator|==
name|SVN_INVALID_REVNUM
operator|)
operator|||
operator|(
name|original_repos_relpath
operator|&&
name|original_root_url
operator|&&
name|original_uuid
operator|&&
name|checksum
operator|&&
name|original_revision
operator|!=
name|SVN_INVALID_REVNUM
operator|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|blank_iwb
argument_list|(
operator|&
name|iwb
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|presence
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|iwb
operator|.
name|kind
operator|=
name|svn_node_file
expr_stmt|;
if|if
condition|(
name|original_root_url
operator|!=
name|NULL
condition|)
block|{
name|SVN_ERR
argument_list|(
name|create_repos_id
argument_list|(
operator|&
name|iwb
operator|.
name|original_repos_id
argument_list|,
name|original_root_url
argument_list|,
name|original_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|original_repos_relpath
operator|=
name|original_repos_relpath
expr_stmt|;
name|iwb
operator|.
name|original_revnum
operator|=
name|original_revision
expr_stmt|;
name|iwb
operator|.
name|props
operator|=
name|props
expr_stmt|;
name|iwb
operator|.
name|changed_rev
operator|=
name|changed_rev
expr_stmt|;
name|iwb
operator|.
name|changed_date
operator|=
name|changed_date
expr_stmt|;
name|iwb
operator|.
name|changed_author
operator|=
name|changed_author
expr_stmt|;
block|}
comment|/* ### Should we do this inside the transaction? */
name|SVN_ERR
argument_list|(
name|op_depth_for_copy
argument_list|(
operator|&
name|iwb
operator|.
name|op_depth
argument_list|,
operator|&
name|iwb
operator|.
name|not_present_op_depth
argument_list|,
operator|&
name|parent_op_depth
argument_list|,
name|iwb
operator|.
name|original_repos_id
argument_list|,
name|original_repos_relpath
argument_list|,
name|original_revision
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|checksum
operator|=
name|checksum
expr_stmt|;
name|iwb
operator|.
name|moved_here
operator|=
name|is_move
operator|&&
operator|(
name|parent_op_depth
operator|==
literal|0
operator|||
name|iwb
operator|.
name|op_depth
operator|==
name|parent_op_depth
operator|)
expr_stmt|;
if|if
condition|(
name|update_actual_props
condition|)
block|{
name|iwb
operator|.
name|update_actual_props
operator|=
name|update_actual_props
expr_stmt|;
name|iwb
operator|.
name|new_actual_props
operator|=
name|new_actual_props
expr_stmt|;
block|}
name|iwb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|iwb
operator|.
name|conflict
operator|=
name|conflict
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_working_node
argument_list|(
operator|&
name|iwb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_copy_symlink
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_revnum_t
name|changed_rev
parameter_list|,
name|apr_time_t
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
name|changed_author
parameter_list|,
specifier|const
name|char
modifier|*
name|original_repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|original_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|original_uuid
parameter_list|,
name|svn_revnum_t
name|original_revision
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|,
name|svn_boolean_t
name|is_move
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|insert_working_baton_t
name|iwb
decl_stmt|;
name|int
name|parent_op_depth
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|props
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* ### any assertions for CHANGED_* ?  */
comment|/* ### any assertions for ORIGINAL_* ?  */
name|SVN_ERR_ASSERT
argument_list|(
name|target
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|blank_iwb
argument_list|(
operator|&
name|iwb
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|presence
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|iwb
operator|.
name|kind
operator|=
name|svn_node_symlink
expr_stmt|;
if|if
condition|(
name|original_root_url
operator|!=
name|NULL
condition|)
block|{
name|SVN_ERR
argument_list|(
name|create_repos_id
argument_list|(
operator|&
name|iwb
operator|.
name|original_repos_id
argument_list|,
name|original_root_url
argument_list|,
name|original_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|original_repos_relpath
operator|=
name|original_repos_relpath
expr_stmt|;
name|iwb
operator|.
name|original_revnum
operator|=
name|original_revision
expr_stmt|;
name|iwb
operator|.
name|props
operator|=
name|props
expr_stmt|;
name|iwb
operator|.
name|changed_rev
operator|=
name|changed_rev
expr_stmt|;
name|iwb
operator|.
name|changed_date
operator|=
name|changed_date
expr_stmt|;
name|iwb
operator|.
name|changed_author
operator|=
name|changed_author
expr_stmt|;
block|}
comment|/* ### Should we do this inside the transaction? */
name|SVN_ERR
argument_list|(
name|op_depth_for_copy
argument_list|(
operator|&
name|iwb
operator|.
name|op_depth
argument_list|,
operator|&
name|iwb
operator|.
name|not_present_op_depth
argument_list|,
operator|&
name|parent_op_depth
argument_list|,
name|iwb
operator|.
name|original_repos_id
argument_list|,
name|original_repos_relpath
argument_list|,
name|original_revision
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|target
operator|=
name|target
expr_stmt|;
name|iwb
operator|.
name|moved_here
operator|=
name|is_move
operator|&&
operator|(
name|parent_op_depth
operator|==
literal|0
operator|||
name|iwb
operator|.
name|op_depth
operator|==
name|parent_op_depth
operator|)
expr_stmt|;
name|iwb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|iwb
operator|.
name|conflict
operator|=
name|conflict
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_working_node
argument_list|(
operator|&
name|iwb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_add_directory
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|props
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|dir_abspath
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|insert_working_baton_t
name|iwb
decl_stmt|;
comment|/* Resolve wcroot via parent directory to avoid obstruction handling */
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|svn_dirent_split
argument_list|(
operator|&
name|dir_abspath
argument_list|,
operator|&
name|name
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|blank_iwb
argument_list|(
operator|&
name|iwb
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|local_relpath
argument_list|,
name|name
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|presence
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|iwb
operator|.
name|kind
operator|=
name|svn_node_dir
expr_stmt|;
name|iwb
operator|.
name|op_depth
operator|=
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
expr_stmt|;
if|if
condition|(
name|props
operator|&&
name|apr_hash_count
argument_list|(
operator|(
name|apr_hash_t
operator|*
operator|)
name|props
argument_list|)
condition|)
block|{
name|iwb
operator|.
name|update_actual_props
operator|=
name|TRUE
expr_stmt|;
name|iwb
operator|.
name|new_actual_props
operator|=
name|props
expr_stmt|;
block|}
name|iwb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_working_node
argument_list|(
operator|&
name|iwb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
comment|/* Use depth infinity to make sure we have no invalid cached information    * about children of this dir. */
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_infinity
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_add_file
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|props
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|insert_working_baton_t
name|iwb
decl_stmt|;
specifier|const
name|char
modifier|*
name|dir_abspath
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
comment|/* Resolve wcroot via parent directory to avoid obstruction handling */
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|svn_dirent_split
argument_list|(
operator|&
name|dir_abspath
argument_list|,
operator|&
name|name
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|blank_iwb
argument_list|(
operator|&
name|iwb
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|local_relpath
argument_list|,
name|name
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|presence
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|iwb
operator|.
name|kind
operator|=
name|svn_node_file
expr_stmt|;
name|iwb
operator|.
name|op_depth
operator|=
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
expr_stmt|;
if|if
condition|(
name|props
operator|&&
name|apr_hash_count
argument_list|(
operator|(
name|apr_hash_t
operator|*
operator|)
name|props
argument_list|)
condition|)
block|{
name|iwb
operator|.
name|update_actual_props
operator|=
name|TRUE
expr_stmt|;
name|iwb
operator|.
name|new_actual_props
operator|=
name|props
expr_stmt|;
block|}
name|iwb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_working_node
argument_list|(
operator|&
name|iwb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_add_symlink
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|props
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|insert_working_baton_t
name|iwb
decl_stmt|;
specifier|const
name|char
modifier|*
name|dir_abspath
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
comment|/* Resolve wcroot via parent directory to avoid obstruction handling */
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|target
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|svn_dirent_split
argument_list|(
operator|&
name|dir_abspath
argument_list|,
operator|&
name|name
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|blank_iwb
argument_list|(
operator|&
name|iwb
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|local_relpath
argument_list|,
name|name
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|iwb
operator|.
name|presence
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|iwb
operator|.
name|kind
operator|=
name|svn_node_symlink
expr_stmt|;
name|iwb
operator|.
name|op_depth
operator|=
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
expr_stmt|;
if|if
condition|(
name|props
operator|&&
name|apr_hash_count
argument_list|(
operator|(
name|apr_hash_t
operator|*
operator|)
name|props
argument_list|)
condition|)
block|{
name|iwb
operator|.
name|update_actual_props
operator|=
name|TRUE
expr_stmt|;
name|iwb
operator|.
name|new_actual_props
operator|=
name|props
expr_stmt|;
block|}
name|iwb
operator|.
name|target
operator|=
name|target
expr_stmt|;
name|iwb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|insert_working_node
argument_list|(
operator|&
name|iwb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Record RECORDED_SIZE and RECORDED_TIME into top layer in NODES */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_record_fileinfo
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_int64_t
name|recorded_size
parameter_list|,
name|apr_int64_t
name|recorded_time
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|int
name|affected_rows
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_NODE_FILEINFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isii"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|recorded_size
argument_list|,
name|recorded_time
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|affected_rows
operator|==
literal|1
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_global_record_fileinfo
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_filesize_t
name|recorded_size
parameter_list|,
name|apr_time_t
name|recorded_time
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|db_record_fileinfo
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|recorded_size
argument_list|,
name|recorded_time
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We *totally* monkeyed the entries. Toss 'em.  */
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Set the ACTUAL_NODE properties column for (WC_ID, LOCAL_RELPATH) to  * PROPS.  *  * Note: PROPS=NULL means the actual props are the same as the pristine  * props; to indicate no properties when the pristine has some props,  * PROPS must be an empty hash. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|set_actual_props
parameter_list|(
name|apr_int64_t
name|wc_id
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_sqlite__db_t
modifier|*
name|db
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|int
name|affected_rows
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|db
argument_list|,
name|STMT_UPDATE_ACTUAL_PROPS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_properties
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|affected_rows
operator|==
literal|1
operator|||
operator|!
name|props
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* We are done */
comment|/* We have to insert a row in ACTUAL */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|db
argument_list|,
name|STMT_INSERT_ACTUAL_PROPS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|local_relpath
operator|!=
literal|'\0'
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_text
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|svn_relpath_dirname
argument_list|(
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_properties
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|,
name|props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_op_set_props().     Set the 'properties' column in the 'ACTUAL_NODE' table to BATON->props.    Create an entry in the ACTUAL table for the node if it does not yet    have one.    To specify no properties, BATON->props must be an empty hash, not NULL.    BATON is of type 'struct set_props_baton_t'. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|set_props_txn
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_boolean_t
name|clear_recorded_info
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|pristine_props
decl_stmt|;
comment|/* Check if the props are modified. If no changes, then wipe out the      ACTUAL props.  PRISTINE_PROPS==NULL means that any      ACTUAL props are okay as provided, so go ahead and set them.  */
name|SVN_ERR
argument_list|(
name|db_read_pristine_props
argument_list|(
operator|&
name|pristine_props
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|props
operator|&&
name|pristine_props
condition|)
block|{
name|apr_array_header_t
modifier|*
name|prop_diffs
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_prop_diffs
argument_list|(
operator|&
name|prop_diffs
argument_list|,
name|props
argument_list|,
name|pristine_props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|prop_diffs
operator|->
name|nelts
operator|==
literal|0
condition|)
name|props
operator|=
name|NULL
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|set_actual_props
argument_list|(
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|props
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|clear_recorded_info
condition|)
block|{
name|SVN_ERR
argument_list|(
name|db_record_fileinfo
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|SVN_INVALID_FILESIZE
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* And finally.  */
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_mark_conflict_internal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|conflict
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_set_props
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_boolean_t
name|clear_recorded_info
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|set_props_txn
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|props
argument_list|,
name|clear_recorded_info
argument_list|,
name|conflict
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_modified
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|NOT_IMPLEMENTED
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|populate_targets_tree
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelist_filter
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|int
name|affected_rows
init|=
literal|0
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CREATE_TARGETS_LIST
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|changelist_filter
operator|&&
name|changelist_filter
operator|->
name|nelts
operator|>
literal|0
condition|)
block|{
comment|/* Iterate over the changelists, adding the nodes which match.          Common case: we only have one changelist, so this only          happens once. */
name|int
name|i
decl_stmt|;
name|int
name|stmt_idx
decl_stmt|;
switch|switch
condition|(
name|depth
condition|)
block|{
case|case
name|svn_depth_empty
case|:
name|stmt_idx
operator|=
name|STMT_INSERT_TARGET_WITH_CHANGELIST
expr_stmt|;
break|break;
case|case
name|svn_depth_files
case|:
name|stmt_idx
operator|=
name|STMT_INSERT_TARGET_WITH_CHANGELIST_DEPTH_FILES
expr_stmt|;
break|break;
case|case
name|svn_depth_immediates
case|:
name|stmt_idx
operator|=
name|STMT_INSERT_TARGET_WITH_CHANGELIST_DEPTH_IMMEDIATES
expr_stmt|;
break|break;
case|case
name|svn_depth_infinity
case|:
name|stmt_idx
operator|=
name|STMT_INSERT_TARGET_WITH_CHANGELIST_DEPTH_INFINITY
expr_stmt|;
break|break;
default|default:
comment|/* We don't know how to handle unknown or exclude. */
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|changelist_filter
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|int
name|sub_affected
decl_stmt|;
specifier|const
name|char
modifier|*
name|changelist
init|=
name|APR_ARRAY_IDX
argument_list|(
name|changelist_filter
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_TARGET_WITH_CHANGELIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"iss"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|changelist
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|sub_affected
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If the root is matched by the changelist, we don't have to match              the children. As that tells us the root is a file */
if|if
condition|(
operator|!
name|sub_affected
operator|&&
name|depth
operator|>
name|svn_depth_empty
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|stmt_idx
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"iss"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|changelist
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|sub_affected
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|affected_rows
operator|+=
name|sub_affected
expr_stmt|;
block|}
block|}
else|else
comment|/* No changelist filtering */
block|{
name|int
name|stmt_idx
decl_stmt|;
name|int
name|sub_affected
decl_stmt|;
switch|switch
condition|(
name|depth
condition|)
block|{
case|case
name|svn_depth_empty
case|:
name|stmt_idx
operator|=
name|STMT_INSERT_TARGET
expr_stmt|;
break|break;
case|case
name|svn_depth_files
case|:
name|stmt_idx
operator|=
name|STMT_INSERT_TARGET_DEPTH_FILES
expr_stmt|;
break|break;
case|case
name|svn_depth_immediates
case|:
name|stmt_idx
operator|=
name|STMT_INSERT_TARGET_DEPTH_IMMEDIATES
expr_stmt|;
break|break;
case|case
name|svn_depth_infinity
case|:
name|stmt_idx
operator|=
name|STMT_INSERT_TARGET_DEPTH_INFINITY
expr_stmt|;
break|break;
default|default:
comment|/* We don't know how to handle unknown or exclude. */
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
break|break;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_TARGET
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|sub_affected
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|affected_rows
operator|+=
name|sub_affected
expr_stmt|;
if|if
condition|(
name|depth
operator|>
name|svn_depth_empty
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|stmt_idx
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|sub_affected
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|affected_rows
operator|+=
name|sub_affected
expr_stmt|;
block|}
block|}
comment|/* Does the target exist? */
if|if
condition|(
name|affected_rows
operator|==
literal|0
condition|)
block|{
name|svn_boolean_t
name|exists
decl_stmt|;
name|SVN_ERR
argument_list|(
name|does_node_exist
argument_list|(
operator|&
name|exists
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|exists
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static svn_error_t * dump_targets(svn_wc__db_wcroot_t *wcroot,              apr_pool_t *scratch_pool) {   svn_sqlite__stmt_t *stmt;   svn_boolean_t have_row;    SVN_ERR(svn_sqlite__get_statement(&stmt, wcroot->sdb,                                     STMT_SELECT_TARGETS));   SVN_ERR(svn_sqlite__step(&have_row, stmt));   while (have_row)     {       const char *target = svn_sqlite__column_text(stmt, 0, NULL);       SVN_DBG(("Target: '%s'\n", target));       SVN_ERR(svn_sqlite__step(&have_row, stmt));     }    SVN_ERR(svn_sqlite__reset(stmt));    return SVN_NO_ERROR; }
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|set_changelist_baton_t
block|{
specifier|const
name|char
modifier|*
name|new_changelist
decl_stmt|;
specifier|const
name|apr_array_header_t
modifier|*
name|changelist_filter
decl_stmt|;
name|svn_depth_t
name|depth
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* The main part of svn_wc__db_op_set_changelist().  *  * Implements svn_wc__db_txn_callback_t. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|set_changelist_txn
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|set_changelist_baton_t
modifier|*
name|scb
init|=
name|baton
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|SVN_ERR
argument_list|(
name|populate_targets_tree
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scb
operator|->
name|depth
argument_list|,
name|scb
operator|->
name|changelist_filter
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Ensure we have actual nodes for our targets. */
if|if
condition|(
name|scb
operator|->
name|new_changelist
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_ACTUAL_EMPTIES
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Now create our notification table. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CREATE_CHANGELIST_LIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CREATE_CHANGELIST_TRIGGER
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Update our changelists. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_ACTUAL_CHANGELISTS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"iss"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|scb
operator|->
name|new_changelist
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|scb
operator|->
name|new_changelist
condition|)
block|{
comment|/* We have to notify that we skipped directories, so do that now. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_MARK_SKIPPED_CHANGELIST_DIRS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"iss"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|scb
operator|->
name|new_changelist
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* We may have left empty ACTUAL nodes, so remove them.  This is only a      potential problem if we removed changelists. */
if|if
condition|(
operator|!
name|scb
operator|->
name|new_changelist
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_ACTUAL_EMPTIES
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Send notifications for svn_wc__db_op_set_changelist().  *  * Implements work_callback_t. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|do_changelist_notify
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_CHANGELIST_LIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
comment|/* ### wc_id is column 0. use it one day...  */
specifier|const
name|char
modifier|*
name|notify_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|svn_wc_notify_action_t
name|action
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|svn_wc_notify_t
modifier|*
name|notify
decl_stmt|;
specifier|const
name|char
modifier|*
name|notify_abspath
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|cancel_func
condition|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
name|notify_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|notify_relpath
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|notify
operator|=
name|svn_wc_create_notify
argument_list|(
name|notify_abspath
argument_list|,
name|action
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|notify
operator|->
name|changelist_name
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|notify_func
argument_list|(
name|notify_baton
argument_list|,
name|notify
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_set_changelist
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|new_changelist
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelist_filter
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|struct
name|set_changelist_baton_t
name|scb
decl_stmt|;
name|scb
operator|.
name|new_changelist
operator|=
name|new_changelist
expr_stmt|;
name|scb
operator|.
name|changelist_filter
operator|=
name|changelist_filter
expr_stmt|;
name|scb
operator|.
name|depth
operator|=
name|depth
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
comment|/* Flush the entries before we do the work. Even if no work is performed,      the flush isn't a problem. */
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Perform the set-changelist operation (transactionally), perform any      notifications necessary, and then clean out our temporary tables.  */
return|return
name|svn_error_trace
argument_list|(
name|with_finalization
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|set_changelist_txn
argument_list|,
operator|&
name|scb
argument_list|,
name|do_changelist_notify
argument_list|,
name|NULL
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|notify_func
argument_list|,
name|notify_baton
argument_list|,
name|STMT_FINALIZE_CHANGELIST
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Implementation of svn_wc__db_op_mark_conflict() */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_mark_conflict_internal
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict_skel
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|got_row
decl_stmt|;
name|svn_boolean_t
name|is_complete
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_skel_is_complete
argument_list|(
operator|&
name|is_complete
argument_list|,
name|conflict_skel
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|is_complete
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ACTUAL_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|got_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|got_row
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_ACTUAL_CONFLICT
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_ACTUAL_CONFLICT
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|local_relpath
operator|!=
literal|'\0'
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_text
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|,
name|svn_relpath_dirname
argument_list|(
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|{
name|svn_stringbuf_t
modifier|*
name|sb
init|=
name|svn_skel__unparse
argument_list|(
name|conflict_skel
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_blob
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|sb
operator|->
name|data
argument_list|,
name|sb
operator|->
name|len
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_mark_conflict
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict_skel
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_mark_conflict_internal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|conflict_skel
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### Should be handled in the same transaction as setting the conflict */
if|if
condition|(
name|work_items
condition|)
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_op_mark_resolved().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_op_mark_resolved
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|svn_boolean_t
name|resolved_text
parameter_list|,
name|svn_boolean_t
name|resolved_props
parameter_list|,
name|svn_boolean_t
name|resolved_tree
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|total_affected_rows
init|=
literal|0
decl_stmt|;
name|svn_boolean_t
name|resolved_all
decl_stmt|;
name|apr_size_t
name|conflict_len
decl_stmt|;
specifier|const
name|void
modifier|*
name|conflict_data
decl_stmt|;
name|svn_skel_t
modifier|*
name|conflicts
decl_stmt|;
comment|/* Check if we have a conflict in ACTUAL */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ACTUAL_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
return|return
name|SVN_NO_ERROR
return|;
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
name|conflict_data
operator|=
name|svn_sqlite__column_blob
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
operator|&
name|conflict_len
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|conflicts
operator|=
name|svn_skel__parse
argument_list|(
name|conflict_data
argument_list|,
name|conflict_len
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_skel_resolve
argument_list|(
operator|&
name|resolved_all
argument_list|,
name|conflicts
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|resolved_text
argument_list|,
name|resolved_props
condition|?
literal|""
else|:
name|NULL
argument_list|,
name|resolved_tree
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_ACTUAL_CONFLICT
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|resolved_all
condition|)
block|{
name|svn_stringbuf_t
modifier|*
name|sb
init|=
name|svn_skel__unparse
argument_list|(
name|conflicts
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_blob
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|sb
operator|->
name|data
argument_list|,
name|sb
operator|->
name|len
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|total_affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Now, remove the actual node if it doesn't have any more useful      information.  We only need to do this if we've remove data ourselves. */
if|if
condition|(
name|total_affected_rows
operator|>
literal|0
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_ACTUAL_EMPTY
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_mark_resolved
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|resolved_text
parameter_list|,
name|svn_boolean_t
name|resolved_props
parameter_list|,
name|svn_boolean_t
name|resolved_tree
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|db_op_mark_resolved
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|db
argument_list|,
name|resolved_text
argument_list|,
name|resolved_props
argument_list|,
name|resolved_tree
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Clear moved-to information at the delete-half of the move which  * moved LOCAL_RELPATH here. This transforms the move into a simple delete. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|clear_moved_to
parameter_list|(
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_from_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_FROM_RELPATH
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|moved_from_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CLEAR_MOVED_TO_RELPATH
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|moved_from_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|moved_from_relpath
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* One of the two alternative bodies of svn_wc__db_op_revert().  *  * Implements svn_wc__db_txn_callback_t. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|op_revert_txn
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_t
modifier|*
name|db
init|=
name|baton
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|op_depth
decl_stmt|;
name|svn_boolean_t
name|moved_here
decl_stmt|;
name|int
name|affected_rows
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_to
decl_stmt|;
comment|/* ### Similar structure to op_revert_recursive_txn, should they be          combined? */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* There was no NODE row, so attempt to delete an ACTUAL_NODE row.  */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_ACTUAL_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|affected_rows
condition|)
block|{
comment|/* Can't do non-recursive actual-only revert if actual-only              children exist. Raise an error to cancel the transaction.  */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_ACTUAL_HAS_CHILDREN
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_INVALID_OPERATION_DEPTH
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't revert '%s' without"
literal|" reverting children"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|moved_here
operator|=
name|svn_sqlite__column_boolean
argument_list|(
name|stmt
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|moved_to
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|17
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|moved_to
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_resolve_break_moved_away_internal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|svn_skel_t
modifier|*
name|conflict
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_conflict_internal
argument_list|(
operator|&
name|conflict
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
condition|)
block|{
name|svn_wc_operation_t
name|operation
decl_stmt|;
name|svn_boolean_t
name|tree_conflicted
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_read_info
argument_list|(
operator|&
name|operation
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tree_conflicted
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|conflict
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tree_conflicted
operator|&&
operator|(
name|operation
operator|==
name|svn_wc_operation_update
operator|||
name|operation
operator|==
name|svn_wc_operation_switch
operator|)
condition|)
block|{
name|svn_wc_conflict_reason_t
name|reason
decl_stmt|;
name|svn_wc_conflict_action_t
name|action
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_read_tree_conflict
argument_list|(
operator|&
name|reason
argument_list|,
operator|&
name|action
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|conflict
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason
operator|==
name|svn_wc_conflict_reason_deleted
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_resolve_delete_raise_moved_away
argument_list|(
name|db
argument_list|,
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
comment|/* ### How do we notify this? */
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|op_depth
operator|>
literal|0
operator|&&
name|op_depth
operator|==
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
condition|)
block|{
comment|/* Can't do non-recursive revert if children exist */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_GE_OP_DEPTH_CHILDREN
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_INVALID_OPERATION_DEPTH
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't revert '%s' without"
literal|" reverting children"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
comment|/* Rewrite the op-depth of all deleted children making the          direct children into roots of deletes. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_OP_DEPTH_INCREASE_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### This removes the lock, but what about the access baton? */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_WC_LOCK_ORPHAN
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If this node was moved-here, clear moved-to at the move source. */
if|if
condition|(
name|moved_here
condition|)
name|SVN_ERR
argument_list|(
name|clear_moved_to
argument_list|(
name|local_relpath
argument_list|,
name|wcroot
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_ACTUAL_NODE_LEAVING_CHANGELIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|affected_rows
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CLEAR_ACTUAL_NODE_LEAVING_CHANGELIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* One of the two alternative bodies of svn_wc__db_op_revert().  *  * Implements svn_wc__db_txn_callback_t. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|op_revert_recursive_txn
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|op_depth
decl_stmt|;
name|int
name|select_op_depth
decl_stmt|;
name|svn_boolean_t
name|moved_here
decl_stmt|;
name|int
name|affected_rows
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
comment|/* ### Similar structure to op_revert_txn, should they be          combined? */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_ACTUAL_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|affected_rows
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* actual-only revert */
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|moved_here
operator|=
name|svn_sqlite__column_boolean
argument_list|(
name|stmt
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_depth
operator|>
literal|0
operator|&&
name|op_depth
operator|!=
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_INVALID_OPERATION_DEPTH
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't revert '%s' without"
literal|" reverting parent"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
comment|/* Remove moved-here from move destinations outside the tree. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_OUTSIDE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|move_src_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|int
name|move_op_depth
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|err
operator|=
name|svn_wc__db_resolve_break_moved_away_internal
argument_list|(
name|wcroot
argument_list|,
name|move_src_relpath
argument_list|,
name|move_op_depth
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Don't delete BASE nodes */
name|select_op_depth
operator|=
name|op_depth
condition|?
name|op_depth
else|:
literal|1
expr_stmt|;
comment|/* Reverting any non wc-root node */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_NODES_ABOVE_DEPTH_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|select_op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_ACTUAL_NODE_LEAVING_CHANGELIST_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CLEAR_ACTUAL_NODE_LEAVING_CHANGELIST_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### This removes the locks, but what about the access batons? */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_WC_LOCK_ORPHAN_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_HERE_CHILDREN
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|moved_here_child_relpath
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|moved_here_child_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|err
operator|=
name|clear_moved_to
argument_list|(
name|moved_here_child_relpath
argument_list|,
name|wcroot
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
comment|/* Clear potential moved-to pointing at the target node itself. */
if|if
condition|(
name|op_depth
operator|>
literal|0
operator|&&
name|op_depth
operator|==
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
operator|&&
name|moved_here
condition|)
name|SVN_ERR
argument_list|(
name|clear_moved_to
argument_list|(
name|local_relpath
argument_list|,
name|wcroot
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_revert
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|struct
name|with_triggers_baton_t
name|wtb
init|=
block|{
name|STMT_CREATE_REVERT_LIST
block|,
name|STMT_DROP_REVERT_LIST_TRIGGERS
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|depth
condition|)
block|{
case|case
name|svn_depth_empty
case|:
name|wtb
operator|.
name|cb_func
operator|=
name|op_revert_txn
expr_stmt|;
name|wtb
operator|.
name|cb_baton
operator|=
name|db
expr_stmt|;
break|break;
case|case
name|svn_depth_infinity
case|:
name|wtb
operator|.
name|cb_func
operator|=
name|op_revert_recursive_txn
expr_stmt|;
break|break;
default|default:
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_UNSUPPORTED_FEATURE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Unsupported depth for revert of '%s'"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|with_triggers
argument_list|(
operator|&
name|wtb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_revert_list_read().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|revert_list_read
parameter_list|(
name|svn_boolean_t
modifier|*
name|reverted
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|marker_paths
parameter_list|,
name|svn_boolean_t
modifier|*
name|copied_here
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
operator|*
name|reverted
operator|=
name|FALSE
expr_stmt|;
operator|*
name|marker_paths
operator|=
name|NULL
expr_stmt|;
operator|*
name|copied_here
operator|=
name|FALSE
expr_stmt|;
operator|*
name|kind
operator|=
name|svn_node_unknown
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_REVERT_LIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"s"
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|svn_boolean_t
name|is_actual
init|=
name|svn_sqlite__column_boolean
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|svn_boolean_t
name|another_row
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|is_actual
condition|)
block|{
name|apr_size_t
name|conflict_len
decl_stmt|;
specifier|const
name|void
modifier|*
name|conflict_data
decl_stmt|;
name|conflict_data
operator|=
name|svn_sqlite__column_blob
argument_list|(
name|stmt
argument_list|,
literal|5
argument_list|,
operator|&
name|conflict_len
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict_data
condition|)
block|{
name|svn_skel_t
modifier|*
name|conflicts
init|=
name|svn_skel__parse
argument_list|(
name|conflict_data
argument_list|,
name|conflict_len
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_read_markers
argument_list|(
name|marker_paths
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|conflicts
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
condition|)
comment|/* notify */
operator|*
name|reverted
operator|=
name|TRUE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|another_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|is_actual
operator|||
name|another_row
condition|)
block|{
operator|*
name|reverted
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|)
condition|)
comment|/* repos_id */
block|{
name|int
name|op_depth
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|)
decl_stmt|;
operator|*
name|copied_here
operator|=
operator|(
name|op_depth
operator|==
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
operator|)
expr_stmt|;
block|}
operator|*
name|kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_REVERT_LIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"s"
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_revert_list_read
parameter_list|(
name|svn_boolean_t
modifier|*
name|reverted
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|marker_files
parameter_list|,
name|svn_boolean_t
modifier|*
name|copied_here
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|revert_list_read
argument_list|(
name|reverted
argument_list|,
name|marker_files
argument_list|,
name|copied_here
argument_list|,
name|kind
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|db
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_revert_list_read_copied_children().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|revert_list_read_copied_children
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|children_p
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_array_header_t
modifier|*
name|children
decl_stmt|;
name|children
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_wc__db_revert_list_copied_child_info_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_REVERT_LIST_COPIED_CHILDREN
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"sd"
argument_list|,
name|local_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|svn_wc__db_revert_list_copied_child_info_t
modifier|*
name|child_info
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_relpath
decl_stmt|;
name|child_info
operator|=
name|apr_palloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|child_info
argument_list|)
argument_list|)
expr_stmt|;
name|child_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|child_info
operator|->
name|abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|child_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|child_info
operator|->
name|kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|children
argument_list|,
name|svn_wc__db_revert_list_copied_child_info_t
operator|*
argument_list|)
operator|=
name|child_info
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|children_p
operator|=
name|children
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_revert_list_read_copied_children
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|children
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|revert_list_read_copied_children
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|children
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_revert_list_notify
parameter_list|(
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_REVERT_LIST_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"s"
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
comment|/* optimise for no row */
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|notify_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|notify_func
argument_list|(
name|notify_baton
argument_list|,
name|svn_wc_create_notify
argument_list|(
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|notify_relpath
argument_list|,
name|iterpool
argument_list|)
argument_list|,
name|svn_wc_notify_revert
argument_list|,
name|iterpool
argument_list|)
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_REVERT_LIST_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"s"
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_revert_list_done
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DROP_REVERT_LIST
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_op_remove_node().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|remove_node_txn
parameter_list|(
name|svn_boolean_t
modifier|*
name|left_changes
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|svn_boolean_t
name|destroy_wc
parameter_list|,
name|svn_boolean_t
name|destroy_changes
parameter_list|,
name|svn_revnum_t
name|not_present_rev
parameter_list|,
name|svn_wc__db_status_t
name|not_present_status
parameter_list|,
name|svn_node_kind_t
name|not_present_kind
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
comment|/* Note that unlike many similar functions it is a valid scenario for this      function to be called on a wcroot! */
comment|/* db set when destroying wc */
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|destroy_wc
operator|||
name|db
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|left_changes
condition|)
operator|*
name|left_changes
operator|=
name|FALSE
expr_stmt|;
comment|/* Need info for not_present node? */
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|not_present_rev
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|destroy_wc
operator|&&
operator|(
operator|!
name|destroy_changes
operator|||
operator|*
name|local_relpath
operator|==
literal|'\0'
operator|)
condition|)
block|{
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
comment|/* Install WQ items for deleting the unmodified files and all dirs */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_WORKING_PRESENT
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|child_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_abspath
decl_stmt|;
name|svn_node_kind_t
name|child_kind
decl_stmt|;
name|svn_boolean_t
name|have_checksum
decl_stmt|;
name|svn_filesize_t
name|recorded_size
decl_stmt|;
name|apr_int64_t
name|recorded_time
decl_stmt|;
specifier|const
name|svn_io_dirent2_t
modifier|*
name|dirent
decl_stmt|;
name|svn_boolean_t
name|modified_p
init|=
name|TRUE
decl_stmt|;
name|svn_skel_t
modifier|*
name|work_item
init|=
name|NULL
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|child_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|child_kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
name|child_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|child_relpath
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|child_kind
operator|==
name|svn_node_file
condition|)
block|{
name|have_checksum
operator|=
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|recorded_size
operator|=
name|get_recorded_size
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|recorded_time
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cancel_func
condition|)
name|err
operator|=
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
name|err
operator|=
name|svn_io_stat_dirent2
argument_list|(
operator|&
name|dirent
argument_list|,
name|child_abspath
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
name|destroy_changes
operator|||
name|dirent
operator|->
name|kind
operator|!=
name|svn_node_file
operator|||
name|child_kind
operator|!=
name|svn_node_file
condition|)
block|{
comment|/* Not interested in keeping changes */
name|modified_p
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|child_kind
operator|==
name|svn_node_file
operator|&&
name|dirent
operator|->
name|kind
operator|==
name|svn_node_file
operator|&&
name|dirent
operator|->
name|filesize
operator|==
name|recorded_size
operator|&&
name|dirent
operator|->
name|mtime
operator|==
name|recorded_time
condition|)
block|{
name|modified_p
operator|=
name|FALSE
expr_stmt|;
comment|/* File matches recorded state */
block|}
elseif|else
if|if
condition|(
name|have_checksum
condition|)
name|err
operator|=
name|svn_wc__internal_file_modified_p
argument_list|(
operator|&
name|modified_p
argument_list|,
name|db
argument_list|,
name|child_abspath
argument_list|,
name|FALSE
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
name|modified_p
condition|)
block|{
if|if
condition|(
name|left_changes
condition|)
operator|*
name|left_changes
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|child_kind
operator|==
name|svn_node_dir
condition|)
block|{
name|err
operator|=
name|svn_wc__wq_build_dir_remove
argument_list|(
operator|&
name|work_item
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|child_abspath
argument_list|,
name|FALSE
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* svn_node_file || svn_node_symlink */
block|{
name|err
operator|=
name|svn_wc__wq_build_file_remove
argument_list|(
operator|&
name|work_item
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|child_abspath
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
name|work_item
condition|)
block|{
name|err
operator|=
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_item
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|destroy_wc
operator|&&
operator|*
name|local_relpath
operator|!=
literal|'\0'
condition|)
block|{
comment|/* Create work item for destroying the root */
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR
argument_list|(
name|read_info
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|kind
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_normal
operator|||
name|status
operator|==
name|svn_wc__db_status_added
operator|||
name|status
operator|==
name|svn_wc__db_status_incomplete
condition|)
block|{
name|svn_skel_t
modifier|*
name|work_item
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_abspath
init|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|kind
operator|==
name|svn_node_dir
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__wq_build_dir_remove
argument_list|(
operator|&
name|work_item
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|,
name|destroy_changes
comment|/* recursive */
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|svn_boolean_t
name|modified_p
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
operator|!
name|destroy_changes
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__internal_file_modified_p
argument_list|(
operator|&
name|modified_p
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|modified_p
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__wq_build_file_remove
argument_list|(
operator|&
name|work_item
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|left_changes
condition|)
operator|*
name|left_changes
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_item
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Remove all nodes below local_relpath */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_NODE_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Delete the root NODE when this is not the working copy root */
if|if
condition|(
name|local_relpath
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_NODE_ALL_LAYERS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_ACTUAL_NODE_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Delete all actual nodes at or below local_relpath */
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Should we leave a not-present node? */
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|not_present_rev
argument_list|)
condition|)
block|{
name|insert_base_baton_t
name|ibb
decl_stmt|;
name|blank_ibb
argument_list|(
operator|&
name|ibb
argument_list|)
expr_stmt|;
name|ibb
operator|.
name|repos_id
operator|=
name|repos_id
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|not_present_status
operator|==
name|svn_wc__db_status_not_present
operator|||
name|not_present_status
operator|==
name|svn_wc__db_status_excluded
argument_list|)
expr_stmt|;
name|ibb
operator|.
name|status
operator|=
name|not_present_status
expr_stmt|;
name|ibb
operator|.
name|kind
operator|=
name|not_present_kind
expr_stmt|;
name|ibb
operator|.
name|repos_relpath
operator|=
name|repos_relpath
expr_stmt|;
name|ibb
operator|.
name|revision
operator|=
name|not_present_rev
expr_stmt|;
name|SVN_ERR
argument_list|(
name|insert_base_node
argument_list|(
operator|&
name|ibb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_mark_conflict_internal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|conflict
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_remove_node
parameter_list|(
name|svn_boolean_t
modifier|*
name|left_changes
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|destroy_wc
parameter_list|,
name|svn_boolean_t
name|destroy_changes
parameter_list|,
name|svn_revnum_t
name|not_present_revision
parameter_list|,
name|svn_wc__db_status_t
name|not_present_status
parameter_list|,
name|svn_node_kind_t
name|not_present_kind
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|remove_node_txn
argument_list|(
name|left_changes
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|db
argument_list|,
name|destroy_wc
argument_list|,
name|destroy_changes
argument_list|,
name|not_present_revision
argument_list|,
name|not_present_status
argument_list|,
name|not_present_kind
argument_list|,
name|conflict
argument_list|,
name|work_items
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
comment|/* Flush everything below this node in all ways */
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_infinity
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_op_set_base_depth().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_op_set_base_depth
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|int
name|affected_rows
decl_stmt|;
comment|/* Flush any entries before we start monkeying the database.  */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_NODE_BASE_DEPTH
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"iss"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|svn_token__to_word
argument_list|(
name|depth_map
argument_list|,
name|depth
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|affected_rows
operator|==
literal|0
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
literal|"The node '%s' is not a committed directory"
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_set_base_depth
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|depth
operator|>=
name|svn_depth_empty
operator|&&
name|depth
operator|<=
name|svn_depth_infinity
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
comment|/* ### We set depth on working and base to match entry behavior.          Maybe these should be separated later? */
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|db_op_set_base_depth
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|info_below_working
parameter_list|(
name|svn_boolean_t
modifier|*
name|have_base
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_work
parameter_list|,
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|below_op_depth
parameter_list|,
comment|/*< 0 is ignored */
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Convert STATUS, the raw status obtained from the presence map, to    the status appropriate for a working (op_depth> 0) node and return    it in *WORKING_STATUS. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|convert_to_working_status
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|working_status
parameter_list|,
name|svn_wc__db_status_t
name|status
parameter_list|)
block|{
name|svn_wc__db_status_t
name|work_status
init|=
name|status
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|work_status
operator|==
name|svn_wc__db_status_normal
operator|||
name|work_status
operator|==
name|svn_wc__db_status_not_present
operator|||
name|work_status
operator|==
name|svn_wc__db_status_base_deleted
operator|||
name|work_status
operator|==
name|svn_wc__db_status_incomplete
operator|||
name|work_status
operator|==
name|svn_wc__db_status_excluded
argument_list|)
expr_stmt|;
if|if
condition|(
name|work_status
operator|==
name|svn_wc__db_status_excluded
condition|)
block|{
operator|*
name|working_status
operator|=
name|svn_wc__db_status_excluded
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|work_status
operator|==
name|svn_wc__db_status_not_present
operator|||
name|work_status
operator|==
name|svn_wc__db_status_base_deleted
condition|)
block|{
comment|/* The caller should scan upwards to detect whether this          deletion has occurred because this node has been moved          away, or it is a regular deletion. Also note that the          deletion could be of the BASE tree, or a child of          something that has been copied/moved here. */
operator|*
name|working_status
operator|=
name|svn_wc__db_status_deleted
expr_stmt|;
block|}
else|else
comment|/* normal or incomplete */
block|{
comment|/* The caller should scan upwards to detect whether this          addition has occurred because of a simple addition,          a copy, or is the destination of a move. */
operator|*
name|working_status
operator|=
name|svn_wc__db_status_added
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Return the status of the node, if any, below the "working" node (or    below BELOW_OP_DEPTH if>= 0).    Set *HAVE_BASE or *HAVE_WORK to indicate if a base node or lower    working node is present, and *STATUS to the status of the first    layer below the selected node. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|info_below_working
parameter_list|(
name|svn_boolean_t
modifier|*
name|have_base
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_work
parameter_list|,
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|below_op_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
operator|*
name|have_base
operator|=
operator|*
name|have_work
operator|=
name|FALSE
expr_stmt|;
operator|*
name|status
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|below_op_depth
operator|>=
literal|0
condition|)
block|{
while|while
condition|(
name|have_row
operator|&&
operator|(
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
operator|>
name|below_op_depth
operator|)
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|have_row
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
operator|*
name|status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|int
name|op_depth
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|op_depth
operator|>
literal|0
condition|)
operator|*
name|have_work
operator|=
name|TRUE
expr_stmt|;
else|else
operator|*
name|have_base
operator|=
name|TRUE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|have_work
condition|)
name|SVN_ERR
argument_list|(
name|convert_to_working_status
argument_list|(
name|status
argument_list|,
operator|*
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Helper function for op_delete_txn */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|delete_update_movedto
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|child_moved_from_relpath
parameter_list|,
name|int
name|op_depth
parameter_list|,
specifier|const
name|char
modifier|*
name|new_moved_to_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|int
name|affected
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_MOVED_TO_RELPATH
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isds"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|child_moved_from_relpath
argument_list|,
name|op_depth
argument_list|,
name|new_moved_to_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SVN_DEBUG
comment|/* Not fatal in release mode. The move recording is broken,      but the rest of the working copy can handle this. */
name|SVN_ERR_ASSERT
argument_list|(
name|affected
operator|==
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_struct
struct|struct
name|op_delete_baton_t
block|{
specifier|const
name|char
modifier|*
name|moved_to_relpath
decl_stmt|;
comment|/* NULL if delete is not part of a move */
name|svn_skel_t
modifier|*
name|conflict
decl_stmt|;
name|svn_skel_t
modifier|*
name|work_items
decl_stmt|;
name|svn_boolean_t
name|delete_dir_externals
decl_stmt|;
name|svn_boolean_t
name|notify
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* This structure is used while rewriting move information for nodes.  *  * The most simple case of rewriting move information happens when  * a moved-away subtree is moved again:  mv A B; mv B C  * The second move requires rewriting moved-to info at or within A.  *  * Another example is a move of a subtree which had nodes moved into it:  *   mv A B/F; mv B G  * This requires rewriting such that A/F is marked has having moved to G/F.  *  * Another case is where a node becomes a nested moved node.  * A nested move happens when a subtree child is moved before or after  * the subtree itself is moved. For example:  *   mv A/F A/G; mv A B  * In this case, the move A/F -> A/G is rewritten to B/F -> B/G.  * Note that the following sequence results in the same DB state:  *   mv A B; mv B/F B/G  * We do not care about the order the moves were performed in.  * For details, see http://wiki.apache.org/subversion/MultiLayerMoves  */
end_comment

begin_struct
struct|struct
name|moved_node_t
block|{
comment|/* The source of the move. */
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
comment|/* The move destination. */
specifier|const
name|char
modifier|*
name|moved_to_relpath
decl_stmt|;
comment|/* The op-depth of the deleted node at the source of the move. */
name|int
name|op_depth
decl_stmt|;
comment|/* When>= 1 the op_depth at which local_relpath was moved to its      location. Used to find its original location outside the delete */
name|int
name|moved_from_depth
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Helper function to resolve the original location of local_relpath at OP_DEPTH    before it was moved into the tree rooted at ROOT_RELPATH. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|resolve_moved_from
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|moved_from_relpath
parameter_list|,
name|int
modifier|*
name|moved_from_op_depth
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|root_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|suffix
init|=
literal|""
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
specifier|const
name|char
modifier|*
name|m_from_relpath
decl_stmt|;
name|int
name|m_from_op_depth
decl_stmt|;
name|int
name|m_move_from_depth
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
while|while
condition|(
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
operator|>
name|op_depth
condition|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|svn_relpath_split
argument_list|(
operator|&
name|local_relpath
argument_list|,
operator|&
name|name
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|suffix
operator|=
name|svn_relpath_join
argument_list|(
name|suffix
argument_list|,
name|name
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_FROM_FOR_DELETE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
comment|/* assert(have_row); */
operator|*
name|moved_from_relpath
operator|=
name|NULL
expr_stmt|;
operator|*
name|moved_from_op_depth
operator|=
operator|-
literal|1
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|m_from_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|m_from_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|m_move_from_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_relpath_skip_ancestor
argument_list|(
name|root_relpath
argument_list|,
name|m_from_relpath
argument_list|)
condition|)
block|{
operator|*
name|moved_from_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|m_from_relpath
argument_list|,
name|suffix
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
operator|*
name|moved_from_op_depth
operator|=
name|m_from_op_depth
expr_stmt|;
comment|/* ### Ok? */
return|return
name|SVN_NO_ERROR
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|m_move_from_depth
condition|)
block|{
operator|*
name|moved_from_relpath
operator|=
name|NULL
expr_stmt|;
operator|*
name|moved_from_op_depth
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|svn_error_trace
argument_list|(
name|resolve_moved_from
argument_list|(
name|moved_from_relpath
argument_list|,
name|moved_from_op_depth
argument_list|,
name|wcroot
argument_list|,
name|root_relpath
argument_list|,
name|svn_relpath_join
argument_list|(
name|m_from_relpath
argument_list|,
name|suffix
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|m_move_from_depth
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|delete_node
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|op_delete_baton_t
modifier|*
name|b
init|=
name|baton
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|,
name|op_root
decl_stmt|;
name|svn_boolean_t
name|add_work
init|=
name|FALSE
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|int
name|working_op_depth
decl_stmt|;
comment|/* Depth of what is to be deleted */
name|int
name|keep_op_depth
init|=
literal|0
decl_stmt|;
comment|/* Depth of what is below what is deleted */
name|svn_node_kind_t
name|kind
decl_stmt|;
name|apr_array_header_t
modifier|*
name|moved_nodes
init|=
name|NULL
decl_stmt|;
name|int
name|delete_op_depth
init|=
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
decl_stmt|;
name|assert
argument_list|(
operator|*
name|local_relpath
argument_list|)
expr_stmt|;
comment|/* Can't delete wcroot */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
name|working_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
name|kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|working_op_depth
operator|<
name|delete_op_depth
condition|)
block|{
name|op_root
operator|=
name|FALSE
expr_stmt|;
name|add_work
operator|=
name|TRUE
expr_stmt|;
name|keep_op_depth
operator|=
name|working_op_depth
expr_stmt|;
block|}
else|else
block|{
name|op_root
operator|=
name|TRUE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|svn_wc__db_status_t
name|below_status
decl_stmt|;
name|int
name|below_op_depth
decl_stmt|;
name|below_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|below_status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|below_status
operator|!=
name|svn_wc__db_status_not_present
operator|&&
name|below_status
operator|!=
name|svn_wc__db_status_base_deleted
condition|)
block|{
name|add_work
operator|=
name|TRUE
expr_stmt|;
name|keep_op_depth
operator|=
name|below_op_depth
expr_stmt|;
block|}
else|else
name|keep_op_depth
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|keep_op_depth
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|working_op_depth
operator|!=
literal|0
condition|)
comment|/* WORKING */
name|SVN_ERR
argument_list|(
name|convert_to_working_status
argument_list|(
operator|&
name|status
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_deleted
operator|||
name|status
operator|==
name|svn_wc__db_status_not_present
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Don't copy BASE directories with server excluded nodes */
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_normal
operator|&&
name|kind
operator|==
name|svn_node_dir
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_HAS_SERVER_EXCLUDED_DESCENDANTS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|absent_path
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Cannot delete '%s' as '%s' is excluded by server"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|absent_path
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_server_excluded
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Cannot delete '%s' as it is excluded by server"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_excluded
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Cannot delete '%s' as it is excluded"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|b
operator|->
name|moved_to_relpath
condition|)
block|{
specifier|const
name|char
modifier|*
name|moved_from_relpath
init|=
name|NULL
decl_stmt|;
name|struct
name|moved_node_t
modifier|*
name|moved_node
decl_stmt|;
name|int
name|move_op_depth
decl_stmt|;
name|moved_nodes
operator|=
name|apr_array_make
argument_list|(
name|scratch_pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|moved_node_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
comment|/* The node is being moved-away.        * Figure out if the node was moved-here before, or whether this        * is the first time the node is moved. */
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_added
condition|)
name|SVN_ERR
argument_list|(
name|scan_addition
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|moved_from_relpath
argument_list|,
name|NULL
argument_list|,
operator|&
name|move_op_depth
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_root
operator|&&
name|moved_from_relpath
condition|)
block|{
specifier|const
name|char
modifier|*
name|part
init|=
name|svn_relpath_skip_ancestor
argument_list|(
name|local_relpath
argument_list|,
name|moved_from_relpath
argument_list|)
decl_stmt|;
comment|/* Existing move-root is moved to another location */
name|moved_node
operator|=
name|apr_palloc
argument_list|(
name|scratch_pool
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|moved_node_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|part
condition|)
name|moved_node
operator|->
name|local_relpath
operator|=
name|moved_from_relpath
expr_stmt|;
else|else
name|moved_node
operator|->
name|local_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|b
operator|->
name|moved_to_relpath
argument_list|,
name|part
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|moved_node
operator|->
name|op_depth
operator|=
name|move_op_depth
expr_stmt|;
name|moved_node
operator|->
name|moved_to_relpath
operator|=
name|b
operator|->
name|moved_to_relpath
expr_stmt|;
name|moved_node
operator|->
name|moved_from_depth
operator|=
operator|-
literal|1
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|moved_nodes
argument_list|,
specifier|const
expr|struct
name|moved_node_t
operator|*
argument_list|)
operator|=
name|moved_node
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|op_root
operator|&&
operator|(
name|status
operator|==
name|svn_wc__db_status_normal
operator|||
name|status
operator|==
name|svn_wc__db_status_copied
operator|||
name|status
operator|==
name|svn_wc__db_status_moved_here
operator|)
condition|)
block|{
comment|/* The node is becoming a move-root for the first time,            * possibly because of a nested move operation. */
name|moved_node
operator|=
name|apr_palloc
argument_list|(
name|scratch_pool
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|moved_node_t
argument_list|)
argument_list|)
expr_stmt|;
name|moved_node
operator|->
name|local_relpath
operator|=
name|local_relpath
expr_stmt|;
name|moved_node
operator|->
name|op_depth
operator|=
name|delete_op_depth
expr_stmt|;
name|moved_node
operator|->
name|moved_to_relpath
operator|=
name|b
operator|->
name|moved_to_relpath
expr_stmt|;
name|moved_node
operator|->
name|moved_from_depth
operator|=
operator|-
literal|1
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|moved_nodes
argument_list|,
specifier|const
expr|struct
name|moved_node_t
operator|*
argument_list|)
operator|=
name|moved_node
expr_stmt|;
block|}
comment|/* Else: We can't track history of local additions and/or of things we are                about to delete. */
comment|/* And update all moved_to values still pointing to this location */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_MOVED_TO_DESCENDANTS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"iss"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|b
operator|->
name|moved_to_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Find children that were moved out of the subtree rooted at this node.    * We'll need to update their op-depth columns because their deletion    * is now implied by the deletion of their parent (i.e. this node). */
block|{
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|int
name|i
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_FOR_DELETE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|delete_op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|struct
name|moved_node_t
modifier|*
name|mn
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|mv_to_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|int
name|child_op_depth
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|int
name|moved_from_depth
init|=
operator|-
literal|1
decl_stmt|;
name|svn_boolean_t
name|fixup
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
operator|!
name|b
operator|->
name|moved_to_relpath
operator|&&
operator|!
name|svn_relpath_skip_ancestor
argument_list|(
name|local_relpath
argument_list|,
name|mv_to_relpath
argument_list|)
condition|)
block|{
comment|/* a NULL moved_here_depth will be reported as 0 */
name|int
name|moved_here_depth
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|)
decl_stmt|;
comment|/* Plain delete. Fixup move information of descendants that were                  moved here, or that were moved out */
if|if
condition|(
name|moved_here_depth
operator|>=
name|delete_op_depth
condition|)
block|{
comment|/* The move we recorded here must be moved to the location                      this node had before it was moved here.                       This might contain multiple steps when the node was moved                      in several places within the to be deleted tree */
comment|/* ### TODO: Add logic */
name|fixup
operator|=
name|TRUE
expr_stmt|;
name|moved_from_depth
operator|=
name|moved_here_depth
expr_stmt|;
block|}
else|else
block|{
comment|/* Update the op-depth of an moved away node that was                      registered as moved by the records that we are about                      to delete */
name|fixup
operator|=
name|TRUE
expr_stmt|;
name|child_op_depth
operator|=
name|delete_op_depth
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|b
operator|->
name|moved_to_relpath
condition|)
block|{
comment|/* The node is moved to a new location */
if|if
condition|(
name|delete_op_depth
operator|==
name|child_op_depth
condition|)
block|{
comment|/* Update the op-depth of a tree shadowed by this tree */
name|fixup
operator|=
name|TRUE
expr_stmt|;
comment|/*child_op_depth = delete_depth;*/
block|}
elseif|else
if|if
condition|(
name|child_op_depth
operator|>=
name|delete_op_depth
operator|&&
operator|!
name|svn_relpath_skip_ancestor
argument_list|(
name|local_relpath
argument_list|,
name|mv_to_relpath
argument_list|)
condition|)
block|{
comment|/* Update the move destination of something that is now moved                      away further */
name|child_relpath
operator|=
name|svn_relpath_skip_ancestor
argument_list|(
name|local_relpath
argument_list|,
name|child_relpath
argument_list|)
expr_stmt|;
if|if
condition|(
name|child_relpath
condition|)
block|{
name|child_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|b
operator|->
name|moved_to_relpath
argument_list|,
name|child_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|child_op_depth
operator|>
name|delete_op_depth
operator|&&
name|svn_relpath_skip_ancestor
argument_list|(
name|local_relpath
argument_list|,
name|child_relpath
argument_list|)
condition|)
name|child_op_depth
operator|=
name|delete_op_depth
expr_stmt|;
else|else
block|{
comment|/* Calculate depth of the shadowing at the new location */
name|child_op_depth
operator|=
name|child_op_depth
operator|-
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
operator|+
name|relpath_depth
argument_list|(
name|b
operator|->
name|moved_to_relpath
argument_list|)
expr_stmt|;
block|}
name|fixup
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|fixup
condition|)
block|{
name|mn
operator|=
name|apr_palloc
argument_list|(
name|scratch_pool
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|moved_node_t
argument_list|)
argument_list|)
expr_stmt|;
name|mn
operator|->
name|local_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|scratch_pool
argument_list|,
name|child_relpath
argument_list|)
expr_stmt|;
name|mn
operator|->
name|moved_to_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|scratch_pool
argument_list|,
name|mv_to_relpath
argument_list|)
expr_stmt|;
name|mn
operator|->
name|op_depth
operator|=
name|child_op_depth
expr_stmt|;
name|mn
operator|->
name|moved_from_depth
operator|=
name|moved_from_depth
expr_stmt|;
if|if
condition|(
operator|!
name|moved_nodes
condition|)
name|moved_nodes
operator|=
name|apr_array_make
argument_list|(
name|scratch_pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|moved_node_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|moved_nodes
argument_list|,
expr|struct
name|moved_node_t
operator|*
argument_list|)
operator|=
name|mn
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|moved_nodes
operator|&&
operator|(
name|i
operator|<
name|moved_nodes
operator|->
name|nelts
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|moved_node_t
modifier|*
name|mn
init|=
name|APR_ARRAY_IDX
argument_list|(
name|moved_nodes
argument_list|,
name|i
argument_list|,
expr|struct
name|moved_node_t
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|mn
operator|->
name|moved_from_depth
operator|>
literal|0
condition|)
block|{
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|resolve_moved_from
argument_list|(
operator|&
name|mn
operator|->
name|local_relpath
argument_list|,
operator|&
name|mn
operator|->
name|op_depth
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|mn
operator|->
name|local_relpath
argument_list|,
name|mn
operator|->
name|moved_from_depth
argument_list|,
name|scratch_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mn
operator|->
name|local_relpath
condition|)
name|svn_sort__array_delete
argument_list|(
name|moved_nodes
argument_list|,
name|i
operator|--
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|b
operator|->
name|moved_to_relpath
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CLEAR_MOVED_TO_DESCENDANTS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_root
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CLEAR_MOVED_TO_FROM_DEST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* ### Put actual-only nodes into the list? */
if|if
condition|(
name|b
operator|->
name|notify
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_DELETE_LIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|working_op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_NODES_ABOVE_DEPTH_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|delete_op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Delete ACTUAL_NODE rows, but leave those that have changelist      and a NODES row. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_ACTUAL_NODE_LEAVING_CHANGELIST_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CLEAR_ACTUAL_NODE_LEAVING_CHANGELIST_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_WC_LOCK_ORPHAN_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|add_work
condition|)
block|{
comment|/* Delete the node at LOCAL_RELPATH, and possibly mark it as moved. */
comment|/* Delete the node and possible descendants. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_DELETE_FROM_NODE_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|keep_op_depth
argument_list|,
name|delete_op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|moved_nodes
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|moved_nodes
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
block|{
specifier|const
name|struct
name|moved_node_t
modifier|*
name|moved_node
init|=
name|APR_ARRAY_IDX
argument_list|(
name|moved_nodes
argument_list|,
name|i
argument_list|,
name|void
operator|*
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|delete_update_movedto
argument_list|(
name|wcroot
argument_list|,
name|moved_node
operator|->
name|local_relpath
argument_list|,
name|moved_node
operator|->
name|op_depth
argument_list|,
name|moved_node
operator|->
name|moved_to_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_FILE_EXTERNALS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|b
operator|->
name|delete_dir_externals
condition|?
name|STMT_DELETE_EXTERNAL_REGISTATIONS
else|:
name|STMT_DELETE_FILE_EXTERNAL_REGISTATIONS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|b
operator|->
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|conflict
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_mark_conflict_internal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|b
operator|->
name|conflict
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|op_delete_txn
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CREATE_DELETE_LIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|delete_node
argument_list|(
name|baton
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_struct
struct|struct
name|op_delete_many_baton_t
block|{
name|apr_array_header_t
modifier|*
name|rel_targets
decl_stmt|;
name|svn_boolean_t
name|delete_dir_externals
decl_stmt|;
specifier|const
name|svn_skel_t
modifier|*
name|work_items
decl_stmt|;
block|}
name|op_delete_many_baton_t
struct|;
end_struct

begin_function
specifier|static
name|svn_error_t
modifier|*
name|op_delete_many_txn
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|op_delete_many_baton_t
modifier|*
name|odmb
init|=
name|baton
decl_stmt|;
name|struct
name|op_delete_baton_t
name|odb
decl_stmt|;
name|int
name|i
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|odb
operator|.
name|moved_to_relpath
operator|=
name|NULL
expr_stmt|;
name|odb
operator|.
name|conflict
operator|=
name|NULL
expr_stmt|;
name|odb
operator|.
name|work_items
operator|=
name|NULL
expr_stmt|;
name|odb
operator|.
name|delete_dir_externals
operator|=
name|odmb
operator|->
name|delete_dir_externals
expr_stmt|;
name|odb
operator|.
name|notify
operator|=
name|TRUE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CREATE_DELETE_LIST
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|odmb
operator|->
name|rel_targets
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|target_relpath
init|=
name|APR_ARRAY_IDX
argument_list|(
name|odmb
operator|->
name|rel_targets
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|delete_node
argument_list|(
operator|&
name|odb
argument_list|,
name|wcroot
argument_list|,
name|target_relpath
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|odmb
operator|->
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|do_delete_notify
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_DELETE_LIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|notify_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|notify_abspath
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|notify_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|notify_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|notify_relpath
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|notify_func
argument_list|(
name|notify_baton
argument_list|,
name|svn_wc_create_notify
argument_list|(
name|notify_abspath
argument_list|,
name|svn_wc_notify_delete
argument_list|,
name|iterpool
argument_list|)
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We only allow cancellation after notification for all deleted nodes    * has happened. The nodes are already deleted so we should notify for    * all of them. */
if|if
condition|(
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_delete
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|moved_to_abspath
parameter_list|,
name|svn_boolean_t
name|delete_dir_externals
parameter_list|,
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
name|svn_wc__db_wcroot_t
modifier|*
name|moved_to_wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_to_relpath
decl_stmt|;
name|struct
name|op_delete_baton_t
name|odb
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
name|moved_to_abspath
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|moved_to_wcroot
argument_list|,
operator|&
name|moved_to_relpath
argument_list|,
name|db
argument_list|,
name|moved_to_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|moved_to_wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|moved_to_wcroot
operator|->
name|abspath
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_UNSUPPORTED_FEATURE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Cannot move '%s' to '%s' because they "
literal|"are not in the same working copy"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|moved_to_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
else|else
name|moved_to_relpath
operator|=
name|NULL
expr_stmt|;
name|odb
operator|.
name|moved_to_relpath
operator|=
name|moved_to_relpath
expr_stmt|;
name|odb
operator|.
name|conflict
operator|=
name|conflict
expr_stmt|;
name|odb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|odb
operator|.
name|delete_dir_externals
operator|=
name|delete_dir_externals
expr_stmt|;
if|if
condition|(
name|notify_func
condition|)
block|{
comment|/* Perform the deletion operation (transactionally), perform any          notifications necessary, and then clean out our temporary tables.  */
name|odb
operator|.
name|notify
operator|=
name|TRUE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|with_finalization
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|op_delete_txn
argument_list|,
operator|&
name|odb
argument_list|,
name|do_delete_notify
argument_list|,
name|NULL
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|notify_func
argument_list|,
name|notify_baton
argument_list|,
name|STMT_FINALIZE_DELETE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Avoid the trigger work */
name|odb
operator|.
name|notify
operator|=
name|FALSE
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|delete_node
argument_list|(
operator|&
name|odb
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_infinity
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_delete_many
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|apr_array_header_t
modifier|*
name|targets
parameter_list|,
name|svn_boolean_t
name|delete_dir_externals
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|struct
name|op_delete_many_baton_t
name|odmb
decl_stmt|;
name|int
name|i
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|odmb
operator|.
name|rel_targets
operator|=
name|apr_array_make
argument_list|(
name|scratch_pool
argument_list|,
name|targets
operator|->
name|nelts
argument_list|,
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|odmb
operator|.
name|work_items
operator|=
name|work_items
expr_stmt|;
name|odmb
operator|.
name|delete_dir_externals
operator|=
name|delete_dir_externals
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|APR_ARRAY_IDX
argument_list|(
name|targets
argument_list|,
literal|0
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
argument_list|,
name|scratch_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|targets
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|local_abspath
init|=
name|APR_ARRAY_IDX
argument_list|(
name|targets
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
name|svn_wc__db_wcroot_t
modifier|*
name|target_wcroot
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|target_wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|APR_ARRAY_IDX
argument_list|(
name|targets
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
argument_list|,
name|scratch_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|target_wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Assert that all targets are within the same working copy. */
name|SVN_ERR_ASSERT
argument_list|(
name|wcroot
operator|->
name|wc_id
operator|==
name|target_wcroot
operator|->
name|wc_id
argument_list|)
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|odmb
operator|.
name|rel_targets
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
operator|=
name|local_relpath
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|target_wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_infinity
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
comment|/* Perform the deletion operation (transactionally), perform any      notifications necessary, and then clean out our temporary tables.  */
return|return
name|svn_error_trace
argument_list|(
name|with_finalization
argument_list|(
name|wcroot
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|op_delete_many_txn
argument_list|,
operator|&
name|odmb
argument_list|,
name|do_delete_notify
argument_list|,
name|NULL
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|notify_func
argument_list|,
name|notify_baton
argument_list|,
name|STMT_FINALIZE_DELETE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Like svn_wc__db_read_info(), but taking WCROOT+LOCAL_RELPATH instead of    DB+LOCAL_ABSPATH, and outputting repos ids instead of URL+UUID. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|read_info
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
name|svn_revnum_t
modifier|*
name|changed_rev
parameter_list|,
name|apr_time_t
modifier|*
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changed_author
parameter_list|,
name|svn_depth_t
modifier|*
name|depth
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
modifier|*
name|checksum
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|target
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|original_repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|original_repos_id
parameter_list|,
name|svn_revnum_t
modifier|*
name|original_revision
parameter_list|,
name|svn_wc__db_lock_t
modifier|*
modifier|*
name|lock
parameter_list|,
name|svn_filesize_t
modifier|*
name|recorded_size
parameter_list|,
name|apr_time_t
modifier|*
name|recorded_time
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changelist
parameter_list|,
name|svn_boolean_t
modifier|*
name|conflicted
parameter_list|,
name|svn_boolean_t
modifier|*
name|op_root
parameter_list|,
name|svn_boolean_t
modifier|*
name|had_props
parameter_list|,
name|svn_boolean_t
modifier|*
name|props_mod
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_base
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_more_work
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_work
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt_info
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt_act
decl_stmt|;
name|svn_boolean_t
name|have_info
decl_stmt|;
name|svn_boolean_t
name|have_act
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
comment|/* Obtain the most likely to exist record first, to make sure we don't      have to obtain the SQLite read-lock multiple times */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt_info
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|lock
condition|?
name|STMT_SELECT_NODE_INFO_WITH_LOCK
else|:
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt_info
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_info
argument_list|,
name|stmt_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|changelist
operator|||
name|conflicted
operator|||
name|props_mod
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt_act
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ACTUAL_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt_act
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_act
argument_list|,
name|stmt_act
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|have_act
operator|=
name|FALSE
expr_stmt|;
name|stmt_act
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|have_info
condition|)
block|{
name|int
name|op_depth
decl_stmt|;
name|svn_node_kind_t
name|node_kind
decl_stmt|;
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt_info
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|node_kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt_info
argument_list|,
literal|4
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
block|{
operator|*
name|status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt_info
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_depth
operator|!=
literal|0
condition|)
comment|/* WORKING */
name|err
operator|=
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|convert_to_working_status
argument_list|(
name|status
argument_list|,
operator|*
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|kind
condition|)
block|{
operator|*
name|kind
operator|=
name|node_kind
expr_stmt|;
block|}
if|if
condition|(
name|op_depth
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|repos_id
condition|)
operator|*
name|repos_id
operator|=
name|INVALID_REPOS_ID
expr_stmt|;
if|if
condition|(
name|revision
condition|)
operator|*
name|revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
if|if
condition|(
name|repos_relpath
condition|)
comment|/* Our path is implied by our parent somewhere up the tree.                With the NULL value and status, the caller will know to                search up the tree for the base of our path.  */
operator|*
name|repos_relpath
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
comment|/* Fetch repository information. If we have a              WORKING_NODE (and have been added), then the repository              we're being added to will be dependent upon a parent. The              caller can scan upwards to locate the repository.  */
name|repos_location_from_columns
argument_list|(
name|repos_id
argument_list|,
name|revision
argument_list|,
name|repos_relpath
argument_list|,
name|stmt_info
argument_list|,
literal|1
argument_list|,
literal|5
argument_list|,
literal|2
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|changed_rev
condition|)
block|{
operator|*
name|changed_rev
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt_info
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|changed_date
condition|)
block|{
operator|*
name|changed_date
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt_info
argument_list|,
literal|9
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|changed_author
condition|)
block|{
operator|*
name|changed_author
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt_info
argument_list|,
literal|10
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|recorded_time
condition|)
block|{
operator|*
name|recorded_time
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt_info
argument_list|,
literal|13
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|depth
condition|)
block|{
if|if
condition|(
name|node_kind
operator|!=
name|svn_node_dir
condition|)
block|{
operator|*
name|depth
operator|=
name|svn_depth_unknown
expr_stmt|;
block|}
else|else
block|{
operator|*
name|depth
operator|=
name|svn_sqlite__column_token_null
argument_list|(
name|stmt_info
argument_list|,
literal|11
argument_list|,
name|depth_map
argument_list|,
name|svn_depth_unknown
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|checksum
condition|)
block|{
if|if
condition|(
name|node_kind
operator|!=
name|svn_node_file
condition|)
block|{
operator|*
name|checksum
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__column_checksum
argument_list|(
name|checksum
argument_list|,
name|stmt_info
argument_list|,
literal|6
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|recorded_size
condition|)
block|{
operator|*
name|recorded_size
operator|=
name|get_recorded_size
argument_list|(
name|stmt_info
argument_list|,
literal|7
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|target
condition|)
block|{
if|if
condition|(
name|node_kind
operator|!=
name|svn_node_symlink
condition|)
operator|*
name|target
operator|=
name|NULL
expr_stmt|;
else|else
operator|*
name|target
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt_info
argument_list|,
literal|12
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|changelist
condition|)
block|{
if|if
condition|(
name|have_act
condition|)
operator|*
name|changelist
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt_act
argument_list|,
literal|0
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
else|else
operator|*
name|changelist
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|op_depth
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|original_repos_id
condition|)
operator|*
name|original_repos_id
operator|=
name|INVALID_REPOS_ID
expr_stmt|;
if|if
condition|(
name|original_revision
condition|)
operator|*
name|original_revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
if|if
condition|(
name|original_repos_relpath
condition|)
operator|*
name|original_repos_relpath
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|repos_location_from_columns
argument_list|(
name|original_repos_id
argument_list|,
name|original_revision
argument_list|,
name|original_repos_relpath
argument_list|,
name|stmt_info
argument_list|,
literal|1
argument_list|,
literal|5
argument_list|,
literal|2
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|props_mod
condition|)
block|{
operator|*
name|props_mod
operator|=
name|have_act
operator|&&
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt_act
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|had_props
condition|)
block|{
operator|*
name|had_props
operator|=
name|SQLITE_PROPERTIES_AVAILABLE
argument_list|(
name|stmt_info
argument_list|,
literal|14
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|conflicted
condition|)
block|{
if|if
condition|(
name|have_act
condition|)
block|{
operator|*
name|conflicted
operator|=
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt_act
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* conflict_data */
block|}
else|else
operator|*
name|conflicted
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|lock
condition|)
block|{
if|if
condition|(
name|op_depth
operator|!=
literal|0
condition|)
operator|*
name|lock
operator|=
name|NULL
expr_stmt|;
else|else
operator|*
name|lock
operator|=
name|lock_from_columns
argument_list|(
name|stmt_info
argument_list|,
literal|17
argument_list|,
literal|18
argument_list|,
literal|19
argument_list|,
literal|20
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|have_work
condition|)
operator|*
name|have_work
operator|=
operator|(
name|op_depth
operator|!=
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|op_root
condition|)
block|{
operator|*
name|op_root
operator|=
operator|(
operator|(
name|op_depth
operator|>
literal|0
operator|)
operator|&&
operator|(
name|op_depth
operator|==
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
operator|)
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|have_base
operator|||
name|have_more_work
condition|)
block|{
if|if
condition|(
name|have_more_work
condition|)
operator|*
name|have_more_work
operator|=
name|FALSE
expr_stmt|;
while|while
condition|(
operator|!
name|err
operator|&&
name|op_depth
operator|!=
literal|0
condition|)
block|{
name|err
operator|=
name|svn_sqlite__step
argument_list|(
operator|&
name|have_info
argument_list|,
name|stmt_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|have_info
condition|)
break|break;
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt_info
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_more_work
condition|)
block|{
if|if
condition|(
name|op_depth
operator|>
literal|0
condition|)
operator|*
name|have_more_work
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|have_base
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|have_base
condition|)
operator|*
name|have_base
operator|=
operator|(
name|op_depth
operator|==
literal|0
operator|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|have_act
condition|)
block|{
comment|/* A row in ACTUAL_NODE should never exist without a corresponding          node in BASE_NODE and/or WORKING_NODE unless it flags a tree conflict. */
if|if
condition|(
name|svn_sqlite__column_is_null
argument_list|(
name|stmt_act
argument_list|,
literal|2
argument_list|)
condition|)
comment|/* conflict_data */
name|err
operator|=
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CORRUPT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Corrupt data for '%s'"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### What should we return?  Should we have a separate              function for reading actual-only nodes? */
comment|/* As a safety measure, until we decide if we want to use          read_info for actual-only nodes, make sure the caller asked          for the conflict status. */
name|SVN_ERR_ASSERT
argument_list|(
name|conflicted
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
operator|*
name|status
operator|=
name|svn_wc__db_status_normal
expr_stmt|;
comment|/* What! No it's not! */
if|if
condition|(
name|kind
condition|)
operator|*
name|kind
operator|=
name|svn_node_unknown
expr_stmt|;
if|if
condition|(
name|revision
condition|)
operator|*
name|revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
if|if
condition|(
name|repos_relpath
condition|)
operator|*
name|repos_relpath
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|repos_id
condition|)
operator|*
name|repos_id
operator|=
name|INVALID_REPOS_ID
expr_stmt|;
if|if
condition|(
name|changed_rev
condition|)
operator|*
name|changed_rev
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
if|if
condition|(
name|changed_date
condition|)
operator|*
name|changed_date
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|depth
condition|)
operator|*
name|depth
operator|=
name|svn_depth_unknown
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
operator|*
name|checksum
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|target
condition|)
operator|*
name|target
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|original_repos_relpath
condition|)
operator|*
name|original_repos_relpath
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|original_repos_id
condition|)
operator|*
name|original_repos_id
operator|=
name|INVALID_REPOS_ID
expr_stmt|;
if|if
condition|(
name|original_revision
condition|)
operator|*
name|original_revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
if|if
condition|(
name|lock
condition|)
operator|*
name|lock
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|recorded_size
condition|)
operator|*
name|recorded_size
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|recorded_time
condition|)
operator|*
name|recorded_time
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|changelist
condition|)
operator|*
name|changelist
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt_act
argument_list|,
literal|0
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_root
condition|)
operator|*
name|op_root
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|had_props
condition|)
operator|*
name|had_props
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|props_mod
condition|)
operator|*
name|props_mod
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|conflicted
condition|)
operator|*
name|conflicted
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|have_base
condition|)
operator|*
name|have_base
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|have_more_work
condition|)
operator|*
name|have_more_work
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|have_work
condition|)
operator|*
name|have_work
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|stmt_act
operator|!=
name|NULL
condition|)
name|err
operator|=
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt_act
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|!=
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
name|err
operator|=
name|svn_error_quick_wrap
argument_list|(
name|err
argument_list|,
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"Error reading node '%s'"
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt_info
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_info_internal
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
name|svn_revnum_t
modifier|*
name|changed_rev
parameter_list|,
name|apr_time_t
modifier|*
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changed_author
parameter_list|,
name|svn_depth_t
modifier|*
name|depth
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
modifier|*
name|checksum
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|target
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|original_repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|original_repos_id
parameter_list|,
name|svn_revnum_t
modifier|*
name|original_revision
parameter_list|,
name|svn_wc__db_lock_t
modifier|*
modifier|*
name|lock
parameter_list|,
name|svn_filesize_t
modifier|*
name|recorded_size
parameter_list|,
name|apr_time_t
modifier|*
name|recorded_time
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changelist
parameter_list|,
name|svn_boolean_t
modifier|*
name|conflicted
parameter_list|,
name|svn_boolean_t
modifier|*
name|op_root
parameter_list|,
name|svn_boolean_t
modifier|*
name|had_props
parameter_list|,
name|svn_boolean_t
modifier|*
name|props_mod
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_base
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_more_work
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_work
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|read_info
argument_list|(
name|status
argument_list|,
name|kind
argument_list|,
name|revision
argument_list|,
name|repos_relpath
argument_list|,
name|repos_id
argument_list|,
name|changed_rev
argument_list|,
name|changed_date
argument_list|,
name|changed_author
argument_list|,
name|depth
argument_list|,
name|checksum
argument_list|,
name|target
argument_list|,
name|original_repos_relpath
argument_list|,
name|original_repos_id
argument_list|,
name|original_revision
argument_list|,
name|lock
argument_list|,
name|recorded_size
argument_list|,
name|recorded_time
argument_list|,
name|changelist
argument_list|,
name|conflicted
argument_list|,
name|op_root
argument_list|,
name|had_props
argument_list|,
name|props_mod
argument_list|,
name|have_base
argument_list|,
name|have_more_work
argument_list|,
name|have_work
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_info
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_uuid
parameter_list|,
name|svn_revnum_t
modifier|*
name|changed_rev
parameter_list|,
name|apr_time_t
modifier|*
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changed_author
parameter_list|,
name|svn_depth_t
modifier|*
name|depth
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
modifier|*
name|checksum
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|target
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|original_repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|original_root_url
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|original_uuid
parameter_list|,
name|svn_revnum_t
modifier|*
name|original_revision
parameter_list|,
name|svn_wc__db_lock_t
modifier|*
modifier|*
name|lock
parameter_list|,
name|svn_filesize_t
modifier|*
name|recorded_size
parameter_list|,
name|apr_time_t
modifier|*
name|recorded_time
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changelist
parameter_list|,
name|svn_boolean_t
modifier|*
name|conflicted
parameter_list|,
name|svn_boolean_t
modifier|*
name|op_root
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_props
parameter_list|,
name|svn_boolean_t
modifier|*
name|props_mod
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_base
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_more_work
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_work
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|,
name|original_repos_id
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN4
argument_list|(
name|read_info
argument_list|(
name|status
argument_list|,
name|kind
argument_list|,
name|revision
argument_list|,
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|changed_rev
argument_list|,
name|changed_date
argument_list|,
name|changed_author
argument_list|,
name|depth
argument_list|,
name|checksum
argument_list|,
name|target
argument_list|,
name|original_repos_relpath
argument_list|,
operator|&
name|original_repos_id
argument_list|,
name|original_revision
argument_list|,
name|lock
argument_list|,
name|recorded_size
argument_list|,
name|recorded_time
argument_list|,
name|changelist
argument_list|,
name|conflicted
argument_list|,
name|op_root
argument_list|,
name|have_props
argument_list|,
name|props_mod
argument_list|,
name|have_base
argument_list|,
name|have_more_work
argument_list|,
name|have_work
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|svn_wc__db_fetch_repos_info
argument_list|(
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|repos_id
argument_list|,
name|result_pool
argument_list|)
argument_list|,
name|svn_wc__db_fetch_repos_info
argument_list|(
name|original_root_url
argument_list|,
name|original_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|original_repos_id
argument_list|,
name|result_pool
argument_list|)
argument_list|,
name|SVN_NO_ERROR
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|is_wclocked
parameter_list|(
name|svn_boolean_t
modifier|*
name|locked
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* What we really want to store about a node.  This relies on the    offset of svn_wc__db_info_t being zero. */
end_comment

begin_struct
struct|struct
name|read_children_info_item_t
block|{
name|struct
name|svn_wc__db_info_t
name|info
decl_stmt|;
name|int
name|op_depth
decl_stmt|;
name|int
name|nr_layers
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|svn_error_t
modifier|*
name|read_children_info
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_relpath
parameter_list|,
name|apr_hash_t
modifier|*
name|conflicts
parameter_list|,
name|apr_hash_t
modifier|*
name|nodes
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_root_url
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_uuid
init|=
name|NULL
decl_stmt|;
name|apr_int64_t
name|last_repos_id
init|=
name|INVALID_REPOS_ID
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_CHILDREN_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|dir_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
comment|/* CHILD item points to what we have about the node. We only provide          CHILD->item to our caller. */
name|struct
name|read_children_info_item_t
modifier|*
name|child_item
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|19
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|svn_relpath_basename
argument_list|(
name|child_relpath
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|int
name|op_depth
decl_stmt|;
name|svn_boolean_t
name|new_child
decl_stmt|;
name|child_item
operator|=
name|svn_hash_gets
argument_list|(
name|nodes
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|child_item
condition|)
name|new_child
operator|=
name|FALSE
expr_stmt|;
else|else
block|{
name|child_item
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|child_item
argument_list|)
argument_list|)
expr_stmt|;
name|new_child
operator|=
name|TRUE
expr_stmt|;
block|}
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Do we have new or better information? */
if|if
condition|(
name|new_child
operator|||
name|op_depth
operator|>
name|child_item
operator|->
name|op_depth
condition|)
block|{
name|struct
name|svn_wc__db_info_t
modifier|*
name|child
init|=
operator|&
name|child_item
operator|->
name|info
decl_stmt|;
name|child_item
operator|->
name|op_depth
operator|=
name|op_depth
expr_stmt|;
name|child
operator|->
name|kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
name|child
operator|->
name|status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_depth
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|child
operator|->
name|status
operator|==
name|svn_wc__db_status_incomplete
condition|)
name|child
operator|->
name|incomplete
operator|=
name|TRUE
expr_stmt|;
name|err
operator|=
name|convert_to_working_status
argument_list|(
operator|&
name|child
operator|->
name|status
argument_list|,
name|child
operator|->
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|op_depth
operator|!=
literal|0
condition|)
name|child
operator|->
name|revnum
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
else|else
name|child
operator|->
name|revnum
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_depth
operator|!=
literal|0
condition|)
name|child
operator|->
name|repos_relpath
operator|=
name|NULL
expr_stmt|;
else|else
name|child
operator|->
name|repos_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_depth
operator|!=
literal|0
operator|||
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|child
operator|->
name|repos_root_url
operator|=
name|NULL
expr_stmt|;
name|child
operator|->
name|repos_uuid
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|last_repos_root_url
init|=
name|NULL
decl_stmt|;
name|apr_int64_t
name|repos_id
init|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|repos_root_url
operator|||
operator|(
name|last_repos_id
operator|!=
name|INVALID_REPOS_ID
operator|&&
name|repos_id
operator|!=
name|last_repos_id
operator|)
condition|)
block|{
name|last_repos_root_url
operator|=
name|repos_root_url
expr_stmt|;
name|err
operator|=
name|svn_wc__db_fetch_repos_info
argument_list|(
operator|&
name|repos_root_url
argument_list|,
operator|&
name|repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|repos_id
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|last_repos_id
operator|==
name|INVALID_REPOS_ID
condition|)
name|last_repos_id
operator|=
name|repos_id
expr_stmt|;
comment|/* Assume working copy is all one repos_id so that a                  single cached value is sufficient. */
if|if
condition|(
name|repos_id
operator|!=
name|last_repos_id
condition|)
block|{
name|err
operator|=
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_DB_ERROR
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' comes from unexpected repository "
literal|"'%s', expected '%s'; if this node is a file "
literal|"external using the correct URL in the external "
literal|"definition can fix the problem, see issue #4087"
argument_list|)
argument_list|,
name|child_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|last_repos_root_url
argument_list|)
expr_stmt|;
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
name|child
operator|->
name|repos_root_url
operator|=
name|repos_root_url
expr_stmt|;
name|child
operator|->
name|repos_uuid
operator|=
name|repos_uuid
expr_stmt|;
block|}
name|child
operator|->
name|changed_rev
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|child
operator|->
name|changed_date
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|child
operator|->
name|changed_author
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|10
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|->
name|kind
operator|!=
name|svn_node_dir
condition|)
name|child
operator|->
name|depth
operator|=
name|svn_depth_unknown
expr_stmt|;
else|else
block|{
name|child
operator|->
name|depth
operator|=
name|svn_sqlite__column_token_null
argument_list|(
name|stmt
argument_list|,
literal|11
argument_list|,
name|depth_map
argument_list|,
name|svn_depth_unknown
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_child
condition|)
name|SVN_ERR
argument_list|(
name|is_wclocked
argument_list|(
operator|&
name|child
operator|->
name|locked
argument_list|,
name|wcroot
argument_list|,
name|child_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|child
operator|->
name|recorded_time
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|13
argument_list|)
expr_stmt|;
name|child
operator|->
name|recorded_size
operator|=
name|get_recorded_size
argument_list|(
name|stmt
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|child
operator|->
name|has_checksum
operator|=
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|child
operator|->
name|copied
operator|=
name|op_depth
operator|>
literal|0
operator|&&
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|child
operator|->
name|had_props
operator|=
name|SQLITE_PROPERTIES_AVAILABLE
argument_list|(
name|stmt
argument_list|,
literal|14
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SYMLINK
if|if
condition|(
name|child
operator|->
name|had_props
condition|)
block|{
name|apr_hash_t
modifier|*
name|properties
decl_stmt|;
name|err
operator|=
name|svn_sqlite__column_properties
argument_list|(
operator|&
name|properties
argument_list|,
name|stmt
argument_list|,
literal|14
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|child
operator|->
name|special
operator|=
operator|(
name|child
operator|->
name|had_props
operator|&&
name|svn_hash_gets
argument_list|(
name|properties
argument_list|,
name|SVN_PROP_SPECIAL
argument_list|)
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|op_depth
operator|==
literal|0
condition|)
name|child
operator|->
name|op_root
operator|=
name|FALSE
expr_stmt|;
else|else
name|child
operator|->
name|op_root
operator|=
operator|(
name|op_depth
operator|==
name|relpath_depth
argument_list|(
name|child_relpath
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|op_depth
operator|&&
name|child
operator|->
name|op_root
condition|)
name|child_item
operator|->
name|info
operator|.
name|moved_here
operator|=
name|svn_sqlite__column_boolean
argument_list|(
name|stmt
argument_list|,
literal|20
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_child
condition|)
name|svn_hash_sets
argument_list|(
name|nodes
argument_list|,
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|name
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|op_depth
operator|==
literal|0
condition|)
block|{
name|child_item
operator|->
name|info
operator|.
name|have_base
operator|=
name|TRUE
expr_stmt|;
comment|/* Get the lock info, available only at op_depth 0. */
name|child_item
operator|->
name|info
operator|.
name|lock
operator|=
name|lock_from_columns
argument_list|(
name|stmt
argument_list|,
literal|15
argument_list|,
literal|16
argument_list|,
literal|17
argument_list|,
literal|18
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
comment|/* FILE_EXTERNAL flag only on op_depth 0. */
name|child_item
operator|->
name|info
operator|.
name|file_external
operator|=
name|svn_sqlite__column_boolean
argument_list|(
name|stmt
argument_list|,
literal|22
argument_list|)
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|moved_to_relpath
decl_stmt|;
name|child_item
operator|->
name|nr_layers
operator|++
expr_stmt|;
name|child_item
operator|->
name|info
operator|.
name|have_more_work
operator|=
operator|(
name|child_item
operator|->
name|nr_layers
operator|>
literal|1
operator|)
expr_stmt|;
comment|/* A local_relpath can be moved multiple times at different op              depths and it really depends on the caller what is interesting.              We provide a simple linked list with the moved_from information */
name|moved_to_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|21
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|moved_to_relpath
condition|)
block|{
name|struct
name|svn_wc__db_moved_to_info_t
modifier|*
name|moved_to
decl_stmt|;
name|struct
name|svn_wc__db_moved_to_info_t
modifier|*
modifier|*
name|next
decl_stmt|;
specifier|const
name|char
modifier|*
name|shadow_op_relpath
decl_stmt|;
name|int
name|cur_op_depth
decl_stmt|;
name|moved_to
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|moved_to
argument_list|)
argument_list|)
expr_stmt|;
name|moved_to
operator|->
name|moved_to_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|moved_to_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|cur_op_depth
operator|=
name|relpath_depth
argument_list|(
name|child_relpath
argument_list|)
expr_stmt|;
name|shadow_op_relpath
operator|=
name|child_relpath
expr_stmt|;
while|while
condition|(
name|cur_op_depth
operator|>
name|op_depth
condition|)
block|{
name|shadow_op_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|shadow_op_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|cur_op_depth
operator|--
expr_stmt|;
block|}
name|moved_to
operator|->
name|shadow_op_root_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|shadow_op_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|next
operator|=
operator|&
name|child_item
operator|->
name|info
operator|.
name|moved_to
expr_stmt|;
while|while
condition|(
operator|*
name|next
operator|&&
literal|0
operator|<
name|strcmp
argument_list|(
operator|(
operator|*
name|next
operator|)
operator|->
name|shadow_op_root_abspath
argument_list|,
name|moved_to
operator|->
name|shadow_op_root_abspath
argument_list|)
condition|)
name|next
operator|=
operator|&
operator|(
operator|(
operator|*
name|next
operator|)
operator|->
name|next
operator|)
expr_stmt|;
name|moved_to
operator|->
name|next
operator|=
operator|*
name|next
expr_stmt|;
operator|*
name|next
operator|=
name|moved_to
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ACTUAL_CHILDREN_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|dir_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|struct
name|read_children_info_item_t
modifier|*
name|child_item
decl_stmt|;
name|struct
name|svn_wc__db_info_t
modifier|*
name|child
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|svn_relpath_basename
argument_list|(
name|child_relpath
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|child_item
operator|=
name|svn_hash_gets
argument_list|(
name|nodes
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|child_item
condition|)
block|{
name|child_item
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|child_item
argument_list|)
argument_list|)
expr_stmt|;
name|child_item
operator|->
name|info
operator|.
name|status
operator|=
name|svn_wc__db_status_not_present
expr_stmt|;
block|}
name|child
operator|=
operator|&
name|child_item
operator|->
name|info
expr_stmt|;
name|child
operator|->
name|changelist
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|child
operator|->
name|props_mod
operator|=
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SYMLINK
if|if
condition|(
name|child
operator|->
name|props_mod
condition|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|apr_hash_t
modifier|*
name|properties
decl_stmt|;
name|err
operator|=
name|svn_sqlite__column_properties
argument_list|(
operator|&
name|properties
argument_list|,
name|stmt
argument_list|,
literal|2
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|child
operator|->
name|special
operator|=
operator|(
name|NULL
operator|!=
name|svn_hash_gets
argument_list|(
name|properties
argument_list|,
name|SVN_PROP_SPECIAL
argument_list|)
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
name|child
operator|->
name|conflicted
operator|=
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* conflict */
if|if
condition|(
name|child
operator|->
name|conflicted
condition|)
name|svn_hash_sets
argument_list|(
name|conflicts
argument_list|,
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|name
argument_list|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_children_info
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|nodes
parameter_list|,
name|apr_hash_t
modifier|*
modifier|*
name|conflicts
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|dir_relpath
decl_stmt|;
operator|*
name|conflicts
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
operator|*
name|nodes
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|dir_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|dir_relpath
argument_list|,
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|read_children_info
argument_list|(
name|wcroot
argument_list|,
name|dir_relpath
argument_list|,
operator|*
name|conflicts
argument_list|,
operator|*
name|nodes
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|db_read_props
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|svn_error_t
modifier|*
name|read_single_info
parameter_list|(
specifier|const
name|struct
name|svn_wc__db_info_t
modifier|*
modifier|*
name|info
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|svn_wc__db_info_t
modifier|*
name|mtb
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
specifier|const
name|char
modifier|*
name|original_repos_relpath
decl_stmt|;
name|svn_boolean_t
name|have_work
decl_stmt|;
name|mtb
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|mtb
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|read_info
argument_list|(
operator|&
name|mtb
operator|->
name|status
argument_list|,
operator|&
name|mtb
operator|->
name|kind
argument_list|,
operator|&
name|mtb
operator|->
name|revnum
argument_list|,
operator|&
name|mtb
operator|->
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
operator|&
name|mtb
operator|->
name|changed_rev
argument_list|,
operator|&
name|mtb
operator|->
name|changed_date
argument_list|,
operator|&
name|mtb
operator|->
name|changed_author
argument_list|,
operator|&
name|mtb
operator|->
name|depth
argument_list|,
operator|&
name|checksum
argument_list|,
name|NULL
argument_list|,
operator|&
name|original_repos_relpath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|mtb
operator|->
name|lock
argument_list|,
operator|&
name|mtb
operator|->
name|recorded_size
argument_list|,
operator|&
name|mtb
operator|->
name|recorded_time
argument_list|,
operator|&
name|mtb
operator|->
name|changelist
argument_list|,
operator|&
name|mtb
operator|->
name|conflicted
argument_list|,
operator|&
name|mtb
operator|->
name|op_root
argument_list|,
operator|&
name|mtb
operator|->
name|had_props
argument_list|,
operator|&
name|mtb
operator|->
name|props_mod
argument_list|,
operator|&
name|mtb
operator|->
name|have_base
argument_list|,
operator|&
name|mtb
operator|->
name|have_more_work
argument_list|,
operator|&
name|have_work
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Query the same rows in the database again for move information */
if|if
condition|(
name|have_work
operator|&&
operator|(
name|mtb
operator|->
name|have_base
operator|||
name|mtb
operator|->
name|have_more_work
operator|)
condition|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
specifier|const
name|char
modifier|*
name|cur_relpath
init|=
name|NULL
decl_stmt|;
name|int
name|cur_op_depth
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_TO_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|struct
name|svn_wc__db_moved_to_info_t
modifier|*
name|move
decl_stmt|;
name|int
name|op_depth
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_to_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|move
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|move
argument_list|)
argument_list|)
expr_stmt|;
name|move
operator|->
name|moved_to_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|moved_to_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cur_relpath
condition|)
block|{
name|cur_relpath
operator|=
name|local_relpath
expr_stmt|;
name|cur_op_depth
operator|=
name|relpath_depth
argument_list|(
name|cur_relpath
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|cur_op_depth
operator|>
name|op_depth
condition|)
block|{
name|cur_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|cur_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|cur_op_depth
operator|--
expr_stmt|;
block|}
name|move
operator|->
name|shadow_op_root_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|cur_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|move
operator|->
name|next
operator|=
name|mtb
operator|->
name|moved_to
expr_stmt|;
name|mtb
operator|->
name|moved_to
operator|=
name|move
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Maybe we have to get some shadowed lock from BASE to make our test suite      happy... (It might be completely unrelated, but...)      This queries the same BASE row again, joined to the lock table */
if|if
condition|(
name|mtb
operator|->
name|have_base
operator|&&
operator|(
name|have_work
operator|||
name|mtb
operator|->
name|kind
operator|==
name|svn_node_file
operator|)
condition|)
block|{
name|svn_boolean_t
name|update_root
decl_stmt|;
name|svn_wc__db_lock_t
modifier|*
modifier|*
name|lock_arg
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|have_work
condition|)
name|lock_arg
operator|=
operator|&
name|mtb
operator|->
name|lock
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|lock_arg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|update_root
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|mtb
operator|->
name|file_external
operator|=
operator|(
name|update_root
operator|&&
name|mtb
operator|->
name|kind
operator|==
name|svn_node_file
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|mtb
operator|->
name|status
operator|==
name|svn_wc__db_status_added
condition|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|SVN_ERR
argument_list|(
name|scan_addition
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|mtb
operator|->
name|moved_here
operator|=
operator|(
name|status
operator|==
name|svn_wc__db_status_moved_here
operator|)
expr_stmt|;
name|mtb
operator|->
name|incomplete
operator|=
operator|(
name|status
operator|==
name|svn_wc__db_status_incomplete
operator|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|HAVE_SYMLINK
if|if
condition|(
name|mtb
operator|->
name|kind
operator|==
name|svn_node_file
operator|&&
operator|(
name|mtb
operator|->
name|had_props
operator|||
name|mtb
operator|->
name|props_mod
operator|)
condition|)
block|{
name|apr_hash_t
modifier|*
name|properties
decl_stmt|;
if|if
condition|(
name|mtb
operator|->
name|props_mod
condition|)
name|SVN_ERR
argument_list|(
name|db_read_props
argument_list|(
operator|&
name|properties
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|db_read_pristine_props
argument_list|(
operator|&
name|properties
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|TRUE
comment|/* deleted_ok */
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|mtb
operator|->
name|special
operator|=
operator|(
name|NULL
operator|!=
name|svn_hash_gets
argument_list|(
name|properties
argument_list|,
name|SVN_PROP_SPECIAL
argument_list|)
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
name|mtb
operator|->
name|has_checksum
operator|=
operator|(
name|checksum
operator|!=
name|NULL
operator|)
expr_stmt|;
name|mtb
operator|->
name|copied
operator|=
operator|(
name|original_repos_relpath
operator|!=
name|NULL
operator|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_fetch_repos_info
argument_list|(
operator|&
name|mtb
operator|->
name|repos_root_url
argument_list|,
operator|&
name|mtb
operator|->
name|repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|repos_id
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtb
operator|->
name|kind
operator|==
name|svn_node_dir
condition|)
name|SVN_ERR
argument_list|(
name|is_wclocked
argument_list|(
operator|&
name|mtb
operator|->
name|locked
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|info
operator|=
name|mtb
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_single_info
parameter_list|(
specifier|const
name|struct
name|svn_wc__db_info_t
modifier|*
modifier|*
name|info
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|read_single_info
argument_list|(
name|info
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_pristine_info
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_revnum_t
modifier|*
name|changed_rev
parameter_list|,
name|apr_time_t
modifier|*
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changed_author
parameter_list|,
name|svn_depth_t
modifier|*
name|depth
parameter_list|,
comment|/* dirs only */
specifier|const
name|svn_checksum_t
modifier|*
modifier|*
name|checksum
parameter_list|,
comment|/* files only */
specifier|const
name|char
modifier|*
modifier|*
name|target
parameter_list|,
comment|/* symlinks only */
name|svn_boolean_t
modifier|*
name|had_props
parameter_list|,
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
name|int
name|op_depth
decl_stmt|;
name|svn_wc__db_status_t
name|raw_status
decl_stmt|;
name|svn_node_kind_t
name|node_kind
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
comment|/* Obtain the most likely to exist record first, to make sure we don't      have to obtain the SQLite read-lock multiple times */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|raw_status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_depth
operator|>
literal|0
operator|&&
name|raw_status
operator|==
name|svn_wc__db_status_base_deleted
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_row
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|raw_status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
block|}
name|node_kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
block|{
if|if
condition|(
name|op_depth
operator|>
literal|0
condition|)
block|{
name|err
operator|=
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|convert_to_working_status
argument_list|(
name|status
argument_list|,
name|raw_status
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
operator|*
name|status
operator|=
name|raw_status
expr_stmt|;
block|}
if|if
condition|(
name|kind
condition|)
block|{
operator|*
name|kind
operator|=
name|node_kind
expr_stmt|;
block|}
if|if
condition|(
name|changed_rev
condition|)
block|{
operator|*
name|changed_rev
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|changed_date
condition|)
block|{
operator|*
name|changed_date
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|9
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|changed_author
condition|)
block|{
operator|*
name|changed_author
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|10
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|depth
condition|)
block|{
if|if
condition|(
name|node_kind
operator|!=
name|svn_node_dir
condition|)
block|{
operator|*
name|depth
operator|=
name|svn_depth_unknown
expr_stmt|;
block|}
else|else
block|{
operator|*
name|depth
operator|=
name|svn_sqlite__column_token_null
argument_list|(
name|stmt
argument_list|,
literal|11
argument_list|,
name|depth_map
argument_list|,
name|svn_depth_unknown
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|checksum
condition|)
block|{
if|if
condition|(
name|node_kind
operator|!=
name|svn_node_file
condition|)
block|{
operator|*
name|checksum
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|svn_error_t
modifier|*
name|err2
decl_stmt|;
name|err2
operator|=
name|svn_sqlite__column_checksum
argument_list|(
name|checksum
argument_list|,
name|stmt
argument_list|,
literal|6
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err2
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|err
condition|)
name|err
operator|=
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_error_createf
argument_list|(
name|err
operator|->
name|apr_err
argument_list|,
name|err2
argument_list|,
name|_
argument_list|(
literal|"The node '%s' has a corrupt checksum value."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|err
operator|=
name|err2
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|target
condition|)
block|{
if|if
condition|(
name|node_kind
operator|!=
name|svn_node_symlink
condition|)
operator|*
name|target
operator|=
name|NULL
expr_stmt|;
else|else
operator|*
name|target
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|12
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|had_props
condition|)
block|{
operator|*
name|had_props
operator|=
name|SQLITE_PROPERTIES_AVAILABLE
argument_list|(
name|stmt
argument_list|,
literal|14
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|props
condition|)
block|{
if|if
condition|(
name|raw_status
operator|==
name|svn_wc__db_status_normal
operator|||
name|raw_status
operator|==
name|svn_wc__db_status_incomplete
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_properties
argument_list|(
name|props
argument_list|,
name|stmt
argument_list|,
literal|14
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|props
operator|==
name|NULL
condition|)
operator|*
name|props
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|14
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|props
operator|=
name|NULL
expr_stmt|;
block|}
block|}
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_children_walker_info
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|nodes
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|dir_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|dir_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|dir_relpath
argument_list|,
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_CHILDREN_WALKER_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|dir_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|nodes
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|struct
name|svn_wc__db_walker_info_t
modifier|*
name|child
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|svn_relpath_basename
argument_list|(
name|child_relpath
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|int
name|op_depth
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|child
operator|=
name|apr_palloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|child
argument_list|)
argument_list|)
expr_stmt|;
name|child
operator|->
name|status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_depth
operator|>
literal|0
condition|)
block|{
name|err
operator|=
name|convert_to_working_status
argument_list|(
operator|&
name|child
operator|->
name|status
argument_list|,
name|child
operator|->
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|child
operator|->
name|kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
operator|*
name|nodes
argument_list|,
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|name
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_node_install_info
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|wcroot_abspath
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
modifier|*
name|sha1_checksum
parameter_list|,
name|apr_hash_t
modifier|*
modifier|*
name|pristine_props
parameter_list|,
name|apr_time_t
modifier|*
name|changed_date
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wri_abspath
condition|)
name|wri_abspath
operator|=
name|local_abspath
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
name|local_abspath
operator|!=
name|wri_abspath
operator|&&
name|strcmp
argument_list|(
name|local_abspath
argument_list|,
name|wri_abspath
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|svn_dirent_is_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' is not in working copy '%s'"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|local_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wcroot_abspath
operator|!=
name|NULL
condition|)
operator|*
name|wcroot_abspath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
if|if
condition|(
operator|!
name|err
operator|&&
name|sha1_checksum
condition|)
name|err
operator|=
name|svn_sqlite__column_checksum
argument_list|(
name|sha1_checksum
argument_list|,
name|stmt
argument_list|,
literal|6
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
operator|&&
name|pristine_props
condition|)
block|{
name|err
operator|=
name|svn_sqlite__column_properties
argument_list|(
name|pristine_props
argument_list|,
name|stmt
argument_list|,
literal|14
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* Null means no props (assuming presence normal or incomplete). */
if|if
condition|(
operator|*
name|pristine_props
operator|==
name|NULL
condition|)
operator|*
name|pristine_props
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|changed_date
condition|)
operator|*
name|changed_date
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|9
argument_list|)
expr_stmt|;
block|}
else|else
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The node '%s' is not installable"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_read_url().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|read_url_txn
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|url
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_root_url
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
name|svn_boolean_t
name|have_base
decl_stmt|;
name|SVN_ERR
argument_list|(
name|read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|have_base
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|repos_relpath
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_added
condition|)
block|{
name|SVN_ERR
argument_list|(
name|scan_addition
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_deleted
condition|)
block|{
specifier|const
name|char
modifier|*
name|base_del_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|work_del_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|scan_deletion_txn
argument_list|(
operator|&
name|base_del_relpath
argument_list|,
name|NULL
argument_list|,
operator|&
name|work_del_relpath
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|base_del_relpath
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|base_del_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|repos_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|repos_relpath
argument_list|,
name|svn_dirent_skip_ancestor
argument_list|(
name|base_del_relpath
argument_list|,
name|local_relpath
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* The parent of the WORKING delete, must be an addition */
specifier|const
name|char
modifier|*
name|work_relpath
init|=
name|NULL
decl_stmt|;
comment|/* work_del_relpath should not be NULL. However, we have                * observed instances where that assumption was not met.                * Bail out in that case instead of crashing with a segfault.                */
name|SVN_ERR_ASSERT
argument_list|(
name|work_del_relpath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|work_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|work_del_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|scan_addition
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|work_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|repos_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|repos_relpath
argument_list|,
name|svn_dirent_skip_ancestor
argument_list|(
name|work_relpath
argument_list|,
name|local_relpath
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_excluded
condition|)
block|{
specifier|const
name|char
modifier|*
name|parent_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|url2
decl_stmt|;
comment|/* Set 'url' to the *full URL* of the parent WC dir,            * and 'name' to the *single path component* that is the            * basename of this WC directory, so that joining them will result            * in the correct full URL. */
name|svn_relpath_split
argument_list|(
operator|&
name|parent_relpath
argument_list|,
operator|&
name|name
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|read_url_txn
argument_list|(
operator|&
name|url2
argument_list|,
name|wcroot
argument_list|,
name|parent_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|url
operator|=
name|svn_path_url_add_component2
argument_list|(
name|url2
argument_list|,
name|name
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
else|else
block|{
comment|/* All working statee are explicitly handled and all base statee              have a repos_relpath */
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_wc__db_fetch_repos_info
argument_list|(
operator|&
name|repos_root_url
argument_list|,
name|NULL
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|repos_id
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_root_url
operator|!=
name|NULL
operator|&&
name|repos_relpath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|url
operator|=
name|svn_path_url_add_component2
argument_list|(
name|repos_root_url
argument_list|,
name|repos_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_url
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|url
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|read_url_txn
argument_list|(
name|url
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Call RECEIVER_FUNC, passing RECEIVER_BATON, an absolute path, and    a hash table mapping<tt>char *</tt> names onto svn_string_t *    values for any properties of immediate or recursive child nodes of    LOCAL_ABSPATH, the actual query being determined by STMT_IDX.    If FILES_ONLY is true, only report properties for file child nodes.    Check for cancellation between calls of RECEIVER_FUNC. */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|cache_props_baton_t
block|{
name|svn_depth_t
name|depth
decl_stmt|;
name|svn_boolean_t
name|pristine
decl_stmt|;
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
decl_stmt|;
name|svn_cancel_func_t
name|cancel_func
decl_stmt|;
name|void
modifier|*
name|cancel_baton
decl_stmt|;
block|}
name|cache_props_baton_t
typedef|;
end_typedef

begin_function
specifier|static
name|svn_error_t
modifier|*
name|cache_props_recursive
parameter_list|(
name|void
modifier|*
name|cb_baton
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|cache_props_baton_t
modifier|*
name|baton
init|=
name|cb_baton
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|int
name|stmt_idx
decl_stmt|;
name|SVN_ERR
argument_list|(
name|populate_targets_tree
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|baton
operator|->
name|depth
argument_list|,
name|baton
operator|->
name|changelists
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CREATE_TARGET_PROP_CACHE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|baton
operator|->
name|pristine
condition|)
name|stmt_idx
operator|=
name|STMT_CACHE_TARGET_PRISTINE_PROPS
expr_stmt|;
else|else
name|stmt_idx
operator|=
name|STMT_CACHE_TARGET_PROPS
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|stmt_idx
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int64
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_props_streamily
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|pristine
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
parameter_list|,
name|svn_wc__proplist_receiver_t
name|receiver_func
parameter_list|,
name|void
modifier|*
name|receiver_baton
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|cache_props_baton_t
name|baton
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|receiver_func
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|(
name|depth
operator|==
name|svn_depth_files
operator|)
operator|||
operator|(
name|depth
operator|==
name|svn_depth_immediates
operator|)
operator|||
operator|(
name|depth
operator|==
name|svn_depth_infinity
operator|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|baton
operator|.
name|depth
operator|=
name|depth
expr_stmt|;
name|baton
operator|.
name|pristine
operator|=
name|pristine
expr_stmt|;
name|baton
operator|.
name|changelists
operator|=
name|changelists
expr_stmt|;
name|baton
operator|.
name|cancel_func
operator|=
name|cancel_func
expr_stmt|;
name|baton
operator|.
name|cancel_baton
operator|=
name|cancel_baton
expr_stmt|;
name|SVN_ERR
argument_list|(
name|with_finalization
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|cache_props_recursive
argument_list|,
operator|&
name|baton
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|STMT_DROP_TARGETS_LIST
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ALL_TARGET_PROP_CACHE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|err
operator|&&
name|have_row
condition|)
block|{
name|apr_hash_t
modifier|*
name|props
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_properties
argument_list|(
operator|&
name|props
argument_list|,
name|stmt
argument_list|,
literal|1
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* see if someone wants to cancel this operation. */
if|if
condition|(
name|cancel_func
condition|)
name|err
operator|=
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
operator|&&
name|props
operator|&&
name|apr_hash_count
argument_list|(
name|props
argument_list|)
operator|!=
literal|0
condition|)
block|{
specifier|const
name|char
modifier|*
name|child_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_abspath
decl_stmt|;
name|child_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|child_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|child_relpath
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|err
operator|=
name|receiver_func
argument_list|(
name|receiver_baton
argument_list|,
name|child_abspath
argument_list|,
name|props
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DROP_TARGET_PROP_CACHE
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Helper for svn_wc__db_read_props().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_read_props
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ACTUAL_PROPS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
operator|&&
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|err
operator|=
name|svn_sqlite__column_properties
argument_list|(
name|props
argument_list|,
name|stmt
argument_list|,
literal|0
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
else|else
name|have_row
operator|=
name|FALSE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* No local changes. Return the pristine props for this node.  */
name|SVN_ERR
argument_list|(
name|db_read_pristine_props
argument_list|(
name|props
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|FALSE
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|props
operator|==
name|NULL
condition|)
block|{
comment|/* Pristine properties are not defined for this node.          ### we need to determine whether this node is in a state that          ### allows for ACTUAL properties (ie. not deleted). for now,          ### just say all nodes, no matter the state, have at least an          ### empty set of props.  */
operator|*
name|props
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_props
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|db_read_props
argument_list|(
name|props
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_read_pristine_props
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_boolean_t
name|deleted_ok
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_wc__db_status_t
name|presence
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_PROPS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
comment|/* Examine the presence: */
name|presence
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
comment|/* For "base-deleted", it is obvious the pristine props are located      below the current node. Fetch the NODE from the next record. */
if|if
condition|(
name|presence
operator|==
name|svn_wc__db_status_base_deleted
operator|&&
name|deleted_ok
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|have_row
argument_list|)
expr_stmt|;
name|presence
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
block|}
comment|/* normal or copied: Fetch properties (during update we want      properties for incomplete as well) */
if|if
condition|(
name|presence
operator|==
name|svn_wc__db_status_normal
operator|||
name|presence
operator|==
name|svn_wc__db_status_incomplete
condition|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|err
operator|=
name|svn_sqlite__column_properties
argument_list|(
name|props
argument_list|,
name|stmt
argument_list|,
literal|0
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|props
condition|)
operator|*
name|props
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The node '%s' has a status that"
literal|" has no properties."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_pristine_props
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|db_read_pristine_props
argument_list|(
name|props
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|TRUE
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_prop_retrieve_recursive
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|values
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|propname
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_CURRENT_PROPS_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|values
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|apr_hash_t
modifier|*
name|node_props
decl_stmt|;
name|svn_string_t
modifier|*
name|value
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_properties
argument_list|(
operator|&
name|node_props
argument_list|,
name|stmt
argument_list|,
literal|0
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|value
operator|=
operator|(
name|node_props
condition|?
name|svn_hash_gets
argument_list|(
name|node_props
argument_list|,
name|propname
argument_list|)
else|:
name|NULL
operator|)
expr_stmt|;
if|if
condition|(
name|value
condition|)
block|{
name|svn_hash_sets
argument_list|(
operator|*
name|values
argument_list|,
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
argument_list|,
name|result_pool
argument_list|)
argument_list|,
name|svn_string_dup
argument_list|(
name|value
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_read_cached_iprops(). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_read_cached_iprops
parameter_list|(
name|apr_array_header_t
modifier|*
modifier|*
name|iprops
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_IPROPS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_iprops
argument_list|(
name|iprops
argument_list|,
name|stmt
argument_list|,
literal|0
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_cached_iprops
parameter_list|(
name|apr_array_header_t
modifier|*
modifier|*
name|iprops
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
comment|/* Don't use with_txn yet, as we perform just a single transaction */
name|SVN_ERR
argument_list|(
name|db_read_cached_iprops
argument_list|(
name|iprops
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|iprops
condition|)
block|{
operator|*
name|iprops
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_prop_inherited_item_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Remove all prop name value pairs from PROP_HASH where the property    name is not PROPNAME. */
end_comment

begin_function
specifier|static
name|void
name|filter_unwanted_props
parameter_list|(
name|apr_hash_t
modifier|*
name|prop_hash
parameter_list|,
specifier|const
name|char
modifier|*
name|propname
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_index_t
modifier|*
name|hi
decl_stmt|;
for|for
control|(
name|hi
operator|=
name|apr_hash_first
argument_list|(
name|scratch_pool
argument_list|,
name|prop_hash
argument_list|)
init|;
name|hi
condition|;
name|hi
operator|=
name|apr_hash_next
argument_list|(
name|hi
argument_list|)
control|)
block|{
specifier|const
name|char
modifier|*
name|ipropname
init|=
name|svn__apr_hash_index_key
argument_list|(
name|hi
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|ipropname
argument_list|,
name|propname
argument_list|)
operator|!=
literal|0
condition|)
name|svn_hash_sets
argument_list|(
name|prop_hash
argument_list|,
name|ipropname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* Get the changed properties as stored in the ACTUAL table */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_get_changed_props
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|actual_props
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ACTUAL_PROPS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
operator|&&
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_properties
argument_list|(
name|actual_props
argument_list|,
name|stmt
argument_list|,
literal|0
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|*
name|actual_props
operator|=
name|NULL
expr_stmt|;
comment|/* Cached when we read that record */
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_read_inherited_props().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_read_inherited_props
parameter_list|(
name|apr_array_header_t
modifier|*
modifier|*
name|inherited_props
parameter_list|,
name|apr_hash_t
modifier|*
modifier|*
name|actual_props
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|propname
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|apr_array_header_t
modifier|*
name|cached_iprops
init|=
name|NULL
decl_stmt|;
name|apr_array_header_t
modifier|*
name|iprops
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
specifier|const
name|char
modifier|*
name|relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|expected_parent_repos_relpath
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|parent_relpath
decl_stmt|;
name|iprops
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_prop_inherited_item_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|inherited_props
operator|=
name|iprops
expr_stmt|;
if|if
condition|(
name|actual_props
condition|)
operator|*
name|actual_props
operator|=
name|NULL
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|relpath
operator|=
name|local_relpath
expr_stmt|;
comment|/* Walk up to the root of the WC looking for inherited properties.  When we      reach the WC root also check for cached inherited properties. */
for|for
control|(
name|relpath
operator|=
name|local_relpath
init|;
name|relpath
condition|;
name|relpath
operator|=
name|parent_relpath
control|)
block|{
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|op_depth
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|apr_hash_t
modifier|*
name|node_props
decl_stmt|;
name|parent_relpath
operator|=
name|relpath
index|[
literal|0
index|]
condition|?
name|svn_relpath_dirname
argument_list|(
name|relpath
argument_list|,
name|scratch_pool
argument_list|)
else|:
name|NULL
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|svn_wc__db_status_normal
operator|&&
name|status
operator|!=
name|svn_wc__db_status_incomplete
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The node '%s' has a status that has no properties."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|op_depth
operator|>
literal|0
condition|)
block|{
comment|/* WORKING node. Nothing to check */
block|}
elseif|else
if|if
condition|(
name|expected_parent_repos_relpath
condition|)
block|{
specifier|const
name|char
modifier|*
name|repos_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|expected_parent_repos_relpath
argument_list|,
name|repos_relpath
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* The child of this node has a different parent than this node                  (It is "switched"), so we can stop here. Note that switched                  with the same parent is not interesting for us here. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|expected_parent_repos_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|expected_parent_repos_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|repos_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|expected_parent_repos_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|repos_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|op_depth
operator|==
literal|0
operator|&&
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|16
argument_list|)
condition|)
block|{
comment|/* The node contains a cache. No reason to look further */
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_iprops
argument_list|(
operator|&
name|cached_iprops
argument_list|,
name|stmt
argument_list|,
literal|16
argument_list|,
name|result_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|parent_relpath
operator|=
name|NULL
expr_stmt|;
comment|/* Stop after this */
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_properties
argument_list|(
operator|&
name|node_props
argument_list|,
name|stmt
argument_list|,
literal|14
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If PARENT_ABSPATH is a parent of LOCAL_ABSPATH, then LOCAL_ABSPATH          can inherit properties from it. */
if|if
condition|(
name|relpath
operator|!=
name|local_relpath
condition|)
block|{
name|apr_hash_t
modifier|*
name|changed_props
decl_stmt|;
name|SVN_ERR
argument_list|(
name|db_get_changed_props
argument_list|(
operator|&
name|changed_props
argument_list|,
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|result_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|changed_props
condition|)
name|node_props
operator|=
name|changed_props
expr_stmt|;
elseif|else
if|if
condition|(
name|node_props
condition|)
name|node_props
operator|=
name|svn_prop_hash_dup
argument_list|(
name|node_props
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|node_props
operator|&&
name|apr_hash_count
argument_list|(
name|node_props
argument_list|)
condition|)
block|{
comment|/* If we only want PROPNAME filter out any other properties. */
if|if
condition|(
name|propname
condition|)
name|filter_unwanted_props
argument_list|(
name|node_props
argument_list|,
name|propname
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|apr_hash_count
argument_list|(
name|node_props
argument_list|)
condition|)
block|{
name|svn_prop_inherited_item_t
modifier|*
name|iprop_elt
init|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_prop_inherited_item_t
argument_list|)
argument_list|)
decl_stmt|;
name|iprop_elt
operator|->
name|path_or_url
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|iprop_elt
operator|->
name|prop_hash
operator|=
name|node_props
expr_stmt|;
comment|/* Build the output array in depth-first order. */
name|svn_sort__array_insert
argument_list|(
operator|&
name|iprop_elt
argument_list|,
name|iprops
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|actual_props
condition|)
block|{
name|apr_hash_t
modifier|*
name|changed_props
decl_stmt|;
name|SVN_ERR
argument_list|(
name|db_get_changed_props
argument_list|(
operator|&
name|changed_props
argument_list|,
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|result_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|changed_props
condition|)
operator|*
name|actual_props
operator|=
name|changed_props
expr_stmt|;
elseif|else
if|if
condition|(
name|node_props
condition|)
operator|*
name|actual_props
operator|=
name|svn_prop_hash_dup
argument_list|(
name|node_props
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cached_iprops
condition|)
block|{
for|for
control|(
name|i
operator|=
name|cached_iprops
operator|->
name|nelts
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|svn_prop_inherited_item_t
modifier|*
name|cached_iprop
init|=
name|APR_ARRAY_IDX
argument_list|(
name|cached_iprops
argument_list|,
name|i
argument_list|,
name|svn_prop_inherited_item_t
operator|*
argument_list|)
decl_stmt|;
comment|/* An empty property hash in the iprops cache means there are no              inherited properties. */
if|if
condition|(
name|apr_hash_count
argument_list|(
name|cached_iprop
operator|->
name|prop_hash
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|propname
condition|)
name|filter_unwanted_props
argument_list|(
name|cached_iprop
operator|->
name|prop_hash
argument_list|,
name|propname
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* If we didn't filter everything then keep this iprop. */
if|if
condition|(
name|apr_hash_count
argument_list|(
name|cached_iprop
operator|->
name|prop_hash
argument_list|)
condition|)
name|svn_sort__array_insert
argument_list|(
operator|&
name|cached_iprop
argument_list|,
name|iprops
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|actual_props
operator|&&
operator|!
operator|*
name|actual_props
condition|)
operator|*
name|actual_props
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_inherited_props
parameter_list|(
name|apr_array_header_t
modifier|*
modifier|*
name|iprops
parameter_list|,
name|apr_hash_t
modifier|*
modifier|*
name|actual_props
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|propname
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|db_read_inherited_props
argument_list|(
name|iprops
argument_list|,
name|actual_props
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|propname
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_get_children_with_cached_iprops().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_children_with_cached_iprops
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|iprop_paths
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
operator|*
name|iprop_paths
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
comment|/* First check if LOCAL_RELPATH itself has iprops */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_IPROPS_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|relpath_with_cache
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|abspath_with_cache
init|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|relpath_with_cache
argument_list|,
name|result_pool
argument_list|)
decl_stmt|;
name|svn_hash_sets
argument_list|(
operator|*
name|iprop_paths
argument_list|,
name|abspath_with_cache
argument_list|,
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|depth
operator|==
name|svn_depth_empty
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Now fetch information for children or all descendants */
if|if
condition|(
name|depth
operator|==
name|svn_depth_files
operator|||
name|depth
operator|==
name|svn_depth_immediates
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_IPROPS_CHILDREN
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* Default to svn_depth_infinity. */
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_IPROPS_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|relpath_with_cache
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|abspath_with_cache
init|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|relpath_with_cache
argument_list|,
name|result_pool
argument_list|)
decl_stmt|;
name|svn_hash_sets
argument_list|(
operator|*
name|iprop_paths
argument_list|,
name|abspath_with_cache
argument_list|,
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* For depth files we should filter non files */
if|if
condition|(
name|depth
operator|==
name|svn_depth_files
condition|)
block|{
name|apr_hash_index_t
modifier|*
name|hi
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
for|for
control|(
name|hi
operator|=
name|apr_hash_first
argument_list|(
name|scratch_pool
argument_list|,
operator|*
name|iprop_paths
argument_list|)
init|;
name|hi
condition|;
name|hi
operator|=
name|apr_hash_next
argument_list|(
name|hi
argument_list|)
control|)
block|{
specifier|const
name|char
modifier|*
name|child_abspath
init|=
name|svn__apr_hash_index_key
argument_list|(
name|hi
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_relpath
decl_stmt|;
name|svn_node_kind_t
name|child_kind
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|child_relpath
operator|=
name|svn_dirent_is_child
argument_list|(
name|local_relpath
argument_list|,
name|child_abspath
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|child_relpath
condition|)
block|{
continue|continue;
comment|/* local_relpath itself */
block|}
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|NULL
argument_list|,
operator|&
name|child_kind
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|child_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Filter if not a file */
if|if
condition|(
name|child_kind
operator|!=
name|svn_node_file
condition|)
block|{
name|svn_hash_sets
argument_list|(
operator|*
name|iprop_paths
argument_list|,
name|child_abspath
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_get_children_with_cached_iprops
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|iprop_paths
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|get_children_with_cached_iprops
argument_list|(
name|iprop_paths
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|depth
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_children_of_working_node
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|children
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|gather_children2
argument_list|(
name|children
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Helper for svn_wc__db_node_check_replace().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|check_replace_txn
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_replace_root_p
parameter_list|,
name|svn_boolean_t
modifier|*
name|base_replace_p
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_replace_p
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_boolean_t
name|is_replace
init|=
name|FALSE
decl_stmt|;
name|int
name|replaced_op_depth
decl_stmt|;
name|svn_wc__db_status_t
name|replaced_status
decl_stmt|;
comment|/* Our caller initialized the output values to FALSE */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|svn_wc__db_status_normal
condition|)
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
name|replaced_status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
comment|/* If the layer below the add describes a not present or a deleted node,      this is not a replacement. Deleted can only occur if an ancestor is      the delete root. */
if|if
condition|(
name|replaced_status
operator|!=
name|svn_wc__db_status_not_present
operator|&&
name|replaced_status
operator|!=
name|svn_wc__db_status_excluded
operator|&&
name|replaced_status
operator|!=
name|svn_wc__db_status_server_excluded
operator|&&
name|replaced_status
operator|!=
name|svn_wc__db_status_base_deleted
condition|)
block|{
name|is_replace
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|is_replace_p
condition|)
operator|*
name|is_replace_p
operator|=
name|TRUE
expr_stmt|;
block|}
name|replaced_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|base_replace_p
condition|)
block|{
name|int
name|op_depth
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
decl_stmt|;
while|while
condition|(
name|op_depth
operator|!=
literal|0
operator|&&
name|have_row
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|have_row
operator|&&
name|op_depth
operator|==
literal|0
condition|)
block|{
name|svn_wc__db_status_t
name|base_status
decl_stmt|;
name|base_status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
operator|*
name|base_replace_p
operator|=
operator|(
name|base_status
operator|!=
name|svn_wc__db_status_not_present
operator|)
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_replace_root_p
operator|||
operator|!
name|is_replace
condition|)
return|return
name|SVN_NO_ERROR
return|;
if|if
condition|(
name|replaced_status
operator|!=
name|svn_wc__db_status_base_deleted
condition|)
block|{
name|int
name|parent_op_depth
decl_stmt|;
comment|/* Check the current op-depth of the parent to see if we are a replacement          root */
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|svn_relpath_dirname
argument_list|(
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_row
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Parent must exist as 'normal' */
name|parent_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|parent_op_depth
operator|>=
name|replaced_op_depth
condition|)
block|{
comment|/* Did we replace inside our directory? */
operator|*
name|is_replace_root_p
operator|=
operator|(
name|parent_op_depth
operator|==
name|replaced_op_depth
operator|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
name|parent_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
operator|*
name|is_replace_root_p
operator|=
name|TRUE
expr_stmt|;
comment|/* Parent is no replacement */
elseif|else
if|if
condition|(
name|parent_op_depth
operator|<
name|replaced_op_depth
condition|)
operator|*
name|is_replace_root_p
operator|=
name|TRUE
expr_stmt|;
comment|/* Parent replaces a lower layer */
comment|/*else // No replacement root */
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_node_check_replace
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_replace_root
parameter_list|,
name|svn_boolean_t
modifier|*
name|base_replace
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_replace
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_replace_root
condition|)
operator|*
name|is_replace_root
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|base_replace
condition|)
operator|*
name|base_replace
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|is_replace
condition|)
operator|*
name|is_replace
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|local_relpath
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Working copy root can't be replaced */
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|check_replace_txn
argument_list|(
name|is_replace_root
argument_list|,
name|base_replace
argument_list|,
name|is_replace
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_children
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|children
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|gather_children
argument_list|(
name|children
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|relocate_txn
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|svn_boolean_t
name|have_base_node
parameter_list|,
name|apr_int64_t
name|old_repos_id
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|apr_int64_t
name|new_repos_id
decl_stmt|;
comment|/* This function affects all the children of the given local_relpath,      but the way that it does this is through the repos inheritance mechanism.      So, we only need to rewrite the repos_id of the given local_relpath,      as well as any children with a non-null repos_id, as well as various      repos_id fields in the locks and working_node tables.    */
comment|/* Get the repos_id for the new repository. */
name|SVN_ERR
argument_list|(
name|create_repos_id
argument_list|(
operator|&
name|new_repos_id
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set the (base and working) repos_ids and clear the dav_caches */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_RECURSIVE_UPDATE_NODE_REPO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isii"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|old_repos_id
argument_list|,
name|new_repos_id
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_base_node
condition|)
block|{
comment|/* Update any locks for the root or its children. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_LOCK_REPOS_ID
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"ii"
argument_list|,
name|old_repos_id
argument_list|,
name|new_repos_id
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_global_relocate
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_dir_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_dir_relpath
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_uuid
decl_stmt|;
name|svn_boolean_t
name|have_base_node
decl_stmt|;
name|apr_int64_t
name|old_repos_id
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_dir_abspath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### assert that we were passed a directory?  */
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_dir_relpath
argument_list|,
name|db
argument_list|,
name|local_dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|local_dir_relpath
expr_stmt|;
name|SVN_ERR
argument_list|(
name|read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|old_repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|have_base_node
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_excluded
condition|)
block|{
comment|/* The parent cannot be excluded, so look at the parent and then          adjust the relpath */
specifier|const
name|char
modifier|*
name|parent_relpath
init|=
name|svn_relpath_dirname
argument_list|(
name|local_dir_relpath
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|old_repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|parent_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|local_dir_relpath
operator|=
name|parent_relpath
expr_stmt|;
block|}
if|if
condition|(
name|old_repos_id
operator|==
name|INVALID_REPOS_ID
condition|)
block|{
comment|/* Do we need to support relocating something that is          added/deleted/excluded without relocating the parent?  If not          then perhaps relpath, root_url and uuid should be passed down          to the children so that they don't have to scan? */
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_deleted
condition|)
block|{
specifier|const
name|char
modifier|*
name|work_del_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|scan_deletion_txn
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|work_del_relpath
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_dir_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|work_del_relpath
condition|)
block|{
comment|/* Deleted within a copy/move */
comment|/* The parent of the delete is added. */
name|status
operator|=
name|svn_wc__db_status_added
expr_stmt|;
name|local_dir_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|work_del_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_added
condition|)
block|{
name|SVN_ERR
argument_list|(
name|scan_addition
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|old_repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_dir_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|old_repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_dir_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_wc__db_fetch_repos_info
argument_list|(
name|NULL
argument_list|,
operator|&
name|repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|old_repos_id
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_uuid
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|relocate_txn
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|have_base_node
argument_list|,
name|old_repos_id
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Helper for commit_node()    Set *REPOS_ID and *REPOS_RELPATH to the BASE repository location of    (WCROOT, LOCAL_RELPATH), directly if its BASE row exists or implied from    its parent's BASE row if not. In the latter case, error if the parent    BASE row does not exist.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|determine_commit_repos_info
parameter_list|(
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|op_depth
decl_stmt|;
comment|/* Prefer the current node's repository information.  */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_depth
operator|>
literal|0
condition|)
block|{
name|svn_wc__db_status_t
name|presence
init|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
decl_stmt|;
if|if
condition|(
name|presence
operator|==
name|svn_wc__db_status_base_deleted
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_row
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* There must be a row */
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|parent_repos_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|parent_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* The repository relative path of an add/copy is based on its              ancestor, not on the shadowed base layer.               As this function is only used from the commit processing we know              the parent directory has only a BASE row, so we can just obtain              the information directly by recursing (once!)  */
name|svn_relpath_split
argument_list|(
operator|&
name|parent_relpath
argument_list|,
operator|&
name|name
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|determine_commit_repos_info
argument_list|(
name|repos_id
argument_list|,
operator|&
name|parent_repos_relpath
argument_list|,
name|wcroot
argument_list|,
name|parent_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|repos_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|parent_repos_relpath
argument_list|,
name|name
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
name|SVN_ERR_ASSERT
argument_list|(
name|op_depth
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* And that row must be BASE */
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|repos_id
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|repos_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Helper for svn_wc__db_global_commit()     Makes local_relpath and all its descendants at the same op-depth represent    the copy origin repos_id:repos_relpath@revision.     This code is only valid to fix-up a move from an old location, to a new    location during a commit.     Assumptions:      * local_relpath is not the working copy root (can't be moved)      * repos_relpath is not the repository root (can't be moved)    */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|moved_descendant_commit
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|apr_int64_t
name|repos_id
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|children
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_hash_index_t
modifier|*
name|hi
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|*
name|local_relpath
operator|!=
literal|'\0'
operator|&&
operator|*
name|repos_relpath
operator|!=
literal|'\0'
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_DESCENDANTS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
name|children
operator|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* First, obtain all moved children */
comment|/* To keep error handling simple, first cache them in a hashtable */
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|src_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|to_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|svn_hash_sets
argument_list|(
name|children
argument_list|,
name|src_relpath
argument_list|,
name|to_relpath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Then update them */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_COMMIT_UPDATE_ORIGIN
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
for|for
control|(
name|hi
operator|=
name|apr_hash_first
argument_list|(
name|scratch_pool
argument_list|,
name|children
argument_list|)
init|;
name|hi
condition|;
name|hi
operator|=
name|apr_hash_next
argument_list|(
name|hi
argument_list|)
control|)
block|{
specifier|const
name|char
modifier|*
name|src_relpath
init|=
name|svn__apr_hash_index_key
argument_list|(
name|hi
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|to_relpath
init|=
name|svn__apr_hash_index_val
argument_list|(
name|hi
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|new_repos_relpath
decl_stmt|;
name|int
name|to_op_depth
init|=
name|relpath_depth
argument_list|(
name|to_relpath
argument_list|)
decl_stmt|;
name|int
name|affected
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|to_op_depth
operator|>
literal|0
argument_list|)
expr_stmt|;
name|new_repos_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|repos_relpath
argument_list|,
name|svn_relpath_skip_ancestor
argument_list|(
name|local_relpath
argument_list|,
name|src_relpath
argument_list|)
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdisr"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|to_relpath
argument_list|,
name|to_op_depth
argument_list|,
name|repos_id
argument_list|,
name|new_repos_relpath
argument_list|,
name|revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SVN_DEBUG
comment|/* Enable in release code?          Broken moves are not fatal yet, but this assertion would break          committing them */
name|SVN_ERR_ASSERT
argument_list|(
name|affected
operator|>=
literal|1
argument_list|)
expr_stmt|;
comment|/* If this fails there is no move dest */
endif|#
directive|endif
name|SVN_ERR
argument_list|(
name|moved_descendant_commit
argument_list|(
name|wcroot
argument_list|,
name|to_relpath
argument_list|,
name|to_op_depth
argument_list|,
name|repos_id
argument_list|,
name|new_repos_relpath
argument_list|,
name|revision
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Helper for svn_wc__db_global_commit()     Moves all nodes below LOCAL_RELPATH from op-depth OP_DEPTH to op-depth 0    (BASE), setting their presence to 'not-present' if their presence wasn't    'normal'.     Makes all nodes below LOCAL_RELPATH represent the descendants of repository    location repos_id:repos_relpath@revision.     Assumptions:      * local_relpath is not the working copy root (can't be replaced)      * repos_relpath is not the repository root (can't be replaced)    */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|descendant_commit
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|apr_int64_t
name|repos_id
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|*
name|local_relpath
operator|!=
literal|'\0'
operator|&&
operator|*
name|repos_relpath
operator|!=
literal|'\0'
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_COMMIT_DESCENDANTS_TO_BASE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdisr"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|,
name|repos_id
argument_list|,
name|repos_relpath
argument_list|,
name|revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_global_commit().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|commit_node
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_revnum_t
name|new_revision
parameter_list|,
name|svn_revnum_t
name|changed_rev
parameter_list|,
name|apr_time_t
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
name|changed_author
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|new_checksum
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|new_children
parameter_list|,
name|apr_hash_t
modifier|*
name|new_dav_cache
parameter_list|,
name|svn_boolean_t
name|keep_changelist
parameter_list|,
name|svn_boolean_t
name|no_unlock
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt_info
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt_act
decl_stmt|;
name|svn_boolean_t
name|have_act
decl_stmt|;
name|svn_string_t
name|prop_blob
init|=
block|{
literal|0
block|}
decl_stmt|;
name|svn_string_t
name|inherited_prop_blob
init|=
block|{
literal|0
block|}
decl_stmt|;
specifier|const
name|char
modifier|*
name|changelist
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|parent_relpath
decl_stmt|;
name|svn_wc__db_status_t
name|new_presence
decl_stmt|;
name|svn_node_kind_t
name|new_kind
decl_stmt|;
specifier|const
name|char
modifier|*
name|new_depth_str
init|=
name|NULL
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
name|int
name|op_depth
decl_stmt|;
name|svn_wc__db_status_t
name|old_presence
decl_stmt|;
comment|/* If we are adding a file or directory, then we need to get      repository information from the parent node since "this node" does      not have a BASE).       For existing nodes, we should retain the (potentially-switched)      repository information.  */
name|SVN_ERR
argument_list|(
name|determine_commit_repos_info
argument_list|(
operator|&
name|repos_id
argument_list|,
operator|&
name|repos_relpath
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### is it better to select only the data needed?  */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt_info
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt_info
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_row
argument_list|(
name|stmt_info
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt_act
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ACTUAL_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt_act
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_act
argument_list|,
name|stmt_act
argument_list|)
argument_list|)
expr_stmt|;
comment|/* There should be something to commit!  */
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt_info
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Figure out the new node's kind. It will be whatever is in WORKING_NODE,      or there will be a BASE_NODE that has it.  */
name|new_kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt_info
argument_list|,
literal|4
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
comment|/* What will the new depth be?  */
if|if
condition|(
name|new_kind
operator|==
name|svn_node_dir
condition|)
name|new_depth_str
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt_info
argument_list|,
literal|11
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* Check that the repository information is not being changed.  */
if|if
condition|(
name|op_depth
operator|==
literal|0
condition|)
block|{
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt_info
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt_info
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* A commit cannot change these values.  */
name|SVN_ERR_ASSERT
argument_list|(
name|repos_id
operator|==
name|svn_sqlite__column_int64
argument_list|(
name|stmt_info
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|strcmp
argument_list|(
name|repos_relpath
argument_list|,
name|svn_sqlite__column_text
argument_list|(
name|stmt_info
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|)
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* Find the appropriate new properties -- ACTUAL overrides any properties      in WORKING that arrived as part of a copy/move.       Note: we'll keep them as a big blob of data, rather than      deserialize/serialize them.  */
if|if
condition|(
name|have_act
condition|)
name|prop_blob
operator|.
name|data
operator|=
name|svn_sqlite__column_blob
argument_list|(
name|stmt_act
argument_list|,
literal|1
argument_list|,
operator|&
name|prop_blob
operator|.
name|len
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|prop_blob
operator|.
name|data
operator|==
name|NULL
condition|)
name|prop_blob
operator|.
name|data
operator|=
name|svn_sqlite__column_blob
argument_list|(
name|stmt_info
argument_list|,
literal|14
argument_list|,
operator|&
name|prop_blob
operator|.
name|len
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|inherited_prop_blob
operator|.
name|data
operator|=
name|svn_sqlite__column_blob
argument_list|(
name|stmt_info
argument_list|,
literal|16
argument_list|,
operator|&
name|inherited_prop_blob
operator|.
name|len
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|keep_changelist
operator|&&
name|have_act
condition|)
name|changelist
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt_act
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|old_presence
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt_info
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
comment|/* ### other stuff?  */
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt_info
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt_act
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_depth
operator|>
literal|0
condition|)
block|{
name|int
name|affected_rows
decl_stmt|;
comment|/* This removes all layers of this node and at the same time determines          if we need to remove shadowed layers below our descendants. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_NODE_ALL_LAYERS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|affected_rows
operator|>
literal|1
condition|)
block|{
comment|/* We commit a shadowing operation             1) Remove all shadowed nodes            2) And remove all nodes that have a base-deleted as lowest layer,               because 1) removed that layer */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_SHADOWED_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Note that while these two calls look so similar that they might          be integrated, they really affect a different op-depth and          completely different nodes (via a different recursion pattern). */
comment|/* Collapse descendants of the current op_depth in layer 0 */
name|SVN_ERR
argument_list|(
name|descendant_commit
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|,
name|repos_id
argument_list|,
name|repos_relpath
argument_list|,
name|new_revision
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* And make the recorded local moves represent moves of the node we just          committed. */
name|SVN_ERR
argument_list|(
name|moved_descendant_commit
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
literal|0
argument_list|,
name|repos_id
argument_list|,
name|repos_relpath
argument_list|,
name|new_revision
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* This node is no longer modified, so no node was moved here */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CLEAR_MOVED_TO_FROM_DEST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Update or add the BASE_NODE row with all the new information.  */
if|if
condition|(
operator|*
name|local_relpath
operator|==
literal|'\0'
condition|)
name|parent_relpath
operator|=
name|NULL
expr_stmt|;
else|else
name|parent_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* Preserve any incomplete status */
name|new_presence
operator|=
operator|(
name|old_presence
operator|==
name|svn_wc__db_status_incomplete
condition|?
name|svn_wc__db_status_incomplete
else|:
name|svn_wc__db_status_normal
operator|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_APPLY_CHANGES_TO_BASE_NODE
argument_list|)
argument_list|)
expr_stmt|;
comment|/* symlink_target not yet used */
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"issisrtstrisnbn"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|parent_relpath
argument_list|,
name|repos_id
argument_list|,
name|repos_relpath
argument_list|,
name|new_revision
argument_list|,
name|presence_map
argument_list|,
name|new_presence
argument_list|,
name|new_depth_str
argument_list|,
name|kind_map
argument_list|,
name|new_kind
argument_list|,
name|changed_rev
argument_list|,
name|changed_date
argument_list|,
name|changed_author
argument_list|,
name|prop_blob
operator|.
name|data
argument_list|,
name|prop_blob
operator|.
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_checksum
argument_list|(
name|stmt
argument_list|,
literal|13
argument_list|,
name|new_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_properties
argument_list|(
name|stmt
argument_list|,
literal|15
argument_list|,
name|new_dav_cache
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|inherited_prop_blob
operator|.
name|data
operator|!=
name|NULL
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_blob
argument_list|(
name|stmt
argument_list|,
literal|17
argument_list|,
name|inherited_prop_blob
operator|.
name|data
argument_list|,
name|inherited_prop_blob
operator|.
name|len
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_act
condition|)
block|{
if|if
condition|(
name|keep_changelist
operator|&&
name|changelist
operator|!=
name|NULL
condition|)
block|{
comment|/* The user told us to keep the changelist. Replace the row in              ACTUAL_NODE with the basic keys and the changelist.  */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_RESET_ACTUAL_WITH_CHANGELIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isss"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|svn_relpath_dirname
argument_list|(
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|changelist
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Toss the ACTUAL_NODE row.  */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_ACTUAL_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|new_kind
operator|==
name|svn_node_dir
condition|)
block|{
comment|/* When committing a directory, we should have its new children.  */
comment|/* ### one day. just not today.  */
if|#
directive|if
literal|0
block|SVN_ERR_ASSERT(new_children != NULL);
endif|#
directive|endif
comment|/* ### process the children  */
block|}
if|if
condition|(
operator|!
name|no_unlock
condition|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|lock_stmt
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|lock_stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_LOCK_RECURSIVELY
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|lock_stmt
argument_list|,
literal|"is"
argument_list|,
name|repos_id
argument_list|,
name|repos_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|lock_stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Install any work items into the queue, as part of this transaction.  */
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_global_commit
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_revnum_t
name|new_revision
parameter_list|,
name|svn_revnum_t
name|changed_revision
parameter_list|,
name|apr_time_t
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
name|changed_author
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|new_checksum
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|new_children
parameter_list|,
name|apr_hash_t
modifier|*
name|new_dav_cache
parameter_list|,
name|svn_boolean_t
name|keep_changelist
parameter_list|,
name|svn_boolean_t
name|no_unlock
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|new_revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|new_checksum
operator|==
name|NULL
operator|||
name|new_children
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|commit_node
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|new_revision
argument_list|,
name|changed_revision
argument_list|,
name|changed_date
argument_list|,
name|changed_author
argument_list|,
name|new_checksum
argument_list|,
name|new_children
argument_list|,
name|new_dav_cache
argument_list|,
name|keep_changelist
argument_list|,
name|no_unlock
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
comment|/* We *totally* monkeyed the entries. Toss 'em.  */
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_global_update
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_node_kind_t
name|new_kind
parameter_list|,
specifier|const
name|char
modifier|*
name|new_repos_relpath
parameter_list|,
name|svn_revnum_t
name|new_revision
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|new_props
parameter_list|,
name|svn_revnum_t
name|new_changed_rev
parameter_list|,
name|apr_time_t
name|new_changed_date
parameter_list|,
specifier|const
name|char
modifier|*
name|new_changed_author
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|new_children
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|new_checksum
parameter_list|,
specifier|const
name|char
modifier|*
name|new_target
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|new_dav_cache
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflict
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|NOT_IMPLEMENTED
argument_list|()
expr_stmt|;
if|#
directive|if
literal|0
block|svn_wc__db_wcroot_t *wcroot;   const char *local_relpath;    SVN_ERR_ASSERT(svn_dirent_is_absolute(local_abspath));
comment|/* ### allow NULL for NEW_REPOS_RELPATH to indicate "no change"?  */
block|SVN_ERR_ASSERT(svn_relpath_is_canonical(new_repos_relpath));   SVN_ERR_ASSERT(SVN_IS_VALID_REVNUM(new_revision));   SVN_ERR_ASSERT(new_props != NULL);   SVN_ERR_ASSERT(SVN_IS_VALID_REVNUM(new_changed_rev));   SVN_ERR_ASSERT((new_children != NULL&& new_checksum == NULL&& new_target == NULL)                  || (new_children == NULL&& new_checksum != NULL&& new_target == NULL)                  || (new_children == NULL&& new_checksum == NULL&& new_target != NULL));    SVN_ERR(svn_wc__db_wcroot_parse_local_abspath(&wcroot,&local_relpath, db,                               local_abspath, scratch_pool, scratch_pool));   VERIFY_USABLE_WCROOT(wcroot);    SVN_WC__DB_WITH_TXN(     update_node(wcroot, local_relpath,                 new_repos_relpath, new_revision, new_props,                 new_changed_rev, new_changed_date, new_changed_author,                 new_children, new_checksum, new_target,                 conflict, work_items, scratch_pool),     wcroot);
comment|/* We *totally* monkeyed the entries. Toss 'em.  */
block|SVN_ERR(flush_entries(wcroot, local_abspath, scratch_pool));    return SVN_NO_ERROR;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* Sets a base nodes revision, repository relative path, and/or inherited    propertis. If LOCAL_ABSPATH's rev (REV) is valid, set its revision.  If    SET_REPOS_RELPATH is TRUE set its repository relative path to REPOS_RELPATH    (and make sure its REPOS_ID is still valid).  If IPROPS is not NULL set its    inherited properties to IPROPS, if IPROPS is NULL then clear any the iprops    cache for the base node.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_op_set_rev_repos_relpath_iprops
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_array_header_t
modifier|*
name|iprops
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|svn_boolean_t
name|set_repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
name|apr_int64_t
name|repos_id
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|rev
argument_list|)
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_BASE_REVISION
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isr"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|set_repos_relpath
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_BASE_REPOS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isis"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|repos_id
argument_list|,
name|repos_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Set or clear iprops. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_IPROP
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_iprops
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|iprops
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The main body of bump_revisions_post_update().  *  * Tweak the information for LOCAL_RELPATH in WCROOT.  If NEW_REPOS_RELPATH is  * non-NULL update the entry to the new url specified by NEW_REPOS_RELPATH,  * NEW_REPOS_ID.  If NEW_REV is valid, make this the node's working revision.  *  * If WCROOT_IPROPS is not NULL it is a hash mapping const char * absolute  * working copy paths to depth-first ordered arrays of  * svn_prop_inherited_item_t * structures.  If the absolute path equivalent  * of LOCAL_RELPATH exists in WCROOT_IPROPS, then set the hashed value as the  * node's inherited properties.  *  * Unless S_ROOT is TRUE the tweaks might cause the node for LOCAL_ABSPATH to  * be removed from the WC; if IS_ROOT is TRUE this will not happen.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|bump_node_revision
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_int64_t
name|new_repos_id
parameter_list|,
specifier|const
name|char
modifier|*
name|new_repos_relpath
parameter_list|,
name|svn_revnum_t
name|new_rev
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_hash_t
modifier|*
name|exclude_relpaths
parameter_list|,
name|apr_hash_t
modifier|*
name|wcroot_iprops
parameter_list|,
name|svn_boolean_t
name|is_root
parameter_list|,
name|svn_boolean_t
name|skip_when_dir
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
specifier|const
name|apr_array_header_t
modifier|*
name|children
decl_stmt|;
name|int
name|i
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_node_kind_t
name|db_kind
decl_stmt|;
name|svn_revnum_t
name|revision
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
name|svn_boolean_t
name|set_repos_relpath
init|=
name|FALSE
decl_stmt|;
name|svn_boolean_t
name|update_root
decl_stmt|;
name|svn_depth_t
name|depth_below_here
init|=
name|depth
decl_stmt|;
name|apr_array_header_t
modifier|*
name|iprops
init|=
name|NULL
decl_stmt|;
comment|/* Skip an excluded path and its descendants. */
if|if
condition|(
name|svn_hash_gets
argument_list|(
name|exclude_relpaths
argument_list|,
name|local_relpath
argument_list|)
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|db_kind
argument_list|,
operator|&
name|revision
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|update_root
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Skip file externals */
if|if
condition|(
name|update_root
operator|&&
name|db_kind
operator|==
name|svn_node_file
operator|&&
operator|!
name|is_root
condition|)
return|return
name|SVN_NO_ERROR
return|;
if|if
condition|(
name|skip_when_dir
operator|&&
name|db_kind
operator|==
name|svn_node_dir
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* If the node is still marked 'not-present', then the server did not      re-add it.  So it's really gone in this revision, thus we remove the node.       If the node is still marked 'server-excluded' and yet is not the same      revision as new_rev, then the server did not re-add it, nor      re-server-exclude it, so we can remove the node. */
if|if
condition|(
operator|!
name|is_root
operator|&&
operator|(
name|status
operator|==
name|svn_wc__db_status_not_present
operator|||
operator|(
name|status
operator|==
name|svn_wc__db_status_server_excluded
operator|&&
name|revision
operator|!=
name|new_rev
operator|)
operator|)
condition|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|db_base_remove
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|db
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|SVN_INVALID_REVNUM
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|new_repos_relpath
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|repos_relpath
argument_list|,
name|new_repos_relpath
argument_list|)
condition|)
name|set_repos_relpath
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|wcroot_iprops
condition|)
name|iprops
operator|=
name|svn_hash_gets
argument_list|(
name|wcroot_iprops
argument_list|,
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|iprops
operator|||
name|set_repos_relpath
operator|||
operator|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|new_rev
argument_list|)
operator|&&
name|new_rev
operator|!=
name|revision
operator|)
condition|)
block|{
name|SVN_ERR
argument_list|(
name|db_op_set_rev_repos_relpath_iprops
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|iprops
argument_list|,
name|new_rev
argument_list|,
name|set_repos_relpath
argument_list|,
name|new_repos_relpath
argument_list|,
name|new_repos_id
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Early out */
if|if
condition|(
name|depth
operator|<=
name|svn_depth_empty
operator|||
name|db_kind
operator|!=
name|svn_node_dir
operator|||
name|status
operator|==
name|svn_wc__db_status_server_excluded
operator|||
name|status
operator|==
name|svn_wc__db_status_excluded
operator|||
name|status
operator|==
name|svn_wc__db_status_not_present
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* And now recurse over the children */
name|depth_below_here
operator|=
name|depth
expr_stmt|;
if|if
condition|(
name|depth
operator|==
name|svn_depth_immediates
operator|||
name|depth
operator|==
name|svn_depth_files
condition|)
name|depth_below_here
operator|=
name|svn_depth_empty
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|gather_repo_children
argument_list|(
operator|&
name|children
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|children
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|child_basename
init|=
name|APR_ARRAY_IDX
argument_list|(
name|children
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_local_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_repos_relpath
init|=
name|NULL
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
comment|/* Derive the new URL for the current (child) entry */
if|if
condition|(
name|new_repos_relpath
condition|)
name|child_repos_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|new_repos_relpath
argument_list|,
name|child_basename
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|child_local_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|local_relpath
argument_list|,
name|child_basename
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|bump_node_revision
argument_list|(
name|wcroot
argument_list|,
name|child_local_relpath
argument_list|,
name|new_repos_id
argument_list|,
name|child_repos_relpath
argument_list|,
name|new_rev
argument_list|,
name|depth_below_here
argument_list|,
name|exclude_relpaths
argument_list|,
name|wcroot_iprops
argument_list|,
name|FALSE
comment|/* is_root */
argument_list|,
operator|(
name|depth
operator|<
name|svn_depth_immediates
operator|)
argument_list|,
name|db
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Cleanup */
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Helper for svn_wc__db_op_bump_revisions_post_update().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|bump_revisions_post_update
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
specifier|const
name|char
modifier|*
name|new_repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|new_repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|new_repos_uuid
parameter_list|,
name|svn_revnum_t
name|new_revision
parameter_list|,
name|apr_hash_t
modifier|*
name|exclude_relpaths
parameter_list|,
name|apr_hash_t
modifier|*
name|wcroot_iprops
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|apr_int64_t
name|new_repos_id
init|=
name|INVALID_REPOS_ID
decl_stmt|;
name|err
operator|=
name|svn_wc__db_base_get_info_internal
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|kind
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|svn_wc__db_status_excluded
case|:
case|case
name|svn_wc__db_status_server_excluded
case|:
case|case
name|svn_wc__db_status_not_present
case|:
return|return
name|SVN_NO_ERROR
return|;
comment|/* Explicitly ignore other statii */
default|default:
break|break;
block|}
if|if
condition|(
name|new_repos_root_url
operator|!=
name|NULL
condition|)
name|SVN_ERR
argument_list|(
name|create_repos_id
argument_list|(
operator|&
name|new_repos_id
argument_list|,
name|new_repos_root_url
argument_list|,
name|new_repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|bump_node_revision
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|new_repos_id
argument_list|,
name|new_repos_relpath
argument_list|,
name|new_revision
argument_list|,
name|depth
argument_list|,
name|exclude_relpaths
argument_list|,
name|wcroot_iprops
argument_list|,
name|TRUE
comment|/* is_root */
argument_list|,
name|FALSE
argument_list|,
name|db
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_bump_moved_away
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|depth
argument_list|,
name|db
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_update_move_list_notify
argument_list|(
name|wcroot
argument_list|,
name|SVN_INVALID_REVNUM
argument_list|,
name|SVN_INVALID_REVNUM
argument_list|,
name|notify_func
argument_list|,
name|notify_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_bump_revisions_post_update
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
specifier|const
name|char
modifier|*
name|new_repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|new_repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|new_repos_uuid
parameter_list|,
name|svn_revnum_t
name|new_revision
parameter_list|,
name|apr_hash_t
modifier|*
name|exclude_relpaths
parameter_list|,
name|apr_hash_t
modifier|*
name|wcroot_iprops
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
name|svn_hash_gets
argument_list|(
name|exclude_relpaths
argument_list|,
name|local_relpath
argument_list|)
condition|)
return|return
name|SVN_NO_ERROR
return|;
if|if
condition|(
name|depth
operator|==
name|svn_depth_unknown
condition|)
name|depth
operator|=
name|svn_depth_infinity
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|bump_revisions_post_update
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|db
argument_list|,
name|depth
argument_list|,
name|new_repos_relpath
argument_list|,
name|new_repos_root_url
argument_list|,
name|new_repos_uuid
argument_list|,
name|new_revision
argument_list|,
name|exclude_relpaths
argument_list|,
name|wcroot_iprops
argument_list|,
name|notify_func
argument_list|,
name|notify_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_lock_add().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|lock_add_txn
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
specifier|const
name|svn_wc__db_lock_t
modifier|*
name|lock
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_LOCK
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"iss"
argument_list|,
name|repos_id
argument_list|,
name|repos_relpath
argument_list|,
name|lock
operator|->
name|token
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lock
operator|->
name|owner
operator|!=
name|NULL
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_text
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|,
name|lock
operator|->
name|owner
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lock
operator|->
name|comment
operator|!=
name|NULL
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_text
argument_list|(
name|stmt
argument_list|,
literal|5
argument_list|,
name|lock
operator|->
name|comment
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lock
operator|->
name|date
operator|!=
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int64
argument_list|(
name|stmt
argument_list|,
literal|6
argument_list|,
name|lock
operator|->
name|date
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__insert
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_lock_add
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|svn_wc__db_lock_t
modifier|*
name|lock
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|lock
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|lock_add_txn
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|lock
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
comment|/* There may be some entries, and the lock info is now out of date.  */
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_lock_remove().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|lock_remove_txn
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_LOCK
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|repos_id
argument_list|,
name|repos_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_lock_remove
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|lock_remove_txn
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
comment|/* There may be some entries, and the lock info is now out of date.  */
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_scan_base_repos
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_uuid
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_fetch_repos_info
argument_list|(
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|repos_id
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* A helper for scan_addition().  * Compute moved-from information for the node at LOCAL_RELPATH which  * has been determined as having been moved-here.  * If MOVED_FROM_RELPATH is not NULL, set *MOVED_FROM_RELPATH to the  * path of the move-source node in *MOVED_FROM_RELPATH.  * If DELETE_OP_ROOT_RELPATH is not NULL, set *DELETE_OP_ROOT_RELPATH  * to the path of the op-root of the delete-half of the move.  * If moved-from information cannot be derived, set both *MOVED_FROM_RELPATH  * and *DELETE_OP_ROOT_RELPATH to NULL, and return a "copied" status.  * COPY_OPT_ROOT_RELPATH is the relpath of the op-root of the copied-half  * of the move. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_moved_from_info
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|moved_from_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|moved_from_op_root_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|moved_to_op_root_relpath
parameter_list|,
name|int
modifier|*
name|op_depth
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
comment|/* Run a query to get the moved-from path from the DB. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_FROM_RELPATH
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|moved_to_op_root_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
comment|/* The move was only recorded at the copy-half, possibly because        * the move operation was interrupted mid-way between the copy        * and the delete. Treat this node as a normal copy. */
if|if
condition|(
name|moved_from_relpath
condition|)
operator|*
name|moved_from_relpath
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|moved_from_op_root_relpath
condition|)
operator|*
name|moved_from_op_root_relpath
operator|=
name|NULL
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
if|if
condition|(
name|op_depth
condition|)
operator|*
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|moved_from_relpath
operator|||
name|moved_from_op_root_relpath
condition|)
block|{
specifier|const
name|char
modifier|*
name|db_delete_op_root_relpath
decl_stmt|;
comment|/* The moved-from path from the DB is the relpath of        * the op_root of the delete-half of the move. */
name|db_delete_op_root_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|moved_from_op_root_relpath
condition|)
operator|*
name|moved_from_op_root_relpath
operator|=
name|db_delete_op_root_relpath
expr_stmt|;
if|if
condition|(
name|moved_from_relpath
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|moved_to_op_root_relpath
argument_list|,
name|local_relpath
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* LOCAL_RELPATH is the op_root of the copied-half of the                * move, so the correct MOVED_FROM_ABSPATH is the op-root                * of the delete-half. */
operator|*
name|moved_from_relpath
operator|=
name|db_delete_op_root_relpath
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|child_relpath
decl_stmt|;
comment|/* LOCAL_RELPATH is a child that was copied along with the                * op_root of the copied-half of the move. Construct the                * corresponding path beneath the op_root of the delete-half. */
comment|/* Grab the child path relative to the op_root of the move                * destination. */
name|child_relpath
operator|=
name|svn_relpath_skip_ancestor
argument_list|(
name|moved_to_op_root_relpath
argument_list|,
name|local_relpath
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|child_relpath
operator|&&
name|strlen
argument_list|(
name|child_relpath
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|/* This join is valid because LOCAL_RELPATH has not been moved                * within the copied-half of the move yet -- else, it would                * be its own op_root. */
operator|*
name|moved_from_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|db_delete_op_root_relpath
argument_list|,
name|child_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of scan_addition().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|scan_addition_txn
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|op_root_relpath_p
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|original_repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|original_repos_id
parameter_list|,
name|svn_revnum_t
modifier|*
name|original_revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|moved_from_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|moved_from_op_root_relpath
parameter_list|,
name|int
modifier|*
name|moved_from_op_depth
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|op_root_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|build_relpath
init|=
literal|""
decl_stmt|;
comment|/* Initialize most of the OUT parameters. Generally, we'll only be filling      in a subset of these, so it is easier to init all up front. Note that      the STATUS parameter will be initialized once we read the status of      the specified node.  */
if|if
condition|(
name|op_root_relpath_p
condition|)
operator|*
name|op_root_relpath_p
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|original_repos_relpath
condition|)
operator|*
name|original_repos_relpath
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|original_repos_id
condition|)
operator|*
name|original_repos_id
operator|=
name|INVALID_REPOS_ID
expr_stmt|;
if|if
condition|(
name|original_revision
condition|)
operator|*
name|original_revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
if|if
condition|(
name|moved_from_relpath
condition|)
operator|*
name|moved_from_relpath
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|moved_from_op_root_relpath
condition|)
operator|*
name|moved_from_op_root_relpath
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|moved_from_op_depth
condition|)
operator|*
name|moved_from_op_depth
operator|=
literal|0
expr_stmt|;
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_wc__db_status_t
name|presence
decl_stmt|;
name|int
name|op_depth
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_prefix_path
init|=
literal|""
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* ### is it faster to fetch fewer columns? */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
comment|/* Reset statement before returning */
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### maybe we should return a usage error instead?  */
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
name|presence
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
comment|/* The starting node should exist normally.  */
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_depth
operator|==
literal|0
operator|||
operator|(
name|presence
operator|!=
name|svn_wc__db_status_normal
operator|&&
name|presence
operator|!=
name|svn_wc__db_status_incomplete
operator|)
condition|)
comment|/* reset the statement as part of the error generation process */
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Expected node '%s' to be added."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|original_revision
condition|)
operator|*
name|original_revision
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|12
argument_list|)
expr_stmt|;
comment|/* Provide the default status; we'll override as appropriate. */
if|if
condition|(
name|status
condition|)
block|{
if|if
condition|(
name|presence
operator|==
name|svn_wc__db_status_normal
condition|)
operator|*
name|status
operator|=
name|svn_wc__db_status_added
expr_stmt|;
else|else
operator|*
name|status
operator|=
name|svn_wc__db_status_incomplete
expr_stmt|;
block|}
comment|/* Calculate the op root local path components */
name|op_root_relpath
operator|=
name|local_relpath
expr_stmt|;
for|for
control|(
name|i
operator|=
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
init|;
name|i
operator|>
name|op_depth
condition|;
operator|--
name|i
control|)
block|{
comment|/* Calculate the path of the operation root */
name|repos_prefix_path
operator|=
name|svn_relpath_join
argument_list|(
name|svn_relpath_basename
argument_list|(
name|op_root_relpath
argument_list|,
name|NULL
argument_list|)
argument_list|,
name|repos_prefix_path
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|op_root_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|op_root_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|op_root_relpath_p
condition|)
operator|*
name|op_root_relpath_p
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|op_root_relpath
argument_list|)
expr_stmt|;
comment|/* ### This if-statement is quite redundant.      * ### We're checking all these values again within the body anyway.      * ### The body should be broken up appropriately and move into the      * ### outer scope. */
if|if
condition|(
name|original_repos_relpath
operator|||
name|original_repos_id
operator|||
operator|(
name|original_revision
operator|&&
operator|*
name|original_revision
operator|==
name|SVN_INVALID_REVNUM
operator|)
operator|||
name|status
operator|||
name|moved_from_relpath
operator|||
name|moved_from_op_root_relpath
condition|)
block|{
if|if
condition|(
name|local_relpath
operator|!=
name|op_root_relpath
condition|)
comment|/* requery to get the add/copy root */
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|op_root_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
comment|/* Reset statement before returning */
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### maybe we should return a usage error instead?  */
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|op_root_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|original_revision
operator|&&
operator|*
name|original_revision
operator|==
name|SVN_INVALID_REVNUM
condition|)
operator|*
name|original_revision
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|12
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|original_repos_relpath
condition|)
operator|*
name|original_repos_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|11
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|10
argument_list|)
operator|&&
operator|(
name|status
operator|||
name|original_repos_id
operator|||
name|moved_from_relpath
operator|||
name|moved_from_op_root_relpath
operator|)
condition|)
comment|/* If column 10 (original_repos_id) is NULL,              this is a plain add, not a copy or a move */
block|{
name|svn_boolean_t
name|moved_here
decl_stmt|;
if|if
condition|(
name|original_repos_id
condition|)
operator|*
name|original_repos_id
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|moved_here
operator|=
name|svn_sqlite__column_boolean
argument_list|(
name|stmt
argument_list|,
literal|13
comment|/* moved_here */
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
operator|*
name|status
operator|=
name|moved_here
condition|?
name|svn_wc__db_status_moved_here
else|:
name|svn_wc__db_status_copied
expr_stmt|;
if|if
condition|(
name|moved_here
operator|&&
operator|(
name|moved_from_relpath
operator|||
name|moved_from_op_root_relpath
operator|)
condition|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|err
operator|=
name|get_moved_from_info
argument_list|(
name|moved_from_relpath
argument_list|,
name|moved_from_op_root_relpath
argument_list|,
name|op_root_relpath
argument_list|,
name|moved_from_op_depth
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
block|}
block|}
comment|/* ### This loop here is to skip up to the first node which is a BASE node,        because base_get_info() doesn't accommodate the scenario that        we're looking at here; we found the true op_root, which may be inside        further changed trees. */
if|if
condition|(
name|repos_relpath
operator|||
name|repos_id
condition|)
block|{
specifier|const
name|char
modifier|*
name|base_relpath
decl_stmt|;
while|while
condition|(
name|TRUE
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Pointing at op_depth, look at the parent */
name|repos_prefix_path
operator|=
name|svn_relpath_join
argument_list|(
name|svn_relpath_basename
argument_list|(
name|op_root_relpath
argument_list|,
name|NULL
argument_list|)
argument_list|,
name|repos_prefix_path
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|op_root_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|op_root_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|op_root_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
break|break;
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Skip to op_depth */
for|for
control|(
name|i
operator|=
name|relpath_depth
argument_list|(
name|op_root_relpath
argument_list|)
init|;
name|i
operator|>
name|op_depth
condition|;
name|i
operator|--
control|)
block|{
comment|/* Calculate the path of the operation root */
name|repos_prefix_path
operator|=
name|svn_relpath_join
argument_list|(
name|svn_relpath_basename
argument_list|(
name|op_root_relpath
argument_list|,
name|NULL
argument_list|)
argument_list|,
name|repos_prefix_path
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|op_root_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|op_root_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|build_relpath
operator|=
name|repos_prefix_path
expr_stmt|;
comment|/* If we're here, then we have an added/copied/moved (start) node, and          CURRENT_ABSPATH now points to a BASE node. Figure out the repository          information for the current node, and use that to compute the start          node's repository information.  */
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|base_relpath
argument_list|,
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|op_root_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|repos_relpath
condition|)
operator|*
name|repos_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|base_relpath
argument_list|,
name|build_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Postconditions */
ifdef|#
directive|ifdef
name|SVN_DEBUG
if|if
condition|(
name|status
condition|)
block|{
name|SVN_ERR_ASSERT
argument_list|(
operator|*
name|status
operator|==
name|svn_wc__db_status_added
operator|||
operator|*
name|status
operator|==
name|svn_wc__db_status_copied
operator|||
operator|*
name|status
operator|==
name|svn_wc__db_status_incomplete
operator|||
operator|*
name|status
operator|==
name|svn_wc__db_status_moved_here
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|status
operator|==
name|svn_wc__db_status_added
condition|)
block|{
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|original_repos_relpath
operator|||
operator|*
name|original_repos_relpath
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|original_revision
operator|||
operator|*
name|original_revision
operator|==
name|SVN_INVALID_REVNUM
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|original_repos_id
operator|||
operator|*
name|original_repos_id
operator|==
name|INVALID_REPOS_ID
argument_list|)
expr_stmt|;
block|}
comment|/* An upgrade with a missing directory can leave INCOMPLETE working          op-roots. See upgrade_tests.py 29: upgrade with missing replaced dir        */
elseif|else
if|if
condition|(
operator|*
name|status
operator|!=
name|svn_wc__db_status_incomplete
condition|)
block|{
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|original_repos_relpath
operator|||
operator|*
name|original_repos_relpath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|original_revision
operator|||
operator|*
name|original_revision
operator|!=
name|SVN_INVALID_REVNUM
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|original_repos_id
operator|||
operator|*
name|original_repos_id
operator|!=
name|INVALID_REPOS_ID
argument_list|)
expr_stmt|;
block|}
block|}
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|op_root_relpath_p
operator|||
operator|*
name|op_root_relpath_p
operator|!=
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Like svn_wc__db_scan_addition(), but with WCROOT+LOCAL_RELPATH instead of    DB+LOCAL_ABSPATH.     The output value of *ORIGINAL_REPOS_ID will be INVALID_REPOS_ID if there    is no 'copy-from' repository.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|scan_addition
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|op_root_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|original_repos_relpath
parameter_list|,
name|apr_int64_t
modifier|*
name|original_repos_id
parameter_list|,
name|svn_revnum_t
modifier|*
name|original_revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|moved_from_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|moved_from_op_root_relpath
parameter_list|,
name|int
modifier|*
name|moved_from_op_depth
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|scan_addition_txn
argument_list|(
name|status
argument_list|,
name|op_root_relpath
argument_list|,
name|repos_relpath
argument_list|,
name|repos_id
argument_list|,
name|original_repos_relpath
argument_list|,
name|original_repos_id
argument_list|,
name|original_revision
argument_list|,
name|moved_from_relpath
argument_list|,
name|moved_from_op_root_relpath
argument_list|,
name|moved_from_op_depth
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_scan_addition
parameter_list|(
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|op_root_abspath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_uuid
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|original_repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|original_root_url
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|original_uuid
parameter_list|,
name|svn_revnum_t
modifier|*
name|original_revision
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|op_root_relpath
init|=
name|NULL
decl_stmt|;
name|apr_int64_t
name|repos_id
init|=
name|INVALID_REPOS_ID
decl_stmt|;
name|apr_int64_t
name|original_repos_id
init|=
name|INVALID_REPOS_ID
decl_stmt|;
name|apr_int64_t
modifier|*
name|repos_id_p
init|=
operator|(
name|repos_root_url
operator|||
name|repos_uuid
operator|)
condition|?
operator|&
name|repos_id
else|:
name|NULL
decl_stmt|;
name|apr_int64_t
modifier|*
name|original_repos_id_p
init|=
operator|(
name|original_root_url
operator|||
name|original_uuid
operator|)
condition|?
operator|&
name|original_repos_id
else|:
name|NULL
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|scan_addition
argument_list|(
name|status
argument_list|,
name|op_root_abspath
condition|?
operator|&
name|op_root_relpath
else|:
name|NULL
argument_list|,
name|repos_relpath
argument_list|,
name|repos_id_p
argument_list|,
name|original_repos_relpath
argument_list|,
name|original_repos_id_p
argument_list|,
name|original_revision
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_root_abspath
condition|)
operator|*
name|op_root_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|op_root_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
comment|/* REPOS_ID must be valid if requested; ORIGINAL_REPOS_ID need not be. */
name|SVN_ERR_ASSERT
argument_list|(
name|repos_id_p
operator|==
name|NULL
operator|||
name|repos_id
operator|!=
name|INVALID_REPOS_ID
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_fetch_repos_info
argument_list|(
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|repos_id
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_fetch_repos_info
argument_list|(
name|original_root_url
argument_list|,
name|original_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|original_repos_id
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_scan_moved
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|moved_from_abspath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|op_root_abspath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|op_root_moved_from_abspath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|moved_from_delete_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
specifier|const
name|char
modifier|*
name|op_root_relpath
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_from_relpath
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_from_op_root_relpath
init|=
name|NULL
decl_stmt|;
name|int
name|moved_from_op_depth
init|=
operator|-
literal|1
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|scan_addition
argument_list|(
operator|&
name|status
argument_list|,
name|op_root_abspath
condition|?
operator|&
name|op_root_relpath
else|:
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|moved_from_abspath
condition|?
operator|&
name|moved_from_relpath
else|:
name|NULL
argument_list|,
operator|(
name|op_root_moved_from_abspath
operator|||
name|moved_from_delete_abspath
operator|)
condition|?
operator|&
name|moved_from_op_root_relpath
else|:
name|NULL
argument_list|,
name|moved_from_delete_abspath
condition|?
operator|&
name|moved_from_op_depth
else|:
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|svn_wc__db_status_moved_here
operator|||
operator|!
name|moved_from_relpath
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Path '%s' was not moved here"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|op_root_abspath
condition|)
operator|*
name|op_root_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|op_root_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|moved_from_abspath
condition|)
operator|*
name|moved_from_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|moved_from_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_root_moved_from_abspath
condition|)
operator|*
name|op_root_moved_from_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|moved_from_op_root_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
comment|/* The deleted node is either where we moved from, or one of its ancestors */
if|if
condition|(
name|moved_from_delete_abspath
condition|)
block|{
specifier|const
name|char
modifier|*
name|tmp
init|=
name|moved_from_op_root_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|moved_from_op_depth
operator|>=
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|relpath_depth
argument_list|(
name|tmp
argument_list|)
operator|>
name|moved_from_op_depth
condition|)
name|tmp
operator|=
name|svn_relpath_dirname
argument_list|(
name|tmp
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|*
name|moved_from_delete_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|tmp
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* ###  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|follow_moved_to
parameter_list|(
name|apr_array_header_t
modifier|*
modifier|*
name|moved_tos
parameter_list|,
name|int
name|op_depth
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_path
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|working_op_depth
decl_stmt|;
specifier|const
name|char
modifier|*
name|ancestor_relpath
decl_stmt|,
modifier|*
name|node_moved_to
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|(
operator|!
name|op_depth
operator|&&
operator|!
name|repos_path
operator|)
operator|||
operator|(
name|op_depth
operator|&&
name|repos_path
operator|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_OP_DEPTH_MOVED_TO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|working_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|node_moved_to
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|repos_path
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
operator|||
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The base node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|repos_path
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|revision
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|node_moved_to
condition|)
block|{
name|svn_boolean_t
name|have_row2
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_HERE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|node_moved_to
argument_list|,
name|relpath_depth
argument_list|(
name|node_moved_to
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row2
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row2
operator|||
operator|!
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
operator|||
name|revision
operator|!=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|)
operator|||
name|strcmp
argument_list|(
name|repos_path
argument_list|,
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|)
argument_list|)
condition|)
name|node_moved_to
operator|=
name|NULL
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|node_moved_to
condition|)
block|{
name|struct
name|svn_wc__db_moved_to_t
modifier|*
name|moved_to
decl_stmt|;
name|moved_to
operator|=
name|apr_palloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|moved_to
argument_list|)
argument_list|)
expr_stmt|;
name|moved_to
operator|->
name|op_depth
operator|=
name|working_op_depth
expr_stmt|;
name|moved_to
operator|->
name|local_relpath
operator|=
name|node_moved_to
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
operator|*
name|moved_tos
argument_list|,
expr|struct
name|svn_wc__db_moved_to_t
operator|*
argument_list|)
operator|=
name|moved_to
expr_stmt|;
block|}
comment|/* A working row with moved_to, or no working row, and we are done. */
if|if
condition|(
name|node_moved_to
operator|||
operator|!
name|have_row
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Need to handle being moved via an ancestor. */
name|ancestor_relpath
operator|=
name|local_relpath
expr_stmt|;
for|for
control|(
name|i
operator|=
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
init|;
name|i
operator|>
name|working_op_depth
condition|;
operator|--
name|i
control|)
block|{
specifier|const
name|char
modifier|*
name|ancestor_moved_to
decl_stmt|;
name|ancestor_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|ancestor_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_TO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|ancestor_relpath
argument_list|,
name|working_op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|have_row
argument_list|)
expr_stmt|;
name|ancestor_moved_to
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ancestor_moved_to
condition|)
block|{
name|node_moved_to
operator|=
name|svn_relpath_join
argument_list|(
name|ancestor_moved_to
argument_list|,
name|svn_relpath_skip_ancestor
argument_list|(
name|ancestor_relpath
argument_list|,
name|local_relpath
argument_list|)
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_HERE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|node_moved_to
argument_list|,
name|relpath_depth
argument_list|(
name|ancestor_moved_to
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
name|ancestor_moved_to
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|svn_wc__db_status_t
name|presence
init|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|presence_map
argument_list|)
decl_stmt|;
if|if
condition|(
name|presence
operator|!=
name|svn_wc__db_status_not_present
condition|)
name|ancestor_moved_to
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
operator|&&
operator|!
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
condition|)
name|ancestor_moved_to
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ancestor_moved_to
condition|)
break|break;
comment|/* verify repos_path points back? */
block|}
if|if
condition|(
name|ancestor_moved_to
condition|)
block|{
name|struct
name|svn_wc__db_moved_to_t
modifier|*
name|moved_to
decl_stmt|;
name|moved_to
operator|=
name|apr_palloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|moved_to
argument_list|)
argument_list|)
expr_stmt|;
name|moved_to
operator|->
name|op_depth
operator|=
name|working_op_depth
expr_stmt|;
name|moved_to
operator|->
name|local_relpath
operator|=
name|node_moved_to
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
operator|*
name|moved_tos
argument_list|,
expr|struct
name|svn_wc__db_moved_to_t
operator|*
argument_list|)
operator|=
name|moved_to
expr_stmt|;
name|SVN_ERR
argument_list|(
name|follow_moved_to
argument_list|(
name|moved_tos
argument_list|,
name|relpath_depth
argument_list|(
name|ancestor_moved_to
argument_list|)
argument_list|,
name|repos_path
argument_list|,
name|revision
argument_list|,
name|wcroot
argument_list|,
name|node_moved_to
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_follow_moved_to
parameter_list|(
name|apr_array_header_t
modifier|*
modifier|*
name|moved_tos
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
operator|*
name|moved_tos
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|svn_wc__db_moved_to_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### Wrap in a transaction */
name|SVN_ERR
argument_list|(
name|follow_moved_to
argument_list|(
name|moved_tos
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|SVN_INVALID_REVNUM
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### Convert moved_to to abspath */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Extract the moved-to information for LOCAL_RELPATH at OP-DEPTH by    examining the lowest working node above OP_DEPTH.  The output paths    are NULL if there is no move, otherwise:     *MOVE_DST_RELPATH: the moved-to destination of LOCAL_RELPATH.     *MOVE_DST_OP_ROOT_RELPATH: the moved-to destination of the root of    the move of LOCAL_RELPATH. This may be equal to *MOVE_DST_RELPATH    if LOCAL_RELPATH is the root of the move.     *MOVE_SRC_ROOT_RELPATH: the root of the move source.  For moves    inside a delete this will be different from *MOVE_SRC_OP_ROOT_RELPATH.     *MOVE_SRC_OP_ROOT_RELPATH: the root of the source layer that    contains the move.  For moves inside deletes this is the root of    the delete, for other moves this is the root of the move.     Given a path A/B/C with A/B moved to X then for A/B/C       MOVE_DST_RELPATH is X/C      MOVE_DST_OP_ROOT_RELPATH is X      MOVE_SRC_ROOT_RELPATH is A/B      MOVE_SRC_OP_ROOT_RELPATH is A/B     If A is then deleted the MOVE_DST_RELPATH, MOVE_DST_OP_ROOT_RELPATH    and MOVE_SRC_ROOT_RELPATH remain the same but MOVE_SRC_OP_ROOT_RELPATH    changes to A.     ### Think about combining with scan_deletion?  Also with    ### scan_addition to get moved-to for replaces?  Do we need to    ### return the op-root of the move source, i.e. A/B in the example    ### above?  */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_depth_moved_to
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|move_dst_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|move_dst_op_root_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|move_src_root_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|move_src_op_root_relpath
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|delete_op_depth
decl_stmt|;
specifier|const
name|char
modifier|*
name|relpath
init|=
name|local_relpath
decl_stmt|;
operator|*
name|move_dst_relpath
operator|=
operator|*
name|move_dst_op_root_relpath
operator|=
name|NULL
expr_stmt|;
operator|*
name|move_src_root_relpath
operator|=
operator|*
name|move_src_op_root_relpath
operator|=
name|NULL
expr_stmt|;
do|do
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_LOWEST_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|delete_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|move_dst_op_root_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|move_dst_op_root_relpath
condition|)
operator|*
name|move_src_root_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|move_dst_op_root_relpath
condition|)
name|relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|!
operator|*
name|move_dst_op_root_relpath
operator|&&
name|have_row
operator|&&
name|delete_op_depth
operator|<=
name|relpath_depth
argument_list|(
name|relpath
argument_list|)
condition|)
do|;
if|if
condition|(
operator|*
name|move_dst_op_root_relpath
condition|)
block|{
operator|*
name|move_dst_relpath
operator|=
name|svn_relpath_join
argument_list|(
operator|*
name|move_dst_op_root_relpath
argument_list|,
name|svn_relpath_skip_ancestor
argument_list|(
name|relpath
argument_list|,
name|local_relpath
argument_list|)
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
while|while
condition|(
name|delete_op_depth
operator|<
name|relpath_depth
argument_list|(
name|relpath
argument_list|)
condition|)
name|relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|*
name|move_src_op_root_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Public (within libsvn_wc) absolute path version of    svn_wc__db_op_depth_moved_to with the op-depth hard-coded to    BASE. */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_moved_to
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|move_dst_abspath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|move_dst_op_root_abspath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|move_src_root_abspath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|move_src_op_root_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_dst_relpath
decl_stmt|,
modifier|*
name|move_dst_op_root_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_src_root_relpath
decl_stmt|,
modifier|*
name|move_src_op_root_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|svn_wc__db_op_depth_moved_to
argument_list|(
operator|&
name|move_dst_relpath
argument_list|,
operator|&
name|move_dst_op_root_relpath
argument_list|,
operator|&
name|move_src_root_relpath
argument_list|,
operator|&
name|move_src_op_root_relpath
argument_list|,
literal|0
comment|/* BASE op-depth */
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
name|move_dst_abspath
condition|)
operator|*
name|move_dst_abspath
operator|=
name|move_dst_relpath
condition|?
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|move_dst_relpath
argument_list|,
name|result_pool
argument_list|)
else|:
name|NULL
expr_stmt|;
if|if
condition|(
name|move_dst_op_root_abspath
condition|)
operator|*
name|move_dst_op_root_abspath
operator|=
name|move_dst_op_root_relpath
condition|?
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|move_dst_op_root_relpath
argument_list|,
name|result_pool
argument_list|)
else|:
name|NULL
expr_stmt|;
if|if
condition|(
name|move_src_root_abspath
condition|)
operator|*
name|move_src_root_abspath
operator|=
name|move_src_root_relpath
condition|?
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|move_src_root_relpath
argument_list|,
name|result_pool
argument_list|)
else|:
name|NULL
expr_stmt|;
if|if
condition|(
name|move_src_op_root_abspath
condition|)
operator|*
name|move_src_op_root_abspath
operator|=
name|move_src_op_root_relpath
condition|?
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|move_src_op_root_relpath
argument_list|,
name|result_pool
argument_list|)
else|:
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_upgrade_begin
parameter_list|(
name|svn_sqlite__db_t
modifier|*
modifier|*
name|sdb
parameter_list|,
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
name|apr_int64_t
modifier|*
name|wc_id
parameter_list|,
name|svn_wc__db_t
modifier|*
name|wc_db
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
comment|/* Upgrade is inherently exclusive so specify exclusive locking. */
name|SVN_ERR
argument_list|(
name|create_db
argument_list|(
name|sdb
argument_list|,
name|repos_id
argument_list|,
name|wc_id
argument_list|,
name|dir_abspath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|SDB_FILE
argument_list|,
name|NULL
argument_list|,
name|SVN_INVALID_REVNUM
argument_list|,
name|svn_depth_unknown
argument_list|,
name|TRUE
comment|/* exclusive */
argument_list|,
name|wc_db
operator|->
name|state_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_pdh_create_wcroot
argument_list|(
operator|&
name|wcroot
argument_list|,
name|apr_pstrdup
argument_list|(
name|wc_db
operator|->
name|state_pool
argument_list|,
name|dir_abspath
argument_list|)
argument_list|,
operator|*
name|sdb
argument_list|,
operator|*
name|wc_id
argument_list|,
name|FORMAT_FROM_SDB
argument_list|,
name|FALSE
comment|/* auto-upgrade */
argument_list|,
name|FALSE
comment|/* enforce_empty_wq */
argument_list|,
name|wc_db
operator|->
name|state_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* The WCROOT is complete. Stash it into DB.  */
name|svn_hash_sets
argument_list|(
name|wc_db
operator|->
name|dir_data
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_upgrade_apply_dav_cache
parameter_list|(
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_relpath
parameter_list|,
name|apr_hash_t
modifier|*
name|cache_values
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|apr_int64_t
name|wc_id
decl_stmt|;
name|apr_hash_index_t
modifier|*
name|hi
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_util_fetch_wc_id
argument_list|(
operator|&
name|wc_id
argument_list|,
name|sdb
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_UPDATE_BASE_NODE_DAV_CACHE
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Iterate over all the wcprops, writing each one to the wc_db. */
for|for
control|(
name|hi
operator|=
name|apr_hash_first
argument_list|(
name|scratch_pool
argument_list|,
name|cache_values
argument_list|)
init|;
name|hi
condition|;
name|hi
operator|=
name|apr_hash_next
argument_list|(
name|hi
argument_list|)
control|)
block|{
specifier|const
name|char
modifier|*
name|name
init|=
name|svn__apr_hash_index_key
argument_list|(
name|hi
argument_list|)
decl_stmt|;
name|apr_hash_t
modifier|*
name|props
init|=
name|svn__apr_hash_index_val
argument_list|(
name|hi
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|dir_relpath
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_properties
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|props
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_upgrade_apply_props
parameter_list|(
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_hash_t
modifier|*
name|base_props
parameter_list|,
name|apr_hash_t
modifier|*
name|revert_props
parameter_list|,
name|apr_hash_t
modifier|*
name|working_props
parameter_list|,
name|int
name|original_format
parameter_list|,
name|apr_int64_t
name|wc_id
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|top_op_depth
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|below_op_depth
init|=
operator|-
literal|1
decl_stmt|;
name|svn_wc__db_status_t
name|top_presence
decl_stmt|;
name|svn_wc__db_status_t
name|below_presence
decl_stmt|;
name|int
name|affected_rows
decl_stmt|;
comment|/* ### working_props: use set_props_txn.      ### if working_props == NULL, then skip. what if they equal the      ### pristine props? we should probably do the compare here.      ###      ### base props go into WORKING_NODE if avail, otherwise BASE.      ###      ### revert only goes into BASE. (and WORKING better be there!)       Prior to 1.4.0 (ORIGINAL_FORMAT< 8), REVERT_PROPS did not exist. If a      file was deleted, then a copy (potentially with props) was disallowed      and could not replace the deletion. An addition *could* be performed,      but that would never bring its own props.       1.4.0 through 1.4.5 created the concept of REVERT_PROPS, but had a      bug in svn_wc_add_repos_file2() whereby a copy-with-props did NOT      construct a REVERT_PROPS if the target had no props. Thus, reverting      the delete/copy would see no REVERT_PROPS to restore, leaving the      props from the copy source intact, and appearing as if they are (now)      the base props for the previously-deleted file. (wc corruption)       1.4.6 ensured that an empty REVERT_PROPS would be established at all      times. See issue 2530, and r861670 as starting points.       We will use ORIGINAL_FORMAT and SVN_WC__NO_REVERT_FILES to determine      the handling of our inputs, relative to the state of this node.   */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|top_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|top_presence
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|below_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|below_presence
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Detect the buggy scenario described above. We cannot upgrade this      working copy if we have no idea where BASE_PROPS should go.  */
if|if
condition|(
name|original_format
operator|>
name|SVN_WC__NO_REVERT_FILES
operator|&&
name|revert_props
operator|==
name|NULL
operator|&&
name|top_op_depth
operator|!=
operator|-
literal|1
operator|&&
name|top_presence
operator|==
name|svn_wc__db_status_normal
operator|&&
name|below_op_depth
operator|!=
operator|-
literal|1
operator|&&
name|below_presence
operator|!=
name|svn_wc__db_status_not_present
condition|)
block|{
comment|/* There should be REVERT_PROPS, so it appears that we just ran into          the described bug. Sigh.  */
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CORRUPT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The properties of '%s' are in an "
literal|"indeterminate state and cannot be "
literal|"upgraded. See issue #2530."
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|svn_dirent_join
argument_list|(
name|dir_abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
comment|/* Need at least one row, or two rows if there are revert props */
if|if
condition|(
name|top_op_depth
operator|==
operator|-
literal|1
operator|||
operator|(
name|below_op_depth
operator|==
operator|-
literal|1
operator|&&
name|revert_props
operator|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CORRUPT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Insufficient NODES rows for '%s'"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|svn_dirent_join
argument_list|(
name|dir_abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
comment|/* one row, base props only: upper row gets base props      two rows, base props only: lower row gets base props      two rows, revert props only: lower row gets revert props      two rows, base and revert props: upper row gets base, lower gets revert */
if|if
condition|(
name|revert_props
operator|||
name|below_op_depth
operator|==
operator|-
literal|1
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_UPDATE_NODE_PROPS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|top_op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_properties
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|,
name|base_props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|affected_rows
operator|==
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|below_op_depth
operator|!=
operator|-
literal|1
condition|)
block|{
name|apr_hash_t
modifier|*
name|props
init|=
name|revert_props
condition|?
name|revert_props
else|:
name|base_props
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_UPDATE_NODE_PROPS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|below_op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_properties
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|,
name|props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|affected_rows
operator|==
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* If there are WORKING_PROPS, then they always go into ACTUAL_NODE.  */
if|if
condition|(
name|working_props
operator|!=
name|NULL
operator|&&
name|base_props
operator|!=
name|NULL
condition|)
block|{
name|apr_array_header_t
modifier|*
name|diffs
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_prop_diffs
argument_list|(
operator|&
name|diffs
argument_list|,
name|working_props
argument_list|,
name|base_props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|diffs
operator|->
name|nelts
operator|==
literal|0
condition|)
name|working_props
operator|=
name|NULL
expr_stmt|;
comment|/* No differences */
block|}
if|if
condition|(
name|working_props
operator|!=
name|NULL
condition|)
block|{
name|SVN_ERR
argument_list|(
name|set_actual_props
argument_list|(
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|working_props
argument_list|,
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_upgrade_insert_external
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_node_kind_t
name|kind
parameter_list|,
specifier|const
name|char
modifier|*
name|parent_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|def_local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
name|svn_revnum_t
name|def_peg_revision
parameter_list|,
name|svn_revnum_t
name|def_revision
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|def_local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We know only of DEF_LOCAL_ABSPATH that it definitely belongs to "this"    * WC, i.e. where the svn:externals prop is set. The external target path    * itself may be "hidden behind" other working copies. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|def_local_relpath
argument_list|,
name|db
argument_list|,
name|def_local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_REPOSITORY
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"s"
argument_list|,
name|repos_root_url
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
name|repos_id
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
comment|/* Need to set up a new repository row. */
name|SVN_ERR
argument_list|(
name|create_repos_id
argument_list|(
operator|&
name|repos_id
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_EXTERNAL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* wc_id, local_relpath, parent_relpath, presence, kind, def_local_relpath,    * repos_id, def_repos_relpath, def_operational_revision, def_revision */
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"issstsis"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
argument_list|,
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|parent_abspath
argument_list|)
argument_list|,
literal|"normal"
argument_list|,
name|kind_map
argument_list|,
name|kind
argument_list|,
name|def_local_relpath
argument_list|,
name|repos_id
argument_list|,
name|repos_relpath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|def_peg_revision
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_revnum
argument_list|(
name|stmt
argument_list|,
literal|9
argument_list|,
name|def_peg_revision
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|def_revision
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_revnum
argument_list|(
name|stmt
argument_list|,
literal|10
argument_list|,
name|def_revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__insert
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_upgrade_get_repos_id
parameter_list|(
name|apr_int64_t
modifier|*
name|repos_id
parameter_list|,
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_root_url
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_SELECT_REPOSITORY
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"s"
argument_list|,
name|repos_root_url
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_DB_ERROR
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Repository '%s' not found in the database"
argument_list|)
argument_list|,
name|repos_root_url
argument_list|)
return|;
operator|*
name|repos_id
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_wq_add
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_item
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|wri_abspath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Quick exit, if there are no work items to queue up.  */
if|if
condition|(
name|work_item
operator|==
name|NULL
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
comment|/* Add the work item(s) to the WORK_QUEUE.  */
return|return
name|svn_error_trace
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_item
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_wq_fetch_next().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wq_fetch_next
parameter_list|(
name|apr_uint64_t
modifier|*
name|id
parameter_list|,
name|svn_skel_t
modifier|*
modifier|*
name|work_item
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_uint64_t
name|completed_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
if|if
condition|(
name|completed_id
operator|!=
literal|0
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_WORK_ITEM
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int64
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|completed_id
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_WORK_ITEM
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
operator|*
name|id
operator|=
literal|0
expr_stmt|;
operator|*
name|work_item
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|apr_size_t
name|len
decl_stmt|;
specifier|const
name|void
modifier|*
name|val
decl_stmt|;
operator|*
name|id
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
name|svn_sqlite__column_blob
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
operator|&
name|len
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
operator|*
name|work_item
operator|=
name|svn_skel__parse
argument_list|(
name|val
argument_list|,
name|len
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_wq_fetch_next
parameter_list|(
name|apr_uint64_t
modifier|*
name|id
parameter_list|,
name|svn_skel_t
modifier|*
modifier|*
name|work_item
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
name|apr_uint64_t
name|completed_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|id
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|work_item
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|wri_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|wq_fetch_next
argument_list|(
name|id
argument_list|,
name|work_item
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|completed_id
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Records timestamp and date for one or more files in wcroot */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wq_record
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|apr_hash_t
modifier|*
name|record_map
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_index_t
modifier|*
name|hi
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
for|for
control|(
name|hi
operator|=
name|apr_hash_first
argument_list|(
name|scratch_pool
argument_list|,
name|record_map
argument_list|)
init|;
name|hi
condition|;
name|hi
operator|=
name|apr_hash_next
argument_list|(
name|hi
argument_list|)
control|)
block|{
specifier|const
name|char
modifier|*
name|local_abspath
init|=
name|svn__apr_hash_index_key
argument_list|(
name|hi
argument_list|)
decl_stmt|;
specifier|const
name|svn_io_dirent2_t
modifier|*
name|dirent
init|=
name|svn__apr_hash_index_val
argument_list|(
name|hi
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
init|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|)
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|local_relpath
condition|)
continue|continue;
name|SVN_ERR
argument_list|(
name|db_record_fileinfo
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|dirent
operator|->
name|filesize
argument_list|,
name|dirent
operator|->
name|mtime
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_wq_record_and_fetch_next
parameter_list|(
name|apr_uint64_t
modifier|*
name|id
parameter_list|,
name|svn_skel_t
modifier|*
modifier|*
name|work_item
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
name|apr_uint64_t
name|completed_id
parameter_list|,
name|apr_hash_t
modifier|*
name|record_map
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|id
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|work_item
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|wri_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|svn_error_compose_create
argument_list|(
name|wq_fetch_next
argument_list|(
name|id
argument_list|,
name|work_item
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|completed_id
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wq_record
argument_list|(
name|wcroot
argument_list|,
name|record_map
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* ### temporary API. remove before release.  */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_temp_get_format
parameter_list|(
name|int
modifier|*
name|format
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_dir_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_dir_abspath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### assert that we were passed a directory?  */
name|err
operator|=
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* If we hit an error examining this directory, then declare this      directory to not be a working copy.  */
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
name|err
operator|->
name|apr_err
operator|!=
name|SVN_ERR_WC_NOT_WORKING_COPY
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
comment|/* Remap the returned error.  */
operator|*
name|format
operator|=
literal|0
expr_stmt|;
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_MISSING
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is not a working copy"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_dir_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
name|SVN_ERR_ASSERT
argument_list|(
name|wcroot
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|wcroot
operator|->
name|format
operator|>=
literal|1
argument_list|)
expr_stmt|;
operator|*
name|format
operator|=
name|wcroot
operator|->
name|format
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* ### temporary API. remove before release.  */
end_comment

begin_function
name|svn_wc_adm_access_t
modifier|*
name|svn_wc__db_temp_get_access
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_dir_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|SVN_ERR_ASSERT_NO_RETURN
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_dir_abspath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### we really need to assert that we were passed a directory. sometimes      ### adm_retrieve_internal is asked about a file, and then it asks us      ### for an access baton for it. we should definitely return NULL, but      ### ideally: the caller would never ask us about a non-directory.  */
name|err
operator|=
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|wcroot
condition|)
return|return
name|NULL
return|;
return|return
name|svn_hash_gets
argument_list|(
name|wcroot
operator|->
name|access_cache
argument_list|,
name|local_dir_abspath
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ### temporary API. remove before release.  */
end_comment

begin_function
name|void
name|svn_wc__db_temp_set_access
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_dir_abspath
parameter_list|,
name|svn_wc_adm_access_t
modifier|*
name|adm_access
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|SVN_ERR_ASSERT_NO_RETURN
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_dir_abspath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### assert that we were passed a directory?  */
name|err
operator|=
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
comment|/* We don't even have a wcroot, so just bail. */
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Better not override something already there.  */
name|SVN_ERR_ASSERT_NO_RETURN
argument_list|(
name|svn_hash_gets
argument_list|(
name|wcroot
operator|->
name|access_cache
argument_list|,
name|local_dir_abspath
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|wcroot
operator|->
name|access_cache
argument_list|,
name|local_dir_abspath
argument_list|,
name|adm_access
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ### temporary API. remove before release.  */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_temp_close_access
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_dir_abspath
parameter_list|,
name|svn_wc_adm_access_t
modifier|*
name|adm_access
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_dir_abspath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### assert that we were passed a directory?  */
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|wcroot
operator|->
name|access_cache
argument_list|,
name|local_dir_abspath
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* ### temporary API. remove before release.  */
end_comment

begin_function
name|void
name|svn_wc__db_temp_clear_access
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_dir_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|SVN_ERR_ASSERT_NO_RETURN
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_dir_abspath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### assert that we were passed a directory?  */
name|err
operator|=
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return;
block|}
name|svn_hash_sets
argument_list|(
name|wcroot
operator|->
name|access_cache
argument_list|,
name|local_dir_abspath
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|apr_hash_t
modifier|*
name|svn_wc__db_temp_get_all_access
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|result
init|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
decl_stmt|;
name|apr_hash_index_t
modifier|*
name|hi
decl_stmt|;
for|for
control|(
name|hi
operator|=
name|apr_hash_first
argument_list|(
name|result_pool
argument_list|,
name|db
operator|->
name|dir_data
argument_list|)
init|;
name|hi
condition|;
name|hi
operator|=
name|apr_hash_next
argument_list|(
name|hi
argument_list|)
control|)
block|{
specifier|const
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
init|=
name|svn__apr_hash_index_val
argument_list|(
name|hi
argument_list|)
decl_stmt|;
comment|/* This is highly redundant, 'cause the same WCROOT will appear many          times in dir_data. */
name|result
operator|=
name|apr_hash_overlay
argument_list|(
name|result_pool
argument_list|,
name|result
argument_list|,
name|wcroot
operator|->
name|access_cache
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_temp_borrow_sdb
parameter_list|(
name|svn_sqlite__db_t
modifier|*
modifier|*
name|sdb
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_dir_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_dir_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
operator|*
name|sdb
operator|=
name|wcroot
operator|->
name|sdb
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_conflict_victims
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|victims
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_array_header_t
modifier|*
name|new_victims
decl_stmt|;
comment|/* The parent should be a working copy directory. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
comment|/* ### This will be much easier once we have all conflicts in one          field of actual*/
comment|/* Look for text, tree and property conflicts in ACTUAL */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_CONFLICT_VICTIMS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|new_victims
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|child_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|new_victims
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
operator|=
name|svn_relpath_basename
argument_list|(
name|child_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|victims
operator|=
name|new_victims
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_get_conflict_marker_files().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_conflict_marker_files
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|marker_files_p
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_hash_t
modifier|*
name|marker_files
init|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ACTUAL_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
operator|&&
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|apr_size_t
name|len
decl_stmt|;
specifier|const
name|void
modifier|*
name|data
init|=
name|svn_sqlite__column_blob
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|svn_skel_t
modifier|*
name|conflicts
decl_stmt|;
specifier|const
name|apr_array_header_t
modifier|*
name|markers
decl_stmt|;
name|int
name|i
decl_stmt|;
name|conflicts
operator|=
name|svn_skel__parse
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* ### ADD markers to *marker_files */
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_read_markers
argument_list|(
operator|&
name|markers
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|conflicts
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|markers
operator|&&
operator|(
name|i
operator|<
name|markers
operator|->
name|nelts
operator|)
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|marker_abspath
init|=
name|APR_ARRAY_IDX
argument_list|(
name|markers
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
name|svn_hash_sets
argument_list|(
name|marker_files
argument_list|,
name|marker_abspath
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_CONFLICT_VICTIMS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|apr_size_t
name|len
decl_stmt|;
specifier|const
name|void
modifier|*
name|data
init|=
name|svn_sqlite__column_blob
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
specifier|const
name|apr_array_header_t
modifier|*
name|markers
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|data
condition|)
block|{
name|svn_skel_t
modifier|*
name|conflicts
decl_stmt|;
name|conflicts
operator|=
name|svn_skel__parse
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_read_markers
argument_list|(
operator|&
name|markers
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|conflicts
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|markers
operator|&&
operator|(
name|i
operator|<
name|markers
operator|->
name|nelts
operator|)
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|marker_abspath
init|=
name|APR_ARRAY_IDX
argument_list|(
name|markers
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
name|svn_hash_sets
argument_list|(
name|marker_files
argument_list|,
name|marker_abspath
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|apr_hash_count
argument_list|(
name|marker_files
argument_list|)
condition|)
operator|*
name|marker_files_p
operator|=
name|marker_files
expr_stmt|;
else|else
operator|*
name|marker_files_p
operator|=
name|NULL
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_get_conflict_marker_files
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|marker_files
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
comment|/* The parent should be a working copy directory. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|get_conflict_marker_files
argument_list|(
name|marker_files
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|db
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_conflict
parameter_list|(
name|svn_skel_t
modifier|*
modifier|*
name|conflict
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
comment|/* The parent should be a working copy directory. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_wc__db_read_conflict_internal
argument_list|(
name|conflict
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_conflict_internal
parameter_list|(
name|svn_skel_t
modifier|*
modifier|*
name|conflict
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
comment|/* Check if we have a conflict in ACTUAL */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ACTUAL_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
comment|/* Do this while stmt is still open to avoid closing the sqlite          transaction and then reopening. */
name|svn_sqlite__stmt_t
modifier|*
name|stmt_node
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|err
operator|=
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt_node
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|stmt_node
operator|=
name|NULL
expr_stmt|;
else|else
name|err
operator|=
name|svn_sqlite__bindf
argument_list|(
name|stmt_node
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|stmt_node
condition|)
name|err
operator|=
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt_node
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
operator|*
name|conflict
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
block|{
name|apr_size_t
name|cfl_len
decl_stmt|;
specifier|const
name|void
modifier|*
name|cfl_data
decl_stmt|;
comment|/* svn_skel__parse doesn't copy data, so store in result_pool */
name|cfl_data
operator|=
name|svn_sqlite__column_blob
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
operator|&
name|cfl_len
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfl_data
condition|)
operator|*
name|conflict
operator|=
name|svn_skel__parse
argument_list|(
name|cfl_data
argument_list|,
name|cfl_len
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
else|else
operator|*
name|conflict
operator|=
name|NULL
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_read_kind
parameter_list|(
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|allow_missing
parameter_list|,
name|svn_boolean_t
name|show_deleted
parameter_list|,
name|svn_boolean_t
name|show_hidden
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt_info
decl_stmt|;
name|svn_boolean_t
name|have_info
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt_info
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt_info
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_info
argument_list|,
name|stmt_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_info
condition|)
block|{
if|if
condition|(
name|allow_missing
condition|)
block|{
operator|*
name|kind
operator|=
name|svn_node_unknown
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt_info
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt_info
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
block|}
if|if
condition|(
operator|!
operator|(
name|show_deleted
operator|&&
name|show_hidden
operator|)
condition|)
block|{
name|int
name|op_depth
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt_info
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|svn_boolean_t
name|report_none
init|=
name|FALSE
decl_stmt|;
name|svn_wc__db_status_t
name|status
init|=
name|svn_sqlite__column_token
argument_list|(
name|stmt_info
argument_list|,
literal|3
argument_list|,
name|presence_map
argument_list|)
decl_stmt|;
if|if
condition|(
name|op_depth
operator|>
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|convert_to_working_status
argument_list|(
operator|&
name|status
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|svn_wc__db_status_not_present
case|:
if|if
condition|(
operator|!
operator|(
name|show_hidden
operator|&&
name|show_deleted
operator|)
condition|)
name|report_none
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|svn_wc__db_status_excluded
case|:
case|case
name|svn_wc__db_status_server_excluded
case|:
if|if
condition|(
operator|!
name|show_hidden
condition|)
name|report_none
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|svn_wc__db_status_deleted
case|:
if|if
condition|(
operator|!
name|show_deleted
condition|)
name|report_none
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|report_none
condition|)
block|{
operator|*
name|kind
operator|=
name|svn_node_none
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt_info
argument_list|)
argument_list|)
return|;
block|}
block|}
operator|*
name|kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt_info
argument_list|,
literal|4
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt_info
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_node_hidden
parameter_list|(
name|svn_boolean_t
modifier|*
name|hidden
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|hidden
operator|=
operator|(
name|status
operator|==
name|svn_wc__db_status_server_excluded
operator|||
name|status
operator|==
name|svn_wc__db_status_not_present
operator|||
name|status
operator|==
name|svn_wc__db_status_excluded
operator|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_is_wcroot
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_wcroot
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|local_relpath
operator|!=
literal|'\0'
condition|)
block|{
operator|*
name|is_wcroot
operator|=
name|FALSE
expr_stmt|;
comment|/* Node is a file, or has a parent directory within                            the same wcroot */
return|return
name|SVN_NO_ERROR
return|;
block|}
operator|*
name|is_wcroot
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Find a node's kind and whether it is switched, putting the outputs in  * *IS_SWITCHED and *KIND. Either of the outputs may be NULL if not wanted.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|db_is_switched
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_switched
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|parent_local_relpath
decl_stmt|;
name|apr_int64_t
name|parent_repos_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|parent_repos_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|*
name|local_relpath
operator|!=
literal|'\0'
argument_list|)
expr_stmt|;
comment|/* Handled in wrapper */
name|SVN_ERR
argument_list|(
name|read_info
argument_list|(
operator|&
name|status
argument_list|,
name|kind
argument_list|,
name|NULL
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_server_excluded
operator|||
name|status
operator|==
name|svn_wc__db_status_excluded
operator|||
name|status
operator|==
name|svn_wc__db_status_not_present
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|repos_relpath
condition|)
block|{
comment|/* Node is shadowed; easy out */
if|if
condition|(
name|is_switched
condition|)
operator|*
name|is_switched
operator|=
name|FALSE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
if|if
condition|(
operator|!
name|is_switched
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|svn_relpath_split
argument_list|(
operator|&
name|parent_local_relpath
argument_list|,
operator|&
name|name
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|parent_repos_relpath
argument_list|,
operator|&
name|parent_repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|parent_local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|repos_id
operator|!=
name|parent_repos_id
condition|)
operator|*
name|is_switched
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
specifier|const
name|char
modifier|*
name|expected_relpath
decl_stmt|;
name|expected_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|parent_repos_relpath
argument_list|,
name|name
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|*
name|is_switched
operator|=
operator|(
name|strcmp
argument_list|(
name|expected_relpath
argument_list|,
name|repos_relpath
argument_list|)
operator|!=
literal|0
operator|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_is_switched
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_wcroot
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_switched
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_switched
condition|)
operator|*
name|is_switched
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|*
name|local_relpath
operator|==
literal|'\0'
condition|)
block|{
comment|/* Easy out */
if|if
condition|(
name|is_wcroot
condition|)
operator|*
name|is_wcroot
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|kind
condition|)
operator|*
name|kind
operator|=
name|svn_node_dir
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
if|if
condition|(
name|is_wcroot
condition|)
operator|*
name|is_wcroot
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|!
name|is_switched
operator|&&
operator|!
name|kind
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|db_is_switched
argument_list|(
name|is_switched
argument_list|,
name|kind
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_temp_wcroot_tempdir
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|temp_dir_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|temp_dir_abspath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|wri_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
operator|*
name|temp_dir_abspath
operator|=
name|svn_dirent_join_many
argument_list|(
name|result_pool
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|svn_wc_get_adm_dir
argument_list|(
name|scratch_pool
argument_list|)
argument_list|,
name|WCROOT_TEMPDIR_RELPATH
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Helper for wclock_obtain_cb() to steal an existing lock */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wclock_steal
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_WC_LOCK
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_wclock_obtain().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wclock_obtain_cb
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|levels_to_lock
parameter_list|,
name|svn_boolean_t
name|steal_lock
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
specifier|const
name|char
modifier|*
name|lock_relpath
decl_stmt|;
name|int
name|max_depth
decl_stmt|;
name|int
name|lock_depth
decl_stmt|;
name|svn_boolean_t
name|got_row
decl_stmt|;
name|svn_wc__db_wclock_t
name|lock
decl_stmt|;
comment|/* Upgrade locks the root before the node exists.  Apart from that      the root node always exists so we will just skip the check.       ### Perhaps the lock for upgrade should be created when the db is          created?  1.6 used to lock .svn on creation. */
if|if
condition|(
name|local_relpath
index|[
literal|0
index|]
condition|)
block|{
name|svn_boolean_t
name|exists
decl_stmt|;
name|SVN_ERR
argument_list|(
name|does_node_exist
argument_list|(
operator|&
name|exists
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|exists
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
comment|/* Check if there are nodes locked below the new lock root */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_FIND_WC_LOCK
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|lock_depth
operator|=
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
expr_stmt|;
name|max_depth
operator|=
name|lock_depth
operator|+
name|levels_to_lock
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|got_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|got_row
condition|)
block|{
name|svn_boolean_t
name|own_lock
decl_stmt|;
name|lock_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* If we are not locking with depth infinity, check if this lock          voids our lock request */
if|if
condition|(
name|levels_to_lock
operator|>=
literal|0
operator|&&
name|relpath_depth
argument_list|(
name|lock_relpath
argument_list|)
operator|>
name|max_depth
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|got_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* Check if we are the lock owner, because we should be able to          extend our lock. */
name|err
operator|=
name|wclock_owns_lock
argument_list|(
operator|&
name|own_lock
argument_list|,
name|wcroot
argument_list|,
name|lock_relpath
argument_list|,
name|TRUE
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|own_lock
operator|&&
operator|!
name|steal_lock
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_LOCKED
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is already locked."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|lock_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_LOCKED
argument_list|,
name|err
argument_list|,
name|_
argument_list|(
literal|"Working copy '%s' locked."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|own_lock
condition|)
block|{
name|err
operator|=
name|wclock_steal
argument_list|(
name|wcroot
argument_list|,
name|lock_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|got_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|steal_lock
condition|)
name|SVN_ERR
argument_list|(
name|wclock_steal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_WC_LOCK
argument_list|)
argument_list|)
expr_stmt|;
name|lock_relpath
operator|=
name|local_relpath
expr_stmt|;
while|while
condition|(
name|TRUE
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|lock_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|got_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|got_row
condition|)
block|{
name|int
name|levels
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|levels
operator|>=
literal|0
condition|)
name|levels
operator|+=
name|relpath_depth
argument_list|(
name|lock_relpath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|levels
operator|==
operator|-
literal|1
operator|||
name|levels
operator|>=
name|lock_depth
condition|)
block|{
name|err
operator|=
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_LOCKED
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is already locked."
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|lock_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_LOCKED
argument_list|,
name|err
argument_list|,
name|_
argument_list|(
literal|"Working copy '%s' locked."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
break|break;
comment|/* There can't be interesting locks on higher nodes */
block|}
else|else
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|lock_relpath
condition|)
break|break;
name|lock_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|lock_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_WC_LOCK
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|levels_to_lock
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_sqlite__insert
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_LOCKED
argument_list|,
name|err
argument_list|,
name|_
argument_list|(
literal|"Working copy '%s' locked"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
comment|/* And finally store that we obtained the lock */
name|lock
operator|.
name|local_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|wcroot
operator|->
name|owned_locks
operator|->
name|pool
argument_list|,
name|local_relpath
argument_list|)
expr_stmt|;
name|lock
operator|.
name|levels
operator|=
name|levels_to_lock
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|wcroot
operator|->
name|owned_locks
argument_list|,
name|svn_wc__db_wclock_t
argument_list|)
operator|=
name|lock
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_wclock_obtain
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|int
name|levels_to_lock
parameter_list|,
name|svn_boolean_t
name|steal_lock
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|levels_to_lock
operator|>=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|steal_lock
condition|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|depth
init|=
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wcroot
operator|->
name|owned_locks
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|svn_wc__db_wclock_t
modifier|*
name|lock
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|wcroot
operator|->
name|owned_locks
argument_list|,
name|i
argument_list|,
name|svn_wc__db_wclock_t
argument_list|)
decl_stmt|;
if|if
condition|(
name|svn_relpath_skip_ancestor
argument_list|(
name|lock
operator|->
name|local_relpath
argument_list|,
name|local_relpath
argument_list|)
operator|&&
operator|(
name|lock
operator|->
name|levels
operator|==
operator|-
literal|1
operator|||
operator|(
name|lock
operator|->
name|levels
operator|+
name|relpath_depth
argument_list|(
name|lock
operator|->
name|local_relpath
argument_list|)
operator|)
operator|>=
name|depth
operator|)
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_LOCKED
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is already locked via '%s'."
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|lock
operator|->
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
block|}
block|}
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|wclock_obtain_cb
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|levels_to_lock
argument_list|,
name|steal_lock
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_wclock_find_root() and svn_wc__db_wclocked(). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|find_wclock
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|lock_relpath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|dir_depth
init|=
name|relpath_depth
argument_list|(
name|dir_relpath
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|first_relpath
decl_stmt|;
comment|/* Check for locks on all directories that might be ancestors.      As our new apis only use recursive locks the number of locks stored      in the DB will be very low */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ANCESTOR_WCLOCKS
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Get the top level relpath to reduce the worst case number of results      to the number of directories below this node plus two.      (1: the node itself and 2: the wcroot). */
name|first_relpath
operator|=
name|strchr
argument_list|(
name|dir_relpath
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|first_relpath
operator|!=
name|NULL
condition|)
name|first_relpath
operator|=
name|apr_pstrndup
argument_list|(
name|scratch_pool
argument_list|,
name|dir_relpath
argument_list|,
name|first_relpath
operator|-
name|dir_relpath
argument_list|)
expr_stmt|;
else|else
name|first_relpath
operator|=
name|dir_relpath
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"iss"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|dir_relpath
argument_list|,
name|first_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|svn_relpath_skip_ancestor
argument_list|(
name|relpath
argument_list|,
name|dir_relpath
argument_list|)
condition|)
block|{
name|int
name|locked_levels
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|int
name|row_depth
init|=
name|relpath_depth
argument_list|(
name|relpath
argument_list|)
decl_stmt|;
if|if
condition|(
name|locked_levels
operator|==
operator|-
literal|1
operator|||
name|locked_levels
operator|+
name|row_depth
operator|>=
name|dir_depth
condition|)
block|{
operator|*
name|lock_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|lock_relpath
operator|=
name|NULL
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|is_wclocked
parameter_list|(
name|svn_boolean_t
modifier|*
name|locked
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|lock_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|find_wclock
argument_list|(
operator|&
name|lock_relpath
argument_list|,
name|wcroot
argument_list|,
name|dir_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|locked
operator|=
operator|(
name|lock_relpath
operator|!=
name|NULL
operator|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_wclock_find_root
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|lock_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|lock_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|find_wclock
argument_list|(
operator|&
name|lock_relpath
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lock_relpath
condition|)
operator|*
name|lock_abspath
operator|=
name|NULL
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__db_from_relpath
argument_list|(
name|lock_abspath
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|lock_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_wclocked
parameter_list|(
name|svn_boolean_t
modifier|*
name|locked
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|is_wclocked
argument_list|(
name|locked
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_wclock_release
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|int
name|i
decl_stmt|;
name|apr_array_header_t
modifier|*
name|owned_locks
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
comment|/* First check and remove the owns-lock information as failure in      removing the db record implies that we have to steal the lock later. */
name|owned_locks
operator|=
name|wcroot
operator|->
name|owned_locks
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|owned_locks
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|svn_wc__db_wclock_t
modifier|*
name|lock
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|owned_locks
argument_list|,
name|i
argument_list|,
name|svn_wc__db_wclock_t
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|lock
operator|->
name|local_relpath
argument_list|,
name|local_relpath
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|>=
name|owned_locks
operator|->
name|nelts
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_NOT_LOCKED
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Working copy not locked at '%s'."
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|i
operator|<
name|owned_locks
operator|->
name|nelts
condition|)
block|{
name|owned_locks
operator|->
name|nelts
operator|--
expr_stmt|;
comment|/* Move the last item in the array to the deleted place */
if|if
condition|(
name|owned_locks
operator|->
name|nelts
operator|>
literal|0
condition|)
name|APR_ARRAY_IDX
argument_list|(
name|owned_locks
argument_list|,
name|i
argument_list|,
name|svn_wc__db_wclock_t
argument_list|)
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|owned_locks
argument_list|,
name|owned_locks
operator|->
name|nelts
argument_list|,
name|svn_wc__db_wclock_t
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_WC_LOCK
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Like svn_wc__db_wclock_owns_lock() but taking WCROOT+LOCAL_RELPATH instead    of DB+LOCAL_ABSPATH.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wclock_owns_lock
parameter_list|(
name|svn_boolean_t
modifier|*
name|own_lock
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_boolean_t
name|exact
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_array_header_t
modifier|*
name|owned_locks
decl_stmt|;
name|int
name|lock_level
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|*
name|own_lock
operator|=
name|FALSE
expr_stmt|;
name|owned_locks
operator|=
name|wcroot
operator|->
name|owned_locks
expr_stmt|;
name|lock_level
operator|=
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
expr_stmt|;
if|if
condition|(
name|exact
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|owned_locks
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|svn_wc__db_wclock_t
modifier|*
name|lock
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|owned_locks
argument_list|,
name|i
argument_list|,
name|svn_wc__db_wclock_t
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|lock
operator|->
name|local_relpath
argument_list|,
name|local_relpath
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|own_lock
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|owned_locks
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|svn_wc__db_wclock_t
modifier|*
name|lock
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|owned_locks
argument_list|,
name|i
argument_list|,
name|svn_wc__db_wclock_t
argument_list|)
decl_stmt|;
if|if
condition|(
name|svn_relpath_skip_ancestor
argument_list|(
name|lock
operator|->
name|local_relpath
argument_list|,
name|local_relpath
argument_list|)
operator|&&
operator|(
name|lock
operator|->
name|levels
operator|==
operator|-
literal|1
operator|||
operator|(
operator|(
name|relpath_depth
argument_list|(
name|lock
operator|->
name|local_relpath
argument_list|)
operator|+
name|lock
operator|->
name|levels
operator|)
operator|>=
name|lock_level
operator|)
operator|)
condition|)
block|{
operator|*
name|own_lock
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_wclock_owns_lock
parameter_list|(
name|svn_boolean_t
modifier|*
name|own_lock
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|exact
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wcroot
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_NOT_WORKING_COPY
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|wclock_owns_lock
argument_list|(
name|own_lock
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|exact
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_temp_op_end_directory_update().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|end_directory_update
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_wc__db_status_t
name|base_status
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
operator|&
name|base_status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|base_status
operator|==
name|svn_wc__db_status_normal
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR_ASSERT
argument_list|(
name|base_status
operator|==
name|svn_wc__db_status_incomplete
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_NODE_BASE_PRESENCE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"ist"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|presence_map
argument_list|,
name|svn_wc__db_status_normal
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_temp_op_end_directory_update
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_dir_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_dir_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|end_directory_update
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_dir_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_temp_op_start_directory_update().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|start_directory_update_txn
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|new_repos_relpath
parameter_list|,
name|svn_revnum_t
name|new_rev
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
comment|/* Note: In the majority of calls, the repos_relpath is unchanged. */
comment|/* ### TODO: Maybe check if we can make repos_relpath NULL. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_BASE_NODE_PRESENCE_REVNUM_AND_REPOS_PATH
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"istrs"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|presence_map
argument_list|,
name|svn_wc__db_status_incomplete
argument_list|,
name|new_rev
argument_list|,
name|new_repos_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_temp_op_start_directory_update
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|new_repos_relpath
parameter_list|,
name|svn_revnum_t
name|new_rev
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|new_rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|new_repos_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|start_directory_update_txn
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|new_repos_relpath
argument_list|,
name|new_rev
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|local_abspath
argument_list|,
name|svn_depth_empty
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_temp_op_make_copy().  This is    used by the update editor when deleting a base node tree would be a    tree-conflict because there are changes to subtrees.  This function    inserts a copy of the base node tree below any existing working    subtrees.  Given a tree:               0            1           2            3     /     normal          -     A     normal          -     A/B   normal          -         normal     A/B/C normal          -         base-del       normal     A/F   normal          -         normal     A/F/G normal          -         normal     A/F/H normal          -         base-deleted   normal     A/F/E normal          -         not-present     A/X   normal          -     A/X/Y incomplete      -      This function adds layers to A and some of its descendants in an attempt     to make the working copy look like as if it were a copy of the BASE nodes.               0            1              2            3     /     normal        -     A     normal        norm     A/B   normal        norm        norm     A/B/C normal        norm        base-del       normal     A/F   normal        norm        norm     A/F/G normal        norm        norm     A/F/H normal        norm        not-pres     A/F/E normal        norm        base-del     A/X   normal        norm     A/X/Y incomplete  incomplete  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|make_copy_txn
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|op_depth
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflicts
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_boolean_t
name|add_working_base_deleted
init|=
name|FALSE
decl_stmt|;
name|svn_boolean_t
name|remove_working
init|=
name|FALSE
decl_stmt|;
specifier|const
name|apr_array_header_t
modifier|*
name|children
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_LOWEST_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|svn_wc__db_status_t
name|working_status
decl_stmt|;
name|int
name|working_op_depth
decl_stmt|;
name|working_status
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|presence_map
argument_list|)
expr_stmt|;
name|working_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|working_status
operator|==
name|svn_wc__db_status_normal
operator|||
name|working_status
operator|==
name|svn_wc__db_status_base_deleted
operator|||
name|working_status
operator|==
name|svn_wc__db_status_not_present
operator|||
name|working_status
operator|==
name|svn_wc__db_status_incomplete
argument_list|)
expr_stmt|;
comment|/* Only change nodes in the layers where we are creating the copy.          Deletes in higher layers will just apply to the copy */
if|if
condition|(
name|working_op_depth
operator|<=
name|op_depth
condition|)
block|{
name|add_working_base_deleted
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|working_status
operator|==
name|svn_wc__db_status_base_deleted
condition|)
name|remove_working
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
else|else
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|remove_working
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_LOWEST_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|add_working_base_deleted
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_DELETE_FROM_BASE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_WORKING_NODE_FROM_BASE_COPY
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Get the BASE children, as WORKING children don't need modifications */
name|SVN_ERR
argument_list|(
name|gather_repo_children
argument_list|(
operator|&
name|children
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|children
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|name
init|=
name|APR_ARRAY_IDX
argument_list|(
name|children
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|copy_relpath
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|copy_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|local_relpath
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|make_copy_txn
argument_list|(
name|wcroot
argument_list|,
name|copy_relpath
argument_list|,
name|op_depth
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|flush_entries
argument_list|(
name|wcroot
argument_list|,
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|iterpool
argument_list|)
argument_list|,
name|svn_depth_empty
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflicts
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_mark_conflict_internal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|conflicts
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|add_work_items
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|work_items
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_op_make_copy
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|conflicts
parameter_list|,
specifier|const
name|svn_skel_t
modifier|*
name|work_items
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
comment|/* The update editor is supposed to call this function when there is      no working node for LOCAL_ABSPATH. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Modification of '%s' already exists"
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
comment|/* We don't allow copies to contain server-excluded nodes;      the update editor is going to have to bail out. */
name|SVN_ERR
argument_list|(
name|catch_copy_of_server_excluded
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|make_copy_txn
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
argument_list|,
name|conflicts
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_info_below_working
parameter_list|(
name|svn_boolean_t
modifier|*
name|have_base
parameter_list|,
name|svn_boolean_t
modifier|*
name|have_work
parameter_list|,
name|svn_wc__db_status_t
modifier|*
name|status
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|info_below_working
argument_list|(
name|have_base
argument_list|,
name|have_work
argument_list|,
name|status
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
operator|-
literal|1
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_get_not_present_descendants
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|descendants
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NOT_PRESENT_DESCENDANTS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|apr_array_header_t
modifier|*
name|paths
decl_stmt|;
name|paths
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|found_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|paths
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|svn_relpath_skip_ancestor
argument_list|(
name|local_relpath
argument_list|,
name|found_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|descendants
operator|=
name|paths
expr_stmt|;
block|}
else|else
operator|*
name|descendants
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Like svn_wc__db_min_max_revisions(),  * but accepts a WCROOT/LOCAL_RELPATH pair. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_min_max_revisions
parameter_list|(
name|svn_revnum_t
modifier|*
name|min_revision
parameter_list|,
name|svn_revnum_t
modifier|*
name|max_revision
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_boolean_t
name|committed
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_revnum_t
name|min_rev
decl_stmt|,
name|max_rev
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MIN_MAX_REVISIONS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_row
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|committed
condition|)
block|{
name|min_rev
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|max_rev
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|min_rev
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|max_rev
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* The statement returns exactly one row. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|min_revision
condition|)
operator|*
name|min_revision
operator|=
name|min_rev
expr_stmt|;
if|if
condition|(
name|max_revision
condition|)
operator|*
name|max_revision
operator|=
name|max_rev
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_min_max_revisions
parameter_list|(
name|svn_revnum_t
modifier|*
name|min_revision
parameter_list|,
name|svn_revnum_t
modifier|*
name|max_revision
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|committed
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|get_min_max_revisions
argument_list|(
name|min_revision
argument_list|,
name|max_revision
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|committed
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Set *IS_SPARSE_CHECKOUT TRUE if LOCAL_RELPATH or any of the nodes  * within LOCAL_RELPATH is sparse, FALSE otherwise. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|is_sparse_checkout_internal
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_sparse_checkout
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_HAS_SPARSE_NODES
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If this query returns a row, the working copy is sparse. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|is_sparse_checkout
operator|=
name|have_row
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Like svn_wc__db_has_switched_subtrees(),  * but accepts a WCROOT/LOCAL_RELPATH pair. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|has_switched_subtrees
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_switched
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|trail_url
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_int64_t
name|repos_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
comment|/* Optional argument handling for caller */
if|if
condition|(
operator|!
name|is_switched
condition|)
return|return
name|SVN_NO_ERROR
return|;
operator|*
name|is_switched
operator|=
name|FALSE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* First do the cheap check where we only need info on the origin itself */
if|if
condition|(
name|trail_url
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|char
modifier|*
name|repos_root_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|url
decl_stmt|;
name|apr_size_t
name|len1
decl_stmt|,
name|len2
decl_stmt|;
comment|/* If the trailing part of the URL of the working copy directory          does not match the given trailing URL then the whole working          copy is switched. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_fetch_repos_info
argument_list|(
operator|&
name|repos_root_url
argument_list|,
name|NULL
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|repos_id
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|url
operator|=
name|svn_path_url_add_component2
argument_list|(
name|repos_root_url
argument_list|,
name|repos_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|len1
operator|=
name|strlen
argument_list|(
name|trail_url
argument_list|)
expr_stmt|;
name|len2
operator|=
name|strlen
argument_list|(
name|url
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|len1
operator|>
name|len2
operator|)
operator|||
name|strcmp
argument_list|(
name|url
operator|+
name|len2
operator|-
name|len1
argument_list|,
name|trail_url
argument_list|)
condition|)
block|{
operator|*
name|is_switched
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_HAS_SWITCHED
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"iss"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|repos_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
operator|*
name|is_switched
operator|=
name|TRUE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_has_switched_subtrees
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_switched
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|trail_url
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|has_switched_subtrees
argument_list|(
name|is_switched
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|trail_url
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_get_excluded_subtrees
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|excluded_subtrees
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ALL_EXCLUDED_DESCENDANTS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
operator|*
name|excluded_subtrees
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
else|else
operator|*
name|excluded_subtrees
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|abs_path
init|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
argument_list|,
name|result_pool
argument_list|)
decl_stmt|;
name|svn_hash_sets
argument_list|(
operator|*
name|excluded_subtrees
argument_list|,
name|abs_path
argument_list|,
name|abs_path
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Like svn_wc__db_has_local_mods(),  * but accepts a WCROOT/LOCAL_RELPATH pair.  * ### This needs a DB as well as a WCROOT/RELPATH pair... */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|has_local_mods
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_modified
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
comment|/* Check for additions or deletions. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SUBTREE_HAS_TREE_MODIFICATIONS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If this query returns a row, the working copy is modified. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
name|is_modified
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|is_modified
condition|)
block|{
comment|/* Check for property modifications. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SUBTREE_HAS_PROP_MODIFICATIONS
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If this query returns a row, the working copy is modified. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
name|is_modified
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|is_modified
condition|)
block|{
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|NULL
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
comment|/* Check for text modifications. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_BASE_FILES_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|node_abspath
decl_stmt|;
name|svn_filesize_t
name|recorded_size
decl_stmt|;
name|apr_time_t
name|recorded_time
decl_stmt|;
name|svn_boolean_t
name|skip_check
init|=
name|FALSE
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
if|if
condition|(
name|cancel_func
condition|)
block|{
name|err
operator|=
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|node_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|iterpool
argument_list|)
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|recorded_size
operator|=
name|get_recorded_size
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|recorded_time
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|recorded_size
operator|!=
name|SVN_INVALID_FILESIZE
operator|&&
name|recorded_time
operator|!=
literal|0
condition|)
block|{
specifier|const
name|svn_io_dirent2_t
modifier|*
name|dirent
decl_stmt|;
name|err
operator|=
name|svn_io_stat_dirent2
argument_list|(
operator|&
name|dirent
argument_list|,
name|node_abspath
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|dirent
operator|->
name|kind
operator|!=
name|svn_node_file
condition|)
block|{
operator|*
name|is_modified
operator|=
name|TRUE
expr_stmt|;
comment|/* Missing or obstruction */
break|break;
block|}
elseif|else
if|if
condition|(
name|dirent
operator|->
name|filesize
operator|==
name|recorded_size
operator|&&
name|dirent
operator|->
name|mtime
operator|==
name|recorded_time
condition|)
block|{
comment|/* The file is not modified */
name|skip_check
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|skip_check
condition|)
block|{
name|err
operator|=
name|svn_wc__internal_file_modified_p
argument_list|(
name|is_modified
argument_list|,
name|db
argument_list|,
name|node_abspath
argument_list|,
name|FALSE
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
return|;
if|if
condition|(
operator|*
name|is_modified
condition|)
break|break;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iterpool
condition|)
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_has_local_mods
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_modified
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|has_local_mods
argument_list|(
name|is_modified
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|db
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_revision_status().  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|revision_status_txn
parameter_list|(
name|svn_revnum_t
modifier|*
name|min_revision
parameter_list|,
name|svn_revnum_t
modifier|*
name|max_revision
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_sparse_checkout
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_modified
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_switched
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|trail_url
parameter_list|,
name|svn_boolean_t
name|committed
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_boolean_t
name|exists
decl_stmt|;
name|SVN_ERR
argument_list|(
name|does_node_exist
argument_list|(
operator|&
name|exists
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|exists
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|path_for_error_message
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
comment|/* Determine mixed-revisionness. */
name|SVN_ERR
argument_list|(
name|get_min_max_revisions
argument_list|(
name|min_revision
argument_list|,
name|max_revision
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|committed
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Determine sparseness. */
name|SVN_ERR
argument_list|(
name|is_sparse_checkout_internal
argument_list|(
name|is_sparse_checkout
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check for switched nodes. */
block|{
name|err
operator|=
name|has_switched_subtrees
argument_list|(
name|is_switched
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|trail_url
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
name|err
operator|->
name|apr_err
operator|!=
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
comment|/* No Base node, but no fatal error */
operator|*
name|is_switched
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check for local mods. */
name|SVN_ERR
argument_list|(
name|has_local_mods
argument_list|(
name|is_modified
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|db
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_revision_status
parameter_list|(
name|svn_revnum_t
modifier|*
name|min_revision
parameter_list|,
name|svn_revnum_t
modifier|*
name|max_revision
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_sparse_checkout
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_modified
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_switched
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|trail_url
parameter_list|,
name|svn_boolean_t
name|committed
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|revision_status_txn
argument_list|(
name|min_revision
argument_list|,
name|max_revision
argument_list|,
name|is_sparse_checkout
argument_list|,
name|is_modified
argument_list|,
name|is_switched
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|db
argument_list|,
name|trail_url
argument_list|,
name|committed
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_base_get_lock_tokens_recursive
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|lock_tokens
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_int64_t
name|last_repos_id
init|=
name|INVALID_REPOS_ID
decl_stmt|;
specifier|const
name|char
modifier|*
name|last_repos_root_url
init|=
name|NULL
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
operator|*
name|lock_tokens
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
comment|/* Fetch all the lock tokens in and under LOCAL_RELPATH. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_BASE_NODE_LOCK_TOKENS_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|apr_int64_t
name|child_repos_id
init|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|lock_token
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|result_pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|child_repos_id
operator|!=
name|last_repos_id
condition|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|svn_wc__db_fetch_repos_info
argument_list|(
operator|&
name|last_repos_root_url
argument_list|,
name|NULL
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|child_repos_id
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
condition|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
name|last_repos_id
operator|=
name|child_repos_id
expr_stmt|;
block|}
name|SVN_ERR_ASSERT
argument_list|(
name|last_repos_root_url
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
operator|*
name|lock_tokens
argument_list|,
name|svn_path_url_add_component2
argument_list|(
name|last_repos_root_url
argument_list|,
name|child_relpath
argument_list|,
name|result_pool
argument_list|)
argument_list|,
name|lock_token
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* If EXPRESSION is false, cause the caller to return an SVN_ERR_WC_CORRUPT  * error, showing EXPRESSION and the caller's LOCAL_RELPATH in the message. */
end_comment

begin_define
define|#
directive|define
name|VERIFY
parameter_list|(
name|expression
parameter_list|)
define|\
value|do { \     if (! (expression)) \       return svn_error_createf(SVN_ERR_WC_CORRUPT, NULL, \         _("database inconsistency at local_relpath='%s' verifying " \           "expression '%s'"), local_relpath, #expression); \   } while (0)
end_define

begin_comment
comment|/* Verify consistency of the metadata concerning WCROOT.  This is intended  * for use only during testing and debugging, so is not intended to be  * blazingly fast.  *  * This code is a complement to any verification that we can do in SQLite  * triggers.  See, for example, 'wc-checks.sql'.  *  * Some more verification steps we might want to add are:  *  *   * on every ACTUAL row (except root): a NODES row exists at its parent path  *   * the op-depth root must always exist and every intermediate too  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|verify_wcroot
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_ALL_NODES
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"i"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|TRUE
condition|)
block|{
name|svn_boolean_t
name|have_row
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|,
modifier|*
name|parent_relpath
decl_stmt|;
name|int
name|op_depth
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
break|break;
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|parent_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
comment|/* Verify parent_relpath is the parent path of local_relpath */
name|VERIFY
argument_list|(
operator|(
name|parent_relpath
operator|==
name|NULL
operator|)
condition|?
operator|(
name|local_relpath
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|)
else|:
operator|(
name|strcmp
argument_list|(
name|svn_relpath_dirname
argument_list|(
name|local_relpath
argument_list|,
name|iterpool
argument_list|)
argument_list|,
name|parent_relpath
argument_list|)
operator|==
literal|0
operator|)
argument_list|)
expr_stmt|;
comment|/* Verify op_depth<= the tree depth of local_relpath */
name|VERIFY
argument_list|(
name|op_depth
operator|<=
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Verify parent_relpath refers to a row that exists */
comment|/* TODO: Verify there is a suitable parent row - e.g. has op_depth<=        * the child's and a suitable presence */
if|if
condition|(
name|parent_relpath
operator|&&
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|)
condition|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt2
decl_stmt|;
name|svn_boolean_t
name|have_a_parent_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt2
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_NODE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt2
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|parent_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_a_parent_row
argument_list|,
name|stmt2
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
name|have_a_parent_row
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt2
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_verify
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|verify_wcroot
argument_list|(
name|wcroot
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_bump_format
parameter_list|(
name|int
modifier|*
name|result_format
parameter_list|,
name|svn_boolean_t
modifier|*
name|bumped_format
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wcroot_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__db_t
modifier|*
name|sdb
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|int
name|format
decl_stmt|;
if|if
condition|(
name|bumped_format
condition|)
operator|*
name|bumped_format
operator|=
name|FALSE
expr_stmt|;
comment|/* Do not scan upwards for a working copy root here to prevent accidental    * upgrades of any working copies the WCROOT might be nested in.    * Just try to open a DB at the specified path instead. */
name|err
operator|=
name|svn_wc__db_util_open_db
argument_list|(
operator|&
name|sdb
argument_list|,
name|wcroot_abspath
argument_list|,
name|SDB_FILE
argument_list|,
name|svn_sqlite__mode_readwrite
argument_list|,
name|TRUE
argument_list|,
comment|/* exclusive */
name|NULL
argument_list|,
comment|/* my statements */
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|svn_error_t
modifier|*
name|err2
decl_stmt|;
name|apr_hash_t
modifier|*
name|entries
decl_stmt|;
comment|/* Could not open an sdb. Check for an entries file instead. */
name|err2
operator|=
name|svn_wc__read_entries_old
argument_list|(
operator|&
name|entries
argument_list|,
name|wcroot_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err2
operator|||
name|apr_hash_count
argument_list|(
name|entries
argument_list|)
operator|==
literal|0
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_INVALID_OP_ON_CWD
argument_list|,
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|err2
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Can't upgrade '%s' as it is not a working copy root"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|wcroot_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
comment|/* An entries file was found. This is a pre-wc-ng working copy        * so suggest an upgrade. */
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_UPGRADE_REQUIRED
argument_list|,
name|err
argument_list|,
name|_
argument_list|(
literal|"Working copy '%s' is too old and must be upgraded to "
literal|"at least format %d, as created by Subversion %s"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|wcroot_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|SVN_WC__WC_NG_VERSION
argument_list|,
name|svn_wc__version_string_from_format
argument_list|(
name|SVN_WC__WC_NG_VERSION
argument_list|)
argument_list|)
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__read_schema_version
argument_list|(
operator|&
name|format
argument_list|,
name|sdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_wc__upgrade_sdb
argument_list|(
name|result_format
argument_list|,
name|wcroot_abspath
argument_list|,
name|sdb
argument_list|,
name|format
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|SVN_NO_ERROR
operator|&&
name|bumped_format
condition|)
operator|*
name|bumped_format
operator|=
operator|(
operator|*
name|result_format
operator|>
name|format
operator|)
expr_stmt|;
comment|/* Make sure we return a different error than expected for upgrades from      entries */
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_WC_UPGRADE_REQUIRED
condition|)
name|err
operator|=
name|svn_error_create
argument_list|(
name|SVN_ERR_WC_UNSUPPORTED_FORMAT
argument_list|,
name|err
argument_list|,
name|_
argument_list|(
literal|"Working copy upgrade failed"
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__close
argument_list|(
name|sdb
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_vacuum
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_VACUUM
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


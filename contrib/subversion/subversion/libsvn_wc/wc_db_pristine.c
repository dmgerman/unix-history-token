begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wc_db_pristine.c :  Pristine ("text base") management  *  * See the spec in 'notes/wc-ng/pristine-store'.  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_define
define|#
directive|define
name|SVN_WC__I_AM_WC_DB
end_define

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"wc.h"
end_include

begin_include
include|#
directive|include
file|"wc_db.h"
end_include

begin_include
include|#
directive|include
file|"wc-queries.h"
end_include

begin_include
include|#
directive|include
file|"wc_db_private.h"
end_include

begin_define
define|#
directive|define
name|PRISTINE_STORAGE_EXT
value|".svn-base"
end_define

begin_define
define|#
directive|define
name|PRISTINE_STORAGE_RELPATH
value|"pristine"
end_define

begin_define
define|#
directive|define
name|PRISTINE_TEMPDIR_RELPATH
value|"tmp"
end_define

begin_comment
comment|/* Returns in PRISTINE_ABSPATH a new string allocated from RESULT_POOL,    holding the local absolute path to the file location that is dedicated    to hold CHECKSUM's pristine file, relating to the pristine store    configured for the working copy indicated by PDH. The returned path    does not necessarily currently exist.     Any other allocations are made in SCRATCH_POOL. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_pristine_fname
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|pristine_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|wcroot_abspath
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|base_dir_abspath
decl_stmt|;
specifier|const
name|char
modifier|*
name|hexdigest
init|=
name|svn_checksum_to_cstring
argument_list|(
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|char
name|subdir
index|[
literal|3
index|]
decl_stmt|;
comment|/* ### code is in transition. make sure we have the proper data.  */
name|SVN_ERR_ASSERT
argument_list|(
name|pristine_abspath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|wcroot_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|sha1_checksum
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|sha1_checksum
operator|->
name|kind
operator|==
name|svn_checksum_sha1
argument_list|)
expr_stmt|;
name|base_dir_abspath
operator|=
name|svn_dirent_join_many
argument_list|(
name|scratch_pool
argument_list|,
name|wcroot_abspath
argument_list|,
name|svn_wc_get_adm_dir
argument_list|(
name|scratch_pool
argument_list|)
argument_list|,
name|PRISTINE_STORAGE_RELPATH
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* We should have a valid checksum and (thus) a valid digest. */
name|SVN_ERR_ASSERT
argument_list|(
name|hexdigest
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Get the first two characters of the digest, for the subdir. */
name|subdir
index|[
literal|0
index|]
operator|=
name|hexdigest
index|[
literal|0
index|]
expr_stmt|;
name|subdir
index|[
literal|1
index|]
operator|=
name|hexdigest
index|[
literal|1
index|]
expr_stmt|;
name|subdir
index|[
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
name|hexdigest
operator|=
name|apr_pstrcat
argument_list|(
name|scratch_pool
argument_list|,
name|hexdigest
argument_list|,
name|PRISTINE_STORAGE_EXT
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
comment|/* The file is located at DIR/.svn/pristine/XX/XXYYZZ...svn-base */
operator|*
name|pristine_abspath
operator|=
name|svn_dirent_join_many
argument_list|(
name|result_pool
argument_list|,
name|base_dir_abspath
argument_list|,
name|subdir
argument_list|,
name|hexdigest
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_pristine_get_path
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|pristine_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_boolean_t
name|present
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|pristine_abspath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|wri_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|sha1_checksum
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* ### Transitional: accept MD-5 and look up the SHA-1.  Return an error    * if the pristine text is not in the store. */
if|if
condition|(
name|sha1_checksum
operator|->
name|kind
operator|!=
name|svn_checksum_sha1
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_get_sha1
argument_list|(
operator|&
name|sha1_checksum
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|sha1_checksum
operator|->
name|kind
operator|==
name|svn_checksum_sha1
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_check
argument_list|(
operator|&
name|present
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|present
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_DB_ERROR
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The pristine text with checksum '%s' was "
literal|"not found"
argument_list|)
argument_list|,
name|svn_checksum_to_cstring_display
argument_list|(
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|get_pristine_fname
argument_list|(
name|pristine_abspath
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|sha1_checksum
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_pristine_get_future_path
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|pristine_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|wcroot_abspath
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|get_pristine_fname
argument_list|(
name|pristine_abspath
argument_list|,
name|wcroot_abspath
argument_list|,
name|sha1_checksum
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Set *CONTENTS to a readable stream from which the pristine text  * identified by SHA1_CHECKSUM and PRISTINE_ABSPATH can be read from the  * pristine store of WCROOT.  If SIZE is not null, set *SIZE to the size  * in bytes of that text. If that text is not in the pristine store,  * return an error.  *  * Even if the pristine text is removed from the store while it is being  * read, the stream will remain valid and readable until it is closed.  *  * Allocate the stream in RESULT_POOL.  *  * This function expects to be executed inside a SQLite txn.  *  * Implements 'notes/wc-ng/pristine-store' section A-3(d).  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|pristine_read_txn
parameter_list|(
name|svn_stream_t
modifier|*
modifier|*
name|contents
parameter_list|,
name|svn_filesize_t
modifier|*
name|size
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
parameter_list|,
specifier|const
name|char
modifier|*
name|pristine_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
comment|/* Check that this pristine text is present in the store.  (The presence    * of the file is not sufficient.) */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_PRISTINE_SIZE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_checksum
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
condition|)
operator|*
name|size
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Pristine text '%s' not present"
argument_list|)
argument_list|,
name|svn_checksum_to_cstring_display
argument_list|(
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
comment|/* Open the file as a readable stream.  It will remain readable even when    * deleted from disk; APR guarantees that on Windows as well as Unix. */
if|if
condition|(
name|contents
condition|)
name|SVN_ERR
argument_list|(
name|svn_stream_open_readonly
argument_list|(
name|contents
argument_list|,
name|pristine_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_pristine_read
parameter_list|(
name|svn_stream_t
modifier|*
modifier|*
name|contents
parameter_list|,
name|svn_filesize_t
modifier|*
name|size
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|pristine_abspath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|contents
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|wri_abspath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Some 1.6-to-1.7 wc upgrades created rows without checksums and      updating such a row passes NULL here. */
if|if
condition|(
operator|!
name|sha1_checksum
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CORRUPT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't read '%s' from pristine store "
literal|"because no checksum supplied"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|SVN_ERR_ASSERT
argument_list|(
name|sha1_checksum
operator|->
name|kind
operator|==
name|svn_checksum_sha1
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|get_pristine_fname
argument_list|(
operator|&
name|pristine_abspath
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|pristine_read_txn
argument_list|(
name|contents
argument_list|,
name|size
argument_list|,
name|wcroot
argument_list|,
name|sha1_checksum
argument_list|,
name|pristine_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Return the absolute path to the temporary directory for pristine text    files within WCROOT. */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|pristine_get_tempdir
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_dirent_join_many
argument_list|(
name|result_pool
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|svn_wc_get_adm_dir
argument_list|(
name|scratch_pool
argument_list|)
argument_list|,
name|PRISTINE_TEMPDIR_RELPATH
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_pristine_get_tempdir
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|temp_dir_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|temp_dir_abspath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|wri_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
operator|*
name|temp_dir_abspath
operator|=
name|pristine_get_tempdir
argument_list|(
name|wcroot
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Install the pristine text described by BATON into the pristine store of  * SDB.  If it is already stored then just delete the new file  * BATON->tempfile_abspath.  *  * This function expects to be executed inside a SQLite txn that has already  * acquired a 'RESERVED' lock.  *  * Implements 'notes/wc-ng/pristine-store' section A-3(a).  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|pristine_install_txn
parameter_list|(
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
comment|/* The path to the source file that is to be moved into place. */
specifier|const
name|char
modifier|*
name|tempfile_abspath
parameter_list|,
comment|/* The target path for the file (within the pristine store). */
specifier|const
name|char
modifier|*
name|pristine_abspath
parameter_list|,
comment|/* The pristine text's SHA-1 checksum. */
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
parameter_list|,
comment|/* The pristine text's MD-5 checksum. */
specifier|const
name|svn_checksum_t
modifier|*
name|md5_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_finfo_t
name|finfo
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
comment|/* If this pristine text is already present in the store, just keep it:    * delete the new one and return. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_SELECT_PRISTINE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_checksum
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
ifdef|#
directive|ifdef
name|SVN_DEBUG
comment|/* Consistency checks.  Verify both files exist and match.        * ### We could check much more. */
block|{
name|apr_finfo_t
name|finfo1
decl_stmt|,
name|finfo2
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_stat
argument_list|(
operator|&
name|finfo1
argument_list|,
name|tempfile_abspath
argument_list|,
name|APR_FINFO_SIZE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_stat
argument_list|(
operator|&
name|finfo2
argument_list|,
name|pristine_abspath
argument_list|,
name|APR_FINFO_SIZE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|finfo1
operator|.
name|size
operator|!=
name|finfo2
operator|.
name|size
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CORRUPT_TEXT_BASE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"New pristine text '%s' has different size: %ld versus %ld"
argument_list|)
argument_list|,
name|svn_checksum_to_cstring_display
argument_list|(
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
operator|(
name|long
name|int
operator|)
name|finfo1
operator|.
name|size
argument_list|,
operator|(
name|long
name|int
operator|)
name|finfo2
operator|.
name|size
argument_list|)
return|;
block|}
block|}
endif|#
directive|endif
comment|/* Remove the temp file: it's already there */
name|SVN_ERR
argument_list|(
name|svn_io_remove_file2
argument_list|(
name|tempfile_abspath
argument_list|,
name|FALSE
comment|/* ignore_enoent */
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
comment|/* Move the file to its target location.  (If it is already there, it is    * an orphan file and it doesn't matter if we overwrite it.) */
name|err
operator|=
name|svn_io_file_rename
argument_list|(
name|tempfile_abspath
argument_list|,
name|pristine_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* Maybe the directory doesn't exist yet? */
if|if
condition|(
name|err
operator|&&
name|APR_STATUS_IS_ENOENT
argument_list|(
name|err
operator|->
name|apr_err
argument_list|)
condition|)
block|{
name|svn_error_t
modifier|*
name|err2
decl_stmt|;
name|err2
operator|=
name|svn_io_dir_make
argument_list|(
name|svn_dirent_dirname
argument_list|(
name|pristine_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err2
condition|)
comment|/* Creating directory didn't work: Return all errors */
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|err2
argument_list|)
argument_list|)
return|;
else|else
comment|/* We could create a directory: retry install */
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_rename
argument_list|(
name|tempfile_abspath
argument_list|,
name|pristine_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_stat
argument_list|(
operator|&
name|finfo
argument_list|,
name|pristine_abspath
argument_list|,
name|APR_FINFO_SIZE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_INSERT_PRISTINE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_checksum
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_checksum
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|md5_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int64
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|finfo
operator|.
name|size
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__insert
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_pristine_install
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|tempfile_abspath
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|md5_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|wri_abspath
decl_stmt|;
specifier|const
name|char
modifier|*
name|pristine_abspath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|tempfile_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|sha1_checksum
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|sha1_checksum
operator|->
name|kind
operator|==
name|svn_checksum_sha1
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|md5_checksum
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|md5_checksum
operator|->
name|kind
operator|==
name|svn_checksum_md5
argument_list|)
expr_stmt|;
comment|/* ### this logic assumes that TEMPFILE_ABSPATH follows this pattern:      ###   WCROOT_ABSPATH/COMPONENT/COMPONENT/TEMPFNAME      ### if we change this (see PRISTINE_TEMPDIR_RELPATH), then this      ### logic should change.  */
name|wri_abspath
operator|=
name|svn_dirent_dirname
argument_list|(
name|svn_dirent_dirname
argument_list|(
name|svn_dirent_dirname
argument_list|(
name|tempfile_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|get_pristine_fname
argument_list|(
operator|&
name|pristine_abspath
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Ensure the SQL txn has at least a 'RESERVED' lock before we start looking    * at the disk, to ensure no concurrent pristine install/delete txn. */
name|SVN_SQLITE__WITH_IMMEDIATE_TXN
argument_list|(
name|pristine_install_txn
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|tempfile_abspath
argument_list|,
name|pristine_abspath
argument_list|,
name|sha1_checksum
argument_list|,
name|md5_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_pristine_get_md5
parameter_list|(
specifier|const
name|svn_checksum_t
modifier|*
modifier|*
name|md5_checksum
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|wri_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|sha1_checksum
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|sha1_checksum
operator|->
name|kind
operator|==
name|svn_checksum_sha1
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_PRISTINE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_checksum
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_DB_ERROR
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The pristine text with checksum '%s' was "
literal|"not found"
argument_list|)
argument_list|,
name|svn_checksum_to_cstring_display
argument_list|(
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_checksum
argument_list|(
name|md5_checksum
argument_list|,
name|stmt
argument_list|,
literal|0
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|(
operator|*
name|md5_checksum
operator|)
operator|->
name|kind
operator|==
name|svn_checksum_md5
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_pristine_get_sha1
parameter_list|(
specifier|const
name|svn_checksum_t
modifier|*
modifier|*
name|sha1_checksum
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|md5_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|wri_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|sha1_checksum
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|md5_checksum
operator|->
name|kind
operator|==
name|svn_checksum_md5
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_PRISTINE_BY_MD5
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_checksum
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|md5_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_DB_ERROR
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"The pristine text with MD5 checksum '%s' was "
literal|"not found"
argument_list|)
argument_list|,
name|svn_checksum_to_cstring_display
argument_list|(
name|md5_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_checksum
argument_list|(
name|sha1_checksum
argument_list|,
name|stmt
argument_list|,
literal|0
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|(
operator|*
name|sha1_checksum
operator|)
operator|->
name|kind
operator|==
name|svn_checksum_sha1
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Handle the moving of a pristine from SRC_WCROOT to DST_WCROOT. The existing    pristine in SRC_WCROOT is described by CHECKSUM, MD5_CHECKSUM and SIZE */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|maybe_transfer_one_pristine
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|src_wcroot
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|dst_wcroot
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|md5_checksum
parameter_list|,
name|apr_int64_t
name|size
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pristine_abspath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_stream_t
modifier|*
name|src_stream
decl_stmt|;
name|svn_stream_t
modifier|*
name|dst_stream
decl_stmt|;
specifier|const
name|char
modifier|*
name|tmp_abspath
decl_stmt|;
specifier|const
name|char
modifier|*
name|src_abspath
decl_stmt|;
name|int
name|affected_rows
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|dst_wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_OR_IGNORE_PRISTINE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_checksum
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_checksum
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|md5_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_int64
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|size
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|affected_rows
operator|==
literal|0
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR
argument_list|(
name|svn_stream_open_unique
argument_list|(
operator|&
name|dst_stream
argument_list|,
operator|&
name|tmp_abspath
argument_list|,
name|pristine_get_tempdir
argument_list|(
name|dst_wcroot
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|svn_io_file_del_on_pool_cleanup
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|get_pristine_fname
argument_list|(
operator|&
name|src_abspath
argument_list|,
name|src_wcroot
operator|->
name|abspath
argument_list|,
name|checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_open_readonly
argument_list|(
operator|&
name|src_stream
argument_list|,
name|src_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### Should we verify the SHA1 or MD5 here, or is that too expensive? */
name|SVN_ERR
argument_list|(
name|svn_stream_copy3
argument_list|(
name|src_stream
argument_list|,
name|dst_stream
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|get_pristine_fname
argument_list|(
operator|&
name|pristine_abspath
argument_list|,
name|dst_wcroot
operator|->
name|abspath
argument_list|,
name|checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Move the file to its target location.  (If it is already there, it is    * an orphan file and it doesn't matter if we overwrite it.) */
name|err
operator|=
name|svn_io_file_rename
argument_list|(
name|tmp_abspath
argument_list|,
name|pristine_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* Maybe the directory doesn't exist yet? */
if|if
condition|(
name|err
operator|&&
name|APR_STATUS_IS_ENOENT
argument_list|(
name|err
operator|->
name|apr_err
argument_list|)
condition|)
block|{
name|svn_error_t
modifier|*
name|err2
decl_stmt|;
name|err2
operator|=
name|svn_io_dir_make
argument_list|(
name|svn_dirent_dirname
argument_list|(
name|pristine_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err2
condition|)
comment|/* Creating directory didn't work: Return all errors */
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|err2
argument_list|)
argument_list|)
return|;
else|else
comment|/* We could create a directory: retry install */
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_rename
argument_list|(
name|tmp_abspath
argument_list|,
name|pristine_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Transaction implementation of svn_wc__db_pristine_transfer().    We have a lock on DST_WCROOT.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|pristine_transfer_txn
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|src_wcroot
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|dst_wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|got_row
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|src_wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_COPY_PRISTINES
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|src_wcroot
operator|->
name|wc_id
argument_list|,
name|src_relpath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* This obtains an sqlite read lock on src_wcroot */
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|got_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|got_row
condition|)
block|{
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
specifier|const
name|svn_checksum_t
modifier|*
name|md5_checksum
decl_stmt|;
name|apr_int64_t
name|size
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_checksum
argument_list|(
operator|&
name|checksum
argument_list|,
name|stmt
argument_list|,
literal|0
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_checksum
argument_list|(
operator|&
name|md5_checksum
argument_list|,
name|stmt
argument_list|,
literal|1
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|err
operator|=
name|maybe_transfer_one_pristine
argument_list|(
name|src_wcroot
argument_list|,
name|dst_wcroot
argument_list|,
name|checksum
argument_list|,
name|md5_checksum
argument_list|,
name|size
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|got_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_pristine_transfer
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|src_local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_wri_abspath
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|src_wcroot
decl_stmt|,
modifier|*
name|dst_wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|src_relpath
decl_stmt|,
modifier|*
name|dst_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|src_wcroot
argument_list|,
operator|&
name|src_relpath
argument_list|,
name|db
argument_list|,
name|src_local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|src_wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|dst_wcroot
argument_list|,
operator|&
name|dst_relpath
argument_list|,
name|db
argument_list|,
name|dst_wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|dst_wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
name|src_wcroot
operator|==
name|dst_wcroot
operator|||
name|src_wcroot
operator|->
name|sdb
operator|==
name|dst_wcroot
operator|->
name|sdb
condition|)
block|{
return|return
name|SVN_NO_ERROR
return|;
comment|/* Nothing to transfer */
block|}
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|pristine_transfer_txn
argument_list|(
name|src_wcroot
argument_list|,
name|dst_wcroot
argument_list|,
name|src_relpath
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|dst_wcroot
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Remove the file at FILE_ABSPATH in such a way that we could re-create a  * new file of the same name at any time thereafter.  *  * On Windows, the file will not disappear immediately from the directory if  * it is still being read so the best thing to do is first rename it to a  * unique name. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|remove_file
parameter_list|(
specifier|const
name|char
modifier|*
name|file_abspath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|svn_boolean_t
name|ignore_enoent
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|WIN32
name|svn_error_t
modifier|*
name|err
decl_stmt|;
specifier|const
name|char
modifier|*
name|temp_abspath
decl_stmt|;
specifier|const
name|char
modifier|*
name|temp_dir_abspath
init|=
name|pristine_get_tempdir
argument_list|(
name|wcroot
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
comment|/* To rename the file to a unique name in the temp dir, first create a    * uniquely named file in the temp dir and then overwrite it. */
name|SVN_ERR
argument_list|(
name|svn_io_open_unique_file3
argument_list|(
name|NULL
argument_list|,
operator|&
name|temp_abspath
argument_list|,
name|temp_dir_abspath
argument_list|,
name|svn_io_file_del_none
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_io_file_rename
argument_list|(
name|file_abspath
argument_list|,
name|temp_abspath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|ignore_enoent
operator|&&
name|APR_STATUS_IS_ENOENT
argument_list|(
name|err
operator|->
name|apr_err
argument_list|)
condition|)
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|file_abspath
operator|=
name|temp_abspath
expr_stmt|;
endif|#
directive|endif
name|SVN_ERR
argument_list|(
name|svn_io_remove_file2
argument_list|(
name|file_abspath
argument_list|,
name|ignore_enoent
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* If the pristine text referenced by SHA1_CHECKSUM in WCROOT/SDB, whose path  * within the pristine store is PRISTINE_ABSPATH, has a reference count of  * zero, delete it (both the database row and the disk file).  *  * This function expects to be executed inside a SQLite txn that has already  * acquired a 'RESERVED' lock.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|pristine_remove_if_unreferenced_txn
parameter_list|(
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
parameter_list|,
specifier|const
name|char
modifier|*
name|pristine_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|int
name|affected_rows
decl_stmt|;
comment|/* Remove the DB row, if refcount is 0. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_DELETE_PRISTINE_IF_UNREFERENCED
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_checksum
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__update
argument_list|(
operator|&
name|affected_rows
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If we removed the DB row, then remove the file. */
if|if
condition|(
name|affected_rows
operator|>
literal|0
condition|)
block|{
comment|/* If the file is not present, something has gone wrong, but at this        * point it no longer matters.  In a debug build, raise an error, but        * in a release build, it is more helpful to ignore it and continue. */
ifdef|#
directive|ifdef
name|SVN_DEBUG
name|svn_boolean_t
name|ignore_enoent
init|=
name|FALSE
decl_stmt|;
else|#
directive|else
name|svn_boolean_t
name|ignore_enoent
init|=
name|TRUE
decl_stmt|;
endif|#
directive|endif
name|SVN_ERR
argument_list|(
name|remove_file
argument_list|(
name|pristine_abspath
argument_list|,
name|wcroot
argument_list|,
name|ignore_enoent
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* If the pristine text referenced by SHA1_CHECKSUM in WCROOT has a  * reference count of zero, delete it (both the database row and the disk  * file).  *  * Implements 'notes/wc-ng/pristine-store' section A-3(b). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|pristine_remove_if_unreferenced
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pristine_abspath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|get_pristine_fname
argument_list|(
operator|&
name|pristine_abspath
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Ensure the SQL txn has at least a 'RESERVED' lock before we start looking    * at the disk, to ensure no concurrent pristine install/delete txn. */
name|SVN_SQLITE__WITH_IMMEDIATE_TXN
argument_list|(
name|pristine_remove_if_unreferenced_txn
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|wcroot
argument_list|,
name|sha1_checksum
argument_list|,
name|pristine_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_pristine_remove
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|wri_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|sha1_checksum
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* ### Transitional: accept MD-5 and look up the SHA-1.  Return an error    * if the pristine text is not in the store. */
if|if
condition|(
name|sha1_checksum
operator|->
name|kind
operator|!=
name|svn_checksum_sha1
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_get_sha1
argument_list|(
operator|&
name|sha1_checksum
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|sha1_checksum
operator|->
name|kind
operator|==
name|svn_checksum_sha1
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
comment|/* If the work queue is not empty, don't delete any pristine text because    * the work queue may contain a reference to it. */
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_LOOK_FOR_WORK
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
return|return
name|SVN_NO_ERROR
return|;
block|}
comment|/* If not referenced, remove the PRISTINE table row and the file. */
name|SVN_ERR
argument_list|(
name|pristine_remove_if_unreferenced
argument_list|(
name|wcroot
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|pristine_cleanup_wcroot
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
comment|/* Find each unreferenced pristine in the DB and remove it. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_UNREFERENCED_PRISTINES
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|err
condition|)
block|{
name|svn_boolean_t
name|have_row
decl_stmt|;
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
break|break;
name|SVN_ERR
argument_list|(
name|svn_sqlite__column_checksum
argument_list|(
operator|&
name|sha1_checksum
argument_list|,
name|stmt
argument_list|,
literal|0
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|pristine_remove_if_unreferenced
argument_list|(
name|wcroot
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_pristine_cleanup
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|wri_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|pristine_cleanup_wcroot
argument_list|(
name|wcroot
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_pristine_check
parameter_list|(
name|svn_boolean_t
modifier|*
name|present
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|wri_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|sha1_checksum
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|sha1_checksum
operator|->
name|kind
operator|!=
name|svn_checksum_sha1
condition|)
block|{
operator|*
name|present
operator|=
name|FALSE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
comment|/* A filestat is much cheaper than a sqlite transaction especially on NFS,      so first check if there is a pristine file and then if we are allowed      to use it. */
block|{
specifier|const
name|char
modifier|*
name|pristine_abspath
decl_stmt|;
name|svn_node_kind_t
name|kind_on_disk
decl_stmt|;
name|SVN_ERR
argument_list|(
name|get_pristine_fname
argument_list|(
operator|&
name|pristine_abspath
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_check_path
argument_list|(
name|pristine_abspath
argument_list|,
operator|&
name|kind_on_disk
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind_on_disk
operator|!=
name|svn_node_file
condition|)
block|{
operator|*
name|present
operator|=
name|FALSE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
comment|/* Check that there is an entry in the PRISTINE table. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_PRISTINE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bind_checksum
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|sha1_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|present
operator|=
name|have_row
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * util.c:  general routines defying categorization; eventually I  *          suspect they'll end up in libsvn_subr, but don't want to  *          pollute that right now.  Note that nothing in here is  *          specific to working copies.  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|<apr_pools.h>
end_include

begin_include
include|#
directive|include
file|<apr_file_io.h>
end_include

begin_include
include|#
directive|include
file|"svn_io.h"
end_include

begin_include
include|#
directive|include
file|"svn_types.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"svn_props.h"
end_include

begin_include
include|#
directive|include
file|"svn_version.h"
end_include

begin_include
include|#
directive|include
file|"wc.h"
end_include

begin_comment
comment|/* just for prototypes of things in this .c file */
end_comment

begin_include
include|#
directive|include
file|"entries.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_wc_private.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_escape
end_escape

begin_function
name|svn_error_t
modifier|*
name|svn_wc__ensure_directory
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_check_path
argument_list|(
name|path
argument_list|,
operator|&
name|kind
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|!=
name|svn_node_none
operator|&&
name|kind
operator|!=
name|svn_node_dir
condition|)
block|{
comment|/* If got an error other than dir non-existence, then we can't          ensure this directory's existence, so just return the error.          Might happen if there's a file in the way, for example. */
return|return
name|svn_error_createf
argument_list|(
name|APR_ENOTDIR
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is not a directory"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|kind
operator|==
name|svn_node_none
condition|)
block|{
comment|/* The dir doesn't exist, and it's our job to change that. */
name|SVN_ERR
argument_list|(
name|svn_io_make_dir_recursively
argument_list|(
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* No problem, the dir already existed, so just leave. */
name|SVN_ERR_ASSERT
argument_list|(
name|kind
operator|==
name|svn_node_dir
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Return the library version number. */
end_comment

begin_function
specifier|const
name|svn_version_t
modifier|*
name|svn_wc_version
parameter_list|(
name|void
parameter_list|)
block|{
name|SVN_VERSION_BODY
expr_stmt|;
block|}
end_function

begin_function
name|svn_wc_notify_t
modifier|*
name|svn_wc_create_notify
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_wc_notify_action_t
name|action
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_wc_notify_t
modifier|*
name|ret
init|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ret
argument_list|)
argument_list|)
decl_stmt|;
name|ret
operator|->
name|path
operator|=
name|path
expr_stmt|;
name|ret
operator|->
name|action
operator|=
name|action
expr_stmt|;
name|ret
operator|->
name|kind
operator|=
name|svn_node_unknown
expr_stmt|;
name|ret
operator|->
name|content_state
operator|=
name|ret
operator|->
name|prop_state
operator|=
name|svn_wc_notify_state_unknown
expr_stmt|;
name|ret
operator|->
name|lock_state
operator|=
name|svn_wc_notify_lock_state_unknown
expr_stmt|;
name|ret
operator|->
name|revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|ret
operator|->
name|old_revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|svn_wc_notify_t
modifier|*
name|svn_wc_create_notify_url
parameter_list|(
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|svn_wc_notify_action_t
name|action
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_wc_notify_t
modifier|*
name|ret
init|=
name|svn_wc_create_notify
argument_list|(
literal|"."
argument_list|,
name|action
argument_list|,
name|pool
argument_list|)
decl_stmt|;
name|ret
operator|->
name|url
operator|=
name|url
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Pool cleanup function to clear an svn_error_t *. */
end_comment

begin_function
specifier|static
name|apr_status_t
name|err_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|svn_error_clear
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
name|svn_wc_notify_t
modifier|*
name|svn_wc_dup_notify
parameter_list|(
specifier|const
name|svn_wc_notify_t
modifier|*
name|notify
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_wc_notify_t
modifier|*
name|ret
init|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ret
argument_list|)
argument_list|)
decl_stmt|;
operator|*
name|ret
operator|=
operator|*
name|notify
expr_stmt|;
if|if
condition|(
name|ret
operator|->
name|path
condition|)
name|ret
operator|->
name|path
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|ret
operator|->
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|->
name|mime_type
condition|)
name|ret
operator|->
name|mime_type
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|ret
operator|->
name|mime_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|->
name|lock
condition|)
name|ret
operator|->
name|lock
operator|=
name|svn_lock_dup
argument_list|(
name|ret
operator|->
name|lock
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|->
name|err
condition|)
block|{
name|ret
operator|->
name|err
operator|=
name|svn_error_dup
argument_list|(
name|ret
operator|->
name|err
argument_list|)
expr_stmt|;
name|apr_pool_cleanup_register
argument_list|(
name|pool
argument_list|,
name|ret
operator|->
name|err
argument_list|,
name|err_cleanup
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|->
name|changelist_name
condition|)
name|ret
operator|->
name|changelist_name
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|ret
operator|->
name|changelist_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|->
name|merge_range
condition|)
name|ret
operator|->
name|merge_range
operator|=
name|svn_merge_range_dup
argument_list|(
name|ret
operator|->
name|merge_range
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|->
name|url
condition|)
name|ret
operator|->
name|url
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|ret
operator|->
name|url
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|->
name|path_prefix
condition|)
name|ret
operator|->
name|path_prefix
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|ret
operator|->
name|path_prefix
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|->
name|prop_name
condition|)
name|ret
operator|->
name|prop_name
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|ret
operator|->
name|prop_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|->
name|rev_props
condition|)
name|ret
operator|->
name|rev_props
operator|=
name|svn_prop_hash_dup
argument_list|(
name|ret
operator|->
name|rev_props
argument_list|,
name|pool
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc_external_item2_create
parameter_list|(
name|svn_wc_external_item2_t
modifier|*
modifier|*
name|item
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
operator|*
name|item
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_wc_external_item2_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_wc_external_item2_t
modifier|*
name|svn_wc_external_item2_dup
parameter_list|(
specifier|const
name|svn_wc_external_item2_t
modifier|*
name|item
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_wc_external_item2_t
modifier|*
name|new_item
init|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|new_item
argument_list|)
argument_list|)
decl_stmt|;
operator|*
name|new_item
operator|=
operator|*
name|item
expr_stmt|;
if|if
condition|(
name|new_item
operator|->
name|target_dir
condition|)
name|new_item
operator|->
name|target_dir
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|new_item
operator|->
name|target_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_item
operator|->
name|url
condition|)
name|new_item
operator|->
name|url
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|new_item
operator|->
name|url
argument_list|)
expr_stmt|;
return|return
name|new_item
return|;
block|}
end_function

begin_function
name|svn_boolean_t
name|svn_wc_match_ignore_list
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|list
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
comment|/* For now, we simply forward to svn_cstring_match_glob_list. In the      future, if we support more complex ignore patterns, we would iterate      over 'list' ourselves, and decide for each pattern how to handle      it. */
return|return
name|svn_cstring_match_glob_list
argument_list|(
name|str
argument_list|,
name|list
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_wc_conflict_description2_t
modifier|*
name|svn_wc_conflict_description_create_text2
parameter_list|(
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_wc_conflict_description2_t
modifier|*
name|conflict
decl_stmt|;
name|SVN_ERR_ASSERT_NO_RETURN
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|conflict
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|conflict
argument_list|)
argument_list|)
expr_stmt|;
name|conflict
operator|->
name|local_abspath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
name|conflict
operator|->
name|node_kind
operator|=
name|svn_node_file
expr_stmt|;
name|conflict
operator|->
name|kind
operator|=
name|svn_wc_conflict_kind_text
expr_stmt|;
name|conflict
operator|->
name|action
operator|=
name|svn_wc_conflict_action_edit
expr_stmt|;
name|conflict
operator|->
name|reason
operator|=
name|svn_wc_conflict_reason_edited
expr_stmt|;
return|return
name|conflict
return|;
block|}
end_function

begin_function
name|svn_wc_conflict_description2_t
modifier|*
name|svn_wc_conflict_description_create_prop2
parameter_list|(
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_node_kind_t
name|node_kind
parameter_list|,
specifier|const
name|char
modifier|*
name|property_name
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_wc_conflict_description2_t
modifier|*
name|conflict
decl_stmt|;
name|SVN_ERR_ASSERT_NO_RETURN
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|conflict
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|conflict
argument_list|)
argument_list|)
expr_stmt|;
name|conflict
operator|->
name|local_abspath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
name|conflict
operator|->
name|node_kind
operator|=
name|node_kind
expr_stmt|;
name|conflict
operator|->
name|kind
operator|=
name|svn_wc_conflict_kind_property
expr_stmt|;
name|conflict
operator|->
name|property_name
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|property_name
argument_list|)
expr_stmt|;
return|return
name|conflict
return|;
block|}
end_function

begin_function
name|svn_wc_conflict_description2_t
modifier|*
name|svn_wc_conflict_description_create_tree2
parameter_list|(
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_node_kind_t
name|node_kind
parameter_list|,
name|svn_wc_operation_t
name|operation
parameter_list|,
specifier|const
name|svn_wc_conflict_version_t
modifier|*
name|src_left_version
parameter_list|,
specifier|const
name|svn_wc_conflict_version_t
modifier|*
name|src_right_version
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_wc_conflict_description2_t
modifier|*
name|conflict
decl_stmt|;
name|SVN_ERR_ASSERT_NO_RETURN
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|conflict
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|conflict
argument_list|)
argument_list|)
expr_stmt|;
name|conflict
operator|->
name|local_abspath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|local_abspath
argument_list|)
expr_stmt|;
name|conflict
operator|->
name|node_kind
operator|=
name|node_kind
expr_stmt|;
name|conflict
operator|->
name|kind
operator|=
name|svn_wc_conflict_kind_tree
expr_stmt|;
name|conflict
operator|->
name|operation
operator|=
name|operation
expr_stmt|;
name|conflict
operator|->
name|src_left_version
operator|=
name|svn_wc_conflict_version_dup
argument_list|(
name|src_left_version
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|conflict
operator|->
name|src_right_version
operator|=
name|svn_wc_conflict_version_dup
argument_list|(
name|src_right_version
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
return|return
name|conflict
return|;
block|}
end_function

begin_function
name|svn_wc_conflict_description2_t
modifier|*
name|svn_wc__conflict_description2_dup
parameter_list|(
specifier|const
name|svn_wc_conflict_description2_t
modifier|*
name|conflict
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_wc_conflict_description2_t
modifier|*
name|new_conflict
decl_stmt|;
name|new_conflict
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|new_conflict
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Shallow copy all members. */
operator|*
name|new_conflict
operator|=
operator|*
name|conflict
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|local_abspath
condition|)
name|new_conflict
operator|->
name|local_abspath
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|conflict
operator|->
name|local_abspath
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|property_name
condition|)
name|new_conflict
operator|->
name|property_name
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|conflict
operator|->
name|property_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|mime_type
condition|)
name|new_conflict
operator|->
name|mime_type
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|conflict
operator|->
name|mime_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|base_abspath
condition|)
name|new_conflict
operator|->
name|base_abspath
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|conflict
operator|->
name|base_abspath
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|their_abspath
condition|)
name|new_conflict
operator|->
name|their_abspath
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|conflict
operator|->
name|their_abspath
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|my_abspath
condition|)
name|new_conflict
operator|->
name|my_abspath
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|conflict
operator|->
name|my_abspath
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|merged_file
condition|)
name|new_conflict
operator|->
name|merged_file
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|conflict
operator|->
name|merged_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|src_left_version
condition|)
name|new_conflict
operator|->
name|src_left_version
operator|=
name|svn_wc_conflict_version_dup
argument_list|(
name|conflict
operator|->
name|src_left_version
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|src_right_version
condition|)
name|new_conflict
operator|->
name|src_right_version
operator|=
name|svn_wc_conflict_version_dup
argument_list|(
name|conflict
operator|->
name|src_right_version
argument_list|,
name|pool
argument_list|)
expr_stmt|;
return|return
name|new_conflict
return|;
block|}
end_function

begin_function
name|svn_wc_conflict_version_t
modifier|*
name|svn_wc_conflict_version_create2
parameter_list|(
specifier|const
name|char
modifier|*
name|repos_url
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_uuid
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|svn_node_kind_t
name|kind
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_wc_conflict_version_t
modifier|*
name|version
decl_stmt|;
name|version
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|version
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT_NO_RETURN
argument_list|(
name|svn_uri_is_canonical
argument_list|(
name|repos_url
argument_list|,
name|result_pool
argument_list|)
operator|&&
name|svn_relpath_is_canonical
argument_list|(
name|repos_relpath
argument_list|)
operator|&&
name|SVN_IS_VALID_REVNUM
argument_list|(
name|revision
argument_list|)
comment|/* ### repos_uuid can be NULL :( */
argument_list|)
expr_stmt|;
name|version
operator|->
name|repos_url
operator|=
name|repos_url
expr_stmt|;
name|version
operator|->
name|peg_rev
operator|=
name|revision
expr_stmt|;
name|version
operator|->
name|path_in_repos
operator|=
name|repos_relpath
expr_stmt|;
name|version
operator|->
name|node_kind
operator|=
name|kind
expr_stmt|;
name|version
operator|->
name|repos_uuid
operator|=
name|repos_uuid
expr_stmt|;
return|return
name|version
return|;
block|}
end_function

begin_function
name|svn_wc_conflict_version_t
modifier|*
name|svn_wc_conflict_version_dup
parameter_list|(
specifier|const
name|svn_wc_conflict_version_t
modifier|*
name|version
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_wc_conflict_version_t
modifier|*
name|new_version
decl_stmt|;
if|if
condition|(
name|version
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|new_version
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|new_version
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Shallow copy all members. */
operator|*
name|new_version
operator|=
operator|*
name|version
expr_stmt|;
if|if
condition|(
name|version
operator|->
name|repos_url
condition|)
name|new_version
operator|->
name|repos_url
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|version
operator|->
name|repos_url
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|->
name|path_in_repos
condition|)
name|new_version
operator|->
name|path_in_repos
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|version
operator|->
name|path_in_repos
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|->
name|repos_uuid
condition|)
name|new_version
operator|->
name|repos_uuid
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|version
operator|->
name|repos_uuid
argument_list|)
expr_stmt|;
return|return
name|new_version
return|;
block|}
end_function

begin_function
name|svn_wc_conflict_description_t
modifier|*
name|svn_wc__cd2_to_cd
parameter_list|(
specifier|const
name|svn_wc_conflict_description2_t
modifier|*
name|conflict
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_wc_conflict_description_t
modifier|*
name|new_conflict
decl_stmt|;
if|if
condition|(
name|conflict
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|new_conflict
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|new_conflict
argument_list|)
argument_list|)
expr_stmt|;
name|new_conflict
operator|->
name|path
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|conflict
operator|->
name|local_abspath
argument_list|)
expr_stmt|;
name|new_conflict
operator|->
name|node_kind
operator|=
name|conflict
operator|->
name|node_kind
expr_stmt|;
name|new_conflict
operator|->
name|kind
operator|=
name|conflict
operator|->
name|kind
expr_stmt|;
name|new_conflict
operator|->
name|action
operator|=
name|conflict
operator|->
name|action
expr_stmt|;
name|new_conflict
operator|->
name|reason
operator|=
name|conflict
operator|->
name|reason
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|src_left_version
condition|)
name|new_conflict
operator|->
name|src_left_version
operator|=
name|svn_wc_conflict_version_dup
argument_list|(
name|conflict
operator|->
name|src_left_version
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|src_right_version
condition|)
name|new_conflict
operator|->
name|src_right_version
operator|=
name|svn_wc_conflict_version_dup
argument_list|(
name|conflict
operator|->
name|src_right_version
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|conflict
operator|->
name|kind
condition|)
block|{
case|case
name|svn_wc_conflict_kind_property
case|:
name|new_conflict
operator|->
name|property_name
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|conflict
operator|->
name|property_name
argument_list|)
expr_stmt|;
comment|/* Falling through. */
case|case
name|svn_wc_conflict_kind_text
case|:
name|new_conflict
operator|->
name|is_binary
operator|=
name|conflict
operator|->
name|is_binary
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|mime_type
condition|)
name|new_conflict
operator|->
name|mime_type
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|conflict
operator|->
name|mime_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|base_abspath
condition|)
name|new_conflict
operator|->
name|base_file
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|conflict
operator|->
name|base_abspath
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|their_abspath
condition|)
name|new_conflict
operator|->
name|their_file
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|conflict
operator|->
name|their_abspath
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|my_abspath
condition|)
name|new_conflict
operator|->
name|my_file
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|conflict
operator|->
name|my_abspath
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict
operator|->
name|merged_file
condition|)
name|new_conflict
operator|->
name|merged_file
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|conflict
operator|->
name|merged_file
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_wc_conflict_kind_tree
case|:
name|new_conflict
operator|->
name|operation
operator|=
name|conflict
operator|->
name|operation
expr_stmt|;
break|break;
block|}
comment|/* A NULL access baton is allowable by the API. */
name|new_conflict
operator|->
name|access
operator|=
name|NULL
expr_stmt|;
return|return
name|new_conflict
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__status2_from_3
parameter_list|(
name|svn_wc_status2_t
modifier|*
modifier|*
name|status
parameter_list|,
specifier|const
name|svn_wc_status3_t
modifier|*
name|old_status
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|svn_wc_entry_t
modifier|*
name|entry
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|old_status
operator|==
name|NULL
condition|)
block|{
operator|*
name|status
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
operator|*
name|status
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_status
operator|->
name|versioned
condition|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|err
operator|=
name|svn_wc__get_entry
argument_list|(
operator|&
name|entry
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|FALSE
argument_list|,
name|svn_node_unknown
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_NODE_UNEXPECTED_KIND
condition|)
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|status
operator|)
operator|->
name|entry
operator|=
name|entry
expr_stmt|;
operator|(
operator|*
name|status
operator|)
operator|->
name|copied
operator|=
name|old_status
operator|->
name|copied
expr_stmt|;
operator|(
operator|*
name|status
operator|)
operator|->
name|repos_lock
operator|=
name|svn_lock_dup
argument_list|(
name|old_status
operator|->
name|repos_lock
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_status
operator|->
name|repos_relpath
condition|)
operator|(
operator|*
name|status
operator|)
operator|->
name|url
operator|=
name|svn_path_url_add_component2
argument_list|(
name|old_status
operator|->
name|repos_root_url
argument_list|,
name|old_status
operator|->
name|repos_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
operator|(
operator|*
name|status
operator|)
operator|->
name|ood_last_cmt_rev
operator|=
name|old_status
operator|->
name|ood_changed_rev
expr_stmt|;
operator|(
operator|*
name|status
operator|)
operator|->
name|ood_last_cmt_date
operator|=
name|old_status
operator|->
name|ood_changed_date
expr_stmt|;
operator|(
operator|*
name|status
operator|)
operator|->
name|ood_kind
operator|=
name|old_status
operator|->
name|ood_kind
expr_stmt|;
operator|(
operator|*
name|status
operator|)
operator|->
name|ood_last_cmt_author
operator|=
name|old_status
operator|->
name|ood_changed_author
expr_stmt|;
if|if
condition|(
name|old_status
operator|->
name|conflicted
condition|)
block|{
specifier|const
name|svn_wc_conflict_description2_t
modifier|*
name|tree_conflict
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__get_tree_conflict
argument_list|(
operator|&
name|tree_conflict
argument_list|,
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|status
operator|)
operator|->
name|tree_conflict
operator|=
name|svn_wc__cd2_to_cd
argument_list|(
name|tree_conflict
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|status
operator|)
operator|->
name|switched
operator|=
name|old_status
operator|->
name|switched
expr_stmt|;
operator|(
operator|*
name|status
operator|)
operator|->
name|text_status
operator|=
name|old_status
operator|->
name|node_status
expr_stmt|;
operator|(
operator|*
name|status
operator|)
operator|->
name|prop_status
operator|=
name|old_status
operator|->
name|prop_status
expr_stmt|;
operator|(
operator|*
name|status
operator|)
operator|->
name|repos_text_status
operator|=
name|old_status
operator|->
name|repos_node_status
expr_stmt|;
operator|(
operator|*
name|status
operator|)
operator|->
name|repos_prop_status
operator|=
name|old_status
operator|->
name|repos_prop_status
expr_stmt|;
comment|/* Some values might be inherited from properties */
if|if
condition|(
name|old_status
operator|->
name|node_status
operator|==
name|svn_wc_status_modified
operator|||
name|old_status
operator|->
name|node_status
operator|==
name|svn_wc_status_conflicted
condition|)
operator|(
operator|*
name|status
operator|)
operator|->
name|text_status
operator|=
name|old_status
operator|->
name|text_status
expr_stmt|;
comment|/* (Currently a no-op, but just make sure it is ok) */
if|if
condition|(
name|old_status
operator|->
name|repos_node_status
operator|==
name|svn_wc_status_modified
operator|||
name|old_status
operator|->
name|repos_node_status
operator|==
name|svn_wc_status_conflicted
condition|)
operator|(
operator|*
name|status
operator|)
operator|->
name|repos_text_status
operator|=
name|old_status
operator|->
name|repos_text_status
expr_stmt|;
if|if
condition|(
name|old_status
operator|->
name|node_status
operator|==
name|svn_wc_status_added
condition|)
operator|(
operator|*
name|status
operator|)
operator|->
name|prop_status
operator|=
name|svn_wc_status_none
expr_stmt|;
comment|/* No separate info */
comment|/* Find pristine_text_status value */
switch|switch
condition|(
name|old_status
operator|->
name|text_status
condition|)
block|{
case|case
name|svn_wc_status_none
case|:
case|case
name|svn_wc_status_normal
case|:
case|case
name|svn_wc_status_modified
case|:
operator|(
operator|*
name|status
operator|)
operator|->
name|pristine_text_status
operator|=
name|old_status
operator|->
name|text_status
expr_stmt|;
break|break;
case|case
name|svn_wc_status_conflicted
case|:
default|default:
comment|/* ### Fetch compare data, or fall back to the documented                not retrieved behavior? */
operator|(
operator|*
name|status
operator|)
operator|->
name|pristine_text_status
operator|=
name|svn_wc_status_none
expr_stmt|;
break|break;
block|}
comment|/* Find pristine_prop_status value */
switch|switch
condition|(
name|old_status
operator|->
name|prop_status
condition|)
block|{
case|case
name|svn_wc_status_none
case|:
case|case
name|svn_wc_status_normal
case|:
case|case
name|svn_wc_status_modified
case|:
if|if
condition|(
name|old_status
operator|->
name|node_status
operator|!=
name|svn_wc_status_added
operator|&&
name|old_status
operator|->
name|node_status
operator|!=
name|svn_wc_status_deleted
operator|&&
name|old_status
operator|->
name|node_status
operator|!=
name|svn_wc_status_replaced
condition|)
block|{
operator|(
operator|*
name|status
operator|)
operator|->
name|pristine_prop_status
operator|=
name|old_status
operator|->
name|prop_status
expr_stmt|;
block|}
else|else
operator|(
operator|*
name|status
operator|)
operator|->
name|pristine_prop_status
operator|=
name|svn_wc_status_none
expr_stmt|;
break|break;
case|case
name|svn_wc_status_conflicted
case|:
default|default:
comment|/* ### Fetch compare data, or fall back to the documented                not retrieved behavior? */
operator|(
operator|*
name|status
operator|)
operator|->
name|pristine_prop_status
operator|=
name|svn_wc_status_none
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|old_status
operator|->
name|versioned
operator|&&
name|old_status
operator|->
name|conflicted
operator|&&
name|old_status
operator|->
name|node_status
operator|!=
name|svn_wc_status_obstructed
operator|&&
operator|(
name|old_status
operator|->
name|kind
operator|==
name|svn_node_file
operator|||
name|old_status
operator|->
name|node_status
operator|!=
name|svn_wc_status_missing
operator|)
condition|)
block|{
name|svn_boolean_t
name|text_conflict_p
decl_stmt|,
name|prop_conflict_p
decl_stmt|;
comment|/* The entry says there was a conflict, but the user might have          marked it as resolved by deleting the artifact files, so check          for that. */
name|SVN_ERR
argument_list|(
name|svn_wc__internal_conflicted_p
argument_list|(
operator|&
name|text_conflict_p
argument_list|,
operator|&
name|prop_conflict_p
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|text_conflict_p
condition|)
operator|(
operator|*
name|status
operator|)
operator|->
name|text_status
operator|=
name|svn_wc_status_conflicted
expr_stmt|;
if|if
condition|(
name|prop_conflict_p
condition|)
operator|(
operator|*
name|status
operator|)
operator|->
name|prop_status
operator|=
name|svn_wc_status_conflicted
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__fetch_kind_func
parameter_list|(
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
name|base_revision
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|svn_wc__shim_fetch_baton_t
modifier|*
name|sfb
init|=
name|baton
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_abspath
init|=
name|svn_dirent_join
argument_list|(
name|sfb
operator|->
name|base_abspath
argument_list|,
name|path
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_kind
argument_list|(
name|kind
argument_list|,
name|sfb
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|FALSE
comment|/* allow_missing */
argument_list|,
name|TRUE
comment|/* show_deleted */
argument_list|,
name|FALSE
comment|/* show_hidden */
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__fetch_props_func
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
name|base_revision
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|svn_wc__shim_fetch_baton_t
modifier|*
name|sfb
init|=
name|baton
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_abspath
init|=
name|svn_dirent_join
argument_list|(
name|sfb
operator|->
name|base_abspath
argument_list|,
name|path
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
if|if
condition|(
name|sfb
operator|->
name|fetch_base
condition|)
name|err
operator|=
name|svn_wc__db_base_get_props
argument_list|(
name|props
argument_list|,
name|sfb
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
else|else
name|err
operator|=
name|svn_wc__db_read_props
argument_list|(
name|props
argument_list|,
name|sfb
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* If the path doesn't exist, just return an empty set of props. */
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
operator|*
name|props
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__fetch_base_func
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|filename
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
name|base_revision
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|svn_wc__shim_fetch_baton_t
modifier|*
name|sfb
init|=
name|baton
decl_stmt|;
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_abspath
init|=
name|svn_dirent_join
argument_list|(
name|sfb
operator|->
name|base_abspath
argument_list|,
name|path
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|err
operator|=
name|svn_wc__db_base_get_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|checksum
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|sfb
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
operator|*
name|filename
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
elseif|else
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
if|if
condition|(
name|checksum
operator|==
name|NULL
condition|)
block|{
operator|*
name|filename
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_get_path
argument_list|(
name|filename
argument_list|,
name|sfb
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


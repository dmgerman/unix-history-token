begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * node.c:  routines for getting information about nodes in the working copy.  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_comment
comment|/* A note about these functions:     We aren't really sure yet which bits of data libsvn_client needs about    nodes.  In wc-1, we just grab the entry, and then use whatever we want    from it.  Such a pattern is Bad.     This file is intended to hold functions which retrieve specific bits of    information about a node, and will hopefully give us a better idea about    what data libsvn_client needs, and how to best provide that data in 1.7    final.  As such, these functions should only be called from outside    libsvn_wc; any internal callers are encouraged to use the appropriate    information fetching function, such as svn_wc__db_read_info(). */
end_comment

begin_include
include|#
directive|include
file|<apr_pools.h>
end_include

begin_include
include|#
directive|include
file|<apr_time.h>
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_types.h"
end_include

begin_include
include|#
directive|include
file|"wc.h"
end_include

begin_include
include|#
directive|include
file|"props.h"
end_include

begin_include
include|#
directive|include
file|"entries.h"
end_include

begin_include
include|#
directive|include
file|"wc_db.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_wc_private.h"
end_include

begin_escape
end_escape

begin_comment
comment|/* Set *CHILDREN_ABSPATHS to a new array of the full paths formed by joining  * each name in REL_CHILDREN onto DIR_ABSPATH.  If SHOW_HIDDEN is false then  * omit any paths that are reported as 'hidden' by svn_wc__db_node_hidden().  *  * Allocate the output array and its elements in RESULT_POOL. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|filter_and_make_absolute
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|children_abspaths
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_abspath
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|rel_children
parameter_list|,
name|svn_boolean_t
name|show_hidden
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_array_header_t
modifier|*
name|children
decl_stmt|;
name|int
name|i
decl_stmt|;
name|children
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
name|rel_children
operator|->
name|nelts
argument_list|,
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rel_children
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|child_abspath
init|=
name|svn_dirent_join
argument_list|(
name|dir_abspath
argument_list|,
name|APR_ARRAY_IDX
argument_list|(
name|rel_children
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
argument_list|,
name|result_pool
argument_list|)
decl_stmt|;
comment|/* Don't add hidden nodes to *CHILDREN if we don't want them. */
if|if
condition|(
operator|!
name|show_hidden
condition|)
block|{
name|svn_boolean_t
name|child_is_hidden
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_node_hidden
argument_list|(
operator|&
name|child_is_hidden
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|child_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|child_is_hidden
condition|)
continue|continue;
block|}
name|APR_ARRAY_PUSH
argument_list|(
name|children
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
operator|=
name|child_abspath
expr_stmt|;
block|}
operator|*
name|children_abspaths
operator|=
name|children
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_children_of_working_node
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|children
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_abspath
parameter_list|,
name|svn_boolean_t
name|show_hidden
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|apr_array_header_t
modifier|*
name|rel_children
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_children_of_working_node
argument_list|(
operator|&
name|rel_children
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|filter_and_make_absolute
argument_list|(
name|children
argument_list|,
name|wc_ctx
argument_list|,
name|dir_abspath
argument_list|,
name|rel_children
argument_list|,
name|show_hidden
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_escape
end_escape

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_children
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|children
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_abspath
parameter_list|,
name|svn_boolean_t
name|show_hidden
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|apr_array_header_t
modifier|*
name|rel_children
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_children
argument_list|(
operator|&
name|rel_children
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|filter_and_make_absolute
argument_list|(
name|children
argument_list|,
name|wc_ctx
argument_list|,
name|dir_abspath
argument_list|,
name|rel_children
argument_list|,
name|show_hidden
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__internal_get_repos_info
parameter_list|(
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_uuid
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_boolean_t
name|have_work
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|revision
argument_list|,
name|repos_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|have_work
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|repos_relpath
condition|?
operator|*
name|repos_relpath
operator|!=
name|NULL
else|:
name|TRUE
operator|)
operator|&&
operator|(
name|repos_root_url
condition|?
operator|*
name|repos_root_url
operator|!=
name|NULL
else|:
name|TRUE
operator|)
operator|&&
operator|(
name|repos_uuid
condition|?
operator|*
name|repos_uuid
operator|!=
name|NULL
else|:
name|TRUE
operator|)
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* We got the requested information */
if|if
condition|(
operator|!
name|have_work
condition|)
comment|/* not-present, (server-)excluded? */
block|{
return|return
name|SVN_NO_ERROR
return|;
comment|/* Can't fetch more */
block|}
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_deleted
condition|)
block|{
specifier|const
name|char
modifier|*
name|base_del_abspath
decl_stmt|,
modifier|*
name|wrk_del_abspath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_scan_deletion
argument_list|(
operator|&
name|base_del_abspath
argument_list|,
name|NULL
argument_list|,
operator|&
name|wrk_del_abspath
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|base_del_abspath
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|repos_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|base_del_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If we have a repos_relpath, it is of the op-root */
if|if
condition|(
name|repos_relpath
condition|)
operator|*
name|repos_relpath
operator|=
name|svn_relpath_join
argument_list|(
operator|*
name|repos_relpath
argument_list|,
name|svn_dirent_skip_ancestor
argument_list|(
name|base_del_abspath
argument_list|,
name|local_abspath
argument_list|)
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
comment|/* We keep revision as SVN_INVALID_REVNUM */
block|}
elseif|else
if|if
condition|(
name|wrk_del_abspath
condition|)
block|{
specifier|const
name|char
modifier|*
name|op_root_abspath
init|=
name|NULL
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_scan_addition
argument_list|(
name|NULL
argument_list|,
name|repos_relpath
condition|?
operator|&
name|op_root_abspath
else|:
name|NULL
argument_list|,
name|repos_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|svn_dirent_dirname
argument_list|(
name|wrk_del_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If we have a repos_relpath, it is of the op-root */
if|if
condition|(
name|repos_relpath
condition|)
operator|*
name|repos_relpath
operator|=
name|svn_relpath_join
argument_list|(
operator|*
name|repos_relpath
argument_list|,
name|svn_dirent_skip_ancestor
argument_list|(
name|op_root_abspath
argument_list|,
name|local_abspath
argument_list|)
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
block|}
else|else
comment|/* added, or WORKING incomplete */
block|{
specifier|const
name|char
modifier|*
name|op_root_abspath
init|=
name|NULL
decl_stmt|;
comment|/* We have an addition. scan_addition() will find the intended          repository location by scanning up the tree.  */
name|SVN_ERR
argument_list|(
name|svn_wc__db_scan_addition
argument_list|(
name|NULL
argument_list|,
name|repos_relpath
condition|?
operator|&
name|op_root_abspath
else|:
name|NULL
argument_list|,
name|repos_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR_ASSERT
argument_list|(
name|repos_root_url
operator|==
name|NULL
operator|||
operator|*
name|repos_root_url
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|repos_uuid
operator|==
name|NULL
operator|||
operator|*
name|repos_uuid
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_repos_info
parameter_list|(
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_uuid
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_wc__internal_get_repos_info
argument_list|(
name|revision
argument_list|,
name|repos_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Convert DB_KIND into the appropriate NODE_KIND value.  * If SHOW_HIDDEN is TRUE, report the node kind as found in the DB  * even if DB_STATUS indicates that the node is hidden.  * Else, return svn_node_none for such nodes.  *  * ### This is a bit ugly. We should consider promoting svn_kind_t  * ### to the de-facto node kind type instead of converting between them  * ### in non-backwards compat code.  * ### See also comments at the definition of svn_kind_t.  *  * ### In reality, the previous comment is out of date, as there is  * ### now only one enumeration for node kinds, and that is  * ### svn_node_kind_t (svn_kind_t was merged with that). But it's  * ### still ugly.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|convert_db_kind_to_node_kind
parameter_list|(
name|svn_node_kind_t
modifier|*
name|node_kind
parameter_list|,
name|svn_node_kind_t
name|db_kind
parameter_list|,
name|svn_wc__db_status_t
name|db_status
parameter_list|,
name|svn_boolean_t
name|show_hidden
parameter_list|)
block|{
operator|*
name|node_kind
operator|=
name|db_kind
expr_stmt|;
comment|/* Make sure hidden nodes return svn_node_none. */
if|if
condition|(
operator|!
name|show_hidden
condition|)
switch|switch
condition|(
name|db_status
condition|)
block|{
case|case
name|svn_wc__db_status_not_present
case|:
case|case
name|svn_wc__db_status_server_excluded
case|:
case|case
name|svn_wc__db_status_excluded
case|:
operator|*
name|node_kind
operator|=
name|svn_node_none
expr_stmt|;
default|default:
break|break;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc_read_kind2
parameter_list|(
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|show_deleted
parameter_list|,
name|svn_boolean_t
name|show_hidden
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_node_kind_t
name|db_kind
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_kind
argument_list|(
operator|&
name|db_kind
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|TRUE
argument_list|,
name|show_deleted
argument_list|,
name|show_hidden
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|db_kind
operator|==
name|svn_node_dir
condition|)
operator|*
name|kind
operator|=
name|svn_node_dir
expr_stmt|;
elseif|else
if|if
condition|(
name|db_kind
operator|==
name|svn_node_file
operator|||
name|db_kind
operator|==
name|svn_node_symlink
condition|)
operator|*
name|kind
operator|=
name|svn_node_file
expr_stmt|;
else|else
operator|*
name|kind
operator|=
name|svn_node_none
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_depth
parameter_list|(
name|svn_depth_t
modifier|*
name|depth
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_wc__db_read_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|depth
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_changed_info
parameter_list|(
name|svn_revnum_t
modifier|*
name|changed_rev
parameter_list|,
name|apr_time_t
modifier|*
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changed_author
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_wc__db_read_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|changed_rev
argument_list|,
name|changed_date
argument_list|,
name|changed_author
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_url
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|url
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_wc__db_read_url
argument_list|(
name|url
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* A recursive node-walker, helper for svn_wc__internal_walk_children().  *  * Call WALK_CALLBACK with WALK_BATON on all children (recursively) of  * DIR_ABSPATH in DB, but not on DIR_ABSPATH itself. DIR_ABSPATH must be a  * versioned directory. If SHOW_HIDDEN is true, visit hidden nodes, else  * ignore them. Restrict the depth of the walk to DEPTH.  *  * ### Is it possible for a subdirectory to be hidden and known to be a  *     directory?  If so, and if show_hidden is true, this will try to  *     recurse into it.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|walker_helper
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_abspath
parameter_list|,
name|svn_boolean_t
name|show_hidden
parameter_list|,
specifier|const
name|apr_hash_t
modifier|*
name|changelist_filter
parameter_list|,
name|svn_wc__node_found_func_t
name|walk_callback
parameter_list|,
name|void
modifier|*
name|walk_baton
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|rel_children_info
decl_stmt|;
name|apr_hash_index_t
modifier|*
name|hi
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
if|if
condition|(
name|depth
operator|==
name|svn_depth_empty
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_children_walker_info
argument_list|(
operator|&
name|rel_children_info
argument_list|,
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
for|for
control|(
name|hi
operator|=
name|apr_hash_first
argument_list|(
name|scratch_pool
argument_list|,
name|rel_children_info
argument_list|)
init|;
name|hi
condition|;
name|hi
operator|=
name|apr_hash_next
argument_list|(
name|hi
argument_list|)
control|)
block|{
specifier|const
name|char
modifier|*
name|child_name
init|=
name|svn__apr_hash_index_key
argument_list|(
name|hi
argument_list|)
decl_stmt|;
name|struct
name|svn_wc__db_walker_info_t
modifier|*
name|wi
init|=
name|svn__apr_hash_index_val
argument_list|(
name|hi
argument_list|)
decl_stmt|;
name|svn_node_kind_t
name|child_kind
init|=
name|wi
operator|->
name|kind
decl_stmt|;
name|svn_wc__db_status_t
name|child_status
init|=
name|wi
operator|->
name|status
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_abspath
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
comment|/* See if someone wants to cancel this operation. */
if|if
condition|(
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
argument_list|)
expr_stmt|;
name|child_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|dir_abspath
argument_list|,
name|child_name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|show_hidden
condition|)
switch|switch
condition|(
name|child_status
condition|)
block|{
case|case
name|svn_wc__db_status_not_present
case|:
case|case
name|svn_wc__db_status_server_excluded
case|:
case|case
name|svn_wc__db_status_excluded
case|:
continue|continue;
default|default:
break|break;
block|}
comment|/* Return the child, if appropriate. */
if|if
condition|(
operator|(
name|child_kind
operator|==
name|svn_node_file
operator|||
name|depth
operator|>=
name|svn_depth_immediates
operator|)
operator|&&
name|svn_wc__internal_changelist_match
argument_list|(
name|db
argument_list|,
name|child_abspath
argument_list|,
name|changelist_filter
argument_list|,
name|scratch_pool
argument_list|)
condition|)
block|{
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR
argument_list|(
name|convert_db_kind_to_node_kind
argument_list|(
operator|&
name|kind
argument_list|,
name|child_kind
argument_list|,
name|child_status
argument_list|,
name|show_hidden
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### We might want to pass child_status as well because at least            * ### one callee is asking for it.            * ### But is it OK to use an svn_wc__db type in this API?            * ###    Not yet, we need to get the node walker            * ###    libsvn_wc-internal first. -hkw */
name|SVN_ERR
argument_list|(
name|walk_callback
argument_list|(
name|child_abspath
argument_list|,
name|kind
argument_list|,
name|walk_baton
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Recurse into this directory, if appropriate. */
if|if
condition|(
name|child_kind
operator|==
name|svn_node_dir
operator|&&
name|depth
operator|>=
name|svn_depth_immediates
condition|)
block|{
name|svn_depth_t
name|depth_below_here
init|=
name|depth
decl_stmt|;
if|if
condition|(
name|depth
operator|==
name|svn_depth_immediates
condition|)
name|depth_below_here
operator|=
name|svn_depth_empty
expr_stmt|;
name|SVN_ERR
argument_list|(
name|walker_helper
argument_list|(
name|db
argument_list|,
name|child_abspath
argument_list|,
name|show_hidden
argument_list|,
name|changelist_filter
argument_list|,
name|walk_callback
argument_list|,
name|walk_baton
argument_list|,
name|depth_below_here
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__internal_walk_children
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|show_hidden
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelist_filter
parameter_list|,
name|svn_wc__node_found_func_t
name|walk_callback
parameter_list|,
name|void
modifier|*
name|walk_baton
parameter_list|,
name|svn_depth_t
name|walk_depth
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_node_kind_t
name|db_kind
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|apr_hash_t
modifier|*
name|changelist_hash
init|=
name|NULL
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|walk_depth
operator|>=
name|svn_depth_empty
operator|&&
name|walk_depth
operator|<=
name|svn_depth_infinity
argument_list|)
expr_stmt|;
if|if
condition|(
name|changelist_filter
operator|&&
name|changelist_filter
operator|->
name|nelts
condition|)
name|SVN_ERR
argument_list|(
name|svn_hash_from_cstring_keys
argument_list|(
operator|&
name|changelist_hash
argument_list|,
name|changelist_filter
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check if the node exists before the first callback */
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|db_kind
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|convert_db_kind_to_node_kind
argument_list|(
operator|&
name|kind
argument_list|,
name|db_kind
argument_list|,
name|status
argument_list|,
name|show_hidden
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|svn_wc__internal_changelist_match
argument_list|(
name|db
argument_list|,
name|local_abspath
argument_list|,
name|changelist_hash
argument_list|,
name|scratch_pool
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|walk_callback
argument_list|(
name|local_abspath
argument_list|,
name|kind
argument_list|,
name|walk_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|db_kind
operator|==
name|svn_node_file
operator|||
name|status
operator|==
name|svn_wc__db_status_not_present
operator|||
name|status
operator|==
name|svn_wc__db_status_excluded
operator|||
name|status
operator|==
name|svn_wc__db_status_server_excluded
condition|)
return|return
name|SVN_NO_ERROR
return|;
if|if
condition|(
name|db_kind
operator|==
name|svn_node_dir
condition|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|walker_helper
argument_list|(
name|db
argument_list|,
name|local_abspath
argument_list|,
name|show_hidden
argument_list|,
name|changelist_hash
argument_list|,
name|walk_callback
argument_list|,
name|walk_baton
argument_list|,
name|walk_depth
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_NODE_UNKNOWN_KIND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' has an unrecognized node kind"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_is_status_deleted
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_deleted
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|is_deleted
operator|=
operator|(
name|status
operator|==
name|svn_wc__db_status_deleted
operator|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_deleted_ancestor
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|deleted_ancestor_abspath
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
operator|*
name|deleted_ancestor_abspath
operator|=
name|NULL
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_deleted
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_scan_deletion
argument_list|(
name|deleted_ancestor_abspath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_is_not_present
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_not_present
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_excluded
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_server_excluded
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|base_only
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
if|if
condition|(
name|base_only
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|is_not_present
condition|)
operator|*
name|is_not_present
operator|=
operator|(
name|status
operator|==
name|svn_wc__db_status_not_present
operator|)
expr_stmt|;
if|if
condition|(
name|is_excluded
condition|)
operator|*
name|is_excluded
operator|=
operator|(
name|status
operator|==
name|svn_wc__db_status_excluded
operator|)
expr_stmt|;
if|if
condition|(
name|is_server_excluded
condition|)
operator|*
name|is_server_excluded
operator|=
operator|(
name|status
operator|==
name|svn_wc__db_status_server_excluded
operator|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_is_added
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_added
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|is_added
operator|=
operator|(
name|status
operator|==
name|svn_wc__db_status_added
operator|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_has_working
parameter_list|(
name|svn_boolean_t
modifier|*
name|has_working
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|has_working
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_base
parameter_list|(
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_uuid
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|lock_token
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|ignore_enoent
parameter_list|,
name|svn_boolean_t
name|show_hidden
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_wc__db_lock_t
modifier|*
name|lock
decl_stmt|;
name|svn_node_kind_t
name|db_kind
decl_stmt|;
name|err
operator|=
name|svn_wc__db_base_get_info
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|db_kind
argument_list|,
name|revision
argument_list|,
name|repos_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|lock_token
condition|?
operator|&
name|lock
else|:
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|!=
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
elseif|else
if|if
condition|(
name|err
operator|||
operator|(
operator|!
name|err
operator|&&
operator|!
name|show_hidden
operator|&&
operator|(
name|status
operator|!=
name|svn_wc__db_status_normal
operator|&&
name|status
operator|!=
name|svn_wc__db_status_incomplete
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|ignore_enoent
condition|)
block|{
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
else|else
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' was not found."
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
condition|)
operator|*
name|kind
operator|=
name|svn_node_unknown
expr_stmt|;
if|if
condition|(
name|revision
condition|)
operator|*
name|revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
if|if
condition|(
name|repos_relpath
condition|)
operator|*
name|repos_relpath
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|repos_root_url
condition|)
operator|*
name|repos_root_url
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|repos_uuid
condition|)
operator|*
name|repos_uuid
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|lock_token
condition|)
operator|*
name|lock_token
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
if|if
condition|(
name|kind
condition|)
operator|*
name|kind
operator|=
name|db_kind
expr_stmt|;
if|if
condition|(
name|lock_token
condition|)
operator|*
name|lock_token
operator|=
name|lock
condition|?
name|lock
operator|->
name|token
else|:
name|NULL
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|revision
operator|||
name|SVN_IS_VALID_REVNUM
argument_list|(
operator|*
name|revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|repos_relpath
operator|||
operator|*
name|repos_relpath
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|repos_root_url
operator|||
operator|*
name|repos_root_url
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|repos_uuid
operator|||
operator|*
name|repos_uuid
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_pre_ng_status_data
parameter_list|(
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
name|svn_revnum_t
modifier|*
name|changed_rev
parameter_list|,
name|apr_time_t
modifier|*
name|changed_date
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|changed_author
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_boolean_t
name|have_base
decl_stmt|,
name|have_more_work
decl_stmt|,
name|have_work
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|revision
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|changed_rev
argument_list|,
name|changed_date
argument_list|,
name|changed_author
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|have_base
argument_list|,
operator|&
name|have_more_work
argument_list|,
operator|&
name|have_work
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_work
operator|||
operator|(
operator|(
operator|!
name|changed_rev
operator|||
name|SVN_IS_VALID_REVNUM
argument_list|(
operator|*
name|changed_rev
argument_list|)
operator|)
operator|&&
operator|(
operator|!
name|revision
operator|||
name|SVN_IS_VALID_REVNUM
argument_list|(
operator|*
name|revision
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|status
operator|!=
name|svn_wc__db_status_added
operator|)
operator|&&
operator|(
name|status
operator|!=
name|svn_wc__db_status_deleted
operator|)
operator|)
condition|)
block|{
return|return
name|SVN_NO_ERROR
return|;
comment|/* We got everything we need */
block|}
if|if
condition|(
name|have_base
operator|&&
operator|!
name|have_more_work
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|revision
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|changed_rev
argument_list|,
name|changed_date
argument_list|,
name|changed_author
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_deleted
condition|)
comment|/* Check the information below a WORKING delete */
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_pristine_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|changed_rev
argument_list|,
name|changed_date
argument_list|,
name|changed_author
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__internal_node_get_schedule
parameter_list|(
name|svn_wc_schedule_t
modifier|*
name|schedule
parameter_list|,
name|svn_boolean_t
modifier|*
name|copied
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_boolean_t
name|op_root
decl_stmt|;
name|svn_boolean_t
name|have_base
decl_stmt|;
name|svn_boolean_t
name|have_work
decl_stmt|;
name|svn_boolean_t
name|have_more_work
decl_stmt|;
specifier|const
name|char
modifier|*
name|copyfrom_relpath
decl_stmt|;
if|if
condition|(
name|schedule
condition|)
operator|*
name|schedule
operator|=
name|svn_wc_schedule_normal
expr_stmt|;
if|if
condition|(
name|copied
condition|)
operator|*
name|copied
operator|=
name|FALSE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|copyfrom_relpath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|op_root
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|have_base
argument_list|,
operator|&
name|have_more_work
argument_list|,
operator|&
name|have_work
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|svn_wc__db_status_not_present
case|:
case|case
name|svn_wc__db_status_server_excluded
case|:
case|case
name|svn_wc__db_status_excluded
case|:
comment|/* We used status normal in the entries world. */
if|if
condition|(
name|schedule
condition|)
operator|*
name|schedule
operator|=
name|svn_wc_schedule_normal
expr_stmt|;
break|break;
case|case
name|svn_wc__db_status_normal
case|:
case|case
name|svn_wc__db_status_incomplete
case|:
break|break;
case|case
name|svn_wc__db_status_deleted
case|:
block|{
if|if
condition|(
name|schedule
condition|)
operator|*
name|schedule
operator|=
name|svn_wc_schedule_delete
expr_stmt|;
if|if
condition|(
operator|!
name|copied
condition|)
break|break;
if|if
condition|(
name|have_more_work
operator|||
operator|!
name|have_base
condition|)
operator|*
name|copied
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
specifier|const
name|char
modifier|*
name|work_del_abspath
decl_stmt|;
comment|/* Find out details of our deletion.  */
name|SVN_ERR
argument_list|(
name|svn_wc__db_scan_deletion
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|work_del_abspath
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|work_del_abspath
condition|)
operator|*
name|copied
operator|=
name|TRUE
expr_stmt|;
comment|/* Working deletion */
block|}
break|break;
block|}
case|case
name|svn_wc__db_status_added
case|:
block|{
if|if
condition|(
operator|!
name|op_root
condition|)
block|{
if|if
condition|(
name|copied
condition|)
operator|*
name|copied
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|schedule
condition|)
operator|*
name|schedule
operator|=
name|svn_wc_schedule_normal
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|copied
condition|)
operator|*
name|copied
operator|=
operator|(
name|copyfrom_relpath
operator|!=
name|NULL
operator|)
expr_stmt|;
if|if
condition|(
name|schedule
condition|)
operator|*
name|schedule
operator|=
name|svn_wc_schedule_add
expr_stmt|;
else|else
break|break;
comment|/* Check for replaced */
if|if
condition|(
name|have_base
operator|||
name|have_more_work
condition|)
block|{
name|svn_wc__db_status_t
name|below_working
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_info_below_working
argument_list|(
operator|&
name|have_base
argument_list|,
operator|&
name|have_work
argument_list|,
operator|&
name|below_working
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If the node is not present or deleted (read: not present                  in working), then the node is not a replacement */
if|if
condition|(
name|below_working
operator|!=
name|svn_wc__db_status_not_present
operator|&&
name|below_working
operator|!=
name|svn_wc__db_status_deleted
condition|)
block|{
operator|*
name|schedule
operator|=
name|svn_wc_schedule_replace
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
default|default:
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_schedule
parameter_list|(
name|svn_wc_schedule_t
modifier|*
name|schedule
parameter_list|,
name|svn_boolean_t
modifier|*
name|copied
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_wc__internal_node_get_schedule
argument_list|(
name|schedule
argument_list|,
name|copied
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_clear_dav_cache_recursive
parameter_list|(
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_wc__db_base_clear_dav_cache_recursive
argument_list|(
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_lock_tokens_recursive
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|lock_tokens
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_wc__db_base_get_lock_tokens_recursive
argument_list|(
name|lock_tokens
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__get_excluded_subtrees
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|server_excluded_subtrees
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_wc__db_get_excluded_subtrees
argument_list|(
name|server_excluded_subtrees
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__internal_get_origin
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_copy
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_uuid
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|copy_root_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|scan_deleted
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|original_repos_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|original_repos_root_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|original_repos_uuid
decl_stmt|;
name|svn_revnum_t
name|original_revision
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
specifier|const
name|char
modifier|*
name|tmp_repos_relpath
decl_stmt|;
if|if
condition|(
operator|!
name|repos_relpath
condition|)
name|repos_relpath
operator|=
operator|&
name|tmp_repos_relpath
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|revision
argument_list|,
name|repos_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|original_repos_relpath
argument_list|,
operator|&
name|original_repos_root_url
argument_list|,
operator|&
name|original_repos_uuid
argument_list|,
operator|&
name|original_revision
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|is_copy
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|repos_relpath
condition|)
block|{
return|return
name|SVN_NO_ERROR
return|;
comment|/* Returned BASE information */
block|}
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_deleted
operator|&&
operator|!
name|scan_deleted
condition|)
block|{
if|if
condition|(
name|is_copy
condition|)
operator|*
name|is_copy
operator|=
name|FALSE
expr_stmt|;
comment|/* Deletes are stored in working; default to FALSE */
return|return
name|SVN_NO_ERROR
return|;
comment|/* No info */
block|}
if|if
condition|(
name|original_repos_relpath
condition|)
block|{
operator|*
name|repos_relpath
operator|=
name|original_repos_relpath
expr_stmt|;
if|if
condition|(
name|revision
condition|)
operator|*
name|revision
operator|=
name|original_revision
expr_stmt|;
if|if
condition|(
name|repos_root_url
condition|)
operator|*
name|repos_root_url
operator|=
name|original_repos_root_url
expr_stmt|;
if|if
condition|(
name|repos_uuid
condition|)
operator|*
name|repos_uuid
operator|=
name|original_repos_uuid
expr_stmt|;
if|if
condition|(
name|copy_root_abspath
operator|==
name|NULL
condition|)
return|return
name|SVN_NO_ERROR
return|;
block|}
block|{
name|svn_boolean_t
name|scan_working
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_added
condition|)
name|scan_working
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_deleted
condition|)
block|{
name|svn_boolean_t
name|have_base
decl_stmt|;
comment|/* Is this a BASE or a WORKING delete? */
name|SVN_ERR
argument_list|(
name|svn_wc__db_info_below_working
argument_list|(
operator|&
name|have_base
argument_list|,
operator|&
name|scan_working
argument_list|,
operator|&
name|status
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|scan_working
condition|)
block|{
specifier|const
name|char
modifier|*
name|op_root_abspath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_scan_addition
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|op_root_abspath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|original_repos_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|revision
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_added
condition|)
block|{
if|if
condition|(
name|is_copy
condition|)
operator|*
name|is_copy
operator|=
name|FALSE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
comment|/* Local addition */
block|}
comment|/* We don't know how the following error condition can be fulfilled          * but we have seen that happening in the wild.  Better to create          * an error than a SEGFAULT. */
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_incomplete
operator|&&
operator|!
name|original_repos_relpath
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Incomplete copy information on path '%s'."
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
operator|*
name|repos_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|original_repos_relpath
argument_list|,
name|svn_dirent_skip_ancestor
argument_list|(
name|op_root_abspath
argument_list|,
name|local_abspath
argument_list|)
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|copy_root_abspath
condition|)
operator|*
name|copy_root_abspath
operator|=
name|op_root_abspath
expr_stmt|;
block|}
else|else
comment|/* Deleted, excluded, not-present, server-excluded, ... */
block|{
if|if
condition|(
name|is_copy
condition|)
operator|*
name|is_copy
operator|=
name|FALSE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|revision
argument_list|,
name|repos_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_origin
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_copy
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_root_url
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|repos_uuid
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|copy_root_abspath
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|scan_deleted
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_wc__internal_get_origin
argument_list|(
name|is_copy
argument_list|,
name|revision
argument_list|,
name|repos_relpath
argument_list|,
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|copy_root_abspath
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scan_deleted
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_commit_status
parameter_list|(
name|svn_boolean_t
modifier|*
name|added
parameter_list|,
name|svn_boolean_t
modifier|*
name|deleted
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_replace_root
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_op_root
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
name|svn_revnum_t
modifier|*
name|original_revision
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|original_repos_relpath
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_boolean_t
name|have_base
decl_stmt|;
name|svn_boolean_t
name|have_more_work
decl_stmt|;
name|svn_boolean_t
name|op_root
decl_stmt|;
comment|/* ### All of this should be handled inside a single read transaction */
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
name|revision
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|original_repos_relpath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|original_revision
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|op_root
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|have_base
argument_list|,
operator|&
name|have_more_work
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|added
condition|)
operator|*
name|added
operator|=
operator|(
name|status
operator|==
name|svn_wc__db_status_added
operator|)
expr_stmt|;
if|if
condition|(
name|deleted
condition|)
operator|*
name|deleted
operator|=
operator|(
name|status
operator|==
name|svn_wc__db_status_deleted
operator|)
expr_stmt|;
if|if
condition|(
name|is_op_root
condition|)
operator|*
name|is_op_root
operator|=
name|op_root
expr_stmt|;
if|if
condition|(
name|is_replace_root
condition|)
block|{
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_added
operator|&&
name|op_root
operator|&&
operator|(
name|have_base
operator|||
name|have_more_work
operator|)
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_node_check_replace
argument_list|(
name|is_replace_root
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|*
name|is_replace_root
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/* Retrieve some information from BASE which is needed for replacing      and/or deleting BASE nodes. */
if|if
condition|(
name|have_base
operator|&&
operator|!
name|have_more_work
operator|&&
name|op_root
operator|&&
operator|(
name|revision
operator|&&
operator|!
name|SVN_IS_VALID_REVNUM
argument_list|(
operator|*
name|revision
argument_list|)
operator|)
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|revision
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_get_md5_from_sha1
parameter_list|(
specifier|const
name|svn_checksum_t
modifier|*
modifier|*
name|md5_checksum
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|sha1_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_wc__db_pristine_get_md5
argument_list|(
name|md5_checksum
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|wri_abspath
argument_list|,
name|sha1_checksum
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__get_not_present_descendants
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|descendants
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_wc__db_get_not_present_descendants
argument_list|(
name|descendants
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__rename_wc
parameter_list|(
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|from_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|wcroot_abspath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_get_wcroot
argument_list|(
operator|&
name|wcroot_abspath
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|from_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|from_abspath
argument_list|,
name|wcroot_abspath
argument_list|)
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_drop_root
argument_list|(
name|wc_ctx
operator|->
name|db
argument_list|,
name|wcroot_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_rename
argument_list|(
name|from_abspath
argument_list|,
name|dst_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is not the root of the working copy '%s'"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|from_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|wcroot_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__check_for_obstructions
parameter_list|(
name|svn_wc_notify_state_t
modifier|*
name|obstruction_state
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
name|svn_boolean_t
modifier|*
name|deleted
parameter_list|,
name|svn_boolean_t
modifier|*
name|excluded
parameter_list|,
name|svn_depth_t
modifier|*
name|parent_depth
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|no_wcroot_check
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_node_kind_t
name|db_kind
decl_stmt|;
name|svn_node_kind_t
name|disk_kind
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
operator|*
name|obstruction_state
operator|=
name|svn_wc_notify_state_inapplicable
expr_stmt|;
if|if
condition|(
name|kind
condition|)
operator|*
name|kind
operator|=
name|svn_node_none
expr_stmt|;
if|if
condition|(
name|deleted
condition|)
operator|*
name|deleted
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|excluded
condition|)
operator|*
name|excluded
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|parent_depth
condition|)
operator|*
name|parent_depth
operator|=
name|svn_depth_unknown
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_check_path
argument_list|(
name|local_abspath
argument_list|,
operator|&
name|disk_kind
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|db_kind
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk_kind
operator|!=
name|svn_node_none
condition|)
block|{
comment|/* Nothing in the DB, but something on disk */
operator|*
name|obstruction_state
operator|=
name|svn_wc_notify_state_obstructed
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|err
operator|=
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|db_kind
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|parent_depth
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|svn_dirent_dirname
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
comment|/* No versioned parent; we can't add a node here */
operator|*
name|obstruction_state
operator|=
name|svn_wc_notify_state_obstructed
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|db_kind
operator|!=
name|svn_node_dir
operator|||
operator|(
name|status
operator|!=
name|svn_wc__db_status_normal
operator|&&
name|status
operator|!=
name|svn_wc__db_status_added
operator|)
condition|)
block|{
comment|/* The parent doesn't allow nodes to be added below it */
operator|*
name|obstruction_state
operator|=
name|svn_wc_notify_state_obstructed
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
comment|/* Check for obstructing working copies */
if|if
condition|(
operator|!
name|no_wcroot_check
operator|&&
name|db_kind
operator|==
name|svn_node_dir
operator|&&
name|status
operator|==
name|svn_wc__db_status_normal
condition|)
block|{
name|svn_boolean_t
name|is_root
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_is_wcroot
argument_list|(
operator|&
name|is_root
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_root
condition|)
block|{
comment|/* Callers should handle this as unversioned */
operator|*
name|obstruction_state
operator|=
name|svn_wc_notify_state_obstructed
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
if|if
condition|(
name|kind
condition|)
name|SVN_ERR
argument_list|(
name|convert_db_kind_to_node_kind
argument_list|(
name|kind
argument_list|,
name|db_kind
argument_list|,
name|status
argument_list|,
name|FALSE
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|svn_wc__db_status_deleted
case|:
if|if
condition|(
name|deleted
condition|)
operator|*
name|deleted
operator|=
name|TRUE
expr_stmt|;
comment|/* Fall through to svn_wc__db_status_not_present */
case|case
name|svn_wc__db_status_not_present
case|:
if|if
condition|(
name|disk_kind
operator|!=
name|svn_node_none
condition|)
operator|*
name|obstruction_state
operator|=
name|svn_wc_notify_state_obstructed
expr_stmt|;
break|break;
case|case
name|svn_wc__db_status_excluded
case|:
case|case
name|svn_wc__db_status_server_excluded
case|:
if|if
condition|(
name|excluded
condition|)
operator|*
name|excluded
operator|=
name|TRUE
expr_stmt|;
comment|/* fall through */
case|case
name|svn_wc__db_status_incomplete
case|:
operator|*
name|obstruction_state
operator|=
name|svn_wc_notify_state_missing
expr_stmt|;
break|break;
case|case
name|svn_wc__db_status_added
case|:
case|case
name|svn_wc__db_status_normal
case|:
if|if
condition|(
name|disk_kind
operator|==
name|svn_node_none
condition|)
operator|*
name|obstruction_state
operator|=
name|svn_wc_notify_state_missing
expr_stmt|;
else|else
block|{
name|svn_node_kind_t
name|expected_kind
decl_stmt|;
name|SVN_ERR
argument_list|(
name|convert_db_kind_to_node_kind
argument_list|(
operator|&
name|expected_kind
argument_list|,
name|db_kind
argument_list|,
name|status
argument_list|,
name|FALSE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk_kind
operator|!=
name|expected_kind
condition|)
operator|*
name|obstruction_state
operator|=
name|svn_wc_notify_state_obstructed
expr_stmt|;
block|}
break|break;
default|default:
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_was_moved_away
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|moved_to_abspath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|op_root_abspath
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_boolean_t
name|is_deleted
decl_stmt|;
if|if
condition|(
name|moved_to_abspath
condition|)
operator|*
name|moved_to_abspath
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|op_root_abspath
condition|)
operator|*
name|op_root_abspath
operator|=
name|NULL
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__node_is_status_deleted
argument_list|(
operator|&
name|is_deleted
argument_list|,
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_deleted
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_scan_deletion
argument_list|(
name|NULL
argument_list|,
name|moved_to_abspath
argument_list|,
name|NULL
argument_list|,
name|op_root_abspath
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__node_was_moved_here
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|moved_from_abspath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|delete_op_root_abspath
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
if|if
condition|(
name|moved_from_abspath
condition|)
operator|*
name|moved_from_abspath
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|delete_op_root_abspath
condition|)
operator|*
name|delete_op_root_abspath
operator|=
name|NULL
expr_stmt|;
name|err
operator|=
name|svn_wc__db_scan_moved
argument_list|(
name|moved_from_abspath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|delete_op_root_abspath
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
comment|/* Return error for not added nodes */
if|if
condition|(
name|err
operator|->
name|apr_err
operator|!=
name|SVN_ERR_WC_PATH_UNEXPECTED_STATUS
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
comment|/* Path not moved here */
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


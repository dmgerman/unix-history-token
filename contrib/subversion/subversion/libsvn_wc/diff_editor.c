begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * diff_editor.c -- The diff editor for comparing the working copy against the  *                  repository.  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_comment
comment|/*  * This code uses an svn_delta_editor_t editor driven by  * svn_wc_crawl_revisions (like the update command) to retrieve the  * differences between the working copy and the requested repository  * version. Rather than updating the working copy, this new editor creates  * temporary files that contain the pristine repository versions. When the  * crawler closes the files the editor calls back to a client layer  * function to compare the working copy and the temporary file. There is  * only ever one temporary file in existence at any time.  *  * When the crawler closes a directory, the editor then calls back to the  * client layer to compare any remaining files that may have been modified  * locally. Added directories do not have corresponding temporary  * directories created, as they are not needed.  *  * The diff result from this editor is a combination of the restructuring  * operations from the repository with the local restructurings since checking  * out.  *  * ### TODO: Make sure that we properly support and report multi layered  *           operations instead of only simple file replacements.  *  * ### TODO: Replacements where the node kind changes needs support. It  * mostly works when the change is in the repository, but not when it is  * in the working copy.  *  * ### TODO: Do we need to support copyfrom?  *  */
end_comment

begin_include
include|#
directive|include
file|<apr_hash.h>
end_include

begin_include
include|#
directive|include
file|<apr_md5.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_sorts.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_subr_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_wc_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_diff_tree.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_editor.h"
end_include

begin_include
include|#
directive|include
file|"wc.h"
end_include

begin_include
include|#
directive|include
file|"props.h"
end_include

begin_include
include|#
directive|include
file|"adm_files.h"
end_include

begin_include
include|#
directive|include
file|"translate.h"
end_include

begin_include
include|#
directive|include
file|"diff.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_comment
comment|/*-------------------------------------------------------------------------*/
end_comment

begin_escape
end_escape

begin_comment
comment|/* Overall crawler editor baton.  */
end_comment

begin_struct
struct|struct
name|edit_baton_t
block|{
comment|/* A wc db. */
name|svn_wc__db_t
modifier|*
name|db
decl_stmt|;
comment|/* A diff tree processor, receiving the result of the diff. */
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
decl_stmt|;
comment|/* A boolean indicating whether local additions should be reported before      remote deletes. The processor can transform adds in deletes and deletes      in adds, but it can't reorder the output. */
name|svn_boolean_t
name|local_before_remote
decl_stmt|;
comment|/* ANCHOR/TARGET represent the base of the hierarchy to be compared. */
specifier|const
name|char
modifier|*
name|target
decl_stmt|;
specifier|const
name|char
modifier|*
name|anchor_abspath
decl_stmt|;
comment|/* Target revision */
name|svn_revnum_t
name|revnum
decl_stmt|;
comment|/* Was the root opened? */
name|svn_boolean_t
name|root_opened
decl_stmt|;
comment|/* How does this diff descend as seen from target? */
name|svn_depth_t
name|depth
decl_stmt|;
comment|/* Should this diff ignore node ancestry? */
name|svn_boolean_t
name|ignore_ancestry
decl_stmt|;
comment|/* Possibly diff repos against text-bases instead of working files. */
name|svn_boolean_t
name|diff_pristine
decl_stmt|;
comment|/* Hash whose keys are const char * changelist names. */
name|apr_hash_t
modifier|*
name|changelist_hash
decl_stmt|;
comment|/* Cancel function/baton */
name|svn_cancel_func_t
name|cancel_func
decl_stmt|;
name|void
modifier|*
name|cancel_baton
decl_stmt|;
name|apr_pool_t
modifier|*
name|pool
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Directory level baton.  */
end_comment

begin_struct
struct|struct
name|dir_baton_t
block|{
comment|/* Reference to parent directory baton (or NULL for the root) */
name|struct
name|dir_baton_t
modifier|*
name|parent_baton
decl_stmt|;
comment|/* The depth at which this directory should be diffed. */
name|svn_depth_t
name|depth
decl_stmt|;
comment|/* The name and path of this directory as if they would be/are in the       local working copy. */
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_abspath
decl_stmt|;
comment|/* TRUE if the file is added by the editor drive. */
name|svn_boolean_t
name|added
decl_stmt|;
comment|/* TRUE if the node exists only on the repository side (op_depth 0 or added) */
name|svn_boolean_t
name|repos_only
decl_stmt|;
comment|/* TRUE if the node is to be compared with an unrelated node*/
name|svn_boolean_t
name|ignoring_ancestry
decl_stmt|;
comment|/* Processor state */
name|void
modifier|*
name|pdb
decl_stmt|;
name|svn_boolean_t
name|skip
decl_stmt|;
name|svn_boolean_t
name|skip_children
decl_stmt|;
name|svn_diff_source_t
modifier|*
name|left_src
decl_stmt|;
name|svn_diff_source_t
modifier|*
name|right_src
decl_stmt|;
name|apr_hash_t
modifier|*
name|local_info
decl_stmt|;
comment|/* A hash containing the basenames of the nodes reported deleted by the      repository (or NULL for no values). */
name|apr_hash_t
modifier|*
name|deletes
decl_stmt|;
comment|/* Identifies those directory elements that get compared while running      the crawler.  These elements should not be compared again when      recursively looking for local modifications.       This hash maps the basename of the node to an unimportant value.       If the directory's properties have been compared, an item with hash      key of "" will be present in the hash. */
name|apr_hash_t
modifier|*
name|compared
decl_stmt|;
comment|/* The list of incoming BASE->repos propchanges. */
name|apr_array_header_t
modifier|*
name|propchanges
decl_stmt|;
comment|/* Has a change on regular properties */
name|svn_boolean_t
name|has_propchange
decl_stmt|;
comment|/* The overall crawler editor baton. */
name|struct
name|edit_baton_t
modifier|*
name|eb
decl_stmt|;
name|apr_pool_t
modifier|*
name|pool
decl_stmt|;
name|int
name|users
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* File level baton.  */
end_comment

begin_struct
struct|struct
name|file_baton_t
block|{
name|struct
name|dir_baton_t
modifier|*
name|parent_baton
decl_stmt|;
comment|/* The name and path of this file as if they would be/are in the      parent directory, diff session and local working copy. */
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_abspath
decl_stmt|;
comment|/* Processor state */
name|void
modifier|*
name|pfb
decl_stmt|;
name|svn_boolean_t
name|skip
decl_stmt|;
comment|/* TRUE if the file is added by the editor drive. */
name|svn_boolean_t
name|added
decl_stmt|;
comment|/* TRUE if the node exists only on the repository side (op_depth 0 or added) */
name|svn_boolean_t
name|repos_only
decl_stmt|;
comment|/* TRUE if the node is to be compared with an unrelated node*/
name|svn_boolean_t
name|ignoring_ancestry
decl_stmt|;
specifier|const
name|svn_diff_source_t
modifier|*
name|left_src
decl_stmt|;
specifier|const
name|svn_diff_source_t
modifier|*
name|right_src
decl_stmt|;
comment|/* The list of incoming BASE->repos propchanges. */
name|apr_array_header_t
modifier|*
name|propchanges
decl_stmt|;
comment|/* Has a change on regular properties */
name|svn_boolean_t
name|has_propchange
decl_stmt|;
comment|/* The current BASE checksum and props */
specifier|const
name|svn_checksum_t
modifier|*
name|base_checksum
decl_stmt|;
name|apr_hash_t
modifier|*
name|base_props
decl_stmt|;
comment|/* The resulting from apply_textdelta */
specifier|const
name|char
modifier|*
name|temp_file_path
decl_stmt|;
name|unsigned
name|char
name|result_digest
index|[
name|APR_MD5_DIGESTSIZE
index|]
decl_stmt|;
comment|/* The overall crawler editor baton. */
name|struct
name|edit_baton_t
modifier|*
name|eb
decl_stmt|;
name|apr_pool_t
modifier|*
name|pool
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Create a new edit baton. TARGET_PATH/ANCHOR are working copy paths  * that describe the root of the comparison. CALLBACKS/CALLBACK_BATON  * define the callbacks to compare files. DEPTH defines if and how to  * descend into subdirectories; see public doc string for exactly how.  * IGNORE_ANCESTRY defines whether to utilize node ancestry when  * calculating diffs.  USE_TEXT_BASE defines whether to compare  * against working files or text-bases.  REVERSE_ORDER defines which  * direction to perform the diff.  *  * CHANGELIST_FILTER is a list of const char * changelist names, used to  * filter diff output responses to only those items in one of the  * specified changelists, empty (or NULL altogether) if no changelist  * filtering is requested.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|make_edit_baton
parameter_list|(
name|struct
name|edit_baton_t
modifier|*
modifier|*
name|edit_baton
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|anchor_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|,
specifier|const
name|svn_wc_diff_callbacks4_t
modifier|*
name|callbacks
parameter_list|,
name|void
modifier|*
name|callback_baton
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
name|svn_boolean_t
name|show_copies_as_adds
parameter_list|,
name|svn_boolean_t
name|use_text_base
parameter_list|,
name|svn_boolean_t
name|reverse_order
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelist_filter
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|changelist_hash
init|=
name|NULL
decl_stmt|;
name|struct
name|edit_baton_t
modifier|*
name|eb
decl_stmt|;
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|anchor_abspath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|changelist_filter
operator|&&
name|changelist_filter
operator|->
name|nelts
condition|)
name|SVN_ERR
argument_list|(
name|svn_hash_from_cstring_keys
argument_list|(
operator|&
name|changelist_hash
argument_list|,
name|changelist_filter
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__wrap_diff_callbacks
argument_list|(
operator|&
name|processor
argument_list|,
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
name|TRUE
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reverse_order
condition|)
name|processor
operator|=
name|svn_diff__tree_processor_reverse_create
argument_list|(
name|processor
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
expr_stmt|;
comment|/* --show-copies-as-adds implies --notice-ancestry */
if|if
condition|(
name|show_copies_as_adds
condition|)
name|ignore_ancestry
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|!
name|show_copies_as_adds
condition|)
name|processor
operator|=
name|svn_diff__tree_processor_copy_as_changed_create
argument_list|(
name|processor
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|eb
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|eb
argument_list|)
argument_list|)
expr_stmt|;
name|eb
operator|->
name|db
operator|=
name|db
expr_stmt|;
name|eb
operator|->
name|anchor_abspath
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|anchor_abspath
argument_list|)
expr_stmt|;
name|eb
operator|->
name|target
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|target
argument_list|)
expr_stmt|;
name|eb
operator|->
name|processor
operator|=
name|processor
expr_stmt|;
name|eb
operator|->
name|depth
operator|=
name|depth
expr_stmt|;
name|eb
operator|->
name|ignore_ancestry
operator|=
name|ignore_ancestry
expr_stmt|;
name|eb
operator|->
name|local_before_remote
operator|=
name|reverse_order
expr_stmt|;
name|eb
operator|->
name|diff_pristine
operator|=
name|use_text_base
expr_stmt|;
name|eb
operator|->
name|changelist_hash
operator|=
name|changelist_hash
expr_stmt|;
name|eb
operator|->
name|cancel_func
operator|=
name|cancel_func
expr_stmt|;
name|eb
operator|->
name|cancel_baton
operator|=
name|cancel_baton
expr_stmt|;
name|eb
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
operator|*
name|edit_baton
operator|=
name|eb
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Create a new directory baton.  PATH is the directory path,  * including anchor_path.  ADDED is set if this directory is being  * added rather than replaced.  PARENT_BATON is the baton of the  * parent directory, it will be null if this is the root of the  * comparison hierarchy.  The directory and its parent may or may not  * exist in the working copy.  EDIT_BATON is the overall crawler  * editor baton.  */
end_comment

begin_function
specifier|static
name|struct
name|dir_baton_t
modifier|*
name|make_dir_baton
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|struct
name|dir_baton_t
modifier|*
name|parent_baton
parameter_list|,
name|struct
name|edit_baton_t
modifier|*
name|eb
parameter_list|,
name|svn_boolean_t
name|added
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|dir_pool
init|=
name|svn_pool_create
argument_list|(
name|parent_baton
condition|?
name|parent_baton
operator|->
name|pool
else|:
name|eb
operator|->
name|pool
argument_list|)
decl_stmt|;
name|struct
name|dir_baton_t
modifier|*
name|db
init|=
name|apr_pcalloc
argument_list|(
name|dir_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|db
argument_list|)
argument_list|)
decl_stmt|;
name|db
operator|->
name|parent_baton
operator|=
name|parent_baton
expr_stmt|;
comment|/* Allocate 1 string for using as 3 strings */
name|db
operator|->
name|local_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|eb
operator|->
name|anchor_abspath
argument_list|,
name|path
argument_list|,
name|dir_pool
argument_list|)
expr_stmt|;
name|db
operator|->
name|relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|eb
operator|->
name|anchor_abspath
argument_list|,
name|db
operator|->
name|local_abspath
argument_list|)
expr_stmt|;
name|db
operator|->
name|name
operator|=
name|svn_dirent_basename
argument_list|(
name|db
operator|->
name|relpath
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|db
operator|->
name|eb
operator|=
name|eb
expr_stmt|;
name|db
operator|->
name|added
operator|=
name|added
expr_stmt|;
name|db
operator|->
name|depth
operator|=
name|depth
expr_stmt|;
name|db
operator|->
name|pool
operator|=
name|dir_pool
expr_stmt|;
name|db
operator|->
name|propchanges
operator|=
name|apr_array_make
argument_list|(
name|dir_pool
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_prop_t
argument_list|)
argument_list|)
expr_stmt|;
name|db
operator|->
name|compared
operator|=
name|apr_hash_make
argument_list|(
name|dir_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|parent_baton
operator|!=
name|NULL
condition|)
block|{
name|parent_baton
operator|->
name|users
operator|++
expr_stmt|;
block|}
name|db
operator|->
name|users
operator|=
literal|1
expr_stmt|;
return|return
name|db
return|;
block|}
end_function

begin_comment
comment|/* Create a new file baton.  PATH is the file path, including  * anchor_path.  ADDED is set if this file is being added rather than  * replaced.  PARENT_BATON is the baton of the parent directory.  * The directory and its parent may or may not exist in the working copy.  */
end_comment

begin_function
specifier|static
name|struct
name|file_baton_t
modifier|*
name|make_file_baton
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_boolean_t
name|added
parameter_list|,
name|struct
name|dir_baton_t
modifier|*
name|parent_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|file_pool
init|=
name|svn_pool_create
argument_list|(
name|result_pool
argument_list|)
decl_stmt|;
name|struct
name|file_baton_t
modifier|*
name|fb
init|=
name|apr_pcalloc
argument_list|(
name|file_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fb
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|edit_baton_t
modifier|*
name|eb
init|=
name|parent_baton
operator|->
name|eb
decl_stmt|;
name|fb
operator|->
name|eb
operator|=
name|eb
expr_stmt|;
name|fb
operator|->
name|parent_baton
operator|=
name|parent_baton
expr_stmt|;
name|fb
operator|->
name|parent_baton
operator|->
name|users
operator|++
expr_stmt|;
comment|/* Allocate 1 string for using as 3 strings */
name|fb
operator|->
name|local_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|eb
operator|->
name|anchor_abspath
argument_list|,
name|path
argument_list|,
name|file_pool
argument_list|)
expr_stmt|;
name|fb
operator|->
name|relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|eb
operator|->
name|anchor_abspath
argument_list|,
name|fb
operator|->
name|local_abspath
argument_list|)
expr_stmt|;
name|fb
operator|->
name|name
operator|=
name|svn_dirent_basename
argument_list|(
name|fb
operator|->
name|relpath
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fb
operator|->
name|added
operator|=
name|added
expr_stmt|;
name|fb
operator|->
name|pool
operator|=
name|file_pool
expr_stmt|;
name|fb
operator|->
name|propchanges
operator|=
name|apr_array_make
argument_list|(
name|file_pool
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_prop_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|fb
return|;
block|}
end_function

begin_comment
comment|/* Destroy DB when there are no more registered users */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|maybe_done
parameter_list|(
name|struct
name|dir_baton_t
modifier|*
name|db
parameter_list|)
block|{
name|db
operator|->
name|users
operator|--
expr_stmt|;
if|if
condition|(
operator|!
name|db
operator|->
name|users
condition|)
block|{
name|struct
name|dir_baton_t
modifier|*
name|pb
init|=
name|db
operator|->
name|parent_baton
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|db
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|pb
operator|!=
name|NULL
condition|)
name|SVN_ERR
argument_list|(
name|maybe_done
argument_list|(
name|pb
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Standard check to see if a node is represented in the local working copy */
end_comment

begin_define
define|#
directive|define
name|NOT_PRESENT
parameter_list|(
name|status
parameter_list|)
define|\
value|((status) == svn_wc__db_status_not_present          \              || (status) == svn_wc__db_status_excluded          \              || (status) == svn_wc__db_status_server_excluded)
end_define

begin_function
name|svn_error_t
modifier|*
name|svn_wc__diff_base_working_diff
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|apr_hash_t
modifier|*
name|changelist_hash
parameter_list|,
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|void
modifier|*
name|processor_dir_baton
parameter_list|,
name|svn_boolean_t
name|diff_pristine
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|void
modifier|*
name|file_baton
init|=
name|NULL
decl_stmt|;
name|svn_boolean_t
name|skip
init|=
name|FALSE
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_revnum_t
name|db_revision
decl_stmt|;
name|svn_boolean_t
name|had_props
decl_stmt|;
name|svn_boolean_t
name|props_mod
decl_stmt|;
name|svn_boolean_t
name|files_same
init|=
name|FALSE
decl_stmt|;
name|svn_wc__db_status_t
name|base_status
decl_stmt|;
specifier|const
name|svn_checksum_t
modifier|*
name|working_checksum
decl_stmt|;
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
name|svn_filesize_t
name|recorded_size
decl_stmt|;
name|apr_time_t
name|recorded_time
decl_stmt|;
specifier|const
name|char
modifier|*
name|pristine_file
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_file
decl_stmt|;
name|svn_diff_source_t
modifier|*
name|left_src
decl_stmt|;
name|svn_diff_source_t
modifier|*
name|right_src
decl_stmt|;
name|apr_hash_t
modifier|*
name|base_props
decl_stmt|;
name|apr_hash_t
modifier|*
name|local_props
decl_stmt|;
name|apr_array_header_t
modifier|*
name|prop_changes
decl_stmt|;
specifier|const
name|char
modifier|*
name|changelist
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
name|NULL
argument_list|,
operator|&
name|db_revision
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|working_checksum
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|recorded_size
argument_list|,
operator|&
name|recorded_time
argument_list|,
operator|&
name|changelist
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|had_props
argument_list|,
operator|&
name|props_mod
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|checksum
operator|=
name|working_checksum
expr_stmt|;
name|assert
argument_list|(
name|status
operator|==
name|svn_wc__db_status_normal
operator|||
name|status
operator|==
name|svn_wc__db_status_added
operator|||
operator|(
name|status
operator|==
name|svn_wc__db_status_deleted
operator|&&
name|diff_pristine
operator|)
argument_list|)
expr_stmt|;
comment|/* If the item is not a member of a specified changelist (and there are      some specified changelists), skip it. */
if|if
condition|(
name|changelist_hash
operator|&&
operator|!
name|svn_hash_gets
argument_list|(
name|changelist_hash
argument_list|,
name|changelist
argument_list|)
condition|)
return|return
name|SVN_NO_ERROR
return|;
if|if
condition|(
name|status
operator|!=
name|svn_wc__db_status_normal
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info
argument_list|(
operator|&
name|base_status
argument_list|,
name|NULL
argument_list|,
operator|&
name|db_revision
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|checksum
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|had_props
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|recorded_size
operator|=
name|SVN_INVALID_FILESIZE
expr_stmt|;
name|recorded_time
operator|=
literal|0
expr_stmt|;
name|props_mod
operator|=
name|TRUE
expr_stmt|;
comment|/* Requires compare */
block|}
elseif|else
if|if
condition|(
name|diff_pristine
condition|)
name|files_same
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
specifier|const
name|svn_io_dirent2_t
modifier|*
name|dirent
decl_stmt|;
comment|/* Verify truename to mimic status for iota/IOTA difference on Windows */
name|SVN_ERR
argument_list|(
name|svn_io_stat_dirent2
argument_list|(
operator|&
name|dirent
argument_list|,
name|local_abspath
argument_list|,
name|TRUE
comment|/* verify truename */
argument_list|,
name|TRUE
comment|/* ingore_enoent */
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If a file does not exist on disk (missing/obstructed) then we          can't provide a text diff */
if|if
condition|(
name|dirent
operator|->
name|kind
operator|!=
name|svn_node_file
operator|||
operator|(
name|dirent
operator|->
name|kind
operator|==
name|svn_node_file
operator|&&
name|dirent
operator|->
name|filesize
operator|==
name|recorded_size
operator|&&
name|dirent
operator|->
name|mtime
operator|==
name|recorded_time
operator|)
condition|)
block|{
name|files_same
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|files_same
operator|&&
operator|!
name|props_mod
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Cheap exit */
name|assert
argument_list|(
name|checksum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SVN_IS_VALID_REVNUM
argument_list|(
name|revision
argument_list|)
condition|)
name|revision
operator|=
name|db_revision
expr_stmt|;
name|left_src
operator|=
name|svn_diff__source_create
argument_list|(
name|revision
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|right_src
operator|=
name|svn_diff__source_create
argument_list|(
name|SVN_INVALID_REVNUM
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|processor
operator|->
name|file_opened
argument_list|(
operator|&
name|file_baton
argument_list|,
operator|&
name|skip
argument_list|,
name|relpath
argument_list|,
name|left_src
argument_list|,
name|right_src
argument_list|,
name|NULL
comment|/* copyfrom_src */
argument_list|,
name|processor_dir_baton
argument_list|,
name|processor
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|skip
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_get_path
argument_list|(
operator|&
name|pristine_file
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_pristine
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_get_path
argument_list|(
operator|&
name|local_file
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|working_checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
operator|(
name|had_props
operator|||
name|props_mod
operator|)
condition|)
name|local_file
operator|=
name|local_abspath
expr_stmt|;
elseif|else
if|if
condition|(
name|files_same
condition|)
name|local_file
operator|=
name|pristine_file
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__internal_translated_file
argument_list|(
operator|&
name|local_file
argument_list|,
name|local_abspath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|SVN_WC_TRANSLATE_TO_NF
operator||
name|SVN_WC_TRANSLATE_USE_GLOBAL_TMP
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|files_same
condition|)
name|SVN_ERR
argument_list|(
name|svn_io_files_contents_same_p
argument_list|(
operator|&
name|files_same
argument_list|,
name|local_file
argument_list|,
name|pristine_file
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|had_props
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_props
argument_list|(
operator|&
name|base_props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|base_props
operator|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_normal
operator|&&
operator|(
name|diff_pristine
operator|||
operator|!
name|props_mod
operator|)
condition|)
name|local_props
operator|=
name|base_props
expr_stmt|;
elseif|else
if|if
condition|(
name|diff_pristine
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_pristine_props
argument_list|(
operator|&
name|local_props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_props
argument_list|(
operator|&
name|local_props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_prop_diffs
argument_list|(
operator|&
name|prop_changes
argument_list|,
name|local_props
argument_list|,
name|base_props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|prop_changes
operator|->
name|nelts
operator|||
operator|!
name|files_same
condition|)
block|{
name|SVN_ERR
argument_list|(
name|processor
operator|->
name|file_changed
argument_list|(
name|relpath
argument_list|,
name|left_src
argument_list|,
name|right_src
argument_list|,
name|pristine_file
argument_list|,
name|local_file
argument_list|,
name|base_props
argument_list|,
name|local_props
argument_list|,
operator|!
name|files_same
argument_list|,
name|prop_changes
argument_list|,
name|file_baton
argument_list|,
name|processor
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|processor
operator|->
name|file_closed
argument_list|(
name|relpath
argument_list|,
name|left_src
argument_list|,
name|right_src
argument_list|,
name|file_baton
argument_list|,
name|processor
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|ensure_local_info
parameter_list|(
name|struct
name|dir_baton_t
modifier|*
name|db
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|conflicts
decl_stmt|;
if|if
condition|(
name|db
operator|->
name|local_info
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_children_info
argument_list|(
operator|&
name|db
operator|->
name|local_info
argument_list|,
operator|&
name|conflicts
argument_list|,
name|db
operator|->
name|eb
operator|->
name|db
argument_list|,
name|db
operator|->
name|local_abspath
argument_list|,
name|db
operator|->
name|pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Called when the directory is closed to compare any elements that have  * not yet been compared.  This identifies local, working copy only  * changes.  At this stage we are dealing with files/directories that do  * exist in the working copy.  *  * DIR_BATON is the baton for the directory.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|walk_local_nodes_diff
parameter_list|(
name|struct
name|edit_baton_t
modifier|*
name|eb
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_hash_t
modifier|*
name|compared
parameter_list|,
name|void
modifier|*
name|parent_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_t
modifier|*
name|db
init|=
name|eb
operator|->
name|db
decl_stmt|;
name|svn_boolean_t
name|in_anchor_not_target
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|void
modifier|*
name|dir_baton
init|=
name|NULL
decl_stmt|;
name|svn_boolean_t
name|skip
init|=
name|FALSE
decl_stmt|;
name|svn_boolean_t
name|skip_children
init|=
name|FALSE
decl_stmt|;
name|svn_revnum_t
name|revision
decl_stmt|;
name|svn_boolean_t
name|props_mod
decl_stmt|;
name|svn_diff_source_t
modifier|*
name|left_src
decl_stmt|;
name|svn_diff_source_t
modifier|*
name|right_src
decl_stmt|;
comment|/* Everything we do below is useless if we are comparing to BASE. */
if|if
condition|(
name|eb
operator|->
name|diff_pristine
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Determine if this is the anchor directory if the anchor is different      to the target. When the target is a file, the anchor is the parent      directory and if this is that directory the non-target entries must be      skipped. */
name|in_anchor_not_target
operator|=
operator|(
operator|(
operator|*
name|path
operator|==
literal|'\0'
operator|)
operator|&&
operator|(
operator|*
name|eb
operator|->
name|target
operator|!=
literal|'\0'
operator|)
operator|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|revision
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|props_mod
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|left_src
operator|=
name|svn_diff__source_create
argument_list|(
name|revision
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|right_src
operator|=
name|svn_diff__source_create
argument_list|(
name|SVN_INVALID_REVNUM
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|compared
condition|)
block|{
name|dir_baton
operator|=
name|parent_baton
expr_stmt|;
name|skip
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|in_anchor_not_target
condition|)
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|processor
operator|->
name|dir_opened
argument_list|(
operator|&
name|dir_baton
argument_list|,
operator|&
name|skip
argument_list|,
operator|&
name|skip_children
argument_list|,
name|path
argument_list|,
name|left_src
argument_list|,
name|right_src
argument_list|,
name|NULL
comment|/* copyfrom_src */
argument_list|,
name|parent_baton
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|skip_children
operator|&&
name|depth
operator|!=
name|svn_depth_empty
condition|)
block|{
name|apr_hash_t
modifier|*
name|nodes
decl_stmt|;
name|apr_hash_t
modifier|*
name|conflicts
decl_stmt|;
name|apr_array_header_t
modifier|*
name|children
decl_stmt|;
name|svn_depth_t
name|depth_below_here
init|=
name|depth
decl_stmt|;
name|svn_boolean_t
name|diff_files
decl_stmt|;
name|svn_boolean_t
name|diff_dirs
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|depth_below_here
operator|==
name|svn_depth_immediates
condition|)
name|depth_below_here
operator|=
name|svn_depth_empty
expr_stmt|;
name|diff_files
operator|=
operator|(
name|depth
operator|==
name|svn_depth_unknown
operator|||
name|depth
operator|>=
name|svn_depth_files
operator|)
expr_stmt|;
name|diff_dirs
operator|=
operator|(
name|depth
operator|==
name|svn_depth_unknown
operator|||
name|depth
operator|>=
name|svn_depth_immediates
operator|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_children_info
argument_list|(
operator|&
name|nodes
argument_list|,
operator|&
name|conflicts
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|children
operator|=
name|svn_sort__hash
argument_list|(
name|nodes
argument_list|,
name|svn_sort_compare_items_lexically
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|children
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|svn_sort__item_t
modifier|*
name|item
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|children
argument_list|,
name|i
argument_list|,
name|svn_sort__item_t
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|item
operator|->
name|key
decl_stmt|;
name|struct
name|svn_wc__db_info_t
modifier|*
name|info
init|=
name|item
operator|->
name|value
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_abspath
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_relpath
decl_stmt|;
name|svn_boolean_t
name|repos_only
decl_stmt|;
name|svn_boolean_t
name|local_only
decl_stmt|;
name|svn_node_kind_t
name|base_kind
decl_stmt|;
if|if
condition|(
name|eb
operator|->
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|cancel_func
argument_list|(
name|eb
operator|->
name|cancel_baton
argument_list|)
argument_list|)
expr_stmt|;
comment|/* In the anchor directory, if the anchor is not the target then all              entries other than the target should not be diff'd. Running diff              on one file in a directory should not diff other files in that              directory. */
if|if
condition|(
name|in_anchor_not_target
operator|&&
name|strcmp
argument_list|(
name|eb
operator|->
name|target
argument_list|,
name|name
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|compared
operator|&&
name|svn_hash_gets
argument_list|(
name|compared
argument_list|,
name|name
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|NOT_PRESENT
argument_list|(
name|info
operator|->
name|status
argument_list|)
condition|)
continue|continue;
name|assert
argument_list|(
name|info
operator|->
name|status
operator|==
name|svn_wc__db_status_normal
operator|||
name|info
operator|->
name|status
operator|==
name|svn_wc__db_status_added
operator|||
name|info
operator|->
name|status
operator|==
name|svn_wc__db_status_deleted
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|child_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|local_abspath
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|child_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|path
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|repos_only
operator|=
name|FALSE
expr_stmt|;
name|local_only
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|!
name|info
operator|->
name|have_base
condition|)
block|{
name|local_only
operator|=
name|TRUE
expr_stmt|;
comment|/* Only report additions */
block|}
elseif|else
if|if
condition|(
name|info
operator|->
name|status
operator|==
name|svn_wc__db_status_normal
condition|)
block|{
comment|/* Simple diff */
name|base_kind
operator|=
name|info
operator|->
name|kind
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|info
operator|->
name|status
operator|==
name|svn_wc__db_status_deleted
operator|&&
operator|(
operator|!
name|eb
operator|->
name|diff_pristine
operator|||
operator|!
name|info
operator|->
name|have_more_work
operator|)
condition|)
block|{
name|svn_wc__db_status_t
name|base_status
decl_stmt|;
name|repos_only
operator|=
name|TRUE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info
argument_list|(
operator|&
name|base_status
argument_list|,
operator|&
name|base_kind
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|child_abspath
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|NOT_PRESENT
argument_list|(
name|base_status
argument_list|)
condition|)
continue|continue;
block|}
else|else
block|{
comment|/* working status is either added or deleted */
name|svn_wc__db_status_t
name|base_status
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info
argument_list|(
operator|&
name|base_status
argument_list|,
operator|&
name|base_kind
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|child_abspath
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|NOT_PRESENT
argument_list|(
name|base_status
argument_list|)
condition|)
name|local_only
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|base_kind
operator|!=
name|info
operator|->
name|kind
operator|||
operator|!
name|eb
operator|->
name|ignore_ancestry
condition|)
block|{
name|repos_only
operator|=
name|TRUE
expr_stmt|;
name|local_only
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|eb
operator|->
name|local_before_remote
operator|&&
name|local_only
condition|)
block|{
if|if
condition|(
name|info
operator|->
name|kind
operator|==
name|svn_node_file
operator|&&
name|diff_files
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__diff_local_only_file
argument_list|(
name|db
argument_list|,
name|child_abspath
argument_list|,
name|child_relpath
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|dir_baton
argument_list|,
name|eb
operator|->
name|changelist_hash
argument_list|,
name|eb
operator|->
name|diff_pristine
argument_list|,
name|eb
operator|->
name|cancel_func
argument_list|,
name|eb
operator|->
name|cancel_baton
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|info
operator|->
name|kind
operator|==
name|svn_node_dir
operator|&&
name|diff_dirs
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__diff_local_only_dir
argument_list|(
name|db
argument_list|,
name|child_abspath
argument_list|,
name|child_relpath
argument_list|,
name|depth_below_here
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|dir_baton
argument_list|,
name|eb
operator|->
name|changelist_hash
argument_list|,
name|eb
operator|->
name|diff_pristine
argument_list|,
name|eb
operator|->
name|cancel_func
argument_list|,
name|eb
operator|->
name|cancel_baton
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|repos_only
condition|)
block|{
comment|/* Report repository form deleted */
if|if
condition|(
name|base_kind
operator|==
name|svn_node_file
operator|&&
name|diff_files
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__diff_base_only_file
argument_list|(
name|db
argument_list|,
name|child_abspath
argument_list|,
name|child_relpath
argument_list|,
name|eb
operator|->
name|revnum
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|dir_baton
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|base_kind
operator|==
name|svn_node_dir
operator|&&
name|diff_dirs
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__diff_base_only_dir
argument_list|(
name|db
argument_list|,
name|child_abspath
argument_list|,
name|child_relpath
argument_list|,
name|eb
operator|->
name|revnum
argument_list|,
name|depth_below_here
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|dir_baton
argument_list|,
name|eb
operator|->
name|cancel_func
argument_list|,
name|eb
operator|->
name|cancel_baton
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|local_only
condition|)
comment|/* Not local only nor remote only */
block|{
comment|/* Diff base against actual */
if|if
condition|(
name|info
operator|->
name|kind
operator|==
name|svn_node_file
operator|&&
name|diff_files
condition|)
block|{
if|if
condition|(
name|info
operator|->
name|status
operator|!=
name|svn_wc__db_status_normal
operator|||
operator|!
name|eb
operator|->
name|diff_pristine
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__diff_base_working_diff
argument_list|(
name|db
argument_list|,
name|child_abspath
argument_list|,
name|child_relpath
argument_list|,
name|eb
operator|->
name|revnum
argument_list|,
name|eb
operator|->
name|changelist_hash
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|dir_baton
argument_list|,
name|eb
operator|->
name|diff_pristine
argument_list|,
name|eb
operator|->
name|cancel_func
argument_list|,
name|eb
operator|->
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|info
operator|->
name|kind
operator|==
name|svn_node_dir
operator|&&
name|diff_dirs
condition|)
name|SVN_ERR
argument_list|(
name|walk_local_nodes_diff
argument_list|(
name|eb
argument_list|,
name|child_abspath
argument_list|,
name|child_relpath
argument_list|,
name|depth_below_here
argument_list|,
name|NULL
comment|/* compared */
argument_list|,
name|dir_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|eb
operator|->
name|local_before_remote
operator|&&
name|local_only
condition|)
block|{
if|if
condition|(
name|info
operator|->
name|kind
operator|==
name|svn_node_file
operator|&&
name|diff_files
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__diff_local_only_file
argument_list|(
name|db
argument_list|,
name|child_abspath
argument_list|,
name|child_relpath
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|dir_baton
argument_list|,
name|eb
operator|->
name|changelist_hash
argument_list|,
name|eb
operator|->
name|diff_pristine
argument_list|,
name|eb
operator|->
name|cancel_func
argument_list|,
name|eb
operator|->
name|cancel_baton
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|info
operator|->
name|kind
operator|==
name|svn_node_dir
operator|&&
name|diff_dirs
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__diff_local_only_dir
argument_list|(
name|db
argument_list|,
name|child_abspath
argument_list|,
name|child_relpath
argument_list|,
name|depth_below_here
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|dir_baton
argument_list|,
name|eb
operator|->
name|changelist_hash
argument_list|,
name|eb
operator|->
name|diff_pristine
argument_list|,
name|eb
operator|->
name|cancel_func
argument_list|,
name|eb
operator|->
name|cancel_baton
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|compared
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Check for local property mods on this directory, if we haven't      already reported them and we aren't changelist-filted.      ### it should be noted that we do not currently allow directories      ### to be part of changelists, so if a changelist is provided, the      ### changelist check will always fail. */
if|if
condition|(
operator|!
name|skip
operator|&&
operator|!
name|eb
operator|->
name|changelist_hash
operator|&&
operator|!
name|in_anchor_not_target
operator|&&
name|props_mod
condition|)
block|{
name|apr_array_header_t
modifier|*
name|propchanges
decl_stmt|;
name|apr_hash_t
modifier|*
name|left_props
decl_stmt|;
name|apr_hash_t
modifier|*
name|right_props
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__internal_propdiff
argument_list|(
operator|&
name|propchanges
argument_list|,
operator|&
name|left_props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|right_props
operator|=
name|svn_prop__patch
argument_list|(
name|left_props
argument_list|,
name|propchanges
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|processor
operator|->
name|dir_changed
argument_list|(
name|path
argument_list|,
name|left_src
argument_list|,
name|right_src
argument_list|,
name|left_props
argument_list|,
name|right_props
argument_list|,
name|propchanges
argument_list|,
name|dir_baton
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|skip
condition|)
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|processor
operator|->
name|dir_closed
argument_list|(
name|path
argument_list|,
name|left_src
argument_list|,
name|right_src
argument_list|,
name|dir_baton
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__diff_local_only_file
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|void
modifier|*
name|processor_parent_baton
parameter_list|,
name|apr_hash_t
modifier|*
name|changelist_hash
parameter_list|,
name|svn_boolean_t
name|diff_pristine
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_diff_source_t
modifier|*
name|right_src
decl_stmt|;
name|svn_diff_source_t
modifier|*
name|copyfrom_src
init|=
name|NULL
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
specifier|const
name|char
modifier|*
name|original_repos_relpath
decl_stmt|;
name|svn_revnum_t
name|original_revision
decl_stmt|;
specifier|const
name|char
modifier|*
name|changelist
decl_stmt|;
name|svn_boolean_t
name|had_props
decl_stmt|;
name|svn_boolean_t
name|props_mod
decl_stmt|;
name|apr_hash_t
modifier|*
name|pristine_props
decl_stmt|;
name|apr_hash_t
modifier|*
name|right_props
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|pristine_file
decl_stmt|;
specifier|const
name|char
modifier|*
name|translated_file
decl_stmt|;
name|svn_revnum_t
name|revision
decl_stmt|;
name|void
modifier|*
name|file_baton
init|=
name|NULL
decl_stmt|;
name|svn_boolean_t
name|skip
init|=
name|FALSE
decl_stmt|;
name|svn_boolean_t
name|file_mod
init|=
name|TRUE
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|kind
argument_list|,
operator|&
name|revision
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|checksum
argument_list|,
name|NULL
argument_list|,
operator|&
name|original_repos_relpath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|original_revision
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|changelist
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|had_props
argument_list|,
operator|&
name|props_mod
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|kind
operator|==
name|svn_node_file
operator|&&
operator|(
name|status
operator|==
name|svn_wc__db_status_normal
operator|||
name|status
operator|==
name|svn_wc__db_status_added
operator|||
operator|(
name|status
operator|==
name|svn_wc__db_status_deleted
operator|&&
name|diff_pristine
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|changelist
operator|&&
name|changelist_hash
operator|&&
operator|!
name|svn_hash_gets
argument_list|(
name|changelist_hash
argument_list|,
name|changelist
argument_list|)
condition|)
return|return
name|SVN_NO_ERROR
return|;
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_deleted
condition|)
block|{
name|assert
argument_list|(
name|diff_pristine
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_pristine_info
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|kind
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|checksum
argument_list|,
name|NULL
argument_list|,
operator|&
name|had_props
argument_list|,
operator|&
name|pristine_props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|props_mod
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|had_props
condition|)
name|pristine_props
operator|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_pristine_props
argument_list|(
operator|&
name|pristine_props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|original_repos_relpath
condition|)
block|{
name|copyfrom_src
operator|=
name|svn_diff__source_create
argument_list|(
name|original_revision
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|copyfrom_src
operator|->
name|repos_relpath
operator|=
name|original_repos_relpath
expr_stmt|;
block|}
if|if
condition|(
name|props_mod
operator|||
operator|!
name|SVN_IS_VALID_REVNUM
argument_list|(
name|revision
argument_list|)
condition|)
name|right_src
operator|=
name|svn_diff__source_create
argument_list|(
name|SVN_INVALID_REVNUM
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|diff_pristine
condition|)
name|file_mod
operator|=
name|FALSE
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__internal_file_modified_p
argument_list|(
operator|&
name|file_mod
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|file_mod
condition|)
name|right_src
operator|=
name|svn_diff__source_create
argument_list|(
name|revision
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
else|else
name|right_src
operator|=
name|svn_diff__source_create
argument_list|(
name|SVN_INVALID_REVNUM
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|processor
operator|->
name|file_opened
argument_list|(
operator|&
name|file_baton
argument_list|,
operator|&
name|skip
argument_list|,
name|relpath
argument_list|,
name|NULL
comment|/* left_source */
argument_list|,
name|right_src
argument_list|,
name|copyfrom_src
argument_list|,
name|processor_parent_baton
argument_list|,
name|processor
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|skip
condition|)
return|return
name|SVN_NO_ERROR
return|;
if|if
condition|(
name|props_mod
operator|&&
operator|!
name|diff_pristine
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_props
argument_list|(
operator|&
name|right_props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|right_props
operator|=
name|svn_prop_hash_dup
argument_list|(
name|pristine_props
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_get_path
argument_list|(
operator|&
name|pristine_file
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|pristine_file
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|diff_pristine
condition|)
block|{
name|translated_file
operator|=
name|pristine_file
expr_stmt|;
comment|/* No translation needed */
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__internal_translated_file
argument_list|(
operator|&
name|translated_file
argument_list|,
name|local_abspath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|SVN_WC_TRANSLATE_TO_NF
operator||
name|SVN_WC_TRANSLATE_USE_GLOBAL_TMP
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|processor
operator|->
name|file_added
argument_list|(
name|relpath
argument_list|,
name|copyfrom_src
argument_list|,
name|right_src
argument_list|,
name|copyfrom_src
condition|?
name|pristine_file
else|:
name|NULL
argument_list|,
name|translated_file
argument_list|,
name|copyfrom_src
condition|?
name|pristine_props
else|:
name|NULL
argument_list|,
name|right_props
argument_list|,
name|file_baton
argument_list|,
name|processor
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__diff_local_only_dir
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|void
modifier|*
name|processor_parent_baton
parameter_list|,
name|apr_hash_t
modifier|*
name|changelist_hash
parameter_list|,
name|svn_boolean_t
name|diff_pristine
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|apr_array_header_t
modifier|*
name|children
decl_stmt|;
name|int
name|i
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|void
modifier|*
name|pdb
init|=
name|NULL
decl_stmt|;
name|svn_boolean_t
name|skip
init|=
name|FALSE
decl_stmt|;
name|svn_boolean_t
name|skip_children
init|=
name|FALSE
decl_stmt|;
name|svn_diff_source_t
modifier|*
name|right_src
init|=
name|svn_diff__source_create
argument_list|(
name|SVN_INVALID_REVNUM
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|svn_depth_t
name|depth_below_here
init|=
name|depth
decl_stmt|;
name|apr_hash_t
modifier|*
name|nodes
decl_stmt|;
name|apr_hash_t
modifier|*
name|conflicts
decl_stmt|;
comment|/* Report the addition of the directory's contents. */
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|processor
operator|->
name|dir_opened
argument_list|(
operator|&
name|pdb
argument_list|,
operator|&
name|skip
argument_list|,
operator|&
name|skip_children
argument_list|,
name|relpath
argument_list|,
name|NULL
argument_list|,
name|right_src
argument_list|,
name|NULL
comment|/* copyfrom_src */
argument_list|,
name|processor_parent_baton
argument_list|,
name|processor
argument_list|,
name|scratch_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_children_info
argument_list|(
operator|&
name|nodes
argument_list|,
operator|&
name|conflicts
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|depth_below_here
operator|==
name|svn_depth_immediates
condition|)
name|depth_below_here
operator|=
name|svn_depth_empty
expr_stmt|;
name|children
operator|=
name|svn_sort__hash
argument_list|(
name|nodes
argument_list|,
name|svn_sort_compare_items_lexically
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|children
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|svn_sort__item_t
modifier|*
name|item
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|children
argument_list|,
name|i
argument_list|,
name|svn_sort__item_t
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|item
operator|->
name|key
decl_stmt|;
name|struct
name|svn_wc__db_info_t
modifier|*
name|info
init|=
name|item
operator|->
name|value
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_abspath
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_relpath
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
argument_list|)
expr_stmt|;
name|child_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|local_abspath
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|NOT_PRESENT
argument_list|(
name|info
operator|->
name|status
argument_list|)
condition|)
block|{
continue|continue;
block|}
comment|/* If comparing against WORKING, skip entries that are          schedule-deleted - they don't really exist. */
if|if
condition|(
operator|!
name|diff_pristine
operator|&&
name|info
operator|->
name|status
operator|==
name|svn_wc__db_status_deleted
condition|)
continue|continue;
name|child_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|relpath
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|info
operator|->
name|kind
condition|)
block|{
case|case
name|svn_node_file
case|:
case|case
name|svn_node_symlink
case|:
name|SVN_ERR
argument_list|(
name|svn_wc__diff_local_only_file
argument_list|(
name|db
argument_list|,
name|child_abspath
argument_list|,
name|child_relpath
argument_list|,
name|processor
argument_list|,
name|pdb
argument_list|,
name|changelist_hash
argument_list|,
name|diff_pristine
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_node_dir
case|:
if|if
condition|(
name|depth
operator|>
name|svn_depth_files
operator|||
name|depth
operator|==
name|svn_depth_unknown
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__diff_local_only_dir
argument_list|(
name|db
argument_list|,
name|child_abspath
argument_list|,
name|child_relpath
argument_list|,
name|depth_below_here
argument_list|,
name|processor
argument_list|,
name|pdb
argument_list|,
name|changelist_hash
argument_list|,
name|diff_pristine
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|skip
condition|)
block|{
name|apr_hash_t
modifier|*
name|right_props
decl_stmt|;
if|if
condition|(
name|diff_pristine
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_pristine_props
argument_list|(
operator|&
name|right_props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__get_actual_props
argument_list|(
operator|&
name|right_props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|processor
operator|->
name|dir_added
argument_list|(
name|relpath
argument_list|,
name|NULL
comment|/* copyfrom_src */
argument_list|,
name|right_src
argument_list|,
name|NULL
argument_list|,
name|right_props
argument_list|,
name|pdb
argument_list|,
name|processor
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Reports local changes. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|handle_local_only
parameter_list|(
name|struct
name|dir_baton_t
modifier|*
name|pb
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|edit_baton_t
modifier|*
name|eb
init|=
name|pb
operator|->
name|eb
decl_stmt|;
specifier|const
name|struct
name|svn_wc__db_info_t
modifier|*
name|info
decl_stmt|;
name|svn_boolean_t
name|repos_delete
init|=
operator|(
name|pb
operator|->
name|deletes
operator|&&
name|svn_hash_gets
argument_list|(
name|pb
operator|->
name|deletes
argument_list|,
name|name
argument_list|)
operator|)
decl_stmt|;
name|assert
argument_list|(
operator|!
name|strchr
argument_list|(
name|name
argument_list|,
literal|'/'
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
name|pb
operator|->
name|added
operator|||
name|eb
operator|->
name|ignore_ancestry
argument_list|)
expr_stmt|;
if|if
condition|(
name|pb
operator|->
name|skip_children
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR
argument_list|(
name|ensure_local_info
argument_list|(
name|pb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|info
operator|=
name|svn_hash_gets
argument_list|(
name|pb
operator|->
name|local_info
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
operator|||
name|NOT_PRESENT
argument_list|(
name|info
operator|->
name|status
argument_list|)
condition|)
return|return
name|SVN_NO_ERROR
return|;
switch|switch
condition|(
name|info
operator|->
name|status
condition|)
block|{
case|case
name|svn_wc__db_status_incomplete
case|:
return|return
name|SVN_NO_ERROR
return|;
comment|/* Not local only */
case|case
name|svn_wc__db_status_normal
case|:
if|if
condition|(
operator|!
name|repos_delete
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Local and remote */
name|svn_hash_sets
argument_list|(
name|pb
operator|->
name|deletes
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_wc__db_status_deleted
case|:
if|if
condition|(
operator|!
operator|(
name|eb
operator|->
name|diff_pristine
operator|&&
name|repos_delete
operator|)
condition|)
return|return
name|SVN_NO_ERROR
return|;
break|break;
case|case
name|svn_wc__db_status_added
case|:
default|default:
break|break;
block|}
if|if
condition|(
name|info
operator|->
name|kind
operator|==
name|svn_node_dir
condition|)
block|{
name|svn_depth_t
name|depth
decl_stmt|;
if|if
condition|(
name|pb
operator|->
name|depth
operator|==
name|svn_depth_infinity
operator|||
name|pb
operator|->
name|depth
operator|==
name|svn_depth_unknown
condition|)
name|depth
operator|=
name|pb
operator|->
name|depth
expr_stmt|;
else|else
name|depth
operator|=
name|svn_depth_empty
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__diff_local_only_dir
argument_list|(
name|eb
operator|->
name|db
argument_list|,
name|svn_dirent_join
argument_list|(
name|pb
operator|->
name|local_abspath
argument_list|,
name|name
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|svn_relpath_join
argument_list|(
name|pb
operator|->
name|relpath
argument_list|,
name|name
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|repos_delete
condition|?
name|svn_depth_infinity
else|:
name|depth
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|pb
operator|->
name|pdb
argument_list|,
name|eb
operator|->
name|changelist_hash
argument_list|,
name|eb
operator|->
name|diff_pristine
argument_list|,
name|eb
operator|->
name|cancel_func
argument_list|,
name|eb
operator|->
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__diff_local_only_file
argument_list|(
name|eb
operator|->
name|db
argument_list|,
name|svn_dirent_join
argument_list|(
name|pb
operator|->
name|local_abspath
argument_list|,
name|name
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|svn_relpath_join
argument_list|(
name|pb
operator|->
name|relpath
argument_list|,
name|name
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|pb
operator|->
name|pdb
argument_list|,
name|eb
operator|->
name|changelist_hash
argument_list|,
name|eb
operator|->
name|diff_pristine
argument_list|,
name|eb
operator|->
name|cancel_func
argument_list|,
name|eb
operator|->
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Reports a file LOCAL_ABSPATH in BASE as deleted */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_wc__diff_base_only_file
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|void
modifier|*
name|processor_parent_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
name|apr_hash_t
modifier|*
name|props
decl_stmt|;
name|void
modifier|*
name|file_baton
init|=
name|NULL
decl_stmt|;
name|svn_boolean_t
name|skip
init|=
name|FALSE
decl_stmt|;
name|svn_diff_source_t
modifier|*
name|left_src
decl_stmt|;
specifier|const
name|char
modifier|*
name|pristine_file
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|kind
argument_list|,
name|SVN_IS_VALID_REVNUM
argument_list|(
name|revision
argument_list|)
condition|?
name|NULL
else|:
operator|&
name|revision
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|checksum
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|props
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|status
operator|==
name|svn_wc__db_status_normal
operator|&&
name|kind
operator|==
name|svn_node_file
operator|&&
name|checksum
argument_list|)
expr_stmt|;
name|left_src
operator|=
name|svn_diff__source_create
argument_list|(
name|revision
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|processor
operator|->
name|file_opened
argument_list|(
operator|&
name|file_baton
argument_list|,
operator|&
name|skip
argument_list|,
name|relpath
argument_list|,
name|left_src
argument_list|,
name|NULL
comment|/* right_src */
argument_list|,
name|NULL
comment|/* copyfrom_source */
argument_list|,
name|processor_parent_baton
argument_list|,
name|processor
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|skip
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_get_path
argument_list|(
operator|&
name|pristine_file
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|processor
operator|->
name|file_deleted
argument_list|(
name|relpath
argument_list|,
name|left_src
argument_list|,
name|pristine_file
argument_list|,
name|props
argument_list|,
name|file_baton
argument_list|,
name|processor
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__diff_base_only_dir
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|void
modifier|*
name|processor_parent_baton
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|void
modifier|*
name|dir_baton
init|=
name|NULL
decl_stmt|;
name|svn_boolean_t
name|skip
init|=
name|FALSE
decl_stmt|;
name|svn_boolean_t
name|skip_children
init|=
name|FALSE
decl_stmt|;
name|svn_diff_source_t
modifier|*
name|left_src
decl_stmt|;
name|svn_revnum_t
name|report_rev
init|=
name|revision
decl_stmt|;
if|if
condition|(
operator|!
name|SVN_IS_VALID_REVNUM
argument_list|(
name|report_rev
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|report_rev
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|left_src
operator|=
name|svn_diff__source_create
argument_list|(
name|report_rev
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|processor
operator|->
name|dir_opened
argument_list|(
operator|&
name|dir_baton
argument_list|,
operator|&
name|skip
argument_list|,
operator|&
name|skip_children
argument_list|,
name|relpath
argument_list|,
name|left_src
argument_list|,
name|NULL
comment|/* right_src */
argument_list|,
name|NULL
comment|/* copyfrom_src */
argument_list|,
name|processor_parent_baton
argument_list|,
name|processor
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|skip_children
operator|&&
operator|(
name|depth
operator|==
name|svn_depth_unknown
operator|||
name|depth
operator|>
name|svn_depth_empty
operator|)
condition|)
block|{
name|apr_hash_t
modifier|*
name|nodes
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|apr_array_header_t
modifier|*
name|children
decl_stmt|;
name|int
name|i
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_children_info
argument_list|(
operator|&
name|nodes
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|children
operator|=
name|svn_sort__hash
argument_list|(
name|nodes
argument_list|,
name|svn_sort_compare_items_lexically
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|children
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|svn_sort__item_t
modifier|*
name|item
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|children
argument_list|,
name|i
argument_list|,
name|svn_sort__item_t
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|item
operator|->
name|key
decl_stmt|;
name|struct
name|svn_wc__db_base_info_t
modifier|*
name|info
init|=
name|item
operator|->
name|value
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_abspath
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_relpath
decl_stmt|;
if|if
condition|(
name|info
operator|->
name|status
operator|!=
name|svn_wc__db_status_normal
condition|)
continue|continue;
if|if
condition|(
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|child_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|local_abspath
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|child_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|relpath
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|info
operator|->
name|kind
condition|)
block|{
case|case
name|svn_node_file
case|:
case|case
name|svn_node_symlink
case|:
name|SVN_ERR
argument_list|(
name|svn_wc__diff_base_only_file
argument_list|(
name|db
argument_list|,
name|child_abspath
argument_list|,
name|child_relpath
argument_list|,
name|revision
argument_list|,
name|processor
argument_list|,
name|dir_baton
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_node_dir
case|:
if|if
condition|(
name|depth
operator|>
name|svn_depth_files
operator|||
name|depth
operator|==
name|svn_depth_unknown
condition|)
block|{
name|svn_depth_t
name|depth_below_here
init|=
name|depth
decl_stmt|;
if|if
condition|(
name|depth_below_here
operator|==
name|svn_depth_immediates
condition|)
name|depth_below_here
operator|=
name|svn_depth_empty
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__diff_base_only_dir
argument_list|(
name|db
argument_list|,
name|child_abspath
argument_list|,
name|child_relpath
argument_list|,
name|revision
argument_list|,
name|depth_below_here
argument_list|,
name|processor
argument_list|,
name|dir_baton
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|skip
condition|)
block|{
name|apr_hash_t
modifier|*
name|props
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_props
argument_list|(
operator|&
name|props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|processor
operator|->
name|dir_deleted
argument_list|(
name|relpath
argument_list|,
name|left_src
argument_list|,
name|props
argument_list|,
name|dir_baton
argument_list|,
name|processor
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* An svn_delta_editor_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|set_target_revision
parameter_list|(
name|void
modifier|*
name|edit_baton
parameter_list|,
name|svn_revnum_t
name|target_revision
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|edit_baton_t
modifier|*
name|eb
init|=
name|edit_baton
decl_stmt|;
name|eb
operator|->
name|revnum
operator|=
name|target_revision
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_delta_editor_t function. The root of the comparison hierarchy */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|open_root
parameter_list|(
name|void
modifier|*
name|edit_baton
parameter_list|,
name|svn_revnum_t
name|base_revision
parameter_list|,
name|apr_pool_t
modifier|*
name|dir_pool
parameter_list|,
name|void
modifier|*
modifier|*
name|root_baton
parameter_list|)
block|{
name|struct
name|edit_baton_t
modifier|*
name|eb
init|=
name|edit_baton
decl_stmt|;
name|struct
name|dir_baton_t
modifier|*
name|db
decl_stmt|;
name|eb
operator|->
name|root_opened
operator|=
name|TRUE
expr_stmt|;
name|db
operator|=
name|make_dir_baton
argument_list|(
literal|""
argument_list|,
name|NULL
argument_list|,
name|eb
argument_list|,
name|FALSE
argument_list|,
name|eb
operator|->
name|depth
argument_list|,
name|dir_pool
argument_list|)
expr_stmt|;
operator|*
name|root_baton
operator|=
name|db
expr_stmt|;
if|if
condition|(
name|eb
operator|->
name|target
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
block|{
name|db
operator|->
name|left_src
operator|=
name|svn_diff__source_create
argument_list|(
name|eb
operator|->
name|revnum
argument_list|,
name|db
operator|->
name|pool
argument_list|)
expr_stmt|;
name|db
operator|->
name|right_src
operator|=
name|svn_diff__source_create
argument_list|(
name|SVN_INVALID_REVNUM
argument_list|,
name|db
operator|->
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|processor
operator|->
name|dir_opened
argument_list|(
operator|&
name|db
operator|->
name|pdb
argument_list|,
operator|&
name|db
operator|->
name|skip
argument_list|,
operator|&
name|db
operator|->
name|skip_children
argument_list|,
literal|""
argument_list|,
name|db
operator|->
name|left_src
argument_list|,
name|db
operator|->
name|right_src
argument_list|,
name|NULL
comment|/* copyfrom_source */
argument_list|,
name|NULL
comment|/* parent_baton */
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|db
operator|->
name|pool
argument_list|,
name|db
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|db
operator|->
name|skip
operator|=
name|TRUE
expr_stmt|;
comment|/* Skip this, but not the children */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_delta_editor_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|delete_entry
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
name|base_revision
parameter_list|,
name|void
modifier|*
name|parent_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|dir_baton_t
modifier|*
name|pb
init|=
name|parent_baton
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|svn_dirent_basename
argument_list|(
name|path
argument_list|,
name|pb
operator|->
name|pool
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|pb
operator|->
name|deletes
condition|)
name|pb
operator|->
name|deletes
operator|=
name|apr_hash_make
argument_list|(
name|pb
operator|->
name|pool
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|pb
operator|->
name|deletes
argument_list|,
name|name
argument_list|,
literal|""
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_delta_editor_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|add_directory
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|void
modifier|*
name|parent_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|copyfrom_path
parameter_list|,
name|svn_revnum_t
name|copyfrom_revision
parameter_list|,
name|apr_pool_t
modifier|*
name|dir_pool
parameter_list|,
name|void
modifier|*
modifier|*
name|child_baton
parameter_list|)
block|{
name|struct
name|dir_baton_t
modifier|*
name|pb
init|=
name|parent_baton
decl_stmt|;
name|struct
name|edit_baton_t
modifier|*
name|eb
init|=
name|pb
operator|->
name|eb
decl_stmt|;
name|struct
name|dir_baton_t
modifier|*
name|db
decl_stmt|;
name|svn_depth_t
name|subdir_depth
init|=
operator|(
name|pb
operator|->
name|depth
operator|==
name|svn_depth_immediates
operator|)
condition|?
name|svn_depth_empty
else|:
name|pb
operator|->
name|depth
decl_stmt|;
name|db
operator|=
name|make_dir_baton
argument_list|(
name|path
argument_list|,
name|pb
argument_list|,
name|pb
operator|->
name|eb
argument_list|,
name|TRUE
argument_list|,
name|subdir_depth
argument_list|,
name|dir_pool
argument_list|)
expr_stmt|;
operator|*
name|child_baton
operator|=
name|db
expr_stmt|;
if|if
condition|(
name|pb
operator|->
name|repos_only
operator|||
operator|!
name|eb
operator|->
name|ignore_ancestry
condition|)
name|db
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
name|struct
name|svn_wc__db_info_t
modifier|*
name|info
decl_stmt|;
name|SVN_ERR
argument_list|(
name|ensure_local_info
argument_list|(
name|pb
argument_list|,
name|dir_pool
argument_list|)
argument_list|)
expr_stmt|;
name|info
operator|=
name|svn_hash_gets
argument_list|(
name|pb
operator|->
name|local_info
argument_list|,
name|db
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
operator|||
name|info
operator|->
name|kind
operator|!=
name|svn_node_dir
operator|||
name|NOT_PRESENT
argument_list|(
name|info
operator|->
name|status
argument_list|)
condition|)
name|db
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|db
operator|->
name|repos_only
operator|&&
name|info
operator|->
name|status
operator|!=
name|svn_wc__db_status_added
condition|)
name|db
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|db
operator|->
name|repos_only
condition|)
block|{
name|db
operator|->
name|right_src
operator|=
name|svn_diff__source_create
argument_list|(
name|SVN_INVALID_REVNUM
argument_list|,
name|db
operator|->
name|pool
argument_list|)
expr_stmt|;
name|db
operator|->
name|ignoring_ancestry
operator|=
name|TRUE
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|pb
operator|->
name|compared
argument_list|,
name|apr_pstrdup
argument_list|(
name|pb
operator|->
name|pool
argument_list|,
name|db
operator|->
name|name
argument_list|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
name|db
operator|->
name|left_src
operator|=
name|svn_diff__source_create
argument_list|(
name|eb
operator|->
name|revnum
argument_list|,
name|db
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|eb
operator|->
name|local_before_remote
operator|&&
operator|!
name|db
operator|->
name|repos_only
operator|&&
operator|!
name|db
operator|->
name|ignoring_ancestry
condition|)
name|SVN_ERR
argument_list|(
name|handle_local_only
argument_list|(
name|pb
argument_list|,
name|db
operator|->
name|name
argument_list|,
name|dir_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|processor
operator|->
name|dir_opened
argument_list|(
operator|&
name|db
operator|->
name|pdb
argument_list|,
operator|&
name|db
operator|->
name|skip
argument_list|,
operator|&
name|db
operator|->
name|skip_children
argument_list|,
name|db
operator|->
name|relpath
argument_list|,
name|db
operator|->
name|left_src
argument_list|,
name|db
operator|->
name|right_src
argument_list|,
name|NULL
comment|/* copyfrom src */
argument_list|,
name|pb
operator|->
name|pdb
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|db
operator|->
name|pool
argument_list|,
name|db
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_delta_editor_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|open_directory
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|void
modifier|*
name|parent_baton
parameter_list|,
name|svn_revnum_t
name|base_revision
parameter_list|,
name|apr_pool_t
modifier|*
name|dir_pool
parameter_list|,
name|void
modifier|*
modifier|*
name|child_baton
parameter_list|)
block|{
name|struct
name|dir_baton_t
modifier|*
name|pb
init|=
name|parent_baton
decl_stmt|;
name|struct
name|edit_baton_t
modifier|*
name|eb
init|=
name|pb
operator|->
name|eb
decl_stmt|;
name|struct
name|dir_baton_t
modifier|*
name|db
decl_stmt|;
name|svn_depth_t
name|subdir_depth
init|=
operator|(
name|pb
operator|->
name|depth
operator|==
name|svn_depth_immediates
operator|)
condition|?
name|svn_depth_empty
else|:
name|pb
operator|->
name|depth
decl_stmt|;
comment|/* Allocate path from the parent pool since the memory is used in the      parent's compared hash */
name|db
operator|=
name|make_dir_baton
argument_list|(
name|path
argument_list|,
name|pb
argument_list|,
name|pb
operator|->
name|eb
argument_list|,
name|FALSE
argument_list|,
name|subdir_depth
argument_list|,
name|dir_pool
argument_list|)
expr_stmt|;
operator|*
name|child_baton
operator|=
name|db
expr_stmt|;
if|if
condition|(
name|pb
operator|->
name|repos_only
condition|)
name|db
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
name|struct
name|svn_wc__db_info_t
modifier|*
name|info
decl_stmt|;
name|SVN_ERR
argument_list|(
name|ensure_local_info
argument_list|(
name|pb
argument_list|,
name|dir_pool
argument_list|)
argument_list|)
expr_stmt|;
name|info
operator|=
name|svn_hash_gets
argument_list|(
name|pb
operator|->
name|local_info
argument_list|,
name|db
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
operator|||
name|info
operator|->
name|kind
operator|!=
name|svn_node_dir
operator|||
name|NOT_PRESENT
argument_list|(
name|info
operator|->
name|status
argument_list|)
condition|)
name|db
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|db
operator|->
name|repos_only
condition|)
switch|switch
condition|(
name|info
operator|->
name|status
condition|)
block|{
case|case
name|svn_wc__db_status_normal
case|:
break|break;
case|case
name|svn_wc__db_status_deleted
case|:
name|db
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|info
operator|->
name|have_more_work
condition|)
name|svn_hash_sets
argument_list|(
name|pb
operator|->
name|compared
argument_list|,
name|apr_pstrdup
argument_list|(
name|pb
operator|->
name|pool
argument_list|,
name|db
operator|->
name|name
argument_list|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_wc__db_status_added
case|:
if|if
condition|(
name|eb
operator|->
name|ignore_ancestry
condition|)
name|db
operator|->
name|ignoring_ancestry
operator|=
name|TRUE
expr_stmt|;
else|else
name|db
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|db
operator|->
name|repos_only
condition|)
block|{
name|db
operator|->
name|right_src
operator|=
name|svn_diff__source_create
argument_list|(
name|SVN_INVALID_REVNUM
argument_list|,
name|db
operator|->
name|pool
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|pb
operator|->
name|compared
argument_list|,
name|apr_pstrdup
argument_list|(
name|pb
operator|->
name|pool
argument_list|,
name|db
operator|->
name|name
argument_list|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
name|db
operator|->
name|left_src
operator|=
name|svn_diff__source_create
argument_list|(
name|eb
operator|->
name|revnum
argument_list|,
name|db
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|eb
operator|->
name|local_before_remote
operator|&&
operator|!
name|db
operator|->
name|repos_only
operator|&&
operator|!
name|db
operator|->
name|ignoring_ancestry
condition|)
name|SVN_ERR
argument_list|(
name|handle_local_only
argument_list|(
name|pb
argument_list|,
name|db
operator|->
name|name
argument_list|,
name|dir_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|processor
operator|->
name|dir_opened
argument_list|(
operator|&
name|db
operator|->
name|pdb
argument_list|,
operator|&
name|db
operator|->
name|skip
argument_list|,
operator|&
name|db
operator|->
name|skip_children
argument_list|,
name|db
operator|->
name|relpath
argument_list|,
name|db
operator|->
name|left_src
argument_list|,
name|db
operator|->
name|right_src
argument_list|,
name|NULL
comment|/* copyfrom src */
argument_list|,
name|pb
operator|->
name|pdb
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|db
operator|->
name|pool
argument_list|,
name|db
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_delta_editor_t function.  When a directory is closed, all the  * directory elements that have been added or replaced will already have been  * diff'd. However there may be other elements in the working copy  * that have not yet been considered.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|close_directory
parameter_list|(
name|void
modifier|*
name|dir_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|dir_baton_t
modifier|*
name|db
init|=
name|dir_baton
decl_stmt|;
name|struct
name|dir_baton_t
modifier|*
name|pb
init|=
name|db
operator|->
name|parent_baton
decl_stmt|;
name|struct
name|edit_baton_t
modifier|*
name|eb
init|=
name|db
operator|->
name|eb
decl_stmt|;
name|apr_pool_t
modifier|*
name|scratch_pool
init|=
name|db
operator|->
name|pool
decl_stmt|;
name|svn_boolean_t
name|reported_closed
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
operator|!
name|db
operator|->
name|skip_children
operator|&&
name|db
operator|->
name|deletes
operator|&&
name|apr_hash_count
argument_list|(
name|db
operator|->
name|deletes
argument_list|)
condition|)
block|{
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|apr_array_header_t
modifier|*
name|children
decl_stmt|;
name|int
name|i
decl_stmt|;
name|children
operator|=
name|svn_sort__hash
argument_list|(
name|db
operator|->
name|deletes
argument_list|,
name|svn_sort_compare_items_lexically
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|children
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|svn_sort__item_t
modifier|*
name|item
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|children
argument_list|,
name|i
argument_list|,
name|svn_sort__item_t
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|item
operator|->
name|key
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|handle_local_only
argument_list|(
name|db
argument_list|,
name|name
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|db
operator|->
name|compared
argument_list|,
name|name
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
block|}
comment|/* Report local modifications for this directory.  Skip added      directories since they can only contain added elements, all of      which have already been diff'd. */
if|if
condition|(
operator|!
name|db
operator|->
name|repos_only
operator|&&
operator|!
name|db
operator|->
name|skip_children
condition|)
block|{
name|SVN_ERR
argument_list|(
name|walk_local_nodes_diff
argument_list|(
name|eb
argument_list|,
name|db
operator|->
name|local_abspath
argument_list|,
name|db
operator|->
name|relpath
argument_list|,
name|db
operator|->
name|depth
argument_list|,
name|db
operator|->
name|compared
argument_list|,
name|db
operator|->
name|pdb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Report the property changes on the directory itself, if necessary. */
if|if
condition|(
name|db
operator|->
name|skip
condition|)
block|{
comment|/* Diff processor requested no directory details */
block|}
elseif|else
if|if
condition|(
name|db
operator|->
name|propchanges
operator|->
name|nelts
operator|>
literal|0
operator|||
name|db
operator|->
name|repos_only
condition|)
block|{
name|apr_hash_t
modifier|*
name|repos_props
decl_stmt|;
if|if
condition|(
name|db
operator|->
name|added
condition|)
block|{
name|repos_props
operator|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_props
argument_list|(
operator|&
name|repos_props
argument_list|,
name|eb
operator|->
name|db
argument_list|,
name|db
operator|->
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Add received property changes and entry props */
if|if
condition|(
name|db
operator|->
name|propchanges
operator|->
name|nelts
condition|)
name|repos_props
operator|=
name|svn_prop__patch
argument_list|(
name|repos_props
argument_list|,
name|db
operator|->
name|propchanges
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|->
name|repos_only
condition|)
block|{
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|processor
operator|->
name|dir_deleted
argument_list|(
name|db
operator|->
name|relpath
argument_list|,
name|db
operator|->
name|left_src
argument_list|,
name|repos_props
argument_list|,
name|db
operator|->
name|pdb
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|reported_closed
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|apr_hash_t
modifier|*
name|local_props
decl_stmt|;
name|apr_array_header_t
modifier|*
name|prop_changes
decl_stmt|;
if|if
condition|(
name|eb
operator|->
name|diff_pristine
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_pristine_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|local_props
argument_list|,
name|eb
operator|->
name|db
argument_list|,
name|db
operator|->
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_props
argument_list|(
operator|&
name|local_props
argument_list|,
name|eb
operator|->
name|db
argument_list|,
name|db
operator|->
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_prop_diffs
argument_list|(
operator|&
name|prop_changes
argument_list|,
name|local_props
argument_list|,
name|repos_props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### as a good diff processor we should now only report changes                  if there are non-entry changes, but for now we stick to                  compatibility */
if|if
condition|(
name|prop_changes
operator|->
name|nelts
condition|)
block|{
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|processor
operator|->
name|dir_changed
argument_list|(
name|db
operator|->
name|relpath
argument_list|,
name|db
operator|->
name|left_src
argument_list|,
name|db
operator|->
name|right_src
argument_list|,
name|repos_props
argument_list|,
name|local_props
argument_list|,
name|prop_changes
argument_list|,
name|db
operator|->
name|pdb
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|reported_closed
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
block|}
comment|/* Mark this directory as compared in the parent directory's baton,      unless this is the root of the comparison. */
if|if
condition|(
operator|!
name|reported_closed
operator|&&
operator|!
name|db
operator|->
name|skip
condition|)
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|processor
operator|->
name|dir_closed
argument_list|(
name|db
operator|->
name|relpath
argument_list|,
name|db
operator|->
name|left_src
argument_list|,
name|db
operator|->
name|right_src
argument_list|,
name|db
operator|->
name|pdb
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pb
operator|&&
operator|!
name|eb
operator|->
name|local_before_remote
operator|&&
operator|!
name|db
operator|->
name|repos_only
operator|&&
operator|!
name|db
operator|->
name|ignoring_ancestry
condition|)
name|SVN_ERR
argument_list|(
name|handle_local_only
argument_list|(
name|pb
argument_list|,
name|db
operator|->
name|name
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|maybe_done
argument_list|(
name|db
argument_list|)
argument_list|)
expr_stmt|;
comment|/* destroys scratch_pool */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_delta_editor_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|add_file
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|void
modifier|*
name|parent_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|copyfrom_path
parameter_list|,
name|svn_revnum_t
name|copyfrom_revision
parameter_list|,
name|apr_pool_t
modifier|*
name|file_pool
parameter_list|,
name|void
modifier|*
modifier|*
name|file_baton
parameter_list|)
block|{
name|struct
name|dir_baton_t
modifier|*
name|pb
init|=
name|parent_baton
decl_stmt|;
name|struct
name|edit_baton_t
modifier|*
name|eb
init|=
name|pb
operator|->
name|eb
decl_stmt|;
name|struct
name|file_baton_t
modifier|*
name|fb
decl_stmt|;
name|fb
operator|=
name|make_file_baton
argument_list|(
name|path
argument_list|,
name|TRUE
argument_list|,
name|pb
argument_list|,
name|file_pool
argument_list|)
expr_stmt|;
operator|*
name|file_baton
operator|=
name|fb
expr_stmt|;
if|if
condition|(
name|pb
operator|->
name|skip_children
condition|)
block|{
name|fb
operator|->
name|skip
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
elseif|else
if|if
condition|(
name|pb
operator|->
name|repos_only
operator|||
operator|!
name|eb
operator|->
name|ignore_ancestry
condition|)
name|fb
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
name|struct
name|svn_wc__db_info_t
modifier|*
name|info
decl_stmt|;
name|SVN_ERR
argument_list|(
name|ensure_local_info
argument_list|(
name|pb
argument_list|,
name|file_pool
argument_list|)
argument_list|)
expr_stmt|;
name|info
operator|=
name|svn_hash_gets
argument_list|(
name|pb
operator|->
name|local_info
argument_list|,
name|fb
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
operator|||
name|info
operator|->
name|kind
operator|!=
name|svn_node_file
operator|||
name|NOT_PRESENT
argument_list|(
name|info
operator|->
name|status
argument_list|)
condition|)
name|fb
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|fb
operator|->
name|repos_only
operator|&&
name|info
operator|->
name|status
operator|!=
name|svn_wc__db_status_added
condition|)
name|fb
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|fb
operator|->
name|repos_only
condition|)
block|{
comment|/* Add this path to the parent directory's list of elements that              have been compared. */
name|fb
operator|->
name|right_src
operator|=
name|svn_diff__source_create
argument_list|(
name|SVN_INVALID_REVNUM
argument_list|,
name|fb
operator|->
name|pool
argument_list|)
expr_stmt|;
name|fb
operator|->
name|ignoring_ancestry
operator|=
name|TRUE
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|pb
operator|->
name|compared
argument_list|,
name|apr_pstrdup
argument_list|(
name|pb
operator|->
name|pool
argument_list|,
name|fb
operator|->
name|name
argument_list|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
name|fb
operator|->
name|left_src
operator|=
name|svn_diff__source_create
argument_list|(
name|eb
operator|->
name|revnum
argument_list|,
name|fb
operator|->
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|processor
operator|->
name|file_opened
argument_list|(
operator|&
name|fb
operator|->
name|pfb
argument_list|,
operator|&
name|fb
operator|->
name|skip
argument_list|,
name|fb
operator|->
name|relpath
argument_list|,
name|fb
operator|->
name|left_src
argument_list|,
name|fb
operator|->
name|right_src
argument_list|,
name|NULL
comment|/* copyfrom src */
argument_list|,
name|pb
operator|->
name|pdb
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|fb
operator|->
name|pool
argument_list|,
name|fb
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_delta_editor_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|open_file
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|void
modifier|*
name|parent_baton
parameter_list|,
name|svn_revnum_t
name|base_revision
parameter_list|,
name|apr_pool_t
modifier|*
name|file_pool
parameter_list|,
name|void
modifier|*
modifier|*
name|file_baton
parameter_list|)
block|{
name|struct
name|dir_baton_t
modifier|*
name|pb
init|=
name|parent_baton
decl_stmt|;
name|struct
name|edit_baton_t
modifier|*
name|eb
init|=
name|pb
operator|->
name|eb
decl_stmt|;
name|struct
name|file_baton_t
modifier|*
name|fb
decl_stmt|;
name|fb
operator|=
name|make_file_baton
argument_list|(
name|path
argument_list|,
name|FALSE
argument_list|,
name|pb
argument_list|,
name|file_pool
argument_list|)
expr_stmt|;
operator|*
name|file_baton
operator|=
name|fb
expr_stmt|;
if|if
condition|(
name|pb
operator|->
name|skip_children
condition|)
name|fb
operator|->
name|skip
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|pb
operator|->
name|repos_only
condition|)
name|fb
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
name|struct
name|svn_wc__db_info_t
modifier|*
name|info
decl_stmt|;
name|SVN_ERR
argument_list|(
name|ensure_local_info
argument_list|(
name|pb
argument_list|,
name|file_pool
argument_list|)
argument_list|)
expr_stmt|;
name|info
operator|=
name|svn_hash_gets
argument_list|(
name|pb
operator|->
name|local_info
argument_list|,
name|fb
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
operator|||
name|info
operator|->
name|kind
operator|!=
name|svn_node_file
operator|||
name|NOT_PRESENT
argument_list|(
name|info
operator|->
name|status
argument_list|)
condition|)
name|fb
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|fb
operator|->
name|repos_only
condition|)
switch|switch
condition|(
name|info
operator|->
name|status
condition|)
block|{
case|case
name|svn_wc__db_status_normal
case|:
break|break;
case|case
name|svn_wc__db_status_deleted
case|:
name|fb
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|info
operator|->
name|have_more_work
condition|)
name|svn_hash_sets
argument_list|(
name|pb
operator|->
name|compared
argument_list|,
name|apr_pstrdup
argument_list|(
name|pb
operator|->
name|pool
argument_list|,
name|fb
operator|->
name|name
argument_list|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_wc__db_status_added
case|:
if|if
condition|(
name|eb
operator|->
name|ignore_ancestry
condition|)
name|fb
operator|->
name|ignoring_ancestry
operator|=
name|TRUE
expr_stmt|;
else|else
name|fb
operator|->
name|repos_only
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|fb
operator|->
name|repos_only
condition|)
block|{
comment|/* Add this path to the parent directory's list of elements that              have been compared. */
name|fb
operator|->
name|right_src
operator|=
name|svn_diff__source_create
argument_list|(
name|SVN_INVALID_REVNUM
argument_list|,
name|fb
operator|->
name|pool
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|pb
operator|->
name|compared
argument_list|,
name|apr_pstrdup
argument_list|(
name|pb
operator|->
name|pool
argument_list|,
name|fb
operator|->
name|name
argument_list|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
name|fb
operator|->
name|left_src
operator|=
name|svn_diff__source_create
argument_list|(
name|eb
operator|->
name|revnum
argument_list|,
name|fb
operator|->
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|fb
operator|->
name|base_checksum
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|fb
operator|->
name|base_props
argument_list|,
name|NULL
argument_list|,
name|eb
operator|->
name|db
argument_list|,
name|fb
operator|->
name|local_abspath
argument_list|,
name|fb
operator|->
name|pool
argument_list|,
name|fb
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|processor
operator|->
name|file_opened
argument_list|(
operator|&
name|fb
operator|->
name|pfb
argument_list|,
operator|&
name|fb
operator|->
name|skip
argument_list|,
name|fb
operator|->
name|relpath
argument_list|,
name|fb
operator|->
name|left_src
argument_list|,
name|fb
operator|->
name|right_src
argument_list|,
name|NULL
comment|/* copyfrom src */
argument_list|,
name|pb
operator|->
name|pdb
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|fb
operator|->
name|pool
argument_list|,
name|fb
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_delta_editor_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|apply_textdelta
parameter_list|(
name|void
modifier|*
name|file_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|base_checksum_hex
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_txdelta_window_handler_t
modifier|*
name|handler
parameter_list|,
name|void
modifier|*
modifier|*
name|handler_baton
parameter_list|)
block|{
name|struct
name|file_baton_t
modifier|*
name|fb
init|=
name|file_baton
decl_stmt|;
name|struct
name|edit_baton_t
modifier|*
name|eb
init|=
name|fb
operator|->
name|eb
decl_stmt|;
name|svn_stream_t
modifier|*
name|source
decl_stmt|;
name|svn_stream_t
modifier|*
name|temp_stream
decl_stmt|;
name|svn_checksum_t
modifier|*
name|repos_checksum
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|fb
operator|->
name|skip
condition|)
block|{
operator|*
name|handler
operator|=
name|svn_delta_noop_window_handler
expr_stmt|;
operator|*
name|handler_baton
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
if|if
condition|(
name|base_checksum_hex
operator|&&
name|fb
operator|->
name|base_checksum
condition|)
block|{
specifier|const
name|svn_checksum_t
modifier|*
name|base_md5
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_checksum_parse_hex
argument_list|(
operator|&
name|repos_checksum
argument_list|,
name|svn_checksum_md5
argument_list|,
name|base_checksum_hex
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_get_md5
argument_list|(
operator|&
name|base_md5
argument_list|,
name|eb
operator|->
name|db
argument_list|,
name|eb
operator|->
name|anchor_abspath
argument_list|,
name|fb
operator|->
name|base_checksum
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_checksum_match
argument_list|(
name|repos_checksum
argument_list|,
name|base_md5
argument_list|)
condition|)
block|{
comment|/* ### I expect that there are some bad drivers out there              ### that used to give bad results. We could look in              ### working to see if the expected checksum matches and              ### then return the pristine of that... But that only moves              ### the problem */
comment|/* If needed: compare checksum obtained via md5 of working.              And if they match set fb->base_checksum and fb->base_props */
return|return
name|svn_checksum_mismatch_err
argument_list|(
name|base_md5
argument_list|,
name|repos_checksum
argument_list|,
name|pool
argument_list|,
name|_
argument_list|(
literal|"Checksum mismatch for '%s'"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|fb
operator|->
name|local_abspath
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_read
argument_list|(
operator|&
name|source
argument_list|,
name|NULL
argument_list|,
name|eb
operator|->
name|db
argument_list|,
name|fb
operator|->
name|local_abspath
argument_list|,
name|fb
operator|->
name|base_checksum
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fb
operator|->
name|base_checksum
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_read
argument_list|(
operator|&
name|source
argument_list|,
name|NULL
argument_list|,
name|eb
operator|->
name|db
argument_list|,
name|fb
operator|->
name|local_abspath
argument_list|,
name|fb
operator|->
name|base_checksum
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|source
operator|=
name|svn_stream_empty
argument_list|(
name|pool
argument_list|)
expr_stmt|;
comment|/* This is the file that will contain the pristine repository version. */
name|SVN_ERR
argument_list|(
name|svn_stream_open_unique
argument_list|(
operator|&
name|temp_stream
argument_list|,
operator|&
name|fb
operator|->
name|temp_file_path
argument_list|,
name|NULL
argument_list|,
name|svn_io_file_del_on_pool_cleanup
argument_list|,
name|fb
operator|->
name|pool
argument_list|,
name|fb
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|svn_txdelta_apply
argument_list|(
name|source
argument_list|,
name|temp_stream
argument_list|,
name|fb
operator|->
name|result_digest
argument_list|,
name|fb
operator|->
name|local_abspath
comment|/* error_info */
argument_list|,
name|fb
operator|->
name|pool
argument_list|,
name|handler
argument_list|,
name|handler_baton
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_delta_editor_t function.  When the file is closed we have a temporary  * file containing a pristine version of the repository file. This can  * be compared against the working copy.  *  * Ignore TEXT_CHECKSUM.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|close_file
parameter_list|(
name|void
modifier|*
name|file_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|expected_md5_digest
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|file_baton_t
modifier|*
name|fb
init|=
name|file_baton
decl_stmt|;
name|struct
name|dir_baton_t
modifier|*
name|pb
init|=
name|fb
operator|->
name|parent_baton
decl_stmt|;
name|struct
name|edit_baton_t
modifier|*
name|eb
init|=
name|fb
operator|->
name|eb
decl_stmt|;
name|apr_pool_t
modifier|*
name|scratch_pool
init|=
name|fb
operator|->
name|pool
decl_stmt|;
comment|/* The repository information; constructed from BASE + Changes */
specifier|const
name|char
modifier|*
name|repos_file
decl_stmt|;
name|apr_hash_t
modifier|*
name|repos_props
decl_stmt|;
if|if
condition|(
operator|!
name|fb
operator|->
name|skip
operator|&&
name|expected_md5_digest
operator|!=
name|NULL
condition|)
block|{
name|svn_checksum_t
modifier|*
name|expected_checksum
decl_stmt|;
specifier|const
name|svn_checksum_t
modifier|*
name|result_checksum
decl_stmt|;
if|if
condition|(
name|fb
operator|->
name|temp_file_path
condition|)
name|result_checksum
operator|=
name|svn_checksum__from_digest_md5
argument_list|(
name|fb
operator|->
name|result_digest
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
else|else
name|result_checksum
operator|=
name|fb
operator|->
name|base_checksum
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_checksum_parse_hex
argument_list|(
operator|&
name|expected_checksum
argument_list|,
name|svn_checksum_md5
argument_list|,
name|expected_md5_digest
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result_checksum
operator|->
name|kind
operator|!=
name|svn_checksum_md5
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_get_md5
argument_list|(
operator|&
name|result_checksum
argument_list|,
name|eb
operator|->
name|db
argument_list|,
name|fb
operator|->
name|local_abspath
argument_list|,
name|result_checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_checksum_match
argument_list|(
name|expected_checksum
argument_list|,
name|result_checksum
argument_list|)
condition|)
return|return
name|svn_checksum_mismatch_err
argument_list|(
name|expected_checksum
argument_list|,
name|result_checksum
argument_list|,
name|pool
argument_list|,
name|_
argument_list|(
literal|"Checksum mismatch for '%s'"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|fb
operator|->
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|eb
operator|->
name|local_before_remote
operator|&&
operator|!
name|fb
operator|->
name|repos_only
operator|&&
operator|!
name|fb
operator|->
name|ignoring_ancestry
condition|)
name|SVN_ERR
argument_list|(
name|handle_local_only
argument_list|(
name|pb
argument_list|,
name|fb
operator|->
name|name
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|{
name|apr_hash_t
modifier|*
name|prop_base
decl_stmt|;
if|if
condition|(
name|fb
operator|->
name|added
condition|)
name|prop_base
operator|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
else|else
name|prop_base
operator|=
name|fb
operator|->
name|base_props
expr_stmt|;
comment|/* includes entry props */
name|repos_props
operator|=
name|svn_prop__patch
argument_list|(
name|prop_base
argument_list|,
name|fb
operator|->
name|propchanges
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|repos_file
operator|=
name|fb
operator|->
name|temp_file_path
expr_stmt|;
if|if
condition|(
operator|!
name|repos_file
condition|)
block|{
name|assert
argument_list|(
name|fb
operator|->
name|base_checksum
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_get_path
argument_list|(
operator|&
name|repos_file
argument_list|,
name|eb
operator|->
name|db
argument_list|,
name|eb
operator|->
name|anchor_abspath
argument_list|,
name|fb
operator|->
name|base_checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fb
operator|->
name|skip
condition|)
block|{
comment|/* Diff processor requested skipping information */
block|}
elseif|else
if|if
condition|(
name|fb
operator|->
name|repos_only
condition|)
block|{
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|processor
operator|->
name|file_deleted
argument_list|(
name|fb
operator|->
name|relpath
argument_list|,
name|fb
operator|->
name|left_src
argument_list|,
name|fb
operator|->
name|temp_file_path
argument_list|,
name|repos_props
argument_list|,
name|fb
operator|->
name|pfb
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Produce a diff of actual or pristine against repos */
name|apr_hash_t
modifier|*
name|local_props
decl_stmt|;
name|apr_array_header_t
modifier|*
name|prop_changes
decl_stmt|;
specifier|const
name|char
modifier|*
name|localfile
decl_stmt|;
comment|/* pb->local_info contains some information that might allow optimizing          this a bit */
if|if
condition|(
name|eb
operator|->
name|diff_pristine
condition|)
block|{
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_pristine_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|checksum
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|local_props
argument_list|,
name|eb
operator|->
name|db
argument_list|,
name|fb
operator|->
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|checksum
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_get_path
argument_list|(
operator|&
name|localfile
argument_list|,
name|eb
operator|->
name|db
argument_list|,
name|eb
operator|->
name|anchor_abspath
argument_list|,
name|checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_props
argument_list|(
operator|&
name|local_props
argument_list|,
name|eb
operator|->
name|db
argument_list|,
name|fb
operator|->
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* a detranslated version of the working file */
name|SVN_ERR
argument_list|(
name|svn_wc__internal_translated_file
argument_list|(
operator|&
name|localfile
argument_list|,
name|fb
operator|->
name|local_abspath
argument_list|,
name|eb
operator|->
name|db
argument_list|,
name|fb
operator|->
name|local_abspath
argument_list|,
name|SVN_WC_TRANSLATE_TO_NF
operator||
name|SVN_WC_TRANSLATE_USE_GLOBAL_TMP
argument_list|,
name|eb
operator|->
name|cancel_func
argument_list|,
name|eb
operator|->
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_prop_diffs
argument_list|(
operator|&
name|prop_changes
argument_list|,
name|local_props
argument_list|,
name|repos_props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### as a good diff processor we should now only report changes, and              report file_closed() in other cases */
name|SVN_ERR
argument_list|(
name|eb
operator|->
name|processor
operator|->
name|file_changed
argument_list|(
name|fb
operator|->
name|relpath
argument_list|,
name|fb
operator|->
name|left_src
argument_list|,
name|fb
operator|->
name|right_src
argument_list|,
name|repos_file
comment|/* left file */
argument_list|,
name|localfile
comment|/* right file */
argument_list|,
name|repos_props
comment|/* left_props */
argument_list|,
name|local_props
comment|/* right props */
argument_list|,
name|TRUE
comment|/* ### file_modified */
argument_list|,
name|prop_changes
argument_list|,
name|fb
operator|->
name|pfb
argument_list|,
name|eb
operator|->
name|processor
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|eb
operator|->
name|local_before_remote
operator|&&
operator|!
name|fb
operator|->
name|repos_only
operator|&&
operator|!
name|fb
operator|->
name|ignoring_ancestry
condition|)
name|SVN_ERR
argument_list|(
name|handle_local_only
argument_list|(
name|pb
argument_list|,
name|fb
operator|->
name|name
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|fb
operator|->
name|pool
argument_list|)
expr_stmt|;
comment|/* destroys scratch_pool and fb */
name|SVN_ERR
argument_list|(
name|maybe_done
argument_list|(
name|pb
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_delta_editor_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|change_file_prop
parameter_list|(
name|void
modifier|*
name|file_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|value
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|file_baton_t
modifier|*
name|fb
init|=
name|file_baton
decl_stmt|;
name|svn_prop_t
modifier|*
name|propchange
decl_stmt|;
name|svn_prop_kind_t
name|propkind
decl_stmt|;
name|propkind
operator|=
name|svn_property_kind2
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|propkind
operator|==
name|svn_prop_wc_kind
condition|)
return|return
name|SVN_NO_ERROR
return|;
elseif|else
if|if
condition|(
name|propkind
operator|==
name|svn_prop_regular_kind
condition|)
name|fb
operator|->
name|has_propchange
operator|=
name|TRUE
expr_stmt|;
name|propchange
operator|=
name|apr_array_push
argument_list|(
name|fb
operator|->
name|propchanges
argument_list|)
expr_stmt|;
name|propchange
operator|->
name|name
operator|=
name|apr_pstrdup
argument_list|(
name|fb
operator|->
name|pool
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|propchange
operator|->
name|value
operator|=
name|value
condition|?
name|svn_string_dup
argument_list|(
name|value
argument_list|,
name|fb
operator|->
name|pool
argument_list|)
else|:
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_delta_editor_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|change_dir_prop
parameter_list|(
name|void
modifier|*
name|dir_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|value
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|dir_baton_t
modifier|*
name|db
init|=
name|dir_baton
decl_stmt|;
name|svn_prop_t
modifier|*
name|propchange
decl_stmt|;
name|svn_prop_kind_t
name|propkind
decl_stmt|;
name|propkind
operator|=
name|svn_property_kind2
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|propkind
operator|==
name|svn_prop_wc_kind
condition|)
return|return
name|SVN_NO_ERROR
return|;
elseif|else
if|if
condition|(
name|propkind
operator|==
name|svn_prop_regular_kind
condition|)
name|db
operator|->
name|has_propchange
operator|=
name|TRUE
expr_stmt|;
name|propchange
operator|=
name|apr_array_push
argument_list|(
name|db
operator|->
name|propchanges
argument_list|)
expr_stmt|;
name|propchange
operator|->
name|name
operator|=
name|apr_pstrdup
argument_list|(
name|db
operator|->
name|pool
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|propchange
operator|->
name|value
operator|=
name|value
condition|?
name|svn_string_dup
argument_list|(
name|value
argument_list|,
name|db
operator|->
name|pool
argument_list|)
else|:
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_delta_editor_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|close_edit
parameter_list|(
name|void
modifier|*
name|edit_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|edit_baton_t
modifier|*
name|eb
init|=
name|edit_baton
decl_stmt|;
if|if
condition|(
operator|!
name|eb
operator|->
name|root_opened
condition|)
block|{
name|SVN_ERR
argument_list|(
name|walk_local_nodes_diff
argument_list|(
name|eb
argument_list|,
name|eb
operator|->
name|anchor_abspath
argument_list|,
literal|""
argument_list|,
name|eb
operator|->
name|depth
argument_list|,
name|NULL
comment|/* compared */
argument_list|,
name|NULL
comment|/* No parent_baton */
argument_list|,
name|eb
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Public Interface */
end_comment

begin_escape
end_escape

begin_comment
comment|/* Create a diff editor and baton. */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_wc__get_diff_editor
parameter_list|(
specifier|const
name|svn_delta_editor_t
modifier|*
modifier|*
name|editor
parameter_list|,
name|void
modifier|*
modifier|*
name|edit_baton
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|anchor_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
name|svn_boolean_t
name|show_copies_as_adds
parameter_list|,
name|svn_boolean_t
name|use_git_diff_format
parameter_list|,
name|svn_boolean_t
name|use_text_base
parameter_list|,
name|svn_boolean_t
name|reverse_order
parameter_list|,
name|svn_boolean_t
name|server_performs_filtering
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelist_filter
parameter_list|,
specifier|const
name|svn_wc_diff_callbacks4_t
modifier|*
name|callbacks
parameter_list|,
name|void
modifier|*
name|callback_baton
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|edit_baton_t
modifier|*
name|eb
decl_stmt|;
name|void
modifier|*
name|inner_baton
decl_stmt|;
name|svn_delta_editor_t
modifier|*
name|tree_editor
decl_stmt|;
specifier|const
name|svn_delta_editor_t
modifier|*
name|inner_editor
decl_stmt|;
name|struct
name|svn_wc__shim_fetch_baton_t
modifier|*
name|sfb
decl_stmt|;
name|svn_delta_shim_callbacks_t
modifier|*
name|shim_callbacks
init|=
name|svn_delta_shim_callbacks_default
argument_list|(
name|result_pool
argument_list|)
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|anchor_abspath
argument_list|)
argument_list|)
expr_stmt|;
comment|/* --git implies --show-copies-as-adds */
if|if
condition|(
name|use_git_diff_format
condition|)
name|show_copies_as_adds
operator|=
name|TRUE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|make_edit_baton
argument_list|(
operator|&
name|eb
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|anchor_abspath
argument_list|,
name|target
argument_list|,
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|show_copies_as_adds
argument_list|,
name|use_text_base
argument_list|,
name|reverse_order
argument_list|,
name|changelist_filter
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|tree_editor
operator|=
name|svn_delta_default_editor
argument_list|(
name|eb
operator|->
name|pool
argument_list|)
expr_stmt|;
name|tree_editor
operator|->
name|set_target_revision
operator|=
name|set_target_revision
expr_stmt|;
name|tree_editor
operator|->
name|open_root
operator|=
name|open_root
expr_stmt|;
name|tree_editor
operator|->
name|delete_entry
operator|=
name|delete_entry
expr_stmt|;
name|tree_editor
operator|->
name|add_directory
operator|=
name|add_directory
expr_stmt|;
name|tree_editor
operator|->
name|open_directory
operator|=
name|open_directory
expr_stmt|;
name|tree_editor
operator|->
name|close_directory
operator|=
name|close_directory
expr_stmt|;
name|tree_editor
operator|->
name|add_file
operator|=
name|add_file
expr_stmt|;
name|tree_editor
operator|->
name|open_file
operator|=
name|open_file
expr_stmt|;
name|tree_editor
operator|->
name|apply_textdelta
operator|=
name|apply_textdelta
expr_stmt|;
name|tree_editor
operator|->
name|change_file_prop
operator|=
name|change_file_prop
expr_stmt|;
name|tree_editor
operator|->
name|change_dir_prop
operator|=
name|change_dir_prop
expr_stmt|;
name|tree_editor
operator|->
name|close_file
operator|=
name|close_file
expr_stmt|;
name|tree_editor
operator|->
name|close_edit
operator|=
name|close_edit
expr_stmt|;
name|inner_editor
operator|=
name|tree_editor
expr_stmt|;
name|inner_baton
operator|=
name|eb
expr_stmt|;
if|if
condition|(
operator|!
name|server_performs_filtering
operator|&&
name|depth
operator|==
name|svn_depth_unknown
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__ambient_depth_filter_editor
argument_list|(
operator|&
name|inner_editor
argument_list|,
operator|&
name|inner_baton
argument_list|,
name|wc_ctx
operator|->
name|db
argument_list|,
name|anchor_abspath
argument_list|,
name|target
argument_list|,
name|inner_editor
argument_list|,
name|inner_baton
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_delta_get_cancellation_editor
argument_list|(
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|inner_editor
argument_list|,
name|inner_baton
argument_list|,
name|editor
argument_list|,
name|edit_baton
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|sfb
operator|=
name|apr_palloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sfb
argument_list|)
argument_list|)
expr_stmt|;
name|sfb
operator|->
name|db
operator|=
name|wc_ctx
operator|->
name|db
expr_stmt|;
name|sfb
operator|->
name|base_abspath
operator|=
name|eb
operator|->
name|anchor_abspath
expr_stmt|;
name|sfb
operator|->
name|fetch_base
operator|=
name|TRUE
expr_stmt|;
name|shim_callbacks
operator|->
name|fetch_kind_func
operator|=
name|svn_wc__fetch_kind_func
expr_stmt|;
name|shim_callbacks
operator|->
name|fetch_props_func
operator|=
name|svn_wc__fetch_props_func
expr_stmt|;
name|shim_callbacks
operator|->
name|fetch_base_func
operator|=
name|svn_wc__fetch_base_func
expr_stmt|;
name|shim_callbacks
operator|->
name|fetch_baton
operator|=
name|sfb
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_editor__insert_shims
argument_list|(
name|editor
argument_list|,
name|edit_baton
argument_list|,
operator|*
name|editor
argument_list|,
operator|*
name|edit_baton
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|shim_callbacks
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Wrapping svn_wc_diff_callbacks4_t as svn_diff_tree_processor_t */
end_comment

begin_comment
comment|/* baton for the svn_diff_tree_processor_t wrapper */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|wc_diff_wrap_baton_t
block|{
specifier|const
name|svn_wc_diff_callbacks4_t
modifier|*
name|callbacks
decl_stmt|;
name|void
modifier|*
name|callback_baton
decl_stmt|;
name|svn_boolean_t
name|walk_deleted_dirs
decl_stmt|;
name|apr_pool_t
modifier|*
name|result_pool
decl_stmt|;
specifier|const
name|char
modifier|*
name|empty_file
decl_stmt|;
block|}
name|wc_diff_wrap_baton_t
typedef|;
end_typedef

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wrap_ensure_empty_file
parameter_list|(
name|wc_diff_wrap_baton_t
modifier|*
name|wb
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
if|if
condition|(
name|wb
operator|->
name|empty_file
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Create a unique file in the tempdir */
name|SVN_ERR
argument_list|(
name|svn_io_open_unique_file3
argument_list|(
name|NULL
argument_list|,
operator|&
name|wb
operator|->
name|empty_file
argument_list|,
name|NULL
argument_list|,
name|svn_io_file_del_on_pool_cleanup
argument_list|,
name|wb
operator|->
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* svn_diff_tree_processor_t function */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wrap_dir_opened
parameter_list|(
name|void
modifier|*
modifier|*
name|new_dir_baton
parameter_list|,
name|svn_boolean_t
modifier|*
name|skip
parameter_list|,
name|svn_boolean_t
modifier|*
name|skip_children
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|left_source
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|right_source
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|copyfrom_source
parameter_list|,
name|void
modifier|*
name|parent_dir_baton
parameter_list|,
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|wc_diff_wrap_baton_t
modifier|*
name|wb
init|=
name|processor
operator|->
name|baton
decl_stmt|;
name|svn_boolean_t
name|tree_conflicted
init|=
name|FALSE
decl_stmt|;
name|assert
argument_list|(
name|left_source
operator|||
name|right_source
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
name|copyfrom_source
operator|||
operator|!
name|right_source
argument_list|)
expr_stmt|;
comment|/* Maybe store state and tree_conflicted in baton? */
if|if
condition|(
name|left_source
operator|!=
name|NULL
condition|)
block|{
comment|/* Open for change or delete */
name|SVN_ERR
argument_list|(
name|wb
operator|->
name|callbacks
operator|->
name|dir_opened
argument_list|(
operator|&
name|tree_conflicted
argument_list|,
name|skip
argument_list|,
name|skip_children
argument_list|,
name|relpath
argument_list|,
name|right_source
condition|?
name|right_source
operator|->
name|revision
else|:
operator|(
name|left_source
condition|?
name|left_source
operator|->
name|revision
else|:
name|SVN_INVALID_REVNUM
operator|)
argument_list|,
name|wb
operator|->
name|callback_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|right_source
operator|&&
operator|!
name|wb
operator|->
name|walk_deleted_dirs
condition|)
operator|*
name|skip_children
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
comment|/* left_source == NULL -> Add */
block|{
name|svn_wc_notify_state_t
name|state
init|=
name|svn_wc_notify_state_inapplicable
decl_stmt|;
name|SVN_ERR
argument_list|(
name|wb
operator|->
name|callbacks
operator|->
name|dir_added
argument_list|(
operator|&
name|state
argument_list|,
operator|&
name|tree_conflicted
argument_list|,
name|skip
argument_list|,
name|skip_children
argument_list|,
name|relpath
argument_list|,
name|right_source
operator|->
name|revision
argument_list|,
name|copyfrom_source
condition|?
name|copyfrom_source
operator|->
name|repos_relpath
else|:
name|NULL
argument_list|,
name|copyfrom_source
condition|?
name|copyfrom_source
operator|->
name|revision
else|:
name|SVN_INVALID_REVNUM
argument_list|,
name|wb
operator|->
name|callback_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|new_dir_baton
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* svn_diff_tree_processor_t function */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wrap_dir_added
parameter_list|(
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|right_source
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|copyfrom_source
parameter_list|,
comment|/*const*/
name|apr_hash_t
modifier|*
name|copyfrom_props
parameter_list|,
comment|/*const*/
name|apr_hash_t
modifier|*
name|right_props
parameter_list|,
name|void
modifier|*
name|dir_baton
parameter_list|,
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|wc_diff_wrap_baton_t
modifier|*
name|wb
init|=
name|processor
operator|->
name|baton
decl_stmt|;
name|svn_boolean_t
name|tree_conflicted
init|=
name|FALSE
decl_stmt|;
name|svn_wc_notify_state_t
name|state
init|=
name|svn_wc_notify_state_unknown
decl_stmt|;
name|svn_wc_notify_state_t
name|prop_state
init|=
name|svn_wc_notify_state_unknown
decl_stmt|;
name|apr_hash_t
modifier|*
name|pristine_props
init|=
name|copyfrom_props
decl_stmt|;
name|apr_array_header_t
modifier|*
name|prop_changes
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|right_props
operator|&&
name|apr_hash_count
argument_list|(
name|right_props
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|pristine_props
condition|)
name|pristine_props
operator|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_prop_diffs
argument_list|(
operator|&
name|prop_changes
argument_list|,
name|right_props
argument_list|,
name|pristine_props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|wb
operator|->
name|callbacks
operator|->
name|dir_props_changed
argument_list|(
operator|&
name|prop_state
argument_list|,
operator|&
name|tree_conflicted
argument_list|,
name|relpath
argument_list|,
name|TRUE
comment|/* dir_was_added */
argument_list|,
name|prop_changes
argument_list|,
name|pristine_props
argument_list|,
name|wb
operator|->
name|callback_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|wb
operator|->
name|callbacks
operator|->
name|dir_closed
argument_list|(
operator|&
name|state
argument_list|,
operator|&
name|prop_state
argument_list|,
operator|&
name|tree_conflicted
argument_list|,
name|relpath
argument_list|,
name|TRUE
comment|/* dir_was_added */
argument_list|,
name|wb
operator|->
name|callback_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* svn_diff_tree_processor_t function */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wrap_dir_deleted
parameter_list|(
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|left_source
parameter_list|,
comment|/*const*/
name|apr_hash_t
modifier|*
name|left_props
parameter_list|,
name|void
modifier|*
name|dir_baton
parameter_list|,
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|wc_diff_wrap_baton_t
modifier|*
name|wb
init|=
name|processor
operator|->
name|baton
decl_stmt|;
name|svn_boolean_t
name|tree_conflicted
init|=
name|FALSE
decl_stmt|;
name|svn_wc_notify_state_t
name|state
init|=
name|svn_wc_notify_state_inapplicable
decl_stmt|;
name|SVN_ERR
argument_list|(
name|wb
operator|->
name|callbacks
operator|->
name|dir_deleted
argument_list|(
operator|&
name|state
argument_list|,
operator|&
name|tree_conflicted
argument_list|,
name|relpath
argument_list|,
name|wb
operator|->
name|callback_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* svn_diff_tree_processor_t function */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wrap_dir_closed
parameter_list|(
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|left_source
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|right_source
parameter_list|,
name|void
modifier|*
name|dir_baton
parameter_list|,
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|wc_diff_wrap_baton_t
modifier|*
name|wb
init|=
name|processor
operator|->
name|baton
decl_stmt|;
comment|/* No previous implementations provided these arguments, so we      are not providing them either */
name|SVN_ERR
argument_list|(
name|wb
operator|->
name|callbacks
operator|->
name|dir_closed
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|relpath
argument_list|,
name|FALSE
comment|/* added */
argument_list|,
name|wb
operator|->
name|callback_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* svn_diff_tree_processor_t function */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wrap_dir_changed
parameter_list|(
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|left_source
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|right_source
parameter_list|,
comment|/*const*/
name|apr_hash_t
modifier|*
name|left_props
parameter_list|,
comment|/*const*/
name|apr_hash_t
modifier|*
name|right_props
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|prop_changes
parameter_list|,
name|void
modifier|*
name|dir_baton
parameter_list|,
specifier|const
name|struct
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|wc_diff_wrap_baton_t
modifier|*
name|wb
init|=
name|processor
operator|->
name|baton
decl_stmt|;
name|svn_boolean_t
name|tree_conflicted
init|=
name|FALSE
decl_stmt|;
name|svn_wc_notify_state_t
name|prop_state
init|=
name|svn_wc_notify_state_inapplicable
decl_stmt|;
name|assert
argument_list|(
name|left_source
operator|&&
name|right_source
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|wb
operator|->
name|callbacks
operator|->
name|dir_props_changed
argument_list|(
operator|&
name|prop_state
argument_list|,
operator|&
name|tree_conflicted
argument_list|,
name|relpath
argument_list|,
name|FALSE
comment|/* dir_was_added */
argument_list|,
name|prop_changes
argument_list|,
name|left_props
argument_list|,
name|wb
operator|->
name|callback_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* And call dir_closed, etc */
name|SVN_ERR
argument_list|(
name|wrap_dir_closed
argument_list|(
name|relpath
argument_list|,
name|left_source
argument_list|,
name|right_source
argument_list|,
name|dir_baton
argument_list|,
name|processor
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* svn_diff_tree_processor_t function */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wrap_file_opened
parameter_list|(
name|void
modifier|*
modifier|*
name|new_file_baton
parameter_list|,
name|svn_boolean_t
modifier|*
name|skip
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|left_source
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|right_source
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|copyfrom_source
parameter_list|,
name|void
modifier|*
name|dir_baton
parameter_list|,
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|wc_diff_wrap_baton_t
modifier|*
name|wb
init|=
name|processor
operator|->
name|baton
decl_stmt|;
name|svn_boolean_t
name|tree_conflicted
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|left_source
condition|)
comment|/* If ! added */
name|SVN_ERR
argument_list|(
name|wb
operator|->
name|callbacks
operator|->
name|file_opened
argument_list|(
operator|&
name|tree_conflicted
argument_list|,
name|skip
argument_list|,
name|relpath
argument_list|,
name|right_source
condition|?
name|right_source
operator|->
name|revision
else|:
operator|(
name|left_source
condition|?
name|left_source
operator|->
name|revision
else|:
name|SVN_INVALID_REVNUM
operator|)
argument_list|,
name|wb
operator|->
name|callback_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* No old implementation used the output arguments for notify */
operator|*
name|new_file_baton
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* svn_diff_tree_processor_t function */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wrap_file_added
parameter_list|(
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|copyfrom_source
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|right_source
parameter_list|,
specifier|const
name|char
modifier|*
name|copyfrom_file
parameter_list|,
specifier|const
name|char
modifier|*
name|right_file
parameter_list|,
comment|/*const*/
name|apr_hash_t
modifier|*
name|copyfrom_props
parameter_list|,
comment|/*const*/
name|apr_hash_t
modifier|*
name|right_props
parameter_list|,
name|void
modifier|*
name|file_baton
parameter_list|,
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|wc_diff_wrap_baton_t
modifier|*
name|wb
init|=
name|processor
operator|->
name|baton
decl_stmt|;
name|svn_boolean_t
name|tree_conflicted
init|=
name|FALSE
decl_stmt|;
name|svn_wc_notify_state_t
name|state
init|=
name|svn_wc_notify_state_inapplicable
decl_stmt|;
name|svn_wc_notify_state_t
name|prop_state
init|=
name|svn_wc_notify_state_inapplicable
decl_stmt|;
name|apr_array_header_t
modifier|*
name|prop_changes
decl_stmt|;
if|if
condition|(
operator|!
name|copyfrom_props
condition|)
name|copyfrom_props
operator|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_prop_diffs
argument_list|(
operator|&
name|prop_changes
argument_list|,
name|right_props
argument_list|,
name|copyfrom_props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|copyfrom_source
condition|)
name|SVN_ERR
argument_list|(
name|wrap_ensure_empty_file
argument_list|(
name|wb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|wb
operator|->
name|callbacks
operator|->
name|file_added
argument_list|(
operator|&
name|state
argument_list|,
operator|&
name|prop_state
argument_list|,
operator|&
name|tree_conflicted
argument_list|,
name|relpath
argument_list|,
name|copyfrom_source
condition|?
name|copyfrom_file
else|:
name|wb
operator|->
name|empty_file
argument_list|,
name|right_file
argument_list|,
literal|0
argument_list|,
name|right_source
operator|->
name|revision
argument_list|,
name|copyfrom_props
condition|?
name|svn_prop_get_value
argument_list|(
name|copyfrom_props
argument_list|,
name|SVN_PROP_MIME_TYPE
argument_list|)
else|:
name|NULL
argument_list|,
name|right_props
condition|?
name|svn_prop_get_value
argument_list|(
name|right_props
argument_list|,
name|SVN_PROP_MIME_TYPE
argument_list|)
else|:
name|NULL
argument_list|,
name|copyfrom_source
condition|?
name|copyfrom_source
operator|->
name|repos_relpath
else|:
name|NULL
argument_list|,
name|copyfrom_source
condition|?
name|copyfrom_source
operator|->
name|revision
else|:
name|SVN_INVALID_REVNUM
argument_list|,
name|prop_changes
argument_list|,
name|copyfrom_props
argument_list|,
name|wb
operator|->
name|callback_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wrap_file_deleted
parameter_list|(
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|left_source
parameter_list|,
specifier|const
name|char
modifier|*
name|left_file
parameter_list|,
name|apr_hash_t
modifier|*
name|left_props
parameter_list|,
name|void
modifier|*
name|file_baton
parameter_list|,
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|wc_diff_wrap_baton_t
modifier|*
name|wb
init|=
name|processor
operator|->
name|baton
decl_stmt|;
name|svn_boolean_t
name|tree_conflicted
init|=
name|FALSE
decl_stmt|;
name|svn_wc_notify_state_t
name|state
init|=
name|svn_wc_notify_state_inapplicable
decl_stmt|;
name|SVN_ERR
argument_list|(
name|wrap_ensure_empty_file
argument_list|(
name|wb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|wb
operator|->
name|callbacks
operator|->
name|file_deleted
argument_list|(
operator|&
name|state
argument_list|,
operator|&
name|tree_conflicted
argument_list|,
name|relpath
argument_list|,
name|left_file
argument_list|,
name|wb
operator|->
name|empty_file
argument_list|,
name|left_props
condition|?
name|svn_prop_get_value
argument_list|(
name|left_props
argument_list|,
name|SVN_PROP_MIME_TYPE
argument_list|)
else|:
name|NULL
argument_list|,
name|NULL
argument_list|,
name|left_props
argument_list|,
name|wb
operator|->
name|callback_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* svn_diff_tree_processor_t function */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wrap_file_changed
parameter_list|(
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|left_source
parameter_list|,
specifier|const
name|svn_diff_source_t
modifier|*
name|right_source
parameter_list|,
specifier|const
name|char
modifier|*
name|left_file
parameter_list|,
specifier|const
name|char
modifier|*
name|right_file
parameter_list|,
comment|/*const*/
name|apr_hash_t
modifier|*
name|left_props
parameter_list|,
comment|/*const*/
name|apr_hash_t
modifier|*
name|right_props
parameter_list|,
name|svn_boolean_t
name|file_modified
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|prop_changes
parameter_list|,
name|void
modifier|*
name|file_baton
parameter_list|,
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|processor
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|wc_diff_wrap_baton_t
modifier|*
name|wb
init|=
name|processor
operator|->
name|baton
decl_stmt|;
name|svn_boolean_t
name|tree_conflicted
init|=
name|FALSE
decl_stmt|;
name|svn_wc_notify_state_t
name|state
init|=
name|svn_wc_notify_state_inapplicable
decl_stmt|;
name|svn_wc_notify_state_t
name|prop_state
init|=
name|svn_wc_notify_state_inapplicable
decl_stmt|;
name|SVN_ERR
argument_list|(
name|wrap_ensure_empty_file
argument_list|(
name|wb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|left_source
operator|&&
name|right_source
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|wb
operator|->
name|callbacks
operator|->
name|file_changed
argument_list|(
operator|&
name|state
argument_list|,
operator|&
name|prop_state
argument_list|,
operator|&
name|tree_conflicted
argument_list|,
name|relpath
argument_list|,
name|file_modified
condition|?
name|left_file
else|:
name|NULL
argument_list|,
name|file_modified
condition|?
name|right_file
else|:
name|NULL
argument_list|,
name|left_source
operator|->
name|revision
argument_list|,
name|right_source
operator|->
name|revision
argument_list|,
name|left_props
condition|?
name|svn_prop_get_value
argument_list|(
name|left_props
argument_list|,
name|SVN_PROP_MIME_TYPE
argument_list|)
else|:
name|NULL
argument_list|,
name|right_props
condition|?
name|svn_prop_get_value
argument_list|(
name|right_props
argument_list|,
name|SVN_PROP_MIME_TYPE
argument_list|)
else|:
name|NULL
argument_list|,
name|prop_changes
argument_list|,
name|left_props
argument_list|,
name|wb
operator|->
name|callback_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__wrap_diff_callbacks
parameter_list|(
specifier|const
name|svn_diff_tree_processor_t
modifier|*
modifier|*
name|diff_processor
parameter_list|,
specifier|const
name|svn_wc_diff_callbacks4_t
modifier|*
name|callbacks
parameter_list|,
name|void
modifier|*
name|callback_baton
parameter_list|,
name|svn_boolean_t
name|walk_deleted_dirs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|wc_diff_wrap_baton_t
modifier|*
name|wrap_baton
decl_stmt|;
name|svn_diff_tree_processor_t
modifier|*
name|processor
decl_stmt|;
name|wrap_baton
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wrap_baton
argument_list|)
argument_list|)
expr_stmt|;
name|wrap_baton
operator|->
name|result_pool
operator|=
name|result_pool
expr_stmt|;
name|wrap_baton
operator|->
name|callbacks
operator|=
name|callbacks
expr_stmt|;
name|wrap_baton
operator|->
name|callback_baton
operator|=
name|callback_baton
expr_stmt|;
name|wrap_baton
operator|->
name|empty_file
operator|=
name|NULL
expr_stmt|;
name|wrap_baton
operator|->
name|walk_deleted_dirs
operator|=
name|walk_deleted_dirs
expr_stmt|;
name|processor
operator|=
name|svn_diff__tree_processor_create
argument_list|(
name|wrap_baton
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|processor
operator|->
name|dir_opened
operator|=
name|wrap_dir_opened
expr_stmt|;
name|processor
operator|->
name|dir_added
operator|=
name|wrap_dir_added
expr_stmt|;
name|processor
operator|->
name|dir_deleted
operator|=
name|wrap_dir_deleted
expr_stmt|;
name|processor
operator|->
name|dir_changed
operator|=
name|wrap_dir_changed
expr_stmt|;
name|processor
operator|->
name|dir_closed
operator|=
name|wrap_dir_closed
expr_stmt|;
name|processor
operator|->
name|file_opened
operator|=
name|wrap_file_opened
expr_stmt|;
name|processor
operator|->
name|file_added
operator|=
name|wrap_file_added
expr_stmt|;
name|processor
operator|->
name|file_deleted
operator|=
name|wrap_file_deleted
expr_stmt|;
name|processor
operator|->
name|file_changed
operator|=
name|wrap_file_changed
expr_stmt|;
comment|/*processor->file_closed   = wrap_file_closed*/
empty_stmt|;
comment|/* Not needed */
operator|*
name|diff_processor
operator|=
name|processor
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


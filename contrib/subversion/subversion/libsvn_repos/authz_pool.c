begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * authz_pool.c :  pool of authorization objects  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_escape
end_escape

begin_include
include|#
directive|include
file|"svn_checksum.h"
end_include

begin_include
include|#
directive|include
file|"svn_config.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_dep_compat.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_mutex.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_object_pool.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_subr_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_repos_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_string_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_subr_private.h"
end_include

begin_include
include|#
directive|include
file|"repos.h"
end_include

begin_comment
comment|/* Currently this structure is just a wrapper around a svn_config_t.  */
end_comment

begin_struct
struct|struct
name|svn_authz_t
block|{
name|svn_config_t
modifier|*
name|cfg
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* The wrapper object structure that we store in the object pool.  It  * combines the authz with the underlying config structures and their  * identifying keys.  */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|authz_object_t
block|{
comment|/* key = concatenation of AUTHZ_KEY and GROUPS_KEY */
name|svn_membuf_t
modifier|*
name|key
decl_stmt|;
comment|/* keys used to identify AUTHZ_CFG and GROUPS_CFG */
name|svn_membuf_t
modifier|*
name|authz_key
decl_stmt|;
name|svn_membuf_t
modifier|*
name|groups_key
decl_stmt|;
comment|/* r/o references to configurations from the configuration pool.      GROUPS_CFG may be NULL. */
name|svn_config_t
modifier|*
name|authz_cfg
decl_stmt|;
name|svn_config_t
modifier|*
name|groups_cfg
decl_stmt|;
comment|/* Case-sensitive config. */
name|svn_authz_t
modifier|*
name|authz
decl_stmt|;
block|}
name|authz_object_t
typedef|;
end_typedef

begin_comment
comment|/* Root data structure simply adding the config_pool to the basic object pool.  */
end_comment

begin_struct
struct|struct
name|svn_repos__authz_pool_t
block|{
comment|/* authz_object_t object storage */
name|svn_object_pool__t
modifier|*
name|object_pool
decl_stmt|;
comment|/* factory and storage of (shared) configuration objects */
name|svn_repos__config_pool_t
modifier|*
name|config_pool
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Return a combination of AUTHZ_KEY and GROUPS_KEY, allocated in POOL.  * GROUPS_KEY may be NULL.  */
end_comment

begin_function
specifier|static
name|svn_membuf_t
modifier|*
name|construct_key
parameter_list|(
name|svn_membuf_t
modifier|*
name|authz_key
parameter_list|,
name|svn_membuf_t
modifier|*
name|groups_key
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_membuf_t
modifier|*
name|result
init|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|result
argument_list|)
argument_list|)
decl_stmt|;
name|apr_size_t
name|size
decl_stmt|;
if|if
condition|(
name|groups_key
condition|)
block|{
name|size
operator|=
name|authz_key
operator|->
name|size
operator|+
name|groups_key
operator|->
name|size
expr_stmt|;
name|svn_membuf__create
argument_list|(
name|result
argument_list|,
name|size
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|result
operator|->
name|data
argument_list|,
name|authz_key
operator|->
name|data
argument_list|,
name|authz_key
operator|->
name|size
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|result
operator|->
name|data
operator|+
name|authz_key
operator|->
name|size
argument_list|,
name|groups_key
operator|->
name|data
argument_list|,
name|groups_key
operator|->
name|size
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|size
operator|=
name|authz_key
operator|->
name|size
expr_stmt|;
name|svn_membuf__create
argument_list|(
name|result
argument_list|,
name|size
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|result
operator|->
name|data
argument_list|,
name|authz_key
operator|->
name|data
argument_list|,
name|authz_key
operator|->
name|size
argument_list|)
expr_stmt|;
block|}
name|result
operator|->
name|size
operator|=
name|size
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/* Implement svn_object_pool__getter_t on authz_object_t structures.  */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|getter
parameter_list|(
name|void
modifier|*
name|object
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
operator|(
operator|(
name|authz_object_t
operator|*
operator|)
name|object
operator|)
operator|->
name|authz
return|;
block|}
end_function

begin_comment
comment|/* API implementation */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_repos__authz_pool_create
parameter_list|(
name|svn_repos__authz_pool_t
modifier|*
modifier|*
name|authz_pool
parameter_list|,
name|svn_repos__config_pool_t
modifier|*
name|config_pool
parameter_list|,
name|svn_boolean_t
name|thread_safe
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_repos__authz_pool_t
modifier|*
name|result
decl_stmt|;
name|svn_object_pool__t
modifier|*
name|object_pool
decl_stmt|;
comment|/* there is no setter as we don't need to update existing authz */
name|SVN_ERR
argument_list|(
name|svn_object_pool__create
argument_list|(
operator|&
name|object_pool
argument_list|,
name|getter
argument_list|,
name|NULL
argument_list|,
name|thread_safe
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|->
name|object_pool
operator|=
name|object_pool
expr_stmt|;
name|result
operator|->
name|config_pool
operator|=
name|config_pool
expr_stmt|;
operator|*
name|authz_pool
operator|=
name|result
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_repos__authz_pool_get
parameter_list|(
name|svn_authz_t
modifier|*
modifier|*
name|authz_p
parameter_list|,
name|svn_repos__authz_pool_t
modifier|*
name|authz_pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|groups_path
parameter_list|,
name|svn_boolean_t
name|must_exist
parameter_list|,
name|svn_repos_t
modifier|*
name|preferred_repos
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|authz_ref_pool
init|=
name|svn_object_pool__new_wrapper_pool
argument_list|(
name|authz_pool
operator|->
name|object_pool
argument_list|)
decl_stmt|;
name|authz_object_t
modifier|*
name|authz_ref
init|=
name|apr_pcalloc
argument_list|(
name|authz_ref_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|authz_ref
argument_list|)
argument_list|)
decl_stmt|;
name|svn_boolean_t
name|have_all_keys
decl_stmt|;
comment|/* read the configurations */
name|SVN_ERR
argument_list|(
name|svn_repos__config_pool_get
argument_list|(
operator|&
name|authz_ref
operator|->
name|authz_cfg
argument_list|,
operator|&
name|authz_ref
operator|->
name|authz_key
argument_list|,
name|authz_pool
operator|->
name|config_pool
argument_list|,
name|path
argument_list|,
name|must_exist
argument_list|,
name|TRUE
argument_list|,
name|preferred_repos
argument_list|,
name|authz_ref_pool
argument_list|)
argument_list|)
expr_stmt|;
name|have_all_keys
operator|=
name|authz_ref
operator|->
name|authz_key
operator|!=
name|NULL
expr_stmt|;
if|if
condition|(
name|groups_path
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_repos__config_pool_get
argument_list|(
operator|&
name|authz_ref
operator|->
name|groups_cfg
argument_list|,
operator|&
name|authz_ref
operator|->
name|groups_key
argument_list|,
name|authz_pool
operator|->
name|config_pool
argument_list|,
name|groups_path
argument_list|,
name|must_exist
argument_list|,
name|TRUE
argument_list|,
name|preferred_repos
argument_list|,
name|authz_ref_pool
argument_list|)
argument_list|)
expr_stmt|;
name|have_all_keys
operator|&=
name|authz_ref
operator|->
name|groups_key
operator|!=
name|NULL
expr_stmt|;
block|}
comment|/* fall back to standard implementation in case we don't have all the    * facts (i.e. keys). */
if|if
condition|(
operator|!
name|have_all_keys
condition|)
return|return
name|svn_error_trace
argument_list|(
name|svn_repos_authz_read2
argument_list|(
name|authz_p
argument_list|,
name|path
argument_list|,
name|groups_path
argument_list|,
name|must_exist
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
comment|/* all keys are known and lookup is unambigious. */
name|authz_ref
operator|->
name|key
operator|=
name|construct_key
argument_list|(
name|authz_ref
operator|->
name|authz_key
argument_list|,
name|authz_ref
operator|->
name|groups_key
argument_list|,
name|authz_ref_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_object_pool__lookup
argument_list|(
operator|(
name|void
operator|*
operator|*
operator|)
name|authz_p
argument_list|,
name|authz_pool
operator|->
name|object_pool
argument_list|,
name|authz_ref
operator|->
name|key
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|authz_p
condition|)
block|{
name|svn_pool_destroy
argument_list|(
name|authz_ref_pool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|authz_ref
operator|->
name|authz
operator|=
name|apr_palloc
argument_list|(
name|authz_ref_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|authz_ref
operator|->
name|authz
argument_list|)
argument_list|)
expr_stmt|;
name|authz_ref
operator|->
name|authz
operator|->
name|cfg
operator|=
name|authz_ref
operator|->
name|authz_cfg
expr_stmt|;
if|if
condition|(
name|groups_path
condition|)
block|{
comment|/* Easy out: we prohibit local groups in the authz file when global          groups are being used. */
if|if
condition|(
name|svn_config_has_section
argument_list|(
name|authz_ref
operator|->
name|authz
operator|->
name|cfg
argument_list|,
name|SVN_CONFIG_SECTION_GROUPS
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_AUTHZ_INVALID_CONFIG
argument_list|,
name|NULL
argument_list|,
literal|"Error reading authz file '%s' with "
literal|"groups file '%s':"
literal|"Authz file cannot contain any groups "
literal|"when global groups are being used."
argument_list|,
name|path
argument_list|,
name|groups_path
argument_list|)
return|;
comment|/* We simply need to add the [Groups] section to the authz config.        */
name|svn_config__shallow_replace_section
argument_list|(
name|authz_ref
operator|->
name|authz
operator|->
name|cfg
argument_list|,
name|authz_ref
operator|->
name|groups_cfg
argument_list|,
name|SVN_CONFIG_SECTION_GROUPS
argument_list|)
expr_stmt|;
block|}
comment|/* Make sure there are no errors in the configuration. */
name|SVN_ERR
argument_list|(
name|svn_repos__authz_validate
argument_list|(
name|authz_ref
operator|->
name|authz
argument_list|,
name|authz_ref_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_object_pool__insert
argument_list|(
operator|(
name|void
operator|*
operator|*
operator|)
name|authz_p
argument_list|,
name|authz_pool
operator|->
name|object_pool
argument_list|,
name|authz_ref
operator|->
name|key
argument_list|,
name|authz_ref
argument_list|,
name|NULL
argument_list|,
name|authz_ref_pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


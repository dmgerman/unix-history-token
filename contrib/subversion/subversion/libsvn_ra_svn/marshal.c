begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * marshal.c :  Marshalling routines for Subversion protocol  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_escape
end_escape

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_define
define|#
directive|define
name|APR_WANT_STRFUNC
end_define

begin_include
include|#
directive|include
file|<apr_want.h>
end_include

begin_include
include|#
directive|include
file|<apr_general.h>
end_include

begin_include
include|#
directive|include
file|<apr_lib.h>
end_include

begin_include
include|#
directive|include
file|<apr_strings.h>
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_types.h"
end_include

begin_include
include|#
directive|include
file|"svn_string.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_ra_svn.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"svn_ctype.h"
end_include

begin_include
include|#
directive|include
file|"svn_sorts.h"
end_include

begin_include
include|#
directive|include
file|"svn_time.h"
end_include

begin_include
include|#
directive|include
file|"ra_svn.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_string_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_dep_compat.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_error_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_subr_private.h"
end_include

begin_define
define|#
directive|define
name|svn_iswhitespace
parameter_list|(
name|c
parameter_list|)
value|((c) == ' ' || (c) == '\n')
end_define

begin_comment
comment|/* If we receive data that *claims* to be followed by a very long string,  * we should not trust that claim right away. But everything up to 1 MB  * should be too small to be instrumental for a DOS attack. */
end_comment

begin_define
define|#
directive|define
name|SUSPICIOUSLY_HUGE_STRING_SIZE_THRESHOLD
value|(0x100000)
end_define

begin_comment
comment|/* We don't use "words" longer than this in our protocol.  The longest word  * we are currently using is only about 16 chars long but we leave room for  * longer future capability and command names.  */
end_comment

begin_define
define|#
directive|define
name|MAX_WORD_LENGTH
value|31
end_define

begin_comment
comment|/* The generic parsers will use the following value to limit the recursion  * depth to some reasonable value.  The current protocol implementation  * actually uses only maximum item nesting level of around 5.  So, there is  * plenty of headroom here.  */
end_comment

begin_define
define|#
directive|define
name|ITEM_NESTING_LIMIT
value|64
end_define

begin_comment
comment|/* Return the APR socket timeout to be used for the connection depending  * on whether there is a blockage handler or zero copy has been activated. */
end_comment

begin_function
specifier|static
name|apr_interval_time_t
name|get_timeout
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|)
block|{
return|return
name|conn
operator|->
name|block_handler
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/* --- CONNECTION INITIALIZATION --- */
end_comment

begin_function
name|svn_ra_svn_conn_t
modifier|*
name|svn_ra_svn_create_conn4
parameter_list|(
name|apr_socket_t
modifier|*
name|sock
parameter_list|,
name|svn_stream_t
modifier|*
name|in_stream
parameter_list|,
name|svn_stream_t
modifier|*
name|out_stream
parameter_list|,
name|int
name|compression_level
parameter_list|,
name|apr_size_t
name|zero_copy_limit
parameter_list|,
name|apr_size_t
name|error_check_interval
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_ra_svn_conn_t
modifier|*
name|conn
decl_stmt|;
name|void
modifier|*
name|mem
init|=
name|apr_palloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|conn
argument_list|)
operator|+
name|SVN_RA_SVN__PAGE_SIZE
argument_list|)
decl_stmt|;
name|conn
operator|=
operator|(
name|void
operator|*
operator|)
name|APR_ALIGN
argument_list|(
operator|(
name|apr_uintptr_t
operator|)
name|mem
argument_list|,
name|SVN_RA_SVN__PAGE_SIZE
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|sock
operator|&&
operator|!
name|in_stream
operator|&&
operator|!
name|out_stream
operator|)
operator|||
operator|(
operator|!
name|sock
operator|&&
name|in_stream
operator|&&
name|out_stream
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SVN_HAVE_SASL
name|conn
operator|->
name|sock
operator|=
name|sock
expr_stmt|;
name|conn
operator|->
name|encrypted
operator|=
name|FALSE
expr_stmt|;
endif|#
directive|endif
name|conn
operator|->
name|session
operator|=
name|NULL
expr_stmt|;
name|conn
operator|->
name|read_ptr
operator|=
name|conn
operator|->
name|read_buf
expr_stmt|;
name|conn
operator|->
name|read_end
operator|=
name|conn
operator|->
name|read_buf
expr_stmt|;
name|conn
operator|->
name|write_pos
operator|=
literal|0
expr_stmt|;
name|conn
operator|->
name|written_since_error_check
operator|=
literal|0
expr_stmt|;
name|conn
operator|->
name|error_check_interval
operator|=
name|error_check_interval
expr_stmt|;
name|conn
operator|->
name|may_check_for_error
operator|=
name|error_check_interval
operator|==
literal|0
expr_stmt|;
name|conn
operator|->
name|block_handler
operator|=
name|NULL
expr_stmt|;
name|conn
operator|->
name|block_baton
operator|=
name|NULL
expr_stmt|;
name|conn
operator|->
name|capabilities
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
name|conn
operator|->
name|compression_level
operator|=
name|compression_level
expr_stmt|;
name|conn
operator|->
name|zero_copy_limit
operator|=
name|zero_copy_limit
expr_stmt|;
name|conn
operator|->
name|pool
operator|=
name|result_pool
expr_stmt|;
if|if
condition|(
name|sock
operator|!=
name|NULL
condition|)
block|{
name|apr_sockaddr_t
modifier|*
name|sa
decl_stmt|;
name|conn
operator|->
name|stream
operator|=
name|svn_ra_svn__stream_from_sock
argument_list|(
name|sock
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|apr_socket_addr_get
argument_list|(
operator|&
name|sa
argument_list|,
name|APR_REMOTE
argument_list|,
name|sock
argument_list|)
operator|==
name|APR_SUCCESS
operator|&&
name|apr_sockaddr_ip_get
argument_list|(
operator|&
name|conn
operator|->
name|remote_ip
argument_list|,
name|sa
argument_list|)
operator|==
name|APR_SUCCESS
operator|)
condition|)
name|conn
operator|->
name|remote_ip
operator|=
name|NULL
expr_stmt|;
name|svn_ra_svn__stream_timeout
argument_list|(
name|conn
operator|->
name|stream
argument_list|,
name|get_timeout
argument_list|(
name|conn
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|conn
operator|->
name|stream
operator|=
name|svn_ra_svn__stream_from_streams
argument_list|(
name|in_stream
argument_list|,
name|out_stream
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|conn
operator|->
name|remote_ip
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|conn
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn_set_capabilities
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|list
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|svn_ra_svn_item_t
modifier|*
name|item
decl_stmt|;
specifier|const
name|char
modifier|*
name|word
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|list
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|item
operator|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|list
argument_list|,
name|i
argument_list|,
name|svn_ra_svn_item_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|item
operator|->
name|kind
operator|!=
name|SVN_RA_SVN_WORD
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Capability entry is not a word"
argument_list|)
argument_list|)
return|;
name|word
operator|=
name|apr_pstrdup
argument_list|(
name|conn
operator|->
name|pool
argument_list|,
name|item
operator|->
name|u
operator|.
name|word
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|conn
operator|->
name|capabilities
argument_list|,
name|word
argument_list|,
name|word
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|apr_pool_t
modifier|*
name|svn_ra_svn__get_pool
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|)
block|{
return|return
name|conn
operator|->
name|pool
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__set_shim_callbacks
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|svn_delta_shim_callbacks_t
modifier|*
name|shim_callbacks
parameter_list|)
block|{
name|conn
operator|->
name|shim_callbacks
operator|=
name|shim_callbacks
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_boolean_t
name|svn_ra_svn_has_capability
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|capability
parameter_list|)
block|{
return|return
operator|(
name|svn_hash_gets
argument_list|(
name|conn
operator|->
name|capabilities
argument_list|,
name|capability
argument_list|)
operator|!=
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|int
name|svn_ra_svn_compression_level
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|)
block|{
return|return
name|conn
operator|->
name|compression_level
return|;
block|}
end_function

begin_function
name|apr_size_t
name|svn_ra_svn_zero_copy_limit
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|)
block|{
return|return
name|conn
operator|->
name|zero_copy_limit
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_ra_svn_conn_remote_host
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|)
block|{
return|return
name|conn
operator|->
name|remote_ip
return|;
block|}
end_function

begin_function
name|void
name|svn_ra_svn__set_block_handler
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|ra_svn_block_handler_t
name|handler
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|)
block|{
name|conn
operator|->
name|block_handler
operator|=
name|handler
expr_stmt|;
name|conn
operator|->
name|block_baton
operator|=
name|baton
expr_stmt|;
name|svn_ra_svn__stream_timeout
argument_list|(
name|conn
operator|->
name|stream
argument_list|,
name|get_timeout
argument_list|(
name|conn
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__data_available
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|svn_boolean_t
modifier|*
name|data_available
parameter_list|)
block|{
return|return
name|svn_ra_svn__stream_data_available
argument_list|(
name|conn
operator|->
name|stream
argument_list|,
name|data_available
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* --- WRITE BUFFER MANAGEMENT --- */
end_comment

begin_comment
comment|/* Write data to socket or output file as appropriate. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|writebuf_output
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|,
name|apr_size_t
name|len
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|end
init|=
name|data
operator|+
name|len
decl_stmt|;
name|apr_size_t
name|count
decl_stmt|;
name|apr_pool_t
modifier|*
name|subpool
init|=
name|NULL
decl_stmt|;
name|svn_ra_svn__session_baton_t
modifier|*
name|session
init|=
name|conn
operator|->
name|session
decl_stmt|;
while|while
condition|(
name|data
operator|<
name|end
condition|)
block|{
name|count
operator|=
name|end
operator|-
name|data
expr_stmt|;
if|if
condition|(
name|session
operator|&&
name|session
operator|->
name|callbacks
operator|&&
name|session
operator|->
name|callbacks
operator|->
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
call|(
name|session
operator|->
name|callbacks
operator|->
name|cancel_func
call|)
argument_list|(
name|session
operator|->
name|callbacks_baton
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__stream_write
argument_list|(
name|conn
operator|->
name|stream
argument_list|,
name|data
argument_list|,
operator|&
name|count
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|subpool
condition|)
name|subpool
operator|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
expr_stmt|;
else|else
name|svn_pool_clear
argument_list|(
name|subpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|conn
operator|->
name|block_handler
argument_list|(
name|conn
argument_list|,
name|subpool
argument_list|,
name|conn
operator|->
name|block_baton
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|data
operator|+=
name|count
expr_stmt|;
if|if
condition|(
name|session
condition|)
block|{
specifier|const
name|svn_ra_callbacks2_t
modifier|*
name|cb
init|=
name|session
operator|->
name|callbacks
decl_stmt|;
name|session
operator|->
name|bytes_written
operator|+=
name|count
expr_stmt|;
if|if
condition|(
name|cb
operator|&&
name|cb
operator|->
name|progress_func
condition|)
call|(
name|cb
operator|->
name|progress_func
call|)
argument_list|(
name|session
operator|->
name|bytes_written
operator|+
name|session
operator|->
name|bytes_read
argument_list|,
operator|-
literal|1
argument_list|,
name|cb
operator|->
name|progress_baton
argument_list|,
name|subpool
argument_list|)
expr_stmt|;
block|}
block|}
name|conn
operator|->
name|written_since_error_check
operator|+=
name|len
expr_stmt|;
name|conn
operator|->
name|may_check_for_error
operator|=
name|conn
operator|->
name|written_since_error_check
operator|>=
name|conn
operator|->
name|error_check_interval
expr_stmt|;
if|if
condition|(
name|subpool
condition|)
name|svn_pool_destroy
argument_list|(
name|subpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Write data from the write buffer out to the socket. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|writebuf_flush
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_size_t
name|write_pos
init|=
name|conn
operator|->
name|write_pos
decl_stmt|;
comment|/* Clear conn->write_pos first in case the block handler does a read. */
name|conn
operator|->
name|write_pos
operator|=
literal|0
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_output
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|conn
operator|->
name|write_buf
argument_list|,
name|write_pos
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|writebuf_write
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|,
name|apr_size_t
name|len
parameter_list|)
block|{
comment|/* data>= 8k is sent immediately */
if|if
condition|(
name|len
operator|>=
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|write_buf
argument_list|)
operator|/
literal|2
condition|)
block|{
if|if
condition|(
name|conn
operator|->
name|write_pos
operator|>
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|writebuf_flush
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|writebuf_output
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
return|;
block|}
comment|/* ensure room for the data to add */
if|if
condition|(
name|conn
operator|->
name|write_pos
operator|+
name|len
operator|>
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|write_buf
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|writebuf_flush
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* buffer the new data block as well */
name|memcpy
argument_list|(
name|conn
operator|->
name|write_buf
operator|+
name|conn
operator|->
name|write_pos
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|conn
operator|->
name|write_pos
operator|+=
name|len
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Write STRING_LITERAL, which is a string literal argument.     Note: The purpose of the empty string "" in the macro definition is to    assert that STRING_LITERAL is in fact a string literal. Otherwise, the    string concatenation attempt should produce a compile-time error. */
end_comment

begin_define
define|#
directive|define
name|writebuf_write_literal
parameter_list|(
name|conn
parameter_list|,
name|pool
parameter_list|,
name|string_literal
parameter_list|)
define|\
value|writebuf_write(conn, pool, string_literal, sizeof(string_literal "") - 1)
end_define

begin_function
specifier|static
name|APR_INLINE
name|svn_error_t
modifier|*
name|writebuf_writechar
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|char
name|data
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|->
name|write_pos
operator|<
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|write_buf
argument_list|)
condition|)
block|{
name|conn
operator|->
name|write_buf
index|[
name|conn
operator|->
name|write_pos
index|]
operator|=
name|data
expr_stmt|;
name|conn
operator|->
name|write_pos
operator|++
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
else|else
block|{
name|char
name|temp
init|=
name|data
decl_stmt|;
return|return
name|writebuf_write
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|temp
argument_list|,
literal|1
argument_list|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* --- READ BUFFER MANAGEMENT --- */
end_comment

begin_comment
comment|/* Read bytes into DATA until either the read buffer is empty or  * we reach END. */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|readbuf_drain
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|end
parameter_list|)
block|{
name|apr_ssize_t
name|buflen
decl_stmt|,
name|copylen
decl_stmt|;
name|buflen
operator|=
name|conn
operator|->
name|read_end
operator|-
name|conn
operator|->
name|read_ptr
expr_stmt|;
name|copylen
operator|=
operator|(
name|buflen
operator|<
name|end
operator|-
name|data
operator|)
condition|?
name|buflen
else|:
name|end
operator|-
name|data
expr_stmt|;
name|memcpy
argument_list|(
name|data
argument_list|,
name|conn
operator|->
name|read_ptr
argument_list|,
name|copylen
argument_list|)
expr_stmt|;
name|conn
operator|->
name|read_ptr
operator|+=
name|copylen
expr_stmt|;
return|return
name|data
operator|+
name|copylen
return|;
block|}
end_function

begin_comment
comment|/* Read data from socket or input file as appropriate. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|readbuf_input
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|apr_size_t
modifier|*
name|len
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_ra_svn__session_baton_t
modifier|*
name|session
init|=
name|conn
operator|->
name|session
decl_stmt|;
if|if
condition|(
name|session
operator|&&
name|session
operator|->
name|callbacks
operator|&&
name|session
operator|->
name|callbacks
operator|->
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
call|(
name|session
operator|->
name|callbacks
operator|->
name|cancel_func
call|)
argument_list|(
name|session
operator|->
name|callbacks_baton
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__stream_read
argument_list|(
name|conn
operator|->
name|stream
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|len
operator|==
literal|0
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_CONNECTION_CLOSED
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
if|if
condition|(
name|session
condition|)
block|{
specifier|const
name|svn_ra_callbacks2_t
modifier|*
name|cb
init|=
name|session
operator|->
name|callbacks
decl_stmt|;
name|session
operator|->
name|bytes_read
operator|+=
operator|*
name|len
expr_stmt|;
if|if
condition|(
name|cb
operator|&&
name|cb
operator|->
name|progress_func
condition|)
call|(
name|cb
operator|->
name|progress_func
call|)
argument_list|(
name|session
operator|->
name|bytes_read
operator|+
name|session
operator|->
name|bytes_written
argument_list|,
operator|-
literal|1
argument_list|,
name|cb
operator|->
name|progress_baton
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Treat the next LEN input bytes from CONN as "read" */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|readbuf_skip
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_uint64_t
name|len
parameter_list|)
block|{
do|do
block|{
name|apr_size_t
name|buflen
init|=
name|conn
operator|->
name|read_end
operator|-
name|conn
operator|->
name|read_ptr
decl_stmt|;
name|apr_size_t
name|copylen
init|=
operator|(
name|buflen
operator|<
name|len
operator|)
condition|?
name|buflen
else|:
operator|(
name|apr_size_t
operator|)
name|len
decl_stmt|;
name|conn
operator|->
name|read_ptr
operator|+=
name|copylen
expr_stmt|;
name|len
operator|-=
name|copylen
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
break|break;
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|read_buf
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__stream_read
argument_list|(
name|conn
operator|->
name|stream
argument_list|,
name|conn
operator|->
name|read_buf
argument_list|,
operator|&
name|buflen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buflen
operator|==
literal|0
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_CONNECTION_CLOSED
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
name|conn
operator|->
name|read_end
operator|=
name|conn
operator|->
name|read_buf
operator|+
name|buflen
expr_stmt|;
name|conn
operator|->
name|read_ptr
operator|=
name|conn
operator|->
name|read_buf
expr_stmt|;
block|}
do|while
condition|(
name|len
operator|>
literal|0
condition|)
do|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Read data from the socket into the read buffer, which must be empty. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|readbuf_fill
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_size_t
name|len
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|conn
operator|->
name|read_ptr
operator|==
name|conn
operator|->
name|read_end
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|write_pos
condition|)
name|SVN_ERR
argument_list|(
name|writebuf_flush
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|read_buf
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|readbuf_input
argument_list|(
name|conn
argument_list|,
name|conn
operator|->
name|read_buf
argument_list|,
operator|&
name|len
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|conn
operator|->
name|read_ptr
operator|=
name|conn
operator|->
name|read_buf
expr_stmt|;
name|conn
operator|->
name|read_end
operator|=
name|conn
operator|->
name|read_buf
operator|+
name|len
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* This is a hot function calling a cold function.  GCC and others tend to  * inline the cold sub-function instead of this hot one.  Therefore, be  * very insistent on lining this one.  It is not a correctness issue, though.  */
end_comment

begin_function
specifier|static
name|SVN__FORCE_INLINE
name|svn_error_t
modifier|*
name|readbuf_getchar
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|char
modifier|*
name|result
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|->
name|read_ptr
operator|==
name|conn
operator|->
name|read_end
condition|)
name|SVN_ERR
argument_list|(
name|readbuf_fill
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|result
operator|=
operator|*
name|conn
operator|->
name|read_ptr
operator|++
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|readbuf_getchar_skip_whitespace
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|char
modifier|*
name|result
parameter_list|)
block|{
do|do
name|SVN_ERR
argument_list|(
name|readbuf_getchar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|result
argument_list|)
argument_list|)
expr_stmt|;
do|while
condition|(
name|svn_iswhitespace
argument_list|(
operator|*
name|result
argument_list|)
condition|)
do|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Read the next LEN bytes from CONN and copy them to *DATA. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|readbuf_read
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|apr_size_t
name|len
parameter_list|)
block|{
name|char
modifier|*
name|end
init|=
name|data
operator|+
name|len
decl_stmt|;
name|apr_size_t
name|count
decl_stmt|;
comment|/* Copy in an appropriate amount of data from the buffer. */
name|data
operator|=
name|readbuf_drain
argument_list|(
name|conn
argument_list|,
name|data
argument_list|,
name|end
argument_list|)
expr_stmt|;
comment|/* Read large chunks directly into buffer. */
while|while
condition|(
name|end
operator|-
name|data
operator|>
operator|(
name|apr_ssize_t
operator|)
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|read_buf
argument_list|)
condition|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_flush
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|count
operator|=
name|end
operator|-
name|data
expr_stmt|;
name|SVN_ERR
argument_list|(
name|readbuf_input
argument_list|(
name|conn
argument_list|,
name|data
argument_list|,
operator|&
name|count
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|+=
name|count
expr_stmt|;
block|}
while|while
condition|(
name|end
operator|>
name|data
condition|)
block|{
comment|/* The remaining amount to read is small; fill the buffer and        * copy from that. */
name|SVN_ERR
argument_list|(
name|readbuf_fill
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|=
name|readbuf_drain
argument_list|(
name|conn
argument_list|,
name|data
argument_list|,
name|end
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|readbuf_skip_leading_garbage
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
comment|/* Must be smaller than sizeof(conn->read_buf) - 1. */
specifier|const
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|apr_size_t
name|len
decl_stmt|;
name|svn_boolean_t
name|lparen
init|=
name|FALSE
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|conn
operator|->
name|read_ptr
operator|==
name|conn
operator|->
name|read_end
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
comment|/* Read some data directly from the connection input source. */
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|readbuf_input
argument_list|(
name|conn
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|len
expr_stmt|;
comment|/* Scan the data for '(' WS with a very simple state machine. */
for|for
control|(
name|p
operator|=
name|buf
init|;
name|p
operator|<
name|end
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
name|lparen
operator|&&
name|svn_iswhitespace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
break|break;
else|else
name|lparen
operator|=
operator|(
operator|*
name|p
operator|==
literal|'('
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|<
name|end
condition|)
break|break;
block|}
comment|/* p now points to the whitespace just after the left paren.  Fake    * up the left paren and then copy what we have into the read    * buffer. */
name|conn
operator|->
name|read_buf
index|[
literal|0
index|]
operator|=
literal|'('
expr_stmt|;
name|memcpy
argument_list|(
name|conn
operator|->
name|read_buf
operator|+
literal|1
argument_list|,
name|p
argument_list|,
name|end
operator|-
name|p
argument_list|)
expr_stmt|;
name|conn
operator|->
name|read_ptr
operator|=
name|conn
operator|->
name|read_buf
expr_stmt|;
name|conn
operator|->
name|read_end
operator|=
name|conn
operator|->
name|read_buf
operator|+
literal|1
operator|+
operator|(
name|end
operator|-
name|p
operator|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* --- WRITING DATA ITEMS --- */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_number
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_uint64_t
name|number
parameter_list|,
name|char
name|follow
parameter_list|)
block|{
name|apr_size_t
name|written
decl_stmt|;
comment|/* SVN_INT64_BUFFER_SIZE includes space for a terminating NUL that    * svn__ui64toa will always append. */
if|if
condition|(
name|conn
operator|->
name|write_pos
operator|+
name|SVN_INT64_BUFFER_SIZE
operator|>=
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|write_buf
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|writebuf_flush
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|written
operator|=
name|svn__ui64toa
argument_list|(
name|conn
operator|->
name|write_buf
operator|+
name|conn
operator|->
name|write_pos
argument_list|,
name|number
argument_list|)
expr_stmt|;
name|conn
operator|->
name|write_buf
index|[
name|conn
operator|->
name|write_pos
operator|+
name|written
index|]
operator|=
name|follow
expr_stmt|;
name|conn
operator|->
name|write_pos
operator|+=
name|written
operator|+
literal|1
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_number
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_uint64_t
name|number
parameter_list|)
block|{
return|return
name|write_number
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|number
argument_list|,
literal|' '
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|svn_ra_svn__write_ncstring
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|apr_size_t
name|len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
literal|10
condition|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_writechar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
call|(
name|char
call|)
argument_list|(
name|len
operator|+
literal|'0'
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_writechar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|':'
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|write_number
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|len
argument_list|,
literal|':'
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|s
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_writechar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|' '
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_string
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|str
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_ra_svn__write_ncstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|str
operator|->
name|data
argument_list|,
name|str
operator|->
name|len
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cstring
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|s
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_ra_svn__write_ncstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|s
argument_list|,
name|strlen
argument_list|(
name|s
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_word
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|word
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|word
argument_list|,
name|strlen
argument_list|(
name|word
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_writechar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|' '
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_boolean
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_boolean_t
name|value
parameter_list|)
block|{
if|if
condition|(
name|value
condition|)
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"true "
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"false "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_proplist
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|)
block|{
name|apr_hash_index_t
modifier|*
name|hi
decl_stmt|;
specifier|const
name|char
modifier|*
name|propname
decl_stmt|;
name|svn_string_t
modifier|*
name|propval
decl_stmt|;
name|apr_size_t
name|len
decl_stmt|;
comment|/* One might use an iterpool here but that would only be used when the      send buffer gets flushed and only by the CONN's progress callback.      That should happen at most once for typical prop lists and even then      use only a few bytes at best.    */
if|if
condition|(
name|props
condition|)
for|for
control|(
name|hi
operator|=
name|apr_hash_first
argument_list|(
name|pool
argument_list|,
name|props
argument_list|)
init|;
name|hi
condition|;
name|hi
operator|=
name|apr_hash_next
argument_list|(
name|hi
argument_list|)
control|)
block|{
name|apr_hash_this
argument_list|(
name|hi
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|propname
argument_list|,
operator|(
name|apr_ssize_t
operator|*
operator|)
operator|&
name|len
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|propval
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__write_ncstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|propname
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__write_string
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|propval
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__start_list
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|->
name|write_pos
operator|+
literal|2
operator|<=
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|write_buf
argument_list|)
condition|)
block|{
name|conn
operator|->
name|write_buf
index|[
name|conn
operator|->
name|write_pos
index|]
operator|=
literal|'('
expr_stmt|;
name|conn
operator|->
name|write_buf
index|[
name|conn
operator|->
name|write_pos
operator|+
literal|1
index|]
operator|=
literal|' '
expr_stmt|;
name|conn
operator|->
name|write_pos
operator|+=
literal|2
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|writebuf_write
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( "
argument_list|,
literal|2
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__end_list
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|->
name|write_pos
operator|+
literal|2
operator|<=
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|write_buf
argument_list|)
condition|)
block|{
name|conn
operator|->
name|write_buf
index|[
name|conn
operator|->
name|write_pos
index|]
operator|=
literal|')'
expr_stmt|;
name|conn
operator|->
name|write_buf
index|[
name|conn
operator|->
name|write_pos
operator|+
literal|1
index|]
operator|=
literal|' '
expr_stmt|;
name|conn
operator|->
name|write_pos
operator|+=
literal|2
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|writebuf_write
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") "
argument_list|,
literal|2
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__flush
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_flush
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|conn
operator|->
name|may_check_for_error
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* --- WRITING TUPLES --- */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|vwrite_tuple_cstring
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|va_list
modifier|*
name|ap
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cstr
init|=
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|cstr
argument_list|)
expr_stmt|;
return|return
name|svn_ra_svn__write_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|cstr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|vwrite_tuple_cstring_opt
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|va_list
modifier|*
name|ap
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cstr
init|=
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
return|return
name|cstr
condition|?
name|svn_ra_svn__write_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|cstr
argument_list|)
else|:
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|vwrite_tuple_string
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|va_list
modifier|*
name|ap
parameter_list|)
block|{
specifier|const
name|svn_string_t
modifier|*
name|str
init|=
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
specifier|const
name|svn_string_t
operator|*
argument_list|)
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
name|svn_ra_svn__write_string
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|str
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|vwrite_tuple_string_opt
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|va_list
modifier|*
name|ap
parameter_list|)
block|{
specifier|const
name|svn_string_t
modifier|*
name|str
init|=
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
specifier|const
name|svn_string_t
operator|*
argument_list|)
decl_stmt|;
return|return
name|str
condition|?
name|svn_ra_svn__write_string
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|str
argument_list|)
else|:
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|vwrite_tuple_word
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|va_list
modifier|*
name|ap
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cstr
init|=
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|cstr
argument_list|)
expr_stmt|;
return|return
name|svn_ra_svn__write_word
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|cstr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|vwrite_tuple_word_opt
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|va_list
modifier|*
name|ap
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cstr
init|=
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
return|return
name|cstr
condition|?
name|svn_ra_svn__write_word
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|cstr
argument_list|)
else|:
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|vwrite_tuple_revision
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|va_list
modifier|*
name|ap
parameter_list|)
block|{
name|svn_revnum_t
name|rev
init|=
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|svn_revnum_t
argument_list|)
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|rev
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_ra_svn__write_number
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|vwrite_tuple_revision_opt
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|va_list
modifier|*
name|ap
parameter_list|)
block|{
name|svn_revnum_t
name|rev
init|=
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|svn_revnum_t
argument_list|)
decl_stmt|;
return|return
name|SVN_IS_VALID_REVNUM
argument_list|(
name|rev
argument_list|)
condition|?
name|svn_ra_svn__write_number
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
else|:
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|vwrite_tuple_number
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|va_list
modifier|*
name|ap
parameter_list|)
block|{
return|return
name|svn_ra_svn__write_number
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|apr_uint64_t
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|vwrite_tuple_boolean
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|va_list
modifier|*
name|ap
parameter_list|)
block|{
return|return
name|svn_ra_svn__write_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|svn_boolean_t
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_tuple_cstring
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|cstr
parameter_list|)
block|{
name|SVN_ERR_ASSERT
argument_list|(
name|cstr
argument_list|)
expr_stmt|;
return|return
name|svn_ra_svn__write_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|cstr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_tuple_cstring_opt
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|cstr
parameter_list|)
block|{
return|return
name|cstr
condition|?
name|svn_ra_svn__write_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|cstr
argument_list|)
else|:
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_tuple_string
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|str
parameter_list|)
block|{
name|SVN_ERR_ASSERT
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
name|svn_ra_svn__write_string
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|str
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_tuple_string_opt
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|str
parameter_list|)
block|{
return|return
name|str
condition|?
name|svn_ra_svn__write_string
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|str
argument_list|)
else|:
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_tuple_start_list
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_ra_svn__start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_tuple_end_list
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_ra_svn__end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_tuple_revision
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|SVN_ERR_ASSERT
argument_list|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|rev
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_ra_svn__write_number
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_tuple_revision_opt
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
return|return
name|SVN_IS_VALID_REVNUM
argument_list|(
name|rev
argument_list|)
condition|?
name|svn_ra_svn__write_number
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
else|:
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_tuple_boolean
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_boolean_t
name|value
parameter_list|)
block|{
return|return
name|svn_ra_svn__write_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|value
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_tuple_depth
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|)
block|{
return|return
name|svn_ra_svn__write_word
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|svn_depth_to_word
argument_list|(
name|depth
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_cmd_add_node
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|parent_token
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
specifier|const
name|char
modifier|*
name|copy_path
parameter_list|,
name|svn_revnum_t
name|copy_rev
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|parent_token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|copy_path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|copy_rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_cmd_open_node
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|parent_token
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|parent_token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_cmd_change_node_prop
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|value
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_string_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|value
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_cmd_absent_node
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|vwrite_tuple
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|va_list
modifier|*
name|ap
parameter_list|)
block|{
name|svn_boolean_t
name|opt
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
operator|*
name|fmt
operator|==
literal|'!'
condition|)
name|fmt
operator|++
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_ra_svn__start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
init|;
operator|*
name|fmt
condition|;
name|fmt
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|fmt
operator|==
literal|'c'
condition|)
name|SVN_ERR
argument_list|(
name|opt
condition|?
name|vwrite_tuple_cstring_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|ap
argument_list|)
else|:
name|vwrite_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|ap
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|fmt
operator|==
literal|'s'
condition|)
name|SVN_ERR
argument_list|(
name|opt
condition|?
name|vwrite_tuple_string_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|ap
argument_list|)
else|:
name|vwrite_tuple_string
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|ap
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|fmt
operator|==
literal|'('
operator|&&
operator|!
name|opt
condition|)
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|fmt
operator|==
literal|')'
condition|)
block|{
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|opt
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|fmt
operator|==
literal|'?'
condition|)
name|opt
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|fmt
operator|==
literal|'w'
condition|)
name|SVN_ERR
argument_list|(
name|opt
condition|?
name|vwrite_tuple_word_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|ap
argument_list|)
else|:
name|vwrite_tuple_word
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|ap
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|fmt
operator|==
literal|'r'
condition|)
name|SVN_ERR
argument_list|(
name|opt
condition|?
name|vwrite_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|ap
argument_list|)
else|:
name|vwrite_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|ap
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|fmt
operator|==
literal|'n'
operator|&&
operator|!
name|opt
condition|)
name|SVN_ERR
argument_list|(
name|vwrite_tuple_number
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|ap
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|fmt
operator|==
literal|'b'
operator|&&
operator|!
name|opt
condition|)
name|SVN_ERR
argument_list|(
name|vwrite_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|ap
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|fmt
operator|==
literal|'!'
operator|&&
operator|!
operator|*
operator|(
name|fmt
operator|+
literal|1
operator|)
condition|)
return|return
name|SVN_NO_ERROR
return|;
else|else
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_ra_svn__end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_tuple
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|err
operator|=
name|vwrite_tuple
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|fmt
argument_list|,
operator|&
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/* --- READING DATA ITEMS --- */
end_comment

begin_comment
comment|/* Read LEN bytes from CONN into already-allocated structure ITEM.  * Afterwards, *ITEM is of type 'SVN_RA_SVN_STRING', and its string  * data is allocated in POOL. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|read_string
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_ra_svn_item_t
modifier|*
name|item
parameter_list|,
name|apr_uint64_t
name|len64
parameter_list|)
block|{
name|apr_size_t
name|len
init|=
operator|(
name|apr_size_t
operator|)
name|len64
decl_stmt|;
name|apr_size_t
name|readbuf_len
decl_stmt|;
name|char
modifier|*
name|dest
decl_stmt|;
comment|/* We can't store strings longer than the maximum size of apr_size_t,    * so check for wrapping */
if|if
condition|(
name|len64
operator|>
name|APR_SIZE_MAX
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"String length larger than maximum"
argument_list|)
argument_list|)
return|;
comment|/* Shorter strings can be copied directly from the read buffer. */
if|if
condition|(
name|conn
operator|->
name|read_ptr
operator|+
name|len
operator|<=
name|conn
operator|->
name|read_end
condition|)
block|{
name|item
operator|->
name|kind
operator|=
name|SVN_RA_SVN_STRING
expr_stmt|;
name|item
operator|->
name|u
operator|.
name|string
operator|=
name|svn_string_ncreate
argument_list|(
name|conn
operator|->
name|read_ptr
argument_list|,
name|len
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|conn
operator|->
name|read_ptr
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
comment|/* Read the string in chunks.  The chunk size is large enough to avoid        * re-allocation in typical cases, and small enough to ensure we do        * not pre-allocate an unreasonable amount of memory if (perhaps due        * to network data corruption or a DOS attack), we receive a bogus        * claim that a very long string is going to follow.  In that case, we        * start small and wait for all that data to actually show up.  This        * does not fully prevent DOS attacks but makes them harder (you have        * to actually send gigabytes of data). */
name|svn_stringbuf_t
modifier|*
name|stringbuf
init|=
name|svn_stringbuf_create_empty
argument_list|(
name|pool
argument_list|)
decl_stmt|;
comment|/* Read string data directly into the string structure.        * Do it iteratively.  */
do|do
block|{
comment|/* Determine length of chunk to read and re-alloc the buffer. */
name|readbuf_len
operator|=
name|len
operator|<
name|SUSPICIOUSLY_HUGE_STRING_SIZE_THRESHOLD
condition|?
name|len
else|:
name|SUSPICIOUSLY_HUGE_STRING_SIZE_THRESHOLD
expr_stmt|;
name|svn_stringbuf_ensure
argument_list|(
name|stringbuf
argument_list|,
name|stringbuf
operator|->
name|len
operator|+
name|readbuf_len
argument_list|)
expr_stmt|;
name|dest
operator|=
name|stringbuf
operator|->
name|data
operator|+
name|stringbuf
operator|->
name|len
expr_stmt|;
comment|/* read data& update length info */
name|SVN_ERR
argument_list|(
name|readbuf_read
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|dest
argument_list|,
name|readbuf_len
argument_list|)
argument_list|)
expr_stmt|;
name|stringbuf
operator|->
name|len
operator|+=
name|readbuf_len
expr_stmt|;
name|len
operator|-=
name|readbuf_len
expr_stmt|;
block|}
do|while
condition|(
name|len
condition|)
do|;
comment|/* zero-terminate the string */
name|stringbuf
operator|->
name|data
index|[
name|stringbuf
operator|->
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* Return the string properly wrapped into an RA_SVN item. */
name|item
operator|->
name|kind
operator|=
name|SVN_RA_SVN_STRING
expr_stmt|;
name|item
operator|->
name|u
operator|.
name|string
operator|=
name|svn_stringbuf__morph_into_string
argument_list|(
name|stringbuf
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Given the first non-whitespace character FIRST_CHAR, read an item  * into the already allocated structure ITEM.  LEVEL should be set  * to 0 for the first call and is used to enforce a recursion limit  * on the parser. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|read_item
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_ra_svn_item_t
modifier|*
name|item
parameter_list|,
name|char
name|first_char
parameter_list|,
name|int
name|level
parameter_list|)
block|{
name|char
name|c
init|=
name|first_char
decl_stmt|;
name|apr_uint64_t
name|val
decl_stmt|;
name|svn_ra_svn_item_t
modifier|*
name|listitem
decl_stmt|;
if|if
condition|(
operator|++
name|level
operator|>=
name|ITEM_NESTING_LIMIT
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Items are nested too deeply"
argument_list|)
argument_list|)
return|;
comment|/* Determine the item type and read it in.  Make sure that c is the    * first character at the end of the item so we can test to make    * sure it's whitespace. */
if|if
condition|(
name|svn_ctype_isdigit
argument_list|(
name|c
argument_list|)
condition|)
block|{
comment|/* It's a number or a string.  Read the number part, either way. */
name|val
operator|=
name|c
operator|-
literal|'0'
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|apr_uint64_t
name|prev_val
init|=
name|val
decl_stmt|;
name|SVN_ERR
argument_list|(
name|readbuf_getchar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_ctype_isdigit
argument_list|(
name|c
argument_list|)
condition|)
break|break;
name|val
operator|=
name|val
operator|*
literal|10
operator|+
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
comment|/* val wrapped past maximum value? */
if|if
condition|(
operator|(
name|prev_val
operator|>=
operator|(
name|APR_UINT64_MAX
operator|/
literal|10
operator|)
operator|)
operator|&&
operator|(
name|val
operator|<
name|APR_UINT64_MAX
operator|-
literal|10
operator|)
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Number is larger than maximum"
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|c
operator|==
literal|':'
condition|)
block|{
comment|/* It's a string. */
name|SVN_ERR
argument_list|(
name|read_string
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|item
argument_list|,
name|val
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|readbuf_getchar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* It's a number. */
name|item
operator|->
name|kind
operator|=
name|SVN_RA_SVN_NUMBER
expr_stmt|;
name|item
operator|->
name|u
operator|.
name|number
operator|=
name|val
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|svn_ctype_isalpha
argument_list|(
name|c
argument_list|)
condition|)
block|{
comment|/* It's a word.  Read it into a buffer of limited size. */
name|char
modifier|*
name|buffer
init|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
name|MAX_WORD_LENGTH
operator|+
literal|1
argument_list|)
decl_stmt|;
name|char
modifier|*
name|end
init|=
name|buffer
operator|+
name|MAX_WORD_LENGTH
decl_stmt|;
name|char
modifier|*
name|p
init|=
name|buffer
operator|+
literal|1
decl_stmt|;
name|buffer
index|[
literal|0
index|]
operator|=
name|c
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|SVN_ERR
argument_list|(
name|readbuf_getchar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_ctype_isalnum
argument_list|(
operator|*
name|p
argument_list|)
operator|&&
operator|*
name|p
operator|!=
literal|'-'
condition|)
break|break;
if|if
condition|(
operator|++
name|p
operator|==
name|end
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Word is too long"
argument_list|)
argument_list|)
return|;
block|}
name|c
operator|=
operator|*
name|p
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|item
operator|->
name|kind
operator|=
name|SVN_RA_SVN_WORD
expr_stmt|;
name|item
operator|->
name|u
operator|.
name|word
operator|=
name|buffer
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'('
condition|)
block|{
comment|/* Read in the list items. */
name|item
operator|->
name|kind
operator|=
name|SVN_RA_SVN_LIST
expr_stmt|;
name|item
operator|->
name|u
operator|.
name|list
operator|=
name|apr_array_make
argument_list|(
name|pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_ra_svn_item_t
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|SVN_ERR
argument_list|(
name|readbuf_getchar_skip_whitespace
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|')'
condition|)
break|break;
name|listitem
operator|=
name|apr_array_push
argument_list|(
name|item
operator|->
name|u
operator|.
name|list
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|read_item
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|listitem
argument_list|,
name|c
argument_list|,
name|level
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|readbuf_getchar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|svn_iswhitespace
argument_list|(
name|c
argument_list|)
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Malformed network data"
argument_list|)
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Given the first non-whitespace character FIRST_CHAR, read the first  * command (word) encountered in CONN into *ITEM.  If ITEM is NULL, skip  * to the end of the current list.  Use POOL for allocations. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|read_command_only
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|item
parameter_list|,
name|char
name|first_char
parameter_list|)
block|{
name|char
name|c
init|=
name|first_char
decl_stmt|;
comment|/* Determine the item type and read it in.  Make sure that c is the   * first character at the end of the item so we can test to make   * sure it's whitespace. */
if|if
condition|(
name|svn_ctype_isdigit
argument_list|(
name|c
argument_list|)
condition|)
block|{
comment|/* It's a number or a string.  Read the number part, either way. */
name|apr_uint64_t
name|val
decl_stmt|,
name|prev_val
init|=
literal|0
decl_stmt|;
name|val
operator|=
name|c
operator|-
literal|'0'
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|prev_val
operator|=
name|val
expr_stmt|;
name|SVN_ERR
argument_list|(
name|readbuf_getchar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_ctype_isdigit
argument_list|(
name|c
argument_list|)
condition|)
break|break;
name|val
operator|=
name|val
operator|*
literal|10
operator|+
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
if|if
condition|(
name|prev_val
operator|>=
operator|(
name|APR_UINT64_MAX
operator|/
literal|10
operator|)
condition|)
comment|/*> maximum value? */
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Number is larger than maximum"
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|c
operator|==
literal|':'
condition|)
block|{
comment|/* It's a string. */
name|SVN_ERR
argument_list|(
name|readbuf_skip
argument_list|(
name|conn
argument_list|,
name|val
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|readbuf_getchar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|svn_ctype_isalpha
argument_list|(
name|c
argument_list|)
condition|)
block|{
comment|/* It's a word. */
if|if
condition|(
name|item
condition|)
block|{
comment|/* This is the word we want to read */
name|char
modifier|*
name|buf
init|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
literal|32
argument_list|)
decl_stmt|;
name|apr_size_t
name|len
init|=
literal|1
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|c
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|SVN_ERR
argument_list|(
name|readbuf_getchar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_ctype_isalnum
argument_list|(
name|c
argument_list|)
operator|&&
name|c
operator|!=
literal|'-'
condition|)
break|break;
name|buf
index|[
name|len
index|]
operator|=
name|c
expr_stmt|;
if|if
condition|(
operator|++
name|len
operator|==
literal|32
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Word too long"
argument_list|)
argument_list|)
return|;
block|}
name|buf
index|[
name|len
index|]
operator|=
literal|0
expr_stmt|;
operator|*
name|item
operator|=
name|buf
expr_stmt|;
block|}
else|else
block|{
comment|/* we don't need the actual word, just skip it */
do|do
block|{
name|SVN_ERR
argument_list|(
name|readbuf_getchar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|svn_ctype_isalnum
argument_list|(
name|c
argument_list|)
operator|||
name|c
operator|==
literal|'-'
condition|)
do|;
block|}
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'('
condition|)
block|{
comment|/* Read in the list items. */
while|while
condition|(
literal|1
condition|)
block|{
name|SVN_ERR
argument_list|(
name|readbuf_getchar_skip_whitespace
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|')'
condition|)
break|break;
if|if
condition|(
name|item
operator|&&
operator|*
name|item
operator|==
name|NULL
condition|)
name|SVN_ERR
argument_list|(
name|read_command_only
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|item
argument_list|,
name|c
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|read_command_only
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|NULL
argument_list|,
name|c
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|readbuf_getchar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__read_item
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_ra_svn_item_t
modifier|*
modifier|*
name|item
parameter_list|)
block|{
name|char
name|c
decl_stmt|;
comment|/* Allocate space, read the first character, and then do the rest of    * the work.  This makes sense because of the way lists are read. */
operator|*
name|item
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|item
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|readbuf_getchar_skip_whitespace
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|read_item
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|*
name|item
argument_list|,
name|c
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Drain existing whitespace from the receive buffer of CONN until either    there is no data in the underlying receive socket anymore or we found    a non-whitespace char.  Set *HAS_ITEM to TRUE in the latter case.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|svn_ra_svn__has_item
parameter_list|(
name|svn_boolean_t
modifier|*
name|has_item
parameter_list|,
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
do|do
block|{
if|if
condition|(
name|conn
operator|->
name|read_ptr
operator|==
name|conn
operator|->
name|read_end
condition|)
block|{
name|svn_boolean_t
name|available
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|write_pos
condition|)
name|SVN_ERR
argument_list|(
name|writebuf_flush
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__data_available
argument_list|(
name|conn
argument_list|,
operator|&
name|available
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|available
condition|)
break|break;
name|SVN_ERR
argument_list|(
name|readbuf_fill
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
name|svn_iswhitespace
argument_list|(
operator|*
name|conn
operator|->
name|read_ptr
argument_list|)
operator|&&
operator|++
name|conn
operator|->
name|read_ptr
condition|)
do|;
operator|*
name|has_item
operator|=
name|conn
operator|->
name|read_ptr
operator|!=
name|conn
operator|->
name|read_end
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__skip_leading_garbage
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|readbuf_skip_leading_garbage
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* --- READING AND PARSING TUPLES --- */
end_comment

begin_comment
comment|/* Parse a tuple of svn_ra_svn_item_t *'s.  Advance *FMT to the end of the  * tuple specification and advance AP by the corresponding arguments. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|vparse_tuple
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|items
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|fmt
parameter_list|,
name|va_list
modifier|*
name|ap
parameter_list|)
block|{
name|int
name|count
decl_stmt|,
name|nesting_level
decl_stmt|;
name|svn_ra_svn_item_t
modifier|*
name|elt
decl_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
operator|*
operator|*
name|fmt
operator|&&
name|count
operator|<
name|items
operator|->
name|nelts
condition|;
operator|(
operator|*
name|fmt
operator|)
operator|++
operator|,
name|count
operator|++
control|)
block|{
comment|/* '?' just means the tuple may stop; skip past it. */
if|if
condition|(
operator|*
operator|*
name|fmt
operator|==
literal|'?'
condition|)
operator|(
operator|*
name|fmt
operator|)
operator|++
expr_stmt|;
name|elt
operator|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|items
argument_list|,
name|count
argument_list|,
name|svn_ra_svn_item_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|fmt
operator|==
literal|'('
operator|&&
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_LIST
condition|)
block|{
operator|(
operator|*
name|fmt
operator|)
operator|++
expr_stmt|;
name|SVN_ERR
argument_list|(
name|vparse_tuple
argument_list|(
name|elt
operator|->
name|u
operator|.
name|list
argument_list|,
name|pool
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
name|fmt
operator|==
literal|'c'
operator|&&
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_STRING
condition|)
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
specifier|const
name|char
operator|*
operator|*
argument_list|)
operator|=
name|elt
operator|->
name|u
operator|.
name|string
operator|->
name|data
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
operator|*
name|fmt
operator|==
literal|'s'
operator|&&
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_STRING
condition|)
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|svn_string_t
operator|*
operator|*
argument_list|)
operator|=
name|elt
operator|->
name|u
operator|.
name|string
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
operator|*
name|fmt
operator|==
literal|'w'
operator|&&
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_WORD
condition|)
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
specifier|const
name|char
operator|*
operator|*
argument_list|)
operator|=
name|elt
operator|->
name|u
operator|.
name|word
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
operator|*
name|fmt
operator|==
literal|'b'
operator|&&
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_WORD
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|elt
operator|->
name|u
operator|.
name|word
argument_list|,
literal|"true"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|svn_boolean_t
operator|*
argument_list|)
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|elt
operator|->
name|u
operator|.
name|word
argument_list|,
literal|"false"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|svn_boolean_t
operator|*
argument_list|)
operator|=
name|FALSE
expr_stmt|;
else|else
break|break;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
name|fmt
operator|==
literal|'n'
operator|&&
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_NUMBER
condition|)
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|apr_uint64_t
operator|*
argument_list|)
operator|=
name|elt
operator|->
name|u
operator|.
name|number
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
operator|*
name|fmt
operator|==
literal|'r'
operator|&&
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_NUMBER
condition|)
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|svn_revnum_t
operator|*
argument_list|)
operator|=
operator|(
name|svn_revnum_t
operator|)
name|elt
operator|->
name|u
operator|.
name|number
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
operator|*
name|fmt
operator|==
literal|'B'
operator|&&
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_WORD
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|elt
operator|->
name|u
operator|.
name|word
argument_list|,
literal|"true"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|apr_uint64_t
operator|*
argument_list|)
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|elt
operator|->
name|u
operator|.
name|word
argument_list|,
literal|"false"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|apr_uint64_t
operator|*
argument_list|)
operator|=
name|FALSE
expr_stmt|;
else|else
break|break;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
name|fmt
operator|==
literal|'3'
operator|&&
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_WORD
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|elt
operator|->
name|u
operator|.
name|word
argument_list|,
literal|"true"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|svn_tristate_t
operator|*
argument_list|)
operator|=
name|svn_tristate_true
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|elt
operator|->
name|u
operator|.
name|word
argument_list|,
literal|"false"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|svn_tristate_t
operator|*
argument_list|)
operator|=
name|svn_tristate_false
expr_stmt|;
else|else
break|break;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
name|fmt
operator|==
literal|'l'
operator|&&
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_LIST
condition|)
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|apr_array_header_t
operator|*
operator|*
argument_list|)
operator|=
name|elt
operator|->
name|u
operator|.
name|list
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
operator|*
name|fmt
operator|==
literal|')'
condition|)
return|return
name|SVN_NO_ERROR
return|;
else|else
break|break;
block|}
if|if
condition|(
operator|*
operator|*
name|fmt
operator|==
literal|'?'
condition|)
block|{
name|nesting_level
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
operator|*
operator|*
name|fmt
condition|;
operator|(
operator|*
name|fmt
operator|)
operator|++
control|)
block|{
switch|switch
condition|(
operator|*
operator|*
name|fmt
condition|)
block|{
case|case
literal|'?'
case|:
break|break;
case|case
literal|'r'
case|:
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|svn_revnum_t
operator|*
argument_list|)
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|svn_string_t
operator|*
operator|*
argument_list|)
operator|=
name|NULL
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
case|case
literal|'w'
case|:
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
specifier|const
name|char
operator|*
operator|*
argument_list|)
operator|=
name|NULL
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|apr_array_header_t
operator|*
operator|*
argument_list|)
operator|=
name|NULL
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
case|case
literal|'n'
case|:
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|apr_uint64_t
operator|*
argument_list|)
operator|=
name|SVN_RA_SVN_UNSPECIFIED_NUMBER
expr_stmt|;
break|break;
case|case
literal|'3'
case|:
operator|*
name|va_arg
argument_list|(
operator|*
name|ap
argument_list|,
name|svn_tristate_t
operator|*
argument_list|)
operator|=
name|svn_tristate_unknown
expr_stmt|;
break|break;
case|case
literal|'('
case|:
name|nesting_level
operator|++
expr_stmt|;
break|break;
case|case
literal|')'
case|:
if|if
condition|(
operator|--
name|nesting_level
operator|<
literal|0
condition|)
return|return
name|SVN_NO_ERROR
return|;
break|break;
default|default:
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|*
operator|*
name|fmt
operator|&&
operator|*
operator|*
name|fmt
operator|!=
literal|')'
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Malformed network data"
argument_list|)
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__parse_tuple
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|list
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|err
operator|=
name|vparse_tuple
argument_list|(
name|list
argument_list|,
name|pool
argument_list|,
operator|&
name|fmt
argument_list|,
operator|&
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__read_tuple
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|svn_ra_svn_item_t
modifier|*
name|item
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_item
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|item
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|item
operator|->
name|kind
operator|!=
name|SVN_RA_SVN_LIST
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Malformed network data"
argument_list|)
argument_list|)
return|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|err
operator|=
name|vparse_tuple
argument_list|(
name|item
operator|->
name|u
operator|.
name|list
argument_list|,
name|pool
argument_list|,
operator|&
name|fmt
argument_list|,
operator|&
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__read_command_only
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|command
parameter_list|)
block|{
name|char
name|c
decl_stmt|;
name|SVN_ERR
argument_list|(
name|readbuf_getchar_skip_whitespace
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|command
operator|=
name|NULL
expr_stmt|;
return|return
name|read_command_only
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|command
argument_list|,
name|c
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__parse_proplist
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|list
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|)
block|{
name|svn_string_t
modifier|*
name|name
decl_stmt|;
name|svn_string_t
modifier|*
name|value
decl_stmt|;
name|svn_ra_svn_item_t
modifier|*
name|elt
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|*
name|props
operator|=
name|svn_hash__make
argument_list|(
name|pool
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|list
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|elt
operator|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|list
argument_list|,
name|i
argument_list|,
name|svn_ra_svn_item_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|elt
operator|->
name|kind
operator|!=
name|SVN_RA_SVN_LIST
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Proplist element not a list"
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__parse_tuple
argument_list|(
name|elt
operator|->
name|u
operator|.
name|list
argument_list|,
name|pool
argument_list|,
literal|"ss"
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|value
argument_list|)
argument_list|)
expr_stmt|;
name|apr_hash_set
argument_list|(
operator|*
name|props
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* --- READING AND WRITING COMMANDS AND RESPONSES --- */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__locate_real_error_child
parameter_list|(
name|svn_error_t
modifier|*
name|err
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|this_link
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|err
argument_list|)
expr_stmt|;
for|for
control|(
name|this_link
operator|=
name|err
init|;
name|this_link
operator|&&
operator|(
name|this_link
operator|->
name|apr_err
operator|==
name|SVN_ERR_RA_SVN_CMD_ERR
operator|)
condition|;
name|this_link
operator|=
name|this_link
operator|->
name|child
control|)
empty_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|this_link
argument_list|)
expr_stmt|;
return|return
name|this_link
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__handle_failure_status
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|params
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|message
decl_stmt|,
modifier|*
name|file
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
name|svn_ra_svn_item_t
modifier|*
name|elt
decl_stmt|;
name|int
name|i
decl_stmt|;
name|apr_uint64_t
name|apr_err
decl_stmt|,
name|line
decl_stmt|;
name|apr_pool_t
modifier|*
name|subpool
init|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|params
operator|->
name|nelts
operator|==
literal|0
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Empty error list"
argument_list|)
argument_list|)
return|;
comment|/* Rebuild the error list from the end, to avoid reversing the order. */
for|for
control|(
name|i
operator|=
name|params
operator|->
name|nelts
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|svn_pool_clear
argument_list|(
name|subpool
argument_list|)
expr_stmt|;
name|elt
operator|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|params
argument_list|,
name|i
argument_list|,
name|svn_ra_svn_item_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|elt
operator|->
name|kind
operator|!=
name|SVN_RA_SVN_LIST
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Malformed error list"
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__parse_tuple
argument_list|(
name|elt
operator|->
name|u
operator|.
name|list
argument_list|,
name|subpool
argument_list|,
literal|"nccn"
argument_list|,
operator|&
name|apr_err
argument_list|,
operator|&
name|message
argument_list|,
operator|&
name|file
argument_list|,
operator|&
name|line
argument_list|)
argument_list|)
expr_stmt|;
comment|/* The message field should have been optional, but we can't          easily change that, so "" means a nonexistent message. */
if|if
condition|(
operator|!
operator|*
name|message
condition|)
name|message
operator|=
name|NULL
expr_stmt|;
comment|/* Skip over links in the error chain that were intended only to          exist on the server (to wrap real errors intended for the          client) but accidentally got included in the server's actual          response. */
if|if
condition|(
operator|(
name|apr_status_t
operator|)
name|apr_err
operator|!=
name|SVN_ERR_RA_SVN_CMD_ERR
condition|)
block|{
name|err
operator|=
name|svn_error_create
argument_list|(
operator|(
name|apr_status_t
operator|)
name|apr_err
argument_list|,
name|err
argument_list|,
name|message
argument_list|)
expr_stmt|;
name|err
operator|->
name|file
operator|=
name|apr_pstrdup
argument_list|(
name|err
operator|->
name|pool
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|err
operator|->
name|line
operator|=
operator|(
name|long
operator|)
name|line
expr_stmt|;
block|}
block|}
name|svn_pool_destroy
argument_list|(
name|subpool
argument_list|)
expr_stmt|;
comment|/* If we get here, then we failed to find a real error in the error      chain that the server proported to be sending us.  That's bad. */
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Malformed error list"
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__read_cmd_response
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
specifier|const
name|char
modifier|*
name|status
decl_stmt|;
name|apr_array_header_t
modifier|*
name|params
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_tuple
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"wl"
argument_list|,
operator|&
name|status
argument_list|,
operator|&
name|params
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|status
argument_list|,
literal|"success"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|err
operator|=
name|vparse_tuple
argument_list|(
name|params
argument_list|,
name|pool
argument_list|,
operator|&
name|fmt
argument_list|,
operator|&
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|status
argument_list|,
literal|"failure"
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_ra_svn__handle_failure_status
argument_list|(
name|params
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_RA_SVN_MALFORMED_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Unknown status '%s' in command response"
argument_list|)
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__has_command
parameter_list|(
name|svn_boolean_t
modifier|*
name|has_command
parameter_list|,
name|svn_boolean_t
modifier|*
name|terminated
parameter_list|,
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|svn_ra_svn__has_item
argument_list|(
name|has_command
argument_list|,
name|conn
argument_list|,
name|pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_RA_SVN_CONNECTION_CLOSED
condition|)
block|{
operator|*
name|terminated
operator|=
name|TRUE
expr_stmt|;
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
operator|*
name|terminated
operator|=
name|FALSE
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__handle_command
parameter_list|(
name|svn_boolean_t
modifier|*
name|terminate
parameter_list|,
name|apr_hash_t
modifier|*
name|cmd_hash
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|svn_boolean_t
name|error_on_disconnect
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cmdname
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|,
modifier|*
name|write_err
decl_stmt|;
name|apr_array_header_t
modifier|*
name|params
decl_stmt|;
specifier|const
name|svn_ra_svn_cmd_entry_t
modifier|*
name|command
decl_stmt|;
operator|*
name|terminate
operator|=
name|FALSE
expr_stmt|;
name|err
operator|=
name|svn_ra_svn__read_tuple
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"wl"
argument_list|,
operator|&
name|cmdname
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
operator|!
name|error_on_disconnect
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_RA_SVN_CONNECTION_CLOSED
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
operator|*
name|terminate
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|err
return|;
block|}
name|command
operator|=
name|svn_hash_gets
argument_list|(
name|cmd_hash
argument_list|,
name|cmdname
argument_list|)
expr_stmt|;
if|if
condition|(
name|command
condition|)
block|{
name|err
operator|=
call|(
modifier|*
name|command
operator|->
name|handler
call|)
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|params
argument_list|,
name|baton
argument_list|)
expr_stmt|;
operator|*
name|terminate
operator|=
name|command
operator|->
name|terminate
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|svn_error_createf
argument_list|(
name|SVN_ERR_RA_SVN_UNKNOWN_CMD
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Unknown editor command '%s'"
argument_list|)
argument_list|,
name|cmdname
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_SVN_CMD_ERR
argument_list|,
name|err
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_RA_SVN_CMD_ERR
condition|)
block|{
name|write_err
operator|=
name|svn_ra_svn__write_cmd_failure
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|svn_ra_svn__locate_real_error_child
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|write_err
condition|?
name|write_err
else|:
name|SVN_NO_ERROR
return|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__handle_commands2
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|svn_ra_svn_cmd_entry_t
modifier|*
name|commands
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|svn_boolean_t
name|error_on_disconnect
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|subpool
init|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|subpool
argument_list|)
decl_stmt|;
specifier|const
name|svn_ra_svn_cmd_entry_t
modifier|*
name|command
decl_stmt|;
name|apr_hash_t
modifier|*
name|cmd_hash
init|=
name|apr_hash_make
argument_list|(
name|subpool
argument_list|)
decl_stmt|;
for|for
control|(
name|command
operator|=
name|commands
init|;
name|command
operator|->
name|cmdname
condition|;
name|command
operator|++
control|)
name|svn_hash_sets
argument_list|(
name|cmd_hash
argument_list|,
name|command
operator|->
name|cmdname
argument_list|,
name|command
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|svn_boolean_t
name|terminate
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_ra_svn__handle_command
argument_list|(
operator|&
name|terminate
argument_list|,
name|cmd_hash
argument_list|,
name|baton
argument_list|,
name|conn
argument_list|,
name|error_on_disconnect
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|svn_pool_destroy
argument_list|(
name|subpool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
if|if
condition|(
name|terminate
condition|)
break|break;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|subpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_target_rev
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( target-rev ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_open_root
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( open-root ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_delete_entry
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( delete-entry ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_add_dir
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|parent_token
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
specifier|const
name|char
modifier|*
name|copy_path
parameter_list|,
name|svn_revnum_t
name|copy_rev
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( add-dir ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_cmd_add_node
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|,
name|parent_token
argument_list|,
name|token
argument_list|,
name|copy_path
argument_list|,
name|copy_rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_open_dir
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|parent_token
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( open-dir ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_cmd_open_node
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|,
name|parent_token
argument_list|,
name|token
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_change_dir_prop
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|value
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( change-dir-prop ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_cmd_change_node_prop
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|,
name|name
argument_list|,
name|value
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_close_dir
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( close-dir ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_absent_dir
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|parent_token
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( absent-dir ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_cmd_absent_node
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|,
name|parent_token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_add_file
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|parent_token
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
specifier|const
name|char
modifier|*
name|copy_path
parameter_list|,
name|svn_revnum_t
name|copy_rev
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( add-file ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_cmd_add_node
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|,
name|parent_token
argument_list|,
name|token
argument_list|,
name|copy_path
argument_list|,
name|copy_rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_open_file
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|parent_token
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( open-file ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_cmd_open_node
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|,
name|parent_token
argument_list|,
name|token
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_change_file_prop
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|value
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( change-file-prop ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_cmd_change_node_prop
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|,
name|name
argument_list|,
name|value
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_close_file
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
specifier|const
name|char
modifier|*
name|text_checksum
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( close-file ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|text_checksum
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_absent_file
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|parent_token
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( absent-file ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_cmd_absent_node
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|,
name|parent_token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_textdelta_chunk
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|chunk
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( textdelta-chunk ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_string
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|chunk
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_textdelta_end
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( textdelta-end ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_apply_textdelta
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
specifier|const
name|char
modifier|*
name|base_checksum
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( apply-textdelta ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|base_checksum
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_close_edit
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( close-edit ( ) ) "
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_abort_edit
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( abort-edit ( ) ) "
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_set_path
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|svn_boolean_t
name|start_empty
parameter_list|,
specifier|const
name|char
modifier|*
name|lock_token
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( set-path ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|start_empty
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|lock_token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_depth
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_delete_path
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( delete-path ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_link_path
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|svn_boolean_t
name|start_empty
parameter_list|,
specifier|const
name|char
modifier|*
name|lock_token
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( link-path ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|url
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|start_empty
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|lock_token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_depth
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_finish_report
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( finish-report ( ) ) "
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_abort_report
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( abort-report ( ) ) "
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_reparent
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( reparent ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|url
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_get_latest_rev
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( get-latest-rev ( ) ) "
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_get_dated_rev
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_time_t
name|tm
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( get-dated-rev ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|svn_time_to_cstring
argument_list|(
name|tm
argument_list|,
name|pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_change_rev_prop2
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|value
parameter_list|,
name|svn_boolean_t
name|dont_care
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|old_value
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( change-rev-prop2 ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_string_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|value
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|dont_care
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_string_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|old_value
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_change_rev_prop
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|value
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( change-rev-prop ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_string_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|value
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_rev_proplist
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( rev-proplist ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_rev_prop
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( rev-prop ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_get_file
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|svn_boolean_t
name|props
parameter_list|,
name|svn_boolean_t
name|stream
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( get-file ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|props
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|stream
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Always send the, nominally optional, want-iprops as "false" to      workaround a bug in svnserve 1.8.0-1.8.8 that causes the server      to see "true" if it is omitted. */
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|" false ) ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_update
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|,
name|svn_boolean_t
name|recurse
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|send_copyfrom_args
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( update ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|target
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|recurse
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_depth
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|send_copyfrom_args
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|ignore_ancestry
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_switch
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|,
name|svn_boolean_t
name|recurse
parameter_list|,
specifier|const
name|char
modifier|*
name|switch_url
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|send_copyfrom_args
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( switch ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|target
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|recurse
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|switch_url
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_depth
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|send_copyfrom_args
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|ignore_ancestry
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_status
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|,
name|svn_boolean_t
name|recurse
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( status ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|target
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|recurse
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_depth
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_diff
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|,
name|svn_boolean_t
name|recurse
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
specifier|const
name|char
modifier|*
name|versus_url
parameter_list|,
name|svn_boolean_t
name|text_deltas
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( diff ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|target
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|recurse
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|ignore_ancestry
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|versus_url
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|text_deltas
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_depth
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_check_path
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( check-path ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_stat
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( stat ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_get_file_revs
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
name|start
parameter_list|,
name|svn_revnum_t
name|end
parameter_list|,
name|svn_boolean_t
name|include_merged_revisions
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( get-file-revs ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|start
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|end
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|include_merged_revisions
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_lock
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|comment
parameter_list|,
name|svn_boolean_t
name|steal_lock
parameter_list|,
name|svn_revnum_t
name|revnum
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( lock ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|comment
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|steal_lock
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|revnum
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_unlock
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
name|svn_boolean_t
name|break_lock
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( unlock ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|token
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|break_lock
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_get_lock
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( get-lock ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_get_locks
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( get-locks ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_depth
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_replay
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|svn_revnum_t
name|low_water_mark
parameter_list|,
name|svn_boolean_t
name|send_deltas
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( replay ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|low_water_mark
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|send_deltas
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_replay_range
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|start_revision
parameter_list|,
name|svn_revnum_t
name|end_revision
parameter_list|,
name|svn_revnum_t
name|low_water_mark
parameter_list|,
name|svn_boolean_t
name|send_deltas
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( replay-range ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|start_revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|end_revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|low_water_mark
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|send_deltas
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_get_deleted_rev
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
name|peg_revision
parameter_list|,
name|svn_revnum_t
name|end_revision
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( get-deleted-rev ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|peg_revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|end_revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_get_iprops
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( get-iprops ( "
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_finish_replay
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( finish-replay ( ) ) "
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_response
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( success "
argument_list|)
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|err
operator|=
name|vwrite_tuple
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|fmt
argument_list|,
operator|&
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return
name|err
condition|?
name|svn_error_trace
argument_list|(
name|err
argument_list|)
else|:
name|svn_ra_svn__end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_cmd_failure
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|svn_error_t
modifier|*
name|err
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|128
index|]
decl_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"( failure ( "
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|err
condition|;
name|err
operator|=
name|err
operator|->
name|child
control|)
block|{
specifier|const
name|char
modifier|*
name|msg
decl_stmt|;
ifdef|#
directive|ifdef
name|SVN_ERR__TRACING
if|if
condition|(
name|svn_error__is_tracing_link
argument_list|(
name|err
argument_list|)
condition|)
name|msg
operator|=
name|err
operator|->
name|message
expr_stmt|;
else|else
endif|#
directive|endif
name|msg
operator|=
name|svn_err_best_message
argument_list|(
name|err
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* The message string should have been optional, but we can't          easily change that, so marshal nonexistent messages as "". */
name|SVN_ERR
argument_list|(
name|svn_ra_svn__write_tuple
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"nccn"
argument_list|,
operator|(
name|apr_uint64_t
operator|)
name|err
operator|->
name|apr_err
argument_list|,
name|msg
condition|?
name|msg
else|:
literal|""
argument_list|,
name|err
operator|->
name|file
condition|?
name|err
operator|->
name|file
else|:
literal|""
argument_list|,
operator|(
name|apr_uint64_t
operator|)
name|err
operator|->
name|line
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_data_log_changed_path
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|char
name|action
parameter_list|,
specifier|const
name|char
modifier|*
name|copyfrom_path
parameter_list|,
name|svn_revnum_t
name|copyfrom_rev
parameter_list|,
name|svn_node_kind_t
name|node_kind
parameter_list|,
name|svn_boolean_t
name|text_modified
parameter_list|,
name|svn_boolean_t
name|props_modified
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_writechar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|action
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|writebuf_writechar
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|' '
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|copyfrom_path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_revision_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|copyfrom_rev
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|svn_node_kind_to_word
argument_list|(
name|node_kind
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|text_modified
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|props_modified
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|writebuf_write_literal
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|") ) "
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__write_data_log_entry
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|author
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|date
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|message
parameter_list|,
name|svn_boolean_t
name|has_children
parameter_list|,
name|svn_boolean_t
name|invalid_revnum
parameter_list|,
name|unsigned
name|revprop_count
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|write_tuple_revision
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|revision
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_string_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|author
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_string_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|date
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_start_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_string_opt
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|message
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_end_list
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|has_children
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_tuple_boolean
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|invalid_revnum
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__write_number
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|revprop_count
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* If condition COND is not met, return a "malformed network data" error.  */
end_comment

begin_define
define|#
directive|define
name|CHECK_PROTOCOL_COND
parameter_list|(
name|cond
parameter_list|)
define|\
value|if (!(cond)) \     return svn_error_create(SVN_ERR_RA_SVN_MALFORMED_DATA, NULL, \                             _("Malformed network data"));
end_define

begin_comment
comment|/* In *RESULT, return the SVN-style string at index IDX in tuple ITEMS.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|svn_ra_svn__read_string
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|items
parameter_list|,
name|int
name|idx
parameter_list|,
name|svn_string_t
modifier|*
modifier|*
name|result
parameter_list|)
block|{
name|svn_ra_svn_item_t
modifier|*
name|elt
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|items
argument_list|,
name|idx
argument_list|,
name|svn_ra_svn_item_t
argument_list|)
decl_stmt|;
name|CHECK_PROTOCOL_COND
argument_list|(
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_STRING
argument_list|)
expr_stmt|;
operator|*
name|result
operator|=
name|elt
operator|->
name|u
operator|.
name|string
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* In *RESULT, return the C-style string at index IDX in tuple ITEMS.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|svn_ra_svn__read_cstring
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|items
parameter_list|,
name|int
name|idx
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|result
parameter_list|)
block|{
name|svn_ra_svn_item_t
modifier|*
name|elt
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|items
argument_list|,
name|idx
argument_list|,
name|svn_ra_svn_item_t
argument_list|)
decl_stmt|;
name|CHECK_PROTOCOL_COND
argument_list|(
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_STRING
argument_list|)
expr_stmt|;
operator|*
name|result
operator|=
name|elt
operator|->
name|u
operator|.
name|string
operator|->
name|data
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* In *RESULT, return the word at index IDX in tuple ITEMS.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|svn_ra_svn__read_word
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|items
parameter_list|,
name|int
name|idx
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|result
parameter_list|)
block|{
name|svn_ra_svn_item_t
modifier|*
name|elt
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|items
argument_list|,
name|idx
argument_list|,
name|svn_ra_svn_item_t
argument_list|)
decl_stmt|;
name|CHECK_PROTOCOL_COND
argument_list|(
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_WORD
argument_list|)
expr_stmt|;
operator|*
name|result
operator|=
name|elt
operator|->
name|u
operator|.
name|word
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* In *RESULT, return the revision at index IDX in tuple ITEMS.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|svn_ra_svn__read_revision
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|items
parameter_list|,
name|int
name|idx
parameter_list|,
name|svn_revnum_t
modifier|*
name|result
parameter_list|)
block|{
name|svn_ra_svn_item_t
modifier|*
name|elt
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|items
argument_list|,
name|idx
argument_list|,
name|svn_ra_svn_item_t
argument_list|)
decl_stmt|;
name|CHECK_PROTOCOL_COND
argument_list|(
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_NUMBER
argument_list|)
expr_stmt|;
operator|*
name|result
operator|=
operator|(
name|svn_revnum_t
operator|)
name|elt
operator|->
name|u
operator|.
name|number
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* In *RESULT, return the boolean at index IDX in tuple ITEMS.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|svn_ra_svn__read_boolean
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|items
parameter_list|,
name|int
name|idx
parameter_list|,
name|apr_uint64_t
modifier|*
name|result
parameter_list|)
block|{
name|svn_ra_svn_item_t
modifier|*
name|elt
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|items
argument_list|,
name|idx
argument_list|,
name|svn_ra_svn_item_t
argument_list|)
decl_stmt|;
name|CHECK_PROTOCOL_COND
argument_list|(
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_WORD
argument_list|)
expr_stmt|;
if|if
condition|(
name|elt
operator|->
name|u
operator|.
name|word
index|[
literal|0
index|]
operator|==
literal|'t'
operator|&&
name|strcmp
argument_list|(
name|elt
operator|->
name|u
operator|.
name|word
argument_list|,
literal|"true"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|result
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|elt
operator|->
name|u
operator|.
name|word
argument_list|,
literal|"false"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|result
operator|=
name|FALSE
expr_stmt|;
else|else
name|CHECK_PROTOCOL_COND
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* In *RESULT, return the tuple at index IDX in tuple ITEMS.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|svn_ra_svn__read_list
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|items
parameter_list|,
name|int
name|idx
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
modifier|*
name|result
parameter_list|)
block|{
name|svn_ra_svn_item_t
modifier|*
name|elt
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|items
argument_list|,
name|idx
argument_list|,
name|svn_ra_svn_item_t
argument_list|)
decl_stmt|;
name|CHECK_PROTOCOL_COND
argument_list|(
name|elt
operator|->
name|kind
operator|==
name|SVN_RA_SVN_LIST
argument_list|)
expr_stmt|;
operator|*
name|result
operator|=
name|elt
operator|->
name|u
operator|.
name|list
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Verify the tuple ITEMS contains at least MIN and at most MAX elements.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|svn_ra_svn__read_check_array_size
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|items
parameter_list|,
name|int
name|min
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|CHECK_PROTOCOL_COND
argument_list|(
name|items
operator|->
name|nelts
operator|>=
name|min
operator|&&
name|items
operator|->
name|nelts
operator|<=
name|max
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__read_data_log_changed_entry
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|items
parameter_list|,
name|svn_string_t
modifier|*
modifier|*
name|cpath
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|action
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|copy_path
parameter_list|,
name|svn_revnum_t
modifier|*
name|copy_rev
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|kind_str
parameter_list|,
name|apr_uint64_t
modifier|*
name|text_mods
parameter_list|,
name|apr_uint64_t
modifier|*
name|prop_mods
parameter_list|)
block|{
specifier|const
name|apr_array_header_t
modifier|*
name|sub_items
decl_stmt|;
comment|/* initialize optional values */
operator|*
name|copy_path
operator|=
name|NULL
expr_stmt|;
operator|*
name|copy_rev
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
operator|*
name|kind_str
operator|=
name|NULL
expr_stmt|;
operator|*
name|text_mods
operator|=
name|SVN_RA_SVN_UNSPECIFIED_NUMBER
expr_stmt|;
operator|*
name|prop_mods
operator|=
name|SVN_RA_SVN_UNSPECIFIED_NUMBER
expr_stmt|;
comment|/* top-level elements (mandatory) */
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_check_array_size
argument_list|(
name|items
argument_list|,
literal|3
argument_list|,
name|INT_MAX
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_string
argument_list|(
name|items
argument_list|,
literal|0
argument_list|,
name|cpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_word
argument_list|(
name|items
argument_list|,
literal|1
argument_list|,
name|action
argument_list|)
argument_list|)
expr_stmt|;
comment|/* first sub-structure (mandatory) */
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_list
argument_list|(
name|items
argument_list|,
literal|2
argument_list|,
operator|&
name|sub_items
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sub_items
operator|->
name|nelts
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_check_array_size
argument_list|(
name|sub_items
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_cstring
argument_list|(
name|sub_items
argument_list|,
literal|0
argument_list|,
name|copy_path
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_revision
argument_list|(
name|sub_items
argument_list|,
literal|1
argument_list|,
name|copy_rev
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* second sub-structure (optional) */
if|if
condition|(
name|items
operator|->
name|nelts
operator|>=
literal|4
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_list
argument_list|(
name|items
argument_list|,
literal|3
argument_list|,
operator|&
name|sub_items
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|MIN
argument_list|(
literal|3
argument_list|,
name|sub_items
operator|->
name|nelts
argument_list|)
condition|)
block|{
case|case
literal|3
case|:
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_boolean
argument_list|(
name|sub_items
argument_list|,
literal|2
argument_list|,
name|prop_mods
argument_list|)
argument_list|)
expr_stmt|;
case|case
literal|2
case|:
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_boolean
argument_list|(
name|sub_items
argument_list|,
literal|1
argument_list|,
name|text_mods
argument_list|)
argument_list|)
expr_stmt|;
case|case
literal|1
case|:
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_cstring
argument_list|(
name|sub_items
argument_list|,
literal|0
argument_list|,
name|kind_str
argument_list|)
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * cram.c :  Minimal standalone CRAM-MD5 implementation  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_escape
end_escape

begin_define
define|#
directive|define
name|APR_WANT_STRFUNC
end_define

begin_define
define|#
directive|define
name|APR_WANT_STDIO
end_define

begin_include
include|#
directive|include
file|<apr_want.h>
end_include

begin_include
include|#
directive|include
file|<apr_general.h>
end_include

begin_include
include|#
directive|include
file|<apr_strings.h>
end_include

begin_include
include|#
directive|include
file|<apr_network_io.h>
end_include

begin_include
include|#
directive|include
file|<apr_time.h>
end_include

begin_include
include|#
directive|include
file|<apr_md5.h>
end_include

begin_include
include|#
directive|include
file|"svn_types.h"
end_include

begin_include
include|#
directive|include
file|"svn_string.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_ra_svn.h"
end_include

begin_include
include|#
directive|include
file|"svn_config.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"ra_svn.h"
end_include

begin_function
specifier|static
name|int
name|hex_to_int
parameter_list|(
name|char
name|c
parameter_list|)
block|{
return|return
operator|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
operator|)
condition|?
name|c
operator|-
literal|'0'
else|:
operator|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'f'
operator|)
condition|?
name|c
operator|-
literal|'a'
operator|+
literal|10
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|char
name|int_to_hex
parameter_list|(
name|int
name|v
parameter_list|)
block|{
return|return
call|(
name|char
call|)
argument_list|(
operator|(
name|v
operator|<
literal|10
operator|)
condition|?
literal|'0'
operator|+
name|v
else|:
literal|'a'
operator|+
operator|(
name|v
operator|-
literal|10
operator|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_boolean_t
name|hex_decode
parameter_list|(
name|unsigned
name|char
modifier|*
name|hashval
parameter_list|,
specifier|const
name|char
modifier|*
name|hexval
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|h1
decl_stmt|,
name|h2
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|APR_MD5_DIGESTSIZE
condition|;
name|i
operator|++
control|)
block|{
name|h1
operator|=
name|hex_to_int
argument_list|(
name|hexval
index|[
literal|2
operator|*
name|i
index|]
argument_list|)
expr_stmt|;
name|h2
operator|=
name|hex_to_int
argument_list|(
name|hexval
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|h1
operator|==
operator|-
literal|1
operator|||
name|h2
operator|==
operator|-
literal|1
condition|)
return|return
name|FALSE
return|;
name|hashval
index|[
name|i
index|]
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
operator|(
name|h1
operator|<<
literal|4
operator|)
operator||
name|h2
argument_list|)
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hex_encode
parameter_list|(
name|char
modifier|*
name|hexval
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|hashval
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|APR_MD5_DIGESTSIZE
condition|;
name|i
operator|++
control|)
block|{
name|hexval
index|[
literal|2
operator|*
name|i
index|]
operator|=
name|int_to_hex
argument_list|(
operator|(
name|hashval
index|[
name|i
index|]
operator|>>
literal|4
operator|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
name|hexval
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
operator|=
name|int_to_hex
argument_list|(
name|hashval
index|[
name|i
index|]
operator|&
literal|0xf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|compute_digest
parameter_list|(
name|unsigned
name|char
modifier|*
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|challenge
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|)
block|{
name|unsigned
name|char
name|secret
index|[
literal|64
index|]
decl_stmt|;
name|apr_size_t
name|len
init|=
name|strlen
argument_list|(
name|password
argument_list|)
decl_stmt|,
name|i
decl_stmt|;
name|apr_md5_ctx_t
name|ctx
decl_stmt|;
comment|/* Munge the password into a 64-byte secret. */
name|memset
argument_list|(
name|secret
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|secret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<=
sizeof|sizeof
argument_list|(
name|secret
argument_list|)
condition|)
name|memcpy
argument_list|(
name|secret
argument_list|,
name|password
argument_list|,
name|len
argument_list|)
expr_stmt|;
else|else
name|apr_md5
argument_list|(
name|secret
argument_list|,
name|password
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* Compute MD5(secret XOR opad, MD5(secret XOR ipad, challenge)),    * where ipad is a string of 0x36 and opad is a string of 0x5c. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|secret
argument_list|)
condition|;
name|i
operator|++
control|)
name|secret
index|[
name|i
index|]
operator|^=
literal|0x36
expr_stmt|;
name|apr_md5_init
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|apr_md5_update
argument_list|(
operator|&
name|ctx
argument_list|,
name|secret
argument_list|,
sizeof|sizeof
argument_list|(
name|secret
argument_list|)
argument_list|)
expr_stmt|;
name|apr_md5_update
argument_list|(
operator|&
name|ctx
argument_list|,
name|challenge
argument_list|,
name|strlen
argument_list|(
name|challenge
argument_list|)
argument_list|)
expr_stmt|;
name|apr_md5_final
argument_list|(
name|digest
argument_list|,
operator|&
name|ctx
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|secret
argument_list|)
condition|;
name|i
operator|++
control|)
name|secret
index|[
name|i
index|]
operator|^=
operator|(
literal|0x36
operator|^
literal|0x5c
operator|)
expr_stmt|;
name|apr_md5_init
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|apr_md5_update
argument_list|(
operator|&
name|ctx
argument_list|,
name|secret
argument_list|,
sizeof|sizeof
argument_list|(
name|secret
argument_list|)
argument_list|)
expr_stmt|;
name|apr_md5_update
argument_list|(
operator|&
name|ctx
argument_list|,
name|digest
argument_list|,
name|APR_MD5_DIGESTSIZE
argument_list|)
expr_stmt|;
name|apr_md5_final
argument_list|(
name|digest
argument_list|,
operator|&
name|ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Fail the authentication, from the server's perspective. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|fail
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_ra_svn__write_tuple
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"w(c)"
argument_list|,
literal|"failure"
argument_list|,
name|msg
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_ra_svn__flush
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* If we can, make the nonce with random bytes.  If we can't... well,  * it just has to be different each time.  The current time isn't  * absolutely guaranteed to be different for each connection, but it  * should prevent replay attacks in practice. */
end_comment

begin_function
specifier|static
name|apr_status_t
name|make_nonce
parameter_list|(
name|apr_uint64_t
modifier|*
name|nonce
parameter_list|)
block|{
if|#
directive|if
name|APR_HAS_RANDOM
return|return
name|apr_generate_random_bytes
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|nonce
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|nonce
argument_list|)
argument_list|)
return|;
else|#
directive|else
operator|*
name|nonce
operator|=
name|apr_time_now
argument_list|()
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn_cram_server
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|svn_config_t
modifier|*
name|pwdb
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|user
parameter_list|,
name|svn_boolean_t
modifier|*
name|success
parameter_list|)
block|{
name|apr_status_t
name|status
decl_stmt|;
name|apr_uint64_t
name|nonce
decl_stmt|;
name|char
name|hostbuf
index|[
name|APRMAXHOSTLEN
operator|+
literal|1
index|]
decl_stmt|;
name|unsigned
name|char
name|cdigest
index|[
name|APR_MD5_DIGESTSIZE
index|]
decl_stmt|,
name|sdigest
index|[
name|APR_MD5_DIGESTSIZE
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|challenge
decl_stmt|,
modifier|*
name|sep
decl_stmt|,
modifier|*
name|password
decl_stmt|;
name|svn_ra_svn_item_t
modifier|*
name|item
decl_stmt|;
name|svn_string_t
modifier|*
name|resp
decl_stmt|;
operator|*
name|success
operator|=
name|FALSE
expr_stmt|;
comment|/* Send a challenge. */
name|status
operator|=
name|make_nonce
argument_list|(
operator|&
name|nonce
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|status
condition|)
name|status
operator|=
name|apr_gethostname
argument_list|(
name|hostbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|hostbuf
argument_list|)
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
return|return
name|fail
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"Internal server error in authentication"
argument_list|)
return|;
name|challenge
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"<%"
name|APR_UINT64_T_FMT
literal|".%"
name|APR_TIME_T_FMT
literal|"@%s>"
argument_list|,
name|nonce
argument_list|,
name|apr_time_now
argument_list|()
argument_list|,
name|hostbuf
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__write_tuple
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"w(c)"
argument_list|,
literal|"step"
argument_list|,
name|challenge
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Read the client's response and decode it into *user and cdigest. */
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_item
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
operator|&
name|item
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|item
operator|->
name|kind
operator|!=
name|SVN_RA_SVN_STRING
condition|)
comment|/* Very wrong; don't report failure */
return|return
name|SVN_NO_ERROR
return|;
name|resp
operator|=
name|item
operator|->
name|u
operator|.
name|string
expr_stmt|;
name|sep
operator|=
name|strrchr
argument_list|(
name|resp
operator|->
name|data
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sep
operator|||
name|resp
operator|->
name|len
operator|-
operator|(
name|sep
operator|+
literal|1
operator|-
name|resp
operator|->
name|data
operator|)
operator|!=
name|APR_MD5_DIGESTSIZE
operator|*
literal|2
operator|||
operator|!
name|hex_decode
argument_list|(
name|cdigest
argument_list|,
name|sep
operator|+
literal|1
argument_list|)
condition|)
return|return
name|fail
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"Malformed client response in authentication"
argument_list|)
return|;
operator|*
name|user
operator|=
name|apr_pstrmemdup
argument_list|(
name|pool
argument_list|,
name|resp
operator|->
name|data
argument_list|,
name|sep
operator|-
name|resp
operator|->
name|data
argument_list|)
expr_stmt|;
comment|/* Verify the digest against the password in pwfile. */
name|svn_config_get
argument_list|(
name|pwdb
argument_list|,
operator|&
name|password
argument_list|,
name|SVN_CONFIG_SECTION_USERS
argument_list|,
operator|*
name|user
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|password
condition|)
return|return
name|fail
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"Username not found"
argument_list|)
return|;
name|compute_digest
argument_list|(
name|sdigest
argument_list|,
name|challenge
argument_list|,
name|password
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|cdigest
argument_list|,
name|sdigest
argument_list|,
sizeof|sizeof
argument_list|(
name|sdigest
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|fail
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"Password incorrect"
argument_list|)
return|;
operator|*
name|success
operator|=
name|TRUE
expr_stmt|;
return|return
name|svn_ra_svn__write_tuple
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"w()"
argument_list|,
literal|"success"
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_svn__cram_client
parameter_list|(
name|svn_ra_svn_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|user
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|message
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|status
decl_stmt|,
modifier|*
name|str
decl_stmt|,
modifier|*
name|reply
decl_stmt|;
name|unsigned
name|char
name|digest
index|[
name|APR_MD5_DIGESTSIZE
index|]
decl_stmt|;
name|char
name|hex
index|[
literal|2
operator|*
name|APR_MD5_DIGESTSIZE
operator|+
literal|1
index|]
decl_stmt|;
comment|/* Read the server challenge. */
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_tuple
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"w(?c)"
argument_list|,
operator|&
name|status
argument_list|,
operator|&
name|str
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|status
argument_list|,
literal|"failure"
argument_list|)
operator|==
literal|0
operator|&&
name|str
condition|)
block|{
operator|*
name|message
operator|=
name|str
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|status
argument_list|,
literal|"step"
argument_list|)
operator|!=
literal|0
operator|||
operator|!
name|str
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_NOT_AUTHORIZED
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Unexpected server response to authentication"
argument_list|)
argument_list|)
return|;
comment|/* Write our response. */
name|compute_digest
argument_list|(
name|digest
argument_list|,
name|str
argument_list|,
name|password
argument_list|)
expr_stmt|;
name|hex_encode
argument_list|(
name|hex
argument_list|,
name|digest
argument_list|)
expr_stmt|;
name|hex
index|[
sizeof|sizeof
argument_list|(
name|hex
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|reply
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%s %s"
argument_list|,
name|user
argument_list|,
name|hex
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_svn__write_cstring
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
name|reply
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Read the success or failure response from the server. */
name|SVN_ERR
argument_list|(
name|svn_ra_svn__read_tuple
argument_list|(
name|conn
argument_list|,
name|pool
argument_list|,
literal|"w(?c)"
argument_list|,
operator|&
name|status
argument_list|,
operator|&
name|str
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|status
argument_list|,
literal|"failure"
argument_list|)
operator|==
literal|0
operator|&&
name|str
condition|)
block|{
operator|*
name|message
operator|=
name|str
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|status
argument_list|,
literal|"success"
argument_list|)
operator|!=
literal|0
operator|||
name|str
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_RA_NOT_AUTHORIZED
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Unexpected server response to authentication"
argument_list|)
argument_list|)
return|;
operator|*
name|message
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


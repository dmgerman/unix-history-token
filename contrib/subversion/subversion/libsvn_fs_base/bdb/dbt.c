begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* dbt.c --- DBT-frobbing functions  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<apr_pools.h>
end_include

begin_include
include|#
directive|include
file|<apr_md5.h>
end_include

begin_include
include|#
directive|include
file|<apr_sha1.h>
end_include

begin_define
define|#
directive|define
name|SVN_WANT_BDB
end_define

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"../id.h"
end_include

begin_include
include|#
directive|include
file|"dbt.h"
end_include

begin_function
name|DBT
modifier|*
name|svn_fs_base__clear_dbt
parameter_list|(
name|DBT
modifier|*
name|dbt
parameter_list|)
block|{
name|memset
argument_list|(
name|dbt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dbt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|dbt
return|;
block|}
end_function

begin_function
name|DBT
modifier|*
name|svn_fs_base__nodata_dbt
parameter_list|(
name|DBT
modifier|*
name|dbt
parameter_list|)
block|{
name|svn_fs_base__clear_dbt
argument_list|(
name|dbt
argument_list|)
expr_stmt|;
comment|/* A `nodata' dbt is one which retrieves zero bytes from offset zero,      and stores them in a zero-byte buffer in user-allocated memory.  */
name|dbt
operator|->
name|flags
operator||=
operator|(
name|DB_DBT_USERMEM
operator||
name|DB_DBT_PARTIAL
operator|)
expr_stmt|;
name|dbt
operator|->
name|doff
operator|=
name|dbt
operator|->
name|dlen
operator|=
literal|0
expr_stmt|;
return|return
name|dbt
return|;
block|}
end_function

begin_function
name|DBT
modifier|*
name|svn_fs_base__set_dbt
parameter_list|(
name|DBT
modifier|*
name|dbt
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|apr_size_t
name|size
parameter_list|)
block|{
name|svn_fs_base__clear_dbt
argument_list|(
name|dbt
argument_list|)
expr_stmt|;
name|dbt
operator|->
name|data
operator|=
operator|(
name|void
operator|*
operator|)
name|data
expr_stmt|;
name|dbt
operator|->
name|size
operator|=
operator|(
name|u_int32_t
operator|)
name|size
expr_stmt|;
return|return
name|dbt
return|;
block|}
end_function

begin_function
name|DBT
modifier|*
name|svn_fs_base__result_dbt
parameter_list|(
name|DBT
modifier|*
name|dbt
parameter_list|)
block|{
name|svn_fs_base__clear_dbt
argument_list|(
name|dbt
argument_list|)
expr_stmt|;
name|dbt
operator|->
name|flags
operator||=
name|DB_DBT_MALLOC
expr_stmt|;
return|return
name|dbt
return|;
block|}
end_function

begin_comment
comment|/* An APR pool cleanup function that simply applies `free' to its    argument.  */
end_comment

begin_function
specifier|static
name|apr_status_t
name|apr_free_cleanup
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|free
argument_list|(
name|arg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|DBT
modifier|*
name|svn_fs_base__track_dbt
parameter_list|(
name|DBT
modifier|*
name|dbt
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
if|if
condition|(
name|dbt
operator|->
name|data
condition|)
name|apr_pool_cleanup_register
argument_list|(
name|pool
argument_list|,
name|dbt
operator|->
name|data
argument_list|,
name|apr_free_cleanup
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
return|return
name|dbt
return|;
block|}
end_function

begin_function
name|DBT
modifier|*
name|svn_fs_base__recno_dbt
parameter_list|(
name|DBT
modifier|*
name|dbt
parameter_list|,
name|db_recno_t
modifier|*
name|recno
parameter_list|)
block|{
name|svn_fs_base__set_dbt
argument_list|(
name|dbt
argument_list|,
name|recno
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|recno
argument_list|)
argument_list|)
expr_stmt|;
name|dbt
operator|->
name|ulen
operator|=
name|dbt
operator|->
name|size
expr_stmt|;
name|dbt
operator|->
name|flags
operator||=
name|DB_DBT_USERMEM
expr_stmt|;
return|return
name|dbt
return|;
block|}
end_function

begin_function
name|int
name|svn_fs_base__compare_dbt
parameter_list|(
specifier|const
name|DBT
modifier|*
name|a
parameter_list|,
specifier|const
name|DBT
modifier|*
name|b
parameter_list|)
block|{
name|int
name|common_size
init|=
name|a
operator|->
name|size
operator|>
name|b
operator|->
name|size
condition|?
name|b
operator|->
name|size
else|:
name|a
operator|->
name|size
decl_stmt|;
name|int
name|cmp
init|=
name|memcmp
argument_list|(
name|a
operator|->
name|data
argument_list|,
name|b
operator|->
name|data
argument_list|,
name|common_size
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmp
condition|)
return|return
name|cmp
return|;
else|else
return|return
name|a
operator|->
name|size
operator|-
name|b
operator|->
name|size
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Building DBT's from interesting things.  */
end_comment

begin_comment
comment|/* Set DBT to the unparsed form of ID; allocate memory from POOL.    Return DBT.  */
end_comment

begin_function
name|DBT
modifier|*
name|svn_fs_base__id_to_dbt
parameter_list|(
name|DBT
modifier|*
name|dbt
parameter_list|,
specifier|const
name|svn_fs_id_t
modifier|*
name|id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_string_t
modifier|*
name|unparsed_id
init|=
name|svn_fs_base__id_unparse
argument_list|(
name|id
argument_list|,
name|pool
argument_list|)
decl_stmt|;
name|svn_fs_base__set_dbt
argument_list|(
name|dbt
argument_list|,
name|unparsed_id
operator|->
name|data
argument_list|,
name|unparsed_id
operator|->
name|len
argument_list|)
expr_stmt|;
return|return
name|dbt
return|;
block|}
end_function

begin_comment
comment|/* Set DBT to the unparsed form of SKEL; allocate memory from POOL.  */
end_comment

begin_function
name|DBT
modifier|*
name|svn_fs_base__skel_to_dbt
parameter_list|(
name|DBT
modifier|*
name|dbt
parameter_list|,
name|svn_skel_t
modifier|*
name|skel
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_stringbuf_t
modifier|*
name|unparsed_skel
init|=
name|svn_skel__unparse
argument_list|(
name|skel
argument_list|,
name|pool
argument_list|)
decl_stmt|;
name|svn_fs_base__set_dbt
argument_list|(
name|dbt
argument_list|,
name|unparsed_skel
operator|->
name|data
argument_list|,
name|unparsed_skel
operator|->
name|len
argument_list|)
expr_stmt|;
return|return
name|dbt
return|;
block|}
end_function

begin_comment
comment|/* Set DBT to the text of the null-terminated string STR.  DBT will    refer to STR's storage.  Return DBT.  */
end_comment

begin_function
name|DBT
modifier|*
name|svn_fs_base__str_to_dbt
parameter_list|(
name|DBT
modifier|*
name|dbt
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|svn_fs_base__set_dbt
argument_list|(
name|dbt
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|dbt
return|;
block|}
end_function

begin_function
name|DBT
modifier|*
name|svn_fs_base__checksum_to_dbt
parameter_list|(
name|DBT
modifier|*
name|dbt
parameter_list|,
name|svn_checksum_t
modifier|*
name|checksum
parameter_list|)
block|{
name|svn_fs_base__set_dbt
argument_list|(
name|dbt
argument_list|,
name|checksum
operator|->
name|digest
argument_list|,
name|svn_checksum_size
argument_list|(
name|checksum
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|dbt
return|;
block|}
end_function

end_unit


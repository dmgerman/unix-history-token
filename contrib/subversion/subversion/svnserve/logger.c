begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * logger.c : Implementation of the SvnServe logger API  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_escape
end_escape

begin_define
define|#
directive|define
name|APR_WANT_STRFUNC
end_define

begin_include
include|#
directive|include
file|<apr_want.h>
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_io.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_time.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_mutex.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"logger.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UNISTD_H
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_comment
comment|/* For getpid() */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|logger_t
block|{
comment|/* actual log file / stream object */
name|svn_stream_t
modifier|*
name|stream
decl_stmt|;
comment|/* mutex used to serialize access to this structure */
name|svn_mutex__t
modifier|*
name|mutex
decl_stmt|;
comment|/* private pool used for temporary allocations */
name|apr_pool_t
modifier|*
name|pool
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|svn_error_t
modifier|*
name|logger__create_for_stderr
parameter_list|(
name|logger_t
modifier|*
modifier|*
name|logger
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|logger_t
modifier|*
name|result
init|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|result
argument_list|)
argument_list|)
decl_stmt|;
name|result
operator|->
name|pool
operator|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_for_stderr
argument_list|(
operator|&
name|result
operator|->
name|stream
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_mutex__init
argument_list|(
operator|&
name|result
operator|->
name|mutex
argument_list|,
name|TRUE
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|logger
operator|=
name|result
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|logger__create
parameter_list|(
name|logger_t
modifier|*
modifier|*
name|logger
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|logger_t
modifier|*
name|result
init|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|result
argument_list|)
argument_list|)
decl_stmt|;
name|apr_file_t
modifier|*
name|file
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_open
argument_list|(
operator|&
name|file
argument_list|,
name|filename
argument_list|,
name|APR_WRITE
operator||
name|APR_CREATE
operator||
name|APR_APPEND
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_mutex__init
argument_list|(
operator|&
name|result
operator|->
name|mutex
argument_list|,
name|TRUE
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|->
name|stream
operator|=
name|svn_stream_from_aprfile2
argument_list|(
name|file
argument_list|,
name|FALSE
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|result
operator|->
name|pool
operator|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
expr_stmt|;
operator|*
name|logger
operator|=
name|result
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|void
name|logger__log_error
parameter_list|(
name|logger_t
modifier|*
name|logger
parameter_list|,
name|svn_error_t
modifier|*
name|err
parameter_list|,
name|repository_t
modifier|*
name|repository
parameter_list|,
name|client_info_t
modifier|*
name|client_info
parameter_list|)
block|{
if|if
condition|(
name|logger
operator|&&
name|err
condition|)
block|{
specifier|const
name|char
modifier|*
name|timestr
decl_stmt|,
modifier|*
name|continuation
decl_stmt|;
specifier|const
name|char
modifier|*
name|user
decl_stmt|,
modifier|*
name|repos
decl_stmt|,
modifier|*
name|remote_host
decl_stmt|;
name|char
name|errbuf
index|[
literal|256
index|]
decl_stmt|;
comment|/* 8192 from MAX_STRING_LEN in from httpd-2.2.4/include/httpd.h */
name|char
name|errstr
index|[
literal|8192
index|]
decl_stmt|;
name|svn_error_clear
argument_list|(
name|svn_mutex__lock
argument_list|(
name|logger
operator|->
name|mutex
argument_list|)
argument_list|)
expr_stmt|;
name|timestr
operator|=
name|svn_time_to_cstring
argument_list|(
name|apr_time_now
argument_list|()
argument_list|,
name|logger
operator|->
name|pool
argument_list|)
expr_stmt|;
name|remote_host
operator|=
name|client_info
operator|&&
name|client_info
operator|->
name|remote_host
condition|?
name|client_info
operator|->
name|remote_host
else|:
literal|"-"
expr_stmt|;
name|user
operator|=
name|client_info
operator|&&
name|client_info
operator|->
name|user
condition|?
name|client_info
operator|->
name|user
else|:
literal|"-"
expr_stmt|;
name|repos
operator|=
name|repository
operator|&&
name|repository
operator|->
name|repos_name
condition|?
name|repository
operator|->
name|repos_name
else|:
literal|"-"
expr_stmt|;
name|continuation
operator|=
literal|""
expr_stmt|;
while|while
condition|(
name|err
condition|)
block|{
specifier|const
name|char
modifier|*
name|message
init|=
name|svn_err_best_message
argument_list|(
name|err
argument_list|,
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|errbuf
argument_list|)
argument_list|)
decl_stmt|;
comment|/* based on httpd-2.2.4/server/log.c:log_error_core */
name|apr_size_t
name|len
init|=
name|apr_snprintf
argument_list|(
name|errstr
argument_list|,
sizeof|sizeof
argument_list|(
name|errstr
argument_list|)
argument_list|,
literal|"%"
name|APR_PID_T_FMT
literal|" %s %s %s %s ERR%s %s %ld %d "
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|timestr
argument_list|,
name|remote_host
argument_list|,
name|user
argument_list|,
name|repos
argument_list|,
name|continuation
argument_list|,
name|err
operator|->
name|file
condition|?
name|err
operator|->
name|file
else|:
literal|"-"
argument_list|,
name|err
operator|->
name|line
argument_list|,
name|err
operator|->
name|apr_err
argument_list|)
decl_stmt|;
name|len
operator|+=
name|escape_errorlog_item
argument_list|(
name|errstr
operator|+
name|len
argument_list|,
name|message
argument_list|,
sizeof|sizeof
argument_list|(
name|errstr
argument_list|)
operator|-
name|len
argument_list|)
expr_stmt|;
comment|/* Truncate for the terminator (as apr_snprintf does) */
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|errstr
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|APR_EOL_STR
argument_list|)
condition|)
block|{
name|len
operator|=
sizeof|sizeof
argument_list|(
name|errstr
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|APR_EOL_STR
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|errstr
operator|+
name|len
argument_list|,
name|APR_EOL_STR
argument_list|,
sizeof|sizeof
argument_list|(
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|+=
sizeof|sizeof
argument_list|(
name|APR_EOL_STR
argument_list|)
operator|-
literal|1
expr_stmt|;
comment|/* add NL, ex terminating NUL */
name|svn_error_clear
argument_list|(
name|svn_stream_write
argument_list|(
name|logger
operator|->
name|stream
argument_list|,
name|errstr
argument_list|,
operator|&
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|continuation
operator|=
literal|"-"
expr_stmt|;
name|err
operator|=
name|err
operator|->
name|child
expr_stmt|;
block|}
name|svn_pool_clear
argument_list|(
name|logger
operator|->
name|pool
argument_list|)
expr_stmt|;
name|svn_error_clear
argument_list|(
name|svn_mutex__unlock
argument_list|(
name|logger
operator|->
name|mutex
argument_list|,
name|SVN_NO_ERROR
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|logger__write
parameter_list|(
name|logger_t
modifier|*
name|logger
parameter_list|,
specifier|const
name|char
modifier|*
name|errstr
parameter_list|,
name|apr_size_t
name|len
parameter_list|)
block|{
name|SVN_MUTEX__WITH_LOCK
argument_list|(
name|logger
operator|->
name|mutex
argument_list|,
name|svn_stream_write
argument_list|(
name|logger
operator|->
name|stream
argument_list|,
name|errstr
argument_list|,
operator|&
name|len
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


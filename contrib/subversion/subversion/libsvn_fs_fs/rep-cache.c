begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* rep-sharing.c --- the rep-sharing cache for fsfs  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"fs_fs.h"
end_include

begin_include
include|#
directive|include
file|"fs.h"
end_include

begin_include
include|#
directive|include
file|"rep-cache.h"
end_include

begin_include
include|#
directive|include
file|"../libsvn_fs/fs-loader.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_sqlite.h"
end_include

begin_include
include|#
directive|include
file|"rep-cache-db.h"
end_include

begin_comment
comment|/* A few magic values */
end_comment

begin_define
define|#
directive|define
name|REP_CACHE_SCHEMA_FORMAT
value|1
end_define

begin_expr_stmt
name|REP_CACHE_DB_SQL_DECLARE_STATEMENTS
argument_list|(
name|statements
argument_list|)
expr_stmt|;
end_expr_stmt

begin_escape
end_escape

begin_comment
comment|/** Helper functions. **/
end_comment

begin_function
specifier|static
name|APR_INLINE
specifier|const
name|char
modifier|*
name|path_rep_cache_db
parameter_list|(
specifier|const
name|char
modifier|*
name|fs_path
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs_path
argument_list|,
name|REP_CACHE_DB_NAME
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|SVN_ERR_CLOSE
parameter_list|(
name|x
parameter_list|,
name|db
parameter_list|)
value|do                                       \ {                                                                     \   svn_error_t *svn__err = (x);                                        \   if (svn__err)                                                       \     return svn_error_compose_create(svn__err, svn_sqlite__close(db)); \ } while (0)
end_define

begin_escape
end_escape

begin_comment
comment|/** Library-private API's. **/
end_comment

begin_comment
comment|/* Body of svn_fs_fs__open_rep_cache().    Implements svn_atomic__init_once().init_func.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|open_rep_cache
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_fs_t
modifier|*
name|fs
init|=
name|baton
decl_stmt|;
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|svn_sqlite__db_t
modifier|*
name|sdb
decl_stmt|;
specifier|const
name|char
modifier|*
name|db_path
decl_stmt|;
name|int
name|version
decl_stmt|;
comment|/* Open (or create) the sqlite database.  It will be automatically      closed when fs->pool is destroyed. */
name|db_path
operator|=
name|path_rep_cache_db
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|pool
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|WIN32
block|{
comment|/* We want to extend the permissions that apply to the repository        as a whole when creating a new rep cache and not simply default        to umask. */
name|svn_boolean_t
name|exists
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_fs_fs__exists_rep_cache
argument_list|(
operator|&
name|exists
argument_list|,
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|exists
condition|)
block|{
specifier|const
name|char
modifier|*
name|current
init|=
name|svn_fs_fs__path_current
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|svn_io_file_create_empty
argument_list|(
name|db_path
argument_list|,
name|pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
operator|&&
operator|!
name|APR_STATUS_IS_EEXIST
argument_list|(
name|err
operator|->
name|apr_err
argument_list|)
condition|)
comment|/* A real error. */
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
elseif|else
if|if
condition|(
name|err
condition|)
comment|/* Some other thread/process created the file. */
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
else|else
comment|/* We created the file. */
name|SVN_ERR
argument_list|(
name|svn_io_copy_perms
argument_list|(
name|current
argument_list|,
name|db_path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|SVN_ERR
argument_list|(
name|svn_sqlite__open
argument_list|(
operator|&
name|sdb
argument_list|,
name|db_path
argument_list|,
name|svn_sqlite__mode_rwcreate
argument_list|,
name|statements
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|fs
operator|->
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_CLOSE
argument_list|(
name|svn_sqlite__read_schema_version
argument_list|(
operator|&
name|version
argument_list|,
name|sdb
argument_list|,
name|pool
argument_list|)
argument_list|,
name|sdb
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|<
name|REP_CACHE_SCHEMA_FORMAT
condition|)
block|{
comment|/* Must be 0 -- an uninitialized (no schema) database. Create          the schema. Results in schema version of 1.  */
name|SVN_ERR_CLOSE
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|sdb
argument_list|,
name|STMT_CREATE_SCHEMA
argument_list|)
argument_list|,
name|sdb
argument_list|)
expr_stmt|;
block|}
comment|/* This is used as a flag that the database is available so don't      set it earlier. */
name|ffd
operator|->
name|rep_cache_db
operator|=
name|sdb
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__open_rep_cache
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|svn_atomic__init_once
argument_list|(
operator|&
name|ffd
operator|->
name|rep_cache_db_opened
argument_list|,
name|open_rep_cache
argument_list|,
name|fs
argument_list|,
name|pool
argument_list|)
decl_stmt|;
return|return
name|svn_error_quick_wrapf
argument_list|(
name|err
argument_list|,
name|_
argument_list|(
literal|"Couldn't open rep-cache database '%s'"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|path_rep_cache_db
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|pool
argument_list|)
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__close_rep_cache
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
if|if
condition|(
name|ffd
operator|->
name|rep_cache_db
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__close
argument_list|(
name|ffd
operator|->
name|rep_cache_db
argument_list|)
argument_list|)
expr_stmt|;
name|ffd
operator|->
name|rep_cache_db
operator|=
name|NULL
expr_stmt|;
name|ffd
operator|->
name|rep_cache_db_opened
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__exists_rep_cache
parameter_list|(
name|svn_boolean_t
modifier|*
name|exists
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_check_path
argument_list|(
name|path_rep_cache_db
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|pool
argument_list|)
argument_list|,
operator|&
name|kind
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|exists
operator|=
operator|(
name|kind
operator|!=
name|svn_node_none
operator|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__walk_rep_reference
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|start
parameter_list|,
name|svn_revnum_t
name|end
parameter_list|,
name|svn_error_t
modifier|*
function_decl|(
modifier|*
name|walker
function_decl|)
parameter_list|(
name|representation_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|svn_fs_t
modifier|*
parameter_list|,
name|apr_pool_t
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|walker_baton
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|iterations
init|=
literal|0
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
decl_stmt|;
comment|/* Don't check ffd->rep_sharing_allowed. */
name|SVN_ERR_ASSERT
argument_list|(
name|ffd
operator|->
name|format
operator|>=
name|SVN_FS_FS__MIN_REP_SHARING_FORMAT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ffd
operator|->
name|rep_cache_db
condition|)
name|SVN_ERR
argument_list|(
name|svn_fs_fs__open_rep_cache
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check global invariants. */
if|if
condition|(
name|start
operator|==
literal|0
condition|)
block|{
name|svn_revnum_t
name|max
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|ffd
operator|->
name|rep_cache_db
argument_list|,
name|STMT_GET_MAX_REV
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|max
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|max
argument_list|)
condition|)
comment|/* The rep-cache could be empty. */
name|SVN_ERR
argument_list|(
name|svn_fs_fs__ensure_revision_exists
argument_list|(
name|max
argument_list|,
name|fs
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|ffd
operator|->
name|rep_cache_db
argument_list|,
name|STMT_GET_REPS_FOR_RANGE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"rr"
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Walk the cache entries. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|representation_t
modifier|*
name|rep
decl_stmt|;
specifier|const
name|char
modifier|*
name|sha1_digest
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
comment|/* Clear ITERPOOL occasionally. */
if|if
condition|(
name|iterations
operator|++
operator|%
literal|16
operator|==
literal|0
condition|)
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
comment|/* Check for cancellation. */
if|if
condition|(
name|cancel_func
condition|)
block|{
name|err
operator|=
name|cancel_func
argument_list|(
name|cancel_baton
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
comment|/* Construct a representation_t. */
name|rep
operator|=
name|apr_pcalloc
argument_list|(
name|iterpool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rep
argument_list|)
argument_list|)
expr_stmt|;
name|svn_fs_fs__id_txn_reset
argument_list|(
operator|&
name|rep
operator|->
name|txn_id
argument_list|)
expr_stmt|;
name|sha1_digest
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_checksum_parse_hex
argument_list|(
operator|&
name|checksum
argument_list|,
name|svn_checksum_sha1
argument_list|,
name|sha1_digest
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
name|rep
operator|->
name|has_sha1
operator|=
name|TRUE
expr_stmt|;
name|memcpy
argument_list|(
name|rep
operator|->
name|sha1_digest
argument_list|,
name|checksum
operator|->
name|digest
argument_list|,
sizeof|sizeof
argument_list|(
name|rep
operator|->
name|sha1_digest
argument_list|)
argument_list|)
expr_stmt|;
name|rep
operator|->
name|revision
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rep
operator|->
name|item_index
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|rep
operator|->
name|size
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|rep
operator|->
name|expanded_size
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* Walk. */
name|err
operator|=
name|walker
argument_list|(
name|rep
argument_list|,
name|walker_baton
argument_list|,
name|fs
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* This function's caller ignores most errors it returns.    If you extend this function, check the callsite to see if you have    to make it not-ignore additional error codes.  */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__get_rep_reference
parameter_list|(
name|representation_t
modifier|*
modifier|*
name|rep
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_checksum_t
modifier|*
name|checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|ffd
operator|->
name|rep_sharing_allowed
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ffd
operator|->
name|rep_cache_db
condition|)
name|SVN_ERR
argument_list|(
name|svn_fs_fs__open_rep_cache
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We only allow SHA1 checksums in this table. */
if|if
condition|(
name|checksum
operator|->
name|kind
operator|!=
name|svn_checksum_sha1
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_BAD_CHECKSUM_KIND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Only SHA1 checksums can be used as keys in the "
literal|"rep_cache table.\n"
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|ffd
operator|->
name|rep_cache_db
argument_list|,
name|STMT_GET_REP
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"s"
argument_list|,
name|svn_checksum_to_cstring
argument_list|(
name|checksum
argument_list|,
name|pool
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
operator|*
name|rep
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|rep
argument_list|)
argument_list|)
expr_stmt|;
name|svn_fs_fs__id_txn_reset
argument_list|(
operator|&
operator|(
operator|*
name|rep
operator|)
operator|->
name|txn_id
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
operator|*
name|rep
operator|)
operator|->
name|sha1_digest
argument_list|,
name|checksum
operator|->
name|digest
argument_list|,
sizeof|sizeof
argument_list|(
operator|(
operator|*
name|rep
operator|)
operator|->
name|sha1_digest
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|rep
operator|)
operator|->
name|has_sha1
operator|=
name|TRUE
expr_stmt|;
operator|(
operator|*
name|rep
operator|)
operator|->
name|revision
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
operator|*
name|rep
operator|)
operator|->
name|item_index
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|(
operator|*
name|rep
operator|)
operator|->
name|size
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
operator|(
operator|*
name|rep
operator|)
operator|->
name|expanded_size
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
operator|*
name|rep
operator|=
name|NULL
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|rep
condition|)
block|{
comment|/* Check that REP refers to a revision that exists in FS. */
name|svn_error_t
modifier|*
name|err
init|=
name|svn_fs_fs__ensure_revision_exists
argument_list|(
operator|(
operator|*
name|rep
operator|)
operator|->
name|revision
argument_list|,
name|fs
argument_list|,
name|pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_CORRUPT
argument_list|,
name|err
argument_list|,
literal|"Checksum '%s' in rep-cache is beyond HEAD"
argument_list|,
name|svn_checksum_to_cstring_display
argument_list|(
name|checksum
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__set_rep_reference
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|representation_t
modifier|*
name|rep
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_checksum_t
name|checksum
decl_stmt|;
name|checksum
operator|.
name|kind
operator|=
name|svn_checksum_sha1
expr_stmt|;
name|checksum
operator|.
name|digest
operator|=
name|rep
operator|->
name|sha1_digest
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|ffd
operator|->
name|rep_sharing_allowed
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ffd
operator|->
name|rep_cache_db
condition|)
name|SVN_ERR
argument_list|(
name|svn_fs_fs__open_rep_cache
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We only allow SHA1 checksums in this table. */
if|if
condition|(
operator|!
name|rep
operator|->
name|has_sha1
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_BAD_CHECKSUM_KIND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Only SHA1 checksums can be used as keys in the "
literal|"rep_cache table.\n"
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|ffd
operator|->
name|rep_cache_db
argument_list|,
name|STMT_SET_REP
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"siiii"
argument_list|,
name|svn_checksum_to_cstring
argument_list|(
operator|&
name|checksum
argument_list|,
name|pool
argument_list|)
argument_list|,
operator|(
name|apr_int64_t
operator|)
name|rep
operator|->
name|revision
argument_list|,
operator|(
name|apr_int64_t
operator|)
name|rep
operator|->
name|item_index
argument_list|,
operator|(
name|apr_int64_t
operator|)
name|rep
operator|->
name|size
argument_list|,
operator|(
name|apr_int64_t
operator|)
name|rep
operator|->
name|expanded_size
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_sqlite__insert
argument_list|(
name|NULL
argument_list|,
name|stmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|representation_t
modifier|*
name|old_rep
decl_stmt|;
if|if
condition|(
name|err
operator|->
name|apr_err
operator|!=
name|SVN_ERR_SQLITE_CONSTRAINT
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
comment|/* Constraint failed so the mapping for SHA1_CHECKSUM->REP          should exist.  If so that's cool -- just do nothing.  If not,          that's a red flag!  */
name|SVN_ERR
argument_list|(
name|svn_fs_fs__get_rep_reference
argument_list|(
operator|&
name|old_rep
argument_list|,
name|fs
argument_list|,
operator|&
name|checksum
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|old_rep
condition|)
block|{
comment|/* Something really odd at this point, we failed to insert the              checksum AND failed to read an existing checksum.  Do we need              to flag this? */
block|}
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__del_rep_reference
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|youngest
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|ffd
operator|->
name|format
operator|>=
name|SVN_FS_FS__MIN_REP_SHARING_FORMAT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ffd
operator|->
name|rep_cache_db
condition|)
name|SVN_ERR
argument_list|(
name|svn_fs_fs__open_rep_cache
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|ffd
operator|->
name|rep_cache_db
argument_list|,
name|STMT_DEL_REPS_YOUNGER_THAN_REV
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"r"
argument_list|,
name|youngest
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Start a transaction to take an SQLite reserved lock that prevents    other writes.     See unlock_rep_cache(). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|lock_rep_cache
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
if|if
condition|(
operator|!
name|ffd
operator|->
name|rep_cache_db
condition|)
name|SVN_ERR
argument_list|(
name|svn_fs_fs__open_rep_cache
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|ffd
operator|->
name|rep_cache_db
argument_list|,
name|STMT_LOCK_REP
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* End the transaction started by lock_rep_cache(). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|unlock_rep_cache
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|ffd
operator|->
name|rep_cache_db
argument_list|)
expr_stmt|;
comment|/* was opened by lock_rep_cache() */
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|ffd
operator|->
name|rep_cache_db
argument_list|,
name|STMT_UNLOCK_REP
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__with_rep_cache_lock
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_error_t
modifier|*
function_decl|(
modifier|*
name|body
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|apr_pool_t
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|SVN_ERR
argument_list|(
name|lock_rep_cache
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|body
argument_list|(
name|baton
argument_list|,
name|pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|unlock_rep_cache
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* util.c --- utility functions for FSFS repo access  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|"svn_ctype.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_string_private.h"
end_include

begin_include
include|#
directive|include
file|"fs_fs.h"
end_include

begin_include
include|#
directive|include
file|"pack.h"
end_include

begin_include
include|#
directive|include
file|"util.h"
end_include

begin_include
include|#
directive|include
file|"../libsvn_fs/fs-loader.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_function
name|svn_boolean_t
name|svn_fs_fs__is_packed_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
return|return
operator|(
name|rev
operator|<
name|ffd
operator|->
name|min_unpacked_rev
operator|)
return|;
block|}
end_function

begin_function
name|svn_boolean_t
name|svn_fs_fs__is_packed_revprop
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
comment|/* rev 0 will not be packed */
return|return
operator|(
name|rev
operator|<
name|ffd
operator|->
name|min_unpacked_rev
operator|)
operator|&&
operator|(
name|rev
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|ffd
operator|->
name|format
operator|>=
name|SVN_FS_FS__MIN_PACKED_REVPROP_FORMAT
operator|)
return|;
block|}
end_function

begin_function
name|svn_revnum_t
name|svn_fs_fs__packed_base_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
return|return
operator|(
name|revision
operator|<
name|ffd
operator|->
name|min_unpacked_rev
operator|)
condition|?
operator|(
name|revision
operator|-
operator|(
name|revision
operator|%
name|ffd
operator|->
name|max_files_per_dir
operator|)
operator|)
else|:
name|revision
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_txn_current
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_TXN_CURRENT
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_txn_current_lock
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_TXN_CURRENT_LOCK
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_lock
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_LOCK_FILE
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_pack_lock
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_PACK_LOCK_FILE
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_revprop_generation
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_REVPROP_GENERATION
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_rev_packed
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|kind
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|assert
argument_list|(
name|ffd
operator|->
name|max_files_per_dir
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|svn_fs_fs__is_packed_rev
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_dirent_join_many
argument_list|(
name|pool
argument_list|,
name|fs
operator|->
name|path
argument_list|,
name|PATH_REVS_DIR
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%ld"
name|PATH_EXT_PACKED_SHARD
argument_list|,
name|rev
operator|/
name|ffd
operator|->
name|max_files_per_dir
argument_list|)
argument_list|,
name|kind
argument_list|,
name|SVN_VA_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_rev_shard
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|assert
argument_list|(
name|ffd
operator|->
name|max_files_per_dir
argument_list|)
expr_stmt|;
return|return
name|svn_dirent_join_many
argument_list|(
name|pool
argument_list|,
name|fs
operator|->
name|path
argument_list|,
name|PATH_REVS_DIR
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%ld"
argument_list|,
name|rev
operator|/
name|ffd
operator|->
name|max_files_per_dir
argument_list|)
argument_list|,
name|SVN_VA_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|assert
argument_list|(
operator|!
name|svn_fs_fs__is_packed_rev
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ffd
operator|->
name|max_files_per_dir
condition|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|svn_fs_fs__path_rev_shard
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|pool
argument_list|)
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%ld"
argument_list|,
name|rev
argument_list|)
argument_list|,
name|pool
argument_list|)
return|;
block|}
return|return
name|svn_dirent_join_many
argument_list|(
name|pool
argument_list|,
name|fs
operator|->
name|path
argument_list|,
name|PATH_REVS_DIR
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%ld"
argument_list|,
name|rev
argument_list|)
argument_list|,
name|SVN_VA_NULL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Set *PATH to the path of REV in FS with PACKED selecting whether the    (potential) pack file or single revision file name is returned.    Allocate *PATH in POOL. */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|path_rev_absolute_internal
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|svn_boolean_t
name|packed
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|packed
condition|?
name|svn_fs_fs__path_rev_packed
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|PATH_PACKED
argument_list|,
name|pool
argument_list|)
else|:
name|svn_fs_fs__path_rev
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_rev_absolute
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|svn_boolean_t
name|is_packed
init|=
name|ffd
operator|->
name|format
operator|>=
name|SVN_FS_FS__MIN_PACKED_FORMAT
operator|&&
name|svn_fs_fs__is_packed_rev
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|)
decl_stmt|;
return|return
name|path_rev_absolute_internal
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|is_packed
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_revprops_shard
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|assert
argument_list|(
name|ffd
operator|->
name|max_files_per_dir
argument_list|)
expr_stmt|;
return|return
name|svn_dirent_join_many
argument_list|(
name|pool
argument_list|,
name|fs
operator|->
name|path
argument_list|,
name|PATH_REVPROPS_DIR
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%ld"
argument_list|,
name|rev
operator|/
name|ffd
operator|->
name|max_files_per_dir
argument_list|)
argument_list|,
name|SVN_VA_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_revprops_pack_shard
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|assert
argument_list|(
name|ffd
operator|->
name|max_files_per_dir
argument_list|)
expr_stmt|;
return|return
name|svn_dirent_join_many
argument_list|(
name|pool
argument_list|,
name|fs
operator|->
name|path
argument_list|,
name|PATH_REVPROPS_DIR
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%ld"
name|PATH_EXT_PACKED_SHARD
argument_list|,
name|rev
operator|/
name|ffd
operator|->
name|max_files_per_dir
argument_list|)
argument_list|,
name|SVN_VA_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_revprops
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
if|if
condition|(
name|ffd
operator|->
name|max_files_per_dir
condition|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|svn_fs_fs__path_revprops_shard
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|pool
argument_list|)
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%ld"
argument_list|,
name|rev
argument_list|)
argument_list|,
name|pool
argument_list|)
return|;
block|}
return|return
name|svn_dirent_join_many
argument_list|(
name|pool
argument_list|,
name|fs
operator|->
name|path
argument_list|,
name|PATH_REVPROPS_DIR
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%ld"
argument_list|,
name|rev
argument_list|)
argument_list|,
name|SVN_VA_NULL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Return TO_ADD appended to the C string representation of TXN_ID.  * Allocate the result in POOL.  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|combine_txn_id_string
parameter_list|(
specifier|const
name|svn_fs_fs__id_part_t
modifier|*
name|txn_id
parameter_list|,
specifier|const
name|char
modifier|*
name|to_add
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|apr_pstrcat
argument_list|(
name|pool
argument_list|,
name|svn_fs_fs__id_txn_unparse
argument_list|(
name|txn_id
argument_list|,
name|pool
argument_list|)
argument_list|,
name|to_add
argument_list|,
name|SVN_VA_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_txns_dir
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_TXNS_DIR
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_txn_dir
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_fs__id_part_t
modifier|*
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|SVN_ERR_ASSERT_NO_RETURN
argument_list|(
name|txn_id
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
name|svn_dirent_join
argument_list|(
name|svn_fs_fs__path_txns_dir
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|,
name|combine_txn_id_string
argument_list|(
name|txn_id
argument_list|,
name|PATH_EXT_TXN
argument_list|,
name|pool
argument_list|)
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_l2p_proto_index
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_fs__id_part_t
modifier|*
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
argument|svn_fs_fs__path_txn_dir(fs, txn_id, pool)
argument_list|,
argument|PATH_INDEX PATH_EXT_L2P_INDEX
argument_list|,
argument|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_p2l_proto_index
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_fs__id_part_t
modifier|*
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
argument|svn_fs_fs__path_txn_dir(fs, txn_id, pool)
argument_list|,
argument|PATH_INDEX PATH_EXT_P2L_INDEX
argument_list|,
argument|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_txn_item_index
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_fs__id_part_t
modifier|*
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|svn_fs_fs__path_txn_dir
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|pool
argument_list|)
argument_list|,
name|PATH_TXN_ITEM_INDEX
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_txn_proto_revs
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_TXN_PROTOS_DIR
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_txn_proto_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_fs__id_part_t
modifier|*
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
if|if
condition|(
name|ffd
operator|->
name|format
operator|>=
name|SVN_FS_FS__MIN_PROTOREVS_DIR_FORMAT
condition|)
return|return
name|svn_dirent_join
argument_list|(
name|svn_fs_fs__path_txn_proto_revs
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|,
name|combine_txn_id_string
argument_list|(
name|txn_id
argument_list|,
name|PATH_EXT_REV
argument_list|,
name|pool
argument_list|)
argument_list|,
name|pool
argument_list|)
return|;
else|else
return|return
name|svn_dirent_join
argument_list|(
name|svn_fs_fs__path_txn_dir
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|pool
argument_list|)
argument_list|,
name|PATH_REV
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_txn_proto_rev_lock
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_fs__id_part_t
modifier|*
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
if|if
condition|(
name|ffd
operator|->
name|format
operator|>=
name|SVN_FS_FS__MIN_PROTOREVS_DIR_FORMAT
condition|)
return|return
name|svn_dirent_join
argument_list|(
name|svn_fs_fs__path_txn_proto_revs
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|,
name|combine_txn_id_string
argument_list|(
name|txn_id
argument_list|,
name|PATH_EXT_REV_LOCK
argument_list|,
name|pool
argument_list|)
argument_list|,
name|pool
argument_list|)
return|;
else|else
return|return
name|svn_dirent_join
argument_list|(
name|svn_fs_fs__path_txn_dir
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|pool
argument_list|)
argument_list|,
name|PATH_REV_LOCK
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_txn_node_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_id_t
modifier|*
name|id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|char
modifier|*
name|filename
init|=
operator|(
name|char
operator|*
operator|)
name|svn_fs_fs__id_unparse
argument_list|(
name|id
argument_list|,
name|pool
argument_list|)
operator|->
name|data
decl_stmt|;
operator|*
name|strrchr
argument_list|(
name|filename
argument_list|,
literal|'.'
argument_list|)
operator|=
literal|'\0'
expr_stmt|;
return|return
name|svn_dirent_join
argument_list|(
name|svn_fs_fs__path_txn_dir
argument_list|(
name|fs
argument_list|,
name|svn_fs_fs__id_txn_id
argument_list|(
name|id
argument_list|)
argument_list|,
name|pool
argument_list|)
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
name|PATH_PREFIX_NODE
literal|"%s"
argument_list|,
name|filename
argument_list|)
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_txn_node_props
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_id_t
modifier|*
name|id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|apr_pstrcat
argument_list|(
name|pool
argument_list|,
name|svn_fs_fs__path_txn_node_rev
argument_list|(
name|fs
argument_list|,
name|id
argument_list|,
name|pool
argument_list|)
argument_list|,
name|PATH_EXT_PROPS
argument_list|,
name|SVN_VA_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_txn_node_children
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_id_t
modifier|*
name|id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|apr_pstrcat
argument_list|(
name|pool
argument_list|,
name|svn_fs_fs__path_txn_node_rev
argument_list|(
name|fs
argument_list|,
name|id
argument_list|,
name|pool
argument_list|)
argument_list|,
name|PATH_EXT_CHILDREN
argument_list|,
name|SVN_VA_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_node_origin
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_fs__id_part_t
modifier|*
name|node_id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|char
name|buffer
index|[
name|SVN_INT64_BUFFER_SIZE
index|]
decl_stmt|;
name|apr_size_t
name|len
init|=
name|svn__ui64tobase36
argument_list|(
name|buffer
argument_list|,
name|node_id
operator|->
name|number
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
operator|>
literal|1
condition|)
name|buffer
index|[
name|len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|svn_dirent_join_many
argument_list|(
name|pool
argument_list|,
name|fs
operator|->
name|path
argument_list|,
name|PATH_NODE_ORIGINS_DIR
argument_list|,
name|buffer
argument_list|,
name|SVN_VA_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_fs__path_min_unpacked_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_MIN_UNPACKED_REV
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__check_file_buffer_numeric
parameter_list|(
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|apr_off_t
name|offset
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|title
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
name|buf
operator|+
name|offset
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
if|if
condition|(
operator|!
name|svn_ctype_isdigit
argument_list|(
operator|*
name|p
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_BAD_VERSION_FILE_FORMAT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"%s file '%s' contains unexpected non-digit '%c' within '%s'"
argument_list|)
argument_list|,
name|title
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|path
argument_list|,
name|pool
argument_list|)
argument_list|,
operator|*
name|p
argument_list|,
name|buf
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__read_min_unpacked_rev
parameter_list|(
name|svn_revnum_t
modifier|*
name|min_unpacked_rev
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
name|apr_file_t
modifier|*
name|file
decl_stmt|;
name|apr_size_t
name|len
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_open
argument_list|(
operator|&
name|file
argument_list|,
name|svn_fs_fs__path_min_unpacked_rev
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|,
name|APR_READ
operator||
name|APR_BUFFERED
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_read_length_line
argument_list|(
name|file
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_close
argument_list|(
name|file
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_revnum_parse
argument_list|(
name|min_unpacked_rev
argument_list|,
name|buf
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__update_min_unpacked_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|ffd
operator|->
name|format
operator|>=
name|SVN_FS_FS__MIN_PACKED_FORMAT
argument_list|)
expr_stmt|;
return|return
name|svn_fs_fs__read_min_unpacked_rev
argument_list|(
operator|&
name|ffd
operator|->
name|min_unpacked_rev
argument_list|,
name|fs
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__write_min_unpacked_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|revnum
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|final_path
decl_stmt|;
name|char
name|buf
index|[
name|SVN_INT64_BUFFER_SIZE
index|]
decl_stmt|;
name|apr_size_t
name|len
init|=
name|svn__i64toa
argument_list|(
name|buf
argument_list|,
name|revnum
argument_list|)
decl_stmt|;
name|buf
index|[
name|len
index|]
operator|=
literal|'\n'
expr_stmt|;
name|final_path
operator|=
name|svn_fs_fs__path_min_unpacked_rev
argument_list|(
name|fs
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_write_atomic
argument_list|(
name|final_path
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|,
name|final_path
comment|/* copy_perms */
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__read_current
parameter_list|(
name|svn_revnum_t
modifier|*
name|rev
parameter_list|,
name|apr_uint64_t
modifier|*
name|next_node_id
parameter_list|,
name|apr_uint64_t
modifier|*
name|next_copy_id
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|svn_stringbuf_t
modifier|*
name|content
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_fs_fs__read_content
argument_list|(
operator|&
name|content
argument_list|,
name|svn_fs_fs__path_current
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ffd
operator|->
name|format
operator|>=
name|SVN_FS_FS__MIN_NO_GLOBAL_IDS_FORMAT
condition|)
block|{
comment|/* When format 1 and 2 filesystems are upgraded, the 'current' file is          left intact.  As a consequence, there is a window when a filesystem          has a new format, but this file still contains the IDs left from an          old format, i.e. looks like "359 j5 v\n".  Do not be too strict here          and only expect a parseable revision number. */
name|SVN_ERR
argument_list|(
name|svn_revnum_parse
argument_list|(
name|rev
argument_list|,
name|content
operator|->
name|data
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|next_node_id
operator|=
literal|0
expr_stmt|;
operator|*
name|next_copy_id
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_revnum_parse
argument_list|(
name|rev
argument_list|,
name|content
operator|->
name|data
argument_list|,
operator|&
name|str
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|str
operator|!=
literal|' '
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_FS_CORRUPT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Corrupt 'current' file"
argument_list|)
argument_list|)
return|;
operator|*
name|next_node_id
operator|=
name|svn__base36toui64
argument_list|(
operator|&
name|str
argument_list|,
name|str
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|str
operator|!=
literal|' '
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_FS_CORRUPT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Corrupt 'current' file"
argument_list|)
argument_list|)
return|;
operator|*
name|next_copy_id
operator|=
name|svn__base36toui64
argument_list|(
operator|&
name|str
argument_list|,
name|str
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|str
operator|!=
literal|'\n'
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_FS_CORRUPT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Corrupt 'current' file"
argument_list|)
argument_list|)
return|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__write_current
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_uint64_t
name|next_node_id
parameter_list|,
name|apr_uint64_t
name|next_copy_id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
comment|/* Now we can just write out this line. */
if|if
condition|(
name|ffd
operator|->
name|format
operator|>=
name|SVN_FS_FS__MIN_NO_GLOBAL_IDS_FORMAT
condition|)
block|{
name|buf
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%ld\n"
argument_list|,
name|rev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
name|node_id_str
index|[
name|SVN_INT64_BUFFER_SIZE
index|]
decl_stmt|;
name|char
name|copy_id_str
index|[
name|SVN_INT64_BUFFER_SIZE
index|]
decl_stmt|;
name|svn__ui64tobase36
argument_list|(
name|node_id_str
argument_list|,
name|next_node_id
argument_list|)
expr_stmt|;
name|svn__ui64tobase36
argument_list|(
name|copy_id_str
argument_list|,
name|next_copy_id
argument_list|)
expr_stmt|;
name|buf
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%ld %s %s\n"
argument_list|,
name|rev
argument_list|,
name|node_id_str
argument_list|,
name|copy_id_str
argument_list|)
expr_stmt|;
block|}
name|name
operator|=
name|svn_fs_fs__path_current
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_write_atomic
argument_list|(
name|name
argument_list|,
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|name
comment|/* copy_perms_path */
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__try_stringbuf_from_file
parameter_list|(
name|svn_stringbuf_t
modifier|*
modifier|*
name|content
parameter_list|,
name|svn_boolean_t
modifier|*
name|missing
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_boolean_t
name|last_attempt
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|svn_stringbuf_from_file2
argument_list|(
name|content
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|missing
condition|)
operator|*
name|missing
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
operator|*
name|content
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|APR_STATUS_IS_ENOENT
argument_list|(
name|err
operator|->
name|apr_err
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|last_attempt
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|missing
condition|)
operator|*
name|missing
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
ifdef|#
directive|ifdef
name|ESTALE
elseif|else
if|if
condition|(
name|APR_TO_OS_ERROR
argument_list|(
name|err
operator|->
name|apr_err
argument_list|)
operator|==
name|ESTALE
operator|||
name|APR_TO_OS_ERROR
argument_list|(
name|err
operator|->
name|apr_err
argument_list|)
operator|==
name|EIO
condition|)
block|{
if|if
condition|(
operator|!
name|last_attempt
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
endif|#
directive|endif
block|}
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__get_file_offset
parameter_list|(
name|apr_off_t
modifier|*
name|offset_p
parameter_list|,
name|apr_file_t
modifier|*
name|file
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_off_t
name|offset
decl_stmt|;
comment|/* Note that, for buffered files, one (possibly surprising) side-effect      of this call is to flush any unwritten data to disk. */
name|offset
operator|=
literal|0
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_seek
argument_list|(
name|file
argument_list|,
name|APR_CUR
argument_list|,
operator|&
name|offset
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|offset_p
operator|=
name|offset
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__read_content
parameter_list|(
name|svn_stringbuf_t
modifier|*
modifier|*
name|content
parameter_list|,
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
operator|*
name|content
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
operator|*
name|content
operator|&&
operator|(
name|i
operator|<
name|SVN_FS_FS__RECOVERABLE_RETRY_COUNT
operator|)
condition|;
operator|++
name|i
control|)
name|SVN_ERR
argument_list|(
name|svn_fs_fs__try_stringbuf_from_file
argument_list|(
name|content
argument_list|,
name|NULL
argument_list|,
name|fname
argument_list|,
name|i
operator|+
literal|1
operator|<
name|SVN_FS_FS__RECOVERABLE_RETRY_COUNT
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|content
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_CORRUPT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't read '%s'"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|fname
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__read_number_from_stream
parameter_list|(
name|apr_int64_t
modifier|*
name|result
parameter_list|,
name|svn_boolean_t
modifier|*
name|hit_eof
parameter_list|,
name|svn_stream_t
modifier|*
name|stream
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_stringbuf_t
modifier|*
name|sb
decl_stmt|;
name|svn_boolean_t
name|eof
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_readline
argument_list|(
name|stream
argument_list|,
operator|&
name|sb
argument_list|,
literal|"\n"
argument_list|,
operator|&
name|eof
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hit_eof
condition|)
operator|*
name|hit_eof
operator|=
name|eof
expr_stmt|;
elseif|else
if|if
condition|(
name|eof
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_FS_CORRUPT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Unexpected EOF"
argument_list|)
argument_list|)
return|;
if|if
condition|(
operator|!
name|eof
condition|)
block|{
name|err
operator|=
name|svn_cstring_atoi64
argument_list|(
name|result
argument_list|,
name|sb
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_CORRUPT
argument_list|,
name|err
argument_list|,
name|_
argument_list|(
literal|"Number '%s' invalid or too large"
argument_list|)
argument_list|,
name|sb
operator|->
name|data
argument_list|)
return|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_fs__move_into_place
parameter_list|(
specifier|const
name|char
modifier|*
name|old_filename
parameter_list|,
specifier|const
name|char
modifier|*
name|new_filename
parameter_list|,
specifier|const
name|char
modifier|*
name|perms_reference
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_copy_perms
argument_list|(
name|perms_reference
argument_list|,
name|old_filename
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Move the file into place. */
name|err
operator|=
name|svn_io_file_rename
argument_list|(
name|old_filename
argument_list|,
name|new_filename
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|APR_STATUS_IS_EXDEV
argument_list|(
name|err
operator|->
name|apr_err
argument_list|)
condition|)
block|{
name|apr_file_t
modifier|*
name|file
decl_stmt|;
comment|/* Can't rename across devices; fall back to copying. */
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|err
operator|=
name|SVN_NO_ERROR
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_copy_file
argument_list|(
name|old_filename
argument_list|,
name|new_filename
argument_list|,
name|TRUE
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Flush the target of the copy to disk. */
name|SVN_ERR
argument_list|(
name|svn_io_file_open
argument_list|(
operator|&
name|file
argument_list|,
name|new_filename
argument_list|,
name|APR_READ
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### BH: Does this really guarantee a flush of the data written          ### via a completely different handle on all operating systems?          ###          ### Maybe we should perform the copy ourselves instead of making          ### apr do that and flush the real handle? */
name|SVN_ERR
argument_list|(
name|svn_io_file_flush_to_disk
argument_list|(
name|file
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_close
argument_list|(
name|file
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
ifdef|#
directive|ifdef
name|__linux__
block|{
comment|/* Linux has the unusual feature that fsync() on a file is not        enough to ensure that a file's directory entries have been        flushed to disk; you have to fsync the directory as well.        On other operating systems, we'd only be asking for trouble        by trying to open and fsync a directory. */
specifier|const
name|char
modifier|*
name|dirname
decl_stmt|;
name|apr_file_t
modifier|*
name|file
decl_stmt|;
name|dirname
operator|=
name|svn_dirent_dirname
argument_list|(
name|new_filename
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_open
argument_list|(
operator|&
name|file
argument_list|,
name|dirname
argument_list|,
name|APR_READ
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_flush_to_disk
argument_list|(
name|file
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_close
argument_list|(
name|file
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_boolean_t
name|svn_fs_fs__use_log_addressing
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|)
block|{
name|fs_fs_data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
return|return
name|ffd
operator|->
name|use_log_addressing
return|;
block|}
end_function

end_unit


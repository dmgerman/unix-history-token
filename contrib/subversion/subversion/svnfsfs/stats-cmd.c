begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* stats-cmd.c -- implements the size stats sub-command.  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|"svn_fs.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_sorts.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_sorts_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_string_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_fs_fs_private.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"svnfsfs.h"
end_include

begin_comment
comment|/* Return the string, allocated in RESULT_POOL, describing the value 2**I.  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|print_two_power
parameter_list|(
name|int
name|i
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
comment|/* These are the SI prefixes for base-1000, the binary ones with base-1024      are too clumsy and require appending B for "byte" to be intelligible,      e.g. "MiB".       Therefore, we ignore the official standard and revert to the traditional      contextual use were the base-1000 prefixes are understood as base-1024      when it came to data sizes.    */
specifier|const
name|char
modifier|*
name|si_prefixes
init|=
literal|" kMGTPEZY"
decl_stmt|;
name|int
name|number
init|=
operator|(
name|i
operator|>=
literal|0
operator|)
condition|?
operator|(
literal|1
operator|<<
operator|(
name|i
operator|%
literal|10
operator|)
operator|)
else|:
literal|0
decl_stmt|;
name|int
name|thousands
init|=
operator|(
name|i
operator|>=
literal|0
operator|)
condition|?
operator|(
name|i
operator|/
literal|10
operator|)
else|:
literal|0
decl_stmt|;
name|char
name|si_prefix
init|=
operator|(
name|thousands
operator|<
name|strlen
argument_list|(
name|si_prefixes
argument_list|)
operator|)
condition|?
name|si_prefixes
index|[
name|thousands
index|]
else|:
literal|'?'
decl_stmt|;
if|if
condition|(
name|si_prefix
operator|==
literal|' '
condition|)
return|return
name|apr_psprintf
argument_list|(
name|result_pool
argument_list|,
literal|"%d"
argument_list|,
name|number
argument_list|)
return|;
return|return
name|apr_psprintf
argument_list|(
name|result_pool
argument_list|,
literal|"%d%c"
argument_list|,
name|number
argument_list|,
name|si_prefix
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Print statistics for the given group of representations to console.  * Use POOL for allocations.  */
end_comment

begin_function
specifier|static
name|void
name|print_rep_stats
parameter_list|(
name|svn_fs_fs__representation_stats_t
modifier|*
name|stats
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|printf
argument_list|(
name|_
argument_list|(
literal|"%20s bytes in %12s reps\n"
literal|"%20s bytes in %12s shared reps\n"
literal|"%20s bytes expanded size\n"
literal|"%20s bytes expanded shared size\n"
literal|"%20s bytes with rep-sharing off\n"
literal|"%20s shared references\n"
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total
operator|.
name|packed_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|shared
operator|.
name|packed_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|shared
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total
operator|.
name|expanded_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|shared
operator|.
name|expanded_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|expanded_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|references
operator|-
name|stats
operator|->
name|total
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Print the (used) contents of CHANGES.  Use POOL for allocations.  */
end_comment

begin_function
specifier|static
name|void
name|print_largest_reps
parameter_list|(
name|svn_fs_fs__largest_changes_t
modifier|*
name|changes
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|changes
operator|->
name|count
operator|&&
name|changes
operator|->
name|changes
index|[
name|i
index|]
operator|->
name|size
condition|;
operator|++
name|i
control|)
name|printf
argument_list|(
name|_
argument_list|(
literal|"%12s r%-8ld %s\n"
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|changes
operator|->
name|changes
index|[
name|i
index|]
operator|->
name|size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|changes
operator|->
name|changes
index|[
name|i
index|]
operator|->
name|revision
argument_list|,
name|changes
operator|->
name|changes
index|[
name|i
index|]
operator|->
name|path
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Print the non-zero section of HISTOGRAM to console.  * Use POOL for allocations.  */
end_comment

begin_function
specifier|static
name|void
name|print_histogram
parameter_list|(
name|svn_fs_fs__histogram_t
modifier|*
name|histogram
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|int
name|first
init|=
literal|0
decl_stmt|;
name|int
name|last
init|=
literal|63
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* identify non-zero range */
while|while
condition|(
name|last
operator|>
literal|0
operator|&&
name|histogram
operator|->
name|lines
index|[
name|last
index|]
operator|.
name|count
operator|==
literal|0
condition|)
operator|--
name|last
expr_stmt|;
while|while
condition|(
name|first
operator|<=
name|last
operator|&&
name|histogram
operator|->
name|lines
index|[
name|first
index|]
operator|.
name|count
operator|==
literal|0
condition|)
operator|++
name|first
expr_stmt|;
comment|/* display histogram lines */
for|for
control|(
name|i
operator|=
name|last
init|;
name|i
operator|>=
name|first
condition|;
operator|--
name|i
control|)
name|printf
argument_list|(
name|_
argument_list|(
literal|"  %4s ..< %-4s %19s (%2d%%) bytes in %12s (%2d%%) items\n"
argument_list|)
argument_list|,
name|print_two_power
argument_list|(
name|i
operator|-
literal|1
argument_list|,
name|pool
argument_list|)
argument_list|,
name|print_two_power
argument_list|(
name|i
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|histogram
operator|->
name|lines
index|[
name|i
index|]
operator|.
name|sum
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
name|histogram
operator|->
name|lines
index|[
name|i
index|]
operator|.
name|sum
operator|*
literal|100
operator|/
name|histogram
operator|->
name|total
operator|.
name|sum
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|histogram
operator|->
name|lines
index|[
name|i
index|]
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
name|histogram
operator|->
name|lines
index|[
name|i
index|]
operator|.
name|count
operator|*
literal|100
operator|/
name|histogram
operator|->
name|total
operator|.
name|count
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* COMPARISON_FUNC for svn_sort__hash.  * Sort extension_info_t values by total count in descending order.  */
end_comment

begin_function
specifier|static
name|int
name|compare_count
parameter_list|(
specifier|const
name|svn_sort__item_t
modifier|*
name|a
parameter_list|,
specifier|const
name|svn_sort__item_t
modifier|*
name|b
parameter_list|)
block|{
specifier|const
name|svn_fs_fs__extension_info_t
modifier|*
name|lhs
init|=
name|a
operator|->
name|value
decl_stmt|;
specifier|const
name|svn_fs_fs__extension_info_t
modifier|*
name|rhs
init|=
name|b
operator|->
name|value
decl_stmt|;
name|apr_int64_t
name|diff
init|=
name|lhs
operator|->
name|node_histogram
operator|.
name|total
operator|.
name|count
operator|-
name|rhs
operator|->
name|node_histogram
operator|.
name|total
operator|.
name|count
decl_stmt|;
return|return
name|diff
operator|>
literal|0
condition|?
operator|-
literal|1
else|:
operator|(
name|diff
operator|<
literal|0
condition|?
literal|1
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* COMPARISON_FUNC for svn_sort__hash.  * Sort extension_info_t values by total uncompressed size in descending order.  */
end_comment

begin_function
specifier|static
name|int
name|compare_node_size
parameter_list|(
specifier|const
name|svn_sort__item_t
modifier|*
name|a
parameter_list|,
specifier|const
name|svn_sort__item_t
modifier|*
name|b
parameter_list|)
block|{
specifier|const
name|svn_fs_fs__extension_info_t
modifier|*
name|lhs
init|=
name|a
operator|->
name|value
decl_stmt|;
specifier|const
name|svn_fs_fs__extension_info_t
modifier|*
name|rhs
init|=
name|b
operator|->
name|value
decl_stmt|;
name|apr_int64_t
name|diff
init|=
name|lhs
operator|->
name|node_histogram
operator|.
name|total
operator|.
name|sum
operator|-
name|rhs
operator|->
name|node_histogram
operator|.
name|total
operator|.
name|sum
decl_stmt|;
return|return
name|diff
operator|>
literal|0
condition|?
operator|-
literal|1
else|:
operator|(
name|diff
operator|<
literal|0
condition|?
literal|1
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* COMPARISON_FUNC for svn_sort__hash.  * Sort extension_info_t values by total prep count in descending order.  */
end_comment

begin_function
specifier|static
name|int
name|compare_rep_size
parameter_list|(
specifier|const
name|svn_sort__item_t
modifier|*
name|a
parameter_list|,
specifier|const
name|svn_sort__item_t
modifier|*
name|b
parameter_list|)
block|{
specifier|const
name|svn_fs_fs__extension_info_t
modifier|*
name|lhs
init|=
name|a
operator|->
name|value
decl_stmt|;
specifier|const
name|svn_fs_fs__extension_info_t
modifier|*
name|rhs
init|=
name|b
operator|->
name|value
decl_stmt|;
name|apr_int64_t
name|diff
init|=
name|lhs
operator|->
name|rep_histogram
operator|.
name|total
operator|.
name|sum
operator|-
name|rhs
operator|->
name|rep_histogram
operator|.
name|total
operator|.
name|sum
decl_stmt|;
return|return
name|diff
operator|>
literal|0
condition|?
operator|-
literal|1
else|:
operator|(
name|diff
operator|<
literal|0
condition|?
literal|1
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Return an array of extension_info_t* for the (up to) 16 most prominent  * extensions in STATS according to the sort criterion COMPARISON_FUNC.  * Allocate results in POOL.  */
end_comment

begin_function
specifier|static
name|apr_array_header_t
modifier|*
name|get_by_extensions
parameter_list|(
name|svn_fs_fs__stats_t
modifier|*
name|stats
parameter_list|,
name|int
function_decl|(
modifier|*
name|comparison_func
function_decl|)
parameter_list|(
specifier|const
name|svn_sort__item_t
modifier|*
parameter_list|,
specifier|const
name|svn_sort__item_t
modifier|*
parameter_list|)
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
comment|/* sort all data by extension */
name|apr_array_header_t
modifier|*
name|sorted
init|=
name|svn_sort__hash
argument_list|(
name|stats
operator|->
name|by_extension
argument_list|,
name|comparison_func
argument_list|,
name|pool
argument_list|)
decl_stmt|;
comment|/* select the top (first) 16 entries */
name|int
name|count
init|=
name|MIN
argument_list|(
name|sorted
operator|->
name|nelts
argument_list|,
literal|16
argument_list|)
decl_stmt|;
name|apr_array_header_t
modifier|*
name|result
init|=
name|apr_array_make
argument_list|(
name|pool
argument_list|,
name|count
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_fs_fs__extension_info_t
operator|*
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
operator|++
name|i
control|)
name|APR_ARRAY_PUSH
argument_list|(
name|result
argument_list|,
name|svn_fs_fs__extension_info_t
operator|*
argument_list|)
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|sorted
argument_list|,
name|i
argument_list|,
name|svn_sort__item_t
argument_list|)
operator|.
name|value
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/* Add all extension_info_t* entries of TO_ADD not already in TARGET to  * TARGET.  */
end_comment

begin_function
specifier|static
name|void
name|merge_by_extension
parameter_list|(
name|apr_array_header_t
modifier|*
name|target
parameter_list|,
name|apr_array_header_t
modifier|*
name|to_add
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|k
decl_stmt|,
name|count
decl_stmt|;
name|count
operator|=
name|target
operator|->
name|nelts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|to_add
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
block|{
name|svn_fs_fs__extension_info_t
modifier|*
name|info
init|=
name|APR_ARRAY_IDX
argument_list|(
name|to_add
argument_list|,
name|i
argument_list|,
name|svn_fs_fs__extension_info_t
operator|*
argument_list|)
decl_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|count
condition|;
operator|++
name|k
control|)
if|if
condition|(
name|info
operator|==
name|APR_ARRAY_IDX
argument_list|(
name|target
argument_list|,
name|k
argument_list|,
name|svn_fs_fs__extension_info_t
operator|*
argument_list|)
condition|)
break|break;
if|if
condition|(
name|k
operator|==
name|count
condition|)
name|APR_ARRAY_PUSH
argument_list|(
name|target
argument_list|,
name|svn_fs_fs__extension_info_t
operator|*
argument_list|)
operator|=
name|info
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Print the (up to) 16 extensions in STATS with the most changes.  * Use POOL for allocations.  */
end_comment

begin_function
specifier|static
name|void
name|print_extensions_by_changes
parameter_list|(
name|svn_fs_fs__stats_t
modifier|*
name|stats
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_array_header_t
modifier|*
name|data
init|=
name|get_by_extensions
argument_list|(
name|stats
argument_list|,
name|compare_count
argument_list|,
name|pool
argument_list|)
decl_stmt|;
name|apr_int64_t
name|sum
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
block|{
name|svn_fs_fs__extension_info_t
modifier|*
name|info
init|=
name|APR_ARRAY_IDX
argument_list|(
name|data
argument_list|,
name|i
argument_list|,
name|svn_fs_fs__extension_info_t
operator|*
argument_list|)
decl_stmt|;
comment|/* If there are elements, then their count cannot be 0. */
name|assert
argument_list|(
name|stats
operator|->
name|file_histogram
operator|.
name|total
operator|.
name|count
argument_list|)
expr_stmt|;
name|sum
operator|+=
name|info
operator|->
name|node_histogram
operator|.
name|total
operator|.
name|count
expr_stmt|;
name|printf
argument_list|(
name|_
argument_list|(
literal|"%11s %20s (%2d%%) representations\n"
argument_list|)
argument_list|,
name|info
operator|->
name|extension
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|info
operator|->
name|node_histogram
operator|.
name|total
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
name|info
operator|->
name|node_histogram
operator|.
name|total
operator|.
name|count
operator|*
literal|100
operator|/
name|stats
operator|->
name|file_histogram
operator|.
name|total
operator|.
name|count
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|stats
operator|->
name|file_histogram
operator|.
name|total
operator|.
name|count
condition|)
block|{
name|printf
argument_list|(
name|_
argument_list|(
literal|"%11s %20s (%2d%%) representations\n"
argument_list|)
argument_list|,
literal|"(others)"
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|file_histogram
operator|.
name|total
operator|.
name|count
operator|-
name|sum
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|stats
operator|->
name|file_histogram
operator|.
name|total
operator|.
name|count
operator|-
name|sum
operator|)
operator|*
literal|100
operator|/
name|stats
operator|->
name|file_histogram
operator|.
name|total
operator|.
name|count
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Calculate a percentage, handling edge cases. */
end_comment

begin_function
specifier|static
name|int
name|get_percentage
parameter_list|(
name|apr_uint64_t
name|part
parameter_list|,
name|apr_uint64_t
name|total
parameter_list|)
block|{
comment|/* This include total == 0. */
if|if
condition|(
name|part
operator|>=
name|total
condition|)
return|return
literal|100
return|;
comment|/* Standard case. */
return|return
call|(
name|int
call|)
argument_list|(
name|part
operator|*
literal|100.0
operator|/
name|total
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Print the (up to) 16 extensions in STATS with the largest total size of  * changed file content.  Use POOL for allocations.  */
end_comment

begin_function
specifier|static
name|void
name|print_extensions_by_nodes
parameter_list|(
name|svn_fs_fs__stats_t
modifier|*
name|stats
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_array_header_t
modifier|*
name|data
init|=
name|get_by_extensions
argument_list|(
name|stats
argument_list|,
name|compare_node_size
argument_list|,
name|pool
argument_list|)
decl_stmt|;
name|apr_int64_t
name|sum
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
block|{
name|svn_fs_fs__extension_info_t
modifier|*
name|info
init|=
name|APR_ARRAY_IDX
argument_list|(
name|data
argument_list|,
name|i
argument_list|,
name|svn_fs_fs__extension_info_t
operator|*
argument_list|)
decl_stmt|;
name|sum
operator|+=
name|info
operator|->
name|node_histogram
operator|.
name|total
operator|.
name|sum
expr_stmt|;
name|printf
argument_list|(
name|_
argument_list|(
literal|"%11s %20s (%2d%%) bytes\n"
argument_list|)
argument_list|,
name|info
operator|->
name|extension
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|info
operator|->
name|node_histogram
operator|.
name|total
operator|.
name|sum
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|get_percentage
argument_list|(
name|info
operator|->
name|node_histogram
operator|.
name|total
operator|.
name|sum
argument_list|,
name|stats
operator|->
name|file_histogram
operator|.
name|total
operator|.
name|sum
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|stats
operator|->
name|file_histogram
operator|.
name|total
operator|.
name|sum
operator|>
name|sum
condition|)
block|{
comment|/* Total sum can't be zero here. */
name|printf
argument_list|(
name|_
argument_list|(
literal|"%11s %20s (%2d%%) bytes\n"
argument_list|)
argument_list|,
literal|"(others)"
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|file_histogram
operator|.
name|total
operator|.
name|sum
operator|-
name|sum
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|get_percentage
argument_list|(
name|stats
operator|->
name|file_histogram
operator|.
name|total
operator|.
name|sum
operator|-
name|sum
argument_list|,
name|stats
operator|->
name|file_histogram
operator|.
name|total
operator|.
name|sum
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Print the (up to) 16 extensions in STATS with the largest total size of  * changed file content.  Use POOL for allocations.  */
end_comment

begin_function
specifier|static
name|void
name|print_extensions_by_reps
parameter_list|(
name|svn_fs_fs__stats_t
modifier|*
name|stats
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_array_header_t
modifier|*
name|data
init|=
name|get_by_extensions
argument_list|(
name|stats
argument_list|,
name|compare_rep_size
argument_list|,
name|pool
argument_list|)
decl_stmt|;
name|apr_int64_t
name|sum
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
block|{
name|svn_fs_fs__extension_info_t
modifier|*
name|info
init|=
name|APR_ARRAY_IDX
argument_list|(
name|data
argument_list|,
name|i
argument_list|,
name|svn_fs_fs__extension_info_t
operator|*
argument_list|)
decl_stmt|;
name|sum
operator|+=
name|info
operator|->
name|rep_histogram
operator|.
name|total
operator|.
name|sum
expr_stmt|;
name|printf
argument_list|(
name|_
argument_list|(
literal|"%11s %20s (%2d%%) bytes\n"
argument_list|)
argument_list|,
name|info
operator|->
name|extension
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|info
operator|->
name|rep_histogram
operator|.
name|total
operator|.
name|sum
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|get_percentage
argument_list|(
name|info
operator|->
name|rep_histogram
operator|.
name|total
operator|.
name|sum
argument_list|,
name|stats
operator|->
name|rep_size_histogram
operator|.
name|total
operator|.
name|sum
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|stats
operator|->
name|rep_size_histogram
operator|.
name|total
operator|.
name|sum
operator|>
name|sum
condition|)
block|{
comment|/* Total sum can't be zero here. */
name|printf
argument_list|(
name|_
argument_list|(
literal|"%11s %20s (%2d%%) bytes\n"
argument_list|)
argument_list|,
literal|"(others)"
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|rep_size_histogram
operator|.
name|total
operator|.
name|sum
operator|-
name|sum
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|get_percentage
argument_list|(
name|stats
operator|->
name|rep_size_histogram
operator|.
name|total
operator|.
name|sum
operator|-
name|sum
argument_list|,
name|stats
operator|->
name|rep_size_histogram
operator|.
name|total
operator|.
name|sum
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Print per-extension histograms for the most frequent extensions in STATS.  * Use POOL for allocations. */
end_comment

begin_function
specifier|static
name|void
name|print_histograms_by_extension
parameter_list|(
name|svn_fs_fs__stats_t
modifier|*
name|stats
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_array_header_t
modifier|*
name|data
init|=
name|get_by_extensions
argument_list|(
name|stats
argument_list|,
name|compare_count
argument_list|,
name|pool
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|merge_by_extension
argument_list|(
name|data
argument_list|,
name|get_by_extensions
argument_list|(
name|stats
argument_list|,
name|compare_node_size
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|merge_by_extension
argument_list|(
name|data
argument_list|,
name|get_by_extensions
argument_list|(
name|stats
argument_list|,
name|compare_rep_size
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
block|{
name|svn_fs_fs__extension_info_t
modifier|*
name|info
init|=
name|APR_ARRAY_IDX
argument_list|(
name|data
argument_list|,
name|i
argument_list|,
name|svn_fs_fs__extension_info_t
operator|*
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"\nHistogram of '%s' file sizes:\n"
argument_list|,
name|info
operator|->
name|extension
argument_list|)
expr_stmt|;
name|print_histogram
argument_list|(
operator|&
name|info
operator|->
name|node_histogram
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nHistogram of '%s' file representation sizes:\n"
argument_list|,
name|info
operator|->
name|extension
argument_list|)
expr_stmt|;
name|print_histogram
argument_list|(
operator|&
name|info
operator|->
name|rep_histogram
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Print the contents of STATS to the console.  * Use POOL for allocations.  */
end_comment

begin_function
specifier|static
name|void
name|print_stats
parameter_list|(
name|svn_fs_fs__stats_t
modifier|*
name|stats
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
comment|/* print results */
name|printf
argument_list|(
literal|"\nGlobal statistics:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|_
argument_list|(
literal|"%20s bytes in %12s revisions\n"
literal|"%20s bytes in %12s changes\n"
literal|"%20s bytes in %12s node revision records\n"
literal|"%20s bytes in %12s representations\n"
literal|"%20s bytes expanded representation size\n"
literal|"%20s bytes with rep-sharing off\n"
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|revision_count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|change_len
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|change_count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total_node_stats
operator|.
name|size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total_node_stats
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total_rep_stats
operator|.
name|total
operator|.
name|packed_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total_rep_stats
operator|.
name|total
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total_rep_stats
operator|.
name|total
operator|.
name|expanded_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total_rep_stats
operator|.
name|expanded_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nNoderev statistics:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|_
argument_list|(
literal|"%20s bytes in %12s nodes total\n"
literal|"%20s bytes in %12s directory noderevs\n"
literal|"%20s bytes in %12s file noderevs\n"
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total_node_stats
operator|.
name|size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total_node_stats
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|dir_node_stats
operator|.
name|size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|dir_node_stats
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|file_node_stats
operator|.
name|size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|file_node_stats
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nRepresentation statistics:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|_
argument_list|(
literal|"%20s bytes in %12s representations total\n"
literal|"%20s bytes in %12s directory representations\n"
literal|"%20s bytes in %12s file representations\n"
literal|"%20s bytes in %12s representations of added file nodes\n"
literal|"%20s bytes in %12s directory property representations\n"
literal|"%20s bytes in %12s file property representations\n"
literal|"%20s bytes in header& footer overhead\n"
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total_rep_stats
operator|.
name|total
operator|.
name|packed_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total_rep_stats
operator|.
name|total
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|dir_rep_stats
operator|.
name|total
operator|.
name|packed_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|dir_rep_stats
operator|.
name|total
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|file_rep_stats
operator|.
name|total
operator|.
name|packed_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|file_rep_stats
operator|.
name|total
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|added_rep_size_histogram
operator|.
name|total
operator|.
name|sum
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|added_rep_size_histogram
operator|.
name|total
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|dir_prop_rep_stats
operator|.
name|total
operator|.
name|packed_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|dir_prop_rep_stats
operator|.
name|total
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|file_prop_rep_stats
operator|.
name|total
operator|.
name|packed_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|file_prop_rep_stats
operator|.
name|total
operator|.
name|count
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn__ui64toa_sep
argument_list|(
name|stats
operator|->
name|total_rep_stats
operator|.
name|total
operator|.
name|overhead_size
argument_list|,
literal|','
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nDirectory representation statistics:\n"
argument_list|)
expr_stmt|;
name|print_rep_stats
argument_list|(
operator|&
name|stats
operator|->
name|dir_rep_stats
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nFile representation statistics:\n"
argument_list|)
expr_stmt|;
name|print_rep_stats
argument_list|(
operator|&
name|stats
operator|->
name|file_rep_stats
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nDirectory property representation statistics:\n"
argument_list|)
expr_stmt|;
name|print_rep_stats
argument_list|(
operator|&
name|stats
operator|->
name|dir_prop_rep_stats
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nFile property representation statistics:\n"
argument_list|)
expr_stmt|;
name|print_rep_stats
argument_list|(
operator|&
name|stats
operator|->
name|file_prop_rep_stats
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nLargest representations:\n"
argument_list|)
expr_stmt|;
name|print_largest_reps
argument_list|(
name|stats
operator|->
name|largest_changes
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nExtensions by number of representations:\n"
argument_list|)
expr_stmt|;
name|print_extensions_by_changes
argument_list|(
name|stats
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nExtensions by size of changed files:\n"
argument_list|)
expr_stmt|;
name|print_extensions_by_nodes
argument_list|(
name|stats
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nExtensions by size of representations:\n"
argument_list|)
expr_stmt|;
name|print_extensions_by_reps
argument_list|(
name|stats
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nHistogram of expanded node sizes:\n"
argument_list|)
expr_stmt|;
name|print_histogram
argument_list|(
operator|&
name|stats
operator|->
name|node_size_histogram
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nHistogram of representation sizes:\n"
argument_list|)
expr_stmt|;
name|print_histogram
argument_list|(
operator|&
name|stats
operator|->
name|rep_size_histogram
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nHistogram of file sizes:\n"
argument_list|)
expr_stmt|;
name|print_histogram
argument_list|(
operator|&
name|stats
operator|->
name|file_histogram
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nHistogram of file representation sizes:\n"
argument_list|)
expr_stmt|;
name|print_histogram
argument_list|(
operator|&
name|stats
operator|->
name|file_rep_histogram
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nHistogram of file property sizes:\n"
argument_list|)
expr_stmt|;
name|print_histogram
argument_list|(
operator|&
name|stats
operator|->
name|file_prop_histogram
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nHistogram of file property representation sizes:\n"
argument_list|)
expr_stmt|;
name|print_histogram
argument_list|(
operator|&
name|stats
operator|->
name|file_prop_rep_histogram
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nHistogram of directory sizes:\n"
argument_list|)
expr_stmt|;
name|print_histogram
argument_list|(
operator|&
name|stats
operator|->
name|dir_histogram
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nHistogram of directory representation sizes:\n"
argument_list|)
expr_stmt|;
name|print_histogram
argument_list|(
operator|&
name|stats
operator|->
name|dir_rep_histogram
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nHistogram of directory property sizes:\n"
argument_list|)
expr_stmt|;
name|print_histogram
argument_list|(
operator|&
name|stats
operator|->
name|dir_prop_histogram
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nHistogram of directory property representation sizes:\n"
argument_list|)
expr_stmt|;
name|print_histogram
argument_list|(
operator|&
name|stats
operator|->
name|dir_prop_rep_histogram
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|print_histograms_by_extension
argument_list|(
name|stats
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Our progress function simply prints the REVISION number and makes it  * appear immediately.  */
end_comment

begin_function
specifier|static
name|void
name|print_progress
parameter_list|(
name|svn_revnum_t
name|revision
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%8ld"
argument_list|,
name|revision
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* This implements `svn_opt_subcommand_t'. */
end_comment

begin_function
name|svn_error_t
modifier|*
name|subcommand__stats
parameter_list|(
name|apr_getopt_t
modifier|*
name|os
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svnfsfs__opt_state
modifier|*
name|opt_state
init|=
name|baton
decl_stmt|;
name|svn_fs_fs__stats_t
modifier|*
name|stats
decl_stmt|;
name|svn_fs_t
modifier|*
name|fs
decl_stmt|;
name|printf
argument_list|(
literal|"Reading revisions\n"
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|open_fs
argument_list|(
operator|&
name|fs
argument_list|,
name|opt_state
operator|->
name|repository_path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_fs_fs__get_stats
argument_list|(
operator|&
name|stats
argument_list|,
name|fs
argument_list|,
name|print_progress
argument_list|,
name|NULL
argument_list|,
name|check_cancel
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|print_stats
argument_list|(
name|stats
argument_list|,
name|pool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


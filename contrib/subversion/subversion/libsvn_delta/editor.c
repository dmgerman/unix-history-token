begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * editor.c :  editing trees of versioned resources  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|<apr_pools.h>
end_include

begin_include
include|#
directive|include
file|"svn_types.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_editor.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SVN_DEBUG
end_ifdef

begin_comment
comment|/* This enables runtime checks of the editor API constraints.  This may    introduce additional memory and runtime overhead, and should not be used    in production builds.     ### Remove before release?     ### Disabled for now.  If I call svn_editor_alter_directory(A) then        svn_editor_add_file(A/f) the latter fails on SHOULD_ALLOW_ADD.        If I modify svn_editor_alter_directory to MARK_ALLOW_ADD(child)        then if I call svn_editor_alter_directory(A) followed by        svn_editor_alter_directory(A/B/C) the latter fails on        VERIFY_PARENT_MAY_EXIST. */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_define
define|#
directive|define
name|ENABLE_ORDERING_CHECK
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|svn_editor_t
block|{
name|void
modifier|*
name|baton
decl_stmt|;
comment|/* Standard cancellation function. Called before each callback.  */
name|svn_cancel_func_t
name|cancel_func
decl_stmt|;
name|void
modifier|*
name|cancel_baton
decl_stmt|;
comment|/* Our callback functions match that of the set-many structure, so      just use that.  */
name|svn_editor_cb_many_t
name|funcs
decl_stmt|;
comment|/* This pool is used as the scratch_pool for all callbacks.  */
name|apr_pool_t
modifier|*
name|scratch_pool
decl_stmt|;
ifdef|#
directive|ifdef
name|ENABLE_ORDERING_CHECK
name|svn_boolean_t
name|within_callback
decl_stmt|;
name|apr_hash_t
modifier|*
name|pending_incomplete_children
decl_stmt|;
name|apr_hash_t
modifier|*
name|completed_nodes
decl_stmt|;
name|svn_boolean_t
name|finished
decl_stmt|;
name|apr_pool_t
modifier|*
name|state_pool
decl_stmt|;
endif|#
directive|endif
block|}
struct|;
end_struct

begin_ifdef
ifdef|#
directive|ifdef
name|ENABLE_ORDERING_CHECK
end_ifdef

begin_define
define|#
directive|define
name|START_CALLBACK
parameter_list|(
name|editor
parameter_list|)
define|\
value|do {                                               \     svn_editor_t *editor__tmp_e = (editor);          \     SVN_ERR_ASSERT(!editor__tmp_e->within_callback); \     editor__tmp_e->within_callback = TRUE;           \   } while (0)
end_define

begin_define
define|#
directive|define
name|END_CALLBACK
parameter_list|(
name|editor
parameter_list|)
value|((editor)->within_callback = FALSE)
end_define

begin_comment
comment|/* Marker to indicate no further changes are allowed on this node.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|int
name|marker_done
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MARKER_DONE
value|(&marker_done)
end_define

begin_comment
comment|/* Marker indicating that add_* may be called for this path, or that it    can be the destination of a copy or move. For copy/move, the path    will switch to MARKER_ALLOW_ALTER, to enable further tweaks.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|int
name|marker_allow_add
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MARKER_ALLOW_ADD
value|(&marker_allow_add)
end_define

begin_comment
comment|/* Marker indicating that alter_* may be called for this path.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|int
name|marker_allow_alter
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MARKER_ALLOW_ALTER
value|(&marker_allow_alter)
end_define

begin_comment
comment|/* Just like MARKER_DONE, but also indicates that the node was created    via add_directory(). This allows us to verify that the CHILDREN param    was comprehensive.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|int
name|marker_added_dir
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MARKER_ADDED_DIR
value|(&marker_added_dir)
end_define

begin_define
define|#
directive|define
name|MARK_FINISHED
parameter_list|(
name|editor
parameter_list|)
value|((editor)->finished = TRUE)
end_define

begin_define
define|#
directive|define
name|SHOULD_NOT_BE_FINISHED
parameter_list|(
name|editor
parameter_list|)
value|SVN_ERR_ASSERT(!(editor)->finished)
end_define

begin_define
define|#
directive|define
name|CLEAR_INCOMPLETE
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
define|\
value|svn_hash_sets((editor)->pending_incomplete_children, relpath, NULL);
end_define

begin_define
define|#
directive|define
name|MARK_RELPATH
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|,
name|value
parameter_list|)
define|\
value|svn_hash_sets((editor)->completed_nodes, \                 apr_pstrdup((editor)->state_pool, relpath), value)
end_define

begin_define
define|#
directive|define
name|MARK_COMPLETED
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
define|\
value|MARK_RELPATH(editor, relpath, MARKER_DONE)
end_define

begin_define
define|#
directive|define
name|SHOULD_NOT_BE_COMPLETED
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
define|\
value|SVN_ERR_ASSERT(svn_hash_gets((editor)->completed_nodes, relpath) == NULL)
end_define

begin_define
define|#
directive|define
name|MARK_ALLOW_ADD
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
define|\
value|MARK_RELPATH(editor, relpath, MARKER_ALLOW_ADD)
end_define

begin_define
define|#
directive|define
name|SHOULD_ALLOW_ADD
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
define|\
value|SVN_ERR_ASSERT(allow_either(editor, relpath, MARKER_ALLOW_ADD, NULL))
end_define

begin_define
define|#
directive|define
name|MARK_ALLOW_ALTER
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
define|\
value|MARK_RELPATH(editor, relpath, MARKER_ALLOW_ALTER)
end_define

begin_define
define|#
directive|define
name|SHOULD_ALLOW_ALTER
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
define|\
value|SVN_ERR_ASSERT(allow_either(editor, relpath, MARKER_ALLOW_ALTER, NULL))
end_define

begin_define
define|#
directive|define
name|MARK_ADDED_DIR
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
define|\
value|MARK_RELPATH(editor, relpath, MARKER_ADDED_DIR)
end_define

begin_define
define|#
directive|define
name|CHECK_UNKNOWN_CHILD
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
define|\
value|SVN_ERR_ASSERT(check_unknown_child(editor, relpath))
end_define

begin_comment
comment|/* When a child is changed in some way, mark the parent directory as needing    to be "stable" (no future structural changes). IOW, only allow "alter" on    the parent. Prevents parent-add/delete/move after any child operation.  */
end_comment

begin_define
define|#
directive|define
name|MARK_PARENT_STABLE
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
define|\
value|mark_parent_stable(editor, relpath)
end_define

begin_comment
comment|/* If the parent is MARKER_ALLOW_ADD, then it has been moved-away, and we    know it does not exist. All other cases: it might exist.  */
end_comment

begin_define
define|#
directive|define
name|VERIFY_PARENT_MAY_EXIST
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
define|\
value|SVN_ERR_ASSERT(svn_hash_gets((editor)->completed_nodes, \                                svn_relpath_dirname(relpath, \                                                    (editor)->scratch_pool)) \                  != MARKER_ALLOW_ADD)
end_define

begin_comment
comment|/* If the parent is MARKER_ADDED_DIR, then we should not be deleting    children(*). If the parent is MARKER_ALLOW_ADD, then it has been    moved-away, so children cannot exist. That leaves MARKER_DONE,    MARKER_ALLOW_ALTER, and NULL as possible values. Just assert that    we didn't get either of the bad ones.     (*) if the child as added via add_*(), then it would have been marked    as completed and delete/move-away already test against completed nodes.    This test is to beware of trying to delete "children" that are not    actually (and can't possibly be) present.  */
end_comment

begin_define
define|#
directive|define
name|CHILD_DELETIONS_ALLOWED
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
define|\
value|SVN_ERR_ASSERT(!allow_either(editor, \                                svn_relpath_dirname(relpath, \                                                    (editor)->scratch_pool), \                                MARKER_ADDED_DIR, MARKER_ALLOW_ADD))
end_define

begin_function
specifier|static
name|svn_boolean_t
name|allow_either
parameter_list|(
specifier|const
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|void
modifier|*
name|marker1
parameter_list|,
specifier|const
name|void
modifier|*
name|marker2
parameter_list|)
block|{
name|void
modifier|*
name|value
init|=
name|svn_hash_gets
argument_list|(
name|editor
operator|->
name|completed_nodes
argument_list|,
name|relpath
argument_list|)
decl_stmt|;
return|return
name|value
operator|==
name|marker1
operator|||
name|value
operator|==
name|marker2
return|;
block|}
end_function

begin_function
specifier|static
name|svn_boolean_t
name|check_unknown_child
parameter_list|(
specifier|const
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|parent
decl_stmt|;
comment|/* If we already know about the new child, then exit early.  */
if|if
condition|(
name|svn_hash_gets
argument_list|(
name|editor
operator|->
name|pending_incomplete_children
argument_list|,
name|relpath
argument_list|)
operator|!=
name|NULL
condition|)
return|return
name|TRUE
return|;
name|parent
operator|=
name|svn_relpath_dirname
argument_list|(
name|relpath
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* Was this parent created via svn_editor_add_directory() ?  */
if|if
condition|(
name|svn_hash_gets
argument_list|(
name|editor
operator|->
name|completed_nodes
argument_list|,
name|parent
argument_list|)
operator|==
name|MARKER_ADDED_DIR
condition|)
block|{
comment|/* Whoops. This child should have been listed in that add call,          and placed into ->pending_incomplete_children.  */
return|return
name|FALSE
return|;
block|}
comment|/* The parent was not added in this drive.  */
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mark_parent_stable
parameter_list|(
specifier|const
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|parent
init|=
name|svn_relpath_dirname
argument_list|(
name|relpath
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
decl_stmt|;
specifier|const
name|void
modifier|*
name|marker
init|=
name|svn_hash_gets
argument_list|(
name|editor
operator|->
name|completed_nodes
argument_list|,
name|parent
argument_list|)
decl_stmt|;
comment|/* If RELPATH has already been marked (to disallow adds, or that it      has been fully-completed), then do nothing.  */
if|if
condition|(
name|marker
operator|==
name|MARKER_ALLOW_ALTER
operator|||
name|marker
operator|==
name|MARKER_DONE
operator|||
name|marker
operator|==
name|MARKER_ADDED_DIR
condition|)
return|return;
comment|/* If the marker is MARKER_ALLOW_ADD, then that means the parent was      moved away. There is no way to work on a child. That should have      been tested before we got here by VERIFY_PARENT_MAY_EXIST().  */
name|SVN_ERR_ASSERT_NO_RETURN
argument_list|(
name|marker
operator|!=
name|MARKER_ALLOW_ADD
argument_list|)
expr_stmt|;
comment|/* MARKER is NULL. Upgrade it to MARKER_ALLOW_ALTER.  */
name|MARK_RELPATH
argument_list|(
name|editor
argument_list|,
name|parent
argument_list|,
name|MARKER_ALLOW_ALTER
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* Be wary with the definition of these macros so that we don't    end up with "statement with no effect" warnings. Obviously, this    depends upon particular usage, which is easy to verify.  */
end_comment

begin_define
define|#
directive|define
name|START_CALLBACK
parameter_list|(
name|editor
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|END_CALLBACK
parameter_list|(
name|editor
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|MARK_FINISHED
parameter_list|(
name|editor
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|SHOULD_NOT_BE_FINISHED
parameter_list|(
name|editor
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|CLEAR_INCOMPLETE
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|MARK_COMPLETED
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|SHOULD_NOT_BE_COMPLETED
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|MARK_ALLOW_ADD
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|SHOULD_ALLOW_ADD
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|MARK_ALLOW_ALTER
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|SHOULD_ALLOW_ALTER
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|MARK_ADDED_DIR
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|CHECK_UNKNOWN_CHILD
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|MARK_PARENT_STABLE
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|VERIFY_PARENT_MAY_EXIST
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_define
define|#
directive|define
name|CHILD_DELETIONS_ALLOWED
parameter_list|(
name|editor
parameter_list|,
name|relpath
parameter_list|)
end_define

begin_comment
comment|/* empty */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ENABLE_ORDERING_CHECK */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_editor_create
parameter_list|(
name|svn_editor_t
modifier|*
modifier|*
name|editor
parameter_list|,
name|void
modifier|*
name|editor_baton
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
operator|*
name|editor
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|editor
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|editor
operator|)
operator|->
name|baton
operator|=
name|editor_baton
expr_stmt|;
operator|(
operator|*
name|editor
operator|)
operator|->
name|cancel_func
operator|=
name|cancel_func
expr_stmt|;
operator|(
operator|*
name|editor
operator|)
operator|->
name|cancel_baton
operator|=
name|cancel_baton
expr_stmt|;
operator|(
operator|*
name|editor
operator|)
operator|->
name|scratch_pool
operator|=
name|svn_pool_create
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ENABLE_ORDERING_CHECK
operator|(
operator|*
name|editor
operator|)
operator|->
name|pending_incomplete_children
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
operator|(
operator|*
name|editor
operator|)
operator|->
name|completed_nodes
operator|=
name|apr_hash_make
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
operator|(
operator|*
name|editor
operator|)
operator|->
name|finished
operator|=
name|FALSE
expr_stmt|;
operator|(
operator|*
name|editor
operator|)
operator|->
name|state_pool
operator|=
name|result_pool
expr_stmt|;
endif|#
directive|endif
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|svn_editor_get_baton
parameter_list|(
specifier|const
name|svn_editor_t
modifier|*
name|editor
parameter_list|)
block|{
return|return
name|editor
operator|->
name|baton
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_add_directory
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
name|svn_editor_cb_add_directory_t
name|callback
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|editor
operator|->
name|funcs
operator|.
name|cb_add_directory
operator|=
name|callback
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_add_file
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
name|svn_editor_cb_add_file_t
name|callback
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|editor
operator|->
name|funcs
operator|.
name|cb_add_file
operator|=
name|callback
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_add_symlink
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
name|svn_editor_cb_add_symlink_t
name|callback
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|editor
operator|->
name|funcs
operator|.
name|cb_add_symlink
operator|=
name|callback
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_add_absent
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
name|svn_editor_cb_add_absent_t
name|callback
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|editor
operator|->
name|funcs
operator|.
name|cb_add_absent
operator|=
name|callback
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_alter_directory
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
name|svn_editor_cb_alter_directory_t
name|callback
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|editor
operator|->
name|funcs
operator|.
name|cb_alter_directory
operator|=
name|callback
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_alter_file
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
name|svn_editor_cb_alter_file_t
name|callback
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|editor
operator|->
name|funcs
operator|.
name|cb_alter_file
operator|=
name|callback
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_alter_symlink
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
name|svn_editor_cb_alter_symlink_t
name|callback
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|editor
operator|->
name|funcs
operator|.
name|cb_alter_symlink
operator|=
name|callback
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_delete
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
name|svn_editor_cb_delete_t
name|callback
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|editor
operator|->
name|funcs
operator|.
name|cb_delete
operator|=
name|callback
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_copy
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
name|svn_editor_cb_copy_t
name|callback
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|editor
operator|->
name|funcs
operator|.
name|cb_copy
operator|=
name|callback
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_move
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
name|svn_editor_cb_move_t
name|callback
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|editor
operator|->
name|funcs
operator|.
name|cb_move
operator|=
name|callback
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_rotate
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
name|svn_editor_cb_rotate_t
name|callback
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|editor
operator|->
name|funcs
operator|.
name|cb_rotate
operator|=
name|callback
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_complete
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
name|svn_editor_cb_complete_t
name|callback
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|editor
operator|->
name|funcs
operator|.
name|cb_complete
operator|=
name|callback
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_abort
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
name|svn_editor_cb_abort_t
name|callback
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|editor
operator|->
name|funcs
operator|.
name|cb_abort
operator|=
name|callback
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_setcb_many
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|svn_editor_cb_many_t
modifier|*
name|many
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
define|#
directive|define
name|COPY_CALLBACK
parameter_list|(
name|NAME
parameter_list|)
value|if (many->NAME) editor->funcs.NAME = many->NAME
name|COPY_CALLBACK
argument_list|(
name|cb_add_directory
argument_list|)
expr_stmt|;
name|COPY_CALLBACK
argument_list|(
name|cb_add_file
argument_list|)
expr_stmt|;
name|COPY_CALLBACK
argument_list|(
name|cb_add_symlink
argument_list|)
expr_stmt|;
name|COPY_CALLBACK
argument_list|(
name|cb_add_absent
argument_list|)
expr_stmt|;
name|COPY_CALLBACK
argument_list|(
name|cb_alter_directory
argument_list|)
expr_stmt|;
name|COPY_CALLBACK
argument_list|(
name|cb_alter_file
argument_list|)
expr_stmt|;
name|COPY_CALLBACK
argument_list|(
name|cb_alter_symlink
argument_list|)
expr_stmt|;
name|COPY_CALLBACK
argument_list|(
name|cb_delete
argument_list|)
expr_stmt|;
name|COPY_CALLBACK
argument_list|(
name|cb_copy
argument_list|)
expr_stmt|;
name|COPY_CALLBACK
argument_list|(
name|cb_move
argument_list|)
expr_stmt|;
name|COPY_CALLBACK
argument_list|(
name|cb_rotate
argument_list|)
expr_stmt|;
name|COPY_CALLBACK
argument_list|(
name|cb_complete
argument_list|)
expr_stmt|;
name|COPY_CALLBACK
argument_list|(
name|cb_abort
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|COPY_CALLBACK
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|check_cancel
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|editor
operator|->
name|cancel_func
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|cancel_func
argument_list|(
name|editor
operator|->
name|cancel_baton
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_add_directory
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|children
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_revnum_t
name|replaces_rev
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|children
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|props
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* ### validate children are just basenames?  */
name|SHOULD_NOT_BE_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|SHOULD_ALLOW_ADD
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|VERIFY_PARENT_MAY_EXIST
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|CHECK_UNKNOWN_CHILD
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|check_cancel
argument_list|(
name|editor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|funcs
operator|.
name|cb_add_directory
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|funcs
operator|.
name|cb_add_directory
argument_list|(
name|editor
operator|->
name|baton
argument_list|,
name|relpath
argument_list|,
name|children
argument_list|,
name|props
argument_list|,
name|replaces_rev
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
name|MARK_ADDED_DIR
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|MARK_PARENT_STABLE
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|CLEAR_INCOMPLETE
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ENABLE_ORDERING_CHECK
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|children
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|child_basename
init|=
name|APR_ARRAY_IDX
argument_list|(
name|children
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|child
init|=
name|svn_relpath_join
argument_list|(
name|relpath
argument_list|,
name|child_basename
argument_list|,
name|editor
operator|->
name|state_pool
argument_list|)
decl_stmt|;
name|svn_hash_sets
argument_list|(
name|editor
operator|->
name|pending_incomplete_children
argument_list|,
name|child
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|svn_pool_clear
argument_list|(
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_add_file
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
parameter_list|,
name|svn_stream_t
modifier|*
name|contents
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_revnum_t
name|replaces_rev
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|checksum
operator|!=
name|NULL
operator|&&
name|checksum
operator|->
name|kind
operator|==
name|SVN_EDITOR_CHECKSUM_KIND
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|contents
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|props
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SHOULD_NOT_BE_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|SHOULD_ALLOW_ADD
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|VERIFY_PARENT_MAY_EXIST
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|CHECK_UNKNOWN_CHILD
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|check_cancel
argument_list|(
name|editor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|funcs
operator|.
name|cb_add_file
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|funcs
operator|.
name|cb_add_file
argument_list|(
name|editor
operator|->
name|baton
argument_list|,
name|relpath
argument_list|,
name|checksum
argument_list|,
name|contents
argument_list|,
name|props
argument_list|,
name|replaces_rev
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
name|MARK_COMPLETED
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|MARK_PARENT_STABLE
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|CLEAR_INCOMPLETE
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_add_symlink
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_revnum_t
name|replaces_rev
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|props
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SHOULD_NOT_BE_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|SHOULD_ALLOW_ADD
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|VERIFY_PARENT_MAY_EXIST
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|CHECK_UNKNOWN_CHILD
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|check_cancel
argument_list|(
name|editor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|funcs
operator|.
name|cb_add_symlink
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|funcs
operator|.
name|cb_add_symlink
argument_list|(
name|editor
operator|->
name|baton
argument_list|,
name|relpath
argument_list|,
name|target
argument_list|,
name|props
argument_list|,
name|replaces_rev
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
name|MARK_COMPLETED
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|MARK_PARENT_STABLE
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|CLEAR_INCOMPLETE
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_add_absent
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_node_kind_t
name|kind
parameter_list|,
name|svn_revnum_t
name|replaces_rev
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SHOULD_NOT_BE_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|SHOULD_ALLOW_ADD
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|VERIFY_PARENT_MAY_EXIST
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|CHECK_UNKNOWN_CHILD
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|check_cancel
argument_list|(
name|editor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|funcs
operator|.
name|cb_add_absent
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|funcs
operator|.
name|cb_add_absent
argument_list|(
name|editor
operator|->
name|baton
argument_list|,
name|relpath
argument_list|,
name|kind
argument_list|,
name|replaces_rev
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
name|MARK_COMPLETED
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|MARK_PARENT_STABLE
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|CLEAR_INCOMPLETE
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_alter_directory
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|children
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|children
operator|!=
name|NULL
operator|||
name|props
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* ### validate children are just basenames?  */
name|SHOULD_NOT_BE_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|SHOULD_ALLOW_ALTER
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|VERIFY_PARENT_MAY_EXIST
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|check_cancel
argument_list|(
name|editor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|funcs
operator|.
name|cb_alter_directory
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|funcs
operator|.
name|cb_alter_directory
argument_list|(
name|editor
operator|->
name|baton
argument_list|,
name|relpath
argument_list|,
name|revision
argument_list|,
name|children
argument_list|,
name|props
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
name|MARK_COMPLETED
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|MARK_PARENT_STABLE
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ENABLE_ORDERING_CHECK
comment|/* ### this is not entirely correct. we probably need to adjust the      ### check_unknown_child() function for this scenario.  */
if|#
directive|if
literal|0
block|{     int i;     for (i = 0; i< children->nelts; i++)       {         const char *child_basename = APR_ARRAY_IDX(children, i, const char *);         const char *child = svn_relpath_join(relpath, child_basename,                                              editor->state_pool);          apr_hash_set(editor->pending_incomplete_children, child,                      APR_HASH_KEY_STRING, "");
comment|/* Perhaps MARK_ALLOW_ADD(editor, child); ? */
block|}   }
endif|#
directive|endif
endif|#
directive|endif
name|svn_pool_clear
argument_list|(
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_alter_file
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
parameter_list|,
name|svn_stream_t
modifier|*
name|contents
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|(
name|checksum
operator|!=
name|NULL
operator|&&
name|contents
operator|!=
name|NULL
operator|)
operator|||
operator|(
name|checksum
operator|==
name|NULL
operator|&&
name|contents
operator|==
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|props
operator|!=
name|NULL
operator|||
name|checksum
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
name|SVN_ERR_ASSERT
argument_list|(
name|checksum
operator|->
name|kind
operator|==
name|SVN_EDITOR_CHECKSUM_KIND
argument_list|)
expr_stmt|;
name|SHOULD_NOT_BE_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|SHOULD_ALLOW_ALTER
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|VERIFY_PARENT_MAY_EXIST
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|check_cancel
argument_list|(
name|editor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|funcs
operator|.
name|cb_alter_file
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|funcs
operator|.
name|cb_alter_file
argument_list|(
name|editor
operator|->
name|baton
argument_list|,
name|relpath
argument_list|,
name|revision
argument_list|,
name|props
argument_list|,
name|checksum
argument_list|,
name|contents
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
name|MARK_COMPLETED
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|MARK_PARENT_STABLE
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_alter_symlink
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|props
operator|!=
name|NULL
operator|||
name|target
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SHOULD_NOT_BE_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|SHOULD_ALLOW_ALTER
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|VERIFY_PARENT_MAY_EXIST
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|check_cancel
argument_list|(
name|editor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|funcs
operator|.
name|cb_alter_symlink
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|funcs
operator|.
name|cb_alter_symlink
argument_list|(
name|editor
operator|->
name|baton
argument_list|,
name|relpath
argument_list|,
name|revision
argument_list|,
name|props
argument_list|,
name|target
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
name|MARK_COMPLETED
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|MARK_PARENT_STABLE
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_delete
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SHOULD_NOT_BE_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|SHOULD_NOT_BE_COMPLETED
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|VERIFY_PARENT_MAY_EXIST
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|CHILD_DELETIONS_ALLOWED
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|check_cancel
argument_list|(
name|editor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|funcs
operator|.
name|cb_delete
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|funcs
operator|.
name|cb_delete
argument_list|(
name|editor
operator|->
name|baton
argument_list|,
name|relpath
argument_list|,
name|revision
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
name|MARK_COMPLETED
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|MARK_PARENT_STABLE
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_copy
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
name|svn_revnum_t
name|src_revision
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|svn_revnum_t
name|replaces_rev
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|src_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|dst_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SHOULD_NOT_BE_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|SHOULD_ALLOW_ADD
argument_list|(
name|editor
argument_list|,
name|dst_relpath
argument_list|)
expr_stmt|;
name|VERIFY_PARENT_MAY_EXIST
argument_list|(
name|editor
argument_list|,
name|src_relpath
argument_list|)
expr_stmt|;
name|VERIFY_PARENT_MAY_EXIST
argument_list|(
name|editor
argument_list|,
name|dst_relpath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|check_cancel
argument_list|(
name|editor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|funcs
operator|.
name|cb_copy
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|funcs
operator|.
name|cb_copy
argument_list|(
name|editor
operator|->
name|baton
argument_list|,
name|src_relpath
argument_list|,
name|src_revision
argument_list|,
name|dst_relpath
argument_list|,
name|replaces_rev
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
name|MARK_ALLOW_ALTER
argument_list|(
name|editor
argument_list|,
name|dst_relpath
argument_list|)
expr_stmt|;
name|MARK_PARENT_STABLE
argument_list|(
name|editor
argument_list|,
name|dst_relpath
argument_list|)
expr_stmt|;
name|CLEAR_INCOMPLETE
argument_list|(
name|editor
argument_list|,
name|dst_relpath
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_move
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
name|svn_revnum_t
name|src_revision
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|svn_revnum_t
name|replaces_rev
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|src_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|dst_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SHOULD_NOT_BE_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|SHOULD_NOT_BE_COMPLETED
argument_list|(
name|editor
argument_list|,
name|src_relpath
argument_list|)
expr_stmt|;
name|SHOULD_ALLOW_ADD
argument_list|(
name|editor
argument_list|,
name|dst_relpath
argument_list|)
expr_stmt|;
name|VERIFY_PARENT_MAY_EXIST
argument_list|(
name|editor
argument_list|,
name|src_relpath
argument_list|)
expr_stmt|;
name|CHILD_DELETIONS_ALLOWED
argument_list|(
name|editor
argument_list|,
name|src_relpath
argument_list|)
expr_stmt|;
name|VERIFY_PARENT_MAY_EXIST
argument_list|(
name|editor
argument_list|,
name|dst_relpath
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|check_cancel
argument_list|(
name|editor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|funcs
operator|.
name|cb_move
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|funcs
operator|.
name|cb_move
argument_list|(
name|editor
operator|->
name|baton
argument_list|,
name|src_relpath
argument_list|,
name|src_revision
argument_list|,
name|dst_relpath
argument_list|,
name|replaces_rev
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
name|MARK_ALLOW_ADD
argument_list|(
name|editor
argument_list|,
name|src_relpath
argument_list|)
expr_stmt|;
name|MARK_PARENT_STABLE
argument_list|(
name|editor
argument_list|,
name|src_relpath
argument_list|)
expr_stmt|;
name|MARK_ALLOW_ALTER
argument_list|(
name|editor
argument_list|,
name|dst_relpath
argument_list|)
expr_stmt|;
name|MARK_PARENT_STABLE
argument_list|(
name|editor
argument_list|,
name|dst_relpath
argument_list|)
expr_stmt|;
name|CLEAR_INCOMPLETE
argument_list|(
name|editor
argument_list|,
name|dst_relpath
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_rotate
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|relpaths
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|revisions
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SHOULD_NOT_BE_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ENABLE_ORDERING_CHECK
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|relpaths
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|relpath
init|=
name|APR_ARRAY_IDX
argument_list|(
name|relpaths
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SHOULD_NOT_BE_COMPLETED
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|VERIFY_PARENT_MAY_EXIST
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|CHILD_DELETIONS_ALLOWED
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|SVN_ERR
argument_list|(
name|check_cancel
argument_list|(
name|editor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|funcs
operator|.
name|cb_rotate
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|funcs
operator|.
name|cb_rotate
argument_list|(
name|editor
operator|->
name|baton
argument_list|,
name|relpaths
argument_list|,
name|revisions
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|ENABLE_ORDERING_CHECK
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|relpaths
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|relpath
init|=
name|APR_ARRAY_IDX
argument_list|(
name|relpaths
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
name|MARK_ALLOW_ALTER
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|MARK_PARENT_STABLE
argument_list|(
name|editor
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|svn_pool_clear
argument_list|(
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_complete
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SHOULD_NOT_BE_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ENABLE_ORDERING_CHECK
name|SVN_ERR_ASSERT
argument_list|(
name|apr_hash_count
argument_list|(
name|editor
operator|->
name|pending_incomplete_children
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|editor
operator|->
name|funcs
operator|.
name|cb_complete
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|funcs
operator|.
name|cb_complete
argument_list|(
name|editor
operator|->
name|baton
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
name|MARK_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_editor_abort
parameter_list|(
name|svn_editor_t
modifier|*
name|editor
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|SHOULD_NOT_BE_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
if|if
condition|(
name|editor
operator|->
name|funcs
operator|.
name|cb_abort
condition|)
block|{
name|START_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|funcs
operator|.
name|cb_abort
argument_list|(
name|editor
operator|->
name|baton
argument_list|,
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
name|END_CALLBACK
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
name|MARK_FINISHED
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|editor
operator|->
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

end_unit


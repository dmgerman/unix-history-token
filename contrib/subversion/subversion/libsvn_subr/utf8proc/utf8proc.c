begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  Copyright (c) 2009 Public Software Group e. V., Berlin, Germany  *  *  Permission is hereby granted, free of charge, to any person obtaining a  *  copy of this software and associated documentation files (the "Software"),  *  to deal in the Software without restriction, including without limitation  *  the rights to use, copy, modify, merge, publish, distribute, sublicense,  *  and/or sell copies of the Software, and to permit persons to whom the  *  Software is furnished to do so, subject to the following conditions:  *  *  The above copyright notice and this permission notice shall be included in  *  all copies or substantial portions of the Software.  *  *  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE  *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER  *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING  *  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  *  DEALINGS IN THE SOFTWARE.  */
end_comment

begin_comment
comment|/*  *  This library contains derived data from a modified version of the  *  Unicode data files.  *  *  The original data files are available at  *  http://www.unicode.org/Public/UNIDATA/  *  *  Please notice the copyright statement in the file "utf8proc_data.c".  */
end_comment

begin_comment
comment|/*  *  File name:    utf8proc.c  *  *  Description:  *  Implementation of libutf8proc.  */
end_comment

begin_include
include|#
directive|include
file|"utf8proc.h"
end_include

begin_include
include|#
directive|include
file|"utf8proc_data.c"
end_include

begin_decl_stmt
name|UTF8PROC_DATA
specifier|const
name|int8_t
name|utf8proc_utf8class
index|[
literal|256
index|]
init|=
block|{
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_SBASE
value|0xAC00
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_LBASE
value|0x1100
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_VBASE
value|0x1161
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_TBASE
value|0x11A7
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_LCOUNT
value|19
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_VCOUNT
value|21
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_TCOUNT
value|28
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_NCOUNT
value|588
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_SCOUNT
value|11172
end_define

begin_comment
comment|/* END is exclusive */
end_comment

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_L_START
value|0x1100
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_L_END
value|0x115A
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_L_FILLER
value|0x115F
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_V_START
value|0x1160
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_V_END
value|0x11A3
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_T_START
value|0x11A8
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_T_END
value|0x11FA
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_S_START
value|0xAC00
end_define

begin_define
define|#
directive|define
name|UTF8PROC_HANGUL_S_END
value|0xD7A4
end_define

begin_define
define|#
directive|define
name|UTF8PROC_BOUNDCLASS_START
value|0
end_define

begin_define
define|#
directive|define
name|UTF8PROC_BOUNDCLASS_OTHER
value|1
end_define

begin_define
define|#
directive|define
name|UTF8PROC_BOUNDCLASS_CR
value|2
end_define

begin_define
define|#
directive|define
name|UTF8PROC_BOUNDCLASS_LF
value|3
end_define

begin_define
define|#
directive|define
name|UTF8PROC_BOUNDCLASS_CONTROL
value|4
end_define

begin_define
define|#
directive|define
name|UTF8PROC_BOUNDCLASS_EXTEND
value|5
end_define

begin_define
define|#
directive|define
name|UTF8PROC_BOUNDCLASS_L
value|6
end_define

begin_define
define|#
directive|define
name|UTF8PROC_BOUNDCLASS_V
value|7
end_define

begin_define
define|#
directive|define
name|UTF8PROC_BOUNDCLASS_T
value|8
end_define

begin_define
define|#
directive|define
name|UTF8PROC_BOUNDCLASS_LV
value|9
end_define

begin_define
define|#
directive|define
name|UTF8PROC_BOUNDCLASS_LVT
value|10
end_define

begin_function
name|UTF8PROC_API
specifier|const
name|char
modifier|*
name|utf8proc_version
parameter_list|(
name|void
parameter_list|)
block|{
return|return
literal|"1.1.5"
return|;
block|}
end_function

begin_comment
comment|/*  * This macro tells translators that string X should be translated,  * but does not look up the translation at run time.  This is standard  * GNU gettext notation for annotating compile-time constant strings.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|N_
end_ifndef

begin_define
define|#
directive|define
name|N_
parameter_list|(
name|x
parameter_list|)
value|x
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|UTF8PROC_API
specifier|const
name|char
modifier|*
name|utf8proc_errmsg
parameter_list|(
name|ssize_t
name|errcode
parameter_list|)
block|{
switch|switch
condition|(
name|errcode
condition|)
block|{
case|case
name|UTF8PROC_ERROR_NOMEM
case|:
return|return
name|N_
argument_list|(
literal|"Memory for processing UTF-8 data could not be allocated."
argument_list|)
return|;
case|case
name|UTF8PROC_ERROR_OVERFLOW
case|:
return|return
name|N_
argument_list|(
literal|"UTF-8 string is too long to be processed."
argument_list|)
return|;
case|case
name|UTF8PROC_ERROR_INVALIDUTF8
case|:
return|return
name|N_
argument_list|(
literal|"Invalid UTF-8 string"
argument_list|)
return|;
case|case
name|UTF8PROC_ERROR_NOTASSIGNED
case|:
return|return
name|N_
argument_list|(
literal|"Unassigned Unicode code point found in UTF-8 string."
argument_list|)
return|;
case|case
name|UTF8PROC_ERROR_INVALIDOPTS
case|:
return|return
name|N_
argument_list|(
literal|"Invalid options for UTF-8 processing chosen."
argument_list|)
return|;
default|default:
return|return
name|N_
argument_list|(
literal|"An unknown error occured while processing UTF-8 data."
argument_list|)
return|;
block|}
block|}
end_function

begin_function
name|UTF8PROC_API
name|ssize_t
name|utf8proc_iterate
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|str
parameter_list|,
name|ssize_t
name|strlen
parameter_list|,
name|int32_t
modifier|*
name|dst
parameter_list|)
block|{
name|int
name|length
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int32_t
name|uc
init|=
operator|-
literal|1
decl_stmt|;
operator|*
name|dst
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|strlen
condition|)
return|return
literal|0
return|;
name|length
operator|=
name|utf8proc_utf8class
index|[
name|str
index|[
literal|0
index|]
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|length
condition|)
return|return
name|UTF8PROC_ERROR_INVALIDUTF8
return|;
if|if
condition|(
name|strlen
operator|>=
literal|0
operator|&&
name|length
operator|>
name|strlen
condition|)
return|return
name|UTF8PROC_ERROR_INVALIDUTF8
return|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|str
index|[
name|i
index|]
operator|&
literal|0xC0
operator|)
operator|!=
literal|0x80
condition|)
return|return
name|UTF8PROC_ERROR_INVALIDUTF8
return|;
block|}
switch|switch
condition|(
name|length
condition|)
block|{
case|case
literal|1
case|:
name|uc
operator|=
name|str
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|uc
operator|=
operator|(
operator|(
name|str
index|[
literal|0
index|]
operator|&
literal|0x1F
operator|)
operator|<<
literal|6
operator|)
operator|+
operator|(
name|str
index|[
literal|1
index|]
operator|&
literal|0x3F
operator|)
expr_stmt|;
if|if
condition|(
name|uc
operator|<
literal|0x80
condition|)
name|uc
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|uc
operator|=
operator|(
operator|(
name|str
index|[
literal|0
index|]
operator|&
literal|0x0F
operator|)
operator|<<
literal|12
operator|)
operator|+
operator|(
operator|(
name|str
index|[
literal|1
index|]
operator|&
literal|0x3F
operator|)
operator|<<
literal|6
operator|)
operator|+
operator|(
name|str
index|[
literal|2
index|]
operator|&
literal|0x3F
operator|)
expr_stmt|;
if|if
condition|(
name|uc
operator|<
literal|0x800
operator|||
operator|(
name|uc
operator|>=
literal|0xD800
operator|&&
name|uc
operator|<
literal|0xE000
operator|)
operator|||
operator|(
name|uc
operator|>=
literal|0xFDD0
operator|&&
name|uc
operator|<
literal|0xFDF0
operator|)
condition|)
name|uc
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|uc
operator|=
operator|(
operator|(
name|str
index|[
literal|0
index|]
operator|&
literal|0x07
operator|)
operator|<<
literal|18
operator|)
operator|+
operator|(
operator|(
name|str
index|[
literal|1
index|]
operator|&
literal|0x3F
operator|)
operator|<<
literal|12
operator|)
operator|+
operator|(
operator|(
name|str
index|[
literal|2
index|]
operator|&
literal|0x3F
operator|)
operator|<<
literal|6
operator|)
operator|+
operator|(
name|str
index|[
literal|3
index|]
operator|&
literal|0x3F
operator|)
expr_stmt|;
if|if
condition|(
name|uc
operator|<
literal|0x10000
operator|||
name|uc
operator|>=
literal|0x110000
condition|)
name|uc
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|uc
operator|<
literal|0
operator|||
operator|(
operator|(
name|uc
operator|&
literal|0xFFFF
operator|)
operator|>=
literal|0xFFFE
operator|)
condition|)
return|return
name|UTF8PROC_ERROR_INVALIDUTF8
return|;
operator|*
name|dst
operator|=
name|uc
expr_stmt|;
return|return
name|length
return|;
block|}
end_function

begin_function
name|UTF8PROC_API
name|bool
name|utf8proc_codepoint_valid
parameter_list|(
name|int32_t
name|uc
parameter_list|)
block|{
if|if
condition|(
name|uc
operator|<
literal|0
operator|||
name|uc
operator|>=
literal|0x110000
operator|||
operator|(
operator|(
name|uc
operator|&
literal|0xFFFF
operator|)
operator|>=
literal|0xFFFE
operator|)
operator|||
operator|(
name|uc
operator|>=
literal|0xD800
operator|&&
name|uc
operator|<
literal|0xE000
operator|)
operator|||
operator|(
name|uc
operator|>=
literal|0xFDD0
operator|&&
name|uc
operator|<
literal|0xFDF0
operator|)
condition|)
return|return
name|false
return|;
else|else
return|return
name|true
return|;
block|}
end_function

begin_function
name|UTF8PROC_API
name|ssize_t
name|utf8proc_encode_char
parameter_list|(
name|int32_t
name|uc
parameter_list|,
name|uint8_t
modifier|*
name|dst
parameter_list|)
block|{
if|if
condition|(
name|uc
operator|<
literal|0x00
condition|)
block|{
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|uc
operator|<
literal|0x80
condition|)
block|{
name|dst
index|[
literal|0
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|uc
expr_stmt|;
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|uc
operator|<
literal|0x800
condition|)
block|{
name|dst
index|[
literal|0
index|]
operator|=
literal|0xC0
operator|+
call|(
name|uint8_t
call|)
argument_list|(
name|uc
operator|>>
literal|6
argument_list|)
expr_stmt|;
name|dst
index|[
literal|1
index|]
operator|=
literal|0x80
operator|+
operator|(
name|uc
operator|&
literal|0x3F
operator|)
expr_stmt|;
return|return
literal|2
return|;
block|}
elseif|else
if|if
condition|(
name|uc
operator|==
literal|0xFFFF
condition|)
block|{
name|dst
index|[
literal|0
index|]
operator|=
literal|0xFF
expr_stmt|;
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|uc
operator|==
literal|0xFFFE
condition|)
block|{
name|dst
index|[
literal|0
index|]
operator|=
literal|0xFE
expr_stmt|;
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|uc
operator|<
literal|0x10000
condition|)
block|{
name|dst
index|[
literal|0
index|]
operator|=
literal|0xE0
operator|+
call|(
name|uint8_t
call|)
argument_list|(
name|uc
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|dst
index|[
literal|1
index|]
operator|=
literal|0x80
operator|+
operator|(
operator|(
name|uc
operator|>>
literal|6
operator|)
operator|&
literal|0x3F
operator|)
expr_stmt|;
name|dst
index|[
literal|2
index|]
operator|=
literal|0x80
operator|+
operator|(
name|uc
operator|&
literal|0x3F
operator|)
expr_stmt|;
return|return
literal|3
return|;
block|}
elseif|else
if|if
condition|(
name|uc
operator|<
literal|0x110000
condition|)
block|{
name|dst
index|[
literal|0
index|]
operator|=
literal|0xF0
operator|+
call|(
name|uint8_t
call|)
argument_list|(
name|uc
operator|>>
literal|18
argument_list|)
expr_stmt|;
name|dst
index|[
literal|1
index|]
operator|=
literal|0x80
operator|+
operator|(
operator|(
name|uc
operator|>>
literal|12
operator|)
operator|&
literal|0x3F
operator|)
expr_stmt|;
name|dst
index|[
literal|2
index|]
operator|=
literal|0x80
operator|+
operator|(
operator|(
name|uc
operator|>>
literal|6
operator|)
operator|&
literal|0x3F
operator|)
expr_stmt|;
name|dst
index|[
literal|3
index|]
operator|=
literal|0x80
operator|+
operator|(
name|uc
operator|&
literal|0x3F
operator|)
expr_stmt|;
return|return
literal|4
return|;
block|}
else|else
return|return
literal|0
return|;
block|}
end_function

begin_function
name|UTF8PROC_API
specifier|const
name|utf8proc_property_t
modifier|*
name|utf8proc_get_property
parameter_list|(
name|int32_t
name|uc
parameter_list|)
block|{
comment|/* ASSERT: uc>= 0&& uc< 0x110000 */
return|return
name|utf8proc_properties
operator|+
operator|(
name|utf8proc_stage2table
index|[
name|utf8proc_stage1table
index|[
name|uc
operator|>>
literal|8
index|]
operator|+
operator|(
name|uc
operator|&
literal|0xFF
operator|)
index|]
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|utf8proc_decompose_lump
parameter_list|(
name|replacement_uc
parameter_list|)
define|\
value|return utf8proc_decompose_char((replacement_uc), dst, bufsize, \   options& ~UTF8PROC_LUMP, last_boundclass)
end_define

begin_function
name|UTF8PROC_API
name|ssize_t
name|utf8proc_decompose_char
parameter_list|(
name|int32_t
name|uc
parameter_list|,
name|int32_t
modifier|*
name|dst
parameter_list|,
name|ssize_t
name|bufsize
parameter_list|,
name|int
name|options
parameter_list|,
name|int
modifier|*
name|last_boundclass
parameter_list|)
block|{
comment|/* ASSERT: uc>= 0&& uc< 0x110000 */
specifier|const
name|utf8proc_property_t
modifier|*
name|property
decl_stmt|;
name|utf8proc_propval_t
name|category
decl_stmt|;
name|int32_t
name|hangul_sindex
decl_stmt|;
name|property
operator|=
name|utf8proc_get_property
argument_list|(
name|uc
argument_list|)
expr_stmt|;
name|category
operator|=
name|property
operator|->
name|category
expr_stmt|;
name|hangul_sindex
operator|=
name|uc
operator|-
name|UTF8PROC_HANGUL_SBASE
expr_stmt|;
if|if
condition|(
name|options
operator|&
operator|(
name|UTF8PROC_COMPOSE
operator||
name|UTF8PROC_DECOMPOSE
operator|)
condition|)
block|{
if|if
condition|(
name|hangul_sindex
operator|>=
literal|0
operator|&&
name|hangul_sindex
operator|<
name|UTF8PROC_HANGUL_SCOUNT
condition|)
block|{
name|int32_t
name|hangul_tindex
decl_stmt|;
if|if
condition|(
name|bufsize
operator|>=
literal|1
condition|)
block|{
name|dst
index|[
literal|0
index|]
operator|=
name|UTF8PROC_HANGUL_LBASE
operator|+
name|hangul_sindex
operator|/
name|UTF8PROC_HANGUL_NCOUNT
expr_stmt|;
if|if
condition|(
name|bufsize
operator|>=
literal|2
condition|)
name|dst
index|[
literal|1
index|]
operator|=
name|UTF8PROC_HANGUL_VBASE
operator|+
operator|(
name|hangul_sindex
operator|%
name|UTF8PROC_HANGUL_NCOUNT
operator|)
operator|/
name|UTF8PROC_HANGUL_TCOUNT
expr_stmt|;
block|}
name|hangul_tindex
operator|=
name|hangul_sindex
operator|%
name|UTF8PROC_HANGUL_TCOUNT
expr_stmt|;
if|if
condition|(
operator|!
name|hangul_tindex
condition|)
return|return
literal|2
return|;
if|if
condition|(
name|bufsize
operator|>=
literal|3
condition|)
name|dst
index|[
literal|2
index|]
operator|=
name|UTF8PROC_HANGUL_TBASE
operator|+
name|hangul_tindex
expr_stmt|;
return|return
literal|3
return|;
block|}
block|}
if|if
condition|(
name|options
operator|&
name|UTF8PROC_REJECTNA
condition|)
block|{
if|if
condition|(
operator|!
name|category
condition|)
return|return
name|UTF8PROC_ERROR_NOTASSIGNED
return|;
block|}
if|if
condition|(
name|options
operator|&
name|UTF8PROC_IGNORE
condition|)
block|{
if|if
condition|(
name|property
operator|->
name|ignorable
condition|)
return|return
literal|0
return|;
block|}
if|if
condition|(
name|options
operator|&
name|UTF8PROC_LUMP
condition|)
block|{
if|if
condition|(
name|category
operator|==
name|UTF8PROC_CATEGORY_ZS
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x0020
argument_list|)
expr_stmt|;
if|if
condition|(
name|uc
operator|==
literal|0x2018
operator|||
name|uc
operator|==
literal|0x2019
operator|||
name|uc
operator|==
literal|0x02BC
operator|||
name|uc
operator|==
literal|0x02C8
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x0027
argument_list|)
expr_stmt|;
if|if
condition|(
name|category
operator|==
name|UTF8PROC_CATEGORY_PD
operator|||
name|uc
operator|==
literal|0x2212
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x002D
argument_list|)
expr_stmt|;
if|if
condition|(
name|uc
operator|==
literal|0x2044
operator|||
name|uc
operator|==
literal|0x2215
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x002F
argument_list|)
expr_stmt|;
if|if
condition|(
name|uc
operator|==
literal|0x2236
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x003A
argument_list|)
expr_stmt|;
if|if
condition|(
name|uc
operator|==
literal|0x2039
operator|||
name|uc
operator|==
literal|0x2329
operator|||
name|uc
operator|==
literal|0x3008
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x003C
argument_list|)
expr_stmt|;
if|if
condition|(
name|uc
operator|==
literal|0x203A
operator|||
name|uc
operator|==
literal|0x232A
operator|||
name|uc
operator|==
literal|0x3009
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x003E
argument_list|)
expr_stmt|;
if|if
condition|(
name|uc
operator|==
literal|0x2216
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x005C
argument_list|)
expr_stmt|;
if|if
condition|(
name|uc
operator|==
literal|0x02C4
operator|||
name|uc
operator|==
literal|0x02C6
operator|||
name|uc
operator|==
literal|0x2038
operator|||
name|uc
operator|==
literal|0x2303
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x005E
argument_list|)
expr_stmt|;
if|if
condition|(
name|category
operator|==
name|UTF8PROC_CATEGORY_PC
operator|||
name|uc
operator|==
literal|0x02CD
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x005F
argument_list|)
expr_stmt|;
if|if
condition|(
name|uc
operator|==
literal|0x02CB
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x0060
argument_list|)
expr_stmt|;
if|if
condition|(
name|uc
operator|==
literal|0x2223
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x007C
argument_list|)
expr_stmt|;
if|if
condition|(
name|uc
operator|==
literal|0x223C
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x007E
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|options
operator|&
name|UTF8PROC_NLF2LS
operator|)
operator|&&
operator|(
name|options
operator|&
name|UTF8PROC_NLF2PS
operator|)
condition|)
block|{
if|if
condition|(
name|category
operator|==
name|UTF8PROC_CATEGORY_ZL
operator|||
name|category
operator|==
name|UTF8PROC_CATEGORY_ZP
condition|)
name|utf8proc_decompose_lump
argument_list|(
literal|0x000A
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|options
operator|&
name|UTF8PROC_STRIPMARK
condition|)
block|{
if|if
condition|(
name|category
operator|==
name|UTF8PROC_CATEGORY_MN
operator|||
name|category
operator|==
name|UTF8PROC_CATEGORY_MC
operator|||
name|category
operator|==
name|UTF8PROC_CATEGORY_ME
condition|)
return|return
literal|0
return|;
block|}
if|if
condition|(
name|options
operator|&
name|UTF8PROC_CASEFOLD
condition|)
block|{
if|if
condition|(
name|property
operator|->
name|casefold_mapping
condition|)
block|{
specifier|const
name|int32_t
modifier|*
name|casefold_entry
decl_stmt|;
name|ssize_t
name|written
init|=
literal|0
decl_stmt|;
for|for
control|(
name|casefold_entry
operator|=
name|property
operator|->
name|casefold_mapping
init|;
operator|*
name|casefold_entry
operator|>=
literal|0
condition|;
name|casefold_entry
operator|++
control|)
block|{
name|written
operator|+=
name|utf8proc_decompose_char
argument_list|(
operator|*
name|casefold_entry
argument_list|,
name|dst
operator|+
name|written
argument_list|,
operator|(
name|bufsize
operator|>
name|written
operator|)
condition|?
operator|(
name|bufsize
operator|-
name|written
operator|)
else|:
literal|0
argument_list|,
name|options
argument_list|,
name|last_boundclass
argument_list|)
expr_stmt|;
if|if
condition|(
name|written
operator|<
literal|0
condition|)
return|return
name|UTF8PROC_ERROR_OVERFLOW
return|;
block|}
return|return
name|written
return|;
block|}
block|}
if|if
condition|(
name|options
operator|&
operator|(
name|UTF8PROC_COMPOSE
operator||
name|UTF8PROC_DECOMPOSE
operator|)
condition|)
block|{
if|if
condition|(
name|property
operator|->
name|decomp_mapping
operator|&&
operator|(
operator|!
name|property
operator|->
name|decomp_type
operator|||
operator|(
name|options
operator|&
name|UTF8PROC_COMPAT
operator|)
operator|)
condition|)
block|{
specifier|const
name|int32_t
modifier|*
name|decomp_entry
decl_stmt|;
name|ssize_t
name|written
init|=
literal|0
decl_stmt|;
for|for
control|(
name|decomp_entry
operator|=
name|property
operator|->
name|decomp_mapping
init|;
operator|*
name|decomp_entry
operator|>=
literal|0
condition|;
name|decomp_entry
operator|++
control|)
block|{
name|written
operator|+=
name|utf8proc_decompose_char
argument_list|(
operator|*
name|decomp_entry
argument_list|,
name|dst
operator|+
name|written
argument_list|,
operator|(
name|bufsize
operator|>
name|written
operator|)
condition|?
operator|(
name|bufsize
operator|-
name|written
operator|)
else|:
literal|0
argument_list|,
name|options
argument_list|,
name|last_boundclass
argument_list|)
expr_stmt|;
if|if
condition|(
name|written
operator|<
literal|0
condition|)
return|return
name|UTF8PROC_ERROR_OVERFLOW
return|;
block|}
return|return
name|written
return|;
block|}
block|}
if|if
condition|(
name|options
operator|&
name|UTF8PROC_CHARBOUND
condition|)
block|{
name|bool
name|boundary
decl_stmt|;
name|int
name|tbc
decl_stmt|,
name|lbc
decl_stmt|;
name|tbc
operator|=
operator|(
name|uc
operator|==
literal|0x000D
operator|)
condition|?
name|UTF8PROC_BOUNDCLASS_CR
else|:
operator|(
name|uc
operator|==
literal|0x000A
operator|)
condition|?
name|UTF8PROC_BOUNDCLASS_LF
else|:
operator|(
operator|(
name|category
operator|==
name|UTF8PROC_CATEGORY_ZL
operator|||
name|category
operator|==
name|UTF8PROC_CATEGORY_ZP
operator|||
name|category
operator|==
name|UTF8PROC_CATEGORY_CC
operator|||
name|category
operator|==
name|UTF8PROC_CATEGORY_CF
operator|)
operator|&&
operator|!
operator|(
name|uc
operator|==
literal|0x200C
operator|||
name|uc
operator|==
literal|0x200D
operator|)
operator|)
condition|?
name|UTF8PROC_BOUNDCLASS_CONTROL
else|:
name|property
operator|->
name|extend
condition|?
name|UTF8PROC_BOUNDCLASS_EXTEND
else|:
operator|(
operator|(
name|uc
operator|>=
name|UTF8PROC_HANGUL_L_START
operator|&&
name|uc
operator|<
name|UTF8PROC_HANGUL_L_END
operator|)
operator|||
name|uc
operator|==
name|UTF8PROC_HANGUL_L_FILLER
operator|)
condition|?
name|UTF8PROC_BOUNDCLASS_L
else|:
operator|(
name|uc
operator|>=
name|UTF8PROC_HANGUL_V_START
operator|&&
name|uc
operator|<
name|UTF8PROC_HANGUL_V_END
operator|)
condition|?
name|UTF8PROC_BOUNDCLASS_V
else|:
operator|(
name|uc
operator|>=
name|UTF8PROC_HANGUL_T_START
operator|&&
name|uc
operator|<
name|UTF8PROC_HANGUL_T_END
operator|)
condition|?
name|UTF8PROC_BOUNDCLASS_T
else|:
operator|(
name|uc
operator|>=
name|UTF8PROC_HANGUL_S_START
operator|&&
name|uc
operator|<
name|UTF8PROC_HANGUL_S_END
operator|)
condition|?
operator|(
operator|(
operator|(
name|uc
operator|-
name|UTF8PROC_HANGUL_SBASE
operator|)
operator|%
name|UTF8PROC_HANGUL_TCOUNT
operator|==
literal|0
operator|)
condition|?
name|UTF8PROC_BOUNDCLASS_LV
else|:
name|UTF8PROC_BOUNDCLASS_LVT
operator|)
else|:
name|UTF8PROC_BOUNDCLASS_OTHER
expr_stmt|;
name|lbc
operator|=
operator|*
name|last_boundclass
expr_stmt|;
name|boundary
operator|=
operator|(
name|tbc
operator|==
name|UTF8PROC_BOUNDCLASS_EXTEND
operator|)
condition|?
name|false
else|:
operator|(
name|lbc
operator|==
name|UTF8PROC_BOUNDCLASS_START
operator|)
condition|?
name|true
else|:
operator|(
name|lbc
operator|==
name|UTF8PROC_BOUNDCLASS_CR
operator|&&
name|tbc
operator|==
name|UTF8PROC_BOUNDCLASS_LF
operator|)
condition|?
name|false
else|:
operator|(
name|lbc
operator|==
name|UTF8PROC_BOUNDCLASS_CONTROL
operator|)
condition|?
name|true
else|:
operator|(
name|tbc
operator|==
name|UTF8PROC_BOUNDCLASS_CONTROL
operator|)
condition|?
name|true
else|:
operator|(
name|lbc
operator|==
name|UTF8PROC_BOUNDCLASS_L
operator|&&
operator|(
name|tbc
operator|==
name|UTF8PROC_BOUNDCLASS_L
operator|||
name|tbc
operator|==
name|UTF8PROC_BOUNDCLASS_V
operator|||
name|tbc
operator|==
name|UTF8PROC_BOUNDCLASS_LV
operator|||
name|tbc
operator|==
name|UTF8PROC_BOUNDCLASS_LVT
operator|)
operator|)
condition|?
name|false
else|:
operator|(
operator|(
name|lbc
operator|==
name|UTF8PROC_BOUNDCLASS_LV
operator|||
name|lbc
operator|==
name|UTF8PROC_BOUNDCLASS_V
operator|)
operator|&&
operator|(
name|tbc
operator|==
name|UTF8PROC_BOUNDCLASS_V
operator|||
name|tbc
operator|==
name|UTF8PROC_BOUNDCLASS_T
operator|)
operator|)
condition|?
name|false
else|:
operator|(
operator|(
name|lbc
operator|==
name|UTF8PROC_BOUNDCLASS_LVT
operator|||
name|lbc
operator|==
name|UTF8PROC_BOUNDCLASS_T
operator|)
operator|&&
name|tbc
operator|==
name|UTF8PROC_BOUNDCLASS_T
operator|)
condition|?
name|false
else|:
name|true
expr_stmt|;
operator|*
name|last_boundclass
operator|=
name|tbc
expr_stmt|;
if|if
condition|(
name|boundary
condition|)
block|{
if|if
condition|(
name|bufsize
operator|>=
literal|1
condition|)
name|dst
index|[
literal|0
index|]
operator|=
literal|0xFFFF
expr_stmt|;
if|if
condition|(
name|bufsize
operator|>=
literal|2
condition|)
name|dst
index|[
literal|1
index|]
operator|=
name|uc
expr_stmt|;
return|return
literal|2
return|;
block|}
block|}
if|if
condition|(
name|bufsize
operator|>=
literal|1
condition|)
operator|*
name|dst
operator|=
name|uc
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|UTF8PROC_API
name|ssize_t
name|utf8proc_decompose
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|str
parameter_list|,
name|ssize_t
name|strlen
parameter_list|,
name|int32_t
modifier|*
name|buffer
parameter_list|,
name|ssize_t
name|bufsize
parameter_list|,
name|int
name|options
parameter_list|)
block|{
comment|/* strlen will be ignored, if UTF8PROC_NULLTERM is set in options */
name|ssize_t
name|wpos
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|options
operator|&
name|UTF8PROC_COMPOSE
operator|)
operator|&&
operator|(
name|options
operator|&
name|UTF8PROC_DECOMPOSE
operator|)
condition|)
return|return
name|UTF8PROC_ERROR_INVALIDOPTS
return|;
if|if
condition|(
operator|(
name|options
operator|&
name|UTF8PROC_STRIPMARK
operator|)
operator|&&
operator|!
operator|(
name|options
operator|&
name|UTF8PROC_COMPOSE
operator|)
operator|&&
operator|!
operator|(
name|options
operator|&
name|UTF8PROC_DECOMPOSE
operator|)
condition|)
return|return
name|UTF8PROC_ERROR_INVALIDOPTS
return|;
block|{
name|int32_t
name|uc
decl_stmt|;
name|ssize_t
name|rpos
init|=
literal|0
decl_stmt|;
name|ssize_t
name|decomp_result
decl_stmt|;
name|int
name|boundclass
init|=
name|UTF8PROC_BOUNDCLASS_START
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|options
operator|&
name|UTF8PROC_NULLTERM
condition|)
block|{
name|rpos
operator|+=
name|utf8proc_iterate
argument_list|(
name|str
operator|+
name|rpos
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|uc
argument_list|)
expr_stmt|;
comment|/* checking of return value is not neccessary,            as 'uc' is< 0 in case of error */
if|if
condition|(
name|uc
operator|<
literal|0
condition|)
return|return
name|UTF8PROC_ERROR_INVALIDUTF8
return|;
if|if
condition|(
name|rpos
operator|<
literal|0
condition|)
return|return
name|UTF8PROC_ERROR_OVERFLOW
return|;
if|if
condition|(
name|uc
operator|==
literal|0
condition|)
break|break;
block|}
else|else
block|{
if|if
condition|(
name|rpos
operator|>=
name|strlen
condition|)
break|break;
name|rpos
operator|+=
name|utf8proc_iterate
argument_list|(
name|str
operator|+
name|rpos
argument_list|,
name|strlen
operator|-
name|rpos
argument_list|,
operator|&
name|uc
argument_list|)
expr_stmt|;
if|if
condition|(
name|uc
operator|<
literal|0
condition|)
return|return
name|UTF8PROC_ERROR_INVALIDUTF8
return|;
block|}
name|decomp_result
operator|=
name|utf8proc_decompose_char
argument_list|(
name|uc
argument_list|,
name|buffer
operator|+
name|wpos
argument_list|,
operator|(
name|bufsize
operator|>
name|wpos
operator|)
condition|?
operator|(
name|bufsize
operator|-
name|wpos
operator|)
else|:
literal|0
argument_list|,
name|options
argument_list|,
operator|&
name|boundclass
argument_list|)
expr_stmt|;
if|if
condition|(
name|decomp_result
operator|<
literal|0
condition|)
return|return
name|decomp_result
return|;
name|wpos
operator|+=
name|decomp_result
expr_stmt|;
comment|/* prohibiting integer overflows due to too long strings: */
if|if
condition|(
name|wpos
operator|<
literal|0
operator|||
name|wpos
operator|>
name|SSIZE_MAX
operator|/
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
operator|/
literal|2
condition|)
return|return
name|UTF8PROC_ERROR_OVERFLOW
return|;
block|}
block|}
if|if
condition|(
operator|(
name|options
operator|&
operator|(
name|UTF8PROC_COMPOSE
operator||
name|UTF8PROC_DECOMPOSE
operator|)
operator|)
operator|&&
name|bufsize
operator|>=
name|wpos
condition|)
block|{
name|ssize_t
name|pos
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|pos
operator|<
name|wpos
operator|-
literal|1
condition|)
block|{
name|int32_t
name|uc1
decl_stmt|,
name|uc2
decl_stmt|;
specifier|const
name|utf8proc_property_t
modifier|*
name|property1
decl_stmt|,
modifier|*
name|property2
decl_stmt|;
name|uc1
operator|=
name|buffer
index|[
name|pos
index|]
expr_stmt|;
name|uc2
operator|=
name|buffer
index|[
name|pos
operator|+
literal|1
index|]
expr_stmt|;
name|property1
operator|=
name|utf8proc_get_property
argument_list|(
name|uc1
argument_list|)
expr_stmt|;
name|property2
operator|=
name|utf8proc_get_property
argument_list|(
name|uc2
argument_list|)
expr_stmt|;
if|if
condition|(
name|property1
operator|->
name|combining_class
operator|>
name|property2
operator|->
name|combining_class
operator|&&
name|property2
operator|->
name|combining_class
operator|>
literal|0
condition|)
block|{
name|buffer
index|[
name|pos
index|]
operator|=
name|uc2
expr_stmt|;
name|buffer
index|[
name|pos
operator|+
literal|1
index|]
operator|=
name|uc1
expr_stmt|;
if|if
condition|(
name|pos
operator|>
literal|0
condition|)
name|pos
operator|--
expr_stmt|;
else|else
name|pos
operator|++
expr_stmt|;
block|}
else|else
block|{
name|pos
operator|++
expr_stmt|;
block|}
block|}
block|}
return|return
name|wpos
return|;
block|}
end_function

begin_function
name|UTF8PROC_API
name|ssize_t
name|utf8proc_reencode
parameter_list|(
name|int32_t
modifier|*
name|buffer
parameter_list|,
name|ssize_t
name|length
parameter_list|,
name|int
name|options
parameter_list|)
block|{
comment|/* UTF8PROC_NULLTERM option will be ignored, 'length' is never ignored      ASSERT: 'buffer' has one spare byte of free space at the end! */
if|if
condition|(
name|options
operator|&
operator|(
name|UTF8PROC_NLF2LS
operator||
name|UTF8PROC_NLF2PS
operator||
name|UTF8PROC_STRIPCC
operator|)
condition|)
block|{
name|ssize_t
name|rpos
decl_stmt|;
name|ssize_t
name|wpos
init|=
literal|0
decl_stmt|;
name|int32_t
name|uc
decl_stmt|;
for|for
control|(
name|rpos
operator|=
literal|0
init|;
name|rpos
operator|<
name|length
condition|;
name|rpos
operator|++
control|)
block|{
name|uc
operator|=
name|buffer
index|[
name|rpos
index|]
expr_stmt|;
if|if
condition|(
name|uc
operator|==
literal|0x000D
operator|&&
name|rpos
operator|<
name|length
operator|-
literal|1
operator|&&
name|buffer
index|[
name|rpos
operator|+
literal|1
index|]
operator|==
literal|0x000A
condition|)
name|rpos
operator|++
expr_stmt|;
if|if
condition|(
name|uc
operator|==
literal|0x000A
operator|||
name|uc
operator|==
literal|0x000D
operator|||
name|uc
operator|==
literal|0x0085
operator|||
operator|(
operator|(
name|options
operator|&
name|UTF8PROC_STRIPCC
operator|)
operator|&&
operator|(
name|uc
operator|==
literal|0x000B
operator|||
name|uc
operator|==
literal|0x000C
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|options
operator|&
name|UTF8PROC_NLF2LS
condition|)
block|{
if|if
condition|(
name|options
operator|&
name|UTF8PROC_NLF2PS
condition|)
block|{
name|buffer
index|[
name|wpos
operator|++
index|]
operator|=
literal|0x000A
expr_stmt|;
block|}
else|else
block|{
name|buffer
index|[
name|wpos
operator|++
index|]
operator|=
literal|0x2028
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|options
operator|&
name|UTF8PROC_NLF2PS
condition|)
block|{
name|buffer
index|[
name|wpos
operator|++
index|]
operator|=
literal|0x2029
expr_stmt|;
block|}
else|else
block|{
name|buffer
index|[
name|wpos
operator|++
index|]
operator|=
literal|0x0020
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|options
operator|&
name|UTF8PROC_STRIPCC
operator|)
operator|&&
operator|(
name|uc
operator|<
literal|0x0020
operator|||
operator|(
name|uc
operator|>=
literal|0x007F
operator|&&
name|uc
operator|<
literal|0x00A0
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|uc
operator|==
literal|0x0009
condition|)
name|buffer
index|[
name|wpos
operator|++
index|]
operator|=
literal|0x0020
expr_stmt|;
block|}
else|else
block|{
name|buffer
index|[
name|wpos
operator|++
index|]
operator|=
name|uc
expr_stmt|;
block|}
block|}
name|length
operator|=
name|wpos
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|&
name|UTF8PROC_COMPOSE
condition|)
block|{
name|int32_t
modifier|*
name|starter
init|=
name|NULL
decl_stmt|;
name|int32_t
name|current_char
decl_stmt|;
specifier|const
name|utf8proc_property_t
modifier|*
name|starter_property
init|=
name|NULL
decl_stmt|,
modifier|*
name|current_property
decl_stmt|;
name|utf8proc_propval_t
name|max_combining_class
init|=
operator|-
literal|1
decl_stmt|;
name|ssize_t
name|rpos
decl_stmt|;
name|ssize_t
name|wpos
init|=
literal|0
decl_stmt|;
name|int32_t
name|composition
decl_stmt|;
for|for
control|(
name|rpos
operator|=
literal|0
init|;
name|rpos
operator|<
name|length
condition|;
name|rpos
operator|++
control|)
block|{
name|current_char
operator|=
name|buffer
index|[
name|rpos
index|]
expr_stmt|;
name|current_property
operator|=
name|utf8proc_get_property
argument_list|(
name|current_char
argument_list|)
expr_stmt|;
if|if
condition|(
name|starter
operator|&&
name|current_property
operator|->
name|combining_class
operator|>
name|max_combining_class
condition|)
block|{
comment|/* combination perhaps possible */
name|int32_t
name|hangul_lindex
decl_stmt|;
name|int32_t
name|hangul_sindex
decl_stmt|;
name|hangul_lindex
operator|=
operator|*
name|starter
operator|-
name|UTF8PROC_HANGUL_LBASE
expr_stmt|;
if|if
condition|(
name|hangul_lindex
operator|>=
literal|0
operator|&&
name|hangul_lindex
operator|<
name|UTF8PROC_HANGUL_LCOUNT
condition|)
block|{
name|int32_t
name|hangul_vindex
decl_stmt|;
name|hangul_vindex
operator|=
name|current_char
operator|-
name|UTF8PROC_HANGUL_VBASE
expr_stmt|;
if|if
condition|(
name|hangul_vindex
operator|>=
literal|0
operator|&&
name|hangul_vindex
operator|<
name|UTF8PROC_HANGUL_VCOUNT
condition|)
block|{
operator|*
name|starter
operator|=
name|UTF8PROC_HANGUL_SBASE
operator|+
operator|(
name|hangul_lindex
operator|*
name|UTF8PROC_HANGUL_VCOUNT
operator|+
name|hangul_vindex
operator|)
operator|*
name|UTF8PROC_HANGUL_TCOUNT
expr_stmt|;
name|starter_property
operator|=
name|NULL
expr_stmt|;
continue|continue;
block|}
block|}
name|hangul_sindex
operator|=
operator|*
name|starter
operator|-
name|UTF8PROC_HANGUL_SBASE
expr_stmt|;
if|if
condition|(
name|hangul_sindex
operator|>=
literal|0
operator|&&
name|hangul_sindex
operator|<
name|UTF8PROC_HANGUL_SCOUNT
operator|&&
operator|(
name|hangul_sindex
operator|%
name|UTF8PROC_HANGUL_TCOUNT
operator|)
operator|==
literal|0
condition|)
block|{
name|int32_t
name|hangul_tindex
decl_stmt|;
name|hangul_tindex
operator|=
name|current_char
operator|-
name|UTF8PROC_HANGUL_TBASE
expr_stmt|;
if|if
condition|(
name|hangul_tindex
operator|>=
literal|0
operator|&&
name|hangul_tindex
operator|<
name|UTF8PROC_HANGUL_TCOUNT
condition|)
block|{
operator|*
name|starter
operator|+=
name|hangul_tindex
expr_stmt|;
name|starter_property
operator|=
name|NULL
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
operator|!
name|starter_property
condition|)
block|{
name|starter_property
operator|=
name|utf8proc_get_property
argument_list|(
operator|*
name|starter
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|starter_property
operator|->
name|comb1st_index
operator|>=
literal|0
operator|&&
name|current_property
operator|->
name|comb2nd_index
operator|>=
literal|0
condition|)
block|{
name|composition
operator|=
name|utf8proc_combinations
index|[
name|starter_property
operator|->
name|comb1st_index
operator|+
name|current_property
operator|->
name|comb2nd_index
index|]
expr_stmt|;
if|if
condition|(
name|composition
operator|>=
literal|0
operator|&&
operator|(
operator|!
operator|(
name|options
operator|&
name|UTF8PROC_STABLE
operator|)
operator|||
operator|!
operator|(
name|utf8proc_get_property
argument_list|(
name|composition
argument_list|)
operator|->
name|comp_exclusion
operator|)
operator|)
condition|)
block|{
operator|*
name|starter
operator|=
name|composition
expr_stmt|;
name|starter_property
operator|=
name|NULL
expr_stmt|;
continue|continue;
block|}
block|}
block|}
name|buffer
index|[
name|wpos
index|]
operator|=
name|current_char
expr_stmt|;
if|if
condition|(
name|current_property
operator|->
name|combining_class
condition|)
block|{
if|if
condition|(
name|current_property
operator|->
name|combining_class
operator|>
name|max_combining_class
condition|)
block|{
name|max_combining_class
operator|=
name|current_property
operator|->
name|combining_class
expr_stmt|;
block|}
block|}
else|else
block|{
name|starter
operator|=
name|buffer
operator|+
name|wpos
expr_stmt|;
name|starter_property
operator|=
name|NULL
expr_stmt|;
name|max_combining_class
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|wpos
operator|++
expr_stmt|;
block|}
name|length
operator|=
name|wpos
expr_stmt|;
block|}
block|{
name|ssize_t
name|rpos
decl_stmt|,
name|wpos
init|=
literal|0
decl_stmt|;
name|int32_t
name|uc
decl_stmt|;
for|for
control|(
name|rpos
operator|=
literal|0
init|;
name|rpos
operator|<
name|length
condition|;
name|rpos
operator|++
control|)
block|{
name|uc
operator|=
name|buffer
index|[
name|rpos
index|]
expr_stmt|;
name|wpos
operator|+=
name|utf8proc_encode_char
argument_list|(
name|uc
argument_list|,
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|buffer
operator|)
operator|+
name|wpos
argument_list|)
expr_stmt|;
block|}
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|buffer
operator|)
index|[
name|wpos
index|]
operator|=
literal|0
expr_stmt|;
return|return
name|wpos
return|;
block|}
block|}
end_function

begin_function
name|UTF8PROC_API
name|ssize_t
name|utf8proc_map
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|str
parameter_list|,
name|ssize_t
name|strlen
parameter_list|,
name|uint8_t
modifier|*
modifier|*
name|dstptr
parameter_list|,
name|int
name|options
parameter_list|)
block|{
name|int32_t
modifier|*
name|buffer
decl_stmt|;
name|ssize_t
name|result
decl_stmt|;
operator|*
name|dstptr
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|utf8proc_decompose
argument_list|(
name|str
argument_list|,
name|strlen
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
return|return
name|result
return|;
name|buffer
operator|=
name|malloc
argument_list|(
name|result
operator|*
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buffer
condition|)
return|return
name|UTF8PROC_ERROR_NOMEM
return|;
name|result
operator|=
name|utf8proc_decompose
argument_list|(
name|str
argument_list|,
name|strlen
argument_list|,
name|buffer
argument_list|,
name|result
argument_list|,
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
name|result
operator|=
name|utf8proc_reencode
argument_list|(
name|buffer
argument_list|,
name|result
argument_list|,
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
block|{
name|int32_t
modifier|*
name|newptr
decl_stmt|;
name|newptr
operator|=
name|realloc
argument_list|(
name|buffer
argument_list|,
operator|(
name|size_t
operator|)
name|result
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|newptr
condition|)
name|buffer
operator|=
name|newptr
expr_stmt|;
block|}
operator|*
name|dstptr
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|buffer
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
name|UTF8PROC_API
name|uint8_t
modifier|*
name|utf8proc_NFD
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|str
parameter_list|)
block|{
name|uint8_t
modifier|*
name|retval
decl_stmt|;
name|utf8proc_map
argument_list|(
name|str
argument_list|,
literal|0
argument_list|,
operator|&
name|retval
argument_list|,
name|UTF8PROC_NULLTERM
operator||
name|UTF8PROC_STABLE
operator||
name|UTF8PROC_DECOMPOSE
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_function
name|UTF8PROC_API
name|uint8_t
modifier|*
name|utf8proc_NFC
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|str
parameter_list|)
block|{
name|uint8_t
modifier|*
name|retval
decl_stmt|;
name|utf8proc_map
argument_list|(
name|str
argument_list|,
literal|0
argument_list|,
operator|&
name|retval
argument_list|,
name|UTF8PROC_NULLTERM
operator||
name|UTF8PROC_STABLE
operator||
name|UTF8PROC_COMPOSE
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_function
name|UTF8PROC_API
name|uint8_t
modifier|*
name|utf8proc_NFKD
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|str
parameter_list|)
block|{
name|uint8_t
modifier|*
name|retval
decl_stmt|;
name|utf8proc_map
argument_list|(
name|str
argument_list|,
literal|0
argument_list|,
operator|&
name|retval
argument_list|,
name|UTF8PROC_NULLTERM
operator||
name|UTF8PROC_STABLE
operator||
name|UTF8PROC_DECOMPOSE
operator||
name|UTF8PROC_COMPAT
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_function
name|UTF8PROC_API
name|uint8_t
modifier|*
name|utf8proc_NFKC
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|str
parameter_list|)
block|{
name|uint8_t
modifier|*
name|retval
decl_stmt|;
name|utf8proc_map
argument_list|(
name|str
argument_list|,
literal|0
argument_list|,
operator|&
name|retval
argument_list|,
name|UTF8PROC_NULLTERM
operator||
name|UTF8PROC_STABLE
operator||
name|UTF8PROC_COMPOSE
operator||
name|UTF8PROC_COMPAT
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

end_unit


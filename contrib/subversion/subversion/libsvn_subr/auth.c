begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * auth.c: authentication support functions for Subversion  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|<apr_pools.h>
end_include

begin_include
include|#
directive|include
file|<apr_tables.h>
end_include

begin_include
include|#
directive|include
file|<apr_strings.h>
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_types.h"
end_include

begin_include
include|#
directive|include
file|"svn_string.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_auth.h"
end_include

begin_include
include|#
directive|include
file|"svn_config.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"svn_dso.h"
end_include

begin_include
include|#
directive|include
file|"svn_version.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_dep_compat.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_subr_private.h"
end_include

begin_include
include|#
directive|include
file|"auth.h"
end_include

begin_comment
comment|/* AN OVERVIEW    ===========     A good way to think of this machinery is as a set of tables.       - Each type of credentials selects a single table.       - In a given table, each row is a 'provider' capable of returning        the same type of credentials.  Each column represents a        provider's repeated attempts to provide credentials.      Fetching Credentials from Providers    -----------------------------------     When the caller asks for a particular type of credentials, the    machinery in this file walks over the appropriate table.  It starts    with the first provider (first row), and calls first_credentials()    to get the first set of credentials (first column).  If the caller    is unhappy with the credentials, then each subsequent call to    next_credentials() traverses the row from left to right.  If the    provider returns error at any point, then we go to the next provider    (row).  We continue this way until every provider fails, or    until the client is happy with the returned credentials.     Note that the caller cannot see the table traversal, and thus has    no idea when we switch providers.      Storing Credentials with Providers    ----------------------------------     When the server has validated a set of credentials, and when    credential caching is enabled, we have the chance to store those    credentials for later use.  The provider which provided the working    credentials is the first one given the opportunity to (re)cache    those credentials.  Its save_credentials() function is invoked with    the working credentials.  If that provider reports that it    successfully stored the credentials, we're done.  Otherwise, we    walk the providers (rows) for that type of credentials in order    from the top of the table, allowing each in turn the opportunity to    store the credentials.  When one reports that it has done so    successfully -- or when we run out of providers (rows) to try --    the table walk ends. */
end_comment

begin_comment
comment|/* This effectively defines a single table.  Every provider in this    array returns the same kind of credentials. */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|provider_set_t
block|{
comment|/* ordered array of svn_auth_provider_object_t */
name|apr_array_header_t
modifier|*
name|providers
decl_stmt|;
block|}
name|provider_set_t
typedef|;
end_typedef

begin_comment
comment|/* The main auth baton. */
end_comment

begin_struct
struct|struct
name|svn_auth_baton_t
block|{
comment|/* a collection of tables.  maps cred_kind -> provider_set */
name|apr_hash_t
modifier|*
name|tables
decl_stmt|;
comment|/* the pool I'm allocated in. */
name|apr_pool_t
modifier|*
name|pool
decl_stmt|;
comment|/* run-time parameters needed by providers. */
name|apr_hash_t
modifier|*
name|parameters
decl_stmt|;
comment|/* run-time credentials cache. */
name|apr_hash_t
modifier|*
name|creds_cache
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Abstracted iteration baton */
end_comment

begin_struct
struct|struct
name|svn_auth_iterstate_t
block|{
name|provider_set_t
modifier|*
name|table
decl_stmt|;
comment|/* the table being searched */
name|int
name|provider_idx
decl_stmt|;
comment|/* the current provider (row) */
name|svn_boolean_t
name|got_first
decl_stmt|;
comment|/* did we get the provider's first creds? */
name|void
modifier|*
name|provider_iter_baton
decl_stmt|;
comment|/* the provider's own iteration context */
specifier|const
name|char
modifier|*
name|realmstring
decl_stmt|;
comment|/* The original realmstring passed in */
specifier|const
name|char
modifier|*
name|cache_key
decl_stmt|;
comment|/* key to use in auth_baton's creds_cache */
name|svn_auth_baton_t
modifier|*
name|auth_baton
decl_stmt|;
comment|/* the original auth_baton. */
block|}
struct|;
end_struct

begin_function
name|void
name|svn_auth_open
parameter_list|(
name|svn_auth_baton_t
modifier|*
modifier|*
name|auth_baton
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|providers
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_auth_baton_t
modifier|*
name|ab
decl_stmt|;
name|svn_auth_provider_object_t
modifier|*
name|provider
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Build the auth_baton. */
name|ab
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ab
argument_list|)
argument_list|)
expr_stmt|;
name|ab
operator|->
name|tables
operator|=
name|apr_hash_make
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|ab
operator|->
name|parameters
operator|=
name|apr_hash_make
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|ab
operator|->
name|creds_cache
operator|=
name|apr_hash_make
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|ab
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
comment|/* Register each provider in order.  Providers of different      credentials will be automatically sorted into different tables by      register_provider(). */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|providers
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|provider_set_t
modifier|*
name|table
decl_stmt|;
name|provider
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|providers
argument_list|,
name|i
argument_list|,
name|svn_auth_provider_object_t
operator|*
argument_list|)
expr_stmt|;
comment|/* Add it to the appropriate table in the auth_baton */
name|table
operator|=
name|svn_hash_gets
argument_list|(
name|ab
operator|->
name|tables
argument_list|,
name|provider
operator|->
name|vtable
operator|->
name|cred_kind
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|table
condition|)
block|{
name|table
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|table
argument_list|)
argument_list|)
expr_stmt|;
name|table
operator|->
name|providers
operator|=
name|apr_array_make
argument_list|(
name|pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_auth_provider_object_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|ab
operator|->
name|tables
argument_list|,
name|provider
operator|->
name|vtable
operator|->
name|cred_kind
argument_list|,
name|table
argument_list|)
expr_stmt|;
block|}
name|APR_ARRAY_PUSH
argument_list|(
name|table
operator|->
name|providers
argument_list|,
name|svn_auth_provider_object_t
operator|*
argument_list|)
operator|=
name|provider
expr_stmt|;
block|}
operator|*
name|auth_baton
operator|=
name|ab
expr_stmt|;
block|}
end_function

begin_function
name|void
name|svn_auth_set_parameter
parameter_list|(
name|svn_auth_baton_t
modifier|*
name|auth_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|void
modifier|*
name|value
parameter_list|)
block|{
name|svn_hash_sets
argument_list|(
name|auth_baton
operator|->
name|parameters
argument_list|,
name|name
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|const
name|void
modifier|*
name|svn_auth_get_parameter
parameter_list|(
name|svn_auth_baton_t
modifier|*
name|auth_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|svn_hash_gets
argument_list|(
name|auth_baton
operator|->
name|parameters
argument_list|,
name|name
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Return the key used to address the in-memory cache of auth    credentials of type CRED_KIND and associated with REALMSTRING. */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|make_cache_key
parameter_list|(
specifier|const
name|char
modifier|*
name|cred_kind
parameter_list|,
specifier|const
name|char
modifier|*
name|realmstring
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|apr_pstrcat
argument_list|(
name|pool
argument_list|,
name|cred_kind
argument_list|,
literal|":"
argument_list|,
name|realmstring
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_auth_first_credentials
parameter_list|(
name|void
modifier|*
modifier|*
name|credentials
parameter_list|,
name|svn_auth_iterstate_t
modifier|*
modifier|*
name|state
parameter_list|,
specifier|const
name|char
modifier|*
name|cred_kind
parameter_list|,
specifier|const
name|char
modifier|*
name|realmstring
parameter_list|,
name|svn_auth_baton_t
modifier|*
name|auth_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|provider_set_t
modifier|*
name|table
decl_stmt|;
name|svn_auth_provider_object_t
modifier|*
name|provider
init|=
name|NULL
decl_stmt|;
name|void
modifier|*
name|creds
init|=
name|NULL
decl_stmt|;
name|void
modifier|*
name|iter_baton
init|=
name|NULL
decl_stmt|;
name|svn_boolean_t
name|got_first
init|=
name|FALSE
decl_stmt|;
name|svn_auth_iterstate_t
modifier|*
name|iterstate
decl_stmt|;
specifier|const
name|char
modifier|*
name|cache_key
decl_stmt|;
comment|/* Get the appropriate table of providers for CRED_KIND. */
name|table
operator|=
name|svn_hash_gets
argument_list|(
name|auth_baton
operator|->
name|tables
argument_list|,
name|cred_kind
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|table
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_AUTHN_NO_PROVIDER
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"No provider registered for '%s' credentials"
argument_list|)
argument_list|,
name|cred_kind
argument_list|)
return|;
comment|/* First, see if we have cached creds in the auth_baton. */
name|cache_key
operator|=
name|make_cache_key
argument_list|(
name|cred_kind
argument_list|,
name|realmstring
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|creds
operator|=
name|svn_hash_gets
argument_list|(
name|auth_baton
operator|->
name|creds_cache
argument_list|,
name|cache_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|creds
condition|)
block|{
name|got_first
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
comment|/* If not, find a provider that can give "first" credentials. */
block|{
comment|/* Find a provider that can give "first" credentials. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|table
operator|->
name|providers
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|provider
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|table
operator|->
name|providers
argument_list|,
name|i
argument_list|,
name|svn_auth_provider_object_t
operator|*
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|provider
operator|->
name|vtable
operator|->
name|first_credentials
argument_list|(
operator|&
name|creds
argument_list|,
operator|&
name|iter_baton
argument_list|,
name|provider
operator|->
name|provider_baton
argument_list|,
name|auth_baton
operator|->
name|parameters
argument_list|,
name|realmstring
argument_list|,
name|auth_baton
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|creds
operator|!=
name|NULL
condition|)
block|{
name|got_first
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|creds
condition|)
operator|*
name|state
operator|=
name|NULL
expr_stmt|;
else|else
block|{
comment|/* Build an abstract iteration state. */
name|iterstate
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|iterstate
argument_list|)
argument_list|)
expr_stmt|;
name|iterstate
operator|->
name|table
operator|=
name|table
expr_stmt|;
name|iterstate
operator|->
name|provider_idx
operator|=
name|i
expr_stmt|;
name|iterstate
operator|->
name|got_first
operator|=
name|got_first
expr_stmt|;
name|iterstate
operator|->
name|provider_iter_baton
operator|=
name|iter_baton
expr_stmt|;
name|iterstate
operator|->
name|realmstring
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|realmstring
argument_list|)
expr_stmt|;
name|iterstate
operator|->
name|cache_key
operator|=
name|cache_key
expr_stmt|;
name|iterstate
operator|->
name|auth_baton
operator|=
name|auth_baton
expr_stmt|;
operator|*
name|state
operator|=
name|iterstate
expr_stmt|;
comment|/* Put the creds in the cache */
name|svn_hash_sets
argument_list|(
name|auth_baton
operator|->
name|creds_cache
argument_list|,
name|apr_pstrdup
argument_list|(
name|auth_baton
operator|->
name|pool
argument_list|,
name|cache_key
argument_list|)
argument_list|,
name|creds
argument_list|)
expr_stmt|;
block|}
operator|*
name|credentials
operator|=
name|creds
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_auth_next_credentials
parameter_list|(
name|void
modifier|*
modifier|*
name|credentials
parameter_list|,
name|svn_auth_iterstate_t
modifier|*
name|state
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_auth_baton_t
modifier|*
name|auth_baton
init|=
name|state
operator|->
name|auth_baton
decl_stmt|;
name|svn_auth_provider_object_t
modifier|*
name|provider
decl_stmt|;
name|provider_set_t
modifier|*
name|table
init|=
name|state
operator|->
name|table
decl_stmt|;
name|void
modifier|*
name|creds
init|=
name|NULL
decl_stmt|;
comment|/* Continue traversing the table from where we left off. */
for|for
control|(
comment|/* no init */
init|;
name|state
operator|->
name|provider_idx
operator|<
name|table
operator|->
name|providers
operator|->
name|nelts
condition|;
name|state
operator|->
name|provider_idx
operator|++
control|)
block|{
name|provider
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|table
operator|->
name|providers
argument_list|,
name|state
operator|->
name|provider_idx
argument_list|,
name|svn_auth_provider_object_t
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|state
operator|->
name|got_first
condition|)
block|{
name|SVN_ERR
argument_list|(
name|provider
operator|->
name|vtable
operator|->
name|first_credentials
argument_list|(
operator|&
name|creds
argument_list|,
operator|&
operator|(
name|state
operator|->
name|provider_iter_baton
operator|)
argument_list|,
name|provider
operator|->
name|provider_baton
argument_list|,
name|auth_baton
operator|->
name|parameters
argument_list|,
name|state
operator|->
name|realmstring
argument_list|,
name|auth_baton
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|state
operator|->
name|got_first
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|provider
operator|->
name|vtable
operator|->
name|next_credentials
condition|)
block|{
name|SVN_ERR
argument_list|(
name|provider
operator|->
name|vtable
operator|->
name|next_credentials
argument_list|(
operator|&
name|creds
argument_list|,
name|state
operator|->
name|provider_iter_baton
argument_list|,
name|provider
operator|->
name|provider_baton
argument_list|,
name|auth_baton
operator|->
name|parameters
argument_list|,
name|state
operator|->
name|realmstring
argument_list|,
name|auth_baton
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|creds
operator|!=
name|NULL
condition|)
block|{
comment|/* Put the creds in the cache */
name|svn_hash_sets
argument_list|(
name|auth_baton
operator|->
name|creds_cache
argument_list|,
name|state
operator|->
name|cache_key
argument_list|,
name|creds
argument_list|)
expr_stmt|;
break|break;
block|}
name|state
operator|->
name|got_first
operator|=
name|FALSE
expr_stmt|;
block|}
operator|*
name|credentials
operator|=
name|creds
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_auth_save_credentials
parameter_list|(
name|svn_auth_iterstate_t
modifier|*
name|state
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|svn_auth_provider_object_t
modifier|*
name|provider
decl_stmt|;
name|svn_boolean_t
name|save_succeeded
init|=
name|FALSE
decl_stmt|;
specifier|const
name|char
modifier|*
name|no_auth_cache
decl_stmt|;
name|svn_auth_baton_t
modifier|*
name|auth_baton
decl_stmt|;
name|void
modifier|*
name|creds
decl_stmt|;
if|if
condition|(
operator|!
name|state
operator|||
name|state
operator|->
name|table
operator|->
name|providers
operator|->
name|nelts
operator|<=
name|state
operator|->
name|provider_idx
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|auth_baton
operator|=
name|state
operator|->
name|auth_baton
expr_stmt|;
name|creds
operator|=
name|svn_hash_gets
argument_list|(
name|state
operator|->
name|auth_baton
operator|->
name|creds_cache
argument_list|,
name|state
operator|->
name|cache_key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|creds
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Do not save the creds if SVN_AUTH_PARAM_NO_AUTH_CACHE is set */
name|no_auth_cache
operator|=
name|svn_hash_gets
argument_list|(
name|auth_baton
operator|->
name|parameters
argument_list|,
name|SVN_AUTH_PARAM_NO_AUTH_CACHE
argument_list|)
expr_stmt|;
if|if
condition|(
name|no_auth_cache
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* First, try to save the creds using the provider that produced them. */
name|provider
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|state
operator|->
name|table
operator|->
name|providers
argument_list|,
name|state
operator|->
name|provider_idx
argument_list|,
name|svn_auth_provider_object_t
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|provider
operator|->
name|vtable
operator|->
name|save_credentials
condition|)
name|SVN_ERR
argument_list|(
name|provider
operator|->
name|vtable
operator|->
name|save_credentials
argument_list|(
operator|&
name|save_succeeded
argument_list|,
name|creds
argument_list|,
name|provider
operator|->
name|provider_baton
argument_list|,
name|auth_baton
operator|->
name|parameters
argument_list|,
name|state
operator|->
name|realmstring
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|save_succeeded
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Otherwise, loop from the top of the list, asking every provider      to attempt a save.  ### todo: someday optimize so we don't      necessarily start from the top of the list. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|state
operator|->
name|table
operator|->
name|providers
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|provider
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|state
operator|->
name|table
operator|->
name|providers
argument_list|,
name|i
argument_list|,
name|svn_auth_provider_object_t
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|provider
operator|->
name|vtable
operator|->
name|save_credentials
condition|)
name|SVN_ERR
argument_list|(
name|provider
operator|->
name|vtable
operator|->
name|save_credentials
argument_list|(
operator|&
name|save_succeeded
argument_list|,
name|creds
argument_list|,
name|provider
operator|->
name|provider_baton
argument_list|,
name|auth_baton
operator|->
name|parameters
argument_list|,
name|state
operator|->
name|realmstring
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|save_succeeded
condition|)
break|break;
block|}
comment|/* ### notice that at the moment, if no provider can save, there's      no way the caller will know. */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_auth_forget_credentials
parameter_list|(
name|svn_auth_baton_t
modifier|*
name|auth_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|cred_kind
parameter_list|,
specifier|const
name|char
modifier|*
name|realmstring
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|SVN_ERR_ASSERT
argument_list|(
operator|(
name|cred_kind
operator|&&
name|realmstring
operator|)
operator|||
operator|(
operator|!
name|cred_kind
operator|&&
operator|!
name|realmstring
operator|)
argument_list|)
expr_stmt|;
comment|/* If we have a CRED_KIND and REALMSTRING, we clear out just the      cached item (if any).  Otherwise, empty the whole hash. */
if|if
condition|(
name|cred_kind
condition|)
block|{
name|svn_hash_sets
argument_list|(
name|auth_baton
operator|->
name|creds_cache
argument_list|,
name|make_cache_key
argument_list|(
name|cred_kind
argument_list|,
name|realmstring
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|apr_hash_clear
argument_list|(
name|auth_baton
operator|->
name|creds_cache
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_auth_ssl_server_cert_info_t
modifier|*
name|svn_auth_ssl_server_cert_info_dup
parameter_list|(
specifier|const
name|svn_auth_ssl_server_cert_info_t
modifier|*
name|info
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_auth_ssl_server_cert_info_t
modifier|*
name|new_info
init|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|new_info
argument_list|)
argument_list|)
decl_stmt|;
operator|*
name|new_info
operator|=
operator|*
name|info
expr_stmt|;
name|new_info
operator|->
name|hostname
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|new_info
operator|->
name|hostname
argument_list|)
expr_stmt|;
name|new_info
operator|->
name|fingerprint
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|new_info
operator|->
name|fingerprint
argument_list|)
expr_stmt|;
name|new_info
operator|->
name|valid_from
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|new_info
operator|->
name|valid_from
argument_list|)
expr_stmt|;
name|new_info
operator|->
name|valid_until
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|new_info
operator|->
name|valid_until
argument_list|)
expr_stmt|;
name|new_info
operator|->
name|issuer_dname
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|new_info
operator|->
name|issuer_dname
argument_list|)
expr_stmt|;
name|new_info
operator|->
name|ascii_cert
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|new_info
operator|->
name|ascii_cert
argument_list|)
expr_stmt|;
return|return
name|new_info
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_auth_get_platform_specific_provider
parameter_list|(
name|svn_auth_provider_object_t
modifier|*
modifier|*
name|provider
parameter_list|,
specifier|const
name|char
modifier|*
name|provider_name
parameter_list|,
specifier|const
name|char
modifier|*
name|provider_type
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
operator|*
name|provider
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|apr_strnatcmp
argument_list|(
name|provider_name
argument_list|,
literal|"gnome_keyring"
argument_list|)
operator|==
literal|0
operator|||
name|apr_strnatcmp
argument_list|(
name|provider_name
argument_list|,
literal|"kwallet"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|SVN_HAVE_GNOME_KEYRING
argument_list|)
operator|||
name|defined
argument_list|(
name|SVN_HAVE_KWALLET
argument_list|)
name|apr_dso_handle_t
modifier|*
name|dso
decl_stmt|;
name|apr_dso_handle_sym_t
name|provider_function_symbol
decl_stmt|,
name|version_function_symbol
decl_stmt|;
specifier|const
name|char
modifier|*
name|library_label
decl_stmt|,
modifier|*
name|library_name
decl_stmt|;
specifier|const
name|char
modifier|*
name|provider_function_name
decl_stmt|,
modifier|*
name|version_function_name
decl_stmt|;
name|library_name
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"libsvn_auth_%s-%d.so.%d"
argument_list|,
name|provider_name
argument_list|,
name|SVN_VER_MAJOR
argument_list|,
name|SVN_SOVERSION
argument_list|)
expr_stmt|;
name|library_label
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"svn_%s"
argument_list|,
name|provider_name
argument_list|)
expr_stmt|;
name|provider_function_name
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"svn_auth_get_%s_%s_provider"
argument_list|,
name|provider_name
argument_list|,
name|provider_type
argument_list|)
expr_stmt|;
name|version_function_name
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"svn_auth_%s_version"
argument_list|,
name|provider_name
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_dso_load
argument_list|(
operator|&
name|dso
argument_list|,
name|library_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dso
condition|)
block|{
if|if
condition|(
name|apr_dso_sym
argument_list|(
operator|&
name|version_function_symbol
argument_list|,
name|dso
argument_list|,
name|version_function_name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|svn_version_func_t
name|version_function
init|=
name|version_function_symbol
decl_stmt|;
name|svn_version_checklist_t
name|check_list
index|[
literal|2
index|]
decl_stmt|;
name|check_list
index|[
literal|0
index|]
operator|.
name|label
operator|=
name|library_label
expr_stmt|;
name|check_list
index|[
literal|0
index|]
operator|.
name|version_query
operator|=
name|version_function
expr_stmt|;
name|check_list
index|[
literal|1
index|]
operator|.
name|label
operator|=
name|NULL
expr_stmt|;
name|check_list
index|[
literal|1
index|]
operator|.
name|version_query
operator|=
name|NULL
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ver_check_list2
argument_list|(
name|svn_subr_version
argument_list|()
argument_list|,
name|check_list
argument_list|,
name|svn_ver_equal
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|apr_dso_sym
argument_list|(
operator|&
name|provider_function_symbol
argument_list|,
name|dso
argument_list|,
name|provider_function_name
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|provider_type
argument_list|,
literal|"simple"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|svn_auth_simple_provider_func_t
name|provider_function
init|=
name|provider_function_symbol
decl_stmt|;
name|provider_function
argument_list|(
name|provider
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|provider_type
argument_list|,
literal|"ssl_client_cert_pw"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|svn_auth_ssl_client_cert_pw_provider_func_t
name|provider_function
init|=
name|provider_function_symbol
decl_stmt|;
name|provider_function
argument_list|(
name|provider
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
block|}
else|else
block|{
if|#
directive|if
name|defined
argument_list|(
name|SVN_HAVE_GPG_AGENT
argument_list|)
if|if
condition|(
name|strcmp
argument_list|(
name|provider_name
argument_list|,
literal|"gpg_agent"
argument_list|)
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|provider_type
argument_list|,
literal|"simple"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|svn_auth_get_gpg_agent_simple_provider
argument_list|(
name|provider
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SVN_HAVE_KEYCHAIN_SERVICES
if|if
condition|(
name|strcmp
argument_list|(
name|provider_name
argument_list|,
literal|"keychain"
argument_list|)
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|provider_type
argument_list|,
literal|"simple"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|svn_auth_get_keychain_simple_provider
argument_list|(
name|provider
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|provider_name
argument_list|,
literal|"keychain"
argument_list|)
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|provider_type
argument_list|,
literal|"ssl_client_cert_pw"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|svn_auth_get_keychain_ssl_client_cert_pw_provider
argument_list|(
name|provider
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|WIN32
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__MINGW32__
argument_list|)
if|if
condition|(
name|strcmp
argument_list|(
name|provider_name
argument_list|,
literal|"windows"
argument_list|)
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|provider_type
argument_list|,
literal|"simple"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|svn_auth_get_windows_simple_provider
argument_list|(
name|provider
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|provider_name
argument_list|,
literal|"windows"
argument_list|)
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|provider_type
argument_list|,
literal|"ssl_client_cert_pw"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|svn_auth_get_windows_ssl_client_cert_pw_provider
argument_list|(
name|provider
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|provider_name
argument_list|,
literal|"windows"
argument_list|)
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|provider_type
argument_list|,
literal|"ssl_server_trust"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|svn_auth_get_windows_ssl_server_trust_provider
argument_list|(
name|provider
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_auth_get_platform_specific_client_providers
parameter_list|(
name|apr_array_header_t
modifier|*
modifier|*
name|providers
parameter_list|,
name|svn_config_t
modifier|*
name|config
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_auth_provider_object_t
modifier|*
name|provider
decl_stmt|;
specifier|const
name|char
modifier|*
name|password_stores_config_option
decl_stmt|;
name|apr_array_header_t
modifier|*
name|password_stores
decl_stmt|;
name|int
name|i
decl_stmt|;
define|#
directive|define
name|SVN__MAYBE_ADD_PROVIDER
parameter_list|(
name|list
parameter_list|,
name|p
parameter_list|)
define|\
value|{ if (p) APR_ARRAY_PUSH(list, svn_auth_provider_object_t *) = p; }
define|#
directive|define
name|SVN__DEFAULT_AUTH_PROVIDER_LIST
define|\
value|"gnome-keyring,kwallet,keychain,gpg-agent,windows-cryptoapi"
operator|*
name|providers
operator|=
name|apr_array_make
argument_list|(
name|pool
argument_list|,
literal|12
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_auth_provider_object_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Fetch the configured list of password stores, and split them into      an array. */
name|svn_config_get
argument_list|(
name|config
argument_list|,
operator|&
name|password_stores_config_option
argument_list|,
name|SVN_CONFIG_SECTION_AUTH
argument_list|,
name|SVN_CONFIG_OPTION_PASSWORD_STORES
argument_list|,
name|SVN__DEFAULT_AUTH_PROVIDER_LIST
argument_list|)
expr_stmt|;
name|password_stores
operator|=
name|svn_cstring_split
argument_list|(
name|password_stores_config_option
argument_list|,
literal|" ,"
argument_list|,
name|TRUE
argument_list|,
name|pool
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|password_stores
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|password_store
init|=
name|APR_ARRAY_IDX
argument_list|(
name|password_stores
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
comment|/* GNOME Keyring */
if|if
condition|(
name|apr_strnatcmp
argument_list|(
name|password_store
argument_list|,
literal|"gnome-keyring"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_auth_get_platform_specific_provider
argument_list|(
operator|&
name|provider
argument_list|,
literal|"gnome_keyring"
argument_list|,
literal|"simple"
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN__MAYBE_ADD_PROVIDER
argument_list|(
operator|*
name|providers
argument_list|,
name|provider
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_auth_get_platform_specific_provider
argument_list|(
operator|&
name|provider
argument_list|,
literal|"gnome_keyring"
argument_list|,
literal|"ssl_client_cert_pw"
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN__MAYBE_ADD_PROVIDER
argument_list|(
operator|*
name|providers
argument_list|,
name|provider
argument_list|)
expr_stmt|;
block|}
comment|/* GPG-AGENT */
elseif|else
if|if
condition|(
name|apr_strnatcmp
argument_list|(
name|password_store
argument_list|,
literal|"gpg-agent"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_auth_get_platform_specific_provider
argument_list|(
operator|&
name|provider
argument_list|,
literal|"gpg_agent"
argument_list|,
literal|"simple"
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN__MAYBE_ADD_PROVIDER
argument_list|(
operator|*
name|providers
argument_list|,
name|provider
argument_list|)
expr_stmt|;
block|}
comment|/* KWallet */
elseif|else
if|if
condition|(
name|apr_strnatcmp
argument_list|(
name|password_store
argument_list|,
literal|"kwallet"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_auth_get_platform_specific_provider
argument_list|(
operator|&
name|provider
argument_list|,
literal|"kwallet"
argument_list|,
literal|"simple"
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN__MAYBE_ADD_PROVIDER
argument_list|(
operator|*
name|providers
argument_list|,
name|provider
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_auth_get_platform_specific_provider
argument_list|(
operator|&
name|provider
argument_list|,
literal|"kwallet"
argument_list|,
literal|"ssl_client_cert_pw"
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN__MAYBE_ADD_PROVIDER
argument_list|(
operator|*
name|providers
argument_list|,
name|provider
argument_list|)
expr_stmt|;
block|}
comment|/* Keychain */
elseif|else
if|if
condition|(
name|apr_strnatcmp
argument_list|(
name|password_store
argument_list|,
literal|"keychain"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_auth_get_platform_specific_provider
argument_list|(
operator|&
name|provider
argument_list|,
literal|"keychain"
argument_list|,
literal|"simple"
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN__MAYBE_ADD_PROVIDER
argument_list|(
operator|*
name|providers
argument_list|,
name|provider
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_auth_get_platform_specific_provider
argument_list|(
operator|&
name|provider
argument_list|,
literal|"keychain"
argument_list|,
literal|"ssl_client_cert_pw"
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN__MAYBE_ADD_PROVIDER
argument_list|(
operator|*
name|providers
argument_list|,
name|provider
argument_list|)
expr_stmt|;
block|}
comment|/* Windows */
elseif|else
if|if
condition|(
name|apr_strnatcmp
argument_list|(
name|password_store
argument_list|,
literal|"windows-cryptoapi"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_auth_get_platform_specific_provider
argument_list|(
operator|&
name|provider
argument_list|,
literal|"windows"
argument_list|,
literal|"simple"
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN__MAYBE_ADD_PROVIDER
argument_list|(
operator|*
name|providers
argument_list|,
name|provider
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_auth_get_platform_specific_provider
argument_list|(
operator|&
name|provider
argument_list|,
literal|"windows"
argument_list|,
literal|"ssl_client_cert_pw"
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN__MAYBE_ADD_PROVIDER
argument_list|(
operator|*
name|providers
argument_list|,
name|provider
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


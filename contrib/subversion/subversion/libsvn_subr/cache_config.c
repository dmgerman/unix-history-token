begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* svn_cache_config.c : configuration of internal caches  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|<apr_atomic.h>
end_include

begin_include
include|#
directive|include
file|"svn_cache_config.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_cache.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_comment
comment|/* The cache settings as a process-wide singleton.  */
end_comment

begin_decl_stmt
specifier|static
name|svn_cache_config_t
name|cache_settings
init|=
block|{
comment|/* default configuration:      *      * Please note that the resources listed below will be allocated      * PER PROCESS. Thus, the defaults chosen here are kept deliberately      * low to still make a difference yet to ensure that pre-fork servers      * on machines with small amounts of RAM aren't severely impacted.      */
literal|0x1000000
block|,
comment|/* 16 MB for caches.                   * If you are running a single server process,                   * you may easily increase that to 50+% of your RAM                   * using svn_fs_set_cache_config().                   */
literal|16
block|,
comment|/* up to 16 files kept open.                   * Most OS restrict the number of open file handles to                   * about 1000. To minimize I/O and OS overhead, values                   * of 500+ can be beneficial (use svn_fs_set_cache_config()                   * to change the configuration).                   * When running with a huge in-process cache, this number                   * has little impact on performance and a more modest                   * value (< 100) may be more suitable.                   */
if|#
directive|if
name|APR_HAS_THREADS
name|FALSE
comment|/* assume multi-threaded operation.                   * Because this simply activates proper synchronization                   * between threads, it is a safe default.                   */
else|#
directive|else
name|TRUE
comment|/* single-threaded is the only supported mode of operation */
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Get the current FSFS cache configuration. */
end_comment

begin_function
specifier|const
name|svn_cache_config_t
modifier|*
name|svn_cache_config_get
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|&
name|cache_settings
return|;
block|}
end_function

begin_comment
comment|/* Access the process-global (singleton) membuffer cache. The first call  * will automatically allocate the cache using the current cache config.  * NULL will be returned if the desired cache size is 0 or if the cache  * could not be created for some reason.  */
end_comment

begin_function
name|svn_membuffer_t
modifier|*
name|svn_cache__get_global_membuffer_cache
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|svn_membuffer_t
modifier|*
specifier|volatile
name|cache
init|=
name|NULL
decl_stmt|;
name|apr_uint64_t
name|cache_size
init|=
name|cache_settings
operator|.
name|cache_size
decl_stmt|;
if|if
condition|(
operator|!
name|cache
operator|&&
name|cache_size
condition|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_membuffer_t
modifier|*
name|old_cache
init|=
name|NULL
decl_stmt|;
name|svn_membuffer_t
modifier|*
name|new_cache
init|=
name|NULL
decl_stmt|;
comment|/* auto-allocate cache */
name|apr_allocator_t
modifier|*
name|allocator
init|=
name|NULL
decl_stmt|;
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|apr_allocator_create
argument_list|(
operator|&
name|allocator
argument_list|)
condition|)
return|return
name|NULL
return|;
comment|/* Ensure that we free partially allocated data if we run OOM        * before the cache is complete: If the cache cannot be allocated        * in its full size, the create() function will clear the pool        * explicitly. The allocator will make sure that any memory no        * longer used by the pool will actually be returned to the OS.        *        * Please note that this pool and allocator is used *only* to        * allocate the large membuffer. All later dynamic allocations        * come from other, temporary pools and allocators.        */
name|apr_allocator_max_free_set
argument_list|(
name|allocator
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* don't terminate upon OOM but make pool return a NULL pointer        * instead so we can disable caching gracefully and continue        * operation without membuffer caches.        */
name|apr_pool_create_ex
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|allocator
argument_list|)
expr_stmt|;
if|if
condition|(
name|pool
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|apr_allocator_owner_set
argument_list|(
name|allocator
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_cache__membuffer_cache_create
argument_list|(
operator|&
name|new_cache
argument_list|,
operator|(
name|apr_size_t
operator|)
name|cache_size
argument_list|,
call|(
name|apr_size_t
call|)
argument_list|(
name|cache_size
operator|/
literal|10
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|!
name|svn_cache_config_get
argument_list|()
operator|->
name|single_threaded
argument_list|,
name|FALSE
argument_list|,
name|pool
argument_list|)
expr_stmt|;
comment|/* Some error occurred. Most likely it's an OOM error but we don't        * really care. Simply release all cache memory and disable caching        */
if|if
condition|(
name|err
condition|)
block|{
comment|/* Memory and error cleanup */
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
comment|/* Prevent future attempts to create the cache. However, an            * existing cache instance (see next comment) remains valid.            */
name|cache_settings
operator|.
name|cache_size
operator|=
literal|0
expr_stmt|;
comment|/* The current caller won't get the cache object.            * However, a concurrent call might have succeeded in creating            * the cache object. That call and all following ones will then            * use the successfully created cache instance.            */
return|return
name|NULL
return|;
block|}
comment|/* Handle race condition: if we are the first to create a        * cache object, make it our global singleton. Otherwise,        * discard the new cache and keep the existing one.        *        * Cast is necessary because of APR bug:        * https://issues.apache.org/bugzilla/show_bug.cgi?id=50731        */
name|old_cache
operator|=
name|apr_atomic_casptr
argument_list|(
operator|(
specifier|volatile
name|void
operator|*
operator|*
operator|)
operator|&
name|cache
argument_list|,
name|new_cache
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_cache
operator|!=
name|NULL
condition|)
name|svn_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
return|return
name|cache
return|;
block|}
end_function

begin_function
name|void
name|svn_cache_config_set
parameter_list|(
specifier|const
name|svn_cache_config_t
modifier|*
name|settings
parameter_list|)
block|{
name|cache_settings
operator|=
operator|*
name|settings
expr_stmt|;
block|}
end_function

end_unit


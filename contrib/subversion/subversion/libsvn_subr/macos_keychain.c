begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * macos_keychain.c: Mac OS keychain providers for SVN_AUTH_*  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_comment
comment|/* ==================================================================== */
end_comment

begin_comment
comment|/*** Includes. ***/
end_comment

begin_include
include|#
directive|include
file|<apr_pools.h>
end_include

begin_include
include|#
directive|include
file|"svn_auth.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_utf.h"
end_include

begin_include
include|#
directive|include
file|"svn_config.h"
end_include

begin_include
include|#
directive|include
file|"svn_user.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_auth_private.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SVN_HAVE_KEYCHAIN_SERVICES
end_ifdef

begin_include
include|#
directive|include
file|<Security/Security.h>
end_include

begin_escape
end_escape

begin_comment
comment|/*-----------------------------------------------------------------------*/
end_comment

begin_comment
comment|/* keychain simple provider, puts passwords in the KeyChain              */
end_comment

begin_comment
comment|/*-----------------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  * XXX (2005-12-07): If no GUI is available (e.g. over a SSH session),  * you won't be prompted for credentials with which to unlock your  * keychain.  Apple recognizes lack of TTY prompting as a known  * problem.  *  *  * XXX (2005-12-07): SecKeychainSetUserInteractionAllowed(FALSE) does  * not appear to actually prevent all user interaction.  Specifically,  * if the executable changes (for example, if it is rebuilt), the  * system prompts the user to okay the use of the new executable.  *  * Worse than that, the interactivity setting is global per app (not  * process/thread), meaning that there is a race condition in the  * implementation below between calls to  * SecKeychainSetUserInteractionAllowed() when multiple instances of  * the same Subversion auth provider-based app run concurrently.  */
end_comment

begin_comment
comment|/* Implementation of svn_auth__password_set_t that stores    the password in the OS X KeyChain. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|keychain_password_set
parameter_list|(
name|svn_boolean_t
modifier|*
name|done
parameter_list|,
name|apr_hash_t
modifier|*
name|creds
parameter_list|,
specifier|const
name|char
modifier|*
name|realmstring
parameter_list|,
specifier|const
name|char
modifier|*
name|username
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|,
name|apr_hash_t
modifier|*
name|parameters
parameter_list|,
name|svn_boolean_t
name|non_interactive
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|OSStatus
name|status
decl_stmt|;
name|SecKeychainItemRef
name|item
decl_stmt|;
if|if
condition|(
name|non_interactive
condition|)
name|SecKeychainSetUserInteractionAllowed
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
name|status
operator|=
name|SecKeychainFindGenericPassword
argument_list|(
name|NULL
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|realmstring
argument_list|)
argument_list|,
name|realmstring
argument_list|,
name|username
operator|==
name|NULL
condition|?
literal|0
else|:
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|username
argument_list|)
argument_list|,
name|username
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|item
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
block|{
if|if
condition|(
name|status
operator|==
name|errSecItemNotFound
condition|)
name|status
operator|=
name|SecKeychainAddGenericPassword
argument_list|(
name|NULL
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|realmstring
argument_list|)
argument_list|,
name|realmstring
argument_list|,
name|username
operator|==
name|NULL
condition|?
literal|0
else|:
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|username
argument_list|)
argument_list|,
name|username
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|password
argument_list|)
argument_list|,
name|password
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|SecKeychainItemModifyAttributesAndData
argument_list|(
name|item
argument_list|,
name|NULL
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|password
argument_list|)
argument_list|,
name|password
argument_list|)
expr_stmt|;
name|CFRelease
argument_list|(
name|item
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|non_interactive
condition|)
name|SecKeychainSetUserInteractionAllowed
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
operator|*
name|done
operator|=
operator|(
name|status
operator|==
literal|0
operator|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Implementation of svn_auth__password_get_t that retrieves    the password from the OS X KeyChain. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|keychain_password_get
parameter_list|(
name|svn_boolean_t
modifier|*
name|done
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|password
parameter_list|,
name|apr_hash_t
modifier|*
name|creds
parameter_list|,
specifier|const
name|char
modifier|*
name|realmstring
parameter_list|,
specifier|const
name|char
modifier|*
name|username
parameter_list|,
name|apr_hash_t
modifier|*
name|parameters
parameter_list|,
name|svn_boolean_t
name|non_interactive
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|OSStatus
name|status
decl_stmt|;
name|UInt32
name|length
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
operator|*
name|done
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|non_interactive
condition|)
name|SecKeychainSetUserInteractionAllowed
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
name|status
operator|=
name|SecKeychainFindGenericPassword
argument_list|(
name|NULL
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|realmstring
argument_list|)
argument_list|,
name|realmstring
argument_list|,
name|username
operator|==
name|NULL
condition|?
literal|0
else|:
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|username
argument_list|)
argument_list|,
name|username
argument_list|,
operator|&
name|length
argument_list|,
operator|&
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|non_interactive
condition|)
name|SecKeychainSetUserInteractionAllowed
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
name|SVN_NO_ERROR
return|;
operator|*
name|password
operator|=
name|apr_pstrmemdup
argument_list|(
name|pool
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|SecKeychainItemFreeContent
argument_list|(
name|NULL
argument_list|,
name|data
argument_list|)
expr_stmt|;
operator|*
name|done
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Get cached encrypted credentials from the simple provider's cache. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|keychain_simple_first_creds
parameter_list|(
name|void
modifier|*
modifier|*
name|credentials
parameter_list|,
name|void
modifier|*
modifier|*
name|iter_baton
parameter_list|,
name|void
modifier|*
name|provider_baton
parameter_list|,
name|apr_hash_t
modifier|*
name|parameters
parameter_list|,
specifier|const
name|char
modifier|*
name|realmstring
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_auth__simple_creds_cache_get
argument_list|(
name|credentials
argument_list|,
name|iter_baton
argument_list|,
name|provider_baton
argument_list|,
name|parameters
argument_list|,
name|realmstring
argument_list|,
name|keychain_password_get
argument_list|,
name|SVN_AUTH__KEYCHAIN_PASSWORD_TYPE
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Save encrypted credentials to the simple provider's cache. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|keychain_simple_save_creds
parameter_list|(
name|svn_boolean_t
modifier|*
name|saved
parameter_list|,
name|void
modifier|*
name|credentials
parameter_list|,
name|void
modifier|*
name|provider_baton
parameter_list|,
name|apr_hash_t
modifier|*
name|parameters
parameter_list|,
specifier|const
name|char
modifier|*
name|realmstring
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_auth__simple_creds_cache_set
argument_list|(
name|saved
argument_list|,
name|credentials
argument_list|,
name|provider_baton
argument_list|,
name|parameters
argument_list|,
name|realmstring
argument_list|,
name|keychain_password_set
argument_list|,
name|SVN_AUTH__KEYCHAIN_PASSWORD_TYPE
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|svn_auth_provider_t
name|keychain_simple_provider
init|=
block|{
name|SVN_AUTH_CRED_SIMPLE
block|,
name|keychain_simple_first_creds
block|,
name|NULL
block|,
name|keychain_simple_save_creds
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Get cached encrypted credentials from the ssl client cert password    provider's cache. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|keychain_ssl_client_cert_pw_first_creds
parameter_list|(
name|void
modifier|*
modifier|*
name|credentials
parameter_list|,
name|void
modifier|*
modifier|*
name|iter_baton
parameter_list|,
name|void
modifier|*
name|provider_baton
parameter_list|,
name|apr_hash_t
modifier|*
name|parameters
parameter_list|,
specifier|const
name|char
modifier|*
name|realmstring
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_auth__ssl_client_cert_pw_cache_get
argument_list|(
name|credentials
argument_list|,
name|iter_baton
argument_list|,
name|provider_baton
argument_list|,
name|parameters
argument_list|,
name|realmstring
argument_list|,
name|keychain_password_get
argument_list|,
name|SVN_AUTH__KEYCHAIN_PASSWORD_TYPE
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Save encrypted credentials to the ssl client cert password provider's    cache. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|keychain_ssl_client_cert_pw_save_creds
parameter_list|(
name|svn_boolean_t
modifier|*
name|saved
parameter_list|,
name|void
modifier|*
name|credentials
parameter_list|,
name|void
modifier|*
name|provider_baton
parameter_list|,
name|apr_hash_t
modifier|*
name|parameters
parameter_list|,
specifier|const
name|char
modifier|*
name|realmstring
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_auth__ssl_client_cert_pw_cache_set
argument_list|(
name|saved
argument_list|,
name|credentials
argument_list|,
name|provider_baton
argument_list|,
name|parameters
argument_list|,
name|realmstring
argument_list|,
name|keychain_password_set
argument_list|,
name|SVN_AUTH__KEYCHAIN_PASSWORD_TYPE
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|svn_auth_provider_t
name|keychain_ssl_client_cert_pw_provider
init|=
block|{
name|SVN_AUTH_CRED_SSL_CLIENT_CERT_PW
block|,
name|keychain_ssl_client_cert_pw_first_creds
block|,
name|NULL
block|,
name|keychain_ssl_client_cert_pw_save_creds
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Public API */
end_comment

begin_function
name|void
name|svn_auth_get_keychain_simple_provider
parameter_list|(
name|svn_auth_provider_object_t
modifier|*
modifier|*
name|provider
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_auth_provider_object_t
modifier|*
name|po
init|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|po
argument_list|)
argument_list|)
decl_stmt|;
name|po
operator|->
name|vtable
operator|=
operator|&
name|keychain_simple_provider
expr_stmt|;
operator|*
name|provider
operator|=
name|po
expr_stmt|;
block|}
end_function

begin_function
name|void
name|svn_auth_get_keychain_ssl_client_cert_pw_provider
parameter_list|(
name|svn_auth_provider_object_t
modifier|*
modifier|*
name|provider
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_auth_provider_object_t
modifier|*
name|po
init|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|po
argument_list|)
argument_list|)
decl_stmt|;
name|po
operator|->
name|vtable
operator|=
operator|&
name|keychain_ssl_client_cert_pw_provider
expr_stmt|;
operator|*
name|provider
operator|=
name|po
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SVN_HAVE_KEYCHAIN_SERVICES */
end_comment

end_unit


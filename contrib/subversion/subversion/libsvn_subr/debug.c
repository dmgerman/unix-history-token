begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * debug.c :  small functions to help SVN developers  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_comment
comment|/* These functions are only available to SVN developers and should never    be used in release code. One of the reasons to avoid this code in release    builds is that this code is not thread-safe. */
end_comment

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<apr_pools.h>
end_include

begin_include
include|#
directive|include
file|<apr_strings.h>
end_include

begin_include
include|#
directive|include
file|"svn_types.h"
end_include

begin_include
include|#
directive|include
file|"svn_string.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|SVN_DBG__PROTOTYPES
end_ifndef

begin_define
define|#
directive|define
name|SVN_DBG__PROTOTYPES
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"private/svn_debug.h"
end_include

begin_define
define|#
directive|define
name|DBG_FLAG
value|"DBG: "
end_define

begin_comment
comment|/* This will be tweaked by the preamble code.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|debug_file
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
name|debug_line
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|FILE
modifier|*
specifier|volatile
name|debug_output
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|svn_boolean_t
name|quiet_mode
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|getenv
argument_list|(
literal|"SVN_DBG_QUIET"
argument_list|)
operator|!=
name|NULL
return|;
block|}
end_function

begin_function
name|void
name|svn_dbg__preamble
parameter_list|(
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|long
name|line
parameter_list|,
name|FILE
modifier|*
name|output
parameter_list|)
block|{
name|debug_output
operator|=
name|output
expr_stmt|;
if|if
condition|(
name|output
operator|!=
name|NULL
operator|&&
operator|!
name|quiet_mode
argument_list|()
condition|)
block|{
comment|/* Quick and dirty basename() code.  */
specifier|const
name|char
modifier|*
name|slash
init|=
name|strrchr
argument_list|(
name|file
argument_list|,
literal|'/'
argument_list|)
decl_stmt|;
if|if
condition|(
name|slash
operator|==
name|NULL
condition|)
name|slash
operator|=
name|strrchr
argument_list|(
name|file
argument_list|,
literal|'\\'
argument_list|)
expr_stmt|;
if|if
condition|(
name|slash
condition|)
name|debug_file
operator|=
name|slash
operator|+
literal|1
expr_stmt|;
else|else
name|debug_file
operator|=
name|file
expr_stmt|;
block|}
name|debug_line
operator|=
name|line
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Print a formatted string using format FMT and argument-list AP,  * prefixing each line of output with a debug header. */
end_comment

begin_function
specifier|static
name|void
name|debug_vprintf
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|FILE
modifier|*
name|output
init|=
name|debug_output
decl_stmt|;
name|char
name|prefix
index|[
literal|80
index|]
decl_stmt|,
name|buffer
index|[
literal|1000
index|]
decl_stmt|;
name|char
modifier|*
name|s
init|=
name|buffer
decl_stmt|;
name|int
name|n
decl_stmt|;
if|if
condition|(
name|output
operator|==
name|NULL
operator|||
name|quiet_mode
argument_list|()
condition|)
return|return;
name|n
operator|=
name|apr_snprintf
argument_list|(
name|prefix
argument_list|,
sizeof|sizeof
argument_list|(
name|prefix
argument_list|)
argument_list|,
name|DBG_FLAG
literal|"%s:%4ld: "
argument_list|,
name|debug_file
argument_list|,
name|debug_line
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|n
operator|<
sizeof|sizeof
argument_list|(
name|prefix
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|n
operator|=
name|apr_vsnprintf
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|n
operator|<
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
do|do
block|{
name|char
modifier|*
name|newline
init|=
name|strchr
argument_list|(
name|s
argument_list|,
literal|'\n'
argument_list|)
decl_stmt|;
if|if
condition|(
name|newline
condition|)
operator|*
name|newline
operator|=
literal|'\0'
expr_stmt|;
name|fputs
argument_list|(
name|prefix
argument_list|,
name|output
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|s
argument_list|,
name|output
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
literal|'\n'
argument_list|,
name|output
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|newline
condition|)
break|break;
name|s
operator|=
name|newline
operator|+
literal|1
expr_stmt|;
block|}
do|while
condition|(
operator|*
name|s
condition|)
do|;
comment|/* print another line, except after a final newline */
block|}
end_function

begin_function
name|void
name|svn_dbg__printf
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|debug_vprintf
argument_list|(
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|svn_dbg__print_props
parameter_list|(
name|apr_hash_t
modifier|*
name|props
parameter_list|,
specifier|const
name|char
modifier|*
name|header_fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
comment|/* We only build this code if SVN_DEBUG is defined. */
ifdef|#
directive|ifdef
name|SVN_DEBUG
name|apr_hash_index_t
modifier|*
name|hi
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|header_fmt
argument_list|)
expr_stmt|;
name|debug_vprintf
argument_list|(
name|header_fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|props
operator|==
name|NULL
condition|)
block|{
name|svn_dbg__printf
argument_list|(
literal|"    (null)\n"
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|hi
operator|=
name|apr_hash_first
argument_list|(
name|apr_hash_pool_get
argument_list|(
name|props
argument_list|)
argument_list|,
name|props
argument_list|)
init|;
name|hi
condition|;
name|hi
operator|=
name|apr_hash_next
argument_list|(
name|hi
argument_list|)
control|)
block|{
specifier|const
name|char
modifier|*
name|name
init|=
name|svn__apr_hash_index_key
argument_list|(
name|hi
argument_list|)
decl_stmt|;
name|svn_string_t
modifier|*
name|val
init|=
name|svn__apr_hash_index_val
argument_list|(
name|hi
argument_list|)
decl_stmt|;
name|svn_dbg__printf
argument_list|(
literal|"    '%s' -> '%s'\n"
argument_list|,
name|name
argument_list|,
name|val
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SVN_DEBUG */
block|}
end_function

end_unit


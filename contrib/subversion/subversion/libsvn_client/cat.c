begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * cat.c:  implementation of the 'cat' command  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_comment
comment|/* ==================================================================== */
end_comment

begin_escape
end_escape

begin_comment
comment|/*** Includes. ***/
end_comment

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_client.h"
end_include

begin_include
include|#
directive|include
file|"svn_string.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_subst.h"
end_include

begin_include
include|#
directive|include
file|"svn_io.h"
end_include

begin_include
include|#
directive|include
file|"svn_time.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"svn_props.h"
end_include

begin_include
include|#
directive|include
file|"client.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_wc_private.h"
end_include

begin_escape
end_escape

begin_comment
comment|/*** Code. ***/
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_client__get_normalized_stream
parameter_list|(
name|svn_stream_t
modifier|*
modifier|*
name|normal_stream
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision
parameter_list|,
name|svn_boolean_t
name|expand_keywords
parameter_list|,
name|svn_boolean_t
name|normalize_eols
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|kw
init|=
name|NULL
decl_stmt|;
name|svn_subst_eol_style_t
name|style
decl_stmt|;
name|apr_hash_t
modifier|*
name|props
decl_stmt|;
name|svn_string_t
modifier|*
name|eol_style
decl_stmt|,
modifier|*
name|keywords
decl_stmt|,
modifier|*
name|special
decl_stmt|;
specifier|const
name|char
modifier|*
name|eol
init|=
name|NULL
decl_stmt|;
name|svn_boolean_t
name|local_mod
init|=
name|FALSE
decl_stmt|;
name|svn_stream_t
modifier|*
name|input
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|SVN_CLIENT__REVKIND_IS_LOCAL_TO_WC
argument_list|(
name|revision
operator|->
name|kind
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc_read_kind2
argument_list|(
operator|&
name|kind
argument_list|,
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
operator|(
name|revision
operator|->
name|kind
operator|!=
name|svn_opt_revision_working
operator|)
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|==
name|svn_node_unknown
operator|||
name|kind
operator|==
name|svn_node_none
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_UNVERSIONED_RESOURCE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is not under version control"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|kind
operator|!=
name|svn_node_file
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_CLIENT_IS_DIRECTORY
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' refers to a directory"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|revision
operator|->
name|kind
operator|!=
name|svn_opt_revision_working
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc_get_pristine_contents2
argument_list|(
operator|&
name|input
argument_list|,
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|input
operator|==
name|NULL
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_ILLEGAL_TARGET
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' has no pristine version until it is committed"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_wc_get_pristine_props
argument_list|(
operator|&
name|props
argument_list|,
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|svn_wc_status3_t
modifier|*
name|status
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_open_readonly
argument_list|(
operator|&
name|input
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc_prop_list2
argument_list|(
operator|&
name|props
argument_list|,
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc_status3
argument_list|(
operator|&
name|status
argument_list|,
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|node_status
operator|!=
name|svn_wc_status_normal
condition|)
name|local_mod
operator|=
name|TRUE
expr_stmt|;
block|}
name|eol_style
operator|=
name|svn_hash_gets
argument_list|(
name|props
argument_list|,
name|SVN_PROP_EOL_STYLE
argument_list|)
expr_stmt|;
name|keywords
operator|=
name|svn_hash_gets
argument_list|(
name|props
argument_list|,
name|SVN_PROP_KEYWORDS
argument_list|)
expr_stmt|;
name|special
operator|=
name|svn_hash_gets
argument_list|(
name|props
argument_list|,
name|SVN_PROP_SPECIAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|eol_style
condition|)
name|svn_subst_eol_style_from_value
argument_list|(
operator|&
name|style
argument_list|,
operator|&
name|eol
argument_list|,
name|eol_style
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|keywords
condition|)
block|{
name|svn_revnum_t
name|changed_rev
decl_stmt|;
specifier|const
name|char
modifier|*
name|rev_str
decl_stmt|;
specifier|const
name|char
modifier|*
name|author
decl_stmt|;
specifier|const
name|char
modifier|*
name|url
decl_stmt|;
name|apr_time_t
name|tm
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_root_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__node_get_changed_info
argument_list|(
operator|&
name|changed_rev
argument_list|,
operator|&
name|tm
argument_list|,
operator|&
name|author
argument_list|,
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__node_get_repos_info
argument_list|(
name|NULL
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_root_url
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|url
operator|=
name|svn_path_url_add_component2
argument_list|(
name|repos_root_url
argument_list|,
name|repos_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|local_mod
condition|)
block|{
comment|/* For locally modified files, we'll append an 'M'              to the revision number, and set the author to              "(local)" since we can't always determine the              current user's username */
name|rev_str
operator|=
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"%ldM"
argument_list|,
name|changed_rev
argument_list|)
expr_stmt|;
name|author
operator|=
name|_
argument_list|(
literal|"(local)"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|special
condition|)
block|{
comment|/* Use the modified time from the working copy for files */
name|SVN_ERR
argument_list|(
name|svn_io_file_affected_time
argument_list|(
operator|&
name|tm
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|rev_str
operator|=
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"%ld"
argument_list|,
name|changed_rev
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_subst_build_keywords3
argument_list|(
operator|&
name|kw
argument_list|,
name|keywords
operator|->
name|data
argument_list|,
name|rev_str
argument_list|,
name|url
argument_list|,
name|repos_root_url
argument_list|,
name|tm
argument_list|,
name|author
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Wrap the output stream if translation is needed. */
if|if
condition|(
name|eol
operator|!=
name|NULL
operator|||
name|kw
operator|!=
name|NULL
condition|)
name|input
operator|=
name|svn_subst_stream_translated
argument_list|(
name|input
argument_list|,
operator|(
name|eol_style
operator|&&
name|normalize_eols
operator|)
condition|?
name|SVN_SUBST_NATIVE_EOL_STR
else|:
name|eol
argument_list|,
name|FALSE
argument_list|,
name|kw
argument_list|,
name|expand_keywords
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
operator|*
name|normal_stream
operator|=
name|input
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client_cat2
parameter_list|(
name|svn_stream_t
modifier|*
name|out
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_ra_session_t
modifier|*
name|ra_session
decl_stmt|;
name|svn_client__pathrev_t
modifier|*
name|loc
decl_stmt|;
name|svn_string_t
modifier|*
name|eol_style
decl_stmt|;
name|svn_string_t
modifier|*
name|keywords
decl_stmt|;
name|apr_hash_t
modifier|*
name|props
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_root_url
decl_stmt|;
name|svn_stream_t
modifier|*
name|output
init|=
name|out
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
comment|/* ### Inconsistent default revision logic in this command. */
if|if
condition|(
name|peg_revision
operator|->
name|kind
operator|==
name|svn_opt_revision_unspecified
condition|)
block|{
name|peg_revision
operator|=
name|svn_cl__rev_default_to_head_or_working
argument_list|(
name|peg_revision
argument_list|,
name|path_or_url
argument_list|)
expr_stmt|;
name|revision
operator|=
name|svn_cl__rev_default_to_head_or_base
argument_list|(
name|revision
argument_list|,
name|path_or_url
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|peg_revision
operator|=
name|svn_cl__rev_default_to_head_or_working
argument_list|(
name|peg_revision
argument_list|,
name|path_or_url
argument_list|)
expr_stmt|;
name|revision
operator|=
name|svn_cl__rev_default_to_peg
argument_list|(
name|revision
argument_list|,
name|peg_revision
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|svn_path_is_url
argument_list|(
name|path_or_url
argument_list|)
operator|&&
name|SVN_CLIENT__REVKIND_IS_LOCAL_TO_WC
argument_list|(
name|peg_revision
operator|->
name|kind
argument_list|)
operator|&&
name|SVN_CLIENT__REVKIND_IS_LOCAL_TO_WC
argument_list|(
name|revision
operator|->
name|kind
argument_list|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|local_abspath
decl_stmt|;
name|svn_stream_t
modifier|*
name|normal_stream
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|local_abspath
argument_list|,
name|path_or_url
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__get_normalized_stream
argument_list|(
operator|&
name|normal_stream
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|revision
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|ctx
operator|->
name|cancel_func
argument_list|,
name|ctx
operator|->
name|cancel_baton
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We don't promise to close output, so disown it to ensure we don't. */
name|output
operator|=
name|svn_stream_disown
argument_list|(
name|output
argument_list|,
name|pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_stream_copy3
argument_list|(
name|normal_stream
argument_list|,
name|output
argument_list|,
name|ctx
operator|->
name|cancel_func
argument_list|,
name|ctx
operator|->
name|cancel_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
comment|/* Get an RA plugin for this filesystem object. */
name|SVN_ERR
argument_list|(
name|svn_client__ra_session_from_path2
argument_list|(
operator|&
name|ra_session
argument_list|,
operator|&
name|loc
argument_list|,
name|path_or_url
argument_list|,
name|NULL
argument_list|,
name|peg_revision
argument_list|,
name|revision
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Find the repos root URL */
name|SVN_ERR
argument_list|(
name|svn_ra_get_repos_root2
argument_list|(
name|ra_session
argument_list|,
operator|&
name|repos_root_url
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Grab some properties we need to know in order to figure out if anything      special needs to be done with this file. */
name|err
operator|=
name|svn_ra_get_file
argument_list|(
name|ra_session
argument_list|,
literal|""
argument_list|,
name|loc
operator|->
name|rev
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|props
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_FS_NOT_FILE
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_CLIENT_IS_DIRECTORY
argument_list|,
name|err
argument_list|,
name|_
argument_list|(
literal|"URL '%s' refers to a directory"
argument_list|)
argument_list|,
name|loc
operator|->
name|url
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
block|}
name|eol_style
operator|=
name|svn_hash_gets
argument_list|(
name|props
argument_list|,
name|SVN_PROP_EOL_STYLE
argument_list|)
expr_stmt|;
name|keywords
operator|=
name|svn_hash_gets
argument_list|(
name|props
argument_list|,
name|SVN_PROP_KEYWORDS
argument_list|)
expr_stmt|;
if|if
condition|(
name|eol_style
operator|||
name|keywords
condition|)
block|{
comment|/* It's a file with no special eol style or keywords. */
name|svn_subst_eol_style_t
name|eol
decl_stmt|;
specifier|const
name|char
modifier|*
name|eol_str
decl_stmt|;
name|apr_hash_t
modifier|*
name|kw
decl_stmt|;
if|if
condition|(
name|eol_style
condition|)
name|svn_subst_eol_style_from_value
argument_list|(
operator|&
name|eol
argument_list|,
operator|&
name|eol_str
argument_list|,
name|eol_style
operator|->
name|data
argument_list|)
expr_stmt|;
else|else
block|{
name|eol
operator|=
name|svn_subst_eol_style_none
expr_stmt|;
name|eol_str
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|keywords
condition|)
block|{
name|svn_string_t
modifier|*
name|cmt_rev
decl_stmt|,
modifier|*
name|cmt_date
decl_stmt|,
modifier|*
name|cmt_author
decl_stmt|;
name|apr_time_t
name|when
init|=
literal|0
decl_stmt|;
name|cmt_rev
operator|=
name|svn_hash_gets
argument_list|(
name|props
argument_list|,
name|SVN_PROP_ENTRY_COMMITTED_REV
argument_list|)
expr_stmt|;
name|cmt_date
operator|=
name|svn_hash_gets
argument_list|(
name|props
argument_list|,
name|SVN_PROP_ENTRY_COMMITTED_DATE
argument_list|)
expr_stmt|;
name|cmt_author
operator|=
name|svn_hash_gets
argument_list|(
name|props
argument_list|,
name|SVN_PROP_ENTRY_LAST_AUTHOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmt_date
condition|)
name|SVN_ERR
argument_list|(
name|svn_time_from_cstring
argument_list|(
operator|&
name|when
argument_list|,
name|cmt_date
operator|->
name|data
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_subst_build_keywords3
argument_list|(
operator|&
name|kw
argument_list|,
name|keywords
operator|->
name|data
argument_list|,
name|cmt_rev
operator|->
name|data
argument_list|,
name|loc
operator|->
name|url
argument_list|,
name|repos_root_url
argument_list|,
name|when
argument_list|,
name|cmt_author
condition|?
name|cmt_author
operator|->
name|data
else|:
name|NULL
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|kw
operator|=
name|NULL
expr_stmt|;
comment|/* Interject a translating stream */
name|output
operator|=
name|svn_subst_stream_translated
argument_list|(
name|svn_stream_disown
argument_list|(
name|out
argument_list|,
name|pool
argument_list|)
argument_list|,
name|eol_str
argument_list|,
name|FALSE
argument_list|,
name|kw
argument_list|,
name|TRUE
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_ra_get_file
argument_list|(
name|ra_session
argument_list|,
literal|""
argument_list|,
name|loc
operator|->
name|rev
argument_list|,
name|output
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
operator|!=
name|output
condition|)
comment|/* Close the interjected stream */
name|SVN_ERR
argument_list|(
name|svn_stream_close
argument_list|(
name|output
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


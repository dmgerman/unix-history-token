begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * revert.c:  wrapper around wc revert functionality.  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_comment
comment|/* ==================================================================== */
end_comment

begin_escape
end_escape

begin_comment
comment|/*** Includes. ***/
end_comment

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"svn_wc.h"
end_include

begin_include
include|#
directive|include
file|"svn_client.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_time.h"
end_include

begin_include
include|#
directive|include
file|"svn_config.h"
end_include

begin_include
include|#
directive|include
file|"client.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_wc_private.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_escape
end_escape

begin_comment
comment|/*** Code. ***/
end_comment

begin_struct
struct|struct
name|revert_with_write_lock_baton
block|{
specifier|const
name|char
modifier|*
name|local_abspath
decl_stmt|;
name|svn_depth_t
name|depth
decl_stmt|;
name|svn_boolean_t
name|use_commit_times
decl_stmt|;
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
decl_stmt|;
name|svn_boolean_t
name|clear_changelists
decl_stmt|;
name|svn_boolean_t
name|metadata_only
decl_stmt|;
name|svn_client_ctx_t
modifier|*
name|ctx
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* (Note: All arguments are in the baton above.)     Attempt to revert LOCAL_ABSPATH.     If DEPTH is svn_depth_empty, revert just the properties on the    directory; else if svn_depth_files, revert the properties and any    files immediately under the directory; else if    svn_depth_immediates, revert all of the preceding plus properties    on immediate subdirectories; else if svn_depth_infinity, revert    path and everything under it fully recursively.     CHANGELISTS is an array of const char * changelist names, used as a    restrictive filter on items reverted; that is, don't revert any    item unless it's a member of one of those changelists.  If    CHANGELISTS is empty (or altogether NULL), no changelist filtering occurs.     Consult CTX to determine whether or not to revert timestamp to the    time of last commit ('use-commit-times = yes').     If PATH is unversioned, return SVN_ERR_UNVERSIONED_RESOURCE. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|revert
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|revert_with_write_lock_baton
modifier|*
name|b
init|=
name|baton
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|err
operator|=
name|svn_wc_revert5
argument_list|(
name|b
operator|->
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|b
operator|->
name|local_abspath
argument_list|,
name|b
operator|->
name|depth
argument_list|,
name|b
operator|->
name|use_commit_times
argument_list|,
name|b
operator|->
name|changelists
argument_list|,
name|b
operator|->
name|clear_changelists
argument_list|,
name|b
operator|->
name|metadata_only
argument_list|,
name|b
operator|->
name|ctx
operator|->
name|cancel_func
argument_list|,
name|b
operator|->
name|ctx
operator|->
name|cancel_baton
argument_list|,
name|b
operator|->
name|ctx
operator|->
name|notify_func2
argument_list|,
name|b
operator|->
name|ctx
operator|->
name|notify_baton2
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
comment|/* If target isn't versioned, just send a 'skip'          notification and move on. */
if|if
condition|(
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_ENTRY_NOT_FOUND
operator|||
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_UNVERSIONED_RESOURCE
operator|||
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
block|{
if|if
condition|(
name|b
operator|->
name|ctx
operator|->
name|notify_func2
condition|)
block|{
name|svn_wc_notify_t
modifier|*
name|notify
decl_stmt|;
name|notify
operator|=
name|svn_wc_create_notify
argument_list|(
name|b
operator|->
name|local_abspath
argument_list|,
name|svn_wc_notify_skip
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|notify
operator|->
name|err
operator|=
name|err
expr_stmt|;
name|b
operator|->
name|ctx
operator|->
name|notify_func2
argument_list|(
name|b
operator|->
name|ctx
operator|->
name|notify_baton2
argument_list|,
name|notify
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
block|}
else|else
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client_revert3
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|paths
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
parameter_list|,
name|svn_boolean_t
name|clear_changelists
parameter_list|,
name|svn_boolean_t
name|metadata_only
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|svn_error_t
modifier|*
name|err
init|=
name|SVN_NO_ERROR
decl_stmt|;
name|int
name|i
decl_stmt|;
name|svn_config_t
modifier|*
name|cfg
decl_stmt|;
name|svn_boolean_t
name|use_commit_times
decl_stmt|;
name|struct
name|revert_with_write_lock_baton
name|baton
decl_stmt|;
comment|/* Don't even attempt to modify the working copy if any of the    * targets look like URLs. URLs are invalid input. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|paths
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|path
init|=
name|APR_ARRAY_IDX
argument_list|(
name|paths
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|svn_path_is_url
argument_list|(
name|path
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_ILLEGAL_TARGET
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is not a local path"
argument_list|)
argument_list|,
name|path
argument_list|)
return|;
block|}
name|cfg
operator|=
name|ctx
operator|->
name|config
condition|?
name|svn_hash_gets
argument_list|(
name|ctx
operator|->
name|config
argument_list|,
name|SVN_CONFIG_CATEGORY_CONFIG
argument_list|)
else|:
name|NULL
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_config_get_bool
argument_list|(
name|cfg
argument_list|,
operator|&
name|use_commit_times
argument_list|,
name|SVN_CONFIG_SECTION_MISCELLANY
argument_list|,
name|SVN_CONFIG_OPTION_USE_COMMIT_TIMES
argument_list|,
name|FALSE
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|paths
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|path
init|=
name|APR_ARRAY_IDX
argument_list|(
name|paths
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_abspath
decl_stmt|,
modifier|*
name|lock_target
decl_stmt|;
name|svn_boolean_t
name|wc_root
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
comment|/* See if we've been asked to cancel this operation. */
if|if
condition|(
operator|(
name|ctx
operator|->
name|cancel_func
operator|)
operator|&&
operator|(
operator|(
name|err
operator|=
name|ctx
operator|->
name|cancel_func
argument_list|(
name|ctx
operator|->
name|cancel_baton
argument_list|)
operator|)
operator|)
condition|)
goto|goto
name|errorful
goto|;
name|err
operator|=
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|local_abspath
argument_list|,
name|path
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|errorful
goto|;
name|baton
operator|.
name|local_abspath
operator|=
name|local_abspath
expr_stmt|;
name|baton
operator|.
name|depth
operator|=
name|depth
expr_stmt|;
name|baton
operator|.
name|use_commit_times
operator|=
name|use_commit_times
expr_stmt|;
name|baton
operator|.
name|changelists
operator|=
name|changelists
expr_stmt|;
name|baton
operator|.
name|clear_changelists
operator|=
name|clear_changelists
expr_stmt|;
name|baton
operator|.
name|metadata_only
operator|=
name|metadata_only
expr_stmt|;
name|baton
operator|.
name|ctx
operator|=
name|ctx
expr_stmt|;
name|err
operator|=
name|svn_wc__is_wcroot
argument_list|(
operator|&
name|wc_root
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|errorful
goto|;
name|lock_target
operator|=
name|wc_root
condition|?
name|local_abspath
else|:
name|svn_dirent_dirname
argument_list|(
name|local_abspath
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_wc__call_with_write_lock
argument_list|(
name|revert
argument_list|,
operator|&
name|baton
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|lock_target
argument_list|,
name|FALSE
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|errorful
goto|;
block|}
name|errorful
label|:
block|{
comment|/* Sleep to ensure timestamp integrity. */
specifier|const
name|char
modifier|*
name|sleep_path
init|=
name|NULL
decl_stmt|;
comment|/* Only specify a path if we are certain all paths are on the        same filesystem */
if|if
condition|(
name|paths
operator|->
name|nelts
operator|==
literal|1
condition|)
name|sleep_path
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|paths
argument_list|,
literal|0
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
name|svn_io_sleep_for_timestamps
argument_list|(
name|sleep_path
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

end_unit


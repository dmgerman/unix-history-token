begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * mtcc.c -- Multi Command Context implementation. This allows  *           performing many operations without a working copy.  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"svn_props.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_subst.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_client_mtcc.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"client.h"
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_define
define|#
directive|define
name|SVN_PATH_IS_EMPTY
parameter_list|(
name|s
parameter_list|)
value|((s)[0] == '\0')
end_define

begin_comment
comment|/* The kind of operation to perform in an mtcc_op_t */
end_comment

begin_typedef
typedef|typedef
enum|enum
name|mtcc_kind_t
block|{
name|OP_OPEN_DIR
block|,
name|OP_OPEN_FILE
block|,
name|OP_ADD_DIR
block|,
name|OP_ADD_FILE
block|,
name|OP_DELETE
block|}
name|mtcc_kind_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|mtcc_op_t
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
comment|/* basename of operation */
name|mtcc_kind_t
name|kind
decl_stmt|;
comment|/* editor operation */
name|apr_array_header_t
modifier|*
name|children
decl_stmt|;
comment|/* List of mtcc_op_t * */
specifier|const
name|char
modifier|*
name|src_relpath
decl_stmt|;
comment|/* For ADD_DIR, ADD_FILE */
name|svn_revnum_t
name|src_rev
decl_stmt|;
comment|/* For ADD_DIR, ADD_FILE */
name|svn_stream_t
modifier|*
name|src_stream
decl_stmt|;
comment|/* For ADD_FILE, OPEN_FILE */
name|svn_checksum_t
modifier|*
name|src_checksum
decl_stmt|;
comment|/* For ADD_FILE, OPEN_FILE */
name|svn_stream_t
modifier|*
name|base_stream
decl_stmt|;
comment|/* For ADD_FILE, OPEN_FILE */
specifier|const
name|svn_checksum_t
modifier|*
name|base_checksum
decl_stmt|;
comment|/* For ADD_FILE, OPEN_FILE */
name|apr_array_header_t
modifier|*
name|prop_mods
decl_stmt|;
comment|/* For all except DELETE                                            List of svn_prop_t */
name|svn_boolean_t
name|performed_stat
decl_stmt|;
comment|/* Verified kind with repository */
block|}
name|mtcc_op_t
typedef|;
end_typedef

begin_comment
comment|/* Check if the mtcc doesn't contain any modifications yet */
end_comment

begin_define
define|#
directive|define
name|MTCC_UNMODIFIED
parameter_list|(
name|mtcc
parameter_list|)
define|\
value|((mtcc->root_op->kind == OP_OPEN_DIR                                    \                             || mtcc->root_op->kind == OP_OPEN_FILE)         \&& (mtcc->root_op->prop_mods == NULL                                   \                             || !mtcc->root_op->prop_mods->nelts)            \&& (mtcc->root_op->children == NULL                                    \                             || !mtcc->root_op->children->nelts))
end_define

begin_struct
struct|struct
name|svn_client__mtcc_t
block|{
name|apr_pool_t
modifier|*
name|pool
decl_stmt|;
name|svn_revnum_t
name|head_revision
decl_stmt|;
name|svn_revnum_t
name|base_revision
decl_stmt|;
name|svn_ra_session_t
modifier|*
name|ra_session
decl_stmt|;
name|svn_client_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|mtcc_op_t
modifier|*
name|root_op
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|mtcc_op_t
modifier|*
name|mtcc_op_create
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|svn_boolean_t
name|add
parameter_list|,
name|svn_boolean_t
name|directory
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|mtcc_op_t
modifier|*
name|op
decl_stmt|;
name|op
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|op
argument_list|)
argument_list|)
expr_stmt|;
name|op
operator|->
name|name
operator|=
name|name
condition|?
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|name
argument_list|)
else|:
literal|""
expr_stmt|;
if|if
condition|(
name|add
condition|)
name|op
operator|->
name|kind
operator|=
name|directory
condition|?
name|OP_ADD_DIR
else|:
name|OP_ADD_FILE
expr_stmt|;
else|else
name|op
operator|->
name|kind
operator|=
name|directory
condition|?
name|OP_OPEN_DIR
else|:
name|OP_OPEN_FILE
expr_stmt|;
if|if
condition|(
name|directory
condition|)
name|op
operator|->
name|children
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|mtcc_op_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|op
operator|->
name|src_rev
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
return|return
name|op
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|mtcc_op_find
parameter_list|(
name|mtcc_op_t
modifier|*
modifier|*
name|op
parameter_list|,
name|svn_boolean_t
modifier|*
name|created
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|mtcc_op_t
modifier|*
name|base_op
parameter_list|,
name|svn_boolean_t
name|find_existing
parameter_list|,
name|svn_boolean_t
name|find_deletes
parameter_list|,
name|svn_boolean_t
name|create_file
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|child
decl_stmt|;
name|int
name|i
decl_stmt|;
name|assert
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|created
condition|)
operator|*
name|created
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|SVN_PATH_IS_EMPTY
argument_list|(
name|relpath
argument_list|)
condition|)
block|{
if|if
condition|(
name|find_existing
condition|)
operator|*
name|op
operator|=
name|base_op
expr_stmt|;
else|else
operator|*
name|op
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|child
operator|=
name|strchr
argument_list|(
name|relpath
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
condition|)
block|{
name|name
operator|=
name|apr_pstrmemdup
argument_list|(
name|scratch_pool
argument_list|,
name|relpath
argument_list|,
operator|(
name|child
operator|-
name|relpath
operator|)
argument_list|)
expr_stmt|;
name|child
operator|++
expr_stmt|;
comment|/* Skip '/' */
block|}
else|else
name|name
operator|=
name|relpath
expr_stmt|;
if|if
condition|(
operator|!
name|base_op
operator|->
name|children
condition|)
block|{
if|if
condition|(
operator|!
name|created
condition|)
block|{
operator|*
name|op
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
else|else
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_DIRECTORY
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't operate on '%s' because '%s' is not a "
literal|"directory"
argument_list|)
argument_list|,
name|name
argument_list|,
name|base_op
operator|->
name|name
argument_list|)
return|;
block|}
for|for
control|(
name|i
operator|=
name|base_op
operator|->
name|children
operator|->
name|nelts
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|mtcc_op_t
modifier|*
name|cop
decl_stmt|;
name|cop
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|base_op
operator|->
name|children
argument_list|,
name|i
argument_list|,
name|mtcc_op_t
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|cop
operator|->
name|name
argument_list|,
name|name
argument_list|)
operator|&&
operator|(
name|find_deletes
operator|||
name|cop
operator|->
name|kind
operator|!=
name|OP_DELETE
operator|)
condition|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|mtcc_op_find
argument_list|(
name|op
argument_list|,
name|created
argument_list|,
name|child
condition|?
name|child
else|:
literal|""
argument_list|,
name|cop
argument_list|,
name|find_existing
argument_list|,
name|find_deletes
argument_list|,
name|create_file
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
block|}
if|if
condition|(
operator|!
name|created
condition|)
block|{
operator|*
name|op
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|{
name|mtcc_op_t
modifier|*
name|cop
decl_stmt|;
name|cop
operator|=
name|mtcc_op_create
argument_list|(
name|name
argument_list|,
name|FALSE
argument_list|,
name|child
operator|||
operator|!
name|create_file
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|base_op
operator|->
name|children
argument_list|,
name|mtcc_op_t
operator|*
argument_list|)
operator|=
name|cop
expr_stmt|;
if|if
condition|(
operator|!
name|child
condition|)
block|{
operator|*
name|op
operator|=
name|cop
expr_stmt|;
operator|*
name|created
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|svn_error_trace
argument_list|(
name|mtcc_op_find
argument_list|(
name|op
argument_list|,
name|created
argument_list|,
name|child
argument_list|,
name|cop
argument_list|,
name|find_existing
argument_list|,
name|find_deletes
argument_list|,
name|create_file
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* Gets the original repository location of RELPATH, checking things    like copies, moves, etc.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_origin
parameter_list|(
name|svn_boolean_t
modifier|*
name|done
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|origin_relpath
parameter_list|,
name|svn_revnum_t
modifier|*
name|rev
parameter_list|,
name|mtcc_op_t
modifier|*
name|op
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|child
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
if|if
condition|(
name|SVN_PATH_IS_EMPTY
argument_list|(
name|relpath
argument_list|)
condition|)
block|{
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_ADD_DIR
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_ADD_FILE
condition|)
operator|*
name|done
operator|=
name|TRUE
expr_stmt|;
operator|*
name|origin_relpath
operator|=
name|op
operator|->
name|src_relpath
condition|?
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|op
operator|->
name|src_relpath
argument_list|)
else|:
name|NULL
expr_stmt|;
operator|*
name|rev
operator|=
name|op
operator|->
name|src_rev
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|child
operator|=
name|strchr
argument_list|(
name|relpath
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
condition|)
block|{
name|name
operator|=
name|apr_pstrmemdup
argument_list|(
name|scratch_pool
argument_list|,
name|relpath
argument_list|,
name|child
operator|-
name|relpath
argument_list|)
expr_stmt|;
name|child
operator|++
expr_stmt|;
comment|/* Skip '/' */
block|}
else|else
name|name
operator|=
name|relpath
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|children
operator|&&
name|op
operator|->
name|children
operator|->
name|nelts
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|op
operator|->
name|children
operator|->
name|nelts
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|mtcc_op_t
modifier|*
name|cop
decl_stmt|;
name|cop
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|op
operator|->
name|children
argument_list|,
name|i
argument_list|,
name|mtcc_op_t
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|cop
operator|->
name|name
argument_list|,
name|name
argument_list|)
condition|)
block|{
if|if
condition|(
name|cop
operator|->
name|kind
operator|==
name|OP_DELETE
condition|)
block|{
operator|*
name|done
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|SVN_ERR
argument_list|(
name|get_origin
argument_list|(
name|done
argument_list|,
name|origin_relpath
argument_list|,
name|rev
argument_list|,
name|cop
argument_list|,
name|child
condition|?
name|child
else|:
literal|""
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|origin_relpath
operator|||
operator|*
name|done
condition|)
return|return
name|SVN_NO_ERROR
return|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_ADD_DIR
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_ADD_FILE
condition|)
block|{
operator|*
name|done
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|src_relpath
condition|)
block|{
operator|*
name|origin_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|op
operator|->
name|src_relpath
argument_list|,
name|relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
operator|*
name|rev
operator|=
name|op
operator|->
name|src_rev
expr_stmt|;
block|}
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Obtains the original repository location for an mtcc relpath as    *ORIGIN_RELPATH @ *REV, if it has one. If it has not and IGNORE_ENOENT    is TRUE report *ORIGIN_RELPATH as NULL, otherwise return an error */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|mtcc_get_origin
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|origin_relpath
parameter_list|,
name|svn_revnum_t
modifier|*
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_boolean_t
name|ignore_enoent
parameter_list|,
name|svn_client__mtcc_t
modifier|*
name|mtcc
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_boolean_t
name|done
init|=
name|FALSE
decl_stmt|;
operator|*
name|origin_relpath
operator|=
name|NULL
expr_stmt|;
operator|*
name|rev
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|SVN_ERR
argument_list|(
name|get_origin
argument_list|(
operator|&
name|done
argument_list|,
name|origin_relpath
argument_list|,
name|rev
argument_list|,
name|mtcc
operator|->
name|root_op
argument_list|,
name|relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|origin_relpath
operator|&&
operator|!
name|done
condition|)
block|{
operator|*
name|origin_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
operator|*
name|rev
operator|=
name|mtcc
operator|->
name|base_revision
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|ignore_enoent
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"No origin found for node at '%s'"
argument_list|)
argument_list|,
name|relpath
argument_list|)
return|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client__mtcc_create
parameter_list|(
name|svn_client__mtcc_t
modifier|*
modifier|*
name|mtcc
parameter_list|,
specifier|const
name|char
modifier|*
name|anchor_url
parameter_list|,
name|svn_revnum_t
name|base_revision
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|mtcc_pool
decl_stmt|;
name|mtcc_pool
operator|=
name|svn_pool_create
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
operator|*
name|mtcc
operator|=
name|apr_pcalloc
argument_list|(
name|mtcc_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|mtcc
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|mtcc
operator|)
operator|->
name|pool
operator|=
name|mtcc_pool
expr_stmt|;
operator|(
operator|*
name|mtcc
operator|)
operator|->
name|root_op
operator|=
name|mtcc_op_create
argument_list|(
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|mtcc_pool
argument_list|)
expr_stmt|;
operator|(
operator|*
name|mtcc
operator|)
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client_open_ra_session2
argument_list|(
operator|&
operator|(
operator|*
name|mtcc
operator|)
operator|->
name|ra_session
argument_list|,
name|anchor_url
argument_list|,
name|NULL
comment|/* wri_abspath */
argument_list|,
name|ctx
argument_list|,
name|mtcc_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_get_latest_revnum
argument_list|(
operator|(
operator|*
name|mtcc
operator|)
operator|->
name|ra_session
argument_list|,
operator|&
operator|(
operator|*
name|mtcc
operator|)
operator|->
name|head_revision
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|base_revision
argument_list|)
condition|)
operator|(
operator|*
name|mtcc
operator|)
operator|->
name|base_revision
operator|=
name|base_revision
expr_stmt|;
else|else
operator|(
operator|*
name|mtcc
operator|)
operator|->
name|base_revision
operator|=
operator|(
operator|*
name|mtcc
operator|)
operator|->
name|head_revision
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|mtcc
operator|)
operator|->
name|base_revision
operator|>
operator|(
operator|*
name|mtcc
operator|)
operator|->
name|head_revision
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NO_SUCH_REVISION
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"No such revision %ld (HEAD is %ld)"
argument_list|)
argument_list|,
name|base_revision
argument_list|,
operator|(
operator|*
name|mtcc
operator|)
operator|->
name|head_revision
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|update_copy_src
parameter_list|(
name|mtcc_op_t
modifier|*
name|op
parameter_list|,
specifier|const
name|char
modifier|*
name|add_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|op
operator|->
name|src_relpath
condition|)
name|op
operator|->
name|src_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|add_relpath
argument_list|,
name|op
operator|->
name|src_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|op
operator|->
name|children
condition|)
return|return
name|SVN_NO_ERROR
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|op
operator|->
name|children
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|mtcc_op_t
modifier|*
name|cop
decl_stmt|;
name|cop
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|op
operator|->
name|children
argument_list|,
name|i
argument_list|,
name|mtcc_op_t
operator|*
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|update_copy_src
argument_list|(
name|cop
argument_list|,
name|add_relpath
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|mtcc_reparent
parameter_list|(
specifier|const
name|char
modifier|*
name|new_anchor_url
parameter_list|,
name|svn_client__mtcc_t
modifier|*
name|mtcc
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|session_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|up
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_get_session_url
argument_list|(
name|mtcc
operator|->
name|ra_session
argument_list|,
operator|&
name|session_url
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|up
operator|=
name|svn_uri_skip_ancestor
argument_list|(
name|new_anchor_url
argument_list|,
name|session_url
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|up
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_RA_ILLEGAL_URL
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is not an ancestor of  '%s'"
argument_list|)
argument_list|,
name|new_anchor_url
argument_list|,
name|session_url
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|*
name|up
condition|)
block|{
return|return
name|SVN_NO_ERROR
return|;
comment|/* Same url */
block|}
comment|/* Update copy origins recursively...:( */
name|SVN_ERR
argument_list|(
name|update_copy_src
argument_list|(
name|mtcc
operator|->
name|root_op
argument_list|,
name|up
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_reparent
argument_list|(
name|mtcc
operator|->
name|ra_session
argument_list|,
name|new_anchor_url
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Create directory open operations for new ancestors */
while|while
condition|(
operator|*
name|up
condition|)
block|{
name|mtcc_op_t
modifier|*
name|root_op
decl_stmt|;
name|mtcc
operator|->
name|root_op
operator|->
name|name
operator|=
name|svn_relpath_basename
argument_list|(
name|up
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|)
expr_stmt|;
name|up
operator|=
name|svn_relpath_dirname
argument_list|(
name|up
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|root_op
operator|=
name|mtcc_op_create
argument_list|(
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|)
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|root_op
operator|->
name|children
argument_list|,
name|mtcc_op_t
operator|*
argument_list|)
operator|=
name|mtcc
operator|->
name|root_op
expr_stmt|;
name|mtcc
operator|->
name|root_op
operator|=
name|root_op
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Check if it is safe to create a new node at NEW_RELPATH. Return a proper    error if it is not */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|mtcc_verify_create
parameter_list|(
name|svn_client__mtcc_t
modifier|*
name|mtcc
parameter_list|,
specifier|const
name|char
modifier|*
name|new_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_node_kind_t
name|kind
decl_stmt|;
if|if
condition|(
operator|*
name|new_relpath
operator|||
operator|!
name|MTCC_UNMODIFIED
argument_list|(
name|mtcc
argument_list|)
condition|)
block|{
name|mtcc_op_t
modifier|*
name|op
decl_stmt|;
name|SVN_ERR
argument_list|(
name|mtcc_op_find
argument_list|(
operator|&
name|op
argument_list|,
name|NULL
argument_list|,
name|new_relpath
argument_list|,
name|mtcc
operator|->
name|root_op
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_ALREADY_EXISTS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Path '%s' already exists"
argument_list|)
argument_list|,
name|new_relpath
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|mtcc_op_find
argument_list|(
operator|&
name|op
argument_list|,
name|NULL
argument_list|,
name|new_relpath
argument_list|,
name|mtcc
operator|->
name|root_op
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Node is explicitly deleted. We can replace */
block|}
comment|/* mod_dav_svn used to allow overwriting existing directories. Let's hide      that for users of this api */
name|SVN_ERR
argument_list|(
name|svn_client__mtcc_check_path
argument_list|(
operator|&
name|kind
argument_list|,
name|new_relpath
argument_list|,
name|FALSE
argument_list|,
name|mtcc
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|!=
name|svn_node_none
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_ALREADY_EXISTS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Path '%s' already exists"
argument_list|)
argument_list|,
name|new_relpath
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client__mtcc_add_add_file
parameter_list|(
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_stream_t
modifier|*
name|src_stream
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|src_checksum
parameter_list|,
name|svn_client__mtcc_t
modifier|*
name|mtcc
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|mtcc_op_t
modifier|*
name|op
decl_stmt|;
name|svn_boolean_t
name|created
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
operator|&&
name|src_stream
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|mtcc_verify_create
argument_list|(
name|mtcc
argument_list|,
name|relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SVN_PATH_IS_EMPTY
argument_list|(
name|relpath
argument_list|)
operator|&&
name|MTCC_UNMODIFIED
argument_list|(
name|mtcc
argument_list|)
condition|)
block|{
comment|/* Turn the root operation into a file addition */
name|op
operator|=
name|mtcc
operator|->
name|root_op
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|mtcc_op_find
argument_list|(
operator|&
name|op
argument_list|,
operator|&
name|created
argument_list|,
name|relpath
argument_list|,
name|mtcc
operator|->
name|root_op
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|op
operator|||
operator|!
name|created
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_ILLEGAL_TARGET
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't add file at '%s'"
argument_list|)
argument_list|,
name|relpath
argument_list|)
return|;
block|}
block|}
name|op
operator|->
name|kind
operator|=
name|OP_ADD_FILE
expr_stmt|;
name|op
operator|->
name|src_stream
operator|=
name|src_stream
expr_stmt|;
name|op
operator|->
name|src_checksum
operator|=
name|src_checksum
condition|?
name|svn_checksum_dup
argument_list|(
name|src_checksum
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|)
else|:
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client__mtcc_add_copy
parameter_list|(
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|svn_client__mtcc_t
modifier|*
name|mtcc
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|mtcc_op_t
modifier|*
name|op
decl_stmt|;
name|svn_boolean_t
name|created
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|src_relpath
argument_list|)
operator|&&
name|svn_relpath_is_canonical
argument_list|(
name|dst_relpath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SVN_IS_VALID_REVNUM
argument_list|(
name|revision
argument_list|)
condition|)
name|revision
operator|=
name|mtcc
operator|->
name|head_revision
expr_stmt|;
elseif|else
if|if
condition|(
name|revision
operator|>
name|mtcc
operator|->
name|head_revision
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NO_SUCH_REVISION
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"No such revision %ld"
argument_list|)
argument_list|,
name|revision
argument_list|)
return|;
block|}
name|SVN_ERR
argument_list|(
name|mtcc_verify_create
argument_list|(
name|mtcc
argument_list|,
name|dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Subversion requires the kind of a copy */
name|SVN_ERR
argument_list|(
name|svn_ra_check_path
argument_list|(
name|mtcc
operator|->
name|ra_session
argument_list|,
name|src_relpath
argument_list|,
name|revision
argument_list|,
operator|&
name|kind
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|!=
name|svn_node_dir
operator|&&
name|kind
operator|!=
name|svn_node_file
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Path '%s' not found in revision %ld"
argument_list|)
argument_list|,
name|src_relpath
argument_list|,
name|revision
argument_list|)
return|;
block|}
name|SVN_ERR
argument_list|(
name|mtcc_op_find
argument_list|(
operator|&
name|op
argument_list|,
operator|&
name|created
argument_list|,
name|dst_relpath
argument_list|,
name|mtcc
operator|->
name|root_op
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
operator|(
name|kind
operator|==
name|svn_node_file
operator|)
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|op
operator|||
operator|!
name|created
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_ILLEGAL_TARGET
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't add node at '%s'"
argument_list|)
argument_list|,
name|dst_relpath
argument_list|)
return|;
block|}
name|op
operator|->
name|kind
operator|=
operator|(
name|kind
operator|==
name|svn_node_file
operator|)
condition|?
name|OP_ADD_FILE
else|:
name|OP_ADD_DIR
expr_stmt|;
name|op
operator|->
name|src_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|mtcc
operator|->
name|pool
argument_list|,
name|src_relpath
argument_list|)
expr_stmt|;
name|op
operator|->
name|src_rev
operator|=
name|revision
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client__mtcc_add_delete
parameter_list|(
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_client__mtcc_t
modifier|*
name|mtcc
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|mtcc_op_t
modifier|*
name|op
decl_stmt|;
name|svn_boolean_t
name|created
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__mtcc_check_path
argument_list|(
operator|&
name|kind
argument_list|,
name|relpath
argument_list|,
name|FALSE
argument_list|,
name|mtcc
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|==
name|svn_node_none
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't delete node at '%s' as it "
literal|"does not exist"
argument_list|)
argument_list|,
name|relpath
argument_list|)
return|;
if|if
condition|(
name|SVN_PATH_IS_EMPTY
argument_list|(
name|relpath
argument_list|)
operator|&&
name|MTCC_UNMODIFIED
argument_list|(
name|mtcc
argument_list|)
condition|)
block|{
comment|/* Turn root operation into delete */
name|op
operator|=
name|mtcc
operator|->
name|root_op
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|mtcc_op_find
argument_list|(
operator|&
name|op
argument_list|,
operator|&
name|created
argument_list|,
name|relpath
argument_list|,
name|mtcc
operator|->
name|root_op
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|op
operator|||
operator|!
name|created
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_ILLEGAL_TARGET
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't delete node at '%s'"
argument_list|)
argument_list|,
name|relpath
argument_list|)
return|;
block|}
block|}
name|op
operator|->
name|kind
operator|=
name|OP_DELETE
expr_stmt|;
name|op
operator|->
name|children
operator|=
name|NULL
expr_stmt|;
name|op
operator|->
name|prop_mods
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client__mtcc_add_mkdir
parameter_list|(
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_client__mtcc_t
modifier|*
name|mtcc
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|mtcc_op_t
modifier|*
name|op
decl_stmt|;
name|svn_boolean_t
name|created
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|mtcc_verify_create
argument_list|(
name|mtcc
argument_list|,
name|relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SVN_PATH_IS_EMPTY
argument_list|(
name|relpath
argument_list|)
operator|&&
name|MTCC_UNMODIFIED
argument_list|(
name|mtcc
argument_list|)
condition|)
block|{
comment|/* Turn the root of the operation in an MKDIR */
name|mtcc
operator|->
name|root_op
operator|->
name|kind
operator|=
name|OP_ADD_DIR
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|SVN_ERR
argument_list|(
name|mtcc_op_find
argument_list|(
operator|&
name|op
argument_list|,
operator|&
name|created
argument_list|,
name|relpath
argument_list|,
name|mtcc
operator|->
name|root_op
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|op
operator|||
operator|!
name|created
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_ILLEGAL_TARGET
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't create directory at '%s'"
argument_list|)
argument_list|,
name|relpath
argument_list|)
return|;
block|}
name|op
operator|->
name|kind
operator|=
name|OP_ADD_DIR
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client__mtcc_add_move
parameter_list|(
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|svn_client__mtcc_t
modifier|*
name|mtcc
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|origin_relpath
decl_stmt|;
name|svn_revnum_t
name|origin_rev
decl_stmt|;
name|SVN_ERR
argument_list|(
name|mtcc_get_origin
argument_list|(
operator|&
name|origin_relpath
argument_list|,
operator|&
name|origin_rev
argument_list|,
name|src_relpath
argument_list|,
name|FALSE
argument_list|,
name|mtcc
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__mtcc_add_copy
argument_list|(
name|src_relpath
argument_list|,
name|mtcc
operator|->
name|base_revision
argument_list|,
name|dst_relpath
argument_list|,
name|mtcc
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__mtcc_add_delete
argument_list|(
name|src_relpath
argument_list|,
name|mtcc
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Baton for mtcc_prop_getter */
end_comment

begin_struct
struct|struct
name|mtcc_prop_get_baton
block|{
name|svn_client__mtcc_t
modifier|*
name|mtcc
decl_stmt|;
specifier|const
name|char
modifier|*
name|relpath
decl_stmt|;
name|svn_cancel_func_t
name|cancel_func
decl_stmt|;
name|void
modifier|*
name|cancel_baton
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Implements svn_wc_canonicalize_svn_prop_get_file_t */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|mtcc_prop_getter
parameter_list|(
specifier|const
name|svn_string_t
modifier|*
modifier|*
name|mime_type
parameter_list|,
name|svn_stream_t
modifier|*
name|stream
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|mtcc_prop_get_baton
modifier|*
name|mpgb
init|=
name|baton
decl_stmt|;
specifier|const
name|char
modifier|*
name|origin_relpath
decl_stmt|;
name|svn_revnum_t
name|origin_rev
decl_stmt|;
name|apr_hash_t
modifier|*
name|props
init|=
name|NULL
decl_stmt|;
name|mtcc_op_t
modifier|*
name|op
decl_stmt|;
if|if
condition|(
name|mime_type
condition|)
operator|*
name|mime_type
operator|=
name|NULL
expr_stmt|;
comment|/* Check if we have the information locally */
name|SVN_ERR
argument_list|(
name|mtcc_op_find
argument_list|(
operator|&
name|op
argument_list|,
name|NULL
argument_list|,
name|mpgb
operator|->
name|relpath
argument_list|,
name|mpgb
operator|->
name|mtcc
operator|->
name|root_op
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
condition|)
block|{
if|if
condition|(
name|mime_type
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|op
operator|->
name|prop_mods
operator|&&
name|i
operator|<
name|op
operator|->
name|prop_mods
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|svn_prop_t
modifier|*
name|mod
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|op
operator|->
name|prop_mods
argument_list|,
name|i
argument_list|,
name|svn_prop_t
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|mod
operator|->
name|name
argument_list|,
name|SVN_PROP_MIME_TYPE
argument_list|)
condition|)
block|{
operator|*
name|mime_type
operator|=
name|svn_string_dup
argument_list|(
name|mod
operator|->
name|value
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|mime_type
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|stream
operator|&&
name|op
operator|->
name|src_stream
condition|)
block|{
name|svn_stream_mark_t
modifier|*
name|mark
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
comment|/* Is the source stream capable of being read multiple times? */
name|err
operator|=
name|svn_stream_mark
argument_list|(
name|op
operator|->
name|src_stream
argument_list|,
operator|&
name|mark
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|!=
name|SVN_ERR_STREAM_SEEK_NOT_SUPPORTED
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
name|err
operator|=
name|svn_stream_copy3
argument_list|(
name|svn_stream_disown
argument_list|(
name|op
operator|->
name|src_stream
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn_stream_disown
argument_list|(
name|stream
argument_list|,
name|pool
argument_list|)
argument_list|,
name|mpgb
operator|->
name|cancel_func
argument_list|,
name|mpgb
operator|->
name|cancel_baton
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_stream_seek
argument_list|(
name|op
operator|->
name|src_stream
argument_list|,
name|mark
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* else: ### Create tempfile? */
name|stream
operator|=
name|NULL
expr_stmt|;
comment|/* Stream is handled */
block|}
block|}
if|if
condition|(
operator|!
name|stream
operator|&&
operator|!
name|mime_type
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR
argument_list|(
name|mtcc_get_origin
argument_list|(
operator|&
name|origin_relpath
argument_list|,
operator|&
name|origin_rev
argument_list|,
name|mpgb
operator|->
name|relpath
argument_list|,
name|TRUE
argument_list|,
name|mpgb
operator|->
name|mtcc
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|origin_relpath
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Nothing to fetch at repository */
name|SVN_ERR
argument_list|(
name|svn_ra_get_file
argument_list|(
name|mpgb
operator|->
name|mtcc
operator|->
name|ra_session
argument_list|,
name|origin_relpath
argument_list|,
name|origin_rev
argument_list|,
name|stream
argument_list|,
name|NULL
argument_list|,
name|mime_type
condition|?
operator|&
name|props
else|:
name|NULL
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mime_type
operator|&&
name|props
condition|)
operator|*
name|mime_type
operator|=
name|svn_hash_gets
argument_list|(
name|props
argument_list|,
name|SVN_PROP_MIME_TYPE
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client__mtcc_add_propset
parameter_list|(
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|propname
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|propval
parameter_list|,
name|svn_boolean_t
name|skip_checks
parameter_list|,
name|svn_client__mtcc_t
modifier|*
name|mtcc
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|mtcc_op_t
modifier|*
name|op
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_prop_name_is_valid
argument_list|(
name|propname
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_CLIENT_PROPERTY_NAME
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Bad property name: '%s'"
argument_list|)
argument_list|,
name|propname
argument_list|)
return|;
if|if
condition|(
name|svn_prop_is_known_svn_rev_prop
argument_list|(
name|propname
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_CLIENT_PROPERTY_NAME
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Revision property '%s' not allowed "
literal|"in this context"
argument_list|)
argument_list|,
name|propname
argument_list|)
return|;
if|if
condition|(
name|svn_property_kind2
argument_list|(
name|propname
argument_list|)
operator|==
name|svn_prop_wc_kind
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_CLIENT_PROPERTY_NAME
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is a wcprop, thus not accessible "
literal|"to clients"
argument_list|)
argument_list|,
name|propname
argument_list|)
return|;
if|if
condition|(
operator|!
name|skip_checks
operator|&&
name|svn_prop_needs_translation
argument_list|(
name|propname
argument_list|)
condition|)
block|{
name|svn_string_t
modifier|*
name|translated_value
decl_stmt|;
name|SVN_ERR_W
argument_list|(
name|svn_subst_translate_string2
argument_list|(
operator|&
name|translated_value
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|propval
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Error normalizing property value"
argument_list|)
argument_list|)
expr_stmt|;
name|propval
operator|=
name|translated_value
expr_stmt|;
block|}
if|if
condition|(
name|propval
operator|&&
name|svn_prop_is_svn_prop
argument_list|(
name|propname
argument_list|)
condition|)
block|{
name|struct
name|mtcc_prop_get_baton
name|mpbg
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__mtcc_check_path
argument_list|(
operator|&
name|kind
argument_list|,
name|relpath
argument_list|,
name|FALSE
argument_list|,
name|mtcc
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|mpbg
operator|.
name|mtcc
operator|=
name|mtcc
expr_stmt|;
name|mpbg
operator|.
name|relpath
operator|=
name|relpath
expr_stmt|;
name|mpbg
operator|.
name|cancel_func
operator|=
name|mtcc
operator|->
name|ctx
operator|->
name|cancel_func
expr_stmt|;
name|mpbg
operator|.
name|cancel_baton
operator|=
name|mtcc
operator|->
name|ctx
operator|->
name|cancel_baton
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc_canonicalize_svn_prop
argument_list|(
operator|&
name|propval
argument_list|,
name|propname
argument_list|,
name|propval
argument_list|,
name|relpath
argument_list|,
name|kind
argument_list|,
name|skip_checks
argument_list|,
name|mtcc_prop_getter
argument_list|,
operator|&
name|mpbg
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SVN_PATH_IS_EMPTY
argument_list|(
name|relpath
argument_list|)
operator|&&
name|MTCC_UNMODIFIED
argument_list|(
name|mtcc
argument_list|)
condition|)
block|{
name|svn_node_kind_t
name|kind
decl_stmt|;
comment|/* Probing the node for an unmodified root will fix the node type to          a file if necessary */
name|SVN_ERR
argument_list|(
name|svn_client__mtcc_check_path
argument_list|(
operator|&
name|kind
argument_list|,
name|relpath
argument_list|,
name|FALSE
argument_list|,
name|mtcc
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|==
name|svn_node_none
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_ILLEGAL_TARGET
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't set properties at not existing '%s'"
argument_list|)
argument_list|,
name|relpath
argument_list|)
return|;
name|op
operator|=
name|mtcc
operator|->
name|root_op
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|mtcc_op_find
argument_list|(
operator|&
name|op
argument_list|,
name|NULL
argument_list|,
name|relpath
argument_list|,
name|mtcc
operator|->
name|root_op
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|op
condition|)
block|{
name|svn_node_kind_t
name|kind
decl_stmt|;
name|svn_boolean_t
name|created
decl_stmt|;
comment|/* ### TODO: Check if this node is within a newly copied directory,                        and update origin values accordingly */
name|SVN_ERR
argument_list|(
name|svn_client__mtcc_check_path
argument_list|(
operator|&
name|kind
argument_list|,
name|relpath
argument_list|,
name|FALSE
argument_list|,
name|mtcc
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|==
name|svn_node_none
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_ILLEGAL_TARGET
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't set properties at not existing '%s'"
argument_list|)
argument_list|,
name|relpath
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|mtcc_op_find
argument_list|(
operator|&
name|op
argument_list|,
operator|&
name|created
argument_list|,
name|relpath
argument_list|,
name|mtcc
operator|->
name|root_op
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
operator|(
name|kind
operator|!=
name|svn_node_dir
operator|)
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|op
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|op
operator|->
name|prop_mods
condition|)
name|op
operator|->
name|prop_mods
operator|=
name|apr_array_make
argument_list|(
name|mtcc
operator|->
name|pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_prop_t
argument_list|)
argument_list|)
expr_stmt|;
block|{
name|svn_prop_t
name|propchange
decl_stmt|;
name|propchange
operator|.
name|name
operator|=
name|apr_pstrdup
argument_list|(
name|mtcc
operator|->
name|pool
argument_list|,
name|propname
argument_list|)
expr_stmt|;
if|if
condition|(
name|propval
condition|)
name|propchange
operator|.
name|value
operator|=
name|svn_string_dup
argument_list|(
name|propval
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|)
expr_stmt|;
else|else
name|propchange
operator|.
name|value
operator|=
name|NULL
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|op
operator|->
name|prop_mods
argument_list|,
name|svn_prop_t
argument_list|)
operator|=
name|propchange
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client__mtcc_add_update_file
parameter_list|(
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_stream_t
modifier|*
name|src_stream
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|src_checksum
parameter_list|,
name|svn_stream_t
modifier|*
name|base_stream
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|base_checksum
parameter_list|,
name|svn_client__mtcc_t
modifier|*
name|mtcc
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|mtcc_op_t
modifier|*
name|op
decl_stmt|;
name|svn_boolean_t
name|created
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
operator|&&
name|src_stream
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__mtcc_check_path
argument_list|(
operator|&
name|kind
argument_list|,
name|relpath
argument_list|,
name|FALSE
argument_list|,
name|mtcc
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|!=
name|svn_node_file
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_FILE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't update '%s' because it is not a file"
argument_list|)
argument_list|,
name|relpath
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|mtcc_op_find
argument_list|(
operator|&
name|op
argument_list|,
operator|&
name|created
argument_list|,
name|relpath
argument_list|,
name|mtcc
operator|->
name|root_op
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|op
operator|||
operator|(
name|op
operator|->
name|kind
operator|!=
name|OP_OPEN_FILE
operator|&&
name|op
operator|->
name|kind
operator|!=
name|OP_ADD_FILE
operator|)
operator|||
operator|(
name|op
operator|->
name|src_stream
operator|!=
name|NULL
operator|)
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_ILLEGAL_TARGET
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't update file at '%s'"
argument_list|)
argument_list|,
name|relpath
argument_list|)
return|;
block|}
name|op
operator|->
name|src_stream
operator|=
name|src_stream
expr_stmt|;
name|op
operator|->
name|src_checksum
operator|=
name|src_checksum
condition|?
name|svn_checksum_dup
argument_list|(
name|src_checksum
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|)
else|:
name|NULL
expr_stmt|;
name|op
operator|->
name|base_stream
operator|=
name|base_stream
expr_stmt|;
name|op
operator|->
name|base_checksum
operator|=
name|base_checksum
condition|?
name|svn_checksum_dup
argument_list|(
name|base_checksum
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|)
else|:
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client__mtcc_check_path
parameter_list|(
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_boolean_t
name|check_repository
parameter_list|,
name|svn_client__mtcc_t
modifier|*
name|mtcc
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|origin_relpath
decl_stmt|;
name|svn_revnum_t
name|origin_rev
decl_stmt|;
name|mtcc_op_t
modifier|*
name|op
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_relpath_is_canonical
argument_list|(
name|relpath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SVN_PATH_IS_EMPTY
argument_list|(
name|relpath
argument_list|)
operator|&&
name|MTCC_UNMODIFIED
argument_list|(
name|mtcc
argument_list|)
operator|&&
operator|!
name|mtcc
operator|->
name|root_op
operator|->
name|performed_stat
condition|)
block|{
comment|/* We know nothing about the root. Perhaps it is a file? */
name|SVN_ERR
argument_list|(
name|svn_ra_check_path
argument_list|(
name|mtcc
operator|->
name|ra_session
argument_list|,
literal|""
argument_list|,
name|mtcc
operator|->
name|base_revision
argument_list|,
name|kind
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|mtcc
operator|->
name|root_op
operator|->
name|performed_stat
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|*
name|kind
operator|==
name|svn_node_file
condition|)
block|{
name|mtcc
operator|->
name|root_op
operator|->
name|kind
operator|=
name|OP_OPEN_FILE
expr_stmt|;
name|mtcc
operator|->
name|root_op
operator|->
name|children
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
name|SVN_ERR
argument_list|(
name|mtcc_op_find
argument_list|(
operator|&
name|op
argument_list|,
name|NULL
argument_list|,
name|relpath
argument_list|,
name|mtcc
operator|->
name|root_op
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|op
operator|||
operator|(
name|check_repository
operator|&&
operator|!
name|op
operator|->
name|performed_stat
operator|)
condition|)
block|{
name|SVN_ERR
argument_list|(
name|mtcc_get_origin
argument_list|(
operator|&
name|origin_relpath
argument_list|,
operator|&
name|origin_rev
argument_list|,
name|relpath
argument_list|,
name|TRUE
argument_list|,
name|mtcc
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|origin_relpath
condition|)
operator|*
name|kind
operator|=
name|svn_node_none
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_ra_check_path
argument_list|(
name|mtcc
operator|->
name|ra_session
argument_list|,
name|origin_relpath
argument_list|,
name|origin_rev
argument_list|,
name|kind
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|&&
operator|*
name|kind
operator|==
name|svn_node_dir
condition|)
block|{
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_OPEN_DIR
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_ADD_DIR
condition|)
name|op
operator|->
name|performed_stat
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_OPEN_FILE
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_ADD_FILE
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_FILE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't perform file operation "
literal|"on '%s' as it is not a file"
argument_list|)
argument_list|,
name|relpath
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|op
operator|&&
operator|*
name|kind
operator|==
name|svn_node_file
condition|)
block|{
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_OPEN_FILE
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_ADD_FILE
condition|)
name|op
operator|->
name|performed_stat
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_OPEN_DIR
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_ADD_DIR
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_DIRECTORY
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't perform directory operation "
literal|"on '%s' as it is not a directory"
argument_list|)
argument_list|,
name|relpath
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|op
operator|&&
operator|(
name|op
operator|->
name|kind
operator|==
name|OP_OPEN_DIR
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_OPEN_FILE
operator|)
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't open '%s' as it does not exist"
argument_list|)
argument_list|,
name|relpath
argument_list|)
return|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
comment|/* op != NULL */
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_OPEN_DIR
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_ADD_DIR
condition|)
block|{
operator|*
name|kind
operator|=
name|svn_node_dir
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
elseif|else
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_OPEN_FILE
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_ADD_FILE
condition|)
block|{
operator|*
name|kind
operator|=
name|svn_node_file
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
comment|/* No other kinds defined as delete is filtered */
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|commit_properties
parameter_list|(
specifier|const
name|svn_delta_editor_t
modifier|*
name|editor
parameter_list|,
specifier|const
name|mtcc_op_t
modifier|*
name|op
parameter_list|,
name|void
modifier|*
name|node_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
if|if
condition|(
operator|!
name|op
operator|->
name|prop_mods
operator|||
name|op
operator|->
name|prop_mods
operator|->
name|nelts
operator|==
literal|0
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|op
operator|->
name|prop_mods
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|svn_prop_t
modifier|*
name|mod
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|op
operator|->
name|prop_mods
argument_list|,
name|i
argument_list|,
name|svn_prop_t
argument_list|)
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_ADD_DIR
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_OPEN_DIR
condition|)
name|SVN_ERR
argument_list|(
name|editor
operator|->
name|change_dir_prop
argument_list|(
name|node_baton
argument_list|,
name|mod
operator|->
name|name
argument_list|,
name|mod
operator|->
name|value
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_ADD_FILE
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_OPEN_FILE
condition|)
name|SVN_ERR
argument_list|(
name|editor
operator|->
name|change_file_prop
argument_list|(
name|node_baton
argument_list|,
name|mod
operator|->
name|name
argument_list|,
name|mod
operator|->
name|value
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Handles updating a file to a delta editor and then closes it */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|commit_file
parameter_list|(
specifier|const
name|svn_delta_editor_t
modifier|*
name|editor
parameter_list|,
name|mtcc_op_t
modifier|*
name|op
parameter_list|,
name|void
modifier|*
name|file_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|session_url
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|text_checksum
init|=
name|NULL
decl_stmt|;
name|svn_checksum_t
modifier|*
name|src_checksum
init|=
name|op
operator|->
name|src_checksum
decl_stmt|;
name|SVN_ERR
argument_list|(
name|commit_properties
argument_list|(
name|editor
argument_list|,
name|op
argument_list|,
name|file_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|src_stream
condition|)
block|{
specifier|const
name|char
modifier|*
name|base_checksum
init|=
name|NULL
decl_stmt|;
name|apr_pool_t
modifier|*
name|txdelta_pool
init|=
name|scratch_pool
decl_stmt|;
name|svn_txdelta_window_handler_t
name|window_handler
decl_stmt|;
name|void
modifier|*
name|handler_baton
decl_stmt|;
name|svn_stream_t
modifier|*
name|src_stream
init|=
name|op
operator|->
name|src_stream
decl_stmt|;
if|if
condition|(
name|op
operator|->
name|base_checksum
operator|&&
name|op
operator|->
name|base_checksum
operator|->
name|kind
operator|==
name|svn_checksum_md5
condition|)
name|base_checksum
operator|=
name|svn_checksum_to_cstring
argument_list|(
name|op
operator|->
name|base_checksum
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* ### TODO: Future enhancement: Allocate in special pool and send                    files after the true edit operation, like a wc commit */
name|SVN_ERR
argument_list|(
name|editor
operator|->
name|apply_textdelta
argument_list|(
name|file_baton
argument_list|,
name|base_checksum
argument_list|,
name|txdelta_pool
argument_list|,
operator|&
name|window_handler
argument_list|,
operator|&
name|handler_baton
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|notify_func2
condition|)
block|{
name|svn_wc_notify_t
modifier|*
name|notify
decl_stmt|;
name|notify
operator|=
name|svn_wc_create_notify_url
argument_list|(
name|svn_path_url_add_component2
argument_list|(
name|session_url
argument_list|,
name|relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|svn_wc_notify_commit_postfix_txdelta
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|notify
operator|->
name|path
operator|=
name|relpath
expr_stmt|;
name|notify
operator|->
name|kind
operator|=
name|svn_node_file
expr_stmt|;
name|ctx
operator|->
name|notify_func2
argument_list|(
name|ctx
operator|->
name|notify_baton2
argument_list|,
name|notify
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|window_handler
operator|!=
name|svn_delta_noop_window_handler
condition|)
block|{
if|if
condition|(
operator|!
name|src_checksum
operator|||
name|src_checksum
operator|->
name|kind
operator|!=
name|svn_checksum_md5
condition|)
name|src_stream
operator|=
name|svn_stream_checksummed2
argument_list|(
name|src_stream
argument_list|,
operator|&
name|src_checksum
argument_list|,
name|NULL
argument_list|,
name|svn_checksum_md5
argument_list|,
name|TRUE
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|op
operator|->
name|base_stream
condition|)
name|SVN_ERR
argument_list|(
name|svn_txdelta_send_stream
argument_list|(
name|src_stream
argument_list|,
name|window_handler
argument_list|,
name|handler_baton
argument_list|,
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_txdelta_run
argument_list|(
name|op
operator|->
name|base_stream
argument_list|,
name|src_stream
argument_list|,
name|window_handler
argument_list|,
name|handler_baton
argument_list|,
name|svn_checksum_md5
argument_list|,
name|NULL
argument_list|,
name|ctx
operator|->
name|cancel_func
argument_list|,
name|ctx
operator|->
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_stream_close
argument_list|(
name|src_stream
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|base_stream
condition|)
name|SVN_ERR
argument_list|(
name|svn_stream_close
argument_list|(
name|op
operator|->
name|base_stream
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|src_checksum
operator|&&
name|src_checksum
operator|->
name|kind
operator|==
name|svn_checksum_md5
condition|)
name|text_checksum
operator|=
name|svn_checksum_to_cstring
argument_list|(
name|src_checksum
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|editor
operator|->
name|close_file
argument_list|(
name|file_baton
argument_list|,
name|text_checksum
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Handles updating a directory to a delta editor and then closes it */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|commit_directory
parameter_list|(
specifier|const
name|svn_delta_editor_t
modifier|*
name|editor
parameter_list|,
name|mtcc_op_t
modifier|*
name|op
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_revnum_t
name|base_rev
parameter_list|,
name|void
modifier|*
name|dir_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|session_url
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|commit_properties
argument_list|(
name|editor
argument_list|,
name|op
argument_list|,
name|dir_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|children
operator|&&
name|op
operator|->
name|children
operator|->
name|nelts
operator|>
literal|0
condition|)
block|{
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|op
operator|->
name|children
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|mtcc_op_t
modifier|*
name|cop
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_relpath
decl_stmt|;
name|void
modifier|*
name|child_baton
decl_stmt|;
name|cop
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|op
operator|->
name|children
argument_list|,
name|i
argument_list|,
name|mtcc_op_t
operator|*
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
name|ctx
operator|->
name|cancel_func
argument_list|(
name|ctx
operator|->
name|cancel_baton
argument_list|)
argument_list|)
expr_stmt|;
name|child_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|relpath
argument_list|,
name|cop
operator|->
name|name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cop
operator|->
name|kind
condition|)
block|{
case|case
name|OP_DELETE
case|:
name|SVN_ERR
argument_list|(
name|editor
operator|->
name|delete_entry
argument_list|(
name|child_relpath
argument_list|,
name|base_rev
argument_list|,
name|dir_baton
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_ADD_DIR
case|:
name|SVN_ERR
argument_list|(
name|editor
operator|->
name|add_directory
argument_list|(
name|child_relpath
argument_list|,
name|dir_baton
argument_list|,
name|cop
operator|->
name|src_relpath
condition|?
name|svn_path_url_add_component2
argument_list|(
name|session_url
argument_list|,
name|cop
operator|->
name|src_relpath
argument_list|,
name|iterpool
argument_list|)
else|:
name|NULL
argument_list|,
name|cop
operator|->
name|src_rev
argument_list|,
name|iterpool
argument_list|,
operator|&
name|child_baton
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|commit_directory
argument_list|(
name|editor
argument_list|,
name|cop
argument_list|,
name|child_relpath
argument_list|,
name|SVN_INVALID_REVNUM
argument_list|,
name|child_baton
argument_list|,
name|session_url
argument_list|,
name|ctx
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_OPEN_DIR
case|:
name|SVN_ERR
argument_list|(
name|editor
operator|->
name|open_directory
argument_list|(
name|child_relpath
argument_list|,
name|dir_baton
argument_list|,
name|base_rev
argument_list|,
name|iterpool
argument_list|,
operator|&
name|child_baton
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|commit_directory
argument_list|(
name|editor
argument_list|,
name|cop
argument_list|,
name|child_relpath
argument_list|,
name|base_rev
argument_list|,
name|child_baton
argument_list|,
name|session_url
argument_list|,
name|ctx
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_ADD_FILE
case|:
name|SVN_ERR
argument_list|(
name|editor
operator|->
name|add_file
argument_list|(
name|child_relpath
argument_list|,
name|dir_baton
argument_list|,
name|cop
operator|->
name|src_relpath
condition|?
name|svn_path_url_add_component2
argument_list|(
name|session_url
argument_list|,
name|cop
operator|->
name|src_relpath
argument_list|,
name|iterpool
argument_list|)
else|:
name|NULL
argument_list|,
name|cop
operator|->
name|src_rev
argument_list|,
name|iterpool
argument_list|,
operator|&
name|child_baton
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|commit_file
argument_list|(
name|editor
argument_list|,
name|cop
argument_list|,
name|child_baton
argument_list|,
name|session_url
argument_list|,
name|child_relpath
argument_list|,
name|ctx
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_OPEN_FILE
case|:
name|SVN_ERR
argument_list|(
name|editor
operator|->
name|open_file
argument_list|(
name|child_relpath
argument_list|,
name|dir_baton
argument_list|,
name|base_rev
argument_list|,
name|iterpool
argument_list|,
operator|&
name|child_baton
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|commit_file
argument_list|(
name|editor
argument_list|,
name|cop
argument_list|,
name|child_baton
argument_list|,
name|session_url
argument_list|,
name|child_relpath
argument_list|,
name|ctx
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
block|}
block|}
block|}
return|return
name|svn_error_trace
argument_list|(
name|editor
operator|->
name|close_directory
argument_list|(
name|dir_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Helper function to recursively create svn_client_commit_item3_t items    to provide to the log message callback */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|add_commit_items
parameter_list|(
name|mtcc_op_t
modifier|*
name|op
parameter_list|,
specifier|const
name|char
modifier|*
name|session_url
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|apr_array_header_t
modifier|*
name|commit_items
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
if|if
condition|(
operator|(
name|op
operator|->
name|kind
operator|!=
name|OP_OPEN_DIR
operator|&&
name|op
operator|->
name|kind
operator|!=
name|OP_OPEN_FILE
operator|)
operator|||
operator|(
name|op
operator|->
name|prop_mods
operator|&&
name|op
operator|->
name|prop_mods
operator|->
name|nelts
operator|)
operator|||
operator|(
name|op
operator|->
name|src_stream
operator|)
condition|)
block|{
name|svn_client_commit_item3_t
modifier|*
name|item
decl_stmt|;
name|item
operator|=
name|svn_client_commit_item3_create
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
name|item
operator|->
name|path
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_OPEN_DIR
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_ADD_DIR
condition|)
name|item
operator|->
name|kind
operator|=
name|svn_node_dir
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_OPEN_FILE
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_ADD_FILE
condition|)
name|item
operator|->
name|kind
operator|=
name|svn_node_file
expr_stmt|;
else|else
name|item
operator|->
name|kind
operator|=
name|svn_node_unknown
expr_stmt|;
name|item
operator|->
name|url
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|item
operator|->
name|session_relpath
operator|=
name|svn_uri_skip_ancestor
argument_list|(
name|session_url
argument_list|,
name|item
operator|->
name|url
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|src_relpath
condition|)
block|{
name|item
operator|->
name|copyfrom_url
operator|=
name|svn_path_url_add_component2
argument_list|(
name|session_url
argument_list|,
name|op
operator|->
name|src_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|item
operator|->
name|copyfrom_rev
operator|=
name|op
operator|->
name|src_rev
expr_stmt|;
name|item
operator|->
name|state_flags
operator||=
name|SVN_CLIENT_COMMIT_ITEM_IS_COPY
expr_stmt|;
block|}
else|else
name|item
operator|->
name|copyfrom_rev
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_ADD_DIR
operator|||
name|op
operator|->
name|kind
operator|==
name|OP_ADD_FILE
condition|)
name|item
operator|->
name|state_flags
operator|=
name|SVN_CLIENT_COMMIT_ITEM_ADD
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|->
name|kind
operator|==
name|OP_DELETE
condition|)
name|item
operator|->
name|state_flags
operator|=
name|SVN_CLIENT_COMMIT_ITEM_DELETE
expr_stmt|;
comment|/* else item->state_flags = 0; */
if|if
condition|(
name|op
operator|->
name|prop_mods
operator|&&
name|op
operator|->
name|prop_mods
operator|->
name|nelts
condition|)
name|item
operator|->
name|state_flags
operator||=
name|SVN_CLIENT_COMMIT_ITEM_PROP_MODS
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|src_stream
condition|)
name|item
operator|->
name|state_flags
operator||=
name|SVN_CLIENT_COMMIT_ITEM_TEXT_MODS
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|commit_items
argument_list|,
name|svn_client_commit_item3_t
operator|*
argument_list|)
operator|=
name|item
expr_stmt|;
block|}
if|if
condition|(
name|op
operator|->
name|children
operator|&&
name|op
operator|->
name|children
operator|->
name|nelts
condition|)
block|{
name|int
name|i
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|op
operator|->
name|children
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|mtcc_op_t
modifier|*
name|cop
decl_stmt|;
specifier|const
name|char
modifier|*
name|child_url
decl_stmt|;
name|cop
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|op
operator|->
name|children
argument_list|,
name|i
argument_list|,
name|mtcc_op_t
operator|*
argument_list|)
expr_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|child_url
operator|=
name|svn_path_url_add_component2
argument_list|(
name|url
argument_list|,
name|cop
operator|->
name|name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|add_commit_items
argument_list|(
name|cop
argument_list|,
name|session_url
argument_list|,
name|child_url
argument_list|,
name|commit_items
argument_list|,
name|result_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client__mtcc_commit
parameter_list|(
name|apr_hash_t
modifier|*
name|revprop_table
parameter_list|,
name|svn_commit_callback2_t
name|commit_callback
parameter_list|,
name|void
modifier|*
name|commit_baton
parameter_list|,
name|svn_client__mtcc_t
modifier|*
name|mtcc
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|svn_delta_editor_t
modifier|*
name|editor
decl_stmt|;
name|void
modifier|*
name|edit_baton
decl_stmt|;
name|void
modifier|*
name|root_baton
decl_stmt|;
name|apr_hash_t
modifier|*
name|commit_revprops
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
specifier|const
name|char
modifier|*
name|session_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|log_msg
decl_stmt|;
if|if
condition|(
name|MTCC_UNMODIFIED
argument_list|(
name|mtcc
argument_list|)
condition|)
block|{
comment|/* No changes -> no revision. Easy out */
name|svn_pool_destroy
argument_list|(
name|mtcc
operator|->
name|pool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_ra_get_session_url
argument_list|(
name|mtcc
operator|->
name|ra_session
argument_list|,
operator|&
name|session_url
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtcc
operator|->
name|root_op
operator|->
name|kind
operator|!=
name|OP_OPEN_DIR
condition|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|svn_uri_split
argument_list|(
operator|&
name|session_url
argument_list|,
operator|&
name|name
argument_list|,
name|session_url
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|name
condition|)
block|{
name|SVN_ERR
argument_list|(
name|mtcc_reparent
argument_list|(
name|session_url
argument_list|,
name|mtcc
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_reparent
argument_list|(
name|mtcc
operator|->
name|ra_session
argument_list|,
name|session_url
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Create new commit items and add them to the array. */
if|if
condition|(
name|SVN_CLIENT__HAS_LOG_MSG_FUNC
argument_list|(
name|mtcc
operator|->
name|ctx
argument_list|)
condition|)
block|{
name|svn_client_commit_item3_t
modifier|*
name|item
decl_stmt|;
specifier|const
name|char
modifier|*
name|tmp_file
decl_stmt|;
name|apr_array_header_t
modifier|*
name|commit_items
init|=
name|apr_array_make
argument_list|(
name|scratch_pool
argument_list|,
literal|32
argument_list|,
sizeof|sizeof
argument_list|(
name|item
argument_list|)
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|add_commit_items
argument_list|(
name|mtcc
operator|->
name|root_op
argument_list|,
name|session_url
argument_list|,
name|session_url
argument_list|,
name|commit_items
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__get_log_msg
argument_list|(
operator|&
name|log_msg
argument_list|,
operator|&
name|tmp_file
argument_list|,
name|commit_items
argument_list|,
name|mtcc
operator|->
name|ctx
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|log_msg
condition|)
return|return
name|SVN_NO_ERROR
return|;
block|}
else|else
name|log_msg
operator|=
literal|""
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__ensure_revprop_table
argument_list|(
operator|&
name|commit_revprops
argument_list|,
name|revprop_table
argument_list|,
name|log_msg
argument_list|,
name|mtcc
operator|->
name|ctx
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Ugly corner case: The ra session might have died while we were waiting      for the callback */
name|err
operator|=
name|svn_ra_check_path
argument_list|(
name|mtcc
operator|->
name|ra_session
argument_list|,
literal|""
argument_list|,
name|mtcc
operator|->
name|base_revision
argument_list|,
operator|&
name|kind
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|svn_error_t
modifier|*
name|err2
init|=
name|svn_client_open_ra_session2
argument_list|(
operator|&
name|mtcc
operator|->
name|ra_session
argument_list|,
name|session_url
argument_list|,
name|NULL
argument_list|,
name|mtcc
operator|->
name|ctx
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|err2
condition|)
block|{
name|svn_pool_destroy
argument_list|(
name|mtcc
operator|->
name|pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|err2
argument_list|)
argument_list|)
return|;
block|}
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_check_path
argument_list|(
name|mtcc
operator|->
name|ra_session
argument_list|,
literal|""
argument_list|,
name|mtcc
operator|->
name|base_revision
argument_list|,
operator|&
name|kind
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|kind
operator|!=
name|svn_node_dir
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_DIRECTORY
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't commit to '%s' because it "
literal|"is not a directory"
argument_list|)
argument_list|,
name|session_url
argument_list|)
return|;
comment|/* Beware that the editor object must not live longer than the MTCC.      Otherwise, txn objects etc. in EDITOR may live longer than their      respective FS objects.  So, we can't use SCRATCH_POOL here. */
name|SVN_ERR
argument_list|(
name|svn_ra_get_commit_editor3
argument_list|(
name|mtcc
operator|->
name|ra_session
argument_list|,
operator|&
name|editor
argument_list|,
operator|&
name|edit_baton
argument_list|,
name|commit_revprops
argument_list|,
name|commit_callback
argument_list|,
name|commit_baton
argument_list|,
name|NULL
comment|/* lock_tokens */
argument_list|,
name|FALSE
comment|/* keep_locks */
argument_list|,
name|mtcc
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|editor
operator|->
name|open_root
argument_list|(
name|edit_baton
argument_list|,
name|mtcc
operator|->
name|base_revision
argument_list|,
name|scratch_pool
argument_list|,
operator|&
name|root_baton
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|commit_directory
argument_list|(
name|editor
argument_list|,
name|mtcc
operator|->
name|root_op
argument_list|,
literal|""
argument_list|,
name|mtcc
operator|->
name|base_revision
argument_list|,
name|root_baton
argument_list|,
name|session_url
argument_list|,
name|mtcc
operator|->
name|ctx
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
if|if
condition|(
name|mtcc
operator|->
name|ctx
operator|->
name|notify_func2
condition|)
block|{
name|svn_wc_notify_t
modifier|*
name|notify
decl_stmt|;
name|notify
operator|=
name|svn_wc_create_notify_url
argument_list|(
name|session_url
argument_list|,
name|svn_wc_notify_commit_finalizing
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|mtcc
operator|->
name|ctx
operator|->
name|notify_func2
argument_list|(
name|mtcc
operator|->
name|ctx
operator|->
name|notify_baton2
argument_list|,
name|notify
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|editor
operator|->
name|close_edit
argument_list|(
name|edit_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|err
operator|=
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|editor
operator|->
name|abort_edit
argument_list|(
name|edit_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|mtcc
operator|->
name|pool
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

end_unit


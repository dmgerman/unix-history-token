begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * fs_loader.c:  Front-end to the various FS back ends  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_escape
end_escape

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<apr.h>
end_include

begin_include
include|#
directive|include
file|<apr_atomic.h>
end_include

begin_include
include|#
directive|include
file|<apr_hash.h>
end_include

begin_include
include|#
directive|include
file|<apr_md5.h>
end_include

begin_include
include|#
directive|include
file|<apr_thread_mutex.h>
end_include

begin_include
include|#
directive|include
file|<apr_uuid.h>
end_include

begin_include
include|#
directive|include
file|<apr_strings.h>
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_ctype.h"
end_include

begin_include
include|#
directive|include
file|"svn_types.h"
end_include

begin_include
include|#
directive|include
file|"svn_dso.h"
end_include

begin_include
include|#
directive|include
file|"svn_version.h"
end_include

begin_include
include|#
directive|include
file|"svn_fs.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"svn_xml.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_string.h"
end_include

begin_include
include|#
directive|include
file|"svn_sorts.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_atomic.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_fs_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_fs_util.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_utf_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_mutex.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_subr_private.h"
end_include

begin_include
include|#
directive|include
file|"fs-loader.h"
end_include

begin_comment
comment|/* This is defined by configure on platforms which use configure, but    we need to define a fallback for Windows. */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|DEFAULT_FS_TYPE
end_ifndef

begin_define
define|#
directive|define
name|DEFAULT_FS_TYPE
value|"fsfs"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|FS_TYPE_FILENAME
value|"fs-type"
end_define

begin_comment
comment|/* A pool common to all FS objects.  See the documentation on the    open/create functions in fs-loader.h and for svn_fs_initialize(). */
end_comment

begin_decl_stmt
specifier|static
name|apr_pool_t
modifier|*
name|common_pool
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|svn_mutex__t
modifier|*
name|common_pool_lock
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|svn_atomic_t
name|common_pool_initialized
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/* --- Utility functions for the loader --- */
end_comment

begin_struct
struct|struct
name|fs_type_defn
block|{
specifier|const
name|char
modifier|*
name|fs_type
decl_stmt|;
specifier|const
name|char
modifier|*
name|fsap_name
decl_stmt|;
name|fs_init_func_t
name|initfunc
decl_stmt|;
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
name|struct
name|fs_type_defn
modifier|*
name|next
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|fs_type_defn
name|base_defn
init|=
block|{
name|SVN_FS_TYPE_BDB
block|,
literal|"base"
block|,
ifdef|#
directive|ifdef
name|SVN_LIBSVN_FS_LINKS_FS_BASE
name|svn_fs_base__init
block|,
else|#
directive|else
name|NULL
block|,
endif|#
directive|endif
name|NULL
block|,
name|NULL
comment|/* End of static list: this needs to be reset to NULL if the             common_pool used when setting it has been cleared. */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|fs_type_defn
name|fsx_defn
init|=
block|{
name|SVN_FS_TYPE_FSX
block|,
literal|"x"
block|,
ifdef|#
directive|ifdef
name|SVN_LIBSVN_FS_LINKS_FS_X
name|svn_fs_x__init
block|,
else|#
directive|else
name|NULL
block|,
endif|#
directive|endif
name|NULL
block|,
operator|&
name|base_defn
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|fs_type_defn
name|fsfs_defn
init|=
block|{
name|SVN_FS_TYPE_FSFS
block|,
literal|"fs"
block|,
ifdef|#
directive|ifdef
name|SVN_LIBSVN_FS_LINKS_FS_FS
name|svn_fs_fs__init
block|,
else|#
directive|else
name|NULL
block|,
endif|#
directive|endif
name|NULL
block|,
operator|&
name|fsx_defn
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|fs_type_defn
modifier|*
name|fs_modules
init|=
operator|&
name|fsfs_defn
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|svn_error_t
modifier|*
name|load_module
parameter_list|(
name|fs_init_func_t
modifier|*
name|initfunc
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
operator|*
name|initfunc
operator|=
name|NULL
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SVN_USE_DSO
argument_list|)
operator|&&
name|APR_HAS_DSO
block|{
name|apr_dso_handle_t
modifier|*
name|dso
decl_stmt|;
name|apr_dso_handle_sym_t
name|symbol
decl_stmt|;
specifier|const
name|char
modifier|*
name|libname
decl_stmt|;
specifier|const
name|char
modifier|*
name|funcname
decl_stmt|;
name|apr_status_t
name|status
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
comment|/* Demand a simple alphanumeric name so that the generated DSO        name is sensible. */
for|for
control|(
name|p
operator|=
name|name
init|;
operator|*
name|p
condition|;
operator|++
name|p
control|)
if|if
condition|(
operator|!
name|svn_ctype_isalnum
argument_list|(
operator|*
name|p
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_UNKNOWN_FS_TYPE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Invalid name for FS type '%s'"
argument_list|)
argument_list|,
name|name
argument_list|)
return|;
name|libname
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"libsvn_fs_%s-%d.so.%d"
argument_list|,
name|name
argument_list|,
name|SVN_VER_MAJOR
argument_list|,
name|SVN_SOVERSION
argument_list|)
expr_stmt|;
name|funcname
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"svn_fs_%s__init"
argument_list|,
name|name
argument_list|)
expr_stmt|;
comment|/* Find/load the specified library.  If we get an error, assume        the library doesn't exist.  The library will be unloaded when        pool is destroyed. */
name|SVN_ERR
argument_list|(
name|svn_dso_load
argument_list|(
operator|&
name|dso
argument_list|,
name|libname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dso
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* find the initialization routine */
name|status
operator|=
name|apr_dso_sym
argument_list|(
operator|&
name|symbol
argument_list|,
name|dso
argument_list|,
name|funcname
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
return|return
name|svn_error_wrap_apr
argument_list|(
name|status
argument_list|,
name|_
argument_list|(
literal|"'%s' does not define '%s()'"
argument_list|)
argument_list|,
name|libname
argument_list|,
name|funcname
argument_list|)
return|;
operator|*
name|initfunc
operator|=
operator|(
name|fs_init_func_t
operator|)
name|symbol
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* APR_HAS_DSO */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Fetch a library vtable by a pointer into the library definitions array. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_library_vtable_direct
parameter_list|(
name|fs_library_vtable_t
modifier|*
modifier|*
name|vtable
parameter_list|,
name|struct
name|fs_type_defn
modifier|*
name|fst
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_init_func_t
name|initfunc
init|=
name|NULL
decl_stmt|;
specifier|const
name|svn_version_t
modifier|*
name|my_version
init|=
name|svn_fs_version
argument_list|()
decl_stmt|;
specifier|const
name|svn_version_t
modifier|*
name|fs_version
decl_stmt|;
comment|/* most times, we get lucky */
operator|*
name|vtable
operator|=
name|apr_atomic_casptr
argument_list|(
operator|(
specifier|volatile
name|void
operator|*
operator|*
operator|)
operator|&
name|fst
operator|->
name|vtable
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|vtable
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* o.k. the first access needs to actually load the module, find the      vtable and check for version compatibility. */
name|initfunc
operator|=
name|fst
operator|->
name|initfunc
expr_stmt|;
if|if
condition|(
operator|!
name|initfunc
condition|)
name|SVN_ERR
argument_list|(
name|load_module
argument_list|(
operator|&
name|initfunc
argument_list|,
name|fst
operator|->
name|fsap_name
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|initfunc
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_UNKNOWN_FS_TYPE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Failed to load module for FS type '%s'"
argument_list|)
argument_list|,
name|fst
operator|->
name|fs_type
argument_list|)
return|;
block|{
comment|/* Per our API compatibility rules, we cannot ensure that        svn_fs_initialize is called by the application.  If not, we        cannot create the common pool and lock in a thread-safe fashion,        nor can we clean up the common pool if libsvn_fs is dynamically        unloaded.  This function makes a best effort by creating the        common pool as a child of the global pool; the window of failure        due to thread collision is small. */
name|SVN_ERR
argument_list|(
name|svn_fs_initialize
argument_list|(
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Invoke the FS module's initfunc function with the common        pool protected by a lock. */
name|SVN_MUTEX__WITH_LOCK
argument_list|(
name|common_pool_lock
argument_list|,
name|initfunc
argument_list|(
name|my_version
argument_list|,
name|vtable
argument_list|,
name|common_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fs_version
operator|=
operator|(
operator|*
name|vtable
operator|)
operator|->
name|get_version
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|svn_ver_equal
argument_list|(
name|my_version
argument_list|,
name|fs_version
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_VERSION_MISMATCH
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Mismatched FS module version for '%s':"
literal|" found %d.%d.%d%s,"
literal|" expected %d.%d.%d%s"
argument_list|)
argument_list|,
name|fst
operator|->
name|fs_type
argument_list|,
name|my_version
operator|->
name|major
argument_list|,
name|my_version
operator|->
name|minor
argument_list|,
name|my_version
operator|->
name|patch
argument_list|,
name|my_version
operator|->
name|tag
argument_list|,
name|fs_version
operator|->
name|major
argument_list|,
name|fs_version
operator|->
name|minor
argument_list|,
name|fs_version
operator|->
name|patch
argument_list|,
name|fs_version
operator|->
name|tag
argument_list|)
return|;
comment|/* the vtable will not change.  Remember it */
name|apr_atomic_casptr
argument_list|(
operator|(
specifier|volatile
name|void
operator|*
operator|*
operator|)
operator|&
name|fst
operator|->
name|vtable
argument_list|,
operator|*
name|vtable
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|SVN_USE_DSO
argument_list|)
operator|&&
name|APR_HAS_DSO
end_if

begin_comment
comment|/* Return *FST for the third party FS_TYPE */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_or_allocate_third
parameter_list|(
name|struct
name|fs_type_defn
modifier|*
modifier|*
name|fst
parameter_list|,
specifier|const
name|char
modifier|*
name|fs_type
parameter_list|)
block|{
while|while
condition|(
operator|*
name|fst
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|fs_type
argument_list|,
operator|(
operator|*
name|fst
operator|)
operator|->
name|fs_type
argument_list|)
operator|==
literal|0
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|fst
operator|=
operator|&
operator|(
operator|*
name|fst
operator|)
operator|->
name|next
expr_stmt|;
block|}
operator|*
name|fst
operator|=
name|apr_palloc
argument_list|(
name|common_pool
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|fs_type_defn
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|fst
operator|)
operator|->
name|fs_type
operator|=
name|apr_pstrdup
argument_list|(
name|common_pool
argument_list|,
name|fs_type
argument_list|)
expr_stmt|;
operator|(
operator|*
name|fst
operator|)
operator|->
name|fsap_name
operator|=
operator|(
operator|*
name|fst
operator|)
operator|->
name|fs_type
expr_stmt|;
operator|(
operator|*
name|fst
operator|)
operator|->
name|initfunc
operator|=
name|NULL
expr_stmt|;
operator|(
operator|*
name|fst
operator|)
operator|->
name|vtable
operator|=
name|NULL
expr_stmt|;
operator|(
operator|*
name|fst
operator|)
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Fetch a library *VTABLE by FS_TYPE.    Use POOL for temporary allocations. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_library_vtable
parameter_list|(
name|fs_library_vtable_t
modifier|*
modifier|*
name|vtable
parameter_list|,
specifier|const
name|char
modifier|*
name|fs_type
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|fs_type_defn
modifier|*
modifier|*
name|fst
decl_stmt|;
name|svn_boolean_t
name|known
init|=
name|FALSE
decl_stmt|;
comment|/* There are three FS module definitions known at compile time.  We      want to check these without any locking overhead even when      dynamic third party modules are enabled.  The third party modules      cannot be checked until the lock is held.  */
for|for
control|(
name|fst
operator|=
operator|&
name|fs_modules
init|;
operator|*
name|fst
condition|;
name|fst
operator|=
operator|&
operator|(
operator|*
name|fst
operator|)
operator|->
name|next
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|fs_type
argument_list|,
operator|(
operator|*
name|fst
operator|)
operator|->
name|fs_type
argument_list|)
operator|==
literal|0
condition|)
block|{
name|known
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
operator|*
name|fst
operator|)
operator|->
name|next
condition|)
block|{
break|break;
block|}
block|}
if|#
directive|if
name|defined
argument_list|(
name|SVN_USE_DSO
argument_list|)
operator|&&
name|APR_HAS_DSO
comment|/* Third party FS modules that are unknown at compile time.       A third party FS is identified by the file fs-type containing a      third party name, say "foo".  The loader will load the DSO with      the name "libsvn_fs_foo" and use the entry point with the name      "svn_fs_foo__init".       Note: the BDB and FSFS modules don't follow this naming scheme      and this allows them to be used to test the third party loader.      Change the content of fs-type to "base" in a BDB filesystem or to      "fs" in an FSFS filesystem and they will be loaded as third party      modules. */
if|if
condition|(
operator|!
name|known
condition|)
block|{
name|fst
operator|=
operator|&
operator|(
operator|*
name|fst
operator|)
operator|->
name|next
expr_stmt|;
comment|/* Best-effort init, see get_library_vtable_direct. */
name|SVN_ERR
argument_list|(
name|svn_fs_initialize
argument_list|(
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_MUTEX__WITH_LOCK
argument_list|(
name|common_pool_lock
argument_list|,
name|get_or_allocate_third
argument_list|(
name|fst
argument_list|,
name|fs_type
argument_list|)
argument_list|)
expr_stmt|;
name|known
operator|=
name|TRUE
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|!
name|known
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_UNKNOWN_FS_TYPE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Unknown FS type '%s'"
argument_list|)
argument_list|,
name|fs_type
argument_list|)
return|;
return|return
name|get_library_vtable_direct
argument_list|(
name|vtable
argument_list|,
operator|*
name|fst
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_type
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|fs_type
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|filename
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|apr_file_t
modifier|*
name|file
decl_stmt|;
name|apr_size_t
name|len
decl_stmt|;
comment|/* Read the fsap-name file to get the FSAP name, or assume the (old)      default.  For old repositories I suppose we could check some      other file, DB_CONFIG or strings say, but for now just check the      directory exists. */
name|filename
operator|=
name|svn_dirent_join
argument_list|(
name|path
argument_list|,
name|FS_TYPE_FILENAME
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_io_file_open
argument_list|(
operator|&
name|file
argument_list|,
name|filename
argument_list|,
name|APR_READ
operator||
name|APR_BUFFERED
argument_list|,
literal|0
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|APR_STATUS_IS_ENOENT
argument_list|(
name|err
operator|->
name|apr_err
argument_list|)
condition|)
block|{
name|svn_node_kind_t
name|kind
decl_stmt|;
name|svn_error_t
modifier|*
name|err2
init|=
name|svn_io_check_path
argument_list|(
name|path
argument_list|,
operator|&
name|kind
argument_list|,
name|pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|err2
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err2
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
if|if
condition|(
name|kind
operator|==
name|svn_node_dir
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
operator|*
name|fs_type
operator|=
name|SVN_FS_TYPE_BDB
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|err
return|;
block|}
elseif|else
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_read_length_line
argument_list|(
name|file
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_close
argument_list|(
name|file
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|fs_type
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Fetch the library vtable for an existing FS. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|fs_library_vtable
parameter_list|(
name|fs_library_vtable_t
modifier|*
modifier|*
name|vtable
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|fs_type
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_fs_type
argument_list|(
operator|&
name|fs_type
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Fetch the library vtable by name, now that we've chosen one. */
name|SVN_ERR
argument_list|(
name|get_library_vtable
argument_list|(
name|vtable
argument_list|,
name|fs_type
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_fs_type
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|fs_type
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|filename
decl_stmt|;
name|apr_file_t
modifier|*
name|file
decl_stmt|;
name|filename
operator|=
name|svn_dirent_join
argument_list|(
name|path
argument_list|,
name|FS_TYPE_FILENAME
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_open
argument_list|(
operator|&
name|file
argument_list|,
name|filename
argument_list|,
name|APR_WRITE
operator||
name|APR_CREATE
operator||
name|APR_TRUNCATE
operator||
name|APR_BUFFERED
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_write_full
argument_list|(
name|file
argument_list|,
name|fs_type
argument_list|,
name|strlen
argument_list|(
name|fs_type
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_write_full
argument_list|(
name|file
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_io_file_close
argument_list|(
name|file
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* --- Functions for operating on filesystems by pathname --- */
end_comment

begin_function
specifier|static
name|apr_status_t
name|uninit
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|common_pool
operator|=
name|NULL
expr_stmt|;
name|common_pool_lock
operator|=
name|NULL
expr_stmt|;
name|common_pool_initialized
operator|=
literal|0
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|synchronized_initialize
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|common_pool
operator|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|base_defn
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_mutex__init
argument_list|(
operator|&
name|common_pool_lock
argument_list|,
name|TRUE
argument_list|,
name|common_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### This won't work if POOL is NULL and libsvn_fs is loaded as a DSO      ### (via libsvn_ra_local say) since the global common_pool will live      ### longer than the DSO, which gets unloaded when the pool used to      ### load it is cleared, and so when the handler runs it will refer to      ### a function that no longer exists.  libsvn_ra_local attempts to      ### work around this by explicitly calling svn_fs_initialize. */
name|apr_pool_cleanup_register
argument_list|(
name|common_pool
argument_list|,
name|NULL
argument_list|,
name|uninit
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_initialize
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|SVN_USE_DSO
argument_list|)
operator|&&
name|APR_HAS_DSO
comment|/* Ensure that DSO subsystem is initialized early as possible if      we're going to use it. */
name|SVN_ERR
argument_list|(
name|svn_dso_initialize2
argument_list|()
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Protect against multiple calls. */
return|return
name|svn_error_trace
argument_list|(
name|svn_atomic__init_once
argument_list|(
operator|&
name|common_pool_initialized
argument_list|,
name|synchronized_initialize
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* A default warning handling function.  */
end_comment

begin_function
specifier|static
name|void
name|default_warning_func
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_error_t
modifier|*
name|err
parameter_list|)
block|{
comment|/* The one unforgiveable sin is to fail silently.  Dumping to stderr      or /dev/tty is not acceptable default behavior for server      processes, since those may both be equivalent to /dev/null.       That said, be a good citizen and print something anyway, in case it goes      somewhere, and our caller hasn't overridden the abort() call.    */
if|if
condition|(
name|svn_error_get_malfunction_handler
argument_list|()
operator|==
name|svn_error_abort_on_malfunction
condition|)
comment|/* ### TODO: extend the malfunction API such that non-abort()ing consumers        ### also get the information on ERR. */
name|svn_handle_error2
argument_list|(
name|err
argument_list|,
name|stderr
argument_list|,
name|FALSE
comment|/* fatal */
argument_list|,
literal|"svn: fs-loader: "
argument_list|)
expr_stmt|;
name|SVN_ERR_MALFUNCTION_NO_RETURN
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs__path_valid
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|char
modifier|*
name|c
decl_stmt|;
comment|/* UTF-8 encoded string without NULs. */
if|if
condition|(
operator|!
name|svn_utf__cstring_is_valid
argument_list|(
name|path
argument_list|)
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_PATH_SYNTAX
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Path '%s' is not in UTF-8"
argument_list|)
argument_list|,
name|path
argument_list|)
return|;
block|}
comment|/* No "." or ".." elements. */
if|if
condition|(
name|svn_path_is_backpath_present
argument_list|(
name|path
argument_list|)
operator|||
name|svn_path_is_dotpath_present
argument_list|(
name|path
argument_list|)
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_PATH_SYNTAX
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Path '%s' contains '.' or '..' element"
argument_list|)
argument_list|,
name|path
argument_list|)
return|;
block|}
comment|/* Raise an error if PATH contains a newline because svn:mergeinfo and      friends can't handle them.  Issue #4340 describes a similar problem      in the FSFS code itself.    */
name|c
operator|=
name|strchr
argument_list|(
name|path
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
condition|)
block|{
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_PATH_SYNTAX
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Invalid control character '0x%02x' in path '%s'"
argument_list|)
argument_list|,
operator|(
name|unsigned
name|char
operator|)
operator|*
name|c
argument_list|,
name|svn_path_illegal_path_escape
argument_list|(
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
comment|/* That's good enough. */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Allocate svn_fs_t structure. */
end_comment

begin_function
specifier|static
name|svn_fs_t
modifier|*
name|fs_new
parameter_list|(
name|apr_hash_t
modifier|*
name|fs_config
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_fs_t
modifier|*
name|fs
init|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fs
argument_list|)
argument_list|)
decl_stmt|;
name|fs
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
name|fs
operator|->
name|path
operator|=
name|NULL
expr_stmt|;
name|fs
operator|->
name|warning
operator|=
name|default_warning_func
expr_stmt|;
name|fs
operator|->
name|warning_baton
operator|=
name|NULL
expr_stmt|;
name|fs
operator|->
name|config
operator|=
name|fs_config
expr_stmt|;
name|fs
operator|->
name|access_ctx
operator|=
name|NULL
expr_stmt|;
name|fs
operator|->
name|vtable
operator|=
name|NULL
expr_stmt|;
name|fs
operator|->
name|fsap_data
operator|=
name|NULL
expr_stmt|;
name|fs
operator|->
name|uuid
operator|=
name|NULL
expr_stmt|;
return|return
name|fs
return|;
block|}
end_function

begin_function
name|svn_fs_t
modifier|*
name|svn_fs_new
parameter_list|(
name|apr_hash_t
modifier|*
name|fs_config
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|fs_new
argument_list|(
name|fs_config
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|svn_fs_set_warning_func
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_warning_callback_t
name|warning
parameter_list|,
name|void
modifier|*
name|warning_baton
parameter_list|)
block|{
name|fs
operator|->
name|warning
operator|=
name|warning
expr_stmt|;
name|fs
operator|->
name|warning_baton
operator|=
name|warning_baton
expr_stmt|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_create
parameter_list|(
name|svn_fs_t
modifier|*
modifier|*
name|fs_p
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_hash_t
modifier|*
name|fs_config
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
specifier|const
name|char
modifier|*
name|fs_type
init|=
name|svn_hash__get_cstring
argument_list|(
name|fs_config
argument_list|,
name|SVN_FS_CONFIG_FS_TYPE
argument_list|,
name|DEFAULT_FS_TYPE
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|get_library_vtable
argument_list|(
operator|&
name|vtable
argument_list|,
name|fs_type
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Create the FS directory and write out the fsap-name file. */
name|SVN_ERR
argument_list|(
name|svn_io_dir_make_sgid
argument_list|(
name|path
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_fs_type
argument_list|(
name|path
argument_list|,
name|fs_type
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Perform the actual creation. */
operator|*
name|fs_p
operator|=
name|fs_new
argument_list|(
name|fs_config
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|vtable
operator|->
name|create
argument_list|(
operator|*
name|fs_p
argument_list|,
name|path
argument_list|,
name|common_pool_lock
argument_list|,
name|pool
argument_list|,
name|common_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|vtable
operator|->
name|set_svn_fs_open
argument_list|(
operator|*
name|fs_p
argument_list|,
name|svn_fs_open2
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_open2
parameter_list|(
name|svn_fs_t
modifier|*
modifier|*
name|fs_p
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_hash_t
modifier|*
name|fs_config
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
name|SVN_ERR
argument_list|(
name|fs_library_vtable
argument_list|(
operator|&
name|vtable
argument_list|,
name|path
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|fs_p
operator|=
name|fs_new
argument_list|(
name|fs_config
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|vtable
operator|->
name|open_fs
argument_list|(
operator|*
name|fs_p
argument_list|,
name|path
argument_list|,
name|common_pool_lock
argument_list|,
name|scratch_pool
argument_list|,
name|common_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|vtable
operator|->
name|set_svn_fs_open
argument_list|(
operator|*
name|fs_p
argument_list|,
name|svn_fs_open2
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_open
parameter_list|(
name|svn_fs_t
modifier|*
modifier|*
name|fs_p
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_hash_t
modifier|*
name|fs_config
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_fs_open2
argument_list|(
name|fs_p
argument_list|,
name|path
argument_list|,
name|fs_config
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_upgrade2
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_fs_upgrade_notify_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
name|svn_fs_t
modifier|*
name|fs
decl_stmt|;
name|SVN_ERR
argument_list|(
name|fs_library_vtable
argument_list|(
operator|&
name|vtable
argument_list|,
name|path
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|fs
operator|=
name|fs_new
argument_list|(
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|vtable
operator|->
name|upgrade_fs
argument_list|(
name|fs
argument_list|,
name|path
argument_list|,
name|notify_func
argument_list|,
name|notify_baton
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|common_pool_lock
argument_list|,
name|scratch_pool
argument_list|,
name|common_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* A warning handling function that does not abort on errors,    but just lets them be returned normally.  */
end_comment

begin_function
specifier|static
name|void
name|verify_fs_warning_func
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_error_t
modifier|*
name|err
parameter_list|)
block|{ }
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_verify
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_hash_t
modifier|*
name|fs_config
parameter_list|,
name|svn_revnum_t
name|start
parameter_list|,
name|svn_revnum_t
name|end
parameter_list|,
name|svn_fs_progress_notify_func_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
name|svn_fs_t
modifier|*
name|fs
decl_stmt|;
name|SVN_ERR
argument_list|(
name|fs_library_vtable
argument_list|(
operator|&
name|vtable
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|fs
operator|=
name|fs_new
argument_list|(
name|fs_config
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|svn_fs_set_warning_func
argument_list|(
name|fs
argument_list|,
name|verify_fs_warning_func
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|vtable
operator|->
name|verify_fs
argument_list|(
name|fs
argument_list|,
name|path
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|notify_func
argument_list|,
name|notify_baton
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|common_pool_lock
argument_list|,
name|pool
argument_list|,
name|common_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_path
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|fs
operator|->
name|path
argument_list|)
return|;
block|}
end_function

begin_function
name|apr_hash_t
modifier|*
name|svn_fs_config
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
if|if
condition|(
name|fs
operator|->
name|config
condition|)
return|return
name|apr_hash_copy
argument_list|(
name|pool
argument_list|,
name|fs
operator|->
name|config
argument_list|)
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_delete_fs
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
name|SVN_ERR
argument_list|(
name|fs_library_vtable
argument_list|(
operator|&
name|vtable
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|vtable
operator|->
name|delete_fs
argument_list|(
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_hotcopy3
parameter_list|(
specifier|const
name|char
modifier|*
name|src_path
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_path
parameter_list|,
name|svn_boolean_t
name|clean
parameter_list|,
name|svn_boolean_t
name|incremental
parameter_list|,
name|svn_fs_hotcopy_notify_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
specifier|const
name|char
modifier|*
name|src_fs_type
decl_stmt|;
name|svn_fs_t
modifier|*
name|src_fs
decl_stmt|;
name|svn_fs_t
modifier|*
name|dst_fs
decl_stmt|;
specifier|const
name|char
modifier|*
name|dst_fs_type
decl_stmt|;
name|svn_node_kind_t
name|dst_kind
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|src_path
argument_list|,
name|dst_path
argument_list|)
operator|==
literal|0
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_INCORRECT_PARAMS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Hotcopy source and destination are equal"
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_fs_type
argument_list|(
operator|&
name|src_fs_type
argument_list|,
name|src_path
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|get_library_vtable
argument_list|(
operator|&
name|vtable
argument_list|,
name|src_fs_type
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|src_fs
operator|=
name|fs_new
argument_list|(
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|dst_fs
operator|=
name|fs_new
argument_list|(
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_check_path
argument_list|(
name|dst_path
argument_list|,
operator|&
name|dst_kind
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst_kind
operator|==
name|svn_node_file
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_NODE_UNEXPECTED_KIND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' already exists and is a file"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|dst_path
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|dst_kind
operator|==
name|svn_node_unknown
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_NODE_UNEXPECTED_KIND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' already exists and has an unknown "
literal|"node kind"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|dst_path
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|dst_kind
operator|==
name|svn_node_dir
condition|)
block|{
name|svn_node_kind_t
name|type_file_kind
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_check_path
argument_list|(
name|svn_dirent_join
argument_list|(
name|dst_path
argument_list|,
name|FS_TYPE_FILENAME
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
operator|&
name|type_file_kind
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|type_file_kind
operator|!=
name|svn_node_none
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_fs_type
argument_list|(
operator|&
name|dst_fs_type
argument_list|,
name|dst_path
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|src_fs_type
argument_list|,
name|dst_fs_type
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_ILLEGAL_TARGET
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The filesystem type of the hotcopy source "
literal|"('%s') does not match the filesystem "
literal|"type of the hotcopy destination ('%s')"
argument_list|)
argument_list|,
name|src_fs_type
argument_list|,
name|dst_fs_type
argument_list|)
return|;
block|}
block|}
name|SVN_ERR
argument_list|(
name|vtable
operator|->
name|hotcopy
argument_list|(
name|src_fs
argument_list|,
name|dst_fs
argument_list|,
name|src_path
argument_list|,
name|dst_path
argument_list|,
name|clean
argument_list|,
name|incremental
argument_list|,
name|notify_func
argument_list|,
name|notify_baton
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|common_pool_lock
argument_list|,
name|scratch_pool
argument_list|,
name|common_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|write_fs_type
argument_list|(
name|dst_path
argument_list|,
name|src_fs_type
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_pack
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_fs_pack_notify_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
name|svn_fs_t
modifier|*
name|fs
decl_stmt|;
name|SVN_ERR
argument_list|(
name|fs_library_vtable
argument_list|(
operator|&
name|vtable
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|fs
operator|=
name|fs_new
argument_list|(
name|NULL
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|vtable
operator|->
name|pack_fs
argument_list|(
name|fs
argument_list|,
name|path
argument_list|,
name|notify_func
argument_list|,
name|notify_baton
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|common_pool_lock
argument_list|,
name|pool
argument_list|,
name|common_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_recover
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
name|svn_fs_t
modifier|*
name|fs
decl_stmt|;
name|SVN_ERR
argument_list|(
name|fs_library_vtable
argument_list|(
operator|&
name|vtable
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|fs
operator|=
name|fs_new
argument_list|(
name|NULL
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|vtable
operator|->
name|open_fs_for_recovery
argument_list|(
name|fs
argument_list|,
name|path
argument_list|,
name|common_pool_lock
argument_list|,
name|pool
argument_list|,
name|common_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|vtable
operator|->
name|recover
argument_list|(
name|fs
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_verify_root
parameter_list|(
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_fs_t
modifier|*
name|fs
init|=
name|root
operator|->
name|fs
decl_stmt|;
name|SVN_ERR
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|verify_root
argument_list|(
name|root
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_freeze
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_freeze_func_t
name|freeze_func
parameter_list|,
name|void
modifier|*
name|freeze_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|freeze
argument_list|(
name|fs
argument_list|,
name|freeze_func
argument_list|,
name|freeze_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* --- Berkeley-specific functions --- */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_fs_create_berkeley
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
name|SVN_ERR
argument_list|(
name|get_library_vtable
argument_list|(
operator|&
name|vtable
argument_list|,
name|SVN_FS_TYPE_BDB
argument_list|,
name|fs
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Create the FS directory and write out the fsap-name file. */
name|SVN_ERR
argument_list|(
name|svn_io_dir_make_sgid
argument_list|(
name|path
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|fs
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|write_fs_type
argument_list|(
name|path
argument_list|,
name|SVN_FS_TYPE_BDB
argument_list|,
name|fs
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Perform the actual creation. */
name|SVN_ERR
argument_list|(
name|vtable
operator|->
name|create
argument_list|(
name|fs
argument_list|,
name|path
argument_list|,
name|common_pool_lock
argument_list|,
name|fs
operator|->
name|pool
argument_list|,
name|common_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|vtable
operator|->
name|set_svn_fs_open
argument_list|(
name|fs
argument_list|,
name|svn_fs_open2
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_open_berkeley
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
name|SVN_ERR
argument_list|(
name|fs_library_vtable
argument_list|(
operator|&
name|vtable
argument_list|,
name|path
argument_list|,
name|fs
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|vtable
operator|->
name|open_fs
argument_list|(
name|fs
argument_list|,
name|path
argument_list|,
name|common_pool_lock
argument_list|,
name|fs
operator|->
name|pool
argument_list|,
name|common_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|vtable
operator|->
name|set_svn_fs_open
argument_list|(
name|fs
argument_list|,
name|svn_fs_open2
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_berkeley_path
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_fs_path
argument_list|(
name|fs
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_delete_berkeley
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_fs_delete_fs
argument_list|(
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_hotcopy_berkeley
parameter_list|(
specifier|const
name|char
modifier|*
name|src_path
parameter_list|,
specifier|const
name|char
modifier|*
name|dest_path
parameter_list|,
name|svn_boolean_t
name|clean_logs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_fs_hotcopy3
argument_list|(
name|src_path
argument_list|,
name|dest_path
argument_list|,
name|clean_logs
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_berkeley_recover
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|svn_fs_recover
argument_list|(
name|path
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_set_berkeley_errcall
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|void
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|(
specifier|const
name|char
modifier|*
name|errpfx
parameter_list|,
name|char
modifier|*
name|msg
parameter_list|)
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|bdb_set_errcall
argument_list|(
name|fs
argument_list|,
name|handler
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_berkeley_logfiles
parameter_list|(
name|apr_array_header_t
modifier|*
modifier|*
name|logfiles
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_boolean_t
name|only_unused
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
name|SVN_ERR
argument_list|(
name|fs_library_vtable
argument_list|(
operator|&
name|vtable
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|vtable
operator|->
name|bdb_logfiles
argument_list|(
name|logfiles
argument_list|,
name|path
argument_list|,
name|only_unused
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* --- Transaction functions --- */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_fs_begin_txn2
parameter_list|(
name|svn_fs_txn_t
modifier|*
modifier|*
name|txn_p
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_uint32_t
name|flags
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|begin_txn
argument_list|(
name|txn_p
argument_list|,
name|fs
argument_list|,
name|rev
argument_list|,
name|flags
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_commit_txn
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|conflict_p
parameter_list|,
name|svn_revnum_t
modifier|*
name|new_rev
parameter_list|,
name|svn_fs_txn_t
modifier|*
name|txn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
operator|*
name|new_rev
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
if|if
condition|(
name|conflict_p
condition|)
operator|*
name|conflict_p
operator|=
name|NULL
expr_stmt|;
name|err
operator|=
name|txn
operator|->
name|vtable
operator|->
name|commit
argument_list|(
name|conflict_p
argument_list|,
name|new_rev
argument_list|,
name|txn
argument_list|,
name|pool
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SVN_DEBUG
comment|/* Check postconditions. */
if|if
condition|(
name|conflict_p
condition|)
block|{
name|SVN_ERR_ASSERT_E
argument_list|(
operator|!
operator|(
name|SVN_IS_VALID_REVNUM
argument_list|(
operator|*
name|new_rev
argument_list|)
operator|&&
operator|*
name|conflict_p
operator|!=
name|NULL
operator|)
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT_E
argument_list|(
operator|(
operator|*
name|conflict_p
operator|!=
name|NULL
operator|)
operator|==
operator|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_FS_CONFLICT
operator|)
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_abort_txn
parameter_list|(
name|svn_fs_txn_t
modifier|*
name|txn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|txn
operator|->
name|vtable
operator|->
name|abort
argument_list|(
name|txn
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_purge_txn
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|char
modifier|*
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|purge_txn
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_txn_name
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|name_p
parameter_list|,
name|svn_fs_txn_t
modifier|*
name|txn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
operator|*
name|name_p
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|txn
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_revnum_t
name|svn_fs_txn_base_revision
parameter_list|(
name|svn_fs_txn_t
modifier|*
name|txn
parameter_list|)
block|{
return|return
name|txn
operator|->
name|base_rev
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_open_txn
parameter_list|(
name|svn_fs_txn_t
modifier|*
modifier|*
name|txn
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|open_txn
argument_list|(
name|txn
argument_list|,
name|fs
argument_list|,
name|name
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_list_transactions
parameter_list|(
name|apr_array_header_t
modifier|*
modifier|*
name|names_p
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|list_transactions
argument_list|(
name|names_p
argument_list|,
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_boolean_t
name|is_internal_txn_prop
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|strcmp
argument_list|(
name|name
argument_list|,
name|SVN_FS__PROP_TXN_CHECK_LOCKS
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
name|SVN_FS__PROP_TXN_CHECK_OOD
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
name|SVN_FS__PROP_TXN_CLIENT_DATE
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_txn_prop
parameter_list|(
name|svn_string_t
modifier|*
modifier|*
name|value_p
parameter_list|,
name|svn_fs_txn_t
modifier|*
name|txn
parameter_list|,
specifier|const
name|char
modifier|*
name|propname
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
if|if
condition|(
name|is_internal_txn_prop
argument_list|(
name|propname
argument_list|)
condition|)
block|{
operator|*
name|value_p
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|svn_error_trace
argument_list|(
name|txn
operator|->
name|vtable
operator|->
name|get_prop
argument_list|(
name|value_p
argument_list|,
name|txn
argument_list|,
name|propname
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_txn_proplist
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|table_p
parameter_list|,
name|svn_fs_txn_t
modifier|*
name|txn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|txn
operator|->
name|vtable
operator|->
name|get_proplist
argument_list|(
name|table_p
argument_list|,
name|txn
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Don't give away internal transaction properties. */
name|svn_hash_sets
argument_list|(
operator|*
name|table_p
argument_list|,
name|SVN_FS__PROP_TXN_CHECK_LOCKS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
operator|*
name|table_p
argument_list|,
name|SVN_FS__PROP_TXN_CHECK_OOD
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
operator|*
name|table_p
argument_list|,
name|SVN_FS__PROP_TXN_CLIENT_DATE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_change_txn_prop
parameter_list|(
name|svn_fs_txn_t
modifier|*
name|txn
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|value
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
if|if
condition|(
name|is_internal_txn_prop
argument_list|(
name|name
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_INCORRECT_PARAMS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Attempt to modify internal transaction "
literal|"property '%s'"
argument_list|)
argument_list|,
name|name
argument_list|)
return|;
return|return
name|svn_error_trace
argument_list|(
name|txn
operator|->
name|vtable
operator|->
name|change_prop
argument_list|(
name|txn
argument_list|,
name|name
argument_list|,
name|value
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_change_txn_props
parameter_list|(
name|svn_fs_txn_t
modifier|*
name|txn
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|props
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|props
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
block|{
name|svn_prop_t
modifier|*
name|prop
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|props
argument_list|,
name|i
argument_list|,
name|svn_prop_t
argument_list|)
decl_stmt|;
if|if
condition|(
name|is_internal_txn_prop
argument_list|(
name|prop
operator|->
name|name
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_INCORRECT_PARAMS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Attempt to modify internal transaction "
literal|"property '%s'"
argument_list|)
argument_list|,
name|prop
operator|->
name|name
argument_list|)
return|;
block|}
return|return
name|svn_error_trace
argument_list|(
name|txn
operator|->
name|vtable
operator|->
name|change_props
argument_list|(
name|txn
argument_list|,
name|props
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* --- Root functions --- */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_fs_revision_root
parameter_list|(
name|svn_fs_root_t
modifier|*
modifier|*
name|root_p
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
comment|/* We create a subpool for each root object to allow us to implement      svn_fs_close_root.  */
name|apr_pool_t
modifier|*
name|subpool
init|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
decl_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|revision_root
argument_list|(
name|root_p
argument_list|,
name|fs
argument_list|,
name|rev
argument_list|,
name|subpool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_txn_root
parameter_list|(
name|svn_fs_root_t
modifier|*
modifier|*
name|root_p
parameter_list|,
name|svn_fs_txn_t
modifier|*
name|txn
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
comment|/* We create a subpool for each root object to allow us to implement      svn_fs_close_root.  */
name|apr_pool_t
modifier|*
name|subpool
init|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
decl_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|txn
operator|->
name|vtable
operator|->
name|root
argument_list|(
name|root_p
argument_list|,
name|txn
argument_list|,
name|subpool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|svn_fs_close_root
parameter_list|(
name|svn_fs_root_t
modifier|*
name|root
parameter_list|)
block|{
name|svn_pool_destroy
argument_list|(
name|root
operator|->
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|svn_fs_t
modifier|*
name|svn_fs_root_fs
parameter_list|(
name|svn_fs_root_t
modifier|*
name|root
parameter_list|)
block|{
return|return
name|root
operator|->
name|fs
return|;
block|}
end_function

begin_function
name|svn_boolean_t
name|svn_fs_is_txn_root
parameter_list|(
name|svn_fs_root_t
modifier|*
name|root
parameter_list|)
block|{
return|return
name|root
operator|->
name|is_txn_root
return|;
block|}
end_function

begin_function
name|svn_boolean_t
name|svn_fs_is_revision_root
parameter_list|(
name|svn_fs_root_t
modifier|*
name|root
parameter_list|)
block|{
return|return
operator|!
name|root
operator|->
name|is_txn_root
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_txn_root_name
parameter_list|(
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|root
operator|->
name|is_txn_root
condition|?
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|root
operator|->
name|txn
argument_list|)
else|:
name|NULL
return|;
block|}
end_function

begin_function
name|svn_revnum_t
name|svn_fs_txn_root_base_revision
parameter_list|(
name|svn_fs_root_t
modifier|*
name|root
parameter_list|)
block|{
return|return
name|root
operator|->
name|is_txn_root
condition|?
name|root
operator|->
name|rev
else|:
name|SVN_INVALID_REVNUM
return|;
block|}
end_function

begin_function
name|svn_revnum_t
name|svn_fs_revision_root_revision
parameter_list|(
name|svn_fs_root_t
modifier|*
name|root
parameter_list|)
block|{
return|return
name|root
operator|->
name|is_txn_root
condition|?
name|SVN_INVALID_REVNUM
else|:
name|root
operator|->
name|rev
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_paths_changed2
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|changed_paths_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|root
operator|->
name|vtable
operator|->
name|paths_changed
argument_list|(
name|changed_paths_p
argument_list|,
name|root
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_paths_changed
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|changed_paths_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|changed_paths_new_structs
decl_stmt|;
name|apr_hash_index_t
modifier|*
name|hi
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_fs_paths_changed2
argument_list|(
operator|&
name|changed_paths_new_structs
argument_list|,
name|root
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|changed_paths_p
operator|=
name|apr_hash_make
argument_list|(
name|pool
argument_list|)
expr_stmt|;
for|for
control|(
name|hi
operator|=
name|apr_hash_first
argument_list|(
name|pool
argument_list|,
name|changed_paths_new_structs
argument_list|)
init|;
name|hi
condition|;
name|hi
operator|=
name|apr_hash_next
argument_list|(
name|hi
argument_list|)
control|)
block|{
specifier|const
name|void
modifier|*
name|vkey
decl_stmt|;
name|apr_ssize_t
name|klen
decl_stmt|;
name|void
modifier|*
name|vval
decl_stmt|;
name|svn_fs_path_change2_t
modifier|*
name|val
decl_stmt|;
name|svn_fs_path_change_t
modifier|*
name|change
decl_stmt|;
name|apr_hash_this
argument_list|(
name|hi
argument_list|,
operator|&
name|vkey
argument_list|,
operator|&
name|klen
argument_list|,
operator|&
name|vval
argument_list|)
expr_stmt|;
name|val
operator|=
name|vval
expr_stmt|;
name|change
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|change
argument_list|)
argument_list|)
expr_stmt|;
name|change
operator|->
name|node_rev_id
operator|=
name|val
operator|->
name|node_rev_id
expr_stmt|;
name|change
operator|->
name|change_kind
operator|=
name|val
operator|->
name|change_kind
expr_stmt|;
name|change
operator|->
name|text_mod
operator|=
name|val
operator|->
name|text_mod
expr_stmt|;
name|change
operator|->
name|prop_mod
operator|=
name|val
operator|->
name|prop_mod
expr_stmt|;
name|apr_hash_set
argument_list|(
operator|*
name|changed_paths_p
argument_list|,
name|vkey
argument_list|,
name|klen
argument_list|,
name|change
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_check_path
parameter_list|(
name|svn_node_kind_t
modifier|*
name|kind_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|check_path
argument_list|(
name|kind_p
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_node_history2
parameter_list|(
name|svn_fs_history_t
modifier|*
modifier|*
name|history_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|node_history
argument_list|(
name|history_p
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_node_history
parameter_list|(
name|svn_fs_history_t
modifier|*
modifier|*
name|history_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|node_history
argument_list|(
name|history_p
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_is_dir
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_dir
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|check_path
argument_list|(
operator|&
name|kind
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|is_dir
operator|=
operator|(
name|kind
operator|==
name|svn_node_dir
operator|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_is_file
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_file
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|check_path
argument_list|(
operator|&
name|kind
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|is_file
operator|=
operator|(
name|kind
operator|==
name|svn_node_file
operator|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_node_id
parameter_list|(
specifier|const
name|svn_fs_id_t
modifier|*
modifier|*
name|id_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|node_id
argument_list|(
name|id_p
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_node_relation
parameter_list|(
name|svn_fs_node_relation_t
modifier|*
name|relation
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root_a
parameter_list|,
specifier|const
name|char
modifier|*
name|path_a
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root_b
parameter_list|,
specifier|const
name|char
modifier|*
name|path_b
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
comment|/* Different repository types? */
if|if
condition|(
name|root_a
operator|->
name|fs
operator|!=
name|root_b
operator|->
name|fs
condition|)
block|{
operator|*
name|relation
operator|=
name|svn_fs_node_unrelated
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|svn_error_trace
argument_list|(
name|root_a
operator|->
name|vtable
operator|->
name|node_relation
argument_list|(
name|relation
argument_list|,
name|root_a
argument_list|,
name|path_a
argument_list|,
name|root_b
argument_list|,
name|path_b
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_node_created_rev
parameter_list|(
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|node_created_rev
argument_list|(
name|revision
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_node_origin_rev
parameter_list|(
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|node_origin_rev
argument_list|(
name|revision
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_node_created_path
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|created_path
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|node_created_path
argument_list|(
name|created_path
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_node_prop
parameter_list|(
name|svn_string_t
modifier|*
modifier|*
name|value_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|propname
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|node_prop
argument_list|(
name|value_p
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|propname
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_node_proplist
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|table_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|node_proplist
argument_list|(
name|table_p
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_node_has_props
parameter_list|(
name|svn_boolean_t
modifier|*
name|has_props
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|node_has_props
argument_list|(
name|has_props
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_change_node_prop
parameter_list|(
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|value
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|change_node_prop
argument_list|(
name|root
argument_list|,
name|path
argument_list|,
name|name
argument_list|,
name|value
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_props_different
parameter_list|(
name|svn_boolean_t
modifier|*
name|changed_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root1
parameter_list|,
specifier|const
name|char
modifier|*
name|path1
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root2
parameter_list|,
specifier|const
name|char
modifier|*
name|path2
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root1
operator|->
name|vtable
operator|->
name|props_changed
argument_list|(
name|changed_p
argument_list|,
name|root1
argument_list|,
name|path1
argument_list|,
name|root2
argument_list|,
name|path2
argument_list|,
name|TRUE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_props_changed
parameter_list|(
name|svn_boolean_t
modifier|*
name|changed_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root1
parameter_list|,
specifier|const
name|char
modifier|*
name|path1
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root2
parameter_list|,
specifier|const
name|char
modifier|*
name|path2
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root1
operator|->
name|vtable
operator|->
name|props_changed
argument_list|(
name|changed_p
argument_list|,
name|root1
argument_list|,
name|path1
argument_list|,
name|root2
argument_list|,
name|path2
argument_list|,
name|FALSE
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_copied_from
parameter_list|(
name|svn_revnum_t
modifier|*
name|rev_p
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|path_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|copied_from
argument_list|(
name|rev_p
argument_list|,
name|path_p
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_closest_copy
parameter_list|(
name|svn_fs_root_t
modifier|*
modifier|*
name|root_p
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|path_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|closest_copy
argument_list|(
name|root_p
argument_list|,
name|path_p
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_get_mergeinfo2
parameter_list|(
name|svn_mergeinfo_catalog_t
modifier|*
name|catalog
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|paths
parameter_list|,
name|svn_mergeinfo_inheritance_t
name|inherit
parameter_list|,
name|svn_boolean_t
name|include_descendants
parameter_list|,
name|svn_boolean_t
name|adjust_inherited_mergeinfo
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|get_mergeinfo
argument_list|(
name|catalog
argument_list|,
name|root
argument_list|,
name|paths
argument_list|,
name|inherit
argument_list|,
name|include_descendants
argument_list|,
name|adjust_inherited_mergeinfo
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_get_mergeinfo
parameter_list|(
name|svn_mergeinfo_catalog_t
modifier|*
name|catalog
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|paths
parameter_list|,
name|svn_mergeinfo_inheritance_t
name|inherit
parameter_list|,
name|svn_boolean_t
name|include_descendants
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|get_mergeinfo
argument_list|(
name|catalog
argument_list|,
name|root
argument_list|,
name|paths
argument_list|,
name|inherit
argument_list|,
name|include_descendants
argument_list|,
name|TRUE
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs__get_mergeinfo_for_path
parameter_list|(
name|svn_mergeinfo_t
modifier|*
name|mergeinfo
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_mergeinfo_inheritance_t
name|inherit
parameter_list|,
name|svn_boolean_t
name|adjust_inherited_mergeinfo
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_array_header_t
modifier|*
name|paths
init|=
name|apr_array_make
argument_list|(
name|scratch_pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
decl_stmt|;
name|svn_mergeinfo_catalog_t
name|catalog
decl_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|paths
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
operator|=
name|path
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_fs_get_mergeinfo2
argument_list|(
operator|&
name|catalog
argument_list|,
name|root
argument_list|,
name|paths
argument_list|,
name|inherit
argument_list|,
name|FALSE
comment|/*include_descendants*/
argument_list|,
name|adjust_inherited_mergeinfo
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|mergeinfo
operator|=
name|svn_hash_gets
argument_list|(
name|catalog
argument_list|,
name|path
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_merge
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|conflict_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|source_root
parameter_list|,
specifier|const
name|char
modifier|*
name|source_path
parameter_list|,
name|svn_fs_root_t
modifier|*
name|target_root
parameter_list|,
specifier|const
name|char
modifier|*
name|target_path
parameter_list|,
name|svn_fs_root_t
modifier|*
name|ancestor_root
parameter_list|,
specifier|const
name|char
modifier|*
name|ancestor_path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|target_root
operator|->
name|vtable
operator|->
name|merge
argument_list|(
name|conflict_p
argument_list|,
name|source_root
argument_list|,
name|source_path
argument_list|,
name|target_root
argument_list|,
name|target_path
argument_list|,
name|ancestor_root
argument_list|,
name|ancestor_path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_dir_entries
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|entries_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|dir_entries
argument_list|(
name|entries_p
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_dir_optimal_order
parameter_list|(
name|apr_array_header_t
modifier|*
modifier|*
name|ordered_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
name|apr_hash_t
modifier|*
name|entries
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|dir_optimal_order
argument_list|(
name|ordered_p
argument_list|,
name|root
argument_list|,
name|entries
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_make_dir
parameter_list|(
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_fs__path_valid
argument_list|(
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|make_dir
argument_list|(
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_delete
parameter_list|(
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|delete_node
argument_list|(
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_copy
parameter_list|(
name|svn_fs_root_t
modifier|*
name|from_root
parameter_list|,
specifier|const
name|char
modifier|*
name|from_path
parameter_list|,
name|svn_fs_root_t
modifier|*
name|to_root
parameter_list|,
specifier|const
name|char
modifier|*
name|to_path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_fs__path_valid
argument_list|(
name|to_path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|to_root
operator|->
name|vtable
operator|->
name|copy
argument_list|(
name|from_root
argument_list|,
name|from_path
argument_list|,
name|to_root
argument_list|,
name|to_path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_revision_link
parameter_list|(
name|svn_fs_root_t
modifier|*
name|from_root
parameter_list|,
name|svn_fs_root_t
modifier|*
name|to_root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|to_root
operator|->
name|vtable
operator|->
name|revision_link
argument_list|(
name|from_root
argument_list|,
name|to_root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_file_length
parameter_list|(
name|svn_filesize_t
modifier|*
name|length_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|file_length
argument_list|(
name|length_p
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_file_checksum
parameter_list|(
name|svn_checksum_t
modifier|*
modifier|*
name|checksum
parameter_list|,
name|svn_checksum_kind_t
name|kind
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_boolean_t
name|force
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|file_checksum
argument_list|(
name|checksum
argument_list|,
name|kind
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|force
operator|&&
operator|(
operator|*
name|checksum
operator|==
name|NULL
operator|||
operator|(
operator|*
name|checksum
operator|)
operator|->
name|kind
operator|!=
name|kind
operator|)
condition|)
block|{
name|svn_stream_t
modifier|*
name|contents
decl_stmt|,
modifier|*
name|checksum_contents
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_fs_file_contents
argument_list|(
operator|&
name|contents
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|checksum_contents
operator|=
name|svn_stream_checksummed2
argument_list|(
name|contents
argument_list|,
name|checksum
argument_list|,
name|NULL
argument_list|,
name|kind
argument_list|,
name|TRUE
argument_list|,
name|pool
argument_list|)
expr_stmt|;
comment|/* This will force a read of any remaining data (which is all of it in          this case) and dump the checksum into checksum->digest. */
name|SVN_ERR
argument_list|(
name|svn_stream_close
argument_list|(
name|checksum_contents
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_file_md5_checksum
parameter_list|(
name|unsigned
name|char
name|digest
index|[]
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_checksum_t
modifier|*
name|md5sum
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_fs_file_checksum
argument_list|(
operator|&
name|md5sum
argument_list|,
name|svn_checksum_md5
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|TRUE
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|digest
argument_list|,
name|md5sum
operator|->
name|digest
argument_list|,
name|APR_MD5_DIGESTSIZE
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_file_contents
parameter_list|(
name|svn_stream_t
modifier|*
modifier|*
name|contents
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|file_contents
argument_list|(
name|contents
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_try_process_file_contents
parameter_list|(
name|svn_boolean_t
modifier|*
name|success
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_fs_process_contents_func_t
name|processor
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
comment|/* if the FS doesn't implement this function, report a "failed" attempt */
if|if
condition|(
name|root
operator|->
name|vtable
operator|->
name|try_process_file_contents
operator|==
name|NULL
condition|)
block|{
operator|*
name|success
operator|=
name|FALSE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|try_process_file_contents
argument_list|(
name|success
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|processor
argument_list|,
name|baton
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_make_file
parameter_list|(
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_fs__path_valid
argument_list|(
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|make_file
argument_list|(
name|root
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_apply_textdelta
parameter_list|(
name|svn_txdelta_window_handler_t
modifier|*
name|contents_p
parameter_list|,
name|void
modifier|*
modifier|*
name|contents_baton_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|base_checksum
parameter_list|,
specifier|const
name|char
modifier|*
name|result_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_checksum_t
modifier|*
name|base
decl_stmt|,
modifier|*
name|result
decl_stmt|;
comment|/* TODO: If we ever rev this API, we should make the supplied checksums      svn_checksum_t structs. */
name|SVN_ERR
argument_list|(
name|svn_checksum_parse_hex
argument_list|(
operator|&
name|base
argument_list|,
name|svn_checksum_md5
argument_list|,
name|base_checksum
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_checksum_parse_hex
argument_list|(
operator|&
name|result
argument_list|,
name|svn_checksum_md5
argument_list|,
name|result_checksum
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|apply_textdelta
argument_list|(
name|contents_p
argument_list|,
name|contents_baton_p
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|base
argument_list|,
name|result
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_apply_text
parameter_list|(
name|svn_stream_t
modifier|*
modifier|*
name|contents_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|result_checksum
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_checksum_t
modifier|*
name|result
decl_stmt|;
comment|/* TODO: If we ever rev this API, we should make the supplied checksum an      svn_checksum_t struct. */
name|SVN_ERR
argument_list|(
name|svn_checksum_parse_hex
argument_list|(
operator|&
name|result
argument_list|,
name|svn_checksum_md5
argument_list|,
name|result_checksum
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|root
operator|->
name|vtable
operator|->
name|apply_text
argument_list|(
name|contents_p
argument_list|,
name|root
argument_list|,
name|path
argument_list|,
name|result
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_contents_different
parameter_list|(
name|svn_boolean_t
modifier|*
name|changed_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root1
parameter_list|,
specifier|const
name|char
modifier|*
name|path1
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root2
parameter_list|,
specifier|const
name|char
modifier|*
name|path2
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root1
operator|->
name|vtable
operator|->
name|contents_changed
argument_list|(
name|changed_p
argument_list|,
name|root1
argument_list|,
name|path1
argument_list|,
name|root2
argument_list|,
name|path2
argument_list|,
name|TRUE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_contents_changed
parameter_list|(
name|svn_boolean_t
modifier|*
name|changed_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root1
parameter_list|,
specifier|const
name|char
modifier|*
name|path1
parameter_list|,
name|svn_fs_root_t
modifier|*
name|root2
parameter_list|,
specifier|const
name|char
modifier|*
name|path2
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|root1
operator|->
name|vtable
operator|->
name|contents_changed
argument_list|(
name|changed_p
argument_list|,
name|root1
argument_list|,
name|path1
argument_list|,
name|root2
argument_list|,
name|path2
argument_list|,
name|FALSE
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_youngest_rev
parameter_list|(
name|svn_revnum_t
modifier|*
name|youngest_p
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|youngest_rev
argument_list|(
name|youngest_p
argument_list|,
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_info_format
parameter_list|(
name|int
modifier|*
name|fs_format
parameter_list|,
name|svn_version_t
modifier|*
modifier|*
name|supports_version
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|info_format
argument_list|(
name|fs_format
argument_list|,
name|supports_version
argument_list|,
name|fs
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_info_config_files
parameter_list|(
name|apr_array_header_t
modifier|*
modifier|*
name|files
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|info_config_files
argument_list|(
name|files
argument_list|,
name|fs
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_deltify_revision
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|deltify
argument_list|(
name|fs
argument_list|,
name|revision
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_revision_prop
parameter_list|(
name|svn_string_t
modifier|*
modifier|*
name|value_p
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|propname
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|revision_prop
argument_list|(
name|value_p
argument_list|,
name|fs
argument_list|,
name|rev
argument_list|,
name|propname
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_revision_proplist
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|table_p
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|revision_proplist
argument_list|(
name|table_p
argument_list|,
name|fs
argument_list|,
name|rev
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_change_rev_prop2
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
specifier|const
modifier|*
name|old_value_p
parameter_list|,
specifier|const
name|svn_string_t
modifier|*
name|value
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|change_rev_prop
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|name
argument_list|,
name|old_value_p
argument_list|,
name|value
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_get_file_delta_stream
parameter_list|(
name|svn_txdelta_stream_t
modifier|*
modifier|*
name|stream_p
parameter_list|,
name|svn_fs_root_t
modifier|*
name|source_root
parameter_list|,
specifier|const
name|char
modifier|*
name|source_path
parameter_list|,
name|svn_fs_root_t
modifier|*
name|target_root
parameter_list|,
specifier|const
name|char
modifier|*
name|target_path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|target_root
operator|->
name|vtable
operator|->
name|get_file_delta_stream
argument_list|(
name|stream_p
argument_list|,
name|source_root
argument_list|,
name|source_path
argument_list|,
name|target_root
argument_list|,
name|target_path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_get_uuid
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|uuid
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
comment|/* If you change this, consider changing svn_fs__identifier(). */
operator|*
name|uuid
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|fs
operator|->
name|uuid
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_set_uuid
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|char
modifier|*
name|uuid
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
if|if
condition|(
operator|!
name|uuid
condition|)
block|{
name|uuid
operator|=
name|svn_uuid_generate
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|apr_uuid_t
name|parsed_uuid
decl_stmt|;
name|apr_status_t
name|apr_err
init|=
name|apr_uuid_parse
argument_list|(
operator|&
name|parsed_uuid
argument_list|,
name|uuid
argument_list|)
decl_stmt|;
if|if
condition|(
name|apr_err
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_BAD_UUID
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Malformed UUID '%s'"
argument_list|)
argument_list|,
name|uuid
argument_list|)
return|;
block|}
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|set_uuid
argument_list|(
name|fs
argument_list|,
name|uuid
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_lock_many
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_hash_t
modifier|*
name|targets
parameter_list|,
specifier|const
name|char
modifier|*
name|comment
parameter_list|,
name|svn_boolean_t
name|is_dav_comment
parameter_list|,
name|apr_time_t
name|expiration_date
parameter_list|,
name|svn_boolean_t
name|steal_lock
parameter_list|,
name|svn_fs_lock_callback_t
name|lock_callback
parameter_list|,
name|void
modifier|*
name|lock_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_index_t
modifier|*
name|hi
decl_stmt|;
name|apr_hash_t
modifier|*
name|ok_targets
init|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|,
modifier|*
name|cb_err
init|=
name|SVN_NO_ERROR
decl_stmt|;
comment|/* Enforce that the comment be xml-escapable. */
if|if
condition|(
name|comment
condition|)
if|if
condition|(
operator|!
name|svn_xml_is_xml_safe
argument_list|(
name|comment
argument_list|,
name|strlen
argument_list|(
name|comment
argument_list|)
argument_list|)
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_XML_UNESCAPABLE_DATA
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Lock comment contains illegal characters"
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|expiration_date
operator|<
literal|0
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_INCORRECT_PARAMS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Negative expiration date passed to svn_fs_lock"
argument_list|)
argument_list|)
return|;
comment|/* Enforce that the token be an XML-safe URI. */
for|for
control|(
name|hi
operator|=
name|apr_hash_first
argument_list|(
name|scratch_pool
argument_list|,
name|targets
argument_list|)
init|;
name|hi
condition|;
name|hi
operator|=
name|apr_hash_next
argument_list|(
name|hi
argument_list|)
control|)
block|{
specifier|const
name|svn_fs_lock_target_t
modifier|*
name|target
init|=
name|apr_hash_this_val
argument_list|(
name|hi
argument_list|)
decl_stmt|;
name|err
operator|=
name|SVN_NO_ERROR
expr_stmt|;
if|if
condition|(
name|target
operator|->
name|token
condition|)
block|{
specifier|const
name|char
modifier|*
name|c
decl_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|target
operator|->
name|token
argument_list|,
literal|"opaquelocktoken:"
argument_list|,
literal|16
argument_list|)
condition|)
name|err
operator|=
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_BAD_LOCK_TOKEN
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Lock token URI '%s' has bad scheme; "
literal|"expected '%s'"
argument_list|)
argument_list|,
name|target
operator|->
name|token
argument_list|,
literal|"opaquelocktoken"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
for|for
control|(
name|c
operator|=
name|target
operator|->
name|token
init|;
operator|*
name|c
operator|&&
operator|!
name|err
condition|;
name|c
operator|++
control|)
if|if
condition|(
operator|!
name|svn_ctype_isascii
argument_list|(
operator|*
name|c
argument_list|)
operator|||
name|svn_ctype_iscntrl
argument_list|(
operator|*
name|c
argument_list|)
condition|)
name|err
operator|=
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_BAD_LOCK_TOKEN
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Lock token '%s' is not ASCII or is a "
literal|"control character at byte %u"
argument_list|)
argument_list|,
name|target
operator|->
name|token
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|c
operator|-
name|target
operator|->
name|token
argument_list|)
argument_list|)
expr_stmt|;
comment|/* strlen(token) == c - token. */
if|if
condition|(
operator|!
name|err
operator|&&
operator|!
name|svn_xml_is_xml_safe
argument_list|(
name|target
operator|->
name|token
argument_list|,
name|c
operator|-
name|target
operator|->
name|token
argument_list|)
condition|)
name|err
operator|=
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_BAD_LOCK_TOKEN
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Lock token URI '%s' is not XML-safe"
argument_list|)
argument_list|,
name|target
operator|->
name|token
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
operator|!
name|cb_err
operator|&&
name|lock_callback
condition|)
name|cb_err
operator|=
name|lock_callback
argument_list|(
name|lock_baton
argument_list|,
name|apr_hash_this_key
argument_list|(
name|hi
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|err
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
block|}
else|else
name|svn_hash_sets
argument_list|(
name|ok_targets
argument_list|,
name|apr_hash_this_key
argument_list|(
name|hi
argument_list|)
argument_list|,
name|target
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|apr_hash_count
argument_list|(
name|ok_targets
argument_list|)
condition|)
return|return
name|svn_error_trace
argument_list|(
name|cb_err
argument_list|)
return|;
name|err
operator|=
name|fs
operator|->
name|vtable
operator|->
name|lock
argument_list|(
name|fs
argument_list|,
name|ok_targets
argument_list|,
name|comment
argument_list|,
name|is_dav_comment
argument_list|,
name|expiration_date
argument_list|,
name|steal_lock
argument_list|,
name|lock_callback
argument_list|,
name|lock_baton
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|cb_err
condition|)
name|svn_error_compose
argument_list|(
name|err
argument_list|,
name|cb_err
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|cb_err
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_struct
struct|struct
name|lock_baton_t
block|{
specifier|const
name|svn_lock_t
modifier|*
name|lock
decl_stmt|;
name|svn_error_t
modifier|*
name|fs_err
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Implements svn_fs_lock_callback_t. Used by svn_fs_lock and    svn_fs_unlock to record the lock and error from svn_fs_lock_many    and svn_fs_unlock_many. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|lock_cb
parameter_list|(
name|void
modifier|*
name|lock_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|svn_lock_t
modifier|*
name|lock
parameter_list|,
name|svn_error_t
modifier|*
name|fs_err
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|lock_baton_t
modifier|*
name|b
init|=
name|lock_baton
decl_stmt|;
name|b
operator|->
name|lock
operator|=
name|lock
expr_stmt|;
name|b
operator|->
name|fs_err
operator|=
name|svn_error_dup
argument_list|(
name|fs_err
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_lock
parameter_list|(
name|svn_lock_t
modifier|*
modifier|*
name|lock
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
specifier|const
name|char
modifier|*
name|comment
parameter_list|,
name|svn_boolean_t
name|is_dav_comment
parameter_list|,
name|apr_time_t
name|expiration_date
parameter_list|,
name|svn_revnum_t
name|current_rev
parameter_list|,
name|svn_boolean_t
name|steal_lock
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|targets
init|=
name|apr_hash_make
argument_list|(
name|pool
argument_list|)
decl_stmt|;
name|svn_fs_lock_target_t
name|target
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|struct
name|lock_baton_t
name|baton
init|=
block|{
literal|0
block|}
decl_stmt|;
name|target
operator|.
name|token
operator|=
name|token
expr_stmt|;
name|target
operator|.
name|current_rev
operator|=
name|current_rev
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|targets
argument_list|,
name|path
argument_list|,
operator|&
name|target
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_fs_lock_many
argument_list|(
name|fs
argument_list|,
name|targets
argument_list|,
name|comment
argument_list|,
name|is_dav_comment
argument_list|,
name|expiration_date
argument_list|,
name|steal_lock
argument_list|,
name|lock_cb
argument_list|,
operator|&
name|baton
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|baton
operator|.
name|lock
condition|)
operator|*
name|lock
operator|=
operator|(
name|svn_lock_t
operator|*
operator|)
name|baton
operator|.
name|lock
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|baton
operator|.
name|fs_err
condition|)
name|svn_error_compose
argument_list|(
name|err
argument_list|,
name|baton
operator|.
name|fs_err
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|baton
operator|.
name|fs_err
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_generate_lock_token
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|token
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|generate_lock_token
argument_list|(
name|token
argument_list|,
name|fs
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_fs_lock_target_t
modifier|*
name|svn_fs_lock_target_create
parameter_list|(
specifier|const
name|char
modifier|*
name|token
parameter_list|,
name|svn_revnum_t
name|current_rev
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_fs_lock_target_t
modifier|*
name|target
init|=
name|apr_palloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_fs_lock_target_t
argument_list|)
argument_list|)
decl_stmt|;
name|target
operator|->
name|token
operator|=
name|token
expr_stmt|;
name|target
operator|->
name|current_rev
operator|=
name|current_rev
expr_stmt|;
return|return
name|target
return|;
block|}
end_function

begin_function
name|void
name|svn_fs_lock_target_set_token
parameter_list|(
name|svn_fs_lock_target_t
modifier|*
name|target
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|)
block|{
name|target
operator|->
name|token
operator|=
name|token
expr_stmt|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_unlock_many
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_hash_t
modifier|*
name|targets
parameter_list|,
name|svn_boolean_t
name|break_lock
parameter_list|,
name|svn_fs_lock_callback_t
name|lock_callback
parameter_list|,
name|void
modifier|*
name|lock_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|unlock
argument_list|(
name|fs
argument_list|,
name|targets
argument_list|,
name|break_lock
argument_list|,
name|lock_callback
argument_list|,
name|lock_baton
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_unlock
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|token
parameter_list|,
name|svn_boolean_t
name|break_lock
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|targets
init|=
name|apr_hash_make
argument_list|(
name|pool
argument_list|)
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|struct
name|lock_baton_t
name|baton
init|=
block|{
literal|0
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|token
condition|)
name|token
operator|=
literal|""
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|targets
argument_list|,
name|path
argument_list|,
name|token
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_fs_unlock_many
argument_list|(
name|fs
argument_list|,
name|targets
argument_list|,
name|break_lock
argument_list|,
name|lock_cb
argument_list|,
operator|&
name|baton
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|baton
operator|.
name|fs_err
condition|)
name|svn_error_compose
argument_list|(
name|err
argument_list|,
name|baton
operator|.
name|fs_err
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|baton
operator|.
name|fs_err
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_get_lock
parameter_list|(
name|svn_lock_t
modifier|*
modifier|*
name|lock
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|get_lock
argument_list|(
name|lock
argument_list|,
name|fs
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_get_locks2
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_fs_get_locks_callback_t
name|get_locks_func
parameter_list|,
name|void
modifier|*
name|get_locks_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|SVN_ERR_ASSERT
argument_list|(
operator|(
name|depth
operator|==
name|svn_depth_empty
operator|)
operator|||
operator|(
name|depth
operator|==
name|svn_depth_files
operator|)
operator|||
operator|(
name|depth
operator|==
name|svn_depth_immediates
operator|)
operator|||
operator|(
name|depth
operator|==
name|svn_depth_infinity
operator|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|get_locks
argument_list|(
name|fs
argument_list|,
name|path
argument_list|,
name|depth
argument_list|,
name|get_locks_func
argument_list|,
name|get_locks_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* --- History functions --- */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_fs_history_prev2
parameter_list|(
name|svn_fs_history_t
modifier|*
modifier|*
name|prev_history_p
parameter_list|,
name|svn_fs_history_t
modifier|*
name|history
parameter_list|,
name|svn_boolean_t
name|cross_copies
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|history
operator|->
name|vtable
operator|->
name|prev
argument_list|(
name|prev_history_p
argument_list|,
name|history
argument_list|,
name|cross_copies
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_history_prev
parameter_list|(
name|svn_fs_history_t
modifier|*
modifier|*
name|prev_history_p
parameter_list|,
name|svn_fs_history_t
modifier|*
name|history
parameter_list|,
name|svn_boolean_t
name|cross_copies
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|history
operator|->
name|vtable
operator|->
name|prev
argument_list|(
name|prev_history_p
argument_list|,
name|history
argument_list|,
name|cross_copies
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_history_location
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision
parameter_list|,
name|svn_fs_history_t
modifier|*
name|history
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|history
operator|->
name|vtable
operator|->
name|location
argument_list|(
name|path
argument_list|,
name|revision
argument_list|,
name|history
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* --- Node-ID functions --- */
end_comment

begin_function
name|svn_fs_id_t
modifier|*
name|svn_fs_parse_id
parameter_list|(
specifier|const
name|char
modifier|*
name|data
parameter_list|,
name|apr_size_t
name|len
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|err
operator|=
name|get_library_vtable
argument_list|(
operator|&
name|vtable
argument_list|,
name|SVN_FS_TYPE_BDB
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|vtable
operator|->
name|parse_id
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_string_t
modifier|*
name|svn_fs_unparse_id
parameter_list|(
specifier|const
name|svn_fs_id_t
modifier|*
name|id
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|id
operator|->
name|vtable
operator|->
name|unparse
argument_list|(
name|id
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_boolean_t
name|svn_fs_check_related
parameter_list|(
specifier|const
name|svn_fs_id_t
modifier|*
name|a
parameter_list|,
specifier|const
name|svn_fs_id_t
modifier|*
name|b
parameter_list|)
block|{
return|return
operator|(
name|a
operator|->
name|vtable
operator|->
name|compare
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
operator|!=
name|svn_fs_node_unrelated
operator|)
return|;
block|}
end_function

begin_function
name|int
name|svn_fs_compare_ids
parameter_list|(
specifier|const
name|svn_fs_id_t
modifier|*
name|a
parameter_list|,
specifier|const
name|svn_fs_id_t
modifier|*
name|b
parameter_list|)
block|{
switch|switch
condition|(
name|a
operator|->
name|vtable
operator|->
name|compare
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
condition|)
block|{
case|case
name|svn_fs_node_unchanged
case|:
return|return
literal|0
return|;
case|case
name|svn_fs_node_common_ancestor
case|:
return|return
literal|1
return|;
default|default:
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_print_modules
parameter_list|(
name|svn_stringbuf_t
modifier|*
name|output
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|fs_type_defn
modifier|*
name|defn
init|=
name|fs_modules
decl_stmt|;
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
decl_stmt|;
while|while
condition|(
name|defn
condition|)
block|{
name|char
modifier|*
name|line
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|err
operator|=
name|get_library_vtable_direct
argument_list|(
operator|&
name|vtable
argument_list|,
name|defn
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_FS_UNKNOWN_FS_TYPE
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|defn
operator|=
name|defn
operator|->
name|next
expr_stmt|;
continue|continue;
block|}
else|else
return|return
name|err
return|;
block|}
name|line
operator|=
name|apr_psprintf
argument_list|(
name|iterpool
argument_list|,
literal|"* fs_%s : %s\n"
argument_list|,
name|defn
operator|->
name|fsap_name
argument_list|,
name|vtable
operator|->
name|get_description
argument_list|()
argument_list|)
expr_stmt|;
name|svn_stringbuf_appendcstr
argument_list|(
name|output
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|defn
operator|=
name|defn
operator|->
name|next
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_fs_path_change2_t
modifier|*
name|svn_fs_path_change2_create
parameter_list|(
specifier|const
name|svn_fs_id_t
modifier|*
name|node_rev_id
parameter_list|,
name|svn_fs_path_change_kind_t
name|change_kind
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_fs__path_change_create_internal
argument_list|(
name|node_rev_id
argument_list|,
name|change_kind
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Return the library version number. */
end_comment

begin_function
specifier|const
name|svn_version_t
modifier|*
name|svn_fs_version
parameter_list|(
name|void
parameter_list|)
block|{
name|SVN_VERSION_BODY
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/** info **/
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_fs_info
parameter_list|(
specifier|const
name|svn_fs_info_placeholder_t
modifier|*
modifier|*
name|info_p
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
if|if
condition|(
name|fs
operator|->
name|vtable
operator|->
name|info_fsap
condition|)
block|{
name|SVN_ERR
argument_list|(
name|fs
operator|->
name|vtable
operator|->
name|info_fsap
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
name|info_p
argument_list|,
name|fs
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|svn_fs_info_placeholder_t
modifier|*
name|info
init|=
name|apr_palloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|info
argument_list|)
argument_list|)
decl_stmt|;
comment|/* ### Ask the disk(!), since svn_fs_t doesn't cache the answer. */
name|SVN_ERR
argument_list|(
name|svn_fs_type
argument_list|(
operator|&
name|info
operator|->
name|fs_type
argument_list|,
name|fs
operator|->
name|path
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|info_p
operator|=
name|info
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|svn_fs_info_dup
parameter_list|(
specifier|const
name|void
modifier|*
name|info_void
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|svn_fs_info_placeholder_t
modifier|*
name|info
init|=
name|info_void
decl_stmt|;
name|fs_library_vtable_t
modifier|*
name|vtable
decl_stmt|;
name|SVN_ERR
argument_list|(
name|get_library_vtable
argument_list|(
operator|&
name|vtable
argument_list|,
name|info
operator|->
name|fs_type
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vtable
operator|->
name|info_fsap_dup
condition|)
return|return
name|vtable
operator|->
name|info_fsap_dup
argument_list|(
name|info_void
argument_list|,
name|result_pool
argument_list|)
return|;
else|else
return|return
name|apr_pmemdup
argument_list|(
name|result_pool
argument_list|,
name|info
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|info
argument_list|)
argument_list|)
return|;
block|}
end_function

end_unit


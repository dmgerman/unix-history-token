begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* util.c --- utility functions for FSX repo access  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|"svn_ctype.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_string_private.h"
end_include

begin_include
include|#
directive|include
file|"fs_x.h"
end_include

begin_include
include|#
directive|include
file|"id.h"
end_include

begin_include
include|#
directive|include
file|"util.h"
end_include

begin_include
include|#
directive|include
file|"../libsvn_fs/fs-loader.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_comment
comment|/* Following are defines that specify the textual elements of the    native filesystem directories and revision files. */
end_comment

begin_comment
comment|/* Notes:  To avoid opening and closing the rev-files all the time, it would probably be advantageous to keep each rev-file open for the lifetime of the transaction object.  I'll leave that as a later optimization for now.  I didn't keep track of pool lifetimes at all in this code.  There are likely some errors because of that.  */
end_comment

begin_comment
comment|/* Pathname helper functions */
end_comment

begin_comment
comment|/* Return TRUE is REV is packed in FS, FALSE otherwise. */
end_comment

begin_function
name|svn_boolean_t
name|svn_fs_x__is_packed_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|svn_fs_x__data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
return|return
operator|(
name|rev
operator|<
name|ffd
operator|->
name|min_unpacked_rev
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Return TRUE is REV is packed in FS, FALSE otherwise. */
end_comment

begin_function
name|svn_boolean_t
name|svn_fs_x__is_packed_revprop
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|svn_fs_x__data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
comment|/* rev 0 will not be packed */
return|return
operator|(
name|rev
operator|<
name|ffd
operator|->
name|min_unpacked_rev
operator|)
operator|&&
operator|(
name|rev
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|svn_revnum_t
name|svn_fs_x__packed_base_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|svn_fs_x__data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
return|return
name|rev
operator|<
name|ffd
operator|->
name|min_unpacked_rev
condition|?
name|rev
operator|-
operator|(
name|rev
operator|%
name|ffd
operator|->
name|max_files_per_dir
operator|)
else|:
name|rev
return|;
block|}
end_function

begin_function
name|svn_revnum_t
name|svn_fs_x__pack_size
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|)
block|{
name|svn_fs_x__data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
return|return
name|rev
operator|<
name|ffd
operator|->
name|min_unpacked_rev
condition|?
name|ffd
operator|->
name|max_files_per_dir
else|:
literal|1
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_format
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_FORMAT
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_uuid
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_UUID
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_current
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_CURRENT
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_current
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_TXN_CURRENT
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_current_lock
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_TXN_CURRENT_LOCK
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_lock
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_LOCK_FILE
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_pack_lock
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_PACK_LOCK_FILE
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_revprop_generation
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_REVPROP_GENERATION
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Return the full path of the file FILENAME within revision REV's shard in  * FS.  If FILENAME is NULL, return the shard directory directory itself.  * REVPROPS indicates the parent of the shard parent folder ("revprops" or  * "revs").  PACKED says whether we want the packed shard's name.  *  * Allocate the result in RESULT_POOL.  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|construct_shard_sub_path
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|svn_boolean_t
name|revprops
parameter_list|,
name|svn_boolean_t
name|packed
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_fs_x__data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
name|char
name|buffer
index|[
name|SVN_INT64_BUFFER_SIZE
operator|+
sizeof|sizeof
argument_list|(
name|PATH_EXT_PACKED_SHARD
argument_list|)
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
comment|/* Select the appropriate parent path constant. */
specifier|const
name|char
modifier|*
name|parent
init|=
name|revprops
condition|?
name|PATH_REVPROPS_DIR
else|:
name|PATH_REVS_DIR
decl_stmt|;
comment|/* String containing the shard number. */
name|apr_size_t
name|len
init|=
name|svn__i64toa
argument_list|(
name|buffer
argument_list|,
name|rev
operator|/
name|ffd
operator|->
name|max_files_per_dir
argument_list|)
decl_stmt|;
comment|/* Append the suffix.  Limit it to the buffer size (should never hit it). */
if|if
condition|(
name|packed
condition|)
name|strncpy
argument_list|(
name|buffer
operator|+
name|len
argument_list|,
name|PATH_EXT_PACKED_SHARD
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
operator|-
name|len
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* This will also work for NULL FILENAME as well. */
return|return
name|svn_dirent_join_many
argument_list|(
name|result_pool
argument_list|,
name|fs
operator|->
name|path
argument_list|,
name|parent
argument_list|,
name|buffer
argument_list|,
name|filename
argument_list|,
name|SVN_VA_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_rev_packed
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|kind
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|assert
argument_list|(
name|svn_fs_x__is_packed_rev
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|construct_shard_sub_path
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|kind
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_rev_shard
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|construct_shard_sub_path
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|char
name|buffer
index|[
name|SVN_INT64_BUFFER_SIZE
index|]
decl_stmt|;
name|svn__i64toa
argument_list|(
name|buffer
argument_list|,
name|rev
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
name|svn_fs_x__is_packed_rev
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|construct_shard_sub_path
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|buffer
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_rev_absolute
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|svn_fs_x__is_packed_rev
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|)
condition|?
name|svn_fs_x__path_rev_packed
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|PATH_PACKED
argument_list|,
name|result_pool
argument_list|)
else|:
name|svn_fs_x__path_rev
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_revprops_shard
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|construct_shard_sub_path
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_revprops_pack_shard
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|construct_shard_sub_path
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|NULL
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_revprops
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|char
name|buffer
index|[
name|SVN_INT64_BUFFER_SIZE
index|]
decl_stmt|;
name|svn__i64toa
argument_list|(
name|buffer
argument_list|,
name|rev
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
name|svn_fs_x__is_packed_revprop
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|construct_shard_sub_path
argument_list|(
name|fs
argument_list|,
name|rev
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|buffer
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__txn_name
parameter_list|(
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|char
modifier|*
name|p
init|=
name|apr_palloc
argument_list|(
name|result_pool
argument_list|,
name|SVN_INT64_BUFFER_SIZE
argument_list|)
decl_stmt|;
name|svn__ui64tobase36
argument_list|(
name|p
argument_list|,
name|txn_id
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__txn_by_name
parameter_list|(
name|svn_fs_x__txn_id_t
modifier|*
name|txn_id
parameter_list|,
specifier|const
name|char
modifier|*
name|txn_name
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|next
decl_stmt|;
name|apr_uint64_t
name|id
init|=
name|svn__base36toui64
argument_list|(
operator|&
name|next
argument_list|,
name|txn_name
argument_list|)
decl_stmt|;
if|if
condition|(
name|next
operator|==
name|NULL
operator|||
operator|*
name|next
operator|!=
literal|0
operator|||
operator|*
name|txn_name
operator|==
literal|0
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_INCORRECT_PARAMS
argument_list|,
name|NULL
argument_list|,
literal|"Malformed TXN name '%s'"
argument_list|,
name|txn_name
argument_list|)
return|;
operator|*
name|txn_id
operator|=
name|id
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txns_dir
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_TXNS_DIR
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Return the full path of the file FILENAME within transaction TXN_ID's  * transaction directory in FS.  If FILENAME is NULL, return the transaction  * directory itself.  *  * Allocate the result in RESULT_POOL.  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|construct_txn_path
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
comment|/* Construct the transaction directory name without temp. allocations. */
name|char
name|buffer
index|[
name|SVN_INT64_BUFFER_SIZE
operator|+
sizeof|sizeof
argument_list|(
name|PATH_EXT_TXN
argument_list|)
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|apr_size_t
name|len
init|=
name|svn__ui64tobase36
argument_list|(
name|buffer
argument_list|,
name|txn_id
argument_list|)
decl_stmt|;
name|strncpy
argument_list|(
name|buffer
operator|+
name|len
argument_list|,
name|PATH_EXT_TXN
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
operator|-
name|len
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* If FILENAME is NULL, it will terminate the list of segments      to concatenate. */
return|return
name|svn_dirent_join_many
argument_list|(
name|result_pool
argument_list|,
name|fs
operator|->
name|path
argument_list|,
name|PATH_TXNS_DIR
argument_list|,
name|buffer
argument_list|,
name|filename
argument_list|,
name|SVN_VA_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_dir
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|construct_txn_path
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|NULL
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Return the name of the sha1->rep mapping file in transaction TXN_ID  * within FS for the given SHA1 checksum.  Use POOL for allocations.  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_sha1
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|sha1
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_checksum_t
name|checksum
decl_stmt|;
name|checksum
operator|.
name|digest
operator|=
name|sha1
expr_stmt|;
name|checksum
operator|.
name|kind
operator|=
name|svn_checksum_sha1
expr_stmt|;
return|return
name|svn_dirent_join
argument_list|(
name|svn_fs_x__path_txn_dir
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|pool
argument_list|)
argument_list|,
name|svn_checksum_to_cstring
argument_list|(
operator|&
name|checksum
argument_list|,
name|pool
argument_list|)
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_changes
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|construct_txn_path
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|PATH_CHANGES
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_props
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|construct_txn_path
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|PATH_TXN_PROPS
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_props_final
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|construct_txn_path
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|PATH_TXN_PROPS_FINAL
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_l2p_proto_index
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|construct_txn_path
argument_list|(
argument|fs
argument_list|,
argument|txn_id
argument_list|,
argument|PATH_INDEX PATH_EXT_L2P_INDEX
argument_list|,
argument|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_p2l_proto_index
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|construct_txn_path
argument_list|(
argument|fs
argument_list|,
argument|txn_id
argument_list|,
argument|PATH_INDEX PATH_EXT_P2L_INDEX
argument_list|,
argument|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_next_ids
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|construct_txn_path
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|PATH_NEXT_IDS
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_min_unpacked_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_MIN_UNPACKED_REV
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_proto_revs
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|svn_dirent_join
argument_list|(
name|fs
operator|->
name|path
argument_list|,
name|PATH_TXN_PROTOS_DIR
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_item_index
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|construct_txn_path
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|PATH_TXN_ITEM_INDEX
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Return the full path of the proto-rev file / lock file for transaction  * TXN_ID in FS.  The SUFFIX determines what file (rev / lock) it will be.  *  * Allocate the result in RESULT_POOL.  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|construct_proto_rev_path
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
specifier|const
name|char
modifier|*
name|suffix
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
comment|/* Construct the file name without temp. allocations. */
name|char
name|buffer
index|[
name|SVN_INT64_BUFFER_SIZE
operator|+
sizeof|sizeof
argument_list|(
name|PATH_EXT_REV_LOCK
argument_list|)
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|apr_size_t
name|len
init|=
name|svn__ui64tobase36
argument_list|(
name|buffer
argument_list|,
name|txn_id
argument_list|)
decl_stmt|;
name|strncpy
argument_list|(
name|buffer
operator|+
name|len
argument_list|,
name|suffix
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
operator|-
name|len
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* If FILENAME is NULL, it will terminate the list of segments      to concatenate. */
return|return
name|svn_dirent_join_many
argument_list|(
name|result_pool
argument_list|,
name|fs
operator|->
name|path
argument_list|,
name|PATH_TXN_PROTOS_DIR
argument_list|,
name|buffer
argument_list|,
name|SVN_VA_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_proto_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|construct_proto_rev_path
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|PATH_EXT_REV
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_proto_rev_lock
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_fs_x__txn_id_t
name|txn_id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
return|return
name|construct_proto_rev_path
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|PATH_EXT_REV_LOCK
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Return the full path of the noderev-related file with the extension SUFFIX  * for noderev *ID in transaction TXN_ID in FS.  *  * Allocate the result in RESULT_POOL and temporaries in SCRATCH_POOL.  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|construct_txn_node_path
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_x__id_t
modifier|*
name|id
parameter_list|,
specifier|const
name|char
modifier|*
name|suffix
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|filename
init|=
name|svn_fs_x__id_unparse
argument_list|(
name|id
argument_list|,
name|result_pool
argument_list|)
operator|->
name|data
decl_stmt|;
name|apr_int64_t
name|txn_id
init|=
name|svn_fs_x__get_txn_id
argument_list|(
name|id
operator|->
name|change_set
argument_list|)
decl_stmt|;
return|return
name|svn_dirent_join
argument_list|(
name|svn_fs_x__path_txn_dir
argument_list|(
name|fs
argument_list|,
name|txn_id
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
name|PATH_PREFIX_NODE
literal|"%s%s"
argument_list|,
name|filename
argument_list|,
name|suffix
argument_list|)
argument_list|,
name|result_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_node_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_x__id_t
modifier|*
name|id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|construct_txn_node_path
argument_list|(
name|fs
argument_list|,
name|id
argument_list|,
literal|""
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_node_props
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_x__id_t
modifier|*
name|id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|construct_txn_node_path
argument_list|(
name|fs
argument_list|,
name|id
argument_list|,
name|PATH_EXT_PROPS
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|svn_fs_x__path_txn_node_children
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
specifier|const
name|svn_fs_x__id_t
modifier|*
name|id
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|construct_txn_node_path
argument_list|(
name|fs
argument_list|,
name|id
argument_list|,
name|PATH_EXT_CHILDREN
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__check_file_buffer_numeric
parameter_list|(
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|apr_off_t
name|offset
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|title
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
name|buf
operator|+
name|offset
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
if|if
condition|(
operator|!
name|svn_ctype_isdigit
argument_list|(
operator|*
name|p
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_BAD_VERSION_FILE_FORMAT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"%s file '%s' contains unexpected non-digit '%c' within '%s'"
argument_list|)
argument_list|,
name|title
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|path
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
operator|*
name|p
argument_list|,
name|buf
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__read_min_unpacked_rev
parameter_list|(
name|svn_revnum_t
modifier|*
name|min_unpacked_rev
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
name|apr_file_t
modifier|*
name|file
decl_stmt|;
name|apr_size_t
name|len
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_open
argument_list|(
operator|&
name|file
argument_list|,
name|svn_fs_x__path_min_unpacked_rev
argument_list|(
name|fs
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|APR_READ
operator||
name|APR_BUFFERED
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_read_length_line
argument_list|(
name|file
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_close
argument_list|(
name|file
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_revnum_parse
argument_list|(
name|min_unpacked_rev
argument_list|,
name|buf
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__update_min_unpacked_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_fs_x__data_t
modifier|*
name|ffd
init|=
name|fs
operator|->
name|fsap_data
decl_stmt|;
return|return
name|svn_fs_x__read_min_unpacked_rev
argument_list|(
operator|&
name|ffd
operator|->
name|min_unpacked_rev
argument_list|,
name|fs
argument_list|,
name|scratch_pool
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Write a file FILENAME in directory FS_PATH, containing a single line  * with the number REVNUM in ASCII decimal.  Move the file into place  * atomically, overwriting any existing file.  *  * Similar to write_current(). */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__write_min_unpacked_rev
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|revnum
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|final_path
decl_stmt|;
name|char
name|buf
index|[
name|SVN_INT64_BUFFER_SIZE
index|]
decl_stmt|;
name|apr_size_t
name|len
init|=
name|svn__i64toa
argument_list|(
name|buf
argument_list|,
name|revnum
argument_list|)
decl_stmt|;
name|buf
index|[
name|len
index|]
operator|=
literal|'\n'
expr_stmt|;
name|final_path
operator|=
name|svn_fs_x__path_min_unpacked_rev
argument_list|(
name|fs
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_write_atomic
argument_list|(
name|final_path
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|,
name|final_path
comment|/* copy_perms */
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__read_current
parameter_list|(
name|svn_revnum_t
modifier|*
name|rev
parameter_list|,
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|svn_stringbuf_t
modifier|*
name|content
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_fs_x__read_content
argument_list|(
operator|&
name|content
argument_list|,
name|svn_fs_x__path_current
argument_list|(
name|fs
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_revnum_parse
argument_list|(
name|rev
argument_list|,
name|content
operator|->
name|data
argument_list|,
operator|&
name|str
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|str
operator|!=
literal|'\n'
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_FS_CORRUPT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Corrupt 'current' file"
argument_list|)
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Atomically update the 'current' file to hold the specifed REV.    Perform temporary allocations in SCRATCH_POOL. */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__write_current
parameter_list|(
name|svn_fs_t
modifier|*
name|fs
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
specifier|const
name|char
modifier|*
name|tmp_name
decl_stmt|,
modifier|*
name|name
decl_stmt|;
comment|/* Now we can just write out this line. */
name|buf
operator|=
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"%ld\n"
argument_list|,
name|rev
argument_list|)
expr_stmt|;
name|name
operator|=
name|svn_fs_x__path_current
argument_list|(
name|fs
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_write_unique
argument_list|(
operator|&
name|tmp_name
argument_list|,
name|svn_dirent_dirname
argument_list|(
name|name
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|svn_io_file_del_none
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_fs_x__move_into_place
argument_list|(
name|tmp_name
argument_list|,
name|name
argument_list|,
name|name
argument_list|,
name|scratch_pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__try_stringbuf_from_file
parameter_list|(
name|svn_stringbuf_t
modifier|*
modifier|*
name|content
parameter_list|,
name|svn_boolean_t
modifier|*
name|missing
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_boolean_t
name|last_attempt
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
init|=
name|svn_stringbuf_from_file2
argument_list|(
name|content
argument_list|,
name|path
argument_list|,
name|result_pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|missing
condition|)
operator|*
name|missing
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
operator|*
name|content
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|APR_STATUS_IS_ENOENT
argument_list|(
name|err
operator|->
name|apr_err
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|last_attempt
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|missing
condition|)
operator|*
name|missing
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
ifdef|#
directive|ifdef
name|ESTALE
elseif|else
if|if
condition|(
name|APR_TO_OS_ERROR
argument_list|(
name|err
operator|->
name|apr_err
argument_list|)
operator|==
name|ESTALE
operator|||
name|APR_TO_OS_ERROR
argument_list|(
name|err
operator|->
name|apr_err
argument_list|)
operator|==
name|EIO
condition|)
block|{
if|if
condition|(
operator|!
name|last_attempt
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
endif|#
directive|endif
block|}
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Fetch the current offset of FILE into *OFFSET_P. */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__get_file_offset
parameter_list|(
name|apr_off_t
modifier|*
name|offset_p
parameter_list|,
name|apr_file_t
modifier|*
name|file
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_off_t
name|offset
decl_stmt|;
comment|/* Note that, for buffered files, one (possibly surprising) side-effect      of this call is to flush any unwritten data to disk. */
name|offset
operator|=
literal|0
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_seek
argument_list|(
name|file
argument_list|,
name|APR_CUR
argument_list|,
operator|&
name|offset
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|offset_p
operator|=
name|offset
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__read_content
parameter_list|(
name|svn_stringbuf_t
modifier|*
modifier|*
name|content
parameter_list|,
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
operator|*
name|content
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
operator|*
name|content
operator|&&
operator|(
name|i
operator|<
name|SVN_FS_X__RECOVERABLE_RETRY_COUNT
operator|)
condition|;
operator|++
name|i
control|)
name|SVN_ERR
argument_list|(
name|svn_fs_x__try_stringbuf_from_file
argument_list|(
name|content
argument_list|,
name|NULL
argument_list|,
name|fname
argument_list|,
name|i
operator|+
literal|1
operator|<
name|SVN_FS_X__RECOVERABLE_RETRY_COUNT
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|content
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_CORRUPT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Can't read '%s'"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|fname
argument_list|,
name|result_pool
argument_list|)
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Reads a line from STREAM and converts it to a 64 bit integer to be  * returned in *RESULT.  If we encounter eof, set *HIT_EOF and leave  * *RESULT unchanged.  If HIT_EOF is NULL, EOF causes an "corrupt FS"  * error return.  * SCRATCH_POOL is used for temporary allocations.  */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__read_number_from_stream
parameter_list|(
name|apr_int64_t
modifier|*
name|result
parameter_list|,
name|svn_boolean_t
modifier|*
name|hit_eof
parameter_list|,
name|svn_stream_t
modifier|*
name|stream
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_stringbuf_t
modifier|*
name|sb
decl_stmt|;
name|svn_boolean_t
name|eof
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_readline
argument_list|(
name|stream
argument_list|,
operator|&
name|sb
argument_list|,
literal|"\n"
argument_list|,
operator|&
name|eof
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hit_eof
condition|)
operator|*
name|hit_eof
operator|=
name|eof
expr_stmt|;
elseif|else
if|if
condition|(
name|eof
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_FS_CORRUPT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Unexpected EOF"
argument_list|)
argument_list|)
return|;
if|if
condition|(
operator|!
name|eof
condition|)
block|{
name|err
operator|=
name|svn_cstring_atoi64
argument_list|(
name|result
argument_list|,
name|sb
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_CORRUPT
argument_list|,
name|err
argument_list|,
name|_
argument_list|(
literal|"Number '%s' invalid or too large"
argument_list|)
argument_list|,
name|sb
operator|->
name|data
argument_list|)
return|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Move a file into place from OLD_FILENAME in the transactions    directory to its final location NEW_FILENAME in the repository.  On    Unix, match the permissions of the new file to the permissions of    PERMS_REFERENCE.  Temporary allocations are from SCRATCH_POOL.     This function almost duplicates svn_io_file_move(), but it tries to    guarantee a flush. */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__move_into_place
parameter_list|(
specifier|const
name|char
modifier|*
name|old_filename
parameter_list|,
specifier|const
name|char
modifier|*
name|new_filename
parameter_list|,
specifier|const
name|char
modifier|*
name|perms_reference
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_copy_perms
argument_list|(
name|perms_reference
argument_list|,
name|old_filename
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Move the file into place. */
name|err
operator|=
name|svn_io_file_rename
argument_list|(
name|old_filename
argument_list|,
name|new_filename
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|APR_STATUS_IS_EXDEV
argument_list|(
name|err
operator|->
name|apr_err
argument_list|)
condition|)
block|{
name|apr_file_t
modifier|*
name|file
decl_stmt|;
comment|/* Can't rename across devices; fall back to copying. */
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|err
operator|=
name|SVN_NO_ERROR
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_copy_file
argument_list|(
name|old_filename
argument_list|,
name|new_filename
argument_list|,
name|TRUE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Flush the target of the copy to disk. */
name|SVN_ERR
argument_list|(
name|svn_io_file_open
argument_list|(
operator|&
name|file
argument_list|,
name|new_filename
argument_list|,
name|APR_READ
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### BH: Does this really guarantee a flush of the data written          ### via a completely different handle on all operating systems?          ###          ### Maybe we should perform the copy ourselves instead of making          ### apr do that and flush the real handle? */
name|SVN_ERR
argument_list|(
name|svn_io_file_flush_to_disk
argument_list|(
name|file
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_close
argument_list|(
name|file
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
ifdef|#
directive|ifdef
name|__linux__
block|{
comment|/* Linux has the unusual feature that fsync() on a file is not        enough to ensure that a file's directory entries have been        flushed to disk; you have to fsync the directory as well.        On other operating systems, we'd only be asking for trouble        by trying to open and fsync a directory. */
specifier|const
name|char
modifier|*
name|dirname
decl_stmt|;
name|apr_file_t
modifier|*
name|file
decl_stmt|;
name|dirname
operator|=
name|svn_dirent_dirname
argument_list|(
name|new_filename
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_open
argument_list|(
operator|&
name|file
argument_list|,
name|dirname
argument_list|,
name|APR_READ
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_flush_to_disk
argument_list|(
name|file
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_close
argument_list|(
name|file
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


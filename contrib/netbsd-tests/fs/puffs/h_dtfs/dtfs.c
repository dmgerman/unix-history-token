begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: dtfs.c,v 1.2 2010/07/21 06:58:25 pooka Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (c) 2006  Antti Kantee.  All Rights Reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS  * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Delectable Test File System: a simple in-memory file system which  * demonstrates the use of puffs.  * (a.k.a. Detrempe FS ...)  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<mntopts.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<puffs.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"dtfs.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|DEEP_ROOTED_CLUE
end_ifdef

begin_define
define|#
directive|define
name|FSNAME
value|"detrempe"
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|FSNAME
value|"dt"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MAXREQMAGIC
value|-37
end_define

begin_decl_stmt
specifier|static
name|struct
name|puffs_usermount
modifier|*
name|gpu
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|dtfs_mount
name|gdtm
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dynamicfh
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|straightflush
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|usage
parameter_list|()
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [-bsdftl] [-c hashbuckets] [-m maxreqsize] "
literal|"[-n typename]\n       [-o mntopt] [-o puffsopt] [-p prot] "
literal|"[-r rootnodetype]\n       detrempe /mountpoint\n"
argument_list|,
name|getprogname
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wipe_the_sleep_out_of_my_eyes
parameter_list|(
name|int
name|v
parameter_list|)
block|{
name|gdtm
operator|.
name|dtm_needwakeup
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|loopfun
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|)
block|{
name|struct
name|dtfs_mount
modifier|*
name|dtm
init|=
name|puffs_getspecific
argument_list|(
name|pu
argument_list|)
decl_stmt|;
name|struct
name|dtfs_poll
modifier|*
name|dp
decl_stmt|;
while|while
condition|(
name|dtm
operator|->
name|dtm_needwakeup
condition|)
block|{
name|dtm
operator|->
name|dtm_needwakeup
operator|--
expr_stmt|;
name|dp
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|dtm
operator|->
name|dtm_pollent
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|==
name|NULL
condition|)
return|return;
name|LIST_REMOVE
argument_list|(
name|dp
argument_list|,
name|dp_entries
argument_list|)
expr_stmt|;
name|puffs_cc_continue
argument_list|(
name|dp
operator|->
name|dp_pcc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
specifier|extern
name|int
name|optind
decl_stmt|;
name|struct
name|puffs_usermount
modifier|*
name|pu
decl_stmt|;
name|struct
name|puffs_pathobj
modifier|*
name|po_root
decl_stmt|;
name|struct
name|puffs_ops
modifier|*
name|pops
decl_stmt|;
name|struct
name|timespec
name|ts
decl_stmt|;
specifier|const
name|char
modifier|*
name|typename
decl_stmt|;
name|char
modifier|*
name|rtstr
decl_stmt|;
name|mntoptparse_t
name|mp
decl_stmt|;
name|int
name|pflags
decl_stmt|,
name|detach
decl_stmt|,
name|mntflags
decl_stmt|;
name|int
name|ch
decl_stmt|;
name|int
name|khashbuckets
decl_stmt|;
name|int
name|maxreqsize
decl_stmt|;
name|setprogname
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|rtstr
operator|=
name|NULL
expr_stmt|;
name|detach
operator|=
literal|1
expr_stmt|;
name|mntflags
operator|=
literal|0
expr_stmt|;
name|khashbuckets
operator|=
literal|256
expr_stmt|;
name|pflags
operator|=
name|PUFFS_KFLAG_IAONDEMAND
expr_stmt|;
name|typename
operator|=
name|FSNAME
expr_stmt|;
name|maxreqsize
operator|=
name|MAXREQMAGIC
expr_stmt|;
name|gdtm
operator|.
name|dtm_allowprot
operator|=
name|VM_PROT_ALL
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"bc:dfilm:n:o:p:r:st"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'b'
case|:
comment|/* build paths, for debugging the feature */
name|pflags
operator||=
name|PUFFS_FLAG_BUILDPATH
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|khashbuckets
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|dynamicfh
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|pflags
operator||=
name|PUFFS_KFLAG_LOOKUP_FULLPNBUF
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|pflags
operator|&=
operator|~
name|PUFFS_KFLAG_IAONDEMAND
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|straightflush
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|maxreqsize
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|typename
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|mp
operator|=
name|getmntopts
argument_list|(
name|optarg
argument_list|,
name|puffsmopts
argument_list|,
operator|&
name|mntflags
argument_list|,
operator|&
name|pflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"getmntopts"
argument_list|)
expr_stmt|;
name|freemntopts
argument_list|(
name|mp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|gdtm
operator|.
name|dtm_allowprot
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|gdtm
operator|.
name|dtm_allowprot
operator||
name|VM_PROT_ALL
operator|)
operator|!=
name|VM_PROT_ALL
condition|)
name|usage
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|rtstr
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
comment|/* stay on top */
name|detach
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|pflags
operator||=
name|PUFFS_KFLAG_WTCACHE
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
comment|/*NOTREACHED*/
block|}
block|}
if|if
condition|(
name|pflags
operator|&
name|PUFFS_FLAG_OPDUMP
condition|)
name|detach
operator|=
literal|0
expr_stmt|;
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
name|usage
argument_list|()
expr_stmt|;
name|PUFFSOP_INIT
argument_list|(
name|pops
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|fs
argument_list|,
name|statvfs
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|fs
argument_list|,
name|unmount
argument_list|)
expr_stmt|;
name|PUFFSOP_SETFSNOP
argument_list|(
name|pops
argument_list|,
name|sync
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|fs
argument_list|,
name|fhtonode
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|fs
argument_list|,
name|nodetofh
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|lookup
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|access
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|puffs_genfs
argument_list|,
name|node
argument_list|,
name|getattr
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|setattr
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|create
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|remove
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|readdir
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|poll
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|mmap
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|mkdir
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|rmdir
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|rename
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|read
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|write
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|symlink
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|readlink
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|mknod
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|inactive
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|pathconf
argument_list|)
expr_stmt|;
name|PUFFSOP_SET
argument_list|(
name|pops
argument_list|,
name|dtfs
argument_list|,
name|node
argument_list|,
name|reclaim
argument_list|)
expr_stmt|;
name|srandom
argument_list|(
name|time
argument_list|(
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* for random generation numbers */
name|pu
operator|=
name|puffs_init
argument_list|(
name|pops
argument_list|,
name|_PATH_PUFFS
argument_list|,
name|typename
argument_list|,
operator|&
name|gdtm
argument_list|,
name|pflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|pu
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"init"
argument_list|)
expr_stmt|;
name|gpu
operator|=
name|pu
expr_stmt|;
name|puffs_setfhsize
argument_list|(
name|pu
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|dtfs_fid
argument_list|)
argument_list|,
name|PUFFS_FHFLAG_NFSV2
operator||
name|PUFFS_FHFLAG_NFSV3
operator||
operator|(
name|dynamicfh
condition|?
name|PUFFS_FHFLAG_DYNAMIC
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|puffs_setncookiehash
argument_list|(
name|pu
argument_list|,
name|khashbuckets
argument_list|)
expr_stmt|;
if|if
condition|(
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|wipe_the_sleep_out_of_my_eyes
argument_list|)
operator|==
name|SIG_ERR
condition|)
name|warn
argument_list|(
literal|"cannot set alarm sighandler"
argument_list|)
expr_stmt|;
comment|/* init */
if|if
condition|(
name|dtfs_domount
argument_list|(
name|pu
argument_list|,
name|rtstr
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"dtfs_domount failed"
argument_list|)
expr_stmt|;
name|po_root
operator|=
name|puffs_getrootpathobj
argument_list|(
name|pu
argument_list|)
expr_stmt|;
name|po_root
operator|->
name|po_path
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|po_root
operator|->
name|po_len
operator|=
name|strlen
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* often enough for testing poll */
name|ts
operator|.
name|tv_sec
operator|=
literal|1
expr_stmt|;
name|ts
operator|.
name|tv_nsec
operator|=
literal|0
expr_stmt|;
name|puffs_ml_setloopfn
argument_list|(
name|pu
argument_list|,
name|loopfun
argument_list|)
expr_stmt|;
name|puffs_ml_settimeout
argument_list|(
name|pu
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxreqsize
operator|!=
name|MAXREQMAGIC
condition|)
name|puffs_setmaxreqlen
argument_list|(
name|pu
argument_list|,
name|maxreqsize
argument_list|)
expr_stmt|;
name|puffs_set_errnotify
argument_list|(
name|pu
argument_list|,
name|puffs_kernerr_abort
argument_list|)
expr_stmt|;
if|if
condition|(
name|detach
condition|)
if|if
condition|(
name|puffs_daemon
argument_list|(
name|pu
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"puffs_daemon"
argument_list|)
expr_stmt|;
if|if
condition|(
name|puffs_mount
argument_list|(
name|pu
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|mntflags
argument_list|,
name|puffs_getroot
argument_list|(
name|pu
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mount"
argument_list|)
expr_stmt|;
if|if
condition|(
name|puffs_mainloop
argument_list|(
name|pu
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mainloop"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: t_bpfjit.c,v 1.6 2014/07/08 21:07:52 alnsn Exp $ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2011-2012, 2014 Alexander Nasonov.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE  * COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED  * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"$NetBSD: t_bpfjit.c,v 1.6 2014/07/08 21:07:52 alnsn Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<atf-c.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/bpfjit.h>
end_include

begin_decl_stmt
specifier|static
name|uint8_t
name|deadbeef_at_5
index|[
literal|16
index|]
init|=
block|{
literal|0
block|,
literal|0xf1
block|,
literal|2
block|,
literal|0xf3
block|,
literal|4
block|,
literal|0xde
block|,
literal|0xad
block|,
literal|0xbe
block|,
literal|0xef
block|,
literal|0xff
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|inline
name|unsigned
name|int
name|jitcall
parameter_list|(
name|bpfjit_func_t
name|fn
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|pkt
parameter_list|,
name|unsigned
name|int
name|wirelen
parameter_list|,
name|unsigned
name|int
name|buflen
parameter_list|)
block|{
name|bpf_args_t
name|args
decl_stmt|;
name|args
operator|.
name|pkt
operator|=
name|pkt
expr_stmt|;
name|args
operator|.
name|wirelen
operator|=
name|wirelen
expr_stmt|;
name|args
operator|.
name|buflen
operator|=
name|buflen
expr_stmt|;
return|return
name|fn
argument_list|(
name|NULL
argument_list|,
operator|&
name|args
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_empty
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_empty
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test that JIT compilation of an empty bpf program fails"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_empty
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|bpf_insn
name|dummy
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
operator|&
name|dummy
argument_list|,
literal|0
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_add_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_add_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_ADD+BPF_K"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_add_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|5
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_sub_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_sub_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_SUB+BPF_K"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_sub_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_SUB
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_mul_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_mul_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_MUL+BPF_K"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_mul_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffffff
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_MUL
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_C
argument_list|(
literal|0xfffffffd
argument_list|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div0_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div0_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_K with k=0"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div0_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
comment|//ATF_CHECK(bpf_validate(insns, insn_count));
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div1_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div1_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_K with k=1"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div1_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div2_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div2_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_K with k=2"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div2_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|3
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div4_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div4_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_K with k=4"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div4_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffffff
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_C
argument_list|(
literal|0x3fffffff
argument_list|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div10_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div10_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_K with k=10"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div10_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|4294843849
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_K
argument_list|,
literal|10
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_C
argument_list|(
literal|429484384
argument_list|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div10000_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div10000_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_K with k=10000"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div10000_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|4294843849
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_K
argument_list|,
literal|10000
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_C
argument_list|(
literal|429484
argument_list|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div7609801_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div7609801_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_K with k=7609801"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div7609801_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|4294967295
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|7609801
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|564
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div80000000_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div80000000_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_K with k=0x80000000"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div80000000_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffffde
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0x80000000
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_and_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_and_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_AND+BPF_K"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_and_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|0xdead
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_AND
operator|+
name|BPF_K
argument_list|,
literal|0xbeef
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
operator|(
literal|0xdead
operator|&
literal|0xbeef
operator|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_or_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_or_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_OR+BPF_K"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_or_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|0xdead0000
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_OR
operator|+
name|BPF_K
argument_list|,
literal|0x0000beef
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0xdeadbeef
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_lsh_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_lsh_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_LSH+BPF_K"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_lsh_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|0xdeadbeef
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_LSH
operator|+
name|BPF_K
argument_list|,
literal|16
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0xbeef0000
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_lsh0_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_lsh0_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_LSH+BPF_K with k=0"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_lsh0_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|0xdeadbeef
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_LSH
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0xdeadbeef
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_rsh_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_rsh_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_RSH+BPF_K"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_rsh_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|0xdeadbeef
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_RSH
operator|+
name|BPF_K
argument_list|,
literal|16
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0x0000dead
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_rsh0_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_rsh0_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_RSH+BPF_K with k=0"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_rsh0_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|0xdeadbeef
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_RSH
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0xdeadbeef
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_modulo_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_modulo_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of modulo logic of BPF_ALU+BPF_K operations"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_modulo_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0x7fffff77
argument_list|)
argument_list|)
block|,
comment|/* (7FFFFF77 * 0FFFFF77) = 07FFFFB2,F0004951 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_MUL
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0x0fffff77
argument_list|)
argument_list|)
block|,
comment|/* 07FFFFB2,F0004951<< 1 = 0FFFFF65,E00092A2 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_LSH
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
comment|/* 0FFFFF65,E00092A2 + DDDDDDDD = 0FFFFF66,BDDE707F */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xdddddddd
argument_list|)
argument_list|)
block|,
comment|/* 0FFFFF66,BDDE707F - FFFFFFFF = 0FFFFF65,BDDE7080 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_SUB
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffffff
argument_list|)
argument_list|)
block|,
comment|/* 0FFFFF65,BDDE7080 | 0000030C = 0FFFFF65,BDDE738C */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_OR
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0x0000030c
argument_list|)
argument_list|)
block|,
comment|/* -0FFFFF65,BDDE738C mod(2^64) = F000009A,42218C74 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_NEG
argument_list|,
literal|0
argument_list|)
block|,
comment|/* F000009A,42218C74& FFFFFF0F = F000009A,42218C04 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_AND
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffff0f
argument_list|)
argument_list|)
block|,
comment|/* F000009A,42218C74>> 3 = 1E000013,48443180 */
comment|/* 00000000,42218C74>> 3 = 00000000,08443180 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_RSH
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 00000000,08443180 * 7FFFFF77 = 042218BB,93818280 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_MUL
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0x7fffff77
argument_list|)
argument_list|)
block|,
comment|/* 042218BB,93818280 / DEAD = 000004C0,71CBBBC3 */
comment|/* 00000000,93818280 / DEAD = 00000000,0000A994 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xdead
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|!=
name|UINT32_C
argument_list|(
literal|0x71cbbbc3
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_C
argument_list|(
literal|0x0000a994
argument_list|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_add_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_add_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_ADD+BPF_X"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_add_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|5
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_sub_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_sub_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_SUB+BPF_X"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_sub_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_SUB
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_mul_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_mul_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_MUL+BPF_X"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_mul_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffffff
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_MUL
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_C
argument_list|(
literal|0xfffffffd
argument_list|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div0_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div0_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_X with X=0"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div0_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div1_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div1_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_X with X=1"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div1_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div2_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div2_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_X with X=2"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div2_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|3
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div4_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div4_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_X with X=4"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div4_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffffff
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_C
argument_list|(
literal|0x3fffffff
argument_list|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div10_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div10_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_X with X=10"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div10_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|4294843849
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|10
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_C
argument_list|(
literal|429484384
argument_list|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div10000_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div10000_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_X with X=10000"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div10000_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|4294843849
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|10000
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_C
argument_list|(
literal|429484
argument_list|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div7609801_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div7609801_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_X with X=7609801"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div7609801_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|4294967295
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|7609801
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|564
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_div80000000_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_div80000000_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_DIV+BPF_X with X=0x80000000"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_div80000000_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_MAX
operator|-
literal|33
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0x80000000
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_and_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_and_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_AND+BPF_X"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_and_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|0xdead
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|0xbeef
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_AND
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
operator|(
literal|0xdead
operator|&
literal|0xbeef
operator|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_or_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_or_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_OR+BPF_X"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_or_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|0xdead0000
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|0x0000beef
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_OR
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0xdeadbeef
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_lsh_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_lsh_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_LSH+BPF_X"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_lsh_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|0xdeadbeef
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|16
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_LSH
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0xbeef0000
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_lsh0_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_lsh0_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_LSH+BPF_X with k=0"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_lsh0_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|0xdeadbeef
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_LSH
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0xdeadbeef
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_rsh_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_rsh_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_RSH+BPF_X"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_rsh_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|0xdeadbeef
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|16
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_RSH
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0x0000dead
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_rsh0_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_rsh0_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_RSH+BPF_X with k=0"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_rsh0_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|0xdeadbeef
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_RSH
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0xdeadbeef
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_modulo_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_modulo_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of modulo logic of BPF_ALU+BPF_X operations"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_modulo_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0x7fffff77
argument_list|)
argument_list|)
block|,
comment|/* (7FFFFF77 * 0FFFFF77) = 07FFFFB2,F0004951 */
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0x0fffff77
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_MUL
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 07FFFFB2,F0004951<< 1 = 0FFFFF65,E00092A2 */
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_LSH
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0FFFFF65,E00092A2 + DDDDDDDD = 0FFFFF66,BDDE707F */
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xdddddddd
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0FFFFF66,BDDE707F - FFFFFFFF = 0FFFFF65,BDDE7080 */
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffffff
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_SUB
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0FFFFF65,BDDE7080 | 0000030C = 0FFFFF65,BDDE738C */
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0x0000030c
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_OR
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* -0FFFFF65,BDDE738C mod(2^64) = F000009A,42218C74 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_NEG
argument_list|,
literal|0
argument_list|)
block|,
comment|/* F000009A,42218C74& FFFFFF0F = F000009A,42218C04 */
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffff0f
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_AND
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* F000009A,42218C74>> 3 = 1E000013,48443180 */
comment|/* 00000000,42218C74>> 3 = 00000000,08443180 */
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_RSH
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 00000000,08443180 * 7FFFFF77 = 042218BB,93818280 */
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0x7fffff77
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_MUL
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 042218BB,93818280 / DEAD = 000004C0,71CBBBC3 */
comment|/* 00000000,93818280 / DEAD = 00000000,0000A994 */
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xdead
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_DIV
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|!=
name|UINT32_C
argument_list|(
literal|0x71cbbbc3
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_C
argument_list|(
literal|0x0000a994
argument_list|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_alu_neg
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_alu_neg
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ALU+BPF_NEG"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_alu_neg
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|777
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_NEG
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0u
operator|-
literal|777u
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_jmp_ja
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_jmp_ja
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_JMP+BPF_JA"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_jmp_ja
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JA
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|, 	}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_jmp_jgt_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_jmp_jgt_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_JMP+BPF_JGT+BPF_K"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_jmp_jgt_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_K
argument_list|,
literal|9
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_K
argument_list|,
literal|5
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|8
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|8
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|8
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|5
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_jmp_jge_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_jmp_jge_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_JMP+BPF_JGE+BPF_K"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_jmp_jge_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_K
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_K
argument_list|,
literal|9
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_K
argument_list|,
literal|5
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|8
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|8
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|8
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|5
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_jmp_jeq_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_jmp_jeq_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_JMP+BPF_JEQ+BPF_K"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_jmp_jeq_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|5
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|8
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|8
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|8
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|5
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_jmp_jset_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_jmp_jset_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_JMP+BPF_JSET+BPF_K"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_jmp_jset_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_K
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|8
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|8
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|5
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|8
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|5
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_jmp_modulo_k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_jmp_modulo_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of modulo logic of BPF_JMP+BPF_K operations"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_jmp_modulo_k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0x7fffff77
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_LSH
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xfffff770
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xfffff770
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xfffff771
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xfffff770
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xfffff770
argument_list|)
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xfffff771
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JA
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|,
comment|/* FFFFF770+FFFFF770 = 00000001,FFFFEEE0 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xfffff770
argument_list|)
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffeee0
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffeee0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffeee1
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffeee0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffeee0
argument_list|)
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffeee1
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|7
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_jmp_jgt_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_jmp_jgt_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_JMP+BPF_JGT+BPF_X"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_jmp_jgt_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|9
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|8
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|8
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|8
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|5
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_jmp_jge_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_jmp_jge_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_JMP+BPF_JGE+BPF_X"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_jmp_jge_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|8
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|9
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|8
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|8
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|8
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|5
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_jmp_jeq_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_jmp_jeq_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_JMP+BPF_JEQ+BPF_X"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_jmp_jeq_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|8
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|9
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_X
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|8
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|8
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|8
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|5
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_jmp_jset_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_jmp_jset_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_JMP+BPF_JSET+BPF_X"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_jmp_jset_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|8
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_X
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|8
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|8
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|5
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|8
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|5
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_jmp_modulo_x
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_jmp_modulo_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of modulo logic of BPF_JMP+BPF_X operations"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_jmp_modulo_x
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0x7fffff77
argument_list|)
argument_list|)
block|,
comment|/* FFFFF770<< 4 = FFFFF770 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_LSH
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0xfffff770
argument_list|)
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0xfffff771
argument_list|)
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0xfffff770
argument_list|)
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0xfffff771
argument_list|)
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JA
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|,
comment|/* FFFFF770+FFFFF770 = 00000001,FFFFEEE0 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xfffff770
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffeee0
argument_list|)
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffeee1
argument_list|)
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffeee0
argument_list|)
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffeee1
argument_list|)
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|7
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_ld_abs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_ld_abs
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_LD+BPF_ABS"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_ld_abs
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[
literal|3
index|]
index|[
literal|2
index|]
init|=
block|{
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
block|}
decl_stmt|;
specifier|static
name|size_t
name|lengths
index|[
literal|3
index|]
init|=
block|{
literal|1
block|,
literal|2
block|,
literal|4
block|}
decl_stmt|;
specifier|static
name|unsigned
name|int
name|expected
index|[
literal|3
index|]
init|=
block|{
literal|0xde
block|,
literal|0xdead
block|,
literal|0xdeadbeef
block|}
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|l
decl_stmt|;
name|uint8_t
modifier|*
name|pkt
init|=
name|deadbeef_at_5
decl_stmt|;
name|size_t
name|pktsize
init|=
sizeof|sizeof
argument_list|(
name|deadbeef_at_5
argument_list|)
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|bpfjit_func_t
name|code
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
index|[
name|i
index|]
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
index|[
name|i
index|]
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|l
operator|=
literal|1
init|;
name|l
operator|<
literal|5
operator|+
name|lengths
index|[
name|i
index|]
condition|;
name|l
operator|++
control|)
block|{
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|l
argument_list|,
name|l
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|pktsize
argument_list|,
name|l
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|l
operator|=
literal|5
operator|+
name|lengths
index|[
name|i
index|]
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|l
argument_list|,
name|l
argument_list|)
operator|==
name|expected
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|pktsize
argument_list|,
name|l
argument_list|)
operator|==
name|expected
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|l
operator|=
name|pktsize
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|l
argument_list|,
name|l
argument_list|)
operator|==
name|expected
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_ld_abs_k_overflow
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_ld_abs_k_overflow
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_LD+BPF_ABS with overflow in k+4"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_ld_abs_k_overflow
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[
literal|12
index|]
index|[
literal|3
index|]
init|=
block|{
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
name|UINT32_MAX
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
name|UINT32_MAX
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
name|UINT32_MAX
operator|-
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
name|UINT32_MAX
operator|-
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
name|UINT32_MAX
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
name|UINT32_MAX
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
name|UINT32_MAX
operator|-
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
name|UINT32_MAX
operator|-
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|8
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|bpfjit_func_t
name|code
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
index|[
name|i
index|]
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
index|[
name|i
index|]
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_ld_ind
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_ld_ind
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_LD+BPF_IND"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_ld_ind
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[
literal|6
index|]
index|[
literal|3
index|]
init|=
block|{
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_IND
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_IND
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
block|}
decl_stmt|;
specifier|static
name|size_t
name|lengths
index|[
literal|6
index|]
init|=
block|{
literal|1
block|,
literal|2
block|,
literal|4
block|,
literal|1
block|,
literal|2
block|,
literal|4
block|}
decl_stmt|;
specifier|static
name|unsigned
name|int
name|expected
index|[
literal|6
index|]
init|=
block|{
literal|0xde
block|,
literal|0xdead
block|,
literal|0xdeadbeef
block|,
literal|0xde
block|,
literal|0xdead
block|,
literal|0xdeadbeef
block|}
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|l
decl_stmt|;
name|uint8_t
modifier|*
name|pkt
init|=
name|deadbeef_at_5
decl_stmt|;
name|size_t
name|pktsize
init|=
sizeof|sizeof
argument_list|(
name|deadbeef_at_5
argument_list|)
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|bpfjit_func_t
name|code
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
index|[
name|i
index|]
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
index|[
name|i
index|]
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|l
operator|=
literal|1
init|;
name|l
operator|<
literal|5
operator|+
name|lengths
index|[
name|i
index|]
condition|;
name|l
operator|++
control|)
block|{
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|l
argument_list|,
name|l
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|pktsize
argument_list|,
name|l
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|l
operator|=
literal|5
operator|+
name|lengths
index|[
name|i
index|]
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|l
argument_list|,
name|l
argument_list|)
operator|==
name|expected
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|pktsize
argument_list|,
name|l
argument_list|)
operator|==
name|expected
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|l
operator|=
name|pktsize
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|l
argument_list|,
name|l
argument_list|)
operator|==
name|expected
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_ld_ind_k_overflow
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_ld_ind_k_overflow
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_LD+BPF_IND with overflow in k+4"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_ld_ind_k_overflow
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[
literal|12
index|]
index|[
literal|3
index|]
init|=
block|{
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
name|UINT32_MAX
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
name|UINT32_MAX
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
name|UINT32_MAX
operator|-
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
name|UINT32_MAX
operator|-
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
name|UINT32_MAX
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
name|UINT32_MAX
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
name|UINT32_MAX
operator|-
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|,
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
name|UINT32_MAX
operator|-
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|1
argument_list|)
block|}
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|8
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|bpfjit_func_t
name|code
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
index|[
name|i
index|]
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
index|[
name|i
index|]
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_ld_ind_x_overflow1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_ld_ind_x_overflow1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_LD+BPF_IND with overflow in X+4"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_ld_ind_x_overflow1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffffff
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator|+
name|BPF_TAX
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_IND
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|8
index|]
init|=
block|{
literal|10
block|,
literal|20
block|,
literal|30
block|,
literal|40
block|,
literal|50
block|,
literal|60
block|,
literal|70
block|,
literal|80
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ATF_CHECK
argument_list|(
name|bpf_filter
argument_list|(
name|insns
argument_list|,
name|pkt
argument_list|,
name|i
argument_list|,
name|i
argument_list|)
operator|==
literal|10
operator|*
name|i
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|i
argument_list|,
name|i
argument_list|)
operator|==
literal|10
operator|*
name|i
argument_list|)
expr_stmt|;
block|}
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_ld_ind_x_overflow2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_ld_ind_x_overflow2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_LD+BPF_IND with overflow in X+4"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_ld_ind_x_overflow2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_K
argument_list|,
name|UINT32_C
argument_list|(
literal|0xffffffff
argument_list|)
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_MEM
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_IND
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|8
index|]
init|=
block|{
literal|10
block|,
literal|20
block|,
literal|30
block|,
literal|40
block|,
literal|50
block|,
literal|60
block|,
literal|70
block|,
literal|80
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ATF_CHECK
argument_list|(
name|bpf_filter
argument_list|(
name|insns
argument_list|,
name|pkt
argument_list|,
name|i
argument_list|,
name|i
argument_list|)
operator|==
literal|10
operator|*
name|i
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|i
argument_list|,
name|i
argument_list|)
operator|==
literal|10
operator|*
name|i
argument_list|)
expr_stmt|;
block|}
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_ld_len
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_ld_len
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_LD+BPF_W+BPF_LEN"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_ld_len
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|32
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
condition|;
name|i
operator|++
control|)
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|i
argument_list|,
literal|1
argument_list|)
operator|==
name|i
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_ld_imm
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_ld_imm
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_LD+BPF_IMM"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_ld_imm
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_ldx_imm1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_ldx_imm1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_LDX+BPF_IMM"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_ldx_imm1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
name|UINT32_MAX
operator|-
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_MAX
operator|-
literal|5
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_ldx_imm2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_ldx_imm2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_LDX+BPF_IMM"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_ldx_imm2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
argument|UINT32_MAX
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_ldx_len1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_ldx_len1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_LDX+BPF_LEN"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_ldx_len1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|5
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|i
argument_list|,
literal|1
argument_list|)
operator|==
name|i
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|i
argument_list|)
operator|==
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_ldx_len2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_ldx_len2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_LDX+BPF_LEN"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_ldx_len2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
argument|UINT32_MAX
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|5
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|5
argument_list|)
operator|==
literal|7
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_ldx_msh
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_ldx_msh
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_LDX+BPF_MSH"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_ldx_msh
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_B
operator|+
name|BPF_MSH
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|2
index|]
init|=
block|{
literal|0
block|,
literal|0x7a
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|40
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_misc_tax
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_misc_tax
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_MISC+BPF_TAX"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_misc_tax
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator|+
name|BPF_TAX
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_IND
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[]
init|=
block|{
literal|0
block|,
literal|11
block|,
literal|22
block|,
literal|33
block|,
literal|44
block|,
literal|55
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
argument_list|)
operator|==
literal|55
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_misc_txa
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_misc_txa
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_MISC+BPF_TXA"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_misc_txa
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|391
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator|+
name|BPF_TXA
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|391
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_st1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_st1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ST"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_st1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_MEM
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|16
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
condition|;
name|i
operator|++
control|)
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|i
argument_list|,
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
argument_list|)
operator|==
name|i
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_st2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_st2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ST"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_st2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
name|BPF_MEMWORDS
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_MEM
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_st3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_st3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ST"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_st3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_K
argument_list|,
literal|100
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
name|BPF_MEMWORDS
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_K
argument_list|,
literal|200
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|301
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_MEM
argument_list|,
name|BPF_MEMWORDS
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_A
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_MEM
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|2
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_REQUIRE
argument_list|(
name|BPF_MEMWORDS
operator|>
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|102
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_st4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_st4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ST"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_st4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_K
argument_list|,
literal|100
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
name|BPF_MEMWORDS
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_K
argument_list|,
literal|200
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|301
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_MEM
argument_list|,
name|BPF_MEMWORDS
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_A
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_MEM
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|2
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_REQUIRE
argument_list|(
name|BPF_MEMWORDS
operator|>
literal|6
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|102
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_st5
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_st5
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_ST"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_st5
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|bpf_insn
name|insns
index|[
literal|5
operator|*
name|BPF_MEMWORDS
operator|+
literal|2
index|]
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|size_t
name|k
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
name|BPF_MEMWORDS
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|memset
argument_list|(
name|insns
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
argument_list|)
expr_stmt|;
comment|/* for each k do M[k] = k */
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|BPF_MEMWORDS
condition|;
name|k
operator|++
control|)
block|{
name|insns
index|[
literal|2
operator|*
name|k
index|]
operator|.
name|code
operator|=
name|BPF_LD
operator|+
name|BPF_IMM
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|k
index|]
operator|.
name|k
operator|=
literal|3
operator|*
name|k
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|k
operator|+
literal|1
index|]
operator|.
name|code
operator|=
name|BPF_ST
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|k
operator|+
literal|1
index|]
operator|.
name|k
operator|=
name|k
expr_stmt|;
block|}
comment|/* load wirelen into A */
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
index|]
operator|.
name|code
operator|=
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
expr_stmt|;
comment|/* for each k, if (A == k + 1) return M[k] */
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|BPF_MEMWORDS
condition|;
name|k
operator|++
control|)
block|{
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|1
index|]
operator|.
name|code
operator|=
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|1
index|]
operator|.
name|k
operator|=
name|k
operator|+
literal|1
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|1
index|]
operator|.
name|jt
operator|=
literal|0
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|1
index|]
operator|.
name|jf
operator|=
literal|2
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|2
index|]
operator|.
name|code
operator|=
name|BPF_LD
operator|+
name|BPF_MEM
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|2
index|]
operator|.
name|k
operator|=
name|k
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|3
index|]
operator|.
name|code
operator|=
name|BPF_RET
operator|+
name|BPF_A
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|3
index|]
operator|.
name|k
operator|=
literal|0
expr_stmt|;
block|}
name|insns
index|[
literal|5
operator|*
name|BPF_MEMWORDS
operator|+
literal|1
index|]
operator|.
name|code
operator|=
name|BPF_RET
operator|+
name|BPF_K
expr_stmt|;
name|insns
index|[
literal|5
operator|*
name|BPF_MEMWORDS
operator|+
literal|1
index|]
operator|.
name|k
operator|=
name|UINT32_MAX
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|1
init|;
name|k
operator|<=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
condition|;
name|k
operator|++
control|)
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|k
argument_list|,
name|k
argument_list|)
operator|==
literal|3
operator|*
operator|(
name|k
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_stx1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_stx1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_STX"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_stx1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_STX
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_MEM
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|16
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
condition|;
name|i
operator|++
control|)
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|i
argument_list|,
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
argument_list|)
operator|==
name|i
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_stx2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_stx2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_STX"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_stx2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_STX
argument_list|,
name|BPF_MEMWORDS
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_MEM
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator|+
name|BPF_TXA
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_stx3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_stx3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_STX"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_stx3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_STX
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_STX
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_STX
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_MEM
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_MEM
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_MEM
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_MEM
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_MEM
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|16
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
condition|;
name|i
operator|++
control|)
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|i
argument_list|,
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
argument_list|)
operator|==
literal|3
operator|*
name|i
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_stx4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_stx4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation of BPF_STX"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_stx4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|bpf_insn
name|insns
index|[
literal|5
operator|*
name|BPF_MEMWORDS
operator|+
literal|2
index|]
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|size_t
name|k
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
name|BPF_MEMWORDS
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|memset
argument_list|(
name|insns
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
argument_list|)
expr_stmt|;
comment|/* for each k do M[k] = k */
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|BPF_MEMWORDS
condition|;
name|k
operator|++
control|)
block|{
name|insns
index|[
literal|2
operator|*
name|k
index|]
operator|.
name|code
operator|=
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|k
index|]
operator|.
name|k
operator|=
literal|3
operator|*
name|k
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|k
operator|+
literal|1
index|]
operator|.
name|code
operator|=
name|BPF_STX
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|k
operator|+
literal|1
index|]
operator|.
name|k
operator|=
name|k
expr_stmt|;
block|}
comment|/* load wirelen into A */
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
index|]
operator|.
name|code
operator|=
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_LEN
expr_stmt|;
comment|/* for each k, if (A == k + 1) return M[k] */
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|BPF_MEMWORDS
condition|;
name|k
operator|++
control|)
block|{
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|1
index|]
operator|.
name|code
operator|=
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|1
index|]
operator|.
name|k
operator|=
name|k
operator|+
literal|1
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|1
index|]
operator|.
name|jt
operator|=
literal|0
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|1
index|]
operator|.
name|jf
operator|=
literal|2
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|2
index|]
operator|.
name|code
operator|=
name|BPF_LD
operator|+
name|BPF_MEM
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|2
index|]
operator|.
name|k
operator|=
name|k
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|3
index|]
operator|.
name|code
operator|=
name|BPF_RET
operator|+
name|BPF_A
expr_stmt|;
name|insns
index|[
literal|2
operator|*
name|BPF_MEMWORDS
operator|+
literal|3
operator|*
name|k
operator|+
literal|3
index|]
operator|.
name|k
operator|=
literal|0
expr_stmt|;
block|}
name|insns
index|[
literal|5
operator|*
name|BPF_MEMWORDS
operator|+
literal|1
index|]
operator|.
name|code
operator|=
name|BPF_RET
operator|+
name|BPF_K
expr_stmt|;
name|insns
index|[
literal|5
operator|*
name|BPF_MEMWORDS
operator|+
literal|1
index|]
operator|.
name|k
operator|=
name|UINT32_MAX
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|1
init|;
name|k
operator|<=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
condition|;
name|k
operator|++
control|)
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
name|k
argument_list|,
name|k
argument_list|)
operator|==
literal|3
operator|*
operator|(
name|k
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_opt_ld_abs_1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_opt_ld_abs_1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation with length optimization "
literal|"applied to BPF_LD+BPF_ABS"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_opt_ld_abs_1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
literal|12
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x800
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|26
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|30
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|30
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|, 	}
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|2
index|]
index|[
literal|34
index|]
init|=
block|{
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|}
block|,
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|}
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|pkt
index|[
name|i
index|]
argument_list|)
condition|;
name|j
operator|++
control|)
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
block|}
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_opt_ld_abs_2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_opt_ld_abs_2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation with length optimization "
literal|"applied to BPF_LD+BPF_ABS"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_opt_ld_abs_2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|26
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|30
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|3
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|30
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
literal|12
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x800
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|, 	}
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|2
index|]
index|[
literal|34
index|]
init|=
block|{
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|}
block|,
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|}
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|pkt
index|[
name|i
index|]
argument_list|)
condition|;
name|j
operator|++
control|)
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
block|}
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_opt_ld_abs_3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_opt_ld_abs_3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation with length optimization "
literal|"applied to BPF_LD+BPF_ABS"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_opt_ld_abs_3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|30
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|26
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|3
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|26
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
literal|12
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x800
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|, 	}
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|2
index|]
index|[
literal|34
index|]
init|=
block|{
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|}
block|,
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|}
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|pkt
index|[
name|i
index|]
argument_list|)
condition|;
name|j
operator|++
control|)
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
block|}
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_opt_ld_ind_1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_opt_ld_ind_1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation with length optimization "
literal|"applied to BPF_LD+BPF_IND"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_opt_ld_ind_1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|12
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x800
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|14
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|18
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|18
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|, 	}
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|2
index|]
index|[
literal|34
index|]
init|=
block|{
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|}
block|,
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|}
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|pkt
index|[
name|i
index|]
argument_list|)
condition|;
name|j
operator|++
control|)
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
block|}
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_opt_ld_ind_2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_opt_ld_ind_2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation with length optimization "
literal|"applied to BPF_LD+BPF_IND"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_opt_ld_ind_2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|26
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|30
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|3
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|30
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|12
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x800
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|, 	}
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|2
index|]
index|[
literal|34
index|]
init|=
block|{
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|}
block|,
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|}
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|pkt
index|[
name|i
index|]
argument_list|)
condition|;
name|j
operator|++
control|)
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
block|}
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_opt_ld_ind_3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_opt_ld_ind_3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation with length optimization "
literal|"applied to BPF_LD+BPF_IND"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_opt_ld_ind_3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|15
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|15
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|11
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|3
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|11
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|12
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x800
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|, 	}
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|2
index|]
index|[
literal|34
index|]
init|=
block|{
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|}
block|,
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|}
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|pkt
index|[
name|i
index|]
argument_list|)
condition|;
name|j
operator|++
control|)
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
block|}
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_opt_ld_ind_4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_opt_ld_ind_4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test JIT compilation with length optimization "
literal|"applied to BPF_LD+BPF_IND"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_opt_ld_ind_4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|11
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|19
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|15
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|3
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_IND
argument_list|,
literal|15
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|12
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x800
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|, 	}
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|2
index|]
index|[
literal|34
index|]
init|=
block|{
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|}
block|,
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|,
literal|25
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x23
block|,
literal|0x80
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x0f
block|}
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|pkt
index|[
name|i
index|]
argument_list|)
condition|;
name|j
operator|++
control|)
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|j
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
block|}
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_abc_ja
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_abc_ja
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test ABC optimization with a single BPF_JMP+BPF_JA"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_abc_ja
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|3
argument_list|)
block|,
comment|/* min. length 4 */
name|BPF_STMT
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JA
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
name|UINT32_MAX
operator|-
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|2
argument_list|)
block|,
comment|/* min. length 6 */
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_A
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|7
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|, 	}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|6
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
comment|/* UINT32_MAX: */
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_abc_ja_over
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_abc_ja_over
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test ABC optimization when BPF_JMP+BPF_JA jumps over all loads"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_abc_ja_over
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JA
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|5
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|6
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|)
block|, 	}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
decl_stmt|;
comment|/* the program doesn't read any data */
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_abc_ld_chain
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_abc_ld_chain
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test ABC optimization of a chain of BPF_LD instructions "
literal|"with exits leading to a single BPF_RET"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_abc_ld_chain
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|3
argument_list|)
block|,
comment|/* min. length 4 */
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
literal|4
argument_list|)
block|,
comment|/* min. length 6 */
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGE
operator|+
name|BPF_K
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|6
argument_list|)
block|,
comment|/* min. length 10 */
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JGT
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|123456789
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|987654321
argument_list|)
block|, 	}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|10
index|]
init|=
block|{}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Packet is too short. */
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* !(pkt[3] == 8) => return 123456789 */
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|123456789
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|123456789
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|123456789
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|123456789
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|123456789
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|9
argument_list|,
literal|9
argument_list|)
operator|==
literal|123456789
argument_list|)
expr_stmt|;
comment|/* !(pkt[4:2]>= 7) => too short or return 123456789 */
name|pkt
index|[
literal|3
index|]
operator|=
literal|8
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|123456789
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|9
argument_list|,
literal|9
argument_list|)
operator|==
literal|123456789
argument_list|)
expr_stmt|;
comment|/* !(pkt[6:4]> 6) => too short or return 987654321 */
name|pkt
index|[
literal|4
index|]
operator|=
name|pkt
index|[
literal|5
index|]
operator|=
literal|1
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|9
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|10
argument_list|,
literal|10
argument_list|)
operator|==
literal|987654321
argument_list|)
expr_stmt|;
comment|/* (pkt[6:4]> 6) => too short or return 123456789 */
name|pkt
index|[
literal|6
index|]
operator|=
name|pkt
index|[
literal|7
index|]
operator|=
name|pkt
index|[
literal|8
index|]
operator|=
name|pkt
index|[
literal|9
index|]
operator|=
literal|1
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|9
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|10
argument_list|,
literal|10
argument_list|)
operator|==
literal|123456789
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_examples_1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_examples_1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test the first example from bpf(4) - "
literal|"accept Reverse ARP requests"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_examples_1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
comment|/* 	 * The following filter is taken from the Reverse ARP 	 * Daemon. It accepts only Reverse ARP requests. 	 */
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
literal|12
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8035
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
literal|20
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|42
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|, 	}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|22
index|]
init|=
block|{}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Packet is too short. */
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|9
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|10
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|11
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|12
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|13
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|14
argument_list|,
literal|14
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|17
argument_list|,
literal|17
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|18
argument_list|,
literal|18
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|19
argument_list|,
literal|19
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|20
argument_list|,
literal|20
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* The packet doesn't match. */
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|22
argument_list|,
literal|22
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* Still no match after setting the protocol field. */
name|pkt
index|[
literal|12
index|]
operator|=
literal|0x80
expr_stmt|;
name|pkt
index|[
literal|13
index|]
operator|=
literal|0x35
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|22
argument_list|,
literal|22
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* Set RARP message type. */
name|pkt
index|[
literal|21
index|]
operator|=
literal|3
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|22
argument_list|,
literal|22
argument_list|)
operator|==
literal|42
argument_list|)
expr_stmt|;
comment|/* Packet is too short. */
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|9
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|10
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|11
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|12
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|13
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|14
argument_list|,
literal|14
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|17
argument_list|,
literal|17
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|18
argument_list|,
literal|18
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|19
argument_list|,
literal|19
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|20
argument_list|,
literal|20
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* Change RARP message type. */
name|pkt
index|[
literal|20
index|]
operator|=
literal|3
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|22
argument_list|,
literal|22
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_examples_2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_examples_2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test the second example from bpf(4) - "
literal|"accept IP packets between two specified hosts"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_examples_2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
comment|/* 	 * This filter accepts only IP packets between host 128.3.112.15 	 * and 128.3.112.35. 	 */
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
literal|12
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x0800
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|26
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|30
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x80037023
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_W
operator|+
name|BPF_ABS
argument_list|,
literal|30
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x8003700f
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|, 	}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|34
index|]
init|=
block|{}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Packet is too short. */
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|9
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|10
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|11
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|12
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|13
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|14
argument_list|,
literal|14
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|17
argument_list|,
literal|17
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|18
argument_list|,
literal|18
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|19
argument_list|,
literal|19
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|20
argument_list|,
literal|20
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|22
argument_list|,
literal|22
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|23
argument_list|,
literal|23
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|24
argument_list|,
literal|24
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|25
argument_list|,
literal|25
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|26
argument_list|,
literal|26
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|27
argument_list|,
literal|27
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|28
argument_list|,
literal|28
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|29
argument_list|,
literal|29
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|30
argument_list|,
literal|30
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|31
argument_list|,
literal|31
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|33
argument_list|,
literal|33
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* The packet doesn't match. */
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|34
argument_list|,
literal|34
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* Still no match after setting the protocol field. */
name|pkt
index|[
literal|12
index|]
operator|=
literal|8
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|34
argument_list|,
literal|34
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|pkt
index|[
literal|26
index|]
operator|=
literal|128
expr_stmt|;
name|pkt
index|[
literal|27
index|]
operator|=
literal|3
expr_stmt|;
name|pkt
index|[
literal|28
index|]
operator|=
literal|112
expr_stmt|;
name|pkt
index|[
literal|29
index|]
operator|=
literal|15
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|34
argument_list|,
literal|34
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|pkt
index|[
literal|30
index|]
operator|=
literal|128
expr_stmt|;
name|pkt
index|[
literal|31
index|]
operator|=
literal|3
expr_stmt|;
name|pkt
index|[
literal|32
index|]
operator|=
literal|112
expr_stmt|;
name|pkt
index|[
literal|33
index|]
operator|=
literal|35
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|34
argument_list|,
literal|34
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
comment|/* Swap the ip addresses. */
name|pkt
index|[
literal|26
index|]
operator|=
literal|128
expr_stmt|;
name|pkt
index|[
literal|27
index|]
operator|=
literal|3
expr_stmt|;
name|pkt
index|[
literal|28
index|]
operator|=
literal|112
expr_stmt|;
name|pkt
index|[
literal|29
index|]
operator|=
literal|35
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|34
argument_list|,
literal|34
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|pkt
index|[
literal|30
index|]
operator|=
literal|128
expr_stmt|;
name|pkt
index|[
literal|31
index|]
operator|=
literal|3
expr_stmt|;
name|pkt
index|[
literal|32
index|]
operator|=
literal|112
expr_stmt|;
name|pkt
index|[
literal|33
index|]
operator|=
literal|15
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|34
argument_list|,
literal|34
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
comment|/* Packet is too short. */
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|9
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|10
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|11
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|12
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|13
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|14
argument_list|,
literal|14
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|17
argument_list|,
literal|17
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|18
argument_list|,
literal|18
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|19
argument_list|,
literal|19
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|20
argument_list|,
literal|20
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|22
argument_list|,
literal|22
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|23
argument_list|,
literal|23
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|24
argument_list|,
literal|24
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|25
argument_list|,
literal|25
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|26
argument_list|,
literal|26
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|27
argument_list|,
literal|27
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|28
argument_list|,
literal|28
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|29
argument_list|,
literal|29
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|30
argument_list|,
literal|30
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|31
argument_list|,
literal|31
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|33
argument_list|,
literal|33
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* Change the protocol field. */
name|pkt
index|[
literal|13
index|]
operator|=
literal|8
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|34
argument_list|,
literal|34
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_examples_3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_examples_3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test the third example from bpf(4) - "
literal|"accept TCP finger packets"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_examples_3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
comment|/* 	 * This filter returns only TCP finger packets. 	 */
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
literal|12
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|0x0800
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|23
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_ABS
argument_list|,
literal|20
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JSET
operator|+
name|BPF_K
argument_list|,
literal|0x1fff
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_B
operator|+
name|BPF_MSH
argument_list|,
literal|14
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|14
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|79
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_H
operator|+
name|BPF_IND
argument_list|,
literal|16
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator|+
name|BPF_JEQ
operator|+
name|BPF_K
argument_list|,
literal|79
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
name|UINT32_MAX
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_RET
operator|+
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|, 	}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|30
index|]
init|=
block|{}
decl_stmt|;
comment|/* Set IP fragment offset to non-zero. */
name|pkt
index|[
literal|20
index|]
operator|=
literal|1
expr_stmt|;
name|pkt
index|[
literal|21
index|]
operator|=
literal|1
expr_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Packet is too short. */
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|9
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|10
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|11
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|12
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|13
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|14
argument_list|,
literal|14
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|17
argument_list|,
literal|17
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|18
argument_list|,
literal|18
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|19
argument_list|,
literal|19
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|20
argument_list|,
literal|20
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|22
argument_list|,
literal|22
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|23
argument_list|,
literal|23
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|24
argument_list|,
literal|24
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|25
argument_list|,
literal|25
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|26
argument_list|,
literal|26
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|27
argument_list|,
literal|27
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|28
argument_list|,
literal|28
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|29
argument_list|,
literal|29
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* The packet doesn't match. */
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|30
argument_list|,
literal|30
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* Still no match after setting the protocol field. */
name|pkt
index|[
literal|12
index|]
operator|=
literal|8
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|30
argument_list|,
literal|30
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* Get one step closer to the match. */
name|pkt
index|[
literal|23
index|]
operator|=
literal|6
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|30
argument_list|,
literal|30
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* Set IP fragment offset to zero. */
name|pkt
index|[
literal|20
index|]
operator|=
literal|0x20
expr_stmt|;
name|pkt
index|[
literal|21
index|]
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|30
argument_list|,
literal|30
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* Set IP header length to 12. */
name|pkt
index|[
literal|14
index|]
operator|=
literal|0xd3
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|30
argument_list|,
literal|30
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* Match one branch of the program. */
name|pkt
index|[
literal|27
index|]
operator|=
literal|79
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|30
argument_list|,
literal|30
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
comment|/* Match the other branch of the program. */
name|pkt
index|[
literal|29
index|]
operator|=
literal|79
expr_stmt|;
name|pkt
index|[
literal|27
index|]
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|30
argument_list|,
literal|30
argument_list|)
operator|==
name|UINT32_MAX
argument_list|)
expr_stmt|;
comment|/* Packet is too short. */
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|9
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|10
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|11
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|12
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|13
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|14
argument_list|,
literal|14
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|15
argument_list|,
literal|15
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|17
argument_list|,
literal|17
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|18
argument_list|,
literal|18
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|19
argument_list|,
literal|19
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|20
argument_list|,
literal|20
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|22
argument_list|,
literal|22
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|23
argument_list|,
literal|23
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|24
argument_list|,
literal|24
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|25
argument_list|,
literal|25
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|26
argument_list|,
literal|26
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|27
argument_list|,
literal|27
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|28
argument_list|,
literal|28
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|29
argument_list|,
literal|29
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* Set IP header length to 16. Packet is too short. */
name|pkt
index|[
literal|14
index|]
operator|=
literal|4
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|jitcall
argument_list|(
name|code
argument_list|,
name|pkt
argument_list|,
literal|30
argument_list|,
literal|30
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_cop_no_ctx
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_cop_no_ctx
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test that BPF_MISC|BPF_COP "
literal|"instruction can't be accepted without a context"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_cop_no_ctx
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator|+
name|BPF_COP
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|7
argument_list|)
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
operator|!
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_copx_no_ctx
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_copx_no_ctx
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test that BPF_MISC|BPF_COPX "
literal|"instruction can't be accepted without a context"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_copx_no_ctx
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator|+
name|BPF_COPX
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_K
argument_list|,
literal|7
argument_list|)
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
operator|!
name|bpf_validate
argument_list|(
name|insns
argument_list|,
name|insn_count
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|bpfjit_generate_code
argument_list|(
name|NULL
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TP_ADD_TCS
argument_list|(
argument|tp
argument_list|)
end_macro

begin_block
block|{
comment|/* 	 * For every new test please also add a similar test 	 * to ../../net/bpfjit/t_bpfjit.c 	 */
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_empty
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_add_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_sub_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_mul_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div0_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div1_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div2_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div4_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div10_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div10000_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div7609801_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div80000000_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_and_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_or_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_lsh_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_lsh0_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_rsh_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_rsh0_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_modulo_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_add_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_sub_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_mul_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div0_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div1_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div2_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div4_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div10_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div10000_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div7609801_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_div80000000_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_and_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_or_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_lsh_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_lsh0_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_rsh_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_rsh0_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_modulo_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_alu_neg
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_jmp_ja
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_jmp_jgt_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_jmp_jge_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_jmp_jeq_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_jmp_jset_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_jmp_modulo_k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_jmp_jgt_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_jmp_jge_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_jmp_jeq_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_jmp_jset_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_jmp_modulo_x
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_ld_abs
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_ld_abs_k_overflow
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_ld_ind
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_ld_ind_k_overflow
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_ld_ind_x_overflow1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_ld_ind_x_overflow2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_ld_len
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_ld_imm
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_ldx_imm1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_ldx_imm2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_ldx_len1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_ldx_len2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_ldx_msh
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_misc_tax
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_misc_txa
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_st1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_st2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_st3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_st4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_st5
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_stx1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_stx2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_stx3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_stx4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_opt_ld_abs_1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_opt_ld_abs_2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_opt_ld_abs_3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_opt_ld_ind_1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_opt_ld_ind_2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_opt_ld_ind_3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_opt_ld_ind_4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_abc_ja
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_abc_ja_over
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_abc_ld_chain
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_examples_1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_examples_2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_examples_3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_cop_no_ctx
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_copx_no_ctx
argument_list|)
expr_stmt|;
return|return
name|atf_no_error
argument_list|()
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: t_ptrace_wait.c,v 1.58 2017/01/14 04:37:55 kamil Exp $	*/
end_comment

begin_comment
comment|/*-  * Copyright (c) 2016 The NetBSD Foundation, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"$NetBSD: t_ptrace_wait.c,v 1.58 2017/01/14 04:37:55 kamil Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/ptrace.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<machine/reg.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<atf-c.h>
end_include

begin_include
include|#
directive|include
file|"h_macros.h"
end_include

begin_include
include|#
directive|include
file|"t_ptrace_wait.h"
end_include

begin_include
include|#
directive|include
file|"msg.h"
end_include

begin_define
define|#
directive|define
name|PARENT_TO_CHILD
parameter_list|(
name|info
parameter_list|,
name|fds
parameter_list|,
name|msg
parameter_list|)
define|\
value|ATF_REQUIRE(msg_write_child(info " to child " # fds,&fds,&msg, sizeof(msg)) == 0)
end_define

begin_define
define|#
directive|define
name|CHILD_FROM_PARENT
parameter_list|(
name|info
parameter_list|,
name|fds
parameter_list|,
name|msg
parameter_list|)
define|\
value|FORKEE_ASSERT(msg_read_parent(info " from parent " # fds,&fds,&msg, sizeof(msg)) == 0)
end_define

begin_define
define|#
directive|define
name|CHILD_TO_PARENT
parameter_list|(
name|info
parameter_list|,
name|fds
parameter_list|,
name|msg
parameter_list|)
define|\
value|FORKEE_ASSERT(msg_write_parent(info " to parent " # fds,&fds,&msg, sizeof(msg)) == 0)
end_define

begin_define
define|#
directive|define
name|PARENT_FROM_CHILD
parameter_list|(
name|info
parameter_list|,
name|fds
parameter_list|,
name|msg
parameter_list|)
define|\
value|ATF_REQUIRE(msg_read_child(info " from parent " # fds,&fds,&msg, sizeof(msg)) == 0)
end_define

begin_expr_stmt
name|ATF_TC
argument_list|(
name|traceme1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|traceme1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify SIGSTOP followed by _exit(2) in a child"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|traceme1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|traceme2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|traceme2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify SIGSTOP followed by _exit(2) in a child"
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
specifier|static
name|int
name|traceme2_caught
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|traceme2_sighandler
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
name|FORKEE_ASSERT_EQ
argument_list|(
name|sig
argument_list|,
name|SIGINT
argument_list|)
expr_stmt|;
operator|++
name|traceme2_caught
expr_stmt|;
block|}
end_function

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|traceme2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|,
name|sigsent
init|=
name|SIGINT
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|struct
name|sigaction
name|sa
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|sa
operator|.
name|sa_handler
operator|=
name|traceme2_sighandler
expr_stmt|;
name|sa
operator|.
name|sa_flags
operator|=
name|SA_SIGINFO
expr_stmt|;
name|sigemptyset
argument_list|(
operator|&
name|sa
operator|.
name|sa_mask
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|sigaction
argument_list|(
name|sigsent
argument_list|,
operator|&
name|sa
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|traceme2_caught
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and with "
literal|"signal %s to be sent\n"
argument_list|,
name|strsignal
argument_list|(
name|sigsent
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
name|sigsent
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the exited child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|traceme3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|traceme3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify SIGSTOP followed by termination by a signal in a child"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|traceme3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|,
name|sigsent
init|=
name|SIGINT
comment|/* Without core-dump */
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
name|FORKEE_ASSERTX
argument_list|(
literal|0
operator|&&
literal|"Child should be terminated by a signal from its parent"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and with "
literal|"signal %s to be sent\n"
argument_list|,
name|strsignal
argument_list|(
name|sigsent
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
name|sigsent
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_signaled
argument_list|(
name|status
argument_list|,
name|sigsent
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the exited child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|traceme4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|traceme4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify SIGSTOP followed by SIGCONT and _exit(2) in a child"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|traceme4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|,
name|sigsent
init|=
name|SIGCONT
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigsent
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigsent
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigsent
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the exited child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_if
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_PID
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|attach1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|attach1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Assert that tracer sees process termination before the parent"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|attach1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|msg_fds
name|parent_tracee
decl_stmt|,
name|parent_tracer
decl_stmt|;
specifier|const
name|int
name|exitval_tracee
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|exitval_tracer
init|=
literal|10
decl_stmt|;
name|pid_t
name|tracee
decl_stmt|,
name|tracer
decl_stmt|,
name|wpid
decl_stmt|;
name|uint8_t
name|msg
init|=
literal|0xde
decl_stmt|;
comment|/* dummy message for IPC based on pipe(2) */
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Spawn tracee\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracee
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tracee
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracee
operator|==
literal|0
condition|)
block|{
comment|// Wait for parent to let us exit
name|CHILD_FROM_PARENT
argument_list|(
literal|"exit tracee"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval_tracee
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Spawn debugger\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracer
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tracer
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracer
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_ATTACH from tracee %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_ATTACH
argument_list|,
name|tracee
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Wait for tracee and assert that it was stopped w/ SIGSTOP */
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|forkee_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGSTOP
argument_list|)
expr_stmt|;
comment|/* Resume tracee with PT_CONTINUE */
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|tracee
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Inform parent that tracer has attached to tracee */
name|CHILD_TO_PARENT
argument_list|(
literal|"tracer ready"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* Wait for parent to tell use that tracee should have exited */
name|CHILD_FROM_PARENT
argument_list|(
literal|"wait for tracee exit"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* Wait for tracee and assert that it exited */
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|forkee_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Tracee %d exited with %d\n"
argument_list|,
name|tracee
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the tracer process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval_tracer
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Wait for the tracer to attach to the tracee\n"
argument_list|)
expr_stmt|;
name|PARENT_FROM_CHILD
argument_list|(
literal|"tracer ready"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Resume the tracee and let it exit\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"exit tracee"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Detect that tracee is zombie\n"
argument_list|)
expr_stmt|;
name|await_zombie
argument_list|(
name|tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Assert that there is no status about tracee %d - "
literal|"Tracer must detect zombie first - calling %s()\n"
argument_list|,
name|tracee
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Tell the tracer child should have exited\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"wait for tracee exit"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for tracer to finish its job and exit - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait from tracer child to complete waiting for tracee\n"
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracer
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracer
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracer
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for tracee to finish its job and exit - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracer
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracee
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_PID
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|attach2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|attach2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Assert that any tracer sees process termination before its "
literal|"parent"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|attach2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|msg_fds
name|parent_tracer
decl_stmt|,
name|parent_tracee
decl_stmt|;
specifier|const
name|int
name|exitval_tracee
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|exitval_tracer1
init|=
literal|10
decl_stmt|,
name|exitval_tracer2
init|=
literal|20
decl_stmt|;
name|pid_t
name|tracee
decl_stmt|,
name|tracer
decl_stmt|,
name|wpid
decl_stmt|;
name|uint8_t
name|msg
init|=
literal|0xde
decl_stmt|;
comment|/* dummy message for IPC based on pipe(2) */
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Spawn tracee\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracee
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tracee
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracee
operator|==
literal|0
condition|)
block|{
comment|/* Wait for message from the parent */
name|CHILD_FROM_PARENT
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval_tracee
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Spawn debugger\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracer
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tracer
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracer
operator|==
literal|0
condition|)
block|{
comment|/* Fork again and drop parent to reattach to PID 1 */
name|tracer
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracer
operator|!=
literal|0
condition|)
name|_exit
argument_list|(
name|exitval_tracer1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling PT_ATTACH from tracee %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_ATTACH
argument_list|,
name|tracee
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Wait for tracee and assert that it was stopped w/ SIGSTOP */
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|forkee_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGSTOP
argument_list|)
expr_stmt|;
comment|/* Resume tracee with PT_CONTINUE */
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|tracee
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Inform parent that tracer has attached to tracee */
name|CHILD_TO_PARENT
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|CHILD_FROM_PARENT
argument_list|(
literal|"Message 2"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* Wait for tracee and assert that it exited */
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|forkee_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the tracer process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval_tracer2
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Wait for the tracer process (direct child) to exit calling "
literal|"%s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracer
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracer
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracer1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for the non-exited tracee process with %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
name|NULL
argument_list|,
name|WNOHANG
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for the tracer to attach to the tracee\n"
argument_list|)
expr_stmt|;
name|PARENT_FROM_CHILD
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Resume the tracee and let it exit\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Detect that tracee is zombie\n"
argument_list|)
expr_stmt|;
name|await_zombie
argument_list|(
name|tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Assert that there is no status about tracee - "
literal|"Tracer must detect zombie first - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Resume the tracer and let it detect exited tracee\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"Message 2"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for tracee to finish its job and exit - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracer
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracee
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|ATF_TC
argument_list|(
name|attach3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|attach3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Assert that tracer parent can PT_ATTACH to its child"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|attach3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|msg_fds
name|parent_tracee
decl_stmt|;
specifier|const
name|int
name|exitval_tracee
init|=
literal|5
decl_stmt|;
name|pid_t
name|tracee
decl_stmt|,
name|wpid
decl_stmt|;
name|uint8_t
name|msg
init|=
literal|0xde
decl_stmt|;
comment|/* dummy message for IPC based on pipe(2) */
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Spawn tracee\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracee
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tracee
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracee
operator|==
literal|0
condition|)
block|{
name|CHILD_FROM_PARENT
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Parent should now attach to tracee\n"
argument_list|)
expr_stmt|;
name|CHILD_FROM_PARENT
argument_list|(
literal|"Message 2"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* Wait for message from the parent */
name|_exit
argument_list|(
name|exitval_tracee
argument_list|)
expr_stmt|;
block|}
name|PARENT_TO_CHILD
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling PT_ATTACH for tracee %d\n"
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_ATTACH
argument_list|,
name|tracee
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for the stopped tracee process with %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGSTOP
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Resume tracee with PT_CONTINUE\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|tracee
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Let the tracee exit now\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"Message 2"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for tracee to exit with %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for tracee\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracee
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|attach4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|attach4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Assert that tracer child can PT_ATTACH to its parent"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|attach4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|msg_fds
name|parent_tracee
decl_stmt|;
specifier|const
name|int
name|exitval_tracer
init|=
literal|5
decl_stmt|;
name|pid_t
name|tracer
decl_stmt|,
name|wpid
decl_stmt|;
name|uint8_t
name|msg
init|=
literal|0xde
decl_stmt|;
comment|/* dummy message for IPC based on pipe(2) */
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Spawn tracer\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracee
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tracer
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracer
operator|==
literal|0
condition|)
block|{
comment|/* Wait for message from the parent */
name|CHILD_FROM_PARENT
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Attach to parent PID %d with PT_ATTACH from child\n"
argument_list|,
name|getppid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_ATTACH
argument_list|,
name|getppid
argument_list|()
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for the stopped parent process with %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|getppid
argument_list|()
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|getppid
argument_list|()
argument_list|)
expr_stmt|;
name|forkee_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGSTOP
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Resume parent with PT_DETACH\n"
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_DETACH
argument_list|,
name|getppid
argument_list|()
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Tell parent we are ready */
name|CHILD_TO_PARENT
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval_tracer
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Wait for the tracer to become ready\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Allow the tracer to exit now\n"
argument_list|)
expr_stmt|;
name|PARENT_FROM_CHILD
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for tracer to exit with %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracer
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracer
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracer
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for tracer\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracer
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracee
argument_list|)
expr_stmt|;
block|}
end_block

begin_if
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_PID
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|attach5
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|attach5
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Assert that tracer sees its parent when attached to tracer "
literal|"(check getppid(2))"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|attach5
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|msg_fds
name|parent_tracer
decl_stmt|,
name|parent_tracee
decl_stmt|;
specifier|const
name|int
name|exitval_tracee
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|exitval_tracer
init|=
literal|10
decl_stmt|;
name|pid_t
name|parent
decl_stmt|,
name|tracee
decl_stmt|,
name|tracer
decl_stmt|,
name|wpid
decl_stmt|;
name|uint8_t
name|msg
init|=
literal|0xde
decl_stmt|;
comment|/* dummy message for IPC based on pipe(2) */
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Spawn tracee\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracer
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracee
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tracee
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracee
operator|==
literal|0
condition|)
block|{
name|parent
operator|=
name|getppid
argument_list|()
expr_stmt|;
comment|/* Emit message to the parent */
name|CHILD_TO_PARENT
argument_list|(
literal|"tracee ready"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|CHILD_FROM_PARENT
argument_list|(
literal|"exit tracee"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|parent
argument_list|,
name|getppid
argument_list|()
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval_tracee
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Wait for child to record its parent identifier (pid)\n"
argument_list|)
expr_stmt|;
name|PARENT_FROM_CHILD
argument_list|(
literal|"tracee ready"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Spawn debugger\n"
argument_list|)
expr_stmt|;
name|tracer
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracer
operator|==
literal|0
condition|)
block|{
comment|/* No IPC to communicate with the child */
name|printf
argument_list|(
literal|"Before calling PT_ATTACH from tracee %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_ATTACH
argument_list|,
name|tracee
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Wait for tracee and assert that it was stopped w/ SIGSTOP */
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|forkee_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGSTOP
argument_list|)
expr_stmt|;
comment|/* Resume tracee with PT_CONTINUE */
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|tracee
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Inform parent that tracer has attached to tracee */
name|CHILD_TO_PARENT
argument_list|(
literal|"tracer ready"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* Wait for parent to tell use that tracee should have exited */
name|CHILD_FROM_PARENT
argument_list|(
literal|"wait for tracee exit"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* Wait for tracee and assert that it exited */
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|forkee_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the tracer process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval_tracer
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Wait for the tracer to attach to the tracee\n"
argument_list|)
expr_stmt|;
name|PARENT_FROM_CHILD
argument_list|(
literal|"tracer ready"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Resume the tracee and let it exit\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"exit tracee"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Detect that tracee is zombie\n"
argument_list|)
expr_stmt|;
name|await_zombie
argument_list|(
name|tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Assert that there is no status about tracee - "
literal|"Tracer must detect zombie first - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Tell the tracer child should have exited\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"wait for tracee exit"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait from tracer child to complete waiting for tracee\n"
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracer
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracer
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracer
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for tracee to finish its job and exit - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracer
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracee
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_PID
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|attach6
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|attach6
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Assert that tracer sees its parent when attached to tracer "
literal|"(check sysctl(7) and struct kinfo_proc2)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|attach6
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|msg_fds
name|parent_tracee
decl_stmt|,
name|parent_tracer
decl_stmt|;
specifier|const
name|int
name|exitval_tracee
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|exitval_tracer
init|=
literal|10
decl_stmt|;
name|pid_t
name|parent
decl_stmt|,
name|tracee
decl_stmt|,
name|tracer
decl_stmt|,
name|wpid
decl_stmt|;
name|uint8_t
name|msg
init|=
literal|0xde
decl_stmt|;
comment|/* dummy message for IPC based on pipe(2) */
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|int
name|name
index|[
name|CTL_MAXNAME
index|]
decl_stmt|;
name|struct
name|kinfo_proc2
name|kp
decl_stmt|;
name|size_t
name|len
init|=
sizeof|sizeof
argument_list|(
name|kp
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|namelen
decl_stmt|;
name|printf
argument_list|(
literal|"Spawn tracee\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracee
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracer
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tracee
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracee
operator|==
literal|0
condition|)
block|{
name|parent
operator|=
name|getppid
argument_list|()
expr_stmt|;
comment|/* Emit message to the parent */
name|CHILD_TO_PARENT
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|CHILD_FROM_PARENT
argument_list|(
literal|"Message 2"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|namelen
operator|=
literal|0
expr_stmt|;
name|name
index|[
name|namelen
operator|++
index|]
operator|=
name|CTL_KERN
expr_stmt|;
name|name
index|[
name|namelen
operator|++
index|]
operator|=
name|KERN_PROC2
expr_stmt|;
name|name
index|[
name|namelen
operator|++
index|]
operator|=
name|KERN_PROC_PID
expr_stmt|;
name|name
index|[
name|namelen
operator|++
index|]
operator|=
name|getpid
argument_list|()
expr_stmt|;
name|name
index|[
name|namelen
operator|++
index|]
operator|=
name|len
expr_stmt|;
name|name
index|[
name|namelen
operator|++
index|]
operator|=
literal|1
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|sysctl
argument_list|(
name|name
argument_list|,
name|namelen
argument_list|,
operator|&
name|kp
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|parent
argument_list|,
name|kp
operator|.
name|p_ppid
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval_tracee
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Wait for child to record its parent identifier (pid)\n"
argument_list|)
expr_stmt|;
name|PARENT_FROM_CHILD
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Spawn debugger\n"
argument_list|)
expr_stmt|;
name|tracer
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracer
operator|==
literal|0
condition|)
block|{
comment|/* No IPC to communicate with the child */
name|printf
argument_list|(
literal|"Before calling PT_ATTACH from tracee %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_ATTACH
argument_list|,
name|tracee
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Wait for tracee and assert that it was stopped w/ SIGSTOP */
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|forkee_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGSTOP
argument_list|)
expr_stmt|;
comment|/* Resume tracee with PT_CONTINUE */
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|tracee
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Inform parent that tracer has attached to tracee */
name|CHILD_TO_PARENT
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|CHILD_FROM_PARENT
argument_list|(
literal|"Message 2"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* Wait for tracee and assert that it exited */
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|forkee_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the tracer process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval_tracer
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Wait for the tracer to attach to the tracee\n"
argument_list|)
expr_stmt|;
name|PARENT_FROM_CHILD
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Resume the tracee and let it exit\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"Message 1"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Detect that tracee is zombie\n"
argument_list|)
expr_stmt|;
name|await_zombie
argument_list|(
name|tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Assert that there is no status about tracee - "
literal|"Tracer must detect zombie first - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Resume the tracer and let it detect exited tracee\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"Message 2"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for tracer to finish its job and exit - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracer
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracer
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracer
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for tracee to finish its job and exit - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracee
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracer
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_PID
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|attach7
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|attach7
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Assert that tracer sees its parent when attached to tracer "
literal|"(check /proc/curproc/status 3rd column)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|attach7
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|msg_fds
name|parent_tracee
decl_stmt|,
name|parent_tracer
decl_stmt|;
name|int
name|rv
decl_stmt|;
specifier|const
name|int
name|exitval_tracee
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|exitval_tracer
init|=
literal|10
decl_stmt|;
name|pid_t
name|parent
decl_stmt|,
name|tracee
decl_stmt|,
name|tracer
decl_stmt|,
name|wpid
decl_stmt|;
name|uint8_t
name|msg
init|=
literal|0xde
decl_stmt|;
comment|/* dummy message for IPC based on pipe(2) */
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|FILE
modifier|*
name|fp
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
specifier|const
name|char
modifier|*
name|fname
init|=
literal|"/proc/curproc/status"
decl_stmt|;
name|char
name|s_executable
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
name|int
name|s_pid
decl_stmt|,
name|s_ppid
decl_stmt|;
comment|/* 	 * Format: 	 *  EXECUTABLE PID PPID ... 	 */
name|ATF_REQUIRE
argument_list|(
operator|(
name|rv
operator|=
name|stat
argument_list|(
name|fname
argument_list|,
operator|&
name|st
argument_list|)
operator|)
operator|==
literal|0
operator|||
operator|(
name|errno
operator|==
name|ENOENT
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|atf_tc_skip
argument_list|(
literal|"/proc/curproc/status not found"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Spawn tracee\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracee
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracer
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tracee
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracee
operator|==
literal|0
condition|)
block|{
name|parent
operator|=
name|getppid
argument_list|()
expr_stmt|;
comment|// Wait for parent to let us exit
name|CHILD_TO_PARENT
argument_list|(
literal|"tracee ready"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|CHILD_FROM_PARENT
argument_list|(
literal|"tracee exit"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|fscanf
argument_list|(
name|fp
argument_list|,
literal|"%s %d %d"
argument_list|,
name|s_executable
argument_list|,
operator|&
name|s_pid
argument_list|,
operator|&
name|s_ppid
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|fclose
argument_list|(
name|fp
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|parent
argument_list|,
name|s_ppid
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval_tracee
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Wait for child to record its parent identifier (pid)\n"
argument_list|)
expr_stmt|;
name|PARENT_FROM_CHILD
argument_list|(
literal|"tracee ready"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Spawn debugger\n"
argument_list|)
expr_stmt|;
name|tracer
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracer
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_ATTACH from tracee %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_ATTACH
argument_list|,
name|tracee
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Wait for tracee and assert that it was stopped w/ SIGSTOP */
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|forkee_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGSTOP
argument_list|)
expr_stmt|;
comment|/* Resume tracee with PT_CONTINUE */
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|tracee
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Inform parent that tracer has attached to tracee */
name|CHILD_TO_PARENT
argument_list|(
literal|"tracer ready"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* Wait for parent to tell use that tracee should have exited */
name|CHILD_FROM_PARENT
argument_list|(
literal|"wait for tracee exit"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* Wait for tracee and assert that it exited */
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|forkee_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the tracer process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval_tracer
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Wait for the tracer to attach to the tracee\n"
argument_list|)
expr_stmt|;
name|PARENT_FROM_CHILD
argument_list|(
literal|"tracer ready"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Resume the tracee and let it exit\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"tracee exit"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Detect that tracee is zombie\n"
argument_list|)
expr_stmt|;
name|await_zombie
argument_list|(
name|tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Assert that there is no status about tracee - "
literal|"Tracer must detect zombie first - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Resume the tracer and let it detect exited tracee\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"Message 2"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for tracer to finish its job and exit - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracer
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracer
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracer
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for tracee to finish its job and exit - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracee
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracer
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|ATF_TC
argument_list|(
name|eventmask1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|eventmask1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify that empty EVENT_MASK is preserved"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|eventmask1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|ptrace_event_t
name|set_event
decl_stmt|,
name|get_event
decl_stmt|;
specifier|const
name|int
name|len
init|=
sizeof|sizeof
argument_list|(
name|ptrace_event_t
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|set_event
operator|.
name|pe_set_event
operator|=
literal|0
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|set_event
argument_list|,
name|len
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|get_event
argument_list|,
name|len
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|memcmp
argument_list|(
operator|&
name|set_event
argument_list|,
operator|&
name|get_event
argument_list|,
name|len
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|eventmask2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|eventmask2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify that PTRACE_FORK in EVENT_MASK is preserved"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|eventmask2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|ptrace_event_t
name|set_event
decl_stmt|,
name|get_event
decl_stmt|;
specifier|const
name|int
name|len
init|=
sizeof|sizeof
argument_list|(
name|ptrace_event_t
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|set_event
operator|.
name|pe_set_event
operator|=
name|PTRACE_FORK
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|set_event
argument_list|,
name|len
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|get_event
argument_list|,
name|len
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|memcmp
argument_list|(
operator|&
name|set_event
argument_list|,
operator|&
name|get_event
argument_list|,
name|len
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|eventmask3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|eventmask3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify that PTRACE_VFORK in EVENT_MASK is preserved"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|eventmask3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|ptrace_event_t
name|set_event
decl_stmt|,
name|get_event
decl_stmt|;
specifier|const
name|int
name|len
init|=
sizeof|sizeof
argument_list|(
name|ptrace_event_t
argument_list|)
decl_stmt|;
name|atf_tc_expect_fail
argument_list|(
literal|"PR kern/51630"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|set_event
operator|.
name|pe_set_event
operator|=
name|PTRACE_VFORK
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|set_event
argument_list|,
name|len
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|get_event
argument_list|,
name|len
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|memcmp
argument_list|(
operator|&
name|set_event
argument_list|,
operator|&
name|get_event
argument_list|,
name|len
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|eventmask4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|eventmask4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify that PTRACE_VFORK_DONE in EVENT_MASK is preserved"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|eventmask4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|ptrace_event_t
name|set_event
decl_stmt|,
name|get_event
decl_stmt|;
specifier|const
name|int
name|len
init|=
sizeof|sizeof
argument_list|(
name|ptrace_event_t
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|set_event
operator|.
name|pe_set_event
operator|=
name|PTRACE_VFORK_DONE
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|set_event
argument_list|,
name|len
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|get_event
argument_list|,
name|len
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|memcmp
argument_list|(
operator|&
name|set_event
argument_list|,
operator|&
name|get_event
argument_list|,
name|len
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_if
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_PID
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|fork1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|fork1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify that fork(2) is intercepted by ptrace(2) with EVENT_MASK "
literal|"set to PTRACE_FORK"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|fork1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|exitval2
init|=
literal|15
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|child2
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|ptrace_state_t
name|state
decl_stmt|;
specifier|const
name|int
name|slen
init|=
sizeof|sizeof
argument_list|(
name|state
argument_list|)
decl_stmt|;
name|ptrace_event_t
name|event
decl_stmt|;
specifier|const
name|int
name|elen
init|=
sizeof|sizeof
argument_list|(
name|event
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
operator|(
name|child2
operator|=
name|fork
argument_list|()
operator|)
operator|!=
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child2
operator|==
literal|0
condition|)
name|_exit
argument_list|(
name|exitval2
argument_list|)
expr_stmt|;
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|forkee_status_exited
argument_list|(
name|status
argument_list|,
name|exitval2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Enable PTRACE_FORK in EVENT_MASK for the child %d\n"
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|event
operator|.
name|pe_set_event
operator|=
name|PTRACE_FORK
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|event
argument_list|,
name|elen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child %d\n"
argument_list|,
name|TWAIT_FNAME
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_PROCESS_STATE
argument_list|,
name|child
argument_list|,
operator|&
name|state
argument_list|,
name|slen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|state
operator|.
name|pe_report_event
argument_list|,
name|PTRACE_FORK
argument_list|)
expr_stmt|;
name|child2
operator|=
name|state
operator|.
name|pe_other_pid
expr_stmt|;
name|printf
argument_list|(
literal|"Reported PTRACE_FORK event with forkee %d\n"
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the forkee %d of the child %d\n"
argument_list|,
name|TWAIT_FNAME
argument_list|,
name|child2
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_PROCESS_STATE
argument_list|,
name|child2
argument_list|,
operator|&
name|state
argument_list|,
name|slen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|state
operator|.
name|pe_report_event
argument_list|,
name|PTRACE_FORK
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|state
operator|.
name|pe_other_pid
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the forkee process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child2
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the forkee - expected exited\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the forkee - expected no process\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected stopped "
literal|"SIGCHLD\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGCHLD
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected exited\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected no process\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|ATF_TC
argument_list|(
name|fork2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|fork2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify that fork(2) is not intercepted by ptrace(2) with empty "
literal|"EVENT_MASK"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|fork2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|exitval2
init|=
literal|15
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|child2
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|ptrace_event_t
name|event
decl_stmt|;
specifier|const
name|int
name|elen
init|=
sizeof|sizeof
argument_list|(
name|event
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
operator|(
name|child2
operator|=
name|fork
argument_list|()
operator|)
operator|!=
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child2
operator|==
literal|0
condition|)
name|_exit
argument_list|(
name|exitval2
argument_list|)
expr_stmt|;
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|forkee_status_exited
argument_list|(
name|status
argument_list|,
name|exitval2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Set empty EVENT_MASK for the child %d\n"
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|event
operator|.
name|pe_set_event
operator|=
literal|0
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|event
argument_list|,
name|elen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected stopped "
literal|"SIGCHLD\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGCHLD
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected exited\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected no process\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_if
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_PID
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|vfork1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|vfork1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify that vfork(2) is intercepted by ptrace(2) with EVENT_MASK "
literal|"set to PTRACE_VFORK"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|vfork1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|exitval2
init|=
literal|15
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|child2
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|ptrace_state_t
name|state
decl_stmt|;
specifier|const
name|int
name|slen
init|=
sizeof|sizeof
argument_list|(
name|state
argument_list|)
decl_stmt|;
name|ptrace_event_t
name|event
decl_stmt|;
specifier|const
name|int
name|elen
init|=
sizeof|sizeof
argument_list|(
name|event
argument_list|)
decl_stmt|;
name|atf_tc_expect_fail
argument_list|(
literal|"PR kern/51630"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
operator|(
name|child2
operator|=
name|vfork
argument_list|()
operator|)
operator|!=
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child2
operator|==
literal|0
condition|)
name|_exit
argument_list|(
name|exitval2
argument_list|)
expr_stmt|;
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|forkee_status_exited
argument_list|(
name|status
argument_list|,
name|exitval2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Enable PTRACE_VFORK in EVENT_MASK for the child %d\n"
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|event
operator|.
name|pe_set_event
operator|=
name|PTRACE_VFORK
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|event
argument_list|,
name|elen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child %d\n"
argument_list|,
name|TWAIT_FNAME
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_PROCESS_STATE
argument_list|,
name|child
argument_list|,
operator|&
name|state
argument_list|,
name|slen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|state
operator|.
name|pe_report_event
argument_list|,
name|PTRACE_VFORK
argument_list|)
expr_stmt|;
name|child2
operator|=
name|state
operator|.
name|pe_other_pid
expr_stmt|;
name|printf
argument_list|(
literal|"Reported PTRACE_VFORK event with forkee %d\n"
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the forkee %d of the child %d\n"
argument_list|,
name|TWAIT_FNAME
argument_list|,
name|child2
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_PROCESS_STATE
argument_list|,
name|child2
argument_list|,
operator|&
name|state
argument_list|,
name|slen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|state
operator|.
name|pe_report_event
argument_list|,
name|PTRACE_VFORK
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|state
operator|.
name|pe_other_pid
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the forkee process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child2
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the forkee - expected exited\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the forkee - expected no process\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected stopped "
literal|"SIGCHLD\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGCHLD
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected exited\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected no process\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|ATF_TC
argument_list|(
name|vfork2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|vfork2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify that vfork(2) is not intercepted by ptrace(2) with empty "
literal|"EVENT_MASK"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|vfork2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|exitval2
init|=
literal|15
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|child2
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|ptrace_event_t
name|event
decl_stmt|;
specifier|const
name|int
name|elen
init|=
sizeof|sizeof
argument_list|(
name|event
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
operator|(
name|child2
operator|=
name|vfork
argument_list|()
operator|)
operator|!=
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child2
operator|==
literal|0
condition|)
name|_exit
argument_list|(
name|exitval2
argument_list|)
expr_stmt|;
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|forkee_status_exited
argument_list|(
name|status
argument_list|,
name|exitval2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Set empty EVENT_MASK for the child %d\n"
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|event
operator|.
name|pe_set_event
operator|=
literal|0
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|event
argument_list|,
name|elen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected stopped "
literal|"SIGCHLD\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGCHLD
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected exited\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected no process\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|vforkdone1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|vforkdone1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify that vfork(2) is intercepted by ptrace(2) with EVENT_MASK "
literal|"set to PTRACE_VFORK_DONE"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|vforkdone1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|exitval2
init|=
literal|15
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|child2
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|ptrace_state_t
name|state
decl_stmt|;
specifier|const
name|int
name|slen
init|=
sizeof|sizeof
argument_list|(
name|state
argument_list|)
decl_stmt|;
name|ptrace_event_t
name|event
decl_stmt|;
specifier|const
name|int
name|elen
init|=
sizeof|sizeof
argument_list|(
name|event
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
operator|(
name|child2
operator|=
name|vfork
argument_list|()
operator|)
operator|!=
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child2
operator|==
literal|0
condition|)
name|_exit
argument_list|(
name|exitval2
argument_list|)
expr_stmt|;
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|forkee_status_exited
argument_list|(
name|status
argument_list|,
name|exitval2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Enable PTRACE_VFORK in EVENT_MASK for the child %d\n"
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|event
operator|.
name|pe_set_event
operator|=
name|PTRACE_VFORK_DONE
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|event
argument_list|,
name|elen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child %d\n"
argument_list|,
name|TWAIT_FNAME
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_PROCESS_STATE
argument_list|,
name|child
argument_list|,
operator|&
name|state
argument_list|,
name|slen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|state
operator|.
name|pe_report_event
argument_list|,
name|PTRACE_VFORK_DONE
argument_list|)
expr_stmt|;
name|child2
operator|=
name|state
operator|.
name|pe_other_pid
expr_stmt|;
name|printf
argument_list|(
literal|"Reported PTRACE_VFORK_DONE event with forkee %d\n"
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected stopped "
literal|"SIGCHLD\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGCHLD
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected exited\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected no process\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|vforkdone2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|vforkdone2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify that vfork(2) is intercepted by ptrace(2) with EVENT_MASK "
literal|"set to PTRACE_FORK | PTRACE_VFORK_DONE"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|vforkdone2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|exitval2
init|=
literal|15
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|child2
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|ptrace_state_t
name|state
decl_stmt|;
specifier|const
name|int
name|slen
init|=
sizeof|sizeof
argument_list|(
name|state
argument_list|)
decl_stmt|;
name|ptrace_event_t
name|event
decl_stmt|;
specifier|const
name|int
name|elen
init|=
sizeof|sizeof
argument_list|(
name|event
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
operator|(
name|child2
operator|=
name|vfork
argument_list|()
operator|)
operator|!=
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child2
operator|==
literal|0
condition|)
name|_exit
argument_list|(
name|exitval2
argument_list|)
expr_stmt|;
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|forkee_status_exited
argument_list|(
name|status
argument_list|,
name|exitval2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Enable PTRACE_VFORK in EVENT_MASK for the child %d\n"
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|event
operator|.
name|pe_set_event
operator|=
name|PTRACE_FORK
operator||
name|PTRACE_VFORK_DONE
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|event
argument_list|,
name|elen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child %d\n"
argument_list|,
name|TWAIT_FNAME
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_PROCESS_STATE
argument_list|,
name|child
argument_list|,
operator|&
name|state
argument_list|,
name|slen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|state
operator|.
name|pe_report_event
argument_list|,
name|PTRACE_VFORK_DONE
argument_list|)
expr_stmt|;
name|child2
operator|=
name|state
operator|.
name|pe_other_pid
expr_stmt|;
name|printf
argument_list|(
literal|"Reported PTRACE_VFORK_DONE event with forkee %d\n"
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected stopped "
literal|"SIGCHLD\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGCHLD
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected exited\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected no process\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_read_d1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_read_d1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_READ_D and len = sizeof(uint8_t)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_read_d1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint8_t
name|lookup_me
init|=
literal|0
decl_stmt|;
specifier|const
name|uint8_t
name|magic
init|=
literal|0xab
decl_stmt|;
name|struct
name|ptrace_io_desc
name|io
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_READ_D
block|,
operator|.
name|piod_offs
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lookup_me
operator|=
name|magic
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read lookup_me from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|,
literal|"got value %"
name|PRIx8
literal|" != expected %"
name|PRIx8
argument_list|,
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_read_d2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_read_d2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_READ_D and len = sizeof(uint16_t)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_read_d2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint16_t
name|lookup_me
init|=
literal|0
decl_stmt|;
specifier|const
name|uint16_t
name|magic
init|=
literal|0x1234
decl_stmt|;
name|struct
name|ptrace_io_desc
name|io
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_READ_D
block|,
operator|.
name|piod_offs
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lookup_me
operator|=
name|magic
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read lookup_me from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|,
literal|"got value %"
name|PRIx16
literal|" != expected %"
name|PRIx16
argument_list|,
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_read_d3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_read_d3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_READ_D and len = sizeof(uint32_t)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_read_d3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint32_t
name|lookup_me
init|=
literal|0
decl_stmt|;
specifier|const
name|uint32_t
name|magic
init|=
literal|0x1234abcd
decl_stmt|;
name|struct
name|ptrace_io_desc
name|io
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_READ_D
block|,
operator|.
name|piod_offs
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lookup_me
operator|=
name|magic
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read lookup_me from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|,
literal|"got value %"
name|PRIx32
literal|" != expected %"
name|PRIx32
argument_list|,
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_read_d4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_read_d4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_READ_D and len = sizeof(uint64_t)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_read_d4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint64_t
name|lookup_me
init|=
literal|0
decl_stmt|;
specifier|const
name|uint64_t
name|magic
init|=
literal|0x1234abcd9876dcfa
decl_stmt|;
name|struct
name|ptrace_io_desc
name|io
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_READ_D
block|,
operator|.
name|piod_offs
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lookup_me
operator|=
name|magic
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read lookup_me from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|,
literal|"got value %"
name|PRIx64
literal|" != expected %"
name|PRIx64
argument_list|,
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_write_d1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_write_d1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_WRITE_D and len = sizeof(uint8_t)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_write_d1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint8_t
name|lookup_me
init|=
literal|0
decl_stmt|;
specifier|const
name|uint8_t
name|magic
init|=
literal|0xab
decl_stmt|;
name|struct
name|ptrace_io_desc
name|io
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_WRITE_D
block|,
operator|.
name|piod_offs
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|lookup_me
operator|=
name|magic
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_write_d2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_write_d2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_WRITE_D and len = sizeof(uint16_t)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_write_d2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint16_t
name|lookup_me
init|=
literal|0
decl_stmt|;
specifier|const
name|uint16_t
name|magic
init|=
literal|0xab12
decl_stmt|;
name|struct
name|ptrace_io_desc
name|io
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_WRITE_D
block|,
operator|.
name|piod_offs
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|lookup_me
operator|=
name|magic
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_write_d3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_write_d3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_WRITE_D and len = sizeof(uint32_t)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_write_d3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint32_t
name|lookup_me
init|=
literal|0
decl_stmt|;
specifier|const
name|uint32_t
name|magic
init|=
literal|0xab127643
decl_stmt|;
name|struct
name|ptrace_io_desc
name|io
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_WRITE_D
block|,
operator|.
name|piod_offs
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|lookup_me
operator|=
name|magic
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_write_d4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_write_d4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_WRITE_D and len = sizeof(uint64_t)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_write_d4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint64_t
name|lookup_me
init|=
literal|0
decl_stmt|;
specifier|const
name|uint64_t
name|magic
init|=
literal|0xab12764376490123
decl_stmt|;
name|struct
name|ptrace_io_desc
name|io
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_WRITE_D
block|,
operator|.
name|piod_offs
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|lookup_me
operator|=
name|magic
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|read_d1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|read_d1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_READ_D called once"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|read_d1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|magic
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lookup_me
operator|=
name|magic
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me
operator|=
name|ptrace
argument_list|(
name|PT_READ_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|read_d2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|read_d2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_READ_D called twice"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|read_d2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me1
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me2
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|magic1
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
specifier|const
name|int
name|magic2
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lookup_me1
operator|=
name|magic1
expr_stmt|;
name|lookup_me2
operator|=
name|magic2
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me1 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me1
operator|=
name|ptrace
argument_list|(
name|PT_READ_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me1
argument_list|,
name|magic1
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me1
argument_list|,
name|magic1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me2 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me2
operator|=
name|ptrace
argument_list|(
name|PT_READ_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me2
argument_list|,
name|magic2
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me2
argument_list|,
name|magic2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|read_d3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|read_d3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_READ_D called three times"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|read_d3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me1
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me2
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me3
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|magic1
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
specifier|const
name|int
name|magic2
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
specifier|const
name|int
name|magic3
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lookup_me1
operator|=
name|magic1
expr_stmt|;
name|lookup_me2
operator|=
name|magic2
expr_stmt|;
name|lookup_me3
operator|=
name|magic3
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me1 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me1
operator|=
name|ptrace
argument_list|(
name|PT_READ_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me1
argument_list|,
name|magic1
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me1
argument_list|,
name|magic1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me2 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me2
operator|=
name|ptrace
argument_list|(
name|PT_READ_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me2
argument_list|,
name|magic2
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me2
argument_list|,
name|magic2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me3 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me3
operator|=
name|ptrace
argument_list|(
name|PT_READ_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me3
argument_list|,
name|magic3
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me3
argument_list|,
name|magic3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|read_d4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|read_d4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_READ_D called four times"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|read_d4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me1
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me2
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me3
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me4
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|magic1
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
specifier|const
name|int
name|magic2
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
specifier|const
name|int
name|magic3
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
specifier|const
name|int
name|magic4
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lookup_me1
operator|=
name|magic1
expr_stmt|;
name|lookup_me2
operator|=
name|magic2
expr_stmt|;
name|lookup_me3
operator|=
name|magic3
expr_stmt|;
name|lookup_me4
operator|=
name|magic4
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me1 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me1
operator|=
name|ptrace
argument_list|(
name|PT_READ_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me1
argument_list|,
name|magic1
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me1
argument_list|,
name|magic1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me2 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me2
operator|=
name|ptrace
argument_list|(
name|PT_READ_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me2
argument_list|,
name|magic2
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me2
argument_list|,
name|magic2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me3 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me3
operator|=
name|ptrace
argument_list|(
name|PT_READ_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me3
argument_list|,
name|magic3
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me3
argument_list|,
name|magic3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me4 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me4
operator|=
name|ptrace
argument_list|(
name|PT_READ_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me4
argument_list|,
name|magic4
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me4
argument_list|,
name|magic4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|write_d1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|write_d1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_WRITE_D called once"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|write_d1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|magic
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_WRITE_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me
argument_list|,
name|magic
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|write_d2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|write_d2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_WRITE_D called twice"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|write_d2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me1
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me2
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|magic1
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
specifier|const
name|int
name|magic2
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me1
argument_list|,
name|magic1
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me2
argument_list|,
name|magic2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me1 to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_WRITE_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me1
argument_list|,
name|magic1
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me2 to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_WRITE_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me2
argument_list|,
name|magic2
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|write_d3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|write_d3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_WRITE_D called three times"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|write_d3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me1
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me2
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me3
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|magic1
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
specifier|const
name|int
name|magic2
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
specifier|const
name|int
name|magic3
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me1
argument_list|,
name|magic1
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me2
argument_list|,
name|magic2
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me3
argument_list|,
name|magic3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me1 to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_WRITE_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me1
argument_list|,
name|magic1
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me2 to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_WRITE_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me2
argument_list|,
name|magic2
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me3 to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_WRITE_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me3
argument_list|,
name|magic3
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|write_d4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|write_d4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_WRITE_D called four times"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|write_d4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me1
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me2
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me3
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me4
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|magic1
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
specifier|const
name|int
name|magic2
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
specifier|const
name|int
name|magic3
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
specifier|const
name|int
name|magic4
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me1
argument_list|,
name|magic1
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me2
argument_list|,
name|magic2
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me3
argument_list|,
name|magic3
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me4
argument_list|,
name|magic4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me1 to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_WRITE_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me1
argument_list|,
name|magic1
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me2 to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_WRITE_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me2
argument_list|,
name|magic2
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me3 to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_WRITE_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me3
argument_list|,
name|magic3
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me4 to tracee (PID=%d) from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_WRITE_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me4
argument_list|,
name|magic4
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_read_d_write_d_handshake1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_read_d_write_d_handshake1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_READ_D and PIOD_WRITE_D handshake"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_read_d_write_d_handshake1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint8_t
name|lookup_me_fromtracee
init|=
literal|0
decl_stmt|;
specifier|const
name|uint8_t
name|magic_fromtracee
init|=
operator|(
name|uint8_t
operator|)
name|random
argument_list|()
decl_stmt|;
name|uint8_t
name|lookup_me_totracee
init|=
literal|0
decl_stmt|;
specifier|const
name|uint8_t
name|magic_totracee
init|=
operator|(
name|uint8_t
operator|)
name|random
argument_list|()
decl_stmt|;
name|struct
name|ptrace_io_desc
name|io_fromtracee
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_READ_D
block|,
operator|.
name|piod_offs
operator|=
operator|&
name|lookup_me_fromtracee
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me_fromtracee
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me_fromtracee
operator|)
block|}
decl_stmt|;
name|struct
name|ptrace_io_desc
name|io_totracee
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_WRITE_D
block|,
operator|.
name|piod_offs
operator|=
operator|&
name|lookup_me_totracee
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me_totracee
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me_totracee
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lookup_me_fromtracee
operator|=
name|magic_fromtracee
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me_totracee
argument_list|,
name|magic_totracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read lookup_me_fromtracee PID=%d by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io_fromtracee
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me_fromtracee
argument_list|,
name|magic_fromtracee
argument_list|,
literal|"got value %"
name|PRIx8
literal|" != expected %"
name|PRIx8
argument_list|,
name|lookup_me_fromtracee
argument_list|,
name|magic_fromtracee
argument_list|)
expr_stmt|;
name|lookup_me_totracee
operator|=
name|magic_totracee
expr_stmt|;
name|printf
argument_list|(
literal|"Write lookup_me_totracee to PID=%d by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io_totracee
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me_totracee
argument_list|,
name|magic_totracee
argument_list|,
literal|"got value %"
name|PRIx8
literal|" != expected %"
name|PRIx8
argument_list|,
name|lookup_me_totracee
argument_list|,
name|magic_totracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_read_d_write_d_handshake2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_read_d_write_d_handshake2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_WRITE_D and PIOD_READ_D handshake"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_read_d_write_d_handshake2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint8_t
name|lookup_me_fromtracee
init|=
literal|0
decl_stmt|;
specifier|const
name|uint8_t
name|magic_fromtracee
init|=
operator|(
name|uint8_t
operator|)
name|random
argument_list|()
decl_stmt|;
name|uint8_t
name|lookup_me_totracee
init|=
literal|0
decl_stmt|;
specifier|const
name|uint8_t
name|magic_totracee
init|=
operator|(
name|uint8_t
operator|)
name|random
argument_list|()
decl_stmt|;
name|struct
name|ptrace_io_desc
name|io_fromtracee
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_READ_D
block|,
operator|.
name|piod_offs
operator|=
operator|&
name|lookup_me_fromtracee
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me_fromtracee
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me_fromtracee
operator|)
block|}
decl_stmt|;
name|struct
name|ptrace_io_desc
name|io_totracee
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_WRITE_D
block|,
operator|.
name|piod_offs
operator|=
operator|&
name|lookup_me_totracee
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me_totracee
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me_totracee
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lookup_me_fromtracee
operator|=
name|magic_fromtracee
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me_totracee
argument_list|,
name|magic_totracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|lookup_me_totracee
operator|=
name|magic_totracee
expr_stmt|;
name|printf
argument_list|(
literal|"Write lookup_me_totracee to PID=%d by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io_totracee
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me_totracee
argument_list|,
name|magic_totracee
argument_list|,
literal|"got value %"
name|PRIx8
literal|" != expected %"
name|PRIx8
argument_list|,
name|lookup_me_totracee
argument_list|,
name|magic_totracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read lookup_me_fromtracee PID=%d by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io_fromtracee
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me_fromtracee
argument_list|,
name|magic_fromtracee
argument_list|,
literal|"got value %"
name|PRIx8
literal|" != expected %"
name|PRIx8
argument_list|,
name|lookup_me_fromtracee
argument_list|,
name|magic_fromtracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|read_d_write_d_handshake1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|read_d_write_d_handshake1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_READ_D with PT_WRITE_D handshake"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|read_d_write_d_handshake1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me_fromtracee
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|magic_fromtracee
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
name|int
name|lookup_me_totracee
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|magic_totracee
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lookup_me_fromtracee
operator|=
name|magic_fromtracee
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me_totracee
argument_list|,
name|magic_totracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me_fromtracee PID=%d by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me_fromtracee
operator|=
name|ptrace
argument_list|(
name|PT_READ_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me_fromtracee
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me_fromtracee
argument_list|,
name|magic_fromtracee
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me_fromtracee
argument_list|,
name|magic_fromtracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me_totracee to PID=%d from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_WRITE_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me_totracee
argument_list|,
name|magic_totracee
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|read_d_write_d_handshake2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|read_d_write_d_handshake2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_WRITE_D with PT_READ_D handshake"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|read_d_write_d_handshake2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me_fromtracee
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|magic_fromtracee
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
name|int
name|lookup_me_totracee
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|magic_totracee
init|=
operator|(
name|int
operator|)
name|random
argument_list|()
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lookup_me_fromtracee
operator|=
name|magic_fromtracee
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|lookup_me_totracee
argument_list|,
name|magic_totracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write new lookup_me_totracee to PID=%d from tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_WRITE_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me_totracee
argument_list|,
name|magic_totracee
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me_fromtracee PID=%d by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me_fromtracee
operator|=
name|ptrace
argument_list|(
name|PT_READ_D
argument_list|,
name|child
argument_list|,
operator|&
name|lookup_me_fromtracee
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me_fromtracee
argument_list|,
name|magic_fromtracee
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me_fromtracee
argument_list|,
name|magic_fromtracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* These dummy functions are used to be copied with ptrace(2) calls */
end_comment

begin_function
specifier|static
name|int
name|__used
name|dummy_fn1
parameter_list|(
name|int
name|a
parameter_list|,
name|int
name|b
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|d
parameter_list|)
block|{
name|a
operator|*=
literal|1
expr_stmt|;
name|b
operator|+=
literal|2
expr_stmt|;
name|c
operator|-=
literal|3
expr_stmt|;
name|d
operator|/=
literal|4
expr_stmt|;
return|return
name|a
operator|+
name|b
operator|*
name|c
operator|-
name|d
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__used
name|dummy_fn2
parameter_list|(
name|int
name|a
parameter_list|,
name|int
name|b
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|d
parameter_list|)
block|{
name|a
operator|*=
literal|4
expr_stmt|;
name|b
operator|+=
literal|3
expr_stmt|;
name|c
operator|-=
literal|2
expr_stmt|;
name|d
operator|/=
literal|1
expr_stmt|;
return|return
name|a
operator|+
name|b
operator|*
name|c
operator|-
name|d
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__used
name|dummy_fn3
parameter_list|(
name|int
name|a
parameter_list|,
name|int
name|b
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|d
parameter_list|)
block|{
name|a
operator|*=
literal|10
expr_stmt|;
name|b
operator|+=
literal|20
expr_stmt|;
name|c
operator|-=
literal|30
expr_stmt|;
name|d
operator|/=
literal|40
expr_stmt|;
return|return
name|a
operator|+
name|b
operator|*
name|c
operator|-
name|d
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__used
name|dummy_fn4
parameter_list|(
name|int
name|a
parameter_list|,
name|int
name|b
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|d
parameter_list|)
block|{
name|a
operator|*=
literal|40
expr_stmt|;
name|b
operator|+=
literal|30
expr_stmt|;
name|c
operator|-=
literal|20
expr_stmt|;
name|d
operator|/=
literal|10
expr_stmt|;
return|return
name|a
operator|+
name|b
operator|*
name|c
operator|-
name|d
return|;
block|}
end_function

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_read_i1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_read_i1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_READ_I and len = sizeof(uint8_t)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_read_i1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint8_t
name|lookup_me
init|=
literal|0
decl_stmt|;
name|uint8_t
name|magic
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic
argument_list|,
name|dummy_fn1
argument_list|,
sizeof|sizeof
argument_list|(
name|magic
argument_list|)
argument_list|)
expr_stmt|;
name|struct
name|ptrace_io_desc
name|io
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_READ_I
block|,
operator|.
name|piod_offs
operator|=
name|dummy_fn1
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read lookup_me from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|,
literal|"got value %"
name|PRIx8
literal|" != expected %"
name|PRIx8
argument_list|,
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_read_i2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_read_i2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_READ_I and len = sizeof(uint16_t)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_read_i2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint16_t
name|lookup_me
init|=
literal|0
decl_stmt|;
name|uint16_t
name|magic
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic
argument_list|,
name|dummy_fn1
argument_list|,
sizeof|sizeof
argument_list|(
name|magic
argument_list|)
argument_list|)
expr_stmt|;
name|struct
name|ptrace_io_desc
name|io
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_READ_I
block|,
operator|.
name|piod_offs
operator|=
name|dummy_fn1
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read lookup_me from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|,
literal|"got value %"
name|PRIx16
literal|" != expected %"
name|PRIx16
argument_list|,
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_read_i3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_read_i3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_READ_I and len = sizeof(uint32_t)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_read_i3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint32_t
name|lookup_me
init|=
literal|0
decl_stmt|;
name|uint32_t
name|magic
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic
argument_list|,
name|dummy_fn1
argument_list|,
sizeof|sizeof
argument_list|(
name|magic
argument_list|)
argument_list|)
expr_stmt|;
name|struct
name|ptrace_io_desc
name|io
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_READ_I
block|,
operator|.
name|piod_offs
operator|=
name|dummy_fn1
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read lookup_me from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|,
literal|"got value %"
name|PRIx32
literal|" != expected %"
name|PRIx32
argument_list|,
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|io_read_i4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|io_read_i4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_IO with PIOD_READ_I and len = sizeof(uint64_t)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|io_read_i4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|uint64_t
name|lookup_me
init|=
literal|0
decl_stmt|;
name|uint64_t
name|magic
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic
argument_list|,
name|dummy_fn1
argument_list|,
sizeof|sizeof
argument_list|(
name|magic
argument_list|)
argument_list|)
expr_stmt|;
name|struct
name|ptrace_io_desc
name|io
init|=
block|{
operator|.
name|piod_op
operator|=
name|PIOD_READ_I
block|,
operator|.
name|piod_offs
operator|=
name|dummy_fn1
block|,
operator|.
name|piod_addr
operator|=
operator|&
name|lookup_me
block|,
operator|.
name|piod_len
operator|=
expr|sizeof
operator|(
name|lookup_me
operator|)
block|}
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read lookup_me from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_IO
argument_list|,
name|child
argument_list|,
operator|&
name|io
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|,
literal|"got value %"
name|PRIx64
literal|" != expected %"
name|PRIx64
argument_list|,
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|read_i1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|read_i1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_READ_I called once"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|read_i1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me
init|=
literal|0
decl_stmt|;
name|int
name|magic
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic
argument_list|,
name|dummy_fn1
argument_list|,
sizeof|sizeof
argument_list|(
name|magic
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me
operator|=
name|ptrace
argument_list|(
name|PT_READ_I
argument_list|,
name|child
argument_list|,
name|dummy_fn1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me
argument_list|,
name|magic
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|read_i2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|read_i2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_READ_I called twice"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|read_i2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me1
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me2
init|=
literal|0
decl_stmt|;
name|int
name|magic1
decl_stmt|;
name|int
name|magic2
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic1
argument_list|,
name|dummy_fn1
argument_list|,
sizeof|sizeof
argument_list|(
name|magic1
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic2
argument_list|,
name|dummy_fn2
argument_list|,
sizeof|sizeof
argument_list|(
name|magic2
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me1 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me1
operator|=
name|ptrace
argument_list|(
name|PT_READ_I
argument_list|,
name|child
argument_list|,
name|dummy_fn1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me1
argument_list|,
name|magic1
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me1
argument_list|,
name|magic1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me2 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me2
operator|=
name|ptrace
argument_list|(
name|PT_READ_I
argument_list|,
name|child
argument_list|,
name|dummy_fn2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me2
argument_list|,
name|magic2
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me2
argument_list|,
name|magic2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|read_i3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|read_i3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_READ_I called three times"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|read_i3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me1
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me2
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me3
init|=
literal|0
decl_stmt|;
name|int
name|magic1
decl_stmt|;
name|int
name|magic2
decl_stmt|;
name|int
name|magic3
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic1
argument_list|,
name|dummy_fn1
argument_list|,
sizeof|sizeof
argument_list|(
name|magic1
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic2
argument_list|,
name|dummy_fn2
argument_list|,
sizeof|sizeof
argument_list|(
name|magic2
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic3
argument_list|,
name|dummy_fn3
argument_list|,
sizeof|sizeof
argument_list|(
name|magic3
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me1 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me1
operator|=
name|ptrace
argument_list|(
name|PT_READ_I
argument_list|,
name|child
argument_list|,
name|dummy_fn1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me1
argument_list|,
name|magic1
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me1
argument_list|,
name|magic1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me2 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me2
operator|=
name|ptrace
argument_list|(
name|PT_READ_I
argument_list|,
name|child
argument_list|,
name|dummy_fn2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me2
argument_list|,
name|magic2
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me2
argument_list|,
name|magic2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me3 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me3
operator|=
name|ptrace
argument_list|(
name|PT_READ_I
argument_list|,
name|child
argument_list|,
name|dummy_fn3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me3
argument_list|,
name|magic3
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me3
argument_list|,
name|magic3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|read_i4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|read_i4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_READ_I called four times"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|read_i4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|lookup_me1
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me2
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me3
init|=
literal|0
decl_stmt|;
name|int
name|lookup_me4
init|=
literal|0
decl_stmt|;
name|int
name|magic1
decl_stmt|;
name|int
name|magic2
decl_stmt|;
name|int
name|magic3
decl_stmt|;
name|int
name|magic4
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic1
argument_list|,
name|dummy_fn1
argument_list|,
sizeof|sizeof
argument_list|(
name|magic1
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic2
argument_list|,
name|dummy_fn2
argument_list|,
sizeof|sizeof
argument_list|(
name|magic2
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic3
argument_list|,
name|dummy_fn3
argument_list|,
sizeof|sizeof
argument_list|(
name|magic3
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|magic4
argument_list|,
name|dummy_fn4
argument_list|,
sizeof|sizeof
argument_list|(
name|magic4
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me1 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me1
operator|=
name|ptrace
argument_list|(
name|PT_READ_I
argument_list|,
name|child
argument_list|,
name|dummy_fn1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me1
argument_list|,
name|magic1
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me1
argument_list|,
name|magic1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me2 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me2
operator|=
name|ptrace
argument_list|(
name|PT_READ_I
argument_list|,
name|child
argument_list|,
name|dummy_fn2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me2
argument_list|,
name|magic2
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me2
argument_list|,
name|magic2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me3 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me3
operator|=
name|ptrace
argument_list|(
name|PT_READ_I
argument_list|,
name|child
argument_list|,
name|dummy_fn3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me3
argument_list|,
name|magic3
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me3
argument_list|,
name|magic3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Read new lookup_me4 from tracee (PID=%d) by tracer (PID=%d)\n"
argument_list|,
name|child
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|lookup_me4
operator|=
name|ptrace
argument_list|(
name|PT_READ_I
argument_list|,
name|child
argument_list|,
name|dummy_fn4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|errno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|lookup_me4
argument_list|,
name|magic4
argument_list|,
literal|"got value %#x != expected %#x"
argument_list|,
name|lookup_me4
argument_list|,
name|magic4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_GPREGS
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|regs1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|regs1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify plain PT_GETREGS call without further steps"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|regs1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|struct
name|reg
name|r
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Call GETREGS for the child process\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GETREGS
argument_list|,
name|child
argument_list|,
operator|&
name|r
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_GPREGS
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|regs2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|regs2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify plain PT_GETREGS call and retrieve PC"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|regs2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|struct
name|reg
name|r
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Call GETREGS for the child process\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GETREGS
argument_list|,
name|child
argument_list|,
operator|&
name|r
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Retrieved PC=%"
name|PRIxREGISTER
literal|"\n"
argument_list|,
name|PTRACE_REG_PC
argument_list|(
operator|&
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_GPREGS
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|regs3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|regs3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify plain PT_GETREGS call and retrieve SP"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|regs3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|struct
name|reg
name|r
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Call GETREGS for the child process\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GETREGS
argument_list|,
name|child
argument_list|,
operator|&
name|r
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Retrieved SP=%"
name|PRIxREGISTER
literal|"\n"
argument_list|,
name|PTRACE_REG_SP
argument_list|(
operator|&
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_GPREGS
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|regs4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|regs4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify plain PT_GETREGS call and retrieve INTRV"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|regs4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|struct
name|reg
name|r
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Call GETREGS for the child process\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GETREGS
argument_list|,
name|child
argument_list|,
operator|&
name|r
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Retrieved INTRV=%"
name|PRIxREGISTER
literal|"\n"
argument_list|,
name|PTRACE_REG_INTRV
argument_list|(
operator|&
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_GPREGS
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|regs5
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|regs5
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_GETREGS and PT_SETREGS calls without changing regs"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|regs5
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|struct
name|reg
name|r
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Call GETREGS for the child process\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GETREGS
argument_list|,
name|child
argument_list|,
operator|&
name|r
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Call SETREGS for the child process (without changed regs)\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GETREGS
argument_list|,
name|child
argument_list|,
operator|&
name|r
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_FPREGS
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|fpregs1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|fpregs1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify plain PT_GETFPREGS call without further steps"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|fpregs1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|struct
name|fpreg
name|r
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Call GETFPREGS for the child process\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GETFPREGS
argument_list|,
name|child
argument_list|,
operator|&
name|r
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_FPREGS
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|fpregs2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|fpregs2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_GETFPREGS and PT_SETFPREGS calls without changing "
literal|"regs"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|fpregs2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|struct
name|fpreg
name|r
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Call GETFPREGS for the child process\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GETFPREGS
argument_list|,
name|child
argument_list|,
operator|&
name|r
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Call SETFPREGS for the child (without changed regs)\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SETFPREGS
argument_list|,
name|child
argument_list|,
operator|&
name|r
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|PT_STEP
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|step1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|step1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify single PT_STEP call"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|step1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|int
name|happy
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|happy
operator|=
name|check_happy
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|happy
argument_list|,
name|check_happy
argument_list|(
literal|100
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent (use PT_STEP)\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_STEP
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|PT_STEP
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|step2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|step2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_STEP called twice"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|step2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|int
name|happy
decl_stmt|;
name|int
name|N
init|=
literal|2
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|happy
operator|=
name|check_happy
argument_list|(
literal|999
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|happy
argument_list|,
name|check_happy
argument_list|(
literal|999
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
while|while
condition|(
name|N
operator|--
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before resuming the child process where it left off "
literal|"and without signal to be sent (use PT_STEP)\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_STEP
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|PT_STEP
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|step3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|step3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_STEP called three times"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|step3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|int
name|happy
decl_stmt|;
name|int
name|N
init|=
literal|3
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|happy
operator|=
name|check_happy
argument_list|(
literal|999
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|happy
argument_list|,
name|check_happy
argument_list|(
literal|999
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
while|while
condition|(
name|N
operator|--
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before resuming the child process where it left off "
literal|"and without signal to be sent (use PT_STEP)\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_STEP
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|PT_STEP
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|step4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|step4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify PT_STEP called four times"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|step4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|int
name|happy
decl_stmt|;
name|int
name|N
init|=
literal|4
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|happy
operator|=
name|check_happy
argument_list|(
literal|999
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|happy
argument_list|,
name|check_happy
argument_list|(
literal|999
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
while|while
condition|(
name|N
operator|--
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before resuming the child process where it left off "
literal|"and without signal to be sent (use PT_STEP)\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_STEP
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|ATF_TC
argument_list|(
name|kill1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|kill1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify that PT_CONTINUE with SIGKILL terminates child"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|kill1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|,
name|sigsent
init|=
name|SIGKILL
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
name|FORKEE_ASSERTX
argument_list|(
literal|0
operator|&&
literal|"Child should be terminated by a signal from its parent"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
name|sigsent
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_signaled
argument_list|(
name|status
argument_list|,
name|sigsent
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|kill2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|kill2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify that PT_KILL terminates child"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|kill2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
name|FORKEE_ASSERTX
argument_list|(
literal|0
operator|&&
literal|"Child should be terminated by a signal from its parent"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_KILL
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_signaled
argument_list|(
name|status
argument_list|,
name|SIGKILL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|lwpinfo1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|lwpinfo1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify basic LWPINFO call for single thread (PT_TRACE_ME)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|lwpinfo1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|struct
name|ptrace_lwpinfo
name|info
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_LWPINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_LWPINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Assert that there exists a thread\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|info
operator|.
name|pl_lwpid
operator|>
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Assert that lwp thread %d received event PL_EVENT_SIGNAL\n"
argument_list|,
name|info
operator|.
name|pl_lwpid
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ_MSG
argument_list|(
name|info
operator|.
name|pl_event
argument_list|,
name|PL_EVENT_SIGNAL
argument_list|,
literal|"Received event %d != expected event %d"
argument_list|,
name|info
operator|.
name|pl_event
argument_list|,
name|PL_EVENT_SIGNAL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_LWPINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_LWPINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Assert that there are no more lwp threads in child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|pl_lwpid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_if
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_PID
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|lwpinfo2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|lwpinfo2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify basic LWPINFO call for single thread (PT_ATTACH from "
literal|"tracer)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|lwpinfo2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|msg_fds
name|parent_tracee
decl_stmt|,
name|parent_tracer
decl_stmt|;
specifier|const
name|int
name|exitval_tracee
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|exitval_tracer
init|=
literal|10
decl_stmt|;
name|pid_t
name|tracee
decl_stmt|,
name|tracer
decl_stmt|,
name|wpid
decl_stmt|;
name|uint8_t
name|msg
init|=
literal|0xde
decl_stmt|;
comment|/* dummy message for IPC based on pipe(2) */
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|struct
name|ptrace_lwpinfo
name|info
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|printf
argument_list|(
literal|"Spawn tracee\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracee
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|msg_open
argument_list|(
operator|&
name|parent_tracer
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tracee
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracee
operator|==
literal|0
condition|)
block|{
comment|/* Wait for message from the parent */
name|CHILD_TO_PARENT
argument_list|(
literal|"tracee ready"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|CHILD_FROM_PARENT
argument_list|(
literal|"tracee exit"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval_tracee
argument_list|)
expr_stmt|;
block|}
name|PARENT_FROM_CHILD
argument_list|(
literal|"tracee ready"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Spawn debugger\n"
argument_list|)
expr_stmt|;
name|tracer
operator|=
name|atf_utils_fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|tracer
operator|==
literal|0
condition|)
block|{
comment|/* No IPC to communicate with the child */
name|printf
argument_list|(
literal|"Before calling PT_ATTACH from tracee %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_ATTACH
argument_list|,
name|tracee
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Wait for tracee and assert that it was stopped w/ SIGSTOP */
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|forkee_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGSTOP
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_LWPINFO for child\n"
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_LWPINFO
argument_list|,
name|tracee
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Assert that there exists a thread\n"
argument_list|)
expr_stmt|;
name|FORKEE_ASSERTX
argument_list|(
name|info
operator|.
name|pl_lwpid
operator|>
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Assert that lwp thread %d received event "
literal|"PL_EVENT_SIGNAL\n"
argument_list|,
name|info
operator|.
name|pl_lwpid
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|info
operator|.
name|pl_event
argument_list|,
name|PL_EVENT_SIGNAL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_LWPINFO for child\n"
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_LWPINFO
argument_list|,
name|tracee
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Assert that there are no more lwp threads in child\n"
argument_list|)
expr_stmt|;
name|FORKEE_ASSERTX
argument_list|(
name|info
operator|.
name|pl_lwpid
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* Resume tracee with PT_CONTINUE */
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|tracee
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Inform parent that tracer has attached to tracee */
name|CHILD_TO_PARENT
argument_list|(
literal|"tracer ready"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* Wait for parent */
name|CHILD_FROM_PARENT
argument_list|(
literal|"tracer wait"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* Wait for tracee and assert that it exited */
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|forkee_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the tracer process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval_tracer
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Wait for the tracer to attach to the tracee\n"
argument_list|)
expr_stmt|;
name|PARENT_FROM_CHILD
argument_list|(
literal|"tracer ready"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Resume the tracee and let it exit\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"tracee exit"
argument_list|,
name|parent_tracee
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Detect that tracee is zombie\n"
argument_list|)
expr_stmt|;
name|await_zombie
argument_list|(
name|tracee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Assert that there is no status about tracee - "
literal|"Tracer must detect zombie first - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Resume the tracer and let it detect exited tracee\n"
argument_list|)
expr_stmt|;
name|PARENT_TO_CHILD
argument_list|(
literal|"tracer wait"
argument_list|,
name|parent_tracer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for tracer to finish its job and exit - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracer
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|tracer
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracer
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Wait for tracee to finish its job and exit - calling %s()\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|tracee
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
argument_list|,
name|tracee
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval_tracee
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracer
argument_list|)
expr_stmt|;
name|msg_close
argument_list|(
operator|&
name|parent_tracee
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|ATF_TC
argument_list|(
name|siginfo1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|siginfo1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify basic PT_GET_SIGINFO call for SIGTRAP from tracee"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|siginfo1
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGTRAP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|struct
name|ptrace_siginfo
name|info
decl_stmt|;
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_GET_SIGINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_SIGINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signal traced to lwpid=%d\n"
argument_list|,
name|info
operator|.
name|psi_lwpid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signal properties: si_signo=%#x si_code=%#x si_errno=%#x\n"
argument_list|,
name|info
operator|.
name|psi_siginfo
operator|.
name|si_signo
argument_list|,
name|info
operator|.
name|psi_siginfo
operator|.
name|si_code
argument_list|,
name|info
operator|.
name|psi_siginfo
operator|.
name|si_errno
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|siginfo2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|siginfo2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify basic PT_GET_SIGINFO and PT_SET_SIGINFO calls without "
literal|"modification of SIGINT from tracee"
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
specifier|static
name|int
name|siginfo2_caught
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|siginfo2_sighandler
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
name|FORKEE_ASSERT_EQ
argument_list|(
name|sig
argument_list|,
name|SIGINT
argument_list|)
expr_stmt|;
operator|++
name|siginfo2_caught
expr_stmt|;
block|}
end_function

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|siginfo2
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGINT
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|struct
name|sigaction
name|sa
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|struct
name|ptrace_siginfo
name|info
decl_stmt|;
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|sa
operator|.
name|sa_handler
operator|=
name|siginfo2_sighandler
expr_stmt|;
name|sa
operator|.
name|sa_flags
operator|=
name|SA_SIGINFO
expr_stmt|;
name|sigemptyset
argument_list|(
operator|&
name|sa
operator|.
name|sa_mask
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|sigaction
argument_list|(
name|sigval
argument_list|,
operator|&
name|sa
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|siginfo2_caught
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_GET_SIGINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_SIGINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signal traced to lwpid=%d\n"
argument_list|,
name|info
operator|.
name|psi_lwpid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signal properties: si_signo=%#x si_code=%#x si_errno=%#x\n"
argument_list|,
name|info
operator|.
name|psi_siginfo
operator|.
name|si_signo
argument_list|,
name|info
operator|.
name|psi_siginfo
operator|.
name|si_code
argument_list|,
name|info
operator|.
name|psi_siginfo
operator|.
name|si_errno
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_SET_SIGINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SET_SIGINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
name|sigval
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|siginfo3
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|siginfo3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify basic PT_GET_SIGINFO and PT_SET_SIGINFO calls with "
literal|"setting signal to new value"
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
specifier|static
name|int
name|siginfo3_caught
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|siginfo3_sigaction
parameter_list|(
name|int
name|sig
parameter_list|,
name|siginfo_t
modifier|*
name|info
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|FORKEE_ASSERT_EQ
argument_list|(
name|sig
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|info
operator|->
name|si_signo
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|info
operator|->
name|si_code
argument_list|,
name|TRAP_BRKPT
argument_list|)
expr_stmt|;
operator|++
name|siginfo3_caught
expr_stmt|;
block|}
end_function

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|siginfo3
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGINT
decl_stmt|;
specifier|const
name|int
name|sigfaked
init|=
name|SIGTRAP
decl_stmt|;
specifier|const
name|int
name|sicodefaked
init|=
name|TRAP_BRKPT
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
name|struct
name|sigaction
name|sa
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|struct
name|ptrace_siginfo
name|info
decl_stmt|;
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|sa
operator|.
name|sa_sigaction
operator|=
name|siginfo3_sigaction
expr_stmt|;
name|sa
operator|.
name|sa_flags
operator|=
name|SA_SIGINFO
expr_stmt|;
name|sigemptyset
argument_list|(
operator|&
name|sa
operator|.
name|sa_mask
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|sigaction
argument_list|(
name|sigfaked
argument_list|,
operator|&
name|sa
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|siginfo3_caught
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_GET_SIGINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_SIGINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signal traced to lwpid=%d\n"
argument_list|,
name|info
operator|.
name|psi_lwpid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signal properties: si_signo=%#x si_code=%#x si_errno=%#x\n"
argument_list|,
name|info
operator|.
name|psi_siginfo
operator|.
name|si_signo
argument_list|,
name|info
operator|.
name|psi_siginfo
operator|.
name|si_code
argument_list|,
name|info
operator|.
name|psi_siginfo
operator|.
name|si_errno
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before setting new faked signal to signo=%d si_code=%d\n"
argument_list|,
name|sigfaked
argument_list|,
name|sicodefaked
argument_list|)
expr_stmt|;
name|info
operator|.
name|psi_siginfo
operator|.
name|si_signo
operator|=
name|sigfaked
expr_stmt|;
name|info
operator|.
name|psi_siginfo
operator|.
name|si_code
operator|=
name|sicodefaked
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_SET_SIGINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SET_SIGINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_GET_SIGINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_SIGINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before checking siginfo_t\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_signo
argument_list|,
name|sigfaked
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_code
argument_list|,
name|sicodefaked
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
name|sigfaked
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|siginfo4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|siginfo4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Detect SIGTRAP TRAP_EXEC from tracee"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|siginfo4
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|sigval
init|=
name|SIGTRAP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|struct
name|ptrace_siginfo
name|info
decl_stmt|;
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling execve(2) from child\n"
argument_list|)
expr_stmt|;
name|execlp
argument_list|(
literal|"/bin/echo"
argument_list|,
literal|"/bin/echo"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
literal|0
operator|&&
literal|"Not reached"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_GET_SIGINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_SIGINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signal traced to lwpid=%d\n"
argument_list|,
name|info
operator|.
name|psi_lwpid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signal properties: si_signo=%#x si_code=%#x si_errno=%#x\n"
argument_list|,
name|info
operator|.
name|psi_siginfo
operator|.
name|si_signo
argument_list|,
name|info
operator|.
name|psi_siginfo
operator|.
name|si_code
argument_list|,
name|info
operator|.
name|psi_siginfo
operator|.
name|si_errno
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_signo
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_code
argument_list|,
name|TRAP_EXEC
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_if
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_PID
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|siginfo5
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|siginfo5
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify that fork(2) is intercepted by ptrace(2) with EVENT_MASK "
literal|"set to PTRACE_FORK and reports correct signal information"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|siginfo5
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|exitval2
init|=
literal|15
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|child2
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|ptrace_state_t
name|state
decl_stmt|;
specifier|const
name|int
name|slen
init|=
sizeof|sizeof
argument_list|(
name|state
argument_list|)
decl_stmt|;
name|ptrace_event_t
name|event
decl_stmt|;
specifier|const
name|int
name|elen
init|=
sizeof|sizeof
argument_list|(
name|event
argument_list|)
decl_stmt|;
name|struct
name|ptrace_siginfo
name|info
decl_stmt|;
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
operator|(
name|child2
operator|=
name|fork
argument_list|()
operator|)
operator|!=
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child2
operator|==
literal|0
condition|)
name|_exit
argument_list|(
name|exitval2
argument_list|)
expr_stmt|;
name|FORKEE_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|forkee_status_exited
argument_list|(
name|status
argument_list|,
name|exitval2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_GET_SIGINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_SIGINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before checking siginfo_t\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_signo
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_code
argument_list|,
name|SI_LWP
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Enable PTRACE_FORK in EVENT_MASK for the child %d\n"
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|event
operator|.
name|pe_set_event
operator|=
name|PTRACE_FORK
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_SET_EVENT_MASK
argument_list|,
name|child
argument_list|,
operator|&
name|event
argument_list|,
name|elen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child %d\n"
argument_list|,
name|TWAIT_FNAME
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_GET_SIGINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_SIGINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before checking siginfo_t\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_signo
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_code
argument_list|,
name|TRAP_CHLD
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_PROCESS_STATE
argument_list|,
name|child
argument_list|,
operator|&
name|state
argument_list|,
name|slen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|state
operator|.
name|pe_report_event
argument_list|,
name|PTRACE_FORK
argument_list|)
expr_stmt|;
name|child2
operator|=
name|state
operator|.
name|pe_other_pid
expr_stmt|;
name|printf
argument_list|(
literal|"Reported PTRACE_FORK event with forkee %d\n"
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the forkee %d of the child %d\n"
argument_list|,
name|TWAIT_FNAME
argument_list|,
name|child2
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_GET_SIGINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_SIGINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before checking siginfo_t\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_signo
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_code
argument_list|,
name|TRAP_CHLD
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_PROCESS_STATE
argument_list|,
name|child2
argument_list|,
operator|&
name|state
argument_list|,
name|slen
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|state
operator|.
name|pe_report_event
argument_list|,
name|PTRACE_FORK
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|state
operator|.
name|pe_other_pid
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the forkee process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child2
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the forkee - expected exited\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child2
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the forkee - expected no process\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child2
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected stopped "
literal|"SIGCHLD\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGCHLD
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_GET_SIGINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_SIGINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before checking siginfo_t\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_signo
argument_list|,
name|SIGCHLD
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_code
argument_list|,
name|CLD_EXITED
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected exited\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child - expected no process\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|PT_STEP
argument_list|)
end_if

begin_expr_stmt
name|ATF_TC
argument_list|(
name|siginfo6
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|siginfo6
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Verify single PT_STEP call with signal information check"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|siginfo6
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|int
name|exitval
init|=
literal|5
decl_stmt|;
specifier|const
name|int
name|sigval
init|=
name|SIGSTOP
decl_stmt|;
name|pid_t
name|child
decl_stmt|,
name|wpid
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|TWAIT_HAVE_STATUS
argument_list|)
name|int
name|status
decl_stmt|;
endif|#
directive|endif
name|int
name|happy
decl_stmt|;
name|struct
name|ptrace_siginfo
name|info
decl_stmt|;
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before forking process PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Before calling PT_TRACE_ME from child %d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|ptrace
argument_list|(
name|PT_TRACE_ME
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|happy
operator|=
name|check_happy
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before raising %s from child\n"
argument_list|,
name|strsignal
argument_list|(
name|sigval
argument_list|)
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT
argument_list|(
name|raise
argument_list|(
name|sigval
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|FORKEE_ASSERT_EQ
argument_list|(
name|happy
argument_list|,
name|check_happy
argument_list|(
literal|100
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before exiting of the child process\n"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Parent process PID=%d, child's PID=%d\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_GET_SIGINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_SIGINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before checking siginfo_t\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_signo
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_code
argument_list|,
name|SI_LWP
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent (use PT_STEP)\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_STEP
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_stopped
argument_list|(
name|status
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling ptrace(2) with PT_GET_SIGINFO for child\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_GET_SIGINFO
argument_list|,
name|child
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before checking siginfo_t\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_signo
argument_list|,
name|SIGTRAP
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|info
operator|.
name|psi_siginfo
operator|.
name|si_code
argument_list|,
name|TRAP_TRACE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before resuming the child process where it left off and "
literal|"without signal to be sent\n"
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ptrace
argument_list|(
name|PT_CONTINUE
argument_list|,
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_SUCCESS
argument_list|(
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|validate_status_exited
argument_list|(
name|status
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Before calling %s() for the child\n"
argument_list|,
name|TWAIT_FNAME
argument_list|)
expr_stmt|;
name|TWAIT_REQUIRE_FAILURE
argument_list|(
name|ECHILD
argument_list|,
name|wpid
operator|=
name|TWAIT_GENERIC
argument_list|(
name|child
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_macro
name|ATF_TP_ADD_TCS
argument_list|(
argument|tp
argument_list|)
end_macro

begin_block
block|{
name|setvbuf
argument_list|(
name|stdout
argument_list|,
name|NULL
argument_list|,
name|_IONBF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|setvbuf
argument_list|(
name|stderr
argument_list|,
name|NULL
argument_list|,
name|_IONBF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|traceme1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|traceme2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|traceme3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|traceme4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_PID
argument_list|(
name|tp
argument_list|,
name|attach1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_PID
argument_list|(
name|tp
argument_list|,
name|attach2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|attach3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|attach4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_PID
argument_list|(
name|tp
argument_list|,
name|attach5
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_PID
argument_list|(
name|tp
argument_list|,
name|attach6
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_PID
argument_list|(
name|tp
argument_list|,
name|attach7
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|eventmask1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|eventmask2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|eventmask3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|eventmask4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_PID
argument_list|(
name|tp
argument_list|,
name|fork1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|fork2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_PID
argument_list|(
name|tp
argument_list|,
name|vfork1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|vfork2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|vforkdone1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|vforkdone2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_read_d1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_read_d2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_read_d3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_read_d4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_write_d1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_write_d2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_write_d3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_write_d4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|read_d1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|read_d2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|read_d3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|read_d4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|write_d1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|write_d2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|write_d3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|write_d4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_read_d_write_d_handshake1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_read_d_write_d_handshake2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|read_d_write_d_handshake1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|read_d_write_d_handshake2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_read_i1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_read_i2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_read_i3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|io_read_i4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|read_i1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|read_i2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|read_i3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|read_i4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_GPREGS
argument_list|(
name|tp
argument_list|,
name|regs1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_GPREGS
argument_list|(
name|tp
argument_list|,
name|regs2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_GPREGS
argument_list|(
name|tp
argument_list|,
name|regs3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_GPREGS
argument_list|(
name|tp
argument_list|,
name|regs4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_GPREGS
argument_list|(
name|tp
argument_list|,
name|regs5
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_FPREGS
argument_list|(
name|tp
argument_list|,
name|fpregs1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_FPREGS
argument_list|(
name|tp
argument_list|,
name|fpregs2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_PT_STEP
argument_list|(
name|tp
argument_list|,
name|step1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_PT_STEP
argument_list|(
name|tp
argument_list|,
name|step2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_PT_STEP
argument_list|(
name|tp
argument_list|,
name|step3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_PT_STEP
argument_list|(
name|tp
argument_list|,
name|step4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|kill1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|kill2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|lwpinfo1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_PID
argument_list|(
name|tp
argument_list|,
name|lwpinfo2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|siginfo1
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|siginfo2
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|siginfo3
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|siginfo4
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_HAVE_PID
argument_list|(
name|tp
argument_list|,
name|siginfo5
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC_PT_STEP
argument_list|(
name|tp
argument_list|,
name|siginfo6
argument_list|)
expr_stmt|;
return|return
name|atf_no_error
argument_list|()
return|;
block|}
end_block

end_unit


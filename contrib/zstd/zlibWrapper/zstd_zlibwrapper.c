begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2016-present, Yann Collet, Facebook, Inc.  * All rights reserved.  *  * This source code is licensed under both the BSD-style license (found in the  * LICENSE file in the root directory of this source tree) and the GPLv2 (found  * in the COPYING file in the root directory of this source tree).  */
end_comment

begin_comment
comment|/* ===   Tuning parameters   === */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|ZWRAP_USE_ZSTD
end_ifndef

begin_define
define|#
directive|define
name|ZWRAP_USE_ZSTD
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ===   Dependencies   === */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_comment
comment|/* vsprintf */
end_comment

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_comment
comment|/* va_list, for z_gzprintf */
end_comment

begin_define
define|#
directive|define
name|NO_DUMMY_DECL
end_define

begin_define
define|#
directive|define
name|ZLIB_CONST
end_define

begin_include
include|#
directive|include
file|<zlib.h>
end_include

begin_comment
comment|/* without #define Z_PREFIX */
end_comment

begin_include
include|#
directive|include
file|"zstd_zlibwrapper.h"
end_include

begin_define
define|#
directive|define
name|ZSTD_STATIC_LINKING_ONLY
end_define

begin_comment
comment|/* ZSTD_isFrame, ZSTD_MAGICNUMBER */
end_comment

begin_include
include|#
directive|include
file|"zstd.h"
end_include

begin_include
include|#
directive|include
file|"zstd_internal.h"
end_include

begin_comment
comment|/* ZSTD_malloc, ZSTD_free */
end_comment

begin_comment
comment|/* ===   Constants   === */
end_comment

begin_define
define|#
directive|define
name|Z_INFLATE_SYNC
value|8
end_define

begin_define
define|#
directive|define
name|ZLIB_HEADERSIZE
value|4
end_define

begin_define
define|#
directive|define
name|ZSTD_HEADERSIZE
value|ZSTD_frameHeaderSize_min
end_define

begin_define
define|#
directive|define
name|ZWRAP_DEFAULT_CLEVEL
value|3
end_define

begin_comment
comment|/* Z_DEFAULT_COMPRESSION is translated to ZWRAP_DEFAULT_CLEVEL for zstd */
end_comment

begin_comment
comment|/* ===   Debug   === */
end_comment

begin_define
define|#
directive|define
name|LOG_WRAPPERC
parameter_list|(
modifier|...
parameter_list|)
end_define

begin_comment
comment|/* fprintf(stderr, __VA_ARGS__) */
end_comment

begin_define
define|#
directive|define
name|LOG_WRAPPERD
parameter_list|(
modifier|...
parameter_list|)
end_define

begin_comment
comment|/* fprintf(stderr, __VA_ARGS__) */
end_comment

begin_define
define|#
directive|define
name|FINISH_WITH_GZ_ERR
parameter_list|(
name|msg
parameter_list|)
value|{ (void)msg; return Z_STREAM_ERROR; }
end_define

begin_define
define|#
directive|define
name|FINISH_WITH_NULL_ERR
parameter_list|(
name|msg
parameter_list|)
value|{ (void)msg; return NULL; }
end_define

begin_comment
comment|/* ===   Wrapper   === */
end_comment

begin_decl_stmt
specifier|static
name|int
name|g_ZWRAP_useZSTDcompression
init|=
name|ZWRAP_USE_ZSTD
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 0 = don't use ZSTD */
end_comment

begin_function
name|void
name|ZWRAP_useZSTDcompression
parameter_list|(
name|int
name|turn_on
parameter_list|)
block|{
name|g_ZWRAP_useZSTDcompression
operator|=
name|turn_on
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ZWRAP_isUsingZSTDcompression
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|g_ZWRAP_useZSTDcompression
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|ZWRAP_decompress_type
name|g_ZWRAPdecompressionType
init|=
name|ZWRAP_AUTO
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|ZWRAP_setDecompressionType
parameter_list|(
name|ZWRAP_decompress_type
name|type
parameter_list|)
block|{
name|g_ZWRAPdecompressionType
operator|=
name|type
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
name|ZWRAP_decompress_type
name|ZWRAP_getDecompressionType
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|g_ZWRAPdecompressionType
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|zstdVersion
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|ZSTD_VERSION_STRING
return|;
block|}
end_function

begin_decl_stmt
name|ZEXTERN
specifier|const
name|char
modifier|*
name|ZEXPORT
name|z_zlibVersion
name|OF
argument_list|(
operator|(
name|void
operator|)
argument_list|)
block|{
return|return
name|zlibVersion
argument_list|()
return|;
block|}
end_decl_stmt

begin_function
specifier|static
name|void
modifier|*
name|ZWRAP_allocFunction
parameter_list|(
name|void
modifier|*
name|opaque
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|z_streamp
name|strm
init|=
operator|(
name|z_streamp
operator|)
name|opaque
decl_stmt|;
name|void
modifier|*
name|address
init|=
name|strm
operator|->
name|zalloc
argument_list|(
name|strm
operator|->
name|opaque
argument_list|,
literal|1
argument_list|,
operator|(
name|uInt
operator|)
name|size
argument_list|)
decl_stmt|;
comment|/* LOG_WRAPPERC("ZWRAP alloc %p, %d \n", address, (int)size); */
return|return
name|address
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ZWRAP_freeFunction
parameter_list|(
name|void
modifier|*
name|opaque
parameter_list|,
name|void
modifier|*
name|address
parameter_list|)
block|{
name|z_streamp
name|strm
init|=
operator|(
name|z_streamp
operator|)
name|opaque
decl_stmt|;
name|strm
operator|->
name|zfree
argument_list|(
name|strm
operator|->
name|opaque
argument_list|,
name|address
argument_list|)
expr_stmt|;
comment|/* if (address) LOG_WRAPPERC("ZWRAP free %p \n", address); */
block|}
end_function

begin_comment
comment|/* ===   Compression   === */
end_comment

begin_typedef
typedef|typedef
enum|enum
block|{
name|ZWRAP_useInit
block|,
name|ZWRAP_useReset
block|,
name|ZWRAP_streamEnd
block|}
name|ZWRAP_state_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|ZSTD_CStream
modifier|*
name|zbc
decl_stmt|;
name|int
name|compressionLevel
decl_stmt|;
name|int
name|streamEnd
decl_stmt|;
comment|/* a flag to signal the end of a stream */
name|unsigned
name|long
name|long
name|totalInBytes
decl_stmt|;
comment|/* we need it as strm->total_in can be reset by user */
name|ZSTD_customMem
name|customMem
decl_stmt|;
name|z_stream
name|allocFunc
decl_stmt|;
comment|/* copy of zalloc, zfree, opaque */
name|ZSTD_inBuffer
name|inBuffer
decl_stmt|;
name|ZSTD_outBuffer
name|outBuffer
decl_stmt|;
name|ZWRAP_state_t
name|comprState
decl_stmt|;
name|unsigned
name|long
name|long
name|pledgedSrcSize
decl_stmt|;
block|}
name|ZWRAP_CCtx
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|ZWRAP_CCtx
name|internal_state
typedef|;
end_typedef

begin_function
specifier|static
name|size_t
name|ZWRAP_freeCCtx
parameter_list|(
name|ZWRAP_CCtx
modifier|*
name|zwc
parameter_list|)
block|{
if|if
condition|(
name|zwc
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* support free on NULL */
name|ZSTD_freeCStream
argument_list|(
name|zwc
operator|->
name|zbc
argument_list|)
expr_stmt|;
name|ZSTD_free
argument_list|(
name|zwc
argument_list|,
name|zwc
operator|->
name|customMem
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|ZWRAP_CCtx
modifier|*
name|ZWRAP_createCCtx
parameter_list|(
name|z_streamp
name|strm
parameter_list|)
block|{
name|ZWRAP_CCtx
modifier|*
name|zwc
decl_stmt|;
if|if
condition|(
name|strm
operator|->
name|zalloc
operator|&&
name|strm
operator|->
name|zfree
condition|)
block|{
name|zwc
operator|=
operator|(
name|ZWRAP_CCtx
operator|*
operator|)
name|strm
operator|->
name|zalloc
argument_list|(
name|strm
operator|->
name|opaque
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ZWRAP_CCtx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwc
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|zwc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ZWRAP_CCtx
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|zwc
operator|->
name|allocFunc
argument_list|,
name|strm
argument_list|,
sizeof|sizeof
argument_list|(
name|z_stream
argument_list|)
argument_list|)
expr_stmt|;
block|{
name|ZSTD_customMem
specifier|const
name|ZWRAP_customMem
init|=
block|{
name|ZWRAP_allocFunction
block|,
name|ZWRAP_freeFunction
block|,
operator|&
name|zwc
operator|->
name|allocFunc
block|}
decl_stmt|;
name|zwc
operator|->
name|customMem
operator|=
name|ZWRAP_customMem
expr_stmt|;
block|}
block|}
else|else
block|{
name|zwc
operator|=
operator|(
name|ZWRAP_CCtx
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|zwc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwc
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
block|}
return|return
name|zwc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ZWRAP_initializeCStream
parameter_list|(
name|ZWRAP_CCtx
modifier|*
name|zwc
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|)
block|{
name|LOG_WRAPPERC
argument_list|(
literal|"- ZWRAP_initializeCStream=%p\n"
argument_list|,
name|zwc
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwc
operator|==
name|NULL
operator|||
name|zwc
operator|->
name|zbc
operator|==
name|NULL
condition|)
return|return
name|Z_STREAM_ERROR
return|;
if|if
condition|(
operator|!
name|pledgedSrcSize
condition|)
name|pledgedSrcSize
operator|=
name|zwc
operator|->
name|pledgedSrcSize
expr_stmt|;
block|{
name|ZSTD_parameters
specifier|const
name|params
init|=
name|ZSTD_getParams
argument_list|(
name|zwc
operator|->
name|compressionLevel
argument_list|,
name|pledgedSrcSize
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
name|size_t
name|initErr
decl_stmt|;
name|LOG_WRAPPERC
argument_list|(
literal|"pledgedSrcSize=%d windowLog=%d chainLog=%d hashLog=%d searchLog=%d searchLength=%d strategy=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|pledgedSrcSize
argument_list|,
name|params
operator|.
name|cParams
operator|.
name|windowLog
argument_list|,
name|params
operator|.
name|cParams
operator|.
name|chainLog
argument_list|,
name|params
operator|.
name|cParams
operator|.
name|hashLog
argument_list|,
name|params
operator|.
name|cParams
operator|.
name|searchLog
argument_list|,
name|params
operator|.
name|cParams
operator|.
name|searchLength
argument_list|,
name|params
operator|.
name|cParams
operator|.
name|strategy
argument_list|)
expr_stmt|;
name|initErr
operator|=
name|ZSTD_initCStream_advanced
argument_list|(
name|zwc
operator|->
name|zbc
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|params
argument_list|,
name|pledgedSrcSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|initErr
argument_list|)
condition|)
return|return
name|Z_STREAM_ERROR
return|;
block|}
return|return
name|Z_OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ZWRAPC_finishWithError
parameter_list|(
name|ZWRAP_CCtx
modifier|*
name|zwc
parameter_list|,
name|z_streamp
name|strm
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|LOG_WRAPPERC
argument_list|(
literal|"- ZWRAPC_finishWithError=%d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwc
condition|)
name|ZWRAP_freeCCtx
argument_list|(
name|zwc
argument_list|)
expr_stmt|;
if|if
condition|(
name|strm
condition|)
name|strm
operator|->
name|state
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|error
operator|)
condition|?
name|error
else|:
name|Z_STREAM_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ZWRAPC_finishWithErrorMsg
parameter_list|(
name|z_streamp
name|strm
parameter_list|,
name|char
modifier|*
name|message
parameter_list|)
block|{
name|ZWRAP_CCtx
modifier|*
name|zwc
init|=
operator|(
name|ZWRAP_CCtx
operator|*
operator|)
name|strm
operator|->
name|state
decl_stmt|;
name|strm
operator|->
name|msg
operator|=
name|message
expr_stmt|;
if|if
condition|(
name|zwc
operator|==
name|NULL
condition|)
return|return
name|Z_STREAM_ERROR
return|;
return|return
name|ZWRAPC_finishWithError
argument_list|(
name|zwc
argument_list|,
name|strm
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|ZWRAP_setPledgedSrcSize
parameter_list|(
name|z_streamp
name|strm
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|)
block|{
name|ZWRAP_CCtx
modifier|*
name|zwc
init|=
operator|(
name|ZWRAP_CCtx
operator|*
operator|)
name|strm
operator|->
name|state
decl_stmt|;
if|if
condition|(
name|zwc
operator|==
name|NULL
condition|)
return|return
name|Z_STREAM_ERROR
return|;
name|zwc
operator|->
name|pledgedSrcSize
operator|=
name|pledgedSrcSize
expr_stmt|;
name|zwc
operator|->
name|comprState
operator|=
name|ZWRAP_useInit
expr_stmt|;
return|return
name|Z_OK
return|;
block|}
end_function

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_deflateInit_
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|int
name|level
operator|,
specifier|const
name|char
operator|*
name|version
operator|,
name|int
name|stream_size
operator|)
argument_list|)
block|{
name|ZWRAP_CCtx
modifier|*
name|zwc
decl_stmt|;
name|LOG_WRAPPERC
argument_list|(
literal|"- deflateInit level=%d\n"
argument_list|,
name|level
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
block|{
return|return
name|deflateInit_
argument_list|(
operator|(
name|strm
operator|)
argument_list|,
operator|(
name|level
operator|)
argument_list|,
name|version
argument_list|,
name|stream_size
argument_list|)
return|;
block|}
name|zwc
operator|=
name|ZWRAP_createCCtx
argument_list|(
name|strm
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwc
operator|==
name|NULL
condition|)
return|return
name|Z_MEM_ERROR
return|;
if|if
condition|(
name|level
operator|==
name|Z_DEFAULT_COMPRESSION
condition|)
name|level
operator|=
name|ZWRAP_DEFAULT_CLEVEL
expr_stmt|;
name|zwc
operator|->
name|streamEnd
operator|=
literal|0
expr_stmt|;
name|zwc
operator|->
name|totalInBytes
operator|=
literal|0
expr_stmt|;
name|zwc
operator|->
name|compressionLevel
operator|=
name|level
expr_stmt|;
name|strm
operator|->
name|state
operator|=
operator|(
expr|struct
name|internal_state
operator|*
operator|)
name|zwc
expr_stmt|;
comment|/* use state which in not used by user */
name|strm
operator|->
name|total_in
operator|=
literal|0
expr_stmt|;
name|strm
operator|->
name|total_out
operator|=
literal|0
expr_stmt|;
name|strm
operator|->
name|adler
operator|=
literal|0
expr_stmt|;
return|return
name|Z_OK
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_deflateInit2_
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|int
name|level
operator|,
name|int
name|method
operator|,
name|int
name|windowBits
operator|,
name|int
name|memLevel
operator|,
name|int
name|strategy
operator|,
specifier|const
name|char
operator|*
name|version
operator|,
name|int
name|stream_size
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
return|return
name|deflateInit2_
argument_list|(
name|strm
argument_list|,
name|level
argument_list|,
name|method
argument_list|,
name|windowBits
argument_list|,
name|memLevel
argument_list|,
name|strategy
argument_list|,
name|version
argument_list|,
name|stream_size
argument_list|)
return|;
return|return
name|z_deflateInit_
argument_list|(
name|strm
argument_list|,
name|level
argument_list|,
name|version
argument_list|,
name|stream_size
argument_list|)
return|;
block|}
end_decl_stmt

begin_function
name|int
name|ZWRAP_deflateReset_keepDict
parameter_list|(
name|z_streamp
name|strm
parameter_list|)
block|{
name|LOG_WRAPPERC
argument_list|(
literal|"- ZWRAP_deflateReset_keepDict\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
return|return
name|deflateReset
argument_list|(
name|strm
argument_list|)
return|;
block|{
name|ZWRAP_CCtx
modifier|*
name|zwc
init|=
operator|(
name|ZWRAP_CCtx
operator|*
operator|)
name|strm
operator|->
name|state
decl_stmt|;
if|if
condition|(
name|zwc
condition|)
block|{
name|zwc
operator|->
name|streamEnd
operator|=
literal|0
expr_stmt|;
name|zwc
operator|->
name|totalInBytes
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|strm
operator|->
name|total_in
operator|=
literal|0
expr_stmt|;
name|strm
operator|->
name|total_out
operator|=
literal|0
expr_stmt|;
name|strm
operator|->
name|adler
operator|=
literal|0
expr_stmt|;
return|return
name|Z_OK
return|;
block|}
end_function

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_deflateReset
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|)
argument_list|)
block|{
name|LOG_WRAPPERC
argument_list|(
literal|"- deflateReset\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
return|return
name|deflateReset
argument_list|(
name|strm
argument_list|)
return|;
name|ZWRAP_deflateReset_keepDict
argument_list|(
name|strm
argument_list|)
expr_stmt|;
block|{
name|ZWRAP_CCtx
modifier|*
name|zwc
init|=
operator|(
name|ZWRAP_CCtx
operator|*
operator|)
name|strm
operator|->
name|state
decl_stmt|;
if|if
condition|(
name|zwc
condition|)
name|zwc
operator|->
name|comprState
operator|=
name|ZWRAP_useInit
expr_stmt|;
block|}
return|return
name|Z_OK
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_deflateSetDictionary
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
specifier|const
name|Bytef
operator|*
name|dictionary
operator|,
name|uInt
name|dictLength
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
block|{
name|LOG_WRAPPERC
argument_list|(
literal|"- deflateSetDictionary\n"
argument_list|)
expr_stmt|;
return|return
name|deflateSetDictionary
argument_list|(
name|strm
argument_list|,
name|dictionary
argument_list|,
name|dictLength
argument_list|)
return|;
block|}
block|{
name|ZWRAP_CCtx
modifier|*
name|zwc
init|=
operator|(
name|ZWRAP_CCtx
operator|*
operator|)
name|strm
operator|->
name|state
decl_stmt|;
name|LOG_WRAPPERC
argument_list|(
literal|"- deflateSetDictionary level=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|zwc
operator|->
name|compressionLevel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|zwc
condition|)
return|return
name|Z_STREAM_ERROR
return|;
if|if
condition|(
name|zwc
operator|->
name|zbc
operator|==
name|NULL
condition|)
block|{
name|zwc
operator|->
name|zbc
operator|=
name|ZSTD_createCStream_advanced
argument_list|(
name|zwc
operator|->
name|customMem
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwc
operator|->
name|zbc
operator|==
name|NULL
condition|)
return|return
name|ZWRAPC_finishWithError
argument_list|(
name|zwc
argument_list|,
name|strm
argument_list|,
literal|0
argument_list|)
return|;
block|}
block|{
name|int
name|res
init|=
name|ZWRAP_initializeCStream
argument_list|(
name|zwc
argument_list|,
name|dictionary
argument_list|,
name|dictLength
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
operator|!=
name|Z_OK
condition|)
return|return
name|ZWRAPC_finishWithError
argument_list|(
name|zwc
argument_list|,
name|strm
argument_list|,
name|res
argument_list|)
return|;
block|}
name|zwc
operator|->
name|comprState
operator|=
name|ZWRAP_useReset
expr_stmt|;
block|}
return|return
name|Z_OK
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_deflate
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|int
name|flush
operator|)
argument_list|)
block|{
name|ZWRAP_CCtx
modifier|*
name|zwc
decl_stmt|;
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
block|{
name|LOG_WRAPPERC
argument_list|(
literal|"- deflate1 flush=%d avail_in=%d avail_out=%d total_in=%d total_out=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|flush
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_out
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_out
argument_list|)
expr_stmt|;
return|return
name|deflate
argument_list|(
name|strm
argument_list|,
name|flush
argument_list|)
return|;
block|}
name|zwc
operator|=
operator|(
name|ZWRAP_CCtx
operator|*
operator|)
name|strm
operator|->
name|state
expr_stmt|;
if|if
condition|(
name|zwc
operator|==
name|NULL
condition|)
block|{
name|LOG_WRAPPERC
argument_list|(
literal|"zwc == NULL\n"
argument_list|)
expr_stmt|;
return|return
name|Z_STREAM_ERROR
return|;
block|}
if|if
condition|(
name|zwc
operator|->
name|zbc
operator|==
name|NULL
condition|)
block|{
name|zwc
operator|->
name|zbc
operator|=
name|ZSTD_createCStream_advanced
argument_list|(
name|zwc
operator|->
name|customMem
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwc
operator|->
name|zbc
operator|==
name|NULL
condition|)
return|return
name|ZWRAPC_finishWithError
argument_list|(
name|zwc
argument_list|,
name|strm
argument_list|,
literal|0
argument_list|)
return|;
block|{
name|int
specifier|const
name|initErr
init|=
name|ZWRAP_initializeCStream
argument_list|(
name|zwc
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|(
name|flush
operator|==
name|Z_FINISH
operator|)
condition|?
name|strm
operator|->
name|avail_in
else|:
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|initErr
operator|!=
name|Z_OK
condition|)
return|return
name|ZWRAPC_finishWithError
argument_list|(
name|zwc
argument_list|,
name|strm
argument_list|,
name|initErr
argument_list|)
return|;
block|}
if|if
condition|(
name|flush
operator|!=
name|Z_FINISH
condition|)
name|zwc
operator|->
name|comprState
operator|=
name|ZWRAP_useReset
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|zwc
operator|->
name|totalInBytes
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|zwc
operator|->
name|comprState
operator|==
name|ZWRAP_useReset
condition|)
block|{
name|size_t
specifier|const
name|resetErr
init|=
name|ZSTD_resetCStream
argument_list|(
name|zwc
operator|->
name|zbc
argument_list|,
operator|(
name|flush
operator|==
name|Z_FINISH
operator|)
condition|?
name|strm
operator|->
name|avail_in
else|:
name|zwc
operator|->
name|pledgedSrcSize
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|resetErr
argument_list|)
condition|)
block|{
name|LOG_WRAPPERC
argument_list|(
literal|"ERROR: ZSTD_resetCStream errorCode=%s\n"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|resetErr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ZWRAPC_finishWithError
argument_list|(
name|zwc
argument_list|,
name|strm
argument_list|,
literal|0
argument_list|)
return|;
block|}
block|}
else|else
block|{
name|int
specifier|const
name|res
init|=
name|ZWRAP_initializeCStream
argument_list|(
name|zwc
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|(
name|flush
operator|==
name|Z_FINISH
operator|)
condition|?
name|strm
operator|->
name|avail_in
else|:
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
operator|!=
name|Z_OK
condition|)
return|return
name|ZWRAPC_finishWithError
argument_list|(
name|zwc
argument_list|,
name|strm
argument_list|,
name|res
argument_list|)
return|;
if|if
condition|(
name|flush
operator|!=
name|Z_FINISH
condition|)
name|zwc
operator|->
name|comprState
operator|=
name|ZWRAP_useReset
expr_stmt|;
block|}
block|}
comment|/* (zwc->totalInBytes == 0) */
block|}
comment|/* ! (zwc->zbc == NULL) */
name|LOG_WRAPPERC
argument_list|(
literal|"- deflate2 flush=%d avail_in=%d avail_out=%d total_in=%d total_out=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|flush
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_out
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_out
argument_list|)
expr_stmt|;
if|if
condition|(
name|strm
operator|->
name|avail_in
operator|>
literal|0
condition|)
block|{
name|zwc
operator|->
name|inBuffer
operator|.
name|src
operator|=
name|strm
operator|->
name|next_in
expr_stmt|;
name|zwc
operator|->
name|inBuffer
operator|.
name|size
operator|=
name|strm
operator|->
name|avail_in
expr_stmt|;
name|zwc
operator|->
name|inBuffer
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
name|zwc
operator|->
name|outBuffer
operator|.
name|dst
operator|=
name|strm
operator|->
name|next_out
expr_stmt|;
name|zwc
operator|->
name|outBuffer
operator|.
name|size
operator|=
name|strm
operator|->
name|avail_out
expr_stmt|;
name|zwc
operator|->
name|outBuffer
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
block|{
name|size_t
specifier|const
name|cErr
init|=
name|ZSTD_compressStream
argument_list|(
name|zwc
operator|->
name|zbc
argument_list|,
operator|&
name|zwc
operator|->
name|outBuffer
argument_list|,
operator|&
name|zwc
operator|->
name|inBuffer
argument_list|)
decl_stmt|;
name|LOG_WRAPPERC
argument_list|(
literal|"deflate ZSTD_compressStream srcSize=%d dstCapacity=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|zwc
operator|->
name|inBuffer
operator|.
name|size
argument_list|,
operator|(
name|int
operator|)
name|zwc
operator|->
name|outBuffer
operator|.
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cErr
argument_list|)
condition|)
return|return
name|ZWRAPC_finishWithError
argument_list|(
name|zwc
argument_list|,
name|strm
argument_list|,
literal|0
argument_list|)
return|;
block|}
name|strm
operator|->
name|next_out
operator|+=
name|zwc
operator|->
name|outBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|total_out
operator|+=
name|zwc
operator|->
name|outBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|avail_out
operator|-=
name|zwc
operator|->
name|outBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|total_in
operator|+=
name|zwc
operator|->
name|inBuffer
operator|.
name|pos
expr_stmt|;
name|zwc
operator|->
name|totalInBytes
operator|+=
name|zwc
operator|->
name|inBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|next_in
operator|+=
name|zwc
operator|->
name|inBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|avail_in
operator|-=
name|zwc
operator|->
name|inBuffer
operator|.
name|pos
expr_stmt|;
block|}
if|if
condition|(
name|flush
operator|==
name|Z_FULL_FLUSH
if|#
directive|if
name|ZLIB_VERNUM
operator|>=
literal|0x1240
operator|||
name|flush
operator|==
name|Z_TREES
endif|#
directive|endif
operator|||
name|flush
operator|==
name|Z_BLOCK
condition|)
return|return
name|ZWRAPC_finishWithErrorMsg
argument_list|(
name|strm
argument_list|,
literal|"Z_FULL_FLUSH, Z_BLOCK and Z_TREES are not supported!"
argument_list|)
return|;
if|if
condition|(
name|flush
operator|==
name|Z_FINISH
condition|)
block|{
name|size_t
name|bytesLeft
decl_stmt|;
if|if
condition|(
name|zwc
operator|->
name|streamEnd
condition|)
return|return
name|Z_STREAM_END
return|;
name|zwc
operator|->
name|outBuffer
operator|.
name|dst
operator|=
name|strm
operator|->
name|next_out
expr_stmt|;
name|zwc
operator|->
name|outBuffer
operator|.
name|size
operator|=
name|strm
operator|->
name|avail_out
expr_stmt|;
name|zwc
operator|->
name|outBuffer
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
name|bytesLeft
operator|=
name|ZSTD_endStream
argument_list|(
name|zwc
operator|->
name|zbc
argument_list|,
operator|&
name|zwc
operator|->
name|outBuffer
argument_list|)
expr_stmt|;
name|LOG_WRAPPERC
argument_list|(
literal|"deflate ZSTD_endStream dstCapacity=%d bytesLeft=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_out
argument_list|,
operator|(
name|int
operator|)
name|bytesLeft
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|bytesLeft
argument_list|)
condition|)
return|return
name|ZWRAPC_finishWithError
argument_list|(
name|zwc
argument_list|,
name|strm
argument_list|,
literal|0
argument_list|)
return|;
name|strm
operator|->
name|next_out
operator|+=
name|zwc
operator|->
name|outBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|total_out
operator|+=
name|zwc
operator|->
name|outBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|avail_out
operator|-=
name|zwc
operator|->
name|outBuffer
operator|.
name|pos
expr_stmt|;
if|if
condition|(
name|bytesLeft
operator|==
literal|0
condition|)
block|{
name|zwc
operator|->
name|streamEnd
operator|=
literal|1
expr_stmt|;
name|LOG_WRAPPERC
argument_list|(
literal|"Z_STREAM_END2 strm->total_in=%d strm->avail_out=%d strm->total_out=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_out
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_out
argument_list|)
expr_stmt|;
return|return
name|Z_STREAM_END
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|flush
operator|==
name|Z_SYNC_FLUSH
operator|||
name|flush
operator|==
name|Z_PARTIAL_FLUSH
condition|)
block|{
name|size_t
name|bytesLeft
decl_stmt|;
name|zwc
operator|->
name|outBuffer
operator|.
name|dst
operator|=
name|strm
operator|->
name|next_out
expr_stmt|;
name|zwc
operator|->
name|outBuffer
operator|.
name|size
operator|=
name|strm
operator|->
name|avail_out
expr_stmt|;
name|zwc
operator|->
name|outBuffer
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
name|bytesLeft
operator|=
name|ZSTD_flushStream
argument_list|(
name|zwc
operator|->
name|zbc
argument_list|,
operator|&
name|zwc
operator|->
name|outBuffer
argument_list|)
expr_stmt|;
name|LOG_WRAPPERC
argument_list|(
literal|"deflate ZSTD_flushStream dstCapacity=%d bytesLeft=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_out
argument_list|,
operator|(
name|int
operator|)
name|bytesLeft
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|bytesLeft
argument_list|)
condition|)
return|return
name|ZWRAPC_finishWithError
argument_list|(
name|zwc
argument_list|,
name|strm
argument_list|,
literal|0
argument_list|)
return|;
name|strm
operator|->
name|next_out
operator|+=
name|zwc
operator|->
name|outBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|total_out
operator|+=
name|zwc
operator|->
name|outBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|avail_out
operator|-=
name|zwc
operator|->
name|outBuffer
operator|.
name|pos
expr_stmt|;
block|}
name|LOG_WRAPPERC
argument_list|(
literal|"- deflate3 flush=%d avail_in=%d avail_out=%d total_in=%d total_out=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|flush
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_out
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_out
argument_list|)
expr_stmt|;
return|return
name|Z_OK
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_deflateEnd
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
block|{
name|LOG_WRAPPERC
argument_list|(
literal|"- deflateEnd\n"
argument_list|)
expr_stmt|;
return|return
name|deflateEnd
argument_list|(
name|strm
argument_list|)
return|;
block|}
name|LOG_WRAPPERC
argument_list|(
literal|"- deflateEnd total_in=%d total_out=%d\n"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|strm
operator|->
name|total_in
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
name|strm
operator|->
name|total_out
argument_list|)
argument_list|)
expr_stmt|;
block|{
name|size_t
name|errorCode
decl_stmt|;
name|ZWRAP_CCtx
modifier|*
name|zwc
init|=
operator|(
name|ZWRAP_CCtx
operator|*
operator|)
name|strm
operator|->
name|state
decl_stmt|;
if|if
condition|(
name|zwc
operator|==
name|NULL
condition|)
return|return
name|Z_OK
return|;
comment|/* structures are already freed */
name|strm
operator|->
name|state
operator|=
name|NULL
expr_stmt|;
name|errorCode
operator|=
name|ZWRAP_freeCCtx
argument_list|(
name|zwc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|errorCode
argument_list|)
condition|)
return|return
name|Z_STREAM_ERROR
return|;
block|}
return|return
name|Z_OK
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|uLong
name|ZEXPORT
name|z_deflateBound
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|uLong
name|sourceLen
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
return|return
name|deflateBound
argument_list|(
name|strm
argument_list|,
name|sourceLen
argument_list|)
return|;
return|return
name|ZSTD_compressBound
argument_list|(
name|sourceLen
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_deflateParams
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|int
name|level
operator|,
name|int
name|strategy
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
block|{
name|LOG_WRAPPERC
argument_list|(
literal|"- deflateParams level=%d strategy=%d\n"
argument_list|,
name|level
argument_list|,
name|strategy
argument_list|)
expr_stmt|;
return|return
name|deflateParams
argument_list|(
name|strm
argument_list|,
name|level
argument_list|,
name|strategy
argument_list|)
return|;
block|}
return|return
name|Z_OK
return|;
block|}
end_decl_stmt

begin_comment
comment|/* ===   Decompression   === */
end_comment

begin_typedef
typedef|typedef
enum|enum
block|{
name|ZWRAP_ZLIB_STREAM
block|,
name|ZWRAP_ZSTD_STREAM
block|,
name|ZWRAP_UNKNOWN_STREAM
block|}
name|ZWRAP_stream_type
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|ZSTD_DStream
modifier|*
name|zbd
decl_stmt|;
name|char
name|headerBuf
index|[
literal|16
index|]
decl_stmt|;
comment|/* must be>= ZSTD_frameHeaderSize_min */
name|int
name|errorCount
decl_stmt|;
name|unsigned
name|long
name|long
name|totalInBytes
decl_stmt|;
comment|/* we need it as strm->total_in can be reset by user */
name|ZWRAP_state_t
name|decompState
decl_stmt|;
name|ZSTD_inBuffer
name|inBuffer
decl_stmt|;
name|ZSTD_outBuffer
name|outBuffer
decl_stmt|;
comment|/* zlib params */
name|int
name|stream_size
decl_stmt|;
name|char
modifier|*
name|version
decl_stmt|;
name|int
name|windowBits
decl_stmt|;
name|ZSTD_customMem
name|customMem
decl_stmt|;
name|z_stream
name|allocFunc
decl_stmt|;
comment|/* just to copy zalloc, zfree, opaque */
block|}
name|ZWRAP_DCtx
typedef|;
end_typedef

begin_function
specifier|static
name|void
name|ZWRAP_initDCtx
parameter_list|(
name|ZWRAP_DCtx
modifier|*
name|zwd
parameter_list|)
block|{
name|zwd
operator|->
name|errorCount
operator|=
literal|0
expr_stmt|;
name|zwd
operator|->
name|outBuffer
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
name|zwd
operator|->
name|outBuffer
operator|.
name|size
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ZWRAP_DCtx
modifier|*
name|ZWRAP_createDCtx
parameter_list|(
name|z_streamp
name|strm
parameter_list|)
block|{
name|ZWRAP_DCtx
modifier|*
name|zwd
decl_stmt|;
name|MEM_STATIC_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|zwd
operator|->
name|headerBuf
argument_list|)
operator|>=
name|ZSTD_FRAMEHEADERSIZE_MIN
argument_list|)
expr_stmt|;
comment|/* check static buffer size condition */
if|if
condition|(
name|strm
operator|->
name|zalloc
operator|&&
name|strm
operator|->
name|zfree
condition|)
block|{
name|zwd
operator|=
operator|(
name|ZWRAP_DCtx
operator|*
operator|)
name|strm
operator|->
name|zalloc
argument_list|(
name|strm
operator|->
name|opaque
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ZWRAP_DCtx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwd
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|zwd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ZWRAP_DCtx
argument_list|)
argument_list|)
expr_stmt|;
name|zwd
operator|->
name|allocFunc
operator|=
operator|*
name|strm
expr_stmt|;
comment|/* just to copy zalloc, zfree& opaque */
block|{
name|ZSTD_customMem
specifier|const
name|ZWRAP_customMem
init|=
block|{
name|ZWRAP_allocFunction
block|,
name|ZWRAP_freeFunction
block|,
operator|&
name|zwd
operator|->
name|allocFunc
block|}
decl_stmt|;
name|zwd
operator|->
name|customMem
operator|=
name|ZWRAP_customMem
expr_stmt|;
block|}
block|}
else|else
block|{
name|zwd
operator|=
operator|(
name|ZWRAP_DCtx
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|zwd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwd
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
block|}
name|ZWRAP_initDCtx
argument_list|(
name|zwd
argument_list|)
expr_stmt|;
return|return
name|zwd
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZWRAP_freeDCtx
parameter_list|(
name|ZWRAP_DCtx
modifier|*
name|zwd
parameter_list|)
block|{
if|if
condition|(
name|zwd
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* support free on null */
name|ZSTD_freeDStream
argument_list|(
name|zwd
operator|->
name|zbd
argument_list|)
expr_stmt|;
name|ZSTD_free
argument_list|(
name|zwd
operator|->
name|version
argument_list|,
name|zwd
operator|->
name|customMem
argument_list|)
expr_stmt|;
name|ZSTD_free
argument_list|(
name|zwd
argument_list|,
name|zwd
operator|->
name|customMem
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ZWRAP_isUsingZSTDdecompression
parameter_list|(
name|z_streamp
name|strm
parameter_list|)
block|{
if|if
condition|(
name|strm
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
operator|(
name|strm
operator|->
name|reserved
operator|==
name|ZWRAP_ZSTD_STREAM
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ZWRAPD_finishWithError
parameter_list|(
name|ZWRAP_DCtx
modifier|*
name|zwd
parameter_list|,
name|z_streamp
name|strm
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|LOG_WRAPPERD
argument_list|(
literal|"- ZWRAPD_finishWithError=%d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|ZWRAP_freeDCtx
argument_list|(
name|zwd
argument_list|)
expr_stmt|;
name|strm
operator|->
name|state
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|error
operator|)
condition|?
name|error
else|:
name|Z_STREAM_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ZWRAPD_finishWithErrorMsg
parameter_list|(
name|z_streamp
name|strm
parameter_list|,
name|char
modifier|*
name|message
parameter_list|)
block|{
name|ZWRAP_DCtx
modifier|*
specifier|const
name|zwd
init|=
operator|(
name|ZWRAP_DCtx
operator|*
operator|)
name|strm
operator|->
name|state
decl_stmt|;
name|strm
operator|->
name|msg
operator|=
name|message
expr_stmt|;
if|if
condition|(
name|zwd
operator|==
name|NULL
condition|)
return|return
name|Z_STREAM_ERROR
return|;
return|return
name|ZWRAPD_finishWithError
argument_list|(
name|zwd
argument_list|,
name|strm
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflateInit_
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
specifier|const
name|char
operator|*
name|version
operator|,
name|int
name|stream_size
operator|)
argument_list|)
block|{
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
condition|)
block|{
name|strm
operator|->
name|reserved
operator|=
name|ZWRAP_ZLIB_STREAM
expr_stmt|;
return|return
name|inflateInit
argument_list|(
name|strm
argument_list|)
return|;
block|}
block|{
name|ZWRAP_DCtx
modifier|*
specifier|const
name|zwd
init|=
name|ZWRAP_createDCtx
argument_list|(
name|strm
argument_list|)
decl_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"- inflateInit\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwd
operator|==
name|NULL
condition|)
return|return
name|ZWRAPD_finishWithError
argument_list|(
name|zwd
argument_list|,
name|strm
argument_list|,
literal|0
argument_list|)
return|;
name|zwd
operator|->
name|version
operator|=
name|ZSTD_malloc
argument_list|(
name|strlen
argument_list|(
name|version
argument_list|)
operator|+
literal|1
argument_list|,
name|zwd
operator|->
name|customMem
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwd
operator|->
name|version
operator|==
name|NULL
condition|)
return|return
name|ZWRAPD_finishWithError
argument_list|(
name|zwd
argument_list|,
name|strm
argument_list|,
literal|0
argument_list|)
return|;
name|strcpy
argument_list|(
name|zwd
operator|->
name|version
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|zwd
operator|->
name|stream_size
operator|=
name|stream_size
expr_stmt|;
name|zwd
operator|->
name|totalInBytes
operator|=
literal|0
expr_stmt|;
name|strm
operator|->
name|state
operator|=
operator|(
expr|struct
name|internal_state
operator|*
operator|)
name|zwd
expr_stmt|;
name|strm
operator|->
name|total_in
operator|=
literal|0
expr_stmt|;
name|strm
operator|->
name|total_out
operator|=
literal|0
expr_stmt|;
name|strm
operator|->
name|reserved
operator|=
name|ZWRAP_UNKNOWN_STREAM
expr_stmt|;
name|strm
operator|->
name|adler
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|Z_OK
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflateInit2_
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|int
name|windowBits
operator|,
specifier|const
name|char
operator|*
name|version
operator|,
name|int
name|stream_size
operator|)
argument_list|)
block|{
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
condition|)
block|{
return|return
name|inflateInit2_
argument_list|(
name|strm
argument_list|,
name|windowBits
argument_list|,
name|version
argument_list|,
name|stream_size
argument_list|)
return|;
block|}
block|{
name|int
specifier|const
name|ret
init|=
name|z_inflateInit_
argument_list|(
name|strm
argument_list|,
name|version
argument_list|,
name|stream_size
argument_list|)
decl_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"- inflateInit2 windowBits=%d\n"
argument_list|,
name|windowBits
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|Z_OK
condition|)
block|{
name|ZWRAP_DCtx
modifier|*
specifier|const
name|zwd
init|=
operator|(
name|ZWRAP_DCtx
operator|*
operator|)
name|strm
operator|->
name|state
decl_stmt|;
if|if
condition|(
name|zwd
operator|==
name|NULL
condition|)
return|return
name|Z_STREAM_ERROR
return|;
name|zwd
operator|->
name|windowBits
operator|=
name|windowBits
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
block|}
end_decl_stmt

begin_function
name|int
name|ZWRAP_inflateReset_keepDict
parameter_list|(
name|z_streamp
name|strm
parameter_list|)
block|{
name|LOG_WRAPPERD
argument_list|(
literal|"- ZWRAP_inflateReset_keepDict\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
return|return
name|inflateReset
argument_list|(
name|strm
argument_list|)
return|;
block|{
name|ZWRAP_DCtx
modifier|*
specifier|const
name|zwd
init|=
operator|(
name|ZWRAP_DCtx
operator|*
operator|)
name|strm
operator|->
name|state
decl_stmt|;
if|if
condition|(
name|zwd
operator|==
name|NULL
condition|)
return|return
name|Z_STREAM_ERROR
return|;
name|ZWRAP_initDCtx
argument_list|(
name|zwd
argument_list|)
expr_stmt|;
name|zwd
operator|->
name|decompState
operator|=
name|ZWRAP_useReset
expr_stmt|;
name|zwd
operator|->
name|totalInBytes
operator|=
literal|0
expr_stmt|;
block|}
name|strm
operator|->
name|total_in
operator|=
literal|0
expr_stmt|;
name|strm
operator|->
name|total_out
operator|=
literal|0
expr_stmt|;
return|return
name|Z_OK
return|;
block|}
end_function

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflateReset
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|)
argument_list|)
block|{
name|LOG_WRAPPERD
argument_list|(
literal|"- inflateReset\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
return|return
name|inflateReset
argument_list|(
name|strm
argument_list|)
return|;
block|{
name|int
specifier|const
name|ret
init|=
name|ZWRAP_inflateReset_keepDict
argument_list|(
name|strm
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
operator|!=
name|Z_OK
condition|)
return|return
name|ret
return|;
block|}
block|{
name|ZWRAP_DCtx
modifier|*
specifier|const
name|zwd
init|=
operator|(
name|ZWRAP_DCtx
operator|*
operator|)
name|strm
operator|->
name|state
decl_stmt|;
if|if
condition|(
name|zwd
operator|==
name|NULL
condition|)
return|return
name|Z_STREAM_ERROR
return|;
name|zwd
operator|->
name|decompState
operator|=
name|ZWRAP_useInit
expr_stmt|;
block|}
return|return
name|Z_OK
return|;
block|}
end_decl_stmt

begin_if
if|#
directive|if
name|ZLIB_VERNUM
operator|>=
literal|0x1240
end_if

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflateReset2
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|int
name|windowBits
operator|)
argument_list|)
block|{
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
return|return
name|inflateReset2
argument_list|(
name|strm
argument_list|,
name|windowBits
argument_list|)
return|;
block|{
name|int
specifier|const
name|ret
init|=
name|z_inflateReset
argument_list|(
name|strm
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
operator|==
name|Z_OK
condition|)
block|{
name|ZWRAP_DCtx
modifier|*
specifier|const
name|zwd
init|=
operator|(
name|ZWRAP_DCtx
operator|*
operator|)
name|strm
operator|->
name|state
decl_stmt|;
if|if
condition|(
name|zwd
operator|==
name|NULL
condition|)
return|return
name|Z_STREAM_ERROR
return|;
name|zwd
operator|->
name|windowBits
operator|=
name|windowBits
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflateSetDictionary
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
specifier|const
name|Bytef
operator|*
name|dictionary
operator|,
name|uInt
name|dictLength
operator|)
argument_list|)
block|{
name|LOG_WRAPPERD
argument_list|(
literal|"- inflateSetDictionary\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
return|return
name|inflateSetDictionary
argument_list|(
name|strm
argument_list|,
name|dictionary
argument_list|,
name|dictLength
argument_list|)
return|;
block|{
name|ZWRAP_DCtx
modifier|*
specifier|const
name|zwd
init|=
operator|(
name|ZWRAP_DCtx
operator|*
operator|)
name|strm
operator|->
name|state
decl_stmt|;
if|if
condition|(
name|zwd
operator|==
name|NULL
operator|||
name|zwd
operator|->
name|zbd
operator|==
name|NULL
condition|)
return|return
name|Z_STREAM_ERROR
return|;
block|{
name|size_t
specifier|const
name|initErr
init|=
name|ZSTD_initDStream_usingDict
argument_list|(
name|zwd
operator|->
name|zbd
argument_list|,
name|dictionary
argument_list|,
name|dictLength
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|initErr
argument_list|)
condition|)
return|return
name|ZWRAPD_finishWithError
argument_list|(
name|zwd
argument_list|,
name|strm
argument_list|,
literal|0
argument_list|)
return|;
block|}
name|zwd
operator|->
name|decompState
operator|=
name|ZWRAP_useReset
expr_stmt|;
if|if
condition|(
name|zwd
operator|->
name|totalInBytes
operator|==
name|ZSTD_HEADERSIZE
condition|)
block|{
name|zwd
operator|->
name|inBuffer
operator|.
name|src
operator|=
name|zwd
operator|->
name|headerBuf
expr_stmt|;
name|zwd
operator|->
name|inBuffer
operator|.
name|size
operator|=
name|zwd
operator|->
name|totalInBytes
expr_stmt|;
name|zwd
operator|->
name|inBuffer
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
name|zwd
operator|->
name|outBuffer
operator|.
name|dst
operator|=
name|strm
operator|->
name|next_out
expr_stmt|;
name|zwd
operator|->
name|outBuffer
operator|.
name|size
operator|=
literal|0
expr_stmt|;
name|zwd
operator|->
name|outBuffer
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
block|{
name|size_t
specifier|const
name|errorCode
init|=
name|ZSTD_decompressStream
argument_list|(
name|zwd
operator|->
name|zbd
argument_list|,
operator|&
name|zwd
operator|->
name|outBuffer
argument_list|,
operator|&
name|zwd
operator|->
name|inBuffer
argument_list|)
decl_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"inflateSetDictionary ZSTD_decompressStream errorCode=%d srcSize=%d dstCapacity=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|errorCode
argument_list|,
operator|(
name|int
operator|)
name|zwd
operator|->
name|inBuffer
operator|.
name|size
argument_list|,
operator|(
name|int
operator|)
name|zwd
operator|->
name|outBuffer
operator|.
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwd
operator|->
name|inBuffer
operator|.
name|pos
operator|<
name|zwd
operator|->
name|outBuffer
operator|.
name|size
operator|||
name|ZSTD_isError
argument_list|(
name|errorCode
argument_list|)
condition|)
block|{
name|LOG_WRAPPERD
argument_list|(
literal|"ERROR: ZSTD_decompressStream %s\n"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|errorCode
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ZWRAPD_finishWithError
argument_list|(
name|zwd
argument_list|,
name|strm
argument_list|,
literal|0
argument_list|)
return|;
block|}
block|}
block|}
block|}
return|return
name|Z_OK
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflate
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|int
name|flush
operator|)
argument_list|)
block|{
name|ZWRAP_DCtx
modifier|*
name|zwd
decl_stmt|;
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
block|{
name|int
specifier|const
name|result
init|=
name|inflate
argument_list|(
name|strm
argument_list|,
name|flush
argument_list|)
decl_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"- inflate2 flush=%d avail_in=%d avail_out=%d total_in=%d total_out=%d res=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|flush
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_out
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_out
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
if|if
condition|(
name|strm
operator|->
name|avail_in
operator|<=
literal|0
condition|)
return|return
name|Z_OK
return|;
name|zwd
operator|=
operator|(
name|ZWRAP_DCtx
operator|*
operator|)
name|strm
operator|->
name|state
expr_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"- inflate1 flush=%d avail_in=%d avail_out=%d total_in=%d total_out=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|flush
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_out
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_out
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwd
operator|==
name|NULL
condition|)
return|return
name|Z_STREAM_ERROR
return|;
if|if
condition|(
name|zwd
operator|->
name|decompState
operator|==
name|ZWRAP_streamEnd
condition|)
return|return
name|Z_STREAM_END
return|;
if|if
condition|(
name|zwd
operator|->
name|totalInBytes
operator|<
name|ZLIB_HEADERSIZE
condition|)
block|{
if|if
condition|(
name|zwd
operator|->
name|totalInBytes
operator|==
literal|0
operator|&&
name|strm
operator|->
name|avail_in
operator|>=
name|ZLIB_HEADERSIZE
condition|)
block|{
if|if
condition|(
name|MEM_readLE32
argument_list|(
name|strm
operator|->
name|next_in
argument_list|)
operator|!=
name|ZSTD_MAGICNUMBER
condition|)
block|{
block|{
name|int
specifier|const
name|initErr
init|=
operator|(
name|zwd
operator|->
name|windowBits
operator|)
condition|?
name|inflateInit2_
argument_list|(
name|strm
argument_list|,
name|zwd
operator|->
name|windowBits
argument_list|,
name|zwd
operator|->
name|version
argument_list|,
name|zwd
operator|->
name|stream_size
argument_list|)
else|:
name|inflateInit_
argument_list|(
name|strm
argument_list|,
name|zwd
operator|->
name|version
argument_list|,
name|zwd
operator|->
name|stream_size
argument_list|)
decl_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"ZLIB inflateInit errorCode=%d\n"
argument_list|,
name|initErr
argument_list|)
expr_stmt|;
if|if
condition|(
name|initErr
operator|!=
name|Z_OK
condition|)
return|return
name|ZWRAPD_finishWithError
argument_list|(
name|zwd
argument_list|,
name|strm
argument_list|,
name|initErr
argument_list|)
return|;
block|}
name|strm
operator|->
name|reserved
operator|=
name|ZWRAP_ZLIB_STREAM
expr_stmt|;
block|{
name|size_t
specifier|const
name|freeErr
init|=
name|ZWRAP_freeDCtx
argument_list|(
name|zwd
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|freeErr
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
block|{
name|int
specifier|const
name|result
init|=
operator|(
name|flush
operator|==
name|Z_INFLATE_SYNC
operator|)
condition|?
name|inflateSync
argument_list|(
name|strm
argument_list|)
else|:
name|inflate
argument_list|(
name|strm
argument_list|,
name|flush
argument_list|)
decl_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"- inflate3 flush=%d avail_in=%d avail_out=%d total_in=%d total_out=%d res=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|flush
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_out
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_out
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
block|}
block|}
else|else
block|{
comment|/* ! (zwd->totalInBytes == 0&& strm->avail_in>= ZLIB_HEADERSIZE) */
name|size_t
specifier|const
name|srcSize
init|=
name|MIN
argument_list|(
name|strm
operator|->
name|avail_in
argument_list|,
name|ZLIB_HEADERSIZE
operator|-
name|zwd
operator|->
name|totalInBytes
argument_list|)
decl_stmt|;
name|memcpy
argument_list|(
name|zwd
operator|->
name|headerBuf
operator|+
name|zwd
operator|->
name|totalInBytes
argument_list|,
name|strm
operator|->
name|next_in
argument_list|,
name|srcSize
argument_list|)
expr_stmt|;
name|strm
operator|->
name|total_in
operator|+=
name|srcSize
expr_stmt|;
name|zwd
operator|->
name|totalInBytes
operator|+=
name|srcSize
expr_stmt|;
name|strm
operator|->
name|next_in
operator|+=
name|srcSize
expr_stmt|;
name|strm
operator|->
name|avail_in
operator|-=
name|srcSize
expr_stmt|;
if|if
condition|(
name|zwd
operator|->
name|totalInBytes
operator|<
name|ZLIB_HEADERSIZE
condition|)
return|return
name|Z_OK
return|;
if|if
condition|(
name|MEM_readLE32
argument_list|(
name|zwd
operator|->
name|headerBuf
argument_list|)
operator|!=
name|ZSTD_MAGICNUMBER
condition|)
block|{
name|z_stream
name|strm2
decl_stmt|;
name|strm2
operator|.
name|next_in
operator|=
name|strm
operator|->
name|next_in
expr_stmt|;
name|strm2
operator|.
name|avail_in
operator|=
name|strm
operator|->
name|avail_in
expr_stmt|;
name|strm2
operator|.
name|next_out
operator|=
name|strm
operator|->
name|next_out
expr_stmt|;
name|strm2
operator|.
name|avail_out
operator|=
name|strm
operator|->
name|avail_out
expr_stmt|;
block|{
name|int
specifier|const
name|initErr
init|=
operator|(
name|zwd
operator|->
name|windowBits
operator|)
condition|?
name|inflateInit2_
argument_list|(
name|strm
argument_list|,
name|zwd
operator|->
name|windowBits
argument_list|,
name|zwd
operator|->
name|version
argument_list|,
name|zwd
operator|->
name|stream_size
argument_list|)
else|:
name|inflateInit_
argument_list|(
name|strm
argument_list|,
name|zwd
operator|->
name|version
argument_list|,
name|zwd
operator|->
name|stream_size
argument_list|)
decl_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"ZLIB inflateInit errorCode=%d\n"
argument_list|,
name|initErr
argument_list|)
expr_stmt|;
if|if
condition|(
name|initErr
operator|!=
name|Z_OK
condition|)
return|return
name|ZWRAPD_finishWithError
argument_list|(
name|zwd
argument_list|,
name|strm
argument_list|,
name|initErr
argument_list|)
return|;
block|}
comment|/* inflate header */
name|strm
operator|->
name|next_in
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|zwd
operator|->
name|headerBuf
expr_stmt|;
name|strm
operator|->
name|avail_in
operator|=
name|ZLIB_HEADERSIZE
expr_stmt|;
name|strm
operator|->
name|avail_out
operator|=
literal|0
expr_stmt|;
block|{
name|int
specifier|const
name|dErr
init|=
name|inflate
argument_list|(
name|strm
argument_list|,
name|Z_NO_FLUSH
argument_list|)
decl_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"ZLIB inflate errorCode=%d strm->avail_in=%d\n"
argument_list|,
name|dErr
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|dErr
operator|!=
name|Z_OK
condition|)
return|return
name|ZWRAPD_finishWithError
argument_list|(
name|zwd
argument_list|,
name|strm
argument_list|,
name|dErr
argument_list|)
return|;
block|}
if|if
condition|(
name|strm
operator|->
name|avail_in
operator|>
literal|0
condition|)
goto|goto
name|error
goto|;
name|strm
operator|->
name|next_in
operator|=
name|strm2
operator|.
name|next_in
expr_stmt|;
name|strm
operator|->
name|avail_in
operator|=
name|strm2
operator|.
name|avail_in
expr_stmt|;
name|strm
operator|->
name|next_out
operator|=
name|strm2
operator|.
name|next_out
expr_stmt|;
name|strm
operator|->
name|avail_out
operator|=
name|strm2
operator|.
name|avail_out
expr_stmt|;
name|strm
operator|->
name|reserved
operator|=
name|ZWRAP_ZLIB_STREAM
expr_stmt|;
comment|/* mark as zlib stream */
block|{
name|size_t
specifier|const
name|freeErr
init|=
name|ZWRAP_freeDCtx
argument_list|(
name|zwd
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|freeErr
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
block|{
name|int
specifier|const
name|result
init|=
operator|(
name|flush
operator|==
name|Z_INFLATE_SYNC
operator|)
condition|?
name|inflateSync
argument_list|(
name|strm
argument_list|)
else|:
name|inflate
argument_list|(
name|strm
argument_list|,
name|flush
argument_list|)
decl_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"- inflate2 flush=%d avail_in=%d avail_out=%d total_in=%d total_out=%d res=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|flush
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_out
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_out
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
block|}
block|}
comment|/* if ! (zwd->totalInBytes == 0&& strm->avail_in>= ZLIB_HEADERSIZE) */
block|}
comment|/* (zwd->totalInBytes< ZLIB_HEADERSIZE) */
name|strm
operator|->
name|reserved
operator|=
name|ZWRAP_ZSTD_STREAM
expr_stmt|;
comment|/* mark as zstd steam */
if|if
condition|(
name|flush
operator|==
name|Z_INFLATE_SYNC
condition|)
block|{
name|strm
operator|->
name|msg
operator|=
literal|"inflateSync is not supported!"
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|!
name|zwd
operator|->
name|zbd
condition|)
block|{
name|zwd
operator|->
name|zbd
operator|=
name|ZSTD_createDStream_advanced
argument_list|(
name|zwd
operator|->
name|customMem
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwd
operator|->
name|zbd
operator|==
name|NULL
condition|)
block|{
name|LOG_WRAPPERD
argument_list|(
literal|"ERROR: ZSTD_createDStream_advanced\n"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|zwd
operator|->
name|decompState
operator|=
name|ZWRAP_useInit
expr_stmt|;
block|}
if|if
condition|(
name|zwd
operator|->
name|totalInBytes
operator|<
name|ZSTD_HEADERSIZE
condition|)
block|{
if|if
condition|(
name|zwd
operator|->
name|totalInBytes
operator|==
literal|0
operator|&&
name|strm
operator|->
name|avail_in
operator|>=
name|ZSTD_HEADERSIZE
condition|)
block|{
if|if
condition|(
name|zwd
operator|->
name|decompState
operator|==
name|ZWRAP_useInit
condition|)
block|{
name|size_t
specifier|const
name|initErr
init|=
name|ZSTD_initDStream
argument_list|(
name|zwd
operator|->
name|zbd
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|initErr
argument_list|)
condition|)
block|{
name|LOG_WRAPPERD
argument_list|(
literal|"ERROR: ZSTD_initDStream errorCode=%s\n"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|initErr
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
else|else
block|{
name|size_t
specifier|const
name|resetErr
init|=
name|ZSTD_resetDStream
argument_list|(
name|zwd
operator|->
name|zbd
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|resetErr
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
block|}
else|else
block|{
name|size_t
specifier|const
name|srcSize
init|=
name|MIN
argument_list|(
name|strm
operator|->
name|avail_in
argument_list|,
name|ZSTD_HEADERSIZE
operator|-
name|zwd
operator|->
name|totalInBytes
argument_list|)
decl_stmt|;
name|memcpy
argument_list|(
name|zwd
operator|->
name|headerBuf
operator|+
name|zwd
operator|->
name|totalInBytes
argument_list|,
name|strm
operator|->
name|next_in
argument_list|,
name|srcSize
argument_list|)
expr_stmt|;
name|strm
operator|->
name|total_in
operator|+=
name|srcSize
expr_stmt|;
name|zwd
operator|->
name|totalInBytes
operator|+=
name|srcSize
expr_stmt|;
name|strm
operator|->
name|next_in
operator|+=
name|srcSize
expr_stmt|;
name|strm
operator|->
name|avail_in
operator|-=
name|srcSize
expr_stmt|;
if|if
condition|(
name|zwd
operator|->
name|totalInBytes
operator|<
name|ZSTD_HEADERSIZE
condition|)
return|return
name|Z_OK
return|;
if|if
condition|(
name|zwd
operator|->
name|decompState
operator|==
name|ZWRAP_useInit
condition|)
block|{
name|size_t
specifier|const
name|initErr
init|=
name|ZSTD_initDStream
argument_list|(
name|zwd
operator|->
name|zbd
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|initErr
argument_list|)
condition|)
block|{
name|LOG_WRAPPERD
argument_list|(
literal|"ERROR: ZSTD_initDStream errorCode=%s\n"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|initErr
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
else|else
block|{
name|size_t
specifier|const
name|resetErr
init|=
name|ZSTD_resetDStream
argument_list|(
name|zwd
operator|->
name|zbd
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|resetErr
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
name|zwd
operator|->
name|inBuffer
operator|.
name|src
operator|=
name|zwd
operator|->
name|headerBuf
expr_stmt|;
name|zwd
operator|->
name|inBuffer
operator|.
name|size
operator|=
name|ZSTD_HEADERSIZE
expr_stmt|;
name|zwd
operator|->
name|inBuffer
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
name|zwd
operator|->
name|outBuffer
operator|.
name|dst
operator|=
name|strm
operator|->
name|next_out
expr_stmt|;
name|zwd
operator|->
name|outBuffer
operator|.
name|size
operator|=
literal|0
expr_stmt|;
name|zwd
operator|->
name|outBuffer
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
block|{
name|size_t
specifier|const
name|dErr
init|=
name|ZSTD_decompressStream
argument_list|(
name|zwd
operator|->
name|zbd
argument_list|,
operator|&
name|zwd
operator|->
name|outBuffer
argument_list|,
operator|&
name|zwd
operator|->
name|inBuffer
argument_list|)
decl_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"inflate ZSTD_decompressStream1 errorCode=%d srcSize=%d dstCapacity=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|dErr
argument_list|,
operator|(
name|int
operator|)
name|zwd
operator|->
name|inBuffer
operator|.
name|size
argument_list|,
operator|(
name|int
operator|)
name|zwd
operator|->
name|outBuffer
operator|.
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|dErr
argument_list|)
condition|)
block|{
name|LOG_WRAPPERD
argument_list|(
literal|"ERROR: ZSTD_decompressStream1 %s\n"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|dErr
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
if|if
condition|(
name|zwd
operator|->
name|inBuffer
operator|.
name|pos
operator|!=
name|zwd
operator|->
name|inBuffer
operator|.
name|size
condition|)
goto|goto
name|error
goto|;
comment|/* not consumed */
block|}
block|}
comment|/* (zwd->totalInBytes< ZSTD_HEADERSIZE) */
name|zwd
operator|->
name|inBuffer
operator|.
name|src
operator|=
name|strm
operator|->
name|next_in
expr_stmt|;
name|zwd
operator|->
name|inBuffer
operator|.
name|size
operator|=
name|strm
operator|->
name|avail_in
expr_stmt|;
name|zwd
operator|->
name|inBuffer
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
name|zwd
operator|->
name|outBuffer
operator|.
name|dst
operator|=
name|strm
operator|->
name|next_out
expr_stmt|;
name|zwd
operator|->
name|outBuffer
operator|.
name|size
operator|=
name|strm
operator|->
name|avail_out
expr_stmt|;
name|zwd
operator|->
name|outBuffer
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
block|{
name|size_t
specifier|const
name|dErr
init|=
name|ZSTD_decompressStream
argument_list|(
name|zwd
operator|->
name|zbd
argument_list|,
operator|&
name|zwd
operator|->
name|outBuffer
argument_list|,
operator|&
name|zwd
operator|->
name|inBuffer
argument_list|)
decl_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"inflate ZSTD_decompressStream2 errorCode=%d srcSize=%d dstCapacity=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|dErr
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_out
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|dErr
argument_list|)
condition|)
block|{
name|zwd
operator|->
name|errorCount
operator|++
expr_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"ERROR: ZSTD_decompressStream2 %s zwd->errorCount=%d\n"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|dErr
argument_list|)
argument_list|,
name|zwd
operator|->
name|errorCount
argument_list|)
expr_stmt|;
if|if
condition|(
name|zwd
operator|->
name|errorCount
operator|<=
literal|1
condition|)
return|return
name|Z_NEED_DICT
return|;
else|else
goto|goto
name|error
goto|;
block|}
name|LOG_WRAPPERD
argument_list|(
literal|"inflate inBuffer.pos=%d inBuffer.size=%d outBuffer.pos=%d outBuffer.size=%d o\n"
argument_list|,
operator|(
name|int
operator|)
name|zwd
operator|->
name|inBuffer
operator|.
name|pos
argument_list|,
operator|(
name|int
operator|)
name|zwd
operator|->
name|inBuffer
operator|.
name|size
argument_list|,
operator|(
name|int
operator|)
name|zwd
operator|->
name|outBuffer
operator|.
name|pos
argument_list|,
operator|(
name|int
operator|)
name|zwd
operator|->
name|outBuffer
operator|.
name|size
argument_list|)
expr_stmt|;
name|strm
operator|->
name|next_out
operator|+=
name|zwd
operator|->
name|outBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|total_out
operator|+=
name|zwd
operator|->
name|outBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|avail_out
operator|-=
name|zwd
operator|->
name|outBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|total_in
operator|+=
name|zwd
operator|->
name|inBuffer
operator|.
name|pos
expr_stmt|;
name|zwd
operator|->
name|totalInBytes
operator|+=
name|zwd
operator|->
name|inBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|next_in
operator|+=
name|zwd
operator|->
name|inBuffer
operator|.
name|pos
expr_stmt|;
name|strm
operator|->
name|avail_in
operator|-=
name|zwd
operator|->
name|inBuffer
operator|.
name|pos
expr_stmt|;
if|if
condition|(
name|dErr
operator|==
literal|0
condition|)
block|{
name|LOG_WRAPPERD
argument_list|(
literal|"inflate Z_STREAM_END1 avail_in=%d avail_out=%d total_in=%d total_out=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_out
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_out
argument_list|)
expr_stmt|;
name|zwd
operator|->
name|decompState
operator|=
name|ZWRAP_streamEnd
expr_stmt|;
return|return
name|Z_STREAM_END
return|;
block|}
block|}
comment|/* dErr lifetime */
name|LOG_WRAPPERD
argument_list|(
literal|"- inflate2 flush=%d avail_in=%d avail_out=%d total_in=%d total_out=%d res=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|flush
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|avail_out
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_in
argument_list|,
operator|(
name|int
operator|)
name|strm
operator|->
name|total_out
argument_list|,
name|Z_OK
argument_list|)
expr_stmt|;
return|return
name|Z_OK
return|;
name|error
label|:
return|return
name|ZWRAPD_finishWithError
argument_list|(
name|zwd
argument_list|,
name|strm
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflateEnd
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|)
argument_list|)
block|{
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
return|return
name|inflateEnd
argument_list|(
name|strm
argument_list|)
return|;
name|LOG_WRAPPERD
argument_list|(
literal|"- inflateEnd total_in=%d total_out=%d\n"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|strm
operator|->
name|total_in
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
name|strm
operator|->
name|total_out
argument_list|)
argument_list|)
expr_stmt|;
block|{
name|ZWRAP_DCtx
modifier|*
specifier|const
name|zwd
init|=
operator|(
name|ZWRAP_DCtx
operator|*
operator|)
name|strm
operator|->
name|state
decl_stmt|;
if|if
condition|(
name|zwd
operator|==
name|NULL
condition|)
return|return
name|Z_OK
return|;
comment|/* structures are already freed */
block|{
name|size_t
specifier|const
name|freeErr
init|=
name|ZWRAP_freeDCtx
argument_list|(
name|zwd
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|freeErr
argument_list|)
condition|)
return|return
name|Z_STREAM_ERROR
return|;
block|}
name|strm
operator|->
name|state
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|Z_OK
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflateSync
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|)
argument_list|)
block|{
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
block|{
return|return
name|inflateSync
argument_list|(
name|strm
argument_list|)
return|;
block|}
return|return
name|z_inflate
argument_list|(
name|strm
argument_list|,
name|Z_INFLATE_SYNC
argument_list|)
return|;
block|}
end_decl_stmt

begin_comment
comment|/* Advanced compression functions */
end_comment

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_deflateCopy
name|OF
argument_list|(
operator|(
name|z_streamp
name|dest
operator|,
name|z_streamp
name|source
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
return|return
name|deflateCopy
argument_list|(
name|dest
argument_list|,
name|source
argument_list|)
return|;
return|return
name|ZWRAPC_finishWithErrorMsg
argument_list|(
name|source
argument_list|,
literal|"deflateCopy is not supported!"
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_deflateTune
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|int
name|good_length
operator|,
name|int
name|max_lazy
operator|,
name|int
name|nice_length
operator|,
name|int
name|max_chain
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
return|return
name|deflateTune
argument_list|(
name|strm
argument_list|,
name|good_length
argument_list|,
name|max_lazy
argument_list|,
name|nice_length
argument_list|,
name|max_chain
argument_list|)
return|;
return|return
name|ZWRAPC_finishWithErrorMsg
argument_list|(
name|strm
argument_list|,
literal|"deflateTune is not supported!"
argument_list|)
return|;
block|}
end_decl_stmt

begin_if
if|#
directive|if
name|ZLIB_VERNUM
operator|>=
literal|0x1260
end_if

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_deflatePending
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|unsigned
operator|*
name|pending
operator|,
name|int
operator|*
name|bits
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
return|return
name|deflatePending
argument_list|(
name|strm
argument_list|,
name|pending
argument_list|,
name|bits
argument_list|)
return|;
return|return
name|ZWRAPC_finishWithErrorMsg
argument_list|(
name|strm
argument_list|,
literal|"deflatePending is not supported!"
argument_list|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_deflatePrime
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|int
name|bits
operator|,
name|int
name|value
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
return|return
name|deflatePrime
argument_list|(
name|strm
argument_list|,
name|bits
argument_list|,
name|value
argument_list|)
return|;
return|return
name|ZWRAPC_finishWithErrorMsg
argument_list|(
name|strm
argument_list|,
literal|"deflatePrime is not supported!"
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_deflateSetHeader
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|gz_headerp
name|head
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
return|return
name|deflateSetHeader
argument_list|(
name|strm
argument_list|,
name|head
argument_list|)
return|;
return|return
name|ZWRAPC_finishWithErrorMsg
argument_list|(
name|strm
argument_list|,
literal|"deflateSetHeader is not supported!"
argument_list|)
return|;
block|}
end_decl_stmt

begin_comment
comment|/* Advanced decompression functions */
end_comment

begin_if
if|#
directive|if
name|ZLIB_VERNUM
operator|>=
literal|0x1280
end_if

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflateGetDictionary
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|Bytef
operator|*
name|dictionary
operator|,
name|uInt
operator|*
name|dictLength
operator|)
argument_list|)
block|{
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
return|return
name|inflateGetDictionary
argument_list|(
name|strm
argument_list|,
name|dictionary
argument_list|,
name|dictLength
argument_list|)
return|;
return|return
name|ZWRAPD_finishWithErrorMsg
argument_list|(
name|strm
argument_list|,
literal|"inflateGetDictionary is not supported!"
argument_list|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflateCopy
name|OF
argument_list|(
operator|(
name|z_streamp
name|dest
operator|,
name|z_streamp
name|source
operator|)
argument_list|)
block|{
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|source
operator|->
name|reserved
condition|)
return|return
name|inflateCopy
argument_list|(
name|dest
argument_list|,
name|source
argument_list|)
return|;
return|return
name|ZWRAPD_finishWithErrorMsg
argument_list|(
name|source
argument_list|,
literal|"inflateCopy is not supported!"
argument_list|)
return|;
block|}
end_decl_stmt

begin_if
if|#
directive|if
name|ZLIB_VERNUM
operator|>=
literal|0x1240
end_if

begin_decl_stmt
name|ZEXTERN
name|long
name|ZEXPORT
name|z_inflateMark
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|)
argument_list|)
block|{
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
return|return
name|inflateMark
argument_list|(
name|strm
argument_list|)
return|;
return|return
name|ZWRAPD_finishWithErrorMsg
argument_list|(
name|strm
argument_list|,
literal|"inflateMark is not supported!"
argument_list|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflatePrime
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|int
name|bits
operator|,
name|int
name|value
operator|)
argument_list|)
block|{
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
return|return
name|inflatePrime
argument_list|(
name|strm
argument_list|,
name|bits
argument_list|,
name|value
argument_list|)
return|;
return|return
name|ZWRAPD_finishWithErrorMsg
argument_list|(
name|strm
argument_list|,
literal|"inflatePrime is not supported!"
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflateGetHeader
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|gz_headerp
name|head
operator|)
argument_list|)
block|{
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
return|return
name|inflateGetHeader
argument_list|(
name|strm
argument_list|,
name|head
argument_list|)
return|;
return|return
name|ZWRAPD_finishWithErrorMsg
argument_list|(
name|strm
argument_list|,
literal|"inflateGetHeader is not supported!"
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflateBackInit_
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|int
name|windowBits
operator|,
name|unsigned
name|char
name|FAR
operator|*
name|window
operator|,
specifier|const
name|char
operator|*
name|version
operator|,
name|int
name|stream_size
operator|)
argument_list|)
block|{
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
return|return
name|inflateBackInit_
argument_list|(
name|strm
argument_list|,
name|windowBits
argument_list|,
name|window
argument_list|,
name|version
argument_list|,
name|stream_size
argument_list|)
return|;
return|return
name|ZWRAPD_finishWithErrorMsg
argument_list|(
name|strm
argument_list|,
literal|"inflateBackInit is not supported!"
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflateBack
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|,
name|in_func
name|in
operator|,
name|void
name|FAR
operator|*
name|in_desc
operator|,
name|out_func
name|out
operator|,
name|void
name|FAR
operator|*
name|out_desc
operator|)
argument_list|)
block|{
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
return|return
name|inflateBack
argument_list|(
name|strm
argument_list|,
name|in
argument_list|,
name|in_desc
argument_list|,
name|out
argument_list|,
name|out_desc
argument_list|)
return|;
return|return
name|ZWRAPD_finishWithErrorMsg
argument_list|(
name|strm
argument_list|,
literal|"inflateBack is not supported!"
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_inflateBackEnd
name|OF
argument_list|(
operator|(
name|z_streamp
name|strm
operator|)
argument_list|)
block|{
if|if
condition|(
name|g_ZWRAPdecompressionType
operator|==
name|ZWRAP_FORCE_ZLIB
operator|||
operator|!
name|strm
operator|->
name|reserved
condition|)
return|return
name|inflateBackEnd
argument_list|(
name|strm
argument_list|)
return|;
return|return
name|ZWRAPD_finishWithErrorMsg
argument_list|(
name|strm
argument_list|,
literal|"inflateBackEnd is not supported!"
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|uLong
name|ZEXPORT
name|z_zlibCompileFlags
name|OF
argument_list|(
operator|(
name|void
operator|)
argument_list|)
block|{
return|return
name|zlibCompileFlags
argument_list|()
return|;
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
comment|/* ===   utility functions  === */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|Z_SOLO
end_ifndef

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_compress
name|OF
argument_list|(
operator|(
name|Bytef
operator|*
name|dest
operator|,
name|uLongf
operator|*
name|destLen
operator|,
specifier|const
name|Bytef
operator|*
name|source
operator|,
name|uLong
name|sourceLen
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
return|return
name|compress
argument_list|(
name|dest
argument_list|,
name|destLen
argument_list|,
name|source
argument_list|,
name|sourceLen
argument_list|)
return|;
block|{
name|size_t
name|dstCapacity
init|=
operator|*
name|destLen
decl_stmt|;
name|size_t
specifier|const
name|cSize
init|=
name|ZSTD_compress
argument_list|(
name|dest
argument_list|,
name|dstCapacity
argument_list|,
name|source
argument_list|,
name|sourceLen
argument_list|,
name|ZWRAP_DEFAULT_CLEVEL
argument_list|)
decl_stmt|;
name|LOG_WRAPPERD
argument_list|(
literal|"z_compress sourceLen=%d dstCapacity=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|sourceLen
argument_list|,
operator|(
name|int
operator|)
name|dstCapacity
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
condition|)
return|return
name|Z_STREAM_ERROR
return|;
operator|*
name|destLen
operator|=
name|cSize
expr_stmt|;
block|}
return|return
name|Z_OK
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_compress2
name|OF
argument_list|(
operator|(
name|Bytef
operator|*
name|dest
operator|,
name|uLongf
operator|*
name|destLen
operator|,
specifier|const
name|Bytef
operator|*
name|source
operator|,
name|uLong
name|sourceLen
operator|,
name|int
name|level
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
return|return
name|compress2
argument_list|(
name|dest
argument_list|,
name|destLen
argument_list|,
name|source
argument_list|,
name|sourceLen
argument_list|,
name|level
argument_list|)
return|;
block|{
name|size_t
name|dstCapacity
init|=
operator|*
name|destLen
decl_stmt|;
name|size_t
specifier|const
name|cSize
init|=
name|ZSTD_compress
argument_list|(
name|dest
argument_list|,
name|dstCapacity
argument_list|,
name|source
argument_list|,
name|sourceLen
argument_list|,
name|level
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
condition|)
return|return
name|Z_STREAM_ERROR
return|;
operator|*
name|destLen
operator|=
name|cSize
expr_stmt|;
block|}
return|return
name|Z_OK
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|uLong
name|ZEXPORT
name|z_compressBound
name|OF
argument_list|(
operator|(
name|uLong
name|sourceLen
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|g_ZWRAP_useZSTDcompression
condition|)
return|return
name|compressBound
argument_list|(
name|sourceLen
argument_list|)
return|;
return|return
name|ZSTD_compressBound
argument_list|(
name|sourceLen
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|int
name|ZEXPORT
name|z_uncompress
name|OF
argument_list|(
operator|(
name|Bytef
operator|*
name|dest
operator|,
name|uLongf
operator|*
name|destLen
operator|,
specifier|const
name|Bytef
operator|*
name|source
operator|,
name|uLong
name|sourceLen
operator|)
argument_list|)
block|{
if|if
condition|(
operator|!
name|ZSTD_isFrame
argument_list|(
name|source
argument_list|,
name|sourceLen
argument_list|)
condition|)
return|return
name|uncompress
argument_list|(
name|dest
argument_list|,
name|destLen
argument_list|,
name|source
argument_list|,
name|sourceLen
argument_list|)
return|;
block|{
name|size_t
name|dstCapacity
init|=
operator|*
name|destLen
decl_stmt|;
name|size_t
specifier|const
name|dSize
init|=
name|ZSTD_decompress
argument_list|(
name|dest
argument_list|,
name|dstCapacity
argument_list|,
name|source
argument_list|,
name|sourceLen
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|dSize
argument_list|)
condition|)
return|return
name|Z_STREAM_ERROR
return|;
operator|*
name|destLen
operator|=
name|dSize
expr_stmt|;
block|}
return|return
name|Z_OK
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !Z_SOLO */
end_comment

begin_comment
comment|/* checksum functions */
end_comment

begin_decl_stmt
name|ZEXTERN
name|uLong
name|ZEXPORT
name|z_adler32
name|OF
argument_list|(
operator|(
name|uLong
name|adler
operator|,
specifier|const
name|Bytef
operator|*
name|buf
operator|,
name|uInt
name|len
operator|)
argument_list|)
block|{
return|return
name|adler32
argument_list|(
name|adler
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|uLong
name|ZEXPORT
name|z_crc32
name|OF
argument_list|(
operator|(
name|uLong
name|crc
operator|,
specifier|const
name|Bytef
operator|*
name|buf
operator|,
name|uInt
name|len
operator|)
argument_list|)
block|{
return|return
name|crc32
argument_list|(
name|crc
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_decl_stmt

begin_if
if|#
directive|if
name|ZLIB_VERNUM
operator|>=
literal|0x12B0
end_if

begin_decl_stmt
name|ZEXTERN
name|uLong
name|ZEXPORT
name|z_adler32_z
name|OF
argument_list|(
operator|(
name|uLong
name|adler
operator|,
specifier|const
name|Bytef
operator|*
name|buf
operator|,
name|z_size_t
name|len
operator|)
argument_list|)
block|{
return|return
name|adler32_z
argument_list|(
name|adler
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|ZEXTERN
name|uLong
name|ZEXPORT
name|z_crc32_z
name|OF
argument_list|(
operator|(
name|uLong
name|crc
operator|,
specifier|const
name|Bytef
operator|*
name|buf
operator|,
name|z_size_t
name|len
operator|)
argument_list|)
block|{
return|return
name|crc32_z
argument_list|(
name|crc
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|ZLIB_VERNUM
operator|>=
literal|0x1270
end_if

begin_decl_stmt
name|ZEXTERN
specifier|const
name|z_crc_t
name|FAR
modifier|*
name|ZEXPORT
name|z_get_crc_table
name|OF
argument_list|(
operator|(
name|void
operator|)
argument_list|)
block|{
return|return
name|get_crc_table
argument_list|()
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


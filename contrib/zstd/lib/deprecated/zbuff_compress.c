begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2016-present, Yann Collet, Facebook, Inc.  * All rights reserved.  *  * This source code is licensed under both the BSD-style license (found in the  * LICENSE file in the root directory of this source tree) and the GPLv2 (found  * in the COPYING file in the root directory of this source tree).  */
end_comment

begin_comment
comment|/* ************************************* *  Dependencies ***************************************/
end_comment

begin_define
define|#
directive|define
name|ZBUFF_STATIC_LINKING_ONLY
end_define

begin_include
include|#
directive|include
file|"zbuff.h"
end_include

begin_comment
comment|/*-*********************************************************** *  Streaming compression * *  A ZBUFF_CCtx object is required to track streaming operation. *  Use ZBUFF_createCCtx() and ZBUFF_freeCCtx() to create/release resources. *  Use ZBUFF_compressInit() to start a new compression operation. *  ZBUFF_CCtx objects can be reused multiple times. * *  Use ZBUFF_compressContinue() repetitively to consume your input. *  *srcSizePtr and *dstCapacityPtr can be any size. *  The function will report how many bytes were read or written by modifying *srcSizePtr and *dstCapacityPtr. *  Note that it may not consume the entire input, in which case it's up to the caller to call again the function with remaining input. *  The content of dst will be overwritten (up to *dstCapacityPtr) at each function call, so save its content if it matters or change dst . *  @return : a hint to preferred nb of bytes to use as input for next function call (it's only a hint, to improve latency) *            or an error code, which can be tested using ZBUFF_isError(). * *  ZBUFF_compressFlush() can be used to instruct ZBUFF to compress and output whatever remains within its buffer. *  Note that it will not output more than *dstCapacityPtr. *  Therefore, some content might still be left into its internal buffer if dst buffer is too small. *  @return : nb of bytes still present into internal buffer (0 if it's empty) *            or an error code, which can be tested using ZBUFF_isError(). * *  ZBUFF_compressEnd() instructs to finish a frame. *  It will perform a flush and write frame epilogue. *  Similar to ZBUFF_compressFlush(), it may not be able to output the entire internal buffer content if *dstCapacityPtr is too small. *  @return : nb of bytes still present into internal buffer (0 if it's empty) *            or an error code, which can be tested using ZBUFF_isError(). * *  Hint : recommended buffer sizes (not compulsory) *  input : ZSTD_BLOCKSIZE_MAX (128 KB), internal unit size, it improves latency to use this value. *  output : ZSTD_compressBound(ZSTD_BLOCKSIZE_MAX) + ZSTD_blockHeaderSize + ZBUFF_endFrameSize : ensures it's always possible to write/flush/end a full block at best speed. * ***********************************************************/
end_comment

begin_function
name|ZBUFF_CCtx
modifier|*
name|ZBUFF_createCCtx
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|ZSTD_createCStream
argument_list|()
return|;
block|}
end_function

begin_function
name|ZBUFF_CCtx
modifier|*
name|ZBUFF_createCCtx_advanced
parameter_list|(
name|ZSTD_customMem
name|customMem
parameter_list|)
block|{
return|return
name|ZSTD_createCStream_advanced
argument_list|(
name|customMem
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZBUFF_freeCCtx
parameter_list|(
name|ZBUFF_CCtx
modifier|*
name|zbc
parameter_list|)
block|{
return|return
name|ZSTD_freeCStream
argument_list|(
name|zbc
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ======   Initialization   ====== */
end_comment

begin_function
name|size_t
name|ZBUFF_compressInit_advanced
parameter_list|(
name|ZBUFF_CCtx
modifier|*
name|zbc
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_parameters
name|params
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|)
block|{
return|return
name|ZSTD_initCStream_advanced
argument_list|(
name|zbc
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|params
argument_list|,
name|pledgedSrcSize
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZBUFF_compressInitDictionary
parameter_list|(
name|ZBUFF_CCtx
modifier|*
name|zbc
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|int
name|compressionLevel
parameter_list|)
block|{
return|return
name|ZSTD_initCStream_usingDict
argument_list|(
name|zbc
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|compressionLevel
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZBUFF_compressInit
parameter_list|(
name|ZBUFF_CCtx
modifier|*
name|zbc
parameter_list|,
name|int
name|compressionLevel
parameter_list|)
block|{
return|return
name|ZSTD_initCStream
argument_list|(
name|zbc
argument_list|,
name|compressionLevel
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ======   Compression   ====== */
end_comment

begin_function
name|size_t
name|ZBUFF_compressContinue
parameter_list|(
name|ZBUFF_CCtx
modifier|*
name|zbc
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
modifier|*
name|dstCapacityPtr
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
modifier|*
name|srcSizePtr
parameter_list|)
block|{
name|size_t
name|result
decl_stmt|;
name|ZSTD_outBuffer
name|outBuff
decl_stmt|;
name|ZSTD_inBuffer
name|inBuff
decl_stmt|;
name|outBuff
operator|.
name|dst
operator|=
name|dst
expr_stmt|;
name|outBuff
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
name|outBuff
operator|.
name|size
operator|=
operator|*
name|dstCapacityPtr
expr_stmt|;
name|inBuff
operator|.
name|src
operator|=
name|src
expr_stmt|;
name|inBuff
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
name|inBuff
operator|.
name|size
operator|=
operator|*
name|srcSizePtr
expr_stmt|;
name|result
operator|=
name|ZSTD_compressStream
argument_list|(
name|zbc
argument_list|,
operator|&
name|outBuff
argument_list|,
operator|&
name|inBuff
argument_list|)
expr_stmt|;
operator|*
name|dstCapacityPtr
operator|=
name|outBuff
operator|.
name|pos
expr_stmt|;
operator|*
name|srcSizePtr
operator|=
name|inBuff
operator|.
name|pos
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/* ======   Finalize   ====== */
end_comment

begin_function
name|size_t
name|ZBUFF_compressFlush
parameter_list|(
name|ZBUFF_CCtx
modifier|*
name|zbc
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
modifier|*
name|dstCapacityPtr
parameter_list|)
block|{
name|size_t
name|result
decl_stmt|;
name|ZSTD_outBuffer
name|outBuff
decl_stmt|;
name|outBuff
operator|.
name|dst
operator|=
name|dst
expr_stmt|;
name|outBuff
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
name|outBuff
operator|.
name|size
operator|=
operator|*
name|dstCapacityPtr
expr_stmt|;
name|result
operator|=
name|ZSTD_flushStream
argument_list|(
name|zbc
argument_list|,
operator|&
name|outBuff
argument_list|)
expr_stmt|;
operator|*
name|dstCapacityPtr
operator|=
name|outBuff
operator|.
name|pos
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
name|size_t
name|ZBUFF_compressEnd
parameter_list|(
name|ZBUFF_CCtx
modifier|*
name|zbc
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
modifier|*
name|dstCapacityPtr
parameter_list|)
block|{
name|size_t
name|result
decl_stmt|;
name|ZSTD_outBuffer
name|outBuff
decl_stmt|;
name|outBuff
operator|.
name|dst
operator|=
name|dst
expr_stmt|;
name|outBuff
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
name|outBuff
operator|.
name|size
operator|=
operator|*
name|dstCapacityPtr
expr_stmt|;
name|result
operator|=
name|ZSTD_endStream
argument_list|(
name|zbc
argument_list|,
operator|&
name|outBuff
argument_list|)
expr_stmt|;
operator|*
name|dstCapacityPtr
operator|=
name|outBuff
operator|.
name|pos
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/* ************************************* *  Tool functions ***************************************/
end_comment

begin_function
name|size_t
name|ZBUFF_recommendedCInSize
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|ZSTD_CStreamInSize
argument_list|()
return|;
block|}
end_function

begin_function
name|size_t
name|ZBUFF_recommendedCOutSize
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|ZSTD_CStreamOutSize
argument_list|()
return|;
block|}
end_function

end_unit


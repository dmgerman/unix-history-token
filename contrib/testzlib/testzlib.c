begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_include
include|#
directive|include
file|"zlib.h"
end_include

begin_function
name|void
name|MyDoMinus64
parameter_list|(
name|LARGE_INTEGER
modifier|*
name|R
parameter_list|,
name|LARGE_INTEGER
name|A
parameter_list|,
name|LARGE_INTEGER
name|B
parameter_list|)
block|{
name|R
operator|->
name|HighPart
operator|=
name|A
operator|.
name|HighPart
operator|-
name|B
operator|.
name|HighPart
expr_stmt|;
if|if
condition|(
name|A
operator|.
name|LowPart
operator|>=
name|B
operator|.
name|LowPart
condition|)
name|R
operator|->
name|LowPart
operator|=
name|A
operator|.
name|LowPart
operator|-
name|B
operator|.
name|LowPart
expr_stmt|;
else|else
block|{
name|R
operator|->
name|LowPart
operator|=
name|A
operator|.
name|LowPart
operator|-
name|B
operator|.
name|LowPart
expr_stmt|;
name|R
operator|->
name|HighPart
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|_M_X64
end_ifdef

begin_comment
comment|// see http://msdn2.microsoft.com/library/twchhe95(en-us,vs.80).aspx for __rdtsc
end_comment

begin_function_decl
name|unsigned
name|__int64
name|__rdtsc
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|BeginCountRdtsc
parameter_list|(
name|LARGE_INTEGER
modifier|*
name|pbeginTime64
parameter_list|)
block|{
comment|//   printf("rdtsc = %I64x\n",__rdtsc());
name|pbeginTime64
operator|->
name|QuadPart
operator|=
name|__rdtsc
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|LARGE_INTEGER
name|GetResRdtsc
parameter_list|(
name|LARGE_INTEGER
name|beginTime64
parameter_list|,
name|BOOL
name|fComputeTimeQueryPerf
parameter_list|)
block|{
name|LARGE_INTEGER
name|LIres
decl_stmt|;
name|unsigned
name|_int64
name|res
init|=
name|__rdtsc
argument_list|()
operator|-
operator|(
call|(
name|unsigned
name|_int64
call|)
argument_list|(
name|beginTime64
operator|.
name|QuadPart
argument_list|)
operator|)
decl_stmt|;
name|LIres
operator|.
name|QuadPart
operator|=
name|res
expr_stmt|;
comment|// printf("rdtsc = %I64x\n",__rdtsc());
return|return
name|LIres
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_ifdef
ifdef|#
directive|ifdef
name|_M_IX86
end_ifdef

begin_function
name|void
name|myGetRDTSC32
parameter_list|(
name|LARGE_INTEGER
modifier|*
name|pbeginTime64
parameter_list|)
block|{
name|DWORD
name|dwEdx
decl_stmt|,
name|dwEax
decl_stmt|;
name|_asm
block|{
name|rdtsc
name|mov
name|dwEax
decl_stmt|,
name|eax
name|mov
name|dwEdx
decl_stmt|,
name|edx
block|}
name|pbeginTime64
operator|->
name|LowPart
operator|=
name|dwEax
expr_stmt|;
name|pbeginTime64
operator|->
name|HighPart
operator|=
name|dwEdx
expr_stmt|;
block|}
end_function

begin_function
name|void
name|BeginCountRdtsc
parameter_list|(
name|LARGE_INTEGER
modifier|*
name|pbeginTime64
parameter_list|)
block|{
name|myGetRDTSC32
argument_list|(
name|pbeginTime64
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LARGE_INTEGER
name|GetResRdtsc
parameter_list|(
name|LARGE_INTEGER
name|beginTime64
parameter_list|,
name|BOOL
name|fComputeTimeQueryPerf
parameter_list|)
block|{
name|LARGE_INTEGER
name|LIres
decl_stmt|,
name|endTime64
decl_stmt|;
name|myGetRDTSC32
argument_list|(
operator|&
name|endTime64
argument_list|)
expr_stmt|;
name|LIres
operator|.
name|LowPart
operator|=
name|LIres
operator|.
name|HighPart
operator|=
literal|0
expr_stmt|;
name|MyDoMinus64
argument_list|(
operator|&
name|LIres
argument_list|,
name|endTime64
argument_list|,
name|beginTime64
argument_list|)
expr_stmt|;
return|return
name|LIres
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_function
name|void
name|myGetRDTSC32
parameter_list|(
name|LARGE_INTEGER
modifier|*
name|pbeginTime64
parameter_list|)
block|{ }
end_function

begin_function
name|void
name|BeginCountRdtsc
parameter_list|(
name|LARGE_INTEGER
modifier|*
name|pbeginTime64
parameter_list|)
block|{ }
end_function

begin_function
name|LARGE_INTEGER
name|GetResRdtsc
parameter_list|(
name|LARGE_INTEGER
name|beginTime64
parameter_list|,
name|BOOL
name|fComputeTimeQueryPerf
parameter_list|)
block|{
name|LARGE_INTEGER
name|lr
decl_stmt|;
name|lr
operator|.
name|QuadPart
operator|=
literal|0
expr_stmt|;
return|return
name|lr
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|BeginCountPerfCounter
parameter_list|(
name|LARGE_INTEGER
modifier|*
name|pbeginTime64
parameter_list|,
name|BOOL
name|fComputeTimeQueryPerf
parameter_list|)
block|{
if|if
condition|(
operator|(
operator|!
name|fComputeTimeQueryPerf
operator|)
operator|||
operator|(
operator|!
name|QueryPerformanceCounter
argument_list|(
name|pbeginTime64
argument_list|)
operator|)
condition|)
block|{
name|pbeginTime64
operator|->
name|LowPart
operator|=
name|GetTickCount
argument_list|()
expr_stmt|;
name|pbeginTime64
operator|->
name|HighPart
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|DWORD
name|GetMsecSincePerfCounter
parameter_list|(
name|LARGE_INTEGER
name|beginTime64
parameter_list|,
name|BOOL
name|fComputeTimeQueryPerf
parameter_list|)
block|{
name|LARGE_INTEGER
name|endTime64
decl_stmt|,
name|ticksPerSecond
decl_stmt|,
name|ticks
decl_stmt|;
name|DWORDLONG
name|ticksShifted
decl_stmt|,
name|tickSecShifted
decl_stmt|;
name|DWORD
name|dwLog
init|=
literal|16
operator|+
literal|0
decl_stmt|;
name|DWORD
name|dwRet
decl_stmt|;
if|if
condition|(
operator|(
operator|!
name|fComputeTimeQueryPerf
operator|)
operator|||
operator|(
operator|!
name|QueryPerformanceCounter
argument_list|(
operator|&
name|endTime64
argument_list|)
operator|)
condition|)
name|dwRet
operator|=
operator|(
name|GetTickCount
argument_list|()
operator|-
name|beginTime64
operator|.
name|LowPart
operator|)
operator|*
literal|1
expr_stmt|;
else|else
block|{
name|MyDoMinus64
argument_list|(
operator|&
name|ticks
argument_list|,
name|endTime64
argument_list|,
name|beginTime64
argument_list|)
expr_stmt|;
name|QueryPerformanceFrequency
argument_list|(
operator|&
name|ticksPerSecond
argument_list|)
expr_stmt|;
block|{
name|ticksShifted
operator|=
name|Int64ShrlMod32
argument_list|(
operator|*
operator|(
name|DWORDLONG
operator|*
operator|)
operator|&
name|ticks
argument_list|,
name|dwLog
argument_list|)
expr_stmt|;
name|tickSecShifted
operator|=
name|Int64ShrlMod32
argument_list|(
operator|*
operator|(
name|DWORDLONG
operator|*
operator|)
operator|&
name|ticksPerSecond
argument_list|,
name|dwLog
argument_list|)
expr_stmt|;
block|}
name|dwRet
operator|=
call|(
name|DWORD
call|)
argument_list|(
operator|(
operator|(
operator|(
name|DWORD
operator|)
name|ticksShifted
operator|)
operator|*
literal|1000
operator|)
operator|/
call|(
name|DWORD
call|)
argument_list|(
name|tickSecShifted
argument_list|)
argument_list|)
expr_stmt|;
name|dwRet
operator|*=
literal|1
expr_stmt|;
block|}
return|return
name|dwRet
return|;
block|}
end_function

begin_function
name|int
name|ReadFileMemory
parameter_list|(
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|long
modifier|*
name|plFileSize
parameter_list|,
name|unsigned
name|char
modifier|*
modifier|*
name|pFilePtr
parameter_list|)
block|{
name|FILE
modifier|*
name|stream
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|retVal
init|=
literal|1
decl_stmt|;
name|stream
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|stream
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|fseek
argument_list|(
name|stream
argument_list|,
literal|0
argument_list|,
name|SEEK_END
argument_list|)
expr_stmt|;
operator|*
name|plFileSize
operator|=
name|ftell
argument_list|(
name|stream
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|stream
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|malloc
argument_list|(
operator|(
operator|*
name|plFileSize
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
name|retVal
operator|=
literal|0
expr_stmt|;
else|else
block|{
if|if
condition|(
name|fread
argument_list|(
name|ptr
argument_list|,
literal|1
argument_list|,
operator|*
name|plFileSize
argument_list|,
name|stream
argument_list|)
operator|!=
operator|(
operator|*
name|plFileSize
operator|)
condition|)
name|retVal
operator|=
literal|0
expr_stmt|;
block|}
name|fclose
argument_list|(
name|stream
argument_list|)
expr_stmt|;
operator|*
name|pFilePtr
operator|=
name|ptr
expr_stmt|;
return|return
name|retVal
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|BlockSizeCompress
init|=
literal|0x8000
decl_stmt|;
name|int
name|BlockSizeUncompress
init|=
literal|0x8000
decl_stmt|;
name|int
name|cprLevel
init|=
name|Z_DEFAULT_COMPRESSION
decl_stmt|;
name|long
name|lFileSize
decl_stmt|;
name|unsigned
name|char
modifier|*
name|FilePtr
decl_stmt|;
name|long
name|lBufferSizeCpr
decl_stmt|;
name|long
name|lBufferSizeUncpr
decl_stmt|;
name|long
name|lCompressedSize
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
modifier|*
name|CprPtr
decl_stmt|;
name|unsigned
name|char
modifier|*
name|UncprPtr
decl_stmt|;
name|long
name|lSizeCpr
decl_stmt|,
name|lSizeUncpr
decl_stmt|;
name|DWORD
name|dwGetTick
decl_stmt|,
name|dwMsecQP
decl_stmt|;
name|LARGE_INTEGER
name|li_qp
decl_stmt|,
name|li_rdtsc
decl_stmt|,
name|dwResRdtsc
decl_stmt|;
if|if
condition|(
name|argc
operator|<=
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"run TestZlib<File> [BlockSizeCompress] [BlockSizeUncompress] [compres. level]\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|ReadFileMemory
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
operator|&
name|lFileSize
argument_list|,
operator|&
name|FilePtr
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"error reading %s\n"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
else|else
name|printf
argument_list|(
literal|"file %s read, %u bytes\n"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|lFileSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>=
literal|3
condition|)
name|BlockSizeCompress
operator|=
name|atol
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>=
literal|4
condition|)
name|BlockSizeUncompress
operator|=
name|atol
argument_list|(
name|argv
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>=
literal|5
condition|)
name|cprLevel
operator|=
operator|(
name|int
operator|)
name|atol
argument_list|(
name|argv
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|lBufferSizeCpr
operator|=
name|lFileSize
operator|+
operator|(
name|lFileSize
operator|/
literal|0x10
operator|)
operator|+
literal|0x200
expr_stmt|;
name|lBufferSizeUncpr
operator|=
name|lBufferSizeCpr
expr_stmt|;
name|CprPtr
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|lBufferSizeCpr
operator|+
name|BlockSizeCompress
argument_list|)
expr_stmt|;
name|BeginCountPerfCounter
argument_list|(
operator|&
name|li_qp
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|dwGetTick
operator|=
name|GetTickCount
argument_list|()
expr_stmt|;
name|BeginCountRdtsc
argument_list|(
operator|&
name|li_rdtsc
argument_list|)
expr_stmt|;
block|{
name|z_stream
name|zcpr
decl_stmt|;
name|int
name|ret
init|=
name|Z_OK
decl_stmt|;
name|long
name|lOrigToDo
init|=
name|lFileSize
decl_stmt|;
name|long
name|lOrigDone
init|=
literal|0
decl_stmt|;
name|int
name|step
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|zcpr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|z_stream
argument_list|)
argument_list|)
expr_stmt|;
name|deflateInit
argument_list|(
operator|&
name|zcpr
argument_list|,
name|cprLevel
argument_list|)
expr_stmt|;
name|zcpr
operator|.
name|next_in
operator|=
name|FilePtr
expr_stmt|;
name|zcpr
operator|.
name|next_out
operator|=
name|CprPtr
expr_stmt|;
do|do
block|{
name|long
name|all_read_before
init|=
name|zcpr
operator|.
name|total_in
decl_stmt|;
name|zcpr
operator|.
name|avail_in
operator|=
name|min
argument_list|(
name|lOrigToDo
argument_list|,
name|BlockSizeCompress
argument_list|)
expr_stmt|;
name|zcpr
operator|.
name|avail_out
operator|=
name|BlockSizeCompress
expr_stmt|;
name|ret
operator|=
name|deflate
argument_list|(
operator|&
name|zcpr
argument_list|,
operator|(
name|zcpr
operator|.
name|avail_in
operator|==
name|lOrigToDo
operator|)
condition|?
name|Z_FINISH
else|:
name|Z_SYNC_FLUSH
argument_list|)
expr_stmt|;
name|lOrigDone
operator|+=
operator|(
name|zcpr
operator|.
name|total_in
operator|-
name|all_read_before
operator|)
expr_stmt|;
name|lOrigToDo
operator|-=
operator|(
name|zcpr
operator|.
name|total_in
operator|-
name|all_read_before
operator|)
expr_stmt|;
name|step
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|ret
operator|==
name|Z_OK
condition|)
do|;
name|lSizeCpr
operator|=
name|zcpr
operator|.
name|total_out
expr_stmt|;
name|deflateEnd
argument_list|(
operator|&
name|zcpr
argument_list|)
expr_stmt|;
name|dwGetTick
operator|=
name|GetTickCount
argument_list|()
operator|-
name|dwGetTick
expr_stmt|;
name|dwMsecQP
operator|=
name|GetMsecSincePerfCounter
argument_list|(
name|li_qp
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|dwResRdtsc
operator|=
name|GetResRdtsc
argument_list|(
name|li_rdtsc
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total compress size = %u, in %u step\n"
argument_list|,
name|lSizeCpr
argument_list|,
name|step
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"time = %u msec = %f sec\n"
argument_list|,
name|dwGetTick
argument_list|,
name|dwGetTick
operator|/
operator|(
name|double
operator|)
literal|1000.
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"defcpr time QP = %u msec = %f sec\n"
argument_list|,
name|dwMsecQP
argument_list|,
name|dwMsecQP
operator|/
operator|(
name|double
operator|)
literal|1000.
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"defcpr result rdtsc = %I64x\n\n"
argument_list|,
name|dwResRdtsc
operator|.
name|QuadPart
argument_list|)
expr_stmt|;
block|}
name|CprPtr
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|realloc
argument_list|(
name|CprPtr
argument_list|,
name|lSizeCpr
argument_list|)
expr_stmt|;
name|UncprPtr
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|lBufferSizeUncpr
operator|+
name|BlockSizeUncompress
argument_list|)
expr_stmt|;
name|BeginCountPerfCounter
argument_list|(
operator|&
name|li_qp
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|dwGetTick
operator|=
name|GetTickCount
argument_list|()
expr_stmt|;
name|BeginCountRdtsc
argument_list|(
operator|&
name|li_rdtsc
argument_list|)
expr_stmt|;
block|{
name|z_stream
name|zcpr
decl_stmt|;
name|int
name|ret
init|=
name|Z_OK
decl_stmt|;
name|long
name|lOrigToDo
init|=
name|lSizeCpr
decl_stmt|;
name|long
name|lOrigDone
init|=
literal|0
decl_stmt|;
name|int
name|step
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|zcpr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|z_stream
argument_list|)
argument_list|)
expr_stmt|;
name|inflateInit
argument_list|(
operator|&
name|zcpr
argument_list|)
expr_stmt|;
name|zcpr
operator|.
name|next_in
operator|=
name|CprPtr
expr_stmt|;
name|zcpr
operator|.
name|next_out
operator|=
name|UncprPtr
expr_stmt|;
do|do
block|{
name|long
name|all_read_before
init|=
name|zcpr
operator|.
name|total_in
decl_stmt|;
name|zcpr
operator|.
name|avail_in
operator|=
name|min
argument_list|(
name|lOrigToDo
argument_list|,
name|BlockSizeUncompress
argument_list|)
expr_stmt|;
name|zcpr
operator|.
name|avail_out
operator|=
name|BlockSizeUncompress
expr_stmt|;
name|ret
operator|=
name|inflate
argument_list|(
operator|&
name|zcpr
argument_list|,
name|Z_SYNC_FLUSH
argument_list|)
expr_stmt|;
name|lOrigDone
operator|+=
operator|(
name|zcpr
operator|.
name|total_in
operator|-
name|all_read_before
operator|)
expr_stmt|;
name|lOrigToDo
operator|-=
operator|(
name|zcpr
operator|.
name|total_in
operator|-
name|all_read_before
operator|)
expr_stmt|;
name|step
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|ret
operator|==
name|Z_OK
condition|)
do|;
name|lSizeUncpr
operator|=
name|zcpr
operator|.
name|total_out
expr_stmt|;
name|inflateEnd
argument_list|(
operator|&
name|zcpr
argument_list|)
expr_stmt|;
name|dwGetTick
operator|=
name|GetTickCount
argument_list|()
operator|-
name|dwGetTick
expr_stmt|;
name|dwMsecQP
operator|=
name|GetMsecSincePerfCounter
argument_list|(
name|li_qp
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|dwResRdtsc
operator|=
name|GetResRdtsc
argument_list|(
name|li_rdtsc
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total uncompress size = %u, in %u step\n"
argument_list|,
name|lSizeUncpr
argument_list|,
name|step
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"time = %u msec = %f sec\n"
argument_list|,
name|dwGetTick
argument_list|,
name|dwGetTick
operator|/
operator|(
name|double
operator|)
literal|1000.
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"uncpr  time QP = %u msec = %f sec\n"
argument_list|,
name|dwMsecQP
argument_list|,
name|dwMsecQP
operator|/
operator|(
name|double
operator|)
literal|1000.
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"uncpr  result rdtsc = %I64x\n\n"
argument_list|,
name|dwResRdtsc
operator|.
name|QuadPart
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lSizeUncpr
operator|==
name|lFileSize
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|FilePtr
argument_list|,
name|UncprPtr
argument_list|,
name|lFileSize
argument_list|)
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"compare ok\n"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


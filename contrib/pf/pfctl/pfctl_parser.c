begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: pfctl_parser.c,v 1.194 2004/03/15 15:25:44 dhartmei Exp $ */
end_comment

begin_comment
comment|/*  * Copyright (c) 2001 Daniel Hartmeier  * Copyright (c) 2002,2003 Henning Brauer  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  *    - Redistributions of source code must retain the above copyright  *      notice, this list of conditions and the following disclaimer.  *    - Redistributions in binary form must reproduce the above  *      copyright notice, this list of conditions and the following  *      disclaimer in the documentation and/or other materials provided  *      with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE  * COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN  * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_icmp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/icmp6.h>
end_include

begin_include
include|#
directive|include
file|<net/pfvar.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<ifaddrs.h>
end_include

begin_include
include|#
directive|include
file|"pfctl_parser.h"
end_include

begin_include
include|#
directive|include
file|"pfctl.h"
end_include

begin_function_decl
name|void
name|print_op
parameter_list|(
name|u_int8_t
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|print_port
parameter_list|(
name|u_int8_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|print_ugid
parameter_list|(
name|u_int8_t
parameter_list|,
name|unsigned
parameter_list|,
name|unsigned
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|unsigned
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|print_flags
parameter_list|(
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|print_fromto
parameter_list|(
name|struct
name|pf_rule_addr
modifier|*
parameter_list|,
name|pf_osfp_t
parameter_list|,
name|struct
name|pf_rule_addr
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|,
name|u_int8_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|node_host
modifier|*
name|host_if
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|node_host
modifier|*
name|host_v4
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|node_host
modifier|*
name|host_v6
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|node_host
modifier|*
name|host_dns
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|const
name|char
modifier|*
name|tcpflags
init|=
literal|"FSRPAUEW"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|icmptypeent
name|icmp_type
index|[]
init|=
block|{
block|{
literal|"echoreq"
block|,
name|ICMP_ECHO
block|}
block|,
block|{
literal|"echorep"
block|,
name|ICMP_ECHOREPLY
block|}
block|,
block|{
literal|"unreach"
block|,
name|ICMP_UNREACH
block|}
block|,
block|{
literal|"squench"
block|,
name|ICMP_SOURCEQUENCH
block|}
block|,
block|{
literal|"redir"
block|,
name|ICMP_REDIRECT
block|}
block|,
block|{
literal|"althost"
block|,
name|ICMP_ALTHOSTADDR
block|}
block|,
block|{
literal|"routeradv"
block|,
name|ICMP_ROUTERADVERT
block|}
block|,
block|{
literal|"routersol"
block|,
name|ICMP_ROUTERSOLICIT
block|}
block|,
block|{
literal|"timex"
block|,
name|ICMP_TIMXCEED
block|}
block|,
block|{
literal|"paramprob"
block|,
name|ICMP_PARAMPROB
block|}
block|,
block|{
literal|"timereq"
block|,
name|ICMP_TSTAMP
block|}
block|,
block|{
literal|"timerep"
block|,
name|ICMP_TSTAMPREPLY
block|}
block|,
block|{
literal|"inforeq"
block|,
name|ICMP_IREQ
block|}
block|,
block|{
literal|"inforep"
block|,
name|ICMP_IREQREPLY
block|}
block|,
block|{
literal|"maskreq"
block|,
name|ICMP_MASKREQ
block|}
block|,
block|{
literal|"maskrep"
block|,
name|ICMP_MASKREPLY
block|}
block|,
block|{
literal|"trace"
block|,
name|ICMP_TRACEROUTE
block|}
block|,
block|{
literal|"dataconv"
block|,
name|ICMP_DATACONVERR
block|}
block|,
block|{
literal|"mobredir"
block|,
name|ICMP_MOBILE_REDIRECT
block|}
block|,
block|{
literal|"ipv6-where"
block|,
name|ICMP_IPV6_WHEREAREYOU
block|}
block|,
block|{
literal|"ipv6-here"
block|,
name|ICMP_IPV6_IAMHERE
block|}
block|,
block|{
literal|"mobregreq"
block|,
name|ICMP_MOBILE_REGREQUEST
block|}
block|,
block|{
literal|"mobregrep"
block|,
name|ICMP_MOBILE_REGREPLY
block|}
block|,
block|{
literal|"skip"
block|,
name|ICMP_SKIP
block|}
block|,
block|{
literal|"photuris"
block|,
name|ICMP_PHOTURIS
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|icmptypeent
name|icmp6_type
index|[]
init|=
block|{
block|{
literal|"unreach"
block|,
name|ICMP6_DST_UNREACH
block|}
block|,
block|{
literal|"toobig"
block|,
name|ICMP6_PACKET_TOO_BIG
block|}
block|,
block|{
literal|"timex"
block|,
name|ICMP6_TIME_EXCEEDED
block|}
block|,
block|{
literal|"paramprob"
block|,
name|ICMP6_PARAM_PROB
block|}
block|,
block|{
literal|"echoreq"
block|,
name|ICMP6_ECHO_REQUEST
block|}
block|,
block|{
literal|"echorep"
block|,
name|ICMP6_ECHO_REPLY
block|}
block|,
block|{
literal|"groupqry"
block|,
name|ICMP6_MEMBERSHIP_QUERY
block|}
block|,
block|{
literal|"listqry"
block|,
name|MLD_LISTENER_QUERY
block|}
block|,
block|{
literal|"grouprep"
block|,
name|ICMP6_MEMBERSHIP_REPORT
block|}
block|,
block|{
literal|"listenrep"
block|,
name|MLD_LISTENER_REPORT
block|}
block|,
block|{
literal|"groupterm"
block|,
name|ICMP6_MEMBERSHIP_REDUCTION
block|}
block|,
block|{
literal|"listendone"
block|,
name|MLD_LISTENER_DONE
block|}
block|,
block|{
literal|"routersol"
block|,
name|ND_ROUTER_SOLICIT
block|}
block|,
block|{
literal|"routeradv"
block|,
name|ND_ROUTER_ADVERT
block|}
block|,
block|{
literal|"neighbrsol"
block|,
name|ND_NEIGHBOR_SOLICIT
block|}
block|,
block|{
literal|"neighbradv"
block|,
name|ND_NEIGHBOR_ADVERT
block|}
block|,
block|{
literal|"redir"
block|,
name|ND_REDIRECT
block|}
block|,
block|{
literal|"routrrenum"
block|,
name|ICMP6_ROUTER_RENUMBERING
block|}
block|,
block|{
literal|"wrureq"
block|,
name|ICMP6_WRUREQUEST
block|}
block|,
block|{
literal|"wrurep"
block|,
name|ICMP6_WRUREPLY
block|}
block|,
block|{
literal|"fqdnreq"
block|,
name|ICMP6_FQDN_QUERY
block|}
block|,
block|{
literal|"fqdnrep"
block|,
name|ICMP6_FQDN_REPLY
block|}
block|,
block|{
literal|"niqry"
block|,
name|ICMP6_NI_QUERY
block|}
block|,
block|{
literal|"nirep"
block|,
name|ICMP6_NI_REPLY
block|}
block|,
block|{
literal|"mtraceresp"
block|,
name|MLD_MTRACE_RESP
block|}
block|,
block|{
literal|"mtrace"
block|,
name|MLD_MTRACE
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|icmpcodeent
name|icmp_code
index|[]
init|=
block|{
block|{
literal|"net-unr"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_NET
block|}
block|,
block|{
literal|"host-unr"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_HOST
block|}
block|,
block|{
literal|"proto-unr"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_PROTOCOL
block|}
block|,
block|{
literal|"port-unr"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_PORT
block|}
block|,
block|{
literal|"needfrag"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_NEEDFRAG
block|}
block|,
block|{
literal|"srcfail"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_SRCFAIL
block|}
block|,
block|{
literal|"net-unk"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_NET_UNKNOWN
block|}
block|,
block|{
literal|"host-unk"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_HOST_UNKNOWN
block|}
block|,
block|{
literal|"isolate"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_ISOLATED
block|}
block|,
block|{
literal|"net-prohib"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_NET_PROHIB
block|}
block|,
block|{
literal|"host-prohib"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_HOST_PROHIB
block|}
block|,
block|{
literal|"net-tos"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_TOSNET
block|}
block|,
block|{
literal|"host-tos"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_TOSHOST
block|}
block|,
block|{
literal|"filter-prohib"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_FILTER_PROHIB
block|}
block|,
block|{
literal|"host-preced"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_HOST_PRECEDENCE
block|}
block|,
block|{
literal|"cutoff-preced"
block|,
name|ICMP_UNREACH
block|,
name|ICMP_UNREACH_PRECEDENCE_CUTOFF
block|}
block|,
block|{
literal|"redir-net"
block|,
name|ICMP_REDIRECT
block|,
name|ICMP_REDIRECT_NET
block|}
block|,
block|{
literal|"redir-host"
block|,
name|ICMP_REDIRECT
block|,
name|ICMP_REDIRECT_HOST
block|}
block|,
block|{
literal|"redir-tos-net"
block|,
name|ICMP_REDIRECT
block|,
name|ICMP_REDIRECT_TOSNET
block|}
block|,
block|{
literal|"redir-tos-host"
block|,
name|ICMP_REDIRECT
block|,
name|ICMP_REDIRECT_TOSHOST
block|}
block|,
block|{
literal|"normal-adv"
block|,
name|ICMP_ROUTERADVERT
block|,
name|ICMP_ROUTERADVERT_NORMAL
block|}
block|,
block|{
literal|"common-adv"
block|,
name|ICMP_ROUTERADVERT
block|,
name|ICMP_ROUTERADVERT_NOROUTE_COMMON
block|}
block|,
block|{
literal|"transit"
block|,
name|ICMP_TIMXCEED
block|,
name|ICMP_TIMXCEED_INTRANS
block|}
block|,
block|{
literal|"reassemb"
block|,
name|ICMP_TIMXCEED
block|,
name|ICMP_TIMXCEED_REASS
block|}
block|,
block|{
literal|"badhead"
block|,
name|ICMP_PARAMPROB
block|,
name|ICMP_PARAMPROB_ERRATPTR
block|}
block|,
block|{
literal|"optmiss"
block|,
name|ICMP_PARAMPROB
block|,
name|ICMP_PARAMPROB_OPTABSENT
block|}
block|,
block|{
literal|"badlen"
block|,
name|ICMP_PARAMPROB
block|,
name|ICMP_PARAMPROB_LENGTH
block|}
block|,
block|{
literal|"unknown-ind"
block|,
name|ICMP_PHOTURIS
block|,
name|ICMP_PHOTURIS_UNKNOWN_INDEX
block|}
block|,
block|{
literal|"auth-fail"
block|,
name|ICMP_PHOTURIS
block|,
name|ICMP_PHOTURIS_AUTH_FAILED
block|}
block|,
block|{
literal|"decrypt-fail"
block|,
name|ICMP_PHOTURIS
block|,
name|ICMP_PHOTURIS_DECRYPT_FAILED
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|icmpcodeent
name|icmp6_code
index|[]
init|=
block|{
block|{
literal|"admin-unr"
block|,
name|ICMP6_DST_UNREACH
block|,
name|ICMP6_DST_UNREACH_ADMIN
block|}
block|,
block|{
literal|"noroute-unr"
block|,
name|ICMP6_DST_UNREACH
block|,
name|ICMP6_DST_UNREACH_NOROUTE
block|}
block|,
block|{
literal|"notnbr-unr"
block|,
name|ICMP6_DST_UNREACH
block|,
name|ICMP6_DST_UNREACH_NOTNEIGHBOR
block|}
block|,
block|{
literal|"beyond-unr"
block|,
name|ICMP6_DST_UNREACH
block|,
name|ICMP6_DST_UNREACH_BEYONDSCOPE
block|}
block|,
block|{
literal|"addr-unr"
block|,
name|ICMP6_DST_UNREACH
block|,
name|ICMP6_DST_UNREACH_ADDR
block|}
block|,
block|{
literal|"port-unr"
block|,
name|ICMP6_DST_UNREACH
block|,
name|ICMP6_DST_UNREACH_NOPORT
block|}
block|,
block|{
literal|"transit"
block|,
name|ICMP6_TIME_EXCEEDED
block|,
name|ICMP6_TIME_EXCEED_TRANSIT
block|}
block|,
block|{
literal|"reassemb"
block|,
name|ICMP6_TIME_EXCEEDED
block|,
name|ICMP6_TIME_EXCEED_REASSEMBLY
block|}
block|,
block|{
literal|"badhead"
block|,
name|ICMP6_PARAM_PROB
block|,
name|ICMP6_PARAMPROB_HEADER
block|}
block|,
block|{
literal|"nxthdr"
block|,
name|ICMP6_PARAM_PROB
block|,
name|ICMP6_PARAMPROB_NEXTHEADER
block|}
block|,
block|{
literal|"redironlink"
block|,
name|ND_REDIRECT
block|,
name|ND_REDIRECT_ONLINK
block|}
block|,
block|{
literal|"redirrouter"
block|,
name|ND_REDIRECT
block|,
name|ND_REDIRECT_ROUTER
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|struct
name|pf_timeout
name|pf_timeouts
index|[]
init|=
block|{
block|{
literal|"tcp.first"
block|,
name|PFTM_TCP_FIRST_PACKET
block|}
block|,
block|{
literal|"tcp.opening"
block|,
name|PFTM_TCP_OPENING
block|}
block|,
block|{
literal|"tcp.established"
block|,
name|PFTM_TCP_ESTABLISHED
block|}
block|,
block|{
literal|"tcp.closing"
block|,
name|PFTM_TCP_CLOSING
block|}
block|,
block|{
literal|"tcp.finwait"
block|,
name|PFTM_TCP_FIN_WAIT
block|}
block|,
block|{
literal|"tcp.closed"
block|,
name|PFTM_TCP_CLOSED
block|}
block|,
block|{
literal|"udp.first"
block|,
name|PFTM_UDP_FIRST_PACKET
block|}
block|,
block|{
literal|"udp.single"
block|,
name|PFTM_UDP_SINGLE
block|}
block|,
block|{
literal|"udp.multiple"
block|,
name|PFTM_UDP_MULTIPLE
block|}
block|,
block|{
literal|"icmp.first"
block|,
name|PFTM_ICMP_FIRST_PACKET
block|}
block|,
block|{
literal|"icmp.error"
block|,
name|PFTM_ICMP_ERROR_REPLY
block|}
block|,
block|{
literal|"other.first"
block|,
name|PFTM_OTHER_FIRST_PACKET
block|}
block|,
block|{
literal|"other.single"
block|,
name|PFTM_OTHER_SINGLE
block|}
block|,
block|{
literal|"other.multiple"
block|,
name|PFTM_OTHER_MULTIPLE
block|}
block|,
block|{
literal|"frag"
block|,
name|PFTM_FRAG
block|}
block|,
block|{
literal|"interval"
block|,
name|PFTM_INTERVAL
block|}
block|,
block|{
literal|"adaptive.start"
block|,
name|PFTM_ADAPTIVE_START
block|}
block|,
block|{
literal|"adaptive.end"
block|,
name|PFTM_ADAPTIVE_END
block|}
block|,
block|{
literal|"src.track"
block|,
name|PFTM_SRC_NODE
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|const
name|struct
name|icmptypeent
modifier|*
name|geticmptypebynumber
parameter_list|(
name|u_int8_t
name|type
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
name|af
operator|!=
name|AF_INET6
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|icmp_type
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|icmp_type
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|type
operator|==
name|icmp_type
index|[
name|i
index|]
operator|.
name|type
condition|)
return|return
operator|(
operator|&
name|icmp_type
index|[
name|i
index|]
operator|)
return|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|icmp6_type
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|icmp6_type
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|type
operator|==
name|icmp6_type
index|[
name|i
index|]
operator|.
name|type
condition|)
return|return
operator|(
operator|&
name|icmp6_type
index|[
name|i
index|]
operator|)
return|;
block|}
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|const
name|struct
name|icmptypeent
modifier|*
name|geticmptypebyname
parameter_list|(
name|char
modifier|*
name|w
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
name|af
operator|!=
name|AF_INET6
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|icmp_type
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|icmp_type
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|w
argument_list|,
name|icmp_type
index|[
name|i
index|]
operator|.
name|name
argument_list|)
condition|)
return|return
operator|(
operator|&
name|icmp_type
index|[
name|i
index|]
operator|)
return|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|icmp6_type
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|icmp6_type
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|w
argument_list|,
name|icmp6_type
index|[
name|i
index|]
operator|.
name|name
argument_list|)
condition|)
return|return
operator|(
operator|&
name|icmp6_type
index|[
name|i
index|]
operator|)
return|;
block|}
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|const
name|struct
name|icmpcodeent
modifier|*
name|geticmpcodebynumber
parameter_list|(
name|u_int8_t
name|type
parameter_list|,
name|u_int8_t
name|code
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
name|af
operator|!=
name|AF_INET6
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|icmp_code
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|icmp_code
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|type
operator|==
name|icmp_code
index|[
name|i
index|]
operator|.
name|type
operator|&&
name|code
operator|==
name|icmp_code
index|[
name|i
index|]
operator|.
name|code
condition|)
return|return
operator|(
operator|&
name|icmp_code
index|[
name|i
index|]
operator|)
return|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|icmp6_code
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|icmp6_code
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|type
operator|==
name|icmp6_code
index|[
name|i
index|]
operator|.
name|type
operator|&&
name|code
operator|==
name|icmp6_code
index|[
name|i
index|]
operator|.
name|code
condition|)
return|return
operator|(
operator|&
name|icmp6_code
index|[
name|i
index|]
operator|)
return|;
block|}
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|const
name|struct
name|icmpcodeent
modifier|*
name|geticmpcodebyname
parameter_list|(
name|u_long
name|type
parameter_list|,
name|char
modifier|*
name|w
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
name|af
operator|!=
name|AF_INET6
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|icmp_code
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|icmp_code
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|type
operator|==
name|icmp_code
index|[
name|i
index|]
operator|.
name|type
operator|&&
operator|!
name|strcmp
argument_list|(
name|w
argument_list|,
name|icmp_code
index|[
name|i
index|]
operator|.
name|name
argument_list|)
condition|)
return|return
operator|(
operator|&
name|icmp_code
index|[
name|i
index|]
operator|)
return|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|icmp6_code
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|icmp6_code
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|type
operator|==
name|icmp6_code
index|[
name|i
index|]
operator|.
name|type
operator|&&
operator|!
name|strcmp
argument_list|(
name|w
argument_list|,
name|icmp6_code
index|[
name|i
index|]
operator|.
name|name
argument_list|)
condition|)
return|return
operator|(
operator|&
name|icmp6_code
index|[
name|i
index|]
operator|)
return|;
block|}
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|void
name|print_op
parameter_list|(
name|u_int8_t
name|op
parameter_list|,
specifier|const
name|char
modifier|*
name|a1
parameter_list|,
specifier|const
name|char
modifier|*
name|a2
parameter_list|)
block|{
if|if
condition|(
name|op
operator|==
name|PF_OP_IRG
condition|)
name|printf
argument_list|(
literal|" %s>< %s"
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|==
name|PF_OP_XRG
condition|)
name|printf
argument_list|(
literal|" %s<> %s"
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|==
name|PF_OP_EQ
condition|)
name|printf
argument_list|(
literal|" = %s"
argument_list|,
name|a1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|==
name|PF_OP_NE
condition|)
name|printf
argument_list|(
literal|" != %s"
argument_list|,
name|a1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|==
name|PF_OP_LT
condition|)
name|printf
argument_list|(
literal|"< %s"
argument_list|,
name|a1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|==
name|PF_OP_LE
condition|)
name|printf
argument_list|(
literal|"<= %s"
argument_list|,
name|a1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|==
name|PF_OP_GT
condition|)
name|printf
argument_list|(
literal|"> %s"
argument_list|,
name|a1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|==
name|PF_OP_GE
condition|)
name|printf
argument_list|(
literal|">= %s"
argument_list|,
name|a1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|==
name|PF_OP_RRG
condition|)
name|printf
argument_list|(
literal|" %s:%s"
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|print_port
parameter_list|(
name|u_int8_t
name|op
parameter_list|,
name|u_int16_t
name|p1
parameter_list|,
name|u_int16_t
name|p2
parameter_list|,
specifier|const
name|char
modifier|*
name|proto
parameter_list|)
block|{
name|char
name|a1
index|[
literal|6
index|]
decl_stmt|,
name|a2
index|[
literal|6
index|]
decl_stmt|;
name|struct
name|servent
modifier|*
name|s
decl_stmt|;
name|s
operator|=
name|getservbyport
argument_list|(
name|p1
argument_list|,
name|proto
argument_list|)
expr_stmt|;
name|p1
operator|=
name|ntohs
argument_list|(
name|p1
argument_list|)
expr_stmt|;
name|p2
operator|=
name|ntohs
argument_list|(
name|p2
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|a1
argument_list|,
sizeof|sizeof
argument_list|(
name|a1
argument_list|)
argument_list|,
literal|"%u"
argument_list|,
name|p1
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|a2
argument_list|,
sizeof|sizeof
argument_list|(
name|a2
argument_list|)
argument_list|,
literal|"%u"
argument_list|,
name|p2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" port"
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
operator|&&
operator|(
name|op
operator|==
name|PF_OP_EQ
operator|||
name|op
operator|==
name|PF_OP_NE
operator|)
condition|)
name|print_op
argument_list|(
name|op
argument_list|,
name|s
operator|->
name|s_name
argument_list|,
name|a2
argument_list|)
expr_stmt|;
else|else
name|print_op
argument_list|(
name|op
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|print_ugid
parameter_list|(
name|u_int8_t
name|op
parameter_list|,
name|unsigned
name|u1
parameter_list|,
name|unsigned
name|u2
parameter_list|,
specifier|const
name|char
modifier|*
name|t
parameter_list|,
name|unsigned
name|umax
parameter_list|)
block|{
name|char
name|a1
index|[
literal|11
index|]
decl_stmt|,
name|a2
index|[
literal|11
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|a1
argument_list|,
sizeof|sizeof
argument_list|(
name|a1
argument_list|)
argument_list|,
literal|"%u"
argument_list|,
name|u1
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|a2
argument_list|,
sizeof|sizeof
argument_list|(
name|a2
argument_list|)
argument_list|,
literal|"%u"
argument_list|,
name|u2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|u1
operator|==
name|umax
operator|&&
operator|(
name|op
operator|==
name|PF_OP_EQ
operator|||
name|op
operator|==
name|PF_OP_NE
operator|)
condition|)
name|print_op
argument_list|(
name|op
argument_list|,
literal|"unknown"
argument_list|,
name|a2
argument_list|)
expr_stmt|;
else|else
name|print_op
argument_list|(
name|op
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|print_flags
parameter_list|(
name|u_int8_t
name|f
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|tcpflags
index|[
name|i
index|]
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|f
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|tcpflags
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|print_fromto
parameter_list|(
name|struct
name|pf_rule_addr
modifier|*
name|src
parameter_list|,
name|pf_osfp_t
name|osfp
parameter_list|,
name|struct
name|pf_rule_addr
modifier|*
name|dst
parameter_list|,
name|sa_family_t
name|af
parameter_list|,
name|u_int8_t
name|proto
parameter_list|,
name|int
name|verbose
parameter_list|)
block|{
name|char
name|buf
index|[
name|PF_OSFP_LEN
operator|*
literal|3
index|]
decl_stmt|;
if|if
condition|(
name|src
operator|->
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_ADDRMASK
operator|&&
name|dst
operator|->
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_ADDRMASK
operator|&&
name|PF_AZERO
argument_list|(
operator|&
name|src
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
name|AF_INET6
argument_list|)
operator|&&
name|PF_AZERO
argument_list|(
operator|&
name|src
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
name|AF_INET6
argument_list|)
operator|&&
name|PF_AZERO
argument_list|(
operator|&
name|dst
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
name|AF_INET6
argument_list|)
operator|&&
name|PF_AZERO
argument_list|(
operator|&
name|dst
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
name|AF_INET6
argument_list|)
operator|&&
operator|!
name|src
operator|->
name|not
operator|&&
operator|!
name|dst
operator|->
name|not
operator|&&
operator|!
name|src
operator|->
name|port_op
operator|&&
operator|!
name|dst
operator|->
name|port_op
operator|&&
name|osfp
operator|==
name|PF_OSFP_ANY
condition|)
name|printf
argument_list|(
literal|" all"
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|" from "
argument_list|)
expr_stmt|;
if|if
condition|(
name|src
operator|->
name|not
condition|)
name|printf
argument_list|(
literal|"! "
argument_list|)
expr_stmt|;
name|print_addr
argument_list|(
operator|&
name|src
operator|->
name|addr
argument_list|,
name|af
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
if|if
condition|(
name|src
operator|->
name|port_op
condition|)
name|print_port
argument_list|(
name|src
operator|->
name|port_op
argument_list|,
name|src
operator|->
name|port
index|[
literal|0
index|]
argument_list|,
name|src
operator|->
name|port
index|[
literal|1
index|]
argument_list|,
name|proto
operator|==
name|IPPROTO_TCP
condition|?
literal|"tcp"
else|:
literal|"udp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|osfp
operator|!=
name|PF_OSFP_ANY
condition|)
name|printf
argument_list|(
literal|" os \"%s\""
argument_list|,
name|pfctl_lookup_fingerprint
argument_list|(
name|osfp
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" to "
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|not
condition|)
name|printf
argument_list|(
literal|"! "
argument_list|)
expr_stmt|;
name|print_addr
argument_list|(
operator|&
name|dst
operator|->
name|addr
argument_list|,
name|af
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|port_op
condition|)
name|print_port
argument_list|(
name|dst
operator|->
name|port_op
argument_list|,
name|dst
operator|->
name|port
index|[
literal|0
index|]
argument_list|,
name|dst
operator|->
name|port
index|[
literal|1
index|]
argument_list|,
name|proto
operator|==
name|IPPROTO_TCP
condition|?
literal|"tcp"
else|:
literal|"udp"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|print_pool
parameter_list|(
name|struct
name|pf_pool
modifier|*
name|pool
parameter_list|,
name|u_int16_t
name|p1
parameter_list|,
name|u_int16_t
name|p2
parameter_list|,
name|sa_family_t
name|af
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|struct
name|pf_pooladdr
modifier|*
name|pooladdr
decl_stmt|;
if|if
condition|(
operator|(
name|TAILQ_FIRST
argument_list|(
operator|&
name|pool
operator|->
name|list
argument_list|)
operator|!=
name|NULL
operator|)
operator|&&
name|TAILQ_NEXT
argument_list|(
name|TAILQ_FIRST
argument_list|(
operator|&
name|pool
operator|->
name|list
argument_list|)
argument_list|,
name|entries
argument_list|)
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"{ "
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|pooladdr
argument_list|,
argument|&pool->list
argument_list|,
argument|entries
argument_list|)
block|{
switch|switch
condition|(
name|id
condition|)
block|{
case|case
name|PF_NAT
case|:
case|case
name|PF_RDR
case|:
case|case
name|PF_BINAT
case|:
name|print_addr
argument_list|(
operator|&
name|pooladdr
operator|->
name|addr
argument_list|,
name|af
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_PASS
case|:
if|if
condition|(
name|PF_AZERO
argument_list|(
operator|&
name|pooladdr
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
name|af
argument_list|)
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|pooladdr
operator|->
name|ifname
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"(%s "
argument_list|,
name|pooladdr
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|print_addr
argument_list|(
operator|&
name|pooladdr
operator|->
name|addr
argument_list|,
name|af
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|TAILQ_NEXT
argument_list|(
name|pooladdr
argument_list|,
name|entries
argument_list|)
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|TAILQ_NEXT
argument_list|(
name|TAILQ_FIRST
argument_list|(
operator|&
name|pool
operator|->
name|list
argument_list|)
argument_list|,
name|entries
argument_list|)
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|" }"
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|id
condition|)
block|{
case|case
name|PF_NAT
case|:
if|if
condition|(
operator|(
name|p1
operator|!=
name|PF_NAT_PROXY_PORT_LOW
operator|||
name|p2
operator|!=
name|PF_NAT_PROXY_PORT_HIGH
operator|)
operator|&&
operator|(
name|p1
operator|!=
literal|0
operator|||
name|p2
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|p1
operator|==
name|p2
condition|)
name|printf
argument_list|(
literal|" port %u"
argument_list|,
name|p1
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" port %u:%u"
argument_list|,
name|p1
argument_list|,
name|p2
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PF_RDR
case|:
if|if
condition|(
name|p1
condition|)
block|{
name|printf
argument_list|(
literal|" port %u"
argument_list|,
name|p1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2
operator|&&
operator|(
name|p2
operator|!=
name|p1
operator|)
condition|)
name|printf
argument_list|(
literal|":%u"
argument_list|,
name|p2
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
switch|switch
condition|(
name|pool
operator|->
name|opts
operator|&
name|PF_POOL_TYPEMASK
condition|)
block|{
case|case
name|PF_POOL_NONE
case|:
break|break;
case|case
name|PF_POOL_BITMASK
case|:
name|printf
argument_list|(
literal|" bitmask"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_POOL_RANDOM
case|:
name|printf
argument_list|(
literal|" random"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_POOL_SRCHASH
case|:
name|printf
argument_list|(
literal|" source-hash 0x%08x%08x%08x%08x"
argument_list|,
name|pool
operator|->
name|key
operator|.
name|key32
index|[
literal|0
index|]
argument_list|,
name|pool
operator|->
name|key
operator|.
name|key32
index|[
literal|1
index|]
argument_list|,
name|pool
operator|->
name|key
operator|.
name|key32
index|[
literal|2
index|]
argument_list|,
name|pool
operator|->
name|key
operator|.
name|key32
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_POOL_ROUNDROBIN
case|:
name|printf
argument_list|(
literal|" round-robin"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|pool
operator|->
name|opts
operator|&
name|PF_POOL_STICKYADDR
condition|)
name|printf
argument_list|(
literal|" sticky-address"
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|PF_NAT
operator|&&
name|p1
operator|==
literal|0
operator|&&
name|p2
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|" static-port"
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|const
name|char
modifier|*
name|pf_reasons
index|[
name|PFRES_MAX
operator|+
literal|1
index|]
init|=
name|PFRES_NAMES
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|pf_fcounters
index|[
name|FCNT_MAX
operator|+
literal|1
index|]
init|=
name|FCNT_NAMES
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|pf_scounters
index|[
name|FCNT_MAX
operator|+
literal|1
index|]
init|=
name|FCNT_NAMES
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|print_status
parameter_list|(
name|struct
name|pf_status
modifier|*
name|s
parameter_list|,
name|int
name|opts
parameter_list|)
block|{
name|char
name|statline
index|[
literal|80
index|]
decl_stmt|,
modifier|*
name|running
decl_stmt|;
name|time_t
name|runtime
decl_stmt|;
name|int
name|i
decl_stmt|;
name|runtime
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|s
operator|->
name|since
expr_stmt|;
name|running
operator|=
name|s
operator|->
name|running
condition|?
literal|"Enabled"
else|:
literal|"Disabled"
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|since
condition|)
block|{
name|unsigned
name|sec
decl_stmt|,
name|min
decl_stmt|,
name|hrs
decl_stmt|,
name|day
init|=
name|runtime
decl_stmt|;
name|sec
operator|=
name|day
operator|%
literal|60
expr_stmt|;
name|day
operator|/=
literal|60
expr_stmt|;
name|min
operator|=
name|day
operator|%
literal|60
expr_stmt|;
name|day
operator|/=
literal|60
expr_stmt|;
name|hrs
operator|=
name|day
operator|%
literal|24
expr_stmt|;
name|day
operator|/=
literal|24
expr_stmt|;
name|snprintf
argument_list|(
name|statline
argument_list|,
sizeof|sizeof
argument_list|(
name|statline
argument_list|)
argument_list|,
literal|"Status: %s for %u days %.2u:%.2u:%.2u"
argument_list|,
name|running
argument_list|,
name|day
argument_list|,
name|hrs
argument_list|,
name|min
argument_list|,
name|sec
argument_list|)
expr_stmt|;
block|}
else|else
name|snprintf
argument_list|(
name|statline
argument_list|,
sizeof|sizeof
argument_list|(
name|statline
argument_list|)
argument_list|,
literal|"Status: %s"
argument_list|,
name|running
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-44s"
argument_list|,
name|statline
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|s
operator|->
name|debug
condition|)
block|{
case|case
name|PF_DEBUG_NONE
case|:
name|printf
argument_list|(
literal|"%15s\n\n"
argument_list|,
literal|"Debug: None"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_DEBUG_URGENT
case|:
name|printf
argument_list|(
literal|"%15s\n\n"
argument_list|,
literal|"Debug: Urgent"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_DEBUG_MISC
case|:
name|printf
argument_list|(
literal|"%15s\n\n"
argument_list|,
literal|"Debug: Misc"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_DEBUG_NOISY
case|:
name|printf
argument_list|(
literal|"%15s\n\n"
argument_list|,
literal|"Debug: Loud"
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"Hostid: 0x%08x\n\n"
argument_list|,
name|ntohl
argument_list|(
name|s
operator|->
name|hostid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|ifname
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Interface Stats for %-16s %5s %16s\n"
argument_list|,
name|s
operator|->
name|ifname
argument_list|,
literal|"IPv4"
argument_list|,
literal|"IPv6"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %-25s %14llu %16llu\n"
argument_list|,
literal|"Bytes In"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|bcounters
index|[
literal|0
index|]
index|[
literal|0
index|]
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|bcounters
index|[
literal|1
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %-25s %14llu %16llu\n"
argument_list|,
literal|"Bytes Out"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|bcounters
index|[
literal|0
index|]
index|[
literal|1
index|]
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|bcounters
index|[
literal|1
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Packets In\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %-23s %14llu %16llu\n"
argument_list|,
literal|"Passed"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|pcounters
index|[
literal|0
index|]
index|[
literal|0
index|]
index|[
name|PF_PASS
index|]
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|pcounters
index|[
literal|1
index|]
index|[
literal|0
index|]
index|[
name|PF_PASS
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %-23s %14llu %16llu\n"
argument_list|,
literal|"Blocked"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|pcounters
index|[
literal|0
index|]
index|[
literal|0
index|]
index|[
name|PF_DROP
index|]
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|pcounters
index|[
literal|1
index|]
index|[
literal|0
index|]
index|[
name|PF_DROP
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Packets Out\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %-23s %14llu %16llu\n"
argument_list|,
literal|"Passed"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|pcounters
index|[
literal|0
index|]
index|[
literal|1
index|]
index|[
name|PF_PASS
index|]
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|pcounters
index|[
literal|1
index|]
index|[
literal|1
index|]
index|[
name|PF_PASS
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %-23s %14llu %16llu\n\n"
argument_list|,
literal|"Blocked"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|pcounters
index|[
literal|0
index|]
index|[
literal|1
index|]
index|[
name|PF_DROP
index|]
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|pcounters
index|[
literal|1
index|]
index|[
literal|1
index|]
index|[
name|PF_DROP
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%-27s %14s %16s\n"
argument_list|,
literal|"State Table"
argument_list|,
literal|"Total"
argument_list|,
literal|"Rate"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %-25s %14u %14s\n"
argument_list|,
literal|"current entries"
argument_list|,
name|s
operator|->
name|states
argument_list|,
literal|""
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FCNT_MAX
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"  %-25s %14llu "
argument_list|,
name|pf_fcounters
index|[
name|i
index|]
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|fcounters
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|runtime
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"%14.1f/s\n"
argument_list|,
operator|(
name|double
operator|)
name|s
operator|->
name|fcounters
index|[
name|i
index|]
operator|/
operator|(
name|double
operator|)
name|runtime
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%14s\n"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opts
operator|&
name|PF_OPT_VERBOSE
condition|)
block|{
name|printf
argument_list|(
literal|"Source Tracking Table\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %-25s %14u %14s\n"
argument_list|,
literal|"current entries"
argument_list|,
name|s
operator|->
name|src_nodes
argument_list|,
literal|""
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SCNT_MAX
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"  %-25s %14lld "
argument_list|,
name|pf_scounters
index|[
name|i
index|]
argument_list|,
name|s
operator|->
name|scounters
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|runtime
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"%14.1f/s\n"
argument_list|,
operator|(
name|double
operator|)
name|s
operator|->
name|scounters
index|[
name|i
index|]
operator|/
operator|(
name|double
operator|)
name|runtime
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%14s\n"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"Counters\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PFRES_MAX
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"  %-25s %14llu "
argument_list|,
name|pf_reasons
index|[
name|i
index|]
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s
operator|->
name|counters
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|runtime
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"%14.1f/s\n"
argument_list|,
operator|(
name|double
operator|)
name|s
operator|->
name|counters
index|[
name|i
index|]
operator|/
operator|(
name|double
operator|)
name|runtime
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%14s\n"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|print_src_node
parameter_list|(
name|struct
name|pf_src_node
modifier|*
name|sn
parameter_list|,
name|int
name|opts
parameter_list|)
block|{
name|struct
name|pf_addr_wrap
name|aw
decl_stmt|;
name|int
name|min
decl_stmt|,
name|sec
decl_stmt|;
name|memset
argument_list|(
operator|&
name|aw
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|aw
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sn
operator|->
name|af
operator|==
name|AF_INET
condition|)
name|aw
operator|.
name|v
operator|.
name|a
operator|.
name|mask
operator|.
name|addr32
index|[
literal|0
index|]
operator|=
literal|0xffffffff
expr_stmt|;
else|else
name|memset
argument_list|(
operator|&
name|aw
operator|.
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
literal|0xff
argument_list|,
sizeof|sizeof
argument_list|(
name|aw
operator|.
name|v
operator|.
name|a
operator|.
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|aw
operator|.
name|v
operator|.
name|a
operator|.
name|addr
operator|=
name|sn
operator|->
name|addr
expr_stmt|;
name|print_addr
argument_list|(
operator|&
name|aw
argument_list|,
name|sn
operator|->
name|af
argument_list|,
name|opts
operator|&
name|PF_OPT_VERBOSE2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -> "
argument_list|)
expr_stmt|;
name|aw
operator|.
name|v
operator|.
name|a
operator|.
name|addr
operator|=
name|sn
operator|->
name|raddr
expr_stmt|;
name|print_addr
argument_list|(
operator|&
name|aw
argument_list|,
name|sn
operator|->
name|af
argument_list|,
name|opts
operator|&
name|PF_OPT_VERBOSE2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" (%d states)\n"
argument_list|,
name|sn
operator|->
name|states
argument_list|)
expr_stmt|;
if|if
condition|(
name|opts
operator|&
name|PF_OPT_VERBOSE
condition|)
block|{
name|sec
operator|=
name|sn
operator|->
name|creation
operator|%
literal|60
expr_stmt|;
name|sn
operator|->
name|creation
operator|/=
literal|60
expr_stmt|;
name|min
operator|=
name|sn
operator|->
name|creation
operator|%
literal|60
expr_stmt|;
name|sn
operator|->
name|creation
operator|/=
literal|60
expr_stmt|;
name|printf
argument_list|(
literal|"   age %.2u:%.2u:%.2u"
argument_list|,
name|sn
operator|->
name|creation
argument_list|,
name|min
argument_list|,
name|sec
argument_list|)
expr_stmt|;
if|if
condition|(
name|sn
operator|->
name|states
operator|==
literal|0
condition|)
block|{
name|sec
operator|=
name|sn
operator|->
name|expire
operator|%
literal|60
expr_stmt|;
name|sn
operator|->
name|expire
operator|/=
literal|60
expr_stmt|;
name|min
operator|=
name|sn
operator|->
name|expire
operator|%
literal|60
expr_stmt|;
name|sn
operator|->
name|expire
operator|/=
literal|60
expr_stmt|;
name|printf
argument_list|(
literal|", expires in %.2u:%.2u:%.2u"
argument_list|,
name|sn
operator|->
name|expire
argument_list|,
name|min
argument_list|,
name|sec
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|", %u pkts, %u bytes"
argument_list|,
name|sn
operator|->
name|packets
argument_list|,
name|sn
operator|->
name|bytes
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sn
operator|->
name|ruletype
condition|)
block|{
case|case
name|PF_NAT
case|:
if|if
condition|(
name|sn
operator|->
name|rule
operator|.
name|nr
operator|!=
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|", nat rule %u"
argument_list|,
name|sn
operator|->
name|rule
operator|.
name|nr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_RDR
case|:
if|if
condition|(
name|sn
operator|->
name|rule
operator|.
name|nr
operator|!=
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|", rdr rule %u"
argument_list|,
name|sn
operator|->
name|rule
operator|.
name|nr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_PASS
case|:
if|if
condition|(
name|sn
operator|->
name|rule
operator|.
name|nr
operator|!=
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|", filter rule %u"
argument_list|,
name|sn
operator|->
name|rule
operator|.
name|nr
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|print_rule
parameter_list|(
name|struct
name|pf_rule
modifier|*
name|r
parameter_list|,
name|int
name|verbose
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|actiontypes
index|[]
init|=
block|{
literal|"pass"
block|,
literal|"block"
block|,
literal|"scrub"
block|,
literal|"nat"
block|,
literal|"no nat"
block|,
literal|"binat"
block|,
literal|"no binat"
block|,
literal|"rdr"
block|,
literal|"no rdr"
block|}
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|anchortypes
index|[]
init|=
block|{
literal|"anchor"
block|,
literal|"anchor"
block|,
literal|"anchor"
block|,
literal|"nat-anchor"
block|,
literal|"nat-anchor"
block|,
literal|"binat-anchor"
block|,
literal|"binat-anchor"
block|,
literal|"rdr-anchor"
block|,
literal|"rdr-anchor"
block|}
decl_stmt|;
name|int
name|i
decl_stmt|,
name|opts
decl_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"@%d "
argument_list|,
name|r
operator|->
name|nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|action
operator|>
name|PF_NORDR
condition|)
name|printf
argument_list|(
literal|"action(%d)"
argument_list|,
name|r
operator|->
name|action
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|anchorname
index|[
literal|0
index|]
condition|)
name|printf
argument_list|(
literal|"%s %s"
argument_list|,
name|anchortypes
index|[
name|r
operator|->
name|action
index|]
argument_list|,
name|r
operator|->
name|anchorname
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|actiontypes
index|[
name|r
operator|->
name|action
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|natpass
condition|)
name|printf
argument_list|(
literal|" pass"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|action
operator|==
name|PF_DROP
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RETURN
condition|)
name|printf
argument_list|(
literal|" return"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RETURNRST
condition|)
block|{
if|if
condition|(
operator|!
name|r
operator|->
name|return_ttl
condition|)
name|printf
argument_list|(
literal|" return-rst"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" return-rst(ttl %d)"
argument_list|,
name|r
operator|->
name|return_ttl
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RETURNICMP
condition|)
block|{
specifier|const
name|struct
name|icmpcodeent
modifier|*
name|ic
decl_stmt|,
modifier|*
name|ic6
decl_stmt|;
name|ic
operator|=
name|geticmpcodebynumber
argument_list|(
name|r
operator|->
name|return_icmp
operator|>>
literal|8
argument_list|,
name|r
operator|->
name|return_icmp
operator|&
literal|255
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
name|ic6
operator|=
name|geticmpcodebynumber
argument_list|(
name|r
operator|->
name|return_icmp6
operator|>>
literal|8
argument_list|,
name|r
operator|->
name|return_icmp6
operator|&
literal|255
argument_list|,
name|AF_INET6
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|r
operator|->
name|af
condition|)
block|{
case|case
name|AF_INET
case|:
name|printf
argument_list|(
literal|" return-icmp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"(%u)"
argument_list|,
name|r
operator|->
name|return_icmp
operator|&
literal|255
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"(%s)"
argument_list|,
name|ic
operator|->
name|name
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|printf
argument_list|(
literal|" return-icmp6"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic6
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"(%u)"
argument_list|,
name|r
operator|->
name|return_icmp6
operator|&
literal|255
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"(%s)"
argument_list|,
name|ic6
operator|->
name|name
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|" return-icmp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"(%u, "
argument_list|,
name|r
operator|->
name|return_icmp
operator|&
literal|255
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"(%s, "
argument_list|,
name|ic
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic6
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"%u)"
argument_list|,
name|r
operator|->
name|return_icmp6
operator|&
literal|255
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s)"
argument_list|,
name|ic6
operator|->
name|name
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
name|printf
argument_list|(
literal|" drop"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|direction
operator|==
name|PF_IN
condition|)
name|printf
argument_list|(
literal|" in"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|direction
operator|==
name|PF_OUT
condition|)
name|printf
argument_list|(
literal|" out"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|log
operator|==
literal|1
condition|)
name|printf
argument_list|(
literal|" log"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|log
operator|==
literal|2
condition|)
name|printf
argument_list|(
literal|" log-all"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|quick
condition|)
name|printf
argument_list|(
literal|" quick"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|ifname
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|ifnot
condition|)
name|printf
argument_list|(
literal|" on ! %s"
argument_list|,
name|r
operator|->
name|ifname
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" on %s"
argument_list|,
name|r
operator|->
name|ifname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|rt
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|rt
operator|==
name|PF_ROUTETO
condition|)
name|printf
argument_list|(
literal|" route-to"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|rt
operator|==
name|PF_REPLYTO
condition|)
name|printf
argument_list|(
literal|" reply-to"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|rt
operator|==
name|PF_DUPTO
condition|)
name|printf
argument_list|(
literal|" dup-to"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|rt
operator|==
name|PF_FASTROUTE
condition|)
name|printf
argument_list|(
literal|" fastroute"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|rt
operator|!=
name|PF_FASTROUTE
condition|)
block|{
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|print_pool
argument_list|(
operator|&
name|r
operator|->
name|rpool
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|r
operator|->
name|af
argument_list|,
name|PF_PASS
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|r
operator|->
name|af
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|af
operator|==
name|AF_INET
condition|)
name|printf
argument_list|(
literal|" inet"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" inet6"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|proto
condition|)
block|{
name|struct
name|protoent
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|getprotobynumber
argument_list|(
name|r
operator|->
name|proto
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|" proto %s"
argument_list|,
name|p
operator|->
name|p_name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" proto %u"
argument_list|,
name|r
operator|->
name|proto
argument_list|)
expr_stmt|;
block|}
name|print_fromto
argument_list|(
operator|&
name|r
operator|->
name|src
argument_list|,
name|r
operator|->
name|os_fingerprint
argument_list|,
operator|&
name|r
operator|->
name|dst
argument_list|,
name|r
operator|->
name|af
argument_list|,
name|r
operator|->
name|proto
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|uid
operator|.
name|op
condition|)
name|print_ugid
argument_list|(
name|r
operator|->
name|uid
operator|.
name|op
argument_list|,
name|r
operator|->
name|uid
operator|.
name|uid
index|[
literal|0
index|]
argument_list|,
name|r
operator|->
name|uid
operator|.
name|uid
index|[
literal|1
index|]
argument_list|,
literal|"user"
argument_list|,
name|UID_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|gid
operator|.
name|op
condition|)
name|print_ugid
argument_list|(
name|r
operator|->
name|gid
operator|.
name|op
argument_list|,
name|r
operator|->
name|gid
operator|.
name|gid
index|[
literal|0
index|]
argument_list|,
name|r
operator|->
name|gid
operator|.
name|gid
index|[
literal|1
index|]
argument_list|,
literal|"group"
argument_list|,
name|GID_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|flags
operator|||
name|r
operator|->
name|flagset
condition|)
block|{
name|printf
argument_list|(
literal|" flags "
argument_list|)
expr_stmt|;
name|print_flags
argument_list|(
name|r
operator|->
name|flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"/"
argument_list|)
expr_stmt|;
name|print_flags
argument_list|(
name|r
operator|->
name|flagset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|type
condition|)
block|{
specifier|const
name|struct
name|icmptypeent
modifier|*
name|it
decl_stmt|;
name|it
operator|=
name|geticmptypebynumber
argument_list|(
name|r
operator|->
name|type
operator|-
literal|1
argument_list|,
name|r
operator|->
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|af
operator|!=
name|AF_INET6
condition|)
name|printf
argument_list|(
literal|" icmp-type"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" icmp6-type"
argument_list|)
expr_stmt|;
if|if
condition|(
name|it
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|it
operator|->
name|name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" %u"
argument_list|,
name|r
operator|->
name|type
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|code
condition|)
block|{
specifier|const
name|struct
name|icmpcodeent
modifier|*
name|ic
decl_stmt|;
name|ic
operator|=
name|geticmpcodebynumber
argument_list|(
name|r
operator|->
name|type
operator|-
literal|1
argument_list|,
name|r
operator|->
name|code
operator|-
literal|1
argument_list|,
name|r
operator|->
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|" code %s"
argument_list|,
name|ic
operator|->
name|name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" code %u"
argument_list|,
name|r
operator|->
name|code
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|r
operator|->
name|tos
condition|)
name|printf
argument_list|(
literal|" tos 0x%2.2x"
argument_list|,
name|r
operator|->
name|tos
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|keep_state
operator|==
name|PF_STATE_NORMAL
condition|)
name|printf
argument_list|(
literal|" keep state"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|keep_state
operator|==
name|PF_STATE_MODULATE
condition|)
name|printf
argument_list|(
literal|" modulate state"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|keep_state
operator|==
name|PF_STATE_SYNPROXY
condition|)
name|printf
argument_list|(
literal|" synproxy state"
argument_list|)
expr_stmt|;
name|opts
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|max_states
operator|||
name|r
operator|->
name|max_src_nodes
operator|||
name|r
operator|->
name|max_src_states
condition|)
name|opts
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_NOSYNC
condition|)
name|opts
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_SRCTRACK
condition|)
name|opts
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
operator|(
name|PFRULE_IFBOUND
operator||
name|PFRULE_GRBOUND
operator|)
condition|)
name|opts
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|opts
operator|&&
name|i
operator|<
name|PFTM_MAX
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|r
operator|->
name|timeout
index|[
name|i
index|]
condition|)
name|opts
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|opts
condition|)
block|{
name|printf
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|max_states
condition|)
block|{
name|printf
argument_list|(
literal|"max %u"
argument_list|,
name|r
operator|->
name|max_states
argument_list|)
expr_stmt|;
name|opts
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_NOSYNC
condition|)
block|{
if|if
condition|(
operator|!
name|opts
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"no-sync"
argument_list|)
expr_stmt|;
name|opts
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_SRCTRACK
condition|)
block|{
if|if
condition|(
operator|!
name|opts
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"source-track"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RULESRCTRACK
condition|)
name|printf
argument_list|(
literal|" rule"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" global"
argument_list|)
expr_stmt|;
name|opts
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|max_src_states
condition|)
block|{
if|if
condition|(
operator|!
name|opts
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"max-src-states %u"
argument_list|,
name|r
operator|->
name|max_src_states
argument_list|)
expr_stmt|;
name|opts
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|max_src_nodes
condition|)
block|{
if|if
condition|(
operator|!
name|opts
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"max-src-nodes %u"
argument_list|,
name|r
operator|->
name|max_src_nodes
argument_list|)
expr_stmt|;
name|opts
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_IFBOUND
condition|)
block|{
if|if
condition|(
operator|!
name|opts
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"if-bound"
argument_list|)
expr_stmt|;
name|opts
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_GRBOUND
condition|)
block|{
if|if
condition|(
operator|!
name|opts
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"group-bound"
argument_list|)
expr_stmt|;
name|opts
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PFTM_MAX
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|r
operator|->
name|timeout
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
operator|!
name|opts
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|opts
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"%s %u"
argument_list|,
name|pf_timeouts
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|r
operator|->
name|timeout
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_FRAGMENT
condition|)
name|printf
argument_list|(
literal|" fragment"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_NODF
condition|)
name|printf
argument_list|(
literal|" no-df"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RANDOMID
condition|)
name|printf
argument_list|(
literal|" random-id"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|min_ttl
condition|)
name|printf
argument_list|(
literal|" min-ttl %d"
argument_list|,
name|r
operator|->
name|min_ttl
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|max_mss
condition|)
name|printf
argument_list|(
literal|" max-mss %d"
argument_list|,
name|r
operator|->
name|max_mss
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|allow_opts
condition|)
name|printf
argument_list|(
literal|" allow-opts"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|action
operator|==
name|PF_SCRUB
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_REASSEMBLE_TCP
condition|)
name|printf
argument_list|(
literal|" reassemble tcp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_FRAGDROP
condition|)
name|printf
argument_list|(
literal|" fragment drop-ovl"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_FRAGCROP
condition|)
name|printf
argument_list|(
literal|" fragment crop"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" fragment reassemble"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|label
index|[
literal|0
index|]
condition|)
name|printf
argument_list|(
literal|" label \"%s\""
argument_list|,
name|r
operator|->
name|label
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|qname
index|[
literal|0
index|]
operator|&&
name|r
operator|->
name|pqname
index|[
literal|0
index|]
condition|)
name|printf
argument_list|(
literal|" queue(%s, %s)"
argument_list|,
name|r
operator|->
name|qname
argument_list|,
name|r
operator|->
name|pqname
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|qname
index|[
literal|0
index|]
condition|)
name|printf
argument_list|(
literal|" queue %s"
argument_list|,
name|r
operator|->
name|qname
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|tagname
index|[
literal|0
index|]
condition|)
name|printf
argument_list|(
literal|" tag %s"
argument_list|,
name|r
operator|->
name|tagname
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|match_tagname
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|match_tag_not
condition|)
name|printf
argument_list|(
literal|" !"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" tagged %s"
argument_list|,
name|r
operator|->
name|match_tagname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|r
operator|->
name|anchorname
index|[
literal|0
index|]
operator|&&
operator|(
name|r
operator|->
name|action
operator|==
name|PF_NAT
operator|||
name|r
operator|->
name|action
operator|==
name|PF_BINAT
operator|||
name|r
operator|->
name|action
operator|==
name|PF_RDR
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|" -> "
argument_list|)
expr_stmt|;
name|print_pool
argument_list|(
operator|&
name|r
operator|->
name|rpool
argument_list|,
name|r
operator|->
name|rpool
operator|.
name|proxy_port
index|[
literal|0
index|]
argument_list|,
name|r
operator|->
name|rpool
operator|.
name|proxy_port
index|[
literal|1
index|]
argument_list|,
name|r
operator|->
name|af
argument_list|,
name|r
operator|->
name|action
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|print_tabledef
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|addrs
parameter_list|,
name|struct
name|node_tinithead
modifier|*
name|nodes
parameter_list|)
block|{
name|struct
name|node_tinit
modifier|*
name|ti
decl_stmt|,
modifier|*
name|nti
decl_stmt|;
name|struct
name|node_host
modifier|*
name|h
decl_stmt|;
name|printf
argument_list|(
literal|"table<%s>"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|PFR_TFLAG_CONST
condition|)
name|printf
argument_list|(
literal|" const"
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|PFR_TFLAG_PERSIST
condition|)
name|printf
argument_list|(
literal|" persist"
argument_list|)
expr_stmt|;
name|SIMPLEQ_FOREACH
argument_list|(
argument|ti
argument_list|,
argument|nodes
argument_list|,
argument|entries
argument_list|)
block|{
if|if
condition|(
name|ti
operator|->
name|file
condition|)
block|{
name|printf
argument_list|(
literal|" file \"%s\""
argument_list|,
name|ti
operator|->
name|file
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|printf
argument_list|(
literal|" {"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
for|for
control|(
name|h
operator|=
name|ti
operator|->
name|host
init|;
name|h
operator|!=
name|NULL
condition|;
name|h
operator|=
name|h
operator|->
name|next
control|)
block|{
name|printf
argument_list|(
name|h
operator|->
name|not
condition|?
literal|" !"
else|:
literal|" "
argument_list|)
expr_stmt|;
name|print_addr
argument_list|(
operator|&
name|h
operator|->
name|addr
argument_list|,
name|h
operator|->
name|af
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|nti
operator|=
name|SIMPLEQ_NEXT
argument_list|(
name|ti
argument_list|,
name|entries
argument_list|)
expr_stmt|;
if|if
condition|(
name|nti
operator|!=
name|NULL
operator|&&
name|nti
operator|->
name|file
operator|==
name|NULL
condition|)
name|ti
operator|=
name|nti
expr_stmt|;
comment|/* merge lists */
else|else
break|break;
block|}
name|printf
argument_list|(
literal|" }"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|addrs
operator|&&
name|SIMPLEQ_EMPTY
argument_list|(
name|nodes
argument_list|)
condition|)
name|printf
argument_list|(
literal|" { }"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|parse_flags
parameter_list|(
name|char
modifier|*
name|s
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|u_int8_t
name|f
init|=
literal|0
decl_stmt|;
for|for
control|(
name|p
operator|=
name|s
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|q
operator|=
name|strchr
argument_list|(
name|tcpflags
argument_list|,
operator|*
name|p
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
else|else
name|f
operator||=
literal|1
operator|<<
operator|(
name|q
operator|-
name|tcpflags
operator|)
expr_stmt|;
block|}
return|return
operator|(
name|f
condition|?
name|f
else|:
name|PF_TH_ALL
operator|)
return|;
block|}
end_function

begin_function
name|void
name|set_ipmask
parameter_list|(
name|struct
name|node_host
modifier|*
name|h
parameter_list|,
name|u_int8_t
name|b
parameter_list|)
block|{
name|struct
name|pf_addr
modifier|*
name|m
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|;
name|m
operator|=
operator|&
name|h
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|m
operator|->
name|addr32
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|b
operator|>=
literal|32
condition|)
block|{
name|m
operator|->
name|addr32
index|[
name|j
operator|++
index|]
operator|=
literal|0xffffffff
expr_stmt|;
name|b
operator|-=
literal|32
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|31
init|;
name|i
operator|>
literal|31
operator|-
name|b
condition|;
operator|--
name|i
control|)
name|m
operator|->
name|addr32
index|[
name|j
index|]
operator||=
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
name|b
condition|)
name|m
operator|->
name|addr32
index|[
name|j
index|]
operator|=
name|htonl
argument_list|(
name|m
operator|->
name|addr32
index|[
name|j
index|]
argument_list|)
expr_stmt|;
comment|/* Mask off bits of the address that will never be used. */
name|n
operator|=
operator|&
name|h
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
expr_stmt|;
if|if
condition|(
name|h
operator|->
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_ADDRMASK
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|n
operator|->
name|addr32
index|[
name|i
index|]
operator|=
name|n
operator|->
name|addr32
index|[
name|i
index|]
operator|&
name|m
operator|->
name|addr32
index|[
name|i
index|]
expr_stmt|;
block|}
end_function

begin_function
name|int
name|check_netmask
parameter_list|(
name|struct
name|node_host
modifier|*
name|h
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|struct
name|node_host
modifier|*
name|n
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_addr
modifier|*
name|m
decl_stmt|;
for|for
control|(
name|n
operator|=
name|h
init|;
name|n
operator|!=
name|NULL
condition|;
name|n
operator|=
name|n
operator|->
name|next
control|)
block|{
if|if
condition|(
name|h
operator|->
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_TABLE
condition|)
continue|continue;
name|m
operator|=
operator|&
name|h
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
expr_stmt|;
comment|/* fix up netmask for dynaddr */
if|if
condition|(
name|af
operator|==
name|AF_INET
operator|&&
name|h
operator|->
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_DYNIFTL
operator|&&
name|unmask
argument_list|(
name|m
argument_list|,
name|AF_INET6
argument_list|)
operator|>
literal|32
condition|)
name|set_ipmask
argument_list|(
name|n
argument_list|,
literal|32
argument_list|)
expr_stmt|;
comment|/* netmasks> 32 bit are invalid on v4 */
if|if
condition|(
name|af
operator|==
name|AF_INET
operator|&&
operator|(
name|m
operator|->
name|addr32
index|[
literal|1
index|]
operator|||
name|m
operator|->
name|addr32
index|[
literal|2
index|]
operator|||
name|m
operator|->
name|addr32
index|[
literal|3
index|]
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"netmask %u invalid for IPv4 address\n"
argument_list|,
name|unmask
argument_list|(
name|m
argument_list|,
name|AF_INET6
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* interface lookup routines */
end_comment

begin_decl_stmt
name|struct
name|node_host
modifier|*
name|iftab
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|ifa_load
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|ifaddrs
modifier|*
name|ifap
decl_stmt|,
modifier|*
name|ifa
decl_stmt|;
name|struct
name|node_host
modifier|*
name|n
init|=
name|NULL
decl_stmt|,
modifier|*
name|h
init|=
name|NULL
decl_stmt|;
name|struct
name|pfr_buffer
name|b
decl_stmt|;
name|struct
name|pfi_if
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|getifaddrs
argument_list|(
operator|&
name|ifap
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"getifaddrs"
argument_list|)
expr_stmt|;
for|for
control|(
name|ifa
operator|=
name|ifap
init|;
name|ifa
condition|;
name|ifa
operator|=
name|ifa
operator|->
name|ifa_next
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|==
name|AF_INET
operator|||
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|==
name|AF_INET6
operator|||
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|==
name|AF_LINK
operator|)
condition|)
continue|continue;
name|n
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|node_host
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"address: calloc"
argument_list|)
expr_stmt|;
name|n
operator|->
name|af
operator|=
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
expr_stmt|;
name|n
operator|->
name|ifa_flags
operator|=
name|ifa
operator|->
name|ifa_flags
expr_stmt|;
ifdef|#
directive|ifdef
name|__KAME__
if|if
condition|(
name|n
operator|->
name|af
operator|==
name|AF_INET6
operator|&&
name|IN6_IS_ADDR_LINKLOCAL
argument_list|(
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|ifa
operator|->
name|ifa_addr
operator|)
operator|->
name|sin6_addr
argument_list|)
operator|&&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|ifa
operator|->
name|ifa_addr
operator|)
operator|->
name|sin6_scope_id
operator|==
literal|0
condition|)
block|{
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|ifa
operator|->
name|ifa_addr
expr_stmt|;
name|sin6
operator|->
name|sin6_scope_id
operator|=
name|sin6
operator|->
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|2
index|]
operator|<<
literal|8
operator||
name|sin6
operator|->
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|3
index|]
expr_stmt|;
name|sin6
operator|->
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|sin6
operator|->
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
name|n
operator|->
name|ifindex
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|n
operator|->
name|af
operator|==
name|AF_INET
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|ifa
operator|->
name|ifa_addr
operator|)
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|ifa
operator|->
name|ifa_netmask
operator|)
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifa
operator|->
name|ifa_broadaddr
operator|!=
name|NULL
condition|)
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|bcast
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|ifa
operator|->
name|ifa_broadaddr
operator|)
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifa
operator|->
name|ifa_dstaddr
operator|!=
name|NULL
condition|)
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|peer
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|ifa
operator|->
name|ifa_dstaddr
operator|)
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|n
operator|->
name|af
operator|==
name|AF_INET6
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|ifa
operator|->
name|ifa_addr
operator|)
operator|->
name|sin6_addr
operator|.
name|s6_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|ifa
operator|->
name|ifa_netmask
operator|)
operator|->
name|sin6_addr
operator|.
name|s6_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifa
operator|->
name|ifa_broadaddr
operator|!=
name|NULL
condition|)
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|bcast
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|ifa
operator|->
name|ifa_broadaddr
operator|)
operator|->
name|sin6_addr
operator|.
name|s6_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifa
operator|->
name|ifa_dstaddr
operator|!=
name|NULL
condition|)
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|peer
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|ifa
operator|->
name|ifa_dstaddr
operator|)
operator|->
name|sin6_addr
operator|.
name|s6_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|->
name|ifindex
operator|=
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|ifa
operator|->
name|ifa_addr
operator|)
operator|->
name|sin6_scope_id
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|n
operator|->
name|ifname
operator|=
name|strdup
argument_list|(
name|ifa
operator|->
name|ifa_name
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ifa_load: strdup"
argument_list|)
expr_stmt|;
name|n
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|n
operator|->
name|tail
operator|=
name|n
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
name|h
operator|=
name|n
expr_stmt|;
else|else
block|{
name|h
operator|->
name|tail
operator|->
name|next
operator|=
name|n
expr_stmt|;
name|h
operator|->
name|tail
operator|=
name|n
expr_stmt|;
block|}
block|}
comment|/* add interface groups, including clonable and dynamic stuff */
name|bzero
argument_list|(
operator|&
name|b
argument_list|,
sizeof|sizeof
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|b
operator|.
name|pfrb_type
operator|=
name|PFRB_IFACES
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|pfr_buf_grow
argument_list|(
operator|&
name|b
argument_list|,
name|b
operator|.
name|pfrb_size
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ifa_load: pfr_buf_grow"
argument_list|)
expr_stmt|;
name|b
operator|.
name|pfrb_size
operator|=
name|b
operator|.
name|pfrb_msize
expr_stmt|;
if|if
condition|(
name|pfi_get_ifaces
argument_list|(
name|NULL
argument_list|,
name|b
operator|.
name|pfrb_caddr
argument_list|,
operator|&
name|b
operator|.
name|pfrb_size
argument_list|,
name|PFI_FLAG_GROUP
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ifa_load: pfi_get_ifaces"
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|.
name|pfrb_size
operator|<=
name|b
operator|.
name|pfrb_msize
condition|)
break|break;
block|}
name|PFRB_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&b
argument_list|)
block|{
name|n
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|node_host
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"address: calloc"
argument_list|)
expr_stmt|;
name|n
operator|->
name|af
operator|=
name|AF_LINK
expr_stmt|;
name|n
operator|->
name|ifa_flags
operator|=
name|PF_IFA_FLAG_GROUP
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|pfif_flags
operator|&
name|PFI_IFLAG_DYNAMIC
condition|)
name|n
operator|->
name|ifa_flags
operator||=
name|PF_IFA_FLAG_DYNAMIC
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|pfif_flags
operator|&
name|PFI_IFLAG_CLONABLE
condition|)
name|n
operator|->
name|ifa_flags
operator||=
name|PF_IFA_FLAG_CLONABLE
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p
operator|->
name|pfif_name
argument_list|,
literal|"lo"
argument_list|)
condition|)
name|n
operator|->
name|ifa_flags
operator||=
name|IFF_LOOPBACK
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|->
name|ifname
operator|=
name|strdup
argument_list|(
name|p
operator|->
name|pfif_name
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ifa_load: strdup"
argument_list|)
expr_stmt|;
name|n
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|n
operator|->
name|tail
operator|=
name|n
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
name|h
operator|=
name|n
expr_stmt|;
else|else
block|{
name|h
operator|->
name|tail
operator|->
name|next
operator|=
name|n
expr_stmt|;
name|h
operator|->
name|tail
operator|=
name|n
expr_stmt|;
block|}
block|}
name|iftab
operator|=
name|h
expr_stmt|;
name|freeifaddrs
argument_list|(
name|ifap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|node_host
modifier|*
name|ifa_exists
parameter_list|(
specifier|const
name|char
modifier|*
name|ifa_name
parameter_list|,
name|int
name|group_ok
parameter_list|)
block|{
name|struct
name|node_host
modifier|*
name|n
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
name|buf
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|int
name|group
decl_stmt|;
name|group
operator|=
operator|!
name|isdigit
argument_list|(
name|ifa_name
index|[
name|strlen
argument_list|(
name|ifa_name
argument_list|)
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|&&
operator|!
name|group_ok
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|iftab
operator|==
name|NULL
condition|)
name|ifa_load
argument_list|()
expr_stmt|;
for|for
control|(
name|n
operator|=
name|iftab
init|;
name|n
condition|;
name|n
operator|=
name|n
operator|->
name|next
control|)
block|{
if|if
condition|(
name|n
operator|->
name|af
operator|==
name|AF_LINK
operator|&&
operator|!
name|strncmp
argument_list|(
name|n
operator|->
name|ifname
argument_list|,
name|ifa_name
argument_list|,
name|IFNAMSIZ
argument_list|)
condition|)
return|return
operator|(
name|n
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|group
condition|)
block|{
comment|/* look for clonable and/or dynamic interface */
name|strlcpy
argument_list|(
name|buf
argument_list|,
name|ifa_name
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
init|;
name|p
operator|>
name|buf
operator|&&
name|isdigit
argument_list|(
operator|*
name|p
argument_list|)
condition|;
name|p
operator|--
control|)
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|n
operator|=
name|iftab
init|;
name|n
operator|!=
name|NULL
condition|;
name|n
operator|=
name|n
operator|->
name|next
control|)
if|if
condition|(
name|n
operator|->
name|af
operator|==
name|AF_LINK
operator|&&
operator|!
name|strncmp
argument_list|(
name|n
operator|->
name|ifname
argument_list|,
name|buf
argument_list|,
name|IFNAMSIZ
argument_list|)
condition|)
break|break;
if|if
condition|(
name|n
operator|!=
name|NULL
operator|&&
name|n
operator|->
name|ifa_flags
operator|&
operator|(
name|PF_IFA_FLAG_DYNAMIC
operator||
name|PF_IFA_FLAG_CLONABLE
operator|)
condition|)
return|return
operator|(
name|n
operator|)
return|;
comment|/* XXX */
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|node_host
modifier|*
name|ifa_lookup
parameter_list|(
specifier|const
name|char
modifier|*
name|ifa_name
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|node_host
modifier|*
name|p
init|=
name|NULL
decl_stmt|,
modifier|*
name|h
init|=
name|NULL
decl_stmt|,
modifier|*
name|n
init|=
name|NULL
decl_stmt|;
name|int
name|return_all
init|=
literal|0
decl_stmt|,
name|got4
init|=
literal|0
decl_stmt|,
name|got6
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|last_if
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|ifa_name
argument_list|,
literal|"self"
argument_list|,
name|IFNAMSIZ
argument_list|)
condition|)
name|return_all
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|iftab
operator|==
name|NULL
condition|)
name|ifa_load
argument_list|()
expr_stmt|;
for|for
control|(
name|p
operator|=
name|iftab
init|;
name|p
condition|;
name|p
operator|=
name|p
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|p
operator|->
name|af
operator|==
name|AF_INET
operator|||
name|p
operator|->
name|af
operator|==
name|AF_INET6
operator|)
operator|&&
operator|(
operator|!
name|strncmp
argument_list|(
name|p
operator|->
name|ifname
argument_list|,
name|ifa_name
argument_list|,
name|strlen
argument_list|(
name|ifa_name
argument_list|)
argument_list|)
operator|||
name|return_all
operator|)
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|flags
operator|&
name|PFI_AFLAG_BROADCAST
operator|)
operator|&&
name|p
operator|->
name|af
operator|!=
name|AF_INET
condition|)
continue|continue;
if|if
condition|(
operator|(
name|flags
operator|&
name|PFI_AFLAG_BROADCAST
operator|)
operator|&&
operator|!
operator|(
name|p
operator|->
name|ifa_flags
operator|&
name|IFF_BROADCAST
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|flags
operator|&
name|PFI_AFLAG_PEER
operator|)
operator|&&
operator|!
operator|(
name|p
operator|->
name|ifa_flags
operator|&
name|IFF_POINTOPOINT
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|flags
operator|&
name|PFI_AFLAG_NETWORK
operator|)
operator|&&
name|p
operator|->
name|ifindex
operator|>
literal|0
condition|)
continue|continue;
if|if
condition|(
name|last_if
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|last_if
argument_list|,
name|p
operator|->
name|ifname
argument_list|)
condition|)
name|got4
operator|=
name|got6
operator|=
literal|0
expr_stmt|;
name|last_if
operator|=
name|p
operator|->
name|ifname
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|PFI_AFLAG_NOALIAS
operator|)
operator|&&
name|p
operator|->
name|af
operator|==
name|AF_INET
operator|&&
name|got4
condition|)
continue|continue;
if|if
condition|(
operator|(
name|flags
operator|&
name|PFI_AFLAG_NOALIAS
operator|)
operator|&&
name|p
operator|->
name|af
operator|==
name|AF_INET6
operator|&&
name|got6
condition|)
continue|continue;
if|if
condition|(
name|p
operator|->
name|af
operator|==
name|AF_INET
condition|)
name|got4
operator|=
literal|1
expr_stmt|;
else|else
name|got6
operator|=
literal|1
expr_stmt|;
name|n
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|node_host
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"address: calloc"
argument_list|)
expr_stmt|;
name|n
operator|->
name|af
operator|=
name|p
operator|->
name|af
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|PFI_AFLAG_BROADCAST
condition|)
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
operator|&
name|p
operator|->
name|bcast
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pf_addr
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|flags
operator|&
name|PFI_AFLAG_PEER
condition|)
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
operator|&
name|p
operator|->
name|peer
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pf_addr
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
operator|&
name|p
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pf_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|PFI_AFLAG_NETWORK
condition|)
name|set_ipmask
argument_list|(
name|n
argument_list|,
name|unmask
argument_list|(
operator|&
name|p
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
name|n
operator|->
name|af
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|n
operator|->
name|af
operator|==
name|AF_INET
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|ifa_flags
operator|&
name|IFF_LOOPBACK
operator|&&
name|p
operator|->
name|ifa_flags
operator|&
name|IFF_LINK1
condition|)
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
operator|&
name|p
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pf_addr
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|set_ipmask
argument_list|(
name|n
argument_list|,
literal|32
argument_list|)
expr_stmt|;
block|}
else|else
name|set_ipmask
argument_list|(
name|n
argument_list|,
literal|128
argument_list|)
expr_stmt|;
block|}
name|n
operator|->
name|ifindex
operator|=
name|p
operator|->
name|ifindex
expr_stmt|;
name|n
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|n
operator|->
name|tail
operator|=
name|n
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
name|h
operator|=
name|n
expr_stmt|;
else|else
block|{
name|h
operator|->
name|tail
operator|->
name|next
operator|=
name|n
expr_stmt|;
name|h
operator|->
name|tail
operator|=
name|n
expr_stmt|;
block|}
block|}
return|return
operator|(
name|h
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|node_host
modifier|*
name|host
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|)
block|{
name|struct
name|node_host
modifier|*
name|h
init|=
name|NULL
decl_stmt|;
name|int
name|mask
decl_stmt|,
name|v4mask
decl_stmt|,
name|v6mask
decl_stmt|,
name|cont
init|=
literal|1
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|,
modifier|*
name|ps
decl_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|strrchr
argument_list|(
name|s
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|mask
operator|=
name|strtol
argument_list|(
name|p
operator|+
literal|1
argument_list|,
operator|&
name|q
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|q
operator|||
operator|*
name|q
operator|||
name|mask
operator|>
literal|128
operator|||
name|q
operator|==
operator|(
name|p
operator|+
literal|1
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid netmask\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|ps
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|s
argument_list|)
operator|-
name|strlen
argument_list|(
name|p
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"host: malloc"
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ps
argument_list|,
name|s
argument_list|,
name|strlen
argument_list|(
name|s
argument_list|)
operator|-
name|strlen
argument_list|(
name|p
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|v4mask
operator|=
name|v6mask
operator|=
name|mask
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|ps
operator|=
name|strdup
argument_list|(
name|s
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"host: strdup"
argument_list|)
expr_stmt|;
name|v4mask
operator|=
literal|32
expr_stmt|;
name|v6mask
operator|=
literal|128
expr_stmt|;
name|mask
operator|=
operator|-
literal|1
expr_stmt|;
block|}
comment|/* interface with this name exists? */
if|if
condition|(
name|cont
operator|&&
operator|(
name|h
operator|=
name|host_if
argument_list|(
name|ps
argument_list|,
name|mask
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|cont
operator|=
literal|0
expr_stmt|;
comment|/* IPv4 address? */
if|if
condition|(
name|cont
operator|&&
operator|(
name|h
operator|=
name|host_v4
argument_list|(
name|s
argument_list|,
name|mask
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|cont
operator|=
literal|0
expr_stmt|;
comment|/* IPv6 address? */
if|if
condition|(
name|cont
operator|&&
operator|(
name|h
operator|=
name|host_v6
argument_list|(
name|ps
argument_list|,
name|v6mask
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|cont
operator|=
literal|0
expr_stmt|;
comment|/* dns lookup */
if|if
condition|(
name|cont
operator|&&
operator|(
name|h
operator|=
name|host_dns
argument_list|(
name|ps
argument_list|,
name|v4mask
argument_list|,
name|v6mask
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|cont
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|ps
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
operator|||
name|cont
operator|==
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"no IP address found for %s\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
name|h
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|node_host
modifier|*
name|host_if
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|int
name|mask
parameter_list|)
block|{
name|struct
name|node_host
modifier|*
name|n
decl_stmt|,
modifier|*
name|h
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|ps
decl_stmt|;
name|int
name|flags
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|ps
operator|=
name|strdup
argument_list|(
name|s
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"host_if: strdup"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|p
operator|=
name|strrchr
argument_list|(
name|ps
argument_list|,
literal|':'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p
operator|+
literal|1
argument_list|,
literal|"network"
argument_list|)
condition|)
name|flags
operator||=
name|PFI_AFLAG_NETWORK
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p
operator|+
literal|1
argument_list|,
literal|"broadcast"
argument_list|)
condition|)
name|flags
operator||=
name|PFI_AFLAG_BROADCAST
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p
operator|+
literal|1
argument_list|,
literal|"peer"
argument_list|)
condition|)
name|flags
operator||=
name|PFI_AFLAG_PEER
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p
operator|+
literal|1
argument_list|,
literal|"0"
argument_list|)
condition|)
name|flags
operator||=
name|PFI_AFLAG_NOALIAS
expr_stmt|;
else|else
block|{
name|free
argument_list|(
name|ps
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
operator|(
name|flags
operator|-
literal|1
operator|)
operator|&
name|PFI_AFLAG_MODEMASK
condition|)
block|{
comment|/* Yep! */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"illegal combination of interface modifiers\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ps
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|flags
operator|&
operator|(
name|PFI_AFLAG_NETWORK
operator||
name|PFI_AFLAG_BROADCAST
operator|)
operator|)
operator|&&
name|mask
operator|>
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"network or broadcast lookup, but "
literal|"extra netmask given\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ps
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|ifa_exists
argument_list|(
name|ps
argument_list|,
literal|1
argument_list|)
operator|||
operator|!
name|strncmp
argument_list|(
name|ps
argument_list|,
literal|"self"
argument_list|,
name|IFNAMSIZ
argument_list|)
condition|)
block|{
comment|/* interface with this name exists */
name|h
operator|=
name|ifa_lookup
argument_list|(
name|ps
argument_list|,
name|flags
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
name|h
init|;
name|n
operator|!=
name|NULL
operator|&&
name|mask
operator|>
operator|-
literal|1
condition|;
name|n
operator|=
name|n
operator|->
name|next
control|)
name|set_ipmask
argument_list|(
name|n
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|ps
argument_list|)
expr_stmt|;
return|return
operator|(
name|h
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|node_host
modifier|*
name|host_v4
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|int
name|mask
parameter_list|)
block|{
name|struct
name|node_host
modifier|*
name|h
init|=
name|NULL
decl_stmt|;
name|struct
name|in_addr
name|ina
decl_stmt|;
name|int
name|bits
init|=
literal|32
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ina
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strrchr
argument_list|(
name|s
argument_list|,
literal|'/'
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|bits
operator|=
name|inet_net_pton
argument_list|(
name|AF_INET
argument_list|,
name|s
argument_list|,
operator|&
name|ina
argument_list|,
sizeof|sizeof
argument_list|(
name|ina
argument_list|)
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET
argument_list|,
name|s
argument_list|,
operator|&
name|ina
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|h
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|node_host
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"address: calloc"
argument_list|)
expr_stmt|;
name|h
operator|->
name|ifname
operator|=
name|NULL
expr_stmt|;
name|h
operator|->
name|af
operator|=
name|AF_INET
expr_stmt|;
name|h
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|=
name|ina
operator|.
name|s_addr
expr_stmt|;
name|set_ipmask
argument_list|(
name|h
argument_list|,
name|bits
argument_list|)
expr_stmt|;
name|h
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|h
operator|->
name|tail
operator|=
name|h
expr_stmt|;
return|return
operator|(
name|h
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|node_host
modifier|*
name|host_v6
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|int
name|mask
parameter_list|)
block|{
name|struct
name|addrinfo
name|hints
decl_stmt|,
modifier|*
name|res
decl_stmt|;
name|struct
name|node_host
modifier|*
name|h
init|=
name|NULL
decl_stmt|;
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_family
operator|=
name|AF_INET6
expr_stmt|;
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_DGRAM
expr_stmt|;
comment|/*dummy*/
name|hints
operator|.
name|ai_flags
operator|=
name|AI_NUMERICHOST
expr_stmt|;
if|if
condition|(
name|getaddrinfo
argument_list|(
name|s
argument_list|,
literal|"0"
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res
argument_list|)
operator|==
literal|0
condition|)
block|{
name|h
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|node_host
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"address: calloc"
argument_list|)
expr_stmt|;
name|h
operator|->
name|ifname
operator|=
name|NULL
expr_stmt|;
name|h
operator|->
name|af
operator|=
name|AF_INET6
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|h
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|res
operator|->
name|ai_addr
operator|)
operator|->
name|sin6_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|h
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|h
operator|->
name|ifindex
operator|=
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|res
operator|->
name|ai_addr
operator|)
operator|->
name|sin6_scope_id
expr_stmt|;
name|set_ipmask
argument_list|(
name|h
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|freeaddrinfo
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|h
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|h
operator|->
name|tail
operator|=
name|h
expr_stmt|;
block|}
return|return
operator|(
name|h
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|node_host
modifier|*
name|host_dns
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|int
name|v4mask
parameter_list|,
name|int
name|v6mask
parameter_list|)
block|{
name|struct
name|addrinfo
name|hints
decl_stmt|,
modifier|*
name|res0
decl_stmt|,
modifier|*
name|res
decl_stmt|;
name|struct
name|node_host
modifier|*
name|n
decl_stmt|,
modifier|*
name|h
init|=
name|NULL
decl_stmt|;
name|int
name|error
decl_stmt|,
name|noalias
init|=
literal|0
decl_stmt|;
name|int
name|got4
init|=
literal|0
decl_stmt|,
name|got6
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|ps
decl_stmt|;
if|if
condition|(
operator|(
name|ps
operator|=
name|strdup
argument_list|(
name|s
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"host_if: strdup"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|strrchr
argument_list|(
name|ps
argument_list|,
literal|':'
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|!
name|strcmp
argument_list|(
name|p
argument_list|,
literal|":0"
argument_list|)
condition|)
block|{
name|noalias
operator|=
literal|1
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_family
operator|=
name|PF_UNSPEC
expr_stmt|;
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_STREAM
expr_stmt|;
comment|/* DUMMY */
name|error
operator|=
name|getaddrinfo
argument_list|(
name|ps
argument_list|,
name|NULL
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|h
operator|)
return|;
for|for
control|(
name|res
operator|=
name|res0
init|;
name|res
condition|;
name|res
operator|=
name|res
operator|->
name|ai_next
control|)
block|{
if|if
condition|(
name|res
operator|->
name|ai_family
operator|!=
name|AF_INET
operator|&&
name|res
operator|->
name|ai_family
operator|!=
name|AF_INET6
condition|)
continue|continue;
if|if
condition|(
name|noalias
condition|)
block|{
if|if
condition|(
name|res
operator|->
name|ai_family
operator|==
name|AF_INET
condition|)
block|{
if|if
condition|(
name|got4
condition|)
continue|continue;
name|got4
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|got6
condition|)
continue|continue;
name|got6
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|n
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|node_host
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"host_dns: calloc"
argument_list|)
expr_stmt|;
name|n
operator|->
name|ifname
operator|=
name|NULL
expr_stmt|;
name|n
operator|->
name|af
operator|=
name|res
operator|->
name|ai_family
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|ai_family
operator|==
name|AF_INET
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|res
operator|->
name|ai_addr
operator|)
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|set_ipmask
argument_list|(
name|n
argument_list|,
name|v4mask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
operator|&
name|n
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|res
operator|->
name|ai_addr
operator|)
operator|->
name|sin6_addr
operator|.
name|s6_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|->
name|ifindex
operator|=
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|res
operator|->
name|ai_addr
operator|)
operator|->
name|sin6_scope_id
expr_stmt|;
name|set_ipmask
argument_list|(
name|n
argument_list|,
name|v6mask
argument_list|)
expr_stmt|;
block|}
name|n
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|n
operator|->
name|tail
operator|=
name|n
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
name|h
operator|=
name|n
expr_stmt|;
else|else
block|{
name|h
operator|->
name|tail
operator|->
name|next
operator|=
name|n
expr_stmt|;
name|h
operator|->
name|tail
operator|=
name|n
expr_stmt|;
block|}
block|}
name|freeaddrinfo
argument_list|(
name|res0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ps
argument_list|)
expr_stmt|;
return|return
operator|(
name|h
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * convert a hostname to a list of addresses and put them in the given buffer.  * test:  *	if set to 1, only simple addresses are accepted (no netblock, no "!").  */
end_comment

begin_function
name|int
name|append_addr
parameter_list|(
name|struct
name|pfr_buffer
modifier|*
name|b
parameter_list|,
name|char
modifier|*
name|s
parameter_list|,
name|int
name|test
parameter_list|)
block|{
name|char
modifier|*
name|r
decl_stmt|;
name|struct
name|node_host
modifier|*
name|h
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|int
name|rv
decl_stmt|,
name|not
init|=
literal|0
decl_stmt|;
for|for
control|(
name|r
operator|=
name|s
init|;
operator|*
name|r
operator|==
literal|'!'
condition|;
name|r
operator|++
control|)
name|not
operator|=
operator|!
name|not
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
name|host
argument_list|(
name|r
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
literal|0
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|rv
operator|=
name|append_addr_host
argument_list|(
name|b
argument_list|,
name|n
argument_list|,
name|test
argument_list|,
name|not
argument_list|)
expr_stmt|;
do|do
block|{
name|h
operator|=
name|n
expr_stmt|;
name|n
operator|=
name|n
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|h
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|n
operator|!=
name|NULL
condition|)
do|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * same as previous function, but with a pre-parsed input and the ability  * to "negate" the result. Does not free the node_host list.  * not:  *      setting it to 1 is equivalent to adding "!" in front of parameter s.  */
end_comment

begin_function
name|int
name|append_addr_host
parameter_list|(
name|struct
name|pfr_buffer
modifier|*
name|b
parameter_list|,
name|struct
name|node_host
modifier|*
name|n
parameter_list|,
name|int
name|test
parameter_list|,
name|int
name|not
parameter_list|)
block|{
name|int
name|bits
decl_stmt|;
name|struct
name|pfr_addr
name|addr
decl_stmt|;
do|do
block|{
name|bzero
argument_list|(
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|pfra_not
operator|=
name|n
operator|->
name|not
operator|^
name|not
expr_stmt|;
name|addr
operator|.
name|pfra_af
operator|=
name|n
operator|->
name|af
expr_stmt|;
name|addr
operator|.
name|pfra_net
operator|=
name|unmask
argument_list|(
operator|&
name|n
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
name|n
operator|->
name|af
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|n
operator|->
name|af
condition|)
block|{
case|case
name|AF_INET
case|:
name|addr
operator|.
name|pfra_ip4addr
operator|.
name|s_addr
operator|=
name|n
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
expr_stmt|;
name|bits
operator|=
literal|32
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|memcpy
argument_list|(
operator|&
name|addr
operator|.
name|pfra_ip6addr
argument_list|,
operator|&
name|n
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
operator|.
name|v6
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|bits
operator|=
literal|128
expr_stmt|;
break|break;
default|default:
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|test
operator|&&
operator|(
name|not
operator|||
name|addr
operator|.
name|pfra_net
operator|!=
name|bits
operator|)
operator|)
operator|||
name|addr
operator|.
name|pfra_net
operator|>
name|bits
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|pfr_buf_add
argument_list|(
name|b
argument_list|,
operator|&
name|addr
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
do|while
condition|(
operator|(
name|n
operator|=
name|n
operator|->
name|next
operator|)
operator|!=
name|NULL
condition|)
do|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pfctl_add_trans
parameter_list|(
name|struct
name|pfr_buffer
modifier|*
name|buf
parameter_list|,
name|int
name|rs_num
parameter_list|,
specifier|const
name|char
modifier|*
name|anchor
parameter_list|,
specifier|const
name|char
modifier|*
name|ruleset
parameter_list|)
block|{
name|struct
name|pfioc_trans_e
name|trans
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|trans
argument_list|,
sizeof|sizeof
argument_list|(
name|trans
argument_list|)
argument_list|)
expr_stmt|;
name|trans
operator|.
name|rs_num
operator|=
name|rs_num
expr_stmt|;
if|if
condition|(
name|strlcpy
argument_list|(
name|trans
operator|.
name|anchor
argument_list|,
name|anchor
argument_list|,
sizeof|sizeof
argument_list|(
name|trans
operator|.
name|anchor
argument_list|)
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|trans
operator|.
name|anchor
argument_list|)
operator|||
name|strlcpy
argument_list|(
name|trans
operator|.
name|ruleset
argument_list|,
name|ruleset
argument_list|,
sizeof|sizeof
argument_list|(
name|trans
operator|.
name|ruleset
argument_list|)
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|trans
operator|.
name|ruleset
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"pfctl_add_trans: strlcpy"
argument_list|)
expr_stmt|;
return|return
name|pfr_buf_add
argument_list|(
name|buf
argument_list|,
operator|&
name|trans
argument_list|)
return|;
block|}
end_function

begin_function
name|u_int32_t
name|pfctl_get_ticket
parameter_list|(
name|struct
name|pfr_buffer
modifier|*
name|buf
parameter_list|,
name|int
name|rs_num
parameter_list|,
specifier|const
name|char
modifier|*
name|anchor
parameter_list|,
specifier|const
name|char
modifier|*
name|ruleset
parameter_list|)
block|{
name|struct
name|pfioc_trans_e
modifier|*
name|p
decl_stmt|;
name|PFRB_FOREACH
argument_list|(
argument|p
argument_list|,
argument|buf
argument_list|)
if|if
condition|(
name|rs_num
operator|==
name|p
operator|->
name|rs_num
operator|&&
operator|!
name|strcmp
argument_list|(
name|anchor
argument_list|,
name|p
operator|->
name|anchor
argument_list|)
operator|&&
operator|!
name|strcmp
argument_list|(
name|ruleset
argument_list|,
name|p
operator|->
name|ruleset
argument_list|)
condition|)
return|return
operator|(
name|p
operator|->
name|ticket
operator|)
return|;
name|errx
argument_list|(
literal|1
argument_list|,
literal|"pfr_get_ticket: assertion failed"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pfctl_trans
parameter_list|(
name|int
name|dev
parameter_list|,
name|struct
name|pfr_buffer
modifier|*
name|buf
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|int
name|from
parameter_list|)
block|{
name|struct
name|pfioc_trans
name|trans
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|trans
argument_list|,
sizeof|sizeof
argument_list|(
name|trans
argument_list|)
argument_list|)
expr_stmt|;
name|trans
operator|.
name|size
operator|=
name|buf
operator|->
name|pfrb_size
operator|-
name|from
expr_stmt|;
name|trans
operator|.
name|esize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|pfioc_trans_e
argument_list|)
expr_stmt|;
name|trans
operator|.
name|array
operator|=
operator|(
operator|(
expr|struct
name|pfioc_trans_e
operator|*
operator|)
name|buf
operator|->
name|pfrb_caddr
operator|)
operator|+
name|from
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|,
operator|&
name|trans
argument_list|)
return|;
block|}
end_function

end_unit


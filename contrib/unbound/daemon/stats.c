begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * daemon/stats.c - collect runtime performance indicators.  *  * Copyright (c) 2007, NLnet Labs. All rights reserved.  *  * This software is open source.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *   * Redistributions of source code must retain the above copyright notice,  * this list of conditions and the following disclaimer.  *   * Redistributions in binary form must reproduce the above copyright notice,  * this list of conditions and the following disclaimer in the documentation  * and/or other materials provided with the distribution.  *   * Neither the name of the NLNET LABS nor the names of its contributors may  * be used to endorse or promote products derived from this software without  * specific prior written permission.  *   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED  * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/**  * \file  *  * This file describes the data structure used to collect runtime performance  * numbers. These 'statistics' may be of interest to the operator.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_TIME_H
end_ifdef

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|"daemon/stats.h"
end_include

begin_include
include|#
directive|include
file|"daemon/worker.h"
end_include

begin_include
include|#
directive|include
file|"daemon/daemon.h"
end_include

begin_include
include|#
directive|include
file|"services/mesh.h"
end_include

begin_include
include|#
directive|include
file|"services/outside_network.h"
end_include

begin_include
include|#
directive|include
file|"services/listen_dnsport.h"
end_include

begin_include
include|#
directive|include
file|"util/config_file.h"
end_include

begin_include
include|#
directive|include
file|"util/tube.h"
end_include

begin_include
include|#
directive|include
file|"util/timehist.h"
end_include

begin_include
include|#
directive|include
file|"util/net_help.h"
end_include

begin_include
include|#
directive|include
file|"validator/validator.h"
end_include

begin_include
include|#
directive|include
file|"sldns/sbuffer.h"
end_include

begin_include
include|#
directive|include
file|"services/cache/rrset.h"
end_include

begin_include
include|#
directive|include
file|"services/cache/infra.h"
end_include

begin_include
include|#
directive|include
file|"validator/val_kcache.h"
end_include

begin_comment
comment|/** add timers and the values do not overflow or become negative */
end_comment

begin_function
specifier|static
name|void
name|timeval_add
parameter_list|(
name|struct
name|timeval
modifier|*
name|d
parameter_list|,
specifier|const
name|struct
name|timeval
modifier|*
name|add
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|S_SPLINT_S
name|d
operator|->
name|tv_sec
operator|+=
name|add
operator|->
name|tv_sec
expr_stmt|;
name|d
operator|->
name|tv_usec
operator|+=
name|add
operator|->
name|tv_usec
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|tv_usec
operator|>
literal|1000000
condition|)
block|{
name|d
operator|->
name|tv_usec
operator|-=
literal|1000000
expr_stmt|;
name|d
operator|->
name|tv_sec
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|server_stats_init
parameter_list|(
name|struct
name|server_stats
modifier|*
name|stats
parameter_list|,
name|struct
name|config_file
modifier|*
name|cfg
parameter_list|)
block|{
name|memset
argument_list|(
name|stats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|stats
argument_list|)
argument_list|)
expr_stmt|;
name|stats
operator|->
name|extended
operator|=
name|cfg
operator|->
name|stat_extended
expr_stmt|;
block|}
end_function

begin_function
name|void
name|server_stats_querymiss
parameter_list|(
name|struct
name|server_stats
modifier|*
name|stats
parameter_list|,
name|struct
name|worker
modifier|*
name|worker
parameter_list|)
block|{
name|stats
operator|->
name|num_queries_missed_cache
operator|++
expr_stmt|;
name|stats
operator|->
name|sum_query_list_size
operator|+=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|all
operator|.
name|count
expr_stmt|;
if|if
condition|(
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|all
operator|.
name|count
operator|>
name|stats
operator|->
name|max_query_list_size
condition|)
name|stats
operator|->
name|max_query_list_size
operator|=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|all
operator|.
name|count
expr_stmt|;
block|}
end_function

begin_function
name|void
name|server_stats_prefetch
parameter_list|(
name|struct
name|server_stats
modifier|*
name|stats
parameter_list|,
name|struct
name|worker
modifier|*
name|worker
parameter_list|)
block|{
name|stats
operator|->
name|num_queries_prefetch
operator|++
expr_stmt|;
comment|/* changes the query list size so account that, like a querymiss */
name|stats
operator|->
name|sum_query_list_size
operator|+=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|all
operator|.
name|count
expr_stmt|;
if|if
condition|(
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|all
operator|.
name|count
operator|>
name|stats
operator|->
name|max_query_list_size
condition|)
name|stats
operator|->
name|max_query_list_size
operator|=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|all
operator|.
name|count
expr_stmt|;
block|}
end_function

begin_function
name|void
name|server_stats_log
parameter_list|(
name|struct
name|server_stats
modifier|*
name|stats
parameter_list|,
name|struct
name|worker
modifier|*
name|worker
parameter_list|,
name|int
name|threadnum
parameter_list|)
block|{
name|log_info
argument_list|(
literal|"server stats for thread %d: %u queries, "
literal|"%u answers from cache, %u recursions, %u prefetch"
argument_list|,
name|threadnum
argument_list|,
operator|(
name|unsigned
operator|)
name|stats
operator|->
name|num_queries
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|stats
operator|->
name|num_queries
operator|-
name|stats
operator|->
name|num_queries_missed_cache
argument_list|)
argument_list|,
operator|(
name|unsigned
operator|)
name|stats
operator|->
name|num_queries_missed_cache
argument_list|,
operator|(
name|unsigned
operator|)
name|stats
operator|->
name|num_queries_prefetch
argument_list|)
expr_stmt|;
name|log_info
argument_list|(
literal|"server stats for thread %d: requestlist max %u avg %g "
literal|"exceeded %u jostled %u"
argument_list|,
name|threadnum
argument_list|,
operator|(
name|unsigned
operator|)
name|stats
operator|->
name|max_query_list_size
argument_list|,
operator|(
name|stats
operator|->
name|num_queries_missed_cache
operator|+
name|stats
operator|->
name|num_queries_prefetch
operator|)
condition|?
operator|(
name|double
operator|)
name|stats
operator|->
name|sum_query_list_size
operator|/
operator|(
name|stats
operator|->
name|num_queries_missed_cache
operator|+
name|stats
operator|->
name|num_queries_prefetch
operator|)
else|:
literal|0.0
argument_list|,
operator|(
name|unsigned
operator|)
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|stats_dropped
argument_list|,
operator|(
name|unsigned
operator|)
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|stats_jostled
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** get rrsets bogus number from validator */
end_comment

begin_function
specifier|static
name|size_t
name|get_rrset_bogus
parameter_list|(
name|struct
name|worker
modifier|*
name|worker
parameter_list|)
block|{
name|int
name|m
init|=
name|modstack_find
argument_list|(
operator|&
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|mods
argument_list|,
literal|"validator"
argument_list|)
decl_stmt|;
name|struct
name|val_env
modifier|*
name|ve
decl_stmt|;
name|size_t
name|r
decl_stmt|;
if|if
condition|(
name|m
operator|==
operator|-
literal|1
condition|)
return|return
literal|0
return|;
name|ve
operator|=
operator|(
expr|struct
name|val_env
operator|*
operator|)
name|worker
operator|->
name|env
operator|.
name|modinfo
index|[
name|m
index|]
expr_stmt|;
name|lock_basic_lock
argument_list|(
operator|&
name|ve
operator|->
name|bogus_lock
argument_list|)
expr_stmt|;
name|r
operator|=
name|ve
operator|->
name|num_rrset_bogus
expr_stmt|;
if|if
condition|(
operator|!
name|worker
operator|->
name|env
operator|.
name|cfg
operator|->
name|stat_cumulative
condition|)
name|ve
operator|->
name|num_rrset_bogus
operator|=
literal|0
expr_stmt|;
name|lock_basic_unlock
argument_list|(
operator|&
name|ve
operator|->
name|bogus_lock
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|void
name|server_stats_compile
parameter_list|(
name|struct
name|worker
modifier|*
name|worker
parameter_list|,
name|struct
name|stats_info
modifier|*
name|s
parameter_list|,
name|int
name|reset
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|listen_list
modifier|*
name|lp
decl_stmt|;
name|s
operator|->
name|svr
operator|=
name|worker
operator|->
name|stats
expr_stmt|;
name|s
operator|->
name|mesh_num_states
operator|=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|all
operator|.
name|count
expr_stmt|;
name|s
operator|->
name|mesh_num_reply_states
operator|=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|num_reply_states
expr_stmt|;
name|s
operator|->
name|mesh_jostled
operator|=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|stats_jostled
expr_stmt|;
name|s
operator|->
name|mesh_dropped
operator|=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|stats_dropped
expr_stmt|;
name|s
operator|->
name|mesh_replies_sent
operator|=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|replies_sent
expr_stmt|;
name|s
operator|->
name|mesh_replies_sum_wait
operator|=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|replies_sum_wait
expr_stmt|;
name|s
operator|->
name|mesh_time_median
operator|=
name|timehist_quartile
argument_list|(
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|histogram
argument_list|,
literal|0.50
argument_list|)
expr_stmt|;
comment|/* add in the values from the mesh */
name|s
operator|->
name|svr
operator|.
name|ans_secure
operator|+=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|ans_secure
expr_stmt|;
name|s
operator|->
name|svr
operator|.
name|ans_bogus
operator|+=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|ans_bogus
expr_stmt|;
name|s
operator|->
name|svr
operator|.
name|ans_rcode_nodata
operator|+=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|ans_nodata
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|s
operator|->
name|svr
operator|.
name|ans_rcode
index|[
name|i
index|]
operator|+=
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|ans_rcode
index|[
name|i
index|]
expr_stmt|;
name|timehist_export
argument_list|(
name|worker
operator|->
name|env
operator|.
name|mesh
operator|->
name|histogram
argument_list|,
name|s
operator|->
name|svr
operator|.
name|hist
argument_list|,
name|NUM_BUCKETS_HIST
argument_list|)
expr_stmt|;
comment|/* values from outside network */
name|s
operator|->
name|svr
operator|.
name|unwanted_replies
operator|=
name|worker
operator|->
name|back
operator|->
name|unwanted_replies
expr_stmt|;
name|s
operator|->
name|svr
operator|.
name|qtcp_outgoing
operator|=
name|worker
operator|->
name|back
operator|->
name|num_tcp_outgoing
expr_stmt|;
comment|/* get and reset validator rrset bogus number */
name|s
operator|->
name|svr
operator|.
name|rrset_bogus
operator|=
name|get_rrset_bogus
argument_list|(
name|worker
argument_list|)
expr_stmt|;
comment|/* get cache sizes */
name|s
operator|->
name|svr
operator|.
name|msg_cache_count
operator|=
name|count_slabhash_entries
argument_list|(
name|worker
operator|->
name|env
operator|.
name|msg_cache
argument_list|)
expr_stmt|;
name|s
operator|->
name|svr
operator|.
name|rrset_cache_count
operator|=
name|count_slabhash_entries
argument_list|(
operator|&
name|worker
operator|->
name|env
operator|.
name|rrset_cache
operator|->
name|table
argument_list|)
expr_stmt|;
name|s
operator|->
name|svr
operator|.
name|infra_cache_count
operator|=
name|count_slabhash_entries
argument_list|(
name|worker
operator|->
name|env
operator|.
name|infra_cache
operator|->
name|hosts
argument_list|)
expr_stmt|;
if|if
condition|(
name|worker
operator|->
name|env
operator|.
name|key_cache
condition|)
name|s
operator|->
name|svr
operator|.
name|key_cache_count
operator|=
name|count_slabhash_entries
argument_list|(
name|worker
operator|->
name|env
operator|.
name|key_cache
operator|->
name|slab
argument_list|)
expr_stmt|;
else|else
name|s
operator|->
name|svr
operator|.
name|key_cache_count
operator|=
literal|0
expr_stmt|;
comment|/* get tcp accept usage */
name|s
operator|->
name|svr
operator|.
name|tcp_accept_usage
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|lp
operator|=
name|worker
operator|->
name|front
operator|->
name|cps
init|;
name|lp
condition|;
name|lp
operator|=
name|lp
operator|->
name|next
control|)
block|{
if|if
condition|(
name|lp
operator|->
name|com
operator|->
name|type
operator|==
name|comm_tcp_accept
condition|)
name|s
operator|->
name|svr
operator|.
name|tcp_accept_usage
operator|+=
name|lp
operator|->
name|com
operator|->
name|cur_tcp_count
expr_stmt|;
block|}
if|if
condition|(
name|reset
operator|&&
operator|!
name|worker
operator|->
name|env
operator|.
name|cfg
operator|->
name|stat_cumulative
condition|)
block|{
name|worker_stats_clear
argument_list|(
name|worker
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|server_stats_obtain
parameter_list|(
name|struct
name|worker
modifier|*
name|worker
parameter_list|,
name|struct
name|worker
modifier|*
name|who
parameter_list|,
name|struct
name|stats_info
modifier|*
name|s
parameter_list|,
name|int
name|reset
parameter_list|)
block|{
name|uint8_t
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|len
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|worker
operator|==
name|who
condition|)
block|{
comment|/* just fill it in */
name|server_stats_compile
argument_list|(
name|worker
argument_list|,
name|s
argument_list|,
name|reset
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* communicate over tube */
name|verbose
argument_list|(
name|VERB_ALGO
argument_list|,
literal|"write stats cmd"
argument_list|)
expr_stmt|;
if|if
condition|(
name|reset
condition|)
name|worker_send_cmd
argument_list|(
name|who
argument_list|,
name|worker_cmd_stats
argument_list|)
expr_stmt|;
else|else
name|worker_send_cmd
argument_list|(
name|who
argument_list|,
name|worker_cmd_stats_noreset
argument_list|)
expr_stmt|;
name|verbose
argument_list|(
name|VERB_ALGO
argument_list|,
literal|"wait for stats reply"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tube_read_msg
argument_list|(
name|worker
operator|->
name|cmd
argument_list|,
operator|&
name|reply
argument_list|,
operator|&
name|len
argument_list|,
literal|0
argument_list|)
condition|)
name|fatal_exit
argument_list|(
literal|"failed to read stats over cmd channel"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
operator|(
name|uint32_t
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|s
argument_list|)
condition|)
name|fatal_exit
argument_list|(
literal|"stats on cmd channel wrong length %d %d"
argument_list|,
operator|(
name|int
operator|)
name|len
argument_list|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|s
argument_list|,
name|reply
argument_list|,
operator|(
name|size_t
operator|)
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|server_stats_reply
parameter_list|(
name|struct
name|worker
modifier|*
name|worker
parameter_list|,
name|int
name|reset
parameter_list|)
block|{
name|struct
name|stats_info
name|s
decl_stmt|;
name|server_stats_compile
argument_list|(
name|worker
argument_list|,
operator|&
name|s
argument_list|,
name|reset
argument_list|)
expr_stmt|;
name|verbose
argument_list|(
name|VERB_ALGO
argument_list|,
literal|"write stats replymsg"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tube_write_msg
argument_list|(
name|worker
operator|->
name|daemon
operator|->
name|workers
index|[
literal|0
index|]
operator|->
name|cmd
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|s
argument_list|,
sizeof|sizeof
argument_list|(
name|s
argument_list|)
argument_list|,
literal|0
argument_list|)
condition|)
name|fatal_exit
argument_list|(
literal|"could not write stat values over cmd channel"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|server_stats_add
parameter_list|(
name|struct
name|stats_info
modifier|*
name|total
parameter_list|,
name|struct
name|stats_info
modifier|*
name|a
parameter_list|)
block|{
name|total
operator|->
name|svr
operator|.
name|num_queries
operator|+=
name|a
operator|->
name|svr
operator|.
name|num_queries
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|num_queries_missed_cache
operator|+=
name|a
operator|->
name|svr
operator|.
name|num_queries_missed_cache
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|num_queries_prefetch
operator|+=
name|a
operator|->
name|svr
operator|.
name|num_queries_prefetch
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|sum_query_list_size
operator|+=
name|a
operator|->
name|svr
operator|.
name|sum_query_list_size
expr_stmt|;
comment|/* the max size reached is upped to higher of both */
if|if
condition|(
name|a
operator|->
name|svr
operator|.
name|max_query_list_size
operator|>
name|total
operator|->
name|svr
operator|.
name|max_query_list_size
condition|)
name|total
operator|->
name|svr
operator|.
name|max_query_list_size
operator|=
name|a
operator|->
name|svr
operator|.
name|max_query_list_size
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|svr
operator|.
name|extended
condition|)
block|{
name|int
name|i
decl_stmt|;
name|total
operator|->
name|svr
operator|.
name|qtype_big
operator|+=
name|a
operator|->
name|svr
operator|.
name|qtype_big
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qclass_big
operator|+=
name|a
operator|->
name|svr
operator|.
name|qclass_big
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qtcp
operator|+=
name|a
operator|->
name|svr
operator|.
name|qtcp
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qtcp_outgoing
operator|+=
name|a
operator|->
name|svr
operator|.
name|qtcp_outgoing
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qipv6
operator|+=
name|a
operator|->
name|svr
operator|.
name|qipv6
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qbit_QR
operator|+=
name|a
operator|->
name|svr
operator|.
name|qbit_QR
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qbit_AA
operator|+=
name|a
operator|->
name|svr
operator|.
name|qbit_AA
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qbit_TC
operator|+=
name|a
operator|->
name|svr
operator|.
name|qbit_TC
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qbit_RD
operator|+=
name|a
operator|->
name|svr
operator|.
name|qbit_RD
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qbit_RA
operator|+=
name|a
operator|->
name|svr
operator|.
name|qbit_RA
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qbit_Z
operator|+=
name|a
operator|->
name|svr
operator|.
name|qbit_Z
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qbit_AD
operator|+=
name|a
operator|->
name|svr
operator|.
name|qbit_AD
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qbit_CD
operator|+=
name|a
operator|->
name|svr
operator|.
name|qbit_CD
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qEDNS
operator|+=
name|a
operator|->
name|svr
operator|.
name|qEDNS
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|qEDNS_DO
operator|+=
name|a
operator|->
name|svr
operator|.
name|qEDNS_DO
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|ans_rcode_nodata
operator|+=
name|a
operator|->
name|svr
operator|.
name|ans_rcode_nodata
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|ans_secure
operator|+=
name|a
operator|->
name|svr
operator|.
name|ans_secure
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|ans_bogus
operator|+=
name|a
operator|->
name|svr
operator|.
name|ans_bogus
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|rrset_bogus
operator|+=
name|a
operator|->
name|svr
operator|.
name|rrset_bogus
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|unwanted_replies
operator|+=
name|a
operator|->
name|svr
operator|.
name|unwanted_replies
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|unwanted_queries
operator|+=
name|a
operator|->
name|svr
operator|.
name|unwanted_queries
expr_stmt|;
name|total
operator|->
name|svr
operator|.
name|tcp_accept_usage
operator|+=
name|a
operator|->
name|svr
operator|.
name|tcp_accept_usage
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|STATS_QTYPE_NUM
condition|;
name|i
operator|++
control|)
name|total
operator|->
name|svr
operator|.
name|qtype
index|[
name|i
index|]
operator|+=
name|a
operator|->
name|svr
operator|.
name|qtype
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|STATS_QCLASS_NUM
condition|;
name|i
operator|++
control|)
name|total
operator|->
name|svr
operator|.
name|qclass
index|[
name|i
index|]
operator|+=
name|a
operator|->
name|svr
operator|.
name|qclass
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|STATS_OPCODE_NUM
condition|;
name|i
operator|++
control|)
name|total
operator|->
name|svr
operator|.
name|qopcode
index|[
name|i
index|]
operator|+=
name|a
operator|->
name|svr
operator|.
name|qopcode
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|STATS_RCODE_NUM
condition|;
name|i
operator|++
control|)
name|total
operator|->
name|svr
operator|.
name|ans_rcode
index|[
name|i
index|]
operator|+=
name|a
operator|->
name|svr
operator|.
name|ans_rcode
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_BUCKETS_HIST
condition|;
name|i
operator|++
control|)
name|total
operator|->
name|svr
operator|.
name|hist
index|[
name|i
index|]
operator|+=
name|a
operator|->
name|svr
operator|.
name|hist
index|[
name|i
index|]
expr_stmt|;
block|}
name|total
operator|->
name|mesh_num_states
operator|+=
name|a
operator|->
name|mesh_num_states
expr_stmt|;
name|total
operator|->
name|mesh_num_reply_states
operator|+=
name|a
operator|->
name|mesh_num_reply_states
expr_stmt|;
name|total
operator|->
name|mesh_jostled
operator|+=
name|a
operator|->
name|mesh_jostled
expr_stmt|;
name|total
operator|->
name|mesh_dropped
operator|+=
name|a
operator|->
name|mesh_dropped
expr_stmt|;
name|total
operator|->
name|mesh_replies_sent
operator|+=
name|a
operator|->
name|mesh_replies_sent
expr_stmt|;
name|timeval_add
argument_list|(
operator|&
name|total
operator|->
name|mesh_replies_sum_wait
argument_list|,
operator|&
name|a
operator|->
name|mesh_replies_sum_wait
argument_list|)
expr_stmt|;
comment|/* the medians are averaged together, this is not as accurate as 	 * taking the median over all of the data, but is good and fast 	 * added up here, division later*/
name|total
operator|->
name|mesh_time_median
operator|+=
name|a
operator|->
name|mesh_time_median
expr_stmt|;
block|}
end_function

begin_function
name|void
name|server_stats_insquery
parameter_list|(
name|struct
name|server_stats
modifier|*
name|stats
parameter_list|,
name|struct
name|comm_point
modifier|*
name|c
parameter_list|,
name|uint16_t
name|qtype
parameter_list|,
name|uint16_t
name|qclass
parameter_list|,
name|struct
name|edns_data
modifier|*
name|edns
parameter_list|,
name|struct
name|comm_reply
modifier|*
name|repinfo
parameter_list|)
block|{
name|uint16_t
name|flags
init|=
name|sldns_buffer_read_u16_at
argument_list|(
name|c
operator|->
name|buffer
argument_list|,
literal|2
argument_list|)
decl_stmt|;
if|if
condition|(
name|qtype
operator|<
name|STATS_QTYPE_NUM
condition|)
name|stats
operator|->
name|qtype
index|[
name|qtype
index|]
operator|++
expr_stmt|;
else|else
name|stats
operator|->
name|qtype_big
operator|++
expr_stmt|;
if|if
condition|(
name|qclass
operator|<
name|STATS_QCLASS_NUM
condition|)
name|stats
operator|->
name|qclass
index|[
name|qclass
index|]
operator|++
expr_stmt|;
else|else
name|stats
operator|->
name|qclass_big
operator|++
expr_stmt|;
name|stats
operator|->
name|qopcode
index|[
name|LDNS_OPCODE_WIRE
argument_list|(
name|sldns_buffer_begin
argument_list|(
name|c
operator|->
name|buffer
argument_list|)
argument_list|)
index|]
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|comm_udp
condition|)
name|stats
operator|->
name|qtcp
operator|++
expr_stmt|;
if|if
condition|(
name|repinfo
operator|&&
name|addr_is_ip6
argument_list|(
operator|&
name|repinfo
operator|->
name|addr
argument_list|,
name|repinfo
operator|->
name|addrlen
argument_list|)
condition|)
name|stats
operator|->
name|qipv6
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|BIT_QR
operator|)
condition|)
name|stats
operator|->
name|qbit_QR
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|BIT_AA
operator|)
condition|)
name|stats
operator|->
name|qbit_AA
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|BIT_TC
operator|)
condition|)
name|stats
operator|->
name|qbit_TC
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|BIT_RD
operator|)
condition|)
name|stats
operator|->
name|qbit_RD
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|BIT_RA
operator|)
condition|)
name|stats
operator|->
name|qbit_RA
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|BIT_Z
operator|)
condition|)
name|stats
operator|->
name|qbit_Z
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|BIT_AD
operator|)
condition|)
name|stats
operator|->
name|qbit_AD
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|BIT_CD
operator|)
condition|)
name|stats
operator|->
name|qbit_CD
operator|++
expr_stmt|;
if|if
condition|(
name|edns
operator|->
name|edns_present
condition|)
block|{
name|stats
operator|->
name|qEDNS
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|edns
operator|->
name|bits
operator|&
name|EDNS_DO
operator|)
condition|)
name|stats
operator|->
name|qEDNS_DO
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|server_stats_insrcode
parameter_list|(
name|struct
name|server_stats
modifier|*
name|stats
parameter_list|,
name|sldns_buffer
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|stats
operator|->
name|extended
operator|&&
name|sldns_buffer_limit
argument_list|(
name|buf
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|int
name|r
init|=
operator|(
name|int
operator|)
name|LDNS_RCODE_WIRE
argument_list|(
name|sldns_buffer_begin
argument_list|(
name|buf
argument_list|)
argument_list|)
decl_stmt|;
name|stats
operator|->
name|ans_rcode
index|[
name|r
index|]
operator|++
expr_stmt|;
if|if
condition|(
name|r
operator|==
literal|0
operator|&&
name|LDNS_ANCOUNT
argument_list|(
name|sldns_buffer_begin
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|stats
operator|->
name|ans_rcode_nodata
operator|++
expr_stmt|;
block|}
block|}
end_function

end_unit


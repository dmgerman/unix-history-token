begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**  * str2wire.c - read txt presentation of RRs  *  * (c) NLnet Labs, 2005-2006  *  * See the file LICENSE for the license  */
end_comment

begin_comment
comment|/**  * \file  *  * Parses text to wireformat.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"ldns/str2wire.h"
end_include

begin_include
include|#
directive|include
file|"ldns/wire2str.h"
end_include

begin_include
include|#
directive|include
file|"ldns/sbuffer.h"
end_include

begin_include
include|#
directive|include
file|"ldns/parse.h"
end_include

begin_include
include|#
directive|include
file|"ldns/parseutil.h"
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_TIME_H
end_ifdef

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_NETDB_H
end_ifdef

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/** return an error */
end_comment

begin_define
define|#
directive|define
name|RET_ERR
parameter_list|(
name|e
parameter_list|,
name|off
parameter_list|)
value|((int)((e)|((off)<<LDNS_WIREPARSE_SHIFT)))
end_define

begin_comment
comment|/** Move parse error but keep its ID */
end_comment

begin_define
define|#
directive|define
name|RET_ERR_SHIFT
parameter_list|(
name|e
parameter_list|,
name|move
parameter_list|)
value|RET_ERR(LDNS_WIREPARSE_ERROR(e), LDNS_WIREPARSE_OFFSET(e)+(move));
end_define

begin_define
define|#
directive|define
name|LDNS_IP6ADDRLEN
value|(128/8)
end_define

begin_comment
comment|/*  * No special care is taken, all dots are translated into  * label separators.  * @param rel: true if the domain is not absolute (not terminated in .).  * 	The output is then still terminated with a '0' rootlabel.  */
end_comment

begin_function
specifier|static
name|int
name|sldns_str2wire_dname_buf_rel
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|olen
parameter_list|,
name|int
modifier|*
name|rel
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
specifier|const
name|char
modifier|*
name|s
decl_stmt|;
name|uint8_t
modifier|*
name|q
decl_stmt|,
modifier|*
name|pq
decl_stmt|,
name|label_len
decl_stmt|;
if|if
condition|(
name|rel
condition|)
operator|*
name|rel
operator|=
literal|0
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
operator|(
name|char
operator|*
operator|)
name|str
argument_list|)
expr_stmt|;
comment|/* octet representation can make strings a lot longer than actual length */
if|if
condition|(
name|len
operator|>
name|LDNS_MAX_DOMAINLEN
operator|*
literal|4
condition|)
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_DOMAINNAME_OVERFLOW
argument_list|,
literal|0
argument_list|)
return|;
block|}
if|if
condition|(
literal|0
operator|==
name|len
condition|)
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_DOMAINNAME_UNDERFLOW
argument_list|,
literal|0
argument_list|)
return|;
block|}
comment|/* root label */
if|if
condition|(
literal|1
operator|==
name|len
operator|&&
operator|*
name|str
operator|==
literal|'.'
condition|)
block|{
if|if
condition|(
operator|*
name|olen
operator|<
literal|1
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
literal|0
argument_list|)
return|;
name|buf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
operator|*
name|olen
operator|=
literal|1
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
comment|/* get on with the rest */
comment|/* s is on the current character in the string          * pq points to where the labellength is going to go          * label_len keeps track of the current label's length 	 * q builds the dname inside the buf array 	 */
name|len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|*
name|olen
operator|<
literal|1
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
literal|0
argument_list|)
return|;
name|q
operator|=
name|buf
operator|+
literal|1
expr_stmt|;
name|pq
operator|=
name|buf
expr_stmt|;
name|label_len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|s
operator|=
name|str
init|;
operator|*
name|s
condition|;
name|s
operator|++
operator|,
name|q
operator|++
control|)
block|{
if|if
condition|(
name|q
operator|>=
name|buf
operator|+
operator|*
name|olen
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|q
operator|-
name|buf
argument_list|)
return|;
if|if
condition|(
name|q
operator|>
name|buf
operator|+
name|LDNS_MAX_DOMAINLEN
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_DOMAINNAME_OVERFLOW
argument_list|,
name|q
operator|-
name|buf
argument_list|)
return|;
switch|switch
condition|(
operator|*
name|s
condition|)
block|{
case|case
literal|'.'
case|:
if|if
condition|(
name|label_len
operator|>
name|LDNS_MAX_LABELLEN
condition|)
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_LABEL_OVERFLOW
argument_list|,
name|q
operator|-
name|buf
argument_list|)
return|;
block|}
if|if
condition|(
name|label_len
operator|==
literal|0
condition|)
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_EMPTY_LABEL
argument_list|,
name|q
operator|-
name|buf
argument_list|)
return|;
block|}
name|len
operator|+=
name|label_len
operator|+
literal|1
expr_stmt|;
operator|*
name|q
operator|=
literal|0
expr_stmt|;
operator|*
name|pq
operator|=
name|label_len
expr_stmt|;
name|label_len
operator|=
literal|0
expr_stmt|;
name|pq
operator|=
name|q
expr_stmt|;
break|break;
case|case
literal|'\\'
case|:
comment|/* octet value or literal char */
name|s
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|sldns_parse_escape
argument_list|(
name|q
argument_list|,
operator|&
name|s
argument_list|)
condition|)
block|{
operator|*
name|q
operator|=
literal|0
expr_stmt|;
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_BAD_ESCAPE
argument_list|,
name|q
operator|-
name|buf
argument_list|)
return|;
block|}
name|s
operator|-=
literal|1
expr_stmt|;
name|label_len
operator|++
expr_stmt|;
break|break;
default|default:
operator|*
name|q
operator|=
operator|(
name|uint8_t
operator|)
operator|*
name|s
expr_stmt|;
name|label_len
operator|++
expr_stmt|;
block|}
block|}
comment|/* add root label if last char was not '.' */
if|if
condition|(
name|label_len
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|rel
condition|)
operator|*
name|rel
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|q
operator|>=
name|buf
operator|+
operator|*
name|olen
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|q
operator|-
name|buf
argument_list|)
return|;
if|if
condition|(
name|q
operator|>
name|buf
operator|+
name|LDNS_MAX_DOMAINLEN
condition|)
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_DOMAINNAME_OVERFLOW
argument_list|,
name|q
operator|-
name|buf
argument_list|)
return|;
block|}
if|if
condition|(
name|label_len
operator|>
name|LDNS_MAX_LABELLEN
condition|)
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_LABEL_OVERFLOW
argument_list|,
name|q
operator|-
name|buf
argument_list|)
return|;
block|}
if|if
condition|(
name|label_len
operator|==
literal|0
condition|)
block|{
comment|/* label_len 0 but not . at end? */
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_EMPTY_LABEL
argument_list|,
name|q
operator|-
name|buf
argument_list|)
return|;
block|}
name|len
operator|+=
name|label_len
operator|+
literal|1
expr_stmt|;
operator|*
name|pq
operator|=
name|label_len
expr_stmt|;
operator|*
name|q
operator|=
literal|0
expr_stmt|;
block|}
name|len
operator|++
expr_stmt|;
operator|*
name|olen
operator|=
name|len
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_dname_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
return|return
name|sldns_str2wire_dname_buf_rel
argument_list|(
name|str
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_dname_buf_origin
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|uint8_t
modifier|*
name|origin
parameter_list|,
name|size_t
name|origin_len
parameter_list|)
block|{
name|size_t
name|dlen
init|=
operator|*
name|len
decl_stmt|;
name|int
name|rel
init|=
literal|0
decl_stmt|;
name|int
name|s
init|=
name|sldns_str2wire_dname_buf_rel
argument_list|(
name|str
argument_list|,
name|buf
argument_list|,
operator|&
name|dlen
argument_list|,
operator|&
name|rel
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
condition|)
return|return
name|s
return|;
if|if
condition|(
name|rel
operator|&&
name|origin
operator|&&
name|dlen
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|dlen
operator|+
name|origin_len
operator|-
literal|1
operator|>
name|LDNS_MAX_DOMAINLEN
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_DOMAINNAME_OVERFLOW
argument_list|,
name|LDNS_MAX_DOMAINLEN
argument_list|)
return|;
if|if
condition|(
name|dlen
operator|+
name|origin_len
operator|-
literal|1
operator|>
operator|*
name|len
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
operator|*
name|len
argument_list|)
return|;
name|memmove
argument_list|(
name|buf
operator|+
name|dlen
operator|-
literal|1
argument_list|,
name|origin
argument_list|,
name|origin_len
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|dlen
operator|+
name|origin_len
operator|-
literal|1
expr_stmt|;
block|}
else|else
operator|*
name|len
operator|=
name|dlen
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|uint8_t
modifier|*
name|sldns_str2wire_dname
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|uint8_t
name|dname
index|[
name|LDNS_MAX_DOMAINLEN
operator|+
literal|1
index|]
decl_stmt|;
operator|*
name|len
operator|=
sizeof|sizeof
argument_list|(
name|dname
argument_list|)
expr_stmt|;
if|if
condition|(
name|sldns_str2wire_dname_buf
argument_list|(
name|str
argument_list|,
name|dname
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|uint8_t
modifier|*
name|r
init|=
operator|(
name|uint8_t
operator|*
operator|)
name|malloc
argument_list|(
operator|*
name|len
argument_list|)
decl_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|memcpy
argument_list|(
name|r
argument_list|,
name|dname
argument_list|,
operator|*
name|len
argument_list|)
return|;
block|}
operator|*
name|len
operator|=
literal|0
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/** read owner name */
end_comment

begin_function
specifier|static
name|int
name|rrinternal_get_owner
parameter_list|(
name|sldns_buffer
modifier|*
name|strbuf
parameter_list|,
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|size_t
modifier|*
name|dname_len
parameter_list|,
name|uint8_t
modifier|*
name|origin
parameter_list|,
name|size_t
name|origin_len
parameter_list|,
name|uint8_t
modifier|*
name|prev
parameter_list|,
name|size_t
name|prev_len
parameter_list|,
name|char
modifier|*
name|token
parameter_list|,
name|size_t
name|token_len
parameter_list|)
block|{
comment|/* split the rr in its parts -1 signals trouble */
if|if
condition|(
name|sldns_bget_token
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
literal|"\t\n "
argument_list|,
name|token_len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|token
argument_list|,
literal|"@"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|uint8_t
modifier|*
name|tocopy
decl_stmt|;
if|if
condition|(
name|origin
condition|)
block|{
operator|*
name|dname_len
operator|=
name|origin_len
expr_stmt|;
name|tocopy
operator|=
name|origin
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|prev
condition|)
block|{
operator|*
name|dname_len
operator|=
name|prev_len
expr_stmt|;
name|tocopy
operator|=
name|prev
expr_stmt|;
block|}
else|else
block|{
comment|/* default to root */
operator|*
name|dname_len
operator|=
literal|1
expr_stmt|;
name|tocopy
operator|=
operator|(
name|uint8_t
operator|*
operator|)
literal|"\0"
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|len
operator|<
operator|*
name|dname_len
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
name|memmove
argument_list|(
name|rr
argument_list|,
name|tocopy
argument_list|,
operator|*
name|dname_len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strlen
argument_list|(
name|token
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* no ownername was given, try prev, if that fails 		 * origin, else default to root */
name|uint8_t
modifier|*
name|tocopy
decl_stmt|;
if|if
condition|(
name|prev
condition|)
block|{
operator|*
name|dname_len
operator|=
name|prev_len
expr_stmt|;
name|tocopy
operator|=
name|prev
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|origin
condition|)
block|{
operator|*
name|dname_len
operator|=
name|origin_len
expr_stmt|;
name|tocopy
operator|=
name|origin
expr_stmt|;
block|}
else|else
block|{
operator|*
name|dname_len
operator|=
literal|1
expr_stmt|;
name|tocopy
operator|=
operator|(
name|uint8_t
operator|*
operator|)
literal|"\0"
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|len
operator|<
operator|*
name|dname_len
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
name|memmove
argument_list|(
name|rr
argument_list|,
name|tocopy
argument_list|,
operator|*
name|dname_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|size_t
name|dlen
init|=
operator|*
name|len
decl_stmt|;
name|int
name|s
init|=
name|sldns_str2wire_dname_buf_origin
argument_list|(
name|token
argument_list|,
name|rr
argument_list|,
operator|&
name|dlen
argument_list|,
name|origin
argument_list|,
name|origin_len
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
condition|)
return|return
name|RET_ERR_SHIFT
argument_list|(
name|s
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
operator|-
name|strlen
argument_list|(
name|token
argument_list|)
argument_list|)
return|;
operator|*
name|dname_len
operator|=
name|dlen
expr_stmt|;
block|}
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_comment
comment|/** read ttl */
end_comment

begin_function
specifier|static
name|int
name|rrinternal_get_ttl
parameter_list|(
name|sldns_buffer
modifier|*
name|strbuf
parameter_list|,
name|char
modifier|*
name|token
parameter_list|,
name|size_t
name|token_len
parameter_list|,
name|int
modifier|*
name|not_there
parameter_list|,
name|uint32_t
modifier|*
name|ttl
parameter_list|,
name|uint32_t
name|default_ttl
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|endptr
decl_stmt|;
if|if
condition|(
name|sldns_bget_token
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
literal|"\t\n "
argument_list|,
name|token_len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_TTL
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
operator|*
name|ttl
operator|=
operator|(
name|uint32_t
operator|)
name|sldns_str2period
argument_list|(
name|token
argument_list|,
operator|&
name|endptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|token
argument_list|)
operator|>
literal|0
operator|&&
operator|!
name|isdigit
argument_list|(
operator|(
name|int
operator|)
name|token
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
operator|*
name|not_there
operator|=
literal|1
expr_stmt|;
comment|/* ah, it's not there or something */
if|if
condition|(
name|default_ttl
operator|==
literal|0
condition|)
block|{
operator|*
name|ttl
operator|=
name|LDNS_DEFAULT_TTL
expr_stmt|;
block|}
else|else
block|{
operator|*
name|ttl
operator|=
name|default_ttl
expr_stmt|;
block|}
block|}
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_comment
comment|/** read class */
end_comment

begin_function
specifier|static
name|int
name|rrinternal_get_class
parameter_list|(
name|sldns_buffer
modifier|*
name|strbuf
parameter_list|,
name|char
modifier|*
name|token
parameter_list|,
name|size_t
name|token_len
parameter_list|,
name|int
modifier|*
name|not_there
parameter_list|,
name|uint16_t
modifier|*
name|cl
parameter_list|)
block|{
comment|/* if 'not_there' then we got token from previous parse routine */
if|if
condition|(
operator|!
operator|*
name|not_there
condition|)
block|{
comment|/* parse new token for class */
if|if
condition|(
name|sldns_bget_token
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
literal|"\t\n "
argument_list|,
name|token_len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_CLASS
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
block|}
else|else
operator|*
name|not_there
operator|=
literal|0
expr_stmt|;
operator|*
name|cl
operator|=
name|sldns_get_rr_class_by_name
argument_list|(
name|token
argument_list|)
expr_stmt|;
comment|/* class can be left out too, assume IN, current token must be type */
if|if
condition|(
operator|*
name|cl
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|token
argument_list|,
literal|"CLASS0"
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|*
name|not_there
operator|=
literal|1
expr_stmt|;
operator|*
name|cl
operator|=
name|LDNS_RR_CLASS_IN
expr_stmt|;
block|}
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_comment
comment|/** read type */
end_comment

begin_function
specifier|static
name|int
name|rrinternal_get_type
parameter_list|(
name|sldns_buffer
modifier|*
name|strbuf
parameter_list|,
name|char
modifier|*
name|token
parameter_list|,
name|size_t
name|token_len
parameter_list|,
name|int
modifier|*
name|not_there
parameter_list|,
name|uint16_t
modifier|*
name|tp
parameter_list|)
block|{
comment|/* if 'not_there' then we got token from previous parse routine */
if|if
condition|(
operator|!
operator|*
name|not_there
condition|)
block|{
comment|/* parse new token for type */
if|if
condition|(
name|sldns_bget_token
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
literal|"\t\n "
argument_list|,
name|token_len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_TYPE
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
block|}
operator|*
name|tp
operator|=
name|sldns_get_rr_type_by_name
argument_list|(
name|token
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|tp
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|token
argument_list|,
literal|"TYPE0"
argument_list|)
operator|!=
literal|0
condition|)
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_TYPE
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_comment
comment|/** put type, class, ttl into rr buffer */
end_comment

begin_function
specifier|static
name|int
name|rrinternal_write_typeclassttl
parameter_list|(
name|sldns_buffer
modifier|*
name|strbuf
parameter_list|,
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
name|len
parameter_list|,
name|size_t
name|dname_len
parameter_list|,
name|uint16_t
name|tp
parameter_list|,
name|uint16_t
name|cl
parameter_list|,
name|uint32_t
name|ttl
parameter_list|,
name|int
name|question
parameter_list|)
block|{
if|if
condition|(
name|question
condition|)
block|{
comment|/* question is : name, type, class */
if|if
condition|(
name|dname_len
operator|+
literal|4
operator|>
name|len
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
name|sldns_write_uint16
argument_list|(
name|rr
operator|+
name|dname_len
argument_list|,
name|tp
argument_list|)
expr_stmt|;
name|sldns_write_uint16
argument_list|(
name|rr
operator|+
name|dname_len
operator|+
literal|2
argument_list|,
name|cl
argument_list|)
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
comment|/* type(2), class(2), ttl(4), rdatalen(2 (later)) = 10 */
if|if
condition|(
name|dname_len
operator|+
literal|10
operator|>
name|len
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
name|sldns_write_uint16
argument_list|(
name|rr
operator|+
name|dname_len
argument_list|,
name|tp
argument_list|)
expr_stmt|;
name|sldns_write_uint16
argument_list|(
name|rr
operator|+
name|dname_len
operator|+
literal|2
argument_list|,
name|cl
argument_list|)
expr_stmt|;
name|sldns_write_uint32
argument_list|(
name|rr
operator|+
name|dname_len
operator|+
literal|4
argument_list|,
name|ttl
argument_list|)
expr_stmt|;
name|sldns_write_uint16
argument_list|(
name|rr
operator|+
name|dname_len
operator|+
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* rdatalen placeholder */
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_comment
comment|/** find delimiters for type */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|rrinternal_get_delims
parameter_list|(
name|sldns_rdf_type
name|rdftype
parameter_list|,
name|uint16_t
name|r_cnt
parameter_list|,
name|uint16_t
name|r_max
parameter_list|)
block|{
switch|switch
condition|(
name|rdftype
condition|)
block|{
case|case
name|LDNS_RDF_TYPE_B64
case|:
case|case
name|LDNS_RDF_TYPE_HEX
case|:
comment|/* These rdf types may con- */
case|case
name|LDNS_RDF_TYPE_LOC
case|:
comment|/* tain whitespace, only if */
case|case
name|LDNS_RDF_TYPE_WKS
case|:
comment|/* it is the last rd field. */
case|case
name|LDNS_RDF_TYPE_IPSECKEY
case|:
case|case
name|LDNS_RDF_TYPE_NSEC
case|:
if|if
condition|(
name|r_cnt
operator|==
name|r_max
operator|-
literal|1
condition|)
block|{
return|return
literal|"\n\t"
return|;
block|}
break|break;
default|default                       :
break|break;
block|}
return|return
literal|"\n\t "
return|;
block|}
end_function

begin_comment
comment|/* Syntactic sugar for sldns_rr_new_frm_str_internal */
end_comment

begin_function
specifier|static
name|int
name|sldns_rdf_type_maybe_quoted
parameter_list|(
name|sldns_rdf_type
name|rdf_type
parameter_list|)
block|{
return|return
name|rdf_type
operator|==
name|LDNS_RDF_TYPE_STR
operator|||
name|rdf_type
operator|==
name|LDNS_RDF_TYPE_LONG_STR
return|;
block|}
end_function

begin_comment
comment|/** see if rdata is quoted */
end_comment

begin_function
specifier|static
name|int
name|rrinternal_get_quoted
parameter_list|(
name|sldns_buffer
modifier|*
name|strbuf
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|delimiters
parameter_list|,
name|sldns_rdf_type
name|rdftype
parameter_list|)
block|{
if|if
condition|(
name|sldns_rdf_type_maybe_quoted
argument_list|(
name|rdftype
argument_list|)
operator|&&
name|sldns_buffer_remaining
argument_list|(
name|strbuf
argument_list|)
operator|>
literal|0
condition|)
block|{
comment|/* skip spaces */
while|while
condition|(
name|sldns_buffer_remaining
argument_list|(
name|strbuf
argument_list|)
operator|>
literal|0
operator|&&
operator|*
operator|(
name|sldns_buffer_current
argument_list|(
name|strbuf
argument_list|)
operator|)
operator|==
literal|' '
condition|)
block|{
name|sldns_buffer_skip
argument_list|(
name|strbuf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sldns_buffer_remaining
argument_list|(
name|strbuf
argument_list|)
operator|>
literal|0
operator|&&
operator|*
operator|(
name|sldns_buffer_current
argument_list|(
name|strbuf
argument_list|)
operator|)
operator|==
literal|'\"'
condition|)
block|{
operator|*
name|delimiters
operator|=
literal|"\"\0"
expr_stmt|;
name|sldns_buffer_skip
argument_list|(
name|strbuf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** spool hex data into rdata */
end_comment

begin_function
specifier|static
name|int
name|rrinternal_spool_hex
parameter_list|(
name|char
modifier|*
name|token
parameter_list|,
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
name|rr_len
parameter_list|,
name|size_t
name|rr_cur_len
parameter_list|,
name|size_t
modifier|*
name|cur_hex_data_size
parameter_list|,
name|size_t
name|hex_data_size
parameter_list|)
block|{
name|char
modifier|*
name|p
init|=
name|token
decl_stmt|;
while|while
condition|(
operator|*
name|p
condition|)
block|{
if|if
condition|(
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
block|{
name|p
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|isxdigit
argument_list|(
operator|*
name|p
argument_list|)
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_RDATA
argument_list|,
name|p
operator|-
name|token
argument_list|)
return|;
if|if
condition|(
operator|*
name|cur_hex_data_size
operator|>=
name|hex_data_size
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_RDATA
argument_list|,
name|p
operator|-
name|token
argument_list|)
return|;
comment|/* extra robust check */
if|if
condition|(
name|rr_cur_len
operator|+
operator|(
operator|*
name|cur_hex_data_size
operator|)
operator|/
literal|2
operator|>=
name|rr_len
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|p
operator|-
name|token
argument_list|)
return|;
comment|/* see if 16s or 1s */
if|if
condition|(
operator|(
operator|(
operator|*
name|cur_hex_data_size
operator|)
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|rr
index|[
name|rr_cur_len
operator|+
operator|(
operator|*
name|cur_hex_data_size
operator|)
operator|/
literal|2
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|sldns_hexdigit_to_int
argument_list|(
operator|*
name|p
argument_list|)
operator|*
literal|16
expr_stmt|;
block|}
else|else
block|{
name|rr
index|[
name|rr_cur_len
operator|+
operator|(
operator|*
name|cur_hex_data_size
operator|)
operator|/
literal|2
index|]
operator|+=
operator|(
name|uint8_t
operator|)
name|sldns_hexdigit_to_int
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
block|}
name|p
operator|++
expr_stmt|;
operator|(
operator|*
name|cur_hex_data_size
operator|)
operator|++
expr_stmt|;
block|}
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_comment
comment|/** read unknown rr type format */
end_comment

begin_function
specifier|static
name|int
name|rrinternal_parse_unknown
parameter_list|(
name|sldns_buffer
modifier|*
name|strbuf
parameter_list|,
name|char
modifier|*
name|token
parameter_list|,
name|size_t
name|token_len
parameter_list|,
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
modifier|*
name|rr_len
parameter_list|,
name|size_t
modifier|*
name|rr_cur_len
parameter_list|,
name|size_t
name|pre_data_pos
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|delim
init|=
literal|"\n\t "
decl_stmt|;
name|size_t
name|hex_data_size
decl_stmt|,
name|cur_hex_data_size
decl_stmt|;
comment|/* go back to before \# 	 * and skip it while setting delimiters better 	 */
name|sldns_buffer_set_position
argument_list|(
name|strbuf
argument_list|,
name|pre_data_pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|sldns_bget_token
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
name|delim
argument_list|,
name|token_len
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
name|LDNS_WIREPARSE_ERR_GENERAL
return|;
comment|/* should not fail */
comment|/* read rdata octet length */
if|if
condition|(
name|sldns_bget_token
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
name|delim
argument_list|,
name|token_len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* something goes very wrong here */
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_RDATA
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
name|hex_data_size
operator|=
operator|(
name|size_t
operator|)
name|atoi
argument_list|(
name|token
argument_list|)
expr_stmt|;
if|if
condition|(
name|hex_data_size
operator|>
name|LDNS_MAX_RDFLEN
operator|||
operator|*
name|rr_cur_len
operator|+
name|hex_data_size
operator|>
operator|*
name|rr_len
condition|)
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
comment|/* copy hex chars into hex str (2 chars per byte) */
name|hex_data_size
operator|*=
literal|2
expr_stmt|;
name|cur_hex_data_size
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|cur_hex_data_size
operator|<
name|hex_data_size
condition|)
block|{
name|int
name|status
decl_stmt|;
name|ssize_t
name|c
init|=
name|sldns_bget_token
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
name|delim
argument_list|,
name|token_len
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|rrinternal_spool_hex
argument_list|(
name|token
argument_list|,
name|rr
argument_list|,
operator|*
name|rr_len
argument_list|,
operator|*
name|rr_cur_len
argument_list|,
operator|&
name|cur_hex_data_size
argument_list|,
name|hex_data_size
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|RET_ERR_SHIFT
argument_list|(
name|status
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
operator|-
name|strlen
argument_list|(
name|token
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|c
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|cur_hex_data_size
operator|!=
name|hex_data_size
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_RDATA
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
break|break;
block|}
block|}
operator|*
name|rr_cur_len
operator|+=
name|hex_data_size
operator|/
literal|2
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_comment
comment|/** parse normal RR rdata element */
end_comment

begin_function
specifier|static
name|int
name|rrinternal_parse_rdf
parameter_list|(
name|sldns_buffer
modifier|*
name|strbuf
parameter_list|,
name|char
modifier|*
name|token
parameter_list|,
name|size_t
name|token_len
parameter_list|,
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
name|rr_len
parameter_list|,
name|size_t
modifier|*
name|rr_cur_len
parameter_list|,
name|sldns_rdf_type
name|rdftype
parameter_list|,
name|uint16_t
name|rr_type
parameter_list|,
name|uint16_t
name|r_cnt
parameter_list|,
name|uint16_t
name|r_max
parameter_list|,
name|size_t
name|dname_len
parameter_list|,
name|uint8_t
modifier|*
name|origin
parameter_list|,
name|size_t
name|origin_len
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|int
name|status
decl_stmt|;
switch|switch
condition|(
name|rdftype
condition|)
block|{
case|case
name|LDNS_RDF_TYPE_DNAME
case|:
comment|/* check if the origin should be used or concatenated */
if|if
condition|(
name|strcmp
argument_list|(
name|token
argument_list|,
literal|"@"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|uint8_t
modifier|*
name|tocopy
decl_stmt|;
name|size_t
name|copylen
decl_stmt|;
if|if
condition|(
name|origin
condition|)
block|{
name|copylen
operator|=
name|origin_len
expr_stmt|;
name|tocopy
operator|=
name|origin
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rr_type
operator|==
name|LDNS_RR_TYPE_SOA
condition|)
block|{
name|copylen
operator|=
name|dname_len
expr_stmt|;
name|tocopy
operator|=
name|rr
expr_stmt|;
comment|/* copy rr owner name */
block|}
else|else
block|{
name|copylen
operator|=
literal|1
expr_stmt|;
name|tocopy
operator|=
operator|(
name|uint8_t
operator|*
operator|)
literal|"\0"
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|*
name|rr_cur_len
operator|)
operator|+
name|copylen
operator|>
name|rr_len
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
name|memmove
argument_list|(
name|rr
operator|+
operator|*
name|rr_cur_len
argument_list|,
name|tocopy
argument_list|,
name|copylen
argument_list|)
expr_stmt|;
operator|(
operator|*
name|rr_cur_len
operator|)
operator|+=
name|copylen
expr_stmt|;
block|}
else|else
block|{
name|size_t
name|dlen
init|=
name|rr_len
operator|-
operator|(
operator|*
name|rr_cur_len
operator|)
decl_stmt|;
name|int
name|s
init|=
name|sldns_str2wire_dname_buf_origin
argument_list|(
name|token
argument_list|,
name|rr
operator|+
operator|*
name|rr_cur_len
argument_list|,
operator|&
name|dlen
argument_list|,
name|origin
argument_list|,
name|origin_len
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
condition|)
return|return
name|RET_ERR_SHIFT
argument_list|(
name|s
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
operator|-
name|strlen
argument_list|(
name|token
argument_list|)
argument_list|)
return|;
operator|(
operator|*
name|rr_cur_len
operator|)
operator|+=
name|dlen
expr_stmt|;
block|}
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
case|case
name|LDNS_RDF_TYPE_HEX
case|:
case|case
name|LDNS_RDF_TYPE_B64
case|:
comment|/* When this is the last rdata field, then the 		 * rest should be read in (cause then these 		 * rdf types may contain spaces). */
if|if
condition|(
name|r_cnt
operator|==
name|r_max
operator|-
literal|1
condition|)
block|{
name|size_t
name|tlen
init|=
name|strlen
argument_list|(
name|token
argument_list|)
decl_stmt|;
operator|(
name|void
operator|)
name|sldns_bget_token
argument_list|(
name|strbuf
argument_list|,
name|token
operator|+
name|tlen
argument_list|,
literal|"\n"
argument_list|,
name|token_len
operator|-
name|tlen
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
name|len
operator|=
name|rr_len
operator|-
operator|(
operator|*
name|rr_cur_len
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|sldns_str2wire_rdf_buf
argument_list|(
name|token
argument_list|,
name|rr
operator|+
operator|(
operator|*
name|rr_cur_len
operator|)
argument_list|,
operator|&
name|len
argument_list|,
name|rdftype
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|RET_ERR_SHIFT
argument_list|(
name|status
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
operator|-
name|strlen
argument_list|(
name|token
argument_list|)
argument_list|)
return|;
operator|*
name|rr_cur_len
operator|+=
name|len
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_comment
comment|/**  * Parse one rdf token.  Takes care of quotes and parenthesis.  */
end_comment

begin_function
specifier|static
name|int
name|sldns_parse_rdf_token
parameter_list|(
name|sldns_buffer
modifier|*
name|strbuf
parameter_list|,
name|char
modifier|*
name|token
parameter_list|,
name|size_t
name|token_len
parameter_list|,
name|int
modifier|*
name|quoted
parameter_list|,
name|int
modifier|*
name|parens
parameter_list|,
name|size_t
modifier|*
name|pre_data_pos
parameter_list|,
specifier|const
name|char
modifier|*
name|delimiters
parameter_list|,
name|sldns_rdf_type
name|rdftype
parameter_list|,
name|size_t
modifier|*
name|token_strlen
parameter_list|)
block|{
name|size_t
name|slen
decl_stmt|;
comment|/* skip spaces */
while|while
condition|(
name|sldns_buffer_remaining
argument_list|(
name|strbuf
argument_list|)
operator|>
literal|0
operator|&&
operator|!
operator|*
name|quoted
operator|&&
operator|*
operator|(
name|sldns_buffer_current
argument_list|(
name|strbuf
argument_list|)
operator|)
operator|==
literal|' '
condition|)
block|{
name|sldns_buffer_skip
argument_list|(
name|strbuf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
operator|*
name|pre_data_pos
operator|=
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|sldns_bget_token_par
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
operator|(
operator|*
name|quoted
operator|)
condition|?
literal|"\""
else|:
name|delimiters
argument_list|,
name|token_len
argument_list|,
name|parens
argument_list|,
operator|(
operator|*
name|quoted
operator|)
condition|?
name|NULL
else|:
literal|" \t"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
literal|0
return|;
block|}
name|slen
operator|=
name|strlen
argument_list|(
name|token
argument_list|)
expr_stmt|;
comment|/* check if not quoted yet, and we have encountered quotes */
if|if
condition|(
operator|!
operator|*
name|quoted
operator|&&
name|sldns_rdf_type_maybe_quoted
argument_list|(
name|rdftype
argument_list|)
operator|&&
name|slen
operator|>=
literal|2
operator|&&
operator|(
name|token
index|[
literal|0
index|]
operator|==
literal|'"'
operator|||
name|token
index|[
literal|0
index|]
operator|==
literal|'\''
operator|)
operator|&&
operator|(
name|token
index|[
name|slen
operator|-
literal|1
index|]
operator|==
literal|'"'
operator|||
name|token
index|[
name|slen
operator|-
literal|1
index|]
operator|==
literal|'\''
operator|)
condition|)
block|{
comment|/* move token two smaller (quotes) with endnull */
name|memmove
argument_list|(
name|token
argument_list|,
name|token
operator|+
literal|1
argument_list|,
name|slen
operator|-
literal|2
argument_list|)
expr_stmt|;
name|token
index|[
name|slen
operator|-
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|slen
operator|-=
literal|2
expr_stmt|;
operator|*
name|quoted
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|*
name|quoted
operator|&&
name|sldns_rdf_type_maybe_quoted
argument_list|(
name|rdftype
argument_list|)
operator|&&
name|slen
operator|>=
literal|2
operator|&&
operator|(
name|token
index|[
literal|0
index|]
operator|==
literal|'"'
operator|||
name|token
index|[
literal|0
index|]
operator|==
literal|'\''
operator|)
condition|)
block|{
comment|/* got the start quote (remove it) but read remainder 		 * of quoted string as well into remainder of token */
name|memmove
argument_list|(
name|token
argument_list|,
name|token
operator|+
literal|1
argument_list|,
name|slen
operator|-
literal|1
argument_list|)
expr_stmt|;
name|token
index|[
name|slen
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|slen
operator|-=
literal|1
expr_stmt|;
operator|*
name|quoted
operator|=
literal|1
expr_stmt|;
comment|/* rewind buffer over skipped whitespace */
while|while
condition|(
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
operator|>
literal|0
operator|&&
operator|(
name|sldns_buffer_current
argument_list|(
name|strbuf
argument_list|)
index|[
operator|-
literal|1
index|]
operator|==
literal|' '
operator|||
name|sldns_buffer_current
argument_list|(
name|strbuf
argument_list|)
index|[
operator|-
literal|1
index|]
operator|==
literal|'\t'
operator|)
condition|)
block|{
name|sldns_buffer_skip
argument_list|(
name|strbuf
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sldns_bget_token_par
argument_list|(
name|strbuf
argument_list|,
name|token
operator|+
name|slen
argument_list|,
literal|"\""
argument_list|,
name|token_len
operator|-
name|slen
argument_list|,
name|parens
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
literal|0
return|;
block|}
name|slen
operator|=
name|strlen
argument_list|(
name|token
argument_list|)
expr_stmt|;
block|}
operator|*
name|token_strlen
operator|=
name|slen
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/** Add space and one more rdf token onto the existing token string. */
end_comment

begin_function
specifier|static
name|int
name|sldns_affix_token
parameter_list|(
name|sldns_buffer
modifier|*
name|strbuf
parameter_list|,
name|char
modifier|*
name|token
parameter_list|,
name|size_t
modifier|*
name|token_len
parameter_list|,
name|int
modifier|*
name|quoted
parameter_list|,
name|int
modifier|*
name|parens
parameter_list|,
name|size_t
modifier|*
name|pre_data_pos
parameter_list|,
specifier|const
name|char
modifier|*
name|delimiters
parameter_list|,
name|sldns_rdf_type
name|rdftype
parameter_list|,
name|size_t
modifier|*
name|token_strlen
parameter_list|)
block|{
name|size_t
name|addlen
init|=
operator|*
name|token_len
operator|-
operator|*
name|token_strlen
decl_stmt|;
name|size_t
name|addstrlen
init|=
literal|0
decl_stmt|;
comment|/* add space */
if|if
condition|(
name|addlen
operator|<
literal|1
condition|)
return|return
literal|0
return|;
name|token
index|[
operator|*
name|token_strlen
index|]
operator|=
literal|' '
expr_stmt|;
name|token
index|[
operator|++
operator|(
operator|*
name|token_strlen
operator|)
index|]
operator|=
literal|0
expr_stmt|;
comment|/* read another token */
name|addlen
operator|=
operator|*
name|token_len
operator|-
operator|*
name|token_strlen
expr_stmt|;
if|if
condition|(
operator|!
name|sldns_parse_rdf_token
argument_list|(
name|strbuf
argument_list|,
name|token
operator|+
operator|*
name|token_strlen
argument_list|,
name|addlen
argument_list|,
name|quoted
argument_list|,
name|parens
argument_list|,
name|pre_data_pos
argument_list|,
name|delimiters
argument_list|,
name|rdftype
argument_list|,
operator|&
name|addstrlen
argument_list|)
condition|)
return|return
literal|0
return|;
operator|(
operator|*
name|token_strlen
operator|)
operator|+=
name|addstrlen
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/** parse rdata from string into rr buffer(-remainder after dname). */
end_comment

begin_function
specifier|static
name|int
name|rrinternal_parse_rdata
parameter_list|(
name|sldns_buffer
modifier|*
name|strbuf
parameter_list|,
name|char
modifier|*
name|token
parameter_list|,
name|size_t
name|token_len
parameter_list|,
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
modifier|*
name|rr_len
parameter_list|,
name|size_t
name|dname_len
parameter_list|,
name|uint16_t
name|rr_type
parameter_list|,
name|uint8_t
modifier|*
name|origin
parameter_list|,
name|size_t
name|origin_len
parameter_list|)
block|{
specifier|const
name|sldns_rr_descriptor
modifier|*
name|desc
init|=
name|sldns_rr_descript
argument_list|(
operator|(
name|uint16_t
operator|)
name|rr_type
argument_list|)
decl_stmt|;
name|uint16_t
name|r_cnt
decl_stmt|,
name|r_min
decl_stmt|,
name|r_max
decl_stmt|;
name|size_t
name|rr_cur_len
init|=
name|dname_len
operator|+
literal|10
decl_stmt|,
name|pre_data_pos
decl_stmt|,
name|token_strlen
decl_stmt|;
name|int
name|was_unknown_rr_format
init|=
literal|0
decl_stmt|,
name|parens
init|=
literal|0
decl_stmt|,
name|status
decl_stmt|,
name|quoted
decl_stmt|;
specifier|const
name|char
modifier|*
name|delimiters
decl_stmt|;
name|sldns_rdf_type
name|rdftype
decl_stmt|;
comment|/* a desc is always returned */
if|if
condition|(
operator|!
name|desc
condition|)
return|return
name|LDNS_WIREPARSE_ERR_GENERAL
return|;
name|r_max
operator|=
name|sldns_rr_descriptor_maximum
argument_list|(
name|desc
argument_list|)
expr_stmt|;
name|r_min
operator|=
name|sldns_rr_descriptor_minimum
argument_list|(
name|desc
argument_list|)
expr_stmt|;
comment|/* robust check */
if|if
condition|(
name|rr_cur_len
operator|>
operator|*
name|rr_len
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
comment|/* because number of fields can be variable, we can't rely on 	 * _maximum() only */
for|for
control|(
name|r_cnt
operator|=
literal|0
init|;
name|r_cnt
operator|<
name|r_max
condition|;
name|r_cnt
operator|++
control|)
block|{
name|rdftype
operator|=
name|sldns_rr_descriptor_field_type
argument_list|(
name|desc
argument_list|,
name|r_cnt
argument_list|)
expr_stmt|;
name|delimiters
operator|=
name|rrinternal_get_delims
argument_list|(
name|rdftype
argument_list|,
name|r_cnt
argument_list|,
name|r_max
argument_list|)
expr_stmt|;
name|quoted
operator|=
name|rrinternal_get_quoted
argument_list|(
name|strbuf
argument_list|,
operator|&
name|delimiters
argument_list|,
name|rdftype
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sldns_parse_rdf_token
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
name|token_len
argument_list|,
operator|&
name|quoted
argument_list|,
operator|&
name|parens
argument_list|,
operator|&
name|pre_data_pos
argument_list|,
name|delimiters
argument_list|,
name|rdftype
argument_list|,
operator|&
name|token_strlen
argument_list|)
condition|)
break|break;
comment|/* rfc3597 specifies that any type can be represented 		 * with \# method, which can contain spaces... 		 * it does specify size though... */
comment|/* unknown RR data */
if|if
condition|(
name|token_strlen
operator|>=
literal|2
operator|&&
name|strncmp
argument_list|(
name|token
argument_list|,
literal|"\\#"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|&&
operator|!
name|quoted
operator|&&
operator|(
name|token_strlen
operator|==
literal|2
operator|||
name|token
index|[
literal|2
index|]
operator|==
literal|' '
operator|)
condition|)
block|{
name|was_unknown_rr_format
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|rrinternal_parse_unknown
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
name|token_len
argument_list|,
name|rr
argument_list|,
name|rr_len
argument_list|,
operator|&
name|rr_cur_len
argument_list|,
name|pre_data_pos
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|status
return|;
block|}
elseif|else
if|if
condition|(
name|token_strlen
operator|>
literal|0
operator|||
name|quoted
condition|)
block|{
if|if
condition|(
name|rdftype
operator|==
name|LDNS_RDF_TYPE_HIP
condition|)
block|{
comment|/* affix the HIT and PK fields, with a space */
if|if
condition|(
operator|!
name|sldns_affix_token
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
operator|&
name|token_len
argument_list|,
operator|&
name|quoted
argument_list|,
operator|&
name|parens
argument_list|,
operator|&
name|pre_data_pos
argument_list|,
name|delimiters
argument_list|,
name|rdftype
argument_list|,
operator|&
name|token_strlen
argument_list|)
condition|)
break|break;
if|if
condition|(
operator|!
name|sldns_affix_token
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
operator|&
name|token_len
argument_list|,
operator|&
name|quoted
argument_list|,
operator|&
name|parens
argument_list|,
operator|&
name|pre_data_pos
argument_list|,
name|delimiters
argument_list|,
name|rdftype
argument_list|,
operator|&
name|token_strlen
argument_list|)
condition|)
break|break;
block|}
comment|/* normal RR */
if|if
condition|(
operator|(
name|status
operator|=
name|rrinternal_parse_rdf
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
name|token_len
argument_list|,
name|rr
argument_list|,
operator|*
name|rr_len
argument_list|,
operator|&
name|rr_cur_len
argument_list|,
name|rdftype
argument_list|,
name|rr_type
argument_list|,
name|r_cnt
argument_list|,
name|r_max
argument_list|,
name|dname_len
argument_list|,
name|origin
argument_list|,
name|origin_len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
return|return
name|status
return|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|was_unknown_rr_format
operator|&&
name|r_cnt
operator|+
literal|1
operator|<
name|r_min
condition|)
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_MISSING_VALUE
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
while|while
condition|(
name|parens
operator|!=
literal|0
condition|)
block|{
comment|/* read remainder, must be "" */
if|if
condition|(
name|sldns_bget_token_par
argument_list|(
name|strbuf
argument_list|,
name|token
argument_list|,
literal|"\n"
argument_list|,
name|token_len
argument_list|,
operator|&
name|parens
argument_list|,
literal|" \t"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|parens
operator|!=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_PARENTHESIS
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|token
argument_list|,
literal|""
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_PARENTHESIS
argument_list|,
name|sldns_buffer_position
argument_list|(
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
comment|/* write rdata length */
name|sldns_write_uint16
argument_list|(
name|rr
operator|+
name|dname_len
operator|+
literal|8
argument_list|,
name|rr_cur_len
operator|-
name|dname_len
operator|-
literal|10
argument_list|)
expr_stmt|;
operator|*
name|rr_len
operator|=
name|rr_cur_len
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_comment
comment|/*  * trailing spaces are allowed  * leading spaces are not allowed  * allow ttl to be optional  * class is optional too  * if ttl is missing, and default_ttl is 0, use DEF_TTL  * allow ttl to be written as 1d3h  * So the RR should look like. e.g.  * miek.nl. 3600 IN MX 10 elektron.atoom.net  * or  * miek.nl. 1h IN MX 10 elektron.atoom.net  * or  * miek.nl. IN MX 10 elektron.atoom.net  */
end_comment

begin_function
specifier|static
name|int
name|sldns_str2wire_rr_buf_internal
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|size_t
modifier|*
name|dname_len
parameter_list|,
name|uint32_t
name|default_ttl
parameter_list|,
name|uint8_t
modifier|*
name|origin
parameter_list|,
name|size_t
name|origin_len
parameter_list|,
name|uint8_t
modifier|*
name|prev
parameter_list|,
name|size_t
name|prev_len
parameter_list|,
name|int
name|question
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|int
name|not_there
init|=
literal|0
decl_stmt|;
name|char
name|token
index|[
name|LDNS_MAX_RDFLEN
operator|+
literal|1
index|]
decl_stmt|;
name|uint32_t
name|ttl
init|=
literal|0
decl_stmt|;
name|uint16_t
name|tp
init|=
literal|0
decl_stmt|,
name|cl
init|=
literal|0
decl_stmt|;
name|size_t
name|ddlen
init|=
literal|0
decl_stmt|;
comment|/* string in buffer */
name|sldns_buffer
name|strbuf
decl_stmt|;
name|sldns_buffer_init_frm_data
argument_list|(
operator|&
name|strbuf
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dname_len
condition|)
name|dname_len
operator|=
operator|&
name|ddlen
expr_stmt|;
comment|/* parse the owner */
if|if
condition|(
operator|(
name|status
operator|=
name|rrinternal_get_owner
argument_list|(
operator|&
name|strbuf
argument_list|,
name|rr
argument_list|,
name|len
argument_list|,
name|dname_len
argument_list|,
name|origin
argument_list|,
name|origin_len
argument_list|,
name|prev
argument_list|,
name|prev_len
argument_list|,
name|token
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|status
return|;
comment|/* parse the [ttl] [class]<type> */
if|if
condition|(
operator|(
name|status
operator|=
name|rrinternal_get_ttl
argument_list|(
operator|&
name|strbuf
argument_list|,
name|token
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
argument_list|,
operator|&
name|not_there
argument_list|,
operator|&
name|ttl
argument_list|,
name|default_ttl
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|status
return|;
if|if
condition|(
operator|(
name|status
operator|=
name|rrinternal_get_class
argument_list|(
operator|&
name|strbuf
argument_list|,
name|token
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
argument_list|,
operator|&
name|not_there
argument_list|,
operator|&
name|cl
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|status
return|;
if|if
condition|(
operator|(
name|status
operator|=
name|rrinternal_get_type
argument_list|(
operator|&
name|strbuf
argument_list|,
name|token
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
argument_list|,
operator|&
name|not_there
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|status
return|;
comment|/* put ttl, class, type into the rr result */
if|if
condition|(
operator|(
name|status
operator|=
name|rrinternal_write_typeclassttl
argument_list|(
operator|&
name|strbuf
argument_list|,
name|rr
argument_list|,
operator|*
name|len
argument_list|,
operator|*
name|dname_len
argument_list|,
name|tp
argument_list|,
name|cl
argument_list|,
name|ttl
argument_list|,
name|question
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|status
return|;
comment|/* for a question-RR we are done, no rdata */
if|if
condition|(
name|question
condition|)
block|{
operator|*
name|len
operator|=
operator|*
name|dname_len
operator|+
literal|4
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
comment|/* rdata */
if|if
condition|(
operator|(
name|status
operator|=
name|rrinternal_parse_rdata
argument_list|(
operator|&
name|strbuf
argument_list|,
name|token
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
argument_list|,
name|rr
argument_list|,
name|len
argument_list|,
operator|*
name|dname_len
argument_list|,
name|tp
argument_list|,
name|origin
argument_list|,
name|origin_len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|status
return|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_rr_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|size_t
modifier|*
name|dname_len
parameter_list|,
name|uint32_t
name|default_ttl
parameter_list|,
name|uint8_t
modifier|*
name|origin
parameter_list|,
name|size_t
name|origin_len
parameter_list|,
name|uint8_t
modifier|*
name|prev
parameter_list|,
name|size_t
name|prev_len
parameter_list|)
block|{
return|return
name|sldns_str2wire_rr_buf_internal
argument_list|(
name|str
argument_list|,
name|rr
argument_list|,
name|len
argument_list|,
name|dname_len
argument_list|,
name|default_ttl
argument_list|,
name|origin
argument_list|,
name|origin_len
argument_list|,
name|prev
argument_list|,
name|prev_len
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_rr_question_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|size_t
modifier|*
name|dname_len
parameter_list|,
name|uint8_t
modifier|*
name|origin
parameter_list|,
name|size_t
name|origin_len
parameter_list|,
name|uint8_t
modifier|*
name|prev
parameter_list|,
name|size_t
name|prev_len
parameter_list|)
block|{
return|return
name|sldns_str2wire_rr_buf_internal
argument_list|(
name|str
argument_list|,
name|rr
argument_list|,
name|len
argument_list|,
name|dname_len
argument_list|,
literal|0
argument_list|,
name|origin
argument_list|,
name|origin_len
argument_list|,
name|prev
argument_list|,
name|prev_len
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|uint16_t
name|sldns_wirerr_get_type
parameter_list|(
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
name|len
parameter_list|,
name|size_t
name|dname_len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
name|dname_len
operator|+
literal|2
condition|)
return|return
literal|0
return|;
return|return
name|sldns_read_uint16
argument_list|(
name|rr
operator|+
name|dname_len
argument_list|)
return|;
block|}
end_function

begin_function
name|uint16_t
name|sldns_wirerr_get_class
parameter_list|(
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
name|len
parameter_list|,
name|size_t
name|dname_len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
name|dname_len
operator|+
literal|4
condition|)
return|return
literal|0
return|;
return|return
name|sldns_read_uint16
argument_list|(
name|rr
operator|+
name|dname_len
operator|+
literal|2
argument_list|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|sldns_wirerr_get_ttl
parameter_list|(
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
name|len
parameter_list|,
name|size_t
name|dname_len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
name|dname_len
operator|+
literal|8
condition|)
return|return
literal|0
return|;
return|return
name|sldns_read_uint32
argument_list|(
name|rr
operator|+
name|dname_len
operator|+
literal|4
argument_list|)
return|;
block|}
end_function

begin_function
name|uint16_t
name|sldns_wirerr_get_rdatalen
parameter_list|(
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
name|len
parameter_list|,
name|size_t
name|dname_len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
name|dname_len
operator|+
literal|10
condition|)
return|return
literal|0
return|;
return|return
name|sldns_read_uint16
argument_list|(
name|rr
operator|+
name|dname_len
operator|+
literal|8
argument_list|)
return|;
block|}
end_function

begin_function
name|uint8_t
modifier|*
name|sldns_wirerr_get_rdata
parameter_list|(
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
name|len
parameter_list|,
name|size_t
name|dname_len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
name|dname_len
operator|+
literal|10
condition|)
return|return
name|NULL
return|;
return|return
name|rr
operator|+
name|dname_len
operator|+
literal|10
return|;
block|}
end_function

begin_function
name|uint8_t
modifier|*
name|sldns_wirerr_get_rdatawl
parameter_list|(
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
name|len
parameter_list|,
name|size_t
name|dname_len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
name|dname_len
operator|+
literal|10
condition|)
return|return
name|NULL
return|;
return|return
name|rr
operator|+
name|dname_len
operator|+
literal|8
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|sldns_get_errorstr_parse
parameter_list|(
name|int
name|e
parameter_list|)
block|{
name|sldns_lookup_table
modifier|*
name|lt
decl_stmt|;
name|lt
operator|=
name|sldns_lookup_by_id
argument_list|(
name|sldns_wireparse_errors
argument_list|,
name|LDNS_WIREPARSE_ERROR
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|lt
condition|?
name|lt
operator|->
name|name
else|:
literal|"unknown error"
return|;
block|}
end_function

begin_function
name|int
name|sldns_fp2wire_rr_buf
parameter_list|(
name|FILE
modifier|*
name|in
parameter_list|,
name|uint8_t
modifier|*
name|rr
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|size_t
modifier|*
name|dname_len
parameter_list|,
name|struct
name|sldns_file_parse_state
modifier|*
name|parse_state
parameter_list|)
block|{
name|char
name|line
index|[
name|LDNS_RR_BUF_SIZE
operator|+
literal|1
index|]
decl_stmt|;
name|ssize_t
name|size
decl_stmt|;
comment|/* read an entire line in from the file */
if|if
condition|(
operator|(
name|size
operator|=
name|sldns_fget_token_l
argument_list|(
name|in
argument_list|,
name|line
argument_list|,
name|LDNS_PARSE_SKIP_SPACE
argument_list|,
name|LDNS_RR_BUF_SIZE
argument_list|,
name|parse_state
condition|?
operator|&
name|parse_state
operator|->
name|lineno
else|:
name|NULL
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* if last line was empty, we are now at feof, which is not 		 * always a parse error (happens when for instance last line 		 * was a comment) 		 */
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX
return|;
block|}
comment|/* we can have the situation, where we've read ok, but still got 	 * no bytes to play with, in this case size is 0 */
if|if
condition|(
name|size
operator|==
literal|0
condition|)
block|{
operator|*
name|len
operator|=
literal|0
expr_stmt|;
operator|*
name|dname_len
operator|=
literal|0
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|line
argument_list|,
literal|"$ORIGIN"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
operator|&&
name|isspace
argument_list|(
name|line
index|[
literal|7
index|]
argument_list|)
condition|)
block|{
name|size_t
name|off
init|=
literal|8
decl_stmt|;
name|int
name|s
decl_stmt|;
operator|*
name|len
operator|=
literal|0
expr_stmt|;
operator|*
name|dname_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|parse_state
condition|)
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
while|while
condition|(
name|isspace
argument_list|(
name|line
index|[
name|off
index|]
argument_list|)
condition|)
name|off
operator|++
expr_stmt|;
name|parse_state
operator|->
name|origin_len
operator|=
sizeof|sizeof
argument_list|(
name|parse_state
operator|->
name|origin
argument_list|)
expr_stmt|;
name|s
operator|=
name|sldns_str2wire_dname_buf
argument_list|(
name|line
operator|+
name|off
argument_list|,
name|parse_state
operator|->
name|origin
argument_list|,
operator|&
name|parse_state
operator|->
name|origin_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
name|parse_state
operator|->
name|origin_len
operator|=
literal|0
expr_stmt|;
return|return
name|s
return|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|line
argument_list|,
literal|"$TTL"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|&&
name|isspace
argument_list|(
name|line
index|[
literal|4
index|]
argument_list|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|end
init|=
name|NULL
decl_stmt|;
name|size_t
name|off
init|=
literal|8
decl_stmt|;
operator|*
name|len
operator|=
literal|0
expr_stmt|;
operator|*
name|dname_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|parse_state
condition|)
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
while|while
condition|(
name|isspace
argument_list|(
name|line
index|[
name|off
index|]
argument_list|)
condition|)
name|off
operator|++
expr_stmt|;
name|parse_state
operator|->
name|default_ttl
operator|=
name|sldns_str2period
argument_list|(
name|line
operator|+
name|off
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|line
argument_list|,
literal|"$INCLUDE"
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|len
operator|=
literal|0
expr_stmt|;
operator|*
name|dname_len
operator|=
literal|0
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_INCLUDE
return|;
block|}
else|else
block|{
return|return
name|sldns_str2wire_rr_buf
argument_list|(
name|line
argument_list|,
name|rr
argument_list|,
name|len
argument_list|,
name|dname_len
argument_list|,
name|parse_state
condition|?
name|parse_state
operator|->
name|default_ttl
else|:
literal|0
argument_list|,
operator|(
name|parse_state
operator|&&
name|parse_state
operator|->
name|origin_len
operator|)
condition|?
name|parse_state
operator|->
name|origin
else|:
name|NULL
argument_list|,
name|parse_state
operator|->
name|origin_len
argument_list|,
operator|(
name|parse_state
operator|&&
name|parse_state
operator|->
name|prev_rr_len
operator|)
condition|?
name|parse_state
operator|->
name|prev_rr
else|:
name|NULL
argument_list|,
name|parse_state
operator|->
name|prev_rr_len
argument_list|)
return|;
block|}
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_rdf_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|sldns_rdf_type
name|rdftype
parameter_list|)
block|{
switch|switch
condition|(
name|rdftype
condition|)
block|{
case|case
name|LDNS_RDF_TYPE_DNAME
case|:
return|return
name|sldns_str2wire_dname_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_INT8
case|:
return|return
name|sldns_str2wire_int8_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_INT16
case|:
return|return
name|sldns_str2wire_int16_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_INT32
case|:
return|return
name|sldns_str2wire_int32_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_A
case|:
return|return
name|sldns_str2wire_a_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_AAAA
case|:
return|return
name|sldns_str2wire_aaaa_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_STR
case|:
return|return
name|sldns_str2wire_str_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_APL
case|:
return|return
name|sldns_str2wire_apl_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_B64
case|:
return|return
name|sldns_str2wire_b64_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_B32_EXT
case|:
return|return
name|sldns_str2wire_b32_ext_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_HEX
case|:
return|return
name|sldns_str2wire_hex_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_NSEC
case|:
return|return
name|sldns_str2wire_nsec_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_TYPE
case|:
return|return
name|sldns_str2wire_type_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_CLASS
case|:
return|return
name|sldns_str2wire_class_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_CERT_ALG
case|:
return|return
name|sldns_str2wire_cert_alg_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_ALG
case|:
return|return
name|sldns_str2wire_alg_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_TIME
case|:
return|return
name|sldns_str2wire_time_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_PERIOD
case|:
return|return
name|sldns_str2wire_period_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_LOC
case|:
return|return
name|sldns_str2wire_loc_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_WKS
case|:
return|return
name|sldns_str2wire_wks_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_NSAP
case|:
return|return
name|sldns_str2wire_nsap_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_ATMA
case|:
return|return
name|sldns_str2wire_atma_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_IPSECKEY
case|:
return|return
name|sldns_str2wire_ipseckey_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_NSEC3_SALT
case|:
return|return
name|sldns_str2wire_nsec3_salt_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_NSEC3_NEXT_OWNER
case|:
return|return
name|sldns_str2wire_b32_ext_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_ILNP64
case|:
return|return
name|sldns_str2wire_ilnp64_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_EUI48
case|:
return|return
name|sldns_str2wire_eui48_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_EUI64
case|:
return|return
name|sldns_str2wire_eui64_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_TAG
case|:
return|return
name|sldns_str2wire_tag_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_LONG_STR
case|:
return|return
name|sldns_str2wire_long_str_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_HIP
case|:
return|return
name|sldns_str2wire_hip_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_INT16_DATA
case|:
return|return
name|sldns_str2wire_int16_data_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
case|case
name|LDNS_RDF_TYPE_UNKNOWN
case|:
case|case
name|LDNS_RDF_TYPE_SERVICE
case|:
return|return
name|LDNS_WIREPARSE_ERR_NOT_IMPL
return|;
case|case
name|LDNS_RDF_TYPE_NONE
case|:
default|default:
break|break;
block|}
return|return
name|LDNS_WIREPARSE_ERR_GENERAL
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_int8_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|char
modifier|*
name|end
decl_stmt|;
name|uint8_t
name|r
init|=
operator|(
name|uint8_t
operator|)
name|strtol
argument_list|(
operator|(
name|char
operator|*
operator|)
name|str
argument_list|,
operator|&
name|end
argument_list|,
literal|10
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|end
operator|!=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_INT
argument_list|,
name|end
operator|-
operator|(
name|char
operator|*
operator|)
name|str
argument_list|)
return|;
if|if
condition|(
operator|*
name|len
operator|<
literal|1
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|rd
index|[
literal|0
index|]
operator|=
name|r
expr_stmt|;
operator|*
name|len
operator|=
literal|1
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_int16_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|char
modifier|*
name|end
decl_stmt|;
name|uint16_t
name|r
init|=
operator|(
name|uint16_t
operator|)
name|strtol
argument_list|(
operator|(
name|char
operator|*
operator|)
name|str
argument_list|,
operator|&
name|end
argument_list|,
literal|10
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|end
operator|!=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_INT
argument_list|,
name|end
operator|-
operator|(
name|char
operator|*
operator|)
name|str
argument_list|)
return|;
if|if
condition|(
operator|*
name|len
operator|<
literal|2
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|sldns_write_uint16
argument_list|(
name|rd
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
literal|2
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_int32_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|char
modifier|*
name|end
decl_stmt|;
name|uint32_t
name|r
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
comment|/* must set to zero before call, 			note race condition on errno */
if|if
condition|(
operator|*
name|str
operator|==
literal|'-'
condition|)
name|r
operator|=
operator|(
name|uint32_t
operator|)
name|strtol
argument_list|(
operator|(
name|char
operator|*
operator|)
name|str
argument_list|,
operator|&
name|end
argument_list|,
literal|10
argument_list|)
expr_stmt|;
else|else
name|r
operator|=
operator|(
name|uint32_t
operator|)
name|strtoul
argument_list|(
operator|(
name|char
operator|*
operator|)
name|str
argument_list|,
operator|&
name|end
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|end
operator|!=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_INT
argument_list|,
name|end
operator|-
operator|(
name|char
operator|*
operator|)
name|str
argument_list|)
return|;
if|if
condition|(
name|errno
operator|==
name|ERANGE
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_INTEGER_OVERFLOW
return|;
if|if
condition|(
operator|*
name|len
operator|<
literal|4
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|sldns_write_uint32
argument_list|(
name|rd
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
literal|4
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_a_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|in_addr
name|address
decl_stmt|;
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET
argument_list|,
operator|(
name|char
operator|*
operator|)
name|str
argument_list|,
operator|&
name|address
argument_list|)
operator|!=
literal|1
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_IP4
return|;
if|if
condition|(
operator|*
name|len
operator|<
sizeof|sizeof
argument_list|(
name|address
argument_list|)
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|memmove
argument_list|(
name|rd
argument_list|,
operator|&
name|address
argument_list|,
sizeof|sizeof
argument_list|(
name|address
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
sizeof|sizeof
argument_list|(
name|address
argument_list|)
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_aaaa_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|AF_INET6
name|uint8_t
name|address
index|[
name|LDNS_IP6ADDRLEN
operator|+
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
operator|(
name|char
operator|*
operator|)
name|str
argument_list|,
name|address
argument_list|)
operator|!=
literal|1
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_IP6
return|;
if|if
condition|(
operator|*
name|len
operator|<
name|LDNS_IP6ADDRLEN
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|memmove
argument_list|(
name|rd
argument_list|,
name|address
argument_list|,
name|LDNS_IP6ADDRLEN
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|LDNS_IP6ADDRLEN
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
else|#
directive|else
return|return
name|LDNS_WIREPARSE_ERR_NOT_IMPL
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|sldns_str2wire_str_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|uint8_t
name|ch
init|=
literal|0
decl_stmt|;
name|size_t
name|sl
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|s
init|=
name|str
decl_stmt|;
comment|/* skip length byte */
if|if
condition|(
operator|*
name|len
operator|<
literal|1
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
comment|/* read characters */
while|while
condition|(
name|sldns_parse_char
argument_list|(
operator|&
name|ch
argument_list|,
operator|&
name|s
argument_list|)
condition|)
block|{
if|if
condition|(
name|sl
operator|>=
literal|255
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_INVALID_STR
argument_list|,
name|s
operator|-
name|str
argument_list|)
return|;
if|if
condition|(
operator|*
name|len
operator|<
name|sl
operator|+
literal|1
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|s
operator|-
name|str
argument_list|)
return|;
name|rd
index|[
operator|++
name|sl
index|]
operator|=
name|ch
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|s
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_BAD_ESCAPE
return|;
name|rd
index|[
literal|0
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|sl
expr_stmt|;
operator|*
name|len
operator|=
name|sl
operator|+
literal|1
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_apl_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|my_str
init|=
name|str
decl_stmt|;
name|char
name|my_ip_str
index|[
literal|64
index|]
decl_stmt|;
name|size_t
name|ip_str_len
decl_stmt|;
name|uint16_t
name|family
decl_stmt|;
name|int
name|negation
decl_stmt|;
name|size_t
name|adflength
init|=
literal|0
decl_stmt|;
name|uint8_t
name|data
index|[
literal|16
operator|+
literal|4
index|]
decl_stmt|;
name|uint8_t
name|prefix
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|my_str
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* empty APL element, no data, no string */
operator|*
name|len
operator|=
literal|0
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
comment|/* [!]afi:address/prefix */
if|if
condition|(
name|strlen
argument_list|(
name|my_str
argument_list|)
operator|<
literal|2
operator|||
name|strchr
argument_list|(
name|my_str
argument_list|,
literal|':'
argument_list|)
operator|==
name|NULL
operator|||
name|strchr
argument_list|(
name|my_str
argument_list|,
literal|'/'
argument_list|)
operator|==
name|NULL
operator|||
name|strchr
argument_list|(
name|my_str
argument_list|,
literal|':'
argument_list|)
operator|>
name|strchr
argument_list|(
name|my_str
argument_list|,
literal|'/'
argument_list|)
condition|)
block|{
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
block|}
if|if
condition|(
name|my_str
index|[
literal|0
index|]
operator|==
literal|'!'
condition|)
block|{
name|negation
operator|=
literal|1
expr_stmt|;
name|my_str
operator|+=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|negation
operator|=
literal|0
expr_stmt|;
block|}
name|family
operator|=
operator|(
name|uint16_t
operator|)
name|atoi
argument_list|(
name|my_str
argument_list|)
expr_stmt|;
name|my_str
operator|=
name|strchr
argument_list|(
name|my_str
argument_list|,
literal|':'
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* need ip addr and only ip addr for inet_pton */
name|ip_str_len
operator|=
call|(
name|size_t
call|)
argument_list|(
name|strchr
argument_list|(
name|my_str
argument_list|,
literal|'/'
argument_list|)
operator|-
name|my_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip_str_len
operator|+
literal|1
operator|>
sizeof|sizeof
argument_list|(
name|my_ip_str
argument_list|)
condition|)
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|my_ip_str
argument_list|,
name|my_str
argument_list|,
sizeof|sizeof
argument_list|(
name|my_ip_str
argument_list|)
argument_list|)
expr_stmt|;
name|my_ip_str
index|[
name|ip_str_len
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|family
operator|==
literal|1
condition|)
block|{
comment|/* ipv4 */
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET
argument_list|,
name|my_ip_str
argument_list|,
name|data
operator|+
literal|4
argument_list|)
operator|==
literal|0
condition|)
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|data
index|[
name|i
operator|+
literal|4
index|]
operator|!=
literal|0
condition|)
block|{
name|adflength
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|family
operator|==
literal|2
condition|)
block|{
comment|/* ipv6 */
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|my_ip_str
argument_list|,
name|data
operator|+
literal|4
argument_list|)
operator|==
literal|0
condition|)
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|data
index|[
name|i
operator|+
literal|4
index|]
operator|!=
literal|0
condition|)
block|{
name|adflength
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|/* unknown family */
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
block|}
name|my_str
operator|=
name|strchr
argument_list|(
name|my_str
argument_list|,
literal|'/'
argument_list|)
operator|+
literal|1
expr_stmt|;
name|prefix
operator|=
operator|(
name|uint8_t
operator|)
name|atoi
argument_list|(
name|my_str
argument_list|)
expr_stmt|;
name|sldns_write_uint16
argument_list|(
name|data
argument_list|,
name|family
argument_list|)
expr_stmt|;
name|data
index|[
literal|2
index|]
operator|=
name|prefix
expr_stmt|;
name|data
index|[
literal|3
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|adflength
expr_stmt|;
if|if
condition|(
name|negation
condition|)
block|{
comment|/* set bit 1 of byte 3 */
name|data
index|[
literal|3
index|]
operator|=
name|data
index|[
literal|3
index|]
operator||
literal|0x80
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|len
operator|<
literal|4
operator|+
name|adflength
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|memmove
argument_list|(
name|rd
argument_list|,
name|data
argument_list|,
literal|4
operator|+
name|adflength
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
literal|4
operator|+
name|adflength
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_b64_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|size_t
name|sz
init|=
name|sldns_b64_pton_calculate_size
argument_list|(
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|n
decl_stmt|;
if|if
condition|(
operator|*
name|len
operator|<
name|sz
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|n
operator|=
name|sldns_b64_pton
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
operator|*
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_B64
return|;
operator|*
name|len
operator|=
operator|(
name|size_t
operator|)
name|n
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_b32_ext_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|size_t
name|slen
init|=
name|strlen
argument_list|(
name|str
argument_list|)
decl_stmt|;
name|size_t
name|sz
init|=
name|sldns_b32_pton_calculate_size
argument_list|(
name|slen
argument_list|)
decl_stmt|;
name|int
name|n
decl_stmt|;
if|if
condition|(
operator|*
name|len
operator|<
literal|1
operator|+
name|sz
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|rd
index|[
literal|0
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|sz
expr_stmt|;
name|n
operator|=
name|sldns_b32_pton_extended_hex
argument_list|(
name|str
argument_list|,
name|slen
argument_list|,
name|rd
operator|+
literal|1
argument_list|,
operator|*
name|len
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_B32_EXT
return|;
operator|*
name|len
operator|=
operator|(
name|size_t
operator|)
name|n
operator|+
literal|1
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_hex_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|s
init|=
name|str
decl_stmt|;
name|size_t
name|dlen
init|=
literal|0
decl_stmt|;
comment|/* number of hexdigits parsed */
while|while
condition|(
operator|*
name|s
condition|)
block|{
if|if
condition|(
name|isspace
argument_list|(
operator|*
name|s
argument_list|)
condition|)
block|{
name|s
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|isxdigit
argument_list|(
operator|*
name|s
argument_list|)
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_HEX
argument_list|,
name|s
operator|-
name|str
argument_list|)
return|;
if|if
condition|(
operator|*
name|len
operator|<
name|dlen
operator|/
literal|2
operator|+
literal|1
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|s
operator|-
name|str
argument_list|)
return|;
if|if
condition|(
operator|(
name|dlen
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
name|rd
index|[
name|dlen
operator|/
literal|2
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|sldns_hexdigit_to_int
argument_list|(
operator|*
name|s
operator|++
argument_list|)
operator|*
literal|16
expr_stmt|;
else|else
name|rd
index|[
name|dlen
operator|/
literal|2
index|]
operator|+=
operator|(
name|uint8_t
operator|)
name|sldns_hexdigit_to_int
argument_list|(
operator|*
name|s
operator|++
argument_list|)
expr_stmt|;
name|dlen
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dlen
operator|&
literal|1
operator|)
operator|!=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_HEX
argument_list|,
name|s
operator|-
name|str
argument_list|)
return|;
operator|*
name|len
operator|=
name|dlen
operator|/
literal|2
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_nsec_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|delim
init|=
literal|"\n\t "
decl_stmt|;
name|char
name|token
index|[
literal|64
index|]
decl_stmt|;
comment|/* for a type name */
name|size_t
name|type_count
init|=
literal|0
decl_stmt|;
name|int
name|block
decl_stmt|;
name|size_t
name|used
init|=
literal|0
decl_stmt|;
name|uint16_t
name|maxtype
init|=
literal|0
decl_stmt|;
name|uint8_t
name|typebits
index|[
literal|8192
index|]
decl_stmt|;
comment|/* 65536 bits */
name|uint8_t
name|window_in_use
index|[
literal|256
index|]
decl_stmt|;
comment|/* string in buffer */
name|sldns_buffer
name|strbuf
decl_stmt|;
name|sldns_buffer_init_frm_data
argument_list|(
operator|&
name|strbuf
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
comment|/* parse the types */
name|memset
argument_list|(
name|typebits
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|typebits
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|window_in_use
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|window_in_use
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|sldns_buffer_remaining
argument_list|(
operator|&
name|strbuf
argument_list|)
operator|>
literal|0
operator|&&
name|sldns_bget_token
argument_list|(
operator|&
name|strbuf
argument_list|,
name|token
argument_list|,
name|delim
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|uint16_t
name|t
init|=
name|sldns_get_rr_type_by_name
argument_list|(
name|token
argument_list|)
decl_stmt|;
if|if
condition|(
name|token
index|[
literal|0
index|]
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|t
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|token
argument_list|,
literal|"TYPE0"
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_TYPE
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
name|typebits
index|[
name|t
operator|/
literal|8
index|]
operator||=
operator|(
literal|0x80
operator|>>
operator|(
name|t
operator|%
literal|8
operator|)
operator|)
expr_stmt|;
name|window_in_use
index|[
name|t
operator|/
literal|256
index|]
operator|=
literal|1
expr_stmt|;
name|type_count
operator|++
expr_stmt|;
if|if
condition|(
name|t
operator|>
name|maxtype
condition|)
name|maxtype
operator|=
name|t
expr_stmt|;
block|}
comment|/* empty NSEC bitmap */
if|if
condition|(
name|type_count
operator|==
literal|0
condition|)
block|{
operator|*
name|len
operator|=
literal|0
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
comment|/* encode windows {u8 windowblock, u8 bitmaplength, 0-32u8 bitmap}, 	 * block is 0-255 upper octet of types, length if 0-32. */
for|for
control|(
name|block
operator|=
literal|0
init|;
name|block
operator|<=
operator|(
name|int
operator|)
name|maxtype
operator|/
literal|256
condition|;
name|block
operator|++
control|)
block|{
name|int
name|i
decl_stmt|,
name|blocklen
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|window_in_use
index|[
name|block
index|]
condition|)
continue|continue;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|typebits
index|[
name|block
operator|*
literal|32
operator|+
name|i
index|]
operator|!=
literal|0
condition|)
name|blocklen
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|blocklen
operator|==
literal|0
condition|)
continue|continue;
comment|/* empty window should have been !in_use */
if|if
condition|(
name|used
operator|+
name|blocklen
operator|+
literal|2
operator|>
operator|*
name|len
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|rd
index|[
name|used
operator|+
literal|0
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|block
expr_stmt|;
name|rd
index|[
name|used
operator|+
literal|1
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|blocklen
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|blocklen
condition|;
name|i
operator|++
control|)
block|{
name|rd
index|[
name|used
operator|+
literal|2
operator|+
name|i
index|]
operator|=
name|typebits
index|[
name|block
operator|*
literal|32
operator|+
name|i
index|]
expr_stmt|;
block|}
name|used
operator|+=
name|blocklen
operator|+
literal|2
expr_stmt|;
block|}
operator|*
name|len
operator|=
name|used
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_type_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|uint16_t
name|t
init|=
name|sldns_get_rr_type_by_name
argument_list|(
name|str
argument_list|)
decl_stmt|;
if|if
condition|(
name|t
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|str
argument_list|,
literal|"TYPE0"
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_TYPE
return|;
if|if
condition|(
operator|*
name|len
operator|<
literal|2
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|sldns_write_uint16
argument_list|(
name|rd
argument_list|,
name|t
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
literal|2
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_class_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|uint16_t
name|c
init|=
name|sldns_get_rr_class_by_name
argument_list|(
name|str
argument_list|)
decl_stmt|;
if|if
condition|(
name|c
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|str
argument_list|,
literal|"CLASS0"
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_CLASS
return|;
if|if
condition|(
operator|*
name|len
operator|<
literal|2
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|sldns_write_uint16
argument_list|(
name|rd
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
literal|2
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_comment
comment|/* An certificate alg field can either be specified as a 8 bits number  * or by its symbolic name. Handle both */
end_comment

begin_function
name|int
name|sldns_str2wire_cert_alg_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|sldns_lookup_table
modifier|*
name|lt
init|=
name|sldns_lookup_by_name
argument_list|(
name|sldns_cert_algorithms
argument_list|,
name|str
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|len
operator|<
literal|2
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
if|if
condition|(
name|lt
condition|)
block|{
name|sldns_write_uint16
argument_list|(
name|rd
argument_list|,
operator|(
name|uint16_t
operator|)
name|lt
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|s
init|=
name|sldns_str2wire_int16_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
condition|)
return|return
name|s
return|;
if|if
condition|(
name|sldns_read_uint16
argument_list|(
name|rd
argument_list|)
operator|==
literal|0
condition|)
return|return
name|LDNS_WIREPARSE_ERR_CERT_BAD_ALGORITHM
return|;
block|}
operator|*
name|len
operator|=
literal|2
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_comment
comment|/* An alg field can either be specified as a 8 bits number  * or by its symbolic name. Handle both */
end_comment

begin_function
name|int
name|sldns_str2wire_alg_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|sldns_lookup_table
modifier|*
name|lt
init|=
name|sldns_lookup_by_name
argument_list|(
name|sldns_algorithms
argument_list|,
name|str
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|len
operator|<
literal|1
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
if|if
condition|(
name|lt
condition|)
block|{
name|rd
index|[
literal|0
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|lt
operator|->
name|id
expr_stmt|;
operator|*
name|len
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* try as-is (a number) */
return|return
name|sldns_str2wire_int8_buf
argument_list|(
name|str
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
return|;
block|}
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_time_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
comment|/* convert a time YYYYDDMMHHMMSS to wireformat */
name|struct
name|tm
name|tm
decl_stmt|;
if|if
condition|(
operator|*
name|len
operator|<
literal|4
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
comment|/* Try to scan the time... */
name|memset
argument_list|(
operator|&
name|tm
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|str
argument_list|)
operator|==
literal|14
operator|&&
name|sscanf
argument_list|(
name|str
argument_list|,
literal|"%4d%2d%2d%2d%2d%2d"
argument_list|,
operator|&
name|tm
operator|.
name|tm_year
argument_list|,
operator|&
name|tm
operator|.
name|tm_mon
argument_list|,
operator|&
name|tm
operator|.
name|tm_mday
argument_list|,
operator|&
name|tm
operator|.
name|tm_hour
argument_list|,
operator|&
name|tm
operator|.
name|tm_min
argument_list|,
operator|&
name|tm
operator|.
name|tm_sec
argument_list|)
operator|==
literal|6
condition|)
block|{
name|tm
operator|.
name|tm_year
operator|-=
literal|1900
expr_stmt|;
name|tm
operator|.
name|tm_mon
operator|--
expr_stmt|;
comment|/* Check values */
if|if
condition|(
name|tm
operator|.
name|tm_year
operator|<
literal|70
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_TIME
return|;
if|if
condition|(
name|tm
operator|.
name|tm_mon
operator|<
literal|0
operator|||
name|tm
operator|.
name|tm_mon
operator|>
literal|11
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_TIME
return|;
if|if
condition|(
name|tm
operator|.
name|tm_mday
operator|<
literal|1
operator|||
name|tm
operator|.
name|tm_mday
operator|>
literal|31
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_TIME
return|;
if|if
condition|(
name|tm
operator|.
name|tm_hour
operator|<
literal|0
operator|||
name|tm
operator|.
name|tm_hour
operator|>
literal|23
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_TIME
return|;
if|if
condition|(
name|tm
operator|.
name|tm_min
operator|<
literal|0
operator|||
name|tm
operator|.
name|tm_min
operator|>
literal|59
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_TIME
return|;
if|if
condition|(
name|tm
operator|.
name|tm_sec
operator|<
literal|0
operator|||
name|tm
operator|.
name|tm_sec
operator|>
literal|59
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_TIME
return|;
name|sldns_write_uint32
argument_list|(
name|rd
argument_list|,
name|sldns_mktime_from_utc
argument_list|(
operator|&
name|tm
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* handle it as 32 bits timestamp */
name|char
modifier|*
name|end
decl_stmt|;
name|uint32_t
name|l
init|=
operator|(
name|uint32_t
operator|)
name|strtol
argument_list|(
operator|(
name|char
operator|*
operator|)
name|str
argument_list|,
operator|&
name|end
argument_list|,
literal|10
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|end
operator|!=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_TIME
argument_list|,
name|end
operator|-
operator|(
name|char
operator|*
operator|)
name|str
argument_list|)
return|;
name|sldns_write_uint32
argument_list|(
name|rd
argument_list|,
name|l
argument_list|)
expr_stmt|;
block|}
operator|*
name|len
operator|=
literal|4
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_period_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|end
decl_stmt|;
name|uint32_t
name|p
init|=
name|sldns_str2period
argument_list|(
name|str
argument_list|,
operator|&
name|end
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|end
operator|!=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_PERIOD
argument_list|,
name|end
operator|-
name|str
argument_list|)
return|;
if|if
condition|(
operator|*
name|len
operator|<
literal|4
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|sldns_write_uint32
argument_list|(
name|rd
argument_list|,
name|p
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
literal|4
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_comment
comment|/** read "<digits>[.<digits>][mM]" into mantissa exponent format for LOC type */
end_comment

begin_function
specifier|static
name|int
name|loc_parse_cm
parameter_list|(
name|char
modifier|*
name|my_str
parameter_list|,
name|char
modifier|*
modifier|*
name|endstr
parameter_list|,
name|uint8_t
modifier|*
name|m
parameter_list|,
name|uint8_t
modifier|*
name|e
parameter_list|)
block|{
name|uint32_t
name|meters
init|=
literal|0
decl_stmt|,
name|cm
init|=
literal|0
decl_stmt|,
name|val
decl_stmt|;
while|while
condition|(
name|isblank
argument_list|(
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|my_str
operator|++
expr_stmt|;
block|}
name|meters
operator|=
operator|(
name|uint32_t
operator|)
name|strtol
argument_list|(
name|my_str
argument_list|,
operator|&
name|my_str
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|my_str
operator|==
literal|'.'
condition|)
block|{
name|my_str
operator|++
expr_stmt|;
name|cm
operator|=
operator|(
name|uint32_t
operator|)
name|strtol
argument_list|(
name|my_str
argument_list|,
operator|&
name|my_str
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|meters
operator|>=
literal|1
condition|)
block|{
operator|*
name|e
operator|=
literal|2
expr_stmt|;
name|val
operator|=
name|meters
expr_stmt|;
block|}
else|else
block|{
operator|*
name|e
operator|=
literal|0
expr_stmt|;
name|val
operator|=
name|cm
expr_stmt|;
block|}
while|while
condition|(
name|val
operator|>=
literal|10
condition|)
block|{
operator|(
operator|*
name|e
operator|)
operator|++
expr_stmt|;
name|val
operator|/=
literal|10
expr_stmt|;
block|}
operator|*
name|m
operator|=
operator|(
name|uint8_t
operator|)
name|val
expr_stmt|;
if|if
condition|(
operator|*
name|e
operator|>
literal|9
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
name|my_str
operator|==
literal|'m'
operator|||
operator|*
name|my_str
operator|==
literal|'M'
condition|)
block|{
name|my_str
operator|++
expr_stmt|;
block|}
operator|*
name|endstr
operator|=
name|my_str
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_loc_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|uint32_t
name|latitude
init|=
literal|0
decl_stmt|;
name|uint32_t
name|longitude
init|=
literal|0
decl_stmt|;
name|uint32_t
name|altitude
init|=
literal|0
decl_stmt|;
name|uint32_t
name|equator
init|=
operator|(
name|uint32_t
operator|)
literal|1
operator|<<
literal|31
decl_stmt|;
comment|/* 2**31 */
comment|/* only support version 0 */
name|uint32_t
name|h
init|=
literal|0
decl_stmt|;
name|uint32_t
name|m
init|=
literal|0
decl_stmt|;
name|uint8_t
name|size_b
init|=
literal|1
decl_stmt|,
name|size_e
init|=
literal|2
decl_stmt|;
name|uint8_t
name|horiz_pre_b
init|=
literal|1
decl_stmt|,
name|horiz_pre_e
init|=
literal|6
decl_stmt|;
name|uint8_t
name|vert_pre_b
init|=
literal|1
decl_stmt|,
name|vert_pre_e
init|=
literal|3
decl_stmt|;
name|double
name|s
init|=
literal|0.0
decl_stmt|;
name|int
name|northerness
decl_stmt|;
name|int
name|easterness
decl_stmt|;
name|char
modifier|*
name|my_str
init|=
operator|(
name|char
operator|*
operator|)
name|str
decl_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
operator|(
name|int
operator|)
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|h
operator|=
operator|(
name|uint32_t
operator|)
name|strtol
argument_list|(
name|my_str
argument_list|,
operator|&
name|my_str
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
block|}
while|while
condition|(
name|isblank
argument_list|(
operator|(
name|int
operator|)
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|my_str
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|isdigit
argument_list|(
operator|(
name|int
operator|)
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|m
operator|=
operator|(
name|uint32_t
operator|)
name|strtol
argument_list|(
name|my_str
argument_list|,
operator|&
name|my_str
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|my_str
operator|==
literal|'N'
operator|||
operator|*
name|my_str
operator|==
literal|'S'
condition|)
block|{
goto|goto
name|north
goto|;
block|}
else|else
block|{
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
block|}
while|while
condition|(
name|isblank
argument_list|(
operator|(
name|int
operator|)
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|my_str
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|isdigit
argument_list|(
operator|(
name|int
operator|)
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|s
operator|=
name|strtod
argument_list|(
name|my_str
argument_list|,
operator|&
name|my_str
argument_list|)
expr_stmt|;
block|}
comment|/* skip blanks before norterness */
while|while
condition|(
name|isblank
argument_list|(
operator|(
name|int
operator|)
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|my_str
operator|++
expr_stmt|;
block|}
name|north
label|:
if|if
condition|(
operator|*
name|my_str
operator|==
literal|'N'
condition|)
block|{
name|northerness
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|my_str
operator|==
literal|'S'
condition|)
block|{
name|northerness
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
block|}
name|my_str
operator|++
expr_stmt|;
comment|/* store number */
name|s
operator|=
literal|1000.0
operator|*
name|s
expr_stmt|;
comment|/* add a little to make floor in conversion a round */
name|s
operator|+=
literal|0.0005
expr_stmt|;
name|latitude
operator|=
operator|(
name|uint32_t
operator|)
name|s
expr_stmt|;
name|latitude
operator|+=
literal|1000
operator|*
literal|60
operator|*
name|m
expr_stmt|;
name|latitude
operator|+=
literal|1000
operator|*
literal|60
operator|*
literal|60
operator|*
name|h
expr_stmt|;
if|if
condition|(
name|northerness
condition|)
block|{
name|latitude
operator|=
name|equator
operator|+
name|latitude
expr_stmt|;
block|}
else|else
block|{
name|latitude
operator|=
name|equator
operator|-
name|latitude
expr_stmt|;
block|}
while|while
condition|(
name|isblank
argument_list|(
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|my_str
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|isdigit
argument_list|(
operator|(
name|int
operator|)
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|h
operator|=
operator|(
name|uint32_t
operator|)
name|strtol
argument_list|(
name|my_str
argument_list|,
operator|&
name|my_str
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
block|}
while|while
condition|(
name|isblank
argument_list|(
operator|(
name|int
operator|)
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|my_str
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|isdigit
argument_list|(
operator|(
name|int
operator|)
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|m
operator|=
operator|(
name|uint32_t
operator|)
name|strtol
argument_list|(
name|my_str
argument_list|,
operator|&
name|my_str
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|my_str
operator|==
literal|'E'
operator|||
operator|*
name|my_str
operator|==
literal|'W'
condition|)
block|{
goto|goto
name|east
goto|;
block|}
else|else
block|{
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
block|}
while|while
condition|(
name|isblank
argument_list|(
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|my_str
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|isdigit
argument_list|(
operator|(
name|int
operator|)
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|s
operator|=
name|strtod
argument_list|(
name|my_str
argument_list|,
operator|&
name|my_str
argument_list|)
expr_stmt|;
block|}
comment|/* skip blanks before easterness */
while|while
condition|(
name|isblank
argument_list|(
operator|*
name|my_str
argument_list|)
condition|)
block|{
name|my_str
operator|++
expr_stmt|;
block|}
name|east
label|:
if|if
condition|(
operator|*
name|my_str
operator|==
literal|'E'
condition|)
block|{
name|easterness
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|my_str
operator|==
literal|'W'
condition|)
block|{
name|easterness
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
block|}
name|my_str
operator|++
expr_stmt|;
comment|/* store number */
name|s
operator|*=
literal|1000.0
expr_stmt|;
comment|/* add a little to make floor in conversion a round */
name|s
operator|+=
literal|0.0005
expr_stmt|;
name|longitude
operator|=
operator|(
name|uint32_t
operator|)
name|s
expr_stmt|;
name|longitude
operator|+=
literal|1000
operator|*
literal|60
operator|*
name|m
expr_stmt|;
name|longitude
operator|+=
literal|1000
operator|*
literal|60
operator|*
literal|60
operator|*
name|h
expr_stmt|;
if|if
condition|(
name|easterness
condition|)
block|{
name|longitude
operator|+=
name|equator
expr_stmt|;
block|}
else|else
block|{
name|longitude
operator|=
name|equator
operator|-
name|longitude
expr_stmt|;
block|}
name|altitude
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|strtod
argument_list|(
name|my_str
argument_list|,
operator|&
name|my_str
argument_list|)
operator|*
literal|100.0
operator|+
literal|10000000.0
operator|+
literal|0.5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|my_str
operator|==
literal|'m'
operator|||
operator|*
name|my_str
operator|==
literal|'M'
condition|)
block|{
name|my_str
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|my_str
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|loc_parse_cm
argument_list|(
name|my_str
argument_list|,
operator|&
name|my_str
argument_list|,
operator|&
name|size_b
argument_list|,
operator|&
name|size_e
argument_list|)
condition|)
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|my_str
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|loc_parse_cm
argument_list|(
name|my_str
argument_list|,
operator|&
name|my_str
argument_list|,
operator|&
name|horiz_pre_b
argument_list|,
operator|&
name|horiz_pre_e
argument_list|)
condition|)
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|my_str
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|loc_parse_cm
argument_list|(
name|my_str
argument_list|,
operator|&
name|my_str
argument_list|,
operator|&
name|vert_pre_b
argument_list|,
operator|&
name|vert_pre_e
argument_list|)
condition|)
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
block|}
if|if
condition|(
operator|*
name|len
operator|<
literal|16
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|rd
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|rd
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|size_b
operator|<<
literal|4
operator|)
operator|&
literal|0xf0
operator|)
operator||
operator|(
name|size_e
operator|&
literal|0x0f
operator|)
expr_stmt|;
name|rd
index|[
literal|2
index|]
operator|=
operator|(
operator|(
name|horiz_pre_b
operator|<<
literal|4
operator|)
operator|&
literal|0xf0
operator|)
operator||
operator|(
name|horiz_pre_e
operator|&
literal|0x0f
operator|)
expr_stmt|;
name|rd
index|[
literal|3
index|]
operator|=
operator|(
operator|(
name|vert_pre_b
operator|<<
literal|4
operator|)
operator|&
literal|0xf0
operator|)
operator||
operator|(
name|vert_pre_e
operator|&
literal|0x0f
operator|)
expr_stmt|;
name|sldns_write_uint32
argument_list|(
name|rd
operator|+
literal|4
argument_list|,
name|latitude
argument_list|)
expr_stmt|;
name|sldns_write_uint32
argument_list|(
name|rd
operator|+
literal|8
argument_list|,
name|longitude
argument_list|)
expr_stmt|;
name|sldns_write_uint32
argument_list|(
name|rd
operator|+
literal|12
argument_list|,
name|altitude
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
literal|16
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_wks_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|int
name|rd_len
init|=
literal|1
decl_stmt|;
name|int
name|have_proto
init|=
literal|0
decl_stmt|;
name|char
name|token
index|[
literal|50
index|]
decl_stmt|,
name|proto_str
index|[
literal|50
index|]
decl_stmt|;
name|sldns_buffer
name|strbuf
decl_stmt|;
name|sldns_buffer_init_frm_data
argument_list|(
operator|&
name|strbuf
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|proto_str
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* check we have one byte for proto */
if|if
condition|(
operator|*
name|len
operator|<
literal|1
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
while|while
condition|(
name|sldns_bget_token
argument_list|(
operator|&
name|strbuf
argument_list|,
name|token
argument_list|,
literal|"\t\n "
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|have_proto
condition|)
block|{
name|struct
name|protoent
modifier|*
name|p
init|=
name|getprotobyname
argument_list|(
name|token
argument_list|)
decl_stmt|;
name|have_proto
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|p
condition|)
name|rd
index|[
literal|0
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|p
operator|->
name|p_proto
expr_stmt|;
else|else
name|rd
index|[
literal|0
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|atoi
argument_list|(
name|token
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|proto_str
argument_list|,
name|token
argument_list|,
sizeof|sizeof
argument_list|(
name|proto_str
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|serv_port
decl_stmt|;
name|struct
name|servent
modifier|*
name|serv
init|=
name|getservbyname
argument_list|(
name|token
argument_list|,
name|proto_str
argument_list|)
decl_stmt|;
if|if
condition|(
name|serv
condition|)
name|serv_port
operator|=
operator|(
name|int
operator|)
name|ntohs
argument_list|(
operator|(
name|uint16_t
operator|)
name|serv
operator|->
name|s_port
argument_list|)
expr_stmt|;
else|else
block|{
name|serv_port
operator|=
name|atoi
argument_list|(
name|token
argument_list|)
expr_stmt|;
if|if
condition|(
name|serv_port
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|token
argument_list|,
literal|"0"
argument_list|)
operator|!=
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_ENDSERVENT
name|endservent
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_ENDPROTOENT
name|endprotoent
argument_list|()
expr_stmt|;
endif|#
directive|endif
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
if|if
condition|(
name|serv_port
operator|<
literal|0
operator|||
name|serv_port
operator|>
literal|65535
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_ENDSERVENT
name|endservent
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_ENDPROTOENT
name|endprotoent
argument_list|()
expr_stmt|;
endif|#
directive|endif
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
block|}
if|if
condition|(
name|rd_len
operator|<
literal|1
operator|+
name|serv_port
operator|/
literal|8
operator|+
literal|1
condition|)
block|{
comment|/* bitmap is larger, init new bytes at 0 */
if|if
condition|(
operator|*
name|len
operator|<
literal|1
operator|+
operator|(
name|size_t
operator|)
name|serv_port
operator|/
literal|8
operator|+
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_ENDSERVENT
name|endservent
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_ENDPROTOENT
name|endprotoent
argument_list|()
expr_stmt|;
endif|#
directive|endif
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
name|memset
argument_list|(
name|rd
operator|+
name|rd_len
argument_list|,
literal|0
argument_list|,
literal|1
operator|+
operator|(
name|size_t
operator|)
name|serv_port
operator|/
literal|8
operator|+
literal|1
operator|-
name|rd_len
argument_list|)
expr_stmt|;
name|rd_len
operator|=
literal|1
operator|+
name|serv_port
operator|/
literal|8
operator|+
literal|1
expr_stmt|;
block|}
name|rd
index|[
literal|1
operator|+
name|serv_port
operator|/
literal|8
index|]
operator||=
operator|(
literal|1
operator|<<
operator|(
literal|7
operator|-
name|serv_port
operator|%
literal|8
operator|)
operator|)
expr_stmt|;
block|}
block|}
operator|*
name|len
operator|=
operator|(
name|size_t
operator|)
name|rd_len
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_ENDSERVENT
name|endservent
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_ENDPROTOENT
name|endprotoent
argument_list|()
expr_stmt|;
endif|#
directive|endif
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_nsap_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|s
init|=
name|str
decl_stmt|;
name|size_t
name|slen
decl_stmt|;
name|size_t
name|dlen
init|=
literal|0
decl_stmt|;
comment|/* number of hexdigits parsed */
comment|/* just a hex string with optional dots? */
if|if
condition|(
name|s
index|[
literal|0
index|]
operator|!=
literal|'0'
operator|||
name|s
index|[
literal|1
index|]
operator|!=
literal|'x'
condition|)
return|return
name|LDNS_WIREPARSE_ERR_INVALID_STR
return|;
name|s
operator|+=
literal|2
expr_stmt|;
name|slen
operator|=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|slen
operator|>
name|LDNS_MAX_RDFLEN
operator|*
literal|2
condition|)
return|return
name|LDNS_WIREPARSE_ERR_LABEL_OVERFLOW
return|;
while|while
condition|(
operator|*
name|s
condition|)
block|{
if|if
condition|(
name|isspace
argument_list|(
operator|*
name|s
argument_list|)
operator|||
operator|*
name|s
operator|==
literal|'.'
condition|)
block|{
name|s
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|isxdigit
argument_list|(
operator|*
name|s
argument_list|)
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_HEX
argument_list|,
name|s
operator|-
name|str
argument_list|)
return|;
if|if
condition|(
operator|*
name|len
operator|<
name|dlen
operator|/
literal|2
operator|+
literal|1
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|s
operator|-
name|str
argument_list|)
return|;
if|if
condition|(
operator|(
name|dlen
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
name|rd
index|[
name|dlen
operator|/
literal|2
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|sldns_hexdigit_to_int
argument_list|(
operator|*
name|s
operator|++
argument_list|)
operator|*
literal|16
expr_stmt|;
else|else
name|rd
index|[
name|dlen
operator|/
literal|2
index|]
operator|+=
name|sldns_hexdigit_to_int
argument_list|(
operator|*
name|s
operator|++
argument_list|)
expr_stmt|;
name|dlen
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dlen
operator|&
literal|1
operator|)
operator|!=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_HEX
argument_list|,
name|s
operator|-
name|str
argument_list|)
return|;
operator|*
name|len
operator|=
name|dlen
operator|/
literal|2
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_atma_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|s
init|=
name|str
decl_stmt|;
name|size_t
name|slen
init|=
name|strlen
argument_list|(
name|str
argument_list|)
decl_stmt|;
name|size_t
name|dlen
init|=
literal|0
decl_stmt|;
comment|/* number of hexdigits parsed */
comment|/* just a hex string with optional dots? */
comment|/* notimpl e.164 format */
if|if
condition|(
name|slen
operator|>
name|LDNS_MAX_RDFLEN
operator|*
literal|2
condition|)
return|return
name|LDNS_WIREPARSE_ERR_LABEL_OVERFLOW
return|;
while|while
condition|(
operator|*
name|s
condition|)
block|{
if|if
condition|(
name|isspace
argument_list|(
operator|*
name|s
argument_list|)
operator|||
operator|*
name|s
operator|==
literal|'.'
condition|)
block|{
name|s
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|isxdigit
argument_list|(
operator|*
name|s
argument_list|)
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_HEX
argument_list|,
name|s
operator|-
name|str
argument_list|)
return|;
if|if
condition|(
operator|*
name|len
operator|<
name|dlen
operator|/
literal|2
operator|+
literal|1
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|s
operator|-
name|str
argument_list|)
return|;
if|if
condition|(
operator|(
name|dlen
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
name|rd
index|[
name|dlen
operator|/
literal|2
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|sldns_hexdigit_to_int
argument_list|(
operator|*
name|s
operator|++
argument_list|)
operator|*
literal|16
expr_stmt|;
else|else
name|rd
index|[
name|dlen
operator|/
literal|2
index|]
operator|+=
name|sldns_hexdigit_to_int
argument_list|(
operator|*
name|s
operator|++
argument_list|)
expr_stmt|;
name|dlen
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dlen
operator|&
literal|1
operator|)
operator|!=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_HEX
argument_list|,
name|s
operator|-
name|str
argument_list|)
return|;
operator|*
name|len
operator|=
name|dlen
operator|/
literal|2
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_ipseckey_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|size_t
name|gwlen
init|=
literal|0
decl_stmt|,
name|keylen
init|=
literal|0
decl_stmt|;
name|int
name|s
decl_stmt|;
name|uint8_t
name|gwtype
decl_stmt|;
name|char
name|token
index|[
literal|512
index|]
decl_stmt|;
name|sldns_buffer
name|strbuf
decl_stmt|;
name|sldns_buffer_init_frm_data
argument_list|(
operator|&
name|strbuf
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|len
operator|<
literal|3
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
comment|/* precedence */
if|if
condition|(
name|sldns_bget_token
argument_list|(
operator|&
name|strbuf
argument_list|,
name|token
argument_list|,
literal|"\t\n "
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
argument_list|)
operator|<=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_INVALID_STR
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
name|rd
index|[
literal|0
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|atoi
argument_list|(
name|token
argument_list|)
expr_stmt|;
comment|/* gateway_type */
if|if
condition|(
name|sldns_bget_token
argument_list|(
operator|&
name|strbuf
argument_list|,
name|token
argument_list|,
literal|"\t\n "
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
argument_list|)
operator|<=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_INVALID_STR
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
name|rd
index|[
literal|1
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|atoi
argument_list|(
name|token
argument_list|)
expr_stmt|;
name|gwtype
operator|=
name|rd
index|[
literal|1
index|]
expr_stmt|;
comment|/* algorithm */
if|if
condition|(
name|sldns_bget_token
argument_list|(
operator|&
name|strbuf
argument_list|,
name|token
argument_list|,
literal|"\t\n "
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
argument_list|)
operator|<=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_INVALID_STR
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
name|rd
index|[
literal|2
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|atoi
argument_list|(
name|token
argument_list|)
expr_stmt|;
comment|/* gateway */
if|if
condition|(
name|sldns_bget_token
argument_list|(
operator|&
name|strbuf
argument_list|,
name|token
argument_list|,
literal|"\t\n "
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
argument_list|)
operator|<=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_INVALID_STR
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|gwtype
operator|==
literal|0
condition|)
block|{
comment|/* NOGATEWAY */
if|if
condition|(
name|strcmp
argument_list|(
name|token
argument_list|,
literal|"."
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_INVALID_STR
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
name|gwlen
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|gwtype
operator|==
literal|1
condition|)
block|{
comment|/* IP4 */
name|gwlen
operator|=
operator|*
name|len
operator|-
literal|3
expr_stmt|;
name|s
operator|=
name|sldns_str2wire_a_buf
argument_list|(
name|token
argument_list|,
name|rd
operator|+
literal|3
argument_list|,
operator|&
name|gwlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
return|return
name|RET_ERR_SHIFT
argument_list|(
name|s
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|gwtype
operator|==
literal|2
condition|)
block|{
comment|/* IP6 */
name|gwlen
operator|=
operator|*
name|len
operator|-
literal|3
expr_stmt|;
name|s
operator|=
name|sldns_str2wire_aaaa_buf
argument_list|(
name|token
argument_list|,
name|rd
operator|+
literal|3
argument_list|,
operator|&
name|gwlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
return|return
name|RET_ERR_SHIFT
argument_list|(
name|s
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|gwtype
operator|==
literal|3
condition|)
block|{
comment|/* DNAME */
name|gwlen
operator|=
operator|*
name|len
operator|-
literal|3
expr_stmt|;
name|s
operator|=
name|sldns_str2wire_dname_buf
argument_list|(
name|token
argument_list|,
name|rd
operator|+
literal|3
argument_list|,
operator|&
name|gwlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
return|return
name|RET_ERR_SHIFT
argument_list|(
name|s
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
comment|/* unknown gateway type */
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_INVALID_STR
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
block|}
comment|/* double check for size */
if|if
condition|(
operator|*
name|len
operator|<
literal|3
operator|+
name|gwlen
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
comment|/* publickey in remainder of strbuf */
name|keylen
operator|=
operator|*
name|len
operator|-
literal|3
operator|-
name|gwlen
expr_stmt|;
name|s
operator|=
name|sldns_str2wire_b64_buf
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|sldns_buffer_current
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|,
name|rd
operator|+
literal|3
operator|+
name|gwlen
argument_list|,
operator|&
name|keylen
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
return|return
name|RET_ERR_SHIFT
argument_list|(
name|s
argument_list|,
name|sldns_buffer_position
argument_list|(
operator|&
name|strbuf
argument_list|)
argument_list|)
return|;
operator|*
name|len
operator|=
literal|3
operator|+
name|gwlen
operator|+
name|keylen
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_nsec3_salt_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|salt_length_str
init|=
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|str
argument_list|)
decl_stmt|;
if|if
condition|(
name|salt_length_str
operator|==
literal|1
operator|&&
name|str
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
name|salt_length_str
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|salt_length_str
operator|%
literal|2
operator|!=
literal|0
condition|)
block|{
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_HEX
return|;
block|}
if|if
condition|(
name|salt_length_str
operator|>
literal|512
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_HEX
return|;
if|if
condition|(
operator|*
name|len
operator|<
literal|1
operator|+
operator|(
name|size_t
operator|)
name|salt_length_str
operator|/
literal|2
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|rd
index|[
literal|0
index|]
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|salt_length_str
operator|/
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|salt_length_str
condition|;
name|i
operator|+=
literal|2
control|)
block|{
if|if
condition|(
name|isxdigit
argument_list|(
operator|(
name|int
operator|)
name|str
index|[
name|i
index|]
argument_list|)
operator|&&
name|isxdigit
argument_list|(
operator|(
name|int
operator|)
name|str
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
condition|)
block|{
name|rd
index|[
literal|1
operator|+
name|i
operator|/
literal|2
index|]
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|sldns_hexdigit_to_int
argument_list|(
name|str
index|[
name|i
index|]
argument_list|)
operator|*
literal|16
operator|+
name|sldns_hexdigit_to_int
argument_list|(
name|str
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_HEX
argument_list|,
name|i
argument_list|)
return|;
block|}
block|}
operator|*
name|len
operator|=
literal|1
operator|+
operator|(
name|size_t
operator|)
name|rd
index|[
literal|0
index|]
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_ilnp64_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|unsigned
name|int
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|;
name|uint16_t
name|shorts
index|[
literal|4
index|]
decl_stmt|;
name|int
name|l
decl_stmt|;
if|if
condition|(
operator|*
name|len
operator|<
sizeof|sizeof
argument_list|(
name|shorts
argument_list|)
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
if|if
condition|(
name|sscanf
argument_list|(
name|str
argument_list|,
literal|"%4x:%4x:%4x:%4x%n"
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|c
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|l
argument_list|)
operator|!=
literal|4
operator|||
name|l
operator|!=
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|str
argument_list|)
operator|||
comment|/* more data to read */
name|strpbrk
argument_list|(
name|str
argument_list|,
literal|"+-"
argument_list|)
comment|/* signed hexes */
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_ILNP64
return|;
name|shorts
index|[
literal|0
index|]
operator|=
name|htons
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|shorts
index|[
literal|1
index|]
operator|=
name|htons
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|shorts
index|[
literal|2
index|]
operator|=
name|htons
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|shorts
index|[
literal|3
index|]
operator|=
name|htons
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|rd
argument_list|,
operator|&
name|shorts
argument_list|,
sizeof|sizeof
argument_list|(
name|shorts
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
sizeof|sizeof
argument_list|(
name|shorts
argument_list|)
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_eui48_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|unsigned
name|int
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|,
name|e
decl_stmt|,
name|f
decl_stmt|;
name|int
name|l
decl_stmt|;
if|if
condition|(
operator|*
name|len
operator|<
literal|6
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
if|if
condition|(
name|sscanf
argument_list|(
name|str
argument_list|,
literal|"%2x-%2x-%2x-%2x-%2x-%2x%n"
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|c
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|e
argument_list|,
operator|&
name|f
argument_list|,
operator|&
name|l
argument_list|)
operator|!=
literal|6
operator|||
name|l
operator|!=
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|str
argument_list|)
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_EUI48
return|;
name|rd
index|[
literal|0
index|]
operator|=
name|a
expr_stmt|;
name|rd
index|[
literal|1
index|]
operator|=
name|b
expr_stmt|;
name|rd
index|[
literal|2
index|]
operator|=
name|c
expr_stmt|;
name|rd
index|[
literal|3
index|]
operator|=
name|d
expr_stmt|;
name|rd
index|[
literal|4
index|]
operator|=
name|e
expr_stmt|;
name|rd
index|[
literal|5
index|]
operator|=
name|f
expr_stmt|;
operator|*
name|len
operator|=
literal|6
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_eui64_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|unsigned
name|int
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|,
name|e
decl_stmt|,
name|f
decl_stmt|,
name|g
decl_stmt|,
name|h
decl_stmt|;
name|int
name|l
decl_stmt|;
if|if
condition|(
operator|*
name|len
operator|<
literal|8
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
if|if
condition|(
name|sscanf
argument_list|(
name|str
argument_list|,
literal|"%2x-%2x-%2x-%2x-%2x-%2x-%2x-%2x%n"
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|c
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|e
argument_list|,
operator|&
name|f
argument_list|,
operator|&
name|g
argument_list|,
operator|&
name|h
argument_list|,
operator|&
name|l
argument_list|)
operator|!=
literal|8
operator|||
name|l
operator|!=
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|str
argument_list|)
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_EUI64
return|;
name|rd
index|[
literal|0
index|]
operator|=
name|a
expr_stmt|;
name|rd
index|[
literal|1
index|]
operator|=
name|b
expr_stmt|;
name|rd
index|[
literal|2
index|]
operator|=
name|c
expr_stmt|;
name|rd
index|[
literal|3
index|]
operator|=
name|d
expr_stmt|;
name|rd
index|[
literal|4
index|]
operator|=
name|e
expr_stmt|;
name|rd
index|[
literal|5
index|]
operator|=
name|f
expr_stmt|;
name|rd
index|[
literal|6
index|]
operator|=
name|g
expr_stmt|;
name|rd
index|[
literal|7
index|]
operator|=
name|h
expr_stmt|;
operator|*
name|len
operator|=
literal|8
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_tag_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|size_t
name|slen
init|=
name|strlen
argument_list|(
name|str
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|ptr
decl_stmt|;
if|if
condition|(
name|slen
operator|>
literal|255
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_TAG
return|;
if|if
condition|(
operator|*
name|len
operator|<
name|slen
operator|+
literal|1
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
for|for
control|(
name|ptr
operator|=
name|str
init|;
operator|*
name|ptr
condition|;
name|ptr
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|isalnum
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_TAG
argument_list|,
name|ptr
operator|-
name|str
argument_list|)
return|;
block|}
name|rd
index|[
literal|0
index|]
operator|=
name|slen
expr_stmt|;
name|memmove
argument_list|(
name|rd
operator|+
literal|1
argument_list|,
name|str
argument_list|,
name|slen
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|slen
operator|+
literal|1
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_long_str_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|uint8_t
name|ch
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|pstr
init|=
name|str
decl_stmt|;
name|size_t
name|length
init|=
literal|0
decl_stmt|;
comment|/* Fill data with parsed bytes */
while|while
condition|(
name|sldns_parse_char
argument_list|(
operator|&
name|ch
argument_list|,
operator|&
name|pstr
argument_list|)
condition|)
block|{
if|if
condition|(
operator|*
name|len
operator|<
name|length
operator|+
literal|1
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
name|rd
index|[
name|length
operator|++
index|]
operator|=
name|ch
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pstr
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_BAD_ESCAPE
return|;
operator|*
name|len
operator|=
name|length
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_hip_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|e
decl_stmt|;
name|size_t
name|hitlen
decl_stmt|,
name|pklen
init|=
literal|0
decl_stmt|;
comment|/* presentation format: 	 * 	pk-algo HIThex pubkeybase64 	 * wireformat: 	 * 	hitlen[1byte] pkalgo[1byte] pubkeylen[2byte] [hit] [pubkey] */
if|if
condition|(
operator|*
name|len
operator|<
literal|4
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
comment|/* read PK algorithm */
name|rd
index|[
literal|1
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|strtol
argument_list|(
operator|(
name|char
operator|*
operator|)
name|str
argument_list|,
operator|&
name|s
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|!=
literal|' '
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX_INT
argument_list|,
name|s
operator|-
operator|(
name|char
operator|*
operator|)
name|str
argument_list|)
return|;
name|s
operator|++
expr_stmt|;
while|while
condition|(
operator|*
name|s
operator|==
literal|' '
condition|)
name|s
operator|++
expr_stmt|;
comment|/* read HIT hex tag */
comment|/* zero terminate the tag (replace later) */
name|end
operator|=
name|strchr
argument_list|(
name|s
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|end
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_SYNTAX
argument_list|,
name|s
operator|-
operator|(
name|char
operator|*
operator|)
name|str
argument_list|)
return|;
operator|*
name|end
operator|=
literal|0
expr_stmt|;
name|hitlen
operator|=
operator|*
name|len
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|e
operator|=
name|sldns_str2wire_hex_buf
argument_list|(
name|s
argument_list|,
name|rd
operator|+
literal|4
argument_list|,
operator|&
name|hitlen
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
operator|*
name|end
operator|=
literal|' '
expr_stmt|;
return|return
name|RET_ERR_SHIFT
argument_list|(
name|e
argument_list|,
name|s
operator|-
operator|(
name|char
operator|*
operator|)
name|str
argument_list|)
return|;
block|}
if|if
condition|(
name|hitlen
operator|>
literal|255
condition|)
block|{
operator|*
name|end
operator|=
literal|' '
expr_stmt|;
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_LABEL_OVERFLOW
argument_list|,
name|s
operator|-
operator|(
name|char
operator|*
operator|)
name|str
operator|+
literal|255
operator|*
literal|2
argument_list|)
return|;
block|}
name|rd
index|[
literal|0
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|hitlen
expr_stmt|;
operator|*
name|end
operator|=
literal|' '
expr_stmt|;
name|s
operator|=
name|end
operator|+
literal|1
expr_stmt|;
comment|/* read pubkey base64 sequence */
name|pklen
operator|=
operator|*
name|len
operator|-
literal|4
operator|-
name|hitlen
expr_stmt|;
if|if
condition|(
operator|(
name|e
operator|=
name|sldns_str2wire_b64_buf
argument_list|(
name|s
argument_list|,
name|rd
operator|+
literal|4
operator|+
name|hitlen
argument_list|,
operator|&
name|pklen
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|RET_ERR_SHIFT
argument_list|(
name|e
argument_list|,
name|s
operator|-
operator|(
name|char
operator|*
operator|)
name|str
argument_list|)
return|;
if|if
condition|(
name|pklen
operator|>
literal|65535
condition|)
return|return
name|RET_ERR
argument_list|(
name|LDNS_WIREPARSE_ERR_LABEL_OVERFLOW
argument_list|,
name|s
operator|-
operator|(
name|char
operator|*
operator|)
name|str
operator|+
literal|65535
argument_list|)
return|;
name|sldns_write_uint16
argument_list|(
name|rd
operator|+
literal|2
argument_list|,
name|pklen
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
literal|4
operator|+
name|hitlen
operator|+
name|pklen
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

begin_function
name|int
name|sldns_str2wire_int16_data_buf
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|rd
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|size_t
name|sz
init|=
name|sldns_b64_pton_calculate_size
argument_list|(
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|n
decl_stmt|;
if|if
condition|(
operator|*
name|len
operator|<
name|sz
operator|+
literal|2
condition|)
return|return
name|LDNS_WIREPARSE_ERR_BUFFER_TOO_SMALL
return|;
if|if
condition|(
name|sz
operator|>
literal|65535
condition|)
return|return
name|LDNS_WIREPARSE_ERR_LABEL_OVERFLOW
return|;
name|n
operator|=
name|sldns_b64_pton
argument_list|(
name|str
argument_list|,
name|rd
operator|+
literal|2
argument_list|,
operator|(
operator|*
name|len
operator|)
operator|-
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
return|return
name|LDNS_WIREPARSE_ERR_SYNTAX_B64
return|;
name|sldns_write_uint16
argument_list|(
name|rd
argument_list|,
operator|(
name|uint16_t
operator|)
name|n
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
operator|(
name|size_t
operator|)
name|n
expr_stmt|;
return|return
name|LDNS_WIREPARSE_ERR_OK
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * parseutil.c - parse utilities for string and wire conversion  *  * (c) NLnet Labs, 2004-2006  *  * See the file LICENSE for the license  */
end_comment

begin_comment
comment|/**  * \file  *  * Utility functions for parsing, base32(DNS variant) and base64 encoding  * and decoding, Hex, Time units, Escape codes.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"ldns/parseutil.h"
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_function
name|sldns_lookup_table
modifier|*
name|sldns_lookup_by_name
parameter_list|(
name|sldns_lookup_table
modifier|*
name|table
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
while|while
condition|(
name|table
operator|->
name|name
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|name
argument_list|,
name|table
operator|->
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
name|table
return|;
name|table
operator|++
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|sldns_lookup_table
modifier|*
name|sldns_lookup_by_id
parameter_list|(
name|sldns_lookup_table
modifier|*
name|table
parameter_list|,
name|int
name|id
parameter_list|)
block|{
while|while
condition|(
name|table
operator|->
name|name
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|table
operator|->
name|id
operator|==
name|id
condition|)
return|return
name|table
return|;
name|table
operator|++
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* Number of days per month (except for February in leap years). */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|int
name|mdays
index|[]
init|=
block|{
literal|31
block|,
literal|28
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|LDNS_MOD
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|(((x) % (y)< 0) ? ((x) % (y) + (y)) : ((x) % (y)))
end_define

begin_define
define|#
directive|define
name|LDNS_DIV
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|(((x) % (y)< 0) ? ((x) / (y) -  1 ) : ((x) / (y)))
end_define

begin_function
specifier|static
name|int
name|is_leap_year
parameter_list|(
name|int
name|year
parameter_list|)
block|{
return|return
name|LDNS_MOD
argument_list|(
name|year
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|LDNS_MOD
argument_list|(
name|year
argument_list|,
literal|100
argument_list|)
operator|!=
literal|0
operator|||
name|LDNS_MOD
argument_list|(
name|year
argument_list|,
literal|400
argument_list|)
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|leap_days
parameter_list|(
name|int
name|y1
parameter_list|,
name|int
name|y2
parameter_list|)
block|{
operator|--
name|y1
expr_stmt|;
operator|--
name|y2
expr_stmt|;
return|return
operator|(
name|LDNS_DIV
argument_list|(
name|y2
argument_list|,
literal|4
argument_list|)
operator|-
name|LDNS_DIV
argument_list|(
name|y1
argument_list|,
literal|4
argument_list|)
operator|)
operator|-
operator|(
name|LDNS_DIV
argument_list|(
name|y2
argument_list|,
literal|100
argument_list|)
operator|-
name|LDNS_DIV
argument_list|(
name|y1
argument_list|,
literal|100
argument_list|)
operator|)
operator|+
operator|(
name|LDNS_DIV
argument_list|(
name|y2
argument_list|,
literal|400
argument_list|)
operator|-
name|LDNS_DIV
argument_list|(
name|y1
argument_list|,
literal|400
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Code adapted from Python 2.4.1 sources (Lib/calendar.py).  */
end_comment

begin_function
name|time_t
name|sldns_mktime_from_utc
parameter_list|(
specifier|const
name|struct
name|tm
modifier|*
name|tm
parameter_list|)
block|{
name|int
name|year
init|=
literal|1900
operator|+
name|tm
operator|->
name|tm_year
decl_stmt|;
name|time_t
name|days
init|=
literal|365
operator|*
operator|(
operator|(
name|time_t
operator|)
name|year
operator|-
literal|1970
operator|)
operator|+
name|leap_days
argument_list|(
literal|1970
argument_list|,
name|year
argument_list|)
decl_stmt|;
name|time_t
name|hours
decl_stmt|;
name|time_t
name|minutes
decl_stmt|;
name|time_t
name|seconds
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tm
operator|->
name|tm_mon
condition|;
operator|++
name|i
control|)
block|{
name|days
operator|+=
name|mdays
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|tm
operator|->
name|tm_mon
operator|>
literal|1
operator|&&
name|is_leap_year
argument_list|(
name|year
argument_list|)
condition|)
block|{
operator|++
name|days
expr_stmt|;
block|}
name|days
operator|+=
name|tm
operator|->
name|tm_mday
operator|-
literal|1
expr_stmt|;
name|hours
operator|=
name|days
operator|*
literal|24
operator|+
name|tm
operator|->
name|tm_hour
expr_stmt|;
name|minutes
operator|=
name|hours
operator|*
literal|60
operator|+
name|tm
operator|->
name|tm_min
expr_stmt|;
name|seconds
operator|=
name|minutes
operator|*
literal|60
operator|+
name|tm
operator|->
name|tm_sec
expr_stmt|;
return|return
name|seconds
return|;
block|}
end_function

begin_if
if|#
directive|if
name|SIZEOF_TIME_T
operator|<=
literal|4
end_if

begin_function
specifier|static
name|void
name|sldns_year_and_yday_from_days_since_epoch
parameter_list|(
name|int64_t
name|days
parameter_list|,
name|struct
name|tm
modifier|*
name|result
parameter_list|)
block|{
name|int
name|year
init|=
literal|1970
decl_stmt|;
name|int
name|new_year
decl_stmt|;
while|while
condition|(
name|days
operator|<
literal|0
operator|||
name|days
operator|>=
call|(
name|int64_t
call|)
argument_list|(
name|is_leap_year
argument_list|(
name|year
argument_list|)
condition|?
literal|366
else|:
literal|365
argument_list|)
condition|)
block|{
name|new_year
operator|=
name|year
operator|+
operator|(
name|int
operator|)
name|LDNS_DIV
argument_list|(
name|days
argument_list|,
literal|365
argument_list|)
expr_stmt|;
name|days
operator|-=
operator|(
name|new_year
operator|-
name|year
operator|)
operator|*
literal|365
expr_stmt|;
name|days
operator|-=
name|leap_days
argument_list|(
name|year
argument_list|,
name|new_year
argument_list|)
expr_stmt|;
name|year
operator|=
name|new_year
expr_stmt|;
block|}
name|result
operator|->
name|tm_year
operator|=
name|year
expr_stmt|;
name|result
operator|->
name|tm_yday
operator|=
operator|(
name|int
operator|)
name|days
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Number of days per month in a leap year. */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|int
name|leap_year_mdays
index|[]
init|=
block|{
literal|31
block|,
literal|29
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|sldns_mon_and_mday_from_year_and_yday
parameter_list|(
name|struct
name|tm
modifier|*
name|result
parameter_list|)
block|{
name|int
name|idays
init|=
name|result
operator|->
name|tm_yday
decl_stmt|;
specifier|const
name|int
modifier|*
name|mon_lengths
init|=
name|is_leap_year
argument_list|(
name|result
operator|->
name|tm_year
argument_list|)
condition|?
name|leap_year_mdays
else|:
name|mdays
decl_stmt|;
name|result
operator|->
name|tm_mon
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|idays
operator|>=
name|mon_lengths
index|[
name|result
operator|->
name|tm_mon
index|]
condition|)
block|{
name|idays
operator|-=
name|mon_lengths
index|[
name|result
operator|->
name|tm_mon
operator|++
index|]
expr_stmt|;
block|}
name|result
operator|->
name|tm_mday
operator|=
name|idays
operator|+
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sldns_wday_from_year_and_yday
parameter_list|(
name|struct
name|tm
modifier|*
name|result
parameter_list|)
block|{
name|result
operator|->
name|tm_wday
operator|=
literal|4
comment|/* 1-1-1970 was a thursday */
operator|+
name|LDNS_MOD
argument_list|(
operator|(
name|result
operator|->
name|tm_year
operator|-
literal|1970
operator|)
argument_list|,
literal|7
argument_list|)
operator|*
name|LDNS_MOD
argument_list|(
literal|365
argument_list|,
literal|7
argument_list|)
operator|+
name|leap_days
argument_list|(
literal|1970
argument_list|,
name|result
operator|->
name|tm_year
argument_list|)
operator|+
name|result
operator|->
name|tm_yday
expr_stmt|;
name|result
operator|->
name|tm_wday
operator|=
name|LDNS_MOD
argument_list|(
name|result
operator|->
name|tm_wday
argument_list|,
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|tm_wday
operator|<
literal|0
condition|)
block|{
name|result
operator|->
name|tm_wday
operator|+=
literal|7
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|tm
modifier|*
name|sldns_gmtime64_r
parameter_list|(
name|int64_t
name|clock
parameter_list|,
name|struct
name|tm
modifier|*
name|result
parameter_list|)
block|{
name|result
operator|->
name|tm_isdst
operator|=
literal|0
expr_stmt|;
name|result
operator|->
name|tm_sec
operator|=
operator|(
name|int
operator|)
name|LDNS_MOD
argument_list|(
name|clock
argument_list|,
literal|60
argument_list|)
expr_stmt|;
name|clock
operator|=
name|LDNS_DIV
argument_list|(
name|clock
argument_list|,
literal|60
argument_list|)
expr_stmt|;
name|result
operator|->
name|tm_min
operator|=
operator|(
name|int
operator|)
name|LDNS_MOD
argument_list|(
name|clock
argument_list|,
literal|60
argument_list|)
expr_stmt|;
name|clock
operator|=
name|LDNS_DIV
argument_list|(
name|clock
argument_list|,
literal|60
argument_list|)
expr_stmt|;
name|result
operator|->
name|tm_hour
operator|=
operator|(
name|int
operator|)
name|LDNS_MOD
argument_list|(
name|clock
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|clock
operator|=
name|LDNS_DIV
argument_list|(
name|clock
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|sldns_year_and_yday_from_days_since_epoch
argument_list|(
name|clock
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|sldns_mon_and_mday_from_year_and_yday
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|sldns_wday_from_year_and_yday
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|result
operator|->
name|tm_year
operator|-=
literal|1900
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SIZEOF_TIME_T<= 4 */
end_comment

begin_function
specifier|static
name|int64_t
name|sldns_serial_arithmitics_time
parameter_list|(
name|int32_t
name|time
parameter_list|,
name|time_t
name|now
parameter_list|)
block|{
name|int32_t
name|offset
init|=
name|time
operator|-
operator|(
name|int32_t
operator|)
name|now
decl_stmt|;
return|return
operator|(
name|int64_t
operator|)
name|now
operator|+
name|offset
return|;
block|}
end_function

begin_function
name|struct
name|tm
modifier|*
name|sldns_serial_arithmitics_gmtime_r
parameter_list|(
name|int32_t
name|time
parameter_list|,
name|time_t
name|now
parameter_list|,
name|struct
name|tm
modifier|*
name|result
parameter_list|)
block|{
if|#
directive|if
name|SIZEOF_TIME_T
operator|<=
literal|4
name|int64_t
name|secs_since_epoch
init|=
name|sldns_serial_arithmitics_time
argument_list|(
name|time
argument_list|,
name|now
argument_list|)
decl_stmt|;
return|return
name|sldns_gmtime64_r
argument_list|(
name|secs_since_epoch
argument_list|,
name|result
argument_list|)
return|;
else|#
directive|else
name|time_t
name|secs_since_epoch
init|=
name|sldns_serial_arithmitics_time
argument_list|(
name|time
argument_list|,
name|now
argument_list|)
decl_stmt|;
return|return
name|gmtime_r
argument_list|(
operator|&
name|secs_since_epoch
argument_list|,
name|result
argument_list|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|sldns_hexdigit_to_int
parameter_list|(
name|char
name|ch
parameter_list|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'0'
case|:
return|return
literal|0
return|;
case|case
literal|'1'
case|:
return|return
literal|1
return|;
case|case
literal|'2'
case|:
return|return
literal|2
return|;
case|case
literal|'3'
case|:
return|return
literal|3
return|;
case|case
literal|'4'
case|:
return|return
literal|4
return|;
case|case
literal|'5'
case|:
return|return
literal|5
return|;
case|case
literal|'6'
case|:
return|return
literal|6
return|;
case|case
literal|'7'
case|:
return|return
literal|7
return|;
case|case
literal|'8'
case|:
return|return
literal|8
return|;
case|case
literal|'9'
case|:
return|return
literal|9
return|;
case|case
literal|'a'
case|:
case|case
literal|'A'
case|:
return|return
literal|10
return|;
case|case
literal|'b'
case|:
case|case
literal|'B'
case|:
return|return
literal|11
return|;
case|case
literal|'c'
case|:
case|case
literal|'C'
case|:
return|return
literal|12
return|;
case|case
literal|'d'
case|:
case|case
literal|'D'
case|:
return|return
literal|13
return|;
case|case
literal|'e'
case|:
case|case
literal|'E'
case|:
return|return
literal|14
return|;
case|case
literal|'f'
case|:
case|case
literal|'F'
case|:
return|return
literal|15
return|;
default|default:
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_function
name|uint32_t
name|sldns_str2period
parameter_list|(
specifier|const
name|char
modifier|*
name|nptr
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|endptr
parameter_list|)
block|{
name|int
name|sign
init|=
literal|0
decl_stmt|;
name|uint32_t
name|i
init|=
literal|0
decl_stmt|;
name|uint32_t
name|seconds
init|=
literal|0
decl_stmt|;
for|for
control|(
operator|*
name|endptr
operator|=
name|nptr
init|;
operator|*
operator|*
name|endptr
condition|;
operator|(
operator|*
name|endptr
operator|)
operator|++
control|)
block|{
switch|switch
condition|(
operator|*
operator|*
name|endptr
condition|)
block|{
case|case
literal|' '
case|:
case|case
literal|'\t'
case|:
break|break;
case|case
literal|'-'
case|:
if|if
condition|(
name|sign
operator|==
literal|0
condition|)
block|{
name|sign
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
return|return
name|seconds
return|;
block|}
break|break;
case|case
literal|'+'
case|:
if|if
condition|(
name|sign
operator|==
literal|0
condition|)
block|{
name|sign
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
return|return
name|seconds
return|;
block|}
break|break;
case|case
literal|'s'
case|:
case|case
literal|'S'
case|:
name|seconds
operator|+=
name|i
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
case|case
literal|'M'
case|:
name|seconds
operator|+=
name|i
operator|*
literal|60
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
case|case
literal|'H'
case|:
name|seconds
operator|+=
name|i
operator|*
literal|60
operator|*
literal|60
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
case|case
literal|'D'
case|:
name|seconds
operator|+=
name|i
operator|*
literal|60
operator|*
literal|60
operator|*
literal|24
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
case|case
literal|'W'
case|:
name|seconds
operator|+=
name|i
operator|*
literal|60
operator|*
literal|60
operator|*
literal|24
operator|*
literal|7
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
name|i
operator|*=
literal|10
expr_stmt|;
name|i
operator|+=
operator|(
operator|*
operator|*
name|endptr
operator|-
literal|'0'
operator|)
expr_stmt|;
break|break;
default|default:
name|seconds
operator|+=
name|i
expr_stmt|;
comment|/* disregard signedness */
return|return
name|seconds
return|;
block|}
block|}
name|seconds
operator|+=
name|i
expr_stmt|;
comment|/* disregard signedness */
return|return
name|seconds
return|;
block|}
end_function

begin_function
name|int
name|sldns_parse_escape
parameter_list|(
name|uint8_t
modifier|*
name|ch_p
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|str_p
parameter_list|)
block|{
name|uint16_t
name|val
decl_stmt|;
if|if
condition|(
operator|(
operator|*
name|str_p
operator|)
index|[
literal|0
index|]
operator|&&
name|isdigit
argument_list|(
operator|(
operator|*
name|str_p
operator|)
index|[
literal|0
index|]
argument_list|)
operator|&&
operator|(
operator|*
name|str_p
operator|)
index|[
literal|1
index|]
operator|&&
name|isdigit
argument_list|(
operator|(
operator|*
name|str_p
operator|)
index|[
literal|1
index|]
argument_list|)
operator|&&
operator|(
operator|*
name|str_p
operator|)
index|[
literal|2
index|]
operator|&&
name|isdigit
argument_list|(
operator|(
operator|*
name|str_p
operator|)
index|[
literal|2
index|]
argument_list|)
condition|)
block|{
name|val
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
operator|(
operator|*
name|str_p
operator|)
index|[
literal|0
index|]
operator|-
literal|'0'
operator|)
operator|*
literal|100
operator|+
operator|(
operator|(
operator|*
name|str_p
operator|)
index|[
literal|1
index|]
operator|-
literal|'0'
operator|)
operator|*
literal|10
operator|+
operator|(
operator|(
operator|*
name|str_p
operator|)
index|[
literal|2
index|]
operator|-
literal|'0'
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>
literal|255
condition|)
block|{
goto|goto
name|error
goto|;
block|}
operator|*
name|ch_p
operator|=
operator|(
name|uint8_t
operator|)
name|val
expr_stmt|;
operator|*
name|str_p
operator|+=
literal|3
expr_stmt|;
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|*
name|str_p
operator|)
index|[
literal|0
index|]
operator|&&
operator|!
name|isdigit
argument_list|(
operator|(
operator|*
name|str_p
operator|)
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
operator|*
name|ch_p
operator|=
operator|(
name|uint8_t
operator|)
operator|*
operator|(
operator|*
name|str_p
operator|)
operator|++
expr_stmt|;
return|return
literal|1
return|;
block|}
name|error
label|:
operator|*
name|str_p
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
comment|/* LDNS_WIREPARSE_ERR_SYNTAX_BAD_ESCAPE */
block|}
end_function

begin_comment
comment|/** parse one character, with escape codes */
end_comment

begin_function
name|int
name|sldns_parse_char
parameter_list|(
name|uint8_t
modifier|*
name|ch_p
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|str_p
parameter_list|)
block|{
switch|switch
condition|(
operator|*
operator|*
name|str_p
condition|)
block|{
case|case
literal|'\0'
case|:
return|return
literal|0
return|;
case|case
literal|'\\'
case|:
operator|*
name|str_p
operator|+=
literal|1
expr_stmt|;
return|return
name|sldns_parse_escape
argument_list|(
name|ch_p
argument_list|,
name|str_p
argument_list|)
return|;
default|default:
operator|*
name|ch_p
operator|=
operator|(
name|uint8_t
operator|)
operator|*
operator|(
operator|*
name|str_p
operator|)
operator|++
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
end_function

begin_function
name|size_t
name|sldns_b32_ntop_calculate_size
parameter_list|(
name|size_t
name|src_data_length
parameter_list|)
block|{
return|return
name|src_data_length
operator|==
literal|0
condition|?
literal|0
else|:
operator|(
operator|(
name|src_data_length
operator|-
literal|1
operator|)
operator|/
literal|5
operator|+
literal|1
operator|)
operator|*
literal|8
return|;
block|}
end_function

begin_function
name|size_t
name|sldns_b32_ntop_calculate_size_no_padding
parameter_list|(
name|size_t
name|src_data_length
parameter_list|)
block|{
return|return
operator|(
operator|(
name|src_data_length
operator|+
literal|3
operator|)
operator|*
literal|8
operator|/
literal|5
operator|)
operator|-
literal|4
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sldns_b32_ntop_base
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|src
parameter_list|,
name|size_t
name|src_sz
parameter_list|,
name|char
modifier|*
name|dst
parameter_list|,
name|size_t
name|dst_sz
parameter_list|,
name|int
name|extended_hex
parameter_list|,
name|int
name|add_padding
parameter_list|)
block|{
name|size_t
name|ret_sz
decl_stmt|;
specifier|const
name|char
modifier|*
name|b32
init|=
name|extended_hex
condition|?
literal|"0123456789abcdefghijklmnopqrstuv"
else|:
literal|"abcdefghijklmnopqrstuvwxyz234567"
decl_stmt|;
name|size_t
name|c
init|=
literal|0
decl_stmt|;
comment|/* c is used to carry partial base32 character over  		       * byte boundaries for sizes with a remainder. 		       * (i.e. src_sz % 5 != 0) 		       */
name|ret_sz
operator|=
name|add_padding
condition|?
name|sldns_b32_ntop_calculate_size
argument_list|(
name|src_sz
argument_list|)
else|:
name|sldns_b32_ntop_calculate_size_no_padding
argument_list|(
name|src_sz
argument_list|)
expr_stmt|;
comment|/* Do we have enough space? */
if|if
condition|(
name|dst_sz
operator|<
name|ret_sz
operator|+
literal|1
condition|)
return|return
operator|-
literal|1
return|;
comment|/* We know the size; terminate the string */
name|dst
index|[
name|ret_sz
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* First process all chunks of five */
while|while
condition|(
name|src_sz
operator|>=
literal|5
condition|)
block|{
comment|/* 00000... ........ ........ ........ ........ */
name|dst
index|[
literal|0
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|0
index|]
operator|)
operator|>>
literal|3
index|]
expr_stmt|;
comment|/* .....111 11...... ........ ........ ........ */
name|dst
index|[
literal|1
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|0
index|]
operator|&
literal|0x07
operator|)
operator|<<
literal|2
operator||
name|src
index|[
literal|1
index|]
operator|>>
literal|6
index|]
expr_stmt|;
comment|/* ........ ..22222. ........ ........ ........ */
name|dst
index|[
literal|2
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|1
index|]
operator|&
literal|0x3e
operator|)
operator|>>
literal|1
index|]
expr_stmt|;
comment|/* ........ .......3 3333.... ........ ........ */
name|dst
index|[
literal|3
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|1
index|]
operator|&
literal|0x01
operator|)
operator|<<
literal|4
operator||
name|src
index|[
literal|2
index|]
operator|>>
literal|4
index|]
expr_stmt|;
comment|/* ........ ........ ....4444 4....... ........ */
name|dst
index|[
literal|4
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|2
index|]
operator|&
literal|0x0f
operator|)
operator|<<
literal|1
operator||
name|src
index|[
literal|3
index|]
operator|>>
literal|7
index|]
expr_stmt|;
comment|/* ........ ........ ........ .55555.. ........ */
name|dst
index|[
literal|5
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|3
index|]
operator|&
literal|0x7c
operator|)
operator|>>
literal|2
index|]
expr_stmt|;
comment|/* ........ ........ ........ ......66 666..... */
name|dst
index|[
literal|6
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|3
index|]
operator|&
literal|0x03
operator|)
operator|<<
literal|3
operator||
name|src
index|[
literal|4
index|]
operator|>>
literal|5
index|]
expr_stmt|;
comment|/* ........ ........ ........ ........ ...77777 */
name|dst
index|[
literal|7
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|4
index|]
operator|&
literal|0x1f
operator|)
index|]
expr_stmt|;
name|src_sz
operator|-=
literal|5
expr_stmt|;
name|src
operator|+=
literal|5
expr_stmt|;
name|dst
operator|+=
literal|8
expr_stmt|;
block|}
comment|/* Process what remains */
switch|switch
condition|(
name|src_sz
condition|)
block|{
case|case
literal|4
case|:
comment|/* ........ ........ ........ ......66 666..... */
name|dst
index|[
literal|6
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|3
index|]
operator|&
literal|0x03
operator|)
operator|<<
literal|3
index|]
expr_stmt|;
comment|/* ........ ........ ........ .55555.. ........ */
name|dst
index|[
literal|5
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|3
index|]
operator|&
literal|0x7c
operator|)
operator|>>
literal|2
index|]
expr_stmt|;
comment|/* ........ ........ ....4444 4....... ........ */
name|c
operator|=
name|src
index|[
literal|3
index|]
operator|>>
literal|7
expr_stmt|;
case|case
literal|3
case|:
name|dst
index|[
literal|4
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|2
index|]
operator|&
literal|0x0f
operator|)
operator|<<
literal|1
operator||
name|c
index|]
expr_stmt|;
comment|/* ........ .......3 3333.... ........ ........ */
name|c
operator|=
name|src
index|[
literal|2
index|]
operator|>>
literal|4
expr_stmt|;
case|case
literal|2
case|:
name|dst
index|[
literal|3
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|1
index|]
operator|&
literal|0x01
operator|)
operator|<<
literal|4
operator||
name|c
index|]
expr_stmt|;
comment|/* ........ ..22222. ........ ........ ........ */
name|dst
index|[
literal|2
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|1
index|]
operator|&
literal|0x3e
operator|)
operator|>>
literal|1
index|]
expr_stmt|;
comment|/* .....111 11...... ........ ........ ........ */
name|c
operator|=
name|src
index|[
literal|1
index|]
operator|>>
literal|6
expr_stmt|;
case|case
literal|1
case|:
name|dst
index|[
literal|1
index|]
operator|=
name|b32
index|[
operator|(
name|src
index|[
literal|0
index|]
operator|&
literal|0x07
operator|)
operator|<<
literal|2
operator||
name|c
index|]
expr_stmt|;
comment|/* 00000... ........ ........ ........ ........ */
name|dst
index|[
literal|0
index|]
operator|=
name|b32
index|[
name|src
index|[
literal|0
index|]
operator|>>
literal|3
index|]
expr_stmt|;
block|}
comment|/* Add padding */
if|if
condition|(
name|add_padding
condition|)
block|{
switch|switch
condition|(
name|src_sz
condition|)
block|{
case|case
literal|1
case|:
name|dst
index|[
literal|2
index|]
operator|=
literal|'='
expr_stmt|;
name|dst
index|[
literal|3
index|]
operator|=
literal|'='
expr_stmt|;
case|case
literal|2
case|:
name|dst
index|[
literal|4
index|]
operator|=
literal|'='
expr_stmt|;
case|case
literal|3
case|:
name|dst
index|[
literal|5
index|]
operator|=
literal|'='
expr_stmt|;
name|dst
index|[
literal|6
index|]
operator|=
literal|'='
expr_stmt|;
case|case
literal|4
case|:
name|dst
index|[
literal|7
index|]
operator|=
literal|'='
expr_stmt|;
block|}
block|}
return|return
operator|(
name|int
operator|)
name|ret_sz
return|;
block|}
end_function

begin_function
name|int
name|sldns_b32_ntop
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|src
parameter_list|,
name|size_t
name|src_sz
parameter_list|,
name|char
modifier|*
name|dst
parameter_list|,
name|size_t
name|dst_sz
parameter_list|)
block|{
return|return
name|sldns_b32_ntop_base
argument_list|(
name|src
argument_list|,
name|src_sz
argument_list|,
name|dst
argument_list|,
name|dst_sz
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|sldns_b32_ntop_extended_hex
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|src
parameter_list|,
name|size_t
name|src_sz
parameter_list|,
name|char
modifier|*
name|dst
parameter_list|,
name|size_t
name|dst_sz
parameter_list|)
block|{
return|return
name|sldns_b32_ntop_base
argument_list|(
name|src
argument_list|,
name|src_sz
argument_list|,
name|dst
argument_list|,
name|dst_sz
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|sldns_b32_pton_calculate_size
parameter_list|(
name|size_t
name|src_text_length
parameter_list|)
block|{
return|return
name|src_text_length
operator|*
literal|5
operator|/
literal|8
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sldns_b32_pton_base
parameter_list|(
specifier|const
name|char
modifier|*
name|src
parameter_list|,
name|size_t
name|src_sz
parameter_list|,
name|uint8_t
modifier|*
name|dst
parameter_list|,
name|size_t
name|dst_sz
parameter_list|,
name|int
name|extended_hex
parameter_list|,
name|int
name|check_padding
parameter_list|)
block|{
name|size_t
name|i
init|=
literal|0
decl_stmt|;
name|char
name|ch
init|=
literal|'\0'
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|8
index|]
decl_stmt|;
name|uint8_t
modifier|*
name|start
init|=
name|dst
decl_stmt|;
while|while
condition|(
name|src_sz
condition|)
block|{
comment|/* Collect 8 characters in buf (if possible) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
do|do
block|{
name|ch
operator|=
operator|*
name|src
operator|++
expr_stmt|;
operator|--
name|src_sz
expr_stmt|;
block|}
do|while
condition|(
name|isspace
argument_list|(
name|ch
argument_list|)
operator|&&
name|src_sz
operator|>
literal|0
condition|)
do|;
if|if
condition|(
name|ch
operator|==
literal|'='
operator|||
name|ch
operator|==
literal|'\0'
condition|)
break|break;
elseif|else
if|if
condition|(
name|extended_hex
condition|)
if|if
condition|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
condition|)
name|buf
index|[
name|i
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|ch
operator|-
literal|'0'
expr_stmt|;
elseif|else
if|if
condition|(
name|ch
operator|>=
literal|'a'
operator|&&
name|ch
operator|<=
literal|'v'
condition|)
name|buf
index|[
name|i
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|ch
operator|-
literal|'a'
operator|+
literal|10
expr_stmt|;
elseif|else
if|if
condition|(
name|ch
operator|>=
literal|'A'
operator|&&
name|ch
operator|<=
literal|'V'
condition|)
name|buf
index|[
name|i
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|ch
operator|-
literal|'A'
operator|+
literal|10
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
elseif|else
if|if
condition|(
name|ch
operator|>=
literal|'a'
operator|&&
name|ch
operator|<=
literal|'z'
condition|)
name|buf
index|[
name|i
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|ch
operator|-
literal|'a'
expr_stmt|;
elseif|else
if|if
condition|(
name|ch
operator|>=
literal|'A'
operator|&&
name|ch
operator|<=
literal|'Z'
condition|)
name|buf
index|[
name|i
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|ch
operator|-
literal|'A'
expr_stmt|;
elseif|else
if|if
condition|(
name|ch
operator|>=
literal|'2'
operator|&&
name|ch
operator|<=
literal|'7'
condition|)
name|buf
index|[
name|i
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|ch
operator|-
literal|'2'
operator|+
literal|26
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
block|}
comment|/* Less that 8 characters. We're done. */
if|if
condition|(
name|i
operator|<
literal|8
condition|)
break|break;
comment|/* Enough space available at the destination? */
if|if
condition|(
name|dst_sz
operator|<
literal|5
condition|)
return|return
operator|-
literal|1
return|;
comment|/* 00000... ........ ........ ........ ........ */
comment|/* .....111 11...... ........ ........ ........ */
name|dst
index|[
literal|0
index|]
operator|=
name|buf
index|[
literal|0
index|]
operator|<<
literal|3
operator||
name|buf
index|[
literal|1
index|]
operator|>>
literal|2
expr_stmt|;
comment|/* .....111 11...... ........ ........ ........ */
comment|/* ........ ..22222. ........ ........ ........ */
comment|/* ........ .......3 3333.... ........ ........ */
name|dst
index|[
literal|1
index|]
operator|=
name|buf
index|[
literal|1
index|]
operator|<<
literal|6
operator||
name|buf
index|[
literal|2
index|]
operator|<<
literal|1
operator||
name|buf
index|[
literal|3
index|]
operator|>>
literal|4
expr_stmt|;
comment|/* ........ .......3 3333.... ........ ........ */
comment|/* ........ ........ ....4444 4....... ........ */
name|dst
index|[
literal|2
index|]
operator|=
name|buf
index|[
literal|3
index|]
operator|<<
literal|4
operator||
name|buf
index|[
literal|4
index|]
operator|>>
literal|1
expr_stmt|;
comment|/* ........ ........ ....4444 4....... ........ */
comment|/* ........ ........ ........ .55555.. ........ */
comment|/* ........ ........ ........ ......66 666..... */
name|dst
index|[
literal|3
index|]
operator|=
name|buf
index|[
literal|4
index|]
operator|<<
literal|7
operator||
name|buf
index|[
literal|5
index|]
operator|<<
literal|2
operator||
name|buf
index|[
literal|6
index|]
operator|>>
literal|3
expr_stmt|;
comment|/* ........ ........ ........ ......66 666..... */
comment|/* ........ ........ ........ ........ ...77777 */
name|dst
index|[
literal|4
index|]
operator|=
name|buf
index|[
literal|6
index|]
operator|<<
literal|5
operator||
name|buf
index|[
literal|7
index|]
expr_stmt|;
name|dst
operator|+=
literal|5
expr_stmt|;
name|dst_sz
operator|-=
literal|5
expr_stmt|;
block|}
comment|/* Not ending on a eight byte boundary? */
if|if
condition|(
name|i
operator|>
literal|0
operator|&&
name|i
operator|<
literal|8
condition|)
block|{
comment|/* Enough space available at the destination? */
if|if
condition|(
name|dst_sz
operator|<
operator|(
name|i
operator|+
literal|1
operator|)
operator|/
literal|2
condition|)
return|return
operator|-
literal|1
return|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|7
case|:
comment|/* ........ ........ ........ ......66 666..... */
comment|/* ........ ........ ........ .55555.. ........ */
comment|/* ........ ........ ....4444 4....... ........ */
name|dst
index|[
literal|3
index|]
operator|=
name|buf
index|[
literal|4
index|]
operator|<<
literal|7
operator||
name|buf
index|[
literal|5
index|]
operator|<<
literal|2
operator||
name|buf
index|[
literal|6
index|]
operator|>>
literal|3
expr_stmt|;
case|case
literal|5
case|:
comment|/* ........ ........ ....4444 4....... ........ */
comment|/* ........ .......3 3333.... ........ ........ */
name|dst
index|[
literal|2
index|]
operator|=
name|buf
index|[
literal|3
index|]
operator|<<
literal|4
operator||
name|buf
index|[
literal|4
index|]
operator|>>
literal|1
expr_stmt|;
case|case
literal|4
case|:
comment|/* ........ .......3 3333.... ........ ........ */
comment|/* ........ ..22222. ........ ........ ........ */
comment|/* .....111 11...... ........ ........ ........ */
name|dst
index|[
literal|1
index|]
operator|=
name|buf
index|[
literal|1
index|]
operator|<<
literal|6
operator||
name|buf
index|[
literal|2
index|]
operator|<<
literal|1
operator||
name|buf
index|[
literal|3
index|]
operator|>>
literal|4
expr_stmt|;
case|case
literal|2
case|:
comment|/* .....111 11...... ........ ........ ........ */
comment|/* 00000... ........ ........ ........ ........ */
name|dst
index|[
literal|0
index|]
operator|=
name|buf
index|[
literal|0
index|]
operator|<<
literal|3
operator||
name|buf
index|[
literal|1
index|]
operator|>>
literal|2
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
name|dst
operator|+=
operator|(
name|i
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|check_padding
condition|)
block|{
comment|/* Check remaining padding characters */
if|if
condition|(
name|ch
operator|!=
literal|'='
condition|)
return|return
operator|-
literal|1
return|;
comment|/* One down, 8 - i - 1 more to come... */
for|for
control|(
name|i
operator|=
literal|8
operator|-
name|i
operator|-
literal|1
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
do|do
block|{
if|if
condition|(
name|src_sz
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|ch
operator|=
operator|*
name|src
operator|++
expr_stmt|;
name|src_sz
operator|--
expr_stmt|;
block|}
do|while
condition|(
name|isspace
argument_list|(
name|ch
argument_list|)
condition|)
do|;
if|if
condition|(
name|ch
operator|!=
literal|'='
condition|)
return|return
operator|-
literal|1
return|;
block|}
block|}
block|}
return|return
name|dst
operator|-
name|start
return|;
block|}
end_function

begin_function
name|int
name|sldns_b32_pton
parameter_list|(
specifier|const
name|char
modifier|*
name|src
parameter_list|,
name|size_t
name|src_sz
parameter_list|,
name|uint8_t
modifier|*
name|dst
parameter_list|,
name|size_t
name|dst_sz
parameter_list|)
block|{
return|return
name|sldns_b32_pton_base
argument_list|(
name|src
argument_list|,
name|src_sz
argument_list|,
name|dst
argument_list|,
name|dst_sz
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|sldns_b32_pton_extended_hex
parameter_list|(
specifier|const
name|char
modifier|*
name|src
parameter_list|,
name|size_t
name|src_sz
parameter_list|,
name|uint8_t
modifier|*
name|dst
parameter_list|,
name|size_t
name|dst_sz
parameter_list|)
block|{
return|return
name|sldns_b32_pton_base
argument_list|(
name|src
argument_list|,
name|src_sz
argument_list|,
name|dst
argument_list|,
name|dst_sz
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|sldns_b64_ntop_calculate_size
parameter_list|(
name|size_t
name|srcsize
parameter_list|)
block|{
return|return
operator|(
operator|(
operator|(
operator|(
name|srcsize
operator|+
literal|2
operator|)
operator|/
literal|3
operator|)
operator|*
literal|4
operator|)
operator|+
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/* RFC 1521, section 5.2.  *  * The encoding process represents 24-bit groups of input bits as output  * strings of 4 encoded characters. Proceeding from left to right, a  * 24-bit input group is formed by concatenating 3 8-bit input groups.  * These 24 bits are then treated as 4 concatenated 6-bit groups, each  * of which is translated into a single digit in the base64 alphabet.  *  * This routine does not insert spaces or linebreaks after 76 characters.  */
end_comment

begin_function
name|int
name|sldns_b64_ntop
parameter_list|(
name|uint8_t
specifier|const
modifier|*
name|src
parameter_list|,
name|size_t
name|srclength
parameter_list|,
name|char
modifier|*
name|target
parameter_list|,
name|size_t
name|targsize
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|b64
init|=
literal|"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"
decl_stmt|;
specifier|const
name|char
name|pad64
init|=
literal|'='
decl_stmt|;
name|size_t
name|i
init|=
literal|0
decl_stmt|,
name|o
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|targsize
operator|<
name|sldns_b64_ntop_calculate_size
argument_list|(
name|srclength
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* whole chunks: xxxxxxyy yyyyzzzz zzwwwwww */
while|while
condition|(
name|i
operator|+
literal|3
operator|<=
name|srclength
condition|)
block|{
if|if
condition|(
name|o
operator|+
literal|4
operator|>
name|targsize
condition|)
return|return
operator|-
literal|1
return|;
name|target
index|[
name|o
index|]
operator|=
name|b64
index|[
name|src
index|[
name|i
index|]
operator|>>
literal|2
index|]
expr_stmt|;
name|target
index|[
name|o
operator|+
literal|1
index|]
operator|=
name|b64
index|[
operator|(
operator|(
name|src
index|[
name|i
index|]
operator|&
literal|0x03
operator|)
operator|<<
literal|4
operator|)
operator||
operator|(
name|src
index|[
name|i
operator|+
literal|1
index|]
operator|>>
literal|4
operator|)
index|]
expr_stmt|;
name|target
index|[
name|o
operator|+
literal|2
index|]
operator|=
name|b64
index|[
operator|(
operator|(
name|src
index|[
name|i
operator|+
literal|1
index|]
operator|&
literal|0x0f
operator|)
operator|<<
literal|2
operator|)
operator||
operator|(
name|src
index|[
name|i
operator|+
literal|2
index|]
operator|>>
literal|6
operator|)
index|]
expr_stmt|;
name|target
index|[
name|o
operator|+
literal|3
index|]
operator|=
name|b64
index|[
operator|(
name|src
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x3f
operator|)
index|]
expr_stmt|;
name|i
operator|+=
literal|3
expr_stmt|;
name|o
operator|+=
literal|4
expr_stmt|;
block|}
comment|/* remainder */
switch|switch
condition|(
name|srclength
operator|-
name|i
condition|)
block|{
case|case
literal|2
case|:
comment|/* two at end, converted into A B C = */
name|target
index|[
name|o
index|]
operator|=
name|b64
index|[
name|src
index|[
name|i
index|]
operator|>>
literal|2
index|]
expr_stmt|;
name|target
index|[
name|o
operator|+
literal|1
index|]
operator|=
name|b64
index|[
operator|(
operator|(
name|src
index|[
name|i
index|]
operator|&
literal|0x03
operator|)
operator|<<
literal|4
operator|)
operator||
operator|(
name|src
index|[
name|i
operator|+
literal|1
index|]
operator|>>
literal|4
operator|)
index|]
expr_stmt|;
name|target
index|[
name|o
operator|+
literal|2
index|]
operator|=
name|b64
index|[
operator|(
operator|(
name|src
index|[
name|i
operator|+
literal|1
index|]
operator|&
literal|0x0f
operator|)
operator|<<
literal|2
operator|)
index|]
expr_stmt|;
name|target
index|[
name|o
operator|+
literal|3
index|]
operator|=
name|pad64
expr_stmt|;
name|i
operator|+=
literal|2
expr_stmt|;
name|o
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* one at end, converted into A B = = */
name|target
index|[
name|o
index|]
operator|=
name|b64
index|[
name|src
index|[
name|i
index|]
operator|>>
literal|2
index|]
expr_stmt|;
name|target
index|[
name|o
operator|+
literal|1
index|]
operator|=
name|b64
index|[
operator|(
operator|(
name|src
index|[
name|i
index|]
operator|&
literal|0x03
operator|)
operator|<<
literal|4
operator|)
index|]
expr_stmt|;
name|target
index|[
name|o
operator|+
literal|2
index|]
operator|=
name|pad64
expr_stmt|;
name|target
index|[
name|o
operator|+
literal|3
index|]
operator|=
name|pad64
expr_stmt|;
name|i
operator|+=
literal|1
expr_stmt|;
name|o
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
literal|0
case|:
default|default:
comment|/* nothing */
break|break;
block|}
comment|/* assert: i == srclength */
if|if
condition|(
name|o
operator|+
literal|1
operator|>
name|targsize
condition|)
return|return
operator|-
literal|1
return|;
name|target
index|[
name|o
index|]
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|int
operator|)
name|o
return|;
block|}
end_function

begin_function
name|size_t
name|sldns_b64_pton_calculate_size
parameter_list|(
name|size_t
name|srcsize
parameter_list|)
block|{
return|return
operator|(
operator|(
operator|(
operator|(
operator|(
name|srcsize
operator|+
literal|3
operator|)
operator|/
literal|4
operator|)
operator|*
literal|3
operator|)
operator|)
operator|+
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|sldns_b64_pton
parameter_list|(
name|char
specifier|const
modifier|*
name|src
parameter_list|,
name|uint8_t
modifier|*
name|target
parameter_list|,
name|size_t
name|targsize
parameter_list|)
block|{
specifier|const
name|uint8_t
name|pad64
init|=
literal|64
decl_stmt|;
comment|/* is 64th in the b64 array */
specifier|const
name|char
modifier|*
name|s
init|=
name|src
decl_stmt|;
name|uint8_t
name|in
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|o
init|=
literal|0
decl_stmt|,
name|incount
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|*
name|s
condition|)
block|{
comment|/* skip any character that is not base64 */
comment|/* conceptually we do: 		const char* b64 =      pad'=' is appended to array 		"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="; 		const char* d = strchr(b64, *s++); 		and use d-b64; 		*/
name|char
name|d
init|=
operator|*
name|s
operator|++
decl_stmt|;
if|if
condition|(
name|d
operator|<=
literal|'Z'
operator|&&
name|d
operator|>=
literal|'A'
condition|)
name|d
operator|-=
literal|'A'
expr_stmt|;
elseif|else
if|if
condition|(
name|d
operator|<=
literal|'z'
operator|&&
name|d
operator|>=
literal|'a'
condition|)
name|d
operator|=
name|d
operator|-
literal|'a'
operator|+
literal|26
expr_stmt|;
elseif|else
if|if
condition|(
name|d
operator|<=
literal|'9'
operator|&&
name|d
operator|>=
literal|'0'
condition|)
name|d
operator|=
name|d
operator|-
literal|'0'
operator|+
literal|52
expr_stmt|;
elseif|else
if|if
condition|(
name|d
operator|==
literal|'+'
condition|)
name|d
operator|=
literal|62
expr_stmt|;
elseif|else
if|if
condition|(
name|d
operator|==
literal|'/'
condition|)
name|d
operator|=
literal|63
expr_stmt|;
elseif|else
if|if
condition|(
name|d
operator|==
literal|'='
condition|)
name|d
operator|=
literal|64
expr_stmt|;
else|else
continue|continue;
name|in
index|[
name|incount
operator|++
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|d
expr_stmt|;
if|if
condition|(
name|incount
operator|!=
literal|4
condition|)
continue|continue;
comment|/* process whole block of 4 characters into 3 output bytes */
if|if
condition|(
name|in
index|[
literal|3
index|]
operator|==
name|pad64
operator|&&
name|in
index|[
literal|2
index|]
operator|==
name|pad64
condition|)
block|{
comment|/* A B = = */
if|if
condition|(
name|o
operator|+
literal|1
operator|>
name|targsize
condition|)
return|return
operator|-
literal|1
return|;
name|target
index|[
name|o
index|]
operator|=
operator|(
name|in
index|[
literal|0
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|in
index|[
literal|1
index|]
operator|&
literal|0x30
operator|)
operator|>>
literal|4
operator|)
expr_stmt|;
name|o
operator|+=
literal|1
expr_stmt|;
break|break;
comment|/* we are done */
block|}
elseif|else
if|if
condition|(
name|in
index|[
literal|3
index|]
operator|==
name|pad64
condition|)
block|{
comment|/* A B C = */
if|if
condition|(
name|o
operator|+
literal|2
operator|>
name|targsize
condition|)
return|return
operator|-
literal|1
return|;
name|target
index|[
name|o
index|]
operator|=
operator|(
name|in
index|[
literal|0
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|in
index|[
literal|1
index|]
operator|&
literal|0x30
operator|)
operator|>>
literal|4
operator|)
expr_stmt|;
name|target
index|[
name|o
operator|+
literal|1
index|]
operator|=
operator|(
operator|(
name|in
index|[
literal|1
index|]
operator|&
literal|0x0f
operator|)
operator|<<
literal|4
operator|)
operator||
operator|(
operator|(
name|in
index|[
literal|2
index|]
operator|&
literal|0x3c
operator|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|o
operator|+=
literal|2
expr_stmt|;
break|break;
comment|/* we are done */
block|}
else|else
block|{
if|if
condition|(
name|o
operator|+
literal|3
operator|>
name|targsize
condition|)
return|return
operator|-
literal|1
return|;
comment|/* write xxxxxxyy yyyyzzzz zzwwwwww */
name|target
index|[
name|o
index|]
operator|=
operator|(
name|in
index|[
literal|0
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|in
index|[
literal|1
index|]
operator|&
literal|0x30
operator|)
operator|>>
literal|4
operator|)
expr_stmt|;
name|target
index|[
name|o
operator|+
literal|1
index|]
operator|=
operator|(
operator|(
name|in
index|[
literal|1
index|]
operator|&
literal|0x0f
operator|)
operator|<<
literal|4
operator|)
operator||
operator|(
operator|(
name|in
index|[
literal|2
index|]
operator|&
literal|0x3c
operator|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|target
index|[
name|o
operator|+
literal|2
index|]
operator|=
operator|(
operator|(
name|in
index|[
literal|2
index|]
operator|&
literal|0x03
operator|)
operator|<<
literal|6
operator|)
operator||
name|in
index|[
literal|3
index|]
expr_stmt|;
name|o
operator|+=
literal|3
expr_stmt|;
block|}
name|incount
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
name|int
operator|)
name|o
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * util/config_file.c - reads and stores the config file for unbound.  *  * Copyright (c) 2007, NLnet Labs. All rights reserved.  *  * This software is open source.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *   * Redistributions of source code must retain the above copyright notice,  * this list of conditions and the following disclaimer.  *   * Redistributions in binary form must reproduce the above copyright notice,  * this list of conditions and the following disclaimer in the documentation  * and/or other materials provided with the distribution.  *   * Neither the name of the NLNET LABS nor the names of its contributors may  * be used to endorse or promote products derived from this software without  * specific prior written permission.  *   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED  * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/**  * \file  *  * This file contains functions for the config file.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_TIME_H
end_ifdef

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"util/log.h"
end_include

begin_include
include|#
directive|include
file|"util/configyyrename.h"
end_include

begin_include
include|#
directive|include
file|"util/config_file.h"
end_include

begin_include
include|#
directive|include
file|"util/configparser.h"
end_include

begin_include
include|#
directive|include
file|"util/net_help.h"
end_include

begin_include
include|#
directive|include
file|"util/data/msgparse.h"
end_include

begin_include
include|#
directive|include
file|"util/module.h"
end_include

begin_include
include|#
directive|include
file|"util/regional.h"
end_include

begin_include
include|#
directive|include
file|"util/fptr_wlist.h"
end_include

begin_include
include|#
directive|include
file|"util/data/dname.h"
end_include

begin_include
include|#
directive|include
file|"ldns/wire2str.h"
end_include

begin_include
include|#
directive|include
file|"ldns/parseutil.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_GLOB_H
end_ifdef

begin_include
include|#
directive|include
file|<glob.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/** global config during parsing */
end_comment

begin_decl_stmt
name|struct
name|config_parser_state
modifier|*
name|cfg_parser
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/** init ports possible for use */
end_comment

begin_function_decl
specifier|static
name|void
name|init_outgoing_availports
parameter_list|(
name|int
modifier|*
name|array
parameter_list|,
name|int
name|num
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|struct
name|config_file
modifier|*
name|config_create
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|config_file
modifier|*
name|cfg
decl_stmt|;
name|cfg
operator|=
operator|(
expr|struct
name|config_file
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|config_file
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cfg
condition|)
return|return
name|NULL
return|;
comment|/* the defaults if no config is present */
name|cfg
operator|->
name|verbosity
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|stat_interval
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|stat_cumulative
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|stat_extended
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|num_threads
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|port
operator|=
name|UNBOUND_DNS_PORT
expr_stmt|;
name|cfg
operator|->
name|do_ip4
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|do_ip6
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|do_udp
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|do_tcp
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|tcp_upstream
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|ssl_service_key
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|ssl_service_pem
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|ssl_port
operator|=
literal|443
expr_stmt|;
name|cfg
operator|->
name|ssl_upstream
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|use_syslog
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|log_time_ascii
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|log_queries
operator|=
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|USE_WINSOCK
ifdef|#
directive|ifdef
name|USE_MINI_EVENT
comment|/* select max 1024 sockets */
name|cfg
operator|->
name|outgoing_num_ports
operator|=
literal|960
expr_stmt|;
name|cfg
operator|->
name|num_queries_per_thread
operator|=
literal|512
expr_stmt|;
else|#
directive|else
comment|/* libevent can use many sockets */
name|cfg
operator|->
name|outgoing_num_ports
operator|=
literal|4096
expr_stmt|;
name|cfg
operator|->
name|num_queries_per_thread
operator|=
literal|1024
expr_stmt|;
endif|#
directive|endif
name|cfg
operator|->
name|outgoing_num_tcp
operator|=
literal|10
expr_stmt|;
name|cfg
operator|->
name|incoming_num_tcp
operator|=
literal|10
expr_stmt|;
else|#
directive|else
name|cfg
operator|->
name|outgoing_num_ports
operator|=
literal|48
expr_stmt|;
comment|/* windows is limited in num fds */
name|cfg
operator|->
name|num_queries_per_thread
operator|=
literal|24
expr_stmt|;
name|cfg
operator|->
name|outgoing_num_tcp
operator|=
literal|2
expr_stmt|;
comment|/* leaves 64-52=12 for: 4if,1stop,thread4 */
name|cfg
operator|->
name|incoming_num_tcp
operator|=
literal|2
expr_stmt|;
endif|#
directive|endif
name|cfg
operator|->
name|edns_buffer_size
operator|=
literal|4096
expr_stmt|;
comment|/* 4k from rfc recommendation */
name|cfg
operator|->
name|msg_buffer_size
operator|=
literal|65552
expr_stmt|;
comment|/* 64 k + a small margin */
name|cfg
operator|->
name|msg_cache_size
operator|=
literal|4
operator|*
literal|1024
operator|*
literal|1024
expr_stmt|;
name|cfg
operator|->
name|msg_cache_slabs
operator|=
literal|4
expr_stmt|;
name|cfg
operator|->
name|jostle_time
operator|=
literal|200
expr_stmt|;
name|cfg
operator|->
name|rrset_cache_size
operator|=
literal|4
operator|*
literal|1024
operator|*
literal|1024
expr_stmt|;
name|cfg
operator|->
name|rrset_cache_slabs
operator|=
literal|4
expr_stmt|;
name|cfg
operator|->
name|host_ttl
operator|=
literal|900
expr_stmt|;
name|cfg
operator|->
name|bogus_ttl
operator|=
literal|60
expr_stmt|;
name|cfg
operator|->
name|min_ttl
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|max_ttl
operator|=
literal|3600
operator|*
literal|24
expr_stmt|;
name|cfg
operator|->
name|prefetch
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|prefetch_key
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|infra_cache_slabs
operator|=
literal|4
expr_stmt|;
name|cfg
operator|->
name|infra_cache_numhosts
operator|=
literal|10000
expr_stmt|;
name|cfg
operator|->
name|delay_close
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|cfg
operator|->
name|outgoing_avail_ports
operator|=
operator|(
name|int
operator|*
operator|)
name|calloc
argument_list|(
literal|65536
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
operator|)
condition|)
goto|goto
name|error_exit
goto|;
name|init_outgoing_availports
argument_list|(
name|cfg
operator|->
name|outgoing_avail_ports
argument_list|,
literal|65536
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|cfg
operator|->
name|username
operator|=
name|strdup
argument_list|(
name|UB_USERNAME
argument_list|)
operator|)
condition|)
goto|goto
name|error_exit
goto|;
ifdef|#
directive|ifdef
name|HAVE_CHROOT
if|if
condition|(
operator|!
operator|(
name|cfg
operator|->
name|chrootdir
operator|=
name|strdup
argument_list|(
name|CHROOT_DIR
argument_list|)
operator|)
condition|)
goto|goto
name|error_exit
goto|;
endif|#
directive|endif
if|if
condition|(
operator|!
operator|(
name|cfg
operator|->
name|directory
operator|=
name|strdup
argument_list|(
name|RUN_DIR
argument_list|)
operator|)
condition|)
goto|goto
name|error_exit
goto|;
if|if
condition|(
operator|!
operator|(
name|cfg
operator|->
name|logfile
operator|=
name|strdup
argument_list|(
literal|""
argument_list|)
operator|)
condition|)
goto|goto
name|error_exit
goto|;
if|if
condition|(
operator|!
operator|(
name|cfg
operator|->
name|pidfile
operator|=
name|strdup
argument_list|(
name|PIDFILE
argument_list|)
operator|)
condition|)
goto|goto
name|error_exit
goto|;
if|if
condition|(
operator|!
operator|(
name|cfg
operator|->
name|target_fetch_policy
operator|=
name|strdup
argument_list|(
literal|"3 2 1 0 0"
argument_list|)
operator|)
condition|)
goto|goto
name|error_exit
goto|;
name|cfg
operator|->
name|donotqueryaddrs
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|donotquery_localhost
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|root_hints
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|do_daemonize
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|if_automatic
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|so_rcvbuf
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|so_sndbuf
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|so_reuseport
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|num_ifs
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|ifs
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|num_out_ifs
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|out_ifs
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|stubs
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|forwards
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|acls
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|harden_short_bufsize
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|harden_large_queries
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|harden_glue
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|harden_dnssec_stripped
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|harden_below_nxdomain
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|harden_referral_path
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|use_caps_bits_for_id
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|private_address
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|private_domain
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|unwanted_threshold
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|hide_identity
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|hide_version
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|identity
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|version
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|auto_trust_anchor_file_list
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|trust_anchor_file_list
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|trust_anchor_list
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|trusted_keys_file_list
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|dlv_anchor_file
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|dlv_anchor_list
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|domain_insecure
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|val_date_override
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|val_sig_skew_min
operator|=
literal|3600
expr_stmt|;
comment|/* at least daylight savings trouble */
name|cfg
operator|->
name|val_sig_skew_max
operator|=
literal|86400
expr_stmt|;
comment|/* at most timezone settings trouble */
name|cfg
operator|->
name|val_clean_additional
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|val_log_level
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|val_log_squelch
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|val_permissive_mode
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|ignore_cd
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|add_holddown
operator|=
literal|30
operator|*
literal|24
operator|*
literal|3600
expr_stmt|;
name|cfg
operator|->
name|del_holddown
operator|=
literal|30
operator|*
literal|24
operator|*
literal|3600
expr_stmt|;
name|cfg
operator|->
name|keep_missing
operator|=
literal|366
operator|*
literal|24
operator|*
literal|3600
expr_stmt|;
comment|/* one year plus a little leeway */
name|cfg
operator|->
name|key_cache_size
operator|=
literal|4
operator|*
literal|1024
operator|*
literal|1024
expr_stmt|;
name|cfg
operator|->
name|key_cache_slabs
operator|=
literal|4
expr_stmt|;
name|cfg
operator|->
name|neg_cache_size
operator|=
literal|1
operator|*
literal|1024
operator|*
literal|1024
expr_stmt|;
name|cfg
operator|->
name|local_zones
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|local_zones_nodefault
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|local_data
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|unblock_lan_zones
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|python_script
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|remote_control_enable
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|control_ifs
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|control_port
operator|=
name|UNBOUND_CONTROL_PORT
expr_stmt|;
name|cfg
operator|->
name|minimal_responses
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|rrset_roundrobin
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|max_udp_size
operator|=
literal|4096
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|cfg
operator|->
name|server_key_file
operator|=
name|strdup
argument_list|(
name|RUN_DIR
literal|"/unbound_server.key"
argument_list|)
operator|)
condition|)
goto|goto
name|error_exit
goto|;
if|if
condition|(
operator|!
operator|(
name|cfg
operator|->
name|server_cert_file
operator|=
name|strdup
argument_list|(
name|RUN_DIR
literal|"/unbound_server.pem"
argument_list|)
operator|)
condition|)
goto|goto
name|error_exit
goto|;
if|if
condition|(
operator|!
operator|(
name|cfg
operator|->
name|control_key_file
operator|=
name|strdup
argument_list|(
name|RUN_DIR
literal|"/unbound_control.key"
argument_list|)
operator|)
condition|)
goto|goto
name|error_exit
goto|;
if|if
condition|(
operator|!
operator|(
name|cfg
operator|->
name|control_cert_file
operator|=
name|strdup
argument_list|(
name|RUN_DIR
literal|"/unbound_control.pem"
argument_list|)
operator|)
condition|)
goto|goto
name|error_exit
goto|;
if|if
condition|(
operator|!
operator|(
name|cfg
operator|->
name|module_conf
operator|=
name|strdup
argument_list|(
literal|"validator iterator"
argument_list|)
operator|)
condition|)
goto|goto
name|error_exit
goto|;
if|if
condition|(
operator|!
operator|(
name|cfg
operator|->
name|val_nsec3_key_iterations
operator|=
name|strdup
argument_list|(
literal|"1024 150 2048 500 4096 2500"
argument_list|)
operator|)
condition|)
goto|goto
name|error_exit
goto|;
return|return
name|cfg
return|;
name|error_exit
label|:
name|config_delete
argument_list|(
name|cfg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|struct
name|config_file
modifier|*
name|config_create_forlib
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|config_file
modifier|*
name|cfg
init|=
name|config_create
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|cfg
condition|)
return|return
name|NULL
return|;
comment|/* modifications for library use, less verbose, less memory */
name|free
argument_list|(
name|cfg
operator|->
name|chrootdir
argument_list|)
expr_stmt|;
name|cfg
operator|->
name|chrootdir
operator|=
name|NULL
expr_stmt|;
name|cfg
operator|->
name|verbosity
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|outgoing_num_ports
operator|=
literal|16
expr_stmt|;
comment|/* in library use, this is 'reasonable' 		and probably within the ulimit(maxfds) of the user */
name|cfg
operator|->
name|outgoing_num_tcp
operator|=
literal|2
expr_stmt|;
name|cfg
operator|->
name|msg_cache_size
operator|=
literal|1024
operator|*
literal|1024
expr_stmt|;
name|cfg
operator|->
name|msg_cache_slabs
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|rrset_cache_size
operator|=
literal|1024
operator|*
literal|1024
expr_stmt|;
name|cfg
operator|->
name|rrset_cache_slabs
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|infra_cache_slabs
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|use_syslog
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|key_cache_size
operator|=
literal|1024
operator|*
literal|1024
expr_stmt|;
name|cfg
operator|->
name|key_cache_slabs
operator|=
literal|1
expr_stmt|;
name|cfg
operator|->
name|neg_cache_size
operator|=
literal|100
operator|*
literal|1024
expr_stmt|;
name|cfg
operator|->
name|donotquery_localhost
operator|=
literal|0
expr_stmt|;
comment|/* allow, so that you can ask a 		forward nameserver running on localhost */
name|cfg
operator|->
name|val_log_level
operator|=
literal|2
expr_stmt|;
comment|/* to fill why_bogus with */
name|cfg
operator|->
name|val_log_squelch
operator|=
literal|1
expr_stmt|;
return|return
name|cfg
return|;
block|}
end_function

begin_comment
comment|/** check that the value passed is>= 0 */
end_comment

begin_define
define|#
directive|define
name|IS_NUMBER_OR_ZERO
define|\
value|if(atoi(val) == 0&& strcmp(val, "0") != 0) return 0
end_define

begin_comment
comment|/** check that the value passed is> 0 */
end_comment

begin_define
define|#
directive|define
name|IS_NONZERO_NUMBER
define|\
value|if(atoi(val) == 0) return 0
end_define

begin_comment
comment|/** check that the value passed is not 0 and a power of 2 */
end_comment

begin_define
define|#
directive|define
name|IS_POW2_NUMBER
define|\
value|if(atoi(val) == 0 || !is_pow2((size_t)atoi(val))) return 0
end_define

begin_comment
comment|/** check that the value passed is yes or no */
end_comment

begin_define
define|#
directive|define
name|IS_YES_OR_NO
define|\
value|if(strcmp(val, "yes") != 0&& strcmp(val, "no") != 0) return 0
end_define

begin_comment
comment|/** put integer_or_zero into variable */
end_comment

begin_define
define|#
directive|define
name|S_NUMBER_OR_ZERO
parameter_list|(
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str) == 0) \ 	{ IS_NUMBER_OR_ZERO; cfg->var = atoi(val); }
end_define

begin_comment
comment|/** put integer_nonzero into variable */
end_comment

begin_define
define|#
directive|define
name|S_NUMBER_NONZERO
parameter_list|(
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str) == 0) \ 	{ IS_NONZERO_NUMBER; cfg->var = atoi(val); }
end_define

begin_comment
comment|/** put integer_or_zero into unsigned */
end_comment

begin_define
define|#
directive|define
name|S_UNSIGNED_OR_ZERO
parameter_list|(
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str) == 0) \ 	{ IS_NUMBER_OR_ZERO; cfg->var = (unsigned)atoi(val); }
end_define

begin_comment
comment|/** put integer_or_zero into size_t */
end_comment

begin_define
define|#
directive|define
name|S_SIZET_OR_ZERO
parameter_list|(
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str) == 0) \ 	{ IS_NUMBER_OR_ZERO; cfg->var = (size_t)atoi(val); }
end_define

begin_comment
comment|/** put integer_nonzero into size_t */
end_comment

begin_define
define|#
directive|define
name|S_SIZET_NONZERO
parameter_list|(
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str) == 0) \ 	{ IS_NONZERO_NUMBER; cfg->var = (size_t)atoi(val); }
end_define

begin_comment
comment|/** put yesno into variable */
end_comment

begin_define
define|#
directive|define
name|S_YNO
parameter_list|(
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str) == 0) \ 	{ IS_YES_OR_NO; cfg->var = (strcmp(val, "yes") == 0); }
end_define

begin_comment
comment|/** put memsize into variable */
end_comment

begin_define
define|#
directive|define
name|S_MEMSIZE
parameter_list|(
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str)==0) \ 	{ return cfg_parse_memsize(val,&cfg->var); }
end_define

begin_comment
comment|/** put pow2 number into variable */
end_comment

begin_define
define|#
directive|define
name|S_POW2
parameter_list|(
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str)==0) \ 	{ IS_POW2_NUMBER; cfg->var = (size_t)atoi(val); }
end_define

begin_comment
comment|/** put string into variable */
end_comment

begin_define
define|#
directive|define
name|S_STR
parameter_list|(
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str)==0) \ 	{ free(cfg->var); return (cfg->var = strdup(val)) != NULL; }
end_define

begin_comment
comment|/** put string into strlist */
end_comment

begin_define
define|#
directive|define
name|S_STRLIST
parameter_list|(
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str)==0) \ 	{ return cfg_strlist_insert(&cfg->var, strdup(val)); }
end_define

begin_function
name|int
name|config_set_option
parameter_list|(
name|struct
name|config_file
modifier|*
name|cfg
parameter_list|,
specifier|const
name|char
modifier|*
name|opt
parameter_list|,
specifier|const
name|char
modifier|*
name|val
parameter_list|)
block|{
name|S_NUMBER_OR_ZERO
argument_list|(
literal|"verbosity:"
argument_list|,
argument|verbosity
argument_list|)
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"statistics-interval:"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|val
argument_list|,
literal|"0"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|val
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
condition|)
name|cfg
operator|->
name|stat_interval
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|atoi
argument_list|(
name|val
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
else|else
name|cfg
operator|->
name|stat_interval
operator|=
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"num_threads:"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* not supported, library must have 1 thread in bgworker */
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"outgoing-port-permit:"
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|cfg_mark_ports
argument_list|(
name|val
argument_list|,
literal|1
argument_list|,
name|cfg
operator|->
name|outgoing_avail_ports
argument_list|,
literal|65536
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"outgoing-port-avoid:"
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|cfg_mark_ports
argument_list|(
name|val
argument_list|,
literal|0
argument_list|,
name|cfg
operator|->
name|outgoing_avail_ports
argument_list|,
literal|65536
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"local-zone:"
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|cfg_parse_local_zone
argument_list|(
name|cfg
argument_list|,
name|val
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"val-override-date:"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|val
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|val
argument_list|,
literal|"0"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cfg
operator|->
name|val_date_override
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strlen
argument_list|(
name|val
argument_list|)
operator|==
literal|14
condition|)
block|{
name|cfg
operator|->
name|val_date_override
operator|=
name|cfg_convert_timeval
argument_list|(
name|val
argument_list|)
expr_stmt|;
return|return
name|cfg
operator|->
name|val_date_override
operator|!=
literal|0
return|;
block|}
else|else
block|{
if|if
condition|(
name|atoi
argument_list|(
name|val
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|cfg
operator|->
name|val_date_override
operator|=
operator|(
name|uint32_t
operator|)
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"local-data-ptr:"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|ptr
init|=
name|cfg_ptr_reverse
argument_list|(
operator|(
name|char
operator|*
operator|)
name|opt
argument_list|)
decl_stmt|;
return|return
name|cfg_strlist_insert
argument_list|(
operator|&
name|cfg
operator|->
name|local_data
argument_list|,
name|ptr
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"logfile:"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cfg
operator|->
name|use_syslog
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|logfile
argument_list|)
expr_stmt|;
return|return
operator|(
name|cfg
operator|->
name|logfile
operator|=
name|strdup
argument_list|(
name|val
argument_list|)
operator|)
operator|!=
name|NULL
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"log-time-ascii:"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|IS_YES_OR_NO
expr_stmt|;
name|cfg
operator|->
name|log_time_ascii
operator|=
operator|(
name|strcmp
argument_list|(
name|val
argument_list|,
literal|"yes"
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|log_set_time_asc
argument_list|(
name|cfg
operator|->
name|log_time_ascii
argument_list|)
expr_stmt|;
block|}
else|else
name|S_SIZET_NONZERO
argument_list|(
literal|"max-udp-size:"
argument_list|,
argument|max_udp_size
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"use-syslog:"
argument_list|,
argument|use_syslog
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"extended-statistics:"
argument_list|,
argument|stat_extended
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"statistics-cumulative:"
argument_list|,
argument|stat_cumulative
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"do-ip4:"
argument_list|,
argument|do_ip4
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"do-ip6:"
argument_list|,
argument|do_ip6
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"do-udp:"
argument_list|,
argument|do_udp
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"do-tcp:"
argument_list|,
argument|do_tcp
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"tcp-upstream:"
argument_list|,
argument|tcp_upstream
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"ssl-upstream:"
argument_list|,
argument|ssl_upstream
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"ssl-service-key:"
argument_list|,
argument|ssl_service_key
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"ssl-service-pem:"
argument_list|,
argument|ssl_service_pem
argument_list|)
else|else
name|S_NUMBER_NONZERO
argument_list|(
literal|"ssl-port:"
argument_list|,
argument|ssl_port
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"interface-automatic:"
argument_list|,
argument|if_automatic
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"do-daemonize:"
argument_list|,
argument|do_daemonize
argument_list|)
else|else
name|S_NUMBER_NONZERO
argument_list|(
literal|"port:"
argument_list|,
argument|port
argument_list|)
else|else
name|S_NUMBER_NONZERO
argument_list|(
literal|"outgoing-range:"
argument_list|,
argument|outgoing_num_ports
argument_list|)
else|else
name|S_SIZET_OR_ZERO
argument_list|(
literal|"outgoing-num-tcp:"
argument_list|,
argument|outgoing_num_tcp
argument_list|)
else|else
name|S_SIZET_OR_ZERO
argument_list|(
literal|"incoming-num-tcp:"
argument_list|,
argument|incoming_num_tcp
argument_list|)
else|else
name|S_SIZET_NONZERO
argument_list|(
literal|"edns-buffer-size:"
argument_list|,
argument|edns_buffer_size
argument_list|)
else|else
name|S_SIZET_NONZERO
argument_list|(
literal|"msg-buffer-size:"
argument_list|,
argument|msg_buffer_size
argument_list|)
else|else
name|S_MEMSIZE
argument_list|(
literal|"msg-cache-size:"
argument_list|,
argument|msg_cache_size
argument_list|)
else|else
name|S_POW2
argument_list|(
literal|"msg-cache-slabs:"
argument_list|,
argument|msg_cache_slabs
argument_list|)
else|else
name|S_SIZET_NONZERO
argument_list|(
literal|"num-queries-per-thread:"
argument_list|,
argument|num_queries_per_thread
argument_list|)
else|else
name|S_SIZET_OR_ZERO
argument_list|(
literal|"jostle-timeout:"
argument_list|,
argument|jostle_time
argument_list|)
else|else
name|S_MEMSIZE
argument_list|(
literal|"so-rcvbuf:"
argument_list|,
argument|so_rcvbuf
argument_list|)
else|else
name|S_MEMSIZE
argument_list|(
literal|"so-sndbuf:"
argument_list|,
argument|so_sndbuf
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"so-reuseport:"
argument_list|,
argument|so_reuseport
argument_list|)
else|else
name|S_MEMSIZE
argument_list|(
literal|"rrset-cache-size:"
argument_list|,
argument|rrset_cache_size
argument_list|)
else|else
name|S_POW2
argument_list|(
literal|"rrset-cache-slabs:"
argument_list|,
argument|rrset_cache_slabs
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"prefetch:"
argument_list|,
argument|prefetch
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"prefetch-key:"
argument_list|,
argument|prefetch_key
argument_list|)
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"cache-max-ttl:"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|IS_NUMBER_OR_ZERO
expr_stmt|;
name|cfg
operator|->
name|max_ttl
operator|=
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|MAX_TTL
operator|=
operator|(
name|time_t
operator|)
name|cfg
operator|->
name|max_ttl
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"cache-min-ttl:"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|IS_NUMBER_OR_ZERO
expr_stmt|;
name|cfg
operator|->
name|min_ttl
operator|=
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|MIN_TTL
operator|=
operator|(
name|time_t
operator|)
name|cfg
operator|->
name|min_ttl
expr_stmt|;
block|}
else|else
name|S_NUMBER_OR_ZERO
argument_list|(
literal|"infra-host-ttl:"
argument_list|,
argument|host_ttl
argument_list|)
else|else
name|S_POW2
argument_list|(
literal|"infra-cache-slabs:"
argument_list|,
argument|infra_cache_slabs
argument_list|)
else|else
name|S_SIZET_NONZERO
argument_list|(
literal|"infra-cache-numhosts:"
argument_list|,
argument|infra_cache_numhosts
argument_list|)
else|else
name|S_NUMBER_OR_ZERO
argument_list|(
literal|"delay-close:"
argument_list|,
argument|delay_close
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"chroot:"
argument_list|,
argument|chrootdir
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"username:"
argument_list|,
argument|username
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"directory:"
argument_list|,
argument|directory
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"pidfile:"
argument_list|,
argument|pidfile
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"hide-identity:"
argument_list|,
argument|hide_identity
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"hide-version:"
argument_list|,
argument|hide_version
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"identity:"
argument_list|,
argument|identity
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"version:"
argument_list|,
argument|version
argument_list|)
else|else
name|S_STRLIST
argument_list|(
literal|"root-hints:"
argument_list|,
argument|root_hints
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"target-fetch-policy:"
argument_list|,
argument|target_fetch_policy
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"harden-glue:"
argument_list|,
argument|harden_glue
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"harden-short-bufsize:"
argument_list|,
argument|harden_short_bufsize
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"harden-large-queries:"
argument_list|,
argument|harden_large_queries
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"harden-dnssec-stripped:"
argument_list|,
argument|harden_dnssec_stripped
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"harden-below-nxdomain:"
argument_list|,
argument|harden_below_nxdomain
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"harden-referral-path:"
argument_list|,
argument|harden_referral_path
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"use-caps-for-id"
argument_list|,
argument|use_caps_bits_for_id
argument_list|)
else|else
name|S_SIZET_OR_ZERO
argument_list|(
literal|"unwanted-reply-threshold:"
argument_list|,
argument|unwanted_threshold
argument_list|)
else|else
name|S_STRLIST
argument_list|(
literal|"private-address:"
argument_list|,
argument|private_address
argument_list|)
else|else
name|S_STRLIST
argument_list|(
literal|"private-domain:"
argument_list|,
argument|private_domain
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"do-not-query-localhost:"
argument_list|,
argument|donotquery_localhost
argument_list|)
else|else
name|S_STRLIST
argument_list|(
literal|"do-not-query-address:"
argument_list|,
argument|donotqueryaddrs
argument_list|)
else|else
name|S_STRLIST
argument_list|(
literal|"auto-trust-anchor-file:"
argument_list|,
argument|auto_trust_anchor_file_list
argument_list|)
else|else
name|S_STRLIST
argument_list|(
literal|"trust-anchor-file:"
argument_list|,
argument|trust_anchor_file_list
argument_list|)
else|else
name|S_STRLIST
argument_list|(
literal|"trust-anchor:"
argument_list|,
argument|trust_anchor_list
argument_list|)
else|else
name|S_STRLIST
argument_list|(
literal|"trusted-keys-file:"
argument_list|,
argument|trusted_keys_file_list
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"dlv-anchor-file:"
argument_list|,
argument|dlv_anchor_file
argument_list|)
else|else
name|S_STRLIST
argument_list|(
literal|"dlv-anchor:"
argument_list|,
argument|dlv_anchor_list
argument_list|)
else|else
name|S_STRLIST
argument_list|(
literal|"domain-insecure:"
argument_list|,
argument|domain_insecure
argument_list|)
else|else
name|S_NUMBER_OR_ZERO
argument_list|(
literal|"val-bogus-ttl:"
argument_list|,
argument|bogus_ttl
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"val-clean-additional:"
argument_list|,
argument|val_clean_additional
argument_list|)
else|else
name|S_NUMBER_OR_ZERO
argument_list|(
literal|"val-log-level:"
argument_list|,
argument|val_log_level
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"val-log-squelch:"
argument_list|,
argument|val_log_squelch
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"log-queries:"
argument_list|,
argument|log_queries
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"val-permissive-mode:"
argument_list|,
argument|val_permissive_mode
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"ignore-cd-flag:"
argument_list|,
argument|ignore_cd
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"val-nsec3-keysize-iterations:"
argument_list|,
argument|val_nsec3_key_iterations
argument_list|)
else|else
name|S_UNSIGNED_OR_ZERO
argument_list|(
literal|"add-holddown:"
argument_list|,
argument|add_holddown
argument_list|)
else|else
name|S_UNSIGNED_OR_ZERO
argument_list|(
literal|"del-holddown:"
argument_list|,
argument|del_holddown
argument_list|)
else|else
name|S_UNSIGNED_OR_ZERO
argument_list|(
literal|"keep-missing:"
argument_list|,
argument|keep_missing
argument_list|)
else|else
name|S_MEMSIZE
argument_list|(
literal|"key-cache-size:"
argument_list|,
argument|key_cache_size
argument_list|)
else|else
name|S_POW2
argument_list|(
literal|"key-cache-slabs:"
argument_list|,
argument|key_cache_slabs
argument_list|)
else|else
name|S_MEMSIZE
argument_list|(
literal|"neg-cache-size:"
argument_list|,
argument|neg_cache_size
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"minimal-responses:"
argument_list|,
argument|minimal_responses
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"rrset-roundrobin:"
argument_list|,
argument|rrset_roundrobin
argument_list|)
else|else
name|S_STRLIST
argument_list|(
literal|"local-data:"
argument_list|,
argument|local_data
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"unblock-lan-zones:"
argument_list|,
argument|unblock_lan_zones
argument_list|)
else|else
name|S_YNO
argument_list|(
literal|"control-enable:"
argument_list|,
argument|remote_control_enable
argument_list|)
else|else
name|S_STRLIST
argument_list|(
literal|"control-interface:"
argument_list|,
argument|control_ifs
argument_list|)
else|else
name|S_NUMBER_NONZERO
argument_list|(
literal|"control-port:"
argument_list|,
argument|control_port
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"server-key-file:"
argument_list|,
argument|server_key_file
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"server-cert-file:"
argument_list|,
argument|server_cert_file
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"control-key-file:"
argument_list|,
argument|control_key_file
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"control-cert-file:"
argument_list|,
argument|control_cert_file
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"module-config:"
argument_list|,
argument|module_conf
argument_list|)
else|else
name|S_STR
argument_list|(
literal|"python-script:"
argument_list|,
argument|python_script
argument_list|)
comment|/* val_sig_skew_min and max are copied into val_env during init, 	 * so this does not update val_env with set_option */
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"val-sig-skew-min:"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|IS_NUMBER_OR_ZERO
expr_stmt|;
name|cfg
operator|->
name|val_sig_skew_min
operator|=
operator|(
name|int32_t
operator|)
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"val-sig-skew-max:"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|IS_NUMBER_OR_ZERO
expr_stmt|;
name|cfg
operator|->
name|val_sig_skew_max
operator|=
operator|(
name|int32_t
operator|)
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
argument_list|,
literal|"outgoing-interface:"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|d
init|=
name|strdup
argument_list|(
name|val
argument_list|)
decl_stmt|;
name|char
modifier|*
modifier|*
name|oi
init|=
operator|(
name|char
operator|*
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|cfg
operator|->
name|num_out_ifs
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|d
operator|||
operator|!
name|oi
condition|)
block|{
name|free
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|oi
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|cfg
operator|->
name|out_ifs
operator|&&
name|cfg
operator|->
name|num_out_ifs
condition|)
block|{
name|memmove
argument_list|(
name|oi
argument_list|,
name|cfg
operator|->
name|out_ifs
argument_list|,
name|cfg
operator|->
name|num_out_ifs
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|out_ifs
argument_list|)
expr_stmt|;
block|}
name|oi
index|[
name|cfg
operator|->
name|num_out_ifs
operator|++
index|]
operator|=
name|d
expr_stmt|;
name|cfg
operator|->
name|out_ifs
operator|=
name|oi
expr_stmt|;
block|}
else|else
block|{
comment|/* unknown or unsupported (from the set_option interface): 		 * interface, outgoing-interface, access-control,  		 * stub-zone, name, stub-addr, stub-host, stub-prime 		 * forward-first, stub-first, 		 * forward-zone, name, forward-addr, forward-host */
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|config_print_func
parameter_list|(
name|char
modifier|*
name|line
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|FILE
modifier|*
name|f
init|=
operator|(
name|FILE
operator|*
operator|)
name|arg
decl_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** collate func arg */
end_comment

begin_struct
struct|struct
name|config_collate_arg
block|{
comment|/** list of result items */
name|struct
name|config_strlist_head
name|list
decl_stmt|;
comment|/** if a malloc error occurred, 0 is OK */
name|int
name|status
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|config_collate_func
parameter_list|(
name|char
modifier|*
name|line
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|config_collate_arg
modifier|*
name|m
init|=
operator|(
expr|struct
name|config_collate_arg
operator|*
operator|)
name|arg
decl_stmt|;
if|if
condition|(
name|m
operator|->
name|status
condition|)
return|return;
if|if
condition|(
operator|!
name|cfg_strlist_append
argument_list|(
operator|&
name|m
operator|->
name|list
argument_list|,
name|strdup
argument_list|(
name|line
argument_list|)
argument_list|)
condition|)
name|m
operator|->
name|status
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|int
name|config_get_option_list
parameter_list|(
name|struct
name|config_file
modifier|*
name|cfg
parameter_list|,
specifier|const
name|char
modifier|*
name|opt
parameter_list|,
name|struct
name|config_strlist
modifier|*
modifier|*
name|list
parameter_list|)
block|{
name|struct
name|config_collate_arg
name|m
decl_stmt|;
name|memset
argument_list|(
operator|&
name|m
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|m
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|list
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|config_get_option
argument_list|(
name|cfg
argument_list|,
name|opt
argument_list|,
name|config_collate_func
argument_list|,
operator|&
name|m
argument_list|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|m
operator|.
name|status
condition|)
block|{
name|config_delstrlist
argument_list|(
name|m
operator|.
name|list
operator|.
name|first
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
block|}
operator|*
name|list
operator|=
name|m
operator|.
name|list
operator|.
name|first
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|config_get_option_collate
parameter_list|(
name|struct
name|config_file
modifier|*
name|cfg
parameter_list|,
specifier|const
name|char
modifier|*
name|opt
parameter_list|,
name|char
modifier|*
modifier|*
name|str
parameter_list|)
block|{
name|struct
name|config_strlist
modifier|*
name|list
init|=
name|NULL
decl_stmt|;
name|int
name|r
decl_stmt|;
operator|*
name|str
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|config_get_option_list
argument_list|(
name|cfg
argument_list|,
name|opt
argument_list|,
operator|&
name|list
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|r
return|;
operator|*
name|str
operator|=
name|config_collate_cat
argument_list|(
name|list
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|str
condition|)
return|return
literal|2
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|config_collate_cat
parameter_list|(
name|struct
name|config_strlist
modifier|*
name|list
parameter_list|)
block|{
name|size_t
name|total
init|=
literal|0
decl_stmt|,
name|left
decl_stmt|;
name|struct
name|config_strlist
modifier|*
name|s
decl_stmt|;
name|char
modifier|*
name|r
decl_stmt|,
modifier|*
name|w
decl_stmt|;
if|if
condition|(
operator|!
name|list
condition|)
comment|/* no elements */
return|return
name|strdup
argument_list|(
literal|""
argument_list|)
return|;
if|if
condition|(
name|list
operator|->
name|next
operator|==
name|NULL
condition|)
comment|/* one element , no newline at end. */
return|return
name|strdup
argument_list|(
name|list
operator|->
name|str
argument_list|)
return|;
comment|/* count total length */
for|for
control|(
name|s
operator|=
name|list
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
name|total
operator|+=
name|strlen
argument_list|(
name|s
operator|->
name|str
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* len + newline */
name|left
operator|=
name|total
operator|+
literal|1
expr_stmt|;
comment|/* one extra for nul at end */
name|r
operator|=
name|malloc
argument_list|(
name|left
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
return|return
name|NULL
return|;
name|w
operator|=
name|r
expr_stmt|;
for|for
control|(
name|s
operator|=
name|list
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
name|size_t
name|this
init|=
name|strlen
argument_list|(
name|s
operator|->
name|str
argument_list|)
decl_stmt|;
if|if
condition|(
name|this
operator|+
literal|2
operator|>
name|left
condition|)
block|{
comment|/* sanity check */
name|free
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|snprintf
argument_list|(
name|w
argument_list|,
name|left
argument_list|,
literal|"%s\n"
argument_list|,
name|s
operator|->
name|str
argument_list|)
expr_stmt|;
name|this
operator|=
name|strlen
argument_list|(
name|w
argument_list|)
expr_stmt|;
name|w
operator|+=
name|this
expr_stmt|;
name|left
operator|-=
name|this
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/** compare and print decimal option */
end_comment

begin_define
define|#
directive|define
name|O_DEC
parameter_list|(
name|opt
parameter_list|,
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str)==0) \ 	{snprintf(buf, len, "%d", (int)cfg->var); \ 	func(buf, arg);}
end_define

begin_comment
comment|/** compare and print unsigned option */
end_comment

begin_define
define|#
directive|define
name|O_UNS
parameter_list|(
name|opt
parameter_list|,
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str)==0) \ 	{snprintf(buf, len, "%u", (unsigned)cfg->var); \ 	func(buf, arg);}
end_define

begin_comment
comment|/** compare and print yesno option */
end_comment

begin_define
define|#
directive|define
name|O_YNO
parameter_list|(
name|opt
parameter_list|,
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str)==0) \ 	{func(cfg->var?"yes":"no", arg);}
end_define

begin_comment
comment|/** compare and print string option */
end_comment

begin_define
define|#
directive|define
name|O_STR
parameter_list|(
name|opt
parameter_list|,
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str)==0) \ 	{func(cfg->var?cfg->var:"", arg);}
end_define

begin_comment
comment|/** compare and print array option */
end_comment

begin_define
define|#
directive|define
name|O_IFC
parameter_list|(
name|opt
parameter_list|,
name|str
parameter_list|,
name|num
parameter_list|,
name|arr
parameter_list|)
value|if(strcmp(opt, str)==0) \ 	{int i; for(i=0; i<cfg->num; i++) func(cfg->arr[i], arg);}
end_define

begin_comment
comment|/** compare and print memorysize option */
end_comment

begin_define
define|#
directive|define
name|O_MEM
parameter_list|(
name|opt
parameter_list|,
name|str
parameter_list|,
name|var
parameter_list|)
value|if(strcmp(opt, str)==0) { \ 	if(cfg->var> 1024*1024*1024) {	\ 	  size_t f=cfg->var/(size_t)1000000, b=cfg->var%(size_t)1000000; \ 	  snprintf(buf, len, "%u%6.6u\n", (unsigned)f, (unsigned)b); \ 	} else snprintf(buf, len, "%u\n", (unsigned)cfg->var); \ 	func(buf, arg);}
end_define

begin_comment
comment|/** compare and print list option */
end_comment

begin_define
define|#
directive|define
name|O_LST
parameter_list|(
name|opt
parameter_list|,
name|name
parameter_list|,
name|lst
parameter_list|)
value|if(strcmp(opt, name)==0) { \ 	struct config_strlist* p = cfg->lst; \ 	for(p = cfg->lst; p; p = p->next) \ 		func(p->str, arg); \ 	}
end_define

begin_comment
comment|/** compare and print list option */
end_comment

begin_define
define|#
directive|define
name|O_LS2
parameter_list|(
name|opt
parameter_list|,
name|name
parameter_list|,
name|lst
parameter_list|)
value|if(strcmp(opt, name)==0) { \ 	struct config_str2list* p = cfg->lst; \ 	for(p = cfg->lst; p; p = p->next) \ 		snprintf(buf, len, "%s %s\n", p->str, p->str2); \ 		func(buf, arg); \ 	}
end_define

begin_function
name|int
name|config_get_option
parameter_list|(
name|struct
name|config_file
modifier|*
name|cfg
parameter_list|,
specifier|const
name|char
modifier|*
name|opt
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|char
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|size_t
name|len
init|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|fptr_ok
argument_list|(
name|fptr_whitelist_print_func
argument_list|(
name|func
argument_list|)
argument_list|)
expr_stmt|;
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"verbosity"
argument_list|,
argument|verbosity
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"statistics-interval"
argument_list|,
argument|stat_interval
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"statistics-cumulative"
argument_list|,
argument|stat_cumulative
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"extended-statistics"
argument_list|,
argument|stat_extended
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"use-syslog"
argument_list|,
argument|use_syslog
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"log-time-ascii"
argument_list|,
argument|log_time_ascii
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"num-threads"
argument_list|,
argument|num_threads
argument_list|)
else|else
name|O_IFC
argument_list|(
argument|opt
argument_list|,
literal|"interface"
argument_list|,
argument|num_ifs
argument_list|,
argument|ifs
argument_list|)
else|else
name|O_IFC
argument_list|(
argument|opt
argument_list|,
literal|"outgoing-interface"
argument_list|,
argument|num_out_ifs
argument_list|,
argument|out_ifs
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"interface-automatic"
argument_list|,
argument|if_automatic
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"port"
argument_list|,
argument|port
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"outgoing-range"
argument_list|,
argument|outgoing_num_ports
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"outgoing-num-tcp"
argument_list|,
argument|outgoing_num_tcp
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"incoming-num-tcp"
argument_list|,
argument|incoming_num_tcp
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"edns-buffer-size"
argument_list|,
argument|edns_buffer_size
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"msg-buffer-size"
argument_list|,
argument|msg_buffer_size
argument_list|)
else|else
name|O_MEM
argument_list|(
argument|opt
argument_list|,
literal|"msg-cache-size"
argument_list|,
argument|msg_cache_size
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"msg-cache-slabs"
argument_list|,
argument|msg_cache_slabs
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"num-queries-per-thread"
argument_list|,
argument|num_queries_per_thread
argument_list|)
else|else
name|O_UNS
argument_list|(
argument|opt
argument_list|,
literal|"jostle-timeout"
argument_list|,
argument|jostle_time
argument_list|)
else|else
name|O_MEM
argument_list|(
argument|opt
argument_list|,
literal|"so-rcvbuf"
argument_list|,
argument|so_rcvbuf
argument_list|)
else|else
name|O_MEM
argument_list|(
argument|opt
argument_list|,
literal|"so-sndbuf"
argument_list|,
argument|so_sndbuf
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"so-reuseport"
argument_list|,
argument|so_reuseport
argument_list|)
else|else
name|O_MEM
argument_list|(
argument|opt
argument_list|,
literal|"rrset-cache-size"
argument_list|,
argument|rrset_cache_size
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"rrset-cache-slabs"
argument_list|,
argument|rrset_cache_slabs
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"prefetch-key"
argument_list|,
argument|prefetch_key
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"prefetch"
argument_list|,
argument|prefetch
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"cache-max-ttl"
argument_list|,
argument|max_ttl
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"cache-min-ttl"
argument_list|,
argument|min_ttl
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"infra-host-ttl"
argument_list|,
argument|host_ttl
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"infra-cache-slabs"
argument_list|,
argument|infra_cache_slabs
argument_list|)
else|else
name|O_MEM
argument_list|(
argument|opt
argument_list|,
literal|"infra-cache-numhosts"
argument_list|,
argument|infra_cache_numhosts
argument_list|)
else|else
name|O_UNS
argument_list|(
argument|opt
argument_list|,
literal|"delay-close"
argument_list|,
argument|delay_close
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"do-ip4"
argument_list|,
argument|do_ip4
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"do-ip6"
argument_list|,
argument|do_ip6
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"do-udp"
argument_list|,
argument|do_udp
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"do-tcp"
argument_list|,
argument|do_tcp
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"tcp-upstream"
argument_list|,
argument|tcp_upstream
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"ssl-upstream"
argument_list|,
argument|ssl_upstream
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"ssl-service-key"
argument_list|,
argument|ssl_service_key
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"ssl-service-pem"
argument_list|,
argument|ssl_service_pem
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"ssl-port"
argument_list|,
argument|ssl_port
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"do-daemonize"
argument_list|,
argument|do_daemonize
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"chroot"
argument_list|,
argument|chrootdir
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"username"
argument_list|,
argument|username
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"directory"
argument_list|,
argument|directory
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"logfile"
argument_list|,
argument|logfile
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"log-queries"
argument_list|,
argument|log_queries
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"pidfile"
argument_list|,
argument|pidfile
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"hide-identity"
argument_list|,
argument|hide_identity
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"hide-version"
argument_list|,
argument|hide_version
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"identity"
argument_list|,
argument|identity
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"version"
argument_list|,
argument|version
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"target-fetch-policy"
argument_list|,
argument|target_fetch_policy
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"harden-short-bufsize"
argument_list|,
argument|harden_short_bufsize
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"harden-large-queries"
argument_list|,
argument|harden_large_queries
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"harden-glue"
argument_list|,
argument|harden_glue
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"harden-dnssec-stripped"
argument_list|,
argument|harden_dnssec_stripped
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"harden-below-nxdomain"
argument_list|,
argument|harden_below_nxdomain
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"harden-referral-path"
argument_list|,
argument|harden_referral_path
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"use-caps-for-id"
argument_list|,
argument|use_caps_bits_for_id
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"unwanted-reply-threshold"
argument_list|,
argument|unwanted_threshold
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"do-not-query-localhost"
argument_list|,
argument|donotquery_localhost
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"module-config"
argument_list|,
argument|module_conf
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"dlv-anchor-file"
argument_list|,
argument|dlv_anchor_file
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"val-bogus-ttl"
argument_list|,
argument|bogus_ttl
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"val-clean-additional"
argument_list|,
argument|val_clean_additional
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"val-log-level"
argument_list|,
argument|val_log_level
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"val-permissive-mode"
argument_list|,
argument|val_permissive_mode
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"ignore-cd-flag"
argument_list|,
argument|ignore_cd
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"val-nsec3-keysize-iterations"
argument_list|,
argument|val_nsec3_key_iterations
argument_list|)
else|else
name|O_UNS
argument_list|(
argument|opt
argument_list|,
literal|"add-holddown"
argument_list|,
argument|add_holddown
argument_list|)
else|else
name|O_UNS
argument_list|(
argument|opt
argument_list|,
literal|"del-holddown"
argument_list|,
argument|del_holddown
argument_list|)
else|else
name|O_UNS
argument_list|(
argument|opt
argument_list|,
literal|"keep-missing"
argument_list|,
argument|keep_missing
argument_list|)
else|else
name|O_MEM
argument_list|(
argument|opt
argument_list|,
literal|"key-cache-size"
argument_list|,
argument|key_cache_size
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"key-cache-slabs"
argument_list|,
argument|key_cache_slabs
argument_list|)
else|else
name|O_MEM
argument_list|(
argument|opt
argument_list|,
literal|"neg-cache-size"
argument_list|,
argument|neg_cache_size
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"control-enable"
argument_list|,
argument|remote_control_enable
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"control-port"
argument_list|,
argument|control_port
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"server-key-file"
argument_list|,
argument|server_key_file
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"server-cert-file"
argument_list|,
argument|server_cert_file
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"control-key-file"
argument_list|,
argument|control_key_file
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"control-cert-file"
argument_list|,
argument|control_cert_file
argument_list|)
else|else
name|O_LST
argument_list|(
argument|opt
argument_list|,
literal|"root-hints"
argument_list|,
argument|root_hints
argument_list|)
else|else
name|O_LS2
argument_list|(
argument|opt
argument_list|,
literal|"access-control"
argument_list|,
argument|acls
argument_list|)
else|else
name|O_LST
argument_list|(
argument|opt
argument_list|,
literal|"do-not-query-address"
argument_list|,
argument|donotqueryaddrs
argument_list|)
else|else
name|O_LST
argument_list|(
argument|opt
argument_list|,
literal|"private-address"
argument_list|,
argument|private_address
argument_list|)
else|else
name|O_LST
argument_list|(
argument|opt
argument_list|,
literal|"private-domain"
argument_list|,
argument|private_domain
argument_list|)
else|else
name|O_LST
argument_list|(
argument|opt
argument_list|,
literal|"auto-trust-anchor-file"
argument_list|,
argument|auto_trust_anchor_file_list
argument_list|)
else|else
name|O_LST
argument_list|(
argument|opt
argument_list|,
literal|"trust-anchor-file"
argument_list|,
argument|trust_anchor_file_list
argument_list|)
else|else
name|O_LST
argument_list|(
argument|opt
argument_list|,
literal|"trust-anchor"
argument_list|,
argument|trust_anchor_list
argument_list|)
else|else
name|O_LST
argument_list|(
argument|opt
argument_list|,
literal|"trusted-keys-file"
argument_list|,
argument|trusted_keys_file_list
argument_list|)
else|else
name|O_LST
argument_list|(
argument|opt
argument_list|,
literal|"dlv-anchor"
argument_list|,
argument|dlv_anchor_list
argument_list|)
else|else
name|O_LST
argument_list|(
argument|opt
argument_list|,
literal|"control-interface"
argument_list|,
argument|control_ifs
argument_list|)
else|else
name|O_LST
argument_list|(
argument|opt
argument_list|,
literal|"domain-insecure"
argument_list|,
argument|domain_insecure
argument_list|)
else|else
name|O_UNS
argument_list|(
argument|opt
argument_list|,
literal|"val-override-date"
argument_list|,
argument|val_date_override
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"minimal-responses"
argument_list|,
argument|minimal_responses
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"rrset-roundrobin"
argument_list|,
argument|rrset_roundrobin
argument_list|)
else|else
name|O_YNO
argument_list|(
argument|opt
argument_list|,
literal|"unblock-lan-zones"
argument_list|,
argument|unblock_lan_zones
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"max-udp-size"
argument_list|,
argument|max_udp_size
argument_list|)
else|else
name|O_STR
argument_list|(
argument|opt
argument_list|,
literal|"python-script"
argument_list|,
argument|python_script
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"val-sig-skew-min"
argument_list|,
argument|val_sig_skew_min
argument_list|)
else|else
name|O_DEC
argument_list|(
argument|opt
argument_list|,
literal|"val-sig-skew-max"
argument_list|,
argument|val_sig_skew_max
argument_list|)
comment|/* not here: 	 * outgoing-permit, outgoing-avoid - have list of ports 	 * local-zone - zones and nodefault variables 	 * local-data - see below 	 * local-data-ptr - converted to local-data entries 	 * stub-zone, name, stub-addr, stub-host, stub-prime 	 * forward-zone, name, forward-addr, forward-host 	 */
else|else
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/** initialize the global cfg_parser object */
end_comment

begin_function
specifier|static
name|void
name|create_cfg_parser
parameter_list|(
name|struct
name|config_file
modifier|*
name|cfg
parameter_list|,
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|char
modifier|*
name|chroot
parameter_list|)
block|{
specifier|static
name|struct
name|config_parser_state
name|st
decl_stmt|;
name|cfg_parser
operator|=
operator|&
name|st
expr_stmt|;
name|cfg_parser
operator|->
name|filename
operator|=
name|filename
expr_stmt|;
name|cfg_parser
operator|->
name|line
operator|=
literal|1
expr_stmt|;
name|cfg_parser
operator|->
name|errors
operator|=
literal|0
expr_stmt|;
name|cfg_parser
operator|->
name|cfg
operator|=
name|cfg
expr_stmt|;
name|cfg_parser
operator|->
name|chroot
operator|=
name|chroot
expr_stmt|;
name|init_cfg_parse
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|config_read
parameter_list|(
name|struct
name|config_file
modifier|*
name|cfg
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|char
modifier|*
name|chroot
parameter_list|)
block|{
name|FILE
modifier|*
name|in
decl_stmt|;
name|char
modifier|*
name|fname
init|=
operator|(
name|char
operator|*
operator|)
name|filename
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_GLOB
name|glob_t
name|g
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|int
name|r
decl_stmt|,
name|flags
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|fname
condition|)
return|return
literal|1
return|;
comment|/* check for wildcards */
ifdef|#
directive|ifdef
name|HAVE_GLOB
if|if
condition|(
operator|!
operator|(
operator|!
name|strchr
argument_list|(
name|fname
argument_list|,
literal|'*'
argument_list|)
operator|&&
operator|!
name|strchr
argument_list|(
name|fname
argument_list|,
literal|'?'
argument_list|)
operator|&&
operator|!
name|strchr
argument_list|(
name|fname
argument_list|,
literal|'['
argument_list|)
operator|&&
operator|!
name|strchr
argument_list|(
name|fname
argument_list|,
literal|'{'
argument_list|)
operator|&&
operator|!
name|strchr
argument_list|(
name|fname
argument_list|,
literal|'~'
argument_list|)
operator|)
condition|)
block|{
name|verbose
argument_list|(
name|VERB_QUERY
argument_list|,
literal|"wildcard found, processing %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|flags
operator|=
literal|0
ifdef|#
directive|ifdef
name|GLOB_ERR
operator||
name|GLOB_ERR
endif|#
directive|endif
ifdef|#
directive|ifdef
name|GLOB_NOSORT
operator||
name|GLOB_NOSORT
endif|#
directive|endif
ifdef|#
directive|ifdef
name|GLOB_BRACE
operator||
name|GLOB_BRACE
endif|#
directive|endif
ifdef|#
directive|ifdef
name|GLOB_TILDE
operator||
name|GLOB_TILDE
endif|#
directive|endif
expr_stmt|;
name|memset
argument_list|(
operator|&
name|g
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|g
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|=
name|glob
argument_list|(
name|fname
argument_list|,
name|flags
argument_list|,
name|NULL
argument_list|,
operator|&
name|g
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
comment|/* some error */
name|globfree
argument_list|(
operator|&
name|g
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|GLOB_NOMATCH
condition|)
block|{
name|verbose
argument_list|(
name|VERB_QUERY
argument_list|,
literal|"include: "
literal|"no matches for %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|r
operator|==
name|GLOB_NOSPACE
condition|)
block|{
name|log_err
argument_list|(
literal|"include: %s: "
literal|"fnametern out of memory"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|r
operator|==
name|GLOB_ABORTED
condition|)
block|{
name|log_err
argument_list|(
literal|"wildcard include: %s: expansion "
literal|"aborted (%s)"
argument_list|,
name|fname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log_err
argument_list|(
literal|"wildcard include: %s: expansion "
literal|"failed (%s)"
argument_list|,
name|fname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* ignore globs that yield no files */
return|return
literal|1
return|;
block|}
comment|/* process files found, if any */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|size_t
operator|)
name|g
operator|.
name|gl_pathc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|config_read
argument_list|(
name|cfg
argument_list|,
name|g
operator|.
name|gl_pathv
index|[
name|i
index|]
argument_list|,
name|chroot
argument_list|)
condition|)
block|{
name|log_err
argument_list|(
literal|"error reading wildcard "
literal|"include: %s"
argument_list|,
name|g
operator|.
name|gl_pathv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|globfree
argument_list|(
operator|&
name|g
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|globfree
argument_list|(
operator|&
name|g
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* HAVE_GLOB */
name|in
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in
condition|)
block|{
name|log_err
argument_list|(
literal|"Could not open %s: %s"
argument_list|,
name|fname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|create_cfg_parser
argument_list|(
name|cfg
argument_list|,
name|fname
argument_list|,
name|chroot
argument_list|)
expr_stmt|;
name|ub_c_in
operator|=
name|in
expr_stmt|;
name|ub_c_parse
argument_list|()
expr_stmt|;
name|fclose
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_parser
operator|->
name|errors
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"read %s failed: %d errors in configuration file\n"
argument_list|,
name|cfg_parser
operator|->
name|filename
argument_list|,
name|cfg_parser
operator|->
name|errors
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|config_delstrlist
parameter_list|(
name|struct
name|config_strlist
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|config_strlist
modifier|*
name|np
decl_stmt|;
while|while
condition|(
name|p
condition|)
block|{
name|np
operator|=
name|p
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|np
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|config_deldblstrlist
parameter_list|(
name|struct
name|config_str2list
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|config_str2list
modifier|*
name|np
decl_stmt|;
while|while
condition|(
name|p
condition|)
block|{
name|np
operator|=
name|p
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|str2
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|np
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|config_delstubs
parameter_list|(
name|struct
name|config_stub
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|config_stub
modifier|*
name|np
decl_stmt|;
while|while
condition|(
name|p
condition|)
block|{
name|np
operator|=
name|p
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|name
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|p
operator|->
name|hosts
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|p
operator|->
name|addrs
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|np
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|config_delete
parameter_list|(
name|struct
name|config_file
modifier|*
name|cfg
parameter_list|)
block|{
if|if
condition|(
operator|!
name|cfg
condition|)
return|return;
name|free
argument_list|(
name|cfg
operator|->
name|username
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|chrootdir
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|directory
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|logfile
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|pidfile
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|target_fetch_policy
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|ssl_service_key
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|ssl_service_pem
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|ifs
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfg
operator|->
name|num_ifs
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|cfg
operator|->
name|ifs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|ifs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cfg
operator|->
name|out_ifs
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfg
operator|->
name|num_out_ifs
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|cfg
operator|->
name|out_ifs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|out_ifs
argument_list|)
expr_stmt|;
block|}
name|config_delstubs
argument_list|(
name|cfg
operator|->
name|stubs
argument_list|)
expr_stmt|;
name|config_delstubs
argument_list|(
name|cfg
operator|->
name|forwards
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|cfg
operator|->
name|donotqueryaddrs
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|cfg
operator|->
name|root_hints
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|identity
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|version
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|module_conf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|outgoing_avail_ports
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|cfg
operator|->
name|private_address
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|cfg
operator|->
name|private_domain
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|cfg
operator|->
name|auto_trust_anchor_file_list
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|cfg
operator|->
name|trust_anchor_file_list
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|cfg
operator|->
name|trusted_keys_file_list
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|cfg
operator|->
name|trust_anchor_list
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|cfg
operator|->
name|domain_insecure
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|dlv_anchor_file
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|cfg
operator|->
name|dlv_anchor_list
argument_list|)
expr_stmt|;
name|config_deldblstrlist
argument_list|(
name|cfg
operator|->
name|acls
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|val_nsec3_key_iterations
argument_list|)
expr_stmt|;
name|config_deldblstrlist
argument_list|(
name|cfg
operator|->
name|local_zones
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|cfg
operator|->
name|local_zones_nodefault
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|cfg
operator|->
name|local_data
argument_list|)
expr_stmt|;
name|config_delstrlist
argument_list|(
name|cfg
operator|->
name|control_ifs
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|server_key_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|server_cert_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|control_key_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
operator|->
name|control_cert_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cfg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|init_outgoing_availports
parameter_list|(
name|int
modifier|*
name|a
parameter_list|,
name|int
name|num
parameter_list|)
block|{
comment|/* generated with make iana_update */
specifier|const
name|int
name|iana_assigned
index|[]
init|=
block|{
include|#
directive|include
file|"util/iana_ports.inc"
operator|-
literal|1
block|}
decl_stmt|;
comment|/* end marker to put behind trailing comma */
name|int
name|i
decl_stmt|;
comment|/* do not use<1024, that could be trouble with the system, privs */
for|for
control|(
name|i
operator|=
literal|1024
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|a
index|[
name|i
index|]
operator|=
name|i
expr_stmt|;
block|}
comment|/* create empty spot at 49152 to keep ephemeral ports available  	 * to other programs */
for|for
control|(
name|i
operator|=
literal|49152
init|;
name|i
operator|<
literal|49152
operator|+
literal|256
condition|;
name|i
operator|++
control|)
name|a
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
comment|/* pick out all the IANA assigned ports */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|iana_assigned
index|[
name|i
index|]
operator|!=
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|iana_assigned
index|[
name|i
index|]
operator|<
name|num
condition|)
name|a
index|[
name|iana_assigned
index|[
name|i
index|]
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|cfg_mark_ports
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|int
name|allow
parameter_list|,
name|int
modifier|*
name|avail
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|char
modifier|*
name|mid
init|=
name|strchr
argument_list|(
name|str
argument_list|,
literal|'-'
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|mid
condition|)
block|{
name|int
name|port
init|=
name|atoi
argument_list|(
name|str
argument_list|)
decl_stmt|;
if|if
condition|(
name|port
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|str
argument_list|,
literal|"0"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|log_err
argument_list|(
literal|"cannot parse port number '%s'"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|port
operator|<
name|num
condition|)
name|avail
index|[
name|port
index|]
operator|=
operator|(
name|allow
condition|?
name|port
else|:
literal|0
operator|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|i
decl_stmt|,
name|low
decl_stmt|,
name|high
init|=
name|atoi
argument_list|(
name|mid
operator|+
literal|1
argument_list|)
decl_stmt|;
name|char
name|buf
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
name|high
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|mid
operator|+
literal|1
argument_list|,
literal|"0"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|log_err
argument_list|(
literal|"cannot parse port number '%s'"
argument_list|,
name|mid
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
call|(
name|int
call|)
argument_list|(
name|mid
operator|-
name|str
argument_list|)
operator|+
literal|1
operator|>=
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
block|{
name|log_err
argument_list|(
literal|"cannot parse port number '%s'"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|mid
operator|>
name|str
condition|)
name|memcpy
argument_list|(
name|buf
argument_list|,
name|str
argument_list|,
call|(
name|size_t
call|)
argument_list|(
name|mid
operator|-
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|buf
index|[
name|mid
operator|-
name|str
index|]
operator|=
literal|0
expr_stmt|;
name|low
operator|=
name|atoi
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|low
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"0"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|log_err
argument_list|(
literal|"cannot parse port number '%s'"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
name|low
init|;
name|i
operator|<=
name|high
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|<
name|num
condition|)
name|avail
index|[
name|i
index|]
operator|=
operator|(
name|allow
condition|?
name|i
else|:
literal|0
operator|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cfg_scan_ports
parameter_list|(
name|int
modifier|*
name|avail
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|avail
index|[
name|i
index|]
condition|)
name|count
operator|++
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
name|int
name|cfg_condense_ports
parameter_list|(
name|struct
name|config_file
modifier|*
name|cfg
parameter_list|,
name|int
modifier|*
modifier|*
name|avail
parameter_list|)
block|{
name|int
name|num
init|=
name|cfg_scan_ports
argument_list|(
name|cfg
operator|->
name|outgoing_avail_ports
argument_list|,
literal|65536
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|at
init|=
literal|0
decl_stmt|;
operator|*
name|avail
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|num
operator|==
literal|0
condition|)
return|return
literal|0
return|;
operator|*
name|avail
operator|=
operator|(
name|int
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|*
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|avail
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|65536
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cfg
operator|->
name|outgoing_avail_ports
index|[
name|i
index|]
condition|)
operator|(
operator|*
name|avail
operator|)
index|[
name|at
operator|++
index|]
operator|=
name|cfg
operator|->
name|outgoing_avail_ports
index|[
name|i
index|]
expr_stmt|;
block|}
name|log_assert
argument_list|(
name|at
operator|==
name|num
argument_list|)
expr_stmt|;
return|return
name|num
return|;
block|}
end_function

begin_comment
comment|/** print error with file and line number */
end_comment

begin_function
specifier|static
name|void
name|ub_c_error_va_list
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
name|cfg_parser
operator|->
name|errors
operator|++
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s:%d: error: "
argument_list|,
name|cfg_parser
operator|->
name|filename
argument_list|,
name|cfg_parser
operator|->
name|line
argument_list|)
expr_stmt|;
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|fmt
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** print error with file and line number */
end_comment

begin_function
name|void
name|ub_c_error_msg
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|ub_c_error_va_list
argument_list|(
name|fmt
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ub_c_error
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|cfg_parser
operator|->
name|errors
operator|++
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s:%d: error: %s\n"
argument_list|,
name|cfg_parser
operator|->
name|filename
argument_list|,
name|cfg_parser
operator|->
name|line
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ub_c_wrap
parameter_list|(
name|void
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cfg_strlist_append
parameter_list|(
name|struct
name|config_strlist_head
modifier|*
name|list
parameter_list|,
name|char
modifier|*
name|item
parameter_list|)
block|{
name|struct
name|config_strlist
modifier|*
name|s
decl_stmt|;
if|if
condition|(
operator|!
name|item
operator|||
operator|!
name|list
condition|)
return|return
literal|0
return|;
name|s
operator|=
operator|(
expr|struct
name|config_strlist
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|config_strlist
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s
condition|)
return|return
literal|0
return|;
name|s
operator|->
name|str
operator|=
name|item
expr_stmt|;
name|s
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|list
operator|->
name|last
condition|)
name|list
operator|->
name|last
operator|->
name|next
operator|=
name|s
expr_stmt|;
else|else
name|list
operator|->
name|first
operator|=
name|s
expr_stmt|;
name|list
operator|->
name|last
operator|=
name|s
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cfg_strlist_insert
parameter_list|(
name|struct
name|config_strlist
modifier|*
modifier|*
name|head
parameter_list|,
name|char
modifier|*
name|item
parameter_list|)
block|{
name|struct
name|config_strlist
modifier|*
name|s
decl_stmt|;
if|if
condition|(
operator|!
name|item
operator|||
operator|!
name|head
condition|)
return|return
literal|0
return|;
name|s
operator|=
operator|(
expr|struct
name|config_strlist
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|config_strlist
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s
condition|)
return|return
literal|0
return|;
name|s
operator|->
name|str
operator|=
name|item
expr_stmt|;
name|s
operator|->
name|next
operator|=
operator|*
name|head
expr_stmt|;
operator|*
name|head
operator|=
name|s
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cfg_str2list_insert
parameter_list|(
name|struct
name|config_str2list
modifier|*
modifier|*
name|head
parameter_list|,
name|char
modifier|*
name|item
parameter_list|,
name|char
modifier|*
name|i2
parameter_list|)
block|{
name|struct
name|config_str2list
modifier|*
name|s
decl_stmt|;
if|if
condition|(
operator|!
name|item
operator|||
operator|!
name|i2
operator|||
operator|!
name|head
condition|)
return|return
literal|0
return|;
name|s
operator|=
operator|(
expr|struct
name|config_str2list
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|config_str2list
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s
condition|)
return|return
literal|0
return|;
name|s
operator|->
name|str
operator|=
name|item
expr_stmt|;
name|s
operator|->
name|str2
operator|=
name|i2
expr_stmt|;
name|s
operator|->
name|next
operator|=
operator|*
name|head
expr_stmt|;
operator|*
name|head
operator|=
name|s
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|time_t
name|cfg_convert_timeval
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|time_t
name|t
decl_stmt|;
name|struct
name|tm
name|tm
decl_stmt|;
name|memset
argument_list|(
operator|&
name|tm
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|str
argument_list|)
operator|<
literal|14
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|sscanf
argument_list|(
name|str
argument_list|,
literal|"%4d%2d%2d%2d%2d%2d"
argument_list|,
operator|&
name|tm
operator|.
name|tm_year
argument_list|,
operator|&
name|tm
operator|.
name|tm_mon
argument_list|,
operator|&
name|tm
operator|.
name|tm_mday
argument_list|,
operator|&
name|tm
operator|.
name|tm_hour
argument_list|,
operator|&
name|tm
operator|.
name|tm_min
argument_list|,
operator|&
name|tm
operator|.
name|tm_sec
argument_list|)
operator|!=
literal|6
condition|)
return|return
literal|0
return|;
name|tm
operator|.
name|tm_year
operator|-=
literal|1900
expr_stmt|;
name|tm
operator|.
name|tm_mon
operator|--
expr_stmt|;
comment|/* Check values */
if|if
condition|(
name|tm
operator|.
name|tm_year
operator|<
literal|70
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|tm
operator|.
name|tm_mon
operator|<
literal|0
operator|||
name|tm
operator|.
name|tm_mon
operator|>
literal|11
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|tm
operator|.
name|tm_mday
operator|<
literal|1
operator|||
name|tm
operator|.
name|tm_mday
operator|>
literal|31
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|tm
operator|.
name|tm_hour
operator|<
literal|0
operator|||
name|tm
operator|.
name|tm_hour
operator|>
literal|23
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|tm
operator|.
name|tm_min
operator|<
literal|0
operator|||
name|tm
operator|.
name|tm_min
operator|>
literal|59
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|tm
operator|.
name|tm_sec
operator|<
literal|0
operator|||
name|tm
operator|.
name|tm_sec
operator|>
literal|59
condition|)
return|return
literal|0
return|;
comment|/* call ldns conversion function */
name|t
operator|=
name|sldns_mktime_from_utc
argument_list|(
operator|&
name|tm
argument_list|)
expr_stmt|;
return|return
name|t
return|;
block|}
end_function

begin_function
name|int
name|cfg_count_numbers
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|)
block|{
comment|/* format ::= (sp num)+ sp  */
comment|/* num ::= [-](0-9)+        */
comment|/* sp ::= (space|tab)*      */
name|int
name|num
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|*
name|s
condition|)
block|{
while|while
condition|(
operator|*
name|s
operator|&&
name|isspace
argument_list|(
operator|(
name|int
operator|)
operator|*
name|s
argument_list|)
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|s
condition|)
comment|/* end of string */
break|break;
if|if
condition|(
operator|*
name|s
operator|==
literal|'-'
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|s
condition|)
comment|/* only - not allowed */
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|isdigit
argument_list|(
operator|(
name|int
operator|)
operator|*
name|s
argument_list|)
condition|)
comment|/* bad character */
return|return
literal|0
return|;
while|while
condition|(
operator|*
name|s
operator|&&
name|isdigit
argument_list|(
operator|(
name|int
operator|)
operator|*
name|s
argument_list|)
condition|)
name|s
operator|++
expr_stmt|;
name|num
operator|++
expr_stmt|;
block|}
return|return
name|num
return|;
block|}
end_function

begin_comment
comment|/** all digit number */
end_comment

begin_function
specifier|static
name|int
name|isalldigit
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|size_t
name|l
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|l
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|!
name|isdigit
argument_list|(
name|str
index|[
name|i
index|]
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cfg_parse_memsize
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|size_t
modifier|*
name|res
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|size_t
name|mult
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|str
operator|||
operator|(
name|len
operator|=
operator|(
name|size_t
operator|)
name|strlen
argument_list|(
name|str
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|log_err
argument_list|(
literal|"not a size: '%s'"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|isalldigit
argument_list|(
name|str
argument_list|,
name|len
argument_list|)
condition|)
block|{
operator|*
name|res
operator|=
operator|(
name|size_t
operator|)
name|atol
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
comment|/* check appended num */
while|while
condition|(
name|len
operator|>
literal|0
operator|&&
name|str
index|[
name|len
operator|-
literal|1
index|]
operator|==
literal|' '
condition|)
name|len
operator|--
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
name|str
index|[
name|len
operator|-
literal|1
index|]
operator|==
literal|'b'
condition|)
name|len
operator|--
expr_stmt|;
elseif|else
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
name|str
index|[
name|len
operator|-
literal|1
index|]
operator|==
literal|'B'
condition|)
name|len
operator|--
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
name|tolower
argument_list|(
name|str
index|[
name|len
operator|-
literal|1
index|]
argument_list|)
operator|==
literal|'g'
condition|)
name|mult
operator|=
literal|1024
operator|*
literal|1024
operator|*
literal|1024
expr_stmt|;
elseif|else
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
name|tolower
argument_list|(
name|str
index|[
name|len
operator|-
literal|1
index|]
argument_list|)
operator|==
literal|'m'
condition|)
name|mult
operator|=
literal|1024
operator|*
literal|1024
expr_stmt|;
elseif|else
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
name|tolower
argument_list|(
name|str
index|[
name|len
operator|-
literal|1
index|]
argument_list|)
operator|==
literal|'k'
condition|)
name|mult
operator|=
literal|1024
expr_stmt|;
elseif|else
if|if
condition|(
name|len
operator|>
literal|0
operator|&&
name|isdigit
argument_list|(
name|str
index|[
name|len
operator|-
literal|1
index|]
argument_list|)
condition|)
name|mult
operator|=
literal|1
expr_stmt|;
else|else
block|{
name|log_err
argument_list|(
literal|"unknown size specifier: '%s'"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
while|while
condition|(
name|len
operator|>
literal|1
operator|&&
name|str
index|[
name|len
operator|-
literal|2
index|]
operator|==
literal|' '
condition|)
name|len
operator|--
expr_stmt|;
if|if
condition|(
operator|!
name|isalldigit
argument_list|(
name|str
argument_list|,
name|len
operator|-
literal|1
argument_list|)
condition|)
block|{
name|log_err
argument_list|(
literal|"unknown size specifier: '%s'"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|res
operator|=
operator|(
operator|(
name|size_t
operator|)
name|atol
argument_list|(
name|str
argument_list|)
operator|)
operator|*
name|mult
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|config_apply
parameter_list|(
name|struct
name|config_file
modifier|*
name|config
parameter_list|)
block|{
name|MAX_TTL
operator|=
operator|(
name|time_t
operator|)
name|config
operator|->
name|max_ttl
expr_stmt|;
name|MIN_TTL
operator|=
operator|(
name|time_t
operator|)
name|config
operator|->
name|min_ttl
expr_stmt|;
name|EDNS_ADVERTISED_SIZE
operator|=
operator|(
name|uint16_t
operator|)
name|config
operator|->
name|edns_buffer_size
expr_stmt|;
name|MINIMAL_RESPONSES
operator|=
name|config
operator|->
name|minimal_responses
expr_stmt|;
name|RRSET_ROUNDROBIN
operator|=
name|config
operator|->
name|rrset_roundrobin
expr_stmt|;
name|log_set_time_asc
argument_list|(
name|config
operator|->
name|log_time_ascii
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   * Calculate string length of full pathname in original filesys  * @param fname: the path name to convert.  * 	Must not be null or empty.  * @param cfg: config struct for chroot and chdir (if set).  * @param use_chdir: if false, only chroot is applied.  * @return length of string.  *	remember to allocate one more for 0 at end in mallocs.  */
end_comment

begin_function
specifier|static
name|size_t
name|strlen_after_chroot
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
name|struct
name|config_file
modifier|*
name|cfg
parameter_list|,
name|int
name|use_chdir
parameter_list|)
block|{
name|size_t
name|len
init|=
literal|0
decl_stmt|;
name|int
name|slashit
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|cfg
operator|->
name|chrootdir
operator|&&
name|cfg
operator|->
name|chrootdir
index|[
literal|0
index|]
operator|&&
name|strncmp
argument_list|(
name|cfg
operator|->
name|chrootdir
argument_list|,
name|fname
argument_list|,
name|strlen
argument_list|(
name|cfg
operator|->
name|chrootdir
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* already full pathname, return it */
return|return
name|strlen
argument_list|(
name|fname
argument_list|)
return|;
block|}
comment|/* chroot */
if|if
condition|(
name|cfg
operator|->
name|chrootdir
operator|&&
name|cfg
operator|->
name|chrootdir
index|[
literal|0
index|]
condition|)
block|{
comment|/* start with chrootdir */
name|len
operator|+=
name|strlen
argument_list|(
name|cfg
operator|->
name|chrootdir
argument_list|)
expr_stmt|;
name|slashit
operator|=
literal|1
expr_stmt|;
block|}
comment|/* chdir */
ifdef|#
directive|ifdef
name|UB_ON_WINDOWS
if|if
condition|(
name|fname
index|[
literal|0
index|]
operator|!=
literal|0
operator|&&
name|fname
index|[
literal|1
index|]
operator|==
literal|':'
condition|)
block|{
comment|/* full path, no chdir */
block|}
elseif|else
endif|#
directive|endif
if|if
condition|(
name|fname
index|[
literal|0
index|]
operator|==
literal|'/'
operator|||
operator|!
name|use_chdir
condition|)
block|{
comment|/* full path, no chdir */
block|}
elseif|else
if|if
condition|(
name|cfg
operator|->
name|directory
operator|&&
name|cfg
operator|->
name|directory
index|[
literal|0
index|]
condition|)
block|{
comment|/* prepend chdir */
if|if
condition|(
name|slashit
operator|&&
name|cfg
operator|->
name|directory
index|[
literal|0
index|]
operator|!=
literal|'/'
condition|)
name|len
operator|++
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|chrootdir
operator|&&
name|cfg
operator|->
name|chrootdir
index|[
literal|0
index|]
operator|&&
name|strncmp
argument_list|(
name|cfg
operator|->
name|chrootdir
argument_list|,
name|cfg
operator|->
name|directory
argument_list|,
name|strlen
argument_list|(
name|cfg
operator|->
name|chrootdir
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|len
operator|+=
name|strlen
argument_list|(
name|cfg
operator|->
name|directory
argument_list|)
operator|-
name|strlen
argument_list|(
name|cfg
operator|->
name|chrootdir
argument_list|)
expr_stmt|;
else|else
name|len
operator|+=
name|strlen
argument_list|(
name|cfg
operator|->
name|directory
argument_list|)
expr_stmt|;
name|slashit
operator|=
literal|1
expr_stmt|;
block|}
comment|/* fname */
if|if
condition|(
name|slashit
operator|&&
name|fname
index|[
literal|0
index|]
operator|!=
literal|'/'
condition|)
name|len
operator|++
expr_stmt|;
name|len
operator|+=
name|strlen
argument_list|(
name|fname
argument_list|)
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|fname_after_chroot
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
name|struct
name|config_file
modifier|*
name|cfg
parameter_list|,
name|int
name|use_chdir
parameter_list|)
block|{
name|size_t
name|len
init|=
name|strlen_after_chroot
argument_list|(
name|fname
argument_list|,
name|cfg
argument_list|,
name|use_chdir
argument_list|)
operator|+
literal|1
decl_stmt|;
name|int
name|slashit
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|buf
init|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|len
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
return|return
name|NULL
return|;
name|buf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* is fname already in chroot ? */
if|if
condition|(
name|cfg
operator|->
name|chrootdir
operator|&&
name|cfg
operator|->
name|chrootdir
index|[
literal|0
index|]
operator|&&
name|strncmp
argument_list|(
name|cfg
operator|->
name|chrootdir
argument_list|,
name|fname
argument_list|,
name|strlen
argument_list|(
name|cfg
operator|->
name|chrootdir
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* already full pathname, return it */
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|buf
argument_list|,
name|fname
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buf
index|[
name|len
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
return|return
name|buf
return|;
block|}
comment|/* chroot */
if|if
condition|(
name|cfg
operator|->
name|chrootdir
operator|&&
name|cfg
operator|->
name|chrootdir
index|[
literal|0
index|]
condition|)
block|{
comment|/* start with chrootdir */
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|buf
argument_list|,
name|cfg
operator|->
name|chrootdir
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|slashit
operator|=
literal|1
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|UB_ON_WINDOWS
if|if
condition|(
name|fname
index|[
literal|0
index|]
operator|!=
literal|0
operator|&&
name|fname
index|[
literal|1
index|]
operator|==
literal|':'
condition|)
block|{
comment|/* full path, no chdir */
block|}
elseif|else
endif|#
directive|endif
comment|/* chdir */
if|if
condition|(
name|fname
index|[
literal|0
index|]
operator|==
literal|'/'
operator|||
operator|!
name|use_chdir
condition|)
block|{
comment|/* full path, no chdir */
block|}
elseif|else
if|if
condition|(
name|cfg
operator|->
name|directory
operator|&&
name|cfg
operator|->
name|directory
index|[
literal|0
index|]
condition|)
block|{
comment|/* prepend chdir */
if|if
condition|(
name|slashit
operator|&&
name|cfg
operator|->
name|directory
index|[
literal|0
index|]
operator|!=
literal|'/'
condition|)
operator|(
name|void
operator|)
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|"/"
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* is the directory already in the chroot? */
if|if
condition|(
name|cfg
operator|->
name|chrootdir
operator|&&
name|cfg
operator|->
name|chrootdir
index|[
literal|0
index|]
operator|&&
name|strncmp
argument_list|(
name|cfg
operator|->
name|chrootdir
argument_list|,
name|cfg
operator|->
name|directory
argument_list|,
name|strlen
argument_list|(
name|cfg
operator|->
name|chrootdir
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|strlcat
argument_list|(
name|buf
argument_list|,
name|cfg
operator|->
name|directory
operator|+
name|strlen
argument_list|(
name|cfg
operator|->
name|chrootdir
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|strlcat
argument_list|(
name|buf
argument_list|,
name|cfg
operator|->
name|directory
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|slashit
operator|=
literal|1
expr_stmt|;
block|}
comment|/* fname */
if|if
condition|(
name|slashit
operator|&&
name|fname
index|[
literal|0
index|]
operator|!=
literal|'/'
condition|)
operator|(
name|void
operator|)
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|"/"
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strlcat
argument_list|(
name|buf
argument_list|,
name|fname
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buf
index|[
name|len
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_comment
comment|/** return next space character in string */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|next_space_pos
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|char
modifier|*
name|sp
init|=
name|strchr
argument_list|(
name|str
argument_list|,
literal|' '
argument_list|)
decl_stmt|;
name|char
modifier|*
name|tab
init|=
name|strchr
argument_list|(
name|str
argument_list|,
literal|'\t'
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|tab
operator|&&
operator|!
name|sp
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|sp
condition|)
return|return
name|tab
return|;
if|if
condition|(
operator|!
name|tab
condition|)
return|return
name|sp
return|;
return|return
operator|(
name|sp
operator|<
name|tab
operator|)
condition|?
name|sp
else|:
name|tab
return|;
block|}
end_function

begin_comment
comment|/** return last space character in string */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|last_space_pos
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|char
modifier|*
name|sp
init|=
name|strrchr
argument_list|(
name|str
argument_list|,
literal|' '
argument_list|)
decl_stmt|;
name|char
modifier|*
name|tab
init|=
name|strrchr
argument_list|(
name|str
argument_list|,
literal|'\t'
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|tab
operator|&&
operator|!
name|sp
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|sp
condition|)
return|return
name|tab
return|;
if|if
condition|(
operator|!
name|tab
condition|)
return|return
name|sp
return|;
return|return
operator|(
name|sp
operator|>
name|tab
operator|)
condition|?
name|sp
else|:
name|tab
return|;
block|}
end_function

begin_function
name|int
name|cfg_parse_local_zone
parameter_list|(
name|struct
name|config_file
modifier|*
name|cfg
parameter_list|,
specifier|const
name|char
modifier|*
name|val
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|type
decl_stmt|,
modifier|*
name|name_end
decl_stmt|,
modifier|*
name|name
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
comment|/* parse it as: [zone_name] [between stuff] [zone_type] */
name|name
operator|=
name|val
expr_stmt|;
while|while
condition|(
operator|*
name|name
operator|&&
name|isspace
argument_list|(
operator|*
name|name
argument_list|)
condition|)
name|name
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|name
condition|)
block|{
name|log_err
argument_list|(
literal|"syntax error: too short: %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|name_end
operator|=
name|next_space_pos
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|name_end
operator|||
operator|!
operator|*
name|name_end
condition|)
block|{
name|log_err
argument_list|(
literal|"syntax error: expected zone type: %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|name_end
operator|-
name|name
operator|>
literal|255
condition|)
block|{
name|log_err
argument_list|(
literal|"syntax error: bad zone name: %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|buf
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|buf
index|[
name|name_end
operator|-
name|name
index|]
operator|=
literal|'\0'
expr_stmt|;
name|type
operator|=
name|last_space_pos
argument_list|(
name|name_end
argument_list|)
expr_stmt|;
while|while
condition|(
name|type
operator|&&
operator|*
name|type
operator|&&
name|isspace
argument_list|(
operator|*
name|type
argument_list|)
condition|)
name|type
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|type
operator|||
operator|!
operator|*
name|type
condition|)
block|{
name|log_err
argument_list|(
literal|"syntax error: expected zone type: %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|type
argument_list|,
literal|"nodefault"
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|cfg_strlist_insert
argument_list|(
operator|&
name|cfg
operator|->
name|local_zones_nodefault
argument_list|,
name|strdup
argument_list|(
name|name
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|cfg_str2list_insert
argument_list|(
operator|&
name|cfg
operator|->
name|local_zones
argument_list|,
name|strdup
argument_list|(
name|buf
argument_list|)
argument_list|,
name|strdup
argument_list|(
name|type
argument_list|)
argument_list|)
return|;
block|}
block|}
end_function

begin_function
name|char
modifier|*
name|cfg_ptr_reverse
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
block|{
name|char
modifier|*
name|ip
decl_stmt|,
modifier|*
name|ip_end
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|result
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|struct
name|sockaddr_storage
name|addr
decl_stmt|;
name|socklen_t
name|addrlen
decl_stmt|;
comment|/* parse it as: [IP] [between stuff] [name] */
name|ip
operator|=
name|str
expr_stmt|;
while|while
condition|(
operator|*
name|ip
operator|&&
name|isspace
argument_list|(
operator|*
name|ip
argument_list|)
condition|)
name|ip
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|ip
condition|)
block|{
name|log_err
argument_list|(
literal|"syntax error: too short: %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ip_end
operator|=
name|next_space_pos
argument_list|(
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ip_end
operator|||
operator|!
operator|*
name|ip_end
condition|)
block|{
name|log_err
argument_list|(
literal|"syntax error: expected name: %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|name
operator|=
name|last_space_pos
argument_list|(
name|ip_end
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|name
operator|||
operator|!
operator|*
name|name
condition|)
block|{
name|log_err
argument_list|(
literal|"syntax error: expected name: %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|sscanf
argument_list|(
name|ip
argument_list|,
literal|"%100s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|ipstrtoaddr
argument_list|(
name|buf
argument_list|,
name|UNBOUND_DNS_PORT
argument_list|,
operator|&
name|addr
argument_list|,
operator|&
name|addrlen
argument_list|)
condition|)
block|{
name|log_err
argument_list|(
literal|"syntax error: cannot parse address: %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* reverse IPv4: 	 * ddd.ddd.ddd.ddd.in-addr-arpa. 	 * IPv6: (h.){32}.ip6.arpa.  */
if|if
condition|(
name|addr_is_ip6
argument_list|(
operator|&
name|addr
argument_list|,
name|addrlen
argument_list|)
condition|)
block|{
name|uint8_t
name|ad
index|[
literal|16
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|hex
init|=
literal|"0123456789abcdef"
decl_stmt|;
name|char
modifier|*
name|p
init|=
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|;
name|memmove
argument_list|(
name|ad
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|addr
operator|)
operator|->
name|sin6_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|ad
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|15
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|uint8_t
name|b
init|=
name|ad
index|[
name|i
index|]
decl_stmt|;
operator|*
name|p
operator|++
operator|=
name|hex
index|[
operator|(
name|b
operator|&
literal|0x0f
operator|)
index|]
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'.'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|hex
index|[
operator|(
name|b
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
index|]
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'.'
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
operator|+
literal|16
operator|*
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|16
operator|*
literal|4
argument_list|,
literal|"ip6.arpa. "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint8_t
name|ad
index|[
literal|4
index|]
decl_stmt|;
name|memmove
argument_list|(
name|ad
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|addr
operator|)
operator|->
name|sin_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|ad
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%u.%u.%u.%u.in-addr.arpa. "
argument_list|,
operator|(
name|unsigned
operator|)
name|ad
index|[
literal|3
index|]
argument_list|,
operator|(
name|unsigned
operator|)
name|ad
index|[
literal|2
index|]
argument_list|,
operator|(
name|unsigned
operator|)
name|ad
index|[
literal|1
index|]
argument_list|,
operator|(
name|unsigned
operator|)
name|ad
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* printed the reverse address, now the between goop and name on end */
while|while
condition|(
operator|*
name|ip_end
operator|&&
name|isspace
argument_list|(
operator|*
name|ip_end
argument_list|)
condition|)
name|ip_end
operator|++
expr_stmt|;
if|if
condition|(
name|name
operator|>
name|ip_end
condition|)
block|{
name|snprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%.*s"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|name
operator|-
name|ip_end
argument_list|)
argument_list|,
name|ip_end
argument_list|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|" PTR %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|result
operator|=
name|strdup
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
block|{
name|log_err
argument_list|(
literal|"out of memory parsing %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|UB_ON_WINDOWS
end_ifdef

begin_function
name|char
modifier|*
name|w_lookup_reg_str
parameter_list|(
specifier|const
name|char
modifier|*
name|key
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|HKEY
name|hk
init|=
name|NULL
decl_stmt|;
name|DWORD
name|type
init|=
literal|0
decl_stmt|;
name|BYTE
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|DWORD
name|len
init|=
operator|(
name|DWORD
operator|)
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|char
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|HKEY_LOCAL_MACHINE
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
name|KEY_READ
argument_list|,
operator|&
name|hk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_FILE_NOT_FOUND
condition|)
return|return
name|NULL
return|;
comment|/* key does not exist */
elseif|else
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|log_err
argument_list|(
literal|"RegOpenKeyEx failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk
argument_list|,
operator|(
name|LPCTSTR
operator|)
name|name
argument_list|,
literal|0
argument_list|,
operator|&
name|type
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|RegCloseKey
argument_list|(
name|hk
argument_list|)
condition|)
name|log_err
argument_list|(
literal|"RegCloseKey"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_FILE_NOT_FOUND
condition|)
return|return
name|NULL
return|;
comment|/* name does not exist */
elseif|else
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|log_err
argument_list|(
literal|"RegQueryValueEx failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|type
operator|==
name|REG_SZ
operator|||
name|type
operator|==
name|REG_MULTI_SZ
operator|||
name|type
operator|==
name|REG_EXPAND_SZ
condition|)
block|{
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* for multi_sz */
name|result
operator|=
name|strdup
argument_list|(
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
name|log_err
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* UB_ON_WINDOWS */
end_comment

begin_function
name|void
name|errinf
parameter_list|(
name|struct
name|module_qstate
modifier|*
name|qstate
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|struct
name|config_strlist
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|qstate
operator|->
name|env
operator|->
name|cfg
operator|->
name|val_log_level
operator|<
literal|2
operator|||
operator|!
name|str
condition|)
return|return;
name|p
operator|=
operator|(
expr|struct
name|config_strlist
operator|*
operator|)
name|regional_alloc
argument_list|(
name|qstate
operator|->
name|region
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
block|{
name|log_err
argument_list|(
literal|"malloc failure in validator-error-info string"
argument_list|)
expr_stmt|;
return|return;
block|}
name|p
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|p
operator|->
name|str
operator|=
name|regional_strdup
argument_list|(
name|qstate
operator|->
name|region
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|str
condition|)
block|{
name|log_err
argument_list|(
literal|"malloc failure in validator-error-info string"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* add at end */
if|if
condition|(
name|qstate
operator|->
name|errinf
condition|)
block|{
name|struct
name|config_strlist
modifier|*
name|q
init|=
name|qstate
operator|->
name|errinf
decl_stmt|;
while|while
condition|(
name|q
operator|->
name|next
condition|)
name|q
operator|=
name|q
operator|->
name|next
expr_stmt|;
name|q
operator|->
name|next
operator|=
name|p
expr_stmt|;
block|}
else|else
name|qstate
operator|->
name|errinf
operator|=
name|p
expr_stmt|;
block|}
end_function

begin_function
name|void
name|errinf_origin
parameter_list|(
name|struct
name|module_qstate
modifier|*
name|qstate
parameter_list|,
name|struct
name|sock_list
modifier|*
name|origin
parameter_list|)
block|{
name|struct
name|sock_list
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|qstate
operator|->
name|env
operator|->
name|cfg
operator|->
name|val_log_level
operator|<
literal|2
condition|)
return|return;
for|for
control|(
name|p
operator|=
name|origin
init|;
name|p
condition|;
name|p
operator|=
name|p
operator|->
name|next
control|)
block|{
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|p
operator|==
name|origin
condition|)
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"from "
argument_list|)
expr_stmt|;
else|else
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"and "
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|len
operator|==
literal|0
condition|)
name|snprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"cache"
argument_list|)
expr_stmt|;
else|else
name|addr_to_str
argument_list|(
operator|&
name|p
operator|->
name|addr
argument_list|,
name|p
operator|->
name|len
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|errinf
argument_list|(
name|qstate
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|char
modifier|*
name|errinf_to_str
parameter_list|(
name|struct
name|module_qstate
modifier|*
name|qstate
parameter_list|)
block|{
name|char
name|buf
index|[
literal|20480
index|]
decl_stmt|;
name|char
modifier|*
name|p
init|=
name|buf
decl_stmt|;
name|size_t
name|left
init|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|struct
name|config_strlist
modifier|*
name|s
decl_stmt|;
name|char
name|dname
index|[
name|LDNS_MAX_DOMAINLEN
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|t
index|[
literal|16
index|]
decl_stmt|,
name|c
index|[
literal|16
index|]
decl_stmt|;
name|sldns_wire2str_type_buf
argument_list|(
name|qstate
operator|->
name|qinfo
operator|.
name|qtype
argument_list|,
name|t
argument_list|,
sizeof|sizeof
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|sldns_wire2str_class_buf
argument_list|(
name|qstate
operator|->
name|qinfo
operator|.
name|qclass
argument_list|,
name|c
argument_list|,
sizeof|sizeof
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
name|dname_str
argument_list|(
name|qstate
operator|->
name|qinfo
operator|.
name|qname
argument_list|,
name|dname
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|p
argument_list|,
name|left
argument_list|,
literal|"validation failure<%s %s %s>:"
argument_list|,
name|dname
argument_list|,
name|t
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|left
operator|-=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|+=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qstate
operator|->
name|errinf
condition|)
name|snprintf
argument_list|(
name|p
argument_list|,
name|left
argument_list|,
literal|" misc failure"
argument_list|)
expr_stmt|;
else|else
for|for
control|(
name|s
operator|=
name|qstate
operator|->
name|errinf
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
name|snprintf
argument_list|(
name|p
argument_list|,
name|left
argument_list|,
literal|" %s"
argument_list|,
name|s
operator|->
name|str
argument_list|)
expr_stmt|;
name|left
operator|-=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|+=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|strdup
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
name|log_err
argument_list|(
literal|"malloc failure in errinf_to_str"
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_function
name|void
name|errinf_rrset
parameter_list|(
name|struct
name|module_qstate
modifier|*
name|qstate
parameter_list|,
name|struct
name|ub_packed_rrset_key
modifier|*
name|rr
parameter_list|)
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|dname
index|[
name|LDNS_MAX_DOMAINLEN
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|t
index|[
literal|16
index|]
decl_stmt|,
name|c
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
name|qstate
operator|->
name|env
operator|->
name|cfg
operator|->
name|val_log_level
operator|<
literal|2
operator|||
operator|!
name|rr
condition|)
return|return;
name|sldns_wire2str_type_buf
argument_list|(
name|ntohs
argument_list|(
name|rr
operator|->
name|rk
operator|.
name|type
argument_list|)
argument_list|,
name|t
argument_list|,
sizeof|sizeof
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|sldns_wire2str_class_buf
argument_list|(
name|ntohs
argument_list|(
name|rr
operator|->
name|rk
operator|.
name|rrset_class
argument_list|)
argument_list|,
name|c
argument_list|,
sizeof|sizeof
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
name|dname_str
argument_list|(
name|rr
operator|->
name|rk
operator|.
name|dname
argument_list|,
name|dname
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"for<%s %s %s>"
argument_list|,
name|dname
argument_list|,
name|t
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|errinf
argument_list|(
name|qstate
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|errinf_dname
parameter_list|(
name|struct
name|module_qstate
modifier|*
name|qstate
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|dname
parameter_list|)
block|{
name|char
name|b
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|buf
index|[
name|LDNS_MAX_DOMAINLEN
operator|+
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|qstate
operator|->
name|env
operator|->
name|cfg
operator|->
name|val_log_level
operator|<
literal|2
operator|||
operator|!
name|str
operator|||
operator|!
name|dname
condition|)
return|return;
name|dname_str
argument_list|(
name|dname
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|b
argument_list|,
sizeof|sizeof
argument_list|(
name|b
argument_list|)
argument_list|,
literal|"%s %s"
argument_list|,
name|str
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|errinf
argument_list|(
name|qstate
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


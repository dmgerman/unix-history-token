begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  $Id: inputbox.c,v 1.76 2012/12/03 11:46:50 tom Exp $  *  *  inputbox.c -- implements the input box  *  *  Copyright 2000-2011,2012 Thomas E. Dickey  *  *  This program is free software; you can redistribute it and/or modify  *  it under the terms of the GNU Lesser General Public License, version 2.1  *  as published by the Free Software Foundation.  *  *  This program is distributed in the hope that it will be useful, but  *  WITHOUT ANY WARRANTY; without even the implied warranty of  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU  *  Lesser General Public License for more details.  *  *  You should have received a copy of the GNU Lesser General Public  *  License along with this program; if not, write to  *	Free Software Foundation, Inc.  *	51 Franklin St., Fifth Floor  *	Boston, MA 02110, USA.  *  *  An earlier version of this program lists as authors:  *	Savio Lam (lam836@cs.cuhk.hk)  */
end_comment

begin_include
include|#
directive|include
file|<dialog.h>
end_include

begin_include
include|#
directive|include
file|<dlg_keys.h>
end_include

begin_define
define|#
directive|define
name|sTEXT
value|-1
end_define

begin_define
define|#
directive|define
name|NAVIGATE_BINDINGS
define|\
value|DLG_KEYS_DATA( DLGK_FIELD_NEXT,	KEY_DOWN ), \ 	DLG_KEYS_DATA( DLGK_FIELD_NEXT,	KEY_RIGHT ), \ 	DLG_KEYS_DATA( DLGK_FIELD_NEXT,	TAB ), \ 	DLG_KEYS_DATA( DLGK_FIELD_PREV,	KEY_BTAB ), \ 	DLG_KEYS_DATA( DLGK_FIELD_PREV,	KEY_LEFT ), \ 	DLG_KEYS_DATA( DLGK_FIELD_PREV,	KEY_UP )
end_define

begin_comment
comment|/*  * Display a dialog box for entering a string  */
end_comment

begin_function
name|int
name|dialog_inputbox
parameter_list|(
specifier|const
name|char
modifier|*
name|title
parameter_list|,
specifier|const
name|char
modifier|*
name|cprompt
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|width
parameter_list|,
specifier|const
name|char
modifier|*
name|init
parameter_list|,
specifier|const
name|int
name|password
parameter_list|)
block|{
comment|/* *INDENT-OFF* */
specifier|static
name|DLG_KEYS_BINDING
name|binding
index|[]
init|=
block|{
name|HELPKEY_BINDINGS
block|,
name|ENTERKEY_BINDINGS
block|,
name|NAVIGATE_BINDINGS
block|,
name|END_KEYS_BINDING
block|}
decl_stmt|;
specifier|static
name|DLG_KEYS_BINDING
name|binding2
index|[]
init|=
block|{
name|INPUTSTR_BINDINGS
block|,
name|HELPKEY_BINDINGS
block|,
name|ENTERKEY_BINDINGS
block|,
name|NAVIGATE_BINDINGS
block|,
name|END_KEYS_BINDING
block|}
decl_stmt|;
comment|/* *INDENT-ON* */
ifdef|#
directive|ifdef
name|KEY_RESIZE
name|int
name|old_height
init|=
name|height
decl_stmt|;
name|int
name|old_width
init|=
name|width
decl_stmt|;
endif|#
directive|endif
name|int
name|xorg
decl_stmt|,
name|yorg
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|box_y
decl_stmt|,
name|box_x
decl_stmt|,
name|box_width
decl_stmt|;
name|int
name|show_buttons
decl_stmt|;
name|int
name|col_offset
init|=
literal|0
decl_stmt|;
name|int
name|chr_offset
init|=
literal|0
decl_stmt|;
name|int
name|key
decl_stmt|,
name|fkey
decl_stmt|,
name|code
decl_stmt|;
name|int
name|result
init|=
name|DLG_EXIT_UNKNOWN
decl_stmt|;
name|int
name|state
decl_stmt|;
name|int
name|first
decl_stmt|;
name|int
name|edited
decl_stmt|;
name|char
modifier|*
name|input
decl_stmt|;
name|WINDOW
modifier|*
name|dialog
decl_stmt|;
name|WINDOW
modifier|*
name|editor
decl_stmt|;
name|char
modifier|*
name|prompt
init|=
name|dlg_strclone
argument_list|(
name|cprompt
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|buttons
init|=
name|dlg_ok_labels
argument_list|()
decl_stmt|;
name|dlg_does_output
argument_list|()
expr_stmt|;
name|dlg_tab_correct_str
argument_list|(
name|prompt
argument_list|)
expr_stmt|;
comment|/* Set up the initial value */
name|input
operator|=
name|dlg_set_result
argument_list|(
name|init
argument_list|)
expr_stmt|;
name|edited
operator|=
name|FALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|KEY_RESIZE
name|retry
label|:
endif|#
directive|endif
name|show_buttons
operator|=
name|TRUE
expr_stmt|;
name|state
operator|=
name|dialog_vars
operator|.
name|default_button
operator|>=
literal|0
condition|?
name|dlg_default_button
argument_list|()
else|:
name|sTEXT
expr_stmt|;
name|first
operator|=
operator|(
name|state
operator|==
name|sTEXT
operator|)
expr_stmt|;
name|key
operator|=
name|fkey
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|init
operator|!=
name|NULL
condition|)
block|{
name|dlg_auto_size
argument_list|(
name|title
argument_list|,
name|prompt
argument_list|,
operator|&
name|height
argument_list|,
operator|&
name|width
argument_list|,
literal|5
argument_list|,
name|MIN
argument_list|(
name|MAX
argument_list|(
name|dlg_count_columns
argument_list|(
name|init
argument_list|)
operator|+
literal|7
argument_list|,
literal|26
argument_list|)
argument_list|,
name|SCOLS
operator|-
operator|(
name|dialog_vars
operator|.
name|begin_set
condition|?
name|dialog_vars
operator|.
name|begin_x
else|:
literal|0
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|chr_offset
operator|=
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|init
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dlg_auto_size
argument_list|(
name|title
argument_list|,
name|prompt
argument_list|,
operator|&
name|height
argument_list|,
operator|&
name|width
argument_list|,
literal|5
argument_list|,
literal|26
argument_list|)
expr_stmt|;
block|}
name|dlg_button_layout
argument_list|(
name|buttons
argument_list|,
operator|&
name|width
argument_list|)
expr_stmt|;
name|dlg_print_size
argument_list|(
name|height
argument_list|,
name|width
argument_list|)
expr_stmt|;
name|dlg_ctl_size
argument_list|(
name|height
argument_list|,
name|width
argument_list|)
expr_stmt|;
name|xorg
operator|=
name|dlg_box_x_ordinate
argument_list|(
name|width
argument_list|)
expr_stmt|;
name|yorg
operator|=
name|dlg_box_y_ordinate
argument_list|(
name|height
argument_list|)
expr_stmt|;
name|dialog
operator|=
name|dlg_new_window
argument_list|(
name|height
argument_list|,
name|width
argument_list|,
name|yorg
argument_list|,
name|xorg
argument_list|)
expr_stmt|;
name|dlg_register_window
argument_list|(
name|dialog
argument_list|,
literal|"inputbox"
argument_list|,
name|binding
argument_list|)
expr_stmt|;
name|dlg_register_buttons
argument_list|(
name|dialog
argument_list|,
literal|"inputbox"
argument_list|,
name|buttons
argument_list|)
expr_stmt|;
name|dlg_mouse_setbase
argument_list|(
name|xorg
argument_list|,
name|yorg
argument_list|)
expr_stmt|;
name|dlg_draw_box2
argument_list|(
name|dialog
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|height
argument_list|,
name|width
argument_list|,
name|dialog_attr
argument_list|,
name|border_attr
argument_list|,
name|border2_attr
argument_list|)
expr_stmt|;
name|dlg_draw_bottom_box2
argument_list|(
name|dialog
argument_list|,
name|border_attr
argument_list|,
name|border2_attr
argument_list|,
name|dialog_attr
argument_list|)
expr_stmt|;
name|dlg_draw_title
argument_list|(
name|dialog
argument_list|,
name|title
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|wattrset
argument_list|(
name|dialog
argument_list|,
name|dialog_attr
argument_list|)
expr_stmt|;
name|dlg_draw_helpline
argument_list|(
name|dialog
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|dlg_print_autowrap
argument_list|(
name|dialog
argument_list|,
name|prompt
argument_list|,
name|height
argument_list|,
name|width
argument_list|)
expr_stmt|;
comment|/* Draw the input field box */
name|box_width
operator|=
name|width
operator|-
literal|6
expr_stmt|;
name|getyx
argument_list|(
name|dialog
argument_list|,
name|y
argument_list|,
name|x
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|x
expr_stmt|;
name|box_y
operator|=
name|y
operator|+
literal|2
expr_stmt|;
name|box_x
operator|=
operator|(
name|width
operator|-
name|box_width
operator|)
operator|/
literal|2
expr_stmt|;
name|dlg_mouse_mkregion
argument_list|(
name|y
operator|+
literal|1
argument_list|,
name|box_x
operator|-
literal|1
argument_list|,
literal|3
argument_list|,
name|box_width
operator|+
literal|2
argument_list|,
literal|'i'
argument_list|)
expr_stmt|;
name|dlg_draw_box
argument_list|(
name|dialog
argument_list|,
name|y
operator|+
literal|1
argument_list|,
name|box_x
operator|-
literal|1
argument_list|,
literal|3
argument_list|,
name|box_width
operator|+
literal|2
argument_list|,
name|border_attr
argument_list|,
name|border2_attr
argument_list|)
expr_stmt|;
comment|/* Make a window for the input-field, to associate bindings */
name|editor
operator|=
name|dlg_sub_window
argument_list|(
name|dialog
argument_list|,
literal|1
argument_list|,
name|box_width
argument_list|,
name|yorg
operator|+
name|box_y
argument_list|,
name|xorg
operator|+
name|box_x
argument_list|)
expr_stmt|;
name|dlg_register_window
argument_list|(
name|editor
argument_list|,
literal|"inputbox2"
argument_list|,
name|binding2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|input
operator|!=
literal|'\0'
condition|)
block|{
name|dlg_show_string
argument_list|(
name|editor
argument_list|,
name|input
argument_list|,
name|chr_offset
argument_list|,
name|inputbox_attr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|box_width
argument_list|,
name|password
argument_list|,
name|first
argument_list|)
expr_stmt|;
name|wsyncup
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|wcursyncup
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|result
operator|==
name|DLG_EXIT_UNKNOWN
condition|)
block|{
name|int
name|edit
init|=
literal|0
decl_stmt|;
comment|/* 	 * The last field drawn determines where the cursor is shown: 	 */
if|if
condition|(
name|show_buttons
condition|)
block|{
name|show_buttons
operator|=
name|FALSE
expr_stmt|;
name|col_offset
operator|=
name|dlg_edit_offset
argument_list|(
name|input
argument_list|,
name|chr_offset
argument_list|,
name|box_width
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|wmove
argument_list|(
name|dialog
argument_list|,
name|box_y
argument_list|,
name|box_x
operator|+
name|col_offset
argument_list|)
expr_stmt|;
name|dlg_draw_buttons
argument_list|(
name|dialog
argument_list|,
name|height
operator|-
literal|2
argument_list|,
literal|0
argument_list|,
name|buttons
argument_list|,
name|state
argument_list|,
name|FALSE
argument_list|,
name|width
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|first
condition|)
block|{
if|if
condition|(
operator|*
name|input
operator|!=
literal|'\0'
operator|&&
operator|!
name|edited
condition|)
block|{
name|dlg_show_string
argument_list|(
name|editor
argument_list|,
name|input
argument_list|,
name|chr_offset
argument_list|,
name|inputbox_attr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|box_width
argument_list|,
name|password
argument_list|,
name|first
argument_list|)
expr_stmt|;
name|wmove
argument_list|(
name|editor
argument_list|,
literal|0
argument_list|,
name|chr_offset
argument_list|)
expr_stmt|;
name|wsyncup
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|wcursyncup
argument_list|(
name|editor
argument_list|)
expr_stmt|;
block|}
name|key
operator|=
name|dlg_mouse_wgetch
argument_list|(
operator|(
name|state
operator|==
name|sTEXT
operator|)
condition|?
name|editor
else|:
name|dialog
argument_list|,
operator|&
name|fkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlg_result_key
argument_list|(
name|key
argument_list|,
name|fkey
argument_list|,
operator|&
name|result
argument_list|)
condition|)
break|break;
block|}
comment|/* 	 * Handle mouse clicks first, since we want to know if this is a button, 	 * or something that dlg_edit_string() should handle. 	 */
if|if
condition|(
name|fkey
operator|&&
name|is_DLGK_MOUSE
argument_list|(
name|key
argument_list|)
operator|&&
operator|(
name|code
operator|=
name|dlg_ok_buttoncode
argument_list|(
name|key
operator|-
name|M_EVENT
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|result
operator|=
name|code
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|state
operator|==
name|sTEXT
condition|)
block|{
comment|/* Input box selected */
name|edit
operator|=
name|dlg_edit_string
argument_list|(
name|input
argument_list|,
operator|&
name|chr_offset
argument_list|,
name|key
argument_list|,
name|fkey
argument_list|,
name|first
argument_list|)
expr_stmt|;
if|if
condition|(
name|edit
condition|)
block|{
name|dlg_show_string
argument_list|(
name|editor
argument_list|,
name|input
argument_list|,
name|chr_offset
argument_list|,
name|inputbox_attr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|box_width
argument_list|,
name|password
argument_list|,
name|first
argument_list|)
expr_stmt|;
name|wsyncup
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|wcursyncup
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|first
operator|=
name|FALSE
expr_stmt|;
name|edited
operator|=
name|TRUE
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|first
condition|)
block|{
name|first
operator|=
name|FALSE
expr_stmt|;
continue|continue;
block|}
block|}
comment|/* handle non-functionkeys */
if|if
condition|(
operator|!
name|fkey
operator|&&
operator|(
name|code
operator|=
name|dlg_char_to_button
argument_list|(
name|key
argument_list|,
name|buttons
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|dlg_del_window
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
name|result
operator|=
name|dlg_ok_buttoncode
argument_list|(
name|code
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* handle functionkeys */
if|if
condition|(
name|fkey
condition|)
block|{
switch|switch
condition|(
name|key
condition|)
block|{
case|case
name|DLGK_MOUSE
argument_list|(
literal|'i'
argument_list|)
case|:
comment|/* mouse enter events */
name|state
operator|=
literal|0
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|DLGK_FIELD_PREV
case|:
name|show_buttons
operator|=
name|TRUE
expr_stmt|;
name|state
operator|=
name|dlg_prev_ok_buttonindex
argument_list|(
name|state
argument_list|,
name|sTEXT
argument_list|)
expr_stmt|;
break|break;
case|case
name|DLGK_FIELD_NEXT
case|:
name|show_buttons
operator|=
name|TRUE
expr_stmt|;
name|state
operator|=
name|dlg_next_ok_buttonindex
argument_list|(
name|state
argument_list|,
name|sTEXT
argument_list|)
expr_stmt|;
break|break;
case|case
literal|' '
case|:
comment|/* FIXME: conflict with inputstr.c */
case|case
name|DLGK_ENTER
case|:
name|dlg_del_window
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|state
operator|>=
literal|0
operator|)
condition|?
name|dlg_enter_buttoncode
argument_list|(
name|state
argument_list|)
else|:
name|DLG_EXIT_OK
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|KEY_RESIZE
case|case
name|KEY_RESIZE
case|:
comment|/* reset data */
name|height
operator|=
name|old_height
expr_stmt|;
name|width
operator|=
name|old_width
expr_stmt|;
comment|/* repaint */
name|dlg_clear
argument_list|()
expr_stmt|;
name|dlg_del_window
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
name|dlg_mouse_free_regions
argument_list|()
expr_stmt|;
goto|goto
name|retry
goto|;
endif|#
directive|endif
default|default:
name|beep
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|beep
argument_list|()
expr_stmt|;
block|}
block|}
name|dlg_unregister_window
argument_list|(
name|editor
argument_list|)
expr_stmt|;
name|dlg_del_window
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
name|dlg_mouse_free_regions
argument_list|()
expr_stmt|;
name|free
argument_list|(
name|prompt
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

end_unit


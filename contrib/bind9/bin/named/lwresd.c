begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004-2008  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 2000-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: lwresd.c,v 1.58 2008-07-23 23:27:54 marka Exp $ */
end_comment

begin_comment
comment|/*! \file  * \brief  * Main program for the Lightweight Resolver Daemon.  *  * To paraphrase the old saying about X11, "It's not a lightweight deamon  * for resolvers, it's a deamon for lightweight resolvers".  */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<isc/list.h>
end_include

begin_include
include|#
directive|include
file|<isc/magic.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/once.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/socket.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<isccfg/namedconf.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/view.h>
end_include

begin_include
include|#
directive|include
file|<named/config.h>
end_include

begin_include
include|#
directive|include
file|<named/globals.h>
end_include

begin_include
include|#
directive|include
file|<named/log.h>
end_include

begin_include
include|#
directive|include
file|<named/lwaddr.h>
end_include

begin_include
include|#
directive|include
file|<named/lwresd.h>
end_include

begin_include
include|#
directive|include
file|<named/lwdclient.h>
end_include

begin_include
include|#
directive|include
file|<named/lwsearch.h>
end_include

begin_include
include|#
directive|include
file|<named/server.h>
end_include

begin_define
define|#
directive|define
name|LWRESD_MAGIC
value|ISC_MAGIC('L', 'W', 'R', 'D')
end_define

begin_define
define|#
directive|define
name|VALID_LWRESD
parameter_list|(
name|l
parameter_list|)
value|ISC_MAGIC_VALID(l, LWRESD_MAGIC)
end_define

begin_define
define|#
directive|define
name|LWRESLISTENER_MAGIC
value|ISC_MAGIC('L', 'W', 'R', 'L')
end_define

begin_define
define|#
directive|define
name|VALID_LWRESLISTENER
parameter_list|(
name|l
parameter_list|)
value|ISC_MAGIC_VALID(l, LWRESLISTENER_MAGIC)
end_define

begin_comment
comment|/*!  * The total number of clients we can handle will be NTASKS * NRECVS.  */
end_comment

begin_define
define|#
directive|define
name|NTASKS
value|2
end_define

begin_comment
comment|/*%< tasks to create to handle lwres queries */
end_comment

begin_define
define|#
directive|define
name|NRECVS
value|2
end_define

begin_comment
comment|/*%< max clients per task */
end_comment

begin_typedef
typedef|typedef
name|ISC_LIST
argument_list|(
argument|ns_lwreslistener_t
argument_list|)
name|ns_lwreslistenerlist_t
expr_stmt|;
end_typedef

begin_decl_stmt
specifier|static
name|ns_lwreslistenerlist_t
name|listeners
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_mutex_t
name|listeners_lock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_once_t
name|once
init|=
name|ISC_ONCE_INIT
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|initialize_mutex
parameter_list|(
name|void
parameter_list|)
block|{
name|RUNTIME_CHECK
argument_list|(
name|isc_mutex_init
argument_list|(
operator|&
name|listeners_lock
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Wrappers around our memory management stuff, for the lwres functions.  */
end_comment

begin_function
name|void
modifier|*
name|ns__lwresd_memalloc
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
return|return
operator|(
name|isc_mem_get
argument_list|(
name|arg
argument_list|,
name|size
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ns__lwresd_memfree
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|void
modifier|*
name|mem
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|isc_mem_put
argument_list|(
name|arg
argument_list|,
name|mem
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|CHECK
parameter_list|(
name|op
parameter_list|)
define|\
value|do { result = (op);					\ 		if (result != ISC_R_SUCCESS) goto cleanup;	\ 	} while (0)
end_define

begin_function
specifier|static
name|isc_result_t
name|buffer_putstr
parameter_list|(
name|isc_buffer_t
modifier|*
name|b
parameter_list|,
specifier|const
name|char
modifier|*
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|len
init|=
name|strlen
argument_list|(
name|s
argument_list|)
decl_stmt|;
if|if
condition|(
name|isc_buffer_availablelength
argument_list|(
name|b
argument_list|)
operator|<=
name|len
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
name|isc_buffer_putmem
argument_list|(
name|b
argument_list|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|s
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert a resolv.conf file into a config structure.  */
end_comment

begin_function
name|isc_result_t
name|ns_lwresd_parseeresolvconf
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|cfg_parser_t
modifier|*
name|pctx
parameter_list|,
name|cfg_obj_t
modifier|*
modifier|*
name|configp
parameter_list|)
block|{
name|char
name|text
index|[
literal|4096
index|]
decl_stmt|;
name|char
name|str
index|[
literal|16
index|]
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|lwres_context_t
modifier|*
name|lwctx
init|=
name|NULL
decl_stmt|;
name|lwres_conf_t
modifier|*
name|lwc
init|=
name|NULL
decl_stmt|;
name|isc_sockaddr_t
name|sa
decl_stmt|;
name|isc_netaddr_t
name|na
decl_stmt|;
name|int
name|i
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|lwres_result_t
name|lwresult
decl_stmt|;
name|lwctx
operator|=
name|NULL
expr_stmt|;
name|lwresult
operator|=
name|lwres_context_create
argument_list|(
operator|&
name|lwctx
argument_list|,
name|mctx
argument_list|,
name|ns__lwresd_memalloc
argument_list|,
name|ns__lwresd_memfree
argument_list|,
name|LWRES_CONTEXT_SERVERMODE
argument_list|)
expr_stmt|;
if|if
condition|(
name|lwresult
operator|!=
name|LWRES_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|lwresult
operator|=
name|lwres_conf_parse
argument_list|(
name|lwctx
argument_list|,
name|lwresd_g_resolvconffile
argument_list|)
expr_stmt|;
if|if
condition|(
name|lwresult
operator|!=
name|LWRES_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|DNS_R_SYNTAX
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|lwc
operator|=
name|lwres_conf_get
argument_list|(
name|lwctx
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|lwc
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|text
argument_list|,
sizeof|sizeof
argument_list|(
name|text
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"options {\n"
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Build the list of forwarders. 	 */
if|if
condition|(
name|lwc
operator|->
name|nsnext
operator|>
literal|0
condition|)
block|{
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\tforwarders {\n"
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|lwc
operator|->
name|nsnext
condition|;
name|i
operator|++
control|)
block|{
name|CHECK
argument_list|(
name|lwaddr_sockaddr_fromlwresaddr
argument_list|(
operator|&
name|sa
argument_list|,
operator|&
name|lwc
operator|->
name|nameservers
index|[
name|i
index|]
argument_list|,
name|ns_g_port
argument_list|)
argument_list|)
expr_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|na
argument_list|,
operator|&
name|sa
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\t\t"
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|isc_netaddr_totext
argument_list|(
operator|&
name|na
argument_list|,
operator|&
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|";\n"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\t};\n"
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Build the sortlist 	 */
if|if
condition|(
name|lwc
operator|->
name|sortlistnxt
operator|>
literal|0
condition|)
block|{
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\tsortlist {\n"
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\t\t{\n"
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\t\t\tany;\n"
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\t\t\t{\n"
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|lwc
operator|->
name|sortlistnxt
condition|;
name|i
operator|++
control|)
block|{
name|lwres_addr_t
modifier|*
name|lwaddr
init|=
operator|&
name|lwc
operator|->
name|sortlist
index|[
name|i
index|]
operator|.
name|addr
decl_stmt|;
name|lwres_addr_t
modifier|*
name|lwmask
init|=
operator|&
name|lwc
operator|->
name|sortlist
index|[
name|i
index|]
operator|.
name|mask
decl_stmt|;
name|unsigned
name|int
name|mask
decl_stmt|;
name|CHECK
argument_list|(
name|lwaddr_sockaddr_fromlwresaddr
argument_list|(
operator|&
name|sa
argument_list|,
name|lwmask
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|na
argument_list|,
operator|&
name|sa
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_netaddr_masktoprefixlen
argument_list|(
operator|&
name|na
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|char
name|addrtext
index|[
name|ISC_NETADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_netaddr_format
argument_list|(
operator|&
name|na
argument_list|,
name|addrtext
argument_list|,
sizeof|sizeof
argument_list|(
name|addrtext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"processing sortlist: '%s' is "
literal|"not a valid netmask"
argument_list|,
name|addrtext
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|CHECK
argument_list|(
name|lwaddr_sockaddr_fromlwresaddr
argument_list|(
operator|&
name|sa
argument_list|,
name|lwaddr
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|na
argument_list|,
operator|&
name|sa
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\t\t\t\t"
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|isc_netaddr_totext
argument_list|(
operator|&
name|na
argument_list|,
operator|&
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|,
literal|"%u"
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"/"
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|";\n"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\t\t\t};\n"
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\t\t};\n"
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\t};\n"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"};\n\n"
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"lwres {\n"
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Build the search path 	 */
if|if
condition|(
name|lwc
operator|->
name|searchnxt
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|lwc
operator|->
name|searchnxt
operator|>
literal|0
condition|)
block|{
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\tsearch {\n"
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|lwc
operator|->
name|searchnxt
condition|;
name|i
operator|++
control|)
block|{
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\t\t\""
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
name|lwc
operator|->
name|search
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\";\n"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\t};\n"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Build the ndots line 	 */
if|if
condition|(
name|lwc
operator|->
name|ndots
operator|!=
literal|1
condition|)
block|{
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\tndots "
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|,
literal|"%u"
argument_list|,
name|lwc
operator|->
name|ndots
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|";\n"
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Build the listen-on line 	 */
if|if
condition|(
name|lwc
operator|->
name|lwnext
operator|>
literal|0
condition|)
block|{
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\tlisten-on {\n"
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|lwc
operator|->
name|lwnext
condition|;
name|i
operator|++
control|)
block|{
name|CHECK
argument_list|(
name|lwaddr_sockaddr_fromlwresaddr
argument_list|(
operator|&
name|sa
argument_list|,
operator|&
name|lwc
operator|->
name|lwservers
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|na
argument_list|,
operator|&
name|sa
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\t\t"
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|isc_netaddr_totext
argument_list|(
operator|&
name|na
argument_list|,
operator|&
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|";\n"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"\t};\n"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"};\n"
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|printf("%.*s\n", 	       (int)isc_buffer_usedlength(&b), 	       (char *)isc_buffer_base(&b));
endif|#
directive|endif
name|lwres_conf_clear
argument_list|(
name|lwctx
argument_list|)
expr_stmt|;
name|lwres_context_destroy
argument_list|(
operator|&
name|lwctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|cfg_parse_buffer
argument_list|(
name|pctx
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|cfg_type_namedconf
argument_list|,
name|configp
argument_list|)
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|lwctx
operator|!=
name|NULL
condition|)
block|{
name|lwres_conf_clear
argument_list|(
name|lwctx
argument_list|)
expr_stmt|;
name|lwres_context_destroy
argument_list|(
operator|&
name|lwctx
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Handle lwresd manager objects  */
end_comment

begin_function
name|isc_result_t
name|ns_lwdmanager_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|lwres
parameter_list|,
name|ns_lwresd_t
modifier|*
modifier|*
name|lwresdp
parameter_list|)
block|{
name|ns_lwresd_t
modifier|*
name|lwresd
decl_stmt|;
specifier|const
name|char
modifier|*
name|vname
decl_stmt|;
name|dns_rdataclass_t
name|vclass
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|,
modifier|*
name|viewobj
decl_stmt|,
modifier|*
name|searchobj
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|INSIST
argument_list|(
name|lwresdp
operator|!=
name|NULL
operator|&&
operator|*
name|lwresdp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|lwresd
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|ns_lwresd_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lwresd
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|lwresd
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|lwresd
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|lwresd
operator|->
name|view
operator|=
name|NULL
expr_stmt|;
name|lwresd
operator|->
name|search
operator|=
name|NULL
expr_stmt|;
name|lwresd
operator|->
name|refs
operator|=
literal|1
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|lwres
argument_list|,
literal|"ndots"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
name|lwresd
operator|->
name|ndots
operator|=
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
expr_stmt|;
else|else
name|lwresd
operator|->
name|ndots
operator|=
literal|1
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|isc_mutex_init
argument_list|(
operator|&
name|lwresd
operator|->
name|lock
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|lwresd
operator|->
name|shutting_down
operator|=
name|ISC_FALSE
expr_stmt|;
name|viewobj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|lwres
argument_list|,
literal|"view"
argument_list|,
operator|&
name|viewobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|viewobj
operator|!=
name|NULL
condition|)
block|{
name|vname
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|viewobj
argument_list|,
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|cfg_tuple_get
argument_list|(
name|viewobj
argument_list|,
literal|"class"
argument_list|)
expr_stmt|;
name|result
operator|=
name|ns_config_getclass
argument_list|(
name|obj
argument_list|,
name|dns_rdataclass_in
argument_list|,
operator|&
name|vclass
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
block|}
else|else
block|{
name|vname
operator|=
literal|"_default"
expr_stmt|;
name|vclass
operator|=
name|dns_rdataclass_in
expr_stmt|;
block|}
name|result
operator|=
name|dns_viewlist_find
argument_list|(
operator|&
name|ns_g_server
operator|->
name|viewlist
argument_list|,
name|vname
argument_list|,
name|vclass
argument_list|,
operator|&
name|lwresd
operator|->
name|view
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't find view %s"
argument_list|,
name|vname
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|searchobj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|lwres
argument_list|,
literal|"search"
argument_list|,
operator|&
name|searchobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|searchobj
operator|!=
name|NULL
condition|)
block|{
name|lwresd
operator|->
name|search
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_lwsearchlist_create
argument_list|(
name|lwresd
operator|->
name|mctx
argument_list|,
operator|&
name|lwresd
operator|->
name|search
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't create searchlist"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|searchobj
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|search
decl_stmt|;
specifier|const
name|char
modifier|*
name|searchstr
decl_stmt|;
name|isc_buffer_t
name|namebuf
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|search
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
name|searchstr
operator|=
name|cfg_obj_asstring
argument_list|(
name|search
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|namebuf
argument_list|,
name|searchstr
argument_list|,
name|strlen
argument_list|(
name|searchstr
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|namebuf
argument_list|,
name|strlen
argument_list|(
name|searchstr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|name
argument_list|,
operator|&
name|namebuf
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"invalid name %s in searchlist"
argument_list|,
name|searchstr
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|result
operator|=
name|ns_lwsearchlist_append
argument_list|(
name|lwresd
operator|->
name|search
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't update searchlist"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
block|}
name|lwresd
operator|->
name|magic
operator|=
name|LWRESD_MAGIC
expr_stmt|;
operator|*
name|lwresdp
operator|=
name|lwresd
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|fail
label|:
if|if
condition|(
name|lwresd
operator|->
name|view
operator|!=
name|NULL
condition|)
name|dns_view_detach
argument_list|(
operator|&
name|lwresd
operator|->
name|view
argument_list|)
expr_stmt|;
if|if
condition|(
name|lwresd
operator|->
name|search
operator|!=
name|NULL
condition|)
name|ns_lwsearchlist_detach
argument_list|(
operator|&
name|lwresd
operator|->
name|search
argument_list|)
expr_stmt|;
if|if
condition|(
name|lwresd
operator|->
name|mctx
operator|!=
name|NULL
condition|)
name|isc_mem_detach
argument_list|(
operator|&
name|lwresd
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|lwresd
argument_list|,
sizeof|sizeof
argument_list|(
name|ns_lwresd_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ns_lwdmanager_attach
parameter_list|(
name|ns_lwresd_t
modifier|*
name|source
parameter_list|,
name|ns_lwresd_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
name|INSIST
argument_list|(
name|VALID_LWRESD
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|targetp
operator|!=
name|NULL
operator|&&
operator|*
name|targetp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|source
operator|->
name|lock
argument_list|)
expr_stmt|;
name|source
operator|->
name|refs
operator|++
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|source
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|targetp
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_lwdmanager_detach
parameter_list|(
name|ns_lwresd_t
modifier|*
modifier|*
name|lwresdp
parameter_list|)
block|{
name|ns_lwresd_t
modifier|*
name|lwresd
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|isc_boolean_t
name|done
init|=
name|ISC_FALSE
decl_stmt|;
name|INSIST
argument_list|(
name|lwresdp
operator|!=
name|NULL
operator|&&
operator|*
name|lwresdp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|VALID_LWRESD
argument_list|(
operator|*
name|lwresdp
argument_list|)
argument_list|)
expr_stmt|;
name|lwresd
operator|=
operator|*
name|lwresdp
expr_stmt|;
operator|*
name|lwresdp
operator|=
name|NULL
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|lwresd
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|lwresd
operator|->
name|refs
operator|>
literal|0
argument_list|)
expr_stmt|;
name|lwresd
operator|->
name|refs
operator|--
expr_stmt|;
if|if
condition|(
name|lwresd
operator|->
name|refs
operator|==
literal|0
condition|)
name|done
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|lwresd
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|done
condition|)
return|return;
name|dns_view_detach
argument_list|(
operator|&
name|lwresd
operator|->
name|view
argument_list|)
expr_stmt|;
if|if
condition|(
name|lwresd
operator|->
name|search
operator|!=
name|NULL
condition|)
name|ns_lwsearchlist_detach
argument_list|(
operator|&
name|lwresd
operator|->
name|search
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|lwresd
operator|->
name|mctx
expr_stmt|;
name|lwresd
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|lwresd
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|lwresd
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Handle listener objects  */
end_comment

begin_function
name|void
name|ns_lwreslistener_attach
parameter_list|(
name|ns_lwreslistener_t
modifier|*
name|source
parameter_list|,
name|ns_lwreslistener_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
name|INSIST
argument_list|(
name|VALID_LWRESLISTENER
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|targetp
operator|!=
name|NULL
operator|&&
operator|*
name|targetp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|source
operator|->
name|lock
argument_list|)
expr_stmt|;
name|source
operator|->
name|refs
operator|++
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|source
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|targetp
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_lwreslistener_detach
parameter_list|(
name|ns_lwreslistener_t
modifier|*
modifier|*
name|listenerp
parameter_list|)
block|{
name|ns_lwreslistener_t
modifier|*
name|listener
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|isc_boolean_t
name|done
init|=
name|ISC_FALSE
decl_stmt|;
name|INSIST
argument_list|(
name|listenerp
operator|!=
name|NULL
operator|&&
operator|*
name|listenerp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|VALID_LWRESLISTENER
argument_list|(
operator|*
name|listenerp
argument_list|)
argument_list|)
expr_stmt|;
name|listener
operator|=
operator|*
name|listenerp
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|listener
operator|->
name|refs
operator|>
literal|0
argument_list|)
expr_stmt|;
name|listener
operator|->
name|refs
operator|--
expr_stmt|;
if|if
condition|(
name|listener
operator|->
name|refs
operator|==
literal|0
condition|)
name|done
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|done
condition|)
return|return;
if|if
condition|(
name|listener
operator|->
name|manager
operator|!=
name|NULL
condition|)
name|ns_lwdmanager_detach
argument_list|(
operator|&
name|listener
operator|->
name|manager
argument_list|)
expr_stmt|;
if|if
condition|(
name|listener
operator|->
name|sock
operator|!=
name|NULL
condition|)
name|isc_socket_detach
argument_list|(
operator|&
name|listener
operator|->
name|sock
argument_list|)
expr_stmt|;
name|listener
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|mctx
operator|=
name|listener
operator|->
name|mctx
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|listener
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|listener
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
name|listenerp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|listener_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|ns_lwresd_t
modifier|*
name|lwresd
parameter_list|,
name|ns_lwreslistener_t
modifier|*
modifier|*
name|listenerp
parameter_list|)
block|{
name|ns_lwreslistener_t
modifier|*
name|listener
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|listenerp
operator|!=
name|NULL
operator|&&
operator|*
name|listenerp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|listener
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|ns_lwreslistener_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|listener
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|listener
argument_list|,
sizeof|sizeof
argument_list|(
name|ns_lwreslistener_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|listener
operator|->
name|magic
operator|=
name|LWRESLISTENER_MAGIC
expr_stmt|;
name|listener
operator|->
name|refs
operator|=
literal|1
expr_stmt|;
name|listener
operator|->
name|sock
operator|=
name|NULL
expr_stmt|;
name|listener
operator|->
name|manager
operator|=
name|NULL
expr_stmt|;
name|ns_lwdmanager_attach
argument_list|(
name|lwresd
argument_list|,
operator|&
name|listener
operator|->
name|manager
argument_list|)
expr_stmt|;
name|listener
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|listener
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|listener
operator|->
name|cmgrs
argument_list|)
expr_stmt|;
operator|*
name|listenerp
operator|=
name|listener
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|listener_bind
parameter_list|(
name|ns_lwreslistener_t
modifier|*
name|listener
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|address
parameter_list|)
block|{
name|isc_socket_t
modifier|*
name|sock
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|int
name|pf
decl_stmt|;
name|pf
operator|=
name|isc_sockaddr_pf
argument_list|(
name|address
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pf
operator|==
name|AF_INET
operator|&&
name|isc_net_probeipv4
argument_list|()
operator|!=
name|ISC_R_SUCCESS
operator|)
operator|||
operator|(
name|pf
operator|==
name|AF_INET6
operator|&&
name|isc_net_probeipv6
argument_list|()
operator|!=
name|ISC_R_SUCCESS
operator|)
condition|)
return|return
operator|(
name|ISC_R_FAMILYNOSUPPORT
operator|)
return|;
name|listener
operator|->
name|address
operator|=
operator|*
name|address
expr_stmt|;
if|if
condition|(
name|isc_sockaddr_getport
argument_list|(
operator|&
name|listener
operator|->
name|address
argument_list|)
operator|==
literal|0
condition|)
block|{
name|in_port_t
name|port
decl_stmt|;
name|port
operator|=
name|lwresd_g_listenport
expr_stmt|;
if|if
condition|(
name|port
operator|==
literal|0
condition|)
name|port
operator|=
name|LWRES_UDP_PORT
expr_stmt|;
name|isc_sockaddr_setport
argument_list|(
operator|&
name|listener
operator|->
name|address
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
name|sock
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_socket_create
argument_list|(
name|ns_g_socketmgr
argument_list|,
name|pf
argument_list|,
name|isc_sockettype_udp
argument_list|,
operator|&
name|sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"failed to create lwres socket: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|result
operator|=
name|isc_socket_bind
argument_list|(
name|sock
argument_list|,
operator|&
name|listener
operator|->
name|address
argument_list|,
name|ISC_SOCKET_REUSEADDRESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|listener
operator|->
name|address
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_socket_detach
argument_list|(
operator|&
name|sock
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"failed to add lwres socket: %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|listener
operator|->
name|sock
operator|=
name|sock
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|listener_copysock
parameter_list|(
name|ns_lwreslistener_t
modifier|*
name|oldlistener
parameter_list|,
name|ns_lwreslistener_t
modifier|*
name|newlistener
parameter_list|)
block|{
name|newlistener
operator|->
name|address
operator|=
name|oldlistener
operator|->
name|address
expr_stmt|;
name|isc_socket_attach
argument_list|(
name|oldlistener
operator|->
name|sock
argument_list|,
operator|&
name|newlistener
operator|->
name|sock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|listener_startclients
parameter_list|(
name|ns_lwreslistener_t
modifier|*
name|listener
parameter_list|)
block|{
name|ns_lwdclientmgr_t
modifier|*
name|cm
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
comment|/* 	 * Create the client managers. 	 */
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NTASKS
operator|&&
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|i
operator|++
control|)
name|result
operator|=
name|ns_lwdclientmgr_create
argument_list|(
name|listener
argument_list|,
name|NRECVS
argument_list|,
name|ns_g_taskmgr
argument_list|)
expr_stmt|;
comment|/* 	 * Ensure that we have created at least one. 	 */
if|if
condition|(
name|ISC_LIST_EMPTY
argument_list|(
name|listener
operator|->
name|cmgrs
argument_list|)
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* 	 * Walk the list of clients and start each one up. 	 */
name|LOCK
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cm
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|listener
operator|->
name|cmgrs
argument_list|)
expr_stmt|;
while|while
condition|(
name|cm
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|ns_lwdclient_startrecv
argument_list|(
name|cm
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"could not start lwres "
literal|"client handler: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|cm
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|cm
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|listener_shutdown
parameter_list|(
name|ns_lwreslistener_t
modifier|*
name|listener
parameter_list|)
block|{
name|ns_lwdclientmgr_t
modifier|*
name|cm
decl_stmt|;
name|cm
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|listener
operator|->
name|cmgrs
argument_list|)
expr_stmt|;
while|while
condition|(
name|cm
operator|!=
name|NULL
condition|)
block|{
name|isc_task_shutdown
argument_list|(
name|cm
operator|->
name|task
argument_list|)
expr_stmt|;
name|cm
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|cm
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|find_listener
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|address
parameter_list|,
name|ns_lwreslistener_t
modifier|*
modifier|*
name|listenerp
parameter_list|)
block|{
name|ns_lwreslistener_t
modifier|*
name|listener
decl_stmt|;
name|INSIST
argument_list|(
name|listenerp
operator|!=
name|NULL
operator|&&
operator|*
name|listenerp
operator|==
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|listener
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|listeners
argument_list|)
init|;
name|listener
operator|!=
name|NULL
condition|;
name|listener
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|listener
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
operator|!
name|isc_sockaddr_equal
argument_list|(
name|address
argument_list|,
operator|&
name|listener
operator|->
name|address
argument_list|)
condition|)
continue|continue;
operator|*
name|listenerp
operator|=
name|listener
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ns_lwreslistener_unlinkcm
parameter_list|(
name|ns_lwreslistener_t
modifier|*
name|listener
parameter_list|,
name|ns_lwdclientmgr_t
modifier|*
name|cm
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_LWRESLISTENER
argument_list|(
name|listener
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|listener
operator|->
name|cmgrs
argument_list|,
name|cm
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_lwreslistener_linkcm
parameter_list|(
name|ns_lwreslistener_t
modifier|*
name|listener
parameter_list|,
name|ns_lwdclientmgr_t
modifier|*
name|cm
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_LWRESLISTENER
argument_list|(
name|listener
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * This does no locking, since it's called early enough that locking 	 * isn't needed. 	 */
name|ISC_LIST_APPEND
argument_list|(
name|listener
operator|->
name|cmgrs
argument_list|,
name|cm
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|configure_listener
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|address
parameter_list|,
name|ns_lwresd_t
modifier|*
name|lwresd
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|ns_lwreslistenerlist_t
modifier|*
name|newlisteners
parameter_list|)
block|{
name|ns_lwreslistener_t
modifier|*
name|listener
decl_stmt|,
modifier|*
name|oldlistener
init|=
name|NULL
decl_stmt|;
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
operator|(
name|void
operator|)
name|find_listener
argument_list|(
name|address
argument_list|,
operator|&
name|oldlistener
argument_list|)
expr_stmt|;
name|listener
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|listener_create
argument_list|(
name|mctx
argument_list|,
name|lwresd
argument_list|,
operator|&
name|listener
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_sockaddr_format
argument_list|(
name|address
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|ISC_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"lwres failed to configure %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 	 * If there's already a listener, don't rebind the socket. 	 */
if|if
condition|(
name|oldlistener
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|listener_bind
argument_list|(
name|listener
argument_list|,
name|address
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|ns_lwreslistener_detach
argument_list|(
operator|&
name|listener
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
block|}
else|else
name|listener_copysock
argument_list|(
name|oldlistener
argument_list|,
name|listener
argument_list|)
expr_stmt|;
name|result
operator|=
name|listener_startclients
argument_list|(
name|listener
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_sockaddr_format
argument_list|(
name|address
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|ISC_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"lwres: failed to start %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|ns_lwreslistener_detach
argument_list|(
operator|&
name|listener
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
if|if
condition|(
name|oldlistener
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * Remove the old listener from the old list and shut it down. 		 */
name|ISC_LIST_UNLINK
argument_list|(
name|listeners
argument_list|,
name|oldlistener
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|listener_shutdown
argument_list|(
name|oldlistener
argument_list|)
expr_stmt|;
name|ns_lwreslistener_detach
argument_list|(
operator|&
name|oldlistener
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isc_sockaddr_format
argument_list|(
name|address
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|ISC_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_NOTICE
argument_list|,
literal|"lwres listening on %s"
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
block|}
name|ISC_LIST_APPEND
argument_list|(
operator|*
name|newlisteners
argument_list|,
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_lwresd_configure
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|lwreslist
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|lwres
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|listenerslist
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
init|=
name|NULL
decl_stmt|;
name|ns_lwreslistener_t
modifier|*
name|listener
decl_stmt|;
name|ns_lwreslistenerlist_t
name|newlisteners
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|addrs
init|=
name|NULL
decl_stmt|;
name|ns_lwresd_t
modifier|*
name|lwresd
init|=
name|NULL
decl_stmt|;
name|isc_uint32_t
name|count
init|=
literal|0
decl_stmt|;
name|REQUIRE
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|config
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|isc_once_do
argument_list|(
operator|&
name|once
argument_list|,
name|initialize_mutex
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|newlisteners
argument_list|)
expr_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"lwres"
argument_list|,
operator|&
name|lwreslist
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|LOCK
argument_list|(
operator|&
name|listeners_lock
argument_list|)
expr_stmt|;
comment|/* 	 * Run through the new lwres address list, noting sockets that 	 * are already being listened on and moving them to the new list. 	 * 	 * Identifying duplicates addr/port combinations is left to either 	 * the underlying config code, or to the bind attempt getting an 	 * address-in-use error. 	 */
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|lwreslist
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
name|in_port_t
name|port
decl_stmt|;
name|lwres
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ns_lwdmanager_create
argument_list|(
name|mctx
argument_list|,
name|lwres
argument_list|,
operator|&
name|lwresd
argument_list|)
argument_list|)
expr_stmt|;
name|port
operator|=
name|lwresd_g_listenport
expr_stmt|;
if|if
condition|(
name|port
operator|==
literal|0
condition|)
name|port
operator|=
name|LWRES_UDP_PORT
expr_stmt|;
name|listenerslist
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|lwres
argument_list|,
literal|"listen-on"
argument_list|,
operator|&
name|listenerslist
argument_list|)
expr_stmt|;
if|if
condition|(
name|listenerslist
operator|==
name|NULL
condition|)
block|{
name|struct
name|in_addr
name|localhost
decl_stmt|;
name|isc_sockaddr_t
name|address
decl_stmt|;
name|localhost
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|INADDR_LOOPBACK
argument_list|)
expr_stmt|;
name|isc_sockaddr_fromin
argument_list|(
operator|&
name|address
argument_list|,
operator|&
name|localhost
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|configure_listener
argument_list|(
operator|&
name|address
argument_list|,
name|lwresd
argument_list|,
name|mctx
argument_list|,
operator|&
name|newlisteners
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isc_uint32_t
name|i
decl_stmt|;
name|CHECK
argument_list|(
name|ns_config_getiplist
argument_list|(
name|config
argument_list|,
name|listenerslist
argument_list|,
name|port
argument_list|,
name|mctx
argument_list|,
operator|&
name|addrs
argument_list|,
operator|&
name|count
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
name|CHECK
argument_list|(
name|configure_listener
argument_list|(
operator|&
name|addrs
index|[
name|i
index|]
argument_list|,
name|lwresd
argument_list|,
name|mctx
argument_list|,
operator|&
name|newlisteners
argument_list|)
argument_list|)
expr_stmt|;
name|ns_config_putiplist
argument_list|(
name|mctx
argument_list|,
operator|&
name|addrs
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
name|ns_lwdmanager_detach
argument_list|(
operator|&
name|lwresd
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Shutdown everything on the listeners list, and remove them from 	 * the list.  Then put all of the new listeners on it. 	 */
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|listeners
argument_list|)
condition|)
block|{
name|listener
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|listeners
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|listeners
argument_list|,
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|listener
operator|->
name|address
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|listener_shutdown
argument_list|(
name|listener
argument_list|)
expr_stmt|;
name|ns_lwreslistener_detach
argument_list|(
operator|&
name|listener
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|ISC_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_NOTICE
argument_list|,
literal|"lwres no longer listening on %s"
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
block|}
name|cleanup
label|:
name|ISC_LIST_APPENDLIST
argument_list|(
name|listeners
argument_list|,
name|newlisteners
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|addrs
operator|!=
name|NULL
condition|)
name|ns_config_putiplist
argument_list|(
name|mctx
argument_list|,
operator|&
name|addrs
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|lwresd
operator|!=
name|NULL
condition|)
name|ns_lwdmanager_detach
argument_list|(
operator|&
name|lwresd
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|listeners_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ns_lwresd_shutdown
parameter_list|(
name|void
parameter_list|)
block|{
name|ns_lwreslistener_t
modifier|*
name|listener
decl_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|isc_once_do
argument_list|(
operator|&
name|once
argument_list|,
name|initialize_mutex
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|listeners
argument_list|)
condition|)
block|{
name|listener
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|listeners
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|listeners
argument_list|,
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ns_lwreslistener_detach
argument_list|(
operator|&
name|listener
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


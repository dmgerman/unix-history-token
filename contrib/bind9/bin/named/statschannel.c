begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2008-2012  Internet Systems Consortium, Inc. ("ISC")  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: statschannel.c,v 1.26.150.2 2011/03/12 04:59:14 tbox Exp $ */
end_comment

begin_comment
comment|/*! \file */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_include
include|#
directive|include
file|<isc/httpd.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/once.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/socket.h>
end_include

begin_include
include|#
directive|include
file|<isc/stats.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<dns/cache.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/opcode.h>
end_include

begin_include
include|#
directive|include
file|<dns/resolver.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataclass.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatatype.h>
end_include

begin_include
include|#
directive|include
file|<dns/stats.h>
end_include

begin_include
include|#
directive|include
file|<dns/view.h>
end_include

begin_include
include|#
directive|include
file|<dns/zt.h>
end_include

begin_include
include|#
directive|include
file|<named/log.h>
end_include

begin_include
include|#
directive|include
file|<named/server.h>
end_include

begin_include
include|#
directive|include
file|<named/statschannel.h>
end_include

begin_include
include|#
directive|include
file|"bind9.xsl.h"
end_include

begin_struct
struct|struct
name|ns_statschannel
block|{
comment|/* Unlocked */
name|isc_httpdmgr_t
modifier|*
name|httpdmgr
decl_stmt|;
name|isc_sockaddr_t
name|address
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
comment|/* 	 * Locked by channel lock: can be referenced and modified by both 	 * the server task and the channel task. 	 */
name|isc_mutex_t
name|lock
decl_stmt|;
name|dns_acl_t
modifier|*
name|acl
decl_stmt|;
comment|/* Locked by server task */
name|ISC_LINK
argument_list|(
argument|struct ns_statschannel
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
enum|enum
block|{
name|statsformat_file
block|,
name|statsformat_xml
block|}
name|statsformat_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|stats_dumparg
block|{
name|statsformat_t
name|type
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
comment|/* type dependent argument */
name|int
name|ncounters
decl_stmt|;
comment|/* used for general statistics */
name|int
modifier|*
name|counterindices
decl_stmt|;
comment|/* used for general statistics */
name|isc_uint64_t
modifier|*
name|countervalues
decl_stmt|;
comment|/* used for general statistics */
name|isc_result_t
name|result
decl_stmt|;
block|}
name|stats_dumparg_t
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|isc_once_t
name|once
init|=
name|ISC_ONCE_INIT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*%  * Statistics descriptions.  These could be statistically initialized at  * compile time, but we configure them run time in the init_desc() function  * below so that they'll be less susceptible to counter name changes.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|nsstats_desc
index|[
name|dns_nsstatscounter_max
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|resstats_desc
index|[
name|dns_resstatscounter_max
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zonestats_desc
index|[
name|dns_zonestatscounter_max
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|sockstats_desc
index|[
name|isc_sockstatscounter_max
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|dnssecstats_desc
index|[
name|dns_dnssecstats_max
index|]
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
end_ifdef

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|nsstats_xmldesc
index|[
name|dns_nsstatscounter_max
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|resstats_xmldesc
index|[
name|dns_resstatscounter_max
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zonestats_xmldesc
index|[
name|dns_zonestatscounter_max
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|sockstats_xmldesc
index|[
name|isc_sockstatscounter_max
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|dnssecstats_xmldesc
index|[
name|dns_dnssecstats_max
index|]
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|nsstats_xmldesc
value|NULL
end_define

begin_define
define|#
directive|define
name|resstats_xmldesc
value|NULL
end_define

begin_define
define|#
directive|define
name|zonestats_xmldesc
value|NULL
end_define

begin_define
define|#
directive|define
name|sockstats_xmldesc
value|NULL
end_define

begin_define
define|#
directive|define
name|dnssecstats_xmldesc
value|NULL
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_LIBXML2 */
end_comment

begin_define
define|#
directive|define
name|TRY0
parameter_list|(
name|a
parameter_list|)
value|do { xmlrc = (a); if (xmlrc< 0) goto error; } while(0)
end_define

begin_comment
comment|/*%  * Mapping arrays to represent statistics counters in the order of our  * preference, regardless of the order of counter indices.  For example,  * nsstats_desc[nsstats_index[0]] will be the description that is shown first.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|nsstats_index
index|[
name|dns_nsstatscounter_max
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|resstats_index
index|[
name|dns_resstatscounter_max
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|zonestats_index
index|[
name|dns_zonestatscounter_max
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sockstats_index
index|[
name|isc_sockstatscounter_max
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|dnssecstats_index
index|[
name|dns_dnssecstats_max
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|inline
name|void
name|set_desc
parameter_list|(
name|int
name|counter
parameter_list|,
name|int
name|maxcounter
parameter_list|,
specifier|const
name|char
modifier|*
name|fdesc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|fdescs
parameter_list|,
specifier|const
name|char
modifier|*
name|xdesc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|xdescs
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|counter
operator|<
name|maxcounter
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|fdescs
index|[
name|counter
index|]
operator|==
name|NULL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|REQUIRE
argument_list|(
name|xdescs
index|[
name|counter
index|]
operator|==
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fdescs
index|[
name|counter
index|]
operator|=
name|fdesc
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|xdescs
index|[
name|counter
index|]
operator|=
name|xdesc
expr_stmt|;
else|#
directive|else
name|UNUSED
argument_list|(
name|xdesc
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|xdescs
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|init_desc
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* Initialize name server statistics */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_nsstatscounter_max
condition|;
name|i
operator|++
control|)
name|nsstats_desc
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_nsstatscounter_max
condition|;
name|i
operator|++
control|)
name|nsstats_xmldesc
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
define|#
directive|define
name|SET_NSSTATDESC
parameter_list|(
name|counterid
parameter_list|,
name|desc
parameter_list|,
name|xmldesc
parameter_list|)
define|\
value|do { \ 		set_desc(dns_nsstatscounter_ ## counterid, \ 			 dns_nsstatscounter_max, \ 			 desc, nsstats_desc, xmldesc, nsstats_xmldesc); \ 		nsstats_index[i++] = dns_nsstatscounter_ ## counterid; \ 	} while (0)
name|i
operator|=
literal|0
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|requestv4
argument_list|,
literal|"IPv4 requests received"
argument_list|,
literal|"Requestv4"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|requestv6
argument_list|,
literal|"IPv6 requests received"
argument_list|,
literal|"Requestv6"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|edns0in
argument_list|,
literal|"requests with EDNS(0) received"
argument_list|,
literal|"ReqEdns0"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|badednsver
argument_list|,
literal|"requests with unsupported EDNS version received"
argument_list|,
literal|"ReqBadEDNSVer"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|tsigin
argument_list|,
literal|"requests with TSIG received"
argument_list|,
literal|"ReqTSIG"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|sig0in
argument_list|,
literal|"requests with SIG(0) received"
argument_list|,
literal|"ReqSIG0"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|invalidsig
argument_list|,
literal|"requests with invalid signature"
argument_list|,
literal|"ReqBadSIG"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|tcp
argument_list|,
literal|"TCP requests received"
argument_list|,
literal|"ReqTCP"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|authrej
argument_list|,
literal|"auth queries rejected"
argument_list|,
literal|"AuthQryRej"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|recurserej
argument_list|,
literal|"recursive queries rejected"
argument_list|,
literal|"RecQryRej"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|xfrrej
argument_list|,
literal|"transfer requests rejected"
argument_list|,
literal|"XfrRej"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|updaterej
argument_list|,
literal|"update requests rejected"
argument_list|,
literal|"UpdateRej"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|response
argument_list|,
literal|"responses sent"
argument_list|,
literal|"Response"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|truncatedresp
argument_list|,
literal|"truncated responses sent"
argument_list|,
literal|"TruncatedResp"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|edns0out
argument_list|,
literal|"responses with EDNS(0) sent"
argument_list|,
literal|"RespEDNS0"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|tsigout
argument_list|,
literal|"responses with TSIG sent"
argument_list|,
literal|"RespTSIG"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|sig0out
argument_list|,
literal|"responses with SIG(0) sent"
argument_list|,
literal|"RespSIG0"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|success
argument_list|,
literal|"queries resulted in successful answer"
argument_list|,
literal|"QrySuccess"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|authans
argument_list|,
literal|"queries resulted in authoritative answer"
argument_list|,
literal|"QryAuthAns"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|nonauthans
argument_list|,
literal|"queries resulted in non authoritative answer"
argument_list|,
literal|"QryNoauthAns"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|referral
argument_list|,
literal|"queries resulted in referral answer"
argument_list|,
literal|"QryReferral"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|nxrrset
argument_list|,
literal|"queries resulted in nxrrset"
argument_list|,
literal|"QryNxrrset"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|servfail
argument_list|,
literal|"queries resulted in SERVFAIL"
argument_list|,
literal|"QrySERVFAIL"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|formerr
argument_list|,
literal|"queries resulted in FORMERR"
argument_list|,
literal|"QryFORMERR"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|nxdomain
argument_list|,
literal|"queries resulted in NXDOMAIN"
argument_list|,
literal|"QryNXDOMAIN"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|recursion
argument_list|,
literal|"queries caused recursion"
argument_list|,
literal|"QryRecursion"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|duplicate
argument_list|,
literal|"duplicate queries received"
argument_list|,
literal|"QryDuplicate"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|dropped
argument_list|,
literal|"queries dropped"
argument_list|,
literal|"QryDropped"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|failure
argument_list|,
literal|"other query failures"
argument_list|,
literal|"QryFailure"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|xfrdone
argument_list|,
literal|"requested transfers completed"
argument_list|,
literal|"XfrReqDone"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|updatereqfwd
argument_list|,
literal|"update requests forwarded"
argument_list|,
literal|"UpdateReqFwd"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|updaterespfwd
argument_list|,
literal|"update responses forwarded"
argument_list|,
literal|"UpdateRespFwd"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|updatefwdfail
argument_list|,
literal|"update forward failed"
argument_list|,
literal|"UpdateFwdFail"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|updatedone
argument_list|,
literal|"updates completed"
argument_list|,
literal|"UpdateDone"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|updatefail
argument_list|,
literal|"updates failed"
argument_list|,
literal|"UpdateFail"
argument_list|)
expr_stmt|;
name|SET_NSSTATDESC
argument_list|(
name|updatebadprereq
argument_list|,
literal|"updates rejected due to prerequisite failure"
argument_list|,
literal|"UpdateBadPrereq"
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|i
operator|==
name|dns_nsstatscounter_max
argument_list|)
expr_stmt|;
comment|/* Initialize resolver statistics */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_resstatscounter_max
condition|;
name|i
operator|++
control|)
name|resstats_desc
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_resstatscounter_max
condition|;
name|i
operator|++
control|)
name|resstats_xmldesc
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
define|#
directive|define
name|SET_RESSTATDESC
parameter_list|(
name|counterid
parameter_list|,
name|desc
parameter_list|,
name|xmldesc
parameter_list|)
define|\
value|do { \ 		set_desc(dns_resstatscounter_ ## counterid, \ 			 dns_resstatscounter_max, \ 			 desc, resstats_desc, xmldesc, resstats_xmldesc); \ 		resstats_index[i++] = dns_resstatscounter_ ## counterid; \ 	} while (0)
name|i
operator|=
literal|0
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|queryv4
argument_list|,
literal|"IPv4 queries sent"
argument_list|,
literal|"Queryv4"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|queryv6
argument_list|,
literal|"IPv6 queries sent"
argument_list|,
literal|"Queryv6"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|responsev4
argument_list|,
literal|"IPv4 responses received"
argument_list|,
literal|"Responsev4"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|responsev6
argument_list|,
literal|"IPv6 responses received"
argument_list|,
literal|"Responsev6"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|nxdomain
argument_list|,
literal|"NXDOMAIN received"
argument_list|,
literal|"NXDOMAIN"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|servfail
argument_list|,
literal|"SERVFAIL received"
argument_list|,
literal|"SERVFAIL"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|formerr
argument_list|,
literal|"FORMERR received"
argument_list|,
literal|"FORMERR"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|othererror
argument_list|,
literal|"other errors received"
argument_list|,
literal|"OtherError"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|edns0fail
argument_list|,
literal|"EDNS(0) query failures"
argument_list|,
literal|"EDNS0Fail"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|mismatch
argument_list|,
literal|"mismatch responses received"
argument_list|,
literal|"Mismatch"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|truncated
argument_list|,
literal|"truncated responses received"
argument_list|,
literal|"Truncated"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|lame
argument_list|,
literal|"lame delegations received"
argument_list|,
literal|"Lame"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|retry
argument_list|,
literal|"query retries"
argument_list|,
literal|"Retry"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|dispabort
argument_list|,
literal|"queries aborted due to quota"
argument_list|,
literal|"QueryAbort"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|dispsockfail
argument_list|,
literal|"failures in opening query sockets"
argument_list|,
literal|"QuerySockFail"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|querytimeout
argument_list|,
literal|"query timeouts"
argument_list|,
literal|"QueryTimeout"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|gluefetchv4
argument_list|,
literal|"IPv4 NS address fetches"
argument_list|,
literal|"GlueFetchv4"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|gluefetchv6
argument_list|,
literal|"IPv6 NS address fetches"
argument_list|,
literal|"GlueFetchv6"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|gluefetchv4fail
argument_list|,
literal|"IPv4 NS address fetch failed"
argument_list|,
literal|"GlueFetchv4Fail"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|gluefetchv6fail
argument_list|,
literal|"IPv6 NS address fetch failed"
argument_list|,
literal|"GlueFetchv6Fail"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|val
argument_list|,
literal|"DNSSEC validation attempted"
argument_list|,
literal|"ValAttempt"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|valsuccess
argument_list|,
literal|"DNSSEC validation succeeded"
argument_list|,
literal|"ValOk"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|valnegsuccess
argument_list|,
literal|"DNSSEC NX validation succeeded"
argument_list|,
literal|"ValNegOk"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|valfail
argument_list|,
literal|"DNSSEC validation failed"
argument_list|,
literal|"ValFail"
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|queryrtt0
argument_list|,
literal|"queries with RTT< "
name|DNS_RESOLVER_QRYRTTCLASS0STR
literal|"ms"
argument_list|,
literal|"QryRTT"
name|DNS_RESOLVER_QRYRTTCLASS0STR
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|queryrtt1
argument_list|,
literal|"queries with RTT "
name|DNS_RESOLVER_QRYRTTCLASS0STR
literal|"-"
name|DNS_RESOLVER_QRYRTTCLASS1STR
literal|"ms"
argument_list|,
literal|"QryRTT"
name|DNS_RESOLVER_QRYRTTCLASS1STR
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|queryrtt2
argument_list|,
literal|"queries with RTT "
name|DNS_RESOLVER_QRYRTTCLASS1STR
literal|"-"
name|DNS_RESOLVER_QRYRTTCLASS2STR
literal|"ms"
argument_list|,
literal|"QryRTT"
name|DNS_RESOLVER_QRYRTTCLASS2STR
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|queryrtt3
argument_list|,
literal|"queries with RTT "
name|DNS_RESOLVER_QRYRTTCLASS2STR
literal|"-"
name|DNS_RESOLVER_QRYRTTCLASS3STR
literal|"ms"
argument_list|,
literal|"QryRTT"
name|DNS_RESOLVER_QRYRTTCLASS3STR
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|queryrtt4
argument_list|,
literal|"queries with RTT "
name|DNS_RESOLVER_QRYRTTCLASS3STR
literal|"-"
name|DNS_RESOLVER_QRYRTTCLASS4STR
literal|"ms"
argument_list|,
literal|"QryRTT"
name|DNS_RESOLVER_QRYRTTCLASS4STR
argument_list|)
expr_stmt|;
name|SET_RESSTATDESC
argument_list|(
name|queryrtt5
argument_list|,
literal|"queries with RTT> "
name|DNS_RESOLVER_QRYRTTCLASS4STR
literal|"ms"
argument_list|,
literal|"QryRTT"
name|DNS_RESOLVER_QRYRTTCLASS4STR
literal|"+"
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|i
operator|==
name|dns_resstatscounter_max
argument_list|)
expr_stmt|;
comment|/* Initialize zone statistics */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_zonestatscounter_max
condition|;
name|i
operator|++
control|)
name|zonestats_desc
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_zonestatscounter_max
condition|;
name|i
operator|++
control|)
name|zonestats_xmldesc
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
define|#
directive|define
name|SET_ZONESTATDESC
parameter_list|(
name|counterid
parameter_list|,
name|desc
parameter_list|,
name|xmldesc
parameter_list|)
define|\
value|do { \ 		set_desc(dns_zonestatscounter_ ## counterid, \ 			 dns_zonestatscounter_max, \ 			 desc, zonestats_desc, xmldesc, zonestats_xmldesc); \ 		zonestats_index[i++] = dns_zonestatscounter_ ## counterid; \ 	} while (0)
name|i
operator|=
literal|0
expr_stmt|;
name|SET_ZONESTATDESC
argument_list|(
name|notifyoutv4
argument_list|,
literal|"IPv4 notifies sent"
argument_list|,
literal|"NotifyOutv4"
argument_list|)
expr_stmt|;
name|SET_ZONESTATDESC
argument_list|(
name|notifyoutv6
argument_list|,
literal|"IPv6 notifies sent"
argument_list|,
literal|"NotifyOutv6"
argument_list|)
expr_stmt|;
name|SET_ZONESTATDESC
argument_list|(
name|notifyinv4
argument_list|,
literal|"IPv4 notifies received"
argument_list|,
literal|"NotifyInv4"
argument_list|)
expr_stmt|;
name|SET_ZONESTATDESC
argument_list|(
name|notifyinv6
argument_list|,
literal|"IPv6 notifies received"
argument_list|,
literal|"NotifyInv6"
argument_list|)
expr_stmt|;
name|SET_ZONESTATDESC
argument_list|(
name|notifyrej
argument_list|,
literal|"notifies rejected"
argument_list|,
literal|"NotifyRej"
argument_list|)
expr_stmt|;
name|SET_ZONESTATDESC
argument_list|(
name|soaoutv4
argument_list|,
literal|"IPv4 SOA queries sent"
argument_list|,
literal|"SOAOutv4"
argument_list|)
expr_stmt|;
name|SET_ZONESTATDESC
argument_list|(
name|soaoutv6
argument_list|,
literal|"IPv6 SOA queries sent"
argument_list|,
literal|"SOAOutv6"
argument_list|)
expr_stmt|;
name|SET_ZONESTATDESC
argument_list|(
name|axfrreqv4
argument_list|,
literal|"IPv4 AXFR requested"
argument_list|,
literal|"AXFRReqv4"
argument_list|)
expr_stmt|;
name|SET_ZONESTATDESC
argument_list|(
name|axfrreqv6
argument_list|,
literal|"IPv6 AXFR requested"
argument_list|,
literal|"AXFRReqv6"
argument_list|)
expr_stmt|;
name|SET_ZONESTATDESC
argument_list|(
name|ixfrreqv4
argument_list|,
literal|"IPv4 IXFR requested"
argument_list|,
literal|"IXFRReqv4"
argument_list|)
expr_stmt|;
name|SET_ZONESTATDESC
argument_list|(
name|ixfrreqv6
argument_list|,
literal|"IPv6 IXFR requested"
argument_list|,
literal|"IXFRReqv6"
argument_list|)
expr_stmt|;
name|SET_ZONESTATDESC
argument_list|(
name|xfrsuccess
argument_list|,
literal|"transfer requests succeeded"
argument_list|,
literal|"XfrSuccess"
argument_list|)
expr_stmt|;
name|SET_ZONESTATDESC
argument_list|(
name|xfrfail
argument_list|,
literal|"transfer requests failed"
argument_list|,
literal|"XfrFail"
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|i
operator|==
name|dns_zonestatscounter_max
argument_list|)
expr_stmt|;
comment|/* Initialize socket statistics */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|isc_sockstatscounter_max
condition|;
name|i
operator|++
control|)
name|sockstats_desc
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|isc_sockstatscounter_max
condition|;
name|i
operator|++
control|)
name|sockstats_xmldesc
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
define|#
directive|define
name|SET_SOCKSTATDESC
parameter_list|(
name|counterid
parameter_list|,
name|desc
parameter_list|,
name|xmldesc
parameter_list|)
define|\
value|do { \ 		set_desc(isc_sockstatscounter_ ## counterid, \ 			 isc_sockstatscounter_max, \ 			 desc, sockstats_desc, xmldesc, sockstats_xmldesc); \ 		sockstats_index[i++] = isc_sockstatscounter_ ## counterid; \ 	} while (0)
name|i
operator|=
literal|0
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp4open
argument_list|,
literal|"UDP/IPv4 sockets opened"
argument_list|,
literal|"UDP4Open"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp6open
argument_list|,
literal|"UDP/IPv6 sockets opened"
argument_list|,
literal|"UDP6Open"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp4open
argument_list|,
literal|"TCP/IPv4 sockets opened"
argument_list|,
literal|"TCP4Open"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp6open
argument_list|,
literal|"TCP/IPv6 sockets opened"
argument_list|,
literal|"TCP6Open"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|unixopen
argument_list|,
literal|"Unix domain sockets opened"
argument_list|,
literal|"UnixOpen"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp4openfail
argument_list|,
literal|"UDP/IPv4 socket open failures"
argument_list|,
literal|"UDP4OpenFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp6openfail
argument_list|,
literal|"UDP/IPv6 socket open failures"
argument_list|,
literal|"UDP6OpenFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp4openfail
argument_list|,
literal|"TCP/IPv4 socket open failures"
argument_list|,
literal|"TCP4OpenFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp6openfail
argument_list|,
literal|"TCP/IPv6 socket open failures"
argument_list|,
literal|"TCP6OpenFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|unixopenfail
argument_list|,
literal|"Unix domain socket open failures"
argument_list|,
literal|"UnixOpenFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp4close
argument_list|,
literal|"UDP/IPv4 sockets closed"
argument_list|,
literal|"UDP4Close"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp6close
argument_list|,
literal|"UDP/IPv6 sockets closed"
argument_list|,
literal|"UDP6Close"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp4close
argument_list|,
literal|"TCP/IPv4 sockets closed"
argument_list|,
literal|"TCP4Close"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp6close
argument_list|,
literal|"TCP/IPv6 sockets closed"
argument_list|,
literal|"TCP6Close"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|unixclose
argument_list|,
literal|"Unix domain sockets closed"
argument_list|,
literal|"UnixClose"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|fdwatchclose
argument_list|,
literal|"FDwatch sockets closed"
argument_list|,
literal|"FDWatchClose"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp4bindfail
argument_list|,
literal|"UDP/IPv4 socket bind failures"
argument_list|,
literal|"UDP4BindFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp6bindfail
argument_list|,
literal|"UDP/IPv6 socket bind failures"
argument_list|,
literal|"UDP6BindFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp4bindfail
argument_list|,
literal|"TCP/IPv4 socket bind failures"
argument_list|,
literal|"TCP4BindFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp6bindfail
argument_list|,
literal|"TCP/IPv6 socket bind failures"
argument_list|,
literal|"TCP6BindFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|unixbindfail
argument_list|,
literal|"Unix domain socket bind failures"
argument_list|,
literal|"UnixBindFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|fdwatchbindfail
argument_list|,
literal|"FDwatch socket bind failures"
argument_list|,
literal|"FdwatchBindFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp4connectfail
argument_list|,
literal|"UDP/IPv4 socket connect failures"
argument_list|,
literal|"UDP4ConnFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp6connectfail
argument_list|,
literal|"UDP/IPv6 socket connect failures"
argument_list|,
literal|"UDP6ConnFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp4connectfail
argument_list|,
literal|"TCP/IPv4 socket connect failures"
argument_list|,
literal|"TCP4ConnFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp6connectfail
argument_list|,
literal|"TCP/IPv6 socket connect failures"
argument_list|,
literal|"TCP6ConnFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|unixconnectfail
argument_list|,
literal|"Unix domain socket connect failures"
argument_list|,
literal|"UnixConnFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|fdwatchconnectfail
argument_list|,
literal|"FDwatch socket connect failures"
argument_list|,
literal|"FDwatchConnFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp4connect
argument_list|,
literal|"UDP/IPv4 connections established"
argument_list|,
literal|"UDP4Conn"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp6connect
argument_list|,
literal|"UDP/IPv6 connections established"
argument_list|,
literal|"UDP6Conn"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp4connect
argument_list|,
literal|"TCP/IPv4 connections established"
argument_list|,
literal|"TCP4Conn"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp6connect
argument_list|,
literal|"TCP/IPv6 connections established"
argument_list|,
literal|"TCP6Conn"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|unixconnect
argument_list|,
literal|"Unix domain connections established"
argument_list|,
literal|"UnixConn"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|fdwatchconnect
argument_list|,
literal|"FDwatch domain connections established"
argument_list|,
literal|"FDwatchConn"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp4acceptfail
argument_list|,
literal|"TCP/IPv4 connection accept failures"
argument_list|,
literal|"TCP4AcceptFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp6acceptfail
argument_list|,
literal|"TCP/IPv6 connection accept failures"
argument_list|,
literal|"TCP6AcceptFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|unixacceptfail
argument_list|,
literal|"Unix domain connection accept failures"
argument_list|,
literal|"UnixAcceptFail"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp4accept
argument_list|,
literal|"TCP/IPv4 connections accepted"
argument_list|,
literal|"TCP4Accept"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp6accept
argument_list|,
literal|"TCP/IPv6 connections accepted"
argument_list|,
literal|"TCP6Accept"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|unixaccept
argument_list|,
literal|"Unix domain connections accepted"
argument_list|,
literal|"UnixAccept"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp4sendfail
argument_list|,
literal|"UDP/IPv4 send errors"
argument_list|,
literal|"UDP4SendErr"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp6sendfail
argument_list|,
literal|"UDP/IPv6 send errors"
argument_list|,
literal|"UDP6SendErr"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp4sendfail
argument_list|,
literal|"TCP/IPv4 send errors"
argument_list|,
literal|"TCP4SendErr"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp6sendfail
argument_list|,
literal|"TCP/IPv6 send errors"
argument_list|,
literal|"TCP6SendErr"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|unixsendfail
argument_list|,
literal|"Unix domain send errors"
argument_list|,
literal|"UnixSendErr"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|fdwatchsendfail
argument_list|,
literal|"FDwatch send errors"
argument_list|,
literal|"FDwatchSendErr"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp4recvfail
argument_list|,
literal|"UDP/IPv4 recv errors"
argument_list|,
literal|"UDP4RecvErr"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|udp6recvfail
argument_list|,
literal|"UDP/IPv6 recv errors"
argument_list|,
literal|"UDP6RecvErr"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp4recvfail
argument_list|,
literal|"TCP/IPv4 recv errors"
argument_list|,
literal|"TCP4RecvErr"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|tcp6recvfail
argument_list|,
literal|"TCP/IPv6 recv errors"
argument_list|,
literal|"TCP6RecvErr"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|unixrecvfail
argument_list|,
literal|"Unix domain recv errors"
argument_list|,
literal|"UnixRecvErr"
argument_list|)
expr_stmt|;
name|SET_SOCKSTATDESC
argument_list|(
name|fdwatchrecvfail
argument_list|,
literal|"FDwatch recv errors"
argument_list|,
literal|"FDwatchRecvErr"
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|i
operator|==
name|isc_sockstatscounter_max
argument_list|)
expr_stmt|;
comment|/* Initialize DNSSEC statistics */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_dnssecstats_max
condition|;
name|i
operator|++
control|)
name|dnssecstats_desc
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_dnssecstats_max
condition|;
name|i
operator|++
control|)
name|dnssecstats_xmldesc
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
define|#
directive|define
name|SET_DNSSECSTATDESC
parameter_list|(
name|counterid
parameter_list|,
name|desc
parameter_list|,
name|xmldesc
parameter_list|)
define|\
value|do { \ 		set_desc(dns_dnssecstats_ ## counterid, \ 			 dns_dnssecstats_max, \ 			 desc, dnssecstats_desc,\ 			 xmldesc, dnssecstats_xmldesc); \ 		dnssecstats_index[i++] = dns_dnssecstats_ ## counterid; \ 	} while (0)
name|i
operator|=
literal|0
expr_stmt|;
name|SET_DNSSECSTATDESC
argument_list|(
name|asis
argument_list|,
literal|"dnssec validation success with signer "
literal|"\"as is\""
argument_list|,
literal|"DNSSECasis"
argument_list|)
expr_stmt|;
name|SET_DNSSECSTATDESC
argument_list|(
name|downcase
argument_list|,
literal|"dnssec validation success with signer "
literal|"lower cased"
argument_list|,
literal|"DNSSECdowncase"
argument_list|)
expr_stmt|;
name|SET_DNSSECSTATDESC
argument_list|(
name|wildcard
argument_list|,
literal|"dnssec validation of wildcard signature"
argument_list|,
literal|"DNSSECwild"
argument_list|)
expr_stmt|;
name|SET_DNSSECSTATDESC
argument_list|(
name|fail
argument_list|,
literal|"dnssec validation failures"
argument_list|,
literal|"DNSSECfail"
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|i
operator|==
name|dns_dnssecstats_max
argument_list|)
expr_stmt|;
comment|/* Sanity check */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_nsstatscounter_max
condition|;
name|i
operator|++
control|)
name|INSIST
argument_list|(
name|nsstats_desc
index|[
name|i
index|]
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_resstatscounter_max
condition|;
name|i
operator|++
control|)
name|INSIST
argument_list|(
name|resstats_desc
index|[
name|i
index|]
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_zonestatscounter_max
condition|;
name|i
operator|++
control|)
name|INSIST
argument_list|(
name|zonestats_desc
index|[
name|i
index|]
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|isc_sockstatscounter_max
condition|;
name|i
operator|++
control|)
name|INSIST
argument_list|(
name|sockstats_desc
index|[
name|i
index|]
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_dnssecstats_max
condition|;
name|i
operator|++
control|)
name|INSIST
argument_list|(
name|dnssecstats_desc
index|[
name|i
index|]
operator|!=
name|NULL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_nsstatscounter_max
condition|;
name|i
operator|++
control|)
name|INSIST
argument_list|(
name|nsstats_xmldesc
index|[
name|i
index|]
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_resstatscounter_max
condition|;
name|i
operator|++
control|)
name|INSIST
argument_list|(
name|resstats_xmldesc
index|[
name|i
index|]
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_zonestatscounter_max
condition|;
name|i
operator|++
control|)
name|INSIST
argument_list|(
name|zonestats_xmldesc
index|[
name|i
index|]
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|isc_sockstatscounter_max
condition|;
name|i
operator|++
control|)
name|INSIST
argument_list|(
name|sockstats_xmldesc
index|[
name|i
index|]
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dns_dnssecstats_max
condition|;
name|i
operator|++
control|)
name|INSIST
argument_list|(
name|dnssecstats_xmldesc
index|[
name|i
index|]
operator|!=
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*%  * Dump callback functions.  */
end_comment

begin_function
specifier|static
name|void
name|generalstat_dump
parameter_list|(
name|isc_statscounter_t
name|counter
parameter_list|,
name|isc_uint64_t
name|val
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stats_dumparg_t
modifier|*
name|dumparg
init|=
name|arg
decl_stmt|;
name|REQUIRE
argument_list|(
name|counter
operator|<
name|dumparg
operator|->
name|ncounters
argument_list|)
expr_stmt|;
name|dumparg
operator|->
name|countervalues
index|[
name|counter
index|]
operator|=
name|val
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dump_counters
parameter_list|(
name|isc_stats_t
modifier|*
name|stats
parameter_list|,
name|statsformat_t
name|type
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
specifier|const
name|char
modifier|*
name|category
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|desc
parameter_list|,
name|int
name|ncounters
parameter_list|,
name|int
modifier|*
name|indices
parameter_list|,
name|isc_uint64_t
modifier|*
name|values
parameter_list|,
name|int
name|options
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|index
decl_stmt|;
name|isc_uint64_t
name|value
decl_stmt|;
name|stats_dumparg_t
name|dumparg
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|xmlTextWriterPtr
name|writer
decl_stmt|;
name|int
name|xmlrc
decl_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|HAVE_LIBXML2
name|UNUSED
argument_list|(
name|category
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|dumparg
operator|.
name|type
operator|=
name|type
expr_stmt|;
name|dumparg
operator|.
name|ncounters
operator|=
name|ncounters
expr_stmt|;
name|dumparg
operator|.
name|counterindices
operator|=
name|indices
expr_stmt|;
name|dumparg
operator|.
name|countervalues
operator|=
name|values
expr_stmt|;
name|memset
argument_list|(
name|values
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|)
operator|*
name|ncounters
argument_list|)
expr_stmt|;
name|isc_stats_dump
argument_list|(
name|stats
argument_list|,
name|generalstat_dump
argument_list|,
operator|&
name|dumparg
argument_list|,
name|options
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ncounters
condition|;
name|i
operator|++
control|)
block|{
name|index
operator|=
name|indices
index|[
name|i
index|]
expr_stmt|;
name|value
operator|=
name|values
index|[
name|index
index|]
expr_stmt|;
if|if
condition|(
name|value
operator|==
literal|0
operator|&&
operator|(
name|options
operator|&
name|ISC_STATSDUMP_VERBOSE
operator|)
operator|==
literal|0
condition|)
continue|continue;
switch|switch
condition|(
name|dumparg
operator|.
name|type
condition|)
block|{
case|case
name|statsformat_file
case|:
name|fp
operator|=
name|arg
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%20"
name|ISC_PRINT_QUADFORMAT
literal|"u %s\n"
argument_list|,
name|value
argument_list|,
name|desc
index|[
name|index
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|statsformat_xml
case|:
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|writer
operator|=
name|arg
expr_stmt|;
if|if
condition|(
name|category
operator|!=
name|NULL
condition|)
block|{
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
argument|writer
argument_list|,
argument|ISC_XMLCHAR 							       category
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteString
argument_list|(
argument|writer
argument_list|,
argument|ISC_XMLCHAR 							      desc[index]
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* name */
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"counter"
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
argument|writer
argument_list|,
argument|ISC_XMLCHAR 							       desc[index]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|TRY0
argument_list|(
name|xmlTextWriterWriteFormatString
argument_list|(
name|writer
argument_list|,
literal|"%"
name|ISC_PRINT_QUADFORMAT
literal|"u"
argument_list|,
name|value
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* counter */
if|if
condition|(
name|category
operator|!=
name|NULL
condition|)
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* category */
endif|#
directive|endif
break|break;
block|}
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|error
label|:
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|rdtypestat_dump
parameter_list|(
name|dns_rdatastatstype_t
name|type
parameter_list|,
name|isc_uint64_t
name|val
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|char
name|typebuf
index|[
literal|64
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|typestr
decl_stmt|;
name|stats_dumparg_t
modifier|*
name|dumparg
init|=
name|arg
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|xmlTextWriterPtr
name|writer
decl_stmt|;
name|int
name|xmlrc
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|DNS_RDATASTATSTYPE_ATTR
argument_list|(
name|type
argument_list|)
operator|&
name|DNS_RDATASTATSTYPE_ATTR_OTHERTYPE
operator|)
operator|==
literal|0
condition|)
block|{
name|dns_rdatatype_format
argument_list|(
name|DNS_RDATASTATSTYPE_BASE
argument_list|(
name|type
argument_list|)
argument_list|,
name|typebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|typebuf
argument_list|)
argument_list|)
expr_stmt|;
name|typestr
operator|=
name|typebuf
expr_stmt|;
block|}
else|else
name|typestr
operator|=
literal|"Others"
expr_stmt|;
switch|switch
condition|(
name|dumparg
operator|->
name|type
condition|)
block|{
case|case
name|statsformat_file
case|:
name|fp
operator|=
name|dumparg
operator|->
name|arg
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%20"
name|ISC_PRINT_QUADFORMAT
literal|"u %s\n"
argument_list|,
name|val
argument_list|,
name|typestr
argument_list|)
expr_stmt|;
break|break;
case|case
name|statsformat_xml
case|:
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|writer
operator|=
name|dumparg
operator|->
name|arg
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"rdtype"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteString
argument_list|(
argument|writer
argument_list|,
argument|ISC_XMLCHAR typestr
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* name */
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"counter"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteFormatString
argument_list|(
name|writer
argument_list|,
literal|"%"
name|ISC_PRINT_QUADFORMAT
literal|"u"
argument_list|,
name|val
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* counter */
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* rdtype */
endif|#
directive|endif
break|break;
block|}
return|return;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|error
label|:
name|dumparg
operator|->
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
return|return;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|rdatasetstats_dump
parameter_list|(
name|dns_rdatastatstype_t
name|type
parameter_list|,
name|isc_uint64_t
name|val
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|stats_dumparg_t
modifier|*
name|dumparg
init|=
name|arg
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
name|typebuf
index|[
literal|64
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|typestr
decl_stmt|;
name|isc_boolean_t
name|nxrrset
init|=
name|ISC_FALSE
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|xmlTextWriterPtr
name|writer
decl_stmt|;
name|int
name|xmlrc
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|DNS_RDATASTATSTYPE_ATTR
argument_list|(
name|type
argument_list|)
operator|&
name|DNS_RDATASTATSTYPE_ATTR_NXDOMAIN
operator|)
operator|!=
literal|0
condition|)
block|{
name|typestr
operator|=
literal|"NXDOMAIN"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|DNS_RDATASTATSTYPE_ATTR
argument_list|(
name|type
argument_list|)
operator|&
name|DNS_RDATASTATSTYPE_ATTR_OTHERTYPE
operator|)
operator|!=
literal|0
condition|)
block|{
name|typestr
operator|=
literal|"Others"
expr_stmt|;
block|}
else|else
block|{
name|dns_rdatatype_format
argument_list|(
name|DNS_RDATASTATSTYPE_BASE
argument_list|(
name|type
argument_list|)
argument_list|,
name|typebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|typebuf
argument_list|)
argument_list|)
expr_stmt|;
name|typestr
operator|=
name|typebuf
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|DNS_RDATASTATSTYPE_ATTR
argument_list|(
name|type
argument_list|)
operator|&
name|DNS_RDATASTATSTYPE_ATTR_NXRRSET
operator|)
operator|!=
literal|0
condition|)
name|nxrrset
operator|=
name|ISC_TRUE
expr_stmt|;
switch|switch
condition|(
name|dumparg
operator|->
name|type
condition|)
block|{
case|case
name|statsformat_file
case|:
name|fp
operator|=
name|dumparg
operator|->
name|arg
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%20"
name|ISC_PRINT_QUADFORMAT
literal|"u %s%s\n"
argument_list|,
name|val
argument_list|,
name|nxrrset
condition|?
literal|"!"
else|:
literal|""
argument_list|,
name|typestr
argument_list|)
expr_stmt|;
break|break;
case|case
name|statsformat_xml
case|:
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|writer
operator|=
name|dumparg
operator|->
name|arg
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"rrset"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteFormatString
argument_list|(
name|writer
argument_list|,
literal|"%s%s"
argument_list|,
name|nxrrset
condition|?
literal|"!"
else|:
literal|""
argument_list|,
name|typestr
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* name */
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"counter"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteFormatString
argument_list|(
name|writer
argument_list|,
literal|"%"
name|ISC_PRINT_QUADFORMAT
literal|"u"
argument_list|,
name|val
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* counter */
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* rrset */
endif|#
directive|endif
break|break;
block|}
return|return;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|error
label|:
name|dumparg
operator|->
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|opcodestat_dump
parameter_list|(
name|dns_opcode_t
name|code
parameter_list|,
name|isc_uint64_t
name|val
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|char
name|codebuf
index|[
literal|64
index|]
decl_stmt|;
name|stats_dumparg_t
modifier|*
name|dumparg
init|=
name|arg
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|xmlTextWriterPtr
name|writer
decl_stmt|;
name|int
name|xmlrc
decl_stmt|;
endif|#
directive|endif
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|codebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|codebuf
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|dns_opcode_totext
argument_list|(
name|code
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|codebuf
index|[
name|isc_buffer_usedlength
argument_list|(
operator|&
name|b
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
switch|switch
condition|(
name|dumparg
operator|->
name|type
condition|)
block|{
case|case
name|statsformat_file
case|:
name|fp
operator|=
name|dumparg
operator|->
name|arg
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%20"
name|ISC_PRINT_QUADFORMAT
literal|"u %s\n"
argument_list|,
name|val
argument_list|,
name|codebuf
argument_list|)
expr_stmt|;
break|break;
case|case
name|statsformat_xml
case|:
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|writer
operator|=
name|dumparg
operator|->
name|arg
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"opcode"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteString
argument_list|(
argument|writer
argument_list|,
argument|ISC_XMLCHAR codebuf
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* name */
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"counter"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteFormatString
argument_list|(
name|writer
argument_list|,
literal|"%"
name|ISC_PRINT_QUADFORMAT
literal|"u"
argument_list|,
name|val
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* counter */
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* opcode */
endif|#
directive|endif
break|break;
block|}
return|return;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|error
label|:
name|dumparg
operator|->
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
return|return;
endif|#
directive|endif
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
end_ifdef

begin_comment
comment|/* XXXMLG below here sucks. */
end_comment

begin_function
specifier|static
name|isc_result_t
name|zone_xmlrender
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|char
name|buf
index|[
literal|1024
operator|+
literal|32
index|]
decl_stmt|;
comment|/* sufficiently large for zone name and class */
name|dns_rdataclass_t
name|rdclass
decl_stmt|;
name|isc_uint32_t
name|serial
decl_stmt|;
name|xmlTextWriterPtr
name|writer
init|=
name|arg
decl_stmt|;
name|isc_stats_t
modifier|*
name|zonestats
decl_stmt|;
name|isc_uint64_t
name|nsstat_values
index|[
name|dns_nsstatscounter_max
index|]
decl_stmt|;
name|int
name|xmlrc
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"zone"
argument_list|)
argument_list|)
expr_stmt|;
name|dns_zone_name
argument_list|(
name|zone
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteString
argument_list|(
argument|writer
argument_list|,
argument|ISC_XMLCHAR buf
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
name|rdclass
operator|=
name|dns_zone_getclass
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_rdataclass_format
argument_list|(
name|rdclass
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"rdataclass"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteString
argument_list|(
argument|writer
argument_list|,
argument|ISC_XMLCHAR buf
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"serial"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_zone_getserial2
argument_list|(
name|zone
argument_list|,
operator|&
name|serial
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
name|TRY0
argument_list|(
name|xmlTextWriterWriteFormatString
argument_list|(
name|writer
argument_list|,
literal|"%u"
argument_list|,
name|serial
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|TRY0
argument_list|(
name|xmlTextWriterWriteString
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"-"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
name|zonestats
operator|=
name|dns_zone_getrequeststats
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zonestats
operator|!=
name|NULL
condition|)
block|{
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"counters"
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dump_counters
argument_list|(
name|zonestats
argument_list|,
name|statsformat_xml
argument_list|,
name|writer
argument_list|,
name|NULL
argument_list|,
name|nsstats_xmldesc
argument_list|,
name|dns_nsstatscounter_max
argument_list|,
name|nsstats_index
argument_list|,
name|nsstat_values
argument_list|,
name|ISC_STATSDUMP_VERBOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|error
goto|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* counters */
block|}
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* zone */
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|error
label|:
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|generatexml
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|int
modifier|*
name|buflen
parameter_list|,
name|xmlChar
modifier|*
modifier|*
name|buf
parameter_list|)
block|{
name|char
name|boottime
index|[
sizeof|sizeof
expr|"yyyy-mm-ddThh:mm:ssZ"]
expr_stmt|;
name|char
name|nowstr
index|[
sizeof|sizeof
expr|"yyyy-mm-ddThh:mm:ssZ"]
expr_stmt|;
name|isc_time_t
name|now
decl_stmt|;
name|xmlTextWriterPtr
name|writer
init|=
name|NULL
decl_stmt|;
name|xmlDocPtr
name|doc
init|=
name|NULL
decl_stmt|;
name|int
name|xmlrc
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|stats_dumparg_t
name|dumparg
decl_stmt|;
name|dns_stats_t
modifier|*
name|cachestats
decl_stmt|;
name|isc_uint64_t
name|nsstat_values
index|[
name|dns_nsstatscounter_max
index|]
decl_stmt|;
name|isc_uint64_t
name|resstat_values
index|[
name|dns_resstatscounter_max
index|]
decl_stmt|;
name|isc_uint64_t
name|zonestat_values
index|[
name|dns_zonestatscounter_max
index|]
decl_stmt|;
name|isc_uint64_t
name|sockstat_values
index|[
name|isc_sockstatscounter_max
index|]
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_time_now
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|isc_time_formatISO8601
argument_list|(
operator|&
name|ns_g_boottime
argument_list|,
name|boottime
argument_list|,
sizeof|sizeof
name|boottime
argument_list|)
expr_stmt|;
name|isc_time_formatISO8601
argument_list|(
operator|&
name|now
argument_list|,
name|nowstr
argument_list|,
sizeof|sizeof
name|nowstr
argument_list|)
expr_stmt|;
name|writer
operator|=
name|xmlNewTextWriterDoc
argument_list|(
operator|&
name|doc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|writer
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|TRY0
argument_list|(
name|xmlTextWriterStartDocument
argument_list|(
name|writer
argument_list|,
name|NULL
argument_list|,
literal|"UTF-8"
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWritePI
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"xml-stylesheet"
argument_list|,
name|ISC_XMLCHAR
literal|"type=\"text/xsl\" href=\"/bind9.xsl\""
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"isc"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteAttribute
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"version"
argument_list|,
name|ISC_XMLCHAR
literal|"1.0"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"bind"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"statistics"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteAttribute
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"version"
argument_list|,
name|ISC_XMLCHAR
literal|"2.2"
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set common fields for statistics dump */
name|dumparg
operator|.
name|type
operator|=
name|statsformat_xml
expr_stmt|;
name|dumparg
operator|.
name|arg
operator|=
name|writer
expr_stmt|;
comment|/* 	 * Start by rendering the views we know of here.  For each view we 	 * know of, call its rendering function. 	 */
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"views"
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|view
operator|!=
name|NULL
condition|)
block|{
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"view"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteString
argument_list|(
argument|writer
argument_list|,
argument|ISC_XMLCHAR view->name
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"zones"
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_zt_apply
argument_list|(
name|view
operator|->
name|zonetable
argument_list|,
name|ISC_TRUE
argument_list|,
name|zone_xmlrender
argument_list|,
name|writer
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|error
goto|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|view
operator|->
name|resquerystats
operator|!=
name|NULL
condition|)
block|{
name|dumparg
operator|.
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|dns_rdatatypestats_dump
argument_list|(
name|view
operator|->
name|resquerystats
argument_list|,
name|rdtypestat_dump
argument_list|,
operator|&
name|dumparg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dumparg
operator|.
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|view
operator|->
name|resstats
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|dump_counters
argument_list|(
name|view
operator|->
name|resstats
argument_list|,
name|statsformat_xml
argument_list|,
name|writer
argument_list|,
literal|"resstat"
argument_list|,
name|resstats_xmldesc
argument_list|,
name|dns_resstatscounter_max
argument_list|,
name|resstats_index
argument_list|,
name|resstat_values
argument_list|,
name|ISC_STATSDUMP_VERBOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|error
goto|;
block|}
name|cachestats
operator|=
name|dns_db_getrrsetstats
argument_list|(
name|view
operator|->
name|cachedb
argument_list|)
expr_stmt|;
if|if
condition|(
name|cachestats
operator|!=
name|NULL
condition|)
block|{
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"cache"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteAttribute
argument_list|(
argument|writer
argument_list|,
argument|ISC_XMLCHAR
literal|"name"
argument_list|,
argument|ISC_XMLCHAR 					 dns_cache_getname(view->cache)
argument_list|)
argument_list|)
expr_stmt|;
name|dumparg
operator|.
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|dns_rdatasetstats_dump
argument_list|(
name|cachestats
argument_list|,
name|rdatasetstats_dump
argument_list|,
operator|&
name|dumparg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dumparg
operator|.
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|error
goto|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* cache */
block|}
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* view */
name|view
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* views */
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"socketmgr"
argument_list|)
argument_list|)
expr_stmt|;
name|isc_socketmgr_renderxml
argument_list|(
name|ns_g_socketmgr
argument_list|,
name|writer
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* socketmgr */
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"taskmgr"
argument_list|)
argument_list|)
expr_stmt|;
name|isc_taskmgr_renderxml
argument_list|(
name|ns_g_taskmgr
argument_list|,
name|writer
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* taskmgr */
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"server"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"boot-time"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteString
argument_list|(
argument|writer
argument_list|,
argument|ISC_XMLCHAR boottime
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"current-time"
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterWriteString
argument_list|(
argument|writer
argument_list|,
argument|ISC_XMLCHAR nowstr
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"requests"
argument_list|)
argument_list|)
expr_stmt|;
name|dumparg
operator|.
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|dns_opcodestats_dump
argument_list|(
name|server
operator|->
name|opcodestats
argument_list|,
name|opcodestat_dump
argument_list|,
operator|&
name|dumparg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dumparg
operator|.
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|error
goto|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* requests */
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"queries-in"
argument_list|)
argument_list|)
expr_stmt|;
name|dumparg
operator|.
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|dns_rdatatypestats_dump
argument_list|(
name|server
operator|->
name|rcvquerystats
argument_list|,
name|rdtypestat_dump
argument_list|,
operator|&
name|dumparg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dumparg
operator|.
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|error
goto|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* queries-in */
name|result
operator|=
name|dump_counters
argument_list|(
name|server
operator|->
name|nsstats
argument_list|,
name|statsformat_xml
argument_list|,
name|writer
argument_list|,
literal|"nsstat"
argument_list|,
name|nsstats_xmldesc
argument_list|,
name|dns_nsstatscounter_max
argument_list|,
name|nsstats_index
argument_list|,
name|nsstat_values
argument_list|,
name|ISC_STATSDUMP_VERBOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|error
goto|;
name|result
operator|=
name|dump_counters
argument_list|(
name|server
operator|->
name|zonestats
argument_list|,
name|statsformat_xml
argument_list|,
name|writer
argument_list|,
literal|"zonestat"
argument_list|,
name|zonestats_xmldesc
argument_list|,
name|dns_zonestatscounter_max
argument_list|,
name|zonestats_index
argument_list|,
name|zonestat_values
argument_list|,
name|ISC_STATSDUMP_VERBOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|error
goto|;
comment|/* 	 * Most of the common resolver statistics entries are 0, so we don't 	 * use the verbose dump here. 	 */
name|result
operator|=
name|dump_counters
argument_list|(
name|server
operator|->
name|resolverstats
argument_list|,
name|statsformat_xml
argument_list|,
name|writer
argument_list|,
literal|"resstat"
argument_list|,
name|resstats_xmldesc
argument_list|,
name|dns_resstatscounter_max
argument_list|,
name|resstats_index
argument_list|,
name|resstat_values
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|error
goto|;
name|result
operator|=
name|dump_counters
argument_list|(
name|server
operator|->
name|sockstats
argument_list|,
name|statsformat_xml
argument_list|,
name|writer
argument_list|,
literal|"sockstat"
argument_list|,
name|sockstats_xmldesc
argument_list|,
name|isc_sockstatscounter_max
argument_list|,
name|sockstats_index
argument_list|,
name|sockstat_values
argument_list|,
name|ISC_STATSDUMP_VERBOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|error
goto|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* server */
name|TRY0
argument_list|(
name|xmlTextWriterStartElement
argument_list|(
name|writer
argument_list|,
name|ISC_XMLCHAR
literal|"memory"
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_renderxml
argument_list|(
name|writer
argument_list|)
expr_stmt|;
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* memory */
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* statistics */
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* bind */
name|TRY0
argument_list|(
name|xmlTextWriterEndElement
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* isc */
name|TRY0
argument_list|(
name|xmlTextWriterEndDocument
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
name|xmlFreeTextWriter
argument_list|(
name|writer
argument_list|)
expr_stmt|;
name|xmlDocDumpFormatMemoryEnc
argument_list|(
name|doc
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"UTF-8"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|xmlFreeDoc
argument_list|(
name|doc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|error
label|:
if|if
condition|(
name|writer
operator|!=
name|NULL
condition|)
name|xmlFreeTextWriter
argument_list|(
name|writer
argument_list|)
expr_stmt|;
if|if
condition|(
name|doc
operator|!=
name|NULL
condition|)
name|xmlFreeDoc
argument_list|(
name|doc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wrap_xmlfree
parameter_list|(
name|isc_buffer_t
modifier|*
name|buffer
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|xmlFree
argument_list|(
name|isc_buffer_base
argument_list|(
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|render_index
parameter_list|(
specifier|const
name|char
modifier|*
name|url
parameter_list|,
specifier|const
name|char
modifier|*
name|querystring
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|unsigned
name|int
modifier|*
name|retcode
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|retmsg
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|mimetype
parameter_list|,
name|isc_buffer_t
modifier|*
name|b
parameter_list|,
name|isc_httpdfree_t
modifier|*
modifier|*
name|freecb
parameter_list|,
name|void
modifier|*
modifier|*
name|freecb_args
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|msg
decl_stmt|;
name|int
name|msglen
decl_stmt|;
name|ns_server_t
modifier|*
name|server
init|=
name|arg
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|UNUSED
argument_list|(
name|url
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|querystring
argument_list|)
expr_stmt|;
name|result
operator|=
name|generatexml
argument_list|(
name|server
argument_list|,
operator|&
name|msglen
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
operator|*
name|retcode
operator|=
literal|200
expr_stmt|;
operator|*
name|retmsg
operator|=
literal|"OK"
expr_stmt|;
operator|*
name|mimetype
operator|=
literal|"text/xml"
expr_stmt|;
name|isc_buffer_reinit
argument_list|(
name|b
argument_list|,
name|msg
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
name|b
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
operator|*
name|freecb
operator|=
name|wrap_xmlfree
expr_stmt|;
operator|*
name|freecb_args
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_LIBXML2 */
end_comment

begin_function
specifier|static
name|isc_result_t
name|render_xsl
parameter_list|(
specifier|const
name|char
modifier|*
name|url
parameter_list|,
specifier|const
name|char
modifier|*
name|querystring
parameter_list|,
name|void
modifier|*
name|args
parameter_list|,
name|unsigned
name|int
modifier|*
name|retcode
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|retmsg
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|mimetype
parameter_list|,
name|isc_buffer_t
modifier|*
name|b
parameter_list|,
name|isc_httpdfree_t
modifier|*
modifier|*
name|freecb
parameter_list|,
name|void
modifier|*
modifier|*
name|freecb_args
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|url
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|querystring
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|args
argument_list|)
expr_stmt|;
operator|*
name|retcode
operator|=
literal|200
expr_stmt|;
operator|*
name|retmsg
operator|=
literal|"OK"
expr_stmt|;
operator|*
name|mimetype
operator|=
literal|"text/xslt+xml"
expr_stmt|;
name|isc_buffer_reinit
argument_list|(
name|b
argument_list|,
name|xslmsg
argument_list|,
name|strlen
argument_list|(
name|xslmsg
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
name|b
argument_list|,
name|strlen
argument_list|(
name|xslmsg
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|freecb
operator|=
name|NULL
expr_stmt|;
operator|*
name|freecb_args
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|shutdown_listener
parameter_list|(
name|ns_statschannel_t
modifier|*
name|listener
parameter_list|)
block|{
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|listener
operator|->
name|address
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_NOTICE
argument_list|,
literal|"stopping statistics channel on %s"
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
name|isc_httpdmgr_shutdown
argument_list|(
operator|&
name|listener
operator|->
name|httpdmgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|client_ok
parameter_list|(
specifier|const
name|isc_sockaddr_t
modifier|*
name|fromaddr
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|ns_statschannel_t
modifier|*
name|listener
init|=
name|arg
decl_stmt|;
name|isc_netaddr_t
name|netaddr
decl_stmt|;
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|int
name|match
decl_stmt|;
name|REQUIRE
argument_list|(
name|listener
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|netaddr
argument_list|,
name|fromaddr
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_acl_match
argument_list|(
operator|&
name|netaddr
argument_list|,
name|NULL
argument_list|,
name|listener
operator|->
name|acl
argument_list|,
operator|&
name|ns_g_server
operator|->
name|aclenv
argument_list|,
operator|&
name|match
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_SUCCESS
operator|&&
name|match
operator|>
literal|0
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
name|fromaddr
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"rejected statistics connection from %s"
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroy_listener
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|ns_statschannel_t
modifier|*
name|listener
init|=
name|arg
decl_stmt|;
name|REQUIRE
argument_list|(
name|listener
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|!
name|ISC_LINK_LINKED
argument_list|(
name|listener
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We don't have to acquire the lock here since it's already unlinked */
name|dns_acl_detach
argument_list|(
operator|&
name|listener
operator|->
name|acl
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_putanddetach
argument_list|(
operator|&
name|listener
operator|->
name|mctx
argument_list|,
name|listener
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|listener
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|add_listener
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|ns_statschannel_t
modifier|*
modifier|*
name|listenerp
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|listen_params
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|,
name|cfg_aclconfctx_t
modifier|*
name|aclconfctx
parameter_list|,
specifier|const
name|char
modifier|*
name|socktext
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|ns_statschannel_t
modifier|*
name|listener
decl_stmt|;
name|isc_task_t
modifier|*
name|task
init|=
name|NULL
decl_stmt|;
name|isc_socket_t
modifier|*
name|sock
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|allow
decl_stmt|;
name|dns_acl_t
modifier|*
name|new_acl
init|=
name|NULL
decl_stmt|;
name|listener
operator|=
name|isc_mem_get
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|listener
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|listener
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|listener
operator|->
name|httpdmgr
operator|=
name|NULL
expr_stmt|;
name|listener
operator|->
name|address
operator|=
operator|*
name|addr
expr_stmt|;
name|listener
operator|->
name|acl
operator|=
name|NULL
expr_stmt|;
name|listener
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
name|listener
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|listener
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
name|isc_mem_attach
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
operator|&
name|listener
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|allow
operator|=
name|cfg_tuple_get
argument_list|(
name|listen_params
argument_list|,
literal|"allow"
argument_list|)
expr_stmt|;
if|if
condition|(
name|allow
operator|!=
name|NULL
operator|&&
name|cfg_obj_islist
argument_list|(
name|allow
argument_list|)
condition|)
block|{
name|result
operator|=
name|cfg_acl_fromconfig
argument_list|(
name|allow
argument_list|,
name|config
argument_list|,
name|ns_g_lctx
argument_list|,
name|aclconfctx
argument_list|,
name|listener
operator|->
name|mctx
argument_list|,
literal|0
argument_list|,
operator|&
name|new_acl
argument_list|)
expr_stmt|;
block|}
else|else
name|result
operator|=
name|dns_acl_any
argument_list|(
name|listener
operator|->
name|mctx
argument_list|,
operator|&
name|new_acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|dns_acl_attach
argument_list|(
name|new_acl
argument_list|,
operator|&
name|listener
operator|->
name|acl
argument_list|)
expr_stmt|;
name|dns_acl_detach
argument_list|(
operator|&
name|new_acl
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_task_create
argument_list|(
name|ns_g_taskmgr
argument_list|,
literal|0
argument_list|,
operator|&
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|isc_task_setname
argument_list|(
name|task
argument_list|,
literal|"statchannel"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_socket_create
argument_list|(
name|ns_g_socketmgr
argument_list|,
name|isc_sockaddr_pf
argument_list|(
name|addr
argument_list|)
argument_list|,
name|isc_sockettype_tcp
argument_list|,
operator|&
name|sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|isc_socket_setname
argument_list|(
name|sock
argument_list|,
literal|"statchannel"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|ISC_ALLOW_MAPPED
name|isc_socket_ipv6only
argument_list|(
name|sock
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|result
operator|=
name|isc_socket_bind
argument_list|(
name|sock
argument_list|,
name|addr
argument_list|,
name|ISC_SOCKET_REUSEADDRESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|isc_httpdmgr_create
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
name|sock
argument_list|,
name|task
argument_list|,
name|client_ok
argument_list|,
name|destroy_listener
argument_list|,
name|listener
argument_list|,
name|ns_g_timermgr
argument_list|,
operator|&
name|listener
operator|->
name|httpdmgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
ifdef|#
directive|ifdef
name|HAVE_LIBXML2
name|isc_httpdmgr_addurl
argument_list|(
name|listener
operator|->
name|httpdmgr
argument_list|,
literal|"/"
argument_list|,
name|render_index
argument_list|,
name|server
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|isc_httpdmgr_addurl
argument_list|(
name|listener
operator|->
name|httpdmgr
argument_list|,
literal|"/bind9.xsl"
argument_list|,
name|render_xsl
argument_list|,
name|server
argument_list|)
expr_stmt|;
operator|*
name|listenerp
operator|=
name|listener
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_NOTICE
argument_list|,
literal|"statistics channel listening on %s"
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|listener
operator|->
name|acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|listener
operator|->
name|acl
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_putanddetach
argument_list|(
operator|&
name|listener
operator|->
name|mctx
argument_list|,
name|listener
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|listener
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|task
operator|!=
name|NULL
condition|)
name|isc_task_detach
argument_list|(
operator|&
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|sock
operator|!=
name|NULL
condition|)
name|isc_socket_detach
argument_list|(
operator|&
name|sock
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|update_listener
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|ns_statschannel_t
modifier|*
modifier|*
name|listenerp
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|listen_params
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|,
name|cfg_aclconfctx_t
modifier|*
name|aclconfctx
parameter_list|,
specifier|const
name|char
modifier|*
name|socktext
parameter_list|)
block|{
name|ns_statschannel_t
modifier|*
name|listener
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|allow
init|=
name|NULL
decl_stmt|;
name|dns_acl_t
modifier|*
name|new_acl
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
for|for
control|(
name|listener
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|statschannels
argument_list|)
init|;
name|listener
operator|!=
name|NULL
condition|;
name|listener
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|listener
argument_list|,
name|link
argument_list|)
control|)
if|if
condition|(
name|isc_sockaddr_equal
argument_list|(
name|addr
argument_list|,
operator|&
name|listener
operator|->
name|address
argument_list|)
condition|)
break|break;
if|if
condition|(
name|listener
operator|==
name|NULL
condition|)
block|{
operator|*
name|listenerp
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
comment|/* 	 * Now, keep the old access list unless a new one can be made. 	 */
name|allow
operator|=
name|cfg_tuple_get
argument_list|(
name|listen_params
argument_list|,
literal|"allow"
argument_list|)
expr_stmt|;
if|if
condition|(
name|allow
operator|!=
name|NULL
operator|&&
name|cfg_obj_islist
argument_list|(
name|allow
argument_list|)
condition|)
block|{
name|result
operator|=
name|cfg_acl_fromconfig
argument_list|(
name|allow
argument_list|,
name|config
argument_list|,
name|ns_g_lctx
argument_list|,
name|aclconfctx
argument_list|,
name|listener
operator|->
name|mctx
argument_list|,
literal|0
argument_list|,
operator|&
name|new_acl
argument_list|)
expr_stmt|;
block|}
else|else
name|result
operator|=
name|dns_acl_any
argument_list|(
name|listener
operator|->
name|mctx
argument_list|,
operator|&
name|new_acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|LOCK
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dns_acl_detach
argument_list|(
operator|&
name|listener
operator|->
name|acl
argument_list|)
expr_stmt|;
name|dns_acl_attach
argument_list|(
name|new_acl
argument_list|,
operator|&
name|listener
operator|->
name|acl
argument_list|)
expr_stmt|;
name|dns_acl_detach
argument_list|(
operator|&
name|new_acl
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|listener
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cfg_obj_log
argument_list|(
name|listen_params
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't install new acl for "
literal|"statistics channel %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|listenerp
operator|=
name|listener
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_statschannels_configure
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|cfg_aclconfctx_t
modifier|*
name|aclconfctx
parameter_list|)
block|{
name|ns_statschannel_t
modifier|*
name|listener
decl_stmt|,
modifier|*
name|listener_next
decl_stmt|;
name|ns_statschannellist_t
name|new_listeners
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|statschannellist
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|,
modifier|*
name|element2
decl_stmt|;
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|isc_once_do
argument_list|(
operator|&
name|once
argument_list|,
name|init_desc
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|new_listeners
argument_list|)
expr_stmt|;
comment|/* 	 * Get the list of named.conf 'statistics-channels' statements. 	 */
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"statistics-channels"
argument_list|,
operator|&
name|statschannellist
argument_list|)
expr_stmt|;
comment|/* 	 * Run through the new address/port list, noting sockets that are 	 * already being listened on and moving them to the new list. 	 * 	 * Identifying duplicate addr/port combinations is left to either 	 * the underlying config code, or to the bind attempt getting an 	 * address-in-use error. 	 */
if|if
condition|(
name|statschannellist
operator|!=
name|NULL
condition|)
block|{
ifndef|#
directive|ifndef
name|HAVE_LIBXML2
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"statistics-channels specified but not effective "
literal|"due to missing XML library"
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|statschannellist
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|statschannel
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|listenercfg
init|=
name|NULL
decl_stmt|;
name|statschannel
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|statschannel
argument_list|,
literal|"inet"
argument_list|,
operator|&
name|listenercfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|listenercfg
operator|==
name|NULL
condition|)
continue|continue;
for|for
control|(
name|element2
operator|=
name|cfg_list_first
argument_list|(
name|listenercfg
argument_list|)
init|;
name|element2
operator|!=
name|NULL
condition|;
name|element2
operator|=
name|cfg_list_next
argument_list|(
name|element2
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|listen_params
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|;
name|isc_sockaddr_t
name|addr
decl_stmt|;
name|listen_params
operator|=
name|cfg_listelt_value
argument_list|(
name|element2
argument_list|)
expr_stmt|;
name|obj
operator|=
name|cfg_tuple_get
argument_list|(
name|listen_params
argument_list|,
literal|"address"
argument_list|)
expr_stmt|;
name|addr
operator|=
operator|*
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_sockaddr_getport
argument_list|(
operator|&
name|addr
argument_list|)
operator|==
literal|0
condition|)
name|isc_sockaddr_setport
argument_list|(
operator|&
name|addr
argument_list|,
name|NS_STATSCHANNEL_HTTPPORT
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|addr
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|9
argument_list|)
argument_list|,
literal|"processing statistics "
literal|"channel %s"
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
name|update_listener
argument_list|(
name|server
argument_list|,
operator|&
name|listener
argument_list|,
name|listen_params
argument_list|,
name|config
argument_list|,
operator|&
name|addr
argument_list|,
name|aclconfctx
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
if|if
condition|(
name|listener
operator|!=
name|NULL
condition|)
block|{
comment|/* 					 * Remove the listener from the old 					 * list, so it won't be shut down. 					 */
name|ISC_LIST_UNLINK
argument_list|(
name|server
operator|->
name|statschannels
argument_list|,
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 					 * This is a new listener. 					 */
name|isc_result_t
name|r
decl_stmt|;
name|r
operator|=
name|add_listener
argument_list|(
name|server
argument_list|,
operator|&
name|listener
argument_list|,
name|listen_params
argument_list|,
name|config
argument_list|,
operator|&
name|addr
argument_list|,
name|aclconfctx
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|listen_params
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't allocate "
literal|"statistics channel"
literal|" %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|listener
operator|!=
name|NULL
condition|)
name|ISC_LIST_APPEND
argument_list|(
name|new_listeners
argument_list|,
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
block|}
block|}
for|for
control|(
name|listener
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|statschannels
argument_list|)
init|;
name|listener
operator|!=
name|NULL
condition|;
name|listener
operator|=
name|listener_next
control|)
block|{
name|listener_next
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|server
operator|->
name|statschannels
argument_list|,
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|shutdown_listener
argument_list|(
name|listener
argument_list|)
expr_stmt|;
block|}
name|ISC_LIST_APPENDLIST
argument_list|(
name|server
operator|->
name|statschannels
argument_list|,
name|new_listeners
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ns_statschannels_shutdown
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|)
block|{
name|ns_statschannel_t
modifier|*
name|listener
decl_stmt|;
while|while
condition|(
operator|(
name|listener
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|statschannels
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|server
operator|->
name|statschannels
argument_list|,
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|shutdown_listener
argument_list|(
name|listener
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|isc_result_t
name|ns_stats_dump
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|isc_stdtime_t
name|now
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
decl_stmt|,
modifier|*
name|next
decl_stmt|;
name|stats_dumparg_t
name|dumparg
decl_stmt|;
name|isc_uint64_t
name|nsstat_values
index|[
name|dns_nsstatscounter_max
index|]
decl_stmt|;
name|isc_uint64_t
name|resstat_values
index|[
name|dns_resstatscounter_max
index|]
decl_stmt|;
name|isc_uint64_t
name|zonestat_values
index|[
name|dns_zonestatscounter_max
index|]
decl_stmt|;
name|isc_uint64_t
name|sockstat_values
index|[
name|isc_sockstatscounter_max
index|]
decl_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|isc_once_do
argument_list|(
operator|&
name|once
argument_list|,
name|init_desc
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
comment|/* Set common fields */
name|dumparg
operator|.
name|type
operator|=
name|statsformat_file
expr_stmt|;
name|dumparg
operator|.
name|arg
operator|=
name|fp
expr_stmt|;
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"+++ Statistics Dump +++ (%lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|now
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"++ Incoming Requests ++\n"
argument_list|)
expr_stmt|;
name|dns_opcodestats_dump
argument_list|(
name|server
operator|->
name|opcodestats
argument_list|,
name|opcodestat_dump
argument_list|,
operator|&
name|dumparg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"++ Incoming Queries ++\n"
argument_list|)
expr_stmt|;
name|dns_rdatatypestats_dump
argument_list|(
name|server
operator|->
name|rcvquerystats
argument_list|,
name|rdtypestat_dump
argument_list|,
operator|&
name|dumparg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"++ Outgoing Queries ++\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|view
operator|->
name|resquerystats
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
literal|"_default"
argument_list|)
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"[View: default]\n"
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"[View: %s]\n"
argument_list|,
name|view
operator|->
name|name
argument_list|)
expr_stmt|;
name|dns_rdatatypestats_dump
argument_list|(
name|view
operator|->
name|resquerystats
argument_list|,
name|rdtypestat_dump
argument_list|,
operator|&
name|dumparg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"++ Name Server Statistics ++\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dump_counters
argument_list|(
name|server
operator|->
name|nsstats
argument_list|,
name|statsformat_file
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|,
name|nsstats_desc
argument_list|,
name|dns_nsstatscounter_max
argument_list|,
name|nsstats_index
argument_list|,
name|nsstat_values
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"++ Zone Maintenance Statistics ++\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dump_counters
argument_list|(
name|server
operator|->
name|zonestats
argument_list|,
name|statsformat_file
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|,
name|zonestats_desc
argument_list|,
name|dns_zonestatscounter_max
argument_list|,
name|zonestats_index
argument_list|,
name|zonestat_values
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"++ Resolver Statistics ++\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"[Common]\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dump_counters
argument_list|(
name|server
operator|->
name|resolverstats
argument_list|,
name|statsformat_file
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|,
name|resstats_desc
argument_list|,
name|dns_resstatscounter_max
argument_list|,
name|resstats_index
argument_list|,
name|resstat_values
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|view
operator|->
name|resstats
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
literal|"_default"
argument_list|)
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"[View: default]\n"
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"[View: %s]\n"
argument_list|,
name|view
operator|->
name|name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dump_counters
argument_list|(
name|view
operator|->
name|resstats
argument_list|,
name|statsformat_file
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|,
name|resstats_desc
argument_list|,
name|dns_resstatscounter_max
argument_list|,
name|resstats_index
argument_list|,
name|resstat_values
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"++ Cache DB RRsets ++\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
control|)
block|{
name|dns_stats_t
modifier|*
name|cachestats
decl_stmt|;
name|cachestats
operator|=
name|dns_db_getrrsetstats
argument_list|(
name|view
operator|->
name|cachedb
argument_list|)
expr_stmt|;
if|if
condition|(
name|cachestats
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
literal|"_default"
argument_list|)
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"[View: default]\n"
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"[View: %s (Cache: %s)]\n"
argument_list|,
name|view
operator|->
name|name
argument_list|,
name|dns_cache_getname
argument_list|(
name|view
operator|->
name|cache
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_view_iscacheshared
argument_list|(
name|view
argument_list|)
condition|)
block|{
comment|/* 			 * Avoid dumping redundant statistics when the cache is 			 * shared. 			 */
continue|continue;
block|}
name|dns_rdatasetstats_dump
argument_list|(
name|cachestats
argument_list|,
name|rdatasetstats_dump
argument_list|,
operator|&
name|dumparg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"++ Socket I/O Statistics ++\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dump_counters
argument_list|(
name|server
operator|->
name|sockstats
argument_list|,
name|statsformat_file
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|,
name|sockstats_desc
argument_list|,
name|isc_sockstatscounter_max
argument_list|,
name|sockstats_index
argument_list|,
name|sockstat_values
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"++ Per Zone Query Statistics ++\n"
argument_list|)
expr_stmt|;
name|zone
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_zone_first
argument_list|(
name|server
operator|->
name|zonemgr
argument_list|,
operator|&
name|zone
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|next
operator|=
name|NULL
operator|,
name|result
operator|=
name|dns_zone_next
argument_list|(
name|zone
argument_list|,
operator|&
name|next
argument_list|)
operator|,
name|zone
operator|=
name|next
control|)
block|{
name|isc_stats_t
modifier|*
name|zonestats
init|=
name|dns_zone_getrequeststats
argument_list|(
name|zone
argument_list|)
decl_stmt|;
if|if
condition|(
name|zonestats
operator|!=
name|NULL
condition|)
block|{
name|char
name|zonename
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|dns_zone_getorigin
argument_list|(
name|zone
argument_list|)
argument_list|,
name|zonename
argument_list|,
sizeof|sizeof
argument_list|(
name|zonename
argument_list|)
argument_list|)
expr_stmt|;
name|view
operator|=
name|dns_zone_getview
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"[%s"
argument_list|,
name|zonename
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
literal|"_default"
argument_list|)
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" (view: %s)"
argument_list|,
name|view
operator|->
name|name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"]\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dump_counters
argument_list|(
name|zonestats
argument_list|,
name|statsformat_file
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|,
name|nsstats_desc
argument_list|,
name|dns_nsstatscounter_max
argument_list|,
name|nsstats_index
argument_list|,
name|nsstat_values
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"--- Statistics Dump --- (%lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|now
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
comment|/* this function currently always succeeds */
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004-2006, 2009  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2002  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: log.c,v 1.37.18.9 2009-09-24 21:38:50 jinmei Exp $ */
end_comment

begin_comment
comment|/*! \file */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/result.h>
end_include

begin_include
include|#
directive|include
file|<isccfg/log.h>
end_include

begin_include
include|#
directive|include
file|<named/log.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|ISC_FACILITY
end_ifndef

begin_define
define|#
directive|define
name|ISC_FACILITY
value|LOG_DAEMON
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*%  * When adding a new category, be sure to add the appropriate  * #define to<named/log.h> and to update the list in  * bin/check/check-tool.c.  */
end_comment

begin_decl_stmt
specifier|static
name|isc_logcategory_t
name|categories
index|[]
init|=
block|{
block|{
literal|""
block|,
literal|0
block|}
block|,
block|{
literal|"client"
block|,
literal|0
block|}
block|,
block|{
literal|"network"
block|,
literal|0
block|}
block|,
block|{
literal|"update"
block|,
literal|0
block|}
block|,
block|{
literal|"queries"
block|,
literal|0
block|}
block|,
block|{
literal|"unmatched"
block|,
literal|0
block|}
block|,
block|{
literal|"update-security"
block|,
literal|0
block|}
block|,
block|{
literal|"query-errors"
block|,
literal|0
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*%  * When adding a new module, be sure to add the appropriate  * #define to<dns/log.h>.  */
end_comment

begin_decl_stmt
specifier|static
name|isc_logmodule_t
name|modules
index|[]
init|=
block|{
block|{
literal|"main"
block|,
literal|0
block|}
block|,
block|{
literal|"client"
block|,
literal|0
block|}
block|,
block|{
literal|"server"
block|,
literal|0
block|}
block|,
block|{
literal|"query"
block|,
literal|0
block|}
block|,
block|{
literal|"interfacemgr"
block|,
literal|0
block|}
block|,
block|{
literal|"update"
block|,
literal|0
block|}
block|,
block|{
literal|"xfer-in"
block|,
literal|0
block|}
block|,
block|{
literal|"xfer-out"
block|,
literal|0
block|}
block|,
block|{
literal|"notify"
block|,
literal|0
block|}
block|,
block|{
literal|"control"
block|,
literal|0
block|}
block|,
block|{
literal|"lwresd"
block|,
literal|0
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|isc_result_t
name|ns_log_init
parameter_list|(
name|isc_boolean_t
name|safe
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_logconfig_t
modifier|*
name|lcfg
init|=
name|NULL
decl_stmt|;
name|ns_g_categories
operator|=
name|categories
expr_stmt|;
name|ns_g_modules
operator|=
name|modules
expr_stmt|;
comment|/* 	 * Setup a logging context. 	 */
name|result
operator|=
name|isc_log_create
argument_list|(
name|ns_g_mctx
argument_list|,
operator|&
name|ns_g_lctx
argument_list|,
operator|&
name|lcfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* 	 * named-checktool.c:setup_logging() needs to be kept in sync. 	 */
name|isc_log_registercategories
argument_list|(
name|ns_g_lctx
argument_list|,
name|ns_g_categories
argument_list|)
expr_stmt|;
name|isc_log_registermodules
argument_list|(
name|ns_g_lctx
argument_list|,
name|ns_g_modules
argument_list|)
expr_stmt|;
name|isc_log_setcontext
argument_list|(
name|ns_g_lctx
argument_list|)
expr_stmt|;
name|dns_log_init
argument_list|(
name|ns_g_lctx
argument_list|)
expr_stmt|;
name|dns_log_setcontext
argument_list|(
name|ns_g_lctx
argument_list|)
expr_stmt|;
name|cfg_log_init
argument_list|(
name|ns_g_lctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|safe
condition|)
name|result
operator|=
name|ns_log_setsafechannels
argument_list|(
name|lcfg
argument_list|)
expr_stmt|;
else|else
name|result
operator|=
name|ns_log_setdefaultchannels
argument_list|(
name|lcfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|ns_log_setdefaultcategory
argument_list|(
name|lcfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
name|isc_log_destroy
argument_list|(
operator|&
name|ns_g_lctx
argument_list|)
expr_stmt|;
name|isc_log_setcontext
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|dns_log_setcontext
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_log_setdefaultchannels
parameter_list|(
name|isc_logconfig_t
modifier|*
name|lcfg
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_logdestination_t
name|destination
decl_stmt|;
comment|/* 	 * By default, the logging library makes "default_debug" log to 	 * stderr.  In BIND, we want to override this and log to named.run 	 * instead, unless the -g option was given. 	 */
if|if
condition|(
operator|!
name|ns_g_logstderr
condition|)
block|{
name|destination
operator|.
name|file
operator|.
name|stream
operator|=
name|NULL
expr_stmt|;
name|destination
operator|.
name|file
operator|.
name|name
operator|=
literal|"named.run"
expr_stmt|;
name|destination
operator|.
name|file
operator|.
name|versions
operator|=
name|ISC_LOG_ROLLNEVER
expr_stmt|;
name|destination
operator|.
name|file
operator|.
name|maximum_size
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|isc_log_createchannel
argument_list|(
name|lcfg
argument_list|,
literal|"default_debug"
argument_list|,
name|ISC_LOG_TOFILE
argument_list|,
name|ISC_LOG_DYNAMIC
argument_list|,
operator|&
name|destination
argument_list|,
name|ISC_LOG_PRINTTIME
operator||
name|ISC_LOG_DEBUGONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
if|#
directive|if
name|ISC_FACILITY
operator|!=
name|LOG_DAEMON
name|destination
operator|.
name|facility
operator|=
name|ISC_FACILITY
expr_stmt|;
name|result
operator|=
name|isc_log_createchannel
argument_list|(
name|lcfg
argument_list|,
literal|"default_syslog"
argument_list|,
name|ISC_LOG_TOSYSLOG
argument_list|,
name|ISC_LOG_INFO
argument_list|,
operator|&
name|destination
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
endif|#
directive|endif
comment|/* 	 * Set the initial debug level. 	 */
name|isc_log_setdebuglevel
argument_list|(
name|ns_g_lctx
argument_list|,
name|ns_g_debuglevel
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|cleanup
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_log_setsafechannels
parameter_list|(
name|isc_logconfig_t
modifier|*
name|lcfg
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
if|#
directive|if
name|ISC_FACILITY
operator|!=
name|LOG_DAEMON
name|isc_logdestination_t
name|destination
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|ns_g_logstderr
condition|)
block|{
name|result
operator|=
name|isc_log_createchannel
argument_list|(
name|lcfg
argument_list|,
literal|"default_debug"
argument_list|,
name|ISC_LOG_TONULL
argument_list|,
name|ISC_LOG_DYNAMIC
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
comment|/* 		 * Setting the debug level to zero should get the output 		 * discarded a bit faster. 		 */
name|isc_log_setdebuglevel
argument_list|(
name|ns_g_lctx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isc_log_setdebuglevel
argument_list|(
name|ns_g_lctx
argument_list|,
name|ns_g_debuglevel
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|ISC_FACILITY
operator|!=
name|LOG_DAEMON
name|destination
operator|.
name|facility
operator|=
name|ISC_FACILITY
expr_stmt|;
name|result
operator|=
name|isc_log_createchannel
argument_list|(
name|lcfg
argument_list|,
literal|"default_syslog"
argument_list|,
name|ISC_LOG_TOSYSLOG
argument_list|,
name|ISC_LOG_INFO
argument_list|,
operator|&
name|destination
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
endif|#
directive|endif
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|cleanup
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_log_setdefaultcategory
parameter_list|(
name|isc_logconfig_t
modifier|*
name|lcfg
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
operator|!
name|ns_g_logstderr
condition|)
block|{
name|result
operator|=
name|isc_log_usechannel
argument_list|(
name|lcfg
argument_list|,
literal|"default_syslog"
argument_list|,
name|ISC_LOGCATEGORY_DEFAULT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
name|result
operator|=
name|isc_log_usechannel
argument_list|(
name|lcfg
argument_list|,
literal|"default_debug"
argument_list|,
name|ISC_LOGCATEGORY_DEFAULT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|cleanup
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_log_setunmatchedcategory
parameter_list|(
name|isc_logconfig_t
modifier|*
name|lcfg
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|isc_log_usechannel
argument_list|(
name|lcfg
argument_list|,
literal|"null"
argument_list|,
name|NS_LOGCATEGORY_UNMATCHED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ns_log_shutdown
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_log_destroy
argument_list|(
operator|&
name|ns_g_lctx
argument_list|)
expr_stmt|;
name|isc_log_setcontext
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|dns_log_setcontext
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


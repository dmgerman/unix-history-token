begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004, 2006  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 2001-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: config.c,v 1.11.2.4.8.32 2006/02/28 06:32:53 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_include
include|#
directive|include
file|<isc/log.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/region.h>
end_include

begin_include
include|#
directive|include
file|<isc/result.h>
end_include

begin_include
include|#
directive|include
file|<isc/sockaddr.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<isccfg/namedconf.h>
end_include

begin_include
include|#
directive|include
file|<dns/fixedname.h>
end_include

begin_include
include|#
directive|include
file|<dns/name.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataclass.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatatype.h>
end_include

begin_include
include|#
directive|include
file|<dns/tsig.h>
end_include

begin_include
include|#
directive|include
file|<dns/zone.h>
end_include

begin_include
include|#
directive|include
file|<named/config.h>
end_include

begin_include
include|#
directive|include
file|<named/globals.h>
end_include

begin_decl_stmt
specifier|static
name|char
name|defaultconf
index|[]
init|=
literal|"\ options {\n\ #	blackhole {none;};\n"
ifndef|#
directive|ifndef
name|WIN32
literal|"	coresize default;\n\ 	datasize default;\n\ 	files default;\n\ 	stacksize default;\n"
endif|#
directive|endif
literal|"	deallocate-on-exit true;\n\ #	directory<none>\n\ 	dump-file \"named_dump.db\";\n\ 	fake-iquery no;\n\ 	has-old-clients false;\n\ 	heartbeat-interval 60;\n\ 	host-statistics no;\n\ 	interface-interval 60;\n\ 	listen-on {any;};\n\ 	listen-on-v6 {none;};\n\ 	match-mapped-addresses no;\n\ 	memstatistics-file \"named.memstats\";\n\ 	multiple-cnames no;\n\ #	named-xfer<obsolete>;\n\ #	pid-file \""
name|NS_LOCALSTATEDIR
literal|"/named.pid\"; /* or /lwresd.pid */\n\ 	port 53;\n\ 	recursing-file \"named.recursing\";\n\ "
ifdef|#
directive|ifdef
name|PATH_RANDOMDEV
literal|"\ 	random-device \""
name|PATH_RANDOMDEV
literal|"\";\n\ "
endif|#
directive|endif
literal|"\ 	recursive-clients 1000;\n\ 	rrset-order {order cyclic;};\n\ 	serial-queries 20;\n\ 	serial-query-rate 20;\n\ 	server-id none;\n\ 	statistics-file \"named.stats\";\n\ 	statistics-interval 60;\n\ 	tcp-clients 100;\n\ 	tcp-listen-queue 3;\n\ #	tkey-dhkey<none>\n\ #	tkey-gssapi-credential<none>\n\ #	tkey-domain<none>\n\ 	transfers-per-ns 2;\n\ 	transfers-in 10;\n\ 	transfers-out 10;\n\ 	treat-cr-as-space true;\n\ 	use-id-pool true;\n\ 	use-ixfr true;\n\ 	edns-udp-size 4096;\n\ \n\ 	/* view */\n\ 	allow-notify {none;};\n\ 	allow-update-forwarding {none;};\n\ 	allow-recursion {any;};\n\ #	allow-v6-synthesis<obsolete>;\n\ #	sortlist<none>\n\ #	topology<none>\n\ 	auth-nxdomain false;\n\ 	minimal-responses false;\n\ 	recursion true;\n\ 	provide-ixfr true;\n\ 	request-ixfr true;\n\ 	fetch-glue no;\n\ 	rfc2308-type1 no;\n\ 	additional-from-auth true;\n\ 	additional-from-cache true;\n\ 	query-source address *;\n\ 	query-source-v6 address *;\n\ 	notify-source *;\n\ 	notify-source-v6 *;\n\ 	cleaning-interval 60;\n\ 	min-roots 2;\n\ 	lame-ttl 600;\n\ 	max-ncache-ttl 10800; /* 3 hours */\n\ 	max-cache-ttl 604800; /* 1 week */\n\ 	transfer-format many-answers;\n\ 	max-cache-size 0;\n\ 	check-names master fail;\n\ 	check-names slave warn;\n\ 	check-names response ignore;\n\ 	dnssec-enable no; /* Make yes for 9.4. */ \n\ "
literal|"	/* zone */\n\ 	allow-query {any;};\n\ 	allow-transfer {any;};\n\ 	notify yes;\n\ #	also-notify<none>\n\ 	dialup no;\n\ #	forward<none>\n\ #	forwarders<none>\n\ 	maintain-ixfr-base no;\n\ #	max-ixfr-log-size<obsolete>\n\ 	transfer-source *;\n\ 	transfer-source-v6 *;\n\ 	alt-transfer-source *;\n\ 	alt-transfer-source-v6 *;\n\ 	max-transfer-time-in 120;\n\ 	max-transfer-time-out 120;\n\ 	max-transfer-idle-in 60;\n\ 	max-transfer-idle-out 60;\n\ 	max-retry-time 1209600; /* 2 weeks */\n\ 	min-retry-time 500;\n\ 	max-refresh-time 2419200; /* 4 weeks */\n\ 	min-refresh-time 300;\n\ 	multi-master no;\n\ 	sig-validity-interval 30; /* days */\n\ 	zone-statistics false;\n\ 	max-journal-size unlimited;\n\ 	ixfr-from-differences false;\n\ };\n\ "
literal|"#\n\ #  Zones in the \"_bind\" view are NOT counted is the count of zones.\n\ #\n\ view \"_bind\" chaos {\n\ 	recursion no;\n\ 	notify no;\n\ \n\ 	zone \"version.bind\" chaos {\n\ 		type master;\n\ 		database \"_builtin version\";\n\ 	};\n\ \n\ 	zone \"hostname.bind\" chaos {\n\ 		type master;\n\ 		database \"_builtin hostname\";\n\ 	};\n\ \n\ 	zone \"authors.bind\" chaos {\n\ 		type master;\n\ 		database \"_builtin authors\";\n\ 	};\n\ 	zone \"id.server\" chaos {\n\ 		type master;\n\ 		database \"_builtin id\";\n\ 	};\n\ };\n\ "
decl_stmt|;
end_decl_stmt

begin_function
name|isc_result_t
name|ns_config_parsedefaults
parameter_list|(
name|cfg_parser_t
modifier|*
name|parser
parameter_list|,
name|cfg_obj_t
modifier|*
modifier|*
name|conf
parameter_list|)
block|{
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|defaultconf
argument_list|,
sizeof|sizeof
argument_list|(
name|defaultconf
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
sizeof|sizeof
argument_list|(
name|defaultconf
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|cfg_parse_buffer
argument_list|(
name|parser
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|cfg_type_namedconf
argument_list|,
name|conf
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_config_get
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|maps
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|obj
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|maps
index|[
name|i
index|]
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
if|if
condition|(
name|cfg_map_get
argument_list|(
name|maps
index|[
name|i
index|]
argument_list|,
name|name
argument_list|,
name|obj
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
block|}
end_function

begin_function
name|isc_result_t
name|ns_checknames_get
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|maps
parameter_list|,
specifier|const
name|char
modifier|*
name|which
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|obj
parameter_list|)
block|{
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|checknames
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|type
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|value
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|maps
index|[
name|i
index|]
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
name|checknames
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|cfg_map_get
argument_list|(
name|maps
index|[
name|i
index|]
argument_list|,
literal|"check-names"
argument_list|,
operator|&
name|checknames
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* 			 * Zone map entry is not a list. 			 */
if|if
condition|(
name|checknames
operator|!=
name|NULL
operator|&&
operator|!
name|cfg_obj_islist
argument_list|(
name|checknames
argument_list|)
condition|)
block|{
operator|*
name|obj
operator|=
name|checknames
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|checknames
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
name|value
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
name|type
operator|=
name|cfg_tuple_get
argument_list|(
name|value
argument_list|,
literal|"type"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|type
argument_list|)
argument_list|,
name|which
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|obj
operator|=
name|cfg_tuple_get
argument_list|(
name|value
argument_list|,
literal|"mode"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
block|}
block|}
block|}
block|}
end_function

begin_function
name|int
name|ns_config_listcount
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|list
parameter_list|)
block|{
specifier|const
name|cfg_listelt_t
modifier|*
name|e
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
for|for
control|(
name|e
operator|=
name|cfg_list_first
argument_list|(
name|list
argument_list|)
init|;
name|e
operator|!=
name|NULL
condition|;
name|e
operator|=
name|cfg_list_next
argument_list|(
name|e
argument_list|)
control|)
name|i
operator|++
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_config_getclass
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|classobj
parameter_list|,
name|dns_rdataclass_t
name|defclass
parameter_list|,
name|dns_rdataclass_t
modifier|*
name|classp
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|isc_textregion_t
name|r
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
operator|!
name|cfg_obj_isstring
argument_list|(
name|classobj
argument_list|)
condition|)
block|{
operator|*
name|classp
operator|=
name|defclass
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|classobj
argument_list|)
expr_stmt|;
name|DE_CONST
argument_list|(
name|str
argument_list|,
name|r
operator|.
name|base
argument_list|)
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataclass_fromtext
argument_list|(
name|classp
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|cfg_obj_log
argument_list|(
name|classobj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"unknown class '%s'"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_config_gettype
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|typeobj
parameter_list|,
name|dns_rdatatype_t
name|deftype
parameter_list|,
name|dns_rdatatype_t
modifier|*
name|typep
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|isc_textregion_t
name|r
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
operator|!
name|cfg_obj_isstring
argument_list|(
name|typeobj
argument_list|)
condition|)
block|{
operator|*
name|typep
operator|=
name|deftype
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|typeobj
argument_list|)
expr_stmt|;
name|DE_CONST
argument_list|(
name|str
argument_list|,
name|r
operator|.
name|base
argument_list|)
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatatype_fromtext
argument_list|(
name|typep
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|cfg_obj_log
argument_list|(
name|typeobj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"unknown type '%s'"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|dns_zonetype_t
name|ns_config_getzonetype
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|zonetypeobj
parameter_list|)
block|{
name|dns_zonetype_t
name|ztype
init|=
name|dns_zone_none
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|zonetypeobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"master"
argument_list|)
operator|==
literal|0
condition|)
name|ztype
operator|=
name|dns_zone_master
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"slave"
argument_list|)
operator|==
literal|0
condition|)
name|ztype
operator|=
name|dns_zone_slave
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"stub"
argument_list|)
operator|==
literal|0
condition|)
name|ztype
operator|=
name|dns_zone_stub
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|ztype
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_config_getiplist
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|list
parameter_list|,
name|in_port_t
name|defport
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_sockaddr_t
modifier|*
modifier|*
name|addrsp
parameter_list|,
name|isc_uint32_t
modifier|*
name|countp
parameter_list|)
block|{
name|int
name|count
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|addrlist
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|portobj
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|addrs
decl_stmt|;
name|in_port_t
name|port
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|INSIST
argument_list|(
name|addrsp
operator|!=
name|NULL
operator|&&
operator|*
name|addrsp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|countp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|addrlist
operator|=
name|cfg_tuple_get
argument_list|(
name|list
argument_list|,
literal|"addresses"
argument_list|)
expr_stmt|;
name|count
operator|=
name|ns_config_listcount
argument_list|(
name|addrlist
argument_list|)
expr_stmt|;
name|portobj
operator|=
name|cfg_tuple_get
argument_list|(
name|list
argument_list|,
literal|"port"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isuint32
argument_list|(
name|portobj
argument_list|)
condition|)
block|{
name|isc_uint32_t
name|val
init|=
name|cfg_obj_asuint32
argument_list|(
name|portobj
argument_list|)
decl_stmt|;
if|if
condition|(
name|val
operator|>
name|ISC_UINT16_MAX
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|portobj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"port '%u' out of range"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_RANGE
operator|)
return|;
block|}
name|port
operator|=
operator|(
name|in_port_t
operator|)
name|val
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|defport
operator|!=
literal|0
condition|)
name|port
operator|=
name|defport
expr_stmt|;
else|else
block|{
name|result
operator|=
name|ns_config_getport
argument_list|(
name|config
argument_list|,
operator|&
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
name|addrs
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|addrs
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|addrlist
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
operator|,
name|i
operator|++
control|)
block|{
name|INSIST
argument_list|(
name|i
operator|<
name|count
argument_list|)
expr_stmt|;
name|addrs
index|[
name|i
index|]
operator|=
operator|*
name|cfg_obj_assockaddr
argument_list|(
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_sockaddr_getport
argument_list|(
operator|&
name|addrs
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
name|isc_sockaddr_setport
argument_list|(
operator|&
name|addrs
index|[
name|i
index|]
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
name|INSIST
argument_list|(
name|i
operator|==
name|count
argument_list|)
expr_stmt|;
operator|*
name|addrsp
operator|=
name|addrs
expr_stmt|;
operator|*
name|countp
operator|=
name|count
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ns_config_putiplist
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_sockaddr_t
modifier|*
modifier|*
name|addrsp
parameter_list|,
name|isc_uint32_t
name|count
parameter_list|)
block|{
name|INSIST
argument_list|(
name|addrsp
operator|!=
name|NULL
operator|&&
operator|*
name|addrsp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
operator|*
name|addrsp
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|addrsp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|get_masters_def
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|ret
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|masters
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|elt
decl_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|cctx
argument_list|,
literal|"masters"
argument_list|,
operator|&
name|masters
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
for|for
control|(
name|elt
operator|=
name|cfg_list_first
argument_list|(
name|masters
argument_list|)
init|;
name|elt
operator|!=
name|NULL
condition|;
name|elt
operator|=
name|cfg_list_next
argument_list|(
name|elt
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|list
decl_stmt|;
specifier|const
name|char
modifier|*
name|listname
decl_stmt|;
name|list
operator|=
name|cfg_listelt_value
argument_list|(
name|elt
argument_list|)
expr_stmt|;
name|listname
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|list
argument_list|,
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|listname
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|ret
operator|=
name|list
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_config_getipandkeylist
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|list
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_sockaddr_t
modifier|*
modifier|*
name|addrsp
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
modifier|*
name|keysp
parameter_list|,
name|isc_uint32_t
modifier|*
name|countp
parameter_list|)
block|{
name|isc_uint32_t
name|addrcount
init|=
literal|0
decl_stmt|,
name|keycount
init|=
literal|0
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|;
name|isc_uint32_t
name|listcount
init|=
literal|0
decl_stmt|,
name|l
init|=
literal|0
decl_stmt|,
name|j
decl_stmt|;
name|isc_uint32_t
name|stackcount
init|=
literal|0
decl_stmt|,
name|pushed
init|=
literal|0
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|addrlist
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|portobj
decl_stmt|;
name|in_port_t
name|port
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|addrs
init|=
name|NULL
decl_stmt|;
name|dns_name_t
modifier|*
modifier|*
name|keys
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|lists
init|=
name|NULL
decl_stmt|;
struct|struct
block|{
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
name|in_port_t
name|port
decl_stmt|;
block|}
modifier|*
name|stack
init|=
name|NULL
struct|;
name|REQUIRE
argument_list|(
name|addrsp
operator|!=
name|NULL
operator|&&
operator|*
name|addrsp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|keysp
operator|!=
name|NULL
operator|&&
operator|*
name|keysp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|countp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|newlist
label|:
name|addrlist
operator|=
name|cfg_tuple_get
argument_list|(
name|list
argument_list|,
literal|"addresses"
argument_list|)
expr_stmt|;
name|portobj
operator|=
name|cfg_tuple_get
argument_list|(
name|list
argument_list|,
literal|"port"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isuint32
argument_list|(
name|portobj
argument_list|)
condition|)
block|{
name|isc_uint32_t
name|val
init|=
name|cfg_obj_asuint32
argument_list|(
name|portobj
argument_list|)
decl_stmt|;
if|if
condition|(
name|val
operator|>
name|ISC_UINT16_MAX
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|portobj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"port '%u' out of range"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_RANGE
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|port
operator|=
operator|(
name|in_port_t
operator|)
name|val
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|ns_config_getport
argument_list|(
name|config
argument_list|,
operator|&
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
name|element
operator|=
name|cfg_list_first
argument_list|(
name|addrlist
argument_list|)
expr_stmt|;
name|resume
label|:
for|for
control|(
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|addr
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|key
decl_stmt|;
specifier|const
name|char
modifier|*
name|keystr
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|addr
operator|=
name|cfg_tuple_get
argument_list|(
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
argument_list|,
literal|"masterselement"
argument_list|)
expr_stmt|;
name|key
operator|=
name|cfg_tuple_get
argument_list|(
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
argument_list|,
literal|"key"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cfg_obj_issockaddr
argument_list|(
name|addr
argument_list|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|listname
init|=
name|cfg_obj_asstring
argument_list|(
name|addr
argument_list|)
decl_stmt|;
name|isc_result_t
name|tresult
decl_stmt|;
comment|/* Grow lists? */
if|if
condition|(
name|listcount
operator|==
name|l
condition|)
block|{
name|void
modifier|*
name|new
decl_stmt|;
name|isc_uint32_t
name|newlen
init|=
name|listcount
operator|+
literal|16
decl_stmt|;
name|size_t
name|newsize
decl_stmt|,
name|oldsize
decl_stmt|;
name|newsize
operator|=
name|newlen
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|lists
argument_list|)
expr_stmt|;
name|oldsize
operator|=
name|listcount
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|lists
argument_list|)
expr_stmt|;
name|new
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|newsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|listcount
operator|!=
literal|0
condition|)
block|{
name|memcpy
argument_list|(
name|new
argument_list|,
name|lists
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|lists
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
block|}
name|lists
operator|=
name|new
expr_stmt|;
name|listcount
operator|=
name|newlen
expr_stmt|;
block|}
comment|/* Seen? */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|l
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|strcasecmp
argument_list|(
name|lists
index|[
name|j
index|]
argument_list|,
name|listname
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|j
operator|<
name|l
condition|)
continue|continue;
name|tresult
operator|=
name|get_masters_def
argument_list|(
name|config
argument_list|,
name|listname
argument_list|,
operator|&
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|addr
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"masters \"%s\" not found"
argument_list|,
name|listname
argument_list|)
expr_stmt|;
name|result
operator|=
name|tresult
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|tresult
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|lists
index|[
name|l
operator|++
index|]
operator|=
name|listname
expr_stmt|;
comment|/* Grow stack? */
if|if
condition|(
name|stackcount
operator|==
name|pushed
condition|)
block|{
name|void
modifier|*
name|new
decl_stmt|;
name|isc_uint32_t
name|newlen
init|=
name|stackcount
operator|+
literal|16
decl_stmt|;
name|size_t
name|newsize
decl_stmt|,
name|oldsize
decl_stmt|;
name|newsize
operator|=
name|newlen
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|stack
argument_list|)
expr_stmt|;
name|oldsize
operator|=
name|stackcount
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|stack
argument_list|)
expr_stmt|;
name|new
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|newsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|stackcount
operator|!=
literal|0
condition|)
block|{
name|memcpy
argument_list|(
name|new
argument_list|,
name|stack
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|stack
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
block|}
name|stack
operator|=
name|new
expr_stmt|;
name|stackcount
operator|=
name|newlen
expr_stmt|;
block|}
comment|/* 			 * We want to resume processing this list on the 			 * next element. 			 */
name|stack
index|[
name|pushed
index|]
operator|.
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
expr_stmt|;
name|stack
index|[
name|pushed
index|]
operator|.
name|port
operator|=
name|port
expr_stmt|;
name|pushed
operator|++
expr_stmt|;
goto|goto
name|newlist
goto|;
block|}
if|if
condition|(
name|i
operator|==
name|addrcount
condition|)
block|{
name|void
modifier|*
name|new
decl_stmt|;
name|isc_uint32_t
name|newlen
init|=
name|addrcount
operator|+
literal|16
decl_stmt|;
name|size_t
name|newsize
decl_stmt|,
name|oldsize
decl_stmt|;
name|newsize
operator|=
name|newlen
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
expr_stmt|;
name|oldsize
operator|=
name|addrcount
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
expr_stmt|;
name|new
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|newsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|addrcount
operator|!=
literal|0
condition|)
block|{
name|memcpy
argument_list|(
name|new
argument_list|,
name|addrs
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|addrs
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
block|}
name|addrs
operator|=
name|new
expr_stmt|;
name|addrcount
operator|=
name|newlen
expr_stmt|;
name|newsize
operator|=
name|newlen
operator|*
sizeof|sizeof
argument_list|(
name|dns_name_t
operator|*
argument_list|)
expr_stmt|;
name|oldsize
operator|=
name|keycount
operator|*
sizeof|sizeof
argument_list|(
name|dns_name_t
operator|*
argument_list|)
expr_stmt|;
name|new
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|newsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|keycount
operator|!=
literal|0
condition|)
block|{
name|memcpy
argument_list|(
name|new
argument_list|,
name|keys
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|keys
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
block|}
name|keys
operator|=
name|new
expr_stmt|;
name|keycount
operator|=
name|newlen
expr_stmt|;
block|}
name|addrs
index|[
name|i
index|]
operator|=
operator|*
name|cfg_obj_assockaddr
argument_list|(
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_sockaddr_getport
argument_list|(
operator|&
name|addrs
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
name|isc_sockaddr_setport
argument_list|(
operator|&
name|addrs
index|[
name|i
index|]
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|keys
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|cfg_obj_isstring
argument_list|(
name|key
argument_list|)
condition|)
block|{
name|i
operator|++
expr_stmt|;
continue|continue;
block|}
name|keys
index|[
name|i
index|]
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
index|[
name|i
index|]
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
name|dns_name_init
argument_list|(
name|keys
index|[
name|i
index|]
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|keystr
operator|=
name|cfg_obj_asstring
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|keystr
argument_list|,
name|strlen
argument_list|(
name|keystr
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|keystr
argument_list|)
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_name_dup
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
argument_list|,
name|mctx
argument_list|,
name|keys
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pushed
operator|!=
literal|0
condition|)
block|{
name|pushed
operator|--
expr_stmt|;
name|element
operator|=
name|stack
index|[
name|pushed
index|]
operator|.
name|element
expr_stmt|;
name|port
operator|=
name|stack
index|[
name|pushed
index|]
operator|.
name|port
expr_stmt|;
goto|goto
name|resume
goto|;
block|}
if|if
condition|(
name|i
operator|<
name|addrcount
condition|)
block|{
name|void
modifier|*
name|new
decl_stmt|;
name|size_t
name|newsize
decl_stmt|,
name|oldsize
decl_stmt|;
name|newsize
operator|=
name|i
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
expr_stmt|;
name|oldsize
operator|=
name|addrcount
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
block|{
name|new
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|newsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
name|memcpy
argument_list|(
name|new
argument_list|,
name|addrs
argument_list|,
name|newsize
argument_list|)
expr_stmt|;
block|}
else|else
name|new
operator|=
name|NULL
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|addrs
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
name|addrs
operator|=
name|new
expr_stmt|;
name|addrcount
operator|=
name|i
expr_stmt|;
name|newsize
operator|=
name|i
operator|*
sizeof|sizeof
argument_list|(
name|dns_name_t
operator|*
argument_list|)
expr_stmt|;
name|oldsize
operator|=
name|keycount
operator|*
sizeof|sizeof
argument_list|(
name|dns_name_t
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
block|{
name|new
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|newsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
name|memcpy
argument_list|(
name|new
argument_list|,
name|keys
argument_list|,
name|newsize
argument_list|)
expr_stmt|;
block|}
else|else
name|new
operator|=
name|NULL
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|keys
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
name|keys
operator|=
name|new
expr_stmt|;
name|keycount
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|lists
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|lists
argument_list|,
name|listcount
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|lists
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|stack
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|stack
argument_list|,
name|stackcount
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|stack
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|keycount
operator|==
name|addrcount
argument_list|)
expr_stmt|;
operator|*
name|addrsp
operator|=
name|addrs
expr_stmt|;
operator|*
name|keysp
operator|=
name|keys
expr_stmt|;
operator|*
name|countp
operator|=
name|addrcount
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|addrs
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|addrs
argument_list|,
name|addrcount
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<=
name|i
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|keys
index|[
name|j
index|]
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|dns_name_dynamic
argument_list|(
name|keys
index|[
name|j
index|]
argument_list|)
condition|)
name|dns_name_free
argument_list|(
name|keys
index|[
name|j
index|]
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|keys
index|[
name|j
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|keys
argument_list|,
name|keycount
operator|*
sizeof|sizeof
argument_list|(
name|dns_name_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lists
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|lists
argument_list|,
name|listcount
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|lists
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|stack
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|stack
argument_list|,
name|stackcount
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|stack
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ns_config_putipandkeylist
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_sockaddr_t
modifier|*
modifier|*
name|addrsp
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
modifier|*
name|keysp
parameter_list|,
name|isc_uint32_t
name|count
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|dns_name_t
modifier|*
modifier|*
name|keys
init|=
operator|*
name|keysp
decl_stmt|;
name|INSIST
argument_list|(
name|addrsp
operator|!=
name|NULL
operator|&&
operator|*
name|addrsp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
operator|*
name|addrsp
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|keys
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|dns_name_dynamic
argument_list|(
name|keys
index|[
name|i
index|]
argument_list|)
condition|)
name|dns_name_free
argument_list|(
name|keys
index|[
name|i
index|]
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|keys
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
operator|*
name|keysp
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
name|dns_name_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|addrsp
operator|=
name|NULL
expr_stmt|;
operator|*
name|keysp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_config_getport
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|in_port_t
modifier|*
name|portp
parameter_list|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|maps
index|[
literal|3
index|]
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|options
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|portobj
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"options"
argument_list|,
operator|&
name|options
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|!=
name|NULL
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|options
expr_stmt|;
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|ns_g_defaults
expr_stmt|;
name|maps
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"port"
argument_list|,
operator|&
name|portobj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_asuint32
argument_list|(
name|portobj
argument_list|)
operator|>=
name|ISC_UINT16_MAX
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|portobj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"port '%u' out of range"
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|portobj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_RANGE
operator|)
return|;
block|}
operator|*
name|portp
operator|=
operator|(
name|in_port_t
operator|)
name|cfg_obj_asuint32
argument_list|(
name|portobj
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_config_getkeyalgorithm
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|name
parameter_list|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"hmac-md5"
argument_list|)
operator|==
literal|0
operator|||
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"hmac-md5.sig-alg.reg.int"
argument_list|)
operator|==
literal|0
operator|||
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"hmac-md5.sig-alg.reg.int."
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|name
operator|!=
name|NULL
condition|)
operator|*
name|name
operator|=
name|dns_tsig_hmacmd5_name
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 2000, 2001  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: lwdclient.c,v 1.13.12.5 2004/03/08 09:04:15 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/socket.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/adb.h>
end_include

begin_include
include|#
directive|include
file|<dns/view.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<named/types.h>
end_include

begin_include
include|#
directive|include
file|<named/log.h>
end_include

begin_include
include|#
directive|include
file|<named/lwresd.h>
end_include

begin_include
include|#
directive|include
file|<named/lwdclient.h>
end_include

begin_define
define|#
directive|define
name|SHUTTINGDOWN
parameter_list|(
name|cm
parameter_list|)
value|((cm->flags& NS_LWDCLIENTMGR_FLAGSHUTTINGDOWN) != 0)
end_define

begin_function_decl
specifier|static
name|void
name|lwdclientmgr_shutdown_callback
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|ns_lwdclient_log
parameter_list|(
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|isc_log_vwrite
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_DATABASE
argument_list|,
name|DNS_LOGMODULE_ADB
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
name|level
argument_list|)
argument_list|,
name|format
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_lwdclientmgr_create
parameter_list|(
name|ns_lwreslistener_t
modifier|*
name|listener
parameter_list|,
name|unsigned
name|int
name|nclients
parameter_list|,
name|isc_taskmgr_t
modifier|*
name|taskmgr
parameter_list|)
block|{
name|ns_lwresd_t
modifier|*
name|lwresd
init|=
name|listener
operator|->
name|manager
decl_stmt|;
name|ns_lwdclientmgr_t
modifier|*
name|cm
decl_stmt|;
name|ns_lwdclient_t
modifier|*
name|client
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_FAILURE
decl_stmt|;
name|cm
operator|=
name|isc_mem_get
argument_list|(
name|lwresd
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|ns_lwdclientmgr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|cm
operator|->
name|listener
operator|=
name|NULL
expr_stmt|;
name|ns_lwreslistener_attach
argument_list|(
name|listener
argument_list|,
operator|&
name|cm
operator|->
name|listener
argument_list|)
expr_stmt|;
name|cm
operator|->
name|mctx
operator|=
name|lwresd
operator|->
name|mctx
expr_stmt|;
name|cm
operator|->
name|sock
operator|=
name|NULL
expr_stmt|;
name|isc_socket_attach
argument_list|(
name|listener
operator|->
name|sock
argument_list|,
operator|&
name|cm
operator|->
name|sock
argument_list|)
expr_stmt|;
name|cm
operator|->
name|view
operator|=
name|lwresd
operator|->
name|view
expr_stmt|;
name|cm
operator|->
name|lwctx
operator|=
name|NULL
expr_stmt|;
name|cm
operator|->
name|task
operator|=
name|NULL
expr_stmt|;
name|cm
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|cm
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|cm
operator|->
name|idle
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|cm
operator|->
name|running
argument_list|)
expr_stmt|;
if|if
condition|(
name|lwres_context_create
argument_list|(
operator|&
name|cm
operator|->
name|lwctx
argument_list|,
name|cm
operator|->
name|mctx
argument_list|,
name|ns__lwresd_memalloc
argument_list|,
name|ns__lwresd_memfree
argument_list|,
name|LWRES_CONTEXT_SERVERMODE
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|errout
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nclients
condition|;
name|i
operator|++
control|)
block|{
name|client
operator|=
name|isc_mem_get
argument_list|(
name|lwresd
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|ns_lwdclient_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|!=
name|NULL
condition|)
block|{
name|ns_lwdclient_log
argument_list|(
literal|50
argument_list|,
literal|"created client %p, manager %p"
argument_list|,
name|client
argument_list|,
name|cm
argument_list|)
expr_stmt|;
name|ns_lwdclient_initialize
argument_list|(
name|client
argument_list|,
name|cm
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * If we could create no clients, clean up and return. 	 */
if|if
condition|(
name|ISC_LIST_EMPTY
argument_list|(
name|cm
operator|->
name|idle
argument_list|)
condition|)
goto|goto
name|errout
goto|;
name|result
operator|=
name|isc_task_create
argument_list|(
name|taskmgr
argument_list|,
literal|0
argument_list|,
operator|&
name|cm
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|errout
goto|;
comment|/* 	 * This MUST be last, since there is no way to cancel an onshutdown... 	 */
name|result
operator|=
name|isc_task_onshutdown
argument_list|(
name|cm
operator|->
name|task
argument_list|,
name|lwdclientmgr_shutdown_callback
argument_list|,
name|cm
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|errout
goto|;
name|ns_lwreslistener_linkcm
argument_list|(
name|listener
argument_list|,
name|cm
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|errout
label|:
name|client
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|cm
operator|->
name|idle
argument_list|)
expr_stmt|;
while|while
condition|(
name|client
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|cm
operator|->
name|idle
argument_list|,
name|client
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|lwresd
operator|->
name|mctx
argument_list|,
name|client
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|client
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|cm
operator|->
name|idle
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cm
operator|->
name|task
operator|!=
name|NULL
condition|)
name|isc_task_detach
argument_list|(
operator|&
name|cm
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm
operator|->
name|lwctx
operator|!=
name|NULL
condition|)
name|lwres_context_destroy
argument_list|(
operator|&
name|cm
operator|->
name|lwctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|lwresd
operator|->
name|mctx
argument_list|,
name|cm
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cm
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lwdclientmgr_destroy
parameter_list|(
name|ns_lwdclientmgr_t
modifier|*
name|cm
parameter_list|)
block|{
name|ns_lwdclient_t
modifier|*
name|client
decl_stmt|;
name|ns_lwreslistener_t
modifier|*
name|listener
decl_stmt|;
if|if
condition|(
operator|!
name|SHUTTINGDOWN
argument_list|(
name|cm
argument_list|)
condition|)
return|return;
comment|/* 	 * run through the idle list and free the clients there.  Idle 	 * clients do not have a recv running nor do they have any finds 	 * or similar running. 	 */
name|client
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|cm
operator|->
name|idle
argument_list|)
expr_stmt|;
while|while
condition|(
name|client
operator|!=
name|NULL
condition|)
block|{
name|ns_lwdclient_log
argument_list|(
literal|50
argument_list|,
literal|"destroying client %p, manager %p"
argument_list|,
name|client
argument_list|,
name|cm
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|cm
operator|->
name|idle
argument_list|,
name|client
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|cm
operator|->
name|mctx
argument_list|,
name|client
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|client
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|cm
operator|->
name|idle
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|cm
operator|->
name|running
argument_list|)
condition|)
return|return;
name|lwres_context_destroy
argument_list|(
operator|&
name|cm
operator|->
name|lwctx
argument_list|)
expr_stmt|;
name|cm
operator|->
name|view
operator|=
name|NULL
expr_stmt|;
name|isc_socket_detach
argument_list|(
operator|&
name|cm
operator|->
name|sock
argument_list|)
expr_stmt|;
name|isc_task_detach
argument_list|(
operator|&
name|cm
operator|->
name|task
argument_list|)
expr_stmt|;
name|listener
operator|=
name|cm
operator|->
name|listener
expr_stmt|;
name|ns_lwreslistener_unlinkcm
argument_list|(
name|listener
argument_list|,
name|cm
argument_list|)
expr_stmt|;
name|ns_lwdclient_log
argument_list|(
literal|50
argument_list|,
literal|"destroying manager %p"
argument_list|,
name|cm
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|cm
operator|->
name|mctx
argument_list|,
name|cm
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cm
argument_list|)
argument_list|)
expr_stmt|;
name|ns_lwreslistener_detach
argument_list|(
operator|&
name|listener
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|process_request
parameter_list|(
name|ns_lwdclient_t
modifier|*
name|client
parameter_list|)
block|{
name|lwres_buffer_t
name|b
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|lwres_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|client
operator|->
name|buffer
argument_list|,
name|client
operator|->
name|recvlength
argument_list|)
expr_stmt|;
name|lwres_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|client
operator|->
name|recvlength
argument_list|)
expr_stmt|;
name|result
operator|=
name|lwres_lwpacket_parseheader
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|client
operator|->
name|pkt
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|ns_lwdclient_log
argument_list|(
literal|50
argument_list|,
literal|"invalid packet header received"
argument_list|)
expr_stmt|;
goto|goto
name|restart
goto|;
block|}
name|ns_lwdclient_log
argument_list|(
literal|50
argument_list|,
literal|"opcode %08x"
argument_list|,
name|client
operator|->
name|pkt
operator|.
name|opcode
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|client
operator|->
name|pkt
operator|.
name|opcode
condition|)
block|{
case|case
name|LWRES_OPCODE_GETADDRSBYNAME
case|:
name|ns_lwdclient_processgabn
argument_list|(
name|client
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
return|return;
case|case
name|LWRES_OPCODE_GETNAMEBYADDR
case|:
name|ns_lwdclient_processgnba
argument_list|(
name|client
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
return|return;
case|case
name|LWRES_OPCODE_GETRDATABYNAME
case|:
name|ns_lwdclient_processgrbn
argument_list|(
name|client
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
return|return;
case|case
name|LWRES_OPCODE_NOOP
case|:
name|ns_lwdclient_processnoop
argument_list|(
name|client
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
return|return;
default|default:
name|ns_lwdclient_log
argument_list|(
literal|50
argument_list|,
literal|"unknown opcode %08x"
argument_list|,
name|client
operator|->
name|pkt
operator|.
name|opcode
argument_list|)
expr_stmt|;
goto|goto
name|restart
goto|;
block|}
comment|/* 	 * Drop the packet. 	 */
name|restart
label|:
name|ns_lwdclient_log
argument_list|(
literal|50
argument_list|,
literal|"restarting client %p..."
argument_list|,
name|client
argument_list|)
expr_stmt|;
name|ns_lwdclient_stateidle
argument_list|(
name|client
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_lwdclient_recv
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|ns_lwdclient_t
modifier|*
name|client
init|=
name|ev
operator|->
name|ev_arg
decl_stmt|;
name|ns_lwdclientmgr_t
modifier|*
name|cm
init|=
name|client
operator|->
name|clientmgr
decl_stmt|;
name|isc_socketevent_t
modifier|*
name|dev
init|=
operator|(
name|isc_socketevent_t
operator|*
operator|)
name|ev
decl_stmt|;
name|INSIST
argument_list|(
name|dev
operator|->
name|region
operator|.
name|base
operator|==
name|client
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|NS_LWDCLIENT_ISRECV
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|NS_LWDCLIENT_SETRECVDONE
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|(
name|cm
operator|->
name|flags
operator|&
name|NS_LWDCLIENTMGR_FLAGRECVPENDING
operator|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|cm
operator|->
name|flags
operator|&=
operator|~
name|NS_LWDCLIENTMGR_FLAGRECVPENDING
expr_stmt|;
name|ns_lwdclient_log
argument_list|(
literal|50
argument_list|,
literal|"event received: task %p, length %u, result %u (%s)"
argument_list|,
name|task
argument_list|,
name|dev
operator|->
name|n
argument_list|,
name|dev
operator|->
name|result
argument_list|,
name|isc_result_totext
argument_list|(
name|dev
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_event_free
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
name|dev
operator|=
name|NULL
expr_stmt|;
comment|/* 		 * Go idle. 		 */
name|ns_lwdclient_stateidle
argument_list|(
name|client
argument_list|)
expr_stmt|;
return|return;
block|}
name|client
operator|->
name|recvlength
operator|=
name|dev
operator|->
name|n
expr_stmt|;
name|client
operator|->
name|address
operator|=
name|dev
operator|->
name|address
expr_stmt|;
if|if
condition|(
operator|(
name|dev
operator|->
name|attributes
operator|&
name|ISC_SOCKEVENTATTR_PKTINFO
operator|)
operator|!=
literal|0
condition|)
block|{
name|client
operator|->
name|pktinfo
operator|=
name|dev
operator|->
name|pktinfo
expr_stmt|;
name|client
operator|->
name|pktinfo_valid
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
name|client
operator|->
name|pktinfo_valid
operator|=
name|ISC_FALSE
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
name|dev
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_lwdclient_startrecv
argument_list|(
name|cm
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"could not start lwres "
literal|"client handler: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|process_request
argument_list|(
name|client
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This function will start a new recv() on a socket for this client manager.  */
end_comment

begin_function
name|isc_result_t
name|ns_lwdclient_startrecv
parameter_list|(
name|ns_lwdclientmgr_t
modifier|*
name|cm
parameter_list|)
block|{
name|ns_lwdclient_t
modifier|*
name|client
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
if|if
condition|(
name|SHUTTINGDOWN
argument_list|(
name|cm
argument_list|)
condition|)
block|{
name|lwdclientmgr_destroy
argument_list|(
name|cm
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
comment|/* 	 * If a recv is already running, don't bother. 	 */
if|if
condition|(
operator|(
name|cm
operator|->
name|flags
operator|&
name|NS_LWDCLIENTMGR_FLAGRECVPENDING
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
comment|/* 	 * If we have no idle slots, just return success. 	 */
name|client
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|cm
operator|->
name|idle
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|INSIST
argument_list|(
name|NS_LWDCLIENT_ISIDLE
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Issue the recv.  If it fails, return that it did. 	 */
name|r
operator|.
name|base
operator|=
name|client
operator|->
name|buffer
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|LWRES_RECVLENGTH
expr_stmt|;
name|result
operator|=
name|isc_socket_recv
argument_list|(
name|cm
operator|->
name|sock
argument_list|,
operator|&
name|r
argument_list|,
literal|0
argument_list|,
name|cm
operator|->
name|task
argument_list|,
name|ns_lwdclient_recv
argument_list|,
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* 	 * Set the flag to say we've issued a recv() call. 	 */
name|cm
operator|->
name|flags
operator||=
name|NS_LWDCLIENTMGR_FLAGRECVPENDING
expr_stmt|;
comment|/* 	 * Remove the client from the idle list, and put it on the running 	 * list. 	 */
name|NS_LWDCLIENT_SETRECV
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|cm
operator|->
name|idle
argument_list|,
name|client
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|cm
operator|->
name|running
argument_list|,
name|client
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lwdclientmgr_shutdown_callback
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ns_lwdclientmgr_t
modifier|*
name|cm
init|=
name|ev
operator|->
name|ev_arg
decl_stmt|;
name|ns_lwdclient_t
modifier|*
name|client
decl_stmt|;
name|REQUIRE
argument_list|(
operator|!
name|SHUTTINGDOWN
argument_list|(
name|cm
argument_list|)
argument_list|)
expr_stmt|;
name|ns_lwdclient_log
argument_list|(
literal|50
argument_list|,
literal|"got shutdown event, task %p, lwdclientmgr %p"
argument_list|,
name|task
argument_list|,
name|cm
argument_list|)
expr_stmt|;
comment|/* 	 * run through the idle list and free the clients there.  Idle 	 * clients do not have a recv running nor do they have any finds 	 * or similar running. 	 */
name|client
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|cm
operator|->
name|idle
argument_list|)
expr_stmt|;
while|while
condition|(
name|client
operator|!=
name|NULL
condition|)
block|{
name|ns_lwdclient_log
argument_list|(
literal|50
argument_list|,
literal|"destroying client %p, manager %p"
argument_list|,
name|client
argument_list|,
name|cm
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|cm
operator|->
name|idle
argument_list|,
name|client
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|cm
operator|->
name|mctx
argument_list|,
name|client
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|client
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|cm
operator|->
name|idle
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Cancel any pending I/O. 	 */
name|isc_socket_cancel
argument_list|(
name|cm
operator|->
name|sock
argument_list|,
name|task
argument_list|,
name|ISC_SOCKCANCEL_ALL
argument_list|)
expr_stmt|;
comment|/* 	 * Run through the running client list and kill off any finds 	 * in progress. 	 */
name|client
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|cm
operator|->
name|running
argument_list|)
expr_stmt|;
while|while
condition|(
name|client
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|client
operator|->
name|find
operator|!=
name|client
operator|->
name|v4find
operator|&&
name|client
operator|->
name|find
operator|!=
name|client
operator|->
name|v6find
condition|)
name|dns_adb_cancelfind
argument_list|(
name|client
operator|->
name|find
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|v4find
operator|!=
name|NULL
condition|)
name|dns_adb_cancelfind
argument_list|(
name|client
operator|->
name|v4find
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|v6find
operator|!=
name|NULL
condition|)
name|dns_adb_cancelfind
argument_list|(
name|client
operator|->
name|v6find
argument_list|)
expr_stmt|;
name|client
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|client
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|cm
operator|->
name|flags
operator||=
name|NS_LWDCLIENTMGR_FLAGSHUTTINGDOWN
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Do all the crap needed to move a client from the run queue to the idle  * queue.  */
end_comment

begin_function
name|void
name|ns_lwdclient_stateidle
parameter_list|(
name|ns_lwdclient_t
modifier|*
name|client
parameter_list|)
block|{
name|ns_lwdclientmgr_t
modifier|*
name|cm
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|cm
operator|=
name|client
operator|->
name|clientmgr
expr_stmt|;
name|INSIST
argument_list|(
name|client
operator|->
name|sendbuf
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|client
operator|->
name|sendlength
operator|==
literal|0
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|client
operator|->
name|arg
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|client
operator|->
name|v4find
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|client
operator|->
name|v6find
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|cm
operator|->
name|running
argument_list|,
name|client
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_PREPEND
argument_list|(
name|cm
operator|->
name|idle
argument_list|,
name|client
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|NS_LWDCLIENT_SETIDLE
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|result
operator|=
name|ns_lwdclient_startrecv
argument_list|(
name|cm
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_LWRESD
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"could not start lwres "
literal|"client handler: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_lwdclient_send
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ns_lwdclient_t
modifier|*
name|client
init|=
name|ev
operator|->
name|ev_arg
decl_stmt|;
name|ns_lwdclientmgr_t
modifier|*
name|cm
init|=
name|client
operator|->
name|clientmgr
decl_stmt|;
name|isc_socketevent_t
modifier|*
name|dev
init|=
operator|(
name|isc_socketevent_t
operator|*
operator|)
name|ev
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|NS_LWDCLIENT_ISSEND
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|client
operator|->
name|sendbuf
operator|==
name|dev
operator|->
name|region
operator|.
name|base
argument_list|)
expr_stmt|;
name|ns_lwdclient_log
argument_list|(
literal|50
argument_list|,
literal|"task %p for client %p got send-done event"
argument_list|,
name|task
argument_list|,
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|sendbuf
operator|!=
name|client
operator|->
name|buffer
condition|)
name|lwres_context_freemem
argument_list|(
name|cm
operator|->
name|lwctx
argument_list|,
name|client
operator|->
name|sendbuf
argument_list|,
name|client
operator|->
name|sendlength
argument_list|)
expr_stmt|;
name|client
operator|->
name|sendbuf
operator|=
name|NULL
expr_stmt|;
name|client
operator|->
name|sendlength
operator|=
literal|0
expr_stmt|;
name|ns_lwdclient_stateidle
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_lwdclient_sendreply
parameter_list|(
name|ns_lwdclient_t
modifier|*
name|client
parameter_list|,
name|isc_region_t
modifier|*
name|r
parameter_list|)
block|{
name|struct
name|in6_pktinfo
modifier|*
name|pktinfo
decl_stmt|;
name|ns_lwdclientmgr_t
modifier|*
name|cm
init|=
name|client
operator|->
name|clientmgr
decl_stmt|;
if|if
condition|(
name|client
operator|->
name|pktinfo_valid
condition|)
name|pktinfo
operator|=
operator|&
name|client
operator|->
name|pktinfo
expr_stmt|;
else|else
name|pktinfo
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|isc_socket_sendto
argument_list|(
name|cm
operator|->
name|sock
argument_list|,
name|r
argument_list|,
name|cm
operator|->
name|task
argument_list|,
name|ns_lwdclient_send
argument_list|,
name|client
argument_list|,
operator|&
name|client
operator|->
name|address
argument_list|,
name|pktinfo
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ns_lwdclient_initialize
parameter_list|(
name|ns_lwdclient_t
modifier|*
name|client
parameter_list|,
name|ns_lwdclientmgr_t
modifier|*
name|cmgr
parameter_list|)
block|{
name|client
operator|->
name|clientmgr
operator|=
name|cmgr
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|client
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|NS_LWDCLIENT_SETIDLE
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|client
operator|->
name|arg
operator|=
name|NULL
expr_stmt|;
name|client
operator|->
name|recvlength
operator|=
literal|0
expr_stmt|;
name|client
operator|->
name|sendbuf
operator|=
name|NULL
expr_stmt|;
name|client
operator|->
name|sendlength
operator|=
literal|0
expr_stmt|;
name|client
operator|->
name|find
operator|=
name|NULL
expr_stmt|;
name|client
operator|->
name|v4find
operator|=
name|NULL
expr_stmt|;
name|client
operator|->
name|v6find
operator|=
name|NULL
expr_stmt|;
name|client
operator|->
name|find_wanted
operator|=
literal|0
expr_stmt|;
name|client
operator|->
name|options
operator|=
literal|0
expr_stmt|;
name|client
operator|->
name|byaddr
operator|=
name|NULL
expr_stmt|;
name|client
operator|->
name|lookup
operator|=
name|NULL
expr_stmt|;
name|client
operator|->
name|pktinfo_valid
operator|=
name|ISC_FALSE
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|cmgr
operator|->
name|idle
argument_list|,
name|client
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


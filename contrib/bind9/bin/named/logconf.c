begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004, 2006  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2001  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: logconf.c,v 1.30.2.3.10.4 2006/03/02 00:37:20 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/offset.h>
end_include

begin_include
include|#
directive|include
file|<isc/result.h>
end_include

begin_include
include|#
directive|include
file|<isc/stdio.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/syslog.h>
end_include

begin_include
include|#
directive|include
file|<isccfg/cfg.h>
end_include

begin_include
include|#
directive|include
file|<isccfg/log.h>
end_include

begin_include
include|#
directive|include
file|<named/log.h>
end_include

begin_include
include|#
directive|include
file|<named/logconf.h>
end_include

begin_define
define|#
directive|define
name|CHECK
parameter_list|(
name|op
parameter_list|)
define|\
value|do { result = (op); 				  	 \ 	       if (result != ISC_R_SUCCESS) goto cleanup; 	 \ 	} while (0)
end_define

begin_comment
comment|/*  * Set up a logging category according to the named.conf data  * in 'ccat' and add it to 'lctx'.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|category_fromconf
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|ccat
parameter_list|,
name|isc_logconfig_t
modifier|*
name|lctx
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|char
modifier|*
name|catname
decl_stmt|;
name|isc_logcategory_t
modifier|*
name|category
decl_stmt|;
name|isc_logmodule_t
modifier|*
name|module
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|destinations
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
init|=
name|NULL
decl_stmt|;
name|catname
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|ccat
argument_list|,
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|category
operator|=
name|isc_log_categorybyname
argument_list|(
name|ns_g_lctx
argument_list|,
name|catname
argument_list|)
expr_stmt|;
if|if
condition|(
name|category
operator|==
name|NULL
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|ccat
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"unknown logging category '%s' ignored"
argument_list|,
name|catname
argument_list|)
expr_stmt|;
comment|/* 		 * Allow further processing by returning success. 		 */
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
name|module
operator|=
name|NULL
expr_stmt|;
name|destinations
operator|=
name|cfg_tuple_get
argument_list|(
name|ccat
argument_list|,
literal|"destinations"
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|destinations
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|channel
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|channelname
init|=
name|cfg_obj_asstring
argument_list|(
name|channel
argument_list|)
decl_stmt|;
name|result
operator|=
name|isc_log_usechannel
argument_list|(
name|lctx
argument_list|,
name|channelname
argument_list|,
name|category
argument_list|,
name|module
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|CFG_LOGCATEGORY_CONFIG
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"logging channel '%s': %s"
argument_list|,
name|channelname
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set up a logging channel according to the named.conf data  * in 'cchan' and add it to 'lctx'.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|channel_fromconf
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|channel
parameter_list|,
name|isc_logconfig_t
modifier|*
name|lctx
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_logdestination_t
name|dest
decl_stmt|;
name|unsigned
name|int
name|type
decl_stmt|;
name|unsigned
name|int
name|flags
init|=
literal|0
decl_stmt|;
name|int
name|level
decl_stmt|;
specifier|const
name|char
modifier|*
name|channelname
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|fileobj
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|syslogobj
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|nullobj
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|stderrobj
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|severity
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|channelname
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_map_getname
argument_list|(
name|channel
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|channel
argument_list|,
literal|"file"
argument_list|,
operator|&
name|fileobj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|channel
argument_list|,
literal|"syslog"
argument_list|,
operator|&
name|syslogobj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|channel
argument_list|,
literal|"null"
argument_list|,
operator|&
name|nullobj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|channel
argument_list|,
literal|"stderr"
argument_list|,
operator|&
name|stderrobj
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fileobj
operator|!=
name|NULL
condition|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|syslogobj
operator|!=
name|NULL
condition|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|nullobj
operator|!=
name|NULL
condition|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|stderrobj
operator|!=
name|NULL
condition|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|1
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|channel
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"channel '%s': exactly one of file, syslog, "
literal|"null, and stderr must be present"
argument_list|,
name|channelname
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
name|type
operator|=
name|ISC_LOG_TONULL
expr_stmt|;
if|if
condition|(
name|fileobj
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|pathobj
init|=
name|cfg_tuple_get
argument_list|(
name|fileobj
argument_list|,
literal|"file"
argument_list|)
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|sizeobj
init|=
name|cfg_tuple_get
argument_list|(
name|fileobj
argument_list|,
literal|"size"
argument_list|)
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|versionsobj
init|=
name|cfg_tuple_get
argument_list|(
name|fileobj
argument_list|,
literal|"versions"
argument_list|)
decl_stmt|;
name|isc_int32_t
name|versions
init|=
name|ISC_LOG_ROLLNEVER
decl_stmt|;
name|isc_offset_t
name|size
init|=
literal|0
decl_stmt|;
name|type
operator|=
name|ISC_LOG_TOFILE
expr_stmt|;
if|if
condition|(
name|versionsobj
operator|!=
name|NULL
operator|&&
name|cfg_obj_isuint32
argument_list|(
name|versionsobj
argument_list|)
condition|)
name|versions
operator|=
name|cfg_obj_asuint32
argument_list|(
name|versionsobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|versionsobj
operator|!=
name|NULL
operator|&&
name|cfg_obj_isstring
argument_list|(
name|versionsobj
argument_list|)
operator|&&
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|versionsobj
argument_list|)
argument_list|,
literal|"unlimited"
argument_list|)
operator|==
literal|0
condition|)
name|versions
operator|=
name|ISC_LOG_ROLLINFINITE
expr_stmt|;
if|if
condition|(
name|sizeobj
operator|!=
name|NULL
operator|&&
name|cfg_obj_isuint64
argument_list|(
name|sizeobj
argument_list|)
operator|&&
name|cfg_obj_asuint64
argument_list|(
name|sizeobj
argument_list|)
operator|<
name|ISC_OFFSET_MAXIMUM
condition|)
name|size
operator|=
operator|(
name|isc_offset_t
operator|)
name|cfg_obj_asuint64
argument_list|(
name|sizeobj
argument_list|)
expr_stmt|;
name|dest
operator|.
name|file
operator|.
name|stream
operator|=
name|NULL
expr_stmt|;
name|dest
operator|.
name|file
operator|.
name|name
operator|=
name|cfg_obj_asstring
argument_list|(
name|pathobj
argument_list|)
expr_stmt|;
name|dest
operator|.
name|file
operator|.
name|versions
operator|=
name|versions
expr_stmt|;
name|dest
operator|.
name|file
operator|.
name|maximum_size
operator|=
name|size
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|syslogobj
operator|!=
name|NULL
condition|)
block|{
name|int
name|facility
init|=
name|LOG_DAEMON
decl_stmt|;
name|type
operator|=
name|ISC_LOG_TOSYSLOG
expr_stmt|;
if|if
condition|(
name|cfg_obj_isstring
argument_list|(
name|syslogobj
argument_list|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|facilitystr
init|=
name|cfg_obj_asstring
argument_list|(
name|syslogobj
argument_list|)
decl_stmt|;
operator|(
name|void
operator|)
name|isc_syslog_facilityfromstring
argument_list|(
name|facilitystr
argument_list|,
operator|&
name|facility
argument_list|)
expr_stmt|;
block|}
name|dest
operator|.
name|facility
operator|=
name|facility
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|stderrobj
operator|!=
name|NULL
condition|)
block|{
name|type
operator|=
name|ISC_LOG_TOFILEDESC
expr_stmt|;
name|dest
operator|.
name|file
operator|.
name|stream
operator|=
name|stderr
expr_stmt|;
name|dest
operator|.
name|file
operator|.
name|name
operator|=
name|NULL
expr_stmt|;
name|dest
operator|.
name|file
operator|.
name|versions
operator|=
name|ISC_LOG_ROLLNEVER
expr_stmt|;
name|dest
operator|.
name|file
operator|.
name|maximum_size
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 	 * Munge flags. 	 */
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|printcat
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|printsev
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|printtime
init|=
name|NULL
decl_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|channel
argument_list|,
literal|"print-category"
argument_list|,
operator|&
name|printcat
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|channel
argument_list|,
literal|"print-severity"
argument_list|,
operator|&
name|printsev
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|channel
argument_list|,
literal|"print-time"
argument_list|,
operator|&
name|printtime
argument_list|)
expr_stmt|;
if|if
condition|(
name|printcat
operator|!=
name|NULL
operator|&&
name|cfg_obj_asboolean
argument_list|(
name|printcat
argument_list|)
condition|)
name|flags
operator||=
name|ISC_LOG_PRINTCATEGORY
expr_stmt|;
if|if
condition|(
name|printtime
operator|!=
name|NULL
operator|&&
name|cfg_obj_asboolean
argument_list|(
name|printtime
argument_list|)
condition|)
name|flags
operator||=
name|ISC_LOG_PRINTTIME
expr_stmt|;
if|if
condition|(
name|printsev
operator|!=
name|NULL
operator|&&
name|cfg_obj_asboolean
argument_list|(
name|printsev
argument_list|)
condition|)
name|flags
operator||=
name|ISC_LOG_PRINTLEVEL
expr_stmt|;
block|}
name|level
operator|=
name|ISC_LOG_INFO
expr_stmt|;
if|if
condition|(
name|cfg_map_get
argument_list|(
name|channel
argument_list|,
literal|"severity"
argument_list|,
operator|&
name|severity
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|cfg_obj_isstring
argument_list|(
name|severity
argument_list|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|str
init|=
name|cfg_obj_asstring
argument_list|(
name|severity
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"critical"
argument_list|)
operator|==
literal|0
condition|)
name|level
operator|=
name|ISC_LOG_CRITICAL
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"error"
argument_list|)
operator|==
literal|0
condition|)
name|level
operator|=
name|ISC_LOG_ERROR
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"warning"
argument_list|)
operator|==
literal|0
condition|)
name|level
operator|=
name|ISC_LOG_WARNING
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"notice"
argument_list|)
operator|==
literal|0
condition|)
name|level
operator|=
name|ISC_LOG_NOTICE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"info"
argument_list|)
operator|==
literal|0
condition|)
name|level
operator|=
name|ISC_LOG_INFO
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"dynamic"
argument_list|)
operator|==
literal|0
condition|)
name|level
operator|=
name|ISC_LOG_DYNAMIC
expr_stmt|;
block|}
else|else
comment|/* debug */
name|level
operator|=
name|cfg_obj_asuint32
argument_list|(
name|severity
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|isc_log_createchannel
argument_list|(
name|lctx
argument_list|,
name|channelname
argument_list|,
name|type
argument_list|,
name|level
argument_list|,
operator|&
name|dest
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|type
operator|==
name|ISC_LOG_TOFILE
condition|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
comment|/* 		 * Test that the file can be opened, since isc_log_open() 		 * can't effectively report failures when called in 		 * isc_log_doit(). 		 */
name|result
operator|=
name|isc_stdio_open
argument_list|(
name|dest
operator|.
name|file
operator|.
name|name
argument_list|,
literal|"a"
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|CFG_LOGCATEGORY_CONFIG
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"logging channel '%s' file '%s': %s"
argument_list|,
name|channelname
argument_list|,
name|dest
operator|.
name|file
operator|.
name|name
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|isc_stdio_close
argument_list|(
name|fp
argument_list|)
expr_stmt|;
comment|/* 		 * Allow named to continue by returning success. 		 */
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_log_configure
parameter_list|(
name|isc_logconfig_t
modifier|*
name|logconf
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|logstmt
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|channels
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|categories
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
name|isc_boolean_t
name|default_set
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|unmatched_set
init|=
name|ISC_FALSE
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|catname
decl_stmt|;
name|CHECK
argument_list|(
name|ns_log_setdefaultchannels
argument_list|(
name|logconf
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|logstmt
argument_list|,
literal|"channel"
argument_list|,
operator|&
name|channels
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|channels
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|channel
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|channel_fromconf
argument_list|(
name|channel
argument_list|,
name|logconf
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|logstmt
argument_list|,
literal|"category"
argument_list|,
operator|&
name|categories
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|categories
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|category
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|category_fromconf
argument_list|(
name|category
argument_list|,
name|logconf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|default_set
condition|)
block|{
name|catname
operator|=
name|cfg_tuple_get
argument_list|(
name|category
argument_list|,
literal|"name"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|catname
argument_list|)
argument_list|,
literal|"default"
argument_list|)
operator|==
literal|0
condition|)
name|default_set
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|unmatched_set
condition|)
block|{
name|catname
operator|=
name|cfg_tuple_get
argument_list|(
name|category
argument_list|,
literal|"name"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|catname
argument_list|)
argument_list|,
literal|"unmatched"
argument_list|)
operator|==
literal|0
condition|)
name|unmatched_set
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|default_set
condition|)
name|CHECK
argument_list|(
name|ns_log_setdefaultcategory
argument_list|(
name|logconf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|unmatched_set
condition|)
name|CHECK
argument_list|(
name|ns_log_setunmatchedcategory
argument_list|(
name|logconf
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|logconf
operator|!=
name|NULL
condition|)
name|isc_logconfig_destroy
argument_list|(
operator|&
name|logconf
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

end_unit


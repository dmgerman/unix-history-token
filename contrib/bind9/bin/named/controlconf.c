begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004, 2006  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 2001-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: controlconf.c,v 1.28.2.9.2.10 2006/02/28 06:32:53 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/base64.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_include
include|#
directive|include
file|<isc/event.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/net.h>
end_include

begin_include
include|#
directive|include
file|<isc/netaddr.h>
end_include

begin_include
include|#
directive|include
file|<isc/random.h>
end_include

begin_include
include|#
directive|include
file|<isc/result.h>
end_include

begin_include
include|#
directive|include
file|<isc/stdtime.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/timer.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<isccfg/namedconf.h>
end_include

begin_include
include|#
directive|include
file|<bind9/check.h>
end_include

begin_include
include|#
directive|include
file|<isccc/alist.h>
end_include

begin_include
include|#
directive|include
file|<isccc/cc.h>
end_include

begin_include
include|#
directive|include
file|<isccc/ccmsg.h>
end_include

begin_include
include|#
directive|include
file|<isccc/events.h>
end_include

begin_include
include|#
directive|include
file|<isccc/result.h>
end_include

begin_include
include|#
directive|include
file|<isccc/sexpr.h>
end_include

begin_include
include|#
directive|include
file|<isccc/symtab.h>
end_include

begin_include
include|#
directive|include
file|<isccc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<named/config.h>
end_include

begin_include
include|#
directive|include
file|<named/control.h>
end_include

begin_include
include|#
directive|include
file|<named/log.h>
end_include

begin_include
include|#
directive|include
file|<named/server.h>
end_include

begin_comment
comment|/*  * Note: Listeners and connections are not locked.  All event handlers are  * executed by the server task, and all callers of exported routines must  * be running under the server task.  */
end_comment

begin_typedef
typedef|typedef
name|struct
name|controlkey
name|controlkey_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|ISC_LIST
argument_list|(
argument|controlkey_t
argument_list|)
name|controlkeylist_t
expr_stmt|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|controlconnection
name|controlconnection_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|ISC_LIST
argument_list|(
argument|controlconnection_t
argument_list|)
name|controlconnectionlist_t
expr_stmt|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|controllistener
name|controllistener_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|ISC_LIST
argument_list|(
argument|controllistener_t
argument_list|)
name|controllistenerlist_t
expr_stmt|;
end_typedef

begin_struct
struct|struct
name|controlkey
block|{
name|char
modifier|*
name|keyname
decl_stmt|;
name|isc_region_t
name|secret
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|controlkey_t
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|controlconnection
block|{
name|isc_socket_t
modifier|*
name|sock
decl_stmt|;
name|isccc_ccmsg_t
name|ccmsg
decl_stmt|;
name|isc_boolean_t
name|ccmsg_valid
decl_stmt|;
name|isc_boolean_t
name|sending
decl_stmt|;
name|isc_timer_t
modifier|*
name|timer
decl_stmt|;
name|unsigned
name|char
name|buffer
index|[
literal|2048
index|]
decl_stmt|;
name|controllistener_t
modifier|*
name|listener
decl_stmt|;
name|isc_uint32_t
name|nonce
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|controlconnection_t
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|controllistener
block|{
name|ns_controls_t
modifier|*
name|controls
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|isc_sockaddr_t
name|address
decl_stmt|;
name|isc_socket_t
modifier|*
name|sock
decl_stmt|;
name|dns_acl_t
modifier|*
name|acl
decl_stmt|;
name|isc_boolean_t
name|listening
decl_stmt|;
name|isc_boolean_t
name|exiting
decl_stmt|;
name|controlkeylist_t
name|keys
decl_stmt|;
name|controlconnectionlist_t
name|connections
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|controllistener_t
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ns_controls
block|{
name|ns_server_t
modifier|*
name|server
decl_stmt|;
name|controllistenerlist_t
name|listeners
decl_stmt|;
name|isc_boolean_t
name|shuttingdown
decl_stmt|;
name|isccc_symtab_t
modifier|*
name|symtab
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|control_newconn
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|control_recvmessage
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|CLOCKSKEW
value|300
end_define

begin_function
specifier|static
name|void
name|free_controlkey
parameter_list|(
name|controlkey_t
modifier|*
name|key
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|)
block|{
if|if
condition|(
name|key
operator|->
name|keyname
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|key
operator|->
name|keyname
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|->
name|secret
operator|.
name|base
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|key
operator|->
name|secret
operator|.
name|base
argument_list|,
name|key
operator|->
name|secret
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|key
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|key
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_controlkeylist
parameter_list|(
name|controlkeylist_t
modifier|*
name|keylist
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|)
block|{
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
operator|*
name|keylist
argument_list|)
condition|)
block|{
name|controlkey_t
modifier|*
name|key
init|=
name|ISC_LIST_HEAD
argument_list|(
operator|*
name|keylist
argument_list|)
decl_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
operator|*
name|keylist
argument_list|,
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free_controlkey
argument_list|(
name|key
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|free_listener
parameter_list|(
name|controllistener_t
modifier|*
name|listener
parameter_list|)
block|{
name|INSIST
argument_list|(
name|listener
operator|->
name|exiting
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|listener
operator|->
name|listening
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ISC_LIST_EMPTY
argument_list|(
name|listener
operator|->
name|connections
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|listener
operator|->
name|sock
operator|!=
name|NULL
condition|)
name|isc_socket_detach
argument_list|(
operator|&
name|listener
operator|->
name|sock
argument_list|)
expr_stmt|;
name|free_controlkeylist
argument_list|(
operator|&
name|listener
operator|->
name|keys
argument_list|,
name|listener
operator|->
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|listener
operator|->
name|acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|listener
operator|->
name|acl
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|listener
operator|->
name|mctx
argument_list|,
name|listener
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|listener
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|maybe_free_listener
parameter_list|(
name|controllistener_t
modifier|*
name|listener
parameter_list|)
block|{
if|if
condition|(
name|listener
operator|->
name|exiting
operator|&&
operator|!
name|listener
operator|->
name|listening
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|listener
operator|->
name|connections
argument_list|)
condition|)
name|free_listener
argument_list|(
name|listener
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|maybe_free_connection
parameter_list|(
name|controlconnection_t
modifier|*
name|conn
parameter_list|)
block|{
name|controllistener_t
modifier|*
name|listener
init|=
name|conn
operator|->
name|listener
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|timer
operator|!=
name|NULL
condition|)
name|isc_timer_detach
argument_list|(
operator|&
name|conn
operator|->
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|ccmsg_valid
condition|)
block|{
name|isccc_ccmsg_cancelread
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|conn
operator|->
name|sending
condition|)
block|{
name|isc_socket_cancel
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
name|listener
operator|->
name|task
argument_list|,
name|ISC_SOCKCANCEL_SEND
argument_list|)
expr_stmt|;
return|return;
block|}
name|ISC_LIST_UNLINK
argument_list|(
name|listener
operator|->
name|connections
argument_list|,
name|conn
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|listener
operator|->
name|mctx
argument_list|,
name|conn
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|conn
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|shutdown_listener
parameter_list|(
name|controllistener_t
modifier|*
name|listener
parameter_list|)
block|{
name|controlconnection_t
modifier|*
name|conn
decl_stmt|;
name|controlconnection_t
modifier|*
name|next
decl_stmt|;
if|if
condition|(
operator|!
name|listener
operator|->
name|exiting
condition|)
block|{
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|listener
operator|->
name|controls
operator|->
name|listeners
argument_list|,
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|listener
operator|->
name|address
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_CONTROL
argument_list|,
name|ISC_LOG_NOTICE
argument_list|,
literal|"stopping command channel on %s"
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
name|listener
operator|->
name|exiting
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
for|for
control|(
name|conn
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|listener
operator|->
name|connections
argument_list|)
init|;
name|conn
operator|!=
name|NULL
condition|;
name|conn
operator|=
name|next
control|)
block|{
name|next
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|conn
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|maybe_free_connection
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|listener
operator|->
name|listening
condition|)
name|isc_socket_cancel
argument_list|(
name|listener
operator|->
name|sock
argument_list|,
name|listener
operator|->
name|task
argument_list|,
name|ISC_SOCKCANCEL_ACCEPT
argument_list|)
expr_stmt|;
name|maybe_free_listener
argument_list|(
name|listener
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|address_ok
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|,
name|dns_acl_t
modifier|*
name|acl
parameter_list|)
block|{
name|isc_netaddr_t
name|netaddr
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|int
name|match
decl_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|netaddr
argument_list|,
name|sockaddr
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_acl_match
argument_list|(
operator|&
name|netaddr
argument_list|,
name|NULL
argument_list|,
name|acl
argument_list|,
operator|&
name|ns_g_server
operator|->
name|aclenv
argument_list|,
operator|&
name|match
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|||
name|match
operator|<=
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|control_accept
parameter_list|(
name|controllistener_t
modifier|*
name|listener
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|isc_socket_accept
argument_list|(
name|listener
operator|->
name|sock
argument_list|,
name|listener
operator|->
name|task
argument_list|,
name|control_newconn
argument_list|,
name|listener
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"isc_socket_accept() failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|listener
operator|->
name|listening
operator|=
name|ISC_TRUE
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|control_listen
parameter_list|(
name|controllistener_t
modifier|*
name|listener
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|isc_socket_listen
argument_list|(
name|listener
operator|->
name|sock
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"isc_socket_listen() failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|control_next
parameter_list|(
name|controllistener_t
modifier|*
name|listener
parameter_list|)
block|{
operator|(
name|void
operator|)
name|control_accept
argument_list|(
name|listener
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|control_senddone
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_socketevent_t
modifier|*
name|sevent
init|=
operator|(
name|isc_socketevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|controlconnection_t
modifier|*
name|conn
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|controllistener_t
modifier|*
name|listener
init|=
name|conn
operator|->
name|listener
decl_stmt|;
name|isc_socket_t
modifier|*
name|sock
init|=
operator|(
name|isc_socket_t
operator|*
operator|)
name|sevent
operator|->
name|ev_sender
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|conn
operator|->
name|sending
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|conn
operator|->
name|sending
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|sevent
operator|->
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|sevent
operator|->
name|result
operator|!=
name|ISC_R_CANCELED
condition|)
block|{
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_sockaddr_t
name|peeraddr
decl_stmt|;
operator|(
name|void
operator|)
name|isc_socket_getpeername
argument_list|(
name|sock
argument_list|,
operator|&
name|peeraddr
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|peeraddr
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_CONTROL
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"error sending command response to %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|sevent
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|result
operator|=
name|isccc_ccmsg_readmessage
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|,
name|listener
operator|->
name|task
argument_list|,
name|control_recvmessage
argument_list|,
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_socket_detach
argument_list|(
operator|&
name|conn
operator|->
name|sock
argument_list|)
expr_stmt|;
name|maybe_free_connection
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|maybe_free_listener
argument_list|(
name|listener
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|log_invalid
parameter_list|(
name|isccc_ccmsg_t
modifier|*
name|ccmsg
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
block|{
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_sockaddr_t
name|peeraddr
decl_stmt|;
operator|(
name|void
operator|)
name|isc_socket_getpeername
argument_list|(
name|ccmsg
operator|->
name|sock
argument_list|,
operator|&
name|peeraddr
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|peeraddr
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_CONTROL
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"invalid command from %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|control_recvmessage
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|controlconnection_t
modifier|*
name|conn
decl_stmt|;
name|controllistener_t
modifier|*
name|listener
decl_stmt|;
name|controlkey_t
modifier|*
name|key
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|response
init|=
name|NULL
decl_stmt|;
name|isccc_region_t
name|ccregion
decl_stmt|;
name|isccc_region_t
name|secret
decl_stmt|;
name|isc_stdtime_t
name|now
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|isc_uint32_t
name|len
decl_stmt|;
name|isc_buffer_t
name|text
decl_stmt|;
name|char
name|textarray
index|[
literal|1024
index|]
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_result_t
name|eresult
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|_ctrl
decl_stmt|;
name|isccc_time_t
name|sent
decl_stmt|;
name|isccc_time_t
name|exp
decl_stmt|;
name|isc_uint32_t
name|nonce
decl_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|ISCCC_EVENT_CCMSG
argument_list|)
expr_stmt|;
name|conn
operator|=
name|event
operator|->
name|ev_arg
expr_stmt|;
name|listener
operator|=
name|conn
operator|->
name|listener
expr_stmt|;
name|secret
operator|.
name|rstart
operator|=
name|NULL
expr_stmt|;
comment|/* Is the server shutting down? */
if|if
condition|(
name|listener
operator|->
name|controls
operator|->
name|shuttingdown
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|conn
operator|->
name|ccmsg
operator|.
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|conn
operator|->
name|ccmsg
operator|.
name|result
operator|!=
name|ISC_R_CANCELED
operator|&&
name|conn
operator|->
name|ccmsg
operator|.
name|result
operator|!=
name|ISC_R_EOF
condition|)
name|log_invalid
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|,
name|conn
operator|->
name|ccmsg
operator|.
name|result
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|request
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|listener
operator|->
name|keys
argument_list|)
init|;
name|key
operator|!=
name|NULL
condition|;
name|key
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
control|)
block|{
name|ccregion
operator|.
name|rstart
operator|=
name|isc_buffer_base
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|ccregion
operator|.
name|rend
operator|=
name|isc_buffer_used
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
operator|.
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|secret
operator|.
name|rstart
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|listener
operator|->
name|mctx
argument_list|,
name|secret
operator|.
name|rstart
argument_list|,
name|REGION_SIZE
argument_list|(
name|secret
argument_list|)
argument_list|)
expr_stmt|;
name|secret
operator|.
name|rstart
operator|=
name|isc_mem_get
argument_list|(
name|listener
operator|->
name|mctx
argument_list|,
name|key
operator|->
name|secret
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|secret
operator|.
name|rstart
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
name|memcpy
argument_list|(
name|secret
operator|.
name|rstart
argument_list|,
name|key
operator|->
name|secret
operator|.
name|base
argument_list|,
name|key
operator|->
name|secret
operator|.
name|length
argument_list|)
expr_stmt|;
name|secret
operator|.
name|rend
operator|=
name|secret
operator|.
name|rstart
operator|+
name|key
operator|->
name|secret
operator|.
name|length
expr_stmt|;
name|result
operator|=
name|isccc_cc_fromwire
argument_list|(
operator|&
name|ccregion
argument_list|,
operator|&
name|request
argument_list|,
operator|&
name|secret
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
break|break;
elseif|else
if|if
condition|(
name|result
operator|==
name|ISCCC_R_BADAUTH
condition|)
block|{
comment|/* 			 * For some reason, request is non-NULL when 			 * isccc_cc_fromwire returns ISCCC_R_BADAUTH. 			 */
if|if
condition|(
name|request
operator|!=
name|NULL
condition|)
name|isccc_sexpr_free
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log_invalid
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|,
name|result
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
block|{
name|log_invalid
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|,
name|ISCCC_R_BADAUTH
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* We shouldn't be getting a reply. */
if|if
condition|(
name|isccc_cc_isreply
argument_list|(
name|request
argument_list|)
condition|)
block|{
name|log_invalid
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|,
name|ISC_R_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* 	 * Limit exposure to replay attacks. 	 */
name|_ctrl
operator|=
name|isccc_alist_lookup
argument_list|(
name|request
argument_list|,
literal|"_ctrl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_ctrl
operator|==
name|NULL
condition|)
block|{
name|log_invalid
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|,
name|ISC_R_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|isccc_cc_lookupuint32
argument_list|(
name|_ctrl
argument_list|,
literal|"_tim"
argument_list|,
operator|&
name|sent
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|sent
operator|+
name|CLOCKSKEW
operator|)
operator|<
name|now
operator|||
operator|(
name|sent
operator|-
name|CLOCKSKEW
operator|)
operator|>
name|now
condition|)
block|{
name|log_invalid
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|,
name|ISCCC_R_CLOCKSKEW
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
else|else
block|{
name|log_invalid
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|,
name|ISC_R_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * Expire messages that are too old. 	 */
if|if
condition|(
name|isccc_cc_lookupuint32
argument_list|(
name|_ctrl
argument_list|,
literal|"_exp"
argument_list|,
operator|&
name|exp
argument_list|)
operator|==
name|ISC_R_SUCCESS
operator|&&
name|now
operator|>
name|exp
condition|)
block|{
name|log_invalid
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|,
name|ISCCC_R_EXPIRED
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * Duplicate suppression (required for UDP). 	 */
name|isccc_cc_cleansymtab
argument_list|(
name|listener
operator|->
name|controls
operator|->
name|symtab
argument_list|,
name|now
argument_list|)
expr_stmt|;
name|result
operator|=
name|isccc_cc_checkdup
argument_list|(
name|listener
operator|->
name|controls
operator|->
name|symtab
argument_list|,
name|request
argument_list|,
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|result
operator|==
name|ISC_R_EXISTS
condition|)
name|result
operator|=
name|ISCCC_R_DUPLICATE
expr_stmt|;
name|log_invalid
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|,
name|result
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|conn
operator|->
name|nonce
operator|!=
literal|0
operator|&&
operator|(
name|isccc_cc_lookupuint32
argument_list|(
name|_ctrl
argument_list|,
literal|"_nonce"
argument_list|,
operator|&
name|nonce
argument_list|)
operator|!=
name|ISC_R_SUCCESS
operator|||
name|conn
operator|->
name|nonce
operator|!=
name|nonce
operator|)
condition|)
block|{
name|log_invalid
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|,
name|ISCCC_R_BADAUTH
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * Establish nonce. 	 */
while|while
condition|(
name|conn
operator|->
name|nonce
operator|==
literal|0
condition|)
name|isc_random_get
argument_list|(
operator|&
name|conn
operator|->
name|nonce
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|text
argument_list|,
name|textarray
argument_list|,
sizeof|sizeof
argument_list|(
name|textarray
argument_list|)
argument_list|)
expr_stmt|;
name|eresult
operator|=
name|ns_control_docommand
argument_list|(
name|request
argument_list|,
operator|&
name|text
argument_list|)
expr_stmt|;
name|result
operator|=
name|isccc_cc_createresponse
argument_list|(
name|request
argument_list|,
name|now
argument_list|,
name|now
operator|+
literal|60
argument_list|,
operator|&
name|response
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|eresult
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isccc_sexpr_t
modifier|*
name|data
decl_stmt|;
name|data
operator|=
name|isccc_alist_lookup
argument_list|(
name|response
argument_list|,
literal|"_data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|char
modifier|*
name|estr
init|=
name|isc_result_totext
argument_list|(
name|eresult
argument_list|)
decl_stmt|;
if|if
condition|(
name|isccc_cc_definestring
argument_list|(
name|data
argument_list|,
literal|"err"
argument_list|,
name|estr
argument_list|)
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
block|}
block|}
if|if
condition|(
name|isc_buffer_usedlength
argument_list|(
operator|&
name|text
argument_list|)
operator|>
literal|0
condition|)
block|{
name|isccc_sexpr_t
modifier|*
name|data
decl_stmt|;
name|data
operator|=
name|isccc_alist_lookup
argument_list|(
name|response
argument_list|,
literal|"_data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|str
init|=
operator|(
name|char
operator|*
operator|)
name|isc_buffer_base
argument_list|(
operator|&
name|text
argument_list|)
decl_stmt|;
if|if
condition|(
name|isccc_cc_definestring
argument_list|(
name|data
argument_list|,
literal|"text"
argument_list|,
name|str
argument_list|)
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
block|}
block|}
name|_ctrl
operator|=
name|isccc_alist_lookup
argument_list|(
name|response
argument_list|,
literal|"_ctrl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_ctrl
operator|==
name|NULL
operator|||
name|isccc_cc_defineuint32
argument_list|(
name|_ctrl
argument_list|,
literal|"_nonce"
argument_list|,
name|conn
operator|->
name|nonce
argument_list|)
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
name|ccregion
operator|.
name|rstart
operator|=
name|conn
operator|->
name|buffer
operator|+
literal|4
expr_stmt|;
name|ccregion
operator|.
name|rend
operator|=
name|conn
operator|->
name|buffer
operator|+
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|result
operator|=
name|isccc_cc_towire
argument_list|(
name|response
argument_list|,
operator|&
name|ccregion
argument_list|,
operator|&
name|secret
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|buffer
argument_list|)
operator|-
name|REGION_SIZE
argument_list|(
name|ccregion
argument_list|)
expr_stmt|;
name|isc_buffer_putuint32
argument_list|(
operator|&
name|b
argument_list|,
name|len
operator|-
literal|4
argument_list|)
expr_stmt|;
name|r
operator|.
name|base
operator|=
name|conn
operator|->
name|buffer
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|len
expr_stmt|;
name|result
operator|=
name|isc_socket_send
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
operator|&
name|r
argument_list|,
name|task
argument_list|,
name|control_senddone
argument_list|,
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|conn
operator|->
name|sending
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
name|secret
operator|.
name|rstart
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|listener
operator|->
name|mctx
argument_list|,
name|secret
operator|.
name|rstart
argument_list|,
name|REGION_SIZE
argument_list|(
name|secret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|!=
name|NULL
condition|)
name|isccc_sexpr_free
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|response
operator|!=
name|NULL
condition|)
name|isccc_sexpr_free
argument_list|(
operator|&
name|response
argument_list|)
expr_stmt|;
return|return;
name|cleanup
label|:
if|if
condition|(
name|secret
operator|.
name|rstart
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|listener
operator|->
name|mctx
argument_list|,
name|secret
operator|.
name|rstart
argument_list|,
name|REGION_SIZE
argument_list|(
name|secret
argument_list|)
argument_list|)
expr_stmt|;
name|isc_socket_detach
argument_list|(
operator|&
name|conn
operator|->
name|sock
argument_list|)
expr_stmt|;
name|isccc_ccmsg_invalidate
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|)
expr_stmt|;
name|conn
operator|->
name|ccmsg_valid
operator|=
name|ISC_FALSE
expr_stmt|;
name|maybe_free_connection
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|maybe_free_listener
argument_list|(
name|listener
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|!=
name|NULL
condition|)
name|isccc_sexpr_free
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|response
operator|!=
name|NULL
condition|)
name|isccc_sexpr_free
argument_list|(
operator|&
name|response
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|control_timeout
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|controlconnection_t
modifier|*
name|conn
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|isc_timer_detach
argument_list|(
operator|&
name|conn
operator|->
name|timer
argument_list|)
expr_stmt|;
name|maybe_free_connection
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|newconnection
parameter_list|(
name|controllistener_t
modifier|*
name|listener
parameter_list|,
name|isc_socket_t
modifier|*
name|sock
parameter_list|)
block|{
name|controlconnection_t
modifier|*
name|conn
decl_stmt|;
name|isc_interval_t
name|interval
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|conn
operator|=
name|isc_mem_get
argument_list|(
name|listener
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|conn
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|conn
operator|->
name|sock
operator|=
name|sock
expr_stmt|;
name|isccc_ccmsg_init
argument_list|(
name|listener
operator|->
name|mctx
argument_list|,
name|sock
argument_list|,
operator|&
name|conn
operator|->
name|ccmsg
argument_list|)
expr_stmt|;
name|conn
operator|->
name|ccmsg_valid
operator|=
name|ISC_TRUE
expr_stmt|;
name|conn
operator|->
name|sending
operator|=
name|ISC_FALSE
expr_stmt|;
name|conn
operator|->
name|timer
operator|=
name|NULL
expr_stmt|;
name|isc_interval_set
argument_list|(
operator|&
name|interval
argument_list|,
literal|60
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_timer_create
argument_list|(
name|ns_g_timermgr
argument_list|,
name|isc_timertype_once
argument_list|,
name|NULL
argument_list|,
operator|&
name|interval
argument_list|,
name|listener
operator|->
name|task
argument_list|,
name|control_timeout
argument_list|,
name|conn
argument_list|,
operator|&
name|conn
operator|->
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|conn
operator|->
name|listener
operator|=
name|listener
expr_stmt|;
name|conn
operator|->
name|nonce
operator|=
literal|0
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|conn
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|result
operator|=
name|isccc_ccmsg_readmessage
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|,
name|listener
operator|->
name|task
argument_list|,
name|control_recvmessage
argument_list|,
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|isccc_ccmsg_setmaxsize
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|listener
operator|->
name|connections
argument_list|,
name|conn
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
name|isccc_ccmsg_invalidate
argument_list|(
operator|&
name|conn
operator|->
name|ccmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|timer
operator|!=
name|NULL
condition|)
name|isc_timer_detach
argument_list|(
operator|&
name|conn
operator|->
name|timer
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|listener
operator|->
name|mctx
argument_list|,
name|conn
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|conn
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|control_newconn
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_socket_newconnev_t
modifier|*
name|nevent
init|=
operator|(
name|isc_socket_newconnev_t
operator|*
operator|)
name|event
decl_stmt|;
name|controllistener_t
modifier|*
name|listener
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|isc_socket_t
modifier|*
name|sock
decl_stmt|;
name|isc_sockaddr_t
name|peeraddr
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|listener
operator|->
name|listening
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|nevent
operator|->
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|nevent
operator|->
name|result
operator|==
name|ISC_R_CANCELED
condition|)
block|{
name|shutdown_listener
argument_list|(
name|listener
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
goto|goto
name|restart
goto|;
block|}
name|sock
operator|=
name|nevent
operator|->
name|newsocket
expr_stmt|;
operator|(
name|void
operator|)
name|isc_socket_getpeername
argument_list|(
name|sock
argument_list|,
operator|&
name|peeraddr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|address_ok
argument_list|(
operator|&
name|peeraddr
argument_list|,
name|listener
operator|->
name|acl
argument_list|)
condition|)
block|{
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|peeraddr
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_CONTROL
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"rejected command channel message from %s"
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
name|isc_socket_detach
argument_list|(
operator|&
name|sock
argument_list|)
expr_stmt|;
goto|goto
name|restart
goto|;
block|}
name|result
operator|=
name|newconnection
argument_list|(
name|listener
argument_list|,
name|sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|peeraddr
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_CONTROL
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"dropped command channel from %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|isc_socket_detach
argument_list|(
operator|&
name|sock
argument_list|)
expr_stmt|;
goto|goto
name|restart
goto|;
block|}
name|restart
label|:
name|control_next
argument_list|(
name|listener
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|controls_shutdown
parameter_list|(
name|ns_controls_t
modifier|*
name|controls
parameter_list|)
block|{
name|controllistener_t
modifier|*
name|listener
decl_stmt|;
name|controllistener_t
modifier|*
name|next
decl_stmt|;
for|for
control|(
name|listener
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|controls
operator|->
name|listeners
argument_list|)
init|;
name|listener
operator|!=
name|NULL
condition|;
name|listener
operator|=
name|next
control|)
block|{
comment|/* 		 * This is asynchronous.  As listeners shut down, they will 		 * call their callbacks. 		 */
name|next
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|shutdown_listener
argument_list|(
name|listener
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ns_controls_shutdown
parameter_list|(
name|ns_controls_t
modifier|*
name|controls
parameter_list|)
block|{
name|controls_shutdown
argument_list|(
name|controls
argument_list|)
expr_stmt|;
name|controls
operator|->
name|shuttingdown
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|cfgkeylist_find
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|keylist
parameter_list|,
specifier|const
name|char
modifier|*
name|keyname
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|objp
parameter_list|)
block|{
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|keylist
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
name|obj
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_map_getname
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
name|keyname
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|element
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
name|obj
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
operator|*
name|objp
operator|=
name|obj
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|controlkeylist_fromcfg
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|keylist
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|controlkeylist_t
modifier|*
name|keyids
parameter_list|)
block|{
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
name|char
modifier|*
name|newstr
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|;
name|controlkey_t
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|keylist
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
name|obj
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|newstr
operator|=
name|isc_mem_strdup
argument_list|(
name|mctx
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|newstr
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
name|key
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
name|key
operator|->
name|keyname
operator|=
name|newstr
expr_stmt|;
name|key
operator|->
name|secret
operator|.
name|base
operator|=
name|NULL
expr_stmt|;
name|key
operator|->
name|secret
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
operator|*
name|keyids
argument_list|,
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|key
operator|=
name|NULL
expr_stmt|;
name|newstr
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|newstr
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|newstr
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|key
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|free_controlkeylist
argument_list|(
name|keyids
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|register_keys
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|control
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|keylist
parameter_list|,
name|controlkeylist_t
modifier|*
name|keyids
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
specifier|const
name|char
modifier|*
name|socktext
parameter_list|)
block|{
name|controlkey_t
modifier|*
name|keyid
decl_stmt|,
modifier|*
name|next
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|keydef
decl_stmt|;
name|char
name|secret
index|[
literal|1024
index|]
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
comment|/* 	 * Find the keys corresponding to the keyids used by this listener. 	 */
for|for
control|(
name|keyid
operator|=
name|ISC_LIST_HEAD
argument_list|(
operator|*
name|keyids
argument_list|)
init|;
name|keyid
operator|!=
name|NULL
condition|;
name|keyid
operator|=
name|next
control|)
block|{
name|next
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|keyid
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|result
operator|=
name|cfgkeylist_find
argument_list|(
name|keylist
argument_list|,
name|keyid
operator|->
name|keyname
argument_list|,
operator|&
name|keydef
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|control
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't find key '%s' for use with "
literal|"command channel %s"
argument_list|,
name|keyid
operator|->
name|keyname
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
operator|*
name|keyids
argument_list|,
name|keyid
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free_controlkey
argument_list|(
name|keyid
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|algobj
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|secretobj
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|algstr
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|secretstr
init|=
name|NULL
decl_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|keydef
argument_list|,
literal|"algorithm"
argument_list|,
operator|&
name|algobj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|keydef
argument_list|,
literal|"secret"
argument_list|,
operator|&
name|secretobj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|algobj
operator|!=
name|NULL
operator|&&
name|secretobj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|algstr
operator|=
name|cfg_obj_asstring
argument_list|(
name|algobj
argument_list|)
expr_stmt|;
name|secretstr
operator|=
name|cfg_obj_asstring
argument_list|(
name|secretobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|ns_config_getkeyalgorithm
argument_list|(
name|algstr
argument_list|,
name|NULL
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|control
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"unsupported algorithm '%s' in "
literal|"key '%s' for use with command "
literal|"channel %s"
argument_list|,
name|algstr
argument_list|,
name|keyid
operator|->
name|keyname
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
operator|*
name|keyids
argument_list|,
name|keyid
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free_controlkey
argument_list|(
name|keyid
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|secret
argument_list|,
sizeof|sizeof
argument_list|(
name|secret
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_base64_decodestring
argument_list|(
name|secretstr
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|keydef
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"secret for key '%s' on "
literal|"command channel %s: %s"
argument_list|,
name|keyid
operator|->
name|keyname
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
operator|*
name|keyids
argument_list|,
name|keyid
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free_controlkey
argument_list|(
name|keyid
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|keyid
operator|->
name|secret
operator|.
name|length
operator|=
name|isc_buffer_usedlength
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
name|keyid
operator|->
name|secret
operator|.
name|base
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|keyid
operator|->
name|secret
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|keyid
operator|->
name|secret
operator|.
name|base
operator|==
name|NULL
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|keydef
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't register key '%s': "
literal|"out of memory"
argument_list|,
name|keyid
operator|->
name|keyname
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
operator|*
name|keyids
argument_list|,
name|keyid
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free_controlkey
argument_list|(
name|keyid
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
break|break;
block|}
name|memcpy
argument_list|(
name|keyid
operator|->
name|secret
operator|.
name|base
argument_list|,
name|isc_buffer_base
argument_list|(
operator|&
name|b
argument_list|)
argument_list|,
name|keyid
operator|->
name|secret
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_define
define|#
directive|define
name|CHECK
parameter_list|(
name|x
parameter_list|)
define|\
value|do { \ 		 result = (x); \ 		 if (result != ISC_R_SUCCESS) \ 			goto cleanup; \ 	} while (0)
end_define

begin_function
specifier|static
name|isc_result_t
name|get_rndckey
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|controlkeylist_t
modifier|*
name|keyids
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|cfg_parser_t
modifier|*
name|pctx
init|=
name|NULL
decl_stmt|;
name|cfg_obj_t
modifier|*
name|config
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|algobj
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|secretobj
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|algstr
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|secretstr
init|=
name|NULL
decl_stmt|;
name|controlkey_t
modifier|*
name|keyid
init|=
name|NULL
decl_stmt|;
name|char
name|secret
index|[
literal|1024
index|]
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|CHECK
argument_list|(
name|cfg_parser_create
argument_list|(
name|mctx
argument_list|,
name|ns_g_lctx
argument_list|,
operator|&
name|pctx
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|cfg_parse_file
argument_list|(
name|pctx
argument_list|,
name|ns_g_keyfile
argument_list|,
operator|&
name|cfg_type_rndckey
argument_list|,
operator|&
name|config
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"key"
argument_list|,
operator|&
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|keyid
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|keyid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|keyid
operator|==
name|NULL
condition|)
name|CHECK
argument_list|(
name|ISC_R_NOMEMORY
argument_list|)
expr_stmt|;
name|keyid
operator|->
name|keyname
operator|=
name|isc_mem_strdup
argument_list|(
name|mctx
argument_list|,
name|cfg_obj_asstring
argument_list|(
name|cfg_map_getname
argument_list|(
name|key
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|keyid
operator|->
name|secret
operator|.
name|base
operator|=
name|NULL
expr_stmt|;
name|keyid
operator|->
name|secret
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|keyid
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|keyid
operator|->
name|keyname
operator|==
name|NULL
condition|)
name|CHECK
argument_list|(
name|ISC_R_NOMEMORY
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|bind9_check_key
argument_list|(
name|key
argument_list|,
name|ns_g_lctx
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|key
argument_list|,
literal|"algorithm"
argument_list|,
operator|&
name|algobj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|key
argument_list|,
literal|"secret"
argument_list|,
operator|&
name|secretobj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|algobj
operator|!=
name|NULL
operator|&&
name|secretobj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|algstr
operator|=
name|cfg_obj_asstring
argument_list|(
name|algobj
argument_list|)
expr_stmt|;
name|secretstr
operator|=
name|cfg_obj_asstring
argument_list|(
name|secretobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|ns_config_getkeyalgorithm
argument_list|(
name|algstr
argument_list|,
name|NULL
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|key
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"unsupported algorithm '%s' in "
literal|"key '%s' for use with command "
literal|"channel"
argument_list|,
name|algstr
argument_list|,
name|keyid
operator|->
name|keyname
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|secret
argument_list|,
sizeof|sizeof
argument_list|(
name|secret
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_base64_decodestring
argument_list|(
name|secretstr
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|key
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"secret for key '%s' on command channel: %s"
argument_list|,
name|keyid
operator|->
name|keyname
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
name|keyid
operator|->
name|secret
operator|.
name|length
operator|=
name|isc_buffer_usedlength
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
name|keyid
operator|->
name|secret
operator|.
name|base
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|keyid
operator|->
name|secret
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|keyid
operator|->
name|secret
operator|.
name|base
operator|==
name|NULL
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|key
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't register key '%s': "
literal|"out of memory"
argument_list|,
name|keyid
operator|->
name|keyname
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ISC_R_NOMEMORY
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|keyid
operator|->
name|secret
operator|.
name|base
argument_list|,
name|isc_buffer_base
argument_list|(
operator|&
name|b
argument_list|)
argument_list|,
name|keyid
operator|->
name|secret
operator|.
name|length
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
operator|*
name|keyids
argument_list|,
name|keyid
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|keyid
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|keyid
operator|!=
name|NULL
condition|)
name|free_controlkey
argument_list|(
name|keyid
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|!=
name|NULL
condition|)
name|cfg_obj_destroy
argument_list|(
name|pctx
argument_list|,
operator|&
name|config
argument_list|)
expr_stmt|;
if|if
condition|(
name|pctx
operator|!=
name|NULL
condition|)
name|cfg_parser_destroy
argument_list|(
operator|&
name|pctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Ensures that both '*global_keylistp' and '*control_keylistp' are  * valid or both are NULL.  */
end_comment

begin_function
specifier|static
name|void
name|get_key_info
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|control
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|global_keylistp
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|control_keylistp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|control_keylist
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|global_keylist
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|global_keylistp
operator|!=
name|NULL
operator|&&
operator|*
name|global_keylistp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|control_keylistp
operator|!=
name|NULL
operator|&&
operator|*
name|control_keylistp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|control_keylist
operator|=
name|cfg_tuple_get
argument_list|(
name|control
argument_list|,
literal|"keys"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cfg_obj_isvoid
argument_list|(
name|control_keylist
argument_list|)
operator|&&
name|cfg_list_first
argument_list|(
name|control_keylist
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"key"
argument_list|,
operator|&
name|global_keylist
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
operator|*
name|global_keylistp
operator|=
name|global_keylist
expr_stmt|;
operator|*
name|control_keylistp
operator|=
name|control_keylist
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|update_listener
parameter_list|(
name|ns_controls_t
modifier|*
name|cp
parameter_list|,
name|controllistener_t
modifier|*
modifier|*
name|listenerp
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|control
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|,
name|ns_aclconfctx_t
modifier|*
name|aclconfctx
parameter_list|,
specifier|const
name|char
modifier|*
name|socktext
parameter_list|)
block|{
name|controllistener_t
modifier|*
name|listener
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|allow
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|global_keylist
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|control_keylist
init|=
name|NULL
decl_stmt|;
name|dns_acl_t
modifier|*
name|new_acl
init|=
name|NULL
decl_stmt|;
name|controlkeylist_t
name|keys
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
for|for
control|(
name|listener
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|cp
operator|->
name|listeners
argument_list|)
init|;
name|listener
operator|!=
name|NULL
condition|;
name|listener
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|listener
argument_list|,
name|link
argument_list|)
control|)
if|if
condition|(
name|isc_sockaddr_equal
argument_list|(
name|addr
argument_list|,
operator|&
name|listener
operator|->
name|address
argument_list|)
condition|)
break|break;
if|if
condition|(
name|listener
operator|==
name|NULL
condition|)
block|{
operator|*
name|listenerp
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
comment|/* 	 * There is already a listener for this sockaddr. 	 * Update the access list and key information. 	 * 	 * First try to deal with the key situation.  There are a few 	 * possibilities: 	 *  (a)	It had an explicit keylist and still has an explicit keylist. 	 *  (b)	It had an automagic key and now has an explicit keylist. 	 *  (c)	It had an explicit keylist and now needs an automagic key. 	 *  (d) It has an automagic key and still needs the automagic key. 	 * 	 * (c) and (d) are the annoying ones.  The caller needs to know 	 * that it should use the automagic configuration for key information 	 * in place of the named.conf configuration. 	 * 	 * XXXDCL There is one other hazard that has not been dealt with, 	 * the problem that if a key change is being caused by a control 	 * channel reload, then the response will be with the new key 	 * and not able to be decrypted by the client. 	 */
if|if
condition|(
name|control
operator|!=
name|NULL
condition|)
name|get_key_info
argument_list|(
name|config
argument_list|,
name|control
argument_list|,
operator|&
name|global_keylist
argument_list|,
operator|&
name|control_keylist
argument_list|)
expr_stmt|;
if|if
condition|(
name|control_keylist
operator|!=
name|NULL
condition|)
block|{
name|INSIST
argument_list|(
name|global_keylist
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|keys
argument_list|)
expr_stmt|;
name|result
operator|=
name|controlkeylist_fromcfg
argument_list|(
name|control_keylist
argument_list|,
name|listener
operator|->
name|mctx
argument_list|,
operator|&
name|keys
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|free_controlkeylist
argument_list|(
operator|&
name|listener
operator|->
name|keys
argument_list|,
name|listener
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|listener
operator|->
name|keys
operator|=
name|keys
expr_stmt|;
name|register_keys
argument_list|(
name|control
argument_list|,
name|global_keylist
argument_list|,
operator|&
name|listener
operator|->
name|keys
argument_list|,
name|listener
operator|->
name|mctx
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|free_controlkeylist
argument_list|(
operator|&
name|listener
operator|->
name|keys
argument_list|,
name|listener
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|result
operator|=
name|get_rndckey
argument_list|(
name|listener
operator|->
name|mctx
argument_list|,
operator|&
name|listener
operator|->
name|keys
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|global_keylist
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * This message might be a little misleading since the 		 * "new keys" might in fact be identical to the old ones, 		 * but tracking whether they are identical just for the 		 * sake of avoiding this message would be too much trouble. 		 */
if|if
condition|(
name|control
operator|!=
name|NULL
condition|)
name|cfg_obj_log
argument_list|(
name|control
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't install new keys for "
literal|"command channel %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_CONTROL
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't install new keys for "
literal|"command channel %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Now, keep the old access list unless a new one can be made. 	 */
if|if
condition|(
name|control
operator|!=
name|NULL
condition|)
block|{
name|allow
operator|=
name|cfg_tuple_get
argument_list|(
name|control
argument_list|,
literal|"allow"
argument_list|)
expr_stmt|;
name|result
operator|=
name|ns_acl_fromconfig
argument_list|(
name|allow
argument_list|,
name|config
argument_list|,
name|aclconfctx
argument_list|,
name|listener
operator|->
name|mctx
argument_list|,
operator|&
name|new_acl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|dns_acl_any
argument_list|(
name|listener
operator|->
name|mctx
argument_list|,
operator|&
name|new_acl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_acl_detach
argument_list|(
operator|&
name|listener
operator|->
name|acl
argument_list|)
expr_stmt|;
name|dns_acl_attach
argument_list|(
name|new_acl
argument_list|,
operator|&
name|listener
operator|->
name|acl
argument_list|)
expr_stmt|;
name|dns_acl_detach
argument_list|(
operator|&
name|new_acl
argument_list|)
expr_stmt|;
comment|/* XXXDCL say the old acl is still used? */
block|}
elseif|else
if|if
condition|(
name|control
operator|!=
name|NULL
condition|)
name|cfg_obj_log
argument_list|(
name|control
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't install new acl for "
literal|"command channel %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_CONTROL
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't install new acl for "
literal|"command channel %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|listenerp
operator|=
name|listener
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_listener
parameter_list|(
name|ns_controls_t
modifier|*
name|cp
parameter_list|,
name|controllistener_t
modifier|*
modifier|*
name|listenerp
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|control
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|,
name|ns_aclconfctx_t
modifier|*
name|aclconfctx
parameter_list|,
specifier|const
name|char
modifier|*
name|socktext
parameter_list|)
block|{
name|isc_mem_t
modifier|*
name|mctx
init|=
name|cp
operator|->
name|server
operator|->
name|mctx
decl_stmt|;
name|controllistener_t
modifier|*
name|listener
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|allow
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|global_keylist
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|control_keylist
init|=
name|NULL
decl_stmt|;
name|dns_acl_t
modifier|*
name|new_acl
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|listener
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|listener
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|listener
operator|==
name|NULL
condition|)
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|listener
operator|->
name|controls
operator|=
name|cp
expr_stmt|;
name|listener
operator|->
name|mctx
operator|=
name|mctx
expr_stmt|;
name|listener
operator|->
name|task
operator|=
name|cp
operator|->
name|server
operator|->
name|task
expr_stmt|;
name|listener
operator|->
name|address
operator|=
operator|*
name|addr
expr_stmt|;
name|listener
operator|->
name|sock
operator|=
name|NULL
expr_stmt|;
name|listener
operator|->
name|listening
operator|=
name|ISC_FALSE
expr_stmt|;
name|listener
operator|->
name|exiting
operator|=
name|ISC_FALSE
expr_stmt|;
name|listener
operator|->
name|acl
operator|=
name|NULL
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|listener
operator|->
name|keys
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|listener
operator|->
name|connections
argument_list|)
expr_stmt|;
comment|/* 		 * Make the acl. 		 */
if|if
condition|(
name|control
operator|!=
name|NULL
condition|)
block|{
name|allow
operator|=
name|cfg_tuple_get
argument_list|(
name|control
argument_list|,
literal|"allow"
argument_list|)
expr_stmt|;
name|result
operator|=
name|ns_acl_fromconfig
argument_list|(
name|allow
argument_list|,
name|config
argument_list|,
name|aclconfctx
argument_list|,
name|mctx
argument_list|,
operator|&
name|new_acl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|dns_acl_any
argument_list|(
name|mctx
argument_list|,
operator|&
name|new_acl
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_acl_attach
argument_list|(
name|new_acl
argument_list|,
operator|&
name|listener
operator|->
name|acl
argument_list|)
expr_stmt|;
name|dns_acl_detach
argument_list|(
operator|&
name|new_acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|!=
name|NULL
condition|)
name|get_key_info
argument_list|(
name|config
argument_list|,
name|control
argument_list|,
operator|&
name|global_keylist
argument_list|,
operator|&
name|control_keylist
argument_list|)
expr_stmt|;
if|if
condition|(
name|control_keylist
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|controlkeylist_fromcfg
argument_list|(
name|control_keylist
argument_list|,
name|listener
operator|->
name|mctx
argument_list|,
operator|&
name|listener
operator|->
name|keys
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|register_keys
argument_list|(
name|control
argument_list|,
name|global_keylist
argument_list|,
operator|&
name|listener
operator|->
name|keys
argument_list|,
name|listener
operator|->
name|mctx
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
block|}
else|else
name|result
operator|=
name|get_rndckey
argument_list|(
name|mctx
argument_list|,
operator|&
name|listener
operator|->
name|keys
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|control
operator|!=
name|NULL
condition|)
name|cfg_obj_log
argument_list|(
name|control
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't install keys for "
literal|"command channel %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|int
name|pf
init|=
name|isc_sockaddr_pf
argument_list|(
operator|&
name|listener
operator|->
name|address
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|pf
operator|==
name|AF_INET
operator|&&
name|isc_net_probeipv4
argument_list|()
operator|!=
name|ISC_R_SUCCESS
operator|)
operator|||
operator|(
name|pf
operator|==
name|AF_INET6
operator|&&
name|isc_net_probeipv6
argument_list|()
operator|!=
name|ISC_R_SUCCESS
operator|)
condition|)
name|result
operator|=
name|ISC_R_FAMILYNOSUPPORT
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|isc_socket_create
argument_list|(
name|ns_g_socketmgr
argument_list|,
name|isc_sockaddr_pf
argument_list|(
operator|&
name|listener
operator|->
name|address
argument_list|)
argument_list|,
name|isc_sockettype_tcp
argument_list|,
operator|&
name|listener
operator|->
name|sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|isc_socket_bind
argument_list|(
name|listener
operator|->
name|sock
argument_list|,
operator|&
name|listener
operator|->
name|address
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|control_listen
argument_list|(
name|listener
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|control_accept
argument_list|(
name|listener
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_CONTROL
argument_list|,
name|ISC_LOG_NOTICE
argument_list|,
literal|"command channel listening on %s"
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
operator|*
name|listenerp
operator|=
name|listener
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|listener
operator|!=
name|NULL
condition|)
block|{
name|listener
operator|->
name|exiting
operator|=
name|ISC_TRUE
expr_stmt|;
name|free_listener
argument_list|(
name|listener
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|control
operator|!=
name|NULL
condition|)
name|cfg_obj_log
argument_list|(
name|control
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"couldn't add command channel %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_CONTROL
argument_list|,
name|ISC_LOG_NOTICE
argument_list|,
literal|"couldn't add command channel %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|listenerp
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* XXXDCL return error results? fail hard? */
block|}
end_function

begin_function
name|isc_result_t
name|ns_controls_configure
parameter_list|(
name|ns_controls_t
modifier|*
name|cp
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|ns_aclconfctx_t
modifier|*
name|aclconfctx
parameter_list|)
block|{
name|controllistener_t
modifier|*
name|listener
decl_stmt|;
name|controllistenerlist_t
name|new_listeners
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|controlslist
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|,
modifier|*
name|element2
decl_stmt|;
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|new_listeners
argument_list|)
expr_stmt|;
comment|/* 	 * Get the list of named.conf 'controls' statements. 	 */
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"controls"
argument_list|,
operator|&
name|controlslist
argument_list|)
expr_stmt|;
comment|/* 	 * Run through the new control channel list, noting sockets that 	 * are already being listened on and moving them to the new list. 	 * 	 * Identifying duplicate addr/port combinations is left to either 	 * the underlying config code, or to the bind attempt getting an 	 * address-in-use error. 	 */
if|if
condition|(
name|controlslist
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|controlslist
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|controls
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|inetcontrols
init|=
name|NULL
decl_stmt|;
name|controls
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|controls
argument_list|,
literal|"inet"
argument_list|,
operator|&
name|inetcontrols
argument_list|)
expr_stmt|;
if|if
condition|(
name|inetcontrols
operator|==
name|NULL
condition|)
continue|continue;
for|for
control|(
name|element2
operator|=
name|cfg_list_first
argument_list|(
name|inetcontrols
argument_list|)
init|;
name|element2
operator|!=
name|NULL
condition|;
name|element2
operator|=
name|cfg_list_next
argument_list|(
name|element2
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|control
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|;
name|isc_sockaddr_t
name|addr
decl_stmt|;
comment|/* 				 * The parser handles BIND 8 configuration file 				 * syntax, so it allows unix phrases as well 				 * inet phrases with no keys{} clause. 				 * 				 * "unix" phrases have been reported as 				 * unsupported by the parser. 				 */
name|control
operator|=
name|cfg_listelt_value
argument_list|(
name|element2
argument_list|)
expr_stmt|;
name|obj
operator|=
name|cfg_tuple_get
argument_list|(
name|control
argument_list|,
literal|"address"
argument_list|)
expr_stmt|;
name|addr
operator|=
operator|*
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_sockaddr_getport
argument_list|(
operator|&
name|addr
argument_list|)
operator|==
literal|0
condition|)
name|isc_sockaddr_setport
argument_list|(
operator|&
name|addr
argument_list|,
name|NS_CONTROL_PORT
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|addr
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_CONTROL
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|9
argument_list|)
argument_list|,
literal|"processing control channel %s"
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
name|update_listener
argument_list|(
name|cp
argument_list|,
operator|&
name|listener
argument_list|,
name|control
argument_list|,
name|config
argument_list|,
operator|&
name|addr
argument_list|,
name|aclconfctx
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
if|if
condition|(
name|listener
operator|!=
name|NULL
condition|)
comment|/* 					 * Remove the listener from the old 					 * list, so it won't be shut down. 					 */
name|ISC_LIST_UNLINK
argument_list|(
name|cp
operator|->
name|listeners
argument_list|,
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
else|else
comment|/* 					 * This is a new listener. 					 */
name|add_listener
argument_list|(
name|cp
argument_list|,
operator|&
name|listener
argument_list|,
name|control
argument_list|,
name|config
argument_list|,
operator|&
name|addr
argument_list|,
name|aclconfctx
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
if|if
condition|(
name|listener
operator|!=
name|NULL
condition|)
name|ISC_LIST_APPEND
argument_list|(
name|new_listeners
argument_list|,
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|isc_sockaddr_t
name|addr
decl_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|struct
name|in_addr
name|localhost
decl_stmt|;
if|if
condition|(
name|isc_net_probeipv4
argument_list|()
operator|!=
name|ISC_R_SUCCESS
condition|)
continue|continue;
name|localhost
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|INADDR_LOOPBACK
argument_list|)
expr_stmt|;
name|isc_sockaddr_fromin
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|localhost
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|isc_net_probeipv6
argument_list|()
operator|!=
name|ISC_R_SUCCESS
condition|)
continue|continue;
name|isc_sockaddr_fromin6
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|in6addr_loopback
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|isc_sockaddr_setport
argument_list|(
operator|&
name|addr
argument_list|,
name|NS_CONTROL_PORT
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|addr
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|update_listener
argument_list|(
name|cp
argument_list|,
operator|&
name|listener
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|addr
argument_list|,
name|NULL
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
if|if
condition|(
name|listener
operator|!=
name|NULL
condition|)
comment|/* 				 * Remove the listener from the old 				 * list, so it won't be shut down. 				 */
name|ISC_LIST_UNLINK
argument_list|(
name|cp
operator|->
name|listeners
argument_list|,
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
else|else
comment|/* 				 * This is a new listener. 				 */
name|add_listener
argument_list|(
name|cp
argument_list|,
operator|&
name|listener
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|addr
argument_list|,
name|NULL
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
if|if
condition|(
name|listener
operator|!=
name|NULL
condition|)
name|ISC_LIST_APPEND
argument_list|(
name|new_listeners
argument_list|,
name|listener
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * ns_control_shutdown() will stop whatever is on the global 	 * listeners list, which currently only has whatever sockaddrs 	 * were in the previous configuration (if any) that do not 	 * remain in the current configuration. 	 */
name|controls_shutdown
argument_list|(
name|cp
argument_list|)
expr_stmt|;
comment|/* 	 * Put all of the valid listeners on the listeners list. 	 * Anything already on listeners in the process of shutting 	 * down will be taken care of by listen_done(). 	 */
name|ISC_LIST_APPENDLIST
argument_list|(
name|cp
operator|->
name|listeners
argument_list|,
name|new_listeners
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_controls_create
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|ns_controls_t
modifier|*
modifier|*
name|ctrlsp
parameter_list|)
block|{
name|isc_mem_t
modifier|*
name|mctx
init|=
name|server
operator|->
name|mctx
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|ns_controls_t
modifier|*
name|controls
init|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|controls
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|controls
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|controls
operator|->
name|server
operator|=
name|server
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|controls
operator|->
name|listeners
argument_list|)
expr_stmt|;
name|controls
operator|->
name|shuttingdown
operator|=
name|ISC_FALSE
expr_stmt|;
name|controls
operator|->
name|symtab
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isccc_cc_createsymtab
argument_list|(
operator|&
name|controls
operator|->
name|symtab
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
name|controls
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|controls
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
operator|*
name|ctrlsp
operator|=
name|controls
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ns_controls_destroy
parameter_list|(
name|ns_controls_t
modifier|*
modifier|*
name|ctrlsp
parameter_list|)
block|{
name|ns_controls_t
modifier|*
name|controls
init|=
operator|*
name|ctrlsp
decl_stmt|;
name|REQUIRE
argument_list|(
name|ISC_LIST_EMPTY
argument_list|(
name|controls
operator|->
name|listeners
argument_list|)
argument_list|)
expr_stmt|;
name|isccc_symtab_destroy
argument_list|(
operator|&
name|controls
operator|->
name|symtab
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|controls
operator|->
name|server
operator|->
name|mctx
argument_list|,
name|controls
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|controls
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|ctrlsp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004-2006  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: zoneconf.c,v 1.87.2.4.10.19 2006/02/28 06:32:53 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_include
include|#
directive|include
file|<isc/file.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_comment
comment|/* Required for HP/UX (and others?) */
end_comment

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/acl.h>
end_include

begin_include
include|#
directive|include
file|<dns/fixedname.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/name.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatatype.h>
end_include

begin_include
include|#
directive|include
file|<dns/ssu.h>
end_include

begin_include
include|#
directive|include
file|<dns/view.h>
end_include

begin_include
include|#
directive|include
file|<dns/zone.h>
end_include

begin_include
include|#
directive|include
file|<named/config.h>
end_include

begin_include
include|#
directive|include
file|<named/globals.h>
end_include

begin_include
include|#
directive|include
file|<named/log.h>
end_include

begin_include
include|#
directive|include
file|<named/server.h>
end_include

begin_include
include|#
directive|include
file|<named/zoneconf.h>
end_include

begin_comment
comment|/*  * These are BIND9 server defaults, not necessarily identical to the  * library defaults defined in zone.c.  */
end_comment

begin_define
define|#
directive|define
name|RETERR
parameter_list|(
name|x
parameter_list|)
value|do { \ 	isc_result_t _r = (x); \ 	if (_r != ISC_R_SUCCESS) \ 		return (_r); \ 	} while (0)
end_define

begin_comment
comment|/*  * Convenience function for configuring a single zone ACL.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|configure_zone_acl
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|vconfig
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
specifier|const
name|char
modifier|*
name|aclname
parameter_list|,
name|ns_aclconfctx_t
modifier|*
name|actx
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|void
function_decl|(
modifier|*
name|setzacl
function_decl|)
parameter_list|(
name|dns_zone_t
modifier|*
parameter_list|,
name|dns_acl_t
modifier|*
parameter_list|)
parameter_list|,
name|void
function_decl|(
modifier|*
name|clearzacl
function_decl|)
parameter_list|(
name|dns_zone_t
modifier|*
parameter_list|)
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|maps
index|[
literal|4
index|]
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|aclobj
init|=
name|NULL
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|dns_acl_t
modifier|*
name|dacl
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|zconfig
operator|!=
name|NULL
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|cfg_tuple_get
argument_list|(
name|zconfig
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vconfig
operator|!=
name|NULL
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|cfg_tuple_get
argument_list|(
name|vconfig
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|options
init|=
name|NULL
decl_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"options"
argument_list|,
operator|&
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|!=
name|NULL
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|options
expr_stmt|;
block|}
name|maps
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
name|aclname
argument_list|,
operator|&
name|aclobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|aclobj
operator|==
name|NULL
condition|)
block|{
call|(
modifier|*
name|clearzacl
call|)
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
name|result
operator|=
name|ns_acl_fromconfig
argument_list|(
name|aclobj
argument_list|,
name|config
argument_list|,
name|actx
argument_list|,
name|dns_zone_getmctx
argument_list|(
name|zone
argument_list|)
argument_list|,
operator|&
name|dacl
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
call|(
modifier|*
name|setzacl
call|)
argument_list|(
name|zone
argument_list|,
name|dacl
argument_list|)
expr_stmt|;
name|dns_acl_detach
argument_list|(
operator|&
name|dacl
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Parse the zone update-policy statement.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|configure_zone_ssutable
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|updatepolicy
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|,
modifier|*
name|element2
decl_stmt|;
name|dns_ssutable_t
modifier|*
name|table
init|=
name|NULL
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
init|=
name|dns_zone_getmctx
argument_list|(
name|zone
argument_list|)
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|zconfig
argument_list|,
literal|"update-policy"
argument_list|,
operator|&
name|updatepolicy
argument_list|)
expr_stmt|;
if|if
condition|(
name|updatepolicy
operator|==
name|NULL
condition|)
block|{
name|dns_zone_setssutable
argument_list|(
name|zone
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
name|result
operator|=
name|dns_ssutable_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|table
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|updatepolicy
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|stmt
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|mode
init|=
name|cfg_tuple_get
argument_list|(
name|stmt
argument_list|,
literal|"mode"
argument_list|)
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|identity
init|=
name|cfg_tuple_get
argument_list|(
name|stmt
argument_list|,
literal|"identity"
argument_list|)
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|matchtype
init|=
name|cfg_tuple_get
argument_list|(
name|stmt
argument_list|,
literal|"matchtype"
argument_list|)
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|dname
init|=
name|cfg_tuple_get
argument_list|(
name|stmt
argument_list|,
literal|"name"
argument_list|)
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|typelist
init|=
name|cfg_tuple_get
argument_list|(
name|stmt
argument_list|,
literal|"types"
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|isc_boolean_t
name|grant
init|=
name|ISC_FALSE
decl_stmt|;
name|unsigned
name|int
name|mtype
init|=
name|DNS_SSUMATCHTYPE_NAME
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|,
name|fident
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_rdatatype_t
modifier|*
name|types
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"grant"
argument_list|)
operator|==
literal|0
condition|)
name|grant
operator|=
name|ISC_TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"deny"
argument_list|)
operator|==
literal|0
condition|)
name|grant
operator|=
name|ISC_FALSE
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|matchtype
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"name"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_NAME
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"subdomain"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_SUBDOMAIN
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"wildcard"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_WILDCARD
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"self"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_SELF
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fident
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|identity
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fident
argument_list|)
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|identity
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"'%s' is not a valid name"
argument_list|,
name|str
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|dname
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|identity
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"'%s' is not a valid name"
argument_list|,
name|str
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|n
operator|=
name|ns_config_listcount
argument_list|(
name|typelist
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
name|types
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|types
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|n
operator|*
sizeof|sizeof
argument_list|(
name|dns_rdatatype_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|types
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|element2
operator|=
name|cfg_list_first
argument_list|(
name|typelist
argument_list|)
init|;
name|element2
operator|!=
name|NULL
condition|;
name|element2
operator|=
name|cfg_list_next
argument_list|(
name|element2
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|typeobj
decl_stmt|;
name|isc_textregion_t
name|r
decl_stmt|;
name|INSIST
argument_list|(
name|i
operator|<
name|n
argument_list|)
expr_stmt|;
name|typeobj
operator|=
name|cfg_listelt_value
argument_list|(
name|element2
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|typeobj
argument_list|)
expr_stmt|;
name|DE_CONST
argument_list|(
name|str
argument_list|,
name|r
operator|.
name|base
argument_list|)
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatatype_fromtext
argument_list|(
operator|&
name|types
index|[
name|i
operator|++
index|]
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|identity
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"'%s' is not a valid type"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|types
argument_list|,
name|n
operator|*
sizeof|sizeof
argument_list|(
name|dns_rdatatype_t
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
name|INSIST
argument_list|(
name|i
operator|==
name|n
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_ssutable_addrule
argument_list|(
name|table
argument_list|,
name|grant
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fident
argument_list|)
argument_list|,
name|mtype
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
argument_list|,
name|n
argument_list|,
name|types
argument_list|)
expr_stmt|;
if|if
condition|(
name|types
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|types
argument_list|,
name|n
operator|*
sizeof|sizeof
argument_list|(
name|dns_rdatatype_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
goto|goto
name|cleanup
goto|;
block|}
block|}
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|dns_zone_setssutable
argument_list|(
name|zone
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|dns_ssutable_detach
argument_list|(
operator|&
name|table
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert a config file zone type into a server zone type.  */
end_comment

begin_function
specifier|static
specifier|inline
name|dns_zonetype_t
name|zonetype_fromconfig
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|map
parameter_list|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|map
argument_list|,
literal|"type"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
return|return
operator|(
name|ns_config_getzonetype
argument_list|(
name|obj
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Helper function for strtoargv().  Pardon the gratuitous recursion.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|strtoargvsub
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|char
modifier|*
name|s
parameter_list|,
name|unsigned
name|int
modifier|*
name|argcp
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|argvp
parameter_list|,
name|unsigned
name|int
name|n
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
comment|/* Discard leading whitespace. */
while|while
condition|(
operator|*
name|s
operator|==
literal|' '
operator|||
operator|*
name|s
operator|==
literal|'\t'
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|==
literal|'\0'
condition|)
block|{
comment|/* We have reached the end of the string. */
operator|*
name|argcp
operator|=
name|n
expr_stmt|;
operator|*
name|argvp
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|n
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|argvp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
else|else
block|{
name|char
modifier|*
name|p
init|=
name|s
decl_stmt|;
while|while
condition|(
operator|*
name|p
operator|!=
literal|' '
operator|&&
operator|*
name|p
operator|!=
literal|'\t'
operator|&&
operator|*
name|p
operator|!=
literal|'\0'
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|!=
literal|'\0'
condition|)
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|result
operator|=
name|strtoargvsub
argument_list|(
name|mctx
argument_list|,
name|p
argument_list|,
name|argcp
argument_list|,
name|argvp
argument_list|,
name|n
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
operator|(
operator|*
name|argvp
operator|)
index|[
name|n
index|]
operator|=
name|s
expr_stmt|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Tokenize the string "s" into whitespace-separated words,  * return the number of words in '*argcp' and an array  * of pointers to the words in '*argvp'.  The caller  * must free the array using isc_mem_put().  The string  * is modified in-place.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|strtoargv
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|char
modifier|*
name|s
parameter_list|,
name|unsigned
name|int
modifier|*
name|argcp
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|argvp
parameter_list|)
block|{
return|return
operator|(
name|strtoargvsub
argument_list|(
name|mctx
argument_list|,
name|s
argument_list|,
name|argcp
argument_list|,
name|argvp
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|checknames
parameter_list|(
name|dns_zonetype_t
name|ztype
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|maps
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|objp
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|zone
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
switch|switch
condition|(
name|ztype
condition|)
block|{
case|case
name|dns_zone_slave
case|:
name|zone
operator|=
literal|"slave"
expr_stmt|;
break|break;
case|case
name|dns_zone_master
case|:
name|zone
operator|=
literal|"master"
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|ns_checknames_get
argument_list|(
name|maps
argument_list|,
name|zone
argument_list|,
name|objp
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_zone_configure
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|vconfig
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
parameter_list|,
name|ns_aclconfctx_t
modifier|*
name|ac
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|char
modifier|*
name|zname
decl_stmt|;
name|dns_rdataclass_t
name|zclass
decl_stmt|;
name|dns_rdataclass_t
name|vclass
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|maps
index|[
literal|5
index|]
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|zoptions
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|options
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|;
specifier|const
name|char
modifier|*
name|filename
init|=
name|NULL
decl_stmt|;
name|dns_notifytype_t
name|notifytype
init|=
name|dns_notifytype_yes
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|addrs
decl_stmt|;
name|dns_name_t
modifier|*
modifier|*
name|keynames
decl_stmt|;
name|isc_uint32_t
name|count
decl_stmt|;
name|char
modifier|*
name|cpval
decl_stmt|;
name|unsigned
name|int
name|dbargc
decl_stmt|;
name|char
modifier|*
modifier|*
name|dbargv
decl_stmt|;
specifier|static
name|char
name|default_dbtype
index|[]
init|=
literal|"rbt"
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
init|=
name|dns_zone_getmctx
argument_list|(
name|zone
argument_list|)
decl_stmt|;
name|dns_dialuptype_t
name|dialup
init|=
name|dns_dialuptype_no
decl_stmt|;
name|dns_zonetype_t
name|ztype
decl_stmt|;
name|int
name|i
decl_stmt|;
name|isc_int32_t
name|journal_size
decl_stmt|;
name|isc_boolean_t
name|multi
decl_stmt|;
name|isc_boolean_t
name|alt
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|isc_boolean_t
name|check
init|=
name|ISC_FALSE
decl_stmt|,
name|fail
init|=
name|ISC_FALSE
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|zconfig
operator|!=
name|NULL
condition|)
block|{
name|zoptions
operator|=
name|cfg_tuple_get
argument_list|(
name|zconfig
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|zoptions
expr_stmt|;
block|}
if|if
condition|(
name|vconfig
operator|!=
name|NULL
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|cfg_tuple_get
argument_list|(
name|vconfig
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"options"
argument_list|,
operator|&
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|!=
name|NULL
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|options
expr_stmt|;
block|}
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|ns_g_defaults
expr_stmt|;
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|vconfig
operator|!=
name|NULL
condition|)
name|RETERR
argument_list|(
name|ns_config_getclass
argument_list|(
name|cfg_tuple_get
argument_list|(
name|vconfig
argument_list|,
literal|"class"
argument_list|)
argument_list|,
name|dns_rdataclass_in
argument_list|,
operator|&
name|vclass
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|vclass
operator|=
name|dns_rdataclass_in
expr_stmt|;
comment|/* 	 * Configure values common to all zone types. 	 */
name|zname
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|zconfig
argument_list|,
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|ns_config_getclass
argument_list|(
name|cfg_tuple_get
argument_list|(
name|zconfig
argument_list|,
literal|"class"
argument_list|)
argument_list|,
name|vclass
argument_list|,
operator|&
name|zclass
argument_list|)
argument_list|)
expr_stmt|;
name|dns_zone_setclass
argument_list|(
name|zone
argument_list|,
name|zclass
argument_list|)
expr_stmt|;
name|ztype
operator|=
name|zonetype_fromconfig
argument_list|(
name|zoptions
argument_list|)
expr_stmt|;
name|dns_zone_settype
argument_list|(
name|zone
argument_list|,
name|ztype
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"database"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|cpval
operator|=
name|isc_mem_strdup
argument_list|(
name|mctx
argument_list|,
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|cpval
operator|=
name|default_dbtype
expr_stmt|;
if|if
condition|(
name|cpval
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|result
operator|=
name|strtoargv
argument_list|(
name|mctx
argument_list|,
name|cpval
argument_list|,
operator|&
name|dbargc
argument_list|,
operator|&
name|dbargv
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|cpval
operator|!=
name|default_dbtype
condition|)
block|{
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|cpval
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 	 * ANSI C is strange here.  There is no logical reason why (char **) 	 * cannot be promoted automatically to (const char * const *) by the 	 * compiler w/o generating a warning. 	 */
name|result
operator|=
name|dns_zone_setdbtype
argument_list|(
name|zone
argument_list|,
name|dbargc
argument_list|,
operator|(
specifier|const
name|char
operator|*
specifier|const
operator|*
operator|)
name|dbargv
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|dbargv
argument_list|,
name|dbargc
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|dbargv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpval
operator|!=
name|default_dbtype
condition|)
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|cpval
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"file"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|filename
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setfile
argument_list|(
name|zone
argument_list|,
name|filename
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ztype
operator|==
name|dns_zone_slave
condition|)
name|RETERR
argument_list|(
name|configure_zone_acl
argument_list|(
name|zconfig
argument_list|,
name|vconfig
argument_list|,
name|config
argument_list|,
literal|"allow-notify"
argument_list|,
name|ac
argument_list|,
name|zone
argument_list|,
name|dns_zone_setnotifyacl
argument_list|,
name|dns_zone_clearnotifyacl
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * XXXAG This probably does not make sense for stubs. 	 */
name|RETERR
argument_list|(
name|configure_zone_acl
argument_list|(
name|zconfig
argument_list|,
name|vconfig
argument_list|,
name|config
argument_list|,
literal|"allow-query"
argument_list|,
name|ac
argument_list|,
name|zone
argument_list|,
name|dns_zone_setqueryacl
argument_list|,
name|dns_zone_clearqueryacl
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"dialup"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isboolean
argument_list|(
name|obj
argument_list|)
condition|)
block|{
if|if
condition|(
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
condition|)
name|dialup
operator|=
name|dns_dialuptype_yes
expr_stmt|;
else|else
name|dialup
operator|=
name|dns_dialuptype_no
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|dialupstr
init|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|dialupstr
argument_list|,
literal|"notify"
argument_list|)
operator|==
literal|0
condition|)
name|dialup
operator|=
name|dns_dialuptype_notify
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|dialupstr
argument_list|,
literal|"notify-passive"
argument_list|)
operator|==
literal|0
condition|)
name|dialup
operator|=
name|dns_dialuptype_notifypassive
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|dialupstr
argument_list|,
literal|"refresh"
argument_list|)
operator|==
literal|0
condition|)
name|dialup
operator|=
name|dns_dialuptype_refresh
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|dialupstr
argument_list|,
literal|"passive"
argument_list|)
operator|==
literal|0
condition|)
name|dialup
operator|=
name|dns_dialuptype_passive
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|dns_zone_setdialup
argument_list|(
name|zone
argument_list|,
name|dialup
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"zone-statistics"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setstatistics
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Configure master functionality.  This applies 	 * to primary masters (type "master") and slaves 	 * acting as masters (type "slave"), but not to stubs. 	 */
if|if
condition|(
name|ztype
operator|!=
name|dns_zone_stub
condition|)
block|{
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"notify"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isboolean
argument_list|(
name|obj
argument_list|)
condition|)
block|{
if|if
condition|(
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
condition|)
name|notifytype
operator|=
name|dns_notifytype_yes
expr_stmt|;
else|else
name|notifytype
operator|=
name|dns_notifytype_no
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|notifystr
init|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|notifystr
argument_list|,
literal|"explicit"
argument_list|)
operator|==
literal|0
condition|)
name|notifytype
operator|=
name|dns_notifytype_explicit
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|dns_zone_setnotifytype
argument_list|(
name|zone
argument_list|,
name|notifytype
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"also-notify"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_sockaddr_t
modifier|*
name|addrs
init|=
name|NULL
decl_stmt|;
name|isc_uint32_t
name|addrcount
decl_stmt|;
name|result
operator|=
name|ns_config_getiplist
argument_list|(
name|config
argument_list|,
name|obj
argument_list|,
literal|0
argument_list|,
name|mctx
argument_list|,
operator|&
name|addrs
argument_list|,
operator|&
name|addrcount
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_zone_setalsonotify
argument_list|(
name|zone
argument_list|,
name|addrs
argument_list|,
name|addrcount
argument_list|)
expr_stmt|;
name|ns_config_putiplist
argument_list|(
name|mctx
argument_list|,
operator|&
name|addrs
argument_list|,
name|addrcount
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
else|else
name|RETERR
argument_list|(
name|dns_zone_setalsonotify
argument_list|(
name|zone
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"notify-source"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setnotifysrc4
argument_list|(
name|zone
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ns_add_reserved_dispatch
argument_list|(
name|ns_g_server
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"notify-source-v6"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setnotifysrc6
argument_list|(
name|zone
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ns_add_reserved_dispatch
argument_list|(
name|ns_g_server
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|configure_zone_acl
argument_list|(
name|zconfig
argument_list|,
name|vconfig
argument_list|,
name|config
argument_list|,
literal|"allow-transfer"
argument_list|,
name|ac
argument_list|,
name|zone
argument_list|,
name|dns_zone_setxfracl
argument_list|,
name|dns_zone_clearxfracl
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-transfer-time-out"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zone_setmaxxfrout
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
operator|*
literal|60
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-transfer-idle-out"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zone_setidleout
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
operator|*
literal|60
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-journal-size"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zone_setjournalsize
argument_list|(
name|zone
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isstring
argument_list|(
name|obj
argument_list|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|str
init|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"unlimited"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|journal_size
operator|=
name|ISC_UINT32_MAX
operator|/
literal|2
expr_stmt|;
block|}
else|else
block|{
name|isc_resourcevalue_t
name|value
decl_stmt|;
name|value
operator|=
name|cfg_obj_asuint64
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|>
name|ISC_UINT32_MAX
operator|/
literal|2
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|obj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"'max-journal-size "
literal|"%"
name|ISC_PRINT_QUADFORMAT
literal|"d' "
literal|"is too large"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|ISC_R_RANGE
argument_list|)
expr_stmt|;
block|}
name|journal_size
operator|=
operator|(
name|isc_uint32_t
operator|)
name|value
expr_stmt|;
block|}
name|dns_zone_setjournalsize
argument_list|(
name|zone
argument_list|,
name|journal_size
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"ixfr-from-differences"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_IXFRFROMDIFFS
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|checknames
argument_list|(
name|ztype
argument_list|,
name|maps
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"warn"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fail
operator|=
name|ISC_FALSE
expr_stmt|;
name|check
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"fail"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fail
operator|=
name|check
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"ignore"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fail
operator|=
name|check
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNAMES
argument_list|,
name|check
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNAMESFAIL
argument_list|,
name|fail
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Configure update-related options.  These apply to 	 * primary masters only. 	 */
if|if
condition|(
name|ztype
operator|==
name|dns_zone_master
condition|)
block|{
name|dns_acl_t
modifier|*
name|updateacl
decl_stmt|;
name|RETERR
argument_list|(
name|configure_zone_acl
argument_list|(
name|zconfig
argument_list|,
name|vconfig
argument_list|,
name|config
argument_list|,
literal|"allow-update"
argument_list|,
name|ac
argument_list|,
name|zone
argument_list|,
name|dns_zone_setupdateacl
argument_list|,
name|dns_zone_clearupdateacl
argument_list|)
argument_list|)
expr_stmt|;
name|updateacl
operator|=
name|dns_zone_getupdateacl
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|updateacl
operator|!=
name|NULL
operator|&&
name|dns_acl_isinsecure
argument_list|(
name|updateacl
argument_list|)
condition|)
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|DNS_LOGCATEGORY_SECURITY
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"zone '%s' allows updates by IP "
literal|"address, which is insecure"
argument_list|,
name|zname
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|configure_zone_ssutable
argument_list|(
name|zoptions
argument_list|,
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"sig-validity-interval"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zone_setsigvalidityinterval
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
operator|*
literal|86400
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"key-directory"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|filename
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isc_file_isabsolute
argument_list|(
name|filename
argument_list|)
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|obj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"key-directory '%s' "
literal|"is not absolute"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
name|RETERR
argument_list|(
name|dns_zone_setkeydirectory
argument_list|(
name|zone
argument_list|,
name|filename
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ztype
operator|==
name|dns_zone_slave
condition|)
block|{
name|RETERR
argument_list|(
name|configure_zone_acl
argument_list|(
name|zconfig
argument_list|,
name|vconfig
argument_list|,
name|config
argument_list|,
literal|"allow-update-forwarding"
argument_list|,
name|ac
argument_list|,
name|zone
argument_list|,
name|dns_zone_setforwardacl
argument_list|,
name|dns_zone_clearforwardacl
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Configure slave functionality. 	 */
switch|switch
condition|(
name|ztype
condition|)
block|{
case|case
name|dns_zone_slave
case|:
case|case
name|dns_zone_stub
case|:
name|count
operator|=
literal|0
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"masters"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
block|{
name|addrs
operator|=
name|NULL
expr_stmt|;
name|keynames
operator|=
name|NULL
expr_stmt|;
name|RETERR
argument_list|(
name|ns_config_getipandkeylist
argument_list|(
name|config
argument_list|,
name|obj
argument_list|,
name|mctx
argument_list|,
operator|&
name|addrs
argument_list|,
operator|&
name|keynames
argument_list|,
operator|&
name|count
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_zone_setmasterswithkeys
argument_list|(
name|zone
argument_list|,
name|addrs
argument_list|,
name|keynames
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|ns_config_putipandkeylist
argument_list|(
name|mctx
argument_list|,
operator|&
name|addrs
argument_list|,
operator|&
name|keynames
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
else|else
name|result
operator|=
name|dns_zone_setmasters
argument_list|(
name|zone
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|multi
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|1
condition|)
block|{
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"multi-master"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|multi
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
block|}
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_MULTIMASTER
argument_list|,
name|multi
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-transfer-time-in"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zone_setmaxxfrin
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
operator|*
literal|60
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-transfer-idle-in"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zone_setidlein
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
operator|*
literal|60
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-refresh-time"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zone_setmaxrefreshtime
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"min-refresh-time"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zone_setminrefreshtime
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-retry-time"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zone_setmaxretrytime
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"min-retry-time"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zone_setminretrytime
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"transfer-source"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setxfrsource4
argument_list|(
name|zone
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ns_add_reserved_dispatch
argument_list|(
name|ns_g_server
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"transfer-source-v6"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setxfrsource6
argument_list|(
name|zone
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ns_add_reserved_dispatch
argument_list|(
name|ns_g_server
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"alt-transfer-source"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setaltxfrsource4
argument_list|(
name|zone
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"alt-transfer-source-v6"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setaltxfrsource6
argument_list|(
name|zone
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"use-alt-transfer-source"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|==
name|NULL
condition|)
block|{
comment|/* 			 * Default off when views are in use otherwise 			 * on for BIND 8 compatibility. 			 */
name|view
operator|=
name|dns_zone_getview
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|view
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
literal|"_default"
argument_list|)
operator|==
literal|0
condition|)
name|alt
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|alt
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
else|else
name|alt
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_USEALTXFRSRC
argument_list|,
name|alt
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_boolean_t
name|ns_zone_reusable
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
parameter_list|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|zoptions
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|cfilename
decl_stmt|;
specifier|const
name|char
modifier|*
name|zfilename
decl_stmt|;
name|zoptions
operator|=
name|cfg_tuple_get
argument_list|(
name|zconfig
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
if|if
condition|(
name|zonetype_fromconfig
argument_list|(
name|zoptions
argument_list|)
operator|!=
name|dns_zone_gettype
argument_list|(
name|zone
argument_list|)
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"file"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
name|cfilename
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
else|else
name|cfilename
operator|=
name|NULL
expr_stmt|;
name|zfilename
operator|=
name|dns_zone_getfile
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|(
name|cfilename
operator|==
name|NULL
operator|&&
name|zfilename
operator|==
name|NULL
operator|)
operator|||
operator|(
name|cfilename
operator|!=
name|NULL
operator|&&
name|zfilename
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|cfilename
argument_list|,
name|zfilename
argument_list|)
operator|==
literal|0
operator|)
operator|)
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004-2014  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id$ */
end_comment

begin_comment
comment|/*% */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_include
include|#
directive|include
file|<isc/file.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/stats.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_comment
comment|/* Required for HP/UX (and others?) */
end_comment

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/acl.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/fixedname.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/name.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdata.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatatype.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatalist.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/sdlz.h>
end_include

begin_include
include|#
directive|include
file|<dns/ssu.h>
end_include

begin_include
include|#
directive|include
file|<dns/stats.h>
end_include

begin_include
include|#
directive|include
file|<dns/view.h>
end_include

begin_include
include|#
directive|include
file|<dns/zone.h>
end_include

begin_include
include|#
directive|include
file|<named/client.h>
end_include

begin_include
include|#
directive|include
file|<named/config.h>
end_include

begin_include
include|#
directive|include
file|<named/globals.h>
end_include

begin_include
include|#
directive|include
file|<named/log.h>
end_include

begin_include
include|#
directive|include
file|<named/server.h>
end_include

begin_include
include|#
directive|include
file|<named/zoneconf.h>
end_include

begin_comment
comment|/* ACLs associated with zone */
end_comment

begin_typedef
typedef|typedef
enum|enum
block|{
name|allow_notify
block|,
name|allow_query
block|,
name|allow_query_on
block|,
name|allow_transfer
block|,
name|allow_update
block|,
name|allow_update_forwarding
block|}
name|acl_type_t
typedef|;
end_typedef

begin_define
define|#
directive|define
name|RETERR
parameter_list|(
name|x
parameter_list|)
value|do { \ 	isc_result_t _r = (x); \ 	if (_r != ISC_R_SUCCESS) \ 		return (_r); \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|CHECK
parameter_list|(
name|x
parameter_list|)
value|do { \ 	result = (x); \ 	if (result != ISC_R_SUCCESS) \ 		goto cleanup; \ 	} while (0)
end_define

begin_comment
comment|/*%  * Convenience function for configuring a single zone ACL.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|configure_zone_acl
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|vconfig
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|acl_type_t
name|acltype
parameter_list|,
name|cfg_aclconfctx_t
modifier|*
name|actx
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|void
function_decl|(
modifier|*
name|setzacl
function_decl|)
parameter_list|(
name|dns_zone_t
modifier|*
parameter_list|,
name|dns_acl_t
modifier|*
parameter_list|)
parameter_list|,
name|void
function_decl|(
modifier|*
name|clearzacl
function_decl|)
parameter_list|(
name|dns_zone_t
modifier|*
parameter_list|)
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|maps
index|[
literal|5
index|]
init|=
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|aclobj
init|=
name|NULL
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|dns_acl_t
modifier|*
modifier|*
name|aclp
init|=
name|NULL
decl_stmt|,
modifier|*
name|acl
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|aclname
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|view
operator|=
name|dns_zone_getview
argument_list|(
name|zone
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|acltype
condition|)
block|{
case|case
name|allow_notify
case|:
if|if
condition|(
name|view
operator|!=
name|NULL
condition|)
name|aclp
operator|=
operator|&
name|view
operator|->
name|notifyacl
expr_stmt|;
name|aclname
operator|=
literal|"allow-notify"
expr_stmt|;
break|break;
case|case
name|allow_query
case|:
if|if
condition|(
name|view
operator|!=
name|NULL
condition|)
name|aclp
operator|=
operator|&
name|view
operator|->
name|queryacl
expr_stmt|;
name|aclname
operator|=
literal|"allow-query"
expr_stmt|;
break|break;
case|case
name|allow_query_on
case|:
if|if
condition|(
name|view
operator|!=
name|NULL
condition|)
name|aclp
operator|=
operator|&
name|view
operator|->
name|queryonacl
expr_stmt|;
name|aclname
operator|=
literal|"allow-query-on"
expr_stmt|;
break|break;
case|case
name|allow_transfer
case|:
if|if
condition|(
name|view
operator|!=
name|NULL
condition|)
name|aclp
operator|=
operator|&
name|view
operator|->
name|transferacl
expr_stmt|;
name|aclname
operator|=
literal|"allow-transfer"
expr_stmt|;
break|break;
case|case
name|allow_update
case|:
if|if
condition|(
name|view
operator|!=
name|NULL
condition|)
name|aclp
operator|=
operator|&
name|view
operator|->
name|updateacl
expr_stmt|;
name|aclname
operator|=
literal|"allow-update"
expr_stmt|;
break|break;
case|case
name|allow_update_forwarding
case|:
if|if
condition|(
name|view
operator|!=
name|NULL
condition|)
name|aclp
operator|=
operator|&
name|view
operator|->
name|upfwdacl
expr_stmt|;
name|aclname
operator|=
literal|"allow-update-forwarding"
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
comment|/* First check to see if ACL is defined within the zone */
if|if
condition|(
name|zconfig
operator|!=
name|NULL
condition|)
block|{
name|maps
index|[
literal|0
index|]
operator|=
name|cfg_tuple_get
argument_list|(
name|zconfig
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
name|aclname
argument_list|,
operator|&
name|aclobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|aclobj
operator|!=
name|NULL
condition|)
block|{
name|aclp
operator|=
name|NULL
expr_stmt|;
goto|goto
name|parse_acl
goto|;
block|}
block|}
comment|/* Failing that, see if there's a default ACL already in the view */
if|if
condition|(
name|aclp
operator|!=
name|NULL
operator|&&
operator|*
name|aclp
operator|!=
name|NULL
condition|)
block|{
call|(
modifier|*
name|setzacl
call|)
argument_list|(
name|zone
argument_list|,
operator|*
name|aclp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
comment|/* Check for default ACLs that haven't been parsed yet */
if|if
condition|(
name|vconfig
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|options
init|=
name|cfg_tuple_get
argument_list|(
name|vconfig
argument_list|,
literal|"options"
argument_list|)
decl_stmt|;
if|if
condition|(
name|options
operator|!=
name|NULL
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|options
expr_stmt|;
block|}
if|if
condition|(
name|config
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|options
init|=
name|NULL
decl_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"options"
argument_list|,
operator|&
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|!=
name|NULL
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|options
expr_stmt|;
block|}
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|ns_g_defaults
expr_stmt|;
name|maps
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
name|aclname
argument_list|,
operator|&
name|aclobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|aclobj
operator|==
name|NULL
condition|)
block|{
call|(
modifier|*
name|clearzacl
call|)
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
name|parse_acl
label|:
name|result
operator|=
name|cfg_acl_fromconfig
argument_list|(
name|aclobj
argument_list|,
name|config
argument_list|,
name|ns_g_lctx
argument_list|,
name|actx
argument_list|,
name|dns_zone_getmctx
argument_list|(
name|zone
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
call|(
modifier|*
name|setzacl
call|)
argument_list|(
name|zone
argument_list|,
name|acl
argument_list|)
expr_stmt|;
comment|/* Set the view default now */
if|if
condition|(
name|aclp
operator|!=
name|NULL
condition|)
name|dns_acl_attach
argument_list|(
name|acl
argument_list|,
name|aclp
argument_list|)
expr_stmt|;
name|dns_acl_detach
argument_list|(
operator|&
name|acl
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*%  * Parse the zone update-policy statement.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|configure_zone_ssutable
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|char
modifier|*
name|zname
parameter_list|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|updatepolicy
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|,
modifier|*
name|element2
decl_stmt|;
name|dns_ssutable_t
modifier|*
name|table
init|=
name|NULL
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
init|=
name|dns_zone_getmctx
argument_list|(
name|zone
argument_list|)
decl_stmt|;
name|isc_boolean_t
name|autoddns
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|zconfig
argument_list|,
literal|"update-policy"
argument_list|,
operator|&
name|updatepolicy
argument_list|)
expr_stmt|;
if|if
condition|(
name|updatepolicy
operator|==
name|NULL
condition|)
block|{
name|dns_zone_setssutable
argument_list|(
name|zone
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
if|if
condition|(
name|cfg_obj_isstring
argument_list|(
name|updatepolicy
argument_list|)
operator|&&
name|strcmp
argument_list|(
literal|"local"
argument_list|,
name|cfg_obj_asstring
argument_list|(
name|updatepolicy
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|autoddns
operator|=
name|ISC_TRUE
expr_stmt|;
name|updatepolicy
operator|=
name|NULL
expr_stmt|;
block|}
name|result
operator|=
name|dns_ssutable_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|table
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|updatepolicy
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|stmt
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|mode
init|=
name|cfg_tuple_get
argument_list|(
name|stmt
argument_list|,
literal|"mode"
argument_list|)
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|identity
init|=
name|cfg_tuple_get
argument_list|(
name|stmt
argument_list|,
literal|"identity"
argument_list|)
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|matchtype
init|=
name|cfg_tuple_get
argument_list|(
name|stmt
argument_list|,
literal|"matchtype"
argument_list|)
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|dname
init|=
name|cfg_tuple_get
argument_list|(
name|stmt
argument_list|,
literal|"name"
argument_list|)
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|typelist
init|=
name|cfg_tuple_get
argument_list|(
name|stmt
argument_list|,
literal|"types"
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|isc_boolean_t
name|grant
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|usezone
init|=
name|ISC_FALSE
decl_stmt|;
name|unsigned
name|int
name|mtype
init|=
name|DNS_SSUMATCHTYPE_NAME
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|,
name|fident
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_rdatatype_t
modifier|*
name|types
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"grant"
argument_list|)
operator|==
literal|0
condition|)
name|grant
operator|=
name|ISC_TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"deny"
argument_list|)
operator|==
literal|0
condition|)
name|grant
operator|=
name|ISC_FALSE
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|matchtype
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"name"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_NAME
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"subdomain"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_SUBDOMAIN
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"wildcard"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_WILDCARD
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"self"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_SELF
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"selfsub"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_SELFSUB
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"selfwild"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_SELFWILD
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"ms-self"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_SELFMS
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"krb5-self"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_SELFKRB5
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"ms-subdomain"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_SUBDOMAINMS
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"krb5-subdomain"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_SUBDOMAINKRB5
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"tcp-self"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_TCPSELF
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"6to4-self"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_6TO4SELF
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"zonesub"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_SUBDOMAIN
expr_stmt|;
name|usezone
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"external"
argument_list|)
operator|==
literal|0
condition|)
name|mtype
operator|=
name|DNS_SSUMATCHTYPE_EXTERNAL
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fident
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|identity
argument_list|)
expr_stmt|;
name|isc_buffer_constinit
argument_list|(
operator|&
name|b
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fident
argument_list|)
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|identity
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"'%s' is not a valid name"
argument_list|,
name|str
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|usezone
condition|)
block|{
name|result
operator|=
name|dns_name_copy
argument_list|(
name|dns_zone_getorigin
argument_list|(
name|zone
argument_list|)
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|identity
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"error copying origin: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
else|else
block|{
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|dname
argument_list|)
expr_stmt|;
name|isc_buffer_constinit
argument_list|(
operator|&
name|b
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|identity
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"'%s' is not a valid name"
argument_list|,
name|str
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
name|n
operator|=
name|ns_config_listcount
argument_list|(
name|typelist
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
name|types
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|types
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|n
operator|*
sizeof|sizeof
argument_list|(
name|dns_rdatatype_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|types
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|element2
operator|=
name|cfg_list_first
argument_list|(
name|typelist
argument_list|)
init|;
name|element2
operator|!=
name|NULL
condition|;
name|element2
operator|=
name|cfg_list_next
argument_list|(
name|element2
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|typeobj
decl_stmt|;
name|isc_textregion_t
name|r
decl_stmt|;
name|INSIST
argument_list|(
name|i
operator|<
name|n
argument_list|)
expr_stmt|;
name|typeobj
operator|=
name|cfg_listelt_value
argument_list|(
name|element2
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|typeobj
argument_list|)
expr_stmt|;
name|DE_CONST
argument_list|(
name|str
argument_list|,
name|r
operator|.
name|base
argument_list|)
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatatype_fromtext
argument_list|(
operator|&
name|types
index|[
name|i
operator|++
index|]
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|identity
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"'%s' is not a valid type"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|types
argument_list|,
name|n
operator|*
sizeof|sizeof
argument_list|(
name|dns_rdatatype_t
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
name|INSIST
argument_list|(
name|i
operator|==
name|n
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_ssutable_addrule
argument_list|(
name|table
argument_list|,
name|grant
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fident
argument_list|)
argument_list|,
name|mtype
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
argument_list|,
name|n
argument_list|,
name|types
argument_list|)
expr_stmt|;
if|if
condition|(
name|types
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|types
argument_list|,
name|n
operator|*
sizeof|sizeof
argument_list|(
name|dns_rdatatype_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
goto|goto
name|cleanup
goto|;
block|}
block|}
comment|/* 	 * If "update-policy local;" and a session key exists, 	 * then use the default policy, which is equivalent to: 	 * update-policy { grant<session-keyname> zonesub any; }; 	 */
if|if
condition|(
name|autoddns
condition|)
block|{
name|dns_rdatatype_t
name|any
init|=
name|dns_rdatatype_any
decl_stmt|;
if|if
condition|(
name|ns_g_server
operator|->
name|session_keyname
operator|==
name|NULL
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"failed to enable auto DDNS policy "
literal|"for zone %s: session key not found"
argument_list|,
name|zname
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_NOTFOUND
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|result
operator|=
name|dns_ssutable_addrule
argument_list|(
name|table
argument_list|,
name|ISC_TRUE
argument_list|,
name|ns_g_server
operator|->
name|session_keyname
argument_list|,
name|DNS_SSUMATCHTYPE_SUBDOMAIN
argument_list|,
name|dns_zone_getorigin
argument_list|(
name|zone
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|&
name|any
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|dns_zone_setssutable
argument_list|(
name|zone
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|dns_ssutable_detach
argument_list|(
operator|&
name|table
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * This is the TTL used for internally generated RRsets for static-stub zones.  * The value doesn't matter because the mapping is static, but needs to be  * defined for the sake of implementation.  */
end_comment

begin_define
define|#
directive|define
name|STATICSTUB_SERVER_TTL
value|86400
end_define

begin_comment
comment|/*%  * Configure an apex NS with glues for a static-stub zone.  * For example, for the zone named "example.com", the following RRs will be  * added to the zone DB:  * example.com. NS example.com.  * example.com. A 192.0.2.1  * example.com. AAAA 2001:db8::1  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|configure_staticstub_serveraddrs
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_rdatalist_t
modifier|*
name|rdatalist_ns
parameter_list|,
name|dns_rdatalist_t
modifier|*
name|rdatalist_a
parameter_list|,
name|dns_rdatalist_t
modifier|*
name|rdatalist_aaaa
parameter_list|)
block|{
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
init|=
name|dns_zone_getmctx
argument_list|(
name|zone
argument_list|)
decl_stmt|;
name|isc_region_t
name|region
decl_stmt|,
name|sregion
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|zconfig
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|isc_sockaddr_t
modifier|*
name|sa
decl_stmt|;
name|isc_netaddr_t
name|na
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|address
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|rdatalist
decl_stmt|;
name|sa
operator|=
name|cfg_obj_assockaddr
argument_list|(
name|address
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_sockaddr_getport
argument_list|(
name|sa
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|zconfig
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"port is not configurable for "
literal|"static stub server-addresses"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|na
argument_list|,
name|sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_netaddr_getzone
argument_list|(
operator|&
name|na
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|zconfig
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"scoped address is not allowed "
literal|"for static stub "
literal|"server-addresses"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
switch|switch
condition|(
name|na
operator|.
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
name|region
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|na
operator|.
name|type
operator|.
name|in
argument_list|)
expr_stmt|;
name|rdatalist
operator|=
name|rdatalist_a
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
name|na
operator|.
name|family
operator|==
name|AF_INET6
argument_list|)
expr_stmt|;
name|region
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|na
operator|.
name|type
operator|.
name|in6
argument_list|)
expr_stmt|;
name|rdatalist
operator|=
name|rdatalist_aaaa
expr_stmt|;
break|break;
block|}
name|rdata
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rdata
argument_list|)
operator|+
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdata
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|region
operator|.
name|base
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|rdata
operator|+
literal|1
operator|)
expr_stmt|;
name|memmove
argument_list|(
name|region
operator|.
name|base
argument_list|,
operator|&
name|na
operator|.
name|type
argument_list|,
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_fromregion
argument_list|(
name|rdata
argument_list|,
name|dns_zone_getclass
argument_list|(
name|zone
argument_list|)
argument_list|,
name|rdatalist
operator|->
name|type
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * If no address is specified (unlikely in this context, but possible), 	 * there's nothing to do anymore. 	 */
if|if
condition|(
name|ISC_LIST_EMPTY
argument_list|(
name|rdatalist_a
operator|->
name|rdata
argument_list|)
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|rdatalist_aaaa
operator|->
name|rdata
argument_list|)
condition|)
block|{
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
comment|/* Add to the list an apex NS with the ns name being the origin name */
name|dns_name_toregion
argument_list|(
name|dns_zone_getorigin
argument_list|(
name|zone
argument_list|)
argument_list|,
operator|&
name|sregion
argument_list|)
expr_stmt|;
name|rdata
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rdata
argument_list|)
operator|+
name|sregion
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdata
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * Already allocated data will be freed in the caller, so 		 * we can simply return here. 		 */
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
name|region
operator|.
name|length
operator|=
name|sregion
operator|.
name|length
expr_stmt|;
name|region
operator|.
name|base
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|rdata
operator|+
literal|1
operator|)
expr_stmt|;
name|memmove
argument_list|(
name|region
operator|.
name|base
argument_list|,
name|sregion
operator|.
name|base
argument_list|,
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_fromregion
argument_list|(
name|rdata
argument_list|,
name|dns_zone_getclass
argument_list|(
name|zone
argument_list|)
argument_list|,
name|dns_rdatatype_ns
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist_ns
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*%  * Configure an apex NS with an out-of-zone NS names for a static-stub zone.  * For example, for the zone named "example.com", something like the following  * RRs will be added to the zone DB:  * example.com. NS ns.example.net.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|configure_staticstub_servernames
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_rdatalist_t
modifier|*
name|rdatalist
parameter_list|,
specifier|const
name|char
modifier|*
name|zname
parameter_list|)
block|{
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
init|=
name|dns_zone_getmctx
argument_list|(
name|zone
argument_list|)
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
decl_stmt|;
name|isc_region_t
name|sregion
decl_stmt|,
name|region
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|zconfig
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|dns_fixedname_t
name|fixed_name
decl_stmt|;
name|dns_name_t
modifier|*
name|nsname
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|obj
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed_name
argument_list|)
expr_stmt|;
name|nsname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed_name
argument_list|)
expr_stmt|;
name|isc_buffer_constinit
argument_list|(
operator|&
name|b
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|nsname
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|zconfig
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"server-name '%s' is not a valid "
literal|"name"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
if|if
condition|(
name|dns_name_issubdomain
argument_list|(
name|nsname
argument_list|,
name|dns_zone_getorigin
argument_list|(
name|zone
argument_list|)
argument_list|)
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|zconfig
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"server-name '%s' must not be a "
literal|"subdomain of zone name '%s'"
argument_list|,
name|str
argument_list|,
name|zname
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
name|dns_name_toregion
argument_list|(
name|nsname
argument_list|,
operator|&
name|sregion
argument_list|)
expr_stmt|;
name|rdata
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rdata
argument_list|)
operator|+
name|sregion
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdata
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|region
operator|.
name|length
operator|=
name|sregion
operator|.
name|length
expr_stmt|;
name|region
operator|.
name|base
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|rdata
operator|+
literal|1
operator|)
expr_stmt|;
name|memmove
argument_list|(
name|region
operator|.
name|base
argument_list|,
name|sregion
operator|.
name|base
argument_list|,
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_fromregion
argument_list|(
name|rdata
argument_list|,
name|dns_zone_getclass
argument_list|(
name|zone
argument_list|)
argument_list|,
name|dns_rdatatype_ns
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*%  * Configure static-stub zone.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|configure_staticstub
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|char
modifier|*
name|zname
parameter_list|,
specifier|const
name|char
modifier|*
name|dbtype
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
init|=
name|dns_zone_getmctx
argument_list|(
name|zone
argument_list|)
decl_stmt|;
name|dns_db_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|dbversion
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|apexnode
init|=
name|NULL
decl_stmt|;
name|dns_name_t
name|apexname
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdatalist_t
name|rdatalist_ns
decl_stmt|,
name|rdatalist_a
decl_stmt|,
name|rdatalist_aaaa
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|rdatalists
index|[]
init|=
block|{
operator|&
name|rdatalist_ns
block|,
operator|&
name|rdatalist_a
block|,
operator|&
name|rdatalist_aaaa
block|,
name|NULL
block|}
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
decl_stmt|;
name|isc_region_t
name|region
decl_stmt|;
comment|/* Create the DB beforehand */
name|RETERR
argument_list|(
name|dns_db_create
argument_list|(
name|mctx
argument_list|,
name|dbtype
argument_list|,
name|dns_zone_getorigin
argument_list|(
name|zone
argument_list|)
argument_list|,
name|dns_dbtype_stub
argument_list|,
name|dns_zone_getclass
argument_list|(
name|zone
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|db
argument_list|)
argument_list|)
expr_stmt|;
name|dns_zone_setdb
argument_list|(
name|zone
argument_list|,
name|db
argument_list|)
expr_stmt|;
name|dns_rdatalist_init
argument_list|(
operator|&
name|rdatalist_ns
argument_list|)
expr_stmt|;
name|rdatalist_ns
operator|.
name|rdclass
operator|=
name|dns_zone_getclass
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|rdatalist_ns
operator|.
name|type
operator|=
name|dns_rdatatype_ns
expr_stmt|;
name|rdatalist_ns
operator|.
name|ttl
operator|=
name|STATICSTUB_SERVER_TTL
expr_stmt|;
name|dns_rdatalist_init
argument_list|(
operator|&
name|rdatalist_a
argument_list|)
expr_stmt|;
name|rdatalist_a
operator|.
name|rdclass
operator|=
name|dns_zone_getclass
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|rdatalist_a
operator|.
name|type
operator|=
name|dns_rdatatype_a
expr_stmt|;
name|rdatalist_a
operator|.
name|ttl
operator|=
name|STATICSTUB_SERVER_TTL
expr_stmt|;
name|dns_rdatalist_init
argument_list|(
operator|&
name|rdatalist_aaaa
argument_list|)
expr_stmt|;
name|rdatalist_aaaa
operator|.
name|rdclass
operator|=
name|dns_zone_getclass
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|rdatalist_aaaa
operator|.
name|type
operator|=
name|dns_rdatatype_aaaa
expr_stmt|;
name|rdatalist_aaaa
operator|.
name|ttl
operator|=
name|STATICSTUB_SERVER_TTL
expr_stmt|;
comment|/* Prepare zone RRs from the configuration */
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|zconfig
argument_list|,
literal|"server-addresses"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|INSIST
argument_list|(
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|configure_staticstub_serveraddrs
argument_list|(
name|obj
argument_list|,
name|zone
argument_list|,
operator|&
name|rdatalist_ns
argument_list|,
operator|&
name|rdatalist_a
argument_list|,
operator|&
name|rdatalist_aaaa
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|zconfig
argument_list|,
literal|"server-names"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|INSIST
argument_list|(
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|configure_staticstub_servernames
argument_list|(
name|obj
argument_list|,
name|zone
argument_list|,
operator|&
name|rdatalist_ns
argument_list|,
name|zname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * Sanity check: there should be at least one NS RR at the zone apex 	 * to trigger delegation. 	 */
if|if
condition|(
name|ISC_LIST_EMPTY
argument_list|(
name|rdatalist_ns
operator|.
name|rdata
argument_list|)
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"No NS record is configured for a "
literal|"static-stub zone '%s'"
argument_list|,
name|zname
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * Now add NS and glue A/AAAA RRsets to the zone DB. 	 * First open a new version for the add operation and get a pointer 	 * to the apex node (all RRs are of the apex name). 	 */
name|result
operator|=
name|dns_db_newversion
argument_list|(
name|db
argument_list|,
operator|&
name|dbversion
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|dns_name_init
argument_list|(
operator|&
name|apexname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
name|dns_zone_getorigin
argument_list|(
name|zone
argument_list|)
argument_list|,
operator|&
name|apexname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
operator|&
name|apexname
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|apexnode
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
comment|/* Add NS RRset */
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|dns_rdatalist_tordataset
argument_list|(
operator|&
name|rdatalist_ns
argument_list|,
operator|&
name|rdataset
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_addrdataset
argument_list|(
name|db
argument_list|,
name|apexnode
argument_list|,
name|dbversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
comment|/* Add glue A RRset, if any */
if|if
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|rdatalist_a
operator|.
name|rdata
argument_list|)
condition|)
block|{
name|RUNTIME_CHECK
argument_list|(
name|dns_rdatalist_tordataset
argument_list|(
operator|&
name|rdatalist_a
argument_list|,
operator|&
name|rdataset
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_addrdataset
argument_list|(
name|db
argument_list|,
name|apexnode
argument_list|,
name|dbversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
comment|/* Add glue AAAA RRset, if any */
if|if
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|rdatalist_aaaa
operator|.
name|rdata
argument_list|)
condition|)
block|{
name|RUNTIME_CHECK
argument_list|(
name|dns_rdatalist_tordataset
argument_list|(
operator|&
name|rdatalist_aaaa
argument_list|,
operator|&
name|rdataset
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_addrdataset
argument_list|(
name|db
argument_list|,
name|apexnode
argument_list|,
name|dbversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|apexnode
operator|!=
name|NULL
condition|)
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|apexnode
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbversion
operator|!=
name|NULL
condition|)
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|dbversion
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|rdatalists
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
while|while
condition|(
operator|(
name|rdata
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|rdatalists
index|[
name|i
index|]
operator|->
name|rdata
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|rdatalists
index|[
name|i
index|]
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_rdata_toregion
argument_list|(
name|rdata
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|rdata
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rdata
argument_list|)
operator|+
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*%  * Convert a config file zone type into a server zone type.  */
end_comment

begin_function
specifier|static
specifier|inline
name|dns_zonetype_t
name|zonetype_fromconfig
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|map
parameter_list|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|map
argument_list|,
literal|"type"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ns_config_getzonetype
argument_list|(
name|obj
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*%  * Helper function for strtoargv().  Pardon the gratuitous recursion.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|strtoargvsub
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|char
modifier|*
name|s
parameter_list|,
name|unsigned
name|int
modifier|*
name|argcp
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|argvp
parameter_list|,
name|unsigned
name|int
name|n
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
comment|/* Discard leading whitespace. */
while|while
condition|(
operator|*
name|s
operator|==
literal|' '
operator|||
operator|*
name|s
operator|==
literal|'\t'
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|==
literal|'\0'
condition|)
block|{
comment|/* We have reached the end of the string. */
operator|*
name|argcp
operator|=
name|n
expr_stmt|;
operator|*
name|argvp
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|n
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|argvp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
else|else
block|{
name|char
modifier|*
name|p
init|=
name|s
decl_stmt|;
while|while
condition|(
operator|*
name|p
operator|!=
literal|' '
operator|&&
operator|*
name|p
operator|!=
literal|'\t'
operator|&&
operator|*
name|p
operator|!=
literal|'\0'
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|!=
literal|'\0'
condition|)
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|result
operator|=
name|strtoargvsub
argument_list|(
name|mctx
argument_list|,
name|p
argument_list|,
name|argcp
argument_list|,
name|argvp
argument_list|,
name|n
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
operator|(
operator|*
name|argvp
operator|)
index|[
name|n
index|]
operator|=
name|s
expr_stmt|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*%  * Tokenize the string "s" into whitespace-separated words,  * return the number of words in '*argcp' and an array  * of pointers to the words in '*argvp'.  The caller  * must free the array using isc_mem_put().  The string  * is modified in-place.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|strtoargv
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|char
modifier|*
name|s
parameter_list|,
name|unsigned
name|int
modifier|*
name|argcp
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|argvp
parameter_list|)
block|{
return|return
operator|(
name|strtoargvsub
argument_list|(
name|mctx
argument_list|,
name|s
argument_list|,
name|argcp
argument_list|,
name|argvp
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|checknames
parameter_list|(
name|dns_zonetype_t
name|ztype
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|maps
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|objp
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|zone
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
switch|switch
condition|(
name|ztype
condition|)
block|{
case|case
name|dns_zone_slave
case|:
name|zone
operator|=
literal|"slave"
expr_stmt|;
break|break;
case|case
name|dns_zone_master
case|:
name|zone
operator|=
literal|"master"
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|ns_checknames_get
argument_list|(
name|maps
argument_list|,
name|zone
argument_list|,
name|objp
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|objp
operator|!=
name|NULL
operator|&&
operator|*
name|objp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_zone_configure
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|vconfig
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
parameter_list|,
name|cfg_aclconfctx_t
modifier|*
name|ac
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_zone_t
modifier|*
name|raw
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|char
modifier|*
name|zname
decl_stmt|;
name|dns_rdataclass_t
name|zclass
decl_stmt|;
name|dns_rdataclass_t
name|vclass
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|maps
index|[
literal|5
index|]
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|zoptions
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|options
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|;
specifier|const
name|char
modifier|*
name|filename
init|=
name|NULL
decl_stmt|;
name|dns_notifytype_t
name|notifytype
init|=
name|dns_notifytype_yes
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|addrs
decl_stmt|;
name|dns_name_t
modifier|*
modifier|*
name|keynames
decl_stmt|;
name|isc_uint32_t
name|count
decl_stmt|;
name|char
modifier|*
name|cpval
decl_stmt|;
name|unsigned
name|int
name|dbargc
decl_stmt|;
name|char
modifier|*
modifier|*
name|dbargv
decl_stmt|;
specifier|static
name|char
name|default_dbtype
index|[]
init|=
literal|"rbt"
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
init|=
name|dns_zone_getmctx
argument_list|(
name|zone
argument_list|)
decl_stmt|;
name|dns_dialuptype_t
name|dialup
init|=
name|dns_dialuptype_no
decl_stmt|;
name|dns_zonetype_t
name|ztype
decl_stmt|;
name|int
name|i
decl_stmt|;
name|isc_int32_t
name|journal_size
decl_stmt|;
name|isc_boolean_t
name|multi
decl_stmt|;
name|isc_boolean_t
name|alt
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|isc_boolean_t
name|check
init|=
name|ISC_FALSE
decl_stmt|,
name|fail
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|warn
init|=
name|ISC_FALSE
decl_stmt|,
name|ignore
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|ixfrdiff
decl_stmt|;
name|dns_masterformat_t
name|masterformat
decl_stmt|;
name|isc_stats_t
modifier|*
name|zoneqrystats
decl_stmt|;
ifdef|#
directive|ifdef
name|NEWSTATS
name|dns_stats_t
modifier|*
name|rcvquerystats
decl_stmt|;
endif|#
directive|endif
name|dns_zonestat_level_t
name|statlevel
decl_stmt|;
name|int
name|seconds
decl_stmt|;
name|dns_zone_t
modifier|*
name|mayberaw
init|=
operator|(
name|raw
operator|!=
name|NULL
operator|)
condition|?
name|raw
else|:
name|zone
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|zconfig
operator|!=
name|NULL
condition|)
block|{
name|zoptions
operator|=
name|cfg_tuple_get
argument_list|(
name|zconfig
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|zoptions
expr_stmt|;
block|}
if|if
condition|(
name|vconfig
operator|!=
name|NULL
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|cfg_tuple_get
argument_list|(
name|vconfig
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"options"
argument_list|,
operator|&
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|!=
name|NULL
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|options
expr_stmt|;
block|}
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|ns_g_defaults
expr_stmt|;
name|maps
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|vconfig
operator|!=
name|NULL
condition|)
name|RETERR
argument_list|(
name|ns_config_getclass
argument_list|(
name|cfg_tuple_get
argument_list|(
name|vconfig
argument_list|,
literal|"class"
argument_list|)
argument_list|,
name|dns_rdataclass_in
argument_list|,
operator|&
name|vclass
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|vclass
operator|=
name|dns_rdataclass_in
expr_stmt|;
comment|/* 	 * Configure values common to all zone types. 	 */
name|zname
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|zconfig
argument_list|,
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|ns_config_getclass
argument_list|(
name|cfg_tuple_get
argument_list|(
name|zconfig
argument_list|,
literal|"class"
argument_list|)
argument_list|,
name|vclass
argument_list|,
operator|&
name|zclass
argument_list|)
argument_list|)
expr_stmt|;
name|dns_zone_setclass
argument_list|(
name|zone
argument_list|,
name|zclass
argument_list|)
expr_stmt|;
if|if
condition|(
name|raw
operator|!=
name|NULL
condition|)
name|dns_zone_setclass
argument_list|(
name|raw
argument_list|,
name|zclass
argument_list|)
expr_stmt|;
name|ztype
operator|=
name|zonetype_fromconfig
argument_list|(
name|zoptions
argument_list|)
expr_stmt|;
if|if
condition|(
name|raw
operator|!=
name|NULL
condition|)
block|{
name|dns_zone_settype
argument_list|(
name|raw
argument_list|,
name|ztype
argument_list|)
expr_stmt|;
name|dns_zone_settype
argument_list|(
name|zone
argument_list|,
name|dns_zone_master
argument_list|)
expr_stmt|;
block|}
else|else
name|dns_zone_settype
argument_list|(
name|zone
argument_list|,
name|ztype
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"database"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|cpval
operator|=
name|isc_mem_strdup
argument_list|(
name|mctx
argument_list|,
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|cpval
operator|=
name|default_dbtype
expr_stmt|;
if|if
condition|(
name|cpval
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|result
operator|=
name|strtoargv
argument_list|(
name|mctx
argument_list|,
name|cpval
argument_list|,
operator|&
name|dbargc
argument_list|,
operator|&
name|dbargv
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|cpval
operator|!=
name|default_dbtype
condition|)
block|{
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|cpval
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 	 * ANSI C is strange here.  There is no logical reason why (char **) 	 * cannot be promoted automatically to (const char * const *) by the 	 * compiler w/o generating a warning. 	 */
name|result
operator|=
name|dns_zone_setdbtype
argument_list|(
name|zone
argument_list|,
name|dbargc
argument_list|,
operator|(
specifier|const
name|char
operator|*
specifier|const
operator|*
operator|)
name|dbargv
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|dbargv
argument_list|,
name|dbargc
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|dbargv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpval
operator|!=
name|default_dbtype
condition|)
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|cpval
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"file"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|filename
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
comment|/* 	 * Unless we're using some alternative database, a master zone 	 * will be needing a master file. 	 */
if|if
condition|(
name|ztype
operator|==
name|dns_zone_master
operator|&&
name|cpval
operator|==
name|default_dbtype
operator|&&
name|filename
operator|==
name|NULL
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"zone '%s': 'file' not specified"
argument_list|,
name|zname
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
if|if
condition|(
name|ztype
operator|==
name|dns_zone_slave
condition|)
name|masterformat
operator|=
name|dns_masterformat_raw
expr_stmt|;
else|else
name|masterformat
operator|=
name|dns_masterformat_text
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"masterfile-format"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
specifier|const
name|char
modifier|*
name|masterformatstr
init|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|masterformatstr
argument_list|,
literal|"text"
argument_list|)
operator|==
literal|0
condition|)
name|masterformat
operator|=
name|dns_masterformat_text
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|masterformatstr
argument_list|,
literal|"raw"
argument_list|)
operator|==
literal|0
condition|)
name|masterformat
operator|=
name|dns_masterformat_raw
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|raw
operator|!=
name|NULL
operator|&&
name|filename
operator|!=
name|NULL
condition|)
block|{
define|#
directive|define
name|SIGNED
value|".signed"
name|size_t
name|signedlen
init|=
name|strlen
argument_list|(
name|filename
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|SIGNED
argument_list|)
decl_stmt|;
name|char
modifier|*
name|signedname
decl_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setfile2
argument_list|(
name|raw
argument_list|,
name|filename
argument_list|,
name|masterformat
argument_list|)
argument_list|)
expr_stmt|;
name|signedname
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|signedlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|signedname
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|signedname
argument_list|,
name|signedlen
argument_list|,
literal|"%s"
name|SIGNED
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_zone_setfile2
argument_list|(
name|zone
argument_list|,
name|signedname
argument_list|,
name|dns_masterformat_raw
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|signedname
argument_list|,
name|signedlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
else|else
name|RETERR
argument_list|(
name|dns_zone_setfile2
argument_list|(
name|zone
argument_list|,
name|filename
argument_list|,
name|masterformat
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"journal"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|RETERR
argument_list|(
name|dns_zone_setjournal
argument_list|(
name|mayberaw
argument_list|,
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Notify messages are processed by the raw zone if it exists. 	 */
if|if
condition|(
name|ztype
operator|==
name|dns_zone_slave
condition|)
name|RETERR
argument_list|(
name|configure_zone_acl
argument_list|(
name|zconfig
argument_list|,
name|vconfig
argument_list|,
name|config
argument_list|,
name|allow_notify
argument_list|,
name|ac
argument_list|,
name|mayberaw
argument_list|,
name|dns_zone_setnotifyacl
argument_list|,
name|dns_zone_clearnotifyacl
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * XXXAG This probably does not make sense for stubs. 	 */
name|RETERR
argument_list|(
name|configure_zone_acl
argument_list|(
name|zconfig
argument_list|,
name|vconfig
argument_list|,
name|config
argument_list|,
name|allow_query
argument_list|,
name|ac
argument_list|,
name|zone
argument_list|,
name|dns_zone_setqueryacl
argument_list|,
name|dns_zone_clearqueryacl
argument_list|)
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|configure_zone_acl
argument_list|(
name|zconfig
argument_list|,
name|vconfig
argument_list|,
name|config
argument_list|,
name|allow_query_on
argument_list|,
name|ac
argument_list|,
name|zone
argument_list|,
name|dns_zone_setqueryonacl
argument_list|,
name|dns_zone_clearqueryonacl
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"dialup"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isboolean
argument_list|(
name|obj
argument_list|)
condition|)
block|{
if|if
condition|(
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
condition|)
name|dialup
operator|=
name|dns_dialuptype_yes
expr_stmt|;
else|else
name|dialup
operator|=
name|dns_dialuptype_no
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|dialupstr
init|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|dialupstr
argument_list|,
literal|"notify"
argument_list|)
operator|==
literal|0
condition|)
name|dialup
operator|=
name|dns_dialuptype_notify
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|dialupstr
argument_list|,
literal|"notify-passive"
argument_list|)
operator|==
literal|0
condition|)
name|dialup
operator|=
name|dns_dialuptype_notifypassive
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|dialupstr
argument_list|,
literal|"refresh"
argument_list|)
operator|==
literal|0
condition|)
name|dialup
operator|=
name|dns_dialuptype_refresh
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|dialupstr
argument_list|,
literal|"passive"
argument_list|)
operator|==
literal|0
condition|)
name|dialup
operator|=
name|dns_dialuptype_passive
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|raw
operator|!=
name|NULL
condition|)
name|dns_zone_setdialup
argument_list|(
name|raw
argument_list|,
name|dialup
argument_list|)
expr_stmt|;
name|dns_zone_setdialup
argument_list|(
name|zone
argument_list|,
name|dialup
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"zone-statistics"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isboolean
argument_list|(
name|obj
argument_list|)
condition|)
block|{
if|if
condition|(
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
condition|)
name|statlevel
operator|=
name|dns_zonestat_full
expr_stmt|;
else|else
name|statlevel
operator|=
name|dns_zonestat_terse
expr_stmt|;
comment|/* XXX */
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|levelstr
init|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|levelstr
argument_list|,
literal|"full"
argument_list|)
operator|==
literal|0
condition|)
name|statlevel
operator|=
name|dns_zonestat_full
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|levelstr
argument_list|,
literal|"terse"
argument_list|)
operator|==
literal|0
condition|)
name|statlevel
operator|=
name|dns_zonestat_terse
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|levelstr
argument_list|,
literal|"none"
argument_list|)
operator|==
literal|0
condition|)
name|statlevel
operator|=
name|dns_zonestat_none
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|dns_zone_setstatlevel
argument_list|(
name|zone
argument_list|,
name|statlevel
argument_list|)
expr_stmt|;
name|zoneqrystats
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|NEWSTATS
name|rcvquerystats
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|statlevel
operator|==
name|dns_zonestat_full
condition|)
block|{
name|RETERR
argument_list|(
name|isc_stats_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|zoneqrystats
argument_list|,
name|dns_nsstatscounter_max
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NEWSTATS
name|RETERR
argument_list|(
name|dns_rdatatypestats_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|rcvquerystats
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|dns_zone_setrequeststats
argument_list|(
name|zone
argument_list|,
name|zoneqrystats
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NEWSTATS
name|dns_zone_setrcvquerystats
argument_list|(
name|zone
argument_list|,
name|rcvquerystats
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|zoneqrystats
operator|!=
name|NULL
condition|)
name|isc_stats_detach
argument_list|(
operator|&
name|zoneqrystats
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NEWSTATS
if|if
condition|(
name|rcvquerystats
operator|!=
name|NULL
condition|)
name|dns_stats_detach
argument_list|(
operator|&
name|rcvquerystats
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * Configure master functionality.  This applies 	 * to primary masters (type "master") and slaves 	 * acting as masters (type "slave"), but not to stubs. 	 */
if|if
condition|(
name|ztype
operator|!=
name|dns_zone_stub
operator|&&
name|ztype
operator|!=
name|dns_zone_staticstub
operator|&&
name|ztype
operator|!=
name|dns_zone_redirect
condition|)
block|{
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"notify"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isboolean
argument_list|(
name|obj
argument_list|)
condition|)
block|{
if|if
condition|(
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
condition|)
name|notifytype
operator|=
name|dns_notifytype_yes
expr_stmt|;
else|else
name|notifytype
operator|=
name|dns_notifytype_no
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|notifystr
init|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|notifystr
argument_list|,
literal|"explicit"
argument_list|)
operator|==
literal|0
condition|)
name|notifytype
operator|=
name|dns_notifytype_explicit
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|notifystr
argument_list|,
literal|"master-only"
argument_list|)
operator|==
literal|0
condition|)
name|notifytype
operator|=
name|dns_notifytype_masteronly
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|raw
operator|!=
name|NULL
condition|)
name|dns_zone_setnotifytype
argument_list|(
name|raw
argument_list|,
name|dns_notifytype_no
argument_list|)
expr_stmt|;
name|dns_zone_setnotifytype
argument_list|(
name|zone
argument_list|,
name|notifytype
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"also-notify"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
operator|(
name|notifytype
operator|==
name|dns_notifytype_yes
operator|||
name|notifytype
operator|==
name|dns_notifytype_explicit
operator|||
operator|(
name|notifytype
operator|==
name|dns_notifytype_masteronly
operator|&&
name|ztype
operator|==
name|dns_zone_master
operator|)
operator|)
condition|)
block|{
name|isc_uint32_t
name|addrcount
decl_stmt|;
name|addrs
operator|=
name|NULL
expr_stmt|;
name|keynames
operator|=
name|NULL
expr_stmt|;
name|RETERR
argument_list|(
name|ns_config_getipandkeylist
argument_list|(
name|config
argument_list|,
name|obj
argument_list|,
name|mctx
argument_list|,
operator|&
name|addrs
argument_list|,
operator|&
name|keynames
argument_list|,
operator|&
name|addrcount
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_zone_setalsonotifywithkeys
argument_list|(
name|zone
argument_list|,
name|addrs
argument_list|,
name|keynames
argument_list|,
name|addrcount
argument_list|)
expr_stmt|;
if|if
condition|(
name|addrcount
operator|!=
literal|0
condition|)
name|ns_config_putipandkeylist
argument_list|(
name|mctx
argument_list|,
operator|&
name|addrs
argument_list|,
operator|&
name|keynames
argument_list|,
name|addrcount
argument_list|)
expr_stmt|;
else|else
name|INSIST
argument_list|(
name|addrs
operator|==
name|NULL
operator|&&
name|keynames
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
else|else
name|RETERR
argument_list|(
name|dns_zone_setalsonotify
argument_list|(
name|zone
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"notify-source"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setnotifysrc4
argument_list|(
name|zone
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ns_add_reserved_dispatch
argument_list|(
name|ns_g_server
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"notify-source-v6"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setnotifysrc6
argument_list|(
name|zone
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ns_add_reserved_dispatch
argument_list|(
name|ns_g_server
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"notify-to-soa"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_NOTIFYTOSOA
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|dns_zone_setisself
argument_list|(
name|zone
argument_list|,
name|ns_client_isself
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|configure_zone_acl
argument_list|(
name|zconfig
argument_list|,
name|vconfig
argument_list|,
name|config
argument_list|,
name|allow_transfer
argument_list|,
name|ac
argument_list|,
name|zone
argument_list|,
name|dns_zone_setxfracl
argument_list|,
name|dns_zone_clearxfracl
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-transfer-time-out"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setmaxxfrout
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
operator|*
literal|60
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-transfer-idle-out"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setidleout
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
operator|*
literal|60
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-journal-size"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|raw
operator|!=
name|NULL
condition|)
name|dns_zone_setjournalsize
argument_list|(
name|raw
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|dns_zone_setjournalsize
argument_list|(
name|zone
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isstring
argument_list|(
name|obj
argument_list|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|str
init|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"unlimited"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|journal_size
operator|=
name|ISC_UINT32_MAX
operator|/
literal|2
expr_stmt|;
block|}
else|else
block|{
name|isc_resourcevalue_t
name|value
decl_stmt|;
name|value
operator|=
name|cfg_obj_asuint64
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|>
name|ISC_UINT32_MAX
operator|/
literal|2
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|obj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"'max-journal-size "
literal|"%"
name|ISC_PRINT_QUADFORMAT
literal|"d' "
literal|"is too large"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|ISC_R_RANGE
argument_list|)
expr_stmt|;
block|}
name|journal_size
operator|=
operator|(
name|isc_uint32_t
operator|)
name|value
expr_stmt|;
block|}
if|if
condition|(
name|raw
operator|!=
name|NULL
condition|)
name|dns_zone_setjournalsize
argument_list|(
name|raw
argument_list|,
name|journal_size
argument_list|)
expr_stmt|;
name|dns_zone_setjournalsize
argument_list|(
name|zone
argument_list|,
name|journal_size
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"ixfr-from-differences"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isboolean
argument_list|(
name|obj
argument_list|)
condition|)
name|ixfrdiff
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"master"
argument_list|)
operator|&&
name|ztype
operator|==
name|dns_zone_master
condition|)
name|ixfrdiff
operator|=
name|ISC_TRUE
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"slave"
argument_list|)
operator|&&
name|ztype
operator|==
name|dns_zone_slave
condition|)
name|ixfrdiff
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|ixfrdiff
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|raw
operator|!=
name|NULL
condition|)
block|{
name|dns_zone_setoption
argument_list|(
name|raw
argument_list|,
name|DNS_ZONEOPT_IXFRFROMDIFFS
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_IXFRFROMDIFFS
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
block|}
else|else
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_IXFRFROMDIFFS
argument_list|,
name|ixfrdiff
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"request-ixfr"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zone_setrequestixfr
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|checknames
argument_list|(
name|ztype
argument_list|,
name|maps
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"warn"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fail
operator|=
name|ISC_FALSE
expr_stmt|;
name|check
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"fail"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fail
operator|=
name|check
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"ignore"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fail
operator|=
name|check
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|raw
operator|!=
name|NULL
condition|)
block|{
name|dns_zone_setoption
argument_list|(
name|raw
argument_list|,
name|DNS_ZONEOPT_CHECKNAMES
argument_list|,
name|check
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|raw
argument_list|,
name|DNS_ZONEOPT_CHECKNAMESFAIL
argument_list|,
name|fail
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNAMES
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNAMESFAIL
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNAMES
argument_list|,
name|check
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNAMESFAIL
argument_list|,
name|fail
argument_list|)
expr_stmt|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"notify-delay"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setnotifydelay
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"check-sibling"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKSIBLING
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"check-spf"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"warn"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|check
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"ignore"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|check
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKSPF
argument_list|,
name|check
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"zero-no-soa-ttl"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setzeronosoattl
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"nsec3-test-zone"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_NSEC3TESTZONE
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ztype
operator|==
name|dns_zone_redirect
condition|)
block|{
name|dns_zone_setnotifytype
argument_list|(
name|zone
argument_list|,
name|dns_notifytype_no
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-journal-size"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setjournalsize
argument_list|(
name|zone
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isstring
argument_list|(
name|obj
argument_list|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|str
init|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"unlimited"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|journal_size
operator|=
name|ISC_UINT32_MAX
operator|/
literal|2
expr_stmt|;
block|}
else|else
block|{
name|isc_resourcevalue_t
name|value
decl_stmt|;
name|value
operator|=
name|cfg_obj_asuint64
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|>
name|ISC_UINT32_MAX
operator|/
literal|2
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|obj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"'max-journal-size "
literal|"%"
name|ISC_PRINT_QUADFORMAT
literal|"d' "
literal|"is too large"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|ISC_R_RANGE
argument_list|)
expr_stmt|;
block|}
name|journal_size
operator|=
operator|(
name|isc_uint32_t
operator|)
name|value
expr_stmt|;
block|}
name|dns_zone_setjournalsize
argument_list|(
name|zone
argument_list|,
name|journal_size
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Configure update-related options.  These apply to 	 * primary masters only. 	 */
if|if
condition|(
name|ztype
operator|==
name|dns_zone_master
condition|)
block|{
name|dns_acl_t
modifier|*
name|updateacl
decl_stmt|;
name|RETERR
argument_list|(
name|configure_zone_acl
argument_list|(
name|zconfig
argument_list|,
name|vconfig
argument_list|,
name|config
argument_list|,
name|allow_update
argument_list|,
name|ac
argument_list|,
name|mayberaw
argument_list|,
name|dns_zone_setupdateacl
argument_list|,
name|dns_zone_clearupdateacl
argument_list|)
argument_list|)
expr_stmt|;
name|updateacl
operator|=
name|dns_zone_getupdateacl
argument_list|(
name|mayberaw
argument_list|)
expr_stmt|;
if|if
condition|(
name|updateacl
operator|!=
name|NULL
operator|&&
name|dns_acl_isinsecure
argument_list|(
name|updateacl
argument_list|)
condition|)
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|DNS_LOGCATEGORY_SECURITY
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"zone '%s' allows updates by IP "
literal|"address, which is insecure"
argument_list|,
name|zname
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|configure_zone_ssutable
argument_list|(
name|zoptions
argument_list|,
name|mayberaw
argument_list|,
name|zname
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ztype
operator|==
name|dns_zone_master
operator|||
name|raw
operator|!=
name|NULL
condition|)
block|{
name|isc_boolean_t
name|allow
init|=
name|ISC_FALSE
decl_stmt|,
name|maint
init|=
name|ISC_FALSE
decl_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"sig-validity-interval"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|validity
decl_stmt|,
modifier|*
name|resign
decl_stmt|;
name|validity
operator|=
name|cfg_tuple_get
argument_list|(
name|obj
argument_list|,
literal|"validity"
argument_list|)
expr_stmt|;
name|seconds
operator|=
name|cfg_obj_asuint32
argument_list|(
name|validity
argument_list|)
operator|*
literal|86400
expr_stmt|;
name|dns_zone_setsigvalidityinterval
argument_list|(
name|zone
argument_list|,
name|seconds
argument_list|)
expr_stmt|;
name|resign
operator|=
name|cfg_tuple_get
argument_list|(
name|obj
argument_list|,
literal|"re-sign"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isvoid
argument_list|(
name|resign
argument_list|)
condition|)
block|{
name|seconds
operator|/=
literal|4
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|seconds
operator|>
literal|7
operator|*
literal|86400
condition|)
name|seconds
operator|=
name|cfg_obj_asuint32
argument_list|(
name|resign
argument_list|)
operator|*
literal|86400
expr_stmt|;
else|else
name|seconds
operator|=
name|cfg_obj_asuint32
argument_list|(
name|resign
argument_list|)
operator|*
literal|3600
expr_stmt|;
block|}
name|dns_zone_setsigresigninginterval
argument_list|(
name|zone
argument_list|,
name|seconds
argument_list|)
expr_stmt|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"key-directory"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|filename
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setkeydirectory
argument_list|(
name|zone
argument_list|,
name|filename
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"sig-signing-signatures"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setsignatures
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"sig-signing-nodes"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setnodes
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"sig-signing-type"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setprivatetype
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"update-check-ksk"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_UPDATECHECKKSK
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"dnssec-dnskey-kskonly"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_DNSKEYKSKONLY
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"dnssec-loadkeys-interval"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setrefreshkeyinterval
argument_list|(
name|zone
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"auto-dnssec"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
specifier|const
name|char
modifier|*
name|arg
init|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
argument_list|,
literal|"allow"
argument_list|)
operator|==
literal|0
condition|)
name|allow
operator|=
name|ISC_TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
argument_list|,
literal|"maintain"
argument_list|)
operator|==
literal|0
condition|)
name|allow
operator|=
name|maint
operator|=
name|ISC_TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
condition|)
empty_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dns_zone_setkeyopt
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEKEY_ALLOW
argument_list|,
name|allow
argument_list|)
expr_stmt|;
name|dns_zone_setkeyopt
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEKEY_MAINTAIN
argument_list|,
name|maint
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ztype
operator|==
name|dns_zone_slave
condition|)
block|{
name|RETERR
argument_list|(
name|configure_zone_acl
argument_list|(
name|zconfig
argument_list|,
name|vconfig
argument_list|,
name|config
argument_list|,
name|allow_update_forwarding
argument_list|,
name|ac
argument_list|,
name|mayberaw
argument_list|,
name|dns_zone_setforwardacl
argument_list|,
name|dns_zone_clearforwardacl
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/*% 	 * Primary master functionality. 	 */
if|if
condition|(
name|ztype
operator|==
name|dns_zone_master
condition|)
block|{
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"check-wildcard"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|check
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
else|else
name|check
operator|=
name|ISC_FALSE
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_CHECKWILDCARD
argument_list|,
name|check
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"check-dup-records"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"warn"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fail
operator|=
name|ISC_FALSE
expr_stmt|;
name|check
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"fail"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fail
operator|=
name|check
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"ignore"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fail
operator|=
name|check
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_CHECKDUPRR
argument_list|,
name|check
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_CHECKDUPRRFAIL
argument_list|,
name|fail
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"check-mx"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"warn"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fail
operator|=
name|ISC_FALSE
expr_stmt|;
name|check
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"fail"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fail
operator|=
name|check
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"ignore"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fail
operator|=
name|check
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_CHECKMX
argument_list|,
name|check
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_CHECKMXFAIL
argument_list|,
name|fail
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"check-integrity"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_CHECKINTEGRITY
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"check-mx-cname"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"warn"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|warn
operator|=
name|ISC_TRUE
expr_stmt|;
name|ignore
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"fail"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|warn
operator|=
name|ignore
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"ignore"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|warn
operator|=
name|ignore
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_WARNMXCNAME
argument_list|,
name|warn
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_IGNOREMXCNAME
argument_list|,
name|ignore
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"check-srv-cname"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"warn"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|warn
operator|=
name|ISC_TRUE
expr_stmt|;
name|ignore
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"fail"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|warn
operator|=
name|ignore
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"ignore"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|warn
operator|=
name|ignore
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_WARNSRVCNAME
argument_list|,
name|warn
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_IGNORESRVCNAME
argument_list|,
name|ignore
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"dnssec-secure-to-insecure"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_SECURETOINSECURE
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"dnssec-update-mode"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
specifier|const
name|char
modifier|*
name|arg
init|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
argument_list|,
literal|"no-resign"
argument_list|)
operator|==
literal|0
condition|)
name|dns_zone_setkeyopt
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEKEY_NORESIGN
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
argument_list|,
literal|"maintain"
argument_list|)
operator|==
literal|0
condition|)
empty_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"serial-update-method"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|"unixtime"
argument_list|)
operator|==
literal|0
condition|)
name|dns_zone_setserialupdatemethod
argument_list|(
name|zone
argument_list|,
name|dns_updatemethod_unixtime
argument_list|)
expr_stmt|;
else|else
name|dns_zone_setserialupdatemethod
argument_list|(
name|zone
argument_list|,
name|dns_updatemethod_increment
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Configure slave functionality. 	 */
switch|switch
condition|(
name|ztype
condition|)
block|{
case|case
name|dns_zone_slave
case|:
case|case
name|dns_zone_stub
case|:
case|case
name|dns_zone_redirect
case|:
name|count
operator|=
literal|0
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"masters"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
block|{
name|addrs
operator|=
name|NULL
expr_stmt|;
name|keynames
operator|=
name|NULL
expr_stmt|;
name|RETERR
argument_list|(
name|ns_config_getipandkeylist
argument_list|(
name|config
argument_list|,
name|obj
argument_list|,
name|mctx
argument_list|,
operator|&
name|addrs
argument_list|,
operator|&
name|keynames
argument_list|,
operator|&
name|count
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_zone_setmasterswithkeys
argument_list|(
name|mayberaw
argument_list|,
name|addrs
argument_list|,
name|keynames
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|!=
literal|0
condition|)
name|ns_config_putipandkeylist
argument_list|(
name|mctx
argument_list|,
operator|&
name|addrs
argument_list|,
operator|&
name|keynames
argument_list|,
name|count
argument_list|)
expr_stmt|;
else|else
name|INSIST
argument_list|(
name|addrs
operator|==
name|NULL
operator|&&
name|keynames
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|result
operator|=
name|dns_zone_setmasters
argument_list|(
name|mayberaw
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|multi
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|1
condition|)
block|{
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"multi-master"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|multi
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
block|}
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_MULTIMASTER
argument_list|,
name|multi
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-transfer-time-in"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setmaxxfrin
argument_list|(
name|mayberaw
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
operator|*
literal|60
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-transfer-idle-in"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setidlein
argument_list|(
name|mayberaw
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
operator|*
literal|60
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-refresh-time"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setmaxrefreshtime
argument_list|(
name|mayberaw
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"min-refresh-time"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setminrefreshtime
argument_list|(
name|mayberaw
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-retry-time"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setmaxretrytime
argument_list|(
name|mayberaw
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"min-retry-time"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_zone_setminretrytime
argument_list|(
name|mayberaw
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"transfer-source"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setxfrsource4
argument_list|(
name|mayberaw
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ns_add_reserved_dispatch
argument_list|(
name|ns_g_server
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"transfer-source-v6"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setxfrsource6
argument_list|(
name|mayberaw
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ns_add_reserved_dispatch
argument_list|(
name|ns_g_server
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"alt-transfer-source"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setaltxfrsource4
argument_list|(
name|mayberaw
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"alt-transfer-source-v6"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_zone_setaltxfrsource6
argument_list|(
name|mayberaw
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"use-alt-transfer-source"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|==
name|NULL
condition|)
block|{
comment|/* 			 * Default off when views are in use otherwise 			 * on for BIND 8 compatibility. 			 */
name|view
operator|=
name|dns_zone_getview
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|view
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
literal|"_default"
argument_list|)
operator|==
literal|0
condition|)
name|alt
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|alt
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
else|else
name|alt
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_USEALTXFRSRC
argument_list|,
name|alt
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"try-tcp-refresh"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|dns_zone_setoption
argument_list|(
name|mayberaw
argument_list|,
name|DNS_ZONEOPT_TRYTCPREFRESH
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|dns_zone_staticstub
case|:
name|RETERR
argument_list|(
name|configure_staticstub
argument_list|(
name|zoptions
argument_list|,
name|zone
argument_list|,
name|zname
argument_list|,
name|default_dbtype
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set up a DLZ zone as writeable  */
end_comment

begin_function
name|isc_result_t
name|ns_zone_configure_writeable_dlz
parameter_list|(
name|dns_dlzdb_t
modifier|*
name|dlzdatabase
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|dns_db_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|isc_time_t
name|now
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|TIME_NOW
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|dns_zone_settype
argument_list|(
name|zone
argument_list|,
name|dns_zone_dlz
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_sdlz_setdb
argument_list|(
name|dlzdatabase
argument_list|,
name|rdclass
argument_list|,
name|name
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_zone_dlzpostload
argument_list|(
name|zone
argument_list|,
name|db
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_boolean_t
name|ns_zone_reusable
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
parameter_list|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|zoptions
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|cfilename
decl_stmt|;
specifier|const
name|char
modifier|*
name|zfilename
decl_stmt|;
name|dns_zone_t
modifier|*
name|raw
init|=
name|NULL
decl_stmt|;
name|isc_boolean_t
name|has_raw
decl_stmt|;
name|dns_zonetype_t
name|ztype
decl_stmt|;
name|zoptions
operator|=
name|cfg_tuple_get
argument_list|(
name|zconfig
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
comment|/* 	 * We always reconfigure a static-stub zone for simplicity, assuming 	 * the amount of data to be loaded is small. 	 */
if|if
condition|(
name|zonetype_fromconfig
argument_list|(
name|zoptions
argument_list|)
operator|==
name|dns_zone_staticstub
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"not reusable: staticstub"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
comment|/* If there's a raw zone, use that for filename and type comparison */
name|dns_zone_getraw
argument_list|(
name|zone
argument_list|,
operator|&
name|raw
argument_list|)
expr_stmt|;
if|if
condition|(
name|raw
operator|!=
name|NULL
condition|)
block|{
name|zfilename
operator|=
name|dns_zone_getfile
argument_list|(
name|raw
argument_list|)
expr_stmt|;
name|ztype
operator|=
name|dns_zone_gettype
argument_list|(
name|raw
argument_list|)
expr_stmt|;
name|dns_zone_detach
argument_list|(
operator|&
name|raw
argument_list|)
expr_stmt|;
name|has_raw
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
block|{
name|zfilename
operator|=
name|dns_zone_getfile
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|ztype
operator|=
name|dns_zone_gettype
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|has_raw
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"inline-signing"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|obj
operator|==
name|NULL
operator|||
operator|!
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
operator|)
operator|&&
name|has_raw
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"not reusable: old zone was inline-signing"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|obj
operator|!=
name|NULL
operator|&&
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
operator|)
operator|&&
operator|!
name|has_raw
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"not reusable: old zone was not inline-signing"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
if|if
condition|(
name|zonetype_fromconfig
argument_list|(
name|zoptions
argument_list|)
operator|!=
name|ztype
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"not reusable: type mismatch"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"file"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
name|cfilename
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
else|else
name|cfilename
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|(
name|cfilename
operator|==
name|NULL
operator|&&
name|zfilename
operator|==
name|NULL
operator|)
operator|||
operator|(
name|cfilename
operator|!=
name|NULL
operator|&&
name|zfilename
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|cfilename
argument_list|,
name|zfilename
argument_list|)
operator|==
literal|0
operator|)
operator|)
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"not reusable: filename mismatch"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

end_unit


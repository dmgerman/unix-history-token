begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004, 2006  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2002  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: interfacemgr.c,v 1.59.2.5.8.18 2006/07/19 00:16:28 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/interfaceiter.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/acl.h>
end_include

begin_include
include|#
directive|include
file|<dns/dispatch.h>
end_include

begin_include
include|#
directive|include
file|<named/client.h>
end_include

begin_include
include|#
directive|include
file|<named/log.h>
end_include

begin_include
include|#
directive|include
file|<named/interfacemgr.h>
end_include

begin_define
define|#
directive|define
name|IFMGR_MAGIC
value|ISC_MAGIC('I', 'F', 'M', 'G')
end_define

begin_define
define|#
directive|define
name|NS_INTERFACEMGR_VALID
parameter_list|(
name|t
parameter_list|)
value|ISC_MAGIC_VALID(t, IFMGR_MAGIC)
end_define

begin_define
define|#
directive|define
name|IFMGR_COMMON_LOGARGS
define|\
value|ns_g_lctx, NS_LOGCATEGORY_NETWORK, NS_LOGMODULE_INTERFACEMGR
end_define

begin_struct
struct|struct
name|ns_interfacemgr
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
comment|/* Magic number. */
name|int
name|references
decl_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
comment|/* Memory context. */
name|isc_taskmgr_t
modifier|*
name|taskmgr
decl_stmt|;
comment|/* Task manager. */
name|isc_socketmgr_t
modifier|*
name|socketmgr
decl_stmt|;
comment|/* Socket manager. */
name|dns_dispatchmgr_t
modifier|*
name|dispatchmgr
decl_stmt|;
name|unsigned
name|int
name|generation
decl_stmt|;
comment|/* Current generation no. */
name|ns_listenlist_t
modifier|*
name|listenon4
decl_stmt|;
name|ns_listenlist_t
modifier|*
name|listenon6
decl_stmt|;
name|dns_aclenv_t
name|aclenv
decl_stmt|;
comment|/* Localhost/localnets ACLs */
name|ISC_LIST
argument_list|(
argument|ns_interface_t
argument_list|)
name|interfaces
expr_stmt|;
comment|/* List of interfaces. */
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|purge_old_interfaces
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|isc_result_t
name|ns_interfacemgr_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_taskmgr_t
modifier|*
name|taskmgr
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|socketmgr
parameter_list|,
name|dns_dispatchmgr_t
modifier|*
name|dispatchmgr
parameter_list|,
name|ns_interfacemgr_t
modifier|*
modifier|*
name|mgrp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|ns_interfacemgr_t
modifier|*
name|mgr
decl_stmt|;
name|REQUIRE
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|mgrp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|*
name|mgrp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|mgr
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgr
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_mem
goto|;
name|mgr
operator|->
name|mctx
operator|=
name|mctx
expr_stmt|;
name|mgr
operator|->
name|taskmgr
operator|=
name|taskmgr
expr_stmt|;
name|mgr
operator|->
name|socketmgr
operator|=
name|socketmgr
expr_stmt|;
name|mgr
operator|->
name|dispatchmgr
operator|=
name|dispatchmgr
expr_stmt|;
name|mgr
operator|->
name|generation
operator|=
literal|1
expr_stmt|;
name|mgr
operator|->
name|listenon4
operator|=
name|NULL
expr_stmt|;
name|mgr
operator|->
name|listenon6
operator|=
name|NULL
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|mgr
operator|->
name|interfaces
argument_list|)
expr_stmt|;
comment|/* 	 * The listen-on lists are initially empty. 	 */
name|result
operator|=
name|ns_listenlist_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|mgr
operator|->
name|listenon4
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_mem
goto|;
name|ns_listenlist_attach
argument_list|(
name|mgr
operator|->
name|listenon4
argument_list|,
operator|&
name|mgr
operator|->
name|listenon6
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_aclenv_init
argument_list|(
name|mctx
argument_list|,
operator|&
name|mgr
operator|->
name|aclenv
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_listenon
goto|;
name|mgr
operator|->
name|references
operator|=
literal|1
expr_stmt|;
name|mgr
operator|->
name|magic
operator|=
name|IFMGR_MAGIC
expr_stmt|;
operator|*
name|mgrp
operator|=
name|mgr
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup_listenon
label|:
name|ns_listenlist_detach
argument_list|(
operator|&
name|mgr
operator|->
name|listenon4
argument_list|)
expr_stmt|;
name|ns_listenlist_detach
argument_list|(
operator|&
name|mgr
operator|->
name|listenon6
argument_list|)
expr_stmt|;
name|cleanup_mem
label|:
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|mgr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ns_interfacemgr_destroy
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|NS_INTERFACEMGR_VALID
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
name|dns_aclenv_destroy
argument_list|(
operator|&
name|mgr
operator|->
name|aclenv
argument_list|)
expr_stmt|;
name|ns_listenlist_detach
argument_list|(
operator|&
name|mgr
operator|->
name|listenon4
argument_list|)
expr_stmt|;
name|ns_listenlist_detach
argument_list|(
operator|&
name|mgr
operator|->
name|listenon6
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mgr
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
name|mgr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|dns_aclenv_t
modifier|*
name|ns_interfacemgr_getaclenv
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|)
block|{
return|return
operator|(
operator|&
name|mgr
operator|->
name|aclenv
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ns_interfacemgr_attach
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|source
parameter_list|,
name|ns_interfacemgr_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|NS_INTERFACEMGR_VALID
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|source
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|source
operator|->
name|references
operator|>
literal|0
argument_list|)
expr_stmt|;
name|source
operator|->
name|references
operator|++
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|source
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|target
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_interfacemgr_detach
parameter_list|(
name|ns_interfacemgr_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
name|isc_result_t
name|need_destroy
init|=
name|ISC_FALSE
decl_stmt|;
name|ns_interfacemgr_t
modifier|*
name|target
init|=
operator|*
name|targetp
decl_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|NS_INTERFACEMGR_VALID
argument_list|(
name|target
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|target
operator|->
name|lock
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|->
name|references
operator|>
literal|0
argument_list|)
expr_stmt|;
name|target
operator|->
name|references
operator|--
expr_stmt|;
if|if
condition|(
name|target
operator|->
name|references
operator|==
literal|0
condition|)
name|need_destroy
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|target
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_destroy
condition|)
name|ns_interfacemgr_destroy
argument_list|(
name|target
argument_list|)
expr_stmt|;
operator|*
name|targetp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_interfacemgr_shutdown
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|NS_INTERFACEMGR_VALID
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Shut down and detach all interfaces. 	 * By incrementing the generation count, we make purge_old_interfaces() 	 * consider all interfaces "old". 	 */
name|mgr
operator|->
name|generation
operator|++
expr_stmt|;
name|purge_old_interfaces
argument_list|(
name|mgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|ns_interface_create
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|ns_interface_t
modifier|*
modifier|*
name|ifpret
parameter_list|)
block|{
name|ns_interface_t
modifier|*
name|ifp
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|NS_INTERFACEMGR_VALID
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|isc_mem_get
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|ifp
operator|->
name|mgr
operator|=
name|NULL
expr_stmt|;
name|ifp
operator|->
name|generation
operator|=
name|mgr
operator|->
name|generation
expr_stmt|;
name|ifp
operator|->
name|addr
operator|=
operator|*
name|addr
expr_stmt|;
name|ifp
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|strncpy
argument_list|(
name|ifp
operator|->
name|name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifp
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|name
index|[
sizeof|sizeof
argument_list|(
name|ifp
operator|->
name|name
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|ifp
operator|->
name|clientmgr
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|ifp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|lock_create_failure
goto|;
name|result
operator|=
name|ns_clientmgr_create
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
name|mgr
operator|->
name|taskmgr
argument_list|,
name|ns_g_timermgr
argument_list|,
operator|&
name|ifp
operator|->
name|clientmgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"ns_clientmgr_create() failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|clientmgr_create_failure
goto|;
block|}
name|ifp
operator|->
name|udpdispatch
operator|=
name|NULL
expr_stmt|;
name|ifp
operator|->
name|tcpsocket
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * Create a single TCP client object.  It will replace itself 	 * with a new one as soon as it gets a connection, so the actual 	 * connections will be handled in parallel even though there is 	 * only one client initially. 	 */
name|ifp
operator|->
name|ntcptarget
operator|=
literal|1
expr_stmt|;
name|ifp
operator|->
name|ntcpcurrent
operator|=
literal|0
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|ifp
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ns_interfacemgr_attach
argument_list|(
name|mgr
argument_list|,
operator|&
name|ifp
operator|->
name|mgr
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|mgr
operator|->
name|interfaces
argument_list|,
name|ifp
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|references
operator|=
literal|1
expr_stmt|;
name|ifp
operator|->
name|magic
operator|=
name|IFACE_MAGIC
expr_stmt|;
operator|*
name|ifpret
operator|=
name|ifp
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|clientmgr_create_failure
label|:
name|DESTROYLOCK
argument_list|(
operator|&
name|ifp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|lock_create_failure
label|:
name|ifp
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
name|ifp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_UNEXPECTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|ns_interface_listenudp
parameter_list|(
name|ns_interface_t
modifier|*
name|ifp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|attrs
decl_stmt|;
name|unsigned
name|int
name|attrmask
decl_stmt|;
name|attrs
operator|=
literal|0
expr_stmt|;
name|attrs
operator||=
name|DNS_DISPATCHATTR_UDP
expr_stmt|;
if|if
condition|(
name|isc_sockaddr_pf
argument_list|(
operator|&
name|ifp
operator|->
name|addr
argument_list|)
operator|==
name|AF_INET
condition|)
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV4
expr_stmt|;
else|else
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV6
expr_stmt|;
name|attrs
operator||=
name|DNS_DISPATCHATTR_NOLISTEN
expr_stmt|;
name|attrmask
operator|=
literal|0
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_UDP
operator||
name|DNS_DISPATCHATTR_TCP
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_IPV4
operator||
name|DNS_DISPATCHATTR_IPV6
expr_stmt|;
name|result
operator|=
name|dns_dispatch_getudp
argument_list|(
name|ifp
operator|->
name|mgr
operator|->
name|dispatchmgr
argument_list|,
name|ns_g_socketmgr
argument_list|,
name|ns_g_taskmgr
argument_list|,
operator|&
name|ifp
operator|->
name|addr
argument_list|,
literal|4096
argument_list|,
literal|1000
argument_list|,
literal|32768
argument_list|,
literal|8219
argument_list|,
literal|8237
argument_list|,
name|attrs
argument_list|,
name|attrmask
argument_list|,
operator|&
name|ifp
operator|->
name|udpdispatch
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"could not listen on UDP socket: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|udp_dispatch_failure
goto|;
block|}
name|result
operator|=
name|ns_clientmgr_createclients
argument_list|(
name|ifp
operator|->
name|clientmgr
argument_list|,
name|ns_g_cpus
argument_list|,
name|ifp
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"UDP ns_clientmgr_createclients(): %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|addtodispatch_failure
goto|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|addtodispatch_failure
label|:
name|dns_dispatch_changeattributes
argument_list|(
name|ifp
operator|->
name|udpdispatch
argument_list|,
literal|0
argument_list|,
name|DNS_DISPATCHATTR_NOLISTEN
argument_list|)
expr_stmt|;
name|dns_dispatch_detach
argument_list|(
operator|&
name|ifp
operator|->
name|udpdispatch
argument_list|)
expr_stmt|;
name|udp_dispatch_failure
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|ns_interface_accepttcp
parameter_list|(
name|ns_interface_t
modifier|*
name|ifp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
comment|/* 	 * Open a TCP socket. 	 */
name|result
operator|=
name|isc_socket_create
argument_list|(
name|ifp
operator|->
name|mgr
operator|->
name|socketmgr
argument_list|,
name|isc_sockaddr_pf
argument_list|(
operator|&
name|ifp
operator|->
name|addr
argument_list|)
argument_list|,
name|isc_sockettype_tcp
argument_list|,
operator|&
name|ifp
operator|->
name|tcpsocket
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"creating TCP socket: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|tcp_socket_failure
goto|;
block|}
ifndef|#
directive|ifndef
name|ISC_ALLOW_MAPPED
name|isc_socket_ipv6only
argument_list|(
name|ifp
operator|->
name|tcpsocket
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|result
operator|=
name|isc_socket_bind
argument_list|(
name|ifp
operator|->
name|tcpsocket
argument_list|,
operator|&
name|ifp
operator|->
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"binding TCP socket: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|tcp_bind_failure
goto|;
block|}
name|result
operator|=
name|isc_socket_listen
argument_list|(
name|ifp
operator|->
name|tcpsocket
argument_list|,
name|ns_g_listen
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"listening on TCP socket: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|tcp_listen_failure
goto|;
block|}
comment|/*  	 * If/when there a multiple filters listen to the 	 * result. 	 */
operator|(
name|void
operator|)
name|isc_socket_filter
argument_list|(
name|ifp
operator|->
name|tcpsocket
argument_list|,
literal|"dataready"
argument_list|)
expr_stmt|;
name|result
operator|=
name|ns_clientmgr_createclients
argument_list|(
name|ifp
operator|->
name|clientmgr
argument_list|,
name|ifp
operator|->
name|ntcptarget
argument_list|,
name|ifp
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"TCP ns_clientmgr_createclients(): %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|accepttcp_failure
goto|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|accepttcp_failure
label|:
name|tcp_listen_failure
label|:
name|tcp_bind_failure
label|:
name|isc_socket_detach
argument_list|(
operator|&
name|ifp
operator|->
name|tcpsocket
argument_list|)
expr_stmt|;
name|tcp_socket_failure
label|:
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|ns_interface_setup
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|ns_interface_t
modifier|*
modifier|*
name|ifpret
parameter_list|,
name|isc_boolean_t
name|accept_tcp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|ns_interface_t
modifier|*
name|ifp
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|ifpret
operator|!=
name|NULL
operator|&&
operator|*
name|ifpret
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|ns_interface_create
argument_list|(
name|mgr
argument_list|,
name|addr
argument_list|,
name|name
argument_list|,
operator|&
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|ns_interface_listenudp
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_interface
goto|;
if|if
condition|(
name|accept_tcp
operator|==
name|ISC_TRUE
condition|)
block|{
name|result
operator|=
name|ns_interface_accepttcp
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* 			 * XXXRTH We don't currently have a way to easily stop 			 * dispatch service, so we currently return 			 * ISC_R_SUCCESS (the UDP stuff will work even if TCP 			 * creation failed).  This will be fixed later. 			 */
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
block|}
operator|*
name|ifpret
operator|=
name|ifp
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup_interface
label|:
name|ISC_LIST_UNLINK
argument_list|(
name|ifp
operator|->
name|mgr
operator|->
name|interfaces
argument_list|,
name|ifp
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ns_interface_detach
argument_list|(
operator|&
name|ifp
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ns_interface_shutdown
parameter_list|(
name|ns_interface_t
modifier|*
name|ifp
parameter_list|)
block|{
if|if
condition|(
name|ifp
operator|->
name|clientmgr
operator|!=
name|NULL
condition|)
name|ns_clientmgr_destroy
argument_list|(
operator|&
name|ifp
operator|->
name|clientmgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ns_interface_destroy
parameter_list|(
name|ns_interface_t
modifier|*
name|ifp
parameter_list|)
block|{
name|isc_mem_t
modifier|*
name|mctx
init|=
name|ifp
operator|->
name|mgr
operator|->
name|mctx
decl_stmt|;
name|REQUIRE
argument_list|(
name|NS_INTERFACE_VALID
argument_list|(
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
name|ns_interface_shutdown
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|udpdispatch
operator|!=
name|NULL
condition|)
block|{
name|dns_dispatch_changeattributes
argument_list|(
name|ifp
operator|->
name|udpdispatch
argument_list|,
literal|0
argument_list|,
name|DNS_DISPATCHATTR_NOLISTEN
argument_list|)
expr_stmt|;
name|dns_dispatch_detach
argument_list|(
operator|&
name|ifp
operator|->
name|udpdispatch
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ifp
operator|->
name|tcpsocket
operator|!=
name|NULL
condition|)
name|isc_socket_detach
argument_list|(
operator|&
name|ifp
operator|->
name|tcpsocket
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|ifp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ns_interfacemgr_detach
argument_list|(
operator|&
name|ifp
operator|->
name|mgr
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|ifp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_interface_attach
parameter_list|(
name|ns_interface_t
modifier|*
name|source
parameter_list|,
name|ns_interface_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|NS_INTERFACE_VALID
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|source
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|source
operator|->
name|references
operator|>
literal|0
argument_list|)
expr_stmt|;
name|source
operator|->
name|references
operator|++
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|source
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|target
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_interface_detach
parameter_list|(
name|ns_interface_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
name|isc_result_t
name|need_destroy
init|=
name|ISC_FALSE
decl_stmt|;
name|ns_interface_t
modifier|*
name|target
init|=
operator|*
name|targetp
decl_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|NS_INTERFACE_VALID
argument_list|(
name|target
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|target
operator|->
name|lock
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|->
name|references
operator|>
literal|0
argument_list|)
expr_stmt|;
name|target
operator|->
name|references
operator|--
expr_stmt|;
if|if
condition|(
name|target
operator|->
name|references
operator|==
literal|0
condition|)
name|need_destroy
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|target
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_destroy
condition|)
name|ns_interface_destroy
argument_list|(
name|target
argument_list|)
expr_stmt|;
operator|*
name|targetp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Search the interface list for an interface whose address and port  * both match those of 'addr'.  Return a pointer to it, or NULL if not found.  */
end_comment

begin_function
specifier|static
name|ns_interface_t
modifier|*
name|find_matching_interface
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|)
block|{
name|ns_interface_t
modifier|*
name|ifp
decl_stmt|;
for|for
control|(
name|ifp
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|mgr
operator|->
name|interfaces
argument_list|)
init|;
name|ifp
operator|!=
name|NULL
condition|;
name|ifp
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|ifp
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|isc_sockaddr_equal
argument_list|(
operator|&
name|ifp
operator|->
name|addr
argument_list|,
name|addr
argument_list|)
condition|)
break|break;
block|}
return|return
operator|(
name|ifp
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Remove any interfaces whose generation number is not the current one.  */
end_comment

begin_function
specifier|static
name|void
name|purge_old_interfaces
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|)
block|{
name|ns_interface_t
modifier|*
name|ifp
decl_stmt|,
modifier|*
name|next
decl_stmt|;
for|for
control|(
name|ifp
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|mgr
operator|->
name|interfaces
argument_list|)
init|;
name|ifp
operator|!=
name|NULL
condition|;
name|ifp
operator|=
name|next
control|)
block|{
name|INSIST
argument_list|(
name|NS_INTERFACE_VALID
argument_list|(
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
name|next
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|ifp
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|generation
operator|!=
name|mgr
operator|->
name|generation
condition|)
block|{
name|char
name|sabuf
index|[
literal|256
index|]
decl_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|ifp
operator|->
name|mgr
operator|->
name|interfaces
argument_list|,
name|ifp
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|ifp
operator|->
name|addr
argument_list|,
name|sabuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sabuf
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"no longer listening on %s"
argument_list|,
name|sabuf
argument_list|)
expr_stmt|;
name|ns_interface_shutdown
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|ns_interface_detach
argument_list|(
operator|&
name|ifp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|clearacl
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_acl_t
modifier|*
modifier|*
name|aclp
parameter_list|)
block|{
name|dns_acl_t
modifier|*
name|newacl
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|dns_acl_create
argument_list|(
name|mctx
argument_list|,
literal|10
argument_list|,
operator|&
name|newacl
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|dns_acl_detach
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
name|dns_acl_attach
argument_list|(
name|newacl
argument_list|,
name|aclp
argument_list|)
expr_stmt|;
name|dns_acl_detach
argument_list|(
operator|&
name|newacl
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|listenon_is_ip6_any
parameter_list|(
name|ns_listenelt_t
modifier|*
name|elt
parameter_list|)
block|{
if|if
condition|(
name|elt
operator|->
name|acl
operator|->
name|length
operator|!=
literal|1
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|elt
operator|->
name|acl
operator|->
name|elements
index|[
literal|0
index|]
operator|.
name|negative
operator|==
name|ISC_FALSE
operator|&&
name|elt
operator|->
name|acl
operator|->
name|elements
index|[
literal|0
index|]
operator|.
name|type
operator|==
name|dns_aclelementtype_any
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
comment|/* listen-on-v6 { any; } */
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
comment|/* All others */
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|setup_locals
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|,
name|isc_interface_t
modifier|*
name|interface
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_aclelement_t
name|elt
decl_stmt|;
name|unsigned
name|int
name|family
decl_stmt|;
name|unsigned
name|int
name|prefixlen
decl_stmt|;
name|family
operator|=
name|interface
operator|->
name|address
operator|.
name|family
expr_stmt|;
name|elt
operator|.
name|type
operator|=
name|dns_aclelementtype_ipprefix
expr_stmt|;
name|elt
operator|.
name|negative
operator|=
name|ISC_FALSE
expr_stmt|;
name|elt
operator|.
name|u
operator|.
name|ip_prefix
operator|.
name|address
operator|=
name|interface
operator|->
name|address
expr_stmt|;
name|elt
operator|.
name|u
operator|.
name|ip_prefix
operator|.
name|prefixlen
operator|=
operator|(
name|family
operator|==
name|AF_INET
operator|)
condition|?
literal|32
else|:
literal|128
expr_stmt|;
name|result
operator|=
name|dns_acl_appendelement
argument_list|(
name|mgr
operator|->
name|aclenv
operator|.
name|localhost
argument_list|,
operator|&
name|elt
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|isc_netaddr_masktoprefixlen
argument_list|(
operator|&
name|interface
operator|->
name|netmask
argument_list|,
operator|&
name|prefixlen
argument_list|)
expr_stmt|;
comment|/* Non contigious netmasks not allowed by IPv6 arch. */
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|family
operator|==
name|AF_INET6
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"omitting IPv4 interface %s from "
literal|"localnets ACL: %s"
argument_list|,
name|interface
operator|->
name|name
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|elt
operator|.
name|u
operator|.
name|ip_prefix
operator|.
name|prefixlen
operator|=
name|prefixlen
expr_stmt|;
if|if
condition|(
name|dns_acl_elementmatch
argument_list|(
name|mgr
operator|->
name|aclenv
operator|.
name|localnets
argument_list|,
operator|&
name|elt
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
name|result
operator|=
name|dns_acl_appendelement
argument_list|(
name|mgr
operator|->
name|aclenv
operator|.
name|localnets
argument_list|,
operator|&
name|elt
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|do_scan
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|,
name|ns_listenlist_t
modifier|*
name|ext_listen
parameter_list|,
name|isc_boolean_t
name|verbose
parameter_list|)
block|{
name|isc_interfaceiter_t
modifier|*
name|iter
init|=
name|NULL
decl_stmt|;
name|isc_boolean_t
name|scan_ipv4
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|scan_ipv6
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|adjusting
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|ipv6only
init|=
name|ISC_TRUE
decl_stmt|;
name|isc_boolean_t
name|ipv6pktinfo
init|=
name|ISC_TRUE
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_netaddr_t
name|zero_address
decl_stmt|,
name|zero_address6
decl_stmt|;
name|ns_listenelt_t
modifier|*
name|le
decl_stmt|;
name|isc_sockaddr_t
name|listen_addr
decl_stmt|;
name|ns_interface_t
modifier|*
name|ifp
decl_stmt|;
name|isc_boolean_t
name|log_explicit
init|=
name|ISC_FALSE
decl_stmt|;
if|if
condition|(
name|ext_listen
operator|!=
name|NULL
condition|)
name|adjusting
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
name|isc_net_probeipv6
argument_list|()
operator|==
name|ISC_R_SUCCESS
condition|)
name|scan_ipv6
operator|=
name|ISC_TRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|WANT_IPV6
else|else
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|verbose
condition|?
name|ISC_LOG_INFO
else|:
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"no IPv6 interfaces found"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|isc_net_probeipv4
argument_list|()
operator|==
name|ISC_R_SUCCESS
condition|)
name|scan_ipv4
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|verbose
condition|?
name|ISC_LOG_INFO
else|:
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"no IPv4 interfaces found"
argument_list|)
expr_stmt|;
comment|/* 	 * A special, but typical case; listen-on-v6 { any; }. 	 * When we can make the socket IPv6-only, open a single wildcard 	 * socket for IPv6 communication.  Otherwise, make separate socket 	 * for each IPv6 address in order to avoid accepting IPv4 packets 	 * as the form of mapped addresses unintentionally unless explicitly 	 * allowed. 	 */
ifndef|#
directive|ifndef
name|ISC_ALLOW_MAPPED
if|if
condition|(
name|scan_ipv6
operator|==
name|ISC_TRUE
operator|&&
name|isc_net_probe_ipv6only
argument_list|()
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|ipv6only
operator|=
name|ISC_FALSE
expr_stmt|;
name|log_explicit
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|scan_ipv6
operator|==
name|ISC_TRUE
operator|&&
name|isc_net_probe_ipv6pktinfo
argument_list|()
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|ipv6pktinfo
operator|=
name|ISC_FALSE
expr_stmt|;
name|log_explicit
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|scan_ipv6
operator|==
name|ISC_TRUE
operator|&&
name|ipv6only
operator|&&
name|ipv6pktinfo
condition|)
block|{
for|for
control|(
name|le
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|mgr
operator|->
name|listenon6
operator|->
name|elts
argument_list|)
init|;
name|le
operator|!=
name|NULL
condition|;
name|le
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|le
argument_list|,
name|link
argument_list|)
control|)
block|{
name|struct
name|in6_addr
name|in6a
decl_stmt|;
if|if
condition|(
operator|!
name|listenon_is_ip6_any
argument_list|(
name|le
argument_list|)
condition|)
continue|continue;
name|in6a
operator|=
name|in6addr_any
expr_stmt|;
name|isc_sockaddr_fromin6
argument_list|(
operator|&
name|listen_addr
argument_list|,
operator|&
name|in6a
argument_list|,
name|le
operator|->
name|port
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|find_matching_interface
argument_list|(
name|mgr
argument_list|,
operator|&
name|listen_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|!=
name|NULL
condition|)
block|{
name|ifp
operator|->
name|generation
operator|=
name|mgr
operator|->
name|generation
expr_stmt|;
block|}
else|else
block|{
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"listening on IPv6 "
literal|"interfaces, port %u"
argument_list|,
name|le
operator|->
name|port
argument_list|)
expr_stmt|;
name|result
operator|=
name|ns_interface_setup
argument_list|(
name|mgr
argument_list|,
operator|&
name|listen_addr
argument_list|,
literal|"<any>"
argument_list|,
operator|&
name|ifp
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|ifp
operator|->
name|flags
operator||=
name|NS_INTERFACEFLAG_ANYADDR
expr_stmt|;
else|else
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"listening on all IPv6 "
literal|"interfaces failed"
argument_list|)
expr_stmt|;
comment|/* Continue. */
block|}
block|}
block|}
name|isc_netaddr_any
argument_list|(
operator|&
name|zero_address
argument_list|)
expr_stmt|;
name|isc_netaddr_any6
argument_list|(
operator|&
name|zero_address6
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_interfaceiter_create
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|adjusting
operator|==
name|ISC_FALSE
condition|)
block|{
name|result
operator|=
name|clearacl
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
operator|&
name|mgr
operator|->
name|aclenv
operator|.
name|localhost
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_iter
goto|;
name|result
operator|=
name|clearacl
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
operator|&
name|mgr
operator|->
name|aclenv
operator|.
name|localnets
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_iter
goto|;
block|}
for|for
control|(
name|result
operator|=
name|isc_interfaceiter_first
argument_list|(
name|iter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|isc_interfaceiter_next
argument_list|(
name|iter
argument_list|)
control|)
block|{
name|isc_interface_t
name|interface
decl_stmt|;
name|ns_listenlist_t
modifier|*
name|ll
decl_stmt|;
name|unsigned
name|int
name|family
decl_stmt|;
name|result
operator|=
name|isc_interfaceiter_current
argument_list|(
name|iter
argument_list|,
operator|&
name|interface
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
break|break;
name|family
operator|=
name|interface
operator|.
name|address
operator|.
name|family
expr_stmt|;
if|if
condition|(
name|family
operator|!=
name|AF_INET
operator|&&
name|family
operator|!=
name|AF_INET6
condition|)
continue|continue;
if|if
condition|(
name|scan_ipv4
operator|==
name|ISC_FALSE
operator|&&
name|family
operator|==
name|AF_INET
condition|)
continue|continue;
if|if
condition|(
name|scan_ipv6
operator|==
name|ISC_FALSE
operator|&&
name|family
operator|==
name|AF_INET6
condition|)
continue|continue;
comment|/* 		 * Test for the address being nonzero rather than testing 		 * INTERFACE_F_UP, because on some systems the latter 		 * follows the media state and we could end up ignoring 		 * the interface for an entire rescan interval due to 		 * a temporary media glitch at rescan time. 		 */
if|if
condition|(
name|family
operator|==
name|AF_INET
operator|&&
name|isc_netaddr_equal
argument_list|(
operator|&
name|interface
operator|.
name|address
argument_list|,
operator|&
name|zero_address
argument_list|)
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|family
operator|==
name|AF_INET6
operator|&&
name|isc_netaddr_equal
argument_list|(
operator|&
name|interface
operator|.
name|address
argument_list|,
operator|&
name|zero_address6
argument_list|)
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|adjusting
operator|==
name|ISC_FALSE
condition|)
block|{
name|result
operator|=
name|setup_locals
argument_list|(
name|mgr
argument_list|,
operator|&
name|interface
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|ignore_interface
goto|;
block|}
name|ll
operator|=
operator|(
name|family
operator|==
name|AF_INET
operator|)
condition|?
name|mgr
operator|->
name|listenon4
else|:
name|mgr
operator|->
name|listenon6
expr_stmt|;
for|for
control|(
name|le
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|ll
operator|->
name|elts
argument_list|)
init|;
name|le
operator|!=
name|NULL
condition|;
name|le
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|le
argument_list|,
name|link
argument_list|)
control|)
block|{
name|int
name|match
decl_stmt|;
name|isc_boolean_t
name|ipv6_wildcard
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_netaddr_t
name|listen_netaddr
decl_stmt|;
name|isc_sockaddr_t
name|listen_sockaddr
decl_stmt|;
comment|/* 			 * Construct a socket address for this IP/port 			 * combination. 			 */
if|if
condition|(
name|family
operator|==
name|AF_INET
condition|)
block|{
name|isc_netaddr_fromin
argument_list|(
operator|&
name|listen_netaddr
argument_list|,
operator|&
name|interface
operator|.
name|address
operator|.
name|type
operator|.
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isc_netaddr_fromin6
argument_list|(
operator|&
name|listen_netaddr
argument_list|,
operator|&
name|interface
operator|.
name|address
operator|.
name|type
operator|.
name|in6
argument_list|)
expr_stmt|;
name|isc_netaddr_setzone
argument_list|(
operator|&
name|listen_netaddr
argument_list|,
name|interface
operator|.
name|address
operator|.
name|zone
argument_list|)
expr_stmt|;
block|}
name|isc_sockaddr_fromnetaddr
argument_list|(
operator|&
name|listen_sockaddr
argument_list|,
operator|&
name|listen_netaddr
argument_list|,
name|le
operator|->
name|port
argument_list|)
expr_stmt|;
comment|/* 			 * See if the address matches the listen-on statement; 			 * if not, ignore the interface. 			 */
operator|(
name|void
operator|)
name|dns_acl_match
argument_list|(
operator|&
name|listen_netaddr
argument_list|,
name|NULL
argument_list|,
name|le
operator|->
name|acl
argument_list|,
operator|&
name|mgr
operator|->
name|aclenv
argument_list|,
operator|&
name|match
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|match
operator|<=
literal|0
condition|)
continue|continue;
comment|/* 			 * The case of "any" IPv6 address will require 			 * special considerations later, so remember it. 			 */
if|if
condition|(
name|family
operator|==
name|AF_INET6
operator|&&
name|ipv6only
operator|&&
name|ipv6pktinfo
operator|&&
name|listenon_is_ip6_any
argument_list|(
name|le
argument_list|)
condition|)
name|ipv6_wildcard
operator|=
name|ISC_TRUE
expr_stmt|;
comment|/* 			 * When adjusting interfaces with extra a listening 			 * list, see if the address matches the extra list. 			 * If it does, and is also covered by a wildcard 			 * interface, we need to listen on the address 			 * explicitly. 			 */
if|if
condition|(
name|adjusting
operator|==
name|ISC_TRUE
condition|)
block|{
name|ns_listenelt_t
modifier|*
name|ele
decl_stmt|;
name|match
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ele
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|ext_listen
operator|->
name|elts
argument_list|)
init|;
name|ele
operator|!=
name|NULL
condition|;
name|ele
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|ele
argument_list|,
name|link
argument_list|)
control|)
block|{
operator|(
name|void
operator|)
name|dns_acl_match
argument_list|(
operator|&
name|listen_netaddr
argument_list|,
name|NULL
argument_list|,
name|ele
operator|->
name|acl
argument_list|,
name|NULL
argument_list|,
operator|&
name|match
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|match
operator|>
literal|0
operator|&&
name|ele
operator|->
name|port
operator|==
name|le
operator|->
name|port
condition|)
break|break;
else|else
name|match
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ipv6_wildcard
operator|==
name|ISC_TRUE
operator|&&
name|match
operator|==
literal|0
condition|)
continue|continue;
block|}
name|ifp
operator|=
name|find_matching_interface
argument_list|(
name|mgr
argument_list|,
operator|&
name|listen_sockaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|!=
name|NULL
condition|)
block|{
name|ifp
operator|->
name|generation
operator|=
name|mgr
operator|->
name|generation
expr_stmt|;
block|}
else|else
block|{
name|char
name|sabuf
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
if|if
condition|(
name|adjusting
operator|==
name|ISC_FALSE
operator|&&
name|ipv6_wildcard
operator|==
name|ISC_TRUE
condition|)
continue|continue;
if|if
condition|(
name|log_explicit
operator|&&
name|family
operator|==
name|AF_INET6
operator|&&
operator|!
name|adjusting
operator|&&
name|listenon_is_ip6_any
argument_list|(
name|le
argument_list|)
condition|)
block|{
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|verbose
condition|?
name|ISC_LOG_INFO
else|:
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"IPv6 socket API is "
literal|"incomplete; explicitly "
literal|"binding to each IPv6 "
literal|"address separately"
argument_list|)
expr_stmt|;
name|log_explicit
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
name|isc_sockaddr_format
argument_list|(
operator|&
name|listen_sockaddr
argument_list|,
name|sabuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sabuf
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"%s"
literal|"listening on %s interface "
literal|"%s, %s"
argument_list|,
operator|(
name|adjusting
operator|==
name|ISC_TRUE
operator|)
condition|?
literal|"additionally "
else|:
literal|""
argument_list|,
operator|(
name|family
operator|==
name|AF_INET
operator|)
condition|?
literal|"IPv4"
else|:
literal|"IPv6"
argument_list|,
name|interface
operator|.
name|name
argument_list|,
name|sabuf
argument_list|)
expr_stmt|;
name|result
operator|=
name|ns_interface_setup
argument_list|(
name|mgr
argument_list|,
operator|&
name|listen_sockaddr
argument_list|,
name|interface
operator|.
name|name
argument_list|,
operator|&
name|ifp
argument_list|,
operator|(
name|adjusting
operator|==
name|ISC_TRUE
operator|)
condition|?
name|ISC_FALSE
else|:
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"creating %s interface "
literal|"%s failed; interface "
literal|"ignored"
argument_list|,
operator|(
name|family
operator|==
name|AF_INET
operator|)
condition|?
literal|"IPv4"
else|:
literal|"IPv6"
argument_list|,
name|interface
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
comment|/* Continue. */
block|}
block|}
continue|continue;
name|ignore_interface
label|:
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"ignoring %s interface %s: %s"
argument_list|,
operator|(
name|family
operator|==
name|AF_INET
operator|)
condition|?
literal|"IPv4"
else|:
literal|"IPv6"
argument_list|,
name|interface
operator|.
name|name
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"interface iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|cleanup_iter
label|:
name|isc_interfaceiter_destroy
argument_list|(
operator|&
name|iter
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ns_interfacemgr_scan0
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|,
name|ns_listenlist_t
modifier|*
name|ext_listen
parameter_list|,
name|isc_boolean_t
name|verbose
parameter_list|)
block|{
name|isc_boolean_t
name|purge
init|=
name|ISC_TRUE
decl_stmt|;
name|REQUIRE
argument_list|(
name|NS_INTERFACEMGR_VALID
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
name|mgr
operator|->
name|generation
operator|++
expr_stmt|;
comment|/* Increment the generation count. */
if|if
condition|(
name|do_scan
argument_list|(
name|mgr
argument_list|,
name|ext_listen
argument_list|,
name|verbose
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
name|purge
operator|=
name|ISC_FALSE
expr_stmt|;
comment|/* 	 * Now go through the interface list and delete anything that 	 * does not have the current generation number.  This is 	 * how we catch interfaces that go away or change their 	 * addresses. 	 */
if|if
condition|(
name|purge
condition|)
name|purge_old_interfaces
argument_list|(
name|mgr
argument_list|)
expr_stmt|;
comment|/* 	 * Warn if we are not listening on any interface, unless 	 * we're in lwresd-only mode, in which case that is to  	 * be expected. 	 */
if|if
condition|(
name|ext_listen
operator|==
name|NULL
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|mgr
operator|->
name|interfaces
argument_list|)
operator|&&
operator|!
name|ns_g_lwresdonly
condition|)
block|{
name|isc_log_write
argument_list|(
name|IFMGR_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"not listening on any interfaces"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ns_interfacemgr_scan
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|,
name|isc_boolean_t
name|verbose
parameter_list|)
block|{
name|ns_interfacemgr_scan0
argument_list|(
name|mgr
argument_list|,
name|NULL
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_interfacemgr_adjust
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|,
name|ns_listenlist_t
modifier|*
name|list
parameter_list|,
name|isc_boolean_t
name|verbose
parameter_list|)
block|{
name|ns_interfacemgr_scan0
argument_list|(
name|mgr
argument_list|,
name|list
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_interfacemgr_setlistenon4
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|,
name|ns_listenlist_t
modifier|*
name|value
parameter_list|)
block|{
name|LOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ns_listenlist_detach
argument_list|(
operator|&
name|mgr
operator|->
name|listenon4
argument_list|)
expr_stmt|;
name|ns_listenlist_attach
argument_list|(
name|value
argument_list|,
operator|&
name|mgr
operator|->
name|listenon4
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_interfacemgr_setlistenon6
parameter_list|(
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|,
name|ns_listenlist_t
modifier|*
name|value
parameter_list|)
block|{
name|LOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ns_listenlist_detach
argument_list|(
operator|&
name|mgr
operator|->
name|listenon6
argument_list|)
expr_stmt|;
name|ns_listenlist_attach
argument_list|(
name|value
argument_list|,
operator|&
name|mgr
operator|->
name|listenon6
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_interfacemgr_dumprecursing
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|ns_interfacemgr_t
modifier|*
name|mgr
parameter_list|)
block|{
name|ns_interface_t
modifier|*
name|interface
decl_stmt|;
name|LOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|interface
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|mgr
operator|->
name|interfaces
argument_list|)
expr_stmt|;
while|while
condition|(
name|interface
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|interface
operator|->
name|clientmgr
operator|!=
name|NULL
condition|)
name|ns_client_dumprecursing
argument_list|(
name|f
argument_list|,
name|interface
operator|->
name|clientmgr
argument_list|)
expr_stmt|;
name|interface
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|interface
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


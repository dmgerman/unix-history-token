begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004-2006  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 2000-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: rndc.c,v 1.77.2.5.2.19 2006/08/04 03:03:08 marka Exp $ */
end_comment

begin_comment
comment|/*  * Principal Author: DCL  */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<isc/app.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_include
include|#
directive|include
file|<isc/commandline.h>
end_include

begin_include
include|#
directive|include
file|<isc/file.h>
end_include

begin_include
include|#
directive|include
file|<isc/log.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/random.h>
end_include

begin_include
include|#
directive|include
file|<isc/socket.h>
end_include

begin_include
include|#
directive|include
file|<isc/stdtime.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/thread.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<isccfg/namedconf.h>
end_include

begin_include
include|#
directive|include
file|<isccc/alist.h>
end_include

begin_include
include|#
directive|include
file|<isccc/base64.h>
end_include

begin_include
include|#
directive|include
file|<isccc/cc.h>
end_include

begin_include
include|#
directive|include
file|<isccc/ccmsg.h>
end_include

begin_include
include|#
directive|include
file|<isccc/result.h>
end_include

begin_include
include|#
directive|include
file|<isccc/sexpr.h>
end_include

begin_include
include|#
directive|include
file|<isccc/types.h>
end_include

begin_include
include|#
directive|include
file|<isccc/util.h>
end_include

begin_include
include|#
directive|include
file|<bind9/getaddresses.h>
end_include

begin_include
include|#
directive|include
file|"util.h"
end_include

begin_define
define|#
directive|define
name|SERVERADDRS
value|10
end_define

begin_decl_stmt
name|char
modifier|*
name|progname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|isc_boolean_t
name|verbose
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|admin_conffile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|admin_keyfile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|version
init|=
name|VERSION
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|servername
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_sockaddr_t
name|serveraddrs
index|[
name|SERVERADDRS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nserveraddrs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|currentaddr
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|remoteport
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_socketmgr_t
modifier|*
name|socketmgr
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|databuf
index|[
literal|2048
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isccc_ccmsg_t
name|ccmsg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isccc_region_t
name|secret
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|failed
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sends
decl_stmt|,
name|recvs
decl_stmt|,
name|connects
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|command
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|args
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|program
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_socket_t
modifier|*
name|sock
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_uint32_t
name|serial
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|rndc_startconnect
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|int
name|status
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\ Usage: %s [-c config] [-s server] [-p port]\n\         [-k key-file ] [-y key] [-V] command\n\ \n\ command is one of the following:\n\ \n\   reload	Reload configuration file and zones.\n\   reload zone [class [view]]\n\ 		Reload a single zone.\n\   refresh zone [class [view]]\n\ 		Schedule immediate maintenance for a zone.\n\   retransfer zone [class [view]]\n\ 		Retransfer a single zone without checking serial number.\n\   freeze zone [class [view]]\n\   		Suspend updates to a dynamic zone.\n\   thaw zone [class [view]]\n\   		Enable updates to a frozen dynamic zone and reload it.\n\   reconfig	Reload configuration file and new zones only.\n\   stats		Write server statistics to the statistics file.\n\   querylog	Toggle query logging.\n\   dumpdb [-all|-cache|-zones] [view ...]\n\ 		Dump cache(s) to the dump file (named_dump.db).\n\   stop		Save pending updates to master files and stop the server.\n\   stop -p	Save pending updates to master files and stop the server\n\ 		reporting process id.\n\   halt		Stop the server without saving pending updates.\n\   halt -p	Stop the server without saving pending updates reporting\n\ 		process id.\n\   trace		Increment debugging level by one.\n\   trace level	Change the debugging level.\n\   notrace	Set debugging level to 0.\n\   flush 	Flushes all of the server's caches.\n\   flush [view]	Flushes the server's cache for a view.\n\   flushname name [view]\n\ 		Flush the given name from the server's cache(s)\n\   status	Display status of the server.\n\   recursing	Dump the queries that are currently recursing (named.recursing)\n\   *restart	Restart the server.\n\ \n\ * == not yet implemented\n\ Version: %s\n"
argument_list|,
name|progname
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|get_addresses
parameter_list|(
specifier|const
name|char
modifier|*
name|host
parameter_list|,
name|in_port_t
name|port
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_app_block
argument_list|()
expr_stmt|;
name|result
operator|=
name|bind9_getaddresses
argument_list|(
name|servername
argument_list|,
name|port
argument_list|,
name|serveraddrs
argument_list|,
name|SERVERADDRS
argument_list|,
operator|&
name|nserveraddrs
argument_list|)
expr_stmt|;
name|isc_app_unblock
argument_list|()
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"couldn't get address for '%s': %s"
argument_list|,
name|host
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|nserveraddrs
operator|>
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rndc_senddone
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_socketevent_t
modifier|*
name|sevent
init|=
operator|(
name|isc_socketevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|sends
operator|--
expr_stmt|;
if|if
condition|(
name|sevent
operator|->
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"send failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|sevent
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|sends
operator|==
literal|0
operator|&&
name|recvs
operator|==
literal|0
condition|)
block|{
name|isc_socket_detach
argument_list|(
operator|&
name|sock
argument_list|)
expr_stmt|;
name|isc_task_shutdown
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|isc_app_shutdown
argument_list|()
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rndc_recvdone
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|response
init|=
name|NULL
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|data
decl_stmt|;
name|isccc_region_t
name|source
decl_stmt|;
name|char
modifier|*
name|errormsg
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|textmsg
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|recvs
operator|--
expr_stmt|;
if|if
condition|(
name|ccmsg
operator|.
name|result
operator|==
name|ISC_R_EOF
condition|)
name|fatal
argument_list|(
literal|"connection to remote host closed\n"
literal|"This may indicate that the remote server is using "
literal|"an older version of \n"
literal|"the command protocol, this host is not authorized "
literal|"to connect,\nor the key is invalid."
argument_list|)
expr_stmt|;
if|if
condition|(
name|ccmsg
operator|.
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"recv failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|ccmsg
operator|.
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|source
operator|.
name|rstart
operator|=
name|isc_buffer_base
argument_list|(
operator|&
name|ccmsg
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|source
operator|.
name|rend
operator|=
name|isc_buffer_used
argument_list|(
operator|&
name|ccmsg
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"parse message"
argument_list|,
name|isccc_cc_fromwire
argument_list|(
operator|&
name|source
argument_list|,
operator|&
name|response
argument_list|,
operator|&
name|secret
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|=
name|isccc_alist_lookup
argument_list|(
name|response
argument_list|,
literal|"_data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"no data section in response"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isccc_cc_lookupstring
argument_list|(
name|data
argument_list|,
literal|"err"
argument_list|,
operator|&
name|errormsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|failed
operator|=
name|ISC_TRUE
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: '%s' failed: %s\n"
argument_list|,
name|progname
argument_list|,
name|command
argument_list|,
name|errormsg
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOTFOUND
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: parsing response failed: %s\n"
argument_list|,
name|progname
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|isccc_cc_lookupstring
argument_list|(
name|data
argument_list|,
literal|"text"
argument_list|,
operator|&
name|textmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|textmsg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOTFOUND
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: parsing response failed: %s\n"
argument_list|,
name|progname
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|isccc_sexpr_free
argument_list|(
operator|&
name|response
argument_list|)
expr_stmt|;
if|if
condition|(
name|sends
operator|==
literal|0
operator|&&
name|recvs
operator|==
literal|0
condition|)
block|{
name|isc_socket_detach
argument_list|(
operator|&
name|sock
argument_list|)
expr_stmt|;
name|isc_task_shutdown
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|isc_app_shutdown
argument_list|()
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rndc_recvnonce
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|response
init|=
name|NULL
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|_ctrl
decl_stmt|;
name|isccc_region_t
name|source
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_uint32_t
name|nonce
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|isccc_time_t
name|now
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|data
decl_stmt|;
name|isccc_region_t
name|message
decl_stmt|;
name|isc_uint32_t
name|len
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|recvs
operator|--
expr_stmt|;
if|if
condition|(
name|ccmsg
operator|.
name|result
operator|==
name|ISC_R_EOF
condition|)
name|fatal
argument_list|(
literal|"connection to remote host closed\n"
literal|"This may indicate that the remote server is using "
literal|"an older version of \n"
literal|"the command protocol, this host is not authorized "
literal|"to connect,\nor the key is invalid."
argument_list|)
expr_stmt|;
if|if
condition|(
name|ccmsg
operator|.
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"recv failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|ccmsg
operator|.
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|source
operator|.
name|rstart
operator|=
name|isc_buffer_base
argument_list|(
operator|&
name|ccmsg
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|source
operator|.
name|rend
operator|=
name|isc_buffer_used
argument_list|(
operator|&
name|ccmsg
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"parse message"
argument_list|,
name|isccc_cc_fromwire
argument_list|(
operator|&
name|source
argument_list|,
operator|&
name|response
argument_list|,
operator|&
name|secret
argument_list|)
argument_list|)
expr_stmt|;
name|_ctrl
operator|=
name|isccc_alist_lookup
argument_list|(
name|response
argument_list|,
literal|"_ctrl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_ctrl
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"_ctrl section missing"
argument_list|)
expr_stmt|;
name|nonce
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|isccc_cc_lookupuint32
argument_list|(
name|_ctrl
argument_list|,
literal|"_nonce"
argument_list|,
operator|&
name|nonce
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
name|nonce
operator|=
literal|0
expr_stmt|;
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"create message"
argument_list|,
name|isccc_cc_createmessage
argument_list|(
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|++
name|serial
argument_list|,
name|now
argument_list|,
name|now
operator|+
literal|60
argument_list|,
operator|&
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|=
name|isccc_alist_lookup
argument_list|(
name|request
argument_list|,
literal|"_data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"_data section missing"
argument_list|)
expr_stmt|;
if|if
condition|(
name|isccc_cc_definestring
argument_list|(
name|data
argument_list|,
literal|"type"
argument_list|,
name|args
argument_list|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nonce
operator|!=
literal|0
condition|)
block|{
name|_ctrl
operator|=
name|isccc_alist_lookup
argument_list|(
name|request
argument_list|,
literal|"_ctrl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_ctrl
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"_ctrl section missing"
argument_list|)
expr_stmt|;
if|if
condition|(
name|isccc_cc_defineuint32
argument_list|(
name|_ctrl
argument_list|,
literal|"_nonce"
argument_list|,
name|nonce
argument_list|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
block|}
name|message
operator|.
name|rstart
operator|=
name|databuf
operator|+
literal|4
expr_stmt|;
name|message
operator|.
name|rend
operator|=
name|databuf
operator|+
sizeof|sizeof
argument_list|(
name|databuf
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"render message"
argument_list|,
name|isccc_cc_towire
argument_list|(
name|request
argument_list|,
operator|&
name|message
argument_list|,
operator|&
name|secret
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|databuf
argument_list|)
operator|-
name|REGION_SIZE
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|databuf
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|isc_buffer_putuint32
argument_list|(
operator|&
name|b
argument_list|,
name|len
operator|-
literal|4
argument_list|)
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|len
expr_stmt|;
name|r
operator|.
name|base
operator|=
name|databuf
expr_stmt|;
name|isccc_ccmsg_cancelread
argument_list|(
operator|&
name|ccmsg
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"schedule recv"
argument_list|,
name|isccc_ccmsg_readmessage
argument_list|(
operator|&
name|ccmsg
argument_list|,
name|task
argument_list|,
name|rndc_recvdone
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|recvs
operator|++
expr_stmt|;
name|DO
argument_list|(
literal|"send message"
argument_list|,
name|isc_socket_send
argument_list|(
name|sock
argument_list|,
operator|&
name|r
argument_list|,
name|task
argument_list|,
name|rndc_senddone
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|sends
operator|++
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|isccc_sexpr_free
argument_list|(
operator|&
name|response
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|rndc_connected
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_socketevent_t
modifier|*
name|sevent
init|=
operator|(
name|isc_socketevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|data
decl_stmt|;
name|isccc_time_t
name|now
decl_stmt|;
name|isccc_region_t
name|message
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|isc_uint32_t
name|len
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|connects
operator|--
expr_stmt|;
if|if
condition|(
name|sevent
operator|->
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_sockaddr_format
argument_list|(
operator|&
name|serveraddrs
index|[
name|currentaddr
index|]
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sevent
operator|->
name|result
operator|!=
name|ISC_R_CANCELED
operator|&&
operator|++
name|currentaddr
operator|<
name|nserveraddrs
condition|)
block|{
name|notify
argument_list|(
literal|"connection failed: %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|sevent
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|isc_socket_detach
argument_list|(
operator|&
name|sock
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|rndc_startconnect
argument_list|(
operator|&
name|serveraddrs
index|[
name|currentaddr
index|]
argument_list|,
name|task
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
name|fatal
argument_list|(
literal|"connect failed: %s: %s"
argument_list|,
name|socktext
argument_list|,
name|isc_result_totext
argument_list|(
name|sevent
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"create message"
argument_list|,
name|isccc_cc_createmessage
argument_list|(
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|++
name|serial
argument_list|,
name|now
argument_list|,
name|now
operator|+
literal|60
argument_list|,
operator|&
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|=
name|isccc_alist_lookup
argument_list|(
name|request
argument_list|,
literal|"_data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"_data section missing"
argument_list|)
expr_stmt|;
if|if
condition|(
name|isccc_cc_definestring
argument_list|(
name|data
argument_list|,
literal|"type"
argument_list|,
literal|"null"
argument_list|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|message
operator|.
name|rstart
operator|=
name|databuf
operator|+
literal|4
expr_stmt|;
name|message
operator|.
name|rend
operator|=
name|databuf
operator|+
sizeof|sizeof
argument_list|(
name|databuf
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"render message"
argument_list|,
name|isccc_cc_towire
argument_list|(
name|request
argument_list|,
operator|&
name|message
argument_list|,
operator|&
name|secret
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|databuf
argument_list|)
operator|-
name|REGION_SIZE
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|databuf
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|isc_buffer_putuint32
argument_list|(
operator|&
name|b
argument_list|,
name|len
operator|-
literal|4
argument_list|)
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|len
expr_stmt|;
name|r
operator|.
name|base
operator|=
name|databuf
expr_stmt|;
name|isccc_ccmsg_init
argument_list|(
name|mctx
argument_list|,
name|sock
argument_list|,
operator|&
name|ccmsg
argument_list|)
expr_stmt|;
name|isccc_ccmsg_setmaxsize
argument_list|(
operator|&
name|ccmsg
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"schedule recv"
argument_list|,
name|isccc_ccmsg_readmessage
argument_list|(
operator|&
name|ccmsg
argument_list|,
name|task
argument_list|,
name|rndc_recvnonce
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|recvs
operator|++
expr_stmt|;
name|DO
argument_list|(
literal|"send message"
argument_list|,
name|isc_socket_send
argument_list|(
name|sock
argument_list|,
operator|&
name|r
argument_list|,
name|task
argument_list|,
name|rndc_senddone
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|sends
operator|++
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rndc_startconnect
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|char
name|socktext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_sockaddr_format
argument_list|(
name|addr
argument_list|,
name|socktext
argument_list|,
sizeof|sizeof
argument_list|(
name|socktext
argument_list|)
argument_list|)
expr_stmt|;
name|notify
argument_list|(
literal|"using server %s (%s)"
argument_list|,
name|servername
argument_list|,
name|socktext
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"create socket"
argument_list|,
name|isc_socket_create
argument_list|(
name|socketmgr
argument_list|,
name|isc_sockaddr_pf
argument_list|(
name|addr
argument_list|)
argument_list|,
name|isc_sockettype_tcp
argument_list|,
operator|&
name|sock
argument_list|)
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"connect"
argument_list|,
name|isc_socket_connect
argument_list|(
name|sock
argument_list|,
name|addr
argument_list|,
name|task
argument_list|,
name|rndc_connected
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|connects
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rndc_start
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|get_addresses
argument_list|(
name|servername
argument_list|,
operator|(
name|in_port_t
operator|)
name|remoteport
argument_list|)
expr_stmt|;
name|currentaddr
operator|=
literal|0
expr_stmt|;
name|rndc_startconnect
argument_list|(
operator|&
name|serveraddrs
index|[
name|currentaddr
index|]
argument_list|,
name|task
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|parse_config
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_log_t
modifier|*
name|log
parameter_list|,
specifier|const
name|char
modifier|*
name|keyname
parameter_list|,
name|cfg_parser_t
modifier|*
modifier|*
name|pctxp
parameter_list|,
name|cfg_obj_t
modifier|*
modifier|*
name|configp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|char
modifier|*
name|conffile
init|=
name|admin_conffile
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|defkey
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|options
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|servers
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|server
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|keys
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|defport
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|secretobj
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|algorithmobj
init|=
name|NULL
decl_stmt|;
name|cfg_obj_t
modifier|*
name|config
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|elt
decl_stmt|;
specifier|const
name|char
modifier|*
name|secretstr
decl_stmt|;
specifier|const
name|char
modifier|*
name|algorithm
decl_stmt|;
specifier|static
name|char
name|secretarray
index|[
literal|1024
index|]
decl_stmt|;
specifier|const
name|cfg_type_t
modifier|*
name|conftype
init|=
operator|&
name|cfg_type_rndcconf
decl_stmt|;
name|isc_boolean_t
name|key_only
init|=
name|ISC_FALSE
decl_stmt|;
if|if
condition|(
operator|!
name|isc_file_exists
argument_list|(
name|conffile
argument_list|)
condition|)
block|{
name|conffile
operator|=
name|admin_keyfile
expr_stmt|;
name|conftype
operator|=
operator|&
name|cfg_type_rndckey
expr_stmt|;
if|if
condition|(
operator|!
name|isc_file_exists
argument_list|(
name|conffile
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"neither %s nor %s was found"
argument_list|,
name|admin_conffile
argument_list|,
name|admin_keyfile
argument_list|)
expr_stmt|;
name|key_only
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|DO
argument_list|(
literal|"create parser"
argument_list|,
name|cfg_parser_create
argument_list|(
name|mctx
argument_list|,
name|log
argument_list|,
name|pctxp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * The parser will output its own errors, so DO() is not used. 	 */
name|result
operator|=
name|cfg_parse_file
argument_list|(
operator|*
name|pctxp
argument_list|,
name|conffile
argument_list|,
name|conftype
argument_list|,
operator|&
name|config
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"could not load rndc configuration"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|key_only
condition|)
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"options"
argument_list|,
operator|&
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|key_only
operator|&&
name|servername
operator|==
name|NULL
condition|)
name|servername
operator|=
literal|"127.0.0.1"
expr_stmt|;
elseif|else
if|if
condition|(
name|servername
operator|==
name|NULL
operator|&&
name|options
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|defserverobj
init|=
name|NULL
decl_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|options
argument_list|,
literal|"default-server"
argument_list|,
operator|&
name|defserverobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|defserverobj
operator|!=
name|NULL
condition|)
name|servername
operator|=
name|cfg_obj_asstring
argument_list|(
name|defserverobj
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|servername
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"no server specified and no default"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|key_only
condition|)
block|{
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"server"
argument_list|,
operator|&
name|servers
argument_list|)
expr_stmt|;
if|if
condition|(
name|servers
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|elt
operator|=
name|cfg_list_first
argument_list|(
name|servers
argument_list|)
init|;
name|elt
operator|!=
name|NULL
condition|;
name|elt
operator|=
name|cfg_list_next
argument_list|(
name|elt
argument_list|)
control|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|server
operator|=
name|cfg_listelt_value
argument_list|(
name|elt
argument_list|)
expr_stmt|;
name|name
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_map_getname
argument_list|(
name|server
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|name
argument_list|,
name|servername
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|server
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
comment|/* 	 * Look for the name of the key to use. 	 */
if|if
condition|(
name|keyname
operator|!=
name|NULL
condition|)
empty_stmt|;
comment|/* Was set on command line, do nothing. */
elseif|else
if|if
condition|(
name|server
operator|!=
name|NULL
condition|)
block|{
name|DO
argument_list|(
literal|"get key for server"
argument_list|,
name|cfg_map_get
argument_list|(
name|server
argument_list|,
literal|"key"
argument_list|,
operator|&
name|defkey
argument_list|)
argument_list|)
expr_stmt|;
name|keyname
operator|=
name|cfg_obj_asstring
argument_list|(
name|defkey
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|options
operator|!=
name|NULL
condition|)
block|{
name|DO
argument_list|(
literal|"get default key"
argument_list|,
name|cfg_map_get
argument_list|(
name|options
argument_list|,
literal|"default-key"
argument_list|,
operator|&
name|defkey
argument_list|)
argument_list|)
expr_stmt|;
name|keyname
operator|=
name|cfg_obj_asstring
argument_list|(
name|defkey
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|key_only
condition|)
name|fatal
argument_list|(
literal|"no key for server and no default"
argument_list|)
expr_stmt|;
comment|/* 	 * Get the key's definition. 	 */
if|if
condition|(
name|key_only
condition|)
name|DO
argument_list|(
literal|"get key"
argument_list|,
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"key"
argument_list|,
operator|&
name|key
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|DO
argument_list|(
literal|"get config key list"
argument_list|,
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"key"
argument_list|,
operator|&
name|keys
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|elt
operator|=
name|cfg_list_first
argument_list|(
name|keys
argument_list|)
init|;
name|elt
operator|!=
name|NULL
condition|;
name|elt
operator|=
name|cfg_list_next
argument_list|(
name|elt
argument_list|)
control|)
block|{
name|key
operator|=
name|cfg_listelt_value
argument_list|(
name|elt
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|cfg_map_getname
argument_list|(
name|key
argument_list|)
argument_list|)
argument_list|,
name|keyname
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|elt
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"no key definition for name %s"
argument_list|,
name|keyname
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|key
argument_list|,
literal|"secret"
argument_list|,
operator|&
name|secretobj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|key
argument_list|,
literal|"algorithm"
argument_list|,
operator|&
name|algorithmobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|secretobj
operator|==
name|NULL
operator|||
name|algorithmobj
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"key must have algorithm and secret"
argument_list|)
expr_stmt|;
name|secretstr
operator|=
name|cfg_obj_asstring
argument_list|(
name|secretobj
argument_list|)
expr_stmt|;
name|algorithm
operator|=
name|cfg_obj_asstring
argument_list|(
name|algorithmobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|algorithm
argument_list|,
literal|"hmac-md5"
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"unsupported algorithm: %s"
argument_list|,
name|algorithm
argument_list|)
expr_stmt|;
name|secret
operator|.
name|rstart
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|secretarray
expr_stmt|;
name|secret
operator|.
name|rend
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|secretarray
operator|+
sizeof|sizeof
argument_list|(
name|secretarray
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"decode base64 secret"
argument_list|,
name|isccc_base64_decode
argument_list|(
name|secretstr
argument_list|,
operator|&
name|secret
argument_list|)
argument_list|)
expr_stmt|;
name|secret
operator|.
name|rend
operator|=
name|secret
operator|.
name|rstart
expr_stmt|;
name|secret
operator|.
name|rstart
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|secretarray
expr_stmt|;
comment|/* 	 * Find the port to connect to. 	 */
if|if
condition|(
name|remoteport
operator|!=
literal|0
condition|)
empty_stmt|;
comment|/* Was set on command line, do nothing. */
else|else
block|{
if|if
condition|(
name|server
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|server
argument_list|,
literal|"port"
argument_list|,
operator|&
name|defport
argument_list|)
expr_stmt|;
if|if
condition|(
name|defport
operator|==
name|NULL
operator|&&
name|options
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|options
argument_list|,
literal|"default-port"
argument_list|,
operator|&
name|defport
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|defport
operator|!=
name|NULL
condition|)
block|{
name|remoteport
operator|=
name|cfg_obj_asuint32
argument_list|(
name|defport
argument_list|)
expr_stmt|;
if|if
condition|(
name|remoteport
operator|>
literal|65535
operator|||
name|remoteport
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"port %d out of range"
argument_list|,
name|remoteport
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|remoteport
operator|==
literal|0
condition|)
name|remoteport
operator|=
name|NS_CONTROL_PORT
expr_stmt|;
operator|*
name|configp
operator|=
name|config
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|isc_boolean_t
name|show_final_mem
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|isc_taskmgr_t
modifier|*
name|taskmgr
init|=
name|NULL
decl_stmt|;
name|isc_task_t
modifier|*
name|task
init|=
name|NULL
decl_stmt|;
name|isc_log_t
modifier|*
name|log
init|=
name|NULL
decl_stmt|;
name|isc_logconfig_t
modifier|*
name|logconfig
init|=
name|NULL
decl_stmt|;
name|isc_logdestination_t
name|logdest
decl_stmt|;
name|cfg_parser_t
modifier|*
name|pctx
init|=
name|NULL
decl_stmt|;
name|cfg_obj_t
modifier|*
name|config
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|keyname
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|size_t
name|argslen
decl_stmt|;
name|int
name|ch
decl_stmt|;
name|int
name|i
decl_stmt|;
name|result
operator|=
name|isc_file_progname
argument_list|(
operator|*
name|argv
argument_list|,
name|program
argument_list|,
sizeof|sizeof
argument_list|(
name|program
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|memcpy
argument_list|(
name|program
argument_list|,
literal|"rndc"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|progname
operator|=
name|program
expr_stmt|;
name|admin_conffile
operator|=
name|RNDC_CONFFILE
expr_stmt|;
name|admin_keyfile
operator|=
name|RNDC_KEYFILE
expr_stmt|;
name|result
operator|=
name|isc_app_start
argument_list|()
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"isc_app_start() failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|isc_commandline_parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"c:k:Mmp:s:Vy:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'c'
case|:
name|admin_conffile
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
name|admin_keyfile
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
name|isc_mem_debugging
operator|=
name|ISC_MEM_DEBUGTRACE
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|show_final_mem
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|remoteport
operator|=
name|atoi
argument_list|(
name|isc_commandline_argument
argument_list|)
expr_stmt|;
if|if
condition|(
name|remoteport
operator|>
literal|65535
operator|||
name|remoteport
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"port '%s' out of range"
argument_list|,
name|isc_commandline_argument
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|servername
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'V'
case|:
name|verbose
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'y'
case|:
name|keyname
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|usage
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fatal
argument_list|(
literal|"unexpected error parsing command arguments: "
literal|"got %c\n"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|argc
operator|-=
name|isc_commandline_index
expr_stmt|;
name|argv
operator|+=
name|isc_commandline_index
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|isc_random_get
argument_list|(
operator|&
name|serial
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"create memory context"
argument_list|,
name|isc_mem_create
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|mctx
argument_list|)
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"create socket manager"
argument_list|,
name|isc_socketmgr_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|socketmgr
argument_list|)
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"create task manager"
argument_list|,
name|isc_taskmgr_create
argument_list|(
name|mctx
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
operator|&
name|taskmgr
argument_list|)
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"create task"
argument_list|,
name|isc_task_create
argument_list|(
name|taskmgr
argument_list|,
literal|0
argument_list|,
operator|&
name|task
argument_list|)
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"create logging context"
argument_list|,
name|isc_log_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|log
argument_list|,
operator|&
name|logconfig
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_setcontext
argument_list|(
name|log
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"setting log tag"
argument_list|,
name|isc_log_settag
argument_list|(
name|logconfig
argument_list|,
name|progname
argument_list|)
argument_list|)
expr_stmt|;
name|logdest
operator|.
name|file
operator|.
name|stream
operator|=
name|stderr
expr_stmt|;
name|logdest
operator|.
name|file
operator|.
name|name
operator|=
name|NULL
expr_stmt|;
name|logdest
operator|.
name|file
operator|.
name|versions
operator|=
name|ISC_LOG_ROLLNEVER
expr_stmt|;
name|logdest
operator|.
name|file
operator|.
name|maximum_size
operator|=
literal|0
expr_stmt|;
name|DO
argument_list|(
literal|"creating log channel"
argument_list|,
name|isc_log_createchannel
argument_list|(
name|logconfig
argument_list|,
literal|"stderr"
argument_list|,
name|ISC_LOG_TOFILEDESC
argument_list|,
name|ISC_LOG_INFO
argument_list|,
operator|&
name|logdest
argument_list|,
name|ISC_LOG_PRINTTAG
operator||
name|ISC_LOG_PRINTLEVEL
argument_list|)
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"enabling log channel"
argument_list|,
name|isc_log_usechannel
argument_list|(
name|logconfig
argument_list|,
literal|"stderr"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|parse_config
argument_list|(
name|mctx
argument_list|,
name|log
argument_list|,
name|keyname
argument_list|,
operator|&
name|pctx
argument_list|,
operator|&
name|config
argument_list|)
expr_stmt|;
name|isccc_result_register
argument_list|()
expr_stmt|;
name|command
operator|=
operator|*
name|argv
expr_stmt|;
comment|/* 	 * Convert argc/argv into a space-delimited command string 	 * similar to what the user might enter in interactive mode 	 * (if that were implemented). 	 */
name|argslen
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
name|argslen
operator|+=
name|strlen
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
name|args
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|argslen
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|==
name|NULL
condition|)
name|DO
argument_list|(
literal|"isc_mem_get"
argument_list|,
name|ISC_R_NOMEMORY
argument_list|)
expr_stmt|;
name|p
operator|=
name|args
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|size_t
name|len
init|=
name|strlen
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
decl_stmt|;
name|memcpy
argument_list|(
name|p
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|p
operator|+=
name|len
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
block|}
name|p
operator|--
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|INSIST
argument_list|(
name|p
operator|==
name|args
operator|+
name|argslen
argument_list|)
expr_stmt|;
name|notify
argument_list|(
literal|"%s"
argument_list|,
name|command
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|command
argument_list|,
literal|"restart"
argument_list|)
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"'%s' is not implemented"
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|DO
argument_list|(
literal|"post event"
argument_list|,
name|isc_app_onrun
argument_list|(
name|mctx
argument_list|,
name|task
argument_list|,
name|rndc_start
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_app_run
argument_list|()
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"isc_app_run() failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|connects
operator|>
literal|0
operator|||
name|sends
operator|>
literal|0
operator|||
name|recvs
operator|>
literal|0
condition|)
name|isc_socket_cancel
argument_list|(
name|sock
argument_list|,
name|task
argument_list|,
name|ISC_SOCKCANCEL_ALL
argument_list|)
expr_stmt|;
name|isc_task_detach
argument_list|(
operator|&
name|task
argument_list|)
expr_stmt|;
name|isc_taskmgr_destroy
argument_list|(
operator|&
name|taskmgr
argument_list|)
expr_stmt|;
name|isc_socketmgr_destroy
argument_list|(
operator|&
name|socketmgr
argument_list|)
expr_stmt|;
name|isc_log_destroy
argument_list|(
operator|&
name|log
argument_list|)
expr_stmt|;
name|isc_log_setcontext
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|cfg_obj_destroy
argument_list|(
name|pctx
argument_list|,
operator|&
name|config
argument_list|)
expr_stmt|;
name|cfg_parser_destroy
argument_list|(
operator|&
name|pctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|args
argument_list|,
name|argslen
argument_list|)
expr_stmt|;
name|isccc_ccmsg_invalidate
argument_list|(
operator|&
name|ccmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|show_final_mem
condition|)
name|isc_mem_stats
argument_list|(
name|mctx
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|isc_mem_destroy
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|failed
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Portions Copyright (C) 2004-2006  Internet Systems Consortium, Inc. ("ISC")  * Portions Copyright (C) 1999-2003  Internet Software Consortium.  * Portions Copyright (C) 1995-2000 by Network Associates, Inc.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC AND NETWORK ASSOCIATES DISCLAIMS  * ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE  * FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR  * IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: dnssec-signzone.c,v 1.139.2.2.4.23 2006/01/04 23:50:19 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<isc/app.h>
end_include

begin_include
include|#
directive|include
file|<isc/commandline.h>
end_include

begin_include
include|#
directive|include
file|<isc/entropy.h>
end_include

begin_include
include|#
directive|include
file|<isc/event.h>
end_include

begin_include
include|#
directive|include
file|<isc/file.h>
end_include

begin_include
include|#
directive|include
file|<isc/hash.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/mutex.h>
end_include

begin_include
include|#
directive|include
file|<isc/os.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/serial.h>
end_include

begin_include
include|#
directive|include
file|<isc/stdio.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<isc/time.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/dbiterator.h>
end_include

begin_include
include|#
directive|include
file|<dns/diff.h>
end_include

begin_include
include|#
directive|include
file|<dns/dnssec.h>
end_include

begin_include
include|#
directive|include
file|<dns/ds.h>
end_include

begin_include
include|#
directive|include
file|<dns/fixedname.h>
end_include

begin_include
include|#
directive|include
file|<dns/keyvalues.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/master.h>
end_include

begin_include
include|#
directive|include
file|<dns/masterdump.h>
end_include

begin_include
include|#
directive|include
file|<dns/nsec.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdata.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataclass.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatasetiter.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatastruct.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatatype.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/time.h>
end_include

begin_include
include|#
directive|include
file|<dst/dst.h>
end_include

begin_include
include|#
directive|include
file|"dnssectool.h"
end_include

begin_decl_stmt
specifier|const
name|char
modifier|*
name|program
init|=
literal|"dnssec-signzone"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|verbose
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|BUFSIZE
value|2048
end_define

begin_define
define|#
directive|define
name|MAXDSKEYS
value|8
end_define

begin_typedef
typedef|typedef
name|struct
name|signer_key_struct
name|signer_key_t
typedef|;
end_typedef

begin_struct
struct|struct
name|signer_key_struct
block|{
name|dst_key_t
modifier|*
name|key
decl_stmt|;
name|isc_boolean_t
name|issigningkey
decl_stmt|;
name|isc_boolean_t
name|isdsk
decl_stmt|;
name|isc_boolean_t
name|isksk
decl_stmt|;
name|unsigned
name|int
name|position
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|signer_key_t
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|SIGNER_EVENTCLASS
value|ISC_EVENTCLASS(0x4453)
end_define

begin_define
define|#
directive|define
name|SIGNER_EVENT_WRITE
value|(SIGNER_EVENTCLASS + 0)
end_define

begin_define
define|#
directive|define
name|SIGNER_EVENT_WORK
value|(SIGNER_EVENTCLASS + 1)
end_define

begin_typedef
typedef|typedef
name|struct
name|signer_event
name|sevent_t
typedef|;
end_typedef

begin_struct
struct|struct
name|signer_event
block|{
name|ISC_EVENT_COMMON
argument_list|(
name|sevent_t
argument_list|)
expr_stmt|;
name|dns_fixedname_t
modifier|*
name|fname
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
decl_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
specifier|static
name|ISC_LIST
argument_list|(
argument|signer_key_t
argument_list|)
name|keylist
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|keycount
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_stdtime_t
name|starttime
init|=
literal|0
decl_stmt|,
name|endtime
init|=
literal|0
decl_stmt|,
name|now
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|cycle
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|tryverify
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|printstats
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_mem_t
modifier|*
name|mctx
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_entropy_t
modifier|*
name|ectx
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_ttl_t
name|zonettl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|tempfile
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|dns_master_style_t
modifier|*
name|masterstyle
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|nsigned
init|=
literal|0
decl_stmt|,
name|nretained
init|=
literal|0
decl_stmt|,
name|ndropped
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|nverified
init|=
literal|0
decl_stmt|,
name|nverifyfailed
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|directory
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_mutex_t
name|namelock
decl_stmt|,
name|statslock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_taskmgr_t
modifier|*
name|taskmgr
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_db_t
modifier|*
name|gdb
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The database */
end_comment

begin_decl_stmt
specifier|static
name|dns_dbversion_t
modifier|*
name|gversion
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The database version */
end_comment

begin_decl_stmt
specifier|static
name|dns_dbiterator_t
modifier|*
name|gdbiter
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The database iterator */
end_comment

begin_decl_stmt
specifier|static
name|dns_rdataclass_t
name|gclass
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The class */
end_comment

begin_decl_stmt
specifier|static
name|dns_name_t
modifier|*
name|gorigin
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The database origin */
end_comment

begin_decl_stmt
specifier|static
name|isc_task_t
modifier|*
name|master
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|ntasks
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|shuttingdown
init|=
name|ISC_FALSE
decl_stmt|,
name|finished
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|assigned
init|=
literal|0
decl_stmt|,
name|completed
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|nokeys
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|removefile
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|generateds
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|ignoreksk
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_name_t
modifier|*
name|dlv
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_fixedname_t
name|dlv_fixed
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_master_style_t
modifier|*
name|dsstyle
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|INCSTAT
parameter_list|(
name|counter
parameter_list|)
define|\
value|if (printstats) {		\ 		LOCK(&statslock);	\ 		counter++;		\ 		UNLOCK(&statslock);	\ 	}
end_define

begin_function_decl
specifier|static
name|void
name|sign
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
specifier|inline
name|void
name|set_bit
parameter_list|(
name|unsigned
name|char
modifier|*
name|array
parameter_list|,
name|unsigned
name|int
name|index
parameter_list|,
name|unsigned
name|int
name|bit
parameter_list|)
block|{
name|unsigned
name|int
name|shift
decl_stmt|,
name|mask
decl_stmt|;
name|shift
operator|=
literal|7
operator|-
operator|(
name|index
operator|%
literal|8
operator|)
expr_stmt|;
name|mask
operator|=
literal|1
operator|<<
name|shift
expr_stmt|;
if|if
condition|(
name|bit
operator|!=
literal|0
condition|)
name|array
index|[
name|index
operator|/
literal|8
index|]
operator||=
name|mask
expr_stmt|;
else|else
name|array
index|[
name|index
operator|/
literal|8
index|]
operator|&=
operator|(
operator|~
name|mask
operator|&
literal|0xFF
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dumpnode
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|dns_master_dumpnodetostream
argument_list|(
name|mctx
argument_list|,
name|gdb
argument_list|,
name|gversion
argument_list|,
name|node
argument_list|,
name|name
argument_list|,
name|masterstyle
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_master_dumpnodetostream"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dumpdb
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|)
block|{
name|dns_dbiterator_t
modifier|*
name|dbiter
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dbiter
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_db_createiterator
argument_list|(
name|db
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_createiterator()"
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_dbiterator_first
argument_list|(
name|dbiter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
control|)
block|{
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dbiterator_current()"
argument_list|)
expr_stmt|;
name|dumpnode
argument_list|(
name|name
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"iterating database: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_dbiterator_destroy
argument_list|(
operator|&
name|dbiter
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|signer_key_t
modifier|*
name|newkeystruct
parameter_list|(
name|dst_key_t
modifier|*
name|dstkey
parameter_list|,
name|isc_boolean_t
name|signwithkey
parameter_list|)
block|{
name|signer_key_t
modifier|*
name|key
decl_stmt|;
name|key
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|signer_key_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|key
operator|->
name|key
operator|=
name|dstkey
expr_stmt|;
if|if
condition|(
operator|(
name|dst_key_flags
argument_list|(
name|dstkey
argument_list|)
operator|&
name|DNS_KEYFLAG_KSK
operator|)
operator|!=
literal|0
condition|)
block|{
name|key
operator|->
name|issigningkey
operator|=
name|signwithkey
expr_stmt|;
name|key
operator|->
name|isksk
operator|=
name|ISC_TRUE
expr_stmt|;
name|key
operator|->
name|isdsk
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
else|else
block|{
name|key
operator|->
name|issigningkey
operator|=
name|signwithkey
expr_stmt|;
name|key
operator|->
name|isksk
operator|=
name|ISC_FALSE
expr_stmt|;
name|key
operator|->
name|isdsk
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|key
operator|->
name|position
operator|=
name|keycount
operator|++
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|key
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|signwithkey
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|,
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|isc_buffer_t
modifier|*
name|b
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|dns_dnssec_sign
argument_list|(
name|name
argument_list|,
name|rdataset
argument_list|,
name|key
argument_list|,
operator|&
name|starttime
argument_list|,
operator|&
name|endtime
argument_list|,
name|mctx
argument_list|,
name|b
argument_list|,
name|rdata
argument_list|)
expr_stmt|;
name|isc_entropy_stopcallbacksources
argument_list|(
name|ectx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|char
name|keystr
index|[
name|KEY_FORMATSIZE
index|]
decl_stmt|;
name|key_format
argument_list|(
name|key
argument_list|,
name|keystr
argument_list|,
sizeof|sizeof
argument_list|(
name|keystr
argument_list|)
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"dnskey '%s' failed to sign data: %s"
argument_list|,
name|keystr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|INCSTAT
argument_list|(
name|nsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|tryverify
condition|)
block|{
name|result
operator|=
name|dns_dnssec_verify
argument_list|(
name|name
argument_list|,
name|rdataset
argument_list|,
name|key
argument_list|,
name|ISC_TRUE
argument_list|,
name|mctx
argument_list|,
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|vbprintf
argument_list|(
literal|3
argument_list|,
literal|"\tsignature verified\n"
argument_list|)
expr_stmt|;
name|INCSTAT
argument_list|(
name|nverified
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vbprintf
argument_list|(
literal|3
argument_list|,
literal|"\tsignature failed to verify\n"
argument_list|)
expr_stmt|;
name|INCSTAT
argument_list|(
name|nverifyfailed
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|issigningkey
parameter_list|(
name|signer_key_t
modifier|*
name|key
parameter_list|)
block|{
return|return
operator|(
name|key
operator|->
name|issigningkey
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|iszonekey
parameter_list|(
name|signer_key_t
modifier|*
name|key
parameter_list|)
block|{
return|return
operator|(
name|ISC_TF
argument_list|(
name|dns_name_equal
argument_list|(
name|dst_key_name
argument_list|(
name|key
operator|->
name|key
argument_list|)
argument_list|,
name|gorigin
argument_list|)
operator|&&
name|dst_key_iszonekey
argument_list|(
name|key
operator|->
name|key
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Finds the key that generated a RRSIG, if possible.  First look at the keys  * that we've loaded already, and then see if there's a key on disk.  */
end_comment

begin_function
specifier|static
name|signer_key_t
modifier|*
name|keythatsigned
parameter_list|(
name|dns_rdata_rrsig_t
modifier|*
name|rrsig
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dst_key_t
modifier|*
name|pubkey
init|=
name|NULL
decl_stmt|,
modifier|*
name|privkey
init|=
name|NULL
decl_stmt|;
name|signer_key_t
modifier|*
name|key
decl_stmt|;
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
expr_stmt|;
while|while
condition|(
name|key
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|rrsig
operator|->
name|keyid
operator|==
name|dst_key_id
argument_list|(
name|key
operator|->
name|key
argument_list|)
operator|&&
name|rrsig
operator|->
name|algorithm
operator|==
name|dst_key_alg
argument_list|(
name|key
operator|->
name|key
argument_list|)
operator|&&
name|dns_name_equal
argument_list|(
operator|&
name|rrsig
operator|->
name|signer
argument_list|,
name|dst_key_name
argument_list|(
name|key
operator|->
name|key
argument_list|)
argument_list|)
condition|)
return|return
name|key
return|;
name|key
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dst_key_fromfile
argument_list|(
operator|&
name|rrsig
operator|->
name|signer
argument_list|,
name|rrsig
operator|->
name|keyid
argument_list|,
name|rrsig
operator|->
name|algorithm
argument_list|,
name|DST_TYPE_PUBLIC
argument_list|,
name|NULL
argument_list|,
name|mctx
argument_list|,
operator|&
name|pubkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|result
operator|=
name|dst_key_fromfile
argument_list|(
operator|&
name|rrsig
operator|->
name|signer
argument_list|,
name|rrsig
operator|->
name|keyid
argument_list|,
name|rrsig
operator|->
name|algorithm
argument_list|,
name|DST_TYPE_PUBLIC
operator||
name|DST_TYPE_PRIVATE
argument_list|,
name|NULL
argument_list|,
name|mctx
argument_list|,
operator|&
name|privkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dst_key_free
argument_list|(
operator|&
name|pubkey
argument_list|)
expr_stmt|;
name|key
operator|=
name|newkeystruct
argument_list|(
name|privkey
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
else|else
name|key
operator|=
name|newkeystruct
argument_list|(
name|pubkey
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|keylist
argument_list|,
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|key
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check to see if we expect to find a key at this name.  If we see a RRSIG  * and can't find the signing key that we expect to find, we drop the rrsig.  * I'm not sure if this is completely correct, but it seems to work.  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|expecttofindkey
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|unsigned
name|int
name|options
init|=
name|DNS_DBFIND_NOWILD
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_find
argument_list|(
name|gdb
argument_list|,
name|name
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
name|options
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|ISC_R_SUCCESS
case|:
case|case
name|DNS_R_NXDOMAIN
case|:
case|case
name|DNS_R_NXRRSET
case|:
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
case|case
name|DNS_R_DELEGATION
case|:
case|case
name|DNS_R_CNAME
case|:
case|case
name|DNS_R_DNAME
case|:
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"failure looking for '%s DNSKEY' in database: %s"
argument_list|,
name|namestr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
comment|/* removes a warning */
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|setverifies
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|set
parameter_list|,
name|signer_key_t
modifier|*
name|key
parameter_list|,
name|dns_rdata_t
modifier|*
name|rrsig
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|dns_dnssec_verify
argument_list|(
name|name
argument_list|,
name|set
argument_list|,
name|key
operator|->
name|key
argument_list|,
name|ISC_FALSE
argument_list|,
name|mctx
argument_list|,
name|rrsig
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|INCSTAT
argument_list|(
name|nverified
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
else|else
block|{
name|INCSTAT
argument_list|(
name|nverifyfailed
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * Signs a set.  Goes through contortions to decide if each RRSIG should  * be dropped or retained, and then determines if any new SIGs need to  * be generated.  */
end_comment

begin_function
specifier|static
name|void
name|signset
parameter_list|(
name|dns_diff_t
modifier|*
name|del
parameter_list|,
name|dns_diff_t
modifier|*
name|add
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|set
parameter_list|)
block|{
name|dns_rdataset_t
name|sigset
decl_stmt|;
name|dns_rdata_t
name|sigrdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_rrsig_t
name|rrsig
decl_stmt|;
name|signer_key_t
modifier|*
name|key
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_boolean_t
name|nosigs
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
modifier|*
name|wassignedby
decl_stmt|,
modifier|*
name|nowsignedby
decl_stmt|;
name|int
name|arraysize
decl_stmt|;
name|dns_difftuple_t
modifier|*
name|tuple
decl_stmt|;
name|dns_ttl_t
name|ttl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
name|typestr
index|[
name|TYPE_FORMATSIZE
index|]
decl_stmt|;
name|char
name|sigstr
index|[
name|SIG_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|type_format
argument_list|(
name|set
operator|->
name|type
argument_list|,
name|typestr
argument_list|,
sizeof|sizeof
argument_list|(
name|typestr
argument_list|)
argument_list|)
expr_stmt|;
name|ttl
operator|=
name|ISC_MIN
argument_list|(
name|set
operator|->
name|ttl
argument_list|,
name|endtime
operator|-
name|starttime
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|sigset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_rrsig
argument_list|,
name|set
operator|->
name|type
argument_list|,
literal|0
argument_list|,
operator|&
name|sigset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|nosigs
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed while looking for '%s RRSIG %s': %s"
argument_list|,
name|namestr
argument_list|,
name|typestr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|vbprintf
argument_list|(
literal|1
argument_list|,
literal|"%s/%s:\n"
argument_list|,
name|namestr
argument_list|,
name|typestr
argument_list|)
expr_stmt|;
name|arraysize
operator|=
name|keycount
expr_stmt|;
if|if
condition|(
operator|!
name|nosigs
condition|)
name|arraysize
operator|+=
name|dns_rdataset_count
argument_list|(
operator|&
name|sigset
argument_list|)
expr_stmt|;
name|wassignedby
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|arraysize
operator|*
sizeof|sizeof
argument_list|(
name|isc_boolean_t
argument_list|)
argument_list|)
expr_stmt|;
name|nowsignedby
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|arraysize
operator|*
sizeof|sizeof
argument_list|(
name|isc_boolean_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wassignedby
operator|==
name|NULL
operator|||
name|nowsignedby
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|arraysize
condition|;
name|i
operator|++
control|)
name|wassignedby
index|[
name|i
index|]
operator|=
name|nowsignedby
index|[
name|i
index|]
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|nosigs
condition|)
name|result
operator|=
name|ISC_R_NOMORE
expr_stmt|;
else|else
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|sigset
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_boolean_t
name|expired
decl_stmt|,
name|future
decl_stmt|;
name|isc_boolean_t
name|keep
init|=
name|ISC_FALSE
decl_stmt|,
name|resign
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|sigset
argument_list|,
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|sigrdata
argument_list|,
operator|&
name|rrsig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdata_tostruct"
argument_list|)
expr_stmt|;
name|future
operator|=
name|isc_serial_lt
argument_list|(
name|now
argument_list|,
name|rrsig
operator|.
name|timesigned
argument_list|)
expr_stmt|;
name|key
operator|=
name|keythatsigned
argument_list|(
operator|&
name|rrsig
argument_list|)
expr_stmt|;
name|sig_format
argument_list|(
operator|&
name|rrsig
argument_list|,
name|sigstr
argument_list|,
sizeof|sizeof
argument_list|(
name|sigstr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|!=
name|NULL
operator|&&
name|issigningkey
argument_list|(
name|key
argument_list|)
condition|)
name|expired
operator|=
name|isc_serial_gt
argument_list|(
name|now
operator|+
name|cycle
argument_list|,
name|rrsig
operator|.
name|timeexpire
argument_list|)
expr_stmt|;
else|else
name|expired
operator|=
name|isc_serial_gt
argument_list|(
name|now
argument_list|,
name|rrsig
operator|.
name|timeexpire
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_serial_gt
argument_list|(
name|rrsig
operator|.
name|timesigned
argument_list|,
name|rrsig
operator|.
name|timeexpire
argument_list|)
condition|)
block|{
comment|/* rrsig is dropped and not replaced */
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s dropped - "
literal|"invalid validity period\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|key
operator|==
name|NULL
operator|&&
operator|!
name|future
operator|&&
name|expecttofindkey
argument_list|(
operator|&
name|rrsig
operator|.
name|signer
argument_list|)
condition|)
block|{
comment|/* rrsig is dropped and not replaced */
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s dropped - "
literal|"private dnskey not found\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|key
operator|==
name|NULL
operator|||
name|future
condition|)
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s %s - dnskey not found\n"
argument_list|,
name|expired
condition|?
literal|"retained"
else|:
literal|"dropped"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|expired
condition|)
name|keep
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|issigningkey
argument_list|(
name|key
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|expired
operator|&&
name|setverifies
argument_list|(
name|name
argument_list|,
name|set
argument_list|,
name|key
argument_list|,
operator|&
name|sigrdata
argument_list|)
condition|)
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s retained\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
name|keep
operator|=
name|ISC_TRUE
expr_stmt|;
name|wassignedby
index|[
name|key
operator|->
name|position
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
name|nowsignedby
index|[
name|key
operator|->
name|position
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s dropped - %s\n"
argument_list|,
name|sigstr
argument_list|,
name|expired
condition|?
literal|"expired"
else|:
literal|"failed to verify"
argument_list|)
expr_stmt|;
name|wassignedby
index|[
name|key
operator|->
name|position
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
name|resign
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|iszonekey
argument_list|(
name|key
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|expired
operator|&&
name|setverifies
argument_list|(
name|name
argument_list|,
name|set
argument_list|,
name|key
argument_list|,
operator|&
name|sigrdata
argument_list|)
condition|)
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s retained\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
name|keep
operator|=
name|ISC_TRUE
expr_stmt|;
name|wassignedby
index|[
name|key
operator|->
name|position
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
name|nowsignedby
index|[
name|key
operator|->
name|position
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s dropped - %s\n"
argument_list|,
name|sigstr
argument_list|,
name|expired
condition|?
literal|"expired"
else|:
literal|"failed to verify"
argument_list|)
expr_stmt|;
name|wassignedby
index|[
name|key
operator|->
name|position
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|expired
condition|)
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s retained\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
name|keep
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s expired\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|keep
condition|)
block|{
name|nowsignedby
index|[
name|key
operator|->
name|position
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
name|INCSTAT
argument_list|(
name|nretained
argument_list|)
expr_stmt|;
if|if
condition|(
name|sigset
operator|.
name|ttl
operator|!=
name|ttl
condition|)
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\tfixing ttl %s\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
name|tuple
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_DEL
argument_list|,
name|name
argument_list|,
name|sigset
operator|.
name|ttl
argument_list|,
operator|&
name|sigrdata
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
name|del
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
operator|&
name|sigrdata
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
name|add
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|tuple
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_DEL
argument_list|,
name|name
argument_list|,
name|sigset
operator|.
name|ttl
argument_list|,
operator|&
name|sigrdata
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
name|del
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|INCSTAT
argument_list|(
name|ndropped
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|resign
condition|)
block|{
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_rdata_t
name|trdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|unsigned
name|char
name|array
index|[
name|BUFSIZE
index|]
decl_stmt|;
name|char
name|keystr
index|[
name|KEY_FORMATSIZE
index|]
decl_stmt|;
name|INSIST
argument_list|(
operator|!
name|keep
argument_list|)
expr_stmt|;
name|key_format
argument_list|(
name|key
operator|->
name|key
argument_list|,
name|keystr
argument_list|,
sizeof|sizeof
argument_list|(
name|keystr
argument_list|)
argument_list|)
expr_stmt|;
name|vbprintf
argument_list|(
literal|1
argument_list|,
literal|"\tresigning with dnskey %s\n"
argument_list|,
name|keystr
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|array
argument_list|,
sizeof|sizeof
argument_list|(
name|array
argument_list|)
argument_list|)
expr_stmt|;
name|signwithkey
argument_list|(
name|name
argument_list|,
name|set
argument_list|,
operator|&
name|trdata
argument_list|,
name|key
operator|->
name|key
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|nowsignedby
index|[
name|key
operator|->
name|position
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
name|tuple
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
operator|&
name|trdata
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
name|add
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
block|}
name|dns_rdata_reset
argument_list|(
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|rrsig
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|sigset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdataset_first/next"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|sigset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|sigset
argument_list|)
expr_stmt|;
for|for
control|(
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
init|;
name|key
operator|!=
name|NULL
condition|;
name|key
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
control|)
block|{
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_rdata_t
name|trdata
decl_stmt|;
name|unsigned
name|char
name|array
index|[
name|BUFSIZE
index|]
decl_stmt|;
name|char
name|keystr
index|[
name|KEY_FORMATSIZE
index|]
decl_stmt|;
if|if
condition|(
name|nowsignedby
index|[
name|key
operator|->
name|position
index|]
condition|)
continue|continue;
if|if
condition|(
operator|!
name|key
operator|->
name|issigningkey
condition|)
continue|continue;
if|if
condition|(
operator|!
operator|(
name|ignoreksk
operator|||
name|key
operator|->
name|isdsk
operator|||
operator|(
name|key
operator|->
name|isksk
operator|&&
name|set
operator|->
name|type
operator|==
name|dns_rdatatype_dnskey
operator|&&
name|dns_name_equal
argument_list|(
name|name
argument_list|,
name|gorigin
argument_list|)
operator|)
operator|)
condition|)
continue|continue;
name|key_format
argument_list|(
name|key
operator|->
name|key
argument_list|,
name|keystr
argument_list|,
sizeof|sizeof
argument_list|(
name|keystr
argument_list|)
argument_list|)
expr_stmt|;
name|vbprintf
argument_list|(
literal|1
argument_list|,
literal|"\tsigning with dnskey %s\n"
argument_list|,
name|keystr
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
operator|&
name|trdata
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|array
argument_list|,
sizeof|sizeof
argument_list|(
name|array
argument_list|)
argument_list|)
expr_stmt|;
name|signwithkey
argument_list|(
name|name
argument_list|,
name|set
argument_list|,
operator|&
name|trdata
argument_list|,
name|key
operator|->
name|key
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|tuple
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
operator|&
name|trdata
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
name|add
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
block|}
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|wassignedby
argument_list|,
name|arraysize
operator|*
sizeof|sizeof
argument_list|(
name|isc_boolean_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|nowsignedby
argument_list|,
name|arraysize
operator|*
sizeof|sizeof
argument_list|(
name|isc_boolean_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|opendb
parameter_list|(
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|dbp
parameter_list|)
block|{
name|char
name|filename
index|[
literal|256
index|]
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|filename
argument_list|,
sizeof|sizeof
argument_list|(
name|filename
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|directory
operator|!=
name|NULL
condition|)
block|{
name|isc_buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
name|directory
argument_list|)
expr_stmt|;
if|if
condition|(
name|directory
index|[
name|strlen
argument_list|(
name|directory
argument_list|)
operator|-
literal|1
index|]
operator|!=
literal|'/'
condition|)
name|isc_buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
block|}
name|isc_buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_tofilenametext
argument_list|(
name|name
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_name_tofilenametext()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_buffer_availablelength
argument_list|(
operator|&
name|b
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"name '%s' is too long"
argument_list|,
name|namestr
argument_list|)
expr_stmt|;
block|}
name|isc_buffer_putuint8
argument_list|(
operator|&
name|b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_create
argument_list|(
name|mctx
argument_list|,
literal|"rbt"
argument_list|,
name|dns_rootname
argument_list|,
name|dns_dbtype_zone
argument_list|,
name|rdclass
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|dbp
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_create()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_load
argument_list|(
operator|*
name|dbp
argument_list|,
name|filename
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|DNS_R_SEENINCLUDE
condition|)
name|dns_db_detach
argument_list|(
name|dbp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Loads the key set for a child zone, if there is one, and builds DS records.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|loadds
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|isc_uint32_t
name|ttl
parameter_list|,
name|dns_rdataset_t
modifier|*
name|dsset
parameter_list|)
block|{
name|dns_db_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|ver
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataset_t
name|keyset
decl_stmt|;
name|dns_rdata_t
name|key
decl_stmt|,
name|ds
decl_stmt|;
name|unsigned
name|char
name|dsbuf
index|[
name|DNS_DS_BUFFERSIZE
index|]
decl_stmt|;
name|dns_diff_t
name|diff
decl_stmt|;
name|dns_difftuple_t
modifier|*
name|tuple
init|=
name|NULL
decl_stmt|;
name|opendb
argument_list|(
literal|"keyset-"
argument_list|,
name|name
argument_list|,
name|gclass
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
name|name
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_BADDB
operator|)
return|;
block|}
name|dns_rdataset_init
argument_list|(
operator|&
name|keyset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|keyset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"found DNSKEY records\n"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_newversion
argument_list|(
name|db
argument_list|,
operator|&
name|ver
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_newversion"
argument_list|)
expr_stmt|;
name|dns_diff_init
argument_list|(
name|mctx
argument_list|,
operator|&
name|diff
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|keyset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|keyset
argument_list|)
control|)
block|{
name|dns_rdata_init
argument_list|(
operator|&
name|key
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
operator|&
name|ds
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|keyset
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_ds_buildrdata
argument_list|(
name|name
argument_list|,
operator|&
name|key
argument_list|,
name|DNS_DSDIGEST_SHA1
argument_list|,
name|dsbuf
argument_list|,
operator|&
name|ds
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_ds_buildrdata"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
operator|&
name|ds
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
operator|&
name|diff
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_diff_apply
argument_list|(
operator|&
name|diff
argument_list|,
name|db
argument_list|,
name|ver
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_diff_apply"
argument_list|)
expr_stmt|;
name|dns_diff_clear
argument_list|(
operator|&
name|diff
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|ver
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
name|dns_rdatatype_ds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|dsset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_findrdataset"
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|keyset
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|nsec_setbit
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|unsigned
name|int
name|val
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_nsec_t
name|nsec
decl_stmt|;
name|unsigned
name|int
name|newlen
decl_stmt|;
name|unsigned
name|char
name|bitmap
index|[
literal|8192
operator|+
literal|512
index|]
decl_stmt|;
name|unsigned
name|char
name|nsecdata
index|[
literal|8192
operator|+
literal|512
operator|+
name|DNS_NAME_MAXWIRE
index|]
decl_stmt|;
name|isc_boolean_t
name|answer
init|=
name|ISC_FALSE
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|window
decl_stmt|;
name|int
name|octet
decl_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdataset_first()"
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|nsec
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdata_tostruct"
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|nsec
operator|.
name|len
operator|<=
sizeof|sizeof
argument_list|(
name|bitmap
argument_list|)
argument_list|)
expr_stmt|;
name|newlen
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
name|bitmap
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bitmap
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsec
operator|.
name|len
condition|;
name|i
operator|+=
name|len
control|)
block|{
name|INSIST
argument_list|(
name|i
operator|+
literal|2
operator|<=
name|nsec
operator|.
name|len
argument_list|)
expr_stmt|;
name|window
operator|=
name|nsec
operator|.
name|typebits
index|[
name|i
index|]
expr_stmt|;
name|len
operator|=
name|nsec
operator|.
name|typebits
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|i
operator|+=
literal|2
expr_stmt|;
name|INSIST
argument_list|(
name|len
operator|>
literal|0
operator|&&
name|len
operator|<=
literal|32
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|i
operator|+
name|len
operator|<=
name|nsec
operator|.
name|len
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
operator|&
name|bitmap
index|[
name|window
operator|*
literal|32
operator|+
literal|512
index|]
argument_list|,
operator|&
name|nsec
operator|.
name|typebits
index|[
name|i
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
name|set_bit
argument_list|(
name|bitmap
operator|+
literal|512
argument_list|,
name|type
argument_list|,
name|val
argument_list|)
expr_stmt|;
for|for
control|(
name|window
operator|=
literal|0
init|;
name|window
operator|<
literal|256
condition|;
name|window
operator|++
control|)
block|{
for|for
control|(
name|octet
operator|=
literal|31
init|;
name|octet
operator|>=
literal|0
condition|;
name|octet
operator|--
control|)
if|if
condition|(
name|bitmap
index|[
name|window
operator|*
literal|32
operator|+
literal|512
operator|+
name|octet
index|]
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
name|octet
operator|<
literal|0
condition|)
continue|continue;
name|bitmap
index|[
name|newlen
index|]
operator|=
name|window
expr_stmt|;
name|bitmap
index|[
name|newlen
operator|+
literal|1
index|]
operator|=
name|octet
operator|+
literal|1
expr_stmt|;
name|newlen
operator|+=
literal|2
expr_stmt|;
comment|/* 		 * Overlapping move. 		 */
name|memmove
argument_list|(
operator|&
name|bitmap
index|[
name|newlen
index|]
argument_list|,
operator|&
name|bitmap
index|[
name|window
operator|*
literal|32
operator|+
literal|512
index|]
argument_list|,
name|octet
operator|+
literal|1
argument_list|)
expr_stmt|;
name|newlen
operator|+=
name|octet
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|newlen
operator|!=
name|nsec
operator|.
name|len
operator|||
name|memcmp
argument_list|(
name|nsec
operator|.
name|typebits
argument_list|,
name|bitmap
argument_list|,
name|newlen
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|dns_rdata_t
name|newrdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_diff_t
name|diff
decl_stmt|;
name|dns_difftuple_t
modifier|*
name|tuple
init|=
name|NULL
decl_stmt|;
name|dns_diff_init
argument_list|(
name|mctx
argument_list|,
operator|&
name|diff
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_DEL
argument_list|,
name|name
argument_list|,
name|rdataset
operator|->
name|ttl
argument_list|,
operator|&
name|rdata
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
operator|&
name|diff
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|nsec
operator|.
name|typebits
operator|=
name|bitmap
expr_stmt|;
name|nsec
operator|.
name|len
operator|=
name|newlen
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|nsecdata
argument_list|,
sizeof|sizeof
argument_list|(
name|nsecdata
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_fromstruct
argument_list|(
operator|&
name|newrdata
argument_list|,
name|rdata
operator|.
name|rdclass
argument_list|,
name|dns_rdatatype_nsec
argument_list|,
operator|&
name|nsec
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdata_fromstruct"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
name|rdataset
operator|->
name|ttl
argument_list|,
operator|&
name|newrdata
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
operator|&
name|diff
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_diff_apply
argument_list|(
operator|&
name|diff
argument_list|,
name|gdb
argument_list|,
name|gversion
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_apply"
argument_list|)
expr_stmt|;
name|dns_diff_clear
argument_list|(
operator|&
name|diff
argument_list|)
expr_stmt|;
name|answer
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|dns_rdata_freestruct
argument_list|(
operator|&
name|nsec
argument_list|)
expr_stmt|;
return|return
operator|(
name|answer
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|delegation
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|isc_uint32_t
modifier|*
name|ttlp
parameter_list|)
block|{
name|dns_rdataset_t
name|nsset
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|dns_name_equal
argument_list|(
name|name
argument_list|,
name|gorigin
argument_list|)
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
name|dns_rdataset_init
argument_list|(
operator|&
name|nsset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_ns
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|nsset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|nsset
argument_list|)
condition|)
block|{
if|if
condition|(
name|ttlp
operator|!=
name|NULL
condition|)
operator|*
name|ttlp
operator|=
name|nsset
operator|.
name|ttl
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|nsset
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ISC_TF
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Signs all records at a name.  This mostly just signs each set individually,  * but also adds the RRSIG bit to any NSECs generated earlier, deals with  * parent/child KEY signatures, and handles other exceptional cases.  */
end_comment

begin_function
specifier|static
name|void
name|signname
parameter_list|(
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdatasetiter_t
modifier|*
name|rdsiter
decl_stmt|;
name|isc_boolean_t
name|isdelegation
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|hasds
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|changed
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_diff_t
name|del
decl_stmt|,
name|add
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|isc_uint32_t
name|nsttl
init|=
literal|0
decl_stmt|;
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Determine if this is a delegation point. 	 */
if|if
condition|(
name|delegation
argument_list|(
name|name
argument_list|,
name|node
argument_list|,
operator|&
name|nsttl
argument_list|)
condition|)
name|isdelegation
operator|=
name|ISC_TRUE
expr_stmt|;
comment|/* 	 * If this is a delegation point, look for a DS set. 	 */
if|if
condition|(
name|isdelegation
condition|)
block|{
name|dns_rdataset_t
name|dsset
decl_stmt|;
name|dns_rdataset_t
name|sigdsset
decl_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|dsset
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|sigdsset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_ds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|dsset
argument_list|,
operator|&
name|sigdsset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|dsset
argument_list|)
expr_stmt|;
if|if
condition|(
name|generateds
condition|)
block|{
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_ds
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_deleterdataset"
argument_list|)
expr_stmt|;
block|}
else|else
name|hasds
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|generateds
condition|)
block|{
name|result
operator|=
name|loadds
argument_list|(
name|name
argument_list|,
name|nsttl
argument_list|,
operator|&
name|dsset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|dns_db_addrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|dsset
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_addrdataset"
argument_list|)
expr_stmt|;
name|hasds
operator|=
name|ISC_TRUE
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|dsset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|sigdsset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|sigdsset
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|sigdsset
argument_list|)
condition|)
block|{
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_rrsig
argument_list|,
name|dns_rdatatype_ds
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_deleterdataset"
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|sigdsset
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|sigdsset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|sigdsset
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Make sure that NSEC bits are appropriately set. 	 */
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_nsec
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nokeys
condition|)
name|changed
operator|=
name|nsec_setbit
argument_list|(
name|name
argument_list|,
operator|&
name|rdataset
argument_list|,
name|dns_rdatatype_rrsig
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|changed
condition|)
block|{
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_nsec
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hasds
condition|)
operator|(
name|void
operator|)
name|nsec_setbit
argument_list|(
name|name
argument_list|,
operator|&
name|rdataset
argument_list|,
name|dns_rdatatype_ds
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|nsec_setbit
argument_list|(
name|name
argument_list|,
operator|&
name|rdataset
argument_list|,
name|dns_rdatatype_ds
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
comment|/* 	 * Now iterate through the rdatasets. 	 */
name|dns_diff_init
argument_list|(
name|mctx
argument_list|,
operator|&
name|del
argument_list|)
expr_stmt|;
name|dns_diff_init
argument_list|(
name|mctx
argument_list|,
operator|&
name|add
argument_list|)
expr_stmt|;
name|rdsiter
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_db_allrdatasets
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_allrdatasets()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
comment|/* If this is a RRSIG set, skip it. */
if|if
condition|(
name|rdataset
operator|.
name|type
operator|==
name|dns_rdatatype_rrsig
condition|)
goto|goto
name|skip
goto|;
comment|/* 		 * If this name is a delegation point, skip all records 		 * except NSEC and DS sets.  Otherwise check that there 		 * isn't a DS record. 		 */
if|if
condition|(
name|isdelegation
condition|)
block|{
if|if
condition|(
name|rdataset
operator|.
name|type
operator|!=
name|dns_rdatatype_nsec
operator|&&
name|rdataset
operator|.
name|type
operator|!=
name|dns_rdatatype_ds
condition|)
goto|goto
name|skip
goto|;
block|}
elseif|else
if|if
condition|(
name|rdataset
operator|.
name|type
operator|==
name|dns_rdatatype_ds
condition|)
block|{
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"'%s': found DS RRset without NS RRset\n"
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
block|}
name|signset
argument_list|(
operator|&
name|del
argument_list|,
operator|&
name|add
argument_list|,
name|node
argument_list|,
name|name
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|skip
label|:
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration for name '%s' failed: %s"
argument_list|,
name|namestr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_diff_applysilently
argument_list|(
operator|&
name|del
argument_list|,
name|gdb
argument_list|,
name|gversion
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to delete SIGs at node '%s': %s"
argument_list|,
name|namestr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_diff_applysilently
argument_list|(
operator|&
name|add
argument_list|,
name|gdb
argument_list|,
name|gversion
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to add SIGs at node '%s': %s"
argument_list|,
name|namestr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_diff_clear
argument_list|(
operator|&
name|del
argument_list|)
expr_stmt|;
name|dns_diff_clear
argument_list|(
operator|&
name|add
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|active_node
parameter_list|(
name|dns_dbnode_t
modifier|*
name|node
parameter_list|)
block|{
name|dns_rdatasetiter_t
modifier|*
name|rdsiter
init|=
name|NULL
decl_stmt|;
name|dns_rdatasetiter_t
modifier|*
name|rdsiter2
init|=
name|NULL
decl_stmt|;
name|isc_boolean_t
name|active
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdatatype_t
name|type
decl_stmt|;
name|dns_rdatatype_t
name|covers
decl_stmt|;
name|isc_boolean_t
name|found
decl_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_allrdatasets
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_allrdatasets()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|.
name|type
operator|!=
name|dns_rdatatype_nsec
operator|&&
name|rdataset
operator|.
name|type
operator|!=
name|dns_rdatatype_rrsig
condition|)
name|active
operator|=
name|ISC_TRUE
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|active
condition|)
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
else|else
name|result
operator|=
name|ISC_R_NOMORE
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|active
condition|)
block|{
comment|/* 		 * The node is empty of everything but NSEC / RRSIG records. 		 */
for|for
control|(
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
control|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|rdataset
operator|.
name|type
argument_list|,
name|rdataset
operator|.
name|covers
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_deleterdataset()"
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*  		 * Delete RRSIGs for types that no longer exist. 		 */
name|result
operator|=
name|dns_db_allrdatasets
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter2
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_allrdatasets()"
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
control|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|type
operator|=
name|rdataset
operator|.
name|type
expr_stmt|;
name|covers
operator|=
name|rdataset
operator|.
name|covers
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|dns_rdatatype_rrsig
condition|)
continue|continue;
name|found
operator|=
name|ISC_FALSE
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter2
argument_list|)
init|;
operator|!
name|found
operator|&&
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter2
argument_list|)
control|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter2
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|.
name|type
operator|==
name|covers
condition|)
name|found
operator|=
name|ISC_TRUE
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|type
argument_list|,
name|covers
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_deleterdataset(rrsig)"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
operator|&&
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter2
argument_list|)
expr_stmt|;
block|}
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
return|return
operator|(
name|active
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Extracts the TTL from the SOA.  */
end_comment

begin_function
specifier|static
name|dns_ttl_t
name|soattl
parameter_list|(
name|void
parameter_list|)
block|{
name|dns_rdataset_t
name|soaset
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_ttl_t
name|ttl
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_soa_t
name|soa
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|soaset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_find
argument_list|(
name|gdb
argument_list|,
name|gorigin
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_soa
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
operator|&
name|soaset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to find an SOA at the zone apex: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|soaset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdataset_first"
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|soaset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|soa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdata_tostruct"
argument_list|)
expr_stmt|;
name|ttl
operator|=
name|soa
operator|.
name|minimum
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|soaset
argument_list|)
expr_stmt|;
return|return
operator|(
name|ttl
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Delete any RRSIG records at a node.  */
end_comment

begin_function
specifier|static
name|void
name|cleannode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|)
block|{
name|dns_rdatasetiter_t
modifier|*
name|rdsiter
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
name|set
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|,
name|dresult
decl_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_allrdatasets
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_allrdatasets"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_boolean_t
name|destroy
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_rdatatype_t
name|covers
init|=
literal|0
decl_stmt|;
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
name|set
operator|.
name|type
operator|==
name|dns_rdatatype_rrsig
condition|)
block|{
name|covers
operator|=
name|set
operator|.
name|covers
expr_stmt|;
name|destroy
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
if|if
condition|(
name|destroy
condition|)
block|{
name|dresult
operator|=
name|dns_db_deleterdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_rrsig
argument_list|,
name|covers
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|dresult
argument_list|,
literal|"dns_db_deleterdataset"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set up the iterator and global state before starting the tasks.  */
end_comment

begin_function
specifier|static
name|void
name|presign
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|gdbiter
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_db_createiterator
argument_list|(
name|gdb
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|gdbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_createiterator()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_first
argument_list|(
name|gdbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dbiterator_first()"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Clean up the iterator and global state after the tasks complete.  */
end_comment

begin_function
specifier|static
name|void
name|postsign
parameter_list|(
name|void
parameter_list|)
block|{
name|dns_dbiterator_destroy
argument_list|(
operator|&
name|gdbiter
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Assigns a node to a worker thread.  This is protected by the master task's  * lock.  */
end_comment

begin_function
specifier|static
name|void
name|assignwork
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_task_t
modifier|*
name|worker
parameter_list|)
block|{
name|dns_fixedname_t
modifier|*
name|fname
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
decl_stmt|;
name|sevent_t
modifier|*
name|sevent
decl_stmt|;
name|dns_rdataset_t
name|nsec
decl_stmt|;
name|isc_boolean_t
name|found
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|shuttingdown
condition|)
return|return;
if|if
condition|(
name|finished
condition|)
block|{
if|if
condition|(
name|assigned
operator|==
name|completed
condition|)
block|{
name|isc_task_detach
argument_list|(
operator|&
name|task
argument_list|)
expr_stmt|;
name|isc_app_shutdown
argument_list|()
expr_stmt|;
block|}
return|return;
block|}
name|fname
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_fixedname_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fname
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
name|found
operator|=
name|ISC_FALSE
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|namelock
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|found
condition|)
block|{
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|gdbiter
argument_list|,
operator|&
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failure iterating database: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|nsec
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_nsec
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|nsec
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|found
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|dumpnode
argument_list|(
name|name
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|nsec
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|nsec
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|found
condition|)
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|gdbiter
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
block|{
name|finished
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failure iterating database: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|namelock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|found
condition|)
block|{
if|if
condition|(
name|assigned
operator|==
name|completed
condition|)
block|{
name|isc_task_detach
argument_list|(
operator|&
name|task
argument_list|)
expr_stmt|;
name|isc_app_shutdown
argument_list|()
expr_stmt|;
block|}
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_fixedname_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|sevent
operator|=
operator|(
name|sevent_t
operator|*
operator|)
name|isc_event_allocate
argument_list|(
name|mctx
argument_list|,
name|task
argument_list|,
name|SIGNER_EVENT_WORK
argument_list|,
name|sign
argument_list|,
name|NULL
argument_list|,
sizeof|sizeof
argument_list|(
name|sevent_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sevent
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"failed to allocate event\n"
argument_list|)
expr_stmt|;
name|sevent
operator|->
name|node
operator|=
name|node
expr_stmt|;
name|sevent
operator|->
name|fname
operator|=
name|fname
expr_stmt|;
name|isc_task_send
argument_list|(
name|worker
argument_list|,
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|sevent
argument_list|)
argument_list|)
expr_stmt|;
name|assigned
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Start a worker task  */
end_comment

begin_function
specifier|static
name|void
name|startworker
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_task_t
modifier|*
name|worker
decl_stmt|;
name|worker
operator|=
operator|(
name|isc_task_t
operator|*
operator|)
name|event
operator|->
name|ev_arg
expr_stmt|;
name|assignwork
argument_list|(
name|task
argument_list|,
name|worker
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Write a node to the output file, and restart the worker task.  */
end_comment

begin_function
specifier|static
name|void
name|writenode
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_task_t
modifier|*
name|worker
decl_stmt|;
name|sevent_t
modifier|*
name|sevent
init|=
operator|(
name|sevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|completed
operator|++
expr_stmt|;
name|worker
operator|=
operator|(
name|isc_task_t
operator|*
operator|)
name|event
operator|->
name|ev_sender
expr_stmt|;
name|dumpnode
argument_list|(
name|dns_fixedname_name
argument_list|(
name|sevent
operator|->
name|fname
argument_list|)
argument_list|,
name|sevent
operator|->
name|node
argument_list|)
expr_stmt|;
name|cleannode
argument_list|(
name|gdb
argument_list|,
name|gversion
argument_list|,
name|sevent
operator|->
name|node
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|sevent
operator|->
name|node
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|sevent
operator|->
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_fixedname_t
argument_list|)
argument_list|)
expr_stmt|;
name|assignwork
argument_list|(
name|task
argument_list|,
name|worker
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  Sign a database node.  */
end_comment

begin_function
specifier|static
name|void
name|sign
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_fixedname_t
modifier|*
name|fname
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
decl_stmt|;
name|sevent_t
modifier|*
name|sevent
decl_stmt|,
modifier|*
name|wevent
decl_stmt|;
name|sevent
operator|=
operator|(
name|sevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|node
operator|=
name|sevent
operator|->
name|node
expr_stmt|;
name|fname
operator|=
name|sevent
operator|->
name|fname
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|signname
argument_list|(
name|node
argument_list|,
name|dns_fixedname_name
argument_list|(
name|fname
argument_list|)
argument_list|)
expr_stmt|;
name|wevent
operator|=
operator|(
name|sevent_t
operator|*
operator|)
name|isc_event_allocate
argument_list|(
name|mctx
argument_list|,
name|task
argument_list|,
name|SIGNER_EVENT_WRITE
argument_list|,
name|writenode
argument_list|,
name|NULL
argument_list|,
sizeof|sizeof
argument_list|(
name|sevent_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wevent
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"failed to allocate event\n"
argument_list|)
expr_stmt|;
name|wevent
operator|->
name|node
operator|=
name|node
expr_stmt|;
name|wevent
operator|->
name|fname
operator|=
name|fname
expr_stmt|;
name|isc_task_send
argument_list|(
name|master
argument_list|,
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|wevent
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Generate NSEC records for the zone.  */
end_comment

begin_function
specifier|static
name|void
name|nsecify
parameter_list|(
name|void
parameter_list|)
block|{
name|dns_dbiterator_t
modifier|*
name|dbiter
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|,
modifier|*
name|nextnode
init|=
name|NULL
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|,
name|fnextname
decl_stmt|,
name|fzonecut
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|,
modifier|*
name|nextname
decl_stmt|,
modifier|*
name|zonecut
decl_stmt|;
name|isc_boolean_t
name|done
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fnextname
argument_list|)
expr_stmt|;
name|nextname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fnextname
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fzonecut
argument_list|)
expr_stmt|;
name|zonecut
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_db_createiterator
argument_list|(
name|gdb
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_createiterator()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_first
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dbiterator_first()"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|done
condition|)
block|{
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|delegation
argument_list|(
name|name
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|zonecut
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fzonecut
argument_list|)
expr_stmt|;
name|dns_name_copy
argument_list|(
name|name
argument_list|,
name|zonecut
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
name|nextnode
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_boolean_t
name|active
init|=
name|ISC_FALSE
decl_stmt|;
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|nextnode
argument_list|,
name|nextname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
break|break;
name|active
operator|=
name|active_node
argument_list|(
name|nextnode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|active
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|dns_name_issubdomain
argument_list|(
name|nextname
argument_list|,
name|gorigin
argument_list|)
operator|||
operator|(
name|zonecut
operator|!=
name|NULL
operator|&&
name|dns_name_issubdomain
argument_list|(
name|nextname
argument_list|,
name|zonecut
argument_list|)
operator|)
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
block|{
name|dns_name_clone
argument_list|(
name|gorigin
argument_list|,
name|nextname
argument_list|)
expr_stmt|;
name|done
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"iterating through the database failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_nsec_build
argument_list|(
name|gdb
argument_list|,
name|gversion
argument_list|,
name|node
argument_list|,
name|nextname
argument_list|,
name|zonettl
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_nsec_build()"
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
block|}
name|dns_dbiterator_destroy
argument_list|(
operator|&
name|dbiter
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Load the zone file from disk  */
end_comment

begin_function
specifier|static
name|void
name|loadzone
parameter_list|(
name|char
modifier|*
name|file
parameter_list|,
name|char
modifier|*
name|origin
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|db
parameter_list|)
block|{
name|isc_buffer_t
name|b
decl_stmt|;
name|int
name|len
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|origin
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|origin
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|name
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed converting name '%s' to dns format: %s"
argument_list|,
name|origin
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_create
argument_list|(
name|mctx
argument_list|,
literal|"rbt"
argument_list|,
name|name
argument_list|,
name|dns_dbtype_zone
argument_list|,
name|rdclass
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_create()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_load
argument_list|(
operator|*
name|db
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|DNS_R_SEENINCLUDE
condition|)
name|fatal
argument_list|(
literal|"failed loading zone from '%s': %s"
argument_list|,
name|file
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Finds all public zone keys in the zone, and attempts to load the  * private keys from disk.  */
end_comment

begin_function
specifier|static
name|void
name|loadzonekeys
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|)
block|{
name|dns_dbnode_t
modifier|*
name|node
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|currentversion
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dst_key_t
modifier|*
name|keys
index|[
literal|20
index|]
decl_stmt|;
name|unsigned
name|int
name|nkeys
decl_stmt|,
name|i
decl_stmt|;
name|currentversion
operator|=
name|NULL
expr_stmt|;
name|dns_db_currentversion
argument_list|(
name|db
argument_list|,
operator|&
name|currentversion
argument_list|)
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
name|gorigin
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to find the zone's origin: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dnssec_findzonekeys
argument_list|(
name|db
argument_list|,
name|currentversion
argument_list|,
name|node
argument_list|,
name|gorigin
argument_list|,
name|mctx
argument_list|,
literal|20
argument_list|,
name|keys
argument_list|,
operator|&
name|nkeys
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to find the zone keys: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nkeys
condition|;
name|i
operator|++
control|)
block|{
name|signer_key_t
modifier|*
name|key
decl_stmt|;
name|key
operator|=
name|newkeystruct
argument_list|(
name|keys
index|[
name|i
index|]
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|keylist
argument_list|,
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|currentversion
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Finds all public zone keys in the zone.  */
end_comment

begin_function
specifier|static
name|void
name|loadzonepubkeys
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|)
block|{
name|dns_dbversion_t
modifier|*
name|currentversion
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dst_key_t
modifier|*
name|pubkey
decl_stmt|;
name|signer_key_t
modifier|*
name|key
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_db_currentversion
argument_list|(
name|db
argument_list|,
operator|&
name|currentversion
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
name|gorigin
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to find the zone's origin: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|currentversion
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to find keys at the zone apex: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdataset_first"
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|pubkey
operator|=
name|NULL
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dnssec_keyfromrdata
argument_list|(
name|gorigin
argument_list|,
operator|&
name|rdata
argument_list|,
name|mctx
argument_list|,
operator|&
name|pubkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|next
goto|;
if|if
condition|(
operator|!
name|dst_key_iszonekey
argument_list|(
name|pubkey
argument_list|)
condition|)
block|{
name|dst_key_free
argument_list|(
operator|&
name|pubkey
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
name|key
operator|=
name|newkeystruct
argument_list|(
name|pubkey
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|keylist
argument_list|,
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|next
label|:
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|currentversion
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|warnifallksk
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|)
block|{
name|dns_dbversion_t
modifier|*
name|currentversion
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdata_key_t
name|key
decl_stmt|;
name|isc_boolean_t
name|have_non_ksk
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_db_currentversion
argument_list|(
name|db
argument_list|,
operator|&
name|currentversion
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
name|gorigin
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to find the zone's origin: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|currentversion
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to find keys at the zone apex: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdataset_first"
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdata_tostruct"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|key
operator|.
name|flags
operator|&
name|DNS_KEYFLAG_KSK
operator|)
operator|==
literal|0
condition|)
block|{
name|have_non_ksk
operator|=
name|ISC_TRUE
expr_stmt|;
name|result
operator|=
name|ISC_R_NOMORE
expr_stmt|;
block|}
else|else
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|currentversion
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_non_ksk
operator|&&
operator|!
name|ignoreksk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: warning: No non-KSK dnskey found. "
literal|"Supply non-KSK dnskey or use '-z'.\n"
argument_list|,
name|program
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|writeset
parameter_list|(
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|)
block|{
name|char
modifier|*
name|filename
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_db_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|version
init|=
name|NULL
decl_stmt|;
name|dns_diff_t
name|diff
decl_stmt|;
name|dns_difftuple_t
modifier|*
name|tuple
init|=
name|NULL
decl_stmt|;
name|dns_fixedname_t
name|fixed
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_rdata_t
name|rdata
decl_stmt|,
name|ds
decl_stmt|;
name|isc_boolean_t
name|have_ksk
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|have_non_ksk
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_buffer_t
name|namebuf
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|signer_key_t
modifier|*
name|key
decl_stmt|;
name|unsigned
name|char
name|dsbuf
index|[
name|DNS_DS_BUFFERSIZE
index|]
decl_stmt|;
name|unsigned
name|char
name|keybuf
index|[
name|DST_KEY_MAXSIZE
index|]
decl_stmt|;
name|unsigned
name|int
name|filenamelen
decl_stmt|;
specifier|const
name|dns_master_style_t
modifier|*
name|style
init|=
operator|(
name|type
operator|==
name|dns_rdatatype_dnskey
operator|)
condition|?
name|masterstyle
else|:
name|dsstyle
decl_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|namebuf
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_tofilenametext
argument_list|(
name|gorigin
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|namebuf
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_name_tofilenametext"
argument_list|)
expr_stmt|;
name|isc_buffer_putuint8
argument_list|(
operator|&
name|namebuf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|filenamelen
operator|=
name|strlen
argument_list|(
name|prefix
argument_list|)
operator|+
name|strlen
argument_list|(
name|namestr
argument_list|)
expr_stmt|;
if|if
condition|(
name|directory
operator|!=
name|NULL
condition|)
name|filenamelen
operator|+=
name|strlen
argument_list|(
name|directory
argument_list|)
operator|+
literal|1
expr_stmt|;
name|filename
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|filenamelen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|filename
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
if|if
condition|(
name|directory
operator|!=
name|NULL
condition|)
name|sprintf
argument_list|(
name|filename
argument_list|,
literal|"%s/"
argument_list|,
name|directory
argument_list|)
expr_stmt|;
else|else
name|filename
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|strcat
argument_list|(
name|filename
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|filename
argument_list|,
name|namestr
argument_list|)
expr_stmt|;
name|dns_diff_init
argument_list|(
name|mctx
argument_list|,
operator|&
name|diff
argument_list|)
expr_stmt|;
for|for
control|(
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
init|;
name|key
operator|!=
name|NULL
condition|;
name|key
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
control|)
if|if
condition|(
operator|!
name|key
operator|->
name|isksk
condition|)
block|{
name|have_non_ksk
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
block|}
for|for
control|(
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
init|;
name|key
operator|!=
name|NULL
condition|;
name|key
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
control|)
if|if
condition|(
name|key
operator|->
name|isksk
condition|)
block|{
name|have_ksk
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|type
operator|==
name|dns_rdatatype_dlv
condition|)
block|{
name|dns_name_t
name|tname
decl_stmt|;
name|unsigned
name|int
name|labels
decl_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|tname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|gorigin
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|gorigin
argument_list|,
literal|0
argument_list|,
name|labels
operator|-
literal|1
argument_list|,
operator|&
name|tname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_concatenate
argument_list|(
operator|&
name|tname
argument_list|,
name|dlv
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_name_concatenate"
argument_list|)
expr_stmt|;
block|}
else|else
name|name
operator|=
name|gorigin
expr_stmt|;
for|for
control|(
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
init|;
name|key
operator|!=
name|NULL
condition|;
name|key
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|have_ksk
operator|&&
name|have_non_ksk
operator|&&
operator|!
name|key
operator|->
name|isksk
condition|)
continue|continue;
name|dns_rdata_init
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
operator|&
name|ds
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|keybuf
argument_list|,
sizeof|sizeof
argument_list|(
name|keybuf
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dst_key_todns
argument_list|(
name|key
operator|->
name|key
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dst_key_todns"
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|dns_rdata_fromregion
argument_list|(
operator|&
name|rdata
argument_list|,
name|gclass
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|dns_rdatatype_dnskey
condition|)
block|{
name|result
operator|=
name|dns_ds_buildrdata
argument_list|(
name|gorigin
argument_list|,
operator|&
name|rdata
argument_list|,
name|DNS_DSDIGEST_SHA1
argument_list|,
name|dsbuf
argument_list|,
operator|&
name|ds
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_ds_buildrdata"
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|dns_rdatatype_dlv
condition|)
name|ds
operator|.
name|type
operator|=
name|dns_rdatatype_dlv
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
literal|0
argument_list|,
operator|&
name|ds
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
block|}
else|else
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|gorigin
argument_list|,
name|zonettl
argument_list|,
operator|&
name|rdata
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
operator|&
name|diff
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_db_create
argument_list|(
name|mctx
argument_list|,
literal|"rbt"
argument_list|,
name|dns_rootname
argument_list|,
name|dns_dbtype_zone
argument_list|,
name|gclass
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_create"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_newversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_newversion"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_diff_apply
argument_list|(
operator|&
name|diff
argument_list|,
name|db
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_diff_apply"
argument_list|)
expr_stmt|;
name|dns_diff_clear
argument_list|(
operator|&
name|diff
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_master_dump
argument_list|(
name|mctx
argument_list|,
name|db
argument_list|,
name|version
argument_list|,
name|style
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_master_dump"
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|filename
argument_list|,
name|filenamelen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_time
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|time_t
name|currenttime
decl_stmt|;
name|currenttime
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"; File written on %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|currenttime
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_version
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"; dnssec_signzone version "
name|VERSION
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t%s [options] zonefile [keys]\n"
argument_list|,
name|program
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Version: %s\n"
argument_list|,
name|VERSION
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Options: (default value in parenthesis) \n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-c class (IN)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-d directory\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tdirectory to find keyset files (.)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-g:\t"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"generate DS records from keyset files\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-s [YYYYMMDDHHMMSS|+offset]:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tRRSIG start time - absolute|offset (now - 1 hour)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-e [YYYYMMDDHHMMSS|+offset|\"now\"+offset]:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tRRSIG end time  - absolute|from start|from now "
literal|"(now + 30 days)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-i interval:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tcycle interval - resign "
literal|"if< interval from end ( (end-start)/4 )\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-v debuglevel (0)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-o origin:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tzone origin (name of zonefile)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-f outfile:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tfile the signed zone is written in "
literal|"(zonefile + .signed)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-r randomdev:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\ta file containing random data\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-a:\t"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"verify generated signatures\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-p:\t"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"use pseudorandom data (faster but less secure)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-t:\t"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"print statistics\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-n ncpus (number of cpus present)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-k key_signing_key\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-l lookasidezone\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-z:\t"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ignore KSK flag in DNSKEYs"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Signing Keys: "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"(default: all zone keys that have private keys)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\tkeyfile (Kname+alg+tag)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|removetempfile
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|removefile
condition|)
name|isc_file_remove
argument_list|(
name|tempfile
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_stats
parameter_list|(
name|isc_time_t
modifier|*
name|timer_start
parameter_list|,
name|isc_time_t
modifier|*
name|timer_finish
parameter_list|)
block|{
name|isc_uint64_t
name|runtime_us
decl_stmt|;
comment|/* Runtime in microseconds */
name|isc_uint64_t
name|runtime_ms
decl_stmt|;
comment|/* Runtime in milliseconds */
name|isc_uint64_t
name|sig_ms
decl_stmt|;
comment|/* Signatures per millisecond */
name|runtime_us
operator|=
name|isc_time_microdiff
argument_list|(
name|timer_finish
argument_list|,
name|timer_start
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signatures generated:               %10d\n"
argument_list|,
name|nsigned
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signatures retained:                %10d\n"
argument_list|,
name|nretained
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signatures dropped:                 %10d\n"
argument_list|,
name|ndropped
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signatures successfully verified:   %10d\n"
argument_list|,
name|nverified
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signatures unsuccessfully verified: %10d\n"
argument_list|,
name|nverifyfailed
argument_list|)
expr_stmt|;
name|runtime_ms
operator|=
name|runtime_us
operator|/
literal|1000
expr_stmt|;
name|printf
argument_list|(
literal|"Runtime in seconds:                %7u.%03u\n"
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
name|runtime_ms
operator|/
literal|1000
argument_list|)
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
name|runtime_ms
operator|%
literal|1000
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|runtime_us
operator|>
literal|0
condition|)
block|{
name|sig_ms
operator|=
operator|(
operator|(
name|isc_uint64_t
operator|)
name|nsigned
operator|*
literal|1000000000
operator|)
operator|/
name|runtime_us
expr_stmt|;
name|printf
argument_list|(
literal|"Signatures per second:             %7u.%03u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|sig_ms
operator|/
literal|1000
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|sig_ms
operator|%
literal|1000
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ch
decl_stmt|;
name|char
modifier|*
name|startstr
init|=
name|NULL
decl_stmt|,
modifier|*
name|endstr
init|=
name|NULL
decl_stmt|,
modifier|*
name|classname
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|origin
init|=
name|NULL
decl_stmt|,
modifier|*
name|file
init|=
name|NULL
decl_stmt|,
modifier|*
name|output
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|dskeyfile
index|[
name|MAXDSKEYS
index|]
decl_stmt|;
name|int
name|ndskeys
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|endp
decl_stmt|;
name|isc_time_t
name|timer_start
decl_stmt|,
name|timer_finish
decl_stmt|;
name|signer_key_t
modifier|*
name|key
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_log_t
modifier|*
name|log
init|=
name|NULL
decl_stmt|;
name|isc_boolean_t
name|pseudorandom
init|=
name|ISC_FALSE
decl_stmt|;
name|unsigned
name|int
name|eflags
decl_stmt|;
name|isc_boolean_t
name|free_output
init|=
name|ISC_FALSE
decl_stmt|;
name|int
name|tempfilelen
decl_stmt|;
name|dns_rdataclass_t
name|rdclass
decl_stmt|;
name|dns_db_t
modifier|*
name|udb
init|=
name|NULL
decl_stmt|;
name|isc_task_t
modifier|*
modifier|*
name|tasks
init|=
name|NULL
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|int
name|len
decl_stmt|;
name|masterstyle
operator|=
operator|&
name|dns_master_style_explicitttl
expr_stmt|;
name|check_result
argument_list|(
name|isc_app_start
argument_list|()
argument_list|,
literal|"isc_app_start"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_mem_create
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|dns_result_register
argument_list|()
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|isc_commandline_parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"ac:d:e:f:ghi:k:l:n:o:pr:s:Stv:z"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'a'
case|:
name|tryverify
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|classname
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|directory
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|endstr
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|output
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|generateds
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
default|default:
name|usage
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|endp
operator|=
name|NULL
expr_stmt|;
name|cycle
operator|=
name|strtol
argument_list|(
name|isc_commandline_argument
argument_list|,
operator|&
name|endp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
operator|||
name|cycle
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"cycle period must be numeric and "
literal|"positive"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|dns_fixedname_init
argument_list|(
operator|&
name|dlv_fixed
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|isc_commandline_argument
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|isc_commandline_argument
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|dlv_fixed
argument_list|)
expr_stmt|;
name|dlv
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|dlv_fixed
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|dlv
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_name_fromtext(dlv)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
if|if
condition|(
name|ndskeys
operator|==
name|MAXDSKEYS
condition|)
name|fatal
argument_list|(
literal|"too many key-signing keys specified"
argument_list|)
expr_stmt|;
name|dskeyfile
index|[
name|ndskeys
operator|++
index|]
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|endp
operator|=
name|NULL
expr_stmt|;
name|ntasks
operator|=
name|strtol
argument_list|(
name|isc_commandline_argument
argument_list|,
operator|&
name|endp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
operator|||
name|ntasks
operator|>
name|ISC_INT32_MAX
condition|)
name|fatal
argument_list|(
literal|"number of cpus must be numeric"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|origin
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|pseudorandom
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|setup_entropy
argument_list|(
name|mctx
argument_list|,
name|isc_commandline_argument
argument_list|,
operator|&
name|ectx
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|startstr
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
comment|/* This is intentionally undocumented */
comment|/* -S: simple output style */
name|masterstyle
operator|=
operator|&
name|dns_master_style_simple
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|printstats
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|endp
operator|=
name|NULL
expr_stmt|;
name|verbose
operator|=
name|strtol
argument_list|(
name|isc_commandline_argument
argument_list|,
operator|&
name|endp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"verbose level must be numeric"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'z'
case|:
name|ignoreksk
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|ectx
operator|==
name|NULL
condition|)
name|setup_entropy
argument_list|(
name|mctx
argument_list|,
name|NULL
argument_list|,
operator|&
name|ectx
argument_list|)
expr_stmt|;
name|eflags
operator|=
name|ISC_ENTROPY_BLOCKING
expr_stmt|;
if|if
condition|(
operator|!
name|pseudorandom
condition|)
name|eflags
operator||=
name|ISC_ENTROPY_GOODONLY
expr_stmt|;
name|result
operator|=
name|isc_hash_create
argument_list|(
name|mctx
argument_list|,
name|ectx
argument_list|,
name|DNS_NAME_MAXWIRE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"could not create hash context"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dst_lib_init
argument_list|(
name|mctx
argument_list|,
name|ectx
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"could not initialize dst"
argument_list|)
expr_stmt|;
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|startstr
operator|!=
name|NULL
condition|)
name|starttime
operator|=
name|strtotime
argument_list|(
name|startstr
argument_list|,
name|now
argument_list|,
name|now
argument_list|)
expr_stmt|;
else|else
name|starttime
operator|=
name|now
operator|-
literal|3600
expr_stmt|;
comment|/* Allow for some clock skew. */
if|if
condition|(
name|endstr
operator|!=
name|NULL
condition|)
name|endtime
operator|=
name|strtotime
argument_list|(
name|endstr
argument_list|,
name|now
argument_list|,
name|starttime
argument_list|)
expr_stmt|;
else|else
name|endtime
operator|=
name|starttime
operator|+
operator|(
literal|30
operator|*
literal|24
operator|*
literal|60
operator|*
literal|60
operator|)
expr_stmt|;
if|if
condition|(
name|cycle
operator|==
operator|-
literal|1
condition|)
name|cycle
operator|=
operator|(
name|endtime
operator|-
name|starttime
operator|)
operator|/
literal|4
expr_stmt|;
if|if
condition|(
name|ntasks
operator|==
literal|0
condition|)
name|ntasks
operator|=
name|isc_os_ncpus
argument_list|()
expr_stmt|;
name|vbprintf
argument_list|(
literal|4
argument_list|,
literal|"using %d cpus\n"
argument_list|,
name|ntasks
argument_list|)
expr_stmt|;
name|rdclass
operator|=
name|strtoclass
argument_list|(
name|classname
argument_list|)
expr_stmt|;
name|setup_logging
argument_list|(
name|verbose
argument_list|,
name|mctx
argument_list|,
operator|&
name|log
argument_list|)
expr_stmt|;
name|argc
operator|-=
name|isc_commandline_index
expr_stmt|;
name|argv
operator|+=
name|isc_commandline_index
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|usage
argument_list|()
expr_stmt|;
name|file
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|argc
operator|-=
literal|1
expr_stmt|;
name|argv
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
name|origin
operator|==
name|NULL
condition|)
name|origin
operator|=
name|file
expr_stmt|;
if|if
condition|(
name|output
operator|==
name|NULL
condition|)
block|{
name|free_output
operator|=
name|ISC_TRUE
expr_stmt|;
name|output
operator|=
name|isc_mem_allocate
argument_list|(
name|mctx
argument_list|,
name|strlen
argument_list|(
name|file
argument_list|)
operator|+
name|strlen
argument_list|(
literal|".signed"
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|output
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|output
argument_list|,
literal|"%s.signed"
argument_list|,
name|file
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_master_stylecreate
argument_list|(
operator|&
name|dsstyle
argument_list|,
name|DNS_STYLEFLAG_NO_TTL
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_master_stylecreate"
argument_list|)
expr_stmt|;
name|gdb
operator|=
name|NULL
expr_stmt|;
name|TIME_NOW
argument_list|(
operator|&
name|timer_start
argument_list|)
expr_stmt|;
name|loadzone
argument_list|(
name|file
argument_list|,
name|origin
argument_list|,
name|rdclass
argument_list|,
operator|&
name|gdb
argument_list|)
expr_stmt|;
name|gorigin
operator|=
name|dns_db_origin
argument_list|(
name|gdb
argument_list|)
expr_stmt|;
name|gclass
operator|=
name|dns_db_class
argument_list|(
name|gdb
argument_list|)
expr_stmt|;
name|zonettl
operator|=
name|soattl
argument_list|()
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|keylist
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
block|{
name|loadzonekeys
argument_list|(
name|gdb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|dst_key_t
modifier|*
name|newkey
init|=
name|NULL
decl_stmt|;
name|result
operator|=
name|dst_key_fromnamedfile
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
name|DST_TYPE_PUBLIC
operator||
name|DST_TYPE_PRIVATE
argument_list|,
name|mctx
argument_list|,
operator|&
name|newkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"cannot load dnskey %s: %s"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
expr_stmt|;
while|while
condition|(
name|key
operator|!=
name|NULL
condition|)
block|{
name|dst_key_t
modifier|*
name|dkey
init|=
name|key
operator|->
name|key
decl_stmt|;
if|if
condition|(
name|dst_key_id
argument_list|(
name|dkey
argument_list|)
operator|==
name|dst_key_id
argument_list|(
name|newkey
argument_list|)
operator|&&
name|dst_key_alg
argument_list|(
name|dkey
argument_list|)
operator|==
name|dst_key_alg
argument_list|(
name|newkey
argument_list|)
operator|&&
name|dns_name_equal
argument_list|(
name|dst_key_name
argument_list|(
name|dkey
argument_list|)
argument_list|,
name|dst_key_name
argument_list|(
name|newkey
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|dst_key_isprivate
argument_list|(
name|dkey
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"cannot sign zone with "
literal|"non-private dnskey %s"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
name|key
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
block|{
name|key
operator|=
name|newkeystruct
argument_list|(
name|newkey
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|keylist
argument_list|,
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
else|else
name|dst_key_free
argument_list|(
operator|&
name|newkey
argument_list|)
expr_stmt|;
block|}
name|loadzonepubkeys
argument_list|(
name|gdb
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndskeys
condition|;
name|i
operator|++
control|)
block|{
name|dst_key_t
modifier|*
name|newkey
init|=
name|NULL
decl_stmt|;
name|result
operator|=
name|dst_key_fromnamedfile
argument_list|(
name|dskeyfile
index|[
name|i
index|]
argument_list|,
name|DST_TYPE_PUBLIC
operator||
name|DST_TYPE_PRIVATE
argument_list|,
name|mctx
argument_list|,
operator|&
name|newkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"cannot load dnskey %s: %s"
argument_list|,
name|dskeyfile
index|[
name|i
index|]
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
expr_stmt|;
while|while
condition|(
name|key
operator|!=
name|NULL
condition|)
block|{
name|dst_key_t
modifier|*
name|dkey
init|=
name|key
operator|->
name|key
decl_stmt|;
if|if
condition|(
name|dst_key_id
argument_list|(
name|dkey
argument_list|)
operator|==
name|dst_key_id
argument_list|(
name|newkey
argument_list|)
operator|&&
name|dst_key_alg
argument_list|(
name|dkey
argument_list|)
operator|==
name|dst_key_alg
argument_list|(
name|newkey
argument_list|)
operator|&&
name|dns_name_equal
argument_list|(
name|dst_key_name
argument_list|(
name|dkey
argument_list|)
argument_list|,
name|dst_key_name
argument_list|(
name|newkey
argument_list|)
argument_list|)
condition|)
block|{
comment|/* Override key flags. */
name|key
operator|->
name|issigningkey
operator|=
name|ISC_TRUE
expr_stmt|;
name|key
operator|->
name|isksk
operator|=
name|ISC_TRUE
expr_stmt|;
name|key
operator|->
name|isdsk
operator|=
name|ISC_FALSE
expr_stmt|;
name|dst_key_free
argument_list|(
operator|&
name|dkey
argument_list|)
expr_stmt|;
name|key
operator|->
name|key
operator|=
name|newkey
expr_stmt|;
break|break;
block|}
name|key
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
block|{
comment|/* Override dnskey flags. */
name|key
operator|=
name|newkeystruct
argument_list|(
name|newkey
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|key
operator|->
name|isksk
operator|=
name|ISC_TRUE
expr_stmt|;
name|key
operator|->
name|isdsk
operator|=
name|ISC_FALSE
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|keylist
argument_list|,
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ISC_LIST_EMPTY
argument_list|(
name|keylist
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: warning: No keys specified or found\n"
argument_list|,
name|program
argument_list|)
expr_stmt|;
name|nokeys
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|warnifallksk
argument_list|(
name|gdb
argument_list|)
expr_stmt|;
name|gversion
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_db_newversion
argument_list|(
name|gdb
argument_list|,
operator|&
name|gversion
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_newversion()"
argument_list|)
expr_stmt|;
name|nsecify
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|nokeys
condition|)
block|{
name|writeset
argument_list|(
literal|"keyset-"
argument_list|,
name|dns_rdatatype_dnskey
argument_list|)
expr_stmt|;
name|writeset
argument_list|(
literal|"dsset-"
argument_list|,
name|dns_rdatatype_ds
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlv
operator|!=
name|NULL
condition|)
block|{
name|writeset
argument_list|(
literal|"dlvset-"
argument_list|,
name|dns_rdatatype_dlv
argument_list|)
expr_stmt|;
block|}
block|}
name|tempfilelen
operator|=
name|strlen
argument_list|(
name|output
argument_list|)
operator|+
literal|20
expr_stmt|;
name|tempfile
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|tempfilelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempfile
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_file_mktemplate
argument_list|(
name|output
argument_list|,
name|tempfile
argument_list|,
name|tempfilelen
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_file_mktemplate"
argument_list|)
expr_stmt|;
name|fp
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_file_openunique
argument_list|(
name|tempfile
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to open temporary output file: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|removefile
operator|=
name|ISC_TRUE
expr_stmt|;
name|setfatalcallback
argument_list|(
operator|&
name|removetempfile
argument_list|)
expr_stmt|;
name|print_time
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|print_version
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_taskmgr_create
argument_list|(
name|mctx
argument_list|,
name|ntasks
argument_list|,
literal|0
argument_list|,
operator|&
name|taskmgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to create task manager: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|master
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_task_create
argument_list|(
name|taskmgr
argument_list|,
literal|0
argument_list|,
operator|&
name|master
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to create task: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|tasks
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|ntasks
operator|*
sizeof|sizeof
argument_list|(
name|isc_task_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tasks
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|int
operator|)
name|ntasks
condition|;
name|i
operator|++
control|)
block|{
name|tasks
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_task_create
argument_list|(
name|taskmgr
argument_list|,
literal|0
argument_list|,
operator|&
name|tasks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to create task: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_app_onrun
argument_list|(
name|mctx
argument_list|,
name|master
argument_list|,
name|startworker
argument_list|,
name|tasks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to start task: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|RUNTIME_CHECK
argument_list|(
name|isc_mutex_init
argument_list|(
operator|&
name|namelock
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|printstats
condition|)
name|RUNTIME_CHECK
argument_list|(
name|isc_mutex_init
argument_list|(
operator|&
name|statslock
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|presign
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|isc_app_run
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|finished
condition|)
name|fatal
argument_list|(
literal|"process aborted by user"
argument_list|)
expr_stmt|;
name|shuttingdown
operator|=
name|ISC_TRUE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|int
operator|)
name|ntasks
condition|;
name|i
operator|++
control|)
name|isc_task_detach
argument_list|(
operator|&
name|tasks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|isc_taskmgr_destroy
argument_list|(
operator|&
name|taskmgr
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|tasks
argument_list|,
name|ntasks
operator|*
sizeof|sizeof
argument_list|(
name|isc_task_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|postsign
argument_list|()
expr_stmt|;
if|if
condition|(
name|udb
operator|!=
name|NULL
condition|)
block|{
name|dumpdb
argument_list|(
name|udb
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|udb
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|isc_stdio_close
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_stdio_close"
argument_list|)
expr_stmt|;
name|removefile
operator|=
name|ISC_FALSE
expr_stmt|;
name|result
operator|=
name|isc_file_rename
argument_list|(
name|tempfile
argument_list|,
name|output
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to rename temp file to %s: %s\n"
argument_list|,
name|output
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|namelock
argument_list|)
expr_stmt|;
if|if
condition|(
name|printstats
condition|)
name|DESTROYLOCK
argument_list|(
operator|&
name|statslock
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|output
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|gdb
argument_list|,
operator|&
name|gversion
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|gdb
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|keylist
argument_list|)
condition|)
block|{
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|keylist
argument_list|,
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dst_key_free
argument_list|(
operator|&
name|key
operator|->
name|key
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|key
argument_list|,
sizeof|sizeof
argument_list|(
name|signer_key_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|tempfile
argument_list|,
name|tempfilelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|free_output
condition|)
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|output
argument_list|)
expr_stmt|;
name|dns_master_styledestroy
argument_list|(
operator|&
name|dsstyle
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|cleanup_logging
argument_list|(
operator|&
name|log
argument_list|)
expr_stmt|;
name|dst_lib_destroy
argument_list|()
expr_stmt|;
name|isc_hash_destroy
argument_list|()
expr_stmt|;
name|cleanup_entropy
argument_list|(
operator|&
name|ectx
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|>
literal|10
condition|)
name|isc_mem_stats
argument_list|(
name|mctx
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|isc_mem_destroy
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|isc_app_finish
argument_list|()
expr_stmt|;
if|if
condition|(
name|printstats
condition|)
block|{
name|TIME_NOW
argument_list|(
operator|&
name|timer_finish
argument_list|)
expr_stmt|;
name|print_stats
argument_list|(
operator|&
name|timer_start
argument_list|,
operator|&
name|timer_finish
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


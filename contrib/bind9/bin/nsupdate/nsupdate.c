begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004-2014  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 2000-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id$ */
end_comment

begin_comment
comment|/*! \file */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<isc/app.h>
end_include

begin_include
include|#
directive|include
file|<isc/base64.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_include
include|#
directive|include
file|<isc/commandline.h>
end_include

begin_include
include|#
directive|include
file|<isc/entropy.h>
end_include

begin_include
include|#
directive|include
file|<isc/event.h>
end_include

begin_include
include|#
directive|include
file|<isc/file.h>
end_include

begin_include
include|#
directive|include
file|<isc/hash.h>
end_include

begin_include
include|#
directive|include
file|<isc/lex.h>
end_include

begin_include
include|#
directive|include
file|<isc/log.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/parseint.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/random.h>
end_include

begin_include
include|#
directive|include
file|<isc/region.h>
end_include

begin_include
include|#
directive|include
file|<isc/sockaddr.h>
end_include

begin_include
include|#
directive|include
file|<isc/socket.h>
end_include

begin_include
include|#
directive|include
file|<isc/stdio.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/timer.h>
end_include

begin_include
include|#
directive|include
file|<isc/types.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<isccfg/namedconf.h>
end_include

begin_include
include|#
directive|include
file|<dns/callbacks.h>
end_include

begin_include
include|#
directive|include
file|<dns/dispatch.h>
end_include

begin_include
include|#
directive|include
file|<dns/dnssec.h>
end_include

begin_include
include|#
directive|include
file|<dns/events.h>
end_include

begin_include
include|#
directive|include
file|<dns/fixedname.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/masterdump.h>
end_include

begin_include
include|#
directive|include
file|<dns/message.h>
end_include

begin_include
include|#
directive|include
file|<dns/name.h>
end_include

begin_include
include|#
directive|include
file|<dns/rcode.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdata.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataclass.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatalist.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatastruct.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatatype.h>
end_include

begin_include
include|#
directive|include
file|<dns/request.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/tkey.h>
end_include

begin_include
include|#
directive|include
file|<dns/tsig.h>
end_include

begin_include
include|#
directive|include
file|<dst/dst.h>
end_include

begin_include
include|#
directive|include
file|<lwres/lwres.h>
end_include

begin_include
include|#
directive|include
file|<lwres/net.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|GSSAPI
end_ifdef

begin_include
include|#
directive|include
file|<dst/gssapi.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|WIN32
end_ifdef

begin_include
include|#
directive|include
file|<krb5/krb5.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
include|ISC_PLATFORM_KRB5HEADER
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<bind9/getaddresses.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_READLINE
argument_list|)
end_if

begin_include
include|#
directive|include
file|<readline/readline.h>
end_include

begin_include
include|#
directive|include
file|<readline/history.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_ADDRINFO
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_GETADDRINFO
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_GAISTRERROR
end_ifdef

begin_define
define|#
directive|define
name|USE_GETADDRINFO
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|USE_GETADDRINFO
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|ISC_PLATFORM_NONSTDHERRNO
end_ifndef

begin_decl_stmt
specifier|extern
name|int
name|h_errno
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MAXCMD
value|(4 * 1024)
end_define

begin_define
define|#
directive|define
name|MAXWIRE
value|(64 * 1024)
end_define

begin_define
define|#
directive|define
name|PACKETSIZE
value|((64 * 1024) - 1)
end_define

begin_define
define|#
directive|define
name|INITTEXT
value|(2 * 1024)
end_define

begin_define
define|#
directive|define
name|MAXTEXT
value|(128 * 1024)
end_define

begin_define
define|#
directive|define
name|FIND_TIMEOUT
value|5
end_define

begin_define
define|#
directive|define
name|TTL_MAX
value|2147483647U
end_define

begin_comment
comment|/* Maximum signed 32 bit integer. */
end_comment

begin_define
define|#
directive|define
name|DNSDEFAULTPORT
value|53
end_define

begin_comment
comment|/* Number of addresses to request from bind9_getaddresses() */
end_comment

begin_define
define|#
directive|define
name|MAX_SERVERADDRS
value|4
end_define

begin_decl_stmt
specifier|static
name|isc_uint16_t
name|dnsport
init|=
name|DNSDEFAULTPORT
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|RESOLV_CONF
end_ifndef

begin_define
define|#
directive|define
name|RESOLV_CONF
value|"/etc/resolv.conf"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|debugging
init|=
name|ISC_FALSE
decl_stmt|,
name|ddebugging
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|memdebugging
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|have_ipv4
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|have_ipv6
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|is_dst_up
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|usevc
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|usegsstsig
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|use_win2k_gsstsig
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|tried_other_gsstsig
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|local_only
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_taskmgr_t
modifier|*
name|taskmgr
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_task_t
modifier|*
name|global_task
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_event_t
modifier|*
name|global_event
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_log_t
modifier|*
name|lctx
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_mem_t
modifier|*
name|mctx
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_dispatchmgr_t
modifier|*
name|dispatchmgr
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_requestmgr_t
modifier|*
name|requestmgr
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_socketmgr_t
modifier|*
name|socketmgr
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_timermgr_t
modifier|*
name|timermgr
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_dispatch_t
modifier|*
name|dispatchv4
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_dispatch_t
modifier|*
name|dispatchv6
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_message_t
modifier|*
name|updatemsg
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_fixedname_t
name|fuserzone
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_name_t
modifier|*
name|userzone
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_name_t
modifier|*
name|zonename
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_name_t
name|tmpzonename
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_name_t
name|restart_master
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_tsig_keyring_t
modifier|*
name|gssring
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_tsigkey_t
modifier|*
name|tsigkey
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dst_key_t
modifier|*
name|sig0key
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|lwres_context_t
modifier|*
name|lwctx
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|lwres_conf_t
modifier|*
name|lwconf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_sockaddr_t
modifier|*
name|servers
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|default_servers
init|=
name|ISC_TRUE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ns_inuse
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ns_total
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_sockaddr_t
modifier|*
name|localaddr
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|keyfile
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|keystr
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_entropy_t
modifier|*
name|entropy
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|shuttingdown
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|FILE
modifier|*
name|input
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|interactive
init|=
name|ISC_TRUE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|seenerror
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|dns_master_style_t
modifier|*
name|style
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|requests
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|logdebuglevel
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|timeout
init|=
literal|300
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|udp_timeout
init|=
literal|3
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|udp_retries
init|=
literal|3
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_rdataclass_t
name|defaultclass
init|=
name|dns_rdataclass_in
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_rdataclass_t
name|zoneclass
init|=
name|dns_rdataclass_none
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_message_t
modifier|*
name|answer
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_uint32_t
name|default_ttl
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|default_ttl_set
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
name|nsu_requestinfo
block|{
name|dns_message_t
modifier|*
name|msg
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|addr
decl_stmt|;
block|}
name|nsu_requestinfo_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|void
name|sendrequest
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_request_t
modifier|*
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|ISC_PLATFORM_NORETURN_PRE
specifier|static
name|void
name|fatal
argument_list|(
specifier|const
name|char
operator|*
name|format
argument_list|,
operator|...
argument_list|)
name|ISC_FORMAT_PRINTF
argument_list|(
literal|1
argument_list|,
literal|2
argument_list|)
name|ISC_PLATFORM_NORETURN_POST
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|debug
parameter_list|(
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|1
operator|,
function_decl|2
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_function_decl
specifier|static
name|void
name|ddebug
parameter_list|(
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|1
operator|,
function_decl|2
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|GSSAPI
end_ifdef

begin_decl_stmt
specifier|static
name|dns_fixedname_t
name|fkname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_sockaddr_t
modifier|*
name|kserver
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|realm
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|servicename
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_name_t
modifier|*
name|keyname
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
name|nsu_gssinfo
block|{
name|dns_message_t
modifier|*
name|msg
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|addr
decl_stmt|;
name|gss_ctx_id_t
name|context
decl_stmt|;
block|}
name|nsu_gssinfo_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|void
name|start_gssrequest
parameter_list|(
name|dns_name_t
modifier|*
name|master
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|send_gssrequest
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_request_t
modifier|*
modifier|*
name|request
parameter_list|,
name|gss_ctx_id_t
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|recvgss
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* GSSAPI */
end_comment

begin_function_decl
specifier|static
name|void
name|error
parameter_list|(
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|1
operator|,
function_decl|2
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_define
define|#
directive|define
name|STATUS_MORE
value|(isc_uint16_t)0
end_define

begin_define
define|#
directive|define
name|STATUS_SEND
value|(isc_uint16_t)1
end_define

begin_define
define|#
directive|define
name|STATUS_QUIT
value|(isc_uint16_t)2
end_define

begin_define
define|#
directive|define
name|STATUS_SYNTAX
value|(isc_uint16_t)3
end_define

begin_typedef
typedef|typedef
name|struct
name|entropysource
name|entropysource_t
typedef|;
end_typedef

begin_struct
struct|struct
name|entropysource
block|{
name|isc_entropysource_t
modifier|*
name|source
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|entropysource_t
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
specifier|static
name|ISC_LIST
argument_list|(
argument|entropysource_t
argument_list|)
name|sources
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|setup_entropy
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
specifier|const
name|char
modifier|*
name|randomfile
parameter_list|,
name|isc_entropy_t
modifier|*
modifier|*
name|ectx
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_entropysource_t
modifier|*
name|source
init|=
name|NULL
decl_stmt|;
name|entropysource_t
modifier|*
name|elt
decl_stmt|;
name|int
name|usekeyboard
init|=
name|ISC_ENTROPY_KEYBOARDMAYBE
decl_stmt|;
name|REQUIRE
argument_list|(
name|ectx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ectx
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|isc_entropy_create
argument_list|(
name|mctx
argument_list|,
name|ectx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"could not create entropy object"
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|sources
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|randomfile
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|randomfile
argument_list|,
literal|"keyboard"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|usekeyboard
operator|=
name|ISC_ENTROPY_KEYBOARDYES
expr_stmt|;
name|randomfile
operator|=
name|NULL
expr_stmt|;
block|}
name|result
operator|=
name|isc_entropy_usebestsource
argument_list|(
operator|*
name|ectx
argument_list|,
operator|&
name|source
argument_list|,
name|randomfile
argument_list|,
name|usekeyboard
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"could not initialize entropy source: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|source
operator|!=
name|NULL
condition|)
block|{
name|elt
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|elt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|elt
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|elt
operator|->
name|source
operator|=
name|source
expr_stmt|;
name|elt
operator|->
name|mctx
operator|=
name|mctx
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|elt
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|sources
argument_list|,
name|elt
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cleanup_entropy
parameter_list|(
name|isc_entropy_t
modifier|*
modifier|*
name|ectx
parameter_list|)
block|{
name|entropysource_t
modifier|*
name|source
decl_stmt|;
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|sources
argument_list|)
condition|)
block|{
name|source
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|sources
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|sources
argument_list|,
name|source
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_entropy_destroysource
argument_list|(
operator|&
name|source
operator|->
name|source
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|source
operator|->
name|mctx
argument_list|,
name|source
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|source
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|isc_entropy_detach
argument_list|(
name|ectx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|dns_rdataclass_t
name|getzoneclass
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|zoneclass
operator|==
name|dns_rdataclass_none
condition|)
name|zoneclass
operator|=
name|defaultclass
expr_stmt|;
return|return
operator|(
name|zoneclass
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|setzoneclass
parameter_list|(
name|dns_rdataclass_t
name|rdclass
parameter_list|)
block|{
if|if
condition|(
name|zoneclass
operator|==
name|dns_rdataclass_none
operator|||
name|rdclass
operator|==
name|dns_rdataclass_none
condition|)
name|zoneclass
operator|=
name|rdclass
expr_stmt|;
if|if
condition|(
name|zoneclass
operator|!=
name|rdclass
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|fatal
parameter_list|(
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|format
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|error
parameter_list|(
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|format
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|debug
parameter_list|(
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
if|if
condition|(
name|debugging
condition|)
block|{
name|va_start
argument_list|(
name|args
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|format
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ddebug
parameter_list|(
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
if|if
condition|(
name|ddebugging
condition|)
block|{
name|va_start
argument_list|(
name|args
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|format
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|check_result
parameter_list|(
name|isc_result_t
name|result
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"%s: %s"
argument_list|,
name|msg
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|mem_alloc
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
return|return
operator|(
name|isc_mem_get
argument_list|(
name|arg
argument_list|,
name|size
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mem_free
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|void
modifier|*
name|mem
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|isc_mem_put
argument_list|(
name|arg
argument_list|,
name|mem
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|nsu_strsep
parameter_list|(
name|char
modifier|*
modifier|*
name|stringp
parameter_list|,
specifier|const
name|char
modifier|*
name|delim
parameter_list|)
block|{
name|char
modifier|*
name|string
init|=
operator|*
name|stringp
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
specifier|const
name|char
modifier|*
name|d
decl_stmt|;
name|char
name|sc
decl_stmt|,
name|dc
decl_stmt|;
if|if
condition|(
name|string
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
init|;
operator|*
name|string
operator|!=
literal|'\0'
condition|;
name|string
operator|++
control|)
block|{
name|sc
operator|=
operator|*
name|string
expr_stmt|;
for|for
control|(
name|d
operator|=
name|delim
init|;
operator|(
name|dc
operator|=
operator|*
name|d
operator|)
operator|!=
literal|'\0'
condition|;
name|d
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|==
name|dc
condition|)
break|break;
block|}
if|if
condition|(
name|dc
operator|==
literal|0
condition|)
break|break;
block|}
for|for
control|(
name|s
operator|=
name|string
init|;
operator|*
name|s
operator|!=
literal|'\0'
condition|;
name|s
operator|++
control|)
block|{
name|sc
operator|=
operator|*
name|s
expr_stmt|;
for|for
control|(
name|d
operator|=
name|delim
init|;
operator|(
name|dc
operator|=
operator|*
name|d
operator|)
operator|!=
literal|'\0'
condition|;
name|d
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|==
name|dc
condition|)
block|{
operator|*
name|s
operator|++
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|stringp
operator|=
name|s
expr_stmt|;
return|return
operator|(
name|string
operator|)
return|;
block|}
block|}
block|}
operator|*
name|stringp
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|string
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|reset_system
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|ddebug
argument_list|(
literal|"reset_system()"
argument_list|)
expr_stmt|;
comment|/* If the update message is still around, destroy it */
if|if
condition|(
name|updatemsg
operator|!=
name|NULL
condition|)
name|dns_message_reset
argument_list|(
name|updatemsg
argument_list|,
name|DNS_MESSAGE_INTENTRENDER
argument_list|)
expr_stmt|;
else|else
block|{
name|result
operator|=
name|dns_message_create
argument_list|(
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTRENDER
argument_list|,
operator|&
name|updatemsg
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_create"
argument_list|)
expr_stmt|;
block|}
name|updatemsg
operator|->
name|opcode
operator|=
name|dns_opcode_update
expr_stmt|;
if|if
condition|(
name|usegsstsig
condition|)
block|{
if|if
condition|(
name|tsigkey
operator|!=
name|NULL
condition|)
name|dns_tsigkey_detach
argument_list|(
operator|&
name|tsigkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|gssring
operator|!=
name|NULL
condition|)
name|dns_tsigkeyring_detach
argument_list|(
operator|&
name|gssring
argument_list|)
expr_stmt|;
name|tried_other_gsstsig
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|parse_hmac
parameter_list|(
name|dns_name_t
modifier|*
modifier|*
name|hmac
parameter_list|,
specifier|const
name|char
modifier|*
name|hmacstr
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|isc_uint16_t
name|digestbits
init|=
literal|0
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
name|REQUIRE
argument_list|(
name|hmac
operator|!=
name|NULL
operator|&&
operator|*
name|hmac
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|hmacstr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"unknown key type '%.*s'"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|len
argument_list|)
argument_list|,
name|hmacstr
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|buf
argument_list|,
name|hmacstr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buf
index|[
name|len
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|buf
argument_list|,
literal|"hmac-md5"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|hmac
operator|=
name|DNS_TSIG_HMACMD5_NAME
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
name|buf
argument_list|,
literal|"hmac-md5-"
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|hmac
operator|=
name|DNS_TSIG_HMACMD5_NAME
expr_stmt|;
name|result
operator|=
name|isc_parse_uint16
argument_list|(
operator|&
name|digestbits
argument_list|,
operator|&
name|buf
index|[
literal|9
index|]
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|||
name|digestbits
operator|>
literal|128
condition|)
name|fatal
argument_list|(
literal|"digest-bits out of range [0..128]"
argument_list|)
expr_stmt|;
name|digestbits
operator|=
operator|(
name|digestbits
operator|+
literal|7
operator|)
operator|&
operator|~
literal|0x7U
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|buf
argument_list|,
literal|"hmac-sha1"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|hmac
operator|=
name|DNS_TSIG_HMACSHA1_NAME
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
name|buf
argument_list|,
literal|"hmac-sha1-"
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|hmac
operator|=
name|DNS_TSIG_HMACSHA1_NAME
expr_stmt|;
name|result
operator|=
name|isc_parse_uint16
argument_list|(
operator|&
name|digestbits
argument_list|,
operator|&
name|buf
index|[
literal|10
index|]
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|||
name|digestbits
operator|>
literal|160
condition|)
name|fatal
argument_list|(
literal|"digest-bits out of range [0..160]"
argument_list|)
expr_stmt|;
name|digestbits
operator|=
operator|(
name|digestbits
operator|+
literal|7
operator|)
operator|&
operator|~
literal|0x7U
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|buf
argument_list|,
literal|"hmac-sha224"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|hmac
operator|=
name|DNS_TSIG_HMACSHA224_NAME
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
name|buf
argument_list|,
literal|"hmac-sha224-"
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|hmac
operator|=
name|DNS_TSIG_HMACSHA224_NAME
expr_stmt|;
name|result
operator|=
name|isc_parse_uint16
argument_list|(
operator|&
name|digestbits
argument_list|,
operator|&
name|buf
index|[
literal|12
index|]
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|||
name|digestbits
operator|>
literal|224
condition|)
name|fatal
argument_list|(
literal|"digest-bits out of range [0..224]"
argument_list|)
expr_stmt|;
name|digestbits
operator|=
operator|(
name|digestbits
operator|+
literal|7
operator|)
operator|&
operator|~
literal|0x7U
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|buf
argument_list|,
literal|"hmac-sha256"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|hmac
operator|=
name|DNS_TSIG_HMACSHA256_NAME
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
name|buf
argument_list|,
literal|"hmac-sha256-"
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|hmac
operator|=
name|DNS_TSIG_HMACSHA256_NAME
expr_stmt|;
name|result
operator|=
name|isc_parse_uint16
argument_list|(
operator|&
name|digestbits
argument_list|,
operator|&
name|buf
index|[
literal|12
index|]
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|||
name|digestbits
operator|>
literal|256
condition|)
name|fatal
argument_list|(
literal|"digest-bits out of range [0..256]"
argument_list|)
expr_stmt|;
name|digestbits
operator|=
operator|(
name|digestbits
operator|+
literal|7
operator|)
operator|&
operator|~
literal|0x7U
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|buf
argument_list|,
literal|"hmac-sha384"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|hmac
operator|=
name|DNS_TSIG_HMACSHA384_NAME
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
name|buf
argument_list|,
literal|"hmac-sha384-"
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|hmac
operator|=
name|DNS_TSIG_HMACSHA384_NAME
expr_stmt|;
name|result
operator|=
name|isc_parse_uint16
argument_list|(
operator|&
name|digestbits
argument_list|,
operator|&
name|buf
index|[
literal|12
index|]
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|||
name|digestbits
operator|>
literal|384
condition|)
name|fatal
argument_list|(
literal|"digest-bits out of range [0..384]"
argument_list|)
expr_stmt|;
name|digestbits
operator|=
operator|(
name|digestbits
operator|+
literal|7
operator|)
operator|&
operator|~
literal|0x7U
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|buf
argument_list|,
literal|"hmac-sha512"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|hmac
operator|=
name|DNS_TSIG_HMACSHA512_NAME
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
name|buf
argument_list|,
literal|"hmac-sha512-"
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|hmac
operator|=
name|DNS_TSIG_HMACSHA512_NAME
expr_stmt|;
name|result
operator|=
name|isc_parse_uint16
argument_list|(
operator|&
name|digestbits
argument_list|,
operator|&
name|buf
index|[
literal|12
index|]
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|||
name|digestbits
operator|>
literal|512
condition|)
name|fatal
argument_list|(
literal|"digest-bits out of range [0..512]"
argument_list|)
expr_stmt|;
name|digestbits
operator|=
operator|(
name|digestbits
operator|+
literal|7
operator|)
operator|&
operator|~
literal|0x7U
expr_stmt|;
block|}
else|else
name|fatal
argument_list|(
literal|"unknown key type '%s'"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|digestbits
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|basenamelen
parameter_list|(
specifier|const
name|char
modifier|*
name|file
parameter_list|)
block|{
name|int
name|len
init|=
name|strlen
argument_list|(
name|file
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
name|file
index|[
name|len
operator|-
literal|1
index|]
operator|==
literal|'.'
condition|)
name|len
operator|-=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|len
operator|>
literal|8
operator|&&
name|strcmp
argument_list|(
name|file
operator|+
name|len
operator|-
literal|8
argument_list|,
literal|".private"
argument_list|)
operator|==
literal|0
condition|)
name|len
operator|-=
literal|8
expr_stmt|;
elseif|else
if|if
condition|(
name|len
operator|>
literal|4
operator|&&
name|strcmp
argument_list|(
name|file
operator|+
name|len
operator|-
literal|4
argument_list|,
literal|".key"
argument_list|)
operator|==
literal|0
condition|)
name|len
operator|-=
literal|4
expr_stmt|;
return|return
operator|(
name|len
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|setup_keystr
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|secret
init|=
name|NULL
decl_stmt|;
name|int
name|secretlen
decl_stmt|;
name|isc_buffer_t
name|secretbuf
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_t
name|keynamesrc
decl_stmt|;
name|char
modifier|*
name|secretstr
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|dns_fixedname_t
name|fkeyname
decl_stmt|;
name|dns_name_t
modifier|*
name|keyname
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|dns_name_t
modifier|*
name|hmacname
init|=
name|NULL
decl_stmt|;
name|isc_uint16_t
name|digestbits
init|=
literal|0
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fkeyname
argument_list|)
expr_stmt|;
name|keyname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fkeyname
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"Creating key..."
argument_list|)
expr_stmt|;
name|s
operator|=
name|strchr
argument_list|(
name|keystr
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
operator|||
name|s
operator|==
name|keystr
operator|||
name|s
index|[
literal|1
index|]
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"key option must specify [hmac:]keyname:secret"
argument_list|)
expr_stmt|;
name|secretstr
operator|=
name|s
operator|+
literal|1
expr_stmt|;
name|n
operator|=
name|strchr
argument_list|(
name|secretstr
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|n
operator|==
name|secretstr
operator|||
name|n
index|[
literal|1
index|]
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"key option must specify [hmac:]keyname:secret"
argument_list|)
expr_stmt|;
name|name
operator|=
name|secretstr
expr_stmt|;
name|secretstr
operator|=
name|n
operator|+
literal|1
expr_stmt|;
name|digestbits
operator|=
name|parse_hmac
argument_list|(
operator|&
name|hmacname
argument_list|,
name|keystr
argument_list|,
name|s
operator|-
name|keystr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hmacname
operator|=
name|DNS_TSIG_HMACMD5_NAME
expr_stmt|;
name|name
operator|=
name|keystr
expr_stmt|;
name|n
operator|=
name|s
expr_stmt|;
block|}
name|isc_buffer_init
argument_list|(
operator|&
name|keynamesrc
argument_list|,
name|name
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
name|n
operator|-
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|keynamesrc
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
name|n
operator|-
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"namefromtext"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|keyname
argument_list|,
operator|&
name|keynamesrc
argument_list|,
name|dns_rootname
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_name_fromtext"
argument_list|)
expr_stmt|;
name|secretlen
operator|=
name|strlen
argument_list|(
name|secretstr
argument_list|)
operator|*
literal|3
operator|/
literal|4
expr_stmt|;
name|secret
operator|=
name|isc_mem_allocate
argument_list|(
name|mctx
argument_list|,
name|secretlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|secret
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|secretbuf
argument_list|,
name|secret
argument_list|,
name|secretlen
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_base64_decodestring
argument_list|(
name|secretstr
argument_list|,
operator|&
name|secretbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not create key from %s: %s\n"
argument_list|,
name|keystr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
name|secretlen
operator|=
name|isc_buffer_usedlength
argument_list|(
operator|&
name|secretbuf
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"keycreate"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_tsigkey_create
argument_list|(
name|keyname
argument_list|,
name|hmacname
argument_list|,
name|secret
argument_list|,
name|secretlen
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|mctx
argument_list|,
name|NULL
argument_list|,
operator|&
name|tsigkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not create key from %s: %s\n"
argument_list|,
name|keystr
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|dst_key_setbits
argument_list|(
name|tsigkey
operator|->
name|key
argument_list|,
name|digestbits
argument_list|)
expr_stmt|;
name|failure
label|:
if|if
condition|(
name|secret
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|secret
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Get a key from a named.conf format keyfile  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|read_sessionkey
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_log_t
modifier|*
name|lctx
parameter_list|)
block|{
name|cfg_parser_t
modifier|*
name|pctx
init|=
name|NULL
decl_stmt|;
name|cfg_obj_t
modifier|*
name|sessionkey
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|secretobj
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|algorithmobj
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|keyname
decl_stmt|;
specifier|const
name|char
modifier|*
name|secretstr
decl_stmt|;
specifier|const
name|char
modifier|*
name|algorithm
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|!
name|isc_file_exists
argument_list|(
name|keyfile
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_FILENOTFOUND
operator|)
return|;
name|result
operator|=
name|cfg_parser_create
argument_list|(
name|mctx
argument_list|,
name|lctx
argument_list|,
operator|&
name|pctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|cfg_parse_file
argument_list|(
name|pctx
argument_list|,
name|keyfile
argument_list|,
operator|&
name|cfg_type_sessionkey
argument_list|,
operator|&
name|sessionkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|sessionkey
argument_list|,
literal|"key"
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|key
argument_list|,
literal|"secret"
argument_list|,
operator|&
name|secretobj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|key
argument_list|,
literal|"algorithm"
argument_list|,
operator|&
name|algorithmobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|secretobj
operator|==
name|NULL
operator|||
name|algorithmobj
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"key must have algorithm and secret"
argument_list|)
expr_stmt|;
name|keyname
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_map_getname
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|secretstr
operator|=
name|cfg_obj_asstring
argument_list|(
name|secretobj
argument_list|)
expr_stmt|;
name|algorithm
operator|=
name|cfg_obj_asstring
argument_list|(
name|algorithmobj
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|algorithm
argument_list|)
operator|+
name|strlen
argument_list|(
name|keyname
argument_list|)
operator|+
name|strlen
argument_list|(
name|secretstr
argument_list|)
operator|+
literal|3
expr_stmt|;
name|keystr
operator|=
name|isc_mem_allocate
argument_list|(
name|mctx
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|keystr
argument_list|,
name|len
argument_list|,
literal|"%s:%s:%s"
argument_list|,
name|algorithm
argument_list|,
name|keyname
argument_list|,
name|secretstr
argument_list|)
expr_stmt|;
name|setup_keystr
argument_list|()
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|pctx
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|sessionkey
operator|!=
name|NULL
condition|)
name|cfg_obj_destroy
argument_list|(
name|pctx
argument_list|,
operator|&
name|sessionkey
argument_list|)
expr_stmt|;
name|cfg_parser_destroy
argument_list|(
operator|&
name|pctx
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|keystr
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|keystr
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|setup_keyfile
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_log_t
modifier|*
name|lctx
parameter_list|)
block|{
name|dst_key_t
modifier|*
name|dstkey
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_name_t
modifier|*
name|hmacname
init|=
name|NULL
decl_stmt|;
name|debug
argument_list|(
literal|"Creating key..."
argument_list|)
expr_stmt|;
if|if
condition|(
name|sig0key
operator|!=
name|NULL
condition|)
name|dst_key_free
argument_list|(
operator|&
name|sig0key
argument_list|)
expr_stmt|;
comment|/* Try reading the key from a K* pair */
name|result
operator|=
name|dst_key_fromnamedfile
argument_list|(
name|keyfile
argument_list|,
name|NULL
argument_list|,
name|DST_TYPE_PRIVATE
operator||
name|DST_TYPE_KEY
argument_list|,
name|mctx
argument_list|,
operator|&
name|dstkey
argument_list|)
expr_stmt|;
comment|/* If that didn't work, try reading it as a session.key keyfile */
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|read_sessionkey
argument_list|(
name|mctx
argument_list|,
name|lctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
return|return;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read key from %.*s.{private,key}: "
literal|"%s\n"
argument_list|,
name|basenamelen
argument_list|(
name|keyfile
argument_list|)
argument_list|,
name|keyfile
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|dst_key_alg
argument_list|(
name|dstkey
argument_list|)
condition|)
block|{
case|case
name|DST_ALG_HMACMD5
case|:
name|hmacname
operator|=
name|DNS_TSIG_HMACMD5_NAME
expr_stmt|;
break|break;
case|case
name|DST_ALG_HMACSHA1
case|:
name|hmacname
operator|=
name|DNS_TSIG_HMACSHA1_NAME
expr_stmt|;
break|break;
case|case
name|DST_ALG_HMACSHA224
case|:
name|hmacname
operator|=
name|DNS_TSIG_HMACSHA224_NAME
expr_stmt|;
break|break;
case|case
name|DST_ALG_HMACSHA256
case|:
name|hmacname
operator|=
name|DNS_TSIG_HMACSHA256_NAME
expr_stmt|;
break|break;
case|case
name|DST_ALG_HMACSHA384
case|:
name|hmacname
operator|=
name|DNS_TSIG_HMACSHA384_NAME
expr_stmt|;
break|break;
case|case
name|DST_ALG_HMACSHA512
case|:
name|hmacname
operator|=
name|DNS_TSIG_HMACSHA512_NAME
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|hmacname
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|dns_tsigkey_createfromkey
argument_list|(
name|dst_key_name
argument_list|(
name|dstkey
argument_list|)
argument_list|,
name|hmacname
argument_list|,
name|dstkey
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|mctx
argument_list|,
name|NULL
argument_list|,
operator|&
name|tsigkey
argument_list|)
expr_stmt|;
name|dst_key_free
argument_list|(
operator|&
name|dstkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not create key from %s: %s\n"
argument_list|,
name|keyfile
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|dst_key_attach
argument_list|(
name|dstkey
argument_list|,
operator|&
name|sig0key
argument_list|)
expr_stmt|;
name|dst_key_free
argument_list|(
operator|&
name|dstkey
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|doshutdown
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_task_detach
argument_list|(
operator|&
name|global_task
argument_list|)
expr_stmt|;
if|if
condition|(
name|servers
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|servers
argument_list|,
name|ns_total
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|localaddr
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|localaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsigkey
operator|!=
name|NULL
condition|)
block|{
name|ddebug
argument_list|(
literal|"Freeing TSIG key"
argument_list|)
expr_stmt|;
name|dns_tsigkey_detach
argument_list|(
operator|&
name|tsigkey
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sig0key
operator|!=
name|NULL
condition|)
block|{
name|ddebug
argument_list|(
literal|"Freeing SIG(0) key"
argument_list|)
expr_stmt|;
name|dst_key_free
argument_list|(
operator|&
name|sig0key
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|updatemsg
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|updatemsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_dst_up
condition|)
block|{
name|ddebug
argument_list|(
literal|"Destroy DST lib"
argument_list|)
expr_stmt|;
name|dst_lib_destroy
argument_list|()
expr_stmt|;
name|is_dst_up
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
name|cleanup_entropy
argument_list|(
operator|&
name|entropy
argument_list|)
expr_stmt|;
name|lwres_conf_clear
argument_list|(
name|lwctx
argument_list|)
expr_stmt|;
name|lwres_context_destroy
argument_list|(
operator|&
name|lwctx
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Destroying request manager"
argument_list|)
expr_stmt|;
name|dns_requestmgr_detach
argument_list|(
operator|&
name|requestmgr
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Freeing the dispatchers"
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_ipv4
condition|)
name|dns_dispatch_detach
argument_list|(
operator|&
name|dispatchv4
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_ipv6
condition|)
name|dns_dispatch_detach
argument_list|(
operator|&
name|dispatchv6
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Shutting down dispatch manager"
argument_list|)
expr_stmt|;
name|dns_dispatchmgr_destroy
argument_list|(
operator|&
name|dispatchmgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|maybeshutdown
parameter_list|(
name|void
parameter_list|)
block|{
name|ddebug
argument_list|(
literal|"Shutting down request manager"
argument_list|)
expr_stmt|;
name|dns_requestmgr_shutdown
argument_list|(
name|requestmgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|requests
operator|!=
literal|0
condition|)
return|return;
name|doshutdown
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|shutdown_program
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|task
operator|==
name|global_task
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"shutdown_program()"
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|shuttingdown
operator|=
name|ISC_TRUE
expr_stmt|;
name|maybeshutdown
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setup_system
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_sockaddr_t
name|bind_any
decl_stmt|,
name|bind_any6
decl_stmt|;
name|lwres_result_t
name|lwresult
decl_stmt|;
name|unsigned
name|int
name|attrs
decl_stmt|,
name|attrmask
decl_stmt|;
name|int
name|i
decl_stmt|;
name|isc_logconfig_t
modifier|*
name|logconfig
init|=
name|NULL
decl_stmt|;
name|ddebug
argument_list|(
literal|"setup_system()"
argument_list|)
expr_stmt|;
name|dns_result_register
argument_list|()
expr_stmt|;
name|result
operator|=
name|isc_net_probeipv4
argument_list|()
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|have_ipv4
operator|=
name|ISC_TRUE
expr_stmt|;
name|result
operator|=
name|isc_net_probeipv6
argument_list|()
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|have_ipv6
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|have_ipv4
operator|&&
operator|!
name|have_ipv6
condition|)
name|fatal
argument_list|(
literal|"could not find either IPv4 or IPv6"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_log_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|lctx
argument_list|,
operator|&
name|logconfig
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_log_create"
argument_list|)
expr_stmt|;
name|isc_log_setcontext
argument_list|(
name|lctx
argument_list|)
expr_stmt|;
name|dns_log_init
argument_list|(
name|lctx
argument_list|)
expr_stmt|;
name|dns_log_setcontext
argument_list|(
name|lctx
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_log_usechannel
argument_list|(
name|logconfig
argument_list|,
literal|"default_debug"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_log_usechannel"
argument_list|)
expr_stmt|;
name|isc_log_setdebuglevel
argument_list|(
name|lctx
argument_list|,
name|logdebuglevel
argument_list|)
expr_stmt|;
name|lwresult
operator|=
name|lwres_context_create
argument_list|(
operator|&
name|lwctx
argument_list|,
name|mctx
argument_list|,
name|mem_alloc
argument_list|,
name|mem_free
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|lwresult
operator|!=
name|LWRES_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"lwres_context_create failed"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|lwres_conf_parse
argument_list|(
name|lwctx
argument_list|,
name|RESOLV_CONF
argument_list|)
expr_stmt|;
name|lwconf
operator|=
name|lwres_conf_get
argument_list|(
name|lwctx
argument_list|)
expr_stmt|;
name|ns_inuse
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|local_only
operator|||
name|lwconf
operator|->
name|nsnext
operator|<=
literal|0
condition|)
block|{
name|struct
name|in_addr
name|in
decl_stmt|;
name|struct
name|in6_addr
name|in6
decl_stmt|;
if|if
condition|(
name|local_only
operator|&&
name|keyfile
operator|==
name|NULL
condition|)
name|keyfile
operator|=
name|SESSION_KEYFILE
expr_stmt|;
name|default_servers
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|servers
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|servers
argument_list|,
name|ns_total
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
name|ns_total
operator|=
operator|(
name|have_ipv4
condition|?
literal|1
else|:
literal|0
operator|)
operator|+
operator|(
name|have_ipv6
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
name|servers
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|ns_total
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|servers
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_ipv4
condition|)
block|{
name|in
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|INADDR_LOOPBACK
argument_list|)
expr_stmt|;
name|isc_sockaddr_fromin
argument_list|(
operator|&
name|servers
index|[
literal|0
index|]
argument_list|,
operator|&
name|in
argument_list|,
name|dnsport
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|have_ipv6
condition|)
block|{
name|memset
argument_list|(
operator|&
name|in6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in6
argument_list|)
argument_list|)
expr_stmt|;
name|in6
operator|.
name|s6_addr
index|[
literal|15
index|]
operator|=
literal|1
expr_stmt|;
name|isc_sockaddr_fromin6
argument_list|(
operator|&
name|servers
index|[
operator|(
name|have_ipv4
condition|?
literal|1
else|:
literal|0
operator|)
index|]
argument_list|,
operator|&
name|in6
argument_list|,
name|dnsport
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ns_total
operator|=
name|lwconf
operator|->
name|nsnext
expr_stmt|;
name|servers
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|ns_total
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|servers
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ns_total
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|lwconf
operator|->
name|nameservers
index|[
name|i
index|]
operator|.
name|family
operator|==
name|LWRES_ADDRTYPE_V4
condition|)
block|{
name|struct
name|in_addr
name|in4
decl_stmt|;
name|memmove
argument_list|(
operator|&
name|in4
argument_list|,
name|lwconf
operator|->
name|nameservers
index|[
name|i
index|]
operator|.
name|address
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|isc_sockaddr_fromin
argument_list|(
operator|&
name|servers
index|[
name|i
index|]
argument_list|,
operator|&
name|in4
argument_list|,
name|dnsport
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|in6_addr
name|in6
decl_stmt|;
name|memmove
argument_list|(
operator|&
name|in6
argument_list|,
name|lwconf
operator|->
name|nameservers
index|[
name|i
index|]
operator|.
name|address
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|isc_sockaddr_fromin6
argument_list|(
operator|&
name|servers
index|[
name|i
index|]
argument_list|,
operator|&
name|in6
argument_list|,
name|dnsport
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|setup_entropy
argument_list|(
name|mctx
argument_list|,
name|NULL
argument_list|,
operator|&
name|entropy
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_hash_create
argument_list|(
name|mctx
argument_list|,
name|entropy
argument_list|,
name|DNS_NAME_MAXWIRE
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_hash_create"
argument_list|)
expr_stmt|;
name|isc_hash_init
argument_list|()
expr_stmt|;
name|result
operator|=
name|dns_dispatchmgr_create
argument_list|(
name|mctx
argument_list|,
name|entropy
argument_list|,
operator|&
name|dispatchmgr
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dispatchmgr_create"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_socketmgr_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|socketmgr
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_socketmgr_create"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_timermgr_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|timermgr
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_timermgr_create"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_taskmgr_create
argument_list|(
name|mctx
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
operator|&
name|taskmgr
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_taskmgr_create"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_task_create
argument_list|(
name|taskmgr
argument_list|,
literal|0
argument_list|,
operator|&
name|global_task
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_task_create"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_task_onshutdown
argument_list|(
name|global_task
argument_list|,
name|shutdown_program
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_task_onshutdown"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dst_lib_init
argument_list|(
name|mctx
argument_list|,
name|entropy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dst_lib_init"
argument_list|)
expr_stmt|;
name|is_dst_up
operator|=
name|ISC_TRUE
expr_stmt|;
name|attrmask
operator|=
name|DNS_DISPATCHATTR_UDP
operator||
name|DNS_DISPATCHATTR_TCP
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_IPV4
operator||
name|DNS_DISPATCHATTR_IPV6
expr_stmt|;
if|if
condition|(
name|have_ipv6
condition|)
block|{
name|attrs
operator|=
name|DNS_DISPATCHATTR_UDP
expr_stmt|;
name|attrs
operator||=
name|DNS_DISPATCHATTR_MAKEQUERY
expr_stmt|;
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV6
expr_stmt|;
name|isc_sockaddr_any6
argument_list|(
operator|&
name|bind_any6
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dispatch_getudp
argument_list|(
name|dispatchmgr
argument_list|,
name|socketmgr
argument_list|,
name|taskmgr
argument_list|,
operator|&
name|bind_any6
argument_list|,
name|PACKETSIZE
argument_list|,
literal|4
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
literal|5
argument_list|,
name|attrs
argument_list|,
name|attrmask
argument_list|,
operator|&
name|dispatchv6
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dispatch_getudp (v6)"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|have_ipv4
condition|)
block|{
name|attrs
operator|=
name|DNS_DISPATCHATTR_UDP
expr_stmt|;
name|attrs
operator||=
name|DNS_DISPATCHATTR_MAKEQUERY
expr_stmt|;
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV4
expr_stmt|;
name|isc_sockaddr_any
argument_list|(
operator|&
name|bind_any
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dispatch_getudp
argument_list|(
name|dispatchmgr
argument_list|,
name|socketmgr
argument_list|,
name|taskmgr
argument_list|,
operator|&
name|bind_any
argument_list|,
name|PACKETSIZE
argument_list|,
literal|4
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|,
literal|5
argument_list|,
name|attrs
argument_list|,
name|attrmask
argument_list|,
operator|&
name|dispatchv4
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dispatch_getudp (v4)"
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_requestmgr_create
argument_list|(
name|mctx
argument_list|,
name|timermgr
argument_list|,
name|socketmgr
argument_list|,
name|taskmgr
argument_list|,
name|dispatchmgr
argument_list|,
name|dispatchv4
argument_list|,
name|dispatchv6
argument_list|,
operator|&
name|requestmgr
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_requestmgr_create"
argument_list|)
expr_stmt|;
if|if
condition|(
name|keystr
operator|!=
name|NULL
condition|)
name|setup_keystr
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|local_only
condition|)
block|{
name|result
operator|=
name|read_sessionkey
argument_list|(
name|mctx
argument_list|,
name|lctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"can't read key from %s: %s\n"
argument_list|,
name|keyfile
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|keyfile
operator|!=
name|NULL
condition|)
name|setup_keyfile
argument_list|(
name|mctx
argument_list|,
name|lctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|get_addresses
parameter_list|(
name|char
modifier|*
name|host
parameter_list|,
name|in_port_t
name|port
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|,
name|int
name|naddrs
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_app_block
argument_list|()
expr_stmt|;
name|result
operator|=
name|bind9_getaddresses
argument_list|(
name|host
argument_list|,
name|port
argument_list|,
name|sockaddr
argument_list|,
name|naddrs
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|isc_app_unblock
argument_list|()
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"couldn't get address for '%s': %s"
argument_list|,
name|host
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|version
parameter_list|(
name|void
parameter_list|)
block|{
name|fputs
argument_list|(
literal|"nsupdate "
name|VERSION
literal|"\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|PARSE_ARGS_FMT
value|"dDML:y:ghlovk:p:r:R::t:u:V"
end_define

begin_function
specifier|static
name|void
name|pre_parse_args
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ch
decl_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|isc_commandline_parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|PARSE_ARGS_FMT
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'M'
case|:
comment|/* was -dm */
name|debugging
operator|=
name|ISC_TRUE
expr_stmt|;
name|ddebugging
operator|=
name|ISC_TRUE
expr_stmt|;
name|memdebugging
operator|=
name|ISC_TRUE
expr_stmt|;
name|isc_mem_debugging
operator|=
name|ISC_MEM_DEBUGTRACE
operator||
name|ISC_MEM_DEBUGRECORD
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
case|case
literal|'h'
case|:
if|if
condition|(
name|isc_commandline_option
operator|!=
literal|'?'
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: invalid argument -%c\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|isc_commandline_option
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: nsupdate [-dD] [-L level] [-l]"
literal|"[-g | -o | -y keyname:secret | -k keyfile] "
literal|"[-v] [-V] [filename]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
case|case
literal|'V'
case|:
name|version
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
block|}
name|isc_commandline_reset
operator|=
name|ISC_TRUE
expr_stmt|;
name|isc_commandline_index
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|parse_args
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_entropy_t
modifier|*
modifier|*
name|ectx
parameter_list|)
block|{
name|int
name|ch
decl_stmt|;
name|isc_uint32_t
name|i
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|debug
argument_list|(
literal|"parse_args"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|isc_commandline_parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|PARSE_ARGS_FMT
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'d'
case|:
name|debugging
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
comment|/* was -dd */
name|debugging
operator|=
name|ISC_TRUE
expr_stmt|;
name|ddebugging
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
break|break;
case|case
literal|'l'
case|:
name|local_only
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
name|result
operator|=
name|isc_parse_uint32
argument_list|(
operator|&
name|i
argument_list|,
name|isc_commandline_argument
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad library debug value "
literal|"'%s'\n"
argument_list|,
name|isc_commandline_argument
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|logdebuglevel
operator|=
name|i
expr_stmt|;
break|break;
case|case
literal|'y'
case|:
name|keystr
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|usevc
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
name|keyfile
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|usegsstsig
operator|=
name|ISC_TRUE
expr_stmt|;
name|use_win2k_gsstsig
operator|=
name|ISC_FALSE
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|usegsstsig
operator|=
name|ISC_TRUE
expr_stmt|;
name|use_win2k_gsstsig
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|result
operator|=
name|isc_parse_uint16
argument_list|(
operator|&
name|dnsport
argument_list|,
name|isc_commandline_argument
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad port number "
literal|"'%s'\n"
argument_list|,
name|isc_commandline_argument
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'t'
case|:
name|result
operator|=
name|isc_parse_uint32
argument_list|(
operator|&
name|timeout
argument_list|,
name|isc_commandline_argument
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad timeout '%s'\n"
argument_list|,
name|isc_commandline_argument
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|timeout
operator|==
literal|0
condition|)
name|timeout
operator|=
name|UINT_MAX
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|result
operator|=
name|isc_parse_uint32
argument_list|(
operator|&
name|udp_timeout
argument_list|,
name|isc_commandline_argument
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad udp timeout '%s'\n"
argument_list|,
name|isc_commandline_argument
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|udp_timeout
operator|==
literal|0
condition|)
name|udp_timeout
operator|=
name|UINT_MAX
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|result
operator|=
name|isc_parse_uint32
argument_list|(
operator|&
name|udp_retries
argument_list|,
name|isc_commandline_argument
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad udp retries '%s'\n"
argument_list|,
name|isc_commandline_argument
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'R'
case|:
name|setup_entropy
argument_list|(
name|mctx
argument_list|,
name|isc_commandline_argument
argument_list|,
name|ectx
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: unhandled option: %c\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|isc_commandline_option
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|keyfile
operator|!=
name|NULL
operator|&&
name|keystr
operator|!=
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: cannot specify both -k and -y\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|GSSAPI
if|if
condition|(
name|usegsstsig
operator|&&
operator|(
name|keyfile
operator|!=
name|NULL
operator|||
name|keystr
operator|!=
name|NULL
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: cannot specify -g with -k or -y\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|usegsstsig
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: cannot specify -g	or -o, "
expr|\
literal|"program not linked with GSS API Library\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|argv
index|[
name|isc_commandline_index
index|]
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|isc_commandline_index
index|]
argument_list|,
literal|"-"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|input
operator|=
name|stdin
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|isc_stdio_open
argument_list|(
name|argv
index|[
name|isc_commandline_index
index|]
argument_list|,
literal|"r"
argument_list|,
operator|&
name|input
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not open '%s': %s\n"
argument_list|,
name|argv
index|[
name|isc_commandline_index
index|]
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|interactive
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|parse_name
parameter_list|(
name|char
modifier|*
modifier|*
name|cmdlinep
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|namep
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|char
modifier|*
name|word
decl_stmt|;
name|isc_buffer_t
modifier|*
name|namebuf
init|=
name|NULL
decl_stmt|;
name|isc_buffer_t
name|source
decl_stmt|;
name|word
operator|=
name|nsu_strsep
argument_list|(
name|cmdlinep
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read owner name\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
name|result
operator|=
name|dns_message_gettempname
argument_list|(
name|msg
argument_list|,
name|namep
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_gettempname"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
operator|&
name|namebuf
argument_list|,
name|DNS_NAME_MAXWIRE
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_buffer_allocate"
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
operator|*
name|namep
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_setbuffer
argument_list|(
operator|*
name|namep
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
name|dns_message_takebuffer
argument_list|(
name|msg
argument_list|,
operator|&
name|namebuf
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|source
argument_list|,
name|word
argument_list|,
name|strlen
argument_list|(
name|word
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|source
argument_list|,
name|strlen
argument_list|(
name|word
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
operator|*
name|namep
argument_list|,
operator|&
name|source
argument_list|,
name|dns_rootname
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_name_fromtext"
argument_list|)
expr_stmt|;
name|isc_buffer_invalidate
argument_list|(
operator|&
name|source
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|parse_rdata
parameter_list|(
name|char
modifier|*
modifier|*
name|cmdlinep
parameter_list|,
name|dns_rdataclass_t
name|rdataclass
parameter_list|,
name|dns_rdatatype_t
name|rdatatype
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
block|{
name|char
modifier|*
name|cmdline
init|=
operator|*
name|cmdlinep
decl_stmt|;
name|isc_buffer_t
name|source
decl_stmt|,
modifier|*
name|buf
init|=
name|NULL
decl_stmt|,
modifier|*
name|newbuf
init|=
name|NULL
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|isc_lex_t
modifier|*
name|lex
init|=
name|NULL
decl_stmt|;
name|dns_rdatacallbacks_t
name|callbacks
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|cmdline
operator|==
name|NULL
condition|)
block|{
name|rdata
operator|->
name|flags
operator|=
name|DNS_RDATA_UPDATE
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
while|while
condition|(
operator|*
name|cmdline
operator|!=
literal|0
operator|&&
name|isspace
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|cmdline
argument_list|)
condition|)
name|cmdline
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|cmdline
operator|!=
literal|0
condition|)
block|{
name|dns_rdatacallbacks_init
argument_list|(
operator|&
name|callbacks
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_lex_create
argument_list|(
name|mctx
argument_list|,
name|strlen
argument_list|(
name|cmdline
argument_list|)
argument_list|,
operator|&
name|lex
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_lex_create"
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|source
argument_list|,
name|cmdline
argument_list|,
name|strlen
argument_list|(
name|cmdline
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|source
argument_list|,
name|strlen
argument_list|(
name|cmdline
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_lex_openbuffer
argument_list|(
name|lex
argument_list|,
operator|&
name|source
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_lex_openbuffer"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
operator|&
name|buf
argument_list|,
name|MAXWIRE
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_buffer_allocate"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_fromtext
argument_list|(
name|NULL
argument_list|,
name|rdataclass
argument_list|,
name|rdatatype
argument_list|,
name|lex
argument_list|,
name|dns_rootname
argument_list|,
literal|0
argument_list|,
name|mctx
argument_list|,
name|buf
argument_list|,
operator|&
name|callbacks
argument_list|)
expr_stmt|;
name|isc_lex_destroy
argument_list|(
operator|&
name|lex
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_buffer_usedregion
argument_list|(
name|buf
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
operator|&
name|newbuf
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_buffer_allocate"
argument_list|)
expr_stmt|;
name|isc_buffer_putmem
argument_list|(
name|newbuf
argument_list|,
name|r
operator|.
name|base
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
name|newbuf
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|dns_rdata_fromregion
argument_list|(
name|rdata
argument_list|,
name|rdataclass
argument_list|,
name|rdatatype
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|isc_buffer_free
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
name|dns_message_takebuffer
argument_list|(
name|msg
argument_list|,
operator|&
name|newbuf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid rdata format: %s\n"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_free
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
block|}
else|else
block|{
name|rdata
operator|->
name|flags
operator|=
name|DNS_RDATA_UPDATE
expr_stmt|;
block|}
operator|*
name|cmdlinep
operator|=
name|cmdline
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|make_prereq
parameter_list|(
name|char
modifier|*
name|cmdline
parameter_list|,
name|isc_boolean_t
name|ispositive
parameter_list|,
name|isc_boolean_t
name|isrrset
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|char
modifier|*
name|word
decl_stmt|;
name|dns_name_t
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|isc_textregion_t
name|region
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
init|=
name|NULL
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|rdatalist
init|=
name|NULL
decl_stmt|;
name|dns_rdataclass_t
name|rdataclass
decl_stmt|;
name|dns_rdatatype_t
name|rdatatype
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
init|=
name|NULL
decl_stmt|;
name|isc_uint16_t
name|retval
decl_stmt|;
name|ddebug
argument_list|(
literal|"make_prereq()"
argument_list|)
expr_stmt|;
comment|/* 	 * Read the owner name 	 */
name|retval
operator|=
name|parse_name
argument_list|(
operator|&
name|cmdline
argument_list|,
name|updatemsg
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|STATUS_MORE
condition|)
return|return
operator|(
name|retval
operator|)
return|;
comment|/* 	 * If this is an rrset prereq, read the class or type. 	 */
if|if
condition|(
name|isrrset
condition|)
block|{
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read class or type\n"
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
name|region
operator|.
name|base
operator|=
name|word
expr_stmt|;
name|region
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|word
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataclass_fromtext
argument_list|(
operator|&
name|rdataclass
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
operator|!
name|setzoneclass
argument_list|(
name|rdataclass
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"class mismatch: %s\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
comment|/* 			 * Now read the type. 			 */
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read type\n"
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
name|region
operator|.
name|base
operator|=
name|word
expr_stmt|;
name|region
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|word
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatatype_fromtext
argument_list|(
operator|&
name|rdatatype
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid type: %s\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
block|}
else|else
block|{
name|rdataclass
operator|=
name|getzoneclass
argument_list|()
expr_stmt|;
name|result
operator|=
name|dns_rdatatype_fromtext
argument_list|(
operator|&
name|rdatatype
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid type: %s\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
block|}
block|}
else|else
name|rdatatype
operator|=
name|dns_rdatatype_any
expr_stmt|;
name|result
operator|=
name|dns_message_gettemprdata
argument_list|(
name|updatemsg
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_gettemprdata"
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|isrrset
operator|&&
name|ispositive
condition|)
block|{
name|retval
operator|=
name|parse_rdata
argument_list|(
operator|&
name|cmdline
argument_list|,
name|rdataclass
argument_list|,
name|rdatatype
argument_list|,
name|updatemsg
argument_list|,
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|STATUS_MORE
condition|)
goto|goto
name|failure
goto|;
block|}
else|else
name|rdata
operator|->
name|flags
operator|=
name|DNS_RDATA_UPDATE
expr_stmt|;
name|result
operator|=
name|dns_message_gettemprdatalist
argument_list|(
name|updatemsg
argument_list|,
operator|&
name|rdatalist
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_gettemprdatalist"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_gettemprdataset
argument_list|(
name|updatemsg
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_gettemprdataset"
argument_list|)
expr_stmt|;
name|dns_rdatalist_init
argument_list|(
name|rdatalist
argument_list|)
expr_stmt|;
name|rdatalist
operator|->
name|type
operator|=
name|rdatatype
expr_stmt|;
if|if
condition|(
name|ispositive
condition|)
block|{
if|if
condition|(
name|isrrset
operator|&&
name|rdata
operator|->
name|data
operator|!=
name|NULL
condition|)
name|rdatalist
operator|->
name|rdclass
operator|=
name|rdataclass
expr_stmt|;
else|else
name|rdatalist
operator|->
name|rdclass
operator|=
name|dns_rdataclass_any
expr_stmt|;
block|}
else|else
name|rdatalist
operator|->
name|rdclass
operator|=
name|dns_rdataclass_none
expr_stmt|;
name|rdatalist
operator|->
name|covers
operator|=
literal|0
expr_stmt|;
name|rdatalist
operator|->
name|ttl
operator|=
literal|0
expr_stmt|;
name|rdata
operator|->
name|rdclass
operator|=
name|rdatalist
operator|->
name|rdclass
expr_stmt|;
name|rdata
operator|->
name|type
operator|=
name|rdatatype
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|dns_rdatalist_tordataset
argument_list|(
name|rdatalist
argument_list|,
name|rdataset
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|name
operator|->
name|list
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_message_addname
argument_list|(
name|updatemsg
argument_list|,
name|name
argument_list|,
name|DNS_SECTION_PREREQUISITE
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
name|failure
label|:
if|if
condition|(
name|name
operator|!=
name|NULL
condition|)
name|dns_message_puttempname
argument_list|(
name|updatemsg
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|evaluate_prereq
parameter_list|(
name|char
modifier|*
name|cmdline
parameter_list|)
block|{
name|char
modifier|*
name|word
decl_stmt|;
name|isc_boolean_t
name|ispositive
decl_stmt|,
name|isrrset
decl_stmt|;
name|ddebug
argument_list|(
literal|"evaluate_prereq()"
argument_list|)
expr_stmt|;
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read operation code\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"nxdomain"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ispositive
operator|=
name|ISC_FALSE
expr_stmt|;
name|isrrset
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"yxdomain"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ispositive
operator|=
name|ISC_TRUE
expr_stmt|;
name|isrrset
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"nxrrset"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ispositive
operator|=
name|ISC_FALSE
expr_stmt|;
name|isrrset
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"yxrrset"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ispositive
operator|=
name|ISC_TRUE
expr_stmt|;
name|isrrset
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"incorrect operation code: %s\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
return|return
operator|(
name|make_prereq
argument_list|(
name|cmdline
argument_list|,
name|ispositive
argument_list|,
name|isrrset
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|evaluate_server
parameter_list|(
name|char
modifier|*
name|cmdline
parameter_list|)
block|{
name|char
modifier|*
name|word
decl_stmt|,
modifier|*
name|server
decl_stmt|;
name|long
name|port
decl_stmt|;
if|if
condition|(
name|local_only
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cannot reset server in localhost-only mode\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read server name\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
name|server
operator|=
name|word
expr_stmt|;
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
name|port
operator|=
name|dnsport
expr_stmt|;
else|else
block|{
name|char
modifier|*
name|endp
decl_stmt|;
name|port
operator|=
name|strtol
argument_list|(
name|word
argument_list|,
operator|&
name|endp
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"port '%s' is not numeric\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|port
operator|<
literal|1
operator|||
name|port
operator|>
literal|65535
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"port '%s' is out of range "
literal|"(1 to 65535)\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
block|}
if|if
condition|(
name|servers
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|servers
argument_list|,
name|ns_total
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
name|default_servers
operator|=
name|ISC_FALSE
expr_stmt|;
name|ns_total
operator|=
name|MAX_SERVERADDRS
expr_stmt|;
name|servers
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|ns_total
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|servers
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|servers
argument_list|,
literal|0
argument_list|,
name|ns_total
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
name|get_addresses
argument_list|(
name|server
argument_list|,
operator|(
name|in_port_t
operator|)
name|port
argument_list|,
name|servers
argument_list|,
name|ns_total
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|evaluate_local
parameter_list|(
name|char
modifier|*
name|cmdline
parameter_list|)
block|{
name|char
modifier|*
name|word
decl_stmt|,
modifier|*
name|local
decl_stmt|;
name|long
name|port
decl_stmt|;
name|struct
name|in_addr
name|in4
decl_stmt|;
name|struct
name|in6_addr
name|in6
decl_stmt|;
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read server name\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
name|local
operator|=
name|word
expr_stmt|;
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
name|port
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|char
modifier|*
name|endp
decl_stmt|;
name|port
operator|=
name|strtol
argument_list|(
name|word
argument_list|,
operator|&
name|endp
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"port '%s' is not numeric\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|port
operator|<
literal|1
operator|||
name|port
operator|>
literal|65535
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"port '%s' is out of range "
literal|"(1 to 65535)\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
block|}
if|if
condition|(
name|localaddr
operator|==
name|NULL
condition|)
block|{
name|localaddr
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|localaddr
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|have_ipv6
operator|&&
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|local
argument_list|,
operator|&
name|in6
argument_list|)
operator|==
literal|1
condition|)
name|isc_sockaddr_fromin6
argument_list|(
name|localaddr
argument_list|,
operator|&
name|in6
argument_list|,
operator|(
name|in_port_t
operator|)
name|port
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|have_ipv4
operator|&&
name|inet_pton
argument_list|(
name|AF_INET
argument_list|,
name|local
argument_list|,
operator|&
name|in4
argument_list|)
operator|==
literal|1
condition|)
name|isc_sockaddr_fromin
argument_list|(
name|localaddr
argument_list|,
operator|&
name|in4
argument_list|,
operator|(
name|in_port_t
operator|)
name|port
argument_list|)
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid address %s"
argument_list|,
name|local
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|evaluate_key
parameter_list|(
name|char
modifier|*
name|cmdline
parameter_list|)
block|{
name|char
modifier|*
name|namestr
decl_stmt|;
name|char
modifier|*
name|secretstr
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_fixedname_t
name|fkeyname
decl_stmt|;
name|dns_name_t
modifier|*
name|keyname
decl_stmt|;
name|int
name|secretlen
decl_stmt|;
name|unsigned
name|char
modifier|*
name|secret
init|=
name|NULL
decl_stmt|;
name|isc_buffer_t
name|secretbuf
decl_stmt|;
name|dns_name_t
modifier|*
name|hmacname
init|=
name|NULL
decl_stmt|;
name|isc_uint16_t
name|digestbits
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|n
decl_stmt|;
name|namestr
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|namestr
operator|==
name|NULL
operator|||
operator|*
name|namestr
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read key name\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
name|dns_fixedname_init
argument_list|(
operator|&
name|fkeyname
argument_list|)
expr_stmt|;
name|keyname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fkeyname
argument_list|)
expr_stmt|;
name|n
operator|=
name|strchr
argument_list|(
name|namestr
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|NULL
condition|)
block|{
name|digestbits
operator|=
name|parse_hmac
argument_list|(
operator|&
name|hmacname
argument_list|,
name|namestr
argument_list|,
name|n
operator|-
name|namestr
argument_list|)
expr_stmt|;
name|namestr
operator|=
name|n
operator|+
literal|1
expr_stmt|;
block|}
else|else
name|hmacname
operator|=
name|DNS_TSIG_HMACMD5_NAME
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|namestr
argument_list|,
name|strlen
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|keyname
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not parse key name\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
name|secretstr
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|secretstr
operator|==
name|NULL
operator|||
operator|*
name|secretstr
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read key secret\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
name|secretlen
operator|=
name|strlen
argument_list|(
name|secretstr
argument_list|)
operator|*
literal|3
operator|/
literal|4
expr_stmt|;
name|secret
operator|=
name|isc_mem_allocate
argument_list|(
name|mctx
argument_list|,
name|secretlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|secret
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|secretbuf
argument_list|,
name|secret
argument_list|,
name|secretlen
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_base64_decodestring
argument_list|(
name|secretstr
argument_list|,
operator|&
name|secretbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not create key from %s: %s\n"
argument_list|,
name|secretstr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|secret
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
name|secretlen
operator|=
name|isc_buffer_usedlength
argument_list|(
operator|&
name|secretbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsigkey
operator|!=
name|NULL
condition|)
name|dns_tsigkey_detach
argument_list|(
operator|&
name|tsigkey
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_tsigkey_create
argument_list|(
name|keyname
argument_list|,
name|hmacname
argument_list|,
name|secret
argument_list|,
name|secretlen
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|mctx
argument_list|,
name|NULL
argument_list|,
operator|&
name|tsigkey
argument_list|)
expr_stmt|;
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|secret
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not create key from %s %s: %s\n"
argument_list|,
name|namestr
argument_list|,
name|secretstr
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
name|dst_key_setbits
argument_list|(
name|tsigkey
operator|->
name|key
argument_list|,
name|digestbits
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|evaluate_zone
parameter_list|(
name|char
modifier|*
name|cmdline
parameter_list|)
block|{
name|char
modifier|*
name|word
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read zone name\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
name|dns_fixedname_init
argument_list|(
operator|&
name|fuserzone
argument_list|)
expr_stmt|;
name|userzone
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fuserzone
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|word
argument_list|,
name|strlen
argument_list|(
name|word
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|word
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|userzone
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|userzone
operator|=
name|NULL
expr_stmt|;
comment|/* Lest it point to an invalid name */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not parse zone name\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|evaluate_realm
parameter_list|(
name|char
modifier|*
name|cmdline
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|GSSAPI
name|char
modifier|*
name|word
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|n
decl_stmt|;
if|if
condition|(
name|realm
operator|!=
name|NULL
condition|)
block|{
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|realm
argument_list|)
expr_stmt|;
name|realm
operator|=
name|NULL
expr_stmt|;
block|}
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
name|n
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"@%s"
argument_list|,
name|word
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
operator|||
operator|(
name|size_t
operator|)
name|n
operator|>=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"realm is too long"
argument_list|)
expr_stmt|;
name|realm
operator|=
name|isc_mem_strdup
argument_list|(
name|mctx
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
else|#
directive|else
name|UNUSED
argument_list|(
name|cmdline
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|evaluate_ttl
parameter_list|(
name|char
modifier|*
name|cmdline
parameter_list|)
block|{
name|char
modifier|*
name|word
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_uint32_t
name|ttl
decl_stmt|;
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not ttl\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"none"
argument_list|)
condition|)
block|{
name|default_ttl
operator|=
literal|0
expr_stmt|;
name|default_ttl_set
operator|=
name|ISC_FALSE
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
name|result
operator|=
name|isc_parse_uint32
argument_list|(
operator|&
name|ttl
argument_list|,
name|word
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
if|if
condition|(
name|ttl
operator|>
name|TTL_MAX
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ttl '%s' is out of range (0 to %u)\n"
argument_list|,
name|word
argument_list|,
name|TTL_MAX
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
name|default_ttl
operator|=
name|ttl
expr_stmt|;
name|default_ttl_set
operator|=
name|ISC_TRUE
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|evaluate_class
parameter_list|(
name|char
modifier|*
name|cmdline
parameter_list|)
block|{
name|char
modifier|*
name|word
decl_stmt|;
name|isc_textregion_t
name|r
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataclass_t
name|rdclass
decl_stmt|;
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read class name\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
name|r
operator|.
name|base
operator|=
name|word
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|word
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataclass_fromtext
argument_list|(
operator|&
name|rdclass
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not parse class name: %s\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
switch|switch
condition|(
name|rdclass
condition|)
block|{
case|case
name|dns_rdataclass_none
case|:
case|case
name|dns_rdataclass_any
case|:
case|case
name|dns_rdataclass_reserved0
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad default class: %s\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
default|default:
name|defaultclass
operator|=
name|rdclass
expr_stmt|;
block|}
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|update_addordelete
parameter_list|(
name|char
modifier|*
name|cmdline
parameter_list|,
name|isc_boolean_t
name|isdelete
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_name_t
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|isc_uint32_t
name|ttl
decl_stmt|;
name|char
modifier|*
name|word
decl_stmt|;
name|dns_rdataclass_t
name|rdataclass
decl_stmt|;
name|dns_rdatatype_t
name|rdatatype
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
init|=
name|NULL
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|rdatalist
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
init|=
name|NULL
decl_stmt|;
name|isc_textregion_t
name|region
decl_stmt|;
name|isc_uint16_t
name|retval
decl_stmt|;
name|ddebug
argument_list|(
literal|"update_addordelete()"
argument_list|)
expr_stmt|;
comment|/* 	 * Read the owner name. 	 */
name|retval
operator|=
name|parse_name
argument_list|(
operator|&
name|cmdline
argument_list|,
name|updatemsg
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|STATUS_MORE
condition|)
return|return
operator|(
name|retval
operator|)
return|;
name|result
operator|=
name|dns_message_gettemprdata
argument_list|(
name|updatemsg
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_gettemprdata"
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
comment|/* 	 * If this is an add, read the TTL and verify that it's in range. 	 * If it's a delete, ignore a TTL if present (for compatibility). 	 */
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|isdelete
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read owner ttl\n"
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
else|else
block|{
name|ttl
operator|=
literal|0
expr_stmt|;
name|rdataclass
operator|=
name|dns_rdataclass_any
expr_stmt|;
name|rdatatype
operator|=
name|dns_rdatatype_any
expr_stmt|;
name|rdata
operator|->
name|flags
operator|=
name|DNS_RDATA_UPDATE
expr_stmt|;
goto|goto
name|doneparsing
goto|;
block|}
block|}
name|result
operator|=
name|isc_parse_uint32
argument_list|(
operator|&
name|ttl
argument_list|,
name|word
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|isdelete
condition|)
block|{
name|ttl
operator|=
literal|0
expr_stmt|;
goto|goto
name|parseclass
goto|;
block|}
elseif|else
if|if
condition|(
name|default_ttl_set
condition|)
block|{
name|ttl
operator|=
name|default_ttl
expr_stmt|;
goto|goto
name|parseclass
goto|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ttl '%s': %s\n"
argument_list|,
name|word
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
block|}
if|if
condition|(
name|isdelete
condition|)
name|ttl
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|ttl
operator|>
name|TTL_MAX
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ttl '%s' is out of range (0 to %u)\n"
argument_list|,
name|word
argument_list|,
name|TTL_MAX
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
comment|/* 	 * Read the class or type. 	 */
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
name|parseclass
label|:
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|isdelete
condition|)
block|{
name|rdataclass
operator|=
name|dns_rdataclass_any
expr_stmt|;
name|rdatatype
operator|=
name|dns_rdatatype_any
expr_stmt|;
name|rdata
operator|->
name|flags
operator|=
name|DNS_RDATA_UPDATE
expr_stmt|;
goto|goto
name|doneparsing
goto|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read class or type\n"
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
block|}
name|region
operator|.
name|base
operator|=
name|word
expr_stmt|;
name|region
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|word
argument_list|)
expr_stmt|;
name|rdataclass
operator|=
name|dns_rdataclass_any
expr_stmt|;
name|result
operator|=
name|dns_rdataclass_fromtext
argument_list|(
operator|&
name|rdataclass
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|rdataclass
operator|!=
name|dns_rdataclass_any
condition|)
block|{
if|if
condition|(
operator|!
name|setzoneclass
argument_list|(
name|rdataclass
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"class mismatch: %s\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
comment|/* 		 * Now read the type. 		 */
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|isdelete
condition|)
block|{
name|rdataclass
operator|=
name|dns_rdataclass_any
expr_stmt|;
name|rdatatype
operator|=
name|dns_rdatatype_any
expr_stmt|;
name|rdata
operator|->
name|flags
operator|=
name|DNS_RDATA_UPDATE
expr_stmt|;
goto|goto
name|doneparsing
goto|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read type\n"
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
block|}
name|region
operator|.
name|base
operator|=
name|word
expr_stmt|;
name|region
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|word
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatatype_fromtext
argument_list|(
operator|&
name|rdatatype
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"'%s' is not a valid type: %s\n"
argument_list|,
name|word
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
block|}
else|else
block|{
name|rdataclass
operator|=
name|getzoneclass
argument_list|()
expr_stmt|;
name|result
operator|=
name|dns_rdatatype_fromtext
argument_list|(
operator|&
name|rdatatype
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"'%s' is not a valid class or type: "
literal|"%s\n"
argument_list|,
name|word
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
block|}
name|retval
operator|=
name|parse_rdata
argument_list|(
operator|&
name|cmdline
argument_list|,
name|rdataclass
argument_list|,
name|rdatatype
argument_list|,
name|updatemsg
argument_list|,
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|STATUS_MORE
condition|)
goto|goto
name|failure
goto|;
if|if
condition|(
name|isdelete
condition|)
block|{
if|if
condition|(
operator|(
name|rdata
operator|->
name|flags
operator|&
name|DNS_RDATA_UPDATE
operator|)
operator|!=
literal|0
condition|)
name|rdataclass
operator|=
name|dns_rdataclass_any
expr_stmt|;
else|else
name|rdataclass
operator|=
name|dns_rdataclass_none
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|rdata
operator|->
name|flags
operator|&
name|DNS_RDATA_UPDATE
operator|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read rdata\n"
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
block|}
name|doneparsing
label|:
name|result
operator|=
name|dns_message_gettemprdatalist
argument_list|(
name|updatemsg
argument_list|,
operator|&
name|rdatalist
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_gettemprdatalist"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_gettemprdataset
argument_list|(
name|updatemsg
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_gettemprdataset"
argument_list|)
expr_stmt|;
name|dns_rdatalist_init
argument_list|(
name|rdatalist
argument_list|)
expr_stmt|;
name|rdatalist
operator|->
name|type
operator|=
name|rdatatype
expr_stmt|;
name|rdatalist
operator|->
name|rdclass
operator|=
name|rdataclass
expr_stmt|;
name|rdatalist
operator|->
name|covers
operator|=
name|rdatatype
expr_stmt|;
name|rdatalist
operator|->
name|ttl
operator|=
operator|(
name|dns_ttl_t
operator|)
name|ttl
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|dns_rdatalist_tordataset
argument_list|(
name|rdatalist
argument_list|,
name|rdataset
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|name
operator|->
name|list
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_message_addname
argument_list|(
name|updatemsg
argument_list|,
name|name
argument_list|,
name|DNS_SECTION_UPDATE
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
name|failure
label|:
if|if
condition|(
name|name
operator|!=
name|NULL
condition|)
name|dns_message_puttempname
argument_list|(
name|updatemsg
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|dns_message_puttemprdata
argument_list|(
name|updatemsg
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|evaluate_update
parameter_list|(
name|char
modifier|*
name|cmdline
parameter_list|)
block|{
name|char
modifier|*
name|word
decl_stmt|;
name|isc_boolean_t
name|isdelete
decl_stmt|;
name|ddebug
argument_list|(
literal|"evaluate_update()"
argument_list|)
expr_stmt|;
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not read operation code\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"delete"
argument_list|)
operator|==
literal|0
condition|)
name|isdelete
operator|=
name|ISC_TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"del"
argument_list|)
operator|==
literal|0
condition|)
name|isdelete
operator|=
name|ISC_TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"add"
argument_list|)
operator|==
literal|0
condition|)
name|isdelete
operator|=
name|ISC_FALSE
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"incorrect operation code: %s\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
return|return
operator|(
name|update_addordelete
argument_list|(
name|cmdline
argument_list|,
name|isdelete
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|setzone
parameter_list|(
name|dns_name_t
modifier|*
name|zonename
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_name_t
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
init|=
name|NULL
decl_stmt|;
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|updatemsg
argument_list|,
name|DNS_SECTION_ZONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_message_currentname
argument_list|(
name|updatemsg
argument_list|,
name|DNS_SECTION_ZONE
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|dns_message_removename
argument_list|(
name|updatemsg
argument_list|,
name|name
argument_list|,
name|DNS_SECTION_ZONE
argument_list|)
expr_stmt|;
for|for
control|(
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|rdataset
operator|!=
name|NULL
condition|;
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
control|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|dns_message_puttemprdataset
argument_list|(
name|updatemsg
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
name|dns_message_puttempname
argument_list|(
name|updatemsg
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|zonename
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|dns_message_gettempname
argument_list|(
name|updatemsg
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_gettempname"
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
name|zonename
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_gettemprdataset
argument_list|(
name|updatemsg
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_gettemprdataset"
argument_list|)
expr_stmt|;
name|dns_rdataset_makequestion
argument_list|(
name|rdataset
argument_list|,
name|getzoneclass
argument_list|()
argument_list|,
name|dns_rdatatype_soa
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|name
operator|->
name|list
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_message_addname
argument_list|(
name|updatemsg
argument_list|,
name|name
argument_list|,
name|DNS_SECTION_ZONE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|show_message
parameter_list|(
name|FILE
modifier|*
name|stream
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
specifier|const
name|char
modifier|*
name|description
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_t
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|int
name|bufsz
decl_stmt|;
name|ddebug
argument_list|(
literal|"show_message()"
argument_list|)
expr_stmt|;
name|setzone
argument_list|(
name|userzone
argument_list|)
expr_stmt|;
name|bufsz
operator|=
name|INITTEXT
expr_stmt|;
do|do
block|{
if|if
condition|(
name|bufsz
operator|>
name|MAXTEXT
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not allocate large enough "
literal|"buffer to display message\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|buf
operator|!=
name|NULL
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
operator|&
name|buf
argument_list|,
name|bufsz
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_buffer_allocate"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_totext
argument_list|(
name|msg
argument_list|,
name|style
argument_list|,
literal|0
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|bufsz
operator|*=
literal|2
expr_stmt|;
block|}
do|while
condition|(
name|result
operator|==
name|ISC_R_NOSPACE
condition|)
do|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"could not convert message to text format.\n"
argument_list|)
expr_stmt|;
name|isc_buffer_free
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
return|return;
block|}
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"%s\n%.*s"
argument_list|,
name|description
argument_list|,
operator|(
name|int
operator|)
name|isc_buffer_usedlength
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|isc_buffer_base
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_free
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|do_next_command
parameter_list|(
name|char
modifier|*
name|cmdline
parameter_list|)
block|{
name|char
modifier|*
name|word
decl_stmt|;
name|ddebug
argument_list|(
literal|"do_next_command()"
argument_list|)
expr_stmt|;
name|word
operator|=
name|nsu_strsep
argument_list|(
operator|&
name|cmdline
argument_list|,
literal|" \t\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|word
operator|==
name|NULL
operator|||
operator|*
name|word
operator|==
literal|0
condition|)
return|return
operator|(
name|STATUS_SEND
operator|)
return|;
if|if
condition|(
name|word
index|[
literal|0
index|]
operator|==
literal|';'
condition|)
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"quit"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|STATUS_QUIT
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"prereq"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|evaluate_prereq
argument_list|(
name|cmdline
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"nxdomain"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|make_prereq
argument_list|(
name|cmdline
argument_list|,
name|ISC_FALSE
argument_list|,
name|ISC_FALSE
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"yxdomain"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|make_prereq
argument_list|(
name|cmdline
argument_list|,
name|ISC_TRUE
argument_list|,
name|ISC_FALSE
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"nxrrset"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|make_prereq
argument_list|(
name|cmdline
argument_list|,
name|ISC_FALSE
argument_list|,
name|ISC_TRUE
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"yxrrset"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|make_prereq
argument_list|(
name|cmdline
argument_list|,
name|ISC_TRUE
argument_list|,
name|ISC_TRUE
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"update"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|evaluate_update
argument_list|(
name|cmdline
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"delete"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|update_addordelete
argument_list|(
name|cmdline
argument_list|,
name|ISC_TRUE
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"del"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|update_addordelete
argument_list|(
name|cmdline
argument_list|,
name|ISC_TRUE
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"add"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|update_addordelete
argument_list|(
name|cmdline
argument_list|,
name|ISC_FALSE
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"server"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|evaluate_server
argument_list|(
name|cmdline
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"local"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|evaluate_local
argument_list|(
name|cmdline
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"zone"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|evaluate_zone
argument_list|(
name|cmdline
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"class"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|evaluate_class
argument_list|(
name|cmdline
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"send"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|STATUS_SEND
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"debug"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|debugging
condition|)
name|ddebugging
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|debugging
operator|=
name|ISC_TRUE
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"ttl"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|evaluate_ttl
argument_list|(
name|cmdline
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"show"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|show_message
argument_list|(
name|stdout
argument_list|,
name|updatemsg
argument_list|,
literal|"Outgoing update query:"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"answer"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|answer
operator|!=
name|NULL
condition|)
name|show_message
argument_list|(
name|stdout
argument_list|,
name|answer
argument_list|,
literal|"Answer:"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"key"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|usegsstsig
operator|=
name|ISC_FALSE
expr_stmt|;
return|return
operator|(
name|evaluate_key
argument_list|(
name|cmdline
argument_list|)
operator|)
return|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"realm"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|evaluate_realm
argument_list|(
name|cmdline
argument_list|)
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"gsstsig"
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|GSSAPI
name|usegsstsig
operator|=
name|ISC_TRUE
expr_stmt|;
name|use_win2k_gsstsig
operator|=
name|ISC_FALSE
expr_stmt|;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"gsstsig not supported\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"oldgsstsig"
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|GSSAPI
name|usegsstsig
operator|=
name|ISC_TRUE
expr_stmt|;
name|use_win2k_gsstsig
operator|=
name|ISC_TRUE
expr_stmt|;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"gsstsig not supported\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"help"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"nsupdate "
name|VERSION
literal|":\n"
literal|"local address [port]      (set local resolver)\n"
literal|"server address [port]     (set master server for zone)\n"
literal|"send                      (send the update request)\n"
literal|"show                      (show the update request)\n"
literal|"answer                    (show the answer to the last request)\n"
literal|"quit                      (quit, any pending update is not sent\n"
literal|"help                      (display this message_\n"
literal|"key [hmac:]keyname secret (use TSIG to sign the request)\n"
literal|"gsstsig                   (use GSS_TSIG to sign the request)\n"
literal|"oldgsstsig                (use Microsoft's GSS_TSIG to sign the request)\n"
literal|"zone name                 (set the zone to be updated)\n"
literal|"class CLASS               (set the zone's DNS class, e.g. IN (default), CH)\n"
literal|"[prereq] nxdomain name    (does this name not exist)\n"
literal|"[prereq] yxdomain name    (does this name exist)\n"
literal|"[prereq] nxrrset ....     (does this RRset exist)\n"
literal|"[prereq] yxrrset ....     (does this RRset not exist)\n"
literal|"[update] add ....         (add the given record to the zone)\n"
literal|"[update] del[ete] ....    (remove the given record(s) from the zone)\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|word
argument_list|,
literal|"version"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"nsupdate "
name|VERSION
literal|"\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_MORE
operator|)
return|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"incorrect section name: %s\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
return|return
operator|(
name|STATUS_SYNTAX
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_uint16_t
name|get_next_command
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_uint16_t
name|result
init|=
name|STATUS_QUIT
decl_stmt|;
name|char
name|cmdlinebuf
index|[
name|MAXCMD
index|]
decl_stmt|;
name|char
modifier|*
name|cmdline
decl_stmt|;
name|isc_app_block
argument_list|()
expr_stmt|;
if|if
condition|(
name|interactive
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_READLINE
name|cmdline
operator|=
name|readline
argument_list|(
literal|"> "
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdline
operator|!=
name|NULL
condition|)
name|add_history
argument_list|(
name|cmdline
argument_list|)
expr_stmt|;
else|#
directive|else
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"> "
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|cmdline
operator|=
name|fgets
argument_list|(
name|cmdlinebuf
argument_list|,
name|MAXCMD
argument_list|,
name|input
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
name|cmdline
operator|=
name|fgets
argument_list|(
name|cmdlinebuf
argument_list|,
name|MAXCMD
argument_list|,
name|input
argument_list|)
expr_stmt|;
name|isc_app_unblock
argument_list|()
expr_stmt|;
if|if
condition|(
name|cmdline
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|tmp
init|=
name|cmdline
decl_stmt|;
comment|/* 		 * Normalize input by removing any eol as readline() 		 * removes eol but fgets doesn't. 		 */
operator|(
name|void
operator|)
name|nsu_strsep
argument_list|(
operator|&
name|tmp
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|result
operator|=
name|do_next_command
argument_list|(
name|cmdline
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|HAVE_READLINE
if|if
condition|(
name|interactive
condition|)
name|free
argument_list|(
name|cmdline
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|user_interaction
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_uint16_t
name|result
init|=
name|STATUS_MORE
decl_stmt|;
name|ddebug
argument_list|(
literal|"user_interaction()"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|result
operator|==
name|STATUS_MORE
operator|)
operator|||
operator|(
name|result
operator|==
name|STATUS_SYNTAX
operator|)
condition|)
block|{
name|result
operator|=
name|get_next_command
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|interactive
operator|&&
name|result
operator|==
name|STATUS_SYNTAX
condition|)
name|fatal
argument_list|(
literal|"syntax error"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|STATUS_SEND
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|done_update
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_event_t
modifier|*
name|event
init|=
name|global_event
decl_stmt|;
name|ddebug
argument_list|(
literal|"done_update()"
argument_list|)
expr_stmt|;
name|isc_task_send
argument_list|(
name|global_task
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|check_tsig_error
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|isc_buffer_t
modifier|*
name|b
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_any_tsig_t
name|tsig
decl_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdataset_first"
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|tsig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdata_tostruct"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsig
operator|.
name|error
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|isc_buffer_remaininglength
argument_list|(
name|b
argument_list|)
operator|<
literal|1
condition|)
name|check_result
argument_list|(
name|ISC_R_NOSPACE
argument_list|,
literal|"isc_buffer_remaininglength"
argument_list|)
expr_stmt|;
name|isc_buffer_putstr
argument_list|(
name|b
argument_list|,
literal|"("
comment|/*)*/
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_tsigrcode_totext
argument_list|(
name|tsig
operator|.
name|error
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_tsigrcode_totext"
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_buffer_remaininglength
argument_list|(
name|b
argument_list|)
operator|<
literal|1
condition|)
name|check_result
argument_list|(
name|ISC_R_NOSPACE
argument_list|,
literal|"isc_buffer_remaininglength"
argument_list|)
expr_stmt|;
name|isc_buffer_putstr
argument_list|(
name|b
argument_list|,
comment|/*(*/
literal|")"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|update_completed
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_requestevent_t
modifier|*
name|reqev
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_request_t
modifier|*
name|request
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"update_completed()"
argument_list|)
expr_stmt|;
name|requests
operator|--
expr_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_REQUESTDONE
argument_list|)
expr_stmt|;
name|reqev
operator|=
operator|(
name|dns_requestevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|request
operator|=
name|reqev
operator|->
name|request
expr_stmt|;
if|if
condition|(
name|shuttingdown
condition|)
block|{
name|dns_request_destroy
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|maybeshutdown
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|reqev
operator|->
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"; Communication with server failed: %s\n"
argument_list|,
name|isc_result_totext
argument_list|(
name|reqev
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|seenerror
operator|=
name|ISC_TRUE
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|result
operator|=
name|dns_message_create
argument_list|(
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTPARSE
argument_list|,
operator|&
name|answer
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_create"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_request_getresponse
argument_list|(
name|request
argument_list|,
name|answer
argument_list|,
name|DNS_MESSAGEPARSE_PRESERVEORDER
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|ISC_R_SUCCESS
case|:
if|if
condition|(
name|answer
operator|->
name|verify_attempted
condition|)
name|ddebug
argument_list|(
literal|"tsig verification successful"
argument_list|)
expr_stmt|;
break|break;
case|case
name|DNS_R_CLOCKSKEW
case|:
case|case
name|DNS_R_EXPECTEDTSIG
case|:
case|case
name|DNS_R_TSIGERRORSET
case|:
case|case
name|DNS_R_TSIGVERIFYFAILURE
case|:
case|case
name|DNS_R_UNEXPECTEDTSIG
case|:
case|case
name|ISC_R_FAILURE
case|:
if|#
directive|if
literal|0
block|if (usegsstsig&& answer->rcode == dns_rcode_noerror) {
comment|/* 			 * For MS DNS that violates RFC 2845, section 4.2 			 */
block|break; 		}
endif|#
directive|endif
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"; TSIG error with server: %s\n"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|seenerror
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
default|default:
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_request_getresponse"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|answer
operator|->
name|rcode
operator|!=
name|dns_rcode_noerror
condition|)
block|{
name|seenerror
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|debugging
condition|)
block|{
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rds
decl_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rcode_totext
argument_list|(
name|answer
operator|->
name|rcode
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rcode_totext"
argument_list|)
expr_stmt|;
name|rds
operator|=
name|dns_message_gettsig
argument_list|(
name|answer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rds
operator|!=
name|NULL
condition|)
name|check_tsig_error
argument_list|(
name|rds
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"update failed: %.*s\n"
argument_list|,
operator|(
name|int
operator|)
name|isc_buffer_usedlength
argument_list|(
operator|&
name|b
argument_list|)
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|debugging
condition|)
name|show_message
argument_list|(
name|stderr
argument_list|,
name|answer
argument_list|,
literal|"\nReply from update query:"
argument_list|)
expr_stmt|;
name|done
label|:
name|dns_request_destroy
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|usegsstsig
condition|)
block|{
name|dns_name_free
argument_list|(
operator|&
name|tmpzonename
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|dns_name_free
argument_list|(
operator|&
name|restart_master
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
block|}
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|done_update
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|send_update
parameter_list|(
name|dns_name_t
modifier|*
name|zonename
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|master
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_request_t
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|options
init|=
name|DNS_REQUESTOPT_CASE
decl_stmt|;
name|ddebug
argument_list|(
literal|"send_update()"
argument_list|)
expr_stmt|;
name|setzone
argument_list|(
name|zonename
argument_list|)
expr_stmt|;
if|if
condition|(
name|usevc
condition|)
name|options
operator||=
name|DNS_REQUESTOPT_TCP
expr_stmt|;
if|if
condition|(
name|tsigkey
operator|==
name|NULL
operator|&&
name|sig0key
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|dns_message_setsig0key
argument_list|(
name|updatemsg
argument_list|,
name|sig0key
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_setsig0key"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|debugging
condition|)
block|{
name|char
name|addrbuf
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_sockaddr_format
argument_list|(
name|master
argument_list|,
name|addrbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|addrbuf
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Sending update to %s\n"
argument_list|,
name|addrbuf
argument_list|)
expr_stmt|;
block|}
comment|/* Windows doesn't like the tsig name to be compressed. */
if|if
condition|(
name|updatemsg
operator|->
name|tsigname
condition|)
name|updatemsg
operator|->
name|tsigname
operator|->
name|attributes
operator||=
name|DNS_NAMEATTR_NOCOMPRESS
expr_stmt|;
name|result
operator|=
name|dns_request_createvia3
argument_list|(
name|requestmgr
argument_list|,
name|updatemsg
argument_list|,
name|srcaddr
argument_list|,
name|master
argument_list|,
name|options
argument_list|,
name|tsigkey
argument_list|,
name|timeout
argument_list|,
name|udp_timeout
argument_list|,
name|udp_retries
argument_list|,
name|global_task
argument_list|,
name|update_completed
argument_list|,
name|NULL
argument_list|,
operator|&
name|request
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_request_createvia3"
argument_list|)
expr_stmt|;
if|if
condition|(
name|debugging
condition|)
name|show_message
argument_list|(
name|stdout
argument_list|,
name|updatemsg
argument_list|,
literal|"Outgoing update query:"
argument_list|)
expr_stmt|;
name|requests
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|next_server
parameter_list|(
specifier|const
name|char
modifier|*
name|caller
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|,
name|isc_result_t
name|eresult
parameter_list|)
block|{
name|char
name|addrbuf
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_sockaddr_format
argument_list|(
name|addr
argument_list|,
name|addrbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|addrbuf
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"; Communication with %s failed: %s\n"
argument_list|,
name|addrbuf
argument_list|,
name|isc_result_totext
argument_list|(
name|eresult
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|ns_inuse
operator|>=
name|ns_total
condition|)
name|fatal
argument_list|(
literal|"could not reach any name server"
argument_list|)
expr_stmt|;
else|else
name|ddebug
argument_list|(
literal|"%s: trying next server"
argument_list|,
name|caller
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|recvsoa
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_requestevent_t
modifier|*
name|reqev
init|=
name|NULL
decl_stmt|;
name|dns_request_t
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|,
name|eresult
decl_stmt|;
name|dns_message_t
modifier|*
name|rcvmsg
init|=
name|NULL
decl_stmt|;
name|dns_section_t
name|section
decl_stmt|;
name|dns_name_t
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|soaset
init|=
name|NULL
decl_stmt|;
name|dns_rdata_soa_t
name|soa
decl_stmt|;
name|dns_rdata_t
name|soarr
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|int
name|pass
init|=
literal|0
decl_stmt|;
name|dns_name_t
name|master
decl_stmt|;
name|nsu_requestinfo_t
modifier|*
name|reqinfo
decl_stmt|;
name|dns_message_t
modifier|*
name|soaquery
init|=
name|NULL
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|addr
decl_stmt|;
name|isc_boolean_t
name|seencname
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_name_t
name|tname
decl_stmt|;
name|unsigned
name|int
name|nlabels
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"recvsoa()"
argument_list|)
expr_stmt|;
name|requests
operator|--
expr_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_REQUESTDONE
argument_list|)
expr_stmt|;
name|reqev
operator|=
operator|(
name|dns_requestevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|request
operator|=
name|reqev
operator|->
name|request
expr_stmt|;
name|eresult
operator|=
name|reqev
operator|->
name|result
expr_stmt|;
name|reqinfo
operator|=
name|reqev
operator|->
name|ev_arg
expr_stmt|;
name|soaquery
operator|=
name|reqinfo
operator|->
name|msg
expr_stmt|;
name|addr
operator|=
name|reqinfo
operator|->
name|addr
expr_stmt|;
if|if
condition|(
name|shuttingdown
condition|)
block|{
name|dns_request_destroy
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
name|dns_message_destroy
argument_list|(
operator|&
name|soaquery
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|reqinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|nsu_requestinfo_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|maybeshutdown
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|eresult
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|next_server
argument_list|(
literal|"recvsoa"
argument_list|,
name|addr
argument_list|,
name|eresult
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Destroying request [%p]"
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
name|dns_message_renderreset
argument_list|(
name|soaquery
argument_list|)
expr_stmt|;
name|dns_message_settsigkey
argument_list|(
name|soaquery
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sendrequest
argument_list|(
name|localaddr
argument_list|,
operator|&
name|servers
index|[
name|ns_inuse
index|]
argument_list|,
name|soaquery
argument_list|,
operator|&
name|request
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|reqinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|nsu_requestinfo_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|setzoneclass
argument_list|(
name|dns_rdataclass_none
argument_list|)
expr_stmt|;
return|return;
block|}
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|reqinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|nsu_requestinfo_t
argument_list|)
argument_list|)
expr_stmt|;
name|reqinfo
operator|=
name|NULL
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|reqev
operator|=
name|NULL
expr_stmt|;
name|ddebug
argument_list|(
literal|"About to create rcvmsg"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_create
argument_list|(
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTPARSE
argument_list|,
operator|&
name|rcvmsg
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_create"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_request_getresponse
argument_list|(
name|request
argument_list|,
name|rcvmsg
argument_list|,
name|DNS_MESSAGEPARSE_PRESERVEORDER
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_TSIGERRORSET
operator|&&
name|servers
operator|!=
name|NULL
condition|)
block|{
name|dns_message_destroy
argument_list|(
operator|&
name|rcvmsg
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Destroying request [%p]"
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
name|reqinfo
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|nsu_requestinfo_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqinfo
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|reqinfo
operator|->
name|msg
operator|=
name|soaquery
expr_stmt|;
name|reqinfo
operator|->
name|addr
operator|=
name|addr
expr_stmt|;
name|dns_message_renderreset
argument_list|(
name|soaquery
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"retrying soa request without TSIG"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_request_createvia3
argument_list|(
name|requestmgr
argument_list|,
name|soaquery
argument_list|,
name|localaddr
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|FIND_TIMEOUT
operator|*
literal|20
argument_list|,
name|FIND_TIMEOUT
argument_list|,
literal|3
argument_list|,
name|global_task
argument_list|,
name|recvsoa
argument_list|,
name|reqinfo
argument_list|,
operator|&
name|request
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_request_createvia"
argument_list|)
expr_stmt|;
name|requests
operator|++
expr_stmt|;
return|return;
block|}
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_request_getresponse"
argument_list|)
expr_stmt|;
name|section
operator|=
name|DNS_SECTION_ANSWER
expr_stmt|;
name|POST
argument_list|(
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|debugging
condition|)
name|show_message
argument_list|(
name|stderr
argument_list|,
name|rcvmsg
argument_list|,
literal|"Reply from SOA query:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rcvmsg
operator|->
name|rcode
operator|!=
name|dns_rcode_noerror
operator|&&
name|rcvmsg
operator|->
name|rcode
operator|!=
name|dns_rcode_nxdomain
condition|)
name|fatal
argument_list|(
literal|"response to SOA query was unsuccessful"
argument_list|)
expr_stmt|;
if|if
condition|(
name|userzone
operator|!=
name|NULL
operator|&&
name|rcvmsg
operator|->
name|rcode
operator|==
name|dns_rcode_nxdomain
condition|)
block|{
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|userzone
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"specified zone '%s' does not exist (NXDOMAIN)"
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
name|dns_message_destroy
argument_list|(
operator|&
name|rcvmsg
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
name|dns_message_destroy
argument_list|(
operator|&
name|soaquery
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Out of recvsoa"
argument_list|)
expr_stmt|;
name|done_update
argument_list|()
expr_stmt|;
name|seenerror
operator|=
name|ISC_TRUE
expr_stmt|;
return|return;
block|}
name|lookforsoa
label|:
if|if
condition|(
name|pass
operator|==
literal|0
condition|)
name|section
operator|=
name|DNS_SECTION_ANSWER
expr_stmt|;
elseif|else
if|if
condition|(
name|pass
operator|==
literal|1
condition|)
name|section
operator|=
name|DNS_SECTION_AUTHORITY
expr_stmt|;
else|else
goto|goto
name|droplabel
goto|;
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|rcvmsg
argument_list|,
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|pass
operator|++
expr_stmt|;
goto|goto
name|lookforsoa
goto|;
block|}
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|name
operator|=
name|NULL
expr_stmt|;
name|dns_message_currentname
argument_list|(
name|rcvmsg
argument_list|,
name|section
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|soaset
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_message_findtype
argument_list|(
name|name
argument_list|,
name|dns_rdatatype_soa
argument_list|,
literal|0
argument_list|,
operator|&
name|soaset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
break|break;
if|if
condition|(
name|section
operator|==
name|DNS_SECTION_ANSWER
condition|)
block|{
name|dns_rdataset_t
modifier|*
name|tset
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|dns_message_findtype
argument_list|(
name|name
argument_list|,
name|dns_rdatatype_cname
argument_list|,
literal|0
argument_list|,
operator|&
name|tset
argument_list|)
operator|==
name|ISC_R_SUCCESS
operator|||
name|dns_message_findtype
argument_list|(
name|name
argument_list|,
name|dns_rdatatype_dname
argument_list|,
literal|0
argument_list|,
operator|&
name|tset
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|seencname
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
block|}
block|}
name|result
operator|=
name|dns_message_nextname
argument_list|(
name|rcvmsg
argument_list|,
name|section
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|soaset
operator|==
name|NULL
operator|&&
operator|!
name|seencname
condition|)
block|{
name|pass
operator|++
expr_stmt|;
goto|goto
name|lookforsoa
goto|;
block|}
if|if
condition|(
name|seencname
condition|)
goto|goto
name|droplabel
goto|;
if|if
condition|(
name|debugging
condition|)
block|{
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Found zone name: %s\n"
argument_list|,
name|namestr
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|soaset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdataset_first"
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
operator|&
name|soarr
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|soaset
argument_list|,
operator|&
name|soarr
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|soarr
argument_list|,
operator|&
name|soa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdata_tostruct"
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|master
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
operator|&
name|soa
operator|.
name|origin
argument_list|,
operator|&
name|master
argument_list|)
expr_stmt|;
if|if
condition|(
name|userzone
operator|!=
name|NULL
condition|)
name|zonename
operator|=
name|userzone
expr_stmt|;
else|else
name|zonename
operator|=
name|name
expr_stmt|;
if|if
condition|(
name|debugging
condition|)
block|{
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
operator|&
name|master
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"The master is: %s\n"
argument_list|,
name|namestr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|servers
operator|==
name|NULL
condition|)
block|{
name|char
name|serverstr
index|[
name|DNS_NAME_MAXTEXT
operator|+
literal|1
index|]
decl_stmt|;
name|isc_buffer_t
name|buf
decl_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|buf
argument_list|,
name|serverstr
argument_list|,
sizeof|sizeof
argument_list|(
name|serverstr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_totext
argument_list|(
operator|&
name|master
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_name_totext"
argument_list|)
expr_stmt|;
name|serverstr
index|[
name|isc_buffer_usedlength
argument_list|(
operator|&
name|buf
argument_list|)
index|]
operator|=
literal|0
expr_stmt|;
name|ns_total
operator|=
name|MAX_SERVERADDRS
expr_stmt|;
name|servers
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|ns_total
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|servers
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|servers
argument_list|,
literal|0
argument_list|,
name|ns_total
operator|*
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
name|get_addresses
argument_list|(
name|serverstr
argument_list|,
name|dnsport
argument_list|,
name|servers
argument_list|,
name|ns_total
argument_list|)
expr_stmt|;
block|}
name|dns_rdata_freestruct
argument_list|(
operator|&
name|soa
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|GSSAPI
if|if
condition|(
name|usegsstsig
condition|)
block|{
name|dns_name_init
argument_list|(
operator|&
name|tmpzonename
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_dup
argument_list|(
name|zonename
argument_list|,
name|mctx
argument_list|,
operator|&
name|tmpzonename
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|restart_master
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_dup
argument_list|(
operator|&
name|master
argument_list|,
name|mctx
argument_list|,
operator|&
name|restart_master
argument_list|)
expr_stmt|;
name|start_gssrequest
argument_list|(
operator|&
name|master
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|send_update
argument_list|(
name|zonename
argument_list|,
operator|&
name|servers
index|[
name|ns_inuse
index|]
argument_list|,
name|localaddr
argument_list|)
expr_stmt|;
name|setzoneclass
argument_list|(
name|dns_rdataclass_none
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
name|send_update
argument_list|(
name|zonename
argument_list|,
operator|&
name|servers
index|[
name|ns_inuse
index|]
argument_list|,
name|localaddr
argument_list|)
expr_stmt|;
name|setzoneclass
argument_list|(
name|dns_rdataclass_none
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|dns_message_destroy
argument_list|(
operator|&
name|soaquery
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
name|out
label|:
name|dns_message_destroy
argument_list|(
operator|&
name|rcvmsg
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Out of recvsoa"
argument_list|)
expr_stmt|;
return|return;
name|droplabel
label|:
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|soaquery
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|name
operator|=
name|NULL
expr_stmt|;
name|dns_message_currentname
argument_list|(
name|soaquery
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|nlabels
operator|=
name|dns_name_countlabels
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|nlabels
operator|==
literal|1
condition|)
name|fatal
argument_list|(
literal|"could not find enclosing zone"
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|tname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|name
argument_list|,
literal|1
argument_list|,
name|nlabels
operator|-
literal|1
argument_list|,
operator|&
name|tname
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
operator|&
name|tname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
name|dns_message_renderreset
argument_list|(
name|soaquery
argument_list|)
expr_stmt|;
name|dns_message_settsigkey
argument_list|(
name|soaquery
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sendrequest
argument_list|(
name|localaddr
argument_list|,
operator|&
name|servers
index|[
name|ns_inuse
index|]
argument_list|,
name|soaquery
argument_list|,
operator|&
name|request
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
end_function

begin_function
specifier|static
name|void
name|sendrequest
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_request_t
modifier|*
modifier|*
name|request
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|nsu_requestinfo_t
modifier|*
name|reqinfo
decl_stmt|;
name|reqinfo
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|nsu_requestinfo_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqinfo
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|reqinfo
operator|->
name|msg
operator|=
name|msg
expr_stmt|;
name|reqinfo
operator|->
name|addr
operator|=
name|destaddr
expr_stmt|;
name|result
operator|=
name|dns_request_createvia3
argument_list|(
name|requestmgr
argument_list|,
name|msg
argument_list|,
name|srcaddr
argument_list|,
name|destaddr
argument_list|,
literal|0
argument_list|,
name|default_servers
condition|?
name|NULL
else|:
name|tsigkey
argument_list|,
name|FIND_TIMEOUT
operator|*
literal|20
argument_list|,
name|FIND_TIMEOUT
argument_list|,
literal|3
argument_list|,
name|global_task
argument_list|,
name|recvsoa
argument_list|,
name|reqinfo
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_request_createvia"
argument_list|)
expr_stmt|;
name|requests
operator|++
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|GSSAPI
end_ifdef

begin_comment
comment|/*  * Get the realm from the users kerberos ticket if possible  */
end_comment

begin_function
specifier|static
name|void
name|get_ticket_realm
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|)
block|{
name|krb5_context
name|ctx
decl_stmt|;
name|krb5_error_code
name|rc
decl_stmt|;
name|krb5_ccache
name|ccache
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|ticket_realm
decl_stmt|;
name|rc
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
return|return;
name|rc
operator|=
name|krb5_cc_default
argument_list|(
name|ctx
argument_list|,
operator|&
name|ccache
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|krb5_free_context
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
name|rc
operator|=
name|krb5_cc_get_principal
argument_list|(
name|ctx
argument_list|,
name|ccache
argument_list|,
operator|&
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|krb5_cc_close
argument_list|(
name|ctx
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
name|krb5_free_context
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
name|rc
operator|=
name|krb5_unparse_name
argument_list|(
name|ctx
argument_list|,
name|princ
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|krb5_free_principal
argument_list|(
name|ctx
argument_list|,
name|princ
argument_list|)
expr_stmt|;
name|krb5_cc_close
argument_list|(
name|ctx
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
name|krb5_free_context
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
name|ticket_realm
operator|=
name|strrchr
argument_list|(
name|name
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
if|if
condition|(
name|ticket_realm
operator|!=
name|NULL
condition|)
block|{
name|realm
operator|=
name|isc_mem_strdup
argument_list|(
name|mctx
argument_list|,
name|ticket_realm
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|ctx
argument_list|,
name|princ
argument_list|)
expr_stmt|;
name|krb5_cc_close
argument_list|(
name|ctx
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
name|krb5_free_context
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm
operator|!=
name|NULL
operator|&&
name|debugging
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Found realm from ticket: %s\n"
argument_list|,
name|realm
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|start_gssrequest
parameter_list|(
name|dns_name_t
modifier|*
name|master
parameter_list|)
block|{
name|gss_ctx_id_t
name|context
decl_stmt|;
name|isc_buffer_t
name|buf
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_uint32_t
name|val
init|=
literal|0
decl_stmt|;
name|dns_message_t
modifier|*
name|rmsg
decl_stmt|;
name|dns_request_t
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|dns_name_t
modifier|*
name|servname
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
name|keystr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
modifier|*
name|err_message
init|=
name|NULL
decl_stmt|;
name|debug
argument_list|(
literal|"start_gssrequest"
argument_list|)
expr_stmt|;
name|usevc
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
name|gssring
operator|!=
name|NULL
condition|)
name|dns_tsigkeyring_detach
argument_list|(
operator|&
name|gssring
argument_list|)
expr_stmt|;
name|gssring
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_tsigkeyring_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|gssring
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"dns_tsigkeyring_create failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_name_format
argument_list|(
name|master
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kserver
operator|==
name|NULL
condition|)
block|{
name|kserver
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kserver
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|servers
operator|==
name|NULL
condition|)
name|get_addresses
argument_list|(
name|namestr
argument_list|,
name|dnsport
argument_list|,
name|kserver
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|memmove
argument_list|(
name|kserver
argument_list|,
operator|&
name|servers
index|[
name|ns_inuse
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|servname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm
operator|==
name|NULL
condition|)
name|get_ticket_realm
argument_list|(
name|mctx
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_string_printf
argument_list|(
name|servicename
argument_list|,
sizeof|sizeof
argument_list|(
name|servicename
argument_list|)
argument_list|,
literal|"DNS/%s%s"
argument_list|,
name|namestr
argument_list|,
name|realm
condition|?
name|realm
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"isc_string_printf(servicename) failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|buf
argument_list|,
name|servicename
argument_list|,
name|strlen
argument_list|(
name|servicename
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|buf
argument_list|,
name|strlen
argument_list|(
name|servicename
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|servname
argument_list|,
operator|&
name|buf
argument_list|,
name|dns_rootname
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"dns_name_fromtext(servname) failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fkname
argument_list|)
expr_stmt|;
name|keyname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fkname
argument_list|)
expr_stmt|;
name|isc_random_get
argument_list|(
operator|&
name|val
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_string_printf
argument_list|(
name|keystr
argument_list|,
sizeof|sizeof
argument_list|(
name|keystr
argument_list|)
argument_list|,
literal|"%u.sig-%s"
argument_list|,
name|val
argument_list|,
name|namestr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"isc_string_printf(keystr) failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|buf
argument_list|,
name|keystr
argument_list|,
name|strlen
argument_list|(
name|keystr
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|buf
argument_list|,
name|strlen
argument_list|(
name|keystr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|keyname
argument_list|,
operator|&
name|buf
argument_list|,
name|dns_rootname
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"dns_name_fromtext(keyname) failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Windows doesn't recognize name compression in the key name. */
name|keyname
operator|->
name|attributes
operator||=
name|DNS_NAMEATTR_NOCOMPRESS
expr_stmt|;
name|rmsg
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_message_create
argument_list|(
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTRENDER
argument_list|,
operator|&
name|rmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"dns_message_create failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Build first request. */
name|context
operator|=
name|GSS_C_NO_CONTEXT
expr_stmt|;
name|result
operator|=
name|dns_tkey_buildgssquery
argument_list|(
name|rmsg
argument_list|,
name|keyname
argument_list|,
name|servname
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|context
argument_list|,
name|use_win2k_gsstsig
argument_list|,
name|mctx
argument_list|,
operator|&
name|err_message
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_FAILURE
condition|)
name|fatal
argument_list|(
literal|"tkey query failed: %s"
argument_list|,
name|err_message
operator|!=
name|NULL
condition|?
name|err_message
else|:
literal|"unknown error"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"dns_tkey_buildgssquery failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|send_gssrequest
argument_list|(
name|localaddr
argument_list|,
name|kserver
argument_list|,
name|rmsg
argument_list|,
operator|&
name|request
argument_list|,
name|context
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|send_gssrequest
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_request_t
modifier|*
modifier|*
name|request
parameter_list|,
name|gss_ctx_id_t
name|context
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|nsu_gssinfo_t
modifier|*
name|reqinfo
decl_stmt|;
name|unsigned
name|int
name|options
init|=
literal|0
decl_stmt|;
name|debug
argument_list|(
literal|"send_gssrequest"
argument_list|)
expr_stmt|;
name|reqinfo
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|nsu_gssinfo_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqinfo
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|reqinfo
operator|->
name|msg
operator|=
name|msg
expr_stmt|;
name|reqinfo
operator|->
name|addr
operator|=
name|destaddr
expr_stmt|;
name|reqinfo
operator|->
name|context
operator|=
name|context
expr_stmt|;
name|options
operator||=
name|DNS_REQUESTOPT_TCP
expr_stmt|;
name|result
operator|=
name|dns_request_createvia3
argument_list|(
name|requestmgr
argument_list|,
name|msg
argument_list|,
name|srcaddr
argument_list|,
name|destaddr
argument_list|,
name|options
argument_list|,
name|tsigkey
argument_list|,
name|FIND_TIMEOUT
operator|*
literal|20
argument_list|,
name|FIND_TIMEOUT
argument_list|,
literal|3
argument_list|,
name|global_task
argument_list|,
name|recvgss
argument_list|,
name|reqinfo
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_request_createvia3"
argument_list|)
expr_stmt|;
if|if
condition|(
name|debugging
condition|)
name|show_message
argument_list|(
name|stdout
argument_list|,
name|msg
argument_list|,
literal|"Outgoing update query:"
argument_list|)
expr_stmt|;
name|requests
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|recvgss
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_requestevent_t
modifier|*
name|reqev
init|=
name|NULL
decl_stmt|;
name|dns_request_t
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|,
name|eresult
decl_stmt|;
name|dns_message_t
modifier|*
name|rcvmsg
init|=
name|NULL
decl_stmt|;
name|nsu_gssinfo_t
modifier|*
name|reqinfo
decl_stmt|;
name|dns_message_t
modifier|*
name|tsigquery
init|=
name|NULL
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|addr
decl_stmt|;
name|gss_ctx_id_t
name|context
decl_stmt|;
name|isc_buffer_t
name|buf
decl_stmt|;
name|dns_name_t
modifier|*
name|servname
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|char
modifier|*
name|err_message
init|=
name|NULL
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"recvgss()"
argument_list|)
expr_stmt|;
name|requests
operator|--
expr_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_REQUESTDONE
argument_list|)
expr_stmt|;
name|reqev
operator|=
operator|(
name|dns_requestevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|request
operator|=
name|reqev
operator|->
name|request
expr_stmt|;
name|eresult
operator|=
name|reqev
operator|->
name|result
expr_stmt|;
name|reqinfo
operator|=
name|reqev
operator|->
name|ev_arg
expr_stmt|;
name|tsigquery
operator|=
name|reqinfo
operator|->
name|msg
expr_stmt|;
name|context
operator|=
name|reqinfo
operator|->
name|context
expr_stmt|;
name|addr
operator|=
name|reqinfo
operator|->
name|addr
expr_stmt|;
if|if
condition|(
name|shuttingdown
condition|)
block|{
name|dns_request_destroy
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
name|dns_message_destroy
argument_list|(
operator|&
name|tsigquery
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|reqinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|nsu_gssinfo_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|maybeshutdown
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|eresult
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|next_server
argument_list|(
literal|"recvgss"
argument_list|,
name|addr
argument_list|,
name|eresult
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Destroying request [%p]"
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
name|dns_message_renderreset
argument_list|(
name|tsigquery
argument_list|)
expr_stmt|;
name|sendrequest
argument_list|(
name|localaddr
argument_list|,
operator|&
name|servers
index|[
name|ns_inuse
index|]
argument_list|,
name|tsigquery
argument_list|,
operator|&
name|request
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|reqinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|nsu_gssinfo_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
return|return;
block|}
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|reqinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|nsu_gssinfo_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|reqev
operator|=
name|NULL
expr_stmt|;
name|ddebug
argument_list|(
literal|"recvgss creating rcvmsg"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_create
argument_list|(
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTPARSE
argument_list|,
operator|&
name|rcvmsg
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_create"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_request_getresponse
argument_list|(
name|request
argument_list|,
name|rcvmsg
argument_list|,
name|DNS_MESSAGEPARSE_PRESERVEORDER
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_request_getresponse"
argument_list|)
expr_stmt|;
if|if
condition|(
name|debugging
condition|)
name|show_message
argument_list|(
name|stderr
argument_list|,
name|rcvmsg
argument_list|,
literal|"recvmsg reply from GSS-TSIG query"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rcvmsg
operator|->
name|rcode
operator|==
name|dns_rcode_formerr
operator|&&
operator|!
name|tried_other_gsstsig
condition|)
block|{
name|ddebug
argument_list|(
literal|"recvgss trying %s GSS-TSIG"
argument_list|,
name|use_win2k_gsstsig
condition|?
literal|"Standard"
else|:
literal|"Win2k"
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_win2k_gsstsig
condition|)
name|use_win2k_gsstsig
operator|=
name|ISC_FALSE
expr_stmt|;
else|else
name|use_win2k_gsstsig
operator|=
name|ISC_TRUE
expr_stmt|;
name|tried_other_gsstsig
operator|=
name|ISC_TRUE
expr_stmt|;
name|start_gssrequest
argument_list|(
operator|&
name|restart_master
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|rcvmsg
operator|->
name|rcode
operator|!=
name|dns_rcode_noerror
operator|&&
name|rcvmsg
operator|->
name|rcode
operator|!=
name|dns_rcode_nxdomain
condition|)
name|fatal
argument_list|(
literal|"response to GSS-TSIG query was unsuccessful"
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|servname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|buf
argument_list|,
name|servicename
argument_list|,
name|strlen
argument_list|(
name|servicename
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|buf
argument_list|,
name|strlen
argument_list|(
name|servicename
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|servname
argument_list|,
operator|&
name|buf
argument_list|,
name|dns_rootname
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_name_fromtext"
argument_list|)
expr_stmt|;
name|tsigkey
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_tkey_gssnegotiate
argument_list|(
name|tsigquery
argument_list|,
name|rcvmsg
argument_list|,
name|servname
argument_list|,
operator|&
name|context
argument_list|,
operator|&
name|tsigkey
argument_list|,
name|gssring
argument_list|,
name|use_win2k_gsstsig
argument_list|,
operator|&
name|err_message
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|DNS_R_CONTINUE
case|:
name|send_gssrequest
argument_list|(
name|localaddr
argument_list|,
name|kserver
argument_list|,
name|tsigquery
argument_list|,
operator|&
name|request
argument_list|,
name|context
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISC_R_SUCCESS
case|:
comment|/* 		 * XXXSRA Waaay too much fun here.  There's no good 		 * reason why we need a TSIG here (the people who put 		 * it into the spec admitted at the time that it was 		 * not a security issue), and Windows clients don't 		 * seem to work if named complies with the spec and 		 * includes the gratuitous TSIG.  So we're in the 		 * bizarre situation of having to choose between 		 * complying with a useless requirement in the spec 		 * and interoperating.  This is nuts.  If we can 		 * confirm this behavior, we should ask the WG to 		 * consider removing the requirement for the 		 * gratuitous TSIG here.  For the moment, we ignore 		 * the TSIG -- this too is a spec violation, but it's 		 * the least insane thing to do. 		 */
if|#
directive|if
literal|0
comment|/* 		 * Verify the signature. 		 */
block|rcvmsg->state = DNS_SECTION_ANY; 		dns_message_setquerytsig(rcvmsg, NULL); 		result = dns_message_settsigkey(rcvmsg, tsigkey); 		check_result(result, "dns_message_settsigkey"); 		result = dns_message_checksig(rcvmsg, NULL); 		ddebug("tsig verification: %s", dns_result_totext(result)); 		check_result(result, "dns_message_checksig");
endif|#
directive|endif
comment|/* 0 */
name|send_update
argument_list|(
operator|&
name|tmpzonename
argument_list|,
operator|&
name|servers
index|[
name|ns_inuse
index|]
argument_list|,
name|localaddr
argument_list|)
expr_stmt|;
name|setzoneclass
argument_list|(
name|dns_rdataclass_none
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fatal
argument_list|(
literal|"dns_tkey_negotiategss: %s %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|,
name|err_message
operator|!=
name|NULL
condition|?
name|err_message
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|done
label|:
name|dns_request_destroy
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
name|dns_message_destroy
argument_list|(
operator|&
name|tsigquery
argument_list|)
expr_stmt|;
name|dns_message_destroy
argument_list|(
operator|&
name|rcvmsg
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Out of recvgss"
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|start_update
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
init|=
name|NULL
decl_stmt|;
name|dns_name_t
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|dns_request_t
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|dns_message_t
modifier|*
name|soaquery
init|=
name|NULL
decl_stmt|;
name|dns_name_t
modifier|*
name|firstname
decl_stmt|;
name|dns_section_t
name|section
init|=
name|DNS_SECTION_UPDATE
decl_stmt|;
name|ddebug
argument_list|(
literal|"start_update()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|answer
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|answer
argument_list|)
expr_stmt|;
if|if
condition|(
name|userzone
operator|!=
name|NULL
operator|&&
operator|!
name|usegsstsig
condition|)
block|{
name|send_update
argument_list|(
name|userzone
argument_list|,
operator|&
name|servers
index|[
name|ns_inuse
index|]
argument_list|,
name|localaddr
argument_list|)
expr_stmt|;
name|setzoneclass
argument_list|(
name|dns_rdataclass_none
argument_list|)
expr_stmt|;
return|return;
block|}
name|result
operator|=
name|dns_message_create
argument_list|(
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTRENDER
argument_list|,
operator|&
name|soaquery
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_create"
argument_list|)
expr_stmt|;
if|if
condition|(
name|default_servers
condition|)
name|soaquery
operator|->
name|flags
operator||=
name|DNS_MESSAGEFLAG_RD
expr_stmt|;
name|result
operator|=
name|dns_message_gettempname
argument_list|(
name|soaquery
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_gettempname"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_gettemprdataset
argument_list|(
name|soaquery
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_message_gettemprdataset"
argument_list|)
expr_stmt|;
name|dns_rdataset_makequestion
argument_list|(
name|rdataset
argument_list|,
name|getzoneclass
argument_list|()
argument_list|,
name|dns_rdatatype_soa
argument_list|)
expr_stmt|;
if|if
condition|(
name|userzone
operator|!=
name|NULL
condition|)
block|{
name|dns_name_init
argument_list|(
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
name|userzone
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dns_rdataset_t
modifier|*
name|tmprdataset
decl_stmt|;
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|updatemsg
argument_list|,
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
block|{
name|section
operator|=
name|DNS_SECTION_PREREQUISITE
expr_stmt|;
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|updatemsg
argument_list|,
name|section
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_message_puttempname
argument_list|(
name|soaquery
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|dns_message_puttemprdataset
argument_list|(
name|soaquery
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_message_destroy
argument_list|(
operator|&
name|soaquery
argument_list|)
expr_stmt|;
name|done_update
argument_list|()
expr_stmt|;
return|return;
block|}
name|firstname
operator|=
name|NULL
expr_stmt|;
name|dns_message_currentname
argument_list|(
name|updatemsg
argument_list|,
name|section
argument_list|,
operator|&
name|firstname
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
name|firstname
argument_list|,
name|name
argument_list|)
expr_stmt|;
comment|/* 		 * Looks to see if the first name references a DS record 		 * and if that name is not the root remove a label as DS 		 * records live in the parent zone so we need to start our 		 * search one label up. 		 */
name|tmprdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|firstname
operator|->
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|section
operator|==
name|DNS_SECTION_UPDATE
operator|&&
operator|!
name|dns_name_equal
argument_list|(
name|firstname
argument_list|,
name|dns_rootname
argument_list|)
operator|&&
name|tmprdataset
operator|->
name|type
operator|==
name|dns_rdatatype_ds
condition|)
block|{
name|unsigned
name|int
name|labels
init|=
name|dns_name_countlabels
argument_list|(
name|name
argument_list|)
decl_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|name
argument_list|,
literal|1
argument_list|,
name|labels
operator|-
literal|1
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
block|}
name|ISC_LIST_INIT
argument_list|(
name|name
operator|->
name|list
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_message_addname
argument_list|(
name|soaquery
argument_list|,
name|name
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|)
expr_stmt|;
name|ns_inuse
operator|=
literal|0
expr_stmt|;
name|sendrequest
argument_list|(
name|localaddr
argument_list|,
operator|&
name|servers
index|[
name|ns_inuse
index|]
argument_list|,
name|soaquery
argument_list|,
operator|&
name|request
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|ddebug
argument_list|(
literal|"cleanup()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|answer
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|answer
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|GSSAPI
if|if
condition|(
name|tsigkey
operator|!=
name|NULL
condition|)
block|{
name|ddebug
argument_list|(
literal|"detach tsigkey x%p"
argument_list|,
name|tsigkey
argument_list|)
expr_stmt|;
name|dns_tsigkey_detach
argument_list|(
operator|&
name|tsigkey
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|gssring
operator|!=
name|NULL
condition|)
block|{
name|ddebug
argument_list|(
literal|"Detaching GSS-TSIG keyring"
argument_list|)
expr_stmt|;
name|dns_tsigkeyring_detach
argument_list|(
operator|&
name|gssring
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|kserver
operator|!=
name|NULL
condition|)
block|{
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|kserver
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
name|kserver
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|realm
operator|!=
name|NULL
condition|)
block|{
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|realm
argument_list|)
expr_stmt|;
name|realm
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|sig0key
operator|!=
name|NULL
condition|)
name|dst_key_free
argument_list|(
operator|&
name|sig0key
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Shutting down task manager"
argument_list|)
expr_stmt|;
name|isc_taskmgr_destroy
argument_list|(
operator|&
name|taskmgr
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Destroying event"
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|global_event
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Shutting down socket manager"
argument_list|)
expr_stmt|;
name|isc_socketmgr_destroy
argument_list|(
operator|&
name|socketmgr
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Shutting down timer manager"
argument_list|)
expr_stmt|;
name|isc_timermgr_destroy
argument_list|(
operator|&
name|timermgr
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Destroying hash context"
argument_list|)
expr_stmt|;
name|isc_hash_destroy
argument_list|()
expr_stmt|;
name|ddebug
argument_list|(
literal|"Destroying name state"
argument_list|)
expr_stmt|;
name|dns_name_destroy
argument_list|()
expr_stmt|;
name|ddebug
argument_list|(
literal|"Removing log context"
argument_list|)
expr_stmt|;
name|isc_log_destroy
argument_list|(
operator|&
name|lctx
argument_list|)
expr_stmt|;
name|ddebug
argument_list|(
literal|"Destroying memory context"
argument_list|)
expr_stmt|;
if|if
condition|(
name|memdebugging
condition|)
name|isc_mem_stats
argument_list|(
name|mctx
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|isc_mem_destroy
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|getinput
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_boolean_t
name|more
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|shuttingdown
condition|)
block|{
name|maybeshutdown
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|global_event
operator|==
name|NULL
condition|)
name|global_event
operator|=
name|event
expr_stmt|;
name|reset_system
argument_list|()
expr_stmt|;
name|more
operator|=
name|user_interaction
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|more
condition|)
block|{
name|isc_app_shutdown
argument_list|()
expr_stmt|;
return|return;
block|}
name|start_update
argument_list|()
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|style
operator|=
operator|&
name|dns_master_style_debug
expr_stmt|;
name|input
operator|=
name|stdin
expr_stmt|;
name|interactive
operator|=
name|ISC_TF
argument_list|(
name|isatty
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|isc_app_start
argument_list|()
expr_stmt|;
name|pre_parse_args
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_mem_create
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|mctx
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_mem_create"
argument_list|)
expr_stmt|;
name|parse_args
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|mctx
argument_list|,
operator|&
name|entropy
argument_list|)
expr_stmt|;
name|setup_system
argument_list|()
expr_stmt|;
name|result
operator|=
name|isc_app_onrun
argument_list|(
name|mctx
argument_list|,
name|global_task
argument_list|,
name|getinput
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_app_onrun"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|isc_app_run
argument_list|()
expr_stmt|;
name|cleanup
argument_list|()
expr_stmt|;
name|isc_app_finish
argument_list|()
expr_stmt|;
if|if
condition|(
name|seenerror
condition|)
return|return
operator|(
literal|2
operator|)
return|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2008  Internet Systems Consortium, Inc. ("ISC")  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: portset.c,v 1.4.2.1 2008/06/25 00:03:29 jinmei Exp $ */
end_comment

begin_comment
comment|/*! \file */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/portset.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/types.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_define
define|#
directive|define
name|ISC_PORTSET_BUFSIZE
value|(65536 / (sizeof(isc_uint32_t) * 8))
end_define

begin_comment
comment|/*%  * Internal representation of portset.  It's an array of 32-bit integers, each  * bit corresponding to a single port in the ascending order.  For example,  * the second most significant bit of buf[0] corresponds to port 1.  */
end_comment

begin_struct
struct|struct
name|isc_portset
block|{
name|unsigned
name|int
name|nports
decl_stmt|;
comment|/*%< number of ports in the set */
name|isc_uint32_t
name|buf
index|[
name|ISC_PORTSET_BUFSIZE
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|portset_isset
parameter_list|(
name|isc_portset_t
modifier|*
name|portset
parameter_list|,
name|in_port_t
name|port
parameter_list|)
block|{
return|return
operator|(
name|ISC_TF
argument_list|(
operator|(
name|portset
operator|->
name|buf
index|[
name|port
operator|>>
literal|5
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|port
operator|&
literal|31
operator|)
operator|)
operator|)
operator|!=
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|portset_add
parameter_list|(
name|isc_portset_t
modifier|*
name|portset
parameter_list|,
name|in_port_t
name|port
parameter_list|)
block|{
if|if
condition|(
operator|!
name|portset_isset
argument_list|(
name|portset
argument_list|,
name|port
argument_list|)
condition|)
block|{
name|portset
operator|->
name|nports
operator|++
expr_stmt|;
name|portset
operator|->
name|buf
index|[
name|port
operator|>>
literal|5
index|]
operator||=
operator|(
literal|1
operator|<<
operator|(
name|port
operator|&
literal|31
operator|)
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|portset_remove
parameter_list|(
name|isc_portset_t
modifier|*
name|portset
parameter_list|,
name|in_port_t
name|port
parameter_list|)
block|{
if|if
condition|(
name|portset_isset
argument_list|(
name|portset
argument_list|,
name|port
argument_list|)
condition|)
block|{
name|portset
operator|->
name|nports
operator|--
expr_stmt|;
name|portset
operator|->
name|buf
index|[
name|port
operator|>>
literal|5
index|]
operator|&=
operator|~
operator|(
literal|1
operator|<<
operator|(
name|port
operator|&
literal|31
operator|)
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|isc_result_t
name|isc_portset_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_portset_t
modifier|*
modifier|*
name|portsetp
parameter_list|)
block|{
name|isc_portset_t
modifier|*
name|portset
decl_stmt|;
name|REQUIRE
argument_list|(
name|portsetp
operator|!=
name|NULL
operator|&&
operator|*
name|portsetp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|portset
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|portset
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|portset
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
comment|/* Make the set 'empty' by default */
name|memset
argument_list|(
name|portset
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|portset
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|portsetp
operator|=
name|portset
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|isc_portset_destroy
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_portset_t
modifier|*
modifier|*
name|portsetp
parameter_list|)
block|{
name|isc_portset_t
modifier|*
name|portset
decl_stmt|;
name|REQUIRE
argument_list|(
name|portsetp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|portset
operator|=
operator|*
name|portsetp
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|portset
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|portset
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_boolean_t
name|isc_portset_isset
parameter_list|(
name|isc_portset_t
modifier|*
name|portset
parameter_list|,
name|in_port_t
name|port
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|portset
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|portset_isset
argument_list|(
name|portset
argument_list|,
name|port
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|isc_portset_nports
parameter_list|(
name|isc_portset_t
modifier|*
name|portset
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|portset
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|portset
operator|->
name|nports
operator|)
return|;
block|}
end_function

begin_function
name|void
name|isc_portset_add
parameter_list|(
name|isc_portset_t
modifier|*
name|portset
parameter_list|,
name|in_port_t
name|port
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|portset
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|portset_add
argument_list|(
name|portset
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|isc_portset_remove
parameter_list|(
name|isc_portset_t
modifier|*
name|portset
parameter_list|,
name|in_port_t
name|port
parameter_list|)
block|{
name|portset_remove
argument_list|(
name|portset
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|isc_portset_addrange
parameter_list|(
name|isc_portset_t
modifier|*
name|portset
parameter_list|,
name|in_port_t
name|port_lo
parameter_list|,
name|in_port_t
name|port_hi
parameter_list|)
block|{
name|in_port_t
name|p
decl_stmt|;
name|REQUIRE
argument_list|(
name|portset
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|port_lo
operator|<=
name|port_hi
argument_list|)
expr_stmt|;
name|p
operator|=
name|port_lo
expr_stmt|;
do|do
block|{
name|portset_add
argument_list|(
name|portset
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|p
operator|++
operator|<
name|port_hi
condition|)
do|;
block|}
end_function

begin_function
name|void
name|isc_portset_removerange
parameter_list|(
name|isc_portset_t
modifier|*
name|portset
parameter_list|,
name|in_port_t
name|port_lo
parameter_list|,
name|in_port_t
name|port_hi
parameter_list|)
block|{
name|in_port_t
name|p
decl_stmt|;
name|REQUIRE
argument_list|(
name|portset
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|port_lo
operator|<=
name|port_hi
argument_list|)
expr_stmt|;
name|p
operator|=
name|port_lo
expr_stmt|;
do|do
block|{
name|portset_remove
argument_list|(
name|portset
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|p
operator|++
operator|<
name|port_hi
condition|)
do|;
block|}
end_function

end_unit


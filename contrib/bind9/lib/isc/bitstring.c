begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2001  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: bitstring.c,v 1.12.206.1 2004/03/06 08:14:27 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<isc/magic.h>
end_include

begin_include
include|#
directive|include
file|<isc/bitstring.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_define
define|#
directive|define
name|DIV8
parameter_list|(
name|x
parameter_list|)
value|((x)>> 3)
end_define

begin_define
define|#
directive|define
name|MOD8
parameter_list|(
name|x
parameter_list|)
value|((x)& 0x00000007U)
end_define

begin_define
define|#
directive|define
name|OCTETS
parameter_list|(
name|n
parameter_list|)
value|(((n) + 7)>> 3)
end_define

begin_define
define|#
directive|define
name|PADDED
parameter_list|(
name|n
parameter_list|)
value|((((n) + 7)>> 3)<< 3)
end_define

begin_define
define|#
directive|define
name|BITSET
parameter_list|(
name|bs
parameter_list|,
name|n
parameter_list|)
value|(((bs)->data[DIV8(n)]& \ 				 (1<< (7 - MOD8(n)))) != 0)
end_define

begin_define
define|#
directive|define
name|SETBIT
parameter_list|(
name|bs
parameter_list|,
name|n
parameter_list|)
value|(bs)->data[DIV8(n)] |= (1<< (7 - MOD8(n)))
end_define

begin_define
define|#
directive|define
name|CLEARBIT
parameter_list|(
name|bs
parameter_list|,
name|n
parameter_list|)
value|(bs)->data[DIV8(n)]&= ~(1<< (7 - MOD8(n)))
end_define

begin_define
define|#
directive|define
name|BITSTRING_MAGIC
value|ISC_MAGIC('B', 'S', 't', 'r')
end_define

begin_define
define|#
directive|define
name|VALID_BITSTRING
parameter_list|(
name|b
parameter_list|)
value|ISC_MAGIC_VALID(b, BITSTRING_MAGIC)
end_define

begin_function
name|void
name|isc_bitstring_init
parameter_list|(
name|isc_bitstring_t
modifier|*
name|bitstring
parameter_list|,
name|unsigned
name|char
modifier|*
name|data
parameter_list|,
name|unsigned
name|int
name|length
parameter_list|,
name|unsigned
name|int
name|size
parameter_list|,
name|isc_boolean_t
name|lsb0
parameter_list|)
block|{
comment|/* 	 * Make 'bitstring' refer to the bitstring of 'size' bits starting 	 * at 'data'.  'length' bits of the bitstring are valid.  If 'lsb0' 	 * is set then, bit 0 refers to the least significant bit of the 	 * bitstring.  Otherwise bit 0 is the most significant bit. 	 */
name|REQUIRE
argument_list|(
name|bitstring
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|length
operator|<=
name|size
argument_list|)
expr_stmt|;
name|bitstring
operator|->
name|magic
operator|=
name|BITSTRING_MAGIC
expr_stmt|;
name|bitstring
operator|->
name|data
operator|=
name|data
expr_stmt|;
name|bitstring
operator|->
name|length
operator|=
name|length
expr_stmt|;
name|bitstring
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|bitstring
operator|->
name|lsb0
operator|=
name|lsb0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|isc_bitstring_invalidate
parameter_list|(
name|isc_bitstring_t
modifier|*
name|bitstring
parameter_list|)
block|{
comment|/* 	 * Invalidate 'bitstring'. 	 */
name|REQUIRE
argument_list|(
name|VALID_BITSTRING
argument_list|(
name|bitstring
argument_list|)
argument_list|)
expr_stmt|;
name|bitstring
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|bitstring
operator|->
name|data
operator|=
name|NULL
expr_stmt|;
name|bitstring
operator|->
name|length
operator|=
literal|0
expr_stmt|;
name|bitstring
operator|->
name|size
operator|=
literal|0
expr_stmt|;
name|bitstring
operator|->
name|lsb0
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
end_function

begin_function
name|void
name|isc_bitstring_copy
parameter_list|(
name|isc_bitstring_t
modifier|*
name|source
parameter_list|,
name|unsigned
name|int
name|sbitpos
parameter_list|,
name|isc_bitstring_t
modifier|*
name|target
parameter_list|,
name|unsigned
name|int
name|tbitpos
parameter_list|,
name|unsigned
name|int
name|n
parameter_list|)
block|{
name|unsigned
name|int
name|tlast
decl_stmt|;
comment|/* 	 * Starting at bit 'sbitpos', copy 'n' bits from 'source' to 	 * the 'n' bits of 'target' starting at 'tbitpos'. 	 */
name|REQUIRE
argument_list|(
name|VALID_BITSTRING
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_BITSTRING
argument_list|(
name|target
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|source
operator|->
name|lsb0
operator|==
name|target
operator|->
name|lsb0
argument_list|)
expr_stmt|;
if|if
condition|(
name|source
operator|->
name|lsb0
condition|)
block|{
name|REQUIRE
argument_list|(
name|sbitpos
operator|<=
name|source
operator|->
name|length
argument_list|)
expr_stmt|;
name|sbitpos
operator|=
name|PADDED
argument_list|(
name|source
operator|->
name|size
argument_list|)
operator|-
name|sbitpos
expr_stmt|;
name|REQUIRE
argument_list|(
name|sbitpos
operator|>=
name|n
argument_list|)
expr_stmt|;
name|sbitpos
operator|-=
name|n
expr_stmt|;
block|}
else|else
name|REQUIRE
argument_list|(
name|sbitpos
operator|+
name|n
operator|<=
name|source
operator|->
name|length
argument_list|)
expr_stmt|;
name|tlast
operator|=
name|tbitpos
operator|+
name|n
expr_stmt|;
if|if
condition|(
name|target
operator|->
name|lsb0
condition|)
block|{
name|REQUIRE
argument_list|(
name|tbitpos
operator|<=
name|target
operator|->
name|length
argument_list|)
expr_stmt|;
name|tbitpos
operator|=
name|PADDED
argument_list|(
name|target
operator|->
name|size
argument_list|)
operator|-
name|tbitpos
expr_stmt|;
name|REQUIRE
argument_list|(
name|tbitpos
operator|>=
name|n
argument_list|)
expr_stmt|;
name|tbitpos
operator|-=
name|n
expr_stmt|;
block|}
else|else
name|REQUIRE
argument_list|(
name|tlast
operator|<=
name|target
operator|->
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlast
operator|>
name|target
operator|->
name|length
condition|)
name|target
operator|->
name|length
operator|=
name|tlast
expr_stmt|;
comment|/* 	 * This is far from optimal... 	 */
while|while
condition|(
name|n
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|BITSET
argument_list|(
name|source
argument_list|,
name|sbitpos
argument_list|)
condition|)
name|SETBIT
argument_list|(
name|target
argument_list|,
name|tbitpos
argument_list|)
expr_stmt|;
else|else
name|CLEARBIT
argument_list|(
name|target
argument_list|,
name|tbitpos
argument_list|)
expr_stmt|;
name|sbitpos
operator|++
expr_stmt|;
name|tbitpos
operator|++
expr_stmt|;
name|n
operator|--
expr_stmt|;
block|}
block|}
end_function

end_unit


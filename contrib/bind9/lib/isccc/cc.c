begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Portions Copyright (C) 2004-2007  Internet Systems Consortium, Inc. ("ISC")  * Portions Copyright (C) 2001-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC AND NOMINUM DISCLAIMS ALL  * WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY  * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * Portions Copyright (C) 2001  Nominum, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC AND NOMINUM DISCLAIMS ALL  * WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY  * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: cc.c,v 1.18 2007-08-28 07:20:43 tbox Exp $ */
end_comment

begin_comment
comment|/*! \file */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<isc/assertions.h>
end_include

begin_include
include|#
directive|include
file|<isc/hmacmd5.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/stdlib.h>
end_include

begin_include
include|#
directive|include
file|<isccc/alist.h>
end_include

begin_include
include|#
directive|include
file|<isccc/base64.h>
end_include

begin_include
include|#
directive|include
file|<isccc/cc.h>
end_include

begin_include
include|#
directive|include
file|<isccc/result.h>
end_include

begin_include
include|#
directive|include
file|<isccc/sexpr.h>
end_include

begin_include
include|#
directive|include
file|<isccc/symtab.h>
end_include

begin_include
include|#
directive|include
file|<isccc/symtype.h>
end_include

begin_include
include|#
directive|include
file|<isccc/util.h>
end_include

begin_define
define|#
directive|define
name|MAX_TAGS
value|256
end_define

begin_define
define|#
directive|define
name|DUP_LIFETIME
value|900
end_define

begin_typedef
typedef|typedef
name|isccc_sexpr_t
modifier|*
name|sexpr_ptr
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|auth_hmd5
index|[]
init|=
block|{
literal|0x05
block|,
literal|0x5f
block|,
literal|0x61
block|,
literal|0x75
block|,
literal|0x74
block|,
literal|0x68
block|,
comment|/*%< len + _auth */
name|ISCCC_CCMSGTYPE_TABLE
block|,
comment|/*%< message type */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x20
block|,
comment|/*%< length == 32 */
literal|0x04
block|,
literal|0x68
block|,
literal|0x6d
block|,
literal|0x64
block|,
literal|0x35
block|,
comment|/*%< len + hmd5 */
name|ISCCC_CCMSGTYPE_BINARYDATA
block|,
comment|/*%< message type */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x16
block|,
comment|/*%< length == 22 */
comment|/* 	 * The base64 encoding of one of our HMAC-MD5 signatures is 	 * 22 bytes. 	 */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|HMD5_OFFSET
value|21
end_define

begin_comment
comment|/*%< 21 = 6 + 1 + 4 + 5 + 1 + 4 */
end_comment

begin_define
define|#
directive|define
name|HMD5_LENGTH
value|22
end_define

begin_function_decl
specifier|static
name|isc_result_t
name|table_towire
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
name|isccc_region_t
modifier|*
name|target
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|list_towire
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
name|isccc_region_t
modifier|*
name|target
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|isc_result_t
name|value_towire
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|elt
parameter_list|,
name|isccc_region_t
modifier|*
name|target
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|unsigned
name|char
modifier|*
name|lenp
decl_stmt|;
name|isccc_region_t
modifier|*
name|vr
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|isccc_sexpr_binaryp
argument_list|(
name|elt
argument_list|)
condition|)
block|{
name|vr
operator|=
name|isccc_sexpr_tobinary
argument_list|(
name|elt
argument_list|)
expr_stmt|;
name|len
operator|=
name|REGION_SIZE
argument_list|(
operator|*
name|vr
argument_list|)
expr_stmt|;
if|if
condition|(
name|REGION_SIZE
argument_list|(
operator|*
name|target
argument_list|)
operator|<
literal|1
operator|+
literal|4
operator|+
name|len
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
name|PUT8
argument_list|(
name|ISCCC_CCMSGTYPE_BINARYDATA
argument_list|,
name|target
operator|->
name|rstart
argument_list|)
expr_stmt|;
name|PUT32
argument_list|(
name|len
argument_list|,
name|target
operator|->
name|rstart
argument_list|)
expr_stmt|;
if|if
condition|(
name|REGION_SIZE
argument_list|(
operator|*
name|target
argument_list|)
operator|<
name|len
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
name|PUT_MEM
argument_list|(
name|vr
operator|->
name|rstart
argument_list|,
name|len
argument_list|,
name|target
operator|->
name|rstart
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isccc_alist_alistp
argument_list|(
name|elt
argument_list|)
condition|)
block|{
if|if
condition|(
name|REGION_SIZE
argument_list|(
operator|*
name|target
argument_list|)
operator|<
literal|1
operator|+
literal|4
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
name|PUT8
argument_list|(
name|ISCCC_CCMSGTYPE_TABLE
argument_list|,
name|target
operator|->
name|rstart
argument_list|)
expr_stmt|;
comment|/* 		 * Emit a placeholder length. 		 */
name|lenp
operator|=
name|target
operator|->
name|rstart
expr_stmt|;
name|PUT32
argument_list|(
literal|0
argument_list|,
name|target
operator|->
name|rstart
argument_list|)
expr_stmt|;
comment|/* 		 * Emit the table. 		 */
name|result
operator|=
name|table_towire
argument_list|(
name|elt
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|len
operator|=
call|(
name|size_t
call|)
argument_list|(
name|target
operator|->
name|rstart
operator|-
name|lenp
argument_list|)
expr_stmt|;
comment|/* 		 * 'len' is 4 bytes too big, since it counts 		 * the placeholder length too.  Adjust and 		 * emit. 		 */
name|INSIST
argument_list|(
name|len
operator|>=
literal|4U
argument_list|)
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
name|PUT32
argument_list|(
name|len
argument_list|,
name|lenp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isccc_sexpr_listp
argument_list|(
name|elt
argument_list|)
condition|)
block|{
if|if
condition|(
name|REGION_SIZE
argument_list|(
operator|*
name|target
argument_list|)
operator|<
literal|1
operator|+
literal|4
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
name|PUT8
argument_list|(
name|ISCCC_CCMSGTYPE_LIST
argument_list|,
name|target
operator|->
name|rstart
argument_list|)
expr_stmt|;
comment|/* 		 * Emit a placeholder length and count. 		 */
name|lenp
operator|=
name|target
operator|->
name|rstart
expr_stmt|;
name|PUT32
argument_list|(
literal|0
argument_list|,
name|target
operator|->
name|rstart
argument_list|)
expr_stmt|;
comment|/* 		 * Emit the list. 		 */
name|result
operator|=
name|list_towire
argument_list|(
name|elt
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|len
operator|=
call|(
name|size_t
call|)
argument_list|(
name|target
operator|->
name|rstart
operator|-
name|lenp
argument_list|)
expr_stmt|;
comment|/* 		 * 'len' is 4 bytes too big, since it counts 		 * the placeholder length.  Adjust and emit. 		 */
name|INSIST
argument_list|(
name|len
operator|>=
literal|4U
argument_list|)
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
name|PUT32
argument_list|(
name|len
argument_list|,
name|lenp
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|table_towire
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
name|isccc_region_t
modifier|*
name|target
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|kv
decl_stmt|,
modifier|*
name|elt
decl_stmt|,
modifier|*
name|k
decl_stmt|,
modifier|*
name|v
decl_stmt|;
name|char
modifier|*
name|ks
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|size_t
name|len
decl_stmt|;
for|for
control|(
name|elt
operator|=
name|isccc_alist_first
argument_list|(
name|alist
argument_list|)
init|;
name|elt
operator|!=
name|NULL
condition|;
name|elt
operator|=
name|ISCCC_SEXPR_CDR
argument_list|(
name|elt
argument_list|)
control|)
block|{
name|kv
operator|=
name|ISCCC_SEXPR_CAR
argument_list|(
name|elt
argument_list|)
expr_stmt|;
name|k
operator|=
name|ISCCC_SEXPR_CAR
argument_list|(
name|kv
argument_list|)
expr_stmt|;
name|ks
operator|=
name|isccc_sexpr_tostring
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|v
operator|=
name|ISCCC_SEXPR_CDR
argument_list|(
name|kv
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|ks
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|len
operator|<=
literal|255U
argument_list|)
expr_stmt|;
comment|/* 		 * Emit the key name. 		 */
if|if
condition|(
name|REGION_SIZE
argument_list|(
operator|*
name|target
argument_list|)
operator|<
literal|1
operator|+
name|len
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
name|PUT8
argument_list|(
name|len
argument_list|,
name|target
operator|->
name|rstart
argument_list|)
expr_stmt|;
name|PUT_MEM
argument_list|(
name|ks
argument_list|,
name|len
argument_list|,
name|target
operator|->
name|rstart
argument_list|)
expr_stmt|;
comment|/* 		 * Emit the value. 		 */
name|result
operator|=
name|value_towire
argument_list|(
name|v
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|list_towire
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|list
parameter_list|,
name|isccc_region_t
modifier|*
name|target
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
while|while
condition|(
name|list
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|value_towire
argument_list|(
name|ISCCC_SEXPR_CAR
argument_list|(
name|list
argument_list|)
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|list
operator|=
name|ISCCC_SEXPR_CDR
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|sign
parameter_list|(
name|unsigned
name|char
modifier|*
name|data
parameter_list|,
name|unsigned
name|int
name|length
parameter_list|,
name|unsigned
name|char
modifier|*
name|hmd5
parameter_list|,
name|isccc_region_t
modifier|*
name|secret
parameter_list|)
block|{
name|isc_hmacmd5_t
name|ctx
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isccc_region_t
name|source
decl_stmt|,
name|target
decl_stmt|;
name|unsigned
name|char
name|digest
index|[
name|ISC_MD5_DIGESTLENGTH
index|]
decl_stmt|;
name|unsigned
name|char
name|digestb64
index|[
name|ISC_MD5_DIGESTLENGTH
operator|*
literal|4
index|]
decl_stmt|;
name|isc_hmacmd5_init
argument_list|(
operator|&
name|ctx
argument_list|,
name|secret
operator|->
name|rstart
argument_list|,
name|REGION_SIZE
argument_list|(
operator|*
name|secret
argument_list|)
argument_list|)
expr_stmt|;
name|isc_hmacmd5_update
argument_list|(
operator|&
name|ctx
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|isc_hmacmd5_sign
argument_list|(
operator|&
name|ctx
argument_list|,
name|digest
argument_list|)
expr_stmt|;
name|source
operator|.
name|rstart
operator|=
name|digest
expr_stmt|;
name|source
operator|.
name|rend
operator|=
name|digest
operator|+
name|ISC_MD5_DIGESTLENGTH
expr_stmt|;
name|target
operator|.
name|rstart
operator|=
name|digestb64
expr_stmt|;
name|target
operator|.
name|rend
operator|=
name|digestb64
operator|+
name|ISC_MD5_DIGESTLENGTH
operator|*
literal|4
expr_stmt|;
name|result
operator|=
name|isccc_base64_encode
argument_list|(
operator|&
name|source
argument_list|,
literal|64
argument_list|,
literal|""
argument_list|,
operator|&
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|PUT_MEM
argument_list|(
name|digestb64
argument_list|,
name|HMD5_LENGTH
argument_list|,
name|hmd5
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|isccc_cc_towire
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
name|isccc_region_t
modifier|*
name|target
parameter_list|,
name|isccc_region_t
modifier|*
name|secret
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|hmd5_rstart
decl_stmt|,
modifier|*
name|signed_rstart
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|REGION_SIZE
argument_list|(
operator|*
name|target
argument_list|)
operator|<
literal|4
operator|+
sizeof|sizeof
argument_list|(
name|auth_hmd5
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
comment|/* 	 * Emit protocol version. 	 */
name|PUT32
argument_list|(
literal|1
argument_list|,
name|target
operator|->
name|rstart
argument_list|)
expr_stmt|;
if|if
condition|(
name|secret
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * Emit _auth section with zeroed HMAC-MD5 signature. 		 * We'll replace the zeros with the real signature once 		 * we know what it is. 		 */
name|hmd5_rstart
operator|=
name|target
operator|->
name|rstart
operator|+
name|HMD5_OFFSET
expr_stmt|;
name|PUT_MEM
argument_list|(
name|auth_hmd5
argument_list|,
sizeof|sizeof
argument_list|(
name|auth_hmd5
argument_list|)
argument_list|,
name|target
operator|->
name|rstart
argument_list|)
expr_stmt|;
block|}
else|else
name|hmd5_rstart
operator|=
name|NULL
expr_stmt|;
name|signed_rstart
operator|=
name|target
operator|->
name|rstart
expr_stmt|;
comment|/* 	 * Delete any existing _auth section so that we don't try 	 * to encode it. 	 */
name|isccc_alist_delete
argument_list|(
name|alist
argument_list|,
literal|"_auth"
argument_list|)
expr_stmt|;
comment|/* 	 * Emit the message. 	 */
name|result
operator|=
name|table_towire
argument_list|(
name|alist
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|secret
operator|!=
name|NULL
condition|)
return|return
operator|(
name|sign
argument_list|(
name|signed_rstart
argument_list|,
operator|(
name|target
operator|->
name|rstart
operator|-
name|signed_rstart
operator|)
argument_list|,
name|hmd5_rstart
argument_list|,
name|secret
argument_list|)
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|verify
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
name|unsigned
name|char
modifier|*
name|data
parameter_list|,
name|unsigned
name|int
name|length
parameter_list|,
name|isccc_region_t
modifier|*
name|secret
parameter_list|)
block|{
name|isc_hmacmd5_t
name|ctx
decl_stmt|;
name|isccc_region_t
name|source
decl_stmt|;
name|isccc_region_t
name|target
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|_auth
decl_stmt|,
modifier|*
name|hmd5
decl_stmt|;
name|unsigned
name|char
name|digest
index|[
name|ISC_MD5_DIGESTLENGTH
index|]
decl_stmt|;
name|unsigned
name|char
name|digestb64
index|[
name|ISC_MD5_DIGESTLENGTH
operator|*
literal|4
index|]
decl_stmt|;
comment|/* 	 * Extract digest. 	 */
name|_auth
operator|=
name|isccc_alist_lookup
argument_list|(
name|alist
argument_list|,
literal|"_auth"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_auth
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
name|hmd5
operator|=
name|isccc_alist_lookup
argument_list|(
name|_auth
argument_list|,
literal|"hmd5"
argument_list|)
expr_stmt|;
if|if
condition|(
name|hmd5
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
comment|/* 	 * Compute digest. 	 */
name|isc_hmacmd5_init
argument_list|(
operator|&
name|ctx
argument_list|,
name|secret
operator|->
name|rstart
argument_list|,
name|REGION_SIZE
argument_list|(
operator|*
name|secret
argument_list|)
argument_list|)
expr_stmt|;
name|isc_hmacmd5_update
argument_list|(
operator|&
name|ctx
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|isc_hmacmd5_sign
argument_list|(
operator|&
name|ctx
argument_list|,
name|digest
argument_list|)
expr_stmt|;
name|source
operator|.
name|rstart
operator|=
name|digest
expr_stmt|;
name|source
operator|.
name|rend
operator|=
name|digest
operator|+
name|ISC_MD5_DIGESTLENGTH
expr_stmt|;
name|target
operator|.
name|rstart
operator|=
name|digestb64
expr_stmt|;
name|target
operator|.
name|rend
operator|=
name|digestb64
operator|+
name|ISC_MD5_DIGESTLENGTH
operator|*
literal|4
expr_stmt|;
name|result
operator|=
name|isccc_base64_encode
argument_list|(
operator|&
name|source
argument_list|,
literal|64
argument_list|,
literal|""
argument_list|,
operator|&
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* 	 * Strip trailing == and NUL terminate target. 	 */
name|target
operator|.
name|rstart
operator|-=
literal|2
expr_stmt|;
operator|*
name|target
operator|.
name|rstart
operator|++
operator|=
literal|'\0'
expr_stmt|;
comment|/* 	 * Verify. 	 */
if|if
condition|(
name|strcmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|digestb64
argument_list|,
name|isccc_sexpr_tostring
argument_list|(
name|hmd5
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISCCC_R_BADAUTH
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|isc_result_t
name|table_fromwire
parameter_list|(
name|isccc_region_t
modifier|*
name|source
parameter_list|,
name|isccc_region_t
modifier|*
name|secret
parameter_list|,
name|isccc_sexpr_t
modifier|*
modifier|*
name|alistp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|list_fromwire
parameter_list|(
name|isccc_region_t
modifier|*
name|source
parameter_list|,
name|isccc_sexpr_t
modifier|*
modifier|*
name|listp
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|isc_result_t
name|value_fromwire
parameter_list|(
name|isccc_region_t
modifier|*
name|source
parameter_list|,
name|isccc_sexpr_t
modifier|*
modifier|*
name|valuep
parameter_list|)
block|{
name|unsigned
name|int
name|msgtype
decl_stmt|;
name|isc_uint32_t
name|len
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|value
decl_stmt|;
name|isccc_region_t
name|active
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|REGION_SIZE
argument_list|(
operator|*
name|source
argument_list|)
operator|<
literal|1
operator|+
literal|4
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
name|GET8
argument_list|(
name|msgtype
argument_list|,
name|source
operator|->
name|rstart
argument_list|)
expr_stmt|;
name|GET32
argument_list|(
name|len
argument_list|,
name|source
operator|->
name|rstart
argument_list|)
expr_stmt|;
if|if
condition|(
name|REGION_SIZE
argument_list|(
operator|*
name|source
argument_list|)
operator|<
name|len
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
name|active
operator|.
name|rstart
operator|=
name|source
operator|->
name|rstart
expr_stmt|;
name|active
operator|.
name|rend
operator|=
name|active
operator|.
name|rstart
operator|+
name|len
expr_stmt|;
name|source
operator|->
name|rstart
operator|=
name|active
operator|.
name|rend
expr_stmt|;
if|if
condition|(
name|msgtype
operator|==
name|ISCCC_CCMSGTYPE_BINARYDATA
condition|)
block|{
name|value
operator|=
name|isccc_sexpr_frombinary
argument_list|(
operator|&
name|active
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|NULL
condition|)
block|{
operator|*
name|valuep
operator|=
name|value
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
else|else
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|msgtype
operator|==
name|ISCCC_CCMSGTYPE_TABLE
condition|)
name|result
operator|=
name|table_fromwire
argument_list|(
operator|&
name|active
argument_list|,
name|NULL
argument_list|,
name|valuep
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|msgtype
operator|==
name|ISCCC_CCMSGTYPE_LIST
condition|)
name|result
operator|=
name|list_fromwire
argument_list|(
operator|&
name|active
argument_list|,
name|valuep
argument_list|)
expr_stmt|;
else|else
name|result
operator|=
name|ISCCC_R_SYNTAX
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|table_fromwire
parameter_list|(
name|isccc_region_t
modifier|*
name|source
parameter_list|,
name|isccc_region_t
modifier|*
name|secret
parameter_list|,
name|isccc_sexpr_t
modifier|*
modifier|*
name|alistp
parameter_list|)
block|{
name|char
name|key
index|[
literal|256
index|]
decl_stmt|;
name|isc_uint32_t
name|len
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|alist
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|isc_boolean_t
name|first_tag
decl_stmt|;
name|unsigned
name|char
modifier|*
name|checksum_rstart
decl_stmt|;
name|REQUIRE
argument_list|(
name|alistp
operator|!=
name|NULL
operator|&&
operator|*
name|alistp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|checksum_rstart
operator|=
name|NULL
expr_stmt|;
name|first_tag
operator|=
name|ISC_TRUE
expr_stmt|;
name|alist
operator|=
name|isccc_alist_create
argument_list|()
expr_stmt|;
if|if
condition|(
name|alist
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
while|while
condition|(
operator|!
name|REGION_EMPTY
argument_list|(
operator|*
name|source
argument_list|)
condition|)
block|{
name|GET8
argument_list|(
name|len
argument_list|,
name|source
operator|->
name|rstart
argument_list|)
expr_stmt|;
if|if
condition|(
name|REGION_SIZE
argument_list|(
operator|*
name|source
argument_list|)
operator|<
name|len
condition|)
block|{
name|result
operator|=
name|ISC_R_UNEXPECTEDEND
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|GET_MEM
argument_list|(
name|key
argument_list|,
name|len
argument_list|,
name|source
operator|->
name|rstart
argument_list|)
expr_stmt|;
name|key
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* Ensure NUL termination. */
name|value
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|value_fromwire
argument_list|(
name|source
argument_list|,
operator|&
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
name|isccc_alist_define
argument_list|(
name|alist
argument_list|,
name|key
argument_list|,
name|value
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|first_tag
operator|&&
name|secret
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|key
argument_list|,
literal|"_auth"
argument_list|)
operator|==
literal|0
condition|)
name|checksum_rstart
operator|=
name|source
operator|->
name|rstart
expr_stmt|;
name|first_tag
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
operator|*
name|alistp
operator|=
name|alist
expr_stmt|;
if|if
condition|(
name|secret
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|checksum_rstart
operator|!=
name|NULL
condition|)
return|return
operator|(
name|verify
argument_list|(
name|alist
argument_list|,
name|checksum_rstart
argument_list|,
operator|(
name|source
operator|->
name|rend
operator|-
name|checksum_rstart
operator|)
argument_list|,
name|secret
argument_list|)
operator|)
return|;
return|return
operator|(
name|ISCCC_R_BADAUTH
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|bad
label|:
name|isccc_sexpr_free
argument_list|(
operator|&
name|alist
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|list_fromwire
parameter_list|(
name|isccc_region_t
modifier|*
name|source
parameter_list|,
name|isccc_sexpr_t
modifier|*
modifier|*
name|listp
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|list
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|list
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
operator|!
name|REGION_EMPTY
argument_list|(
operator|*
name|source
argument_list|)
condition|)
block|{
name|value
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|value_fromwire
argument_list|(
name|source
argument_list|,
operator|&
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isccc_sexpr_free
argument_list|(
operator|&
name|list
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
if|if
condition|(
name|isccc_sexpr_addtolist
argument_list|(
operator|&
name|list
argument_list|,
name|value
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|isccc_sexpr_free
argument_list|(
operator|&
name|value
argument_list|)
expr_stmt|;
name|isccc_sexpr_free
argument_list|(
operator|&
name|list
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
operator|*
name|listp
operator|=
name|list
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|isccc_cc_fromwire
parameter_list|(
name|isccc_region_t
modifier|*
name|source
parameter_list|,
name|isccc_sexpr_t
modifier|*
modifier|*
name|alistp
parameter_list|,
name|isccc_region_t
modifier|*
name|secret
parameter_list|)
block|{
name|unsigned
name|int
name|size
decl_stmt|;
name|isc_uint32_t
name|version
decl_stmt|;
name|size
operator|=
name|REGION_SIZE
argument_list|(
operator|*
name|source
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|<
literal|4
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
name|GET32
argument_list|(
name|version
argument_list|,
name|source
operator|->
name|rstart
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|!=
literal|1
condition|)
return|return
operator|(
name|ISCCC_R_UNKNOWNVERSION
operator|)
return|;
return|return
operator|(
name|table_fromwire
argument_list|(
name|source
argument_list|,
name|secret
argument_list|,
name|alistp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|createmessage
parameter_list|(
name|isc_uint32_t
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|from
parameter_list|,
specifier|const
name|char
modifier|*
name|to
parameter_list|,
name|isc_uint32_t
name|serial
parameter_list|,
name|isccc_time_t
name|now
parameter_list|,
name|isccc_time_t
name|expires
parameter_list|,
name|isccc_sexpr_t
modifier|*
modifier|*
name|alistp
parameter_list|,
name|isc_boolean_t
name|want_expires
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|alist
decl_stmt|,
modifier|*
name|_ctrl
decl_stmt|,
modifier|*
name|_data
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|alistp
operator|!=
name|NULL
operator|&&
operator|*
name|alistp
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|!=
literal|1
condition|)
return|return
operator|(
name|ISCCC_R_UNKNOWNVERSION
operator|)
return|;
name|alist
operator|=
name|isccc_alist_create
argument_list|()
expr_stmt|;
if|if
condition|(
name|alist
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
name|_ctrl
operator|=
name|isccc_alist_create
argument_list|()
expr_stmt|;
if|if
condition|(
name|_ctrl
operator|==
name|NULL
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
name|isccc_alist_define
argument_list|(
name|alist
argument_list|,
literal|"_ctrl"
argument_list|,
name|_ctrl
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|isccc_sexpr_free
argument_list|(
operator|&
name|_ctrl
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|_data
operator|=
name|isccc_alist_create
argument_list|()
expr_stmt|;
if|if
condition|(
name|_data
operator|==
name|NULL
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
name|isccc_alist_define
argument_list|(
name|alist
argument_list|,
literal|"_data"
argument_list|,
name|_data
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|isccc_sexpr_free
argument_list|(
operator|&
name|_data
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|isccc_cc_defineuint32
argument_list|(
name|_ctrl
argument_list|,
literal|"_ser"
argument_list|,
name|serial
argument_list|)
operator|==
name|NULL
operator|||
name|isccc_cc_defineuint32
argument_list|(
name|_ctrl
argument_list|,
literal|"_tim"
argument_list|,
name|now
argument_list|)
operator|==
name|NULL
operator|||
operator|(
name|want_expires
operator|&&
name|isccc_cc_defineuint32
argument_list|(
name|_ctrl
argument_list|,
literal|"_exp"
argument_list|,
name|expires
argument_list|)
operator|==
name|NULL
operator|)
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
name|from
operator|!=
name|NULL
operator|&&
name|isccc_cc_definestring
argument_list|(
name|_ctrl
argument_list|,
literal|"_frm"
argument_list|,
name|from
argument_list|)
operator|==
name|NULL
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
name|to
operator|!=
name|NULL
operator|&&
name|isccc_cc_definestring
argument_list|(
name|_ctrl
argument_list|,
literal|"_to"
argument_list|,
name|to
argument_list|)
operator|==
name|NULL
condition|)
goto|goto
name|bad
goto|;
operator|*
name|alistp
operator|=
name|alist
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|bad
label|:
name|isccc_sexpr_free
argument_list|(
operator|&
name|alist
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|isccc_cc_createmessage
parameter_list|(
name|isc_uint32_t
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|from
parameter_list|,
specifier|const
name|char
modifier|*
name|to
parameter_list|,
name|isc_uint32_t
name|serial
parameter_list|,
name|isccc_time_t
name|now
parameter_list|,
name|isccc_time_t
name|expires
parameter_list|,
name|isccc_sexpr_t
modifier|*
modifier|*
name|alistp
parameter_list|)
block|{
return|return
operator|(
name|createmessage
argument_list|(
name|version
argument_list|,
name|from
argument_list|,
name|to
argument_list|,
name|serial
argument_list|,
name|now
argument_list|,
name|expires
argument_list|,
name|alistp
argument_list|,
name|ISC_TRUE
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|isccc_cc_createack
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|message
parameter_list|,
name|isc_boolean_t
name|ok
parameter_list|,
name|isccc_sexpr_t
modifier|*
modifier|*
name|ackp
parameter_list|)
block|{
name|char
modifier|*
name|_frm
decl_stmt|,
modifier|*
name|_to
decl_stmt|;
name|isc_uint32_t
name|serial
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|ack
decl_stmt|,
modifier|*
name|_ctrl
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isccc_time_t
name|t
decl_stmt|;
name|REQUIRE
argument_list|(
name|ackp
operator|!=
name|NULL
operator|&&
operator|*
name|ackp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|_ctrl
operator|=
name|isccc_alist_lookup
argument_list|(
name|message
argument_list|,
literal|"_ctrl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_ctrl
operator|==
name|NULL
operator|||
name|isccc_cc_lookupuint32
argument_list|(
name|_ctrl
argument_list|,
literal|"_ser"
argument_list|,
operator|&
name|serial
argument_list|)
operator|!=
name|ISC_R_SUCCESS
operator|||
name|isccc_cc_lookupuint32
argument_list|(
name|_ctrl
argument_list|,
literal|"_tim"
argument_list|,
operator|&
name|t
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
comment|/* 	 * _frm and _to are optional. 	 */
name|_frm
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|isccc_cc_lookupstring
argument_list|(
name|_ctrl
argument_list|,
literal|"_frm"
argument_list|,
operator|&
name|_frm
argument_list|)
expr_stmt|;
name|_to
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|isccc_cc_lookupstring
argument_list|(
name|_ctrl
argument_list|,
literal|"_to"
argument_list|,
operator|&
name|_to
argument_list|)
expr_stmt|;
comment|/* 	 * Create the ack. 	 */
name|ack
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|createmessage
argument_list|(
literal|1
argument_list|,
name|_to
argument_list|,
name|_frm
argument_list|,
name|serial
argument_list|,
name|t
argument_list|,
literal|0
argument_list|,
operator|&
name|ack
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|_ctrl
operator|=
name|isccc_alist_lookup
argument_list|(
name|ack
argument_list|,
literal|"_ctrl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_ctrl
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
if|if
condition|(
name|isccc_cc_definestring
argument_list|(
name|ack
argument_list|,
literal|"_ack"
argument_list|,
operator|(
name|ok
operator|)
condition|?
literal|"1"
else|:
literal|"0"
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
operator|*
name|ackp
operator|=
name|ack
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|bad
label|:
name|isccc_sexpr_free
argument_list|(
operator|&
name|ack
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_boolean_t
name|isccc_cc_isack
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|message
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|_ctrl
decl_stmt|;
name|_ctrl
operator|=
name|isccc_alist_lookup
argument_list|(
name|message
argument_list|,
literal|"_ctrl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_ctrl
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|isccc_cc_lookupstring
argument_list|(
name|_ctrl
argument_list|,
literal|"_ack"
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
name|isc_boolean_t
name|isccc_cc_isreply
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|message
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|_ctrl
decl_stmt|;
name|_ctrl
operator|=
name|isccc_alist_lookup
argument_list|(
name|message
argument_list|,
literal|"_ctrl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_ctrl
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|isccc_cc_lookupstring
argument_list|(
name|_ctrl
argument_list|,
literal|"_rpl"
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|isccc_cc_createresponse
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|message
parameter_list|,
name|isccc_time_t
name|now
parameter_list|,
name|isccc_time_t
name|expires
parameter_list|,
name|isccc_sexpr_t
modifier|*
modifier|*
name|alistp
parameter_list|)
block|{
name|char
modifier|*
name|_frm
decl_stmt|,
modifier|*
name|_to
decl_stmt|,
modifier|*
name|type
decl_stmt|;
name|isc_uint32_t
name|serial
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|alist
decl_stmt|,
modifier|*
name|_ctrl
decl_stmt|,
modifier|*
name|_data
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|alistp
operator|!=
name|NULL
operator|&&
operator|*
name|alistp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|_ctrl
operator|=
name|isccc_alist_lookup
argument_list|(
name|message
argument_list|,
literal|"_ctrl"
argument_list|)
expr_stmt|;
name|_data
operator|=
name|isccc_alist_lookup
argument_list|(
name|message
argument_list|,
literal|"_data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_ctrl
operator|==
name|NULL
operator|||
name|_data
operator|==
name|NULL
operator|||
name|isccc_cc_lookupuint32
argument_list|(
name|_ctrl
argument_list|,
literal|"_ser"
argument_list|,
operator|&
name|serial
argument_list|)
operator|!=
name|ISC_R_SUCCESS
operator|||
name|isccc_cc_lookupstring
argument_list|(
name|_data
argument_list|,
literal|"type"
argument_list|,
operator|&
name|type
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
comment|/* 	 * _frm and _to are optional. 	 */
name|_frm
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|isccc_cc_lookupstring
argument_list|(
name|_ctrl
argument_list|,
literal|"_frm"
argument_list|,
operator|&
name|_frm
argument_list|)
expr_stmt|;
name|_to
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|isccc_cc_lookupstring
argument_list|(
name|_ctrl
argument_list|,
literal|"_to"
argument_list|,
operator|&
name|_to
argument_list|)
expr_stmt|;
comment|/* 	 * Create the response. 	 */
name|alist
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isccc_cc_createmessage
argument_list|(
literal|1
argument_list|,
name|_to
argument_list|,
name|_frm
argument_list|,
name|serial
argument_list|,
name|now
argument_list|,
name|expires
argument_list|,
operator|&
name|alist
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|_ctrl
operator|=
name|isccc_alist_lookup
argument_list|(
name|alist
argument_list|,
literal|"_ctrl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_ctrl
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
name|_data
operator|=
name|isccc_alist_lookup
argument_list|(
name|alist
argument_list|,
literal|"_data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_data
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
if|if
condition|(
name|isccc_cc_definestring
argument_list|(
name|_ctrl
argument_list|,
literal|"_rpl"
argument_list|,
literal|"1"
argument_list|)
operator|==
name|NULL
operator|||
name|isccc_cc_definestring
argument_list|(
name|_data
argument_list|,
literal|"type"
argument_list|,
name|type
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|isccc_sexpr_free
argument_list|(
operator|&
name|alist
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
operator|*
name|alistp
operator|=
name|alist
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isccc_sexpr_t
modifier|*
name|isccc_cc_definestring
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|isccc_region_t
name|r
decl_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|DE_CONST
argument_list|(
name|str
argument_list|,
name|r
operator|.
name|rstart
argument_list|)
expr_stmt|;
name|r
operator|.
name|rend
operator|=
name|r
operator|.
name|rstart
operator|+
name|len
expr_stmt|;
return|return
operator|(
name|isccc_alist_definebinary
argument_list|(
name|alist
argument_list|,
name|key
argument_list|,
operator|&
name|r
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isccc_sexpr_t
modifier|*
name|isccc_cc_defineuint32
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|isc_uint32_t
name|i
parameter_list|)
block|{
name|char
name|b
index|[
literal|100
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|isccc_region_t
name|r
decl_stmt|;
name|snprintf
argument_list|(
name|b
argument_list|,
sizeof|sizeof
argument_list|(
name|b
argument_list|)
argument_list|,
literal|"%u"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|r
operator|.
name|rstart
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|b
expr_stmt|;
name|r
operator|.
name|rend
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|b
operator|+
name|len
expr_stmt|;
return|return
operator|(
name|isccc_alist_definebinary
argument_list|(
name|alist
argument_list|,
name|key
argument_list|,
operator|&
name|r
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|isccc_cc_lookupstring
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|char
modifier|*
modifier|*
name|strp
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|kv
decl_stmt|,
modifier|*
name|v
decl_stmt|;
name|kv
operator|=
name|isccc_alist_assq
argument_list|(
name|alist
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|kv
operator|!=
name|NULL
condition|)
block|{
name|v
operator|=
name|ISCCC_SEXPR_CDR
argument_list|(
name|kv
argument_list|)
expr_stmt|;
if|if
condition|(
name|isccc_sexpr_binaryp
argument_list|(
name|v
argument_list|)
condition|)
block|{
if|if
condition|(
name|strp
operator|!=
name|NULL
condition|)
operator|*
name|strp
operator|=
name|isccc_sexpr_tostring
argument_list|(
name|v
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
else|else
return|return
operator|(
name|ISC_R_EXISTS
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|isccc_cc_lookupuint32
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|isc_uint32_t
modifier|*
name|uintp
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|kv
decl_stmt|,
modifier|*
name|v
decl_stmt|;
name|kv
operator|=
name|isccc_alist_assq
argument_list|(
name|alist
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|kv
operator|!=
name|NULL
condition|)
block|{
name|v
operator|=
name|ISCCC_SEXPR_CDR
argument_list|(
name|kv
argument_list|)
expr_stmt|;
if|if
condition|(
name|isccc_sexpr_binaryp
argument_list|(
name|v
argument_list|)
condition|)
block|{
if|if
condition|(
name|uintp
operator|!=
name|NULL
condition|)
operator|*
name|uintp
operator|=
operator|(
name|isc_uint32_t
operator|)
name|strtoul
argument_list|(
name|isccc_sexpr_tostring
argument_list|(
name|v
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
else|else
return|return
operator|(
name|ISC_R_EXISTS
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|symtab_undefine
parameter_list|(
name|char
modifier|*
name|key
parameter_list|,
name|unsigned
name|int
name|type
parameter_list|,
name|isccc_symvalue_t
name|value
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|key
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|symtab_clean
parameter_list|(
name|char
modifier|*
name|key
parameter_list|,
name|unsigned
name|int
name|type
parameter_list|,
name|isccc_symvalue_t
name|value
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|isccc_time_t
modifier|*
name|now
decl_stmt|;
name|UNUSED
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|now
operator|=
name|arg
expr_stmt|;
if|if
condition|(
operator|*
name|now
operator|<
name|value
operator|.
name|as_uinteger
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
operator|(
operator|*
name|now
operator|-
name|value
operator|.
name|as_uinteger
operator|)
operator|<
name|DUP_LIFETIME
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|isccc_cc_createsymtab
parameter_list|(
name|isccc_symtab_t
modifier|*
modifier|*
name|symtabp
parameter_list|)
block|{
return|return
operator|(
name|isccc_symtab_create
argument_list|(
literal|11897
argument_list|,
name|symtab_undefine
argument_list|,
name|NULL
argument_list|,
name|ISC_FALSE
argument_list|,
name|symtabp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|isccc_cc_cleansymtab
parameter_list|(
name|isccc_symtab_t
modifier|*
name|symtab
parameter_list|,
name|isccc_time_t
name|now
parameter_list|)
block|{
name|isccc_symtab_foreach
argument_list|(
name|symtab
argument_list|,
name|symtab_clean
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|has_whitespace
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|char
name|c
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
name|str
operator|++
operator|)
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|' '
operator|||
name|c
operator|==
literal|'\t'
operator|||
name|c
operator|==
literal|'\n'
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|isccc_cc_checkdup
parameter_list|(
name|isccc_symtab_t
modifier|*
name|symtab
parameter_list|,
name|isccc_sexpr_t
modifier|*
name|message
parameter_list|,
name|isccc_time_t
name|now
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|_frm
decl_stmt|;
specifier|const
name|char
modifier|*
name|_to
decl_stmt|;
name|char
modifier|*
name|_ser
decl_stmt|,
modifier|*
name|_tim
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|char
modifier|*
name|key
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|isccc_symvalue_t
name|value
decl_stmt|;
name|isccc_sexpr_t
modifier|*
name|_ctrl
decl_stmt|;
name|_ctrl
operator|=
name|isccc_alist_lookup
argument_list|(
name|message
argument_list|,
literal|"_ctrl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_ctrl
operator|==
name|NULL
operator|||
name|isccc_cc_lookupstring
argument_list|(
name|_ctrl
argument_list|,
literal|"_ser"
argument_list|,
operator|&
name|_ser
argument_list|)
operator|!=
name|ISC_R_SUCCESS
operator|||
name|isccc_cc_lookupstring
argument_list|(
name|_ctrl
argument_list|,
literal|"_tim"
argument_list|,
operator|&
name|_tim
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
comment|/* 	 * _frm and _to are optional. 	 */
if|if
condition|(
name|isccc_cc_lookupstring
argument_list|(
name|_ctrl
argument_list|,
literal|"_frm"
argument_list|,
operator|&
name|tmp
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
name|_frm
operator|=
literal|""
expr_stmt|;
else|else
name|_frm
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|isccc_cc_lookupstring
argument_list|(
name|_ctrl
argument_list|,
literal|"_to"
argument_list|,
operator|&
name|tmp
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
name|_to
operator|=
literal|""
expr_stmt|;
else|else
name|_to
operator|=
name|tmp
expr_stmt|;
comment|/* 	 * Ensure there is no newline in any of the strings.  This is so 	 * we can write them to a file later. 	 */
if|if
condition|(
name|has_whitespace
argument_list|(
name|_frm
argument_list|)
operator|||
name|has_whitespace
argument_list|(
name|_to
argument_list|)
operator|||
name|has_whitespace
argument_list|(
name|_ser
argument_list|)
operator|||
name|has_whitespace
argument_list|(
name|_tim
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
name|len
operator|=
name|strlen
argument_list|(
name|_frm
argument_list|)
operator|+
name|strlen
argument_list|(
name|_to
argument_list|)
operator|+
name|strlen
argument_list|(
name|_ser
argument_list|)
operator|+
name|strlen
argument_list|(
name|_tim
argument_list|)
operator|+
literal|4
expr_stmt|;
name|key
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|snprintf
argument_list|(
name|key
argument_list|,
name|len
argument_list|,
literal|"%s;%s;%s;%s"
argument_list|,
name|_frm
argument_list|,
name|_to
argument_list|,
name|_ser
argument_list|,
name|_tim
argument_list|)
expr_stmt|;
name|value
operator|.
name|as_uinteger
operator|=
name|now
expr_stmt|;
name|result
operator|=
name|isccc_symtab_define
argument_list|(
name|symtab
argument_list|,
name|key
argument_list|,
name|ISCCC_SYMTYPE_CCDUP
argument_list|,
name|value
argument_list|,
name|isccc_symexists_reject
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|free
argument_list|(
name|key
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Portions Copyright (C) 2004, 2005, 2007  Internet Systems Consortium, Inc. ("ISC")  * Portions Copyright (C) 2001  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC AND NOMINUM DISCLAIMS ALL  * WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY  * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * Portions Copyright (C) 2001  Nominum, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC AND NOMINUM DISCLAIMS ALL  * WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY  * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: alist.c,v 1.8 2007/08/28 07:20:43 tbox Exp $ */
end_comment

begin_comment
comment|/*! \file */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<isccc/alist.h>
end_include

begin_include
include|#
directive|include
file|<isc/assertions.h>
end_include

begin_include
include|#
directive|include
file|<isccc/result.h>
end_include

begin_include
include|#
directive|include
file|<isccc/sexpr.h>
end_include

begin_include
include|#
directive|include
file|<isccc/util.h>
end_include

begin_define
define|#
directive|define
name|CAR
parameter_list|(
name|s
parameter_list|)
value|(s)->value.as_dottedpair.car
end_define

begin_define
define|#
directive|define
name|CDR
parameter_list|(
name|s
parameter_list|)
value|(s)->value.as_dottedpair.cdr
end_define

begin_define
define|#
directive|define
name|ALIST_TAG
value|"*alist*"
end_define

begin_define
define|#
directive|define
name|MAX_INDENT
value|64
end_define

begin_decl_stmt
specifier|static
name|char
name|spaces
index|[
name|MAX_INDENT
operator|+
literal|1
index|]
init|=
literal|"                                                                "
decl_stmt|;
end_decl_stmt

begin_function
name|isccc_sexpr_t
modifier|*
name|isccc_alist_create
parameter_list|(
name|void
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|alist
decl_stmt|,
modifier|*
name|tag
decl_stmt|;
name|tag
operator|=
name|isccc_sexpr_fromstring
argument_list|(
name|ALIST_TAG
argument_list|)
expr_stmt|;
if|if
condition|(
name|tag
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|alist
operator|=
name|isccc_sexpr_cons
argument_list|(
name|tag
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|alist
operator|==
name|NULL
condition|)
block|{
name|isccc_sexpr_free
argument_list|(
operator|&
name|tag
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
name|alist
operator|)
return|;
block|}
end_function

begin_function
name|isc_boolean_t
name|isccc_alist_alistp
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|car
decl_stmt|;
if|if
condition|(
name|alist
operator|==
name|NULL
operator|||
name|alist
operator|->
name|type
operator|!=
name|ISCCC_SEXPRTYPE_DOTTEDPAIR
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
name|car
operator|=
name|CAR
argument_list|(
name|alist
argument_list|)
expr_stmt|;
if|if
condition|(
name|car
operator|==
name|NULL
operator|||
name|car
operator|->
name|type
operator|!=
name|ISCCC_SEXPRTYPE_STRING
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|car
operator|->
name|value
operator|.
name|as_string
argument_list|,
name|ALIST_TAG
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_function
name|isc_boolean_t
name|isccc_alist_emptyp
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|isccc_alist_alistp
argument_list|(
name|alist
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CDR
argument_list|(
name|alist
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
name|isccc_sexpr_t
modifier|*
name|isccc_alist_first
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|isccc_alist_alistp
argument_list|(
name|alist
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|CDR
argument_list|(
name|alist
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isccc_sexpr_t
modifier|*
name|isccc_alist_assq
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|car
decl_stmt|,
modifier|*
name|caar
decl_stmt|;
name|REQUIRE
argument_list|(
name|isccc_alist_alistp
argument_list|(
name|alist
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Skip alist type tag. 	 */
name|alist
operator|=
name|CDR
argument_list|(
name|alist
argument_list|)
expr_stmt|;
while|while
condition|(
name|alist
operator|!=
name|NULL
condition|)
block|{
name|INSIST
argument_list|(
name|alist
operator|->
name|type
operator|==
name|ISCCC_SEXPRTYPE_DOTTEDPAIR
argument_list|)
expr_stmt|;
name|car
operator|=
name|CAR
argument_list|(
name|alist
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|car
operator|->
name|type
operator|==
name|ISCCC_SEXPRTYPE_DOTTEDPAIR
argument_list|)
expr_stmt|;
name|caar
operator|=
name|CAR
argument_list|(
name|car
argument_list|)
expr_stmt|;
if|if
condition|(
name|caar
operator|->
name|type
operator|==
name|ISCCC_SEXPRTYPE_STRING
operator|&&
name|strcmp
argument_list|(
name|caar
operator|->
name|value
operator|.
name|as_string
argument_list|,
name|key
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|car
operator|)
return|;
name|alist
operator|=
name|CDR
argument_list|(
name|alist
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|void
name|isccc_alist_delete
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|car
decl_stmt|,
modifier|*
name|caar
decl_stmt|,
modifier|*
name|rest
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|REQUIRE
argument_list|(
name|isccc_alist_alistp
argument_list|(
name|alist
argument_list|)
argument_list|)
expr_stmt|;
name|prev
operator|=
name|alist
expr_stmt|;
name|rest
operator|=
name|CDR
argument_list|(
name|alist
argument_list|)
expr_stmt|;
while|while
condition|(
name|rest
operator|!=
name|NULL
condition|)
block|{
name|INSIST
argument_list|(
name|rest
operator|->
name|type
operator|==
name|ISCCC_SEXPRTYPE_DOTTEDPAIR
argument_list|)
expr_stmt|;
name|car
operator|=
name|CAR
argument_list|(
name|rest
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|car
operator|!=
name|NULL
operator|&&
name|car
operator|->
name|type
operator|==
name|ISCCC_SEXPRTYPE_DOTTEDPAIR
argument_list|)
expr_stmt|;
name|caar
operator|=
name|CAR
argument_list|(
name|car
argument_list|)
expr_stmt|;
if|if
condition|(
name|caar
operator|->
name|type
operator|==
name|ISCCC_SEXPRTYPE_STRING
operator|&&
name|strcmp
argument_list|(
name|caar
operator|->
name|value
operator|.
name|as_string
argument_list|,
name|key
argument_list|)
operator|==
literal|0
condition|)
block|{
name|CDR
argument_list|(
name|prev
argument_list|)
operator|=
name|CDR
argument_list|(
name|rest
argument_list|)
expr_stmt|;
name|CDR
argument_list|(
name|rest
argument_list|)
operator|=
name|NULL
expr_stmt|;
name|isccc_sexpr_free
argument_list|(
operator|&
name|rest
argument_list|)
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|rest
expr_stmt|;
name|rest
operator|=
name|CDR
argument_list|(
name|rest
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|isccc_sexpr_t
modifier|*
name|isccc_alist_define
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|isccc_sexpr_t
modifier|*
name|value
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|kv
decl_stmt|,
modifier|*
name|k
decl_stmt|,
modifier|*
name|elt
decl_stmt|;
name|kv
operator|=
name|isccc_alist_assq
argument_list|(
name|alist
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|kv
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * New association. 		 */
name|k
operator|=
name|isccc_sexpr_fromstring
argument_list|(
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|kv
operator|=
name|isccc_sexpr_cons
argument_list|(
name|k
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|kv
operator|==
name|NULL
condition|)
block|{
name|isccc_sexpr_free
argument_list|(
operator|&
name|kv
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|elt
operator|=
name|isccc_sexpr_addtolist
argument_list|(
operator|&
name|alist
argument_list|,
name|kv
argument_list|)
expr_stmt|;
if|if
condition|(
name|elt
operator|==
name|NULL
condition|)
block|{
name|isccc_sexpr_free
argument_list|(
operator|&
name|kv
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
else|else
block|{
comment|/* 		 * We've already got an entry for this key.  Replace it. 		 */
name|isccc_sexpr_free
argument_list|(
operator|&
name|CDR
argument_list|(
name|kv
argument_list|)
argument_list|)
expr_stmt|;
name|CDR
argument_list|(
name|kv
argument_list|)
operator|=
name|value
expr_stmt|;
block|}
return|return
operator|(
name|kv
operator|)
return|;
block|}
end_function

begin_function
name|isccc_sexpr_t
modifier|*
name|isccc_alist_definestring
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|v
decl_stmt|,
modifier|*
name|kv
decl_stmt|;
name|v
operator|=
name|isccc_sexpr_fromstring
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|kv
operator|=
name|isccc_alist_define
argument_list|(
name|alist
argument_list|,
name|key
argument_list|,
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|kv
operator|==
name|NULL
condition|)
name|isccc_sexpr_free
argument_list|(
operator|&
name|v
argument_list|)
expr_stmt|;
return|return
operator|(
name|kv
operator|)
return|;
block|}
end_function

begin_function
name|isccc_sexpr_t
modifier|*
name|isccc_alist_definebinary
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|isccc_region_t
modifier|*
name|r
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|v
decl_stmt|,
modifier|*
name|kv
decl_stmt|;
name|v
operator|=
name|isccc_sexpr_frombinary
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|kv
operator|=
name|isccc_alist_define
argument_list|(
name|alist
argument_list|,
name|key
argument_list|,
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|kv
operator|==
name|NULL
condition|)
name|isccc_sexpr_free
argument_list|(
operator|&
name|v
argument_list|)
expr_stmt|;
return|return
operator|(
name|kv
operator|)
return|;
block|}
end_function

begin_function
name|isccc_sexpr_t
modifier|*
name|isccc_alist_lookup
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|kv
decl_stmt|;
name|kv
operator|=
name|isccc_alist_assq
argument_list|(
name|alist
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|kv
operator|!=
name|NULL
condition|)
return|return
operator|(
name|CDR
argument_list|(
name|kv
argument_list|)
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|isccc_alist_lookupstring
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|char
modifier|*
modifier|*
name|strp
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|kv
decl_stmt|,
modifier|*
name|v
decl_stmt|;
name|kv
operator|=
name|isccc_alist_assq
argument_list|(
name|alist
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|kv
operator|!=
name|NULL
condition|)
block|{
name|v
operator|=
name|CDR
argument_list|(
name|kv
argument_list|)
expr_stmt|;
if|if
condition|(
name|isccc_sexpr_stringp
argument_list|(
name|v
argument_list|)
condition|)
block|{
if|if
condition|(
name|strp
operator|!=
name|NULL
condition|)
operator|*
name|strp
operator|=
name|isccc_sexpr_tostring
argument_list|(
name|v
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
else|else
return|return
operator|(
name|ISC_R_EXISTS
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|isccc_alist_lookupbinary
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|alist
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|isccc_region_t
modifier|*
modifier|*
name|r
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|kv
decl_stmt|,
modifier|*
name|v
decl_stmt|;
name|kv
operator|=
name|isccc_alist_assq
argument_list|(
name|alist
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|kv
operator|!=
name|NULL
condition|)
block|{
name|v
operator|=
name|CDR
argument_list|(
name|kv
argument_list|)
expr_stmt|;
if|if
condition|(
name|isccc_sexpr_binaryp
argument_list|(
name|v
argument_list|)
condition|)
block|{
if|if
condition|(
name|r
operator|!=
name|NULL
condition|)
operator|*
name|r
operator|=
name|isccc_sexpr_tobinary
argument_list|(
name|v
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
else|else
return|return
operator|(
name|ISC_R_EXISTS
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
name|void
name|isccc_alist_prettyprint
parameter_list|(
name|isccc_sexpr_t
modifier|*
name|sexpr
parameter_list|,
name|unsigned
name|int
name|indent
parameter_list|,
name|FILE
modifier|*
name|stream
parameter_list|)
block|{
name|isccc_sexpr_t
modifier|*
name|elt
decl_stmt|,
modifier|*
name|kv
decl_stmt|,
modifier|*
name|k
decl_stmt|,
modifier|*
name|v
decl_stmt|;
if|if
condition|(
name|isccc_alist_alistp
argument_list|(
name|sexpr
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"{\n"
argument_list|)
expr_stmt|;
name|indent
operator|+=
literal|4
expr_stmt|;
for|for
control|(
name|elt
operator|=
name|isccc_alist_first
argument_list|(
name|sexpr
argument_list|)
init|;
name|elt
operator|!=
name|NULL
condition|;
name|elt
operator|=
name|CDR
argument_list|(
name|elt
argument_list|)
control|)
block|{
name|kv
operator|=
name|CAR
argument_list|(
name|elt
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|isccc_sexpr_listp
argument_list|(
name|kv
argument_list|)
argument_list|)
expr_stmt|;
name|k
operator|=
name|CAR
argument_list|(
name|kv
argument_list|)
expr_stmt|;
name|v
operator|=
name|CDR
argument_list|(
name|kv
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|isccc_sexpr_stringp
argument_list|(
name|k
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"%.*s%s => "
argument_list|,
operator|(
name|int
operator|)
name|indent
argument_list|,
name|spaces
argument_list|,
name|isccc_sexpr_tostring
argument_list|(
name|k
argument_list|)
argument_list|)
expr_stmt|;
name|isccc_alist_prettyprint
argument_list|(
name|v
argument_list|,
name|indent
argument_list|,
name|stream
argument_list|)
expr_stmt|;
if|if
condition|(
name|CDR
argument_list|(
name|elt
argument_list|)
operator|!=
name|NULL
condition|)
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|","
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|indent
operator|-=
literal|4
expr_stmt|;
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"%.*s}"
argument_list|,
operator|(
name|int
operator|)
name|indent
argument_list|,
name|spaces
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isccc_sexpr_listp
argument_list|(
name|sexpr
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"(\n"
argument_list|)
expr_stmt|;
name|indent
operator|+=
literal|4
expr_stmt|;
for|for
control|(
name|elt
operator|=
name|sexpr
init|;
name|elt
operator|!=
name|NULL
condition|;
name|elt
operator|=
name|CDR
argument_list|(
name|elt
argument_list|)
control|)
block|{
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"%.*s"
argument_list|,
operator|(
name|int
operator|)
name|indent
argument_list|,
name|spaces
argument_list|)
expr_stmt|;
name|isccc_alist_prettyprint
argument_list|(
name|CAR
argument_list|(
name|elt
argument_list|)
argument_list|,
name|indent
argument_list|,
name|stream
argument_list|)
expr_stmt|;
if|if
condition|(
name|CDR
argument_list|(
name|elt
argument_list|)
operator|!=
name|NULL
condition|)
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|","
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|indent
operator|-=
literal|4
expr_stmt|;
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"%.*s)"
argument_list|,
operator|(
name|int
operator|)
name|indent
argument_list|,
name|spaces
argument_list|)
expr_stmt|;
block|}
else|else
name|isccc_sexpr_print
argument_list|(
name|sexpr
argument_list|,
name|stream
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004, 2005, 2007, 2014  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 2001, 2002  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: getaddresses.c,v 1.22 2007/06/19 23:47:16 tbox Exp $ */
end_comment

begin_comment
comment|/*! \file */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<isc/net.h>
end_include

begin_include
include|#
directive|include
file|<isc/netaddr.h>
end_include

begin_include
include|#
directive|include
file|<isc/netdb.h>
end_include

begin_include
include|#
directive|include
file|<isc/netscope.h>
end_include

begin_include
include|#
directive|include
file|<isc/result.h>
end_include

begin_include
include|#
directive|include
file|<isc/sockaddr.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<bind9/getaddresses.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_ADDRINFO
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_GETADDRINFO
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_GAISTRERROR
end_ifdef

begin_define
define|#
directive|define
name|USE_GETADDRINFO
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|USE_GETADDRINFO
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|ISC_PLATFORM_NONSTDHERRNO
end_ifndef

begin_decl_stmt
specifier|extern
name|int
name|h_errno
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|isc_result_t
name|bind9_getaddresses
parameter_list|(
specifier|const
name|char
modifier|*
name|hostname
parameter_list|,
name|in_port_t
name|port
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addrs
parameter_list|,
name|int
name|addrsize
parameter_list|,
name|int
modifier|*
name|addrcount
parameter_list|)
block|{
name|struct
name|in_addr
name|in4
decl_stmt|;
name|struct
name|in6_addr
name|in6
decl_stmt|;
name|isc_boolean_t
name|have_ipv4
decl_stmt|,
name|have_ipv6
decl_stmt|;
name|int
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|USE_GETADDRINFO
name|struct
name|addrinfo
modifier|*
name|ai
init|=
name|NULL
decl_stmt|,
modifier|*
name|tmpai
decl_stmt|,
name|hints
decl_stmt|;
name|int
name|result
decl_stmt|;
else|#
directive|else
name|struct
name|hostent
modifier|*
name|he
decl_stmt|;
endif|#
directive|endif
name|REQUIRE
argument_list|(
name|hostname
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|addrs
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|addrcount
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|addrsize
operator|>
literal|0
argument_list|)
expr_stmt|;
name|have_ipv4
operator|=
name|ISC_TF
argument_list|(
operator|(
name|isc_net_probeipv4
argument_list|()
operator|==
name|ISC_R_SUCCESS
operator|)
argument_list|)
expr_stmt|;
name|have_ipv6
operator|=
name|ISC_TF
argument_list|(
operator|(
name|isc_net_probeipv6
argument_list|()
operator|==
name|ISC_R_SUCCESS
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Try IPv4, then IPv6.  In order to handle the extended format 	 * for IPv6 scoped addresses (address%scope_ID), we'll use a local 	 * working buffer of 128 bytes.  The length is an ad-hoc value, but 	 * should be enough for this purpose; the buffer can contain a string 	 * of at least 80 bytes for scope_ID in addition to any IPv6 numeric 	 * addresses (up to 46 bytes), the delimiter character and the 	 * terminating NULL character. 	 */
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET
argument_list|,
name|hostname
argument_list|,
operator|&
name|in4
argument_list|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|have_ipv4
condition|)
name|isc_sockaddr_fromin
argument_list|(
operator|&
name|addrs
index|[
literal|0
index|]
argument_list|,
operator|&
name|in4
argument_list|,
name|port
argument_list|)
expr_stmt|;
else|else
name|isc_sockaddr_v6fromin
argument_list|(
operator|&
name|addrs
index|[
literal|0
index|]
argument_list|,
operator|&
name|in4
argument_list|,
name|port
argument_list|)
expr_stmt|;
operator|*
name|addrcount
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|strlen
argument_list|(
name|hostname
argument_list|)
operator|<=
literal|127U
condition|)
block|{
name|char
name|tmpbuf
index|[
literal|128
index|]
decl_stmt|,
modifier|*
name|d
decl_stmt|;
name|isc_uint32_t
name|zone
init|=
literal|0
decl_stmt|;
name|strcpy
argument_list|(
name|tmpbuf
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
name|d
operator|=
name|strchr
argument_list|(
name|tmpbuf
argument_list|,
literal|'%'
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|!=
name|NULL
condition|)
operator|*
name|d
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|tmpbuf
argument_list|,
operator|&
name|in6
argument_list|)
operator|==
literal|1
condition|)
block|{
name|isc_netaddr_t
name|na
decl_stmt|;
if|if
condition|(
operator|!
name|have_ipv6
condition|)
return|return
operator|(
name|ISC_R_FAMILYNOSUPPORT
operator|)
return|;
if|if
condition|(
name|d
operator|!=
name|NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESCOPEID
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|isc_netscope_pton
argument_list|(
name|AF_INET6
argument_list|,
name|d
operator|+
literal|1
argument_list|,
operator|&
name|in6
argument_list|,
operator|&
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
else|#
directive|else
comment|/* 				 * The extended format is specified while the 				 * system does not provide the ability to use 				 * it.  Throw an explicit error instead of 				 * ignoring the specified value. 				 */
return|return
operator|(
name|ISC_R_BADADDRESSFORM
operator|)
return|;
endif|#
directive|endif
block|}
name|isc_netaddr_fromin6
argument_list|(
operator|&
name|na
argument_list|,
operator|&
name|in6
argument_list|)
expr_stmt|;
name|isc_netaddr_setzone
argument_list|(
operator|&
name|na
argument_list|,
name|zone
argument_list|)
expr_stmt|;
name|isc_sockaddr_fromnetaddr
argument_list|(
operator|&
name|addrs
index|[
literal|0
index|]
argument_list|,
operator|(
specifier|const
name|isc_netaddr_t
operator|*
operator|)
operator|&
name|na
argument_list|,
name|port
argument_list|)
expr_stmt|;
operator|*
name|addrcount
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
block|}
ifdef|#
directive|ifdef
name|USE_GETADDRINFO
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_ipv6
condition|)
name|hints
operator|.
name|ai_family
operator|=
name|PF_INET
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|have_ipv4
condition|)
name|hints
operator|.
name|ai_family
operator|=
name|PF_INET6
expr_stmt|;
else|else
block|{
name|hints
operator|.
name|ai_family
operator|=
name|PF_UNSPEC
expr_stmt|;
ifdef|#
directive|ifdef
name|AI_ADDRCONFIG
name|hints
operator|.
name|ai_flags
operator|=
name|AI_ADDRCONFIG
expr_stmt|;
endif|#
directive|endif
block|}
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_STREAM
expr_stmt|;
ifdef|#
directive|ifdef
name|AI_ADDRCONFIG
name|again
label|:
endif|#
directive|endif
name|result
operator|=
name|getaddrinfo
argument_list|(
name|hostname
argument_list|,
name|NULL
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|ai
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
literal|0
case|:
break|break;
case|case
name|EAI_NONAME
case|:
if|#
directive|if
name|defined
argument_list|(
name|EAI_NODATA
argument_list|)
operator|&&
operator|(
name|EAI_NODATA
operator|!=
name|EAI_NONAME
operator|)
case|case
name|EAI_NODATA
case|:
endif|#
directive|endif
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
ifdef|#
directive|ifdef
name|AI_ADDRCONFIG
case|case
name|EAI_BADFLAGS
case|:
if|if
condition|(
operator|(
name|hints
operator|.
name|ai_flags
operator|&
name|AI_ADDRCONFIG
operator|)
operator|!=
literal|0
condition|)
block|{
name|hints
operator|.
name|ai_flags
operator|&=
operator|~
name|AI_ADDRCONFIG
expr_stmt|;
goto|goto
name|again
goto|;
block|}
endif|#
directive|endif
default|default:
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
for|for
control|(
name|tmpai
operator|=
name|ai
operator|,
name|i
operator|=
literal|0
init|;
name|tmpai
operator|!=
name|NULL
operator|&&
name|i
operator|<
name|addrsize
condition|;
name|tmpai
operator|=
name|tmpai
operator|->
name|ai_next
control|)
block|{
if|if
condition|(
name|tmpai
operator|->
name|ai_family
operator|!=
name|AF_INET
operator|&&
name|tmpai
operator|->
name|ai_family
operator|!=
name|AF_INET6
condition|)
continue|continue;
if|if
condition|(
name|tmpai
operator|->
name|ai_family
operator|==
name|AF_INET
condition|)
block|{
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|tmpai
operator|->
name|ai_addr
expr_stmt|;
name|isc_sockaddr_fromin
argument_list|(
operator|&
name|addrs
index|[
name|i
index|]
argument_list|,
operator|&
name|sin
operator|->
name|sin_addr
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|tmpai
operator|->
name|ai_addr
expr_stmt|;
name|isc_sockaddr_fromin6
argument_list|(
operator|&
name|addrs
index|[
name|i
index|]
argument_list|,
operator|&
name|sin6
operator|->
name|sin6_addr
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
name|i
operator|++
expr_stmt|;
block|}
name|freeaddrinfo
argument_list|(
name|ai
argument_list|)
expr_stmt|;
operator|*
name|addrcount
operator|=
name|i
expr_stmt|;
else|#
directive|else
name|he
operator|=
name|gethostbyname
argument_list|(
name|hostname
argument_list|)
expr_stmt|;
if|if
condition|(
name|he
operator|==
name|NULL
condition|)
block|{
switch|switch
condition|(
name|h_errno
condition|)
block|{
case|case
name|HOST_NOT_FOUND
case|:
ifdef|#
directive|ifdef
name|NO_DATA
case|case
name|NO_DATA
case|:
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|NO_ADDRESS
argument_list|)
operator|&&
operator|(
operator|!
name|defined
argument_list|(
name|NO_DATA
argument_list|)
operator|||
operator|(
name|NO_DATA
operator|!=
name|NO_ADDRESS
operator|)
operator|)
case|case
name|NO_ADDRESS
case|:
endif|#
directive|endif
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
default|default:
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
block|}
if|if
condition|(
name|he
operator|->
name|h_addrtype
operator|!=
name|AF_INET
operator|&&
name|he
operator|->
name|h_addrtype
operator|!=
name|AF_INET6
condition|)
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|addrsize
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|he
operator|->
name|h_addrtype
operator|==
name|AF_INET
condition|)
block|{
name|struct
name|in_addr
modifier|*
name|inp
decl_stmt|;
name|inp
operator|=
operator|(
expr|struct
name|in_addr
operator|*
operator|)
operator|(
name|he
operator|->
name|h_addr_list
index|[
name|i
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|inp
operator|==
name|NULL
condition|)
break|break;
name|isc_sockaddr_fromin
argument_list|(
operator|&
name|addrs
index|[
name|i
index|]
argument_list|,
name|inp
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|in6_addr
modifier|*
name|in6p
decl_stmt|;
name|in6p
operator|=
operator|(
expr|struct
name|in6_addr
operator|*
operator|)
operator|(
name|he
operator|->
name|h_addr_list
index|[
name|i
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|in6p
operator|==
name|NULL
condition|)
break|break;
name|isc_sockaddr_fromin6
argument_list|(
operator|&
name|addrs
index|[
name|i
index|]
argument_list|,
name|in6p
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
block|}
operator|*
name|addrcount
operator|=
name|i
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|*
name|addrcount
operator|==
literal|0
condition|)
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
else|else
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2009, 2010  Internet Systems Consortium, Inc. ("ISC")  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: tsec.c,v 1.7 2010-12-09 00:54:34 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<dns/tsec.h>
end_include

begin_include
include|#
directive|include
file|<dns/tsig.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dst/dst.h>
end_include

begin_define
define|#
directive|define
name|DNS_TSEC_MAGIC
value|ISC_MAGIC('T', 's', 'e', 'c')
end_define

begin_define
define|#
directive|define
name|DNS_TSEC_VALID
parameter_list|(
name|t
parameter_list|)
value|ISC_MAGIC_VALID(t, DNS_TSEC_MAGIC)
end_define

begin_comment
comment|/*%  * DNS Transaction Security object.  We assume this is not shared by  * multiple threads, and so the structure does not contain a lock.  */
end_comment

begin_struct
struct|struct
name|dns_tsec
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|dns_tsectype_t
name|type
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
union|union
block|{
name|dns_tsigkey_t
modifier|*
name|tsigkey
decl_stmt|;
name|dst_key_t
modifier|*
name|key
decl_stmt|;
block|}
name|ukey
union|;
block|}
struct|;
end_struct

begin_function
name|isc_result_t
name|dns_tsec_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_tsectype_t
name|type
parameter_list|,
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|dns_tsec_t
modifier|*
modifier|*
name|tsecp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_tsec_t
modifier|*
name|tsec
decl_stmt|;
name|dns_tsigkey_t
modifier|*
name|tsigkey
init|=
name|NULL
decl_stmt|;
name|dns_name_t
modifier|*
name|algname
decl_stmt|;
name|REQUIRE
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|tsecp
operator|!=
name|NULL
operator|&&
operator|*
name|tsecp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tsec
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tsec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsec
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|tsec
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|tsec
operator|->
name|mctx
operator|=
name|mctx
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|dns_tsectype_tsig
case|:
switch|switch
condition|(
name|dst_key_alg
argument_list|(
name|key
argument_list|)
condition|)
block|{
case|case
name|DST_ALG_HMACMD5
case|:
name|algname
operator|=
name|dns_tsig_hmacmd5_name
expr_stmt|;
break|break;
case|case
name|DST_ALG_HMACSHA1
case|:
name|algname
operator|=
name|dns_tsig_hmacsha1_name
expr_stmt|;
break|break;
case|case
name|DST_ALG_HMACSHA224
case|:
name|algname
operator|=
name|dns_tsig_hmacsha224_name
expr_stmt|;
break|break;
case|case
name|DST_ALG_HMACSHA256
case|:
name|algname
operator|=
name|dns_tsig_hmacsha256_name
expr_stmt|;
break|break;
case|case
name|DST_ALG_HMACSHA384
case|:
name|algname
operator|=
name|dns_tsig_hmacsha384_name
expr_stmt|;
break|break;
case|case
name|DST_ALG_HMACSHA512
case|:
name|algname
operator|=
name|dns_tsig_hmacsha512_name
expr_stmt|;
break|break;
default|default:
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|tsec
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tsec
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_BADALG
operator|)
return|;
block|}
name|result
operator|=
name|dns_tsigkey_createfromkey
argument_list|(
name|dst_key_name
argument_list|(
name|key
argument_list|)
argument_list|,
name|algname
argument_list|,
name|key
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|mctx
argument_list|,
name|NULL
argument_list|,
operator|&
name|tsigkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|tsec
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tsec
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|tsec
operator|->
name|ukey
operator|.
name|tsigkey
operator|=
name|tsigkey
expr_stmt|;
break|break;
case|case
name|dns_tsectype_sig0
case|:
name|tsec
operator|->
name|ukey
operator|.
name|key
operator|=
name|key
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|tsec
operator|->
name|magic
operator|=
name|DNS_TSEC_MAGIC
expr_stmt|;
operator|*
name|tsecp
operator|=
name|tsec
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_tsec_destroy
parameter_list|(
name|dns_tsec_t
modifier|*
modifier|*
name|tsecp
parameter_list|)
block|{
name|dns_tsec_t
modifier|*
name|tsec
decl_stmt|;
name|REQUIRE
argument_list|(
name|tsecp
operator|!=
name|NULL
operator|&&
operator|*
name|tsecp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tsec
operator|=
operator|*
name|tsecp
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_TSEC_VALID
argument_list|(
name|tsec
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|tsec
operator|->
name|type
condition|)
block|{
case|case
name|dns_tsectype_tsig
case|:
name|dns_tsigkey_detach
argument_list|(
operator|&
name|tsec
operator|->
name|ukey
operator|.
name|tsigkey
argument_list|)
expr_stmt|;
break|break;
case|case
name|dns_tsectype_sig0
case|:
name|dst_key_free
argument_list|(
operator|&
name|tsec
operator|->
name|ukey
operator|.
name|key
argument_list|)
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|tsec
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|tsec
operator|->
name|mctx
argument_list|,
name|tsec
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tsec
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|tsecp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|dns_tsectype_t
name|dns_tsec_gettype
parameter_list|(
name|dns_tsec_t
modifier|*
name|tsec
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_TSEC_VALID
argument_list|(
name|tsec
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|tsec
operator|->
name|type
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_tsec_getkey
parameter_list|(
name|dns_tsec_t
modifier|*
name|tsec
parameter_list|,
name|void
modifier|*
name|keyp
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_TSEC_VALID
argument_list|(
name|tsec
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|keyp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|tsec
operator|->
name|type
condition|)
block|{
case|case
name|dns_tsectype_tsig
case|:
name|dns_tsigkey_attach
argument_list|(
name|tsec
operator|->
name|ukey
operator|.
name|tsigkey
argument_list|,
operator|(
name|dns_tsigkey_t
operator|*
operator|*
operator|)
name|keyp
argument_list|)
expr_stmt|;
break|break;
case|case
name|dns_tsectype_sig0
case|:
operator|*
operator|(
name|dst_key_t
operator|*
operator|*
operator|)
name|keyp
operator|=
name|tsec
operator|->
name|ukey
operator|.
name|key
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


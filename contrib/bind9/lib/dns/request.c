begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004, 2006  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 2000-2002  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: request.c,v 1.64.2.1.10.9 2006/08/21 00:50:48 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/magic.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/timer.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/acl.h>
end_include

begin_include
include|#
directive|include
file|<dns/compress.h>
end_include

begin_include
include|#
directive|include
file|<dns/dispatch.h>
end_include

begin_include
include|#
directive|include
file|<dns/events.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/message.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdata.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatastruct.h>
end_include

begin_include
include|#
directive|include
file|<dns/request.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/tsig.h>
end_include

begin_define
define|#
directive|define
name|REQUESTMGR_MAGIC
value|ISC_MAGIC('R', 'q', 'u', 'M')
end_define

begin_define
define|#
directive|define
name|VALID_REQUESTMGR
parameter_list|(
name|mgr
parameter_list|)
value|ISC_MAGIC_VALID(mgr, REQUESTMGR_MAGIC)
end_define

begin_define
define|#
directive|define
name|REQUEST_MAGIC
value|ISC_MAGIC('R', 'q', 'u', '!')
end_define

begin_define
define|#
directive|define
name|VALID_REQUEST
parameter_list|(
name|request
parameter_list|)
value|ISC_MAGIC_VALID(request, REQUEST_MAGIC)
end_define

begin_typedef
typedef|typedef
name|ISC_LIST
argument_list|(
argument|dns_request_t
argument_list|)
name|dns_requestlist_t
expr_stmt|;
end_typedef

begin_define
define|#
directive|define
name|DNS_REQUEST_NLOCKS
value|7
end_define

begin_struct
struct|struct
name|dns_requestmgr
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
comment|/* locked */
name|isc_int32_t
name|eref
decl_stmt|;
name|isc_int32_t
name|iref
decl_stmt|;
name|isc_timermgr_t
modifier|*
name|timermgr
decl_stmt|;
name|isc_socketmgr_t
modifier|*
name|socketmgr
decl_stmt|;
name|isc_taskmgr_t
modifier|*
name|taskmgr
decl_stmt|;
name|dns_dispatchmgr_t
modifier|*
name|dispatchmgr
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|dispatchv4
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|dispatchv6
decl_stmt|;
name|isc_boolean_t
name|exiting
decl_stmt|;
name|isc_eventlist_t
name|whenshutdown
decl_stmt|;
name|unsigned
name|int
name|hash
decl_stmt|;
name|isc_mutex_t
name|locks
index|[
name|DNS_REQUEST_NLOCKS
index|]
decl_stmt|;
name|dns_requestlist_t
name|requests
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|dns_request
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|unsigned
name|int
name|hash
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|isc_int32_t
name|flags
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|dns_request_t
argument_list|)
name|link
expr_stmt|;
name|isc_buffer_t
modifier|*
name|query
decl_stmt|;
name|isc_buffer_t
modifier|*
name|answer
decl_stmt|;
name|dns_requestevent_t
modifier|*
name|event
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|dispatch
decl_stmt|;
name|dns_dispentry_t
modifier|*
name|dispentry
decl_stmt|;
name|isc_timer_t
modifier|*
name|timer
decl_stmt|;
name|dns_requestmgr_t
modifier|*
name|requestmgr
decl_stmt|;
name|isc_buffer_t
modifier|*
name|tsig
decl_stmt|;
name|dns_tsigkey_t
modifier|*
name|tsigkey
decl_stmt|;
name|isc_event_t
name|ctlevent
decl_stmt|;
name|isc_boolean_t
name|canceling
decl_stmt|;
comment|/* ctlevent outstanding */
name|isc_sockaddr_t
name|destaddr
decl_stmt|;
name|unsigned
name|int
name|udpcount
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|DNS_REQUEST_F_CONNECTING
value|0x0001
end_define

begin_define
define|#
directive|define
name|DNS_REQUEST_F_SENDING
value|0x0002
end_define

begin_define
define|#
directive|define
name|DNS_REQUEST_F_CANCELED
value|0x0004
end_define

begin_comment
comment|/* ctlevent received, or otherwise 					   synchronously canceled */
end_comment

begin_define
define|#
directive|define
name|DNS_REQUEST_F_TIMEDOUT
value|0x0008
end_define

begin_comment
comment|/* cancelled due to a timeout */
end_comment

begin_define
define|#
directive|define
name|DNS_REQUEST_F_TCP
value|0x0010
end_define

begin_comment
comment|/* This request used TCP */
end_comment

begin_define
define|#
directive|define
name|DNS_REQUEST_CANCELED
parameter_list|(
name|r
parameter_list|)
define|\
value|(((r)->flags& DNS_REQUEST_F_CANCELED) != 0)
end_define

begin_define
define|#
directive|define
name|DNS_REQUEST_CONNECTING
parameter_list|(
name|r
parameter_list|)
define|\
value|(((r)->flags& DNS_REQUEST_F_CONNECTING) != 0)
end_define

begin_define
define|#
directive|define
name|DNS_REQUEST_SENDING
parameter_list|(
name|r
parameter_list|)
define|\
value|(((r)->flags& DNS_REQUEST_F_SENDING) != 0)
end_define

begin_define
define|#
directive|define
name|DNS_REQUEST_TIMEDOUT
parameter_list|(
name|r
parameter_list|)
define|\
value|(((r)->flags& DNS_REQUEST_F_TIMEDOUT) != 0)
end_define

begin_comment
comment|/***  *** Forward  ***/
end_comment

begin_function_decl
specifier|static
name|void
name|mgr_destroy
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mgr_shutdown
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|unsigned
name|int
name|mgr_gethash
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|send_shutdown_events
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|req_render
parameter_list|(
name|dns_message_t
modifier|*
name|message
parameter_list|,
name|isc_buffer_t
modifier|*
modifier|*
name|buffer
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|req_senddone
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|req_response
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|req_timeout
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|req_connected
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|req_sendevent
parameter_list|(
name|dns_request_t
modifier|*
name|request
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|req_cancel
parameter_list|(
name|dns_request_t
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|req_destroy
parameter_list|(
name|dns_request_t
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|req_log
parameter_list|(
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|2
operator|,
function_decl|3
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_function_decl
specifier|static
name|void
name|do_cancel
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/***  *** Public  ***/
end_comment

begin_function
name|isc_result_t
name|dns_requestmgr_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_timermgr_t
modifier|*
name|timermgr
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|socketmgr
parameter_list|,
name|isc_taskmgr_t
modifier|*
name|taskmgr
parameter_list|,
name|dns_dispatchmgr_t
modifier|*
name|dispatchmgr
parameter_list|,
name|dns_dispatch_t
modifier|*
name|dispatchv4
parameter_list|,
name|dns_dispatch_t
modifier|*
name|dispatchv6
parameter_list|,
name|dns_requestmgr_t
modifier|*
modifier|*
name|requestmgrp
parameter_list|)
block|{
name|dns_requestmgr_t
modifier|*
name|requestmgr
decl_stmt|;
name|isc_socket_t
modifier|*
name|socket
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|int
name|i
decl_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_requestmgr_create"
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|requestmgrp
operator|!=
name|NULL
operator|&&
operator|*
name|requestmgrp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|timermgr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|socketmgr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|taskmgr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|dispatchmgr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dispatchv4
operator|!=
name|NULL
condition|)
block|{
name|socket
operator|=
name|dns_dispatch_getsocket
argument_list|(
name|dispatchv4
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|isc_socket_gettype
argument_list|(
name|socket
argument_list|)
operator|==
name|isc_sockettype_udp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dispatchv6
operator|!=
name|NULL
condition|)
block|{
name|socket
operator|=
name|dns_dispatch_getsocket
argument_list|(
name|dispatchv6
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|isc_socket_gettype
argument_list|(
name|socket
argument_list|)
operator|==
name|isc_sockettype_udp
argument_list|)
expr_stmt|;
block|}
name|requestmgr
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|requestmgr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|requestmgr
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|requestmgr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|requestmgr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DNS_REQUEST_NLOCKS
condition|;
name|i
operator|++
control|)
block|{
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|requestmgr
operator|->
name|locks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
name|DESTROYLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|locks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|requestmgr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|requestmgr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
name|requestmgr
operator|->
name|timermgr
operator|=
name|timermgr
expr_stmt|;
name|requestmgr
operator|->
name|socketmgr
operator|=
name|socketmgr
expr_stmt|;
name|requestmgr
operator|->
name|taskmgr
operator|=
name|taskmgr
expr_stmt|;
name|requestmgr
operator|->
name|dispatchmgr
operator|=
name|dispatchmgr
expr_stmt|;
name|requestmgr
operator|->
name|dispatchv4
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|dispatchv4
operator|!=
name|NULL
condition|)
name|dns_dispatch_attach
argument_list|(
name|dispatchv4
argument_list|,
operator|&
name|requestmgr
operator|->
name|dispatchv4
argument_list|)
expr_stmt|;
name|requestmgr
operator|->
name|dispatchv6
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|dispatchv6
operator|!=
name|NULL
condition|)
name|dns_dispatch_attach
argument_list|(
name|dispatchv6
argument_list|,
operator|&
name|requestmgr
operator|->
name|dispatchv6
argument_list|)
expr_stmt|;
name|requestmgr
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|requestmgr
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|requestmgr
operator|->
name|eref
operator|=
literal|1
expr_stmt|;
comment|/* implict attach */
name|requestmgr
operator|->
name|iref
operator|=
literal|0
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|requestmgr
operator|->
name|whenshutdown
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|requestmgr
operator|->
name|requests
argument_list|)
expr_stmt|;
name|requestmgr
operator|->
name|exiting
operator|=
name|ISC_FALSE
expr_stmt|;
name|requestmgr
operator|->
name|hash
operator|=
literal|0
expr_stmt|;
name|requestmgr
operator|->
name|magic
operator|=
name|REQUESTMGR_MAGIC
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_requestmgr_create: %p"
argument_list|,
name|requestmgr
argument_list|)
expr_stmt|;
operator|*
name|requestmgrp
operator|=
name|requestmgr
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_requestmgr_whenshutdown
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
modifier|*
name|eventp
parameter_list|)
block|{
name|isc_task_t
modifier|*
name|clone
decl_stmt|;
name|isc_event_t
modifier|*
name|event
decl_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_requestmgr_whenshutdown"
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUESTMGR
argument_list|(
name|requestmgr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|eventp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|event
operator|=
operator|*
name|eventp
expr_stmt|;
operator|*
name|eventp
operator|=
name|NULL
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|requestmgr
operator|->
name|exiting
condition|)
block|{
comment|/* 		 * We're already shutdown.  Send the event. 		 */
name|event
operator|->
name|ev_sender
operator|=
name|requestmgr
expr_stmt|;
name|isc_task_send
argument_list|(
name|task
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|clone
operator|=
name|NULL
expr_stmt|;
name|isc_task_attach
argument_list|(
name|task
argument_list|,
operator|&
name|clone
argument_list|)
expr_stmt|;
name|event
operator|->
name|ev_sender
operator|=
name|clone
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|requestmgr
operator|->
name|whenshutdown
argument_list|,
name|event
argument_list|,
name|ev_link
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_requestmgr_shutdown
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_REQUESTMGR
argument_list|(
name|requestmgr
argument_list|)
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_requestmgr_shutdown: %p"
argument_list|,
name|requestmgr
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mgr_shutdown
argument_list|(
name|requestmgr
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mgr_shutdown
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|)
block|{
name|dns_request_t
modifier|*
name|request
decl_stmt|;
comment|/* 	 * Caller holds lock. 	 */
if|if
condition|(
operator|!
name|requestmgr
operator|->
name|exiting
condition|)
block|{
name|requestmgr
operator|->
name|exiting
operator|=
name|ISC_TRUE
expr_stmt|;
for|for
control|(
name|request
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|requestmgr
operator|->
name|requests
argument_list|)
init|;
name|request
operator|!=
name|NULL
condition|;
name|request
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|request
argument_list|,
name|link
argument_list|)
control|)
block|{
name|dns_request_cancel
argument_list|(
name|request
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|requestmgr
operator|->
name|iref
operator|==
literal|0
condition|)
block|{
name|INSIST
argument_list|(
name|ISC_LIST_EMPTY
argument_list|(
name|requestmgr
operator|->
name|requests
argument_list|)
argument_list|)
expr_stmt|;
name|send_shutdown_events
argument_list|(
name|requestmgr
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|requestmgr_attach
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|source
parameter_list|,
name|dns_requestmgr_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
comment|/* 	 * Locked by caller. 	 */
name|REQUIRE
argument_list|(
name|VALID_REQUESTMGR
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|targetp
operator|!=
name|NULL
operator|&&
operator|*
name|targetp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|!
name|source
operator|->
name|exiting
argument_list|)
expr_stmt|;
name|source
operator|->
name|iref
operator|++
expr_stmt|;
operator|*
name|targetp
operator|=
name|source
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"requestmgr_attach: %p: eref %d iref %d"
argument_list|,
name|source
argument_list|,
name|source
operator|->
name|eref
argument_list|,
name|source
operator|->
name|iref
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|requestmgr_detach
parameter_list|(
name|dns_requestmgr_t
modifier|*
modifier|*
name|requestmgrp
parameter_list|)
block|{
name|dns_requestmgr_t
modifier|*
name|requestmgr
decl_stmt|;
name|isc_boolean_t
name|need_destroy
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|requestmgrp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|requestmgr
operator|=
operator|*
name|requestmgrp
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUESTMGR
argument_list|(
name|requestmgr
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|requestmgrp
operator|=
name|NULL
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|requestmgr
operator|->
name|iref
operator|>
literal|0
argument_list|)
expr_stmt|;
name|requestmgr
operator|->
name|iref
operator|--
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"requestmgr_detach: %p: eref %d iref %d"
argument_list|,
name|requestmgr
argument_list|,
name|requestmgr
operator|->
name|eref
argument_list|,
name|requestmgr
operator|->
name|iref
argument_list|)
expr_stmt|;
if|if
condition|(
name|requestmgr
operator|->
name|iref
operator|==
literal|0
operator|&&
name|requestmgr
operator|->
name|exiting
condition|)
block|{
name|INSIST
argument_list|(
name|ISC_LIST_HEAD
argument_list|(
name|requestmgr
operator|->
name|requests
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|send_shutdown_events
argument_list|(
name|requestmgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|requestmgr
operator|->
name|eref
operator|==
literal|0
condition|)
name|need_destroy
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_destroy
condition|)
name|mgr_destroy
argument_list|(
name|requestmgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_requestmgr_attach
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|source
parameter_list|,
name|dns_requestmgr_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_REQUESTMGR
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|targetp
operator|!=
name|NULL
operator|&&
operator|*
name|targetp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|!
name|source
operator|->
name|exiting
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|source
operator|->
name|lock
argument_list|)
expr_stmt|;
name|source
operator|->
name|eref
operator|++
expr_stmt|;
operator|*
name|targetp
operator|=
name|source
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|source
operator|->
name|lock
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_requestmgr_attach: %p: eref %d iref %d"
argument_list|,
name|source
argument_list|,
name|source
operator|->
name|eref
argument_list|,
name|source
operator|->
name|iref
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_requestmgr_detach
parameter_list|(
name|dns_requestmgr_t
modifier|*
modifier|*
name|requestmgrp
parameter_list|)
block|{
name|dns_requestmgr_t
modifier|*
name|requestmgr
decl_stmt|;
name|isc_boolean_t
name|need_destroy
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|requestmgrp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|requestmgr
operator|=
operator|*
name|requestmgrp
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUESTMGR
argument_list|(
name|requestmgr
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|requestmgr
operator|->
name|eref
operator|>
literal|0
argument_list|)
expr_stmt|;
name|requestmgr
operator|->
name|eref
operator|--
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_requestmgr_detach: %p: eref %d iref %d"
argument_list|,
name|requestmgr
argument_list|,
name|requestmgr
operator|->
name|eref
argument_list|,
name|requestmgr
operator|->
name|iref
argument_list|)
expr_stmt|;
if|if
condition|(
name|requestmgr
operator|->
name|eref
operator|==
literal|0
operator|&&
name|requestmgr
operator|->
name|iref
operator|==
literal|0
condition|)
block|{
name|INSIST
argument_list|(
name|requestmgr
operator|->
name|exiting
operator|&&
name|ISC_LIST_HEAD
argument_list|(
name|requestmgr
operator|->
name|requests
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|need_destroy
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_destroy
condition|)
name|mgr_destroy
argument_list|(
name|requestmgr
argument_list|)
expr_stmt|;
operator|*
name|requestmgrp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|send_shutdown_events
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|)
block|{
name|isc_event_t
modifier|*
name|event
decl_stmt|,
modifier|*
name|next_event
decl_stmt|;
name|isc_task_t
modifier|*
name|etask
decl_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"send_shutdown_events: %p"
argument_list|,
name|requestmgr
argument_list|)
expr_stmt|;
comment|/* 	 * Caller must be holding the manager lock. 	 */
for|for
control|(
name|event
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|requestmgr
operator|->
name|whenshutdown
argument_list|)
init|;
name|event
operator|!=
name|NULL
condition|;
name|event
operator|=
name|next_event
control|)
block|{
name|next_event
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|event
argument_list|,
name|ev_link
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|requestmgr
operator|->
name|whenshutdown
argument_list|,
name|event
argument_list|,
name|ev_link
argument_list|)
expr_stmt|;
name|etask
operator|=
name|event
operator|->
name|ev_sender
expr_stmt|;
name|event
operator|->
name|ev_sender
operator|=
name|requestmgr
expr_stmt|;
name|isc_task_sendanddetach
argument_list|(
operator|&
name|etask
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mgr_destroy
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"mgr_destroy"
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|requestmgr
operator|->
name|eref
operator|==
literal|0
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|requestmgr
operator|->
name|iref
operator|==
literal|0
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DNS_REQUEST_NLOCKS
condition|;
name|i
operator|++
control|)
name|DESTROYLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|locks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|requestmgr
operator|->
name|dispatchv4
operator|!=
name|NULL
condition|)
name|dns_dispatch_detach
argument_list|(
operator|&
name|requestmgr
operator|->
name|dispatchv4
argument_list|)
expr_stmt|;
if|if
condition|(
name|requestmgr
operator|->
name|dispatchv6
operator|!=
name|NULL
condition|)
name|dns_dispatch_detach
argument_list|(
operator|&
name|requestmgr
operator|->
name|dispatchv6
argument_list|)
expr_stmt|;
name|requestmgr
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|mctx
operator|=
name|requestmgr
operator|->
name|mctx
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|requestmgr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|requestmgr
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|mgr_gethash
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|)
block|{
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"mgr_gethash"
argument_list|)
expr_stmt|;
comment|/* 	 * Locked by caller. 	 */
name|requestmgr
operator|->
name|hash
operator|++
expr_stmt|;
return|return
operator|(
name|requestmgr
operator|->
name|hash
operator|%
name|DNS_REQUEST_NLOCKS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_result_t
name|req_send
parameter_list|(
name|dns_request_t
modifier|*
name|request
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|address
parameter_list|)
block|{
name|isc_region_t
name|r
decl_stmt|;
name|isc_socket_t
modifier|*
name|socket
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"req_send: request %p"
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUEST
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|socket
operator|=
name|dns_dispatch_getsocket
argument_list|(
name|request
operator|->
name|dispatch
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
name|request
operator|->
name|query
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_socket_sendto
argument_list|(
name|socket
argument_list|,
operator|&
name|r
argument_list|,
name|task
argument_list|,
name|req_senddone
argument_list|,
name|request
argument_list|,
name|address
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|request
operator|->
name|flags
operator||=
name|DNS_REQUEST_F_SENDING
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|new_request
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_request_t
modifier|*
modifier|*
name|requestp
parameter_list|)
block|{
name|dns_request_t
modifier|*
name|request
decl_stmt|;
name|request
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
comment|/* 	 * Zero structure. 	 */
name|request
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|request
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|request
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|request
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|request
operator|->
name|query
operator|=
name|NULL
expr_stmt|;
name|request
operator|->
name|answer
operator|=
name|NULL
expr_stmt|;
name|request
operator|->
name|event
operator|=
name|NULL
expr_stmt|;
name|request
operator|->
name|dispatch
operator|=
name|NULL
expr_stmt|;
name|request
operator|->
name|dispentry
operator|=
name|NULL
expr_stmt|;
name|request
operator|->
name|timer
operator|=
name|NULL
expr_stmt|;
name|request
operator|->
name|requestmgr
operator|=
name|NULL
expr_stmt|;
name|request
operator|->
name|tsig
operator|=
name|NULL
expr_stmt|;
name|request
operator|->
name|tsigkey
operator|=
name|NULL
expr_stmt|;
name|ISC_EVENT_INIT
argument_list|(
operator|&
name|request
operator|->
name|ctlevent
argument_list|,
sizeof|sizeof
argument_list|(
name|request
operator|->
name|ctlevent
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|DNS_EVENT_REQUESTCONTROL
argument_list|,
name|do_cancel
argument_list|,
name|request
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|request
operator|->
name|canceling
operator|=
name|ISC_FALSE
expr_stmt|;
name|request
operator|->
name|udpcount
operator|=
literal|0
expr_stmt|;
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|request
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|request
operator|->
name|magic
operator|=
name|REQUEST_MAGIC
expr_stmt|;
operator|*
name|requestp
operator|=
name|request
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|isblackholed
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|dispatchmgr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|)
block|{
name|dns_acl_t
modifier|*
name|blackhole
decl_stmt|;
name|isc_netaddr_t
name|netaddr
decl_stmt|;
name|int
name|match
decl_stmt|;
name|isc_boolean_t
name|drop
init|=
name|ISC_FALSE
decl_stmt|;
name|char
name|netaddrstr
index|[
name|ISC_NETADDR_FORMATSIZE
index|]
decl_stmt|;
name|blackhole
operator|=
name|dns_dispatchmgr_getblackhole
argument_list|(
name|dispatchmgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|blackhole
operator|!=
name|NULL
condition|)
block|{
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|netaddr
argument_list|,
name|destaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_acl_match
argument_list|(
operator|&
name|netaddr
argument_list|,
name|NULL
argument_list|,
name|blackhole
argument_list|,
name|NULL
argument_list|,
operator|&
name|match
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_SUCCESS
operator|&&
name|match
operator|>
literal|0
condition|)
name|drop
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|drop
condition|)
block|{
name|isc_netaddr_format
argument_list|(
operator|&
name|netaddr
argument_list|,
name|netaddrstr
argument_list|,
sizeof|sizeof
argument_list|(
name|netaddrstr
argument_list|)
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|10
argument_list|)
argument_list|,
literal|"blackholed address %s"
argument_list|,
name|netaddrstr
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|drop
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|create_tcp_dispatch
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|,
name|dns_dispatch_t
modifier|*
modifier|*
name|dispatchp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_socket_t
modifier|*
name|socket
init|=
name|NULL
decl_stmt|;
name|isc_sockaddr_t
name|src
decl_stmt|;
name|unsigned
name|int
name|attrs
decl_stmt|;
name|isc_sockaddr_t
name|bind_any
decl_stmt|;
name|result
operator|=
name|isc_socket_create
argument_list|(
name|requestmgr
operator|->
name|socketmgr
argument_list|,
name|isc_sockaddr_pf
argument_list|(
name|destaddr
argument_list|)
argument_list|,
name|isc_sockettype_tcp
argument_list|,
operator|&
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
ifndef|#
directive|ifndef
name|BROKEN_TCP_BIND_BEFORE_CONNECT
if|if
condition|(
name|srcaddr
operator|==
name|NULL
condition|)
block|{
name|isc_sockaddr_anyofpf
argument_list|(
operator|&
name|bind_any
argument_list|,
name|isc_sockaddr_pf
argument_list|(
name|destaddr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_socket_bind
argument_list|(
name|socket
argument_list|,
operator|&
name|bind_any
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|src
operator|=
operator|*
name|srcaddr
expr_stmt|;
name|isc_sockaddr_setport
argument_list|(
operator|&
name|src
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_socket_bind
argument_list|(
name|socket
argument_list|,
operator|&
name|src
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
endif|#
directive|endif
name|attrs
operator|=
literal|0
expr_stmt|;
name|attrs
operator||=
name|DNS_DISPATCHATTR_TCP
expr_stmt|;
name|attrs
operator||=
name|DNS_DISPATCHATTR_PRIVATE
expr_stmt|;
if|if
condition|(
name|isc_sockaddr_pf
argument_list|(
name|destaddr
argument_list|)
operator|==
name|AF_INET
condition|)
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV4
expr_stmt|;
else|else
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV6
expr_stmt|;
name|attrs
operator||=
name|DNS_DISPATCHATTR_MAKEQUERY
expr_stmt|;
name|result
operator|=
name|dns_dispatch_createtcp
argument_list|(
name|requestmgr
operator|->
name|dispatchmgr
argument_list|,
name|socket
argument_list|,
name|requestmgr
operator|->
name|taskmgr
argument_list|,
literal|4096
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
name|attrs
argument_list|,
name|dispatchp
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|isc_socket_detach
argument_list|(
operator|&
name|socket
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|find_udp_dispatch
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|,
name|dns_dispatch_t
modifier|*
modifier|*
name|dispatchp
parameter_list|)
block|{
name|dns_dispatch_t
modifier|*
name|disp
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|attrs
decl_stmt|,
name|attrmask
decl_stmt|;
if|if
condition|(
name|srcaddr
operator|==
name|NULL
condition|)
block|{
switch|switch
condition|(
name|isc_sockaddr_pf
argument_list|(
name|destaddr
argument_list|)
condition|)
block|{
case|case
name|PF_INET
case|:
name|disp
operator|=
name|requestmgr
operator|->
name|dispatchv4
expr_stmt|;
break|break;
case|case
name|PF_INET6
case|:
name|disp
operator|=
name|requestmgr
operator|->
name|dispatchv6
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
if|if
condition|(
name|disp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_FAMILYNOSUPPORT
operator|)
return|;
name|dns_dispatch_attach
argument_list|(
name|disp
argument_list|,
name|dispatchp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
name|attrs
operator|=
literal|0
expr_stmt|;
name|attrs
operator||=
name|DNS_DISPATCHATTR_UDP
expr_stmt|;
switch|switch
condition|(
name|isc_sockaddr_pf
argument_list|(
name|srcaddr
argument_list|)
condition|)
block|{
case|case
name|PF_INET
case|:
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV4
expr_stmt|;
break|break;
case|case
name|PF_INET6
case|:
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV6
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
name|attrmask
operator|=
literal|0
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_UDP
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_TCP
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_IPV4
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_IPV6
expr_stmt|;
return|return
operator|(
name|dns_dispatch_getudp
argument_list|(
name|requestmgr
operator|->
name|dispatchmgr
argument_list|,
name|requestmgr
operator|->
name|socketmgr
argument_list|,
name|requestmgr
operator|->
name|taskmgr
argument_list|,
name|srcaddr
argument_list|,
literal|4096
argument_list|,
literal|1000
argument_list|,
literal|32768
argument_list|,
literal|16411
argument_list|,
literal|16433
argument_list|,
name|attrs
argument_list|,
name|attrmask
argument_list|,
name|dispatchp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|get_dispatch
parameter_list|(
name|isc_boolean_t
name|tcp
parameter_list|,
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|,
name|dns_dispatch_t
modifier|*
modifier|*
name|dispatchp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|tcp
condition|)
name|result
operator|=
name|create_tcp_dispatch
argument_list|(
name|requestmgr
argument_list|,
name|srcaddr
argument_list|,
name|destaddr
argument_list|,
name|dispatchp
argument_list|)
expr_stmt|;
else|else
name|result
operator|=
name|find_udp_dispatch
argument_list|(
name|requestmgr
argument_list|,
name|srcaddr
argument_list|,
name|destaddr
argument_list|,
name|dispatchp
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|set_timer
parameter_list|(
name|isc_timer_t
modifier|*
name|timer
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|,
name|unsigned
name|int
name|udpresend
parameter_list|)
block|{
name|isc_time_t
name|expires
decl_stmt|;
name|isc_interval_t
name|interval
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_timertype_t
name|timertype
decl_stmt|;
name|isc_interval_set
argument_list|(
operator|&
name|interval
argument_list|,
name|timeout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_time_nowplusinterval
argument_list|(
operator|&
name|expires
argument_list|,
operator|&
name|interval
argument_list|)
expr_stmt|;
name|isc_interval_set
argument_list|(
operator|&
name|interval
argument_list|,
name|udpresend
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|timertype
operator|=
name|udpresend
operator|!=
literal|0
condition|?
name|isc_timertype_limited
else|:
name|isc_timertype_once
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|isc_timer_reset
argument_list|(
name|timer
argument_list|,
name|timertype
argument_list|,
operator|&
name|expires
argument_list|,
operator|&
name|interval
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_request_createraw
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|,
name|isc_buffer_t
modifier|*
name|msgbuf
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_request_t
modifier|*
modifier|*
name|requestp
parameter_list|)
block|{
return|return
operator|(
name|dns_request_createraw3
argument_list|(
name|requestmgr
argument_list|,
name|msgbuf
argument_list|,
name|srcaddr
argument_list|,
name|destaddr
argument_list|,
name|options
argument_list|,
name|timeout
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|task
argument_list|,
name|action
argument_list|,
name|arg
argument_list|,
name|requestp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_request_createraw2
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|,
name|isc_buffer_t
modifier|*
name|msgbuf
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|,
name|unsigned
name|int
name|udptimeout
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_request_t
modifier|*
modifier|*
name|requestp
parameter_list|)
block|{
name|unsigned
name|int
name|udpretries
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|udptimeout
operator|!=
literal|0
condition|)
name|udpretries
operator|=
name|timeout
operator|/
name|udptimeout
expr_stmt|;
return|return
operator|(
name|dns_request_createraw3
argument_list|(
name|requestmgr
argument_list|,
name|msgbuf
argument_list|,
name|srcaddr
argument_list|,
name|destaddr
argument_list|,
name|options
argument_list|,
name|timeout
argument_list|,
name|udptimeout
argument_list|,
name|udpretries
argument_list|,
name|task
argument_list|,
name|action
argument_list|,
name|arg
argument_list|,
name|requestp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_request_createraw3
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|,
name|isc_buffer_t
modifier|*
name|msgbuf
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|,
name|unsigned
name|int
name|udptimeout
parameter_list|,
name|unsigned
name|int
name|udpretries
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_request_t
modifier|*
modifier|*
name|requestp
parameter_list|)
block|{
name|dns_request_t
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|isc_task_t
modifier|*
name|tclone
init|=
name|NULL
decl_stmt|;
name|isc_socket_t
modifier|*
name|socket
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_messageid_t
name|id
decl_stmt|;
name|isc_boolean_t
name|tcp
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUESTMGR
argument_list|(
name|requestmgr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msgbuf
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|destaddr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|task
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|action
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|requestp
operator|!=
name|NULL
operator|&&
operator|*
name|requestp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|timeout
operator|>
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|srcaddr
operator|!=
name|NULL
condition|)
name|REQUIRE
argument_list|(
name|isc_sockaddr_pf
argument_list|(
name|srcaddr
argument_list|)
operator|==
name|isc_sockaddr_pf
argument_list|(
name|destaddr
argument_list|)
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|requestmgr
operator|->
name|mctx
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_request_createraw"
argument_list|)
expr_stmt|;
if|if
condition|(
name|isblackholed
argument_list|(
name|requestmgr
operator|->
name|dispatchmgr
argument_list|,
name|destaddr
argument_list|)
condition|)
return|return
operator|(
name|DNS_R_BLACKHOLED
operator|)
return|;
name|request
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|new_request
argument_list|(
name|mctx
argument_list|,
operator|&
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|udptimeout
operator|==
literal|0
operator|&&
name|udpretries
operator|!=
literal|0
condition|)
block|{
name|udptimeout
operator|=
name|timeout
operator|/
operator|(
name|udpretries
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|udptimeout
operator|==
literal|0
condition|)
name|udptimeout
operator|=
literal|1
expr_stmt|;
block|}
name|request
operator|->
name|udpcount
operator|=
name|udpretries
expr_stmt|;
comment|/* 	 * Create timer now.  We will set it below once. 	 */
name|result
operator|=
name|isc_timer_create
argument_list|(
name|requestmgr
operator|->
name|timermgr
argument_list|,
name|isc_timertype_inactive
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|task
argument_list|,
name|req_timeout
argument_list|,
name|request
argument_list|,
operator|&
name|request
operator|->
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|request
operator|->
name|event
operator|=
operator|(
name|dns_requestevent_t
operator|*
operator|)
name|isc_event_allocate
argument_list|(
name|mctx
argument_list|,
name|task
argument_list|,
name|DNS_EVENT_REQUESTDONE
argument_list|,
name|action
argument_list|,
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_requestevent_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|event
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|isc_task_attach
argument_list|(
name|task
argument_list|,
operator|&
name|tclone
argument_list|)
expr_stmt|;
name|request
operator|->
name|event
operator|->
name|ev_sender
operator|=
name|task
expr_stmt|;
name|request
operator|->
name|event
operator|->
name|request
operator|=
name|request
expr_stmt|;
name|request
operator|->
name|event
operator|->
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
name|msgbuf
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|<
name|DNS_MESSAGE_HEADERLEN
operator|||
name|r
operator|.
name|length
operator|>
literal|65535
condition|)
block|{
name|result
operator|=
name|DNS_R_FORMERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
operator|(
name|options
operator|&
name|DNS_REQUESTOPT_TCP
operator|)
operator|!=
literal|0
operator|||
name|r
operator|.
name|length
operator|>
literal|512
condition|)
name|tcp
operator|=
name|ISC_TRUE
expr_stmt|;
name|result
operator|=
name|get_dispatch
argument_list|(
name|tcp
argument_list|,
name|requestmgr
argument_list|,
name|srcaddr
argument_list|,
name|destaddr
argument_list|,
operator|&
name|request
operator|->
name|dispatch
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|socket
operator|=
name|dns_dispatch_getsocket
argument_list|(
name|request
operator|->
name|dispatch
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|socket
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dispatch_addresponse
argument_list|(
name|request
operator|->
name|dispatch
argument_list|,
name|destaddr
argument_list|,
name|task
argument_list|,
name|req_response
argument_list|,
name|request
argument_list|,
operator|&
name|id
argument_list|,
operator|&
name|request
operator|->
name|dispentry
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
operator|&
name|request
operator|->
name|query
argument_list|,
name|r
operator|.
name|length
operator|+
operator|(
name|tcp
condition|?
literal|2
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|tcp
condition|)
name|isc_buffer_putuint16
argument_list|(
name|request
operator|->
name|query
argument_list|,
operator|(
name|isc_uint16_t
operator|)
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_buffer_copyregion
argument_list|(
name|request
operator|->
name|query
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
comment|/* Add message ID. */
name|isc_buffer_usedregion
argument_list|(
name|request
operator|->
name|query
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
condition|)
name|isc_region_consume
argument_list|(
operator|&
name|r
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|r
operator|.
name|base
index|[
literal|0
index|]
operator|=
operator|(
name|id
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|r
operator|.
name|base
index|[
literal|1
index|]
operator|=
name|id
operator|&
literal|0xff
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|requestmgr
operator|->
name|exiting
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SHUTTINGDOWN
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|requestmgr_attach
argument_list|(
name|requestmgr
argument_list|,
operator|&
name|request
operator|->
name|requestmgr
argument_list|)
expr_stmt|;
name|request
operator|->
name|hash
operator|=
name|mgr_gethash
argument_list|(
name|requestmgr
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|requestmgr
operator|->
name|requests
argument_list|,
name|request
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|result
operator|=
name|set_timer
argument_list|(
name|request
operator|->
name|timer
argument_list|,
name|timeout
argument_list|,
name|tcp
condition|?
literal|0
else|:
name|udptimeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|unlink
goto|;
name|request
operator|->
name|destaddr
operator|=
operator|*
name|destaddr
expr_stmt|;
if|if
condition|(
name|tcp
condition|)
block|{
name|result
operator|=
name|isc_socket_connect
argument_list|(
name|socket
argument_list|,
name|destaddr
argument_list|,
name|task
argument_list|,
name|req_connected
argument_list|,
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|unlink
goto|;
name|request
operator|->
name|flags
operator||=
name|DNS_REQUEST_F_CONNECTING
operator||
name|DNS_REQUEST_F_TCP
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|req_send
argument_list|(
name|request
argument_list|,
name|task
argument_list|,
name|destaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|unlink
goto|;
block|}
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_request_createraw: request %p"
argument_list|,
name|request
argument_list|)
expr_stmt|;
operator|*
name|requestp
operator|=
name|request
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|unlink
label|:
name|LOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|requestmgr
operator|->
name|requests
argument_list|,
name|request
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|tclone
operator|!=
name|NULL
condition|)
name|isc_task_detach
argument_list|(
operator|&
name|tclone
argument_list|)
expr_stmt|;
name|req_destroy
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_request_createraw: failed %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_request_create
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|,
name|dns_message_t
modifier|*
name|message
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|address
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|dns_tsigkey_t
modifier|*
name|key
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_request_t
modifier|*
modifier|*
name|requestp
parameter_list|)
block|{
return|return
operator|(
name|dns_request_createvia3
argument_list|(
name|requestmgr
argument_list|,
name|message
argument_list|,
name|NULL
argument_list|,
name|address
argument_list|,
name|options
argument_list|,
name|key
argument_list|,
name|timeout
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|task
argument_list|,
name|action
argument_list|,
name|arg
argument_list|,
name|requestp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_request_createvia
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|,
name|dns_message_t
modifier|*
name|message
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|dns_tsigkey_t
modifier|*
name|key
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_request_t
modifier|*
modifier|*
name|requestp
parameter_list|)
block|{
return|return
operator|(
name|dns_request_createvia3
argument_list|(
name|requestmgr
argument_list|,
name|message
argument_list|,
name|srcaddr
argument_list|,
name|destaddr
argument_list|,
name|options
argument_list|,
name|key
argument_list|,
name|timeout
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|task
argument_list|,
name|action
argument_list|,
name|arg
argument_list|,
name|requestp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_request_createvia2
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|,
name|dns_message_t
modifier|*
name|message
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|dns_tsigkey_t
modifier|*
name|key
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|,
name|unsigned
name|int
name|udptimeout
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_request_t
modifier|*
modifier|*
name|requestp
parameter_list|)
block|{
name|unsigned
name|int
name|udpretries
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|udptimeout
operator|!=
literal|0
condition|)
name|udpretries
operator|=
name|timeout
operator|/
name|udptimeout
expr_stmt|;
return|return
operator|(
name|dns_request_createvia3
argument_list|(
name|requestmgr
argument_list|,
name|message
argument_list|,
name|srcaddr
argument_list|,
name|destaddr
argument_list|,
name|options
argument_list|,
name|key
argument_list|,
name|timeout
argument_list|,
name|udptimeout
argument_list|,
name|udpretries
argument_list|,
name|task
argument_list|,
name|action
argument_list|,
name|arg
argument_list|,
name|requestp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_request_createvia3
parameter_list|(
name|dns_requestmgr_t
modifier|*
name|requestmgr
parameter_list|,
name|dns_message_t
modifier|*
name|message
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|srcaddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|destaddr
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|dns_tsigkey_t
modifier|*
name|key
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|,
name|unsigned
name|int
name|udptimeout
parameter_list|,
name|unsigned
name|int
name|udpretries
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_request_t
modifier|*
modifier|*
name|requestp
parameter_list|)
block|{
name|dns_request_t
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|isc_task_t
modifier|*
name|tclone
init|=
name|NULL
decl_stmt|;
name|isc_socket_t
modifier|*
name|socket
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_messageid_t
name|id
decl_stmt|;
name|isc_boolean_t
name|tcp
decl_stmt|;
name|isc_boolean_t
name|setkey
init|=
name|ISC_TRUE
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUESTMGR
argument_list|(
name|requestmgr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|message
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|destaddr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|task
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|action
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|requestp
operator|!=
name|NULL
operator|&&
operator|*
name|requestp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|timeout
operator|>
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|srcaddr
operator|!=
name|NULL
condition|)
name|REQUIRE
argument_list|(
name|isc_sockaddr_pf
argument_list|(
name|srcaddr
argument_list|)
operator|==
name|isc_sockaddr_pf
argument_list|(
name|destaddr
argument_list|)
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|requestmgr
operator|->
name|mctx
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_request_createvia"
argument_list|)
expr_stmt|;
if|if
condition|(
name|isblackholed
argument_list|(
name|requestmgr
operator|->
name|dispatchmgr
argument_list|,
name|destaddr
argument_list|)
condition|)
return|return
operator|(
name|DNS_R_BLACKHOLED
operator|)
return|;
name|request
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|new_request
argument_list|(
name|mctx
argument_list|,
operator|&
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|udptimeout
operator|==
literal|0
operator|&&
name|udpretries
operator|!=
literal|0
condition|)
block|{
name|udptimeout
operator|=
name|timeout
operator|/
operator|(
name|udpretries
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|udptimeout
operator|==
literal|0
condition|)
name|udptimeout
operator|=
literal|1
expr_stmt|;
block|}
name|request
operator|->
name|udpcount
operator|=
name|udpretries
expr_stmt|;
comment|/* 	 * Create timer now.  We will set it below once. 	 */
name|result
operator|=
name|isc_timer_create
argument_list|(
name|requestmgr
operator|->
name|timermgr
argument_list|,
name|isc_timertype_inactive
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|task
argument_list|,
name|req_timeout
argument_list|,
name|request
argument_list|,
operator|&
name|request
operator|->
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|request
operator|->
name|event
operator|=
operator|(
name|dns_requestevent_t
operator|*
operator|)
name|isc_event_allocate
argument_list|(
name|mctx
argument_list|,
name|task
argument_list|,
name|DNS_EVENT_REQUESTDONE
argument_list|,
name|action
argument_list|,
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_requestevent_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|event
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|isc_task_attach
argument_list|(
name|task
argument_list|,
operator|&
name|tclone
argument_list|)
expr_stmt|;
name|request
operator|->
name|event
operator|->
name|ev_sender
operator|=
name|task
expr_stmt|;
name|request
operator|->
name|event
operator|->
name|request
operator|=
name|request
expr_stmt|;
name|request
operator|->
name|event
operator|->
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
if|if
condition|(
name|key
operator|!=
name|NULL
condition|)
name|dns_tsigkey_attach
argument_list|(
name|key
argument_list|,
operator|&
name|request
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
name|use_tcp
label|:
name|tcp
operator|=
name|ISC_TF
argument_list|(
operator|(
name|options
operator|&
name|DNS_REQUESTOPT_TCP
operator|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|get_dispatch
argument_list|(
name|tcp
argument_list|,
name|requestmgr
argument_list|,
name|srcaddr
argument_list|,
name|destaddr
argument_list|,
operator|&
name|request
operator|->
name|dispatch
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|socket
operator|=
name|dns_dispatch_getsocket
argument_list|(
name|request
operator|->
name|dispatch
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|socket
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dispatch_addresponse
argument_list|(
name|request
operator|->
name|dispatch
argument_list|,
name|destaddr
argument_list|,
name|task
argument_list|,
name|req_response
argument_list|,
name|request
argument_list|,
operator|&
name|id
argument_list|,
operator|&
name|request
operator|->
name|dispentry
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|message
operator|->
name|id
operator|=
name|id
expr_stmt|;
if|if
condition|(
name|setkey
condition|)
block|{
name|result
operator|=
name|dns_message_settsigkey
argument_list|(
name|message
argument_list|,
name|request
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
name|result
operator|=
name|req_render
argument_list|(
name|message
argument_list|,
operator|&
name|request
operator|->
name|query
argument_list|,
name|options
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_USETCP
operator|&&
operator|(
name|options
operator|&
name|DNS_REQUESTOPT_TCP
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Try again using TCP. 		 */
name|dns_message_renderreset
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|dns_dispatch_removeresponse
argument_list|(
operator|&
name|request
operator|->
name|dispentry
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_dispatch_detach
argument_list|(
operator|&
name|request
operator|->
name|dispatch
argument_list|)
expr_stmt|;
name|socket
operator|=
name|NULL
expr_stmt|;
name|options
operator||=
name|DNS_REQUESTOPT_TCP
expr_stmt|;
name|setkey
operator|=
name|ISC_FALSE
expr_stmt|;
goto|goto
name|use_tcp
goto|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_message_getquerytsig
argument_list|(
name|message
argument_list|,
name|mctx
argument_list|,
operator|&
name|request
operator|->
name|tsig
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|LOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|requestmgr
operator|->
name|exiting
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SHUTTINGDOWN
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|requestmgr_attach
argument_list|(
name|requestmgr
argument_list|,
operator|&
name|request
operator|->
name|requestmgr
argument_list|)
expr_stmt|;
name|request
operator|->
name|hash
operator|=
name|mgr_gethash
argument_list|(
name|requestmgr
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|requestmgr
operator|->
name|requests
argument_list|,
name|request
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|result
operator|=
name|set_timer
argument_list|(
name|request
operator|->
name|timer
argument_list|,
name|timeout
argument_list|,
name|tcp
condition|?
literal|0
else|:
name|udptimeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|unlink
goto|;
name|request
operator|->
name|destaddr
operator|=
operator|*
name|destaddr
expr_stmt|;
if|if
condition|(
name|tcp
condition|)
block|{
name|result
operator|=
name|isc_socket_connect
argument_list|(
name|socket
argument_list|,
name|destaddr
argument_list|,
name|task
argument_list|,
name|req_connected
argument_list|,
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|unlink
goto|;
name|request
operator|->
name|flags
operator||=
name|DNS_REQUEST_F_CONNECTING
operator||
name|DNS_REQUEST_F_TCP
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|req_send
argument_list|(
name|request
argument_list|,
name|task
argument_list|,
name|destaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|unlink
goto|;
block|}
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_request_createvia: request %p"
argument_list|,
name|request
argument_list|)
expr_stmt|;
operator|*
name|requestp
operator|=
name|request
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|unlink
label|:
name|LOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|requestmgr
operator|->
name|requests
argument_list|,
name|request
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|tclone
operator|!=
name|NULL
condition|)
name|isc_task_detach
argument_list|(
operator|&
name|tclone
argument_list|)
expr_stmt|;
name|req_destroy
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_request_createvia: failed %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|req_render
parameter_list|(
name|dns_message_t
modifier|*
name|message
parameter_list|,
name|isc_buffer_t
modifier|*
modifier|*
name|bufferp
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|)
block|{
name|isc_buffer_t
modifier|*
name|buf1
init|=
name|NULL
decl_stmt|;
name|isc_buffer_t
modifier|*
name|buf2
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|isc_boolean_t
name|tcp
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_compress_t
name|cctx
decl_stmt|;
name|isc_boolean_t
name|cleanup_cctx
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|bufferp
operator|!=
name|NULL
operator|&&
operator|*
name|bufferp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"request_render"
argument_list|)
expr_stmt|;
comment|/* 	 * Create buffer able to hold largest possible message. 	 */
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
operator|&
name|buf1
argument_list|,
literal|65535
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_compress_init
argument_list|(
operator|&
name|cctx
argument_list|,
operator|-
literal|1
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|cleanup_cctx
operator|=
name|ISC_TRUE
expr_stmt|;
comment|/* 	 * Render message. 	 */
name|result
operator|=
name|dns_message_renderbegin
argument_list|(
name|message
argument_list|,
operator|&
name|cctx
argument_list|,
name|buf1
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_message_rendersection
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_message_rendersection
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_message_rendersection
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_message_rendersection
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_ADDITIONAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_message_renderend
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|dns_compress_invalidate
argument_list|(
operator|&
name|cctx
argument_list|)
expr_stmt|;
name|cleanup_cctx
operator|=
name|ISC_FALSE
expr_stmt|;
comment|/* 	 * Copy rendered message to exact sized buffer. 	 */
name|isc_buffer_usedregion
argument_list|(
name|buf1
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|options
operator|&
name|DNS_REQUESTOPT_TCP
operator|)
operator|!=
literal|0
condition|)
block|{
name|tcp
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|r
operator|.
name|length
operator|>
literal|512
condition|)
block|{
name|result
operator|=
name|DNS_R_USETCP
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
operator|&
name|buf2
argument_list|,
name|r
operator|.
name|length
operator|+
operator|(
name|tcp
condition|?
literal|2
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|tcp
condition|)
name|isc_buffer_putuint16
argument_list|(
name|buf2
argument_list|,
operator|(
name|isc_uint16_t
operator|)
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_buffer_copyregion
argument_list|(
name|buf2
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
comment|/* 	 * Cleanup and return. 	 */
name|isc_buffer_free
argument_list|(
operator|&
name|buf1
argument_list|)
expr_stmt|;
operator|*
name|bufferp
operator|=
name|buf2
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
name|dns_message_renderreset
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf1
operator|!=
name|NULL
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|buf1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf2
operator|!=
name|NULL
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|buf2
argument_list|)
expr_stmt|;
if|if
condition|(
name|cleanup_cctx
condition|)
name|dns_compress_invalidate
argument_list|(
operator|&
name|cctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * If this request is no longer waiting for events,  * send the completion event.  This will ultimately  * cause the request to be destroyed.  *  * Requires:  *	'request' is locked by the caller.  */
end_comment

begin_function
specifier|static
name|void
name|send_if_done
parameter_list|(
name|dns_request_t
modifier|*
name|request
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
block|{
if|if
condition|(
operator|!
name|DNS_REQUEST_CONNECTING
argument_list|(
name|request
argument_list|)
operator|&&
operator|!
name|DNS_REQUEST_SENDING
argument_list|(
name|request
argument_list|)
operator|&&
operator|!
name|request
operator|->
name|canceling
condition|)
name|req_sendevent
argument_list|(
name|request
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Handle the control event.  */
end_comment

begin_function
specifier|static
name|void
name|do_cancel
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_request_t
modifier|*
name|request
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_REQUESTCONTROL
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
name|request
operator|->
name|canceling
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
operator|!
name|DNS_REQUEST_CANCELED
argument_list|(
name|request
argument_list|)
condition|)
name|req_cancel
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|send_if_done
argument_list|(
name|request
argument_list|,
name|ISC_R_CANCELED
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_request_cancel
parameter_list|(
name|dns_request_t
modifier|*
name|request
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_REQUEST
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_request_cancel: request %p"
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUEST
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|request
operator|->
name|canceling
operator|&&
operator|!
name|DNS_REQUEST_CANCELED
argument_list|(
name|request
argument_list|)
condition|)
block|{
name|isc_event_t
modifier|*
name|ev
init|=
operator|&
name|request
operator|->
name|ctlevent
decl_stmt|;
name|isc_task_send
argument_list|(
name|request
operator|->
name|event
operator|->
name|ev_sender
argument_list|,
operator|&
name|ev
argument_list|)
expr_stmt|;
name|request
operator|->
name|canceling
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_request_getresponse
parameter_list|(
name|dns_request_t
modifier|*
name|request
parameter_list|,
name|dns_message_t
modifier|*
name|message
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUEST
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|request
operator|->
name|answer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_request_getresponse: request %p"
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_setquerytsig
argument_list|(
name|message
argument_list|,
name|request
operator|->
name|tsig
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_message_settsigkey
argument_list|(
name|message
argument_list|,
name|request
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_message_parse
argument_list|(
name|message
argument_list|,
name|request
operator|->
name|answer
argument_list|,
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|request
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
name|result
operator|=
name|dns_tsig_verify
argument_list|(
name|request
operator|->
name|answer
argument_list|,
name|message
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_boolean_t
name|dns_request_usedtcp
parameter_list|(
name|dns_request_t
modifier|*
name|request
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_REQUEST
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_TF
argument_list|(
operator|(
name|request
operator|->
name|flags
operator|&
name|DNS_REQUEST_F_TCP
operator|)
operator|!=
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_request_destroy
parameter_list|(
name|dns_request_t
modifier|*
modifier|*
name|requestp
parameter_list|)
block|{
name|dns_request_t
modifier|*
name|request
decl_stmt|;
name|REQUIRE
argument_list|(
name|requestp
operator|!=
name|NULL
operator|&&
name|VALID_REQUEST
argument_list|(
operator|*
name|requestp
argument_list|)
argument_list|)
expr_stmt|;
name|request
operator|=
operator|*
name|requestp
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_request_destroy: request %p"
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|request
operator|->
name|requestmgr
operator|->
name|requests
argument_list|,
name|request
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|DNS_REQUEST_CONNECTING
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|DNS_REQUEST_SENDING
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* 	 * These should have been cleaned up by req_cancel() before 	 * the completion event was sent. 	 */
name|INSIST
argument_list|(
operator|!
name|ISC_LINK_LINKED
argument_list|(
name|request
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|request
operator|->
name|dispentry
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|request
operator|->
name|dispatch
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|request
operator|->
name|timer
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|req_destroy
argument_list|(
name|request
argument_list|)
expr_stmt|;
operator|*
name|requestp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/***  *** Private: request.  ***/
end_comment

begin_function
specifier|static
name|void
name|req_connected
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_socketevent_t
modifier|*
name|sevent
init|=
operator|(
name|isc_socketevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_request_t
modifier|*
name|request
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|ISC_SOCKEVENT_CONNECT
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUEST
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_REQUEST_CONNECTING
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"req_connected: request %p"
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
name|request
operator|->
name|flags
operator|&=
operator|~
name|DNS_REQUEST_F_CONNECTING
expr_stmt|;
if|if
condition|(
name|DNS_REQUEST_CANCELED
argument_list|(
name|request
argument_list|)
condition|)
block|{
comment|/* 		 * Send delayed event. 		 */
if|if
condition|(
name|DNS_REQUEST_TIMEDOUT
argument_list|(
name|request
argument_list|)
condition|)
name|send_if_done
argument_list|(
name|request
argument_list|,
name|ISC_R_TIMEDOUT
argument_list|)
expr_stmt|;
else|else
name|send_if_done
argument_list|(
name|request
argument_list|,
name|ISC_R_CANCELED
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dns_dispatch_starttcp
argument_list|(
name|request
operator|->
name|dispatch
argument_list|)
expr_stmt|;
name|result
operator|=
name|sevent
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|req_send
argument_list|(
name|request
argument_list|,
name|task
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|req_cancel
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|send_if_done
argument_list|(
name|request
argument_list|,
name|ISC_R_CANCELED
argument_list|)
expr_stmt|;
block|}
block|}
name|UNLOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|req_senddone
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_socketevent_t
modifier|*
name|sevent
init|=
operator|(
name|isc_socketevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|dns_request_t
modifier|*
name|request
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|ISC_SOCKEVENT_SENDDONE
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUEST
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_REQUEST_SENDING
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"req_senddone: request %p"
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
name|request
operator|->
name|flags
operator|&=
operator|~
name|DNS_REQUEST_F_SENDING
expr_stmt|;
if|if
condition|(
name|DNS_REQUEST_CANCELED
argument_list|(
name|request
argument_list|)
condition|)
block|{
comment|/* 		 * Send delayed event. 		 */
if|if
condition|(
name|DNS_REQUEST_TIMEDOUT
argument_list|(
name|request
argument_list|)
condition|)
name|send_if_done
argument_list|(
name|request
argument_list|,
name|ISC_R_TIMEDOUT
argument_list|)
expr_stmt|;
else|else
name|send_if_done
argument_list|(
name|request
argument_list|,
name|ISC_R_CANCELED
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sevent
operator|->
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|req_cancel
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|send_if_done
argument_list|(
name|request
argument_list|,
name|ISC_R_CANCELED
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|req_response
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_request_t
modifier|*
name|request
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|dns_dispatchevent_t
modifier|*
name|devent
init|=
operator|(
name|dns_dispatchevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUEST
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_DISPATCH
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"req_response: request %p: %s"
argument_list|,
name|request
argument_list|,
name|dns_result_totext
argument_list|(
name|devent
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
name|result
operator|=
name|devent
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|done
goto|;
comment|/* 	 * Copy buffer to request. 	 */
name|isc_buffer_usedregion
argument_list|(
operator|&
name|devent
operator|->
name|buffer
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|request
operator|->
name|mctx
argument_list|,
operator|&
name|request
operator|->
name|answer
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|done
goto|;
name|result
operator|=
name|isc_buffer_copyregion
argument_list|(
name|request
operator|->
name|answer
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|request
operator|->
name|answer
argument_list|)
expr_stmt|;
name|done
label|:
comment|/* 	 * Cleanup. 	 */
name|dns_dispatch_removeresponse
argument_list|(
operator|&
name|request
operator|->
name|dispentry
argument_list|,
operator|&
name|devent
argument_list|)
expr_stmt|;
name|req_cancel
argument_list|(
name|request
argument_list|)
expr_stmt|;
comment|/* 	 * Send completion event. 	 */
name|send_if_done
argument_list|(
name|request
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|req_timeout
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_request_t
modifier|*
name|request
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUEST
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"req_timeout: request %p"
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|->
name|ev_type
operator|==
name|ISC_TIMEREVENT_TICK
operator|&&
name|request
operator|->
name|udpcount
operator|--
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|DNS_REQUEST_SENDING
argument_list|(
name|request
argument_list|)
condition|)
block|{
name|result
operator|=
name|req_send
argument_list|(
name|request
argument_list|,
name|task
argument_list|,
operator|&
name|request
operator|->
name|destaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|req_cancel
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|send_if_done
argument_list|(
name|request
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|request
operator|->
name|flags
operator||=
name|DNS_REQUEST_F_TIMEDOUT
expr_stmt|;
name|req_cancel
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|send_if_done
argument_list|(
name|request
argument_list|,
name|ISC_R_TIMEDOUT
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
operator|->
name|locks
index|[
name|request
operator|->
name|hash
index|]
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|req_sendevent
parameter_list|(
name|dns_request_t
modifier|*
name|request
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
block|{
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUEST
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"req_sendevent: request %p"
argument_list|,
name|request
argument_list|)
expr_stmt|;
comment|/* 	 * Lock held by caller. 	 */
name|task
operator|=
name|request
operator|->
name|event
operator|->
name|ev_sender
expr_stmt|;
name|request
operator|->
name|event
operator|->
name|ev_sender
operator|=
name|request
expr_stmt|;
name|request
operator|->
name|event
operator|->
name|result
operator|=
name|result
expr_stmt|;
name|isc_task_sendanddetach
argument_list|(
operator|&
name|task
argument_list|,
operator|(
name|isc_event_t
operator|*
operator|*
operator|)
operator|&
name|request
operator|->
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|req_destroy
parameter_list|(
name|dns_request_t
modifier|*
name|request
parameter_list|)
block|{
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUEST
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"req_destroy: request %p"
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|request
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|query
operator|!=
name|NULL
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|request
operator|->
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|answer
operator|!=
name|NULL
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|request
operator|->
name|answer
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|event
operator|!=
name|NULL
condition|)
name|isc_event_free
argument_list|(
operator|(
name|isc_event_t
operator|*
operator|*
operator|)
operator|&
name|request
operator|->
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|dispentry
operator|!=
name|NULL
condition|)
name|dns_dispatch_removeresponse
argument_list|(
operator|&
name|request
operator|->
name|dispentry
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|dispatch
operator|!=
name|NULL
condition|)
name|dns_dispatch_detach
argument_list|(
operator|&
name|request
operator|->
name|dispatch
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|timer
operator|!=
name|NULL
condition|)
name|isc_timer_detach
argument_list|(
operator|&
name|request
operator|->
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|tsig
operator|!=
name|NULL
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|request
operator|->
name|tsig
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
name|dns_tsigkey_detach
argument_list|(
operator|&
name|request
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|requestmgr
operator|!=
name|NULL
condition|)
name|requestmgr_detach
argument_list|(
operator|&
name|request
operator|->
name|requestmgr
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|request
operator|->
name|mctx
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|request
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Stop the current request.  Must be called from the request's task.  */
end_comment

begin_function
specifier|static
name|void
name|req_cancel
parameter_list|(
name|dns_request_t
modifier|*
name|request
parameter_list|)
block|{
name|isc_socket_t
modifier|*
name|socket
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_REQUEST
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|req_log
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"req_cancel: request %p"
argument_list|,
name|request
argument_list|)
expr_stmt|;
comment|/* 	 * Lock held by caller. 	 */
name|request
operator|->
name|flags
operator||=
name|DNS_REQUEST_F_CANCELED
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|timer
operator|!=
name|NULL
condition|)
name|isc_timer_detach
argument_list|(
operator|&
name|request
operator|->
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|dispentry
operator|!=
name|NULL
condition|)
name|dns_dispatch_removeresponse
argument_list|(
operator|&
name|request
operator|->
name|dispentry
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_REQUEST_CONNECTING
argument_list|(
name|request
argument_list|)
condition|)
block|{
name|socket
operator|=
name|dns_dispatch_getsocket
argument_list|(
name|request
operator|->
name|dispatch
argument_list|)
expr_stmt|;
name|isc_socket_cancel
argument_list|(
name|socket
argument_list|,
name|NULL
argument_list|,
name|ISC_SOCKCANCEL_CONNECT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|DNS_REQUEST_SENDING
argument_list|(
name|request
argument_list|)
condition|)
block|{
name|socket
operator|=
name|dns_dispatch_getsocket
argument_list|(
name|request
operator|->
name|dispatch
argument_list|)
expr_stmt|;
name|isc_socket_cancel
argument_list|(
name|socket
argument_list|,
name|NULL
argument_list|,
name|ISC_SOCKCANCEL_SEND
argument_list|)
expr_stmt|;
block|}
name|dns_dispatch_detach
argument_list|(
operator|&
name|request
operator|->
name|dispatch
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|req_log
parameter_list|(
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|isc_log_vwrite
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_GENERAL
argument_list|,
name|DNS_LOGMODULE_REQUEST
argument_list|,
name|level
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


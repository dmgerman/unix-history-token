begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 2000, 2001, 2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: sdb.c,v 1.35.12.8 2004/07/22 04:01:58 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_include
include|#
directive|include
file|<isc/lex.h>
end_include

begin_include
include|#
directive|include
file|<isc/log.h>
end_include

begin_include
include|#
directive|include
file|<isc/magic.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/once.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/region.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/callbacks.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/dbiterator.h>
end_include

begin_include
include|#
directive|include
file|<dns/fixedname.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdata.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatalist.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatasetiter.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatatype.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/sdb.h>
end_include

begin_include
include|#
directive|include
file|<dns/types.h>
end_include

begin_include
include|#
directive|include
file|"rdatalist_p.h"
end_include

begin_struct
struct|struct
name|dns_sdbimplementation
block|{
specifier|const
name|dns_sdbmethods_t
modifier|*
name|methods
decl_stmt|;
name|void
modifier|*
name|driverdata
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|isc_mutex_t
name|driverlock
decl_stmt|;
name|dns_dbimplementation_t
modifier|*
name|dbimp
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|dns_sdb
block|{
comment|/* Unlocked */
name|dns_db_t
name|common
decl_stmt|;
name|char
modifier|*
name|zone
decl_stmt|;
name|dns_sdbimplementation_t
modifier|*
name|implementation
decl_stmt|;
name|void
modifier|*
name|dbdata
decl_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
comment|/* Locked */
name|unsigned
name|int
name|references
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|dns_sdblookup
block|{
comment|/* Unlocked */
name|unsigned
name|int
name|magic
decl_stmt|;
name|dns_sdb_t
modifier|*
name|sdb
decl_stmt|;
name|ISC_LIST
argument_list|(
argument|dns_rdatalist_t
argument_list|)
name|lists
expr_stmt|;
name|ISC_LIST
argument_list|(
argument|isc_buffer_t
argument_list|)
name|buffers
expr_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|dns_sdblookup_t
argument_list|)
name|link
expr_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
name|dns_rdatacallbacks_t
name|callbacks
decl_stmt|;
comment|/* Locked */
name|unsigned
name|int
name|references
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|dns_sdblookup
name|dns_sdbnode_t
typedef|;
end_typedef

begin_struct
struct|struct
name|dns_sdballnodes
block|{
name|dns_dbiterator_t
name|common
decl_stmt|;
name|ISC_LIST
argument_list|(
argument|dns_sdbnode_t
argument_list|)
name|nodelist
expr_stmt|;
name|dns_sdbnode_t
modifier|*
name|current
decl_stmt|;
name|dns_sdbnode_t
modifier|*
name|origin
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|dns_sdballnodes_t
name|sdb_dbiterator_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|sdb_rdatasetiter
block|{
name|dns_rdatasetiter_t
name|common
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|current
decl_stmt|;
block|}
name|sdb_rdatasetiter_t
typedef|;
end_typedef

begin_define
define|#
directive|define
name|SDB_MAGIC
value|ISC_MAGIC('S', 'D', 'B', '-')
end_define

begin_comment
comment|/*  * Note that "impmagic" is not the first four bytes of the struct, so  * ISC_MAGIC_VALID cannot be used.  */
end_comment

begin_define
define|#
directive|define
name|VALID_SDB
parameter_list|(
name|sdb
parameter_list|)
value|((sdb) != NULL&& \ 				 (sdb)->common.impmagic == SDB_MAGIC)
end_define

begin_define
define|#
directive|define
name|SDBLOOKUP_MAGIC
value|ISC_MAGIC('S','D','B','L')
end_define

begin_define
define|#
directive|define
name|VALID_SDBLOOKUP
parameter_list|(
name|sdbl
parameter_list|)
value|ISC_MAGIC_VALID(sdbl, SDBLOOKUP_MAGIC)
end_define

begin_define
define|#
directive|define
name|VALID_SDBNODE
parameter_list|(
name|sdbn
parameter_list|)
value|VALID_SDBLOOKUP(sdbn)
end_define

begin_comment
comment|/* These values are taken from RFC 1537 */
end_comment

begin_define
define|#
directive|define
name|SDB_DEFAULT_REFRESH
value|(60 * 60 * 8)
end_define

begin_define
define|#
directive|define
name|SDB_DEFAULT_RETRY
value|(60 * 60 * 2)
end_define

begin_define
define|#
directive|define
name|SDB_DEFAULT_EXPIRE
value|(60 * 60 * 24 * 7)
end_define

begin_define
define|#
directive|define
name|SDB_DEFAULT_MINIMUM
value|(60 * 60 * 24)
end_define

begin_comment
comment|/* This is a reasonable value */
end_comment

begin_define
define|#
directive|define
name|SDB_DEFAULT_TTL
value|(60 * 60 * 24)
end_define

begin_define
define|#
directive|define
name|MAYBE_LOCK
parameter_list|(
name|sdb
parameter_list|)
define|\
value|do {								\ 		unsigned int flags = sdb->implementation->flags;	\ 		if ((flags& DNS_SDBFLAG_THREADSAFE) == 0)		\ 			LOCK(&sdb->implementation->driverlock);		\ 	} while (0)
end_define

begin_define
define|#
directive|define
name|MAYBE_UNLOCK
parameter_list|(
name|sdb
parameter_list|)
define|\
value|do {								\ 		unsigned int flags = sdb->implementation->flags;	\ 		if ((flags& DNS_SDBFLAG_THREADSAFE) == 0)		\ 			UNLOCK(&sdb->implementation->driverlock);	\ 	} while (0)
end_define

begin_decl_stmt
specifier|static
name|int
name|dummy
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|isc_result_t
name|dns_sdb_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_name_t
modifier|*
name|origin
parameter_list|,
name|dns_dbtype_t
name|type
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|unsigned
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|void
modifier|*
name|driverarg
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|dbp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|findrdataset
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|dns_rdatatype_t
name|covers
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdataset_t
modifier|*
name|sigrdataset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|createnode
parameter_list|(
name|dns_sdb_t
modifier|*
name|sdb
parameter_list|,
name|dns_sdbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|destroynode
parameter_list|(
name|dns_sdbnode_t
modifier|*
name|node
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|detachnode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|targetp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|list_tordataset
parameter_list|(
name|dns_rdatalist_t
modifier|*
name|rdatalist
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dbiterator_destroy
parameter_list|(
name|dns_dbiterator_t
modifier|*
modifier|*
name|iteratorp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_first
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_last
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_seek
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_prev
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_next
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_current
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_pause
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_origin
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|dns_dbiteratormethods_t
name|dbiterator_methods
init|=
block|{
name|dbiterator_destroy
block|,
name|dbiterator_first
block|,
name|dbiterator_last
block|,
name|dbiterator_seek
block|,
name|dbiterator_prev
block|,
name|dbiterator_next
block|,
name|dbiterator_current
block|,
name|dbiterator_pause
block|,
name|dbiterator_origin
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|rdatasetiter_destroy
parameter_list|(
name|dns_rdatasetiter_t
modifier|*
modifier|*
name|iteratorp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|rdatasetiter_first
parameter_list|(
name|dns_rdatasetiter_t
modifier|*
name|iterator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|rdatasetiter_next
parameter_list|(
name|dns_rdatasetiter_t
modifier|*
name|iterator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rdatasetiter_current
parameter_list|(
name|dns_rdatasetiter_t
modifier|*
name|iterator
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|dns_rdatasetitermethods_t
name|rdatasetiter_methods
init|=
block|{
name|rdatasetiter_destroy
block|,
name|rdatasetiter_first
block|,
name|rdatasetiter_next
block|,
name|rdatasetiter_current
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Functions used by implementors of simple databases  */
end_comment

begin_function
name|isc_result_t
name|dns_sdb_register
parameter_list|(
specifier|const
name|char
modifier|*
name|drivername
parameter_list|,
specifier|const
name|dns_sdbmethods_t
modifier|*
name|methods
parameter_list|,
name|void
modifier|*
name|driverdata
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_sdbimplementation_t
modifier|*
modifier|*
name|sdbimp
parameter_list|)
block|{
name|dns_sdbimplementation_t
modifier|*
name|imp
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|drivername
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|methods
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|methods
operator|->
name|lookup
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|sdbimp
operator|!=
name|NULL
operator|&&
operator|*
name|sdbimp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|(
name|flags
operator|&
operator|~
operator|(
name|DNS_SDBFLAG_RELATIVEOWNER
operator||
name|DNS_SDBFLAG_RELATIVERDATA
operator||
name|DNS_SDBFLAG_THREADSAFE
operator|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|imp
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdbimplementation_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|imp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|imp
operator|->
name|methods
operator|=
name|methods
expr_stmt|;
name|imp
operator|->
name|driverdata
operator|=
name|driverdata
expr_stmt|;
name|imp
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|imp
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|imp
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|imp
operator|->
name|driverlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"isc_mutex_init() failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup_mctx
goto|;
block|}
name|imp
operator|->
name|dbimp
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_db_register
argument_list|(
name|drivername
argument_list|,
name|dns_sdb_create
argument_list|,
name|imp
argument_list|,
name|mctx
argument_list|,
operator|&
name|imp
operator|->
name|dbimp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_mutex
goto|;
operator|*
name|sdbimp
operator|=
name|imp
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup_mutex
label|:
name|DESTROYLOCK
argument_list|(
operator|&
name|imp
operator|->
name|driverlock
argument_list|)
expr_stmt|;
name|cleanup_mctx
label|:
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|imp
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdbimplementation_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_sdb_unregister
parameter_list|(
name|dns_sdbimplementation_t
modifier|*
modifier|*
name|sdbimp
parameter_list|)
block|{
name|dns_sdbimplementation_t
modifier|*
name|imp
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|REQUIRE
argument_list|(
name|sdbimp
operator|!=
name|NULL
operator|&&
operator|*
name|sdbimp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|imp
operator|=
operator|*
name|sdbimp
expr_stmt|;
name|dns_db_unregister
argument_list|(
operator|&
name|imp
operator|->
name|dbimp
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|imp
operator|->
name|driverlock
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|imp
operator|->
name|mctx
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|imp
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdbimplementation_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
operator|*
name|sdbimp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|unsigned
name|int
name|initial_size
parameter_list|(
name|unsigned
name|int
name|len
parameter_list|)
block|{
name|unsigned
name|int
name|size
decl_stmt|;
for|for
control|(
name|size
operator|=
literal|64
init|;
name|size
operator|<
operator|(
literal|64
operator|*
literal|1024
operator|)
condition|;
name|size
operator|*=
literal|2
control|)
if|if
condition|(
name|len
operator|<
name|size
condition|)
return|return
operator|(
name|size
operator|)
return|;
return|return
operator|(
literal|64
operator|*
literal|1024
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_sdb_putrdata
parameter_list|(
name|dns_sdblookup_t
modifier|*
name|lookup
parameter_list|,
name|dns_rdatatype_t
name|typeval
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|rdatap
parameter_list|,
name|unsigned
name|int
name|rdlen
parameter_list|)
block|{
name|dns_rdatalist_t
modifier|*
name|rdatalist
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
decl_stmt|;
name|isc_buffer_t
modifier|*
name|rdatabuf
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|isc_region_t
name|region
decl_stmt|;
name|mctx
operator|=
name|lookup
operator|->
name|sdb
operator|->
name|common
operator|.
name|mctx
expr_stmt|;
name|rdatalist
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|lookup
operator|->
name|lists
argument_list|)
expr_stmt|;
while|while
condition|(
name|rdatalist
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|rdatalist
operator|->
name|type
operator|==
name|typeval
condition|)
break|break;
name|rdatalist
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|rdatalist
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdatalist
operator|==
name|NULL
condition|)
block|{
name|rdatalist
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdatalist_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdatalist
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|rdatalist
operator|->
name|rdclass
operator|=
name|lookup
operator|->
name|sdb
operator|->
name|common
operator|.
name|rdclass
expr_stmt|;
name|rdatalist
operator|->
name|type
operator|=
name|typeval
expr_stmt|;
name|rdatalist
operator|->
name|covers
operator|=
literal|0
expr_stmt|;
name|rdatalist
operator|->
name|ttl
operator|=
name|ttl
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|rdatalist
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|lookup
operator|->
name|lists
argument_list|,
name|rdatalist
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdatalist
operator|->
name|ttl
operator|!=
name|ttl
condition|)
return|return
operator|(
name|DNS_R_BADTTL
operator|)
return|;
name|rdata
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdata_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdata
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
operator|&
name|rdatabuf
argument_list|,
name|rdlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|failure
goto|;
name|DE_CONST
argument_list|(
name|rdatap
argument_list|,
name|region
operator|.
name|base
argument_list|)
expr_stmt|;
name|region
operator|.
name|length
operator|=
name|rdlen
expr_stmt|;
name|isc_buffer_copyregion
argument_list|(
name|rdatabuf
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
name|rdatabuf
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_fromregion
argument_list|(
name|rdata
argument_list|,
name|rdatalist
operator|->
name|rdclass
argument_list|,
name|rdatalist
operator|->
name|type
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|lookup
operator|->
name|buffers
argument_list|,
name|rdatabuf
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rdata
operator|=
name|NULL
expr_stmt|;
name|failure
label|:
if|if
condition|(
name|rdata
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|rdata
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdata_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_sdb_putrr
parameter_list|(
name|dns_sdblookup_t
modifier|*
name|lookup
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|)
block|{
name|unsigned
name|int
name|datalen
decl_stmt|;
name|dns_rdatatype_t
name|typeval
decl_stmt|;
name|isc_textregion_t
name|r
decl_stmt|;
name|isc_lex_t
modifier|*
name|lex
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|char
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|size
init|=
literal|0
decl_stmt|;
comment|/* Init to suppress compiler warning */
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_sdbimplementation_t
modifier|*
name|imp
decl_stmt|;
name|dns_name_t
modifier|*
name|origin
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_buffer_t
name|rb
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDBLOOKUP
argument_list|(
name|lookup
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|type
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|lookup
operator|->
name|sdb
operator|->
name|common
operator|.
name|mctx
expr_stmt|;
name|DE_CONST
argument_list|(
name|type
argument_list|,
name|r
operator|.
name|base
argument_list|)
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatatype_fromtext
argument_list|(
operator|&
name|typeval
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|imp
operator|=
name|lookup
operator|->
name|sdb
operator|->
name|implementation
expr_stmt|;
if|if
condition|(
operator|(
name|imp
operator|->
name|flags
operator|&
name|DNS_SDBFLAG_RELATIVERDATA
operator|)
operator|!=
literal|0
condition|)
name|origin
operator|=
operator|&
name|lookup
operator|->
name|sdb
operator|->
name|common
operator|.
name|origin
expr_stmt|;
else|else
name|origin
operator|=
name|dns_rootname
expr_stmt|;
name|result
operator|=
name|isc_lex_create
argument_list|(
name|mctx
argument_list|,
literal|64
argument_list|,
operator|&
name|lex
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|failure
goto|;
name|datalen
operator|=
name|strlen
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|size
operator|=
name|initial_size
argument_list|(
name|datalen
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_lex_openbuffer
argument_list|(
name|lex
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|failure
goto|;
name|p
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
name|isc_buffer_init
argument_list|(
operator|&
name|rb
argument_list|,
name|p
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_fromtext
argument_list|(
name|NULL
argument_list|,
name|lookup
operator|->
name|sdb
operator|->
name|common
operator|.
name|rdclass
argument_list|,
name|typeval
argument_list|,
name|lex
argument_list|,
name|origin
argument_list|,
literal|0
argument_list|,
name|mctx
argument_list|,
operator|&
name|rb
argument_list|,
operator|&
name|lookup
operator|->
name|callbacks
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOSPACE
condition|)
break|break;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|p
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
name|size
operator|*=
literal|2
expr_stmt|;
block|}
while|while
condition|(
name|result
operator|==
name|ISC_R_NOSPACE
condition|)
empty_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|failure
goto|;
name|result
operator|=
name|dns_sdb_putrdata
argument_list|(
name|lookup
argument_list|,
name|typeval
argument_list|,
name|ttl
argument_list|,
name|isc_buffer_base
argument_list|(
operator|&
name|rb
argument_list|)
argument_list|,
name|isc_buffer_usedlength
argument_list|(
operator|&
name|rb
argument_list|)
argument_list|)
expr_stmt|;
name|failure
label|:
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|p
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|lex
operator|!=
name|NULL
condition|)
name|isc_lex_destroy
argument_list|(
operator|&
name|lex
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|getnode
parameter_list|(
name|dns_sdballnodes_t
modifier|*
name|allnodes
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|dns_sdbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|)
block|{
name|dns_name_t
modifier|*
name|newname
decl_stmt|,
modifier|*
name|origin
decl_stmt|;
name|dns_fixedname_t
name|fnewname
decl_stmt|;
name|dns_sdb_t
modifier|*
name|sdb
init|=
operator|(
name|dns_sdb_t
operator|*
operator|)
name|allnodes
operator|->
name|common
operator|.
name|db
decl_stmt|;
name|dns_sdbimplementation_t
modifier|*
name|imp
init|=
name|sdb
operator|->
name|implementation
decl_stmt|;
name|dns_sdbnode_t
modifier|*
name|sdbnode
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
init|=
name|sdb
operator|->
name|common
operator|.
name|mctx
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fnewname
argument_list|)
expr_stmt|;
name|newname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fnewname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|imp
operator|->
name|flags
operator|&
name|DNS_SDBFLAG_RELATIVERDATA
operator|)
operator|!=
literal|0
condition|)
name|origin
operator|=
operator|&
name|sdb
operator|->
name|common
operator|.
name|origin
expr_stmt|;
else|else
name|origin
operator|=
name|dns_rootname
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|name
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|newname
argument_list|,
operator|&
name|b
argument_list|,
name|origin
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|allnodes
operator|->
name|common
operator|.
name|relative_names
condition|)
block|{
comment|/* All names are relative to the root */
name|unsigned
name|int
name|nlabels
init|=
name|dns_name_countlabels
argument_list|(
name|newname
argument_list|)
decl_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|newname
argument_list|,
literal|0
argument_list|,
name|nlabels
operator|-
literal|1
argument_list|,
name|newname
argument_list|)
expr_stmt|;
block|}
name|sdbnode
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|allnodes
operator|->
name|nodelist
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdbnode
operator|==
name|NULL
operator|||
operator|!
name|dns_name_equal
argument_list|(
name|sdbnode
operator|->
name|name
argument_list|,
name|newname
argument_list|)
condition|)
block|{
name|sdbnode
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|createnode
argument_list|(
name|sdb
argument_list|,
operator|&
name|sdbnode
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|sdbnode
operator|->
name|name
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdbnode
operator|->
name|name
operator|==
name|NULL
condition|)
block|{
name|destroynode
argument_list|(
name|sdbnode
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
name|dns_name_init
argument_list|(
name|sdbnode
operator|->
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_dup
argument_list|(
name|newname
argument_list|,
name|mctx
argument_list|,
name|sdbnode
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|sdbnode
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
name|destroynode
argument_list|(
name|sdbnode
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|ISC_LIST_PREPEND
argument_list|(
name|allnodes
operator|->
name|nodelist
argument_list|,
name|sdbnode
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|allnodes
operator|->
name|origin
operator|==
name|NULL
operator|&&
name|dns_name_equal
argument_list|(
name|newname
argument_list|,
operator|&
name|sdb
operator|->
name|common
operator|.
name|origin
argument_list|)
condition|)
name|allnodes
operator|->
name|origin
operator|=
name|sdbnode
expr_stmt|;
block|}
operator|*
name|nodep
operator|=
name|sdbnode
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_sdb_putnamedrr
parameter_list|(
name|dns_sdballnodes_t
modifier|*
name|allnodes
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_sdbnode_t
modifier|*
name|sdbnode
init|=
name|NULL
decl_stmt|;
name|result
operator|=
name|getnode
argument_list|(
name|allnodes
argument_list|,
name|name
argument_list|,
operator|&
name|sdbnode
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
return|return
operator|(
name|dns_sdb_putrr
argument_list|(
name|sdbnode
argument_list|,
name|type
argument_list|,
name|ttl
argument_list|,
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_sdb_putnamedrdata
parameter_list|(
name|dns_sdballnodes_t
modifier|*
name|allnodes
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|,
specifier|const
name|void
modifier|*
name|rdata
parameter_list|,
name|unsigned
name|int
name|rdlen
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_sdbnode_t
modifier|*
name|sdbnode
init|=
name|NULL
decl_stmt|;
name|result
operator|=
name|getnode
argument_list|(
name|allnodes
argument_list|,
name|name
argument_list|,
operator|&
name|sdbnode
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
return|return
operator|(
name|dns_sdb_putrdata
argument_list|(
name|sdbnode
argument_list|,
name|type
argument_list|,
name|ttl
argument_list|,
name|rdata
argument_list|,
name|rdlen
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_sdb_putsoa
parameter_list|(
name|dns_sdblookup_t
modifier|*
name|lookup
parameter_list|,
specifier|const
name|char
modifier|*
name|mname
parameter_list|,
specifier|const
name|char
modifier|*
name|rname
parameter_list|,
name|isc_uint32_t
name|serial
parameter_list|)
block|{
name|char
name|str
index|[
literal|2
operator|*
name|DNS_NAME_MAXTEXT
operator|+
literal|5
operator|*
operator|(
sizeof|sizeof
argument_list|(
literal|"2147483647"
argument_list|)
operator|)
operator|+
literal|7
index|]
decl_stmt|;
name|int
name|n
decl_stmt|;
name|REQUIRE
argument_list|(
name|mname
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rname
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|n
operator|=
name|snprintf
argument_list|(
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|,
literal|"%s %s %u %u %u %u %u"
argument_list|,
name|mname
argument_list|,
name|rname
argument_list|,
name|serial
argument_list|,
name|SDB_DEFAULT_REFRESH
argument_list|,
name|SDB_DEFAULT_RETRY
argument_list|,
name|SDB_DEFAULT_EXPIRE
argument_list|,
name|SDB_DEFAULT_MINIMUM
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>=
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|str
argument_list|)
operator|||
name|n
operator|<
literal|0
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
return|return
operator|(
name|dns_sdb_putrr
argument_list|(
name|lookup
argument_list|,
literal|"SOA"
argument_list|,
name|SDB_DEFAULT_TTL
argument_list|,
name|str
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * DB routines  */
end_comment

begin_function
specifier|static
name|void
name|attach
parameter_list|(
name|dns_db_t
modifier|*
name|source
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
name|dns_sdb_t
modifier|*
name|sdb
init|=
operator|(
name|dns_sdb_t
operator|*
operator|)
name|source
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDB
argument_list|(
name|sdb
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|sdb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|sdb
operator|->
name|references
operator|>
literal|0
argument_list|)
expr_stmt|;
name|sdb
operator|->
name|references
operator|++
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|sdb
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|targetp
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroy
parameter_list|(
name|dns_sdb_t
modifier|*
name|sdb
parameter_list|)
block|{
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_sdbimplementation_t
modifier|*
name|imp
init|=
name|sdb
operator|->
name|implementation
decl_stmt|;
name|mctx
operator|=
name|sdb
operator|->
name|common
operator|.
name|mctx
expr_stmt|;
if|if
condition|(
name|imp
operator|->
name|methods
operator|->
name|destroy
operator|!=
name|NULL
condition|)
block|{
name|MAYBE_LOCK
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
name|imp
operator|->
name|methods
operator|->
name|destroy
argument_list|(
name|sdb
operator|->
name|zone
argument_list|,
name|imp
operator|->
name|driverdata
argument_list|,
operator|&
name|sdb
operator|->
name|dbdata
argument_list|)
expr_stmt|;
name|MAYBE_UNLOCK
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
block|}
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|sdb
operator|->
name|zone
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|sdb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|sdb
operator|->
name|common
operator|.
name|magic
operator|=
literal|0
expr_stmt|;
name|sdb
operator|->
name|common
operator|.
name|impmagic
operator|=
literal|0
expr_stmt|;
name|dns_name_free
argument_list|(
operator|&
name|sdb
operator|->
name|common
operator|.
name|origin
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|sdb
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdb_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|detach
parameter_list|(
name|dns_db_t
modifier|*
modifier|*
name|dbp
parameter_list|)
block|{
name|dns_sdb_t
modifier|*
name|sdb
init|=
operator|(
name|dns_sdb_t
operator|*
operator|)
operator|(
operator|*
name|dbp
operator|)
decl_stmt|;
name|isc_boolean_t
name|need_destroy
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDB
argument_list|(
name|sdb
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|sdb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|sdb
operator|->
name|references
operator|>
literal|0
argument_list|)
expr_stmt|;
name|sdb
operator|->
name|references
operator|--
expr_stmt|;
if|if
condition|(
name|sdb
operator|->
name|references
operator|==
literal|0
condition|)
name|need_destroy
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|sdb
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_destroy
condition|)
name|destroy
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
operator|*
name|dbp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|beginload
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_addrdatasetfunc_t
modifier|*
name|addp
parameter_list|,
name|dns_dbload_t
modifier|*
modifier|*
name|dbloadp
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|addp
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|dbloadp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|endload
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbload_t
modifier|*
modifier|*
name|dbloadp
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|dbloadp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dump
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|filename
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|currentversion
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
modifier|*
name|versionp
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|versionp
operator|!=
name|NULL
operator|&&
operator|*
name|versionp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
operator|*
name|versionp
operator|=
operator|(
name|void
operator|*
operator|)
operator|&
name|dummy
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|newversion
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
modifier|*
name|versionp
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|versionp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|attachversion
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
name|source
parameter_list|,
name|dns_dbversion_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|source
operator|!=
name|NULL
operator|&&
name|source
operator|==
operator|(
name|void
operator|*
operator|)
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|targetp
operator|!=
name|NULL
operator|&&
operator|*
name|targetp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
operator|*
name|targetp
operator|=
name|source
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|closeversion
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
modifier|*
name|versionp
parameter_list|,
name|isc_boolean_t
name|commit
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|versionp
operator|!=
name|NULL
operator|&&
operator|*
name|versionp
operator|==
operator|(
name|void
operator|*
operator|)
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|commit
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|commit
argument_list|)
expr_stmt|;
operator|*
name|versionp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|createnode
parameter_list|(
name|dns_sdb_t
modifier|*
name|sdb
parameter_list|,
name|dns_sdbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|)
block|{
name|dns_sdbnode_t
modifier|*
name|node
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|node
operator|=
name|isc_mem_get
argument_list|(
name|sdb
operator|->
name|common
operator|.
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdbnode_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|node
operator|->
name|sdb
operator|=
name|NULL
expr_stmt|;
name|attach
argument_list|(
operator|(
name|dns_db_t
operator|*
operator|)
name|sdb
argument_list|,
operator|(
name|dns_db_t
operator|*
operator|*
operator|)
operator|&
name|node
operator|->
name|sdb
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|node
operator|->
name|lists
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|node
operator|->
name|buffers
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|node
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|node
operator|->
name|name
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|node
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"isc_mutex_init() failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|sdb
operator|->
name|common
operator|.
name|mctx
argument_list|,
name|node
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdbnode_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_UNEXPECTED
operator|)
return|;
block|}
name|dns_rdatacallbacks_init
argument_list|(
operator|&
name|node
operator|->
name|callbacks
argument_list|)
expr_stmt|;
name|node
operator|->
name|references
operator|=
literal|1
expr_stmt|;
name|node
operator|->
name|magic
operator|=
name|SDBLOOKUP_MAGIC
expr_stmt|;
operator|*
name|nodep
operator|=
name|node
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroynode
parameter_list|(
name|dns_sdbnode_t
modifier|*
name|node
parameter_list|)
block|{
name|dns_rdatalist_t
modifier|*
name|list
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
decl_stmt|;
name|isc_buffer_t
modifier|*
name|b
decl_stmt|;
name|dns_sdb_t
modifier|*
name|sdb
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|sdb
operator|=
name|node
operator|->
name|sdb
expr_stmt|;
name|mctx
operator|=
name|sdb
operator|->
name|common
operator|.
name|mctx
expr_stmt|;
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|node
operator|->
name|lists
argument_list|)
condition|)
block|{
name|list
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|node
operator|->
name|lists
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|list
operator|->
name|rdata
argument_list|)
condition|)
block|{
name|rdata
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|list
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|list
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|rdata
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdata_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ISC_LIST_UNLINK
argument_list|(
name|node
operator|->
name|lists
argument_list|,
name|list
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|list
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdatalist_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|node
operator|->
name|buffers
argument_list|)
condition|)
block|{
name|b
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|node
operator|->
name|buffers
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|node
operator|->
name|buffers
argument_list|,
name|b
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_buffer_free
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|node
operator|->
name|name
operator|!=
name|NULL
condition|)
block|{
name|dns_name_free
argument_list|(
name|node
operator|->
name|name
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|node
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|DESTROYLOCK
argument_list|(
operator|&
name|node
operator|->
name|lock
argument_list|)
expr_stmt|;
name|node
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|node
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdbnode_t
argument_list|)
argument_list|)
expr_stmt|;
name|detach
argument_list|(
operator|(
name|dns_db_t
operator|*
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|&
name|sdb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|findnode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|isc_boolean_t
name|create
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|)
block|{
name|dns_sdb_t
modifier|*
name|sdb
init|=
operator|(
name|dns_sdb_t
operator|*
operator|)
name|db
decl_stmt|;
name|dns_sdbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_MAXTEXT
operator|+
literal|1
index|]
decl_stmt|;
name|isc_boolean_t
name|isorigin
decl_stmt|;
name|dns_sdbimplementation_t
modifier|*
name|imp
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDB
argument_list|(
name|sdb
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|create
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|nodep
operator|!=
name|NULL
operator|&&
operator|*
name|nodep
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|create
argument_list|)
expr_stmt|;
name|imp
operator|=
name|sdb
operator|->
name|implementation
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|imp
operator|->
name|flags
operator|&
name|DNS_SDBFLAG_RELATIVEOWNER
operator|)
operator|!=
literal|0
condition|)
block|{
name|dns_name_t
name|relname
decl_stmt|;
name|unsigned
name|int
name|labels
decl_stmt|;
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|name
argument_list|)
operator|-
name|dns_name_countlabels
argument_list|(
operator|&
name|db
operator|->
name|origin
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|relname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|name
argument_list|,
literal|0
argument_list|,
name|labels
argument_list|,
operator|&
name|relname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_totext
argument_list|(
operator|&
name|relname
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
else|else
block|{
name|result
operator|=
name|dns_name_totext
argument_list|(
name|name
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
name|isc_buffer_putuint8
argument_list|(
operator|&
name|b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|createnode
argument_list|(
name|sdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|isorigin
operator|=
name|dns_name_equal
argument_list|(
name|name
argument_list|,
operator|&
name|sdb
operator|->
name|common
operator|.
name|origin
argument_list|)
expr_stmt|;
name|MAYBE_LOCK
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
name|result
operator|=
name|imp
operator|->
name|methods
operator|->
name|lookup
argument_list|(
name|sdb
operator|->
name|zone
argument_list|,
name|namestr
argument_list|,
name|sdb
operator|->
name|dbdata
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|MAYBE_UNLOCK
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
operator|!
operator|(
name|result
operator|==
name|ISC_R_NOTFOUND
operator|&&
name|isorigin
operator|&&
name|imp
operator|->
name|methods
operator|->
name|authority
operator|!=
name|NULL
operator|)
condition|)
block|{
name|destroynode
argument_list|(
name|node
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
if|if
condition|(
name|isorigin
operator|&&
name|imp
operator|->
name|methods
operator|->
name|authority
operator|!=
name|NULL
condition|)
block|{
name|MAYBE_LOCK
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
name|result
operator|=
name|imp
operator|->
name|methods
operator|->
name|authority
argument_list|(
name|sdb
operator|->
name|zone
argument_list|,
name|sdb
operator|->
name|dbdata
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|MAYBE_UNLOCK
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|destroynode
argument_list|(
name|node
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
operator|*
name|nodep
operator|=
name|node
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|find
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|,
name|dns_name_t
modifier|*
name|foundname
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdataset_t
modifier|*
name|sigrdataset
parameter_list|)
block|{
name|dns_sdb_t
modifier|*
name|sdb
init|=
operator|(
name|dns_sdb_t
operator|*
operator|)
name|db
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|dns_rdataset_t
name|xrdataset
decl_stmt|;
name|dns_name_t
modifier|*
name|xname
decl_stmt|;
name|unsigned
name|int
name|nlabels
decl_stmt|,
name|olabels
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDB
argument_list|(
name|sdb
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|nodep
operator|==
name|NULL
operator|||
operator|*
name|nodep
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|version
operator|==
name|NULL
operator|||
name|version
operator|==
operator|(
name|void
operator|*
operator|)
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dns_name_issubdomain
argument_list|(
name|name
argument_list|,
operator|&
name|db
operator|->
name|origin
argument_list|)
condition|)
return|return
operator|(
name|DNS_R_NXDOMAIN
operator|)
return|;
name|olabels
operator|=
name|dns_name_countlabels
argument_list|(
operator|&
name|db
operator|->
name|origin
argument_list|)
expr_stmt|;
name|nlabels
operator|=
name|dns_name_countlabels
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|xname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|==
name|NULL
condition|)
block|{
name|dns_rdataset_init
argument_list|(
operator|&
name|xrdataset
argument_list|)
expr_stmt|;
name|rdataset
operator|=
operator|&
name|xrdataset
expr_stmt|;
block|}
name|result
operator|=
name|DNS_R_NXDOMAIN
expr_stmt|;
for|for
control|(
name|i
operator|=
name|olabels
init|;
name|i
operator|<=
name|nlabels
condition|;
name|i
operator|++
control|)
block|{
comment|/* 		 * Unless this is an explicit lookup at the origin, don't 		 * look at the origin. 		 */
if|if
condition|(
name|i
operator|==
name|olabels
operator|&&
name|i
operator|!=
name|nlabels
condition|)
continue|continue;
comment|/* 		 * Look up the next label. 		 */
name|dns_name_getlabelsequence
argument_list|(
name|name
argument_list|,
name|nlabels
operator|-
name|i
argument_list|,
name|i
argument_list|,
name|xname
argument_list|)
expr_stmt|;
name|result
operator|=
name|findnode
argument_list|(
name|db
argument_list|,
name|xname
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|DNS_R_NXDOMAIN
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * Look for a DNAME at the current label, unless this is 		 * the qname. 		 */
if|if
condition|(
name|i
operator|<
name|nlabels
condition|)
block|{
name|result
operator|=
name|findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_dname
argument_list|,
literal|0
argument_list|,
name|now
argument_list|,
name|rdataset
argument_list|,
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|DNS_R_DNAME
expr_stmt|;
break|break;
block|}
block|}
comment|/* 		 * Look for an NS at the current label, unless this is the 		 * origin or glue is ok. 		 */
if|if
condition|(
name|i
operator|!=
name|olabels
operator|&&
operator|(
name|options
operator|&
name|DNS_DBFIND_GLUEOK
operator|)
operator|==
literal|0
condition|)
block|{
name|result
operator|=
name|findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_ns
argument_list|,
literal|0
argument_list|,
name|now
argument_list|,
name|rdataset
argument_list|,
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|i
operator|==
name|nlabels
operator|&&
name|type
operator|==
name|dns_rdatatype_any
condition|)
block|{
name|result
operator|=
name|DNS_R_ZONECUT
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|sigrdataset
operator|!=
name|NULL
condition|)
name|dns_rdataset_disassociate
argument_list|(
name|sigrdataset
argument_list|)
expr_stmt|;
block|}
else|else
name|result
operator|=
name|DNS_R_DELEGATION
expr_stmt|;
break|break;
block|}
block|}
comment|/* 		 * If the current name is not the qname, add another label 		 * and try again. 		 */
if|if
condition|(
name|i
operator|<
name|nlabels
condition|)
block|{
name|destroynode
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * If we're looking for ANY, we're done. 		 */
if|if
condition|(
name|type
operator|==
name|dns_rdatatype_any
condition|)
block|{
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
break|break;
block|}
comment|/* 		 * Look for the qtype. 		 */
name|result
operator|=
name|findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|type
argument_list|,
literal|0
argument_list|,
name|now
argument_list|,
name|rdataset
argument_list|,
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
break|break;
comment|/* 		 * Look for a CNAME 		 */
if|if
condition|(
name|type
operator|!=
name|dns_rdatatype_cname
condition|)
block|{
name|result
operator|=
name|findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_cname
argument_list|,
literal|0
argument_list|,
name|now
argument_list|,
name|rdataset
argument_list|,
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|DNS_R_CNAME
expr_stmt|;
break|break;
block|}
block|}
name|result
operator|=
name|DNS_R_NXRRSET
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|rdataset
operator|==
operator|&
name|xrdataset
operator|&&
name|dns_rdataset_isassociated
argument_list|(
name|rdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|foundname
operator|!=
name|NULL
condition|)
block|{
name|isc_result_t
name|xresult
decl_stmt|;
name|xresult
operator|=
name|dns_name_copy
argument_list|(
name|xname
argument_list|,
name|foundname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|xresult
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|destroynode
argument_list|(
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
name|rdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_BADDB
operator|)
return|;
block|}
block|}
if|if
condition|(
name|nodep
operator|!=
name|NULL
condition|)
operator|*
name|nodep
operator|=
name|node
expr_stmt|;
elseif|else
if|if
condition|(
name|node
operator|!=
name|NULL
condition|)
name|detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|findzonecut
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|,
name|dns_name_t
modifier|*
name|foundname
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdataset_t
modifier|*
name|sigrdataset
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|now
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|nodep
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|foundname
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|sigrdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|attachnode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|source
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
name|dns_sdb_t
modifier|*
name|sdb
init|=
operator|(
name|dns_sdb_t
operator|*
operator|)
name|db
decl_stmt|;
name|dns_sdbnode_t
modifier|*
name|node
init|=
operator|(
name|dns_sdbnode_t
operator|*
operator|)
name|source
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDB
argument_list|(
name|sdb
argument_list|)
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|node
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|node
operator|->
name|references
operator|>
literal|0
argument_list|)
expr_stmt|;
name|node
operator|->
name|references
operator|++
expr_stmt|;
name|INSIST
argument_list|(
name|node
operator|->
name|references
operator|!=
literal|0
argument_list|)
expr_stmt|;
comment|/* Catch overflow. */
name|UNLOCK
argument_list|(
operator|&
name|node
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|targetp
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|detachnode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
name|dns_sdb_t
modifier|*
name|sdb
init|=
operator|(
name|dns_sdb_t
operator|*
operator|)
name|db
decl_stmt|;
name|dns_sdbnode_t
modifier|*
name|node
decl_stmt|;
name|isc_boolean_t
name|need_destroy
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDB
argument_list|(
name|sdb
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|targetp
operator|!=
name|NULL
operator|&&
operator|*
name|targetp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
name|node
operator|=
operator|(
name|dns_sdbnode_t
operator|*
operator|)
operator|(
operator|*
name|targetp
operator|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|node
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|node
operator|->
name|references
operator|>
literal|0
argument_list|)
expr_stmt|;
name|node
operator|->
name|references
operator|--
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|references
operator|==
literal|0
condition|)
name|need_destroy
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|node
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_destroy
condition|)
name|destroynode
argument_list|(
name|node
argument_list|)
expr_stmt|;
operator|*
name|targetp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|expirenode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|now
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_UNEXPECTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|printnode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|FILE
modifier|*
name|out
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|out
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|createiterator
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|isc_boolean_t
name|relative_names
parameter_list|,
name|dns_dbiterator_t
modifier|*
modifier|*
name|iteratorp
parameter_list|)
block|{
name|dns_sdb_t
modifier|*
name|sdb
init|=
operator|(
name|dns_sdb_t
operator|*
operator|)
name|db
decl_stmt|;
name|sdb_dbiterator_t
modifier|*
name|sdbiter
decl_stmt|;
name|dns_sdbimplementation_t
modifier|*
name|imp
init|=
name|sdb
operator|->
name|implementation
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDB
argument_list|(
name|sdb
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|imp
operator|->
name|methods
operator|->
name|allnodes
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
name|sdbiter
operator|=
name|isc_mem_get
argument_list|(
name|sdb
operator|->
name|common
operator|.
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|sdb_dbiterator_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdbiter
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|sdbiter
operator|->
name|common
operator|.
name|methods
operator|=
operator|&
name|dbiterator_methods
expr_stmt|;
name|sdbiter
operator|->
name|common
operator|.
name|db
operator|=
name|NULL
expr_stmt|;
name|dns_db_attach
argument_list|(
name|db
argument_list|,
operator|&
name|sdbiter
operator|->
name|common
operator|.
name|db
argument_list|)
expr_stmt|;
name|sdbiter
operator|->
name|common
operator|.
name|relative_names
operator|=
name|relative_names
expr_stmt|;
name|sdbiter
operator|->
name|common
operator|.
name|magic
operator|=
name|DNS_DBITERATOR_MAGIC
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|sdbiter
operator|->
name|nodelist
argument_list|)
expr_stmt|;
name|sdbiter
operator|->
name|current
operator|=
name|NULL
expr_stmt|;
name|sdbiter
operator|->
name|origin
operator|=
name|NULL
expr_stmt|;
name|MAYBE_LOCK
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
name|result
operator|=
name|imp
operator|->
name|methods
operator|->
name|allnodes
argument_list|(
name|sdb
operator|->
name|zone
argument_list|,
name|sdb
operator|->
name|dbdata
argument_list|,
name|sdbiter
argument_list|)
expr_stmt|;
name|MAYBE_UNLOCK
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dbiterator_destroy
argument_list|(
operator|(
name|dns_dbiterator_t
operator|*
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|&
name|sdbiter
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
if|if
condition|(
name|sdbiter
operator|->
name|origin
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|sdbiter
operator|->
name|nodelist
argument_list|,
name|sdbiter
operator|->
name|origin
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_PREPEND
argument_list|(
name|sdbiter
operator|->
name|nodelist
argument_list|,
name|sdbiter
operator|->
name|origin
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
operator|*
name|iteratorp
operator|=
operator|(
name|dns_dbiterator_t
operator|*
operator|)
name|sdbiter
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|findrdataset
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|dns_rdatatype_t
name|covers
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdataset_t
modifier|*
name|sigrdataset
parameter_list|)
block|{
name|dns_rdatalist_t
modifier|*
name|list
decl_stmt|;
name|dns_sdbnode_t
modifier|*
name|sdbnode
init|=
operator|(
name|dns_sdbnode_t
operator|*
operator|)
name|node
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDBNODE
argument_list|(
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|covers
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|now
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|dns_rdatatype_rrsig
condition|)
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
name|list
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|sdbnode
operator|->
name|lists
argument_list|)
expr_stmt|;
while|while
condition|(
name|list
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|list
operator|->
name|type
operator|==
name|type
condition|)
break|break;
name|list
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|list
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|list
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
name|list_tordataset
argument_list|(
name|list
argument_list|,
name|db
argument_list|,
name|node
argument_list|,
name|rdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|allrdatasets
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|dns_rdatasetiter_t
modifier|*
modifier|*
name|iteratorp
parameter_list|)
block|{
name|sdb_rdatasetiter_t
modifier|*
name|iterator
decl_stmt|;
name|REQUIRE
argument_list|(
name|version
operator|==
name|NULL
operator|||
name|version
operator|==
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|now
argument_list|)
expr_stmt|;
name|iterator
operator|=
name|isc_mem_get
argument_list|(
name|db
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|sdb_rdatasetiter_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|iterator
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|iterator
operator|->
name|common
operator|.
name|magic
operator|=
name|DNS_RDATASETITER_MAGIC
expr_stmt|;
name|iterator
operator|->
name|common
operator|.
name|methods
operator|=
operator|&
name|rdatasetiter_methods
expr_stmt|;
name|iterator
operator|->
name|common
operator|.
name|db
operator|=
name|db
expr_stmt|;
name|iterator
operator|->
name|common
operator|.
name|node
operator|=
name|NULL
expr_stmt|;
name|attachnode
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
operator|&
name|iterator
operator|->
name|common
operator|.
name|node
argument_list|)
expr_stmt|;
name|iterator
operator|->
name|common
operator|.
name|version
operator|=
name|version
expr_stmt|;
name|iterator
operator|->
name|common
operator|.
name|now
operator|=
name|now
expr_stmt|;
operator|*
name|iteratorp
operator|=
operator|(
name|dns_rdatasetiter_t
operator|*
operator|)
name|iterator
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|addrdataset
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|dns_rdataset_t
modifier|*
name|addedrdataset
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|now
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|addedrdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|subtractrdataset
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|dns_rdataset_t
modifier|*
name|newrdataset
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|newrdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|deleterdataset
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|dns_rdatatype_t
name|covers
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|covers
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|issecure
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|nodecount
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|ispersistent
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|overmem
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|isc_boolean_t
name|overmem
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|overmem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|settask
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|dns_dbmethods_t
name|sdb_methods
init|=
block|{
name|attach
block|,
name|detach
block|,
name|beginload
block|,
name|endload
block|,
name|dump
block|,
name|currentversion
block|,
name|newversion
block|,
name|attachversion
block|,
name|closeversion
block|,
name|findnode
block|,
name|find
block|,
name|findzonecut
block|,
name|attachnode
block|,
name|detachnode
block|,
name|expirenode
block|,
name|printnode
block|,
name|createiterator
block|,
name|findrdataset
block|,
name|allrdatasets
block|,
name|addrdataset
block|,
name|subtractrdataset
block|,
name|deleterdataset
block|,
name|issecure
block|,
name|nodecount
block|,
name|ispersistent
block|,
name|overmem
block|,
name|settask
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|isc_result_t
name|dns_sdb_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_name_t
modifier|*
name|origin
parameter_list|,
name|dns_dbtype_t
name|type
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|unsigned
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|void
modifier|*
name|driverarg
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|dbp
parameter_list|)
block|{
name|dns_sdb_t
modifier|*
name|sdb
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|char
name|zonestr
index|[
name|DNS_NAME_MAXTEXT
operator|+
literal|1
index|]
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_sdbimplementation_t
modifier|*
name|imp
decl_stmt|;
name|REQUIRE
argument_list|(
name|driverarg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|imp
operator|=
name|driverarg
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|dns_dbtype_zone
condition|)
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
name|sdb
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdb_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdb
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|memset
argument_list|(
name|sdb
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdb_t
argument_list|)
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|sdb
operator|->
name|common
operator|.
name|origin
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sdb
operator|->
name|common
operator|.
name|attributes
operator|=
literal|0
expr_stmt|;
name|sdb
operator|->
name|common
operator|.
name|methods
operator|=
operator|&
name|sdb_methods
expr_stmt|;
name|sdb
operator|->
name|common
operator|.
name|rdclass
operator|=
name|rdclass
expr_stmt|;
name|sdb
operator|->
name|common
operator|.
name|mctx
operator|=
name|NULL
expr_stmt|;
name|sdb
operator|->
name|implementation
operator|=
name|imp
expr_stmt|;
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|sdb
operator|->
name|common
operator|.
name|mctx
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|sdb
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"isc_mutex_init() failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_UNEXPECTED
expr_stmt|;
goto|goto
name|cleanup_mctx
goto|;
block|}
name|result
operator|=
name|dns_name_dupwithoffsets
argument_list|(
name|origin
argument_list|,
name|mctx
argument_list|,
operator|&
name|sdb
operator|->
name|common
operator|.
name|origin
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_lock
goto|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|zonestr
argument_list|,
sizeof|sizeof
argument_list|(
name|zonestr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_totext
argument_list|(
name|origin
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_origin
goto|;
name|isc_buffer_putuint8
argument_list|(
operator|&
name|b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sdb
operator|->
name|zone
operator|=
name|isc_mem_strdup
argument_list|(
name|mctx
argument_list|,
name|zonestr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdb
operator|->
name|zone
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup_origin
goto|;
block|}
name|sdb
operator|->
name|dbdata
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|imp
operator|->
name|methods
operator|->
name|create
operator|!=
name|NULL
condition|)
block|{
name|MAYBE_LOCK
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
name|result
operator|=
name|imp
operator|->
name|methods
operator|->
name|create
argument_list|(
name|sdb
operator|->
name|zone
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|imp
operator|->
name|driverdata
argument_list|,
operator|&
name|sdb
operator|->
name|dbdata
argument_list|)
expr_stmt|;
name|MAYBE_UNLOCK
argument_list|(
name|sdb
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_zonestr
goto|;
block|}
name|sdb
operator|->
name|references
operator|=
literal|1
expr_stmt|;
name|sdb
operator|->
name|common
operator|.
name|magic
operator|=
name|DNS_DB_MAGIC
expr_stmt|;
name|sdb
operator|->
name|common
operator|.
name|impmagic
operator|=
name|SDB_MAGIC
expr_stmt|;
operator|*
name|dbp
operator|=
operator|(
name|dns_db_t
operator|*
operator|)
name|sdb
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup_zonestr
label|:
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|sdb
operator|->
name|zone
argument_list|)
expr_stmt|;
name|cleanup_origin
label|:
name|dns_name_free
argument_list|(
operator|&
name|sdb
operator|->
name|common
operator|.
name|origin
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|cleanup_lock
label|:
name|isc_mutex_destroy
argument_list|(
operator|&
name|sdb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cleanup_mctx
label|:
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|sdb
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdb_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Rdataset Methods  */
end_comment

begin_function
specifier|static
name|void
name|disassociate
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
name|dns_dbnode_t
modifier|*
name|node
init|=
name|rdataset
operator|->
name|private5
decl_stmt|;
name|dns_sdbnode_t
modifier|*
name|sdbnode
init|=
operator|(
name|dns_sdbnode_t
operator|*
operator|)
name|node
decl_stmt|;
name|dns_db_t
modifier|*
name|db
init|=
operator|(
name|dns_db_t
operator|*
operator|)
name|sdbnode
operator|->
name|sdb
decl_stmt|;
name|detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|isc__rdatalist_disassociate
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rdataset_clone
parameter_list|(
name|dns_rdataset_t
modifier|*
name|source
parameter_list|,
name|dns_rdataset_t
modifier|*
name|target
parameter_list|)
block|{
name|dns_dbnode_t
modifier|*
name|node
init|=
name|source
operator|->
name|private5
decl_stmt|;
name|dns_sdbnode_t
modifier|*
name|sdbnode
init|=
operator|(
name|dns_sdbnode_t
operator|*
operator|)
name|node
decl_stmt|;
name|dns_db_t
modifier|*
name|db
init|=
operator|(
name|dns_db_t
operator|*
operator|)
name|sdbnode
operator|->
name|sdb
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|tempdb
init|=
name|NULL
decl_stmt|;
name|isc__rdatalist_clone
argument_list|(
name|source
argument_list|,
name|target
argument_list|)
expr_stmt|;
name|attachnode
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
operator|&
name|tempdb
argument_list|)
expr_stmt|;
name|source
operator|->
name|private5
operator|=
name|tempdb
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|dns_rdatasetmethods_t
name|methods
init|=
block|{
name|disassociate
block|,
name|isc__rdatalist_first
block|,
name|isc__rdatalist_next
block|,
name|isc__rdatalist_current
block|,
name|rdataset_clone
block|,
name|isc__rdatalist_count
block|,
name|isc__rdatalist_addnoqname
block|,
name|isc__rdatalist_getnoqname
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|list_tordataset
parameter_list|(
name|dns_rdatalist_t
modifier|*
name|rdatalist
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
comment|/* 	 * The sdb rdataset is an rdatalist with some additions. 	 *	- private1& private2 are used by the rdatalist. 	 *	- private3& private 4 are unused. 	 *	- private5 is the node. 	 */
comment|/* This should never fail. */
name|RUNTIME_CHECK
argument_list|(
name|dns_rdatalist_tordataset
argument_list|(
name|rdatalist
argument_list|,
name|rdataset
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|rdataset
operator|->
name|methods
operator|=
operator|&
name|methods
expr_stmt|;
name|dns_db_attachnode
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
operator|&
name|rdataset
operator|->
name|private5
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Database Iterator Methods  */
end_comment

begin_function
specifier|static
name|void
name|dbiterator_destroy
parameter_list|(
name|dns_dbiterator_t
modifier|*
modifier|*
name|iteratorp
parameter_list|)
block|{
name|sdb_dbiterator_t
modifier|*
name|sdbiter
init|=
operator|(
name|sdb_dbiterator_t
operator|*
operator|)
operator|(
operator|*
name|iteratorp
operator|)
decl_stmt|;
name|dns_sdb_t
modifier|*
name|sdb
init|=
operator|(
name|dns_sdb_t
operator|*
operator|)
name|sdbiter
operator|->
name|common
operator|.
name|db
decl_stmt|;
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|sdbiter
operator|->
name|nodelist
argument_list|)
condition|)
block|{
name|dns_sdbnode_t
modifier|*
name|node
decl_stmt|;
name|node
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|sdbiter
operator|->
name|nodelist
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|sdbiter
operator|->
name|nodelist
argument_list|,
name|node
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|destroynode
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
name|dns_db_detach
argument_list|(
operator|&
name|sdbiter
operator|->
name|common
operator|.
name|db
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|sdb
operator|->
name|common
operator|.
name|mctx
argument_list|,
name|sdbiter
argument_list|,
sizeof|sizeof
argument_list|(
name|sdb_dbiterator_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|iteratorp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_first
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
block|{
name|sdb_dbiterator_t
modifier|*
name|sdbiter
init|=
operator|(
name|sdb_dbiterator_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|sdbiter
operator|->
name|current
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|sdbiter
operator|->
name|nodelist
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdbiter
operator|->
name|current
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_last
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
block|{
name|sdb_dbiterator_t
modifier|*
name|sdbiter
init|=
operator|(
name|sdb_dbiterator_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|sdbiter
operator|->
name|current
operator|=
name|ISC_LIST_TAIL
argument_list|(
name|sdbiter
operator|->
name|nodelist
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdbiter
operator|->
name|current
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_seek
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|sdb_dbiterator_t
modifier|*
name|sdbiter
init|=
operator|(
name|sdb_dbiterator_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|sdbiter
operator|->
name|current
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|sdbiter
operator|->
name|nodelist
argument_list|)
expr_stmt|;
while|while
condition|(
name|sdbiter
operator|->
name|current
operator|!=
name|NULL
condition|)
if|if
condition|(
name|dns_name_equal
argument_list|(
name|sdbiter
operator|->
name|current
operator|->
name|name
argument_list|,
name|name
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_prev
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
block|{
name|sdb_dbiterator_t
modifier|*
name|sdbiter
init|=
operator|(
name|sdb_dbiterator_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|sdbiter
operator|->
name|current
operator|=
name|ISC_LIST_PREV
argument_list|(
name|sdbiter
operator|->
name|current
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdbiter
operator|->
name|current
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_next
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
block|{
name|sdb_dbiterator_t
modifier|*
name|sdbiter
init|=
operator|(
name|sdb_dbiterator_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|sdbiter
operator|->
name|current
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|sdbiter
operator|->
name|current
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdbiter
operator|->
name|current
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_current
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|sdb_dbiterator_t
modifier|*
name|sdbiter
init|=
operator|(
name|sdb_dbiterator_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|attachnode
argument_list|(
name|iterator
operator|->
name|db
argument_list|,
name|sdbiter
operator|->
name|current
argument_list|,
name|nodep
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|!=
name|NULL
condition|)
return|return
operator|(
name|dns_name_copy
argument_list|(
name|sdbiter
operator|->
name|current
operator|->
name|name
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_pause
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|iterator
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_origin
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|iterator
argument_list|)
expr_stmt|;
return|return
operator|(
name|dns_name_copy
argument_list|(
name|dns_rootname
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Rdataset Iterator Methods  */
end_comment

begin_function
specifier|static
name|void
name|rdatasetiter_destroy
parameter_list|(
name|dns_rdatasetiter_t
modifier|*
modifier|*
name|iteratorp
parameter_list|)
block|{
name|sdb_rdatasetiter_t
modifier|*
name|sdbiterator
init|=
operator|(
name|sdb_rdatasetiter_t
operator|*
operator|)
operator|(
operator|*
name|iteratorp
operator|)
decl_stmt|;
name|detachnode
argument_list|(
name|sdbiterator
operator|->
name|common
operator|.
name|db
argument_list|,
operator|&
name|sdbiterator
operator|->
name|common
operator|.
name|node
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|sdbiterator
operator|->
name|common
operator|.
name|db
operator|->
name|mctx
argument_list|,
name|sdbiterator
argument_list|,
sizeof|sizeof
argument_list|(
name|sdb_rdatasetiter_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|iteratorp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|rdatasetiter_first
parameter_list|(
name|dns_rdatasetiter_t
modifier|*
name|iterator
parameter_list|)
block|{
name|sdb_rdatasetiter_t
modifier|*
name|sdbiterator
init|=
operator|(
name|sdb_rdatasetiter_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|dns_sdbnode_t
modifier|*
name|sdbnode
init|=
operator|(
name|dns_sdbnode_t
operator|*
operator|)
name|iterator
operator|->
name|node
decl_stmt|;
if|if
condition|(
name|ISC_LIST_EMPTY
argument_list|(
name|sdbnode
operator|->
name|lists
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
name|sdbiterator
operator|->
name|current
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|sdbnode
operator|->
name|lists
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|rdatasetiter_next
parameter_list|(
name|dns_rdatasetiter_t
modifier|*
name|iterator
parameter_list|)
block|{
name|sdb_rdatasetiter_t
modifier|*
name|sdbiterator
init|=
operator|(
name|sdb_rdatasetiter_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|sdbiterator
operator|->
name|current
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|sdbiterator
operator|->
name|current
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdbiterator
operator|->
name|current
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rdatasetiter_current
parameter_list|(
name|dns_rdatasetiter_t
modifier|*
name|iterator
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
name|sdb_rdatasetiter_t
modifier|*
name|sdbiterator
init|=
operator|(
name|sdb_rdatasetiter_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|list_tordataset
argument_list|(
name|sdbiterator
operator|->
name|current
argument_list|,
name|iterator
operator|->
name|db
argument_list|,
name|iterator
operator|->
name|node
argument_list|,
name|rdataset
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004, 2005, 2009  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 2000-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: diff.c,v 1.9.18.6 2009-01-06 23:45:56 tbox Exp $ */
end_comment

begin_comment
comment|/*! \file */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_include
include|#
directive|include
file|<isc/file.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/diff.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataclass.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatalist.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatatype.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_define
define|#
directive|define
name|CHECK
parameter_list|(
name|op
parameter_list|)
define|\
value|do { result = (op);					\ 		if (result != ISC_R_SUCCESS) goto failure;	\ 	} while (0)
end_define

begin_define
define|#
directive|define
name|DIFF_COMMON_LOGARGS
define|\
value|dns_lctx, DNS_LOGCATEGORY_GENERAL, DNS_LOGMODULE_DIFF
end_define

begin_function
specifier|static
name|dns_rdatatype_t
name|rdata_covers
parameter_list|(
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
block|{
return|return
operator|(
name|rdata
operator|->
name|type
operator|==
name|dns_rdatatype_rrsig
condition|?
name|dns_rdata_covers
argument_list|(
name|rdata
argument_list|)
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_difftuple_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_diffop_t
name|op
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|,
name|dns_difftuple_t
modifier|*
modifier|*
name|tp
parameter_list|)
block|{
name|dns_difftuple_t
modifier|*
name|t
decl_stmt|;
name|unsigned
name|int
name|size
decl_stmt|;
name|unsigned
name|char
modifier|*
name|datap
decl_stmt|;
name|REQUIRE
argument_list|(
name|tp
operator|!=
name|NULL
operator|&&
operator|*
name|tp
operator|==
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Create a new tuple.  The variable-size wire-format name data and 	 * rdata immediately follow the dns_difftuple_t structure 	 * in memory. 	 */
name|size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|t
argument_list|)
operator|+
name|name
operator|->
name|length
operator|+
name|rdata
operator|->
name|length
expr_stmt|;
name|t
operator|=
name|isc_mem_allocate
argument_list|(
name|mctx
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|t
operator|->
name|mctx
operator|=
name|mctx
expr_stmt|;
name|t
operator|->
name|op
operator|=
name|op
expr_stmt|;
name|datap
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|t
operator|+
literal|1
operator|)
expr_stmt|;
name|memcpy
argument_list|(
name|datap
argument_list|,
name|name
operator|->
name|ndata
argument_list|,
name|name
operator|->
name|length
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|t
operator|->
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
name|name
argument_list|,
operator|&
name|t
operator|->
name|name
argument_list|)
expr_stmt|;
name|t
operator|->
name|name
operator|.
name|ndata
operator|=
name|datap
expr_stmt|;
name|datap
operator|+=
name|name
operator|->
name|length
expr_stmt|;
name|t
operator|->
name|ttl
operator|=
name|ttl
expr_stmt|;
name|memcpy
argument_list|(
name|datap
argument_list|,
name|rdata
operator|->
name|data
argument_list|,
name|rdata
operator|->
name|length
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
operator|&
name|t
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_clone
argument_list|(
name|rdata
argument_list|,
operator|&
name|t
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|t
operator|->
name|rdata
operator|.
name|data
operator|=
name|datap
expr_stmt|;
name|datap
operator|+=
name|rdata
operator|->
name|length
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
operator|&
name|t
operator|->
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|t
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|t
operator|->
name|magic
operator|=
name|DNS_DIFFTUPLE_MAGIC
expr_stmt|;
name|INSIST
argument_list|(
name|datap
operator|==
operator|(
name|unsigned
name|char
operator|*
operator|)
name|t
operator|+
name|size
argument_list|)
expr_stmt|;
operator|*
name|tp
operator|=
name|t
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_difftuple_free
parameter_list|(
name|dns_difftuple_t
modifier|*
modifier|*
name|tp
parameter_list|)
block|{
name|dns_difftuple_t
modifier|*
name|t
init|=
operator|*
name|tp
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_DIFFTUPLE_VALID
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|dns_name_invalidate
argument_list|(
operator|&
name|t
operator|->
name|name
argument_list|)
expr_stmt|;
name|t
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_free
argument_list|(
name|t
operator|->
name|mctx
argument_list|,
name|t
argument_list|)
expr_stmt|;
operator|*
name|tp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_difftuple_copy
parameter_list|(
name|dns_difftuple_t
modifier|*
name|orig
parameter_list|,
name|dns_difftuple_t
modifier|*
modifier|*
name|copyp
parameter_list|)
block|{
return|return
operator|(
name|dns_difftuple_create
argument_list|(
name|orig
operator|->
name|mctx
argument_list|,
name|orig
operator|->
name|op
argument_list|,
operator|&
name|orig
operator|->
name|name
argument_list|,
name|orig
operator|->
name|ttl
argument_list|,
operator|&
name|orig
operator|->
name|rdata
argument_list|,
name|copyp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_diff_init
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_diff_t
modifier|*
name|diff
parameter_list|)
block|{
name|diff
operator|->
name|mctx
operator|=
name|mctx
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|diff
operator|->
name|tuples
argument_list|)
expr_stmt|;
name|diff
operator|->
name|magic
operator|=
name|DNS_DIFF_MAGIC
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_diff_clear
parameter_list|(
name|dns_diff_t
modifier|*
name|diff
parameter_list|)
block|{
name|dns_difftuple_t
modifier|*
name|t
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_DIFF_VALID
argument_list|(
name|diff
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|t
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|diff
operator|->
name|tuples
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|diff
operator|->
name|tuples
argument_list|,
name|t
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_difftuple_free
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
block|}
name|ENSURE
argument_list|(
name|ISC_LIST_EMPTY
argument_list|(
name|diff
operator|->
name|tuples
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_diff_append
parameter_list|(
name|dns_diff_t
modifier|*
name|diff
parameter_list|,
name|dns_difftuple_t
modifier|*
modifier|*
name|tuplep
parameter_list|)
block|{
name|ISC_LIST_APPEND
argument_list|(
name|diff
operator|->
name|tuples
argument_list|,
operator|*
name|tuplep
argument_list|,
name|link
argument_list|)
expr_stmt|;
operator|*
name|tuplep
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/* XXX this is O(N) */
end_comment

begin_function
name|void
name|dns_diff_appendminimal
parameter_list|(
name|dns_diff_t
modifier|*
name|diff
parameter_list|,
name|dns_difftuple_t
modifier|*
modifier|*
name|tuplep
parameter_list|)
block|{
name|dns_difftuple_t
modifier|*
name|ot
decl_stmt|,
modifier|*
name|next_ot
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_DIFF_VALID
argument_list|(
name|diff
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_DIFFTUPLE_VALID
argument_list|(
operator|*
name|tuplep
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Look for an existing tuple with the same owner name, 	 * rdata, and TTL.   If we are doing an addition and find a 	 * deletion or vice versa, remove both the old and the 	 * new tuple since they cancel each other out (assuming 	 * that we never delete nonexistent data or add existing 	 * data). 	 * 	 * If we find an old update of the same kind as 	 * the one we are doing, there must be a programming 	 * error.  We report it but try to continue anyway. 	 */
for|for
control|(
name|ot
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|diff
operator|->
name|tuples
argument_list|)
init|;
name|ot
operator|!=
name|NULL
condition|;
name|ot
operator|=
name|next_ot
control|)
block|{
name|next_ot
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|ot
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_name_equal
argument_list|(
operator|&
name|ot
operator|->
name|name
argument_list|,
operator|&
operator|(
operator|*
name|tuplep
operator|)
operator|->
name|name
argument_list|)
operator|&&
name|dns_rdata_compare
argument_list|(
operator|&
name|ot
operator|->
name|rdata
argument_list|,
operator|&
operator|(
operator|*
name|tuplep
operator|)
operator|->
name|rdata
argument_list|)
operator|==
literal|0
operator|&&
name|ot
operator|->
name|ttl
operator|==
operator|(
operator|*
name|tuplep
operator|)
operator|->
name|ttl
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|diff
operator|->
name|tuples
argument_list|,
name|ot
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|tuplep
operator|)
operator|->
name|op
operator|==
name|ot
operator|->
name|op
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"unexpected non-minimal diff"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dns_difftuple_free
argument_list|(
name|tuplep
argument_list|)
expr_stmt|;
block|}
name|dns_difftuple_free
argument_list|(
operator|&
name|ot
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|*
name|tuplep
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_APPEND
argument_list|(
name|diff
operator|->
name|tuples
argument_list|,
operator|*
name|tuplep
argument_list|,
name|link
argument_list|)
expr_stmt|;
operator|*
name|tuplep
operator|=
name|NULL
expr_stmt|;
block|}
name|ENSURE
argument_list|(
operator|*
name|tuplep
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|diff_apply
parameter_list|(
name|dns_diff_t
modifier|*
name|diff
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
name|ver
parameter_list|,
name|isc_boolean_t
name|warn
parameter_list|)
block|{
name|dns_difftuple_t
modifier|*
name|t
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
name|typebuf
index|[
name|DNS_RDATATYPE_FORMATSIZE
index|]
decl_stmt|;
name|char
name|classbuf
index|[
name|DNS_RDATACLASS_FORMATSIZE
index|]
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_DIFF_VALID
argument_list|(
name|diff
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_DB_VALID
argument_list|(
name|db
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|diff
operator|->
name|tuples
argument_list|)
expr_stmt|;
while|while
condition|(
name|t
operator|!=
name|NULL
condition|)
block|{
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|INSIST
argument_list|(
name|node
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|name
operator|=
operator|&
name|t
operator|->
name|name
expr_stmt|;
comment|/* 		 * Find the node. 		 * We create the node if it does not exist. 		 * This will cause an empty node to be created if the diff 		 * contains a deletion of an RR at a nonexistent name, 		 * but such diffs should never be created in the first 		 * place. 		 */
name|node
operator|=
name|NULL
expr_stmt|;
name|CHECK
argument_list|(
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
name|name
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|node
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|t
operator|!=
name|NULL
operator|&&
name|dns_name_equal
argument_list|(
operator|&
name|t
operator|->
name|name
argument_list|,
name|name
argument_list|)
condition|)
block|{
name|dns_rdatatype_t
name|type
decl_stmt|,
name|covers
decl_stmt|;
name|dns_diffop_t
name|op
decl_stmt|;
name|dns_rdatalist_t
name|rdl
decl_stmt|;
name|dns_rdataset_t
name|rds
decl_stmt|;
name|op
operator|=
name|t
operator|->
name|op
expr_stmt|;
name|type
operator|=
name|t
operator|->
name|rdata
operator|.
name|type
expr_stmt|;
name|covers
operator|=
name|rdata_covers
argument_list|(
operator|&
name|t
operator|->
name|rdata
argument_list|)
expr_stmt|;
comment|/* 			 * Collect a contiguous set of updates with 			 * the same operation (add/delete) and RR type 			 * into a single rdatalist so that the 			 * database rrset merging/subtraction code 			 * can work more efficiently than if each 			 * RR were merged into / subtracted from 			 * the database separately. 			 * 			 * This is done by linking rdata structures from the 			 * diff into "rdatalist".  This uses the rdata link 			 * field, not the diff link field, so the structure 			 * of the diff itself is not affected. 			 */
name|rdl
operator|.
name|type
operator|=
name|type
expr_stmt|;
name|rdl
operator|.
name|covers
operator|=
name|covers
expr_stmt|;
name|rdl
operator|.
name|rdclass
operator|=
name|t
operator|->
name|rdata
operator|.
name|rdclass
expr_stmt|;
name|rdl
operator|.
name|ttl
operator|=
name|t
operator|->
name|ttl
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rdl
operator|.
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
operator|&
name|rdl
argument_list|,
name|link
argument_list|)
expr_stmt|;
while|while
condition|(
name|t
operator|!=
name|NULL
operator|&&
name|dns_name_equal
argument_list|(
operator|&
name|t
operator|->
name|name
argument_list|,
name|name
argument_list|)
operator|&&
name|t
operator|->
name|op
operator|==
name|op
operator|&&
name|t
operator|->
name|rdata
operator|.
name|type
operator|==
name|type
operator|&&
name|rdata_covers
argument_list|(
operator|&
name|t
operator|->
name|rdata
argument_list|)
operator|==
name|covers
condition|)
block|{
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdatatype_format
argument_list|(
name|t
operator|->
name|rdata
operator|.
name|type
argument_list|,
name|typebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|typebuf
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataclass_format
argument_list|(
name|t
operator|->
name|rdata
operator|.
name|rdclass
argument_list|,
name|classbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|classbuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|ttl
operator|!=
name|rdl
operator|.
name|ttl
operator|&&
name|warn
condition|)
name|isc_log_write
argument_list|(
name|DIFF_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"'%s/%s/%s': TTL differs in "
literal|"rdataset, adjusting "
literal|"%lu -> %lu"
argument_list|,
name|namebuf
argument_list|,
name|typebuf
argument_list|,
name|classbuf
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|t
operator|->
name|ttl
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|rdl
operator|.
name|ttl
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdl
operator|.
name|rdata
argument_list|,
operator|&
name|t
operator|->
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|t
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|t
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
comment|/* 			 * Convert the rdatalist into a rdataset. 			 */
name|dns_rdataset_init
argument_list|(
operator|&
name|rds
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_rdatalist_tordataset
argument_list|(
operator|&
name|rdl
argument_list|,
operator|&
name|rds
argument_list|)
argument_list|)
expr_stmt|;
name|rds
operator|.
name|trust
operator|=
name|dns_trust_ultimate
expr_stmt|;
comment|/* 			 * Merge the rdataset into the database. 			 */
if|if
condition|(
name|op
operator|==
name|DNS_DIFFOP_ADD
condition|)
block|{
name|result
operator|=
name|dns_db_addrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|ver
argument_list|,
literal|0
argument_list|,
operator|&
name|rds
argument_list|,
name|DNS_DBADD_MERGE
operator||
name|DNS_DBADD_EXACT
operator||
name|DNS_DBADD_EXACTTTL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|op
operator|==
name|DNS_DIFFOP_DEL
condition|)
block|{
name|result
operator|=
name|dns_db_subtractrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|ver
argument_list|,
operator|&
name|rds
argument_list|,
name|DNS_DBSUB_EXACT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|DNS_R_UNCHANGED
condition|)
block|{
comment|/* 				 * This will not happen when executing a 				 * dynamic update, because that code will 				 * generate strictly minimal diffs. 				 * It may happen when receiving an IXFR 				 * from a server that is not as careful. 				 * Issue a warning and continue. 				 */
if|if
condition|(
name|warn
condition|)
name|isc_log_write
argument_list|(
name|DIFF_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"update with no effect"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|||
name|result
operator|==
name|DNS_R_NXRRSET
condition|)
block|{
comment|/* 				 * OK. 				 */
block|}
else|else
block|{
name|CHECK
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
block|}
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|failure
label|:
if|if
condition|(
name|node
operator|!=
name|NULL
condition|)
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_diff_apply
parameter_list|(
name|dns_diff_t
modifier|*
name|diff
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
name|ver
parameter_list|)
block|{
return|return
operator|(
name|diff_apply
argument_list|(
name|diff
argument_list|,
name|db
argument_list|,
name|ver
argument_list|,
name|ISC_TRUE
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_diff_applysilently
parameter_list|(
name|dns_diff_t
modifier|*
name|diff
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
name|ver
parameter_list|)
block|{
return|return
operator|(
name|diff_apply
argument_list|(
name|diff
argument_list|,
name|db
argument_list|,
name|ver
argument_list|,
name|ISC_FALSE
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* XXX this duplicates lots of code in diff_apply(). */
end_comment

begin_function
name|isc_result_t
name|dns_diff_load
parameter_list|(
name|dns_diff_t
modifier|*
name|diff
parameter_list|,
name|dns_addrdatasetfunc_t
name|addfunc
parameter_list|,
name|void
modifier|*
name|add_private
parameter_list|)
block|{
name|dns_difftuple_t
modifier|*
name|t
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_DIFF_VALID
argument_list|(
name|diff
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|diff
operator|->
name|tuples
argument_list|)
expr_stmt|;
while|while
condition|(
name|t
operator|!=
name|NULL
condition|)
block|{
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|name
operator|=
operator|&
name|t
operator|->
name|name
expr_stmt|;
while|while
condition|(
name|t
operator|!=
name|NULL
operator|&&
name|dns_name_equal
argument_list|(
operator|&
name|t
operator|->
name|name
argument_list|,
name|name
argument_list|)
condition|)
block|{
name|dns_rdatatype_t
name|type
decl_stmt|,
name|covers
decl_stmt|;
name|dns_diffop_t
name|op
decl_stmt|;
name|dns_rdatalist_t
name|rdl
decl_stmt|;
name|dns_rdataset_t
name|rds
decl_stmt|;
name|op
operator|=
name|t
operator|->
name|op
expr_stmt|;
name|type
operator|=
name|t
operator|->
name|rdata
operator|.
name|type
expr_stmt|;
name|covers
operator|=
name|rdata_covers
argument_list|(
operator|&
name|t
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|rdl
operator|.
name|type
operator|=
name|type
expr_stmt|;
name|rdl
operator|.
name|covers
operator|=
name|covers
expr_stmt|;
name|rdl
operator|.
name|rdclass
operator|=
name|t
operator|->
name|rdata
operator|.
name|rdclass
expr_stmt|;
name|rdl
operator|.
name|ttl
operator|=
name|t
operator|->
name|ttl
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rdl
operator|.
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
operator|&
name|rdl
argument_list|,
name|link
argument_list|)
expr_stmt|;
while|while
condition|(
name|t
operator|!=
name|NULL
operator|&&
name|dns_name_equal
argument_list|(
operator|&
name|t
operator|->
name|name
argument_list|,
name|name
argument_list|)
operator|&&
name|t
operator|->
name|op
operator|==
name|op
operator|&&
name|t
operator|->
name|rdata
operator|.
name|type
operator|==
name|type
operator|&&
name|rdata_covers
argument_list|(
operator|&
name|t
operator|->
name|rdata
argument_list|)
operator|==
name|covers
condition|)
block|{
name|ISC_LIST_APPEND
argument_list|(
name|rdl
operator|.
name|rdata
argument_list|,
operator|&
name|t
operator|->
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|t
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|t
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
comment|/* 			 * Convert the rdatalist into a rdataset. 			 */
name|dns_rdataset_init
argument_list|(
operator|&
name|rds
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_rdatalist_tordataset
argument_list|(
operator|&
name|rdl
argument_list|,
operator|&
name|rds
argument_list|)
argument_list|)
expr_stmt|;
name|rds
operator|.
name|trust
operator|=
name|dns_trust_ultimate
expr_stmt|;
name|INSIST
argument_list|(
name|op
operator|==
name|DNS_DIFFOP_ADD
argument_list|)
expr_stmt|;
name|result
operator|=
call|(
modifier|*
name|addfunc
call|)
argument_list|(
name|add_private
argument_list|,
name|name
argument_list|,
operator|&
name|rds
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_UNCHANGED
condition|)
block|{
name|isc_log_write
argument_list|(
name|DIFF_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"update with no effect"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|||
name|result
operator|==
name|DNS_R_NXRRSET
condition|)
block|{
comment|/* 				 * OK. 				 */
block|}
else|else
block|{
name|CHECK
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|failure
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * XXX uses qsort(); a merge sort would be more natural for lists,  * and perhaps safer wrt thread stack overflow.  */
end_comment

begin_function
name|isc_result_t
name|dns_diff_sort
parameter_list|(
name|dns_diff_t
modifier|*
name|diff
parameter_list|,
name|dns_diff_compare_func
modifier|*
name|compare
parameter_list|)
block|{
name|unsigned
name|int
name|length
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|dns_difftuple_t
modifier|*
modifier|*
name|v
decl_stmt|;
name|dns_difftuple_t
modifier|*
name|p
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_DIFF_VALID
argument_list|(
name|diff
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|diff
operator|->
name|tuples
argument_list|)
init|;
name|p
operator|!=
name|NULL
condition|;
name|p
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|p
argument_list|,
name|link
argument_list|)
control|)
name|length
operator|++
expr_stmt|;
if|if
condition|(
name|length
operator|==
literal|0
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|v
operator|=
name|isc_mem_get
argument_list|(
name|diff
operator|->
name|mctx
argument_list|,
name|length
operator|*
sizeof|sizeof
argument_list|(
name|dns_difftuple_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|diff
operator|->
name|tuples
argument_list|)
expr_stmt|;
name|v
index|[
name|i
index|]
operator|=
name|p
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|diff
operator|->
name|tuples
argument_list|,
name|p
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|INSIST
argument_list|(
name|ISC_LIST_HEAD
argument_list|(
name|diff
operator|->
name|tuples
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|qsort
argument_list|(
name|v
argument_list|,
name|length
argument_list|,
sizeof|sizeof
argument_list|(
name|v
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|compare
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
name|ISC_LIST_APPEND
argument_list|(
name|diff
operator|->
name|tuples
argument_list|,
name|v
index|[
name|i
index|]
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|isc_mem_put
argument_list|(
name|diff
operator|->
name|mctx
argument_list|,
name|v
argument_list|,
name|length
operator|*
sizeof|sizeof
argument_list|(
name|dns_difftuple_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Create an rdataset containing the single RR of the given  * tuple.  The caller must allocate the rdata, rdataset and  * an rdatalist structure for it to refer to.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|diff_tuple_tordataset
parameter_list|(
name|dns_difftuple_t
modifier|*
name|t
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|,
name|dns_rdatalist_t
modifier|*
name|rdl
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rds
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_DIFFTUPLE_VALID
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdl
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rds
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|rdl
operator|->
name|type
operator|=
name|t
operator|->
name|rdata
operator|.
name|type
expr_stmt|;
name|rdl
operator|->
name|rdclass
operator|=
name|t
operator|->
name|rdata
operator|.
name|rdclass
expr_stmt|;
name|rdl
operator|->
name|ttl
operator|=
name|t
operator|->
name|ttl
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rdl
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|rdl
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
name|rds
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_rdata_clone
argument_list|(
operator|&
name|t
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdl
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|dns_rdatalist_tordataset
argument_list|(
name|rdl
argument_list|,
name|rds
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_diff_print
parameter_list|(
name|dns_diff_t
modifier|*
name|diff
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_difftuple_t
modifier|*
name|t
decl_stmt|;
name|char
modifier|*
name|mem
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|size
init|=
literal|2048
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_DIFF_VALID
argument_list|(
name|diff
argument_list|)
argument_list|)
expr_stmt|;
name|mem
operator|=
name|isc_mem_get
argument_list|(
name|diff
operator|->
name|mctx
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
for|for
control|(
name|t
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|diff
operator|->
name|tuples
argument_list|)
init|;
name|t
operator|!=
name|NULL
condition|;
name|t
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|t
argument_list|,
name|link
argument_list|)
control|)
block|{
name|isc_buffer_t
name|buf
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|dns_rdatalist_t
name|rdl
decl_stmt|;
name|dns_rdataset_t
name|rds
decl_stmt|;
name|dns_rdata_t
name|rd
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|result
operator|=
name|diff_tuple_tordataset
argument_list|(
name|t
argument_list|,
operator|&
name|rd
argument_list|,
operator|&
name|rdl
argument_list|,
operator|&
name|rds
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"diff_tuple_tordataset failed: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_UNEXPECTED
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|again
label|:
name|isc_buffer_init
argument_list|(
operator|&
name|buf
argument_list|,
name|mem
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_totext
argument_list|(
operator|&
name|rds
argument_list|,
operator|&
name|t
operator|->
name|name
argument_list|,
name|ISC_FALSE
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOSPACE
condition|)
block|{
name|isc_mem_put
argument_list|(
name|diff
operator|->
name|mctx
argument_list|,
name|mem
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|size
operator|+=
literal|1024
expr_stmt|;
name|mem
operator|=
name|isc_mem_get
argument_list|(
name|diff
operator|->
name|mctx
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
goto|goto
name|again
goto|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
comment|/* 		 * Get rid of final newline. 		 */
name|INSIST
argument_list|(
name|buf
operator|.
name|used
operator|>=
literal|1
operator|&&
operator|(
operator|(
name|char
operator|*
operator|)
name|buf
operator|.
name|base
operator|)
index|[
name|buf
operator|.
name|used
operator|-
literal|1
index|]
operator|==
literal|'\n'
argument_list|)
expr_stmt|;
name|buf
operator|.
name|used
operator|--
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|file
operator|!=
name|NULL
condition|)
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"%s %.*s\n"
argument_list|,
name|t
operator|->
name|op
operator|==
name|DNS_DIFFOP_ADD
condition|?
literal|"add"
else|:
literal|"del"
argument_list|,
operator|(
name|int
operator|)
name|r
operator|.
name|length
argument_list|,
operator|(
name|char
operator|*
operator|)
name|r
operator|.
name|base
argument_list|)
expr_stmt|;
else|else
name|isc_log_write
argument_list|(
name|DIFF_COMMON_LOGARGS
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|7
argument_list|)
argument_list|,
literal|"%s %.*s"
argument_list|,
name|t
operator|->
name|op
operator|==
name|DNS_DIFFOP_ADD
condition|?
literal|"add"
else|:
literal|"del"
argument_list|,
operator|(
name|int
operator|)
name|r
operator|.
name|length
argument_list|,
operator|(
name|char
operator|*
operator|)
name|r
operator|.
name|base
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|mem
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|diff
operator|->
name|mctx
argument_list|,
name|mem
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

end_unit


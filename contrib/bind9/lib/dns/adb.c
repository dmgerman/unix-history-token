begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: adb.c,v 1.181.2.11.2.20 2004/11/10 22:32:40 marka Exp $ */
end_comment

begin_comment
comment|/*  * Implementation notes  * --------------------  *  * In finds, if task == NULL, no events will be generated, and no events  * have been sent.  If task != NULL but taskaction == NULL, an event has been  * posted but not yet freed.  If neither are NULL, no event was posted.  *  */
end_comment

begin_comment
comment|/*  * After we have cleaned all buckets, dump the database contents.  */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_define
define|#
directive|define
name|DUMP_ADB_AFTER_CLEANING
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<isc/mutexblock.h>
end_include

begin_include
include|#
directive|include
file|<isc/netaddr.h>
end_include

begin_include
include|#
directive|include
file|<isc/random.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_comment
comment|/* Required for HP/UX (and others?) */
end_comment

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/timer.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/adb.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/events.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdata.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatastruct.h>
end_include

begin_include
include|#
directive|include
file|<dns/resolver.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_define
define|#
directive|define
name|DNS_ADB_MAGIC
value|ISC_MAGIC('D', 'a', 'd', 'b')
end_define

begin_define
define|#
directive|define
name|DNS_ADB_VALID
parameter_list|(
name|x
parameter_list|)
value|ISC_MAGIC_VALID(x, DNS_ADB_MAGIC)
end_define

begin_define
define|#
directive|define
name|DNS_ADBNAME_MAGIC
value|ISC_MAGIC('a', 'd', 'b', 'N')
end_define

begin_define
define|#
directive|define
name|DNS_ADBNAME_VALID
parameter_list|(
name|x
parameter_list|)
value|ISC_MAGIC_VALID(x, DNS_ADBNAME_MAGIC)
end_define

begin_define
define|#
directive|define
name|DNS_ADBNAMEHOOK_MAGIC
value|ISC_MAGIC('a', 'd', 'N', 'H')
end_define

begin_define
define|#
directive|define
name|DNS_ADBNAMEHOOK_VALID
parameter_list|(
name|x
parameter_list|)
value|ISC_MAGIC_VALID(x, DNS_ADBNAMEHOOK_MAGIC)
end_define

begin_define
define|#
directive|define
name|DNS_ADBZONEINFO_MAGIC
value|ISC_MAGIC('a', 'd', 'b', 'Z')
end_define

begin_define
define|#
directive|define
name|DNS_ADBZONEINFO_VALID
parameter_list|(
name|x
parameter_list|)
value|ISC_MAGIC_VALID(x, DNS_ADBZONEINFO_MAGIC)
end_define

begin_define
define|#
directive|define
name|DNS_ADBENTRY_MAGIC
value|ISC_MAGIC('a', 'd', 'b', 'E')
end_define

begin_define
define|#
directive|define
name|DNS_ADBENTRY_VALID
parameter_list|(
name|x
parameter_list|)
value|ISC_MAGIC_VALID(x, DNS_ADBENTRY_MAGIC)
end_define

begin_define
define|#
directive|define
name|DNS_ADBFETCH_MAGIC
value|ISC_MAGIC('a', 'd', 'F', '4')
end_define

begin_define
define|#
directive|define
name|DNS_ADBFETCH_VALID
parameter_list|(
name|x
parameter_list|)
value|ISC_MAGIC_VALID(x, DNS_ADBFETCH_MAGIC)
end_define

begin_define
define|#
directive|define
name|DNS_ADBFETCH6_MAGIC
value|ISC_MAGIC('a', 'd', 'F', '6')
end_define

begin_define
define|#
directive|define
name|DNS_ADBFETCH6_VALID
parameter_list|(
name|x
parameter_list|)
value|ISC_MAGIC_VALID(x, DNS_ADBFETCH6_MAGIC)
end_define

begin_comment
comment|/*  * The number of buckets needs to be a prime (for good hashing).  *  * XXXRTH  How many buckets do we need?  */
end_comment

begin_define
define|#
directive|define
name|NBUCKETS
value|1009
end_define

begin_comment
comment|/* how many buckets for names/addrs */
end_comment

begin_comment
comment|/*  * For type 3 negative cache entries, we will remember that the address is  * broken for this long.  XXXMLG This is also used for actual addresses, too.  * The intent is to keep us from constantly asking about A/AAAA records  * if the zone has extremely low TTLs.  */
end_comment

begin_define
define|#
directive|define
name|ADB_CACHE_MINIMUM
value|10
end_define

begin_comment
comment|/* seconds */
end_comment

begin_define
define|#
directive|define
name|ADB_CACHE_MAXIMUM
value|86400
end_define

begin_comment
comment|/* seconds (86400 = 24 hours) */
end_comment

begin_define
define|#
directive|define
name|ADB_ENTRY_WINDOW
value|1800
end_define

begin_comment
comment|/* seconds */
end_comment

begin_comment
comment|/*  * Wake up every CLEAN_SECONDS and clean CLEAN_BUCKETS buckets, so that all  * buckets are cleaned in CLEAN_PERIOD seconds.  */
end_comment

begin_define
define|#
directive|define
name|CLEAN_PERIOD
value|3600
end_define

begin_define
define|#
directive|define
name|CLEAN_SECONDS
value|30
end_define

begin_define
define|#
directive|define
name|CLEAN_BUCKETS
value|((NBUCKETS * CLEAN_SECONDS) / CLEAN_PERIOD)
end_define

begin_define
define|#
directive|define
name|FREE_ITEMS
value|64
end_define

begin_comment
comment|/* free count for memory pools */
end_comment

begin_define
define|#
directive|define
name|FILL_COUNT
value|16
end_define

begin_comment
comment|/* fill count for memory pools */
end_comment

begin_define
define|#
directive|define
name|DNS_ADB_INVALIDBUCKET
value|(-1)
end_define

begin_comment
comment|/* invalid bucket address */
end_comment

begin_define
define|#
directive|define
name|DNS_ADB_MINADBSIZE
value|(1024*1024)
end_define

begin_comment
comment|/* 1 Megabyte */
end_comment

begin_typedef
typedef|typedef
name|ISC_LIST
argument_list|(
argument|dns_adbname_t
argument_list|)
name|dns_adbnamelist_t
expr_stmt|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|dns_adbnamehook
name|dns_adbnamehook_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|ISC_LIST
argument_list|(
argument|dns_adbnamehook_t
argument_list|)
name|dns_adbnamehooklist_t
expr_stmt|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|dns_adbzoneinfo
name|dns_adbzoneinfo_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|ISC_LIST
argument_list|(
argument|dns_adbentry_t
argument_list|)
name|dns_adbentrylist_t
expr_stmt|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|dns_adbfetch
name|dns_adbfetch_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|dns_adbfetch6
name|dns_adbfetch6_t
typedef|;
end_typedef

begin_struct
struct|struct
name|dns_adb
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
name|isc_mutex_t
name|reflock
decl_stmt|;
comment|/* Covers irefcnt, erefcnt */
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|isc_timermgr_t
modifier|*
name|timermgr
decl_stmt|;
name|isc_timer_t
modifier|*
name|timer
decl_stmt|;
name|isc_taskmgr_t
modifier|*
name|taskmgr
decl_stmt|;
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|isc_boolean_t
name|overmem
decl_stmt|;
name|isc_interval_t
name|tick_interval
decl_stmt|;
name|int
name|next_cleanbucket
decl_stmt|;
name|unsigned
name|int
name|irefcnt
decl_stmt|;
name|unsigned
name|int
name|erefcnt
decl_stmt|;
name|isc_mutex_t
name|mplock
decl_stmt|;
name|isc_mempool_t
modifier|*
name|nmp
decl_stmt|;
comment|/* dns_adbname_t */
name|isc_mempool_t
modifier|*
name|nhmp
decl_stmt|;
comment|/* dns_adbnamehook_t */
name|isc_mempool_t
modifier|*
name|zimp
decl_stmt|;
comment|/* dns_adbzoneinfo_t */
name|isc_mempool_t
modifier|*
name|emp
decl_stmt|;
comment|/* dns_adbentry_t */
name|isc_mempool_t
modifier|*
name|ahmp
decl_stmt|;
comment|/* dns_adbfind_t */
name|isc_mempool_t
modifier|*
name|aimp
decl_stmt|;
comment|/* dns_adbaddrinfo_t */
name|isc_mempool_t
modifier|*
name|afmp
decl_stmt|;
comment|/* dns_adbfetch_t */
comment|/* 	 * Bucketized locks and lists for names. 	 * 	 * XXXRTH  Have a per-bucket structure that contains all of these? 	 */
name|dns_adbnamelist_t
name|names
index|[
name|NBUCKETS
index|]
decl_stmt|;
name|isc_mutex_t
name|namelocks
index|[
name|NBUCKETS
index|]
decl_stmt|;
name|isc_boolean_t
name|name_sd
index|[
name|NBUCKETS
index|]
decl_stmt|;
name|unsigned
name|int
name|name_refcnt
index|[
name|NBUCKETS
index|]
decl_stmt|;
comment|/* 	 * Bucketized locks for entries. 	 * 	 * XXXRTH  Have a per-bucket structure that contains all of these? 	 */
name|dns_adbentrylist_t
name|entries
index|[
name|NBUCKETS
index|]
decl_stmt|;
name|isc_mutex_t
name|entrylocks
index|[
name|NBUCKETS
index|]
decl_stmt|;
name|isc_boolean_t
name|entry_sd
index|[
name|NBUCKETS
index|]
decl_stmt|;
comment|/* shutting down */
name|unsigned
name|int
name|entry_refcnt
index|[
name|NBUCKETS
index|]
decl_stmt|;
name|isc_event_t
name|cevent
decl_stmt|;
name|isc_boolean_t
name|cevent_sent
decl_stmt|;
name|isc_boolean_t
name|shutting_down
decl_stmt|;
name|isc_eventlist_t
name|whenshutdown
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * XXXMLG  Document these structures.  */
end_comment

begin_struct
struct|struct
name|dns_adbname
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|dns_name_t
name|name
decl_stmt|;
name|dns_adb_t
modifier|*
name|adb
decl_stmt|;
name|unsigned
name|int
name|partial_result
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
name|int
name|lock_bucket
decl_stmt|;
name|dns_name_t
name|target
decl_stmt|;
name|isc_stdtime_t
name|expire_target
decl_stmt|;
name|isc_stdtime_t
name|expire_v4
decl_stmt|;
name|isc_stdtime_t
name|expire_v6
decl_stmt|;
name|unsigned
name|int
name|chains
decl_stmt|;
name|dns_adbnamehooklist_t
name|v4
decl_stmt|;
name|dns_adbnamehooklist_t
name|v6
decl_stmt|;
name|dns_adbfetch_t
modifier|*
name|fetch_a
decl_stmt|;
name|dns_adbfetch_t
modifier|*
name|fetch_aaaa
decl_stmt|;
name|unsigned
name|int
name|fetch_err
decl_stmt|;
name|unsigned
name|int
name|fetch6_err
decl_stmt|;
name|dns_adbfindlist_t
name|finds
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|dns_adbname_t
argument_list|)
name|plink
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|dns_adbfetch
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|dns_adbnamehook_t
modifier|*
name|namehook
decl_stmt|;
name|dns_adbentry_t
modifier|*
name|entry
decl_stmt|;
name|dns_fetch_t
modifier|*
name|fetch
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * dns_adbnamehook_t  *  * This is a small widget that dangles off a dns_adbname_t.  It contains a  * pointer to the address information about this host, and a link to the next  * namehook that will contain the next address this host has.  */
end_comment

begin_struct
struct|struct
name|dns_adbnamehook
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|dns_adbentry_t
modifier|*
name|entry
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|dns_adbnamehook_t
argument_list|)
name|plink
expr_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * dns_adbzoneinfo_t  *  * This is a small widget that holds zone-specific information about an  * address.  Currently limited to lameness, but could just as easily be  * extended to other types of information about zones.  */
end_comment

begin_struct
struct|struct
name|dns_adbzoneinfo
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|dns_name_t
name|zone
decl_stmt|;
name|isc_stdtime_t
name|lame_timer
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|dns_adbzoneinfo_t
argument_list|)
name|plink
expr_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * An address entry.  It holds quite a bit of information about addresses,  * including edns state (in "flags"), rtt, and of course the address of  * the host.  */
end_comment

begin_struct
struct|struct
name|dns_adbentry
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|int
name|lock_bucket
decl_stmt|;
name|unsigned
name|int
name|refcnt
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
name|unsigned
name|int
name|srtt
decl_stmt|;
name|isc_sockaddr_t
name|sockaddr
decl_stmt|;
name|isc_stdtime_t
name|expires
decl_stmt|;
comment|/* 	 * A nonzero 'expires' field indicates that the entry should 	 * persist until that time.  This allows entries found 	 * using dns_adb_findaddrinfo() to persist for a limited time 	 * even though they are not necessarily associated with a 	 * name. 	 */
name|ISC_LIST
argument_list|(
argument|dns_adbzoneinfo_t
argument_list|)
name|zoneinfo
expr_stmt|;
name|ISC_LINK
argument_list|(
argument|dns_adbentry_t
argument_list|)
name|plink
expr_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Internal functions (and prototypes).  */
end_comment

begin_function_decl
specifier|static
specifier|inline
name|dns_adbname_t
modifier|*
name|new_adbname
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_name_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|free_adbname
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_adbname_t
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|dns_adbnamehook_t
modifier|*
name|new_adbnamehook
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_adbentry_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|free_adbnamehook
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_adbnamehook_t
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|dns_adbzoneinfo_t
modifier|*
name|new_adbzoneinfo
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_name_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|free_adbzoneinfo
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_adbzoneinfo_t
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|dns_adbentry_t
modifier|*
name|new_adbentry
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|free_adbentry
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_adbentry_t
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|dns_adbfind_t
modifier|*
name|new_adbfind
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|isc_boolean_t
name|free_adbfind
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_adbfind_t
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|dns_adbaddrinfo_t
modifier|*
name|new_adbaddrinfo
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_adbentry_t
modifier|*
parameter_list|,
name|in_port_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|dns_adbfetch_t
modifier|*
name|new_adbfetch
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|free_adbfetch
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_adbfetch_t
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|dns_adbname_t
modifier|*
name|find_name_and_lock
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_name_t
modifier|*
parameter_list|,
name|unsigned
name|int
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|dns_adbentry_t
modifier|*
name|find_entry_and_lock
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|isc_sockaddr_t
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_adb
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|FILE
modifier|*
parameter_list|,
name|isc_boolean_t
name|debug
parameter_list|,
name|isc_stdtime_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_dns_name
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|dns_name_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_namehook_list
parameter_list|(
name|FILE
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
name|legend
parameter_list|,
name|dns_adbnamehooklist_t
modifier|*
name|list
parameter_list|,
name|isc_boolean_t
name|debug
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_find_list
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|dns_adbname_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_fetch_list
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|dns_adbname_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|isc_boolean_t
name|dec_adb_irefcnt
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|inc_adb_irefcnt
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|inc_adb_erefcnt
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|inc_entry_refcnt
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_adbentry_t
modifier|*
parameter_list|,
name|isc_boolean_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|isc_boolean_t
name|dec_entry_refcnt
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_adbentry_t
modifier|*
parameter_list|,
name|isc_boolean_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|violate_locking_hierarchy
parameter_list|(
name|isc_mutex_t
modifier|*
parameter_list|,
name|isc_mutex_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_boolean_t
name|clean_namehooks
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_adbnamehooklist_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|clean_target
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_name_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|clean_finds_at_name
parameter_list|(
name|dns_adbname_t
modifier|*
parameter_list|,
name|isc_eventtype_t
parameter_list|,
name|unsigned
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_boolean_t
name|check_expire_namehooks
parameter_list|(
name|dns_adbname_t
modifier|*
parameter_list|,
name|isc_stdtime_t
parameter_list|,
name|isc_boolean_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cancel_fetches_at_name
parameter_list|(
name|dns_adbname_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbfind_name
parameter_list|(
name|dns_adbname_t
modifier|*
parameter_list|,
name|isc_stdtime_t
parameter_list|,
name|dns_rdatatype_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|fetch_name
parameter_list|(
name|dns_adbname_t
modifier|*
parameter_list|,
name|isc_boolean_t
parameter_list|,
name|dns_rdatatype_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|check_exit
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|timer_cleanup
parameter_list|(
name|isc_task_t
modifier|*
parameter_list|,
name|isc_event_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|destroy
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_boolean_t
name|shutdown_names
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_boolean_t
name|shutdown_entries
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|link_name
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|dns_adbname_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|isc_boolean_t
name|unlink_name
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_adbname_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|link_entry
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|dns_adbentry_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|isc_boolean_t
name|unlink_entry
parameter_list|(
name|dns_adb_t
modifier|*
parameter_list|,
name|dns_adbentry_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_boolean_t
name|kill_name
parameter_list|(
name|dns_adbname_t
modifier|*
modifier|*
parameter_list|,
name|isc_eventtype_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|water
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_entry
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|dns_adbentry_t
modifier|*
parameter_list|,
name|isc_boolean_t
parameter_list|,
name|isc_stdtime_t
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * MUST NOT overlap DNS_ADBFIND_* flags!  */
end_comment

begin_define
define|#
directive|define
name|FIND_EVENT_SENT
value|0x40000000
end_define

begin_define
define|#
directive|define
name|FIND_EVENT_FREED
value|0x80000000
end_define

begin_define
define|#
directive|define
name|FIND_EVENTSENT
parameter_list|(
name|h
parameter_list|)
value|(((h)->flags& FIND_EVENT_SENT) != 0)
end_define

begin_define
define|#
directive|define
name|FIND_EVENTFREED
parameter_list|(
name|h
parameter_list|)
value|(((h)->flags& FIND_EVENT_FREED) != 0)
end_define

begin_define
define|#
directive|define
name|NAME_NEEDS_POKE
value|0x80000000
end_define

begin_define
define|#
directive|define
name|NAME_IS_DEAD
value|0x40000000
end_define

begin_define
define|#
directive|define
name|NAME_HINT_OK
value|DNS_ADBFIND_HINTOK
end_define

begin_define
define|#
directive|define
name|NAME_GLUE_OK
value|DNS_ADBFIND_GLUEOK
end_define

begin_define
define|#
directive|define
name|NAME_STARTATZONE
value|DNS_ADBFIND_STARTATZONE
end_define

begin_define
define|#
directive|define
name|NAME_DEAD
parameter_list|(
name|n
parameter_list|)
value|(((n)->flags& NAME_IS_DEAD) != 0)
end_define

begin_define
define|#
directive|define
name|NAME_NEEDSPOKE
parameter_list|(
name|n
parameter_list|)
value|(((n)->flags& NAME_NEEDS_POKE) != 0)
end_define

begin_define
define|#
directive|define
name|NAME_GLUEOK
parameter_list|(
name|n
parameter_list|)
value|(((n)->flags& NAME_GLUE_OK) != 0)
end_define

begin_define
define|#
directive|define
name|NAME_HINTOK
parameter_list|(
name|n
parameter_list|)
value|(((n)->flags& NAME_HINT_OK) != 0)
end_define

begin_comment
comment|/*  * To the name, address classes are all that really exist.  If it has a  * V6 address it doesn't care if it came from a AAAA query.  */
end_comment

begin_define
define|#
directive|define
name|NAME_HAS_V4
parameter_list|(
name|n
parameter_list|)
value|(!ISC_LIST_EMPTY((n)->v4))
end_define

begin_define
define|#
directive|define
name|NAME_HAS_V6
parameter_list|(
name|n
parameter_list|)
value|(!ISC_LIST_EMPTY((n)->v6))
end_define

begin_define
define|#
directive|define
name|NAME_HAS_ADDRS
parameter_list|(
name|n
parameter_list|)
value|(NAME_HAS_V4(n) || NAME_HAS_V6(n))
end_define

begin_comment
comment|/*  * Fetches are broken out into A and AAAA types.  In some cases,  * however, it makes more sense to test for a particular class of fetches,  * like V4 or V6 above.  * Note: since we have removed the support of A6 in adb, FETCH_A and FETCH_AAAA  * are now equal to FETCH_V4 and FETCH_V6, respectively.  */
end_comment

begin_define
define|#
directive|define
name|NAME_FETCH_A
parameter_list|(
name|n
parameter_list|)
value|((n)->fetch_a != NULL)
end_define

begin_define
define|#
directive|define
name|NAME_FETCH_AAAA
parameter_list|(
name|n
parameter_list|)
value|((n)->fetch_aaaa != NULL)
end_define

begin_define
define|#
directive|define
name|NAME_FETCH_V4
parameter_list|(
name|n
parameter_list|)
value|(NAME_FETCH_A(n))
end_define

begin_define
define|#
directive|define
name|NAME_FETCH_V6
parameter_list|(
name|n
parameter_list|)
value|(NAME_FETCH_AAAA(n))
end_define

begin_define
define|#
directive|define
name|NAME_FETCH
parameter_list|(
name|n
parameter_list|)
value|(NAME_FETCH_V4(n) || NAME_FETCH_V6(n))
end_define

begin_comment
comment|/*  * Find options and tests to see if there are addresses on the list.  */
end_comment

begin_define
define|#
directive|define
name|FIND_WANTEVENT
parameter_list|(
name|fn
parameter_list|)
value|(((fn)->options& DNS_ADBFIND_WANTEVENT) != 0)
end_define

begin_define
define|#
directive|define
name|FIND_WANTEMPTYEVENT
parameter_list|(
name|fn
parameter_list|)
value|(((fn)->options& DNS_ADBFIND_EMPTYEVENT) != 0)
end_define

begin_define
define|#
directive|define
name|FIND_AVOIDFETCHES
parameter_list|(
name|fn
parameter_list|)
value|(((fn)->options& DNS_ADBFIND_AVOIDFETCHES) \ 				 != 0)
end_define

begin_define
define|#
directive|define
name|FIND_STARTATZONE
parameter_list|(
name|fn
parameter_list|)
value|(((fn)->options& DNS_ADBFIND_STARTATZONE) \ 				 != 0)
end_define

begin_define
define|#
directive|define
name|FIND_HINTOK
parameter_list|(
name|fn
parameter_list|)
value|(((fn)->options& DNS_ADBFIND_HINTOK) != 0)
end_define

begin_define
define|#
directive|define
name|FIND_GLUEOK
parameter_list|(
name|fn
parameter_list|)
value|(((fn)->options& DNS_ADBFIND_GLUEOK) != 0)
end_define

begin_define
define|#
directive|define
name|FIND_HAS_ADDRS
parameter_list|(
name|fn
parameter_list|)
value|(!ISC_LIST_EMPTY((fn)->list))
end_define

begin_define
define|#
directive|define
name|FIND_RETURNLAME
parameter_list|(
name|fn
parameter_list|)
value|(((fn)->options& DNS_ADBFIND_RETURNLAME) != 0)
end_define

begin_comment
comment|/*  * These are currently used on simple unsigned ints, so they are  * not really associated with any particular type.  */
end_comment

begin_define
define|#
directive|define
name|WANT_INET
parameter_list|(
name|x
parameter_list|)
value|(((x)& DNS_ADBFIND_INET) != 0)
end_define

begin_define
define|#
directive|define
name|WANT_INET6
parameter_list|(
name|x
parameter_list|)
value|(((x)& DNS_ADBFIND_INET6) != 0)
end_define

begin_define
define|#
directive|define
name|EXPIRE_OK
parameter_list|(
name|exp
parameter_list|,
name|now
parameter_list|)
value|((exp == INT_MAX) || (exp< now))
end_define

begin_comment
comment|/*  * Find out if the flags on a name (nf) indicate if it is a hint or  * glue, and compare this to the appropriate bits set in o, to see if  * this is ok.  */
end_comment

begin_define
define|#
directive|define
name|GLUE_OK
parameter_list|(
name|nf
parameter_list|,
name|o
parameter_list|)
value|(!NAME_GLUEOK(nf) || (((o)& DNS_ADBFIND_GLUEOK) != 0))
end_define

begin_define
define|#
directive|define
name|HINT_OK
parameter_list|(
name|nf
parameter_list|,
name|o
parameter_list|)
value|(!NAME_HINTOK(nf) || (((o)& DNS_ADBFIND_HINTOK) != 0))
end_define

begin_define
define|#
directive|define
name|GLUEHINT_OK
parameter_list|(
name|nf
parameter_list|,
name|o
parameter_list|)
value|(GLUE_OK(nf, o) || HINT_OK(nf, o))
end_define

begin_define
define|#
directive|define
name|STARTATZONE_MATCHES
parameter_list|(
name|nf
parameter_list|,
name|o
parameter_list|)
value|(((nf)->flags& NAME_STARTATZONE) == \ 				    ((o)& DNS_ADBFIND_STARTATZONE))
end_define

begin_define
define|#
directive|define
name|ENTER_LEVEL
value|ISC_LOG_DEBUG(50)
end_define

begin_define
define|#
directive|define
name|EXIT_LEVEL
value|ENTER_LEVEL
end_define

begin_define
define|#
directive|define
name|CLEAN_LEVEL
value|ISC_LOG_DEBUG(100)
end_define

begin_define
define|#
directive|define
name|DEF_LEVEL
value|ISC_LOG_DEBUG(5)
end_define

begin_define
define|#
directive|define
name|NCACHE_LEVEL
value|ISC_LOG_DEBUG(20)
end_define

begin_define
define|#
directive|define
name|NCACHE_RESULT
parameter_list|(
name|r
parameter_list|)
value|((r) == DNS_R_NCACHENXDOMAIN || \ 				 (r) == DNS_R_NCACHENXRRSET)
end_define

begin_define
define|#
directive|define
name|AUTH_NX
parameter_list|(
name|r
parameter_list|)
value|((r) == DNS_R_NXDOMAIN || \ 				 (r) == DNS_R_NXRRSET)
end_define

begin_define
define|#
directive|define
name|NXDOMAIN_RESULT
parameter_list|(
name|r
parameter_list|)
value|((r) == DNS_R_NXDOMAIN || \ 				 (r) == DNS_R_NCACHENXDOMAIN)
end_define

begin_define
define|#
directive|define
name|NXRRSET_RESULT
parameter_list|(
name|r
parameter_list|)
value|((r) == DNS_R_NCACHENXRRSET || \ 				 (r) == DNS_R_NXRRSET || \ 				 (r) == DNS_R_HINTNXRRSET)
end_define

begin_comment
comment|/*  * Error state rankings.  */
end_comment

begin_define
define|#
directive|define
name|FIND_ERR_SUCCESS
value|0
end_define

begin_comment
comment|/* highest rank */
end_comment

begin_define
define|#
directive|define
name|FIND_ERR_CANCELED
value|1
end_define

begin_define
define|#
directive|define
name|FIND_ERR_FAILURE
value|2
end_define

begin_define
define|#
directive|define
name|FIND_ERR_NXDOMAIN
value|3
end_define

begin_define
define|#
directive|define
name|FIND_ERR_NXRRSET
value|4
end_define

begin_define
define|#
directive|define
name|FIND_ERR_UNEXPECTED
value|5
end_define

begin_define
define|#
directive|define
name|FIND_ERR_NOTFOUND
value|6
end_define

begin_define
define|#
directive|define
name|FIND_ERR_MAX
value|7
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|errnames
index|[]
init|=
block|{
literal|"success"
block|,
literal|"canceled"
block|,
literal|"failure"
block|,
literal|"nxdomain"
block|,
literal|"nxrrset"
block|,
literal|"unexpected"
block|,
literal|"not_found"
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NEWERR
parameter_list|(
name|old
parameter_list|,
name|new
parameter_list|)
value|(ISC_MIN((old), (new)))
end_define

begin_decl_stmt
specifier|static
name|isc_result_t
name|find_err_map
index|[
name|FIND_ERR_MAX
index|]
init|=
block|{
name|ISC_R_SUCCESS
block|,
name|ISC_R_CANCELED
block|,
name|ISC_R_FAILURE
block|,
name|DNS_R_NXDOMAIN
block|,
name|DNS_R_NXRRSET
block|,
name|ISC_R_UNEXPECTED
block|,
name|ISC_R_NOTFOUND
comment|/* not YET found */
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|DP
parameter_list|(
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|2
operator|,
function_decl|3
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|void
name|DP
parameter_list|(
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|isc_log_vwrite
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_DATABASE
argument_list|,
name|DNS_LOGMODULE_ADB
argument_list|,
name|level
argument_list|,
name|format
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|dns_ttl_t
name|ttlclamp
parameter_list|(
name|dns_ttl_t
name|ttl
parameter_list|)
block|{
if|if
condition|(
name|ttl
operator|<
name|ADB_CACHE_MINIMUM
condition|)
name|ttl
operator|=
name|ADB_CACHE_MINIMUM
expr_stmt|;
if|if
condition|(
name|ttl
operator|>
name|ADB_CACHE_MAXIMUM
condition|)
name|ttl
operator|=
name|ADB_CACHE_MAXIMUM
expr_stmt|;
return|return
operator|(
name|ttl
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Requires the adbname bucket be locked and that no entry buckets be locked.  *  * This code handles A and AAAA rdatasets only.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|import_rdataset
parameter_list|(
name|dns_adbname_t
modifier|*
name|adbname
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_adb_t
modifier|*
name|adb
decl_stmt|;
name|dns_adbnamehook_t
modifier|*
name|nh
decl_stmt|;
name|dns_adbnamehook_t
modifier|*
name|anh
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|struct
name|in_addr
name|ina
decl_stmt|;
name|struct
name|in6_addr
name|in6a
decl_stmt|;
name|isc_sockaddr_t
name|sockaddr
decl_stmt|;
name|dns_adbentry_t
modifier|*
name|foundentry
decl_stmt|;
comment|/* NO CLEAN UP! */
name|int
name|addr_bucket
decl_stmt|;
name|isc_boolean_t
name|new_addresses_added
decl_stmt|;
name|dns_rdatatype_t
name|rdtype
decl_stmt|;
name|unsigned
name|int
name|findoptions
decl_stmt|;
name|INSIST
argument_list|(
name|DNS_ADBNAME_VALID
argument_list|(
name|adbname
argument_list|)
argument_list|)
expr_stmt|;
name|adb
operator|=
name|adbname
operator|->
name|adb
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|rdtype
operator|=
name|rdataset
operator|->
name|type
expr_stmt|;
name|INSIST
argument_list|(
operator|(
name|rdtype
operator|==
name|dns_rdatatype_a
operator|)
operator|||
operator|(
name|rdtype
operator|==
name|dns_rdatatype_aaaa
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_a
condition|)
name|findoptions
operator|=
name|DNS_ADBFIND_INET
expr_stmt|;
else|else
name|findoptions
operator|=
name|DNS_ADBFIND_INET6
expr_stmt|;
name|addr_bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
name|new_addresses_added
operator|=
name|ISC_FALSE
expr_stmt|;
name|nh
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_a
condition|)
block|{
name|INSIST
argument_list|(
name|rdata
operator|.
name|length
operator|==
literal|4
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|ina
operator|.
name|s_addr
argument_list|,
name|rdata
operator|.
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|isc_sockaddr_fromin
argument_list|(
operator|&
name|sockaddr
argument_list|,
operator|&
name|ina
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|INSIST
argument_list|(
name|rdata
operator|.
name|length
operator|==
literal|16
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|in6a
operator|.
name|s6_addr
argument_list|,
name|rdata
operator|.
name|data
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|isc_sockaddr_fromin6
argument_list|(
operator|&
name|sockaddr
argument_list|,
operator|&
name|in6a
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|INSIST
argument_list|(
name|nh
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|nh
operator|=
name|new_adbnamehook
argument_list|(
name|adb
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|nh
operator|==
name|NULL
condition|)
block|{
name|adbname
operator|->
name|partial_result
operator||=
name|findoptions
expr_stmt|;
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|foundentry
operator|=
name|find_entry_and_lock
argument_list|(
name|adb
argument_list|,
operator|&
name|sockaddr
argument_list|,
operator|&
name|addr_bucket
argument_list|)
expr_stmt|;
if|if
condition|(
name|foundentry
operator|==
name|NULL
condition|)
block|{
name|dns_adbentry_t
modifier|*
name|entry
decl_stmt|;
name|entry
operator|=
name|new_adbentry
argument_list|(
name|adb
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
name|adbname
operator|->
name|partial_result
operator||=
name|findoptions
expr_stmt|;
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|entry
operator|->
name|sockaddr
operator|=
name|sockaddr
expr_stmt|;
name|entry
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
name|nh
operator|->
name|entry
operator|=
name|entry
expr_stmt|;
name|link_entry
argument_list|(
name|adb
argument_list|,
name|addr_bucket
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|anh
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|adbname
operator|->
name|v4
argument_list|)
init|;
name|anh
operator|!=
name|NULL
condition|;
name|anh
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|anh
argument_list|,
name|plink
argument_list|)
control|)
if|if
condition|(
name|anh
operator|->
name|entry
operator|==
name|foundentry
condition|)
break|break;
if|if
condition|(
name|anh
operator|==
name|NULL
condition|)
block|{
name|foundentry
operator|->
name|refcnt
operator|++
expr_stmt|;
name|nh
operator|->
name|entry
operator|=
name|foundentry
expr_stmt|;
block|}
else|else
name|free_adbnamehook
argument_list|(
name|adb
argument_list|,
operator|&
name|nh
argument_list|)
expr_stmt|;
block|}
name|new_addresses_added
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
name|nh
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_a
condition|)
name|ISC_LIST_APPEND
argument_list|(
name|adbname
operator|->
name|v4
argument_list|,
name|nh
argument_list|,
name|plink
argument_list|)
expr_stmt|;
else|else
name|ISC_LIST_APPEND
argument_list|(
name|adbname
operator|->
name|v6
argument_list|,
name|nh
argument_list|,
name|plink
argument_list|)
expr_stmt|;
block|}
name|nh
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
block|}
name|fail
label|:
if|if
condition|(
name|nh
operator|!=
name|NULL
condition|)
name|free_adbnamehook
argument_list|(
name|adb
argument_list|,
operator|&
name|nh
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr_bucket
operator|!=
name|DNS_ADB_INVALIDBUCKET
condition|)
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|addr_bucket
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|->
name|trust
operator|==
name|dns_trust_glue
operator|||
name|rdataset
operator|->
name|trust
operator|==
name|dns_trust_additional
condition|)
name|rdataset
operator|->
name|ttl
operator|=
name|ADB_CACHE_MINIMUM
expr_stmt|;
else|else
name|rdataset
operator|->
name|ttl
operator|=
name|ttlclamp
argument_list|(
name|rdataset
operator|->
name|ttl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_a
condition|)
block|{
name|DP
argument_list|(
name|NCACHE_LEVEL
argument_list|,
literal|"expire_v4 set to MIN(%u,%u) import_rdataset"
argument_list|,
name|adbname
operator|->
name|expire_v4
argument_list|,
name|now
operator|+
name|rdataset
operator|->
name|ttl
argument_list|)
expr_stmt|;
name|adbname
operator|->
name|expire_v4
operator|=
name|ISC_MIN
argument_list|(
name|adbname
operator|->
name|expire_v4
argument_list|,
name|now
operator|+
name|rdataset
operator|->
name|ttl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DP
argument_list|(
name|NCACHE_LEVEL
argument_list|,
literal|"expire_v6 set to MIN(%u,%u) import_rdataset"
argument_list|,
name|adbname
operator|->
name|expire_v6
argument_list|,
name|now
operator|+
name|rdataset
operator|->
name|ttl
argument_list|)
expr_stmt|;
name|adbname
operator|->
name|expire_v6
operator|=
name|ISC_MIN
argument_list|(
name|adbname
operator|->
name|expire_v6
argument_list|,
name|now
operator|+
name|rdataset
operator|->
name|ttl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|new_addresses_added
condition|)
block|{
comment|/* 		 * Lie a little here.  This is more or less so code that cares 		 * can find out if any new information was added or not. 		 */
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Requires the name's bucket be locked.  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|kill_name
parameter_list|(
name|dns_adbname_t
modifier|*
modifier|*
name|n
parameter_list|,
name|isc_eventtype_t
name|ev
parameter_list|)
block|{
name|dns_adbname_t
modifier|*
name|name
decl_stmt|;
name|isc_boolean_t
name|result
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|result4
decl_stmt|,
name|result6
decl_stmt|;
name|dns_adb_t
modifier|*
name|adb
decl_stmt|;
name|INSIST
argument_list|(
name|n
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|name
operator|=
operator|*
name|n
expr_stmt|;
operator|*
name|n
operator|=
name|NULL
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ADBNAME_VALID
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|adb
operator|=
name|name
operator|->
name|adb
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"killing name %p"
argument_list|,
name|name
argument_list|)
expr_stmt|;
comment|/* 	 * If we're dead already, just check to see if we should go 	 * away now or not. 	 */
if|if
condition|(
name|NAME_DEAD
argument_list|(
name|name
argument_list|)
operator|&&
operator|!
name|NAME_FETCH
argument_list|(
name|name
argument_list|)
condition|)
block|{
name|result
operator|=
name|unlink_name
argument_list|(
name|adb
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|free_adbname
argument_list|(
name|adb
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
name|result
operator|=
name|dec_adb_irefcnt
argument_list|(
name|adb
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 	 * Clean up the name's various lists.  These two are destructive 	 * in that they will always empty the list. 	 */
name|clean_finds_at_name
argument_list|(
name|name
argument_list|,
name|ev
argument_list|,
name|DNS_ADBFIND_ADDRESSMASK
argument_list|)
expr_stmt|;
name|result4
operator|=
name|clean_namehooks
argument_list|(
name|adb
argument_list|,
operator|&
name|name
operator|->
name|v4
argument_list|)
expr_stmt|;
name|result6
operator|=
name|clean_namehooks
argument_list|(
name|adb
argument_list|,
operator|&
name|name
operator|->
name|v6
argument_list|)
expr_stmt|;
name|clean_target
argument_list|(
name|adb
argument_list|,
operator|&
name|name
operator|->
name|target
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_TF
argument_list|(
name|result4
operator|||
name|result6
argument_list|)
expr_stmt|;
comment|/* 	 * If fetches are running, cancel them.  If none are running, we can 	 * just kill the name here. 	 */
if|if
condition|(
operator|!
name|NAME_FETCH
argument_list|(
name|name
argument_list|)
condition|)
block|{
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|result
operator|=
name|unlink_name
argument_list|(
name|adb
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|free_adbname
argument_list|(
name|adb
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
name|result
operator|=
name|dec_adb_irefcnt
argument_list|(
name|adb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|name
operator|->
name|flags
operator||=
name|NAME_IS_DEAD
expr_stmt|;
name|cancel_fetches_at_name
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Requires the name's bucket be locked and no entry buckets be locked.  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|check_expire_namehooks
parameter_list|(
name|dns_adbname_t
modifier|*
name|name
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|isc_boolean_t
name|overmem
parameter_list|)
block|{
name|dns_adb_t
modifier|*
name|adb
decl_stmt|;
name|isc_boolean_t
name|expire
decl_stmt|;
name|isc_boolean_t
name|result4
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|result6
init|=
name|ISC_FALSE
decl_stmt|;
name|INSIST
argument_list|(
name|DNS_ADBNAME_VALID
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|adb
operator|=
name|name
operator|->
name|adb
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|overmem
condition|)
block|{
name|isc_uint32_t
name|val
decl_stmt|;
name|isc_random_get
argument_list|(
operator|&
name|val
argument_list|)
expr_stmt|;
name|expire
operator|=
name|ISC_TF
argument_list|(
operator|(
name|val
operator|%
literal|4
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|expire
operator|=
name|ISC_FALSE
expr_stmt|;
comment|/* 	 * Check to see if we need to remove the v4 addresses 	 */
if|if
condition|(
operator|!
name|NAME_FETCH_V4
argument_list|(
name|name
argument_list|)
operator|&&
operator|(
name|expire
operator|||
name|EXPIRE_OK
argument_list|(
name|name
operator|->
name|expire_v4
argument_list|,
name|now
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|NAME_HAS_V4
argument_list|(
name|name
argument_list|)
condition|)
block|{
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"expiring v4 for name %p"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|result4
operator|=
name|clean_namehooks
argument_list|(
name|adb
argument_list|,
operator|&
name|name
operator|->
name|v4
argument_list|)
expr_stmt|;
name|name
operator|->
name|partial_result
operator|&=
operator|~
name|DNS_ADBFIND_INET
expr_stmt|;
block|}
name|name
operator|->
name|expire_v4
operator|=
name|INT_MAX
expr_stmt|;
name|name
operator|->
name|fetch_err
operator|=
name|FIND_ERR_UNEXPECTED
expr_stmt|;
block|}
comment|/* 	 * Check to see if we need to remove the v6 addresses 	 */
if|if
condition|(
operator|!
name|NAME_FETCH_V6
argument_list|(
name|name
argument_list|)
operator|&&
operator|(
name|expire
operator|||
name|EXPIRE_OK
argument_list|(
name|name
operator|->
name|expire_v6
argument_list|,
name|now
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|NAME_HAS_V6
argument_list|(
name|name
argument_list|)
condition|)
block|{
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"expiring v6 for name %p"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|result6
operator|=
name|clean_namehooks
argument_list|(
name|adb
argument_list|,
operator|&
name|name
operator|->
name|v6
argument_list|)
expr_stmt|;
name|name
operator|->
name|partial_result
operator|&=
operator|~
name|DNS_ADBFIND_INET6
expr_stmt|;
block|}
name|name
operator|->
name|expire_v6
operator|=
name|INT_MAX
expr_stmt|;
name|name
operator|->
name|fetch6_err
operator|=
name|FIND_ERR_UNEXPECTED
expr_stmt|;
block|}
comment|/* 	 * Check to see if we need to remove the alias target. 	 */
if|if
condition|(
name|expire
operator|||
name|EXPIRE_OK
argument_list|(
name|name
operator|->
name|expire_target
argument_list|,
name|now
argument_list|)
condition|)
block|{
name|clean_target
argument_list|(
name|adb
argument_list|,
operator|&
name|name
operator|->
name|target
argument_list|)
expr_stmt|;
name|name
operator|->
name|expire_target
operator|=
name|INT_MAX
expr_stmt|;
block|}
return|return
operator|(
name|ISC_TF
argument_list|(
name|result4
operator|||
name|result6
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Requires the name's bucket be locked.  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|link_name
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|int
name|bucket
parameter_list|,
name|dns_adbname_t
modifier|*
name|name
parameter_list|)
block|{
name|INSIST
argument_list|(
name|name
operator|->
name|lock_bucket
operator|==
name|DNS_ADB_INVALIDBUCKET
argument_list|)
expr_stmt|;
name|ISC_LIST_PREPEND
argument_list|(
name|adb
operator|->
name|names
index|[
name|bucket
index|]
argument_list|,
name|name
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|name
operator|->
name|lock_bucket
operator|=
name|bucket
expr_stmt|;
name|adb
operator|->
name|name_refcnt
index|[
name|bucket
index|]
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Requires the name's bucket be locked.  */
end_comment

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|unlink_name
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbname_t
modifier|*
name|name
parameter_list|)
block|{
name|int
name|bucket
decl_stmt|;
name|isc_boolean_t
name|result
init|=
name|ISC_FALSE
decl_stmt|;
name|bucket
operator|=
name|name
operator|->
name|lock_bucket
expr_stmt|;
name|INSIST
argument_list|(
name|bucket
operator|!=
name|DNS_ADB_INVALIDBUCKET
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|adb
operator|->
name|names
index|[
name|bucket
index|]
argument_list|,
name|name
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|name
operator|->
name|lock_bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
name|INSIST
argument_list|(
name|adb
operator|->
name|name_refcnt
index|[
name|bucket
index|]
operator|>
literal|0
argument_list|)
expr_stmt|;
name|adb
operator|->
name|name_refcnt
index|[
name|bucket
index|]
operator|--
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|name_sd
index|[
name|bucket
index|]
operator|&&
name|adb
operator|->
name|name_refcnt
index|[
name|bucket
index|]
operator|==
literal|0
condition|)
name|result
operator|=
name|ISC_TRUE
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Requires the entry's bucket be locked.  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|link_entry
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|int
name|bucket
parameter_list|,
name|dns_adbentry_t
modifier|*
name|entry
parameter_list|)
block|{
name|ISC_LIST_PREPEND
argument_list|(
name|adb
operator|->
name|entries
index|[
name|bucket
index|]
argument_list|,
name|entry
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|entry
operator|->
name|lock_bucket
operator|=
name|bucket
expr_stmt|;
name|adb
operator|->
name|entry_refcnt
index|[
name|bucket
index|]
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Requires the entry's bucket be locked.  */
end_comment

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|unlink_entry
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbentry_t
modifier|*
name|entry
parameter_list|)
block|{
name|int
name|bucket
decl_stmt|;
name|isc_boolean_t
name|result
init|=
name|ISC_FALSE
decl_stmt|;
name|bucket
operator|=
name|entry
operator|->
name|lock_bucket
expr_stmt|;
name|INSIST
argument_list|(
name|bucket
operator|!=
name|DNS_ADB_INVALIDBUCKET
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|adb
operator|->
name|entries
index|[
name|bucket
index|]
argument_list|,
name|entry
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|entry
operator|->
name|lock_bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
name|INSIST
argument_list|(
name|adb
operator|->
name|entry_refcnt
index|[
name|bucket
index|]
operator|>
literal|0
argument_list|)
expr_stmt|;
name|adb
operator|->
name|entry_refcnt
index|[
name|bucket
index|]
operator|--
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|entry_sd
index|[
name|bucket
index|]
operator|&&
name|adb
operator|->
name|entry_refcnt
index|[
name|bucket
index|]
operator|==
literal|0
condition|)
name|result
operator|=
name|ISC_TRUE
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|violate_locking_hierarchy
parameter_list|(
name|isc_mutex_t
modifier|*
name|have
parameter_list|,
name|isc_mutex_t
modifier|*
name|want
parameter_list|)
block|{
if|if
condition|(
name|isc_mutex_trylock
argument_list|(
name|want
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNLOCK
argument_list|(
name|have
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
name|want
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
name|have
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * The ADB _MUST_ be locked before calling.  Also, exit conditions must be  * checked after calling this function.  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|shutdown_names
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|)
block|{
name|int
name|bucket
decl_stmt|;
name|isc_boolean_t
name|result
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_adbname_t
modifier|*
name|name
decl_stmt|;
name|dns_adbname_t
modifier|*
name|next_name
decl_stmt|;
for|for
control|(
name|bucket
operator|=
literal|0
init|;
name|bucket
operator|<
name|NBUCKETS
condition|;
name|bucket
operator|++
control|)
block|{
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|adb
operator|->
name|name_sd
index|[
name|bucket
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|adb
operator|->
name|names
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
comment|/* 			 * This bucket has no names.  We must decrement the 			 * irefcnt ourselves, since it will not be 			 * automatically triggered by a name being unlinked. 			 */
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|result
operator|=
name|dec_adb_irefcnt
argument_list|(
name|adb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * Run through the list.  For each name, clean up finds 			 * found there, and cancel any fetches running.  When 			 * all the fetches are canceled, the name will destroy 			 * itself. 			 */
while|while
condition|(
name|name
operator|!=
name|NULL
condition|)
block|{
name|next_name
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|name
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|result
operator|=
name|kill_name
argument_list|(
operator|&
name|name
argument_list|,
name|DNS_EVENT_ADBSHUTDOWN
argument_list|)
expr_stmt|;
name|name
operator|=
name|next_name
expr_stmt|;
block|}
block|}
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * The ADB _MUST_ be locked before calling.  Also, exit conditions must be  * checked after calling this function.  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|shutdown_entries
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|)
block|{
name|int
name|bucket
decl_stmt|;
name|isc_boolean_t
name|result
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_adbentry_t
modifier|*
name|entry
decl_stmt|;
name|dns_adbentry_t
modifier|*
name|next_entry
decl_stmt|;
for|for
control|(
name|bucket
operator|=
literal|0
init|;
name|bucket
operator|<
name|NBUCKETS
condition|;
name|bucket
operator|++
control|)
block|{
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|adb
operator|->
name|entry_sd
index|[
name|bucket
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
name|entry
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|adb
operator|->
name|entries
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
comment|/* 			 * This bucket has no entries.  We must decrement the 			 * irefcnt ourselves, since it will not be 			 * automatically triggered by an entry being unlinked. 			 */
name|result
operator|=
name|dec_adb_irefcnt
argument_list|(
name|adb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * Run through the list.  Cleanup any entries not 			 * associated with names, and which are not in use. 			 */
while|while
condition|(
name|entry
operator|!=
name|NULL
condition|)
block|{
name|next_entry
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|entry
argument_list|,
name|plink
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|refcnt
operator|==
literal|0
operator|&&
name|entry
operator|->
name|expires
operator|!=
literal|0
condition|)
block|{
name|result
operator|=
name|unlink_entry
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|free_adbentry
argument_list|(
name|adb
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
name|result
operator|=
name|dec_adb_irefcnt
argument_list|(
name|adb
argument_list|)
expr_stmt|;
block|}
name|entry
operator|=
name|next_entry
expr_stmt|;
block|}
block|}
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name bucket must be locked  */
end_comment

begin_function
specifier|static
name|void
name|cancel_fetches_at_name
parameter_list|(
name|dns_adbname_t
modifier|*
name|name
parameter_list|)
block|{
if|if
condition|(
name|NAME_FETCH_A
argument_list|(
name|name
argument_list|)
condition|)
name|dns_resolver_cancelfetch
argument_list|(
name|name
operator|->
name|fetch_a
operator|->
name|fetch
argument_list|)
expr_stmt|;
if|if
condition|(
name|NAME_FETCH_AAAA
argument_list|(
name|name
argument_list|)
condition|)
name|dns_resolver_cancelfetch
argument_list|(
name|name
operator|->
name|fetch_aaaa
operator|->
name|fetch
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Assumes the name bucket is locked.  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|clean_namehooks
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbnamehooklist_t
modifier|*
name|namehooks
parameter_list|)
block|{
name|dns_adbentry_t
modifier|*
name|entry
decl_stmt|;
name|dns_adbnamehook_t
modifier|*
name|namehook
decl_stmt|;
name|int
name|addr_bucket
decl_stmt|;
name|isc_boolean_t
name|result
init|=
name|ISC_FALSE
decl_stmt|;
name|addr_bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
name|namehook
operator|=
name|ISC_LIST_HEAD
argument_list|(
operator|*
name|namehooks
argument_list|)
expr_stmt|;
while|while
condition|(
name|namehook
operator|!=
name|NULL
condition|)
block|{
name|INSIST
argument_list|(
name|DNS_ADBNAMEHOOK_VALID
argument_list|(
name|namehook
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * Clean up the entry if needed. 		 */
name|entry
operator|=
name|namehook
operator|->
name|entry
expr_stmt|;
if|if
condition|(
name|entry
operator|!=
name|NULL
condition|)
block|{
name|INSIST
argument_list|(
name|DNS_ADBENTRY_VALID
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr_bucket
operator|!=
name|entry
operator|->
name|lock_bucket
condition|)
block|{
if|if
condition|(
name|addr_bucket
operator|!=
name|DNS_ADB_INVALIDBUCKET
condition|)
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|addr_bucket
index|]
argument_list|)
expr_stmt|;
name|addr_bucket
operator|=
name|entry
operator|->
name|lock_bucket
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|addr_bucket
index|]
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dec_entry_refcnt
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Free the namehook 		 */
name|namehook
operator|->
name|entry
operator|=
name|NULL
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
operator|*
name|namehooks
argument_list|,
name|namehook
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|free_adbnamehook
argument_list|(
name|adb
argument_list|,
operator|&
name|namehook
argument_list|)
expr_stmt|;
name|namehook
operator|=
name|ISC_LIST_HEAD
argument_list|(
operator|*
name|namehooks
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|addr_bucket
operator|!=
name|DNS_ADB_INVALIDBUCKET
condition|)
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|addr_bucket
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|clean_target
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_name_t
modifier|*
name|target
parameter_list|)
block|{
if|if
condition|(
name|dns_name_countlabels
argument_list|(
name|target
argument_list|)
operator|>
literal|0
condition|)
block|{
name|dns_name_free
argument_list|(
name|target
argument_list|,
name|adb
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
name|target
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|set_target
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_name_t
modifier|*
name|fname
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_name_t
modifier|*
name|target
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_namereln_t
name|namereln
decl_stmt|;
name|unsigned
name|int
name|nlabels
decl_stmt|;
name|int
name|order
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_fixedname_t
name|fixed1
decl_stmt|,
name|fixed2
decl_stmt|;
name|dns_name_t
modifier|*
name|prefix
decl_stmt|,
modifier|*
name|new_target
decl_stmt|;
name|REQUIRE
argument_list|(
name|dns_name_countlabels
argument_list|(
name|target
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|->
name|type
operator|==
name|dns_rdatatype_cname
condition|)
block|{
name|dns_rdata_cname_t
name|cname
decl_stmt|;
comment|/* 		 * Copy the CNAME's target into the target name. 		 */
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|cname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_name_dup
argument_list|(
operator|&
name|cname
operator|.
name|cname
argument_list|,
name|adb
operator|->
name|mctx
argument_list|,
name|target
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|cname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
else|else
block|{
name|dns_rdata_dname_t
name|dname
decl_stmt|;
name|INSIST
argument_list|(
name|rdataset
operator|->
name|type
operator|==
name|dns_rdatatype_dname
argument_list|)
expr_stmt|;
name|namereln
operator|=
name|dns_name_fullcompare
argument_list|(
name|name
argument_list|,
name|fname
argument_list|,
operator|&
name|order
argument_list|,
operator|&
name|nlabels
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|namereln
operator|==
name|dns_namereln_subdomain
argument_list|)
expr_stmt|;
comment|/* 		 * Get the target name of the DNAME. 		 */
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|dname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* 		 * Construct the new target name. 		 */
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed1
argument_list|)
expr_stmt|;
name|prefix
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed1
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed2
argument_list|)
expr_stmt|;
name|new_target
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed2
argument_list|)
expr_stmt|;
name|dns_name_split
argument_list|(
name|name
argument_list|,
name|nlabels
argument_list|,
name|prefix
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_concatenate
argument_list|(
name|prefix
argument_list|,
operator|&
name|dname
operator|.
name|dname
argument_list|,
name|new_target
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|dname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_name_dup
argument_list|(
name|new_target
argument_list|,
name|adb
operator|->
name|mctx
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Assumes nothing is locked, since this is called by the client.  */
end_comment

begin_function
specifier|static
name|void
name|event_free
parameter_list|(
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_adbfind_t
modifier|*
name|find
decl_stmt|;
name|INSIST
argument_list|(
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|find
operator|=
name|event
operator|->
name|ev_destroy_arg
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ADBFIND_VALID
argument_list|(
name|find
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|find
operator|->
name|lock
argument_list|)
expr_stmt|;
name|find
operator|->
name|flags
operator||=
name|FIND_EVENT_FREED
expr_stmt|;
name|event
operator|->
name|ev_destroy_arg
operator|=
name|NULL
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|find
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Assumes the name bucket is locked.  */
end_comment

begin_function
specifier|static
name|void
name|clean_finds_at_name
parameter_list|(
name|dns_adbname_t
modifier|*
name|name
parameter_list|,
name|isc_eventtype_t
name|evtype
parameter_list|,
name|unsigned
name|int
name|addrs
parameter_list|)
block|{
name|isc_event_t
modifier|*
name|ev
decl_stmt|;
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|dns_adbfind_t
modifier|*
name|find
decl_stmt|;
name|dns_adbfind_t
modifier|*
name|next_find
decl_stmt|;
name|isc_boolean_t
name|process
decl_stmt|;
name|unsigned
name|int
name|wanted
decl_stmt|,
name|notify
decl_stmt|;
name|DP
argument_list|(
name|ENTER_LEVEL
argument_list|,
literal|"ENTER clean_finds_at_name, name %p, evtype %08x, addrs %08x"
argument_list|,
name|name
argument_list|,
name|evtype
argument_list|,
name|addrs
argument_list|)
expr_stmt|;
name|find
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|finds
argument_list|)
expr_stmt|;
while|while
condition|(
name|find
operator|!=
name|NULL
condition|)
block|{
name|LOCK
argument_list|(
operator|&
name|find
operator|->
name|lock
argument_list|)
expr_stmt|;
name|next_find
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|find
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|process
operator|=
name|ISC_FALSE
expr_stmt|;
name|wanted
operator|=
name|find
operator|->
name|flags
operator|&
name|DNS_ADBFIND_ADDRESSMASK
expr_stmt|;
name|notify
operator|=
name|wanted
operator|&
name|addrs
expr_stmt|;
switch|switch
condition|(
name|evtype
condition|)
block|{
case|case
name|DNS_EVENT_ADBMOREADDRESSES
case|:
name|DP
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"DNS_EVENT_ADBMOREADDRESSES"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|notify
operator|)
operator|!=
literal|0
condition|)
block|{
name|find
operator|->
name|flags
operator|&=
operator|~
name|addrs
expr_stmt|;
name|process
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
break|break;
case|case
name|DNS_EVENT_ADBNOMOREADDRESSES
case|:
name|DP
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"DNS_EVENT_ADBNOMOREADDRESSES"
argument_list|)
expr_stmt|;
name|find
operator|->
name|flags
operator|&=
operator|~
name|addrs
expr_stmt|;
name|wanted
operator|=
name|find
operator|->
name|flags
operator|&
name|DNS_ADBFIND_ADDRESSMASK
expr_stmt|;
if|if
condition|(
name|wanted
operator|==
literal|0
condition|)
name|process
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
default|default:
name|find
operator|->
name|flags
operator|&=
operator|~
name|addrs
expr_stmt|;
name|process
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|process
condition|)
block|{
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"cfan: processing find %p"
argument_list|,
name|find
argument_list|)
expr_stmt|;
comment|/* 			 * Unlink the find from the name, letting the caller 			 * call dns_adb_destroyfind() on it to clean it up 			 * later. 			 */
name|ISC_LIST_UNLINK
argument_list|(
name|name
operator|->
name|finds
argument_list|,
name|find
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|find
operator|->
name|adbname
operator|=
name|NULL
expr_stmt|;
name|find
operator|->
name|name_bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|FIND_EVENTSENT
argument_list|(
name|find
argument_list|)
argument_list|)
expr_stmt|;
name|ev
operator|=
operator|&
name|find
operator|->
name|event
expr_stmt|;
name|task
operator|=
name|ev
operator|->
name|ev_sender
expr_stmt|;
name|ev
operator|->
name|ev_sender
operator|=
name|find
expr_stmt|;
name|find
operator|->
name|result_v4
operator|=
name|find_err_map
index|[
name|name
operator|->
name|fetch_err
index|]
expr_stmt|;
name|find
operator|->
name|result_v6
operator|=
name|find_err_map
index|[
name|name
operator|->
name|fetch6_err
index|]
expr_stmt|;
name|ev
operator|->
name|ev_type
operator|=
name|evtype
expr_stmt|;
name|ev
operator|->
name|ev_destroy
operator|=
name|event_free
expr_stmt|;
name|ev
operator|->
name|ev_destroy_arg
operator|=
name|find
expr_stmt|;
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"sending event %p to task %p for find %p"
argument_list|,
name|ev
argument_list|,
name|task
argument_list|,
name|find
argument_list|)
expr_stmt|;
name|isc_task_sendanddetach
argument_list|(
operator|&
name|task
argument_list|,
operator|(
name|isc_event_t
operator|*
operator|*
operator|)
operator|&
name|ev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"cfan: skipping find %p"
argument_list|,
name|find
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|find
operator|->
name|lock
argument_list|)
expr_stmt|;
name|find
operator|=
name|next_find
expr_stmt|;
block|}
name|DP
argument_list|(
name|ENTER_LEVEL
argument_list|,
literal|"EXIT clean_finds_at_name, name %p"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|check_exit
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|)
block|{
name|isc_event_t
modifier|*
name|event
decl_stmt|;
comment|/* 	 * The caller must be holding the adb lock. 	 */
if|if
condition|(
name|adb
operator|->
name|shutting_down
condition|)
block|{
comment|/* 		 * If there aren't any external references either, we're 		 * done.  Send the control event to initiate shutdown. 		 */
name|INSIST
argument_list|(
operator|!
name|adb
operator|->
name|cevent_sent
argument_list|)
expr_stmt|;
comment|/* Sanity check. */
name|event
operator|=
operator|&
name|adb
operator|->
name|cevent
expr_stmt|;
name|isc_task_send
argument_list|(
name|adb
operator|->
name|task
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
name|adb
operator|->
name|cevent_sent
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|dec_adb_irefcnt
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|)
block|{
name|isc_event_t
modifier|*
name|event
decl_stmt|;
name|isc_task_t
modifier|*
name|etask
decl_stmt|;
name|isc_boolean_t
name|result
init|=
name|ISC_FALSE
decl_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|reflock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|adb
operator|->
name|irefcnt
operator|>
literal|0
argument_list|)
expr_stmt|;
name|adb
operator|->
name|irefcnt
operator|--
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|irefcnt
operator|==
literal|0
condition|)
block|{
name|event
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|adb
operator|->
name|whenshutdown
argument_list|)
expr_stmt|;
while|while
condition|(
name|event
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|adb
operator|->
name|whenshutdown
argument_list|,
name|event
argument_list|,
name|ev_link
argument_list|)
expr_stmt|;
name|etask
operator|=
name|event
operator|->
name|ev_sender
expr_stmt|;
name|event
operator|->
name|ev_sender
operator|=
name|adb
expr_stmt|;
name|isc_task_sendanddetach
argument_list|(
operator|&
name|etask
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
name|event
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|adb
operator|->
name|whenshutdown
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|adb
operator|->
name|irefcnt
operator|==
literal|0
operator|&&
name|adb
operator|->
name|erefcnt
operator|==
literal|0
condition|)
name|result
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|reflock
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|inc_adb_irefcnt
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|)
block|{
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|reflock
argument_list|)
expr_stmt|;
name|adb
operator|->
name|irefcnt
operator|++
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|reflock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|inc_adb_erefcnt
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|)
block|{
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|reflock
argument_list|)
expr_stmt|;
name|adb
operator|->
name|erefcnt
operator|++
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|reflock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|inc_entry_refcnt
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbentry_t
modifier|*
name|entry
parameter_list|,
name|isc_boolean_t
name|lock
parameter_list|)
block|{
name|int
name|bucket
decl_stmt|;
name|bucket
operator|=
name|entry
operator|->
name|lock_bucket
expr_stmt|;
if|if
condition|(
name|lock
condition|)
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|entry
operator|->
name|refcnt
operator|++
expr_stmt|;
if|if
condition|(
name|lock
condition|)
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|dec_entry_refcnt
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbentry_t
modifier|*
name|entry
parameter_list|,
name|isc_boolean_t
name|lock
parameter_list|)
block|{
name|int
name|bucket
decl_stmt|;
name|isc_boolean_t
name|destroy_entry
decl_stmt|;
name|isc_boolean_t
name|result
init|=
name|ISC_FALSE
decl_stmt|;
name|bucket
operator|=
name|entry
operator|->
name|lock_bucket
expr_stmt|;
if|if
condition|(
name|lock
condition|)
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|entry
operator|->
name|refcnt
operator|>
literal|0
argument_list|)
expr_stmt|;
name|entry
operator|->
name|refcnt
operator|--
expr_stmt|;
name|destroy_entry
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|refcnt
operator|==
literal|0
operator|&&
operator|(
name|adb
operator|->
name|entry_sd
index|[
name|bucket
index|]
operator|||
name|entry
operator|->
name|expires
operator|==
literal|0
operator|)
condition|)
block|{
name|destroy_entry
operator|=
name|ISC_TRUE
expr_stmt|;
name|result
operator|=
name|unlink_entry
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lock
condition|)
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|destroy_entry
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|entry
operator|->
name|lock_bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
name|free_adbentry
argument_list|(
name|adb
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
name|result
operator|=
name|dec_adb_irefcnt
argument_list|(
name|adb
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|dns_adbname_t
modifier|*
name|new_adbname
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_name_t
modifier|*
name|dnsname
parameter_list|)
block|{
name|dns_adbname_t
modifier|*
name|name
decl_stmt|;
name|name
operator|=
name|isc_mempool_get
argument_list|(
name|adb
operator|->
name|nmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|dns_name_init
argument_list|(
operator|&
name|name
operator|->
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_name_dup
argument_list|(
name|dnsname
argument_list|,
name|adb
operator|->
name|mctx
argument_list|,
operator|&
name|name
operator|->
name|name
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mempool_put
argument_list|(
name|adb
operator|->
name|nmp
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|dns_name_init
argument_list|(
operator|&
name|name
operator|->
name|target
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|name
operator|->
name|magic
operator|=
name|DNS_ADBNAME_MAGIC
expr_stmt|;
name|name
operator|->
name|adb
operator|=
name|adb
expr_stmt|;
name|name
operator|->
name|partial_result
operator|=
literal|0
expr_stmt|;
name|name
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|name
operator|->
name|expire_v4
operator|=
name|INT_MAX
expr_stmt|;
name|name
operator|->
name|expire_v6
operator|=
name|INT_MAX
expr_stmt|;
name|name
operator|->
name|expire_target
operator|=
name|INT_MAX
expr_stmt|;
name|name
operator|->
name|chains
operator|=
literal|0
expr_stmt|;
name|name
operator|->
name|lock_bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|name
operator|->
name|v4
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|name
operator|->
name|v6
argument_list|)
expr_stmt|;
name|name
operator|->
name|fetch_a
operator|=
name|NULL
expr_stmt|;
name|name
operator|->
name|fetch_aaaa
operator|=
name|NULL
expr_stmt|;
name|name
operator|->
name|fetch_err
operator|=
name|FIND_ERR_UNEXPECTED
expr_stmt|;
name|name
operator|->
name|fetch6_err
operator|=
name|FIND_ERR_UNEXPECTED
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|name
operator|->
name|finds
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|name
argument_list|,
name|plink
argument_list|)
expr_stmt|;
return|return
operator|(
name|name
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|free_adbname
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbname_t
modifier|*
modifier|*
name|name
parameter_list|)
block|{
name|dns_adbname_t
modifier|*
name|n
decl_stmt|;
name|INSIST
argument_list|(
name|name
operator|!=
name|NULL
operator|&&
name|DNS_ADBNAME_VALID
argument_list|(
operator|*
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|=
operator|*
name|name
expr_stmt|;
operator|*
name|name
operator|=
name|NULL
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|NAME_HAS_V4
argument_list|(
name|n
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|NAME_HAS_V6
argument_list|(
name|n
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|NAME_FETCH
argument_list|(
name|n
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ISC_LIST_EMPTY
argument_list|(
name|n
operator|->
name|finds
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|ISC_LINK_LINKED
argument_list|(
name|n
argument_list|,
name|plink
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|n
operator|->
name|lock_bucket
operator|==
name|DNS_ADB_INVALIDBUCKET
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|n
operator|->
name|adb
operator|==
name|adb
argument_list|)
expr_stmt|;
name|n
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|dns_name_free
argument_list|(
operator|&
name|n
operator|->
name|name
argument_list|,
name|adb
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|adb
operator|->
name|nmp
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|dns_adbnamehook_t
modifier|*
name|new_adbnamehook
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbentry_t
modifier|*
name|entry
parameter_list|)
block|{
name|dns_adbnamehook_t
modifier|*
name|nh
decl_stmt|;
name|nh
operator|=
name|isc_mempool_get
argument_list|(
name|adb
operator|->
name|nhmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nh
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|nh
operator|->
name|magic
operator|=
name|DNS_ADBNAMEHOOK_MAGIC
expr_stmt|;
name|nh
operator|->
name|entry
operator|=
name|entry
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|nh
argument_list|,
name|plink
argument_list|)
expr_stmt|;
return|return
operator|(
name|nh
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|free_adbnamehook
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbnamehook_t
modifier|*
modifier|*
name|namehook
parameter_list|)
block|{
name|dns_adbnamehook_t
modifier|*
name|nh
decl_stmt|;
name|INSIST
argument_list|(
name|namehook
operator|!=
name|NULL
operator|&&
name|DNS_ADBNAMEHOOK_VALID
argument_list|(
operator|*
name|namehook
argument_list|)
argument_list|)
expr_stmt|;
name|nh
operator|=
operator|*
name|namehook
expr_stmt|;
operator|*
name|namehook
operator|=
name|NULL
expr_stmt|;
name|INSIST
argument_list|(
name|nh
operator|->
name|entry
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|ISC_LINK_LINKED
argument_list|(
name|nh
argument_list|,
name|plink
argument_list|)
argument_list|)
expr_stmt|;
name|nh
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|adb
operator|->
name|nhmp
argument_list|,
name|nh
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|dns_adbzoneinfo_t
modifier|*
name|new_adbzoneinfo
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_name_t
modifier|*
name|zone
parameter_list|)
block|{
name|dns_adbzoneinfo_t
modifier|*
name|zi
decl_stmt|;
name|zi
operator|=
name|isc_mempool_get
argument_list|(
name|adb
operator|->
name|zimp
argument_list|)
expr_stmt|;
if|if
condition|(
name|zi
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|dns_name_init
argument_list|(
operator|&
name|zi
operator|->
name|zone
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_name_dup
argument_list|(
name|zone
argument_list|,
name|adb
operator|->
name|mctx
argument_list|,
operator|&
name|zi
operator|->
name|zone
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mempool_put
argument_list|(
name|adb
operator|->
name|zimp
argument_list|,
name|zi
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|zi
operator|->
name|magic
operator|=
name|DNS_ADBZONEINFO_MAGIC
expr_stmt|;
name|zi
operator|->
name|lame_timer
operator|=
literal|0
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|zi
argument_list|,
name|plink
argument_list|)
expr_stmt|;
return|return
operator|(
name|zi
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|free_adbzoneinfo
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbzoneinfo_t
modifier|*
modifier|*
name|zoneinfo
parameter_list|)
block|{
name|dns_adbzoneinfo_t
modifier|*
name|zi
decl_stmt|;
name|INSIST
argument_list|(
name|zoneinfo
operator|!=
name|NULL
operator|&&
name|DNS_ADBZONEINFO_VALID
argument_list|(
operator|*
name|zoneinfo
argument_list|)
argument_list|)
expr_stmt|;
name|zi
operator|=
operator|*
name|zoneinfo
expr_stmt|;
operator|*
name|zoneinfo
operator|=
name|NULL
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|ISC_LINK_LINKED
argument_list|(
name|zi
argument_list|,
name|plink
argument_list|)
argument_list|)
expr_stmt|;
name|dns_name_free
argument_list|(
operator|&
name|zi
operator|->
name|zone
argument_list|,
name|adb
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|zi
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|adb
operator|->
name|zimp
argument_list|,
name|zi
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|dns_adbentry_t
modifier|*
name|new_adbentry
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|)
block|{
name|dns_adbentry_t
modifier|*
name|e
decl_stmt|;
name|isc_uint32_t
name|r
decl_stmt|;
name|e
operator|=
name|isc_mempool_get
argument_list|(
name|adb
operator|->
name|emp
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|e
operator|->
name|magic
operator|=
name|DNS_ADBENTRY_MAGIC
expr_stmt|;
name|e
operator|->
name|lock_bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
name|e
operator|->
name|refcnt
operator|=
literal|0
expr_stmt|;
name|e
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|isc_random_get
argument_list|(
operator|&
name|r
argument_list|)
expr_stmt|;
name|e
operator|->
name|srtt
operator|=
operator|(
name|r
operator|&
literal|0x1f
operator|)
operator|+
literal|1
expr_stmt|;
name|e
operator|->
name|expires
operator|=
literal|0
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|e
operator|->
name|zoneinfo
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|e
argument_list|,
name|plink
argument_list|)
expr_stmt|;
return|return
operator|(
name|e
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|free_adbentry
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbentry_t
modifier|*
modifier|*
name|entry
parameter_list|)
block|{
name|dns_adbentry_t
modifier|*
name|e
decl_stmt|;
name|dns_adbzoneinfo_t
modifier|*
name|zi
decl_stmt|;
name|INSIST
argument_list|(
name|entry
operator|!=
name|NULL
operator|&&
name|DNS_ADBENTRY_VALID
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|e
operator|=
operator|*
name|entry
expr_stmt|;
operator|*
name|entry
operator|=
name|NULL
expr_stmt|;
name|INSIST
argument_list|(
name|e
operator|->
name|lock_bucket
operator|==
name|DNS_ADB_INVALIDBUCKET
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|e
operator|->
name|refcnt
operator|==
literal|0
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|ISC_LINK_LINKED
argument_list|(
name|e
argument_list|,
name|plink
argument_list|)
argument_list|)
expr_stmt|;
name|e
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|zi
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|e
operator|->
name|zoneinfo
argument_list|)
expr_stmt|;
while|while
condition|(
name|zi
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|e
operator|->
name|zoneinfo
argument_list|,
name|zi
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|free_adbzoneinfo
argument_list|(
name|adb
argument_list|,
operator|&
name|zi
argument_list|)
expr_stmt|;
name|zi
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|e
operator|->
name|zoneinfo
argument_list|)
expr_stmt|;
block|}
name|isc_mempool_put
argument_list|(
name|adb
operator|->
name|emp
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|dns_adbfind_t
modifier|*
name|new_adbfind
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|)
block|{
name|dns_adbfind_t
modifier|*
name|h
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|h
operator|=
name|isc_mempool_get
argument_list|(
name|adb
operator|->
name|ahmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* 	 * Public members. 	 */
name|h
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|h
operator|->
name|adb
operator|=
name|adb
expr_stmt|;
name|h
operator|->
name|partial_result
operator|=
literal|0
expr_stmt|;
name|h
operator|->
name|options
operator|=
literal|0
expr_stmt|;
name|h
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|h
operator|->
name|result_v4
operator|=
name|ISC_R_UNEXPECTED
expr_stmt|;
name|h
operator|->
name|result_v6
operator|=
name|ISC_R_UNEXPECTED
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|h
argument_list|,
name|publink
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|h
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|h
operator|->
name|list
argument_list|)
expr_stmt|;
name|h
operator|->
name|adbname
operator|=
name|NULL
expr_stmt|;
name|h
operator|->
name|name_bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
comment|/* 	 * private members 	 */
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|h
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"isc_mutex_init failed in new_adbfind()"
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|adb
operator|->
name|ahmp
argument_list|,
name|h
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|ISC_EVENT_INIT
argument_list|(
operator|&
name|h
operator|->
name|event
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_event_t
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|inc_adb_irefcnt
argument_list|(
name|adb
argument_list|)
expr_stmt|;
name|h
operator|->
name|magic
operator|=
name|DNS_ADBFIND_MAGIC
expr_stmt|;
return|return
operator|(
name|h
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|dns_adbfetch_t
modifier|*
name|new_adbfetch
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|)
block|{
name|dns_adbfetch_t
modifier|*
name|f
decl_stmt|;
name|f
operator|=
name|isc_mempool_get
argument_list|(
name|adb
operator|->
name|afmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|f
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|namehook
operator|=
name|NULL
expr_stmt|;
name|f
operator|->
name|entry
operator|=
name|NULL
expr_stmt|;
name|f
operator|->
name|fetch
operator|=
name|NULL
expr_stmt|;
name|f
operator|->
name|namehook
operator|=
name|new_adbnamehook
argument_list|(
name|adb
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|namehook
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|f
operator|->
name|entry
operator|=
name|new_adbentry
argument_list|(
name|adb
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|entry
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|dns_rdataset_init
argument_list|(
operator|&
name|f
operator|->
name|rdataset
argument_list|)
expr_stmt|;
name|f
operator|->
name|magic
operator|=
name|DNS_ADBFETCH_MAGIC
expr_stmt|;
return|return
operator|(
name|f
operator|)
return|;
name|err
label|:
if|if
condition|(
name|f
operator|->
name|namehook
operator|!=
name|NULL
condition|)
name|free_adbnamehook
argument_list|(
name|adb
argument_list|,
operator|&
name|f
operator|->
name|namehook
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|entry
operator|!=
name|NULL
condition|)
name|free_adbentry
argument_list|(
name|adb
argument_list|,
operator|&
name|f
operator|->
name|entry
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|adb
operator|->
name|afmp
argument_list|,
name|f
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|free_adbfetch
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbfetch_t
modifier|*
modifier|*
name|fetch
parameter_list|)
block|{
name|dns_adbfetch_t
modifier|*
name|f
decl_stmt|;
name|INSIST
argument_list|(
name|fetch
operator|!=
name|NULL
operator|&&
name|DNS_ADBFETCH_VALID
argument_list|(
operator|*
name|fetch
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|=
operator|*
name|fetch
expr_stmt|;
operator|*
name|fetch
operator|=
name|NULL
expr_stmt|;
name|f
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|namehook
operator|!=
name|NULL
condition|)
name|free_adbnamehook
argument_list|(
name|adb
argument_list|,
operator|&
name|f
operator|->
name|namehook
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|entry
operator|!=
name|NULL
condition|)
name|free_adbentry
argument_list|(
name|adb
argument_list|,
operator|&
name|f
operator|->
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|f
operator|->
name|rdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|f
operator|->
name|rdataset
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|adb
operator|->
name|afmp
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|free_adbfind
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbfind_t
modifier|*
modifier|*
name|findp
parameter_list|)
block|{
name|dns_adbfind_t
modifier|*
name|find
decl_stmt|;
name|INSIST
argument_list|(
name|findp
operator|!=
name|NULL
operator|&&
name|DNS_ADBFIND_VALID
argument_list|(
operator|*
name|findp
argument_list|)
argument_list|)
expr_stmt|;
name|find
operator|=
operator|*
name|findp
expr_stmt|;
operator|*
name|findp
operator|=
name|NULL
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|FIND_HAS_ADDRS
argument_list|(
name|find
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|ISC_LINK_LINKED
argument_list|(
name|find
argument_list|,
name|publink
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|ISC_LINK_LINKED
argument_list|(
name|find
argument_list|,
name|plink
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|find
operator|->
name|name_bucket
operator|==
name|DNS_ADB_INVALIDBUCKET
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|find
operator|->
name|adbname
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|find
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|find
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|adb
operator|->
name|ahmp
argument_list|,
name|find
argument_list|)
expr_stmt|;
return|return
operator|(
name|dec_adb_irefcnt
argument_list|(
name|adb
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Copy bits from the entry into the newly allocated addrinfo.  The entry  * must be locked, and the reference count must be bumped up by one  * if this function returns a valid pointer.  */
end_comment

begin_function
specifier|static
specifier|inline
name|dns_adbaddrinfo_t
modifier|*
name|new_adbaddrinfo
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbentry_t
modifier|*
name|entry
parameter_list|,
name|in_port_t
name|port
parameter_list|)
block|{
name|dns_adbaddrinfo_t
modifier|*
name|ai
decl_stmt|;
name|ai
operator|=
name|isc_mempool_get
argument_list|(
name|adb
operator|->
name|aimp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ai
operator|->
name|magic
operator|=
name|DNS_ADBADDRINFO_MAGIC
expr_stmt|;
name|ai
operator|->
name|sockaddr
operator|=
name|entry
operator|->
name|sockaddr
expr_stmt|;
name|isc_sockaddr_setport
argument_list|(
operator|&
name|ai
operator|->
name|sockaddr
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|ai
operator|->
name|srtt
operator|=
name|entry
operator|->
name|srtt
expr_stmt|;
name|ai
operator|->
name|flags
operator|=
name|entry
operator|->
name|flags
expr_stmt|;
name|ai
operator|->
name|entry
operator|=
name|entry
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|ai
argument_list|,
name|publink
argument_list|)
expr_stmt|;
return|return
operator|(
name|ai
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|free_adbaddrinfo
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbaddrinfo_t
modifier|*
modifier|*
name|ainfo
parameter_list|)
block|{
name|dns_adbaddrinfo_t
modifier|*
name|ai
decl_stmt|;
name|INSIST
argument_list|(
name|ainfo
operator|!=
name|NULL
operator|&&
name|DNS_ADBADDRINFO_VALID
argument_list|(
operator|*
name|ainfo
argument_list|)
argument_list|)
expr_stmt|;
name|ai
operator|=
operator|*
name|ainfo
expr_stmt|;
operator|*
name|ainfo
operator|=
name|NULL
expr_stmt|;
name|INSIST
argument_list|(
name|ai
operator|->
name|entry
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|ISC_LINK_LINKED
argument_list|(
name|ai
argument_list|,
name|publink
argument_list|)
argument_list|)
expr_stmt|;
name|ai
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|adb
operator|->
name|aimp
argument_list|,
name|ai
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Search for the name.  NOTE:  The bucket is kept locked on both  * success and failure, so it must always be unlocked by the caller!  *  * On the first call to this function, *bucketp must be set to  * DNS_ADB_INVALIDBUCKET.  */
end_comment

begin_function
specifier|static
specifier|inline
name|dns_adbname_t
modifier|*
name|find_name_and_lock
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|int
modifier|*
name|bucketp
parameter_list|)
block|{
name|dns_adbname_t
modifier|*
name|adbname
decl_stmt|;
name|int
name|bucket
decl_stmt|;
name|bucket
operator|=
name|dns_name_fullhash
argument_list|(
name|name
argument_list|,
name|ISC_FALSE
argument_list|)
operator|%
name|NBUCKETS
expr_stmt|;
if|if
condition|(
operator|*
name|bucketp
operator|==
name|DNS_ADB_INVALIDBUCKET
condition|)
block|{
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
operator|*
name|bucketp
operator|=
name|bucket
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|bucketp
operator|!=
name|bucket
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
operator|*
name|bucketp
index|]
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
operator|*
name|bucketp
operator|=
name|bucket
expr_stmt|;
block|}
name|adbname
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|adb
operator|->
name|names
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|adbname
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|NAME_DEAD
argument_list|(
name|adbname
argument_list|)
condition|)
block|{
if|if
condition|(
name|dns_name_equal
argument_list|(
name|name
argument_list|,
operator|&
name|adbname
operator|->
name|name
argument_list|)
operator|&&
name|GLUEHINT_OK
argument_list|(
name|adbname
argument_list|,
name|options
argument_list|)
operator|&&
name|STARTATZONE_MATCHES
argument_list|(
name|adbname
argument_list|,
name|options
argument_list|)
condition|)
return|return
operator|(
name|adbname
operator|)
return|;
block|}
name|adbname
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|adbname
argument_list|,
name|plink
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Search for the address.  NOTE:  The bucket is kept locked on both  * success and failure, so it must always be unlocked by the caller.  *  * On the first call to this function, *bucketp must be set to  * DNS_ADB_INVALIDBUCKET.  This will cause a lock to occur.  On  * later calls (within the same "lock path") it can be left alone, so  * if this function is called multiple times locking is only done if  * the bucket changes.  */
end_comment

begin_function
specifier|static
specifier|inline
name|dns_adbentry_t
modifier|*
name|find_entry_and_lock
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|,
name|int
modifier|*
name|bucketp
parameter_list|)
block|{
name|dns_adbentry_t
modifier|*
name|entry
decl_stmt|;
name|int
name|bucket
decl_stmt|;
name|bucket
operator|=
name|isc_sockaddr_hash
argument_list|(
name|addr
argument_list|,
name|ISC_TRUE
argument_list|)
operator|%
name|NBUCKETS
expr_stmt|;
if|if
condition|(
operator|*
name|bucketp
operator|==
name|DNS_ADB_INVALIDBUCKET
condition|)
block|{
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
operator|*
name|bucketp
operator|=
name|bucket
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|bucketp
operator|!=
name|bucket
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
operator|*
name|bucketp
index|]
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
operator|*
name|bucketp
operator|=
name|bucket
expr_stmt|;
block|}
name|entry
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|adb
operator|->
name|entries
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|entry
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|isc_sockaddr_equal
argument_list|(
name|addr
argument_list|,
operator|&
name|entry
operator|->
name|sockaddr
argument_list|)
condition|)
return|return
operator|(
name|entry
operator|)
return|;
name|entry
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|entry
argument_list|,
name|plink
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Entry bucket MUST be locked!  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|entry_is_bad_for_zone
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbentry_t
modifier|*
name|entry
parameter_list|,
name|dns_name_t
modifier|*
name|zone
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
name|dns_adbzoneinfo_t
modifier|*
name|zi
decl_stmt|,
modifier|*
name|next_zi
decl_stmt|;
name|isc_boolean_t
name|is_bad
decl_stmt|;
name|is_bad
operator|=
name|ISC_FALSE
expr_stmt|;
name|zi
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|entry
operator|->
name|zoneinfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|zi
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
while|while
condition|(
name|zi
operator|!=
name|NULL
condition|)
block|{
name|next_zi
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|zi
argument_list|,
name|plink
argument_list|)
expr_stmt|;
comment|/* 		 * Has the entry expired? 		 */
if|if
condition|(
name|zi
operator|->
name|lame_timer
operator|<
name|now
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|entry
operator|->
name|zoneinfo
argument_list|,
name|zi
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|free_adbzoneinfo
argument_list|(
name|adb
argument_list|,
operator|&
name|zi
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Order tests from least to most expensive. 		 */
if|if
condition|(
name|zi
operator|!=
name|NULL
operator|&&
operator|!
name|is_bad
condition|)
block|{
if|if
condition|(
name|dns_name_equal
argument_list|(
name|zone
argument_list|,
operator|&
name|zi
operator|->
name|zone
argument_list|)
condition|)
name|is_bad
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|zi
operator|=
name|next_zi
expr_stmt|;
block|}
return|return
operator|(
name|is_bad
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|copy_namehook_lists
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbfind_t
modifier|*
name|find
parameter_list|,
name|dns_name_t
modifier|*
name|zone
parameter_list|,
name|dns_adbname_t
modifier|*
name|name
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
name|dns_adbnamehook_t
modifier|*
name|namehook
decl_stmt|;
name|dns_adbaddrinfo_t
modifier|*
name|addrinfo
decl_stmt|;
name|dns_adbentry_t
modifier|*
name|entry
decl_stmt|;
name|int
name|bucket
decl_stmt|;
name|bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
if|if
condition|(
name|find
operator|->
name|options
operator|&
name|DNS_ADBFIND_INET
condition|)
block|{
name|namehook
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|v4
argument_list|)
expr_stmt|;
while|while
condition|(
name|namehook
operator|!=
name|NULL
condition|)
block|{
name|entry
operator|=
name|namehook
operator|->
name|entry
expr_stmt|;
name|bucket
operator|=
name|entry
operator|->
name|lock_bucket
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|FIND_RETURNLAME
argument_list|(
name|find
argument_list|)
operator|&&
name|entry_is_bad_for_zone
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|,
name|zone
argument_list|,
name|now
argument_list|)
condition|)
block|{
name|find
operator|->
name|options
operator||=
name|DNS_ADBFIND_LAMEPRUNED
expr_stmt|;
goto|goto
name|nextv4
goto|;
block|}
name|addrinfo
operator|=
name|new_adbaddrinfo
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|,
name|find
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|addrinfo
operator|==
name|NULL
condition|)
block|{
name|find
operator|->
name|partial_result
operator||=
name|DNS_ADBFIND_INET
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 			 * Found a valid entry.  Add it to the find's list. 			 */
name|inc_entry_refcnt
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|find
operator|->
name|list
argument_list|,
name|addrinfo
argument_list|,
name|publink
argument_list|)
expr_stmt|;
name|addrinfo
operator|=
name|NULL
expr_stmt|;
name|nextv4
label|:
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
name|namehook
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|namehook
argument_list|,
name|plink
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|find
operator|->
name|options
operator|&
name|DNS_ADBFIND_INET6
condition|)
block|{
name|namehook
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|v6
argument_list|)
expr_stmt|;
while|while
condition|(
name|namehook
operator|!=
name|NULL
condition|)
block|{
name|entry
operator|=
name|namehook
operator|->
name|entry
expr_stmt|;
name|bucket
operator|=
name|entry
operator|->
name|lock_bucket
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry_is_bad_for_zone
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|,
name|zone
argument_list|,
name|now
argument_list|)
condition|)
goto|goto
name|nextv6
goto|;
name|addrinfo
operator|=
name|new_adbaddrinfo
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|,
name|find
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|addrinfo
operator|==
name|NULL
condition|)
block|{
name|find
operator|->
name|partial_result
operator||=
name|DNS_ADBFIND_INET6
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 			 * Found a valid entry.  Add it to the find's list. 			 */
name|inc_entry_refcnt
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|find
operator|->
name|list
argument_list|,
name|addrinfo
argument_list|,
name|publink
argument_list|)
expr_stmt|;
name|addrinfo
operator|=
name|NULL
expr_stmt|;
name|nextv6
label|:
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
name|namehook
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|namehook
argument_list|,
name|plink
argument_list|)
expr_stmt|;
block|}
block|}
name|out
label|:
if|if
condition|(
name|bucket
operator|!=
name|DNS_ADB_INVALIDBUCKET
condition|)
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|shutdown_task
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|dns_adb_t
modifier|*
name|adb
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|adb
operator|=
name|ev
operator|->
name|ev_arg
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Kill the timer, and then the ADB itself.  Note that this implies 	 * that this task was the one scheduled to get timer events.  If 	 * this is not true (and it is unfortunate there is no way to INSIST() 	 * this) badness will occur. 	 */
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_timer_detach
argument_list|(
operator|&
name|adb
operator|->
name|timer
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
name|destroy
argument_list|(
name|adb
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Name bucket must be locked; adb may be locked; no other locks held.  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|check_expire_name
parameter_list|(
name|dns_adbname_t
modifier|*
modifier|*
name|namep
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
name|dns_adbname_t
modifier|*
name|name
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_FALSE
decl_stmt|;
name|INSIST
argument_list|(
name|namep
operator|!=
name|NULL
operator|&&
name|DNS_ADBNAME_VALID
argument_list|(
operator|*
name|namep
argument_list|)
argument_list|)
expr_stmt|;
name|name
operator|=
operator|*
name|namep
expr_stmt|;
if|if
condition|(
name|NAME_HAS_V4
argument_list|(
name|name
argument_list|)
operator|||
name|NAME_HAS_V6
argument_list|(
name|name
argument_list|)
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|NAME_FETCH
argument_list|(
name|name
argument_list|)
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
operator|!
name|EXPIRE_OK
argument_list|(
name|name
operator|->
name|expire_v4
argument_list|,
name|now
argument_list|)
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
operator|!
name|EXPIRE_OK
argument_list|(
name|name
operator|->
name|expire_v6
argument_list|,
name|now
argument_list|)
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
operator|!
name|EXPIRE_OK
argument_list|(
name|name
operator|->
name|expire_target
argument_list|,
name|now
argument_list|)
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* 	 * The name is empty.  Delete it. 	 */
name|result
operator|=
name|kill_name
argument_list|(
operator|&
name|name
argument_list|,
name|DNS_EVENT_ADBEXPIRED
argument_list|)
expr_stmt|;
operator|*
name|namep
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * Our caller, or one of its callers, will be calling check_exit() at 	 * some point, so we don't need to do it here. 	 */
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Entry bucket must be locked; adb may be locked; no other locks held.  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|check_expire_entry
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbentry_t
modifier|*
modifier|*
name|entryp
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
name|dns_adbentry_t
modifier|*
name|entry
decl_stmt|;
name|isc_boolean_t
name|expire
decl_stmt|;
name|isc_boolean_t
name|result
init|=
name|ISC_FALSE
decl_stmt|;
name|INSIST
argument_list|(
name|entryp
operator|!=
name|NULL
operator|&&
name|DNS_ADBENTRY_VALID
argument_list|(
operator|*
name|entryp
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|=
operator|*
name|entryp
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|refcnt
operator|!=
literal|0
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|adb
operator|->
name|overmem
condition|)
block|{
name|isc_uint32_t
name|val
decl_stmt|;
name|isc_random_get
argument_list|(
operator|&
name|val
argument_list|)
expr_stmt|;
name|expire
operator|=
name|ISC_TF
argument_list|(
operator|(
name|val
operator|%
literal|4
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|expire
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|expires
operator|==
literal|0
operator|||
operator|(
operator|!
name|expire
operator|&&
name|entry
operator|->
name|expires
operator|>
name|now
operator|)
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* 	 * The entry is not in use.  Delete it. 	 */
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"killing entry %p"
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ISC_LINK_LINKED
argument_list|(
name|entry
argument_list|,
name|plink
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|unlink_entry
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|free_adbentry
argument_list|(
name|adb
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
name|dec_adb_irefcnt
argument_list|(
name|adb
argument_list|)
expr_stmt|;
operator|*
name|entryp
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * ADB must be locked, and no other locks held.  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|cleanup_names
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|int
name|bucket
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
name|dns_adbname_t
modifier|*
name|name
decl_stmt|;
name|dns_adbname_t
modifier|*
name|next_name
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_FALSE
decl_stmt|;
name|DP
argument_list|(
name|CLEAN_LEVEL
argument_list|,
literal|"cleaning name bucket %d"
argument_list|,
name|bucket
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|name_sd
index|[
name|bucket
index|]
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|adb
operator|->
name|names
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|name
operator|!=
name|NULL
condition|)
block|{
name|next_name
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|name
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|result
operator|=
name|check_expire_namehooks
argument_list|(
name|name
argument_list|,
name|now
argument_list|,
name|adb
operator|->
name|overmem
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
name|result
operator|=
name|check_expire_name
argument_list|(
operator|&
name|name
argument_list|,
name|now
argument_list|)
expr_stmt|;
name|name
operator|=
name|next_name
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * ADB must be locked, and no other locks held.  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|cleanup_entries
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|int
name|bucket
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
name|dns_adbentry_t
modifier|*
name|entry
decl_stmt|,
modifier|*
name|next_entry
decl_stmt|;
name|isc_boolean_t
name|result
init|=
name|ISC_FALSE
decl_stmt|;
name|DP
argument_list|(
name|CLEAN_LEVEL
argument_list|,
literal|"cleaning entry bucket %d"
argument_list|,
name|bucket
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|entry
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|adb
operator|->
name|entries
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|entry
operator|!=
name|NULL
condition|)
block|{
name|next_entry
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|entry
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|result
operator|=
name|check_expire_entry
argument_list|(
name|adb
argument_list|,
operator|&
name|entry
argument_list|,
name|now
argument_list|)
expr_stmt|;
name|entry
operator|=
name|next_entry
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|timer_cleanup
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|dns_adb_t
modifier|*
name|adb
decl_stmt|;
name|isc_stdtime_t
name|now
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|isc_interval_t
name|interval
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|adb
operator|=
name|ev
operator|->
name|ev_arg
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CLEAN_BUCKETS
condition|;
name|i
operator|++
control|)
block|{
comment|/* 		 * Call our cleanup routines. 		 */
name|RUNTIME_CHECK
argument_list|(
name|cleanup_names
argument_list|(
name|adb
argument_list|,
name|adb
operator|->
name|next_cleanbucket
argument_list|,
name|now
argument_list|)
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|cleanup_entries
argument_list|(
name|adb
argument_list|,
name|adb
operator|->
name|next_cleanbucket
argument_list|,
name|now
argument_list|)
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
comment|/* 		 * Set the next bucket to be cleaned. 		 */
name|adb
operator|->
name|next_cleanbucket
operator|++
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|next_cleanbucket
operator|>=
name|NBUCKETS
condition|)
block|{
name|adb
operator|->
name|next_cleanbucket
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|DUMP_ADB_AFTER_CLEANING
name|dump_adb
argument_list|(
name|adb
argument_list|,
name|stdout
argument_list|,
name|ISC_TRUE
argument_list|,
name|now
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
comment|/* 	 * Reset the timer. 	 * XXXDCL isc_timer_reset might return ISC_R_UNEXPECTED or 	 * ISC_R_NOMEMORY, but it isn't clear what could be done here 	 * if either one of those things happened. 	 */
name|interval
operator|=
name|adb
operator|->
name|tick_interval
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|overmem
condition|)
name|isc_interval_set
argument_list|(
operator|&
name|interval
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|isc_timer_reset
argument_list|(
name|adb
operator|->
name|timer
argument_list|,
name|isc_timertype_once
argument_list|,
name|NULL
argument_list|,
operator|&
name|interval
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroy
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|)
block|{
name|adb
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
comment|/* 	 * The timer is already dead, from the task's shutdown callback. 	 */
name|isc_task_detach
argument_list|(
operator|&
name|adb
operator|->
name|task
argument_list|)
expr_stmt|;
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|nmp
argument_list|)
expr_stmt|;
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|nhmp
argument_list|)
expr_stmt|;
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|zimp
argument_list|)
expr_stmt|;
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|emp
argument_list|)
expr_stmt|;
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|ahmp
argument_list|)
expr_stmt|;
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|aimp
argument_list|)
expr_stmt|;
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|afmp
argument_list|)
expr_stmt|;
name|DESTROYMUTEXBLOCK
argument_list|(
name|adb
operator|->
name|entrylocks
argument_list|,
name|NBUCKETS
argument_list|)
expr_stmt|;
name|DESTROYMUTEXBLOCK
argument_list|(
name|adb
operator|->
name|namelocks
argument_list|,
name|NBUCKETS
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|adb
operator|->
name|reflock
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|adb
operator|->
name|mplock
argument_list|)
expr_stmt|;
name|isc_mem_putanddetach
argument_list|(
operator|&
name|adb
operator|->
name|mctx
argument_list|,
name|adb
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_adb_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Public functions.  */
end_comment

begin_function
name|isc_result_t
name|dns_adb_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mem
parameter_list|,
name|dns_view_t
modifier|*
name|view
parameter_list|,
name|isc_timermgr_t
modifier|*
name|timermgr
parameter_list|,
name|isc_taskmgr_t
modifier|*
name|taskmgr
parameter_list|,
name|dns_adb_t
modifier|*
modifier|*
name|newadb
parameter_list|)
block|{
name|dns_adb_t
modifier|*
name|adb
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|int
name|i
decl_stmt|;
name|REQUIRE
argument_list|(
name|mem
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|view
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|timermgr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|taskmgr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|newadb
operator|!=
name|NULL
operator|&&
operator|*
name|newadb
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|adb
operator|=
name|isc_mem_get
argument_list|(
name|mem
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_adb_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|adb
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
comment|/* 	 * Initialize things here that cannot fail, and especially things 	 * that must be NULL for the error return to work properly. 	 */
name|adb
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|adb
operator|->
name|erefcnt
operator|=
literal|1
expr_stmt|;
name|adb
operator|->
name|irefcnt
operator|=
literal|0
expr_stmt|;
name|adb
operator|->
name|nmp
operator|=
name|NULL
expr_stmt|;
name|adb
operator|->
name|nhmp
operator|=
name|NULL
expr_stmt|;
name|adb
operator|->
name|zimp
operator|=
name|NULL
expr_stmt|;
name|adb
operator|->
name|emp
operator|=
name|NULL
expr_stmt|;
name|adb
operator|->
name|ahmp
operator|=
name|NULL
expr_stmt|;
name|adb
operator|->
name|aimp
operator|=
name|NULL
expr_stmt|;
name|adb
operator|->
name|afmp
operator|=
name|NULL
expr_stmt|;
name|adb
operator|->
name|task
operator|=
name|NULL
expr_stmt|;
name|adb
operator|->
name|timer
operator|=
name|NULL
expr_stmt|;
name|adb
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|adb
operator|->
name|view
operator|=
name|view
expr_stmt|;
name|adb
operator|->
name|timermgr
operator|=
name|timermgr
expr_stmt|;
name|adb
operator|->
name|taskmgr
operator|=
name|taskmgr
expr_stmt|;
name|adb
operator|->
name|next_cleanbucket
operator|=
literal|0
expr_stmt|;
name|ISC_EVENT_INIT
argument_list|(
operator|&
name|adb
operator|->
name|cevent
argument_list|,
sizeof|sizeof
argument_list|(
name|adb
operator|->
name|cevent
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|DNS_EVENT_ADBCONTROL
argument_list|,
name|shutdown_task
argument_list|,
name|adb
argument_list|,
name|adb
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|adb
operator|->
name|cevent_sent
operator|=
name|ISC_FALSE
expr_stmt|;
name|adb
operator|->
name|shutting_down
operator|=
name|ISC_FALSE
expr_stmt|;
name|adb
operator|->
name|overmem
operator|=
name|ISC_FALSE
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|adb
operator|->
name|whenshutdown
argument_list|)
expr_stmt|;
name|isc_mem_attach
argument_list|(
name|mem
argument_list|,
operator|&
name|adb
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail0b
goto|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|adb
operator|->
name|mplock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail0c
goto|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|adb
operator|->
name|reflock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail0d
goto|;
comment|/* 	 * Initialize the bucket locks for names and elements. 	 * May as well initialize the list heads, too. 	 */
name|result
operator|=
name|isc_mutexblock_init
argument_list|(
name|adb
operator|->
name|namelocks
argument_list|,
name|NBUCKETS
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail1
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUCKETS
condition|;
name|i
operator|++
control|)
block|{
name|ISC_LIST_INIT
argument_list|(
name|adb
operator|->
name|names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|adb
operator|->
name|name_sd
index|[
name|i
index|]
operator|=
name|ISC_FALSE
expr_stmt|;
name|adb
operator|->
name|name_refcnt
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|adb
operator|->
name|irefcnt
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUCKETS
condition|;
name|i
operator|++
control|)
block|{
name|ISC_LIST_INIT
argument_list|(
name|adb
operator|->
name|entries
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|adb
operator|->
name|entry_sd
index|[
name|i
index|]
operator|=
name|ISC_FALSE
expr_stmt|;
name|adb
operator|->
name|entry_refcnt
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|adb
operator|->
name|irefcnt
operator|++
expr_stmt|;
block|}
name|result
operator|=
name|isc_mutexblock_init
argument_list|(
name|adb
operator|->
name|entrylocks
argument_list|,
name|NBUCKETS
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail2
goto|;
comment|/* 	 * Memory pools 	 */
define|#
directive|define
name|MPINIT
parameter_list|(
name|t
parameter_list|,
name|p
parameter_list|,
name|n
parameter_list|)
value|do { \ 	result = isc_mempool_create(mem, sizeof(t),&(p)); \ 	if (result != ISC_R_SUCCESS) \ 		goto fail3; \ 	isc_mempool_setfreemax((p), FREE_ITEMS); \ 	isc_mempool_setfillcount((p), FILL_COUNT); \ 	isc_mempool_setname((p), n); \ 	isc_mempool_associatelock((p),&adb->mplock); \ } while (0)
name|MPINIT
argument_list|(
name|dns_adbname_t
argument_list|,
name|adb
operator|->
name|nmp
argument_list|,
literal|"adbname"
argument_list|)
expr_stmt|;
name|MPINIT
argument_list|(
name|dns_adbnamehook_t
argument_list|,
name|adb
operator|->
name|nhmp
argument_list|,
literal|"adbnamehook"
argument_list|)
expr_stmt|;
name|MPINIT
argument_list|(
name|dns_adbzoneinfo_t
argument_list|,
name|adb
operator|->
name|zimp
argument_list|,
literal|"adbzoneinfo"
argument_list|)
expr_stmt|;
name|MPINIT
argument_list|(
name|dns_adbentry_t
argument_list|,
name|adb
operator|->
name|emp
argument_list|,
literal|"adbentry"
argument_list|)
expr_stmt|;
name|MPINIT
argument_list|(
name|dns_adbfind_t
argument_list|,
name|adb
operator|->
name|ahmp
argument_list|,
literal|"adbfind"
argument_list|)
expr_stmt|;
name|MPINIT
argument_list|(
name|dns_adbaddrinfo_t
argument_list|,
name|adb
operator|->
name|aimp
argument_list|,
literal|"adbaddrinfo"
argument_list|)
expr_stmt|;
name|MPINIT
argument_list|(
name|dns_adbfetch_t
argument_list|,
name|adb
operator|->
name|afmp
argument_list|,
literal|"adbfetch"
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|MPINIT
comment|/* 	 * Allocate a timer and a task for our periodic cleanup. 	 */
name|result
operator|=
name|isc_task_create
argument_list|(
name|adb
operator|->
name|taskmgr
argument_list|,
literal|0
argument_list|,
operator|&
name|adb
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail3
goto|;
name|isc_task_setname
argument_list|(
name|adb
operator|->
name|task
argument_list|,
literal|"ADB"
argument_list|,
name|adb
argument_list|)
expr_stmt|;
comment|/* 	 * XXXMLG When this is changed to be a config file option, 	 */
name|isc_interval_set
argument_list|(
operator|&
name|adb
operator|->
name|tick_interval
argument_list|,
name|CLEAN_SECONDS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_timer_create
argument_list|(
name|adb
operator|->
name|timermgr
argument_list|,
name|isc_timertype_once
argument_list|,
name|NULL
argument_list|,
operator|&
name|adb
operator|->
name|tick_interval
argument_list|,
name|adb
operator|->
name|task
argument_list|,
name|timer_cleanup
argument_list|,
name|adb
argument_list|,
operator|&
name|adb
operator|->
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail3
goto|;
name|DP
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|5
argument_list|)
argument_list|,
literal|"cleaning interval for adb: "
literal|"%u buckets every %u seconds, %u buckets in system, %u cl.interval"
argument_list|,
name|CLEAN_BUCKETS
argument_list|,
name|CLEAN_SECONDS
argument_list|,
name|NBUCKETS
argument_list|,
name|CLEAN_PERIOD
argument_list|)
expr_stmt|;
comment|/* 	 * Normal return. 	 */
name|adb
operator|->
name|magic
operator|=
name|DNS_ADB_MAGIC
expr_stmt|;
operator|*
name|newadb
operator|=
name|adb
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|fail3
label|:
if|if
condition|(
name|adb
operator|->
name|task
operator|!=
name|NULL
condition|)
name|isc_task_detach
argument_list|(
operator|&
name|adb
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|timer
operator|!=
name|NULL
condition|)
name|isc_timer_detach
argument_list|(
operator|&
name|adb
operator|->
name|timer
argument_list|)
expr_stmt|;
comment|/* clean up entrylocks */
name|DESTROYMUTEXBLOCK
argument_list|(
name|adb
operator|->
name|entrylocks
argument_list|,
name|NBUCKETS
argument_list|)
expr_stmt|;
name|fail2
label|:
comment|/* clean up namelocks */
name|DESTROYMUTEXBLOCK
argument_list|(
name|adb
operator|->
name|namelocks
argument_list|,
name|NBUCKETS
argument_list|)
expr_stmt|;
name|fail1
label|:
comment|/* clean up only allocated memory */
if|if
condition|(
name|adb
operator|->
name|nmp
operator|!=
name|NULL
condition|)
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|nmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|nhmp
operator|!=
name|NULL
condition|)
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|nhmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|zimp
operator|!=
name|NULL
condition|)
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|zimp
argument_list|)
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|emp
operator|!=
name|NULL
condition|)
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|emp
argument_list|)
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|ahmp
operator|!=
name|NULL
condition|)
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|ahmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|aimp
operator|!=
name|NULL
condition|)
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|aimp
argument_list|)
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|afmp
operator|!=
name|NULL
condition|)
name|isc_mempool_destroy
argument_list|(
operator|&
name|adb
operator|->
name|afmp
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|adb
operator|->
name|reflock
argument_list|)
expr_stmt|;
name|fail0d
label|:
name|DESTROYLOCK
argument_list|(
operator|&
name|adb
operator|->
name|mplock
argument_list|)
expr_stmt|;
name|fail0c
label|:
name|DESTROYLOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|fail0b
label|:
name|isc_mem_putanddetach
argument_list|(
operator|&
name|adb
operator|->
name|mctx
argument_list|,
name|adb
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_adb_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_adb_attach
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adb_t
modifier|*
modifier|*
name|adbx
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|adbx
operator|!=
name|NULL
operator|&&
operator|*
name|adbx
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|inc_adb_erefcnt
argument_list|(
name|adb
argument_list|)
expr_stmt|;
operator|*
name|adbx
operator|=
name|adb
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_adb_detach
parameter_list|(
name|dns_adb_t
modifier|*
modifier|*
name|adbx
parameter_list|)
block|{
name|dns_adb_t
modifier|*
name|adb
decl_stmt|;
name|isc_boolean_t
name|need_exit_check
decl_stmt|;
name|REQUIRE
argument_list|(
name|adbx
operator|!=
name|NULL
operator|&&
name|DNS_ADB_VALID
argument_list|(
operator|*
name|adbx
argument_list|)
argument_list|)
expr_stmt|;
name|adb
operator|=
operator|*
name|adbx
expr_stmt|;
operator|*
name|adbx
operator|=
name|NULL
expr_stmt|;
name|INSIST
argument_list|(
name|adb
operator|->
name|erefcnt
operator|>
literal|0
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|reflock
argument_list|)
expr_stmt|;
name|adb
operator|->
name|erefcnt
operator|--
expr_stmt|;
name|need_exit_check
operator|=
name|ISC_TF
argument_list|(
name|adb
operator|->
name|erefcnt
operator|==
literal|0
operator|&&
name|adb
operator|->
name|irefcnt
operator|==
literal|0
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|reflock
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_exit_check
condition|)
block|{
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|adb
operator|->
name|shutting_down
argument_list|)
expr_stmt|;
name|check_exit
argument_list|(
name|adb
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|dns_adb_whenshutdown
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
modifier|*
name|eventp
parameter_list|)
block|{
name|isc_task_t
modifier|*
name|clone
decl_stmt|;
name|isc_event_t
modifier|*
name|event
decl_stmt|;
name|isc_boolean_t
name|zeroirefcnt
init|=
name|ISC_FALSE
decl_stmt|;
comment|/* 	 * Send '*eventp' to 'task' when 'adb' has shutdown. 	 */
name|REQUIRE
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|eventp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|event
operator|=
operator|*
name|eventp
expr_stmt|;
operator|*
name|eventp
operator|=
name|NULL
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|reflock
argument_list|)
expr_stmt|;
name|zeroirefcnt
operator|=
name|ISC_TF
argument_list|(
name|adb
operator|->
name|irefcnt
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|shutting_down
operator|&&
name|zeroirefcnt
operator|&&
name|isc_mempool_getallocated
argument_list|(
name|adb
operator|->
name|ahmp
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * We're already shutdown.  Send the event. 		 */
name|event
operator|->
name|ev_sender
operator|=
name|adb
expr_stmt|;
name|isc_task_send
argument_list|(
name|task
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|clone
operator|=
name|NULL
expr_stmt|;
name|isc_task_attach
argument_list|(
name|task
argument_list|,
operator|&
name|clone
argument_list|)
expr_stmt|;
name|event
operator|->
name|ev_sender
operator|=
name|clone
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|adb
operator|->
name|whenshutdown
argument_list|,
name|event
argument_list|,
name|ev_link
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|reflock
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_adb_shutdown
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|)
block|{
name|isc_boolean_t
name|need_check_exit
decl_stmt|;
comment|/* 	 * Shutdown 'adb'. 	 */
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|adb
operator|->
name|shutting_down
condition|)
block|{
name|adb
operator|->
name|shutting_down
operator|=
name|ISC_TRUE
expr_stmt|;
name|isc_mem_setwater
argument_list|(
name|adb
operator|->
name|mctx
argument_list|,
name|water
argument_list|,
name|adb
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|need_check_exit
operator|=
name|shutdown_names
argument_list|(
name|adb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|need_check_exit
condition|)
name|need_check_exit
operator|=
name|shutdown_entries
argument_list|(
name|adb
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_check_exit
condition|)
name|check_exit
argument_list|(
name|adb
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_adb_createfind
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_name_t
modifier|*
name|zone
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|dns_name_t
modifier|*
name|target
parameter_list|,
name|in_port_t
name|port
parameter_list|,
name|dns_adbfind_t
modifier|*
modifier|*
name|findp
parameter_list|)
block|{
name|dns_adbfind_t
modifier|*
name|find
decl_stmt|;
name|dns_adbname_t
modifier|*
name|adbname
decl_stmt|;
name|int
name|bucket
decl_stmt|;
name|isc_boolean_t
name|want_event
decl_stmt|,
name|start_at_zone
decl_stmt|,
name|alias
decl_stmt|,
name|have_address
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|wanted_addresses
decl_stmt|;
name|unsigned
name|int
name|wanted_fetches
decl_stmt|;
name|unsigned
name|int
name|query_pending
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|task
operator|!=
name|NULL
condition|)
block|{
name|REQUIRE
argument_list|(
name|action
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
name|REQUIRE
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|zone
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|findp
operator|!=
name|NULL
operator|&&
operator|*
name|findp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|==
name|NULL
operator|||
name|dns_name_hasbuffer
argument_list|(
name|target
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|(
name|options
operator|&
name|DNS_ADBFIND_ADDRESSMASK
operator|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_UNEXPECTED
expr_stmt|;
name|wanted_addresses
operator|=
operator|(
name|options
operator|&
name|DNS_ADBFIND_ADDRESSMASK
operator|)
expr_stmt|;
name|wanted_fetches
operator|=
literal|0
expr_stmt|;
name|query_pending
operator|=
literal|0
expr_stmt|;
name|want_event
operator|=
name|ISC_FALSE
expr_stmt|;
name|start_at_zone
operator|=
name|ISC_FALSE
expr_stmt|;
name|alias
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|now
operator|==
literal|0
condition|)
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* 	 * XXXMLG  Move this comment somewhere else! 	 * 	 * Look up the name in our internal database. 	 * 	 * Possibilities:  Note that these are not always exclusive. 	 * 	 *	No name found.  In this case, allocate a new name header and 	 *	an initial namehook or two.  If any of these allocations 	 *	fail, clean up and return ISC_R_NOMEMORY. 	 * 	 *	Name found, valid addresses present.  Allocate one addrinfo 	 *	structure for each found and append it to the linked list 	 *	of addresses for this header. 	 * 	 *	Name found, queries pending.  In this case, if a task was 	 *	passed in, allocate a job id, attach it to the name's job 	 *	list and remember to tell the caller that there will be 	 *	more info coming later. 	 */
name|find
operator|=
name|new_adbfind
argument_list|(
name|adb
argument_list|)
expr_stmt|;
if|if
condition|(
name|find
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|find
operator|->
name|port
operator|=
name|port
expr_stmt|;
comment|/* 	 * Remember what types of addresses we are interested in. 	 */
name|find
operator|->
name|options
operator|=
name|options
expr_stmt|;
name|find
operator|->
name|flags
operator||=
name|wanted_addresses
expr_stmt|;
if|if
condition|(
name|FIND_WANTEVENT
argument_list|(
name|find
argument_list|)
condition|)
block|{
name|REQUIRE
argument_list|(
name|task
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Try to see if we know anything about this name at all. 	 */
name|bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
name|adbname
operator|=
name|find_name_and_lock
argument_list|(
name|adb
argument_list|,
name|name
argument_list|,
name|find
operator|->
name|options
argument_list|,
operator|&
name|bucket
argument_list|)
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|name_sd
index|[
name|bucket
index|]
condition|)
block|{
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"dns_adb_createfind: returning ISC_R_SHUTTINGDOWN"
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|free_adbfind
argument_list|(
name|adb
argument_list|,
operator|&
name|find
argument_list|)
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SHUTTINGDOWN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Nothing found.  Allocate a new adbname structure for this name. 	 */
if|if
condition|(
name|adbname
operator|==
name|NULL
condition|)
block|{
name|adbname
operator|=
name|new_adbname
argument_list|(
name|adb
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|adbname
operator|==
name|NULL
condition|)
block|{
name|RUNTIME_CHECK
argument_list|(
name|free_adbfind
argument_list|(
name|adb
argument_list|,
operator|&
name|find
argument_list|)
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|link_name
argument_list|(
name|adb
argument_list|,
name|bucket
argument_list|,
name|adbname
argument_list|)
expr_stmt|;
if|if
condition|(
name|FIND_HINTOK
argument_list|(
name|find
argument_list|)
condition|)
name|adbname
operator|->
name|flags
operator||=
name|NAME_HINT_OK
expr_stmt|;
if|if
condition|(
name|FIND_GLUEOK
argument_list|(
name|find
argument_list|)
condition|)
name|adbname
operator|->
name|flags
operator||=
name|NAME_GLUE_OK
expr_stmt|;
if|if
condition|(
name|FIND_STARTATZONE
argument_list|(
name|find
argument_list|)
condition|)
name|adbname
operator|->
name|flags
operator||=
name|NAME_STARTATZONE
expr_stmt|;
block|}
comment|/* 	 * Expire old entries, etc. 	 */
name|RUNTIME_CHECK
argument_list|(
name|check_expire_namehooks
argument_list|(
name|adbname
argument_list|,
name|now
argument_list|,
name|adb
operator|->
name|overmem
argument_list|)
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
comment|/* 	 * Do we know that the name is an alias? 	 */
if|if
condition|(
operator|!
name|EXPIRE_OK
argument_list|(
name|adbname
operator|->
name|expire_target
argument_list|,
name|now
argument_list|)
condition|)
block|{
comment|/* 		 * Yes, it is. 		 */
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"dns_adb_createfind: name %p is an alias (cached)"
argument_list|,
name|adbname
argument_list|)
expr_stmt|;
name|alias
operator|=
name|ISC_TRUE
expr_stmt|;
goto|goto
name|post_copy
goto|;
block|}
comment|/* 	 * Try to populate the name from the database and/or 	 * start fetches.  First try looking for an A record 	 * in the database. 	 */
if|if
condition|(
operator|!
name|NAME_HAS_V4
argument_list|(
name|adbname
argument_list|)
operator|&&
name|EXPIRE_OK
argument_list|(
name|adbname
operator|->
name|expire_v4
argument_list|,
name|now
argument_list|)
operator|&&
name|WANT_INET
argument_list|(
name|wanted_addresses
argument_list|)
condition|)
block|{
name|result
operator|=
name|dbfind_name
argument_list|(
name|adbname
argument_list|,
name|now
argument_list|,
name|dns_rdatatype_a
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"dns_adb_createfind: found A for name %p in db"
argument_list|,
name|adbname
argument_list|)
expr_stmt|;
goto|goto
name|v6
goto|;
block|}
comment|/* 		 * Did we get a CNAME or DNAME? 		 */
if|if
condition|(
name|result
operator|==
name|DNS_R_ALIAS
condition|)
block|{
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"dns_adb_createfind: name %p is an alias"
argument_list|,
name|adbname
argument_list|)
expr_stmt|;
name|alias
operator|=
name|ISC_TRUE
expr_stmt|;
goto|goto
name|post_copy
goto|;
block|}
comment|/* 		 * If the name doesn't exist at all, don't bother with 		 * v6 queries; they won't work. 		 * 		 * If the name does exist but we didn't get our data, go 		 * ahead and try AAAA. 		 * 		 * If the result is neither of these, try a fetch for A. 		 */
if|if
condition|(
name|NXDOMAIN_RESULT
argument_list|(
name|result
argument_list|)
condition|)
goto|goto
name|fetch
goto|;
elseif|else
if|if
condition|(
name|NXRRSET_RESULT
argument_list|(
name|result
argument_list|)
condition|)
goto|goto
name|v6
goto|;
if|if
condition|(
operator|!
name|NAME_FETCH_V4
argument_list|(
name|adbname
argument_list|)
condition|)
name|wanted_fetches
operator||=
name|DNS_ADBFIND_INET
expr_stmt|;
block|}
name|v6
label|:
if|if
condition|(
operator|!
name|NAME_HAS_V6
argument_list|(
name|adbname
argument_list|)
operator|&&
name|EXPIRE_OK
argument_list|(
name|adbname
operator|->
name|expire_v6
argument_list|,
name|now
argument_list|)
operator|&&
name|WANT_INET6
argument_list|(
name|wanted_addresses
argument_list|)
condition|)
block|{
name|result
operator|=
name|dbfind_name
argument_list|(
name|adbname
argument_list|,
name|now
argument_list|,
name|dns_rdatatype_aaaa
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"dns_adb_createfind: found AAAA for name %p"
argument_list|,
name|adbname
argument_list|)
expr_stmt|;
goto|goto
name|fetch
goto|;
block|}
comment|/* 		 * Did we get a CNAME or DNAME? 		 */
if|if
condition|(
name|result
operator|==
name|DNS_R_ALIAS
condition|)
block|{
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"dns_adb_createfind: name %p is an alias"
argument_list|,
name|adbname
argument_list|)
expr_stmt|;
name|alias
operator|=
name|ISC_TRUE
expr_stmt|;
goto|goto
name|post_copy
goto|;
block|}
comment|/* 		 * Listen to negative cache hints, and don't start 		 * another query. 		 */
if|if
condition|(
name|NCACHE_RESULT
argument_list|(
name|result
argument_list|)
operator|||
name|AUTH_NX
argument_list|(
name|result
argument_list|)
condition|)
goto|goto
name|fetch
goto|;
if|if
condition|(
operator|!
name|NAME_FETCH_V6
argument_list|(
name|adbname
argument_list|)
condition|)
name|wanted_fetches
operator||=
name|DNS_ADBFIND_INET6
expr_stmt|;
block|}
name|fetch
label|:
if|if
condition|(
operator|(
name|WANT_INET
argument_list|(
name|wanted_addresses
argument_list|)
operator|&&
name|NAME_HAS_V4
argument_list|(
name|adbname
argument_list|)
operator|)
operator|||
operator|(
name|WANT_INET6
argument_list|(
name|wanted_addresses
argument_list|)
operator|&&
name|NAME_HAS_V6
argument_list|(
name|adbname
argument_list|)
operator|)
condition|)
name|have_address
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|have_address
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|wanted_fetches
operator|!=
literal|0
operator|&&
operator|!
operator|(
name|FIND_AVOIDFETCHES
argument_list|(
name|find
argument_list|)
operator|&&
name|have_address
operator|)
condition|)
block|{
comment|/* 		 * We're missing at least one address family.  Either the 		 * caller hasn't instructed us to avoid fetches, or we don't 		 * know anything about any of the address families that would 		 * be acceptable so we have to launch fetches. 		 */
if|if
condition|(
name|FIND_STARTATZONE
argument_list|(
name|find
argument_list|)
condition|)
name|start_at_zone
operator|=
name|ISC_TRUE
expr_stmt|;
comment|/* 		 * Start V4. 		 */
if|if
condition|(
name|WANT_INET
argument_list|(
name|wanted_fetches
argument_list|)
operator|&&
name|fetch_name
argument_list|(
name|adbname
argument_list|,
name|start_at_zone
argument_list|,
name|dns_rdatatype_a
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"dns_adb_createfind: started A fetch for name %p"
argument_list|,
name|adbname
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Start V6. 		 */
if|if
condition|(
name|WANT_INET6
argument_list|(
name|wanted_fetches
argument_list|)
operator|&&
name|fetch_name
argument_list|(
name|adbname
argument_list|,
name|start_at_zone
argument_list|,
name|dns_rdatatype_aaaa
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"dns_adb_createfind: "
literal|"started AAAA fetch for name %p"
argument_list|,
name|adbname
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Run through the name and copy out the bits we are 	 * interested in. 	 */
name|copy_namehook_lists
argument_list|(
name|adb
argument_list|,
name|find
argument_list|,
name|zone
argument_list|,
name|adbname
argument_list|,
name|now
argument_list|)
expr_stmt|;
name|post_copy
label|:
if|if
condition|(
name|NAME_FETCH_V4
argument_list|(
name|adbname
argument_list|)
condition|)
name|query_pending
operator||=
name|DNS_ADBFIND_INET
expr_stmt|;
if|if
condition|(
name|NAME_FETCH_V6
argument_list|(
name|adbname
argument_list|)
condition|)
name|query_pending
operator||=
name|DNS_ADBFIND_INET6
expr_stmt|;
comment|/* 	 * Attach to the name's query list if there are queries 	 * already running, and we have been asked to. 	 */
name|want_event
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|FIND_WANTEVENT
argument_list|(
name|find
argument_list|)
condition|)
name|want_event
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|FIND_WANTEMPTYEVENT
argument_list|(
name|find
argument_list|)
operator|&&
name|FIND_HAS_ADDRS
argument_list|(
name|find
argument_list|)
condition|)
name|want_event
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
operator|(
name|wanted_addresses
operator|&
name|query_pending
operator|)
operator|==
literal|0
condition|)
name|want_event
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|alias
condition|)
name|want_event
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|want_event
condition|)
block|{
name|find
operator|->
name|adbname
operator|=
name|adbname
expr_stmt|;
name|find
operator|->
name|name_bucket
operator|=
name|bucket
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|adbname
operator|->
name|finds
argument_list|,
name|find
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|find
operator|->
name|query_pending
operator|=
operator|(
name|query_pending
operator|&
name|wanted_addresses
operator|)
expr_stmt|;
name|find
operator|->
name|flags
operator|&=
operator|~
name|DNS_ADBFIND_ADDRESSMASK
expr_stmt|;
name|find
operator|->
name|flags
operator||=
operator|(
name|find
operator|->
name|query_pending
operator|&
name|DNS_ADBFIND_ADDRESSMASK
operator|)
expr_stmt|;
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"createfind: attaching find %p to adbname %p"
argument_list|,
name|find
argument_list|,
name|adbname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Remove the flag so the caller knows there will never 		 * be an event, and set internal flags to fake that 		 * the event was sent and freed, so dns_adb_destroyfind() will 		 * do the right thing. 		 */
name|find
operator|->
name|query_pending
operator|=
operator|(
name|query_pending
operator|&
name|wanted_addresses
operator|)
expr_stmt|;
name|find
operator|->
name|options
operator|&=
operator|~
name|DNS_ADBFIND_WANTEVENT
expr_stmt|;
name|find
operator|->
name|flags
operator||=
operator|(
name|FIND_EVENT_SENT
operator||
name|FIND_EVENT_FREED
operator|)
expr_stmt|;
name|find
operator|->
name|flags
operator|&=
operator|~
name|DNS_ADBFIND_ADDRESSMASK
expr_stmt|;
block|}
name|find
operator|->
name|partial_result
operator||=
operator|(
name|adbname
operator|->
name|partial_result
operator|&
name|wanted_addresses
operator|)
expr_stmt|;
if|if
condition|(
name|alias
condition|)
block|{
if|if
condition|(
name|target
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|dns_name_copy
argument_list|(
operator|&
name|adbname
operator|->
name|target
argument_list|,
name|target
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|out
goto|;
block|}
name|result
operator|=
name|DNS_R_ALIAS
expr_stmt|;
block|}
else|else
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
comment|/* 	 * Copy out error flags from the name structure into the find. 	 */
name|find
operator|->
name|result_v4
operator|=
name|find_err_map
index|[
name|adbname
operator|->
name|fetch_err
index|]
expr_stmt|;
name|find
operator|->
name|result_v6
operator|=
name|find_err_map
index|[
name|adbname
operator|->
name|fetch6_err
index|]
expr_stmt|;
name|out
label|:
if|if
condition|(
name|find
operator|!=
name|NULL
condition|)
block|{
operator|*
name|findp
operator|=
name|find
expr_stmt|;
if|if
condition|(
name|want_event
condition|)
block|{
name|isc_task_t
modifier|*
name|taskp
decl_stmt|;
name|INSIST
argument_list|(
operator|(
name|find
operator|->
name|flags
operator|&
name|DNS_ADBFIND_ADDRESSMASK
operator|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|taskp
operator|=
name|NULL
expr_stmt|;
name|isc_task_attach
argument_list|(
name|task
argument_list|,
operator|&
name|taskp
argument_list|)
expr_stmt|;
name|find
operator|->
name|event
operator|.
name|ev_sender
operator|=
name|taskp
expr_stmt|;
name|find
operator|->
name|event
operator|.
name|ev_action
operator|=
name|action
expr_stmt|;
name|find
operator|->
name|event
operator|.
name|ev_arg
operator|=
name|arg
expr_stmt|;
block|}
block|}
if|if
condition|(
name|bucket
operator|!=
name|DNS_ADB_INVALIDBUCKET
condition|)
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_adb_destroyfind
parameter_list|(
name|dns_adbfind_t
modifier|*
modifier|*
name|findp
parameter_list|)
block|{
name|dns_adbfind_t
modifier|*
name|find
decl_stmt|;
name|dns_adbentry_t
modifier|*
name|entry
decl_stmt|;
name|dns_adbaddrinfo_t
modifier|*
name|ai
decl_stmt|;
name|int
name|bucket
decl_stmt|;
name|dns_adb_t
modifier|*
name|adb
decl_stmt|;
name|REQUIRE
argument_list|(
name|findp
operator|!=
name|NULL
operator|&&
name|DNS_ADBFIND_VALID
argument_list|(
operator|*
name|findp
argument_list|)
argument_list|)
expr_stmt|;
name|find
operator|=
operator|*
name|findp
expr_stmt|;
operator|*
name|findp
operator|=
name|NULL
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|find
operator|->
name|lock
argument_list|)
expr_stmt|;
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"dns_adb_destroyfind on find %p"
argument_list|,
name|find
argument_list|)
expr_stmt|;
name|adb
operator|=
name|find
operator|->
name|adb
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|FIND_EVENTFREED
argument_list|(
name|find
argument_list|)
argument_list|)
expr_stmt|;
name|bucket
operator|=
name|find
operator|->
name|name_bucket
expr_stmt|;
name|INSIST
argument_list|(
name|bucket
operator|==
name|DNS_ADB_INVALIDBUCKET
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|find
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* 	 * The find doesn't exist on any list, and nothing is locked. 	 * Return the find to the memory pool, and decrement the adb's 	 * reference count. 	 */
name|ai
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|find
operator|->
name|list
argument_list|)
expr_stmt|;
while|while
condition|(
name|ai
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|find
operator|->
name|list
argument_list|,
name|ai
argument_list|,
name|publink
argument_list|)
expr_stmt|;
name|entry
operator|=
name|ai
operator|->
name|entry
expr_stmt|;
name|ai
operator|->
name|entry
operator|=
name|NULL
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ADBENTRY_VALID
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|dec_entry_refcnt
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|,
name|ISC_TRUE
argument_list|)
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|free_adbaddrinfo
argument_list|(
name|adb
argument_list|,
operator|&
name|ai
argument_list|)
expr_stmt|;
name|ai
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|find
operator|->
name|list
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * WARNING:  The find is freed with the adb locked.  This is done 	 * to avoid a race condition where we free the find, some other 	 * thread tests to see if it should be destroyed, detects it should 	 * be, destroys it, and then we try to lock it for our check, but the 	 * lock is destroyed. 	 */
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|free_adbfind
argument_list|(
name|adb
argument_list|,
operator|&
name|find
argument_list|)
condition|)
name|check_exit
argument_list|(
name|adb
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_adb_cancelfind
parameter_list|(
name|dns_adbfind_t
modifier|*
name|find
parameter_list|)
block|{
name|isc_event_t
modifier|*
name|ev
decl_stmt|;
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|dns_adb_t
modifier|*
name|adb
decl_stmt|;
name|int
name|bucket
decl_stmt|;
name|int
name|unlock_bucket
decl_stmt|;
name|LOCK
argument_list|(
operator|&
name|find
operator|->
name|lock
argument_list|)
expr_stmt|;
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"dns_adb_cancelfind on find %p"
argument_list|,
name|find
argument_list|)
expr_stmt|;
name|adb
operator|=
name|find
operator|->
name|adb
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|!
name|FIND_EVENTFREED
argument_list|(
name|find
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|FIND_WANTEVENT
argument_list|(
name|find
argument_list|)
argument_list|)
expr_stmt|;
name|bucket
operator|=
name|find
operator|->
name|name_bucket
expr_stmt|;
if|if
condition|(
name|bucket
operator|==
name|DNS_ADB_INVALIDBUCKET
condition|)
goto|goto
name|cleanup
goto|;
comment|/* 	 * We need to get the adbname's lock to unlink the find. 	 */
name|unlock_bucket
operator|=
name|bucket
expr_stmt|;
name|violate_locking_hierarchy
argument_list|(
operator|&
name|find
operator|->
name|lock
argument_list|,
operator|&
name|adb
operator|->
name|namelocks
index|[
name|unlock_bucket
index|]
argument_list|)
expr_stmt|;
name|bucket
operator|=
name|find
operator|->
name|name_bucket
expr_stmt|;
if|if
condition|(
name|bucket
operator|!=
name|DNS_ADB_INVALIDBUCKET
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|find
operator|->
name|adbname
operator|->
name|finds
argument_list|,
name|find
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|find
operator|->
name|adbname
operator|=
name|NULL
expr_stmt|;
name|find
operator|->
name|name_bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|unlock_bucket
index|]
argument_list|)
expr_stmt|;
name|bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
operator|!
name|FIND_EVENTSENT
argument_list|(
name|find
argument_list|)
condition|)
block|{
name|ev
operator|=
operator|&
name|find
operator|->
name|event
expr_stmt|;
name|task
operator|=
name|ev
operator|->
name|ev_sender
expr_stmt|;
name|ev
operator|->
name|ev_sender
operator|=
name|find
expr_stmt|;
name|ev
operator|->
name|ev_type
operator|=
name|DNS_EVENT_ADBCANCELED
expr_stmt|;
name|ev
operator|->
name|ev_destroy
operator|=
name|event_free
expr_stmt|;
name|ev
operator|->
name|ev_destroy_arg
operator|=
name|find
expr_stmt|;
name|find
operator|->
name|result_v4
operator|=
name|ISC_R_CANCELED
expr_stmt|;
name|find
operator|->
name|result_v6
operator|=
name|ISC_R_CANCELED
expr_stmt|;
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"sending event %p to task %p for find %p"
argument_list|,
name|ev
argument_list|,
name|task
argument_list|,
name|find
argument_list|)
expr_stmt|;
name|isc_task_sendanddetach
argument_list|(
operator|&
name|task
argument_list|,
operator|(
name|isc_event_t
operator|*
operator|*
operator|)
operator|&
name|ev
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|find
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_adb_dump
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|isc_stdtime_t
name|now
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|f
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Lock the adb itself, lock all the name buckets, then lock all 	 * the entry buckets.  This should put the adb into a state where 	 * nothing can change, so we can iterate through everything and 	 * print at our leisure. 	 */
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUCKETS
condition|;
name|i
operator|++
control|)
name|RUNTIME_CHECK
argument_list|(
name|cleanup_names
argument_list|(
name|adb
argument_list|,
name|i
argument_list|,
name|now
argument_list|)
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUCKETS
condition|;
name|i
operator|++
control|)
name|RUNTIME_CHECK
argument_list|(
name|cleanup_entries
argument_list|(
name|adb
argument_list|,
name|i
argument_list|,
name|now
argument_list|)
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|dump_adb
argument_list|(
name|adb
argument_list|,
name|f
argument_list|,
name|ISC_FALSE
argument_list|,
name|now
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_ttl
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
specifier|const
name|char
modifier|*
name|legend
parameter_list|,
name|isc_stdtime_t
name|value
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
if|if
condition|(
name|value
operator|==
name|INT_MAX
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" [%s TTL %d]"
argument_list|,
name|legend
argument_list|,
name|value
operator|-
name|now
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_adb
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|isc_boolean_t
name|debug
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|dns_adbname_t
modifier|*
name|name
decl_stmt|;
name|dns_adbentry_t
modifier|*
name|entry
decl_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|";\n; Address database dump\n;\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"; addr %p, erefcnt %u, irefcnt %u, finds out %u\n"
argument_list|,
name|adb
argument_list|,
name|adb
operator|->
name|erefcnt
argument_list|,
name|adb
operator|->
name|irefcnt
argument_list|,
name|isc_mempool_getallocated
argument_list|(
name|adb
operator|->
name|nhmp
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUCKETS
condition|;
name|i
operator|++
control|)
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUCKETS
condition|;
name|i
operator|++
control|)
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* 	 * Dump the names 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUCKETS
condition|;
name|i
operator|++
control|)
block|{
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|adb
operator|->
name|names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"; bucket %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|name
operator|!=
name|NULL
condition|;
name|name
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|name
argument_list|,
name|plink
argument_list|)
control|)
block|{
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"; name %p (flags %08x)\n"
argument_list|,
name|name
argument_list|,
name|name
operator|->
name|flags
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"; "
argument_list|)
expr_stmt|;
name|print_dns_name
argument_list|(
name|f
argument_list|,
operator|&
name|name
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_name_countlabels
argument_list|(
operator|&
name|name
operator|->
name|target
argument_list|)
operator|>
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" alias "
argument_list|)
expr_stmt|;
name|print_dns_name
argument_list|(
name|f
argument_list|,
operator|&
name|name
operator|->
name|target
argument_list|)
expr_stmt|;
block|}
name|dump_ttl
argument_list|(
name|f
argument_list|,
literal|"v4"
argument_list|,
name|name
operator|->
name|expire_v4
argument_list|,
name|now
argument_list|)
expr_stmt|;
name|dump_ttl
argument_list|(
name|f
argument_list|,
literal|"v6"
argument_list|,
name|name
operator|->
name|expire_v6
argument_list|,
name|now
argument_list|)
expr_stmt|;
name|dump_ttl
argument_list|(
name|f
argument_list|,
literal|"target"
argument_list|,
name|name
operator|->
name|expire_target
argument_list|,
name|now
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" [v4 %s] [v6 %s]"
argument_list|,
name|errnames
index|[
name|name
operator|->
name|fetch_err
index|]
argument_list|,
name|errnames
index|[
name|name
operator|->
name|fetch6_err
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|print_namehook_list
argument_list|(
name|f
argument_list|,
literal|"v4"
argument_list|,
operator|&
name|name
operator|->
name|v4
argument_list|,
name|debug
argument_list|,
name|now
argument_list|)
expr_stmt|;
name|print_namehook_list
argument_list|(
name|f
argument_list|,
literal|"v6"
argument_list|,
operator|&
name|name
operator|->
name|v6
argument_list|,
name|debug
argument_list|,
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|print_fetch_list
argument_list|(
name|f
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|print_find_list
argument_list|(
name|f
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|";\n; Unassociated entries\n;\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUCKETS
condition|;
name|i
operator|++
control|)
block|{
name|entry
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|adb
operator|->
name|entries
index|[
name|i
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|entry
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|entry
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|dump_entry
argument_list|(
name|f
argument_list|,
name|entry
argument_list|,
name|debug
argument_list|,
name|now
argument_list|)
expr_stmt|;
name|entry
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|entry
argument_list|,
name|plink
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Unlock everything 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUCKETS
condition|;
name|i
operator|++
control|)
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUCKETS
condition|;
name|i
operator|++
control|)
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_entry
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|dns_adbentry_t
modifier|*
name|entry
parameter_list|,
name|isc_boolean_t
name|debug
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
name|char
name|addrbuf
index|[
name|ISC_NETADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_netaddr_t
name|netaddr
decl_stmt|;
name|dns_adbzoneinfo_t
modifier|*
name|zi
decl_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|netaddr
argument_list|,
operator|&
name|entry
operator|->
name|sockaddr
argument_list|)
expr_stmt|;
name|isc_netaddr_format
argument_list|(
operator|&
name|netaddr
argument_list|,
name|addrbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|addrbuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|";\t%p: refcnt %u\n"
argument_list|,
name|entry
argument_list|,
name|entry
operator|->
name|refcnt
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|";\t%s [srtt %u] [flags %08x]"
argument_list|,
name|addrbuf
argument_list|,
name|entry
operator|->
name|srtt
argument_list|,
name|entry
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|expires
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" [ttl %d]"
argument_list|,
name|entry
operator|->
name|expires
operator|-
name|now
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|zi
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|entry
operator|->
name|zoneinfo
argument_list|)
init|;
name|zi
operator|!=
name|NULL
condition|;
name|zi
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|zi
argument_list|,
name|plink
argument_list|)
control|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|";\t\t"
argument_list|)
expr_stmt|;
name|print_dns_name
argument_list|(
name|f
argument_list|,
operator|&
name|zi
operator|->
name|zone
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" [lame TTL %d]\n"
argument_list|,
name|zi
operator|->
name|lame_timer
operator|-
name|now
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|dns_adb_dumpfind
parameter_list|(
name|dns_adbfind_t
modifier|*
name|find
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|)
block|{
name|char
name|tmp
index|[
literal|512
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|tmpp
decl_stmt|;
name|dns_adbaddrinfo_t
modifier|*
name|ai
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|sa
decl_stmt|;
comment|/* 	 * Not used currently, in the API Just In Case we 	 * want to dump out the name and/or entries too. 	 */
name|LOCK
argument_list|(
operator|&
name|find
operator|->
name|lock
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|";Find %p\n"
argument_list|,
name|find
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|";\tqpending %08x partial %08x options %08x flags %08x\n"
argument_list|,
name|find
operator|->
name|query_pending
argument_list|,
name|find
operator|->
name|partial_result
argument_list|,
name|find
operator|->
name|options
argument_list|,
name|find
operator|->
name|flags
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|";\tname_bucket %d, name %p, event sender %p\n"
argument_list|,
name|find
operator|->
name|name_bucket
argument_list|,
name|find
operator|->
name|adbname
argument_list|,
name|find
operator|->
name|event
operator|.
name|ev_sender
argument_list|)
expr_stmt|;
name|ai
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|find
operator|->
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|!=
name|NULL
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tAddresses:\n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|ai
operator|!=
name|NULL
condition|)
block|{
name|sa
operator|=
operator|&
name|ai
operator|->
name|sockaddr
expr_stmt|;
switch|switch
condition|(
name|sa
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|tmpp
operator|=
name|inet_ntop
argument_list|(
name|AF_INET
argument_list|,
operator|&
name|sa
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_addr
argument_list|,
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|tmpp
operator|=
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
name|sa
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
argument_list|,
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|tmpp
operator|=
literal|"UnkFamily"
expr_stmt|;
block|}
if|if
condition|(
name|tmpp
operator|==
name|NULL
condition|)
name|tmpp
operator|=
literal|"BadAddress"
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\t\tentry %p, flags %08x"
literal|" srtt %u addr %s\n"
argument_list|,
name|ai
operator|->
name|entry
argument_list|,
name|ai
operator|->
name|flags
argument_list|,
name|ai
operator|->
name|srtt
argument_list|,
name|tmpp
argument_list|)
expr_stmt|;
name|ai
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|ai
argument_list|,
name|publink
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|find
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_dns_name
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|char
name|buf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|INSIST
argument_list|(
name|f
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_namehook_list
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
specifier|const
name|char
modifier|*
name|legend
parameter_list|,
name|dns_adbnamehooklist_t
modifier|*
name|list
parameter_list|,
name|isc_boolean_t
name|debug
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
name|dns_adbnamehook_t
modifier|*
name|nh
decl_stmt|;
for|for
control|(
name|nh
operator|=
name|ISC_LIST_HEAD
argument_list|(
operator|*
name|list
argument_list|)
init|;
name|nh
operator|!=
name|NULL
condition|;
name|nh
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|nh
argument_list|,
name|plink
argument_list|)
control|)
block|{
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|";\tHook(%s) %p\n"
argument_list|,
name|legend
argument_list|,
name|nh
argument_list|)
expr_stmt|;
name|dump_entry
argument_list|(
name|f
argument_list|,
name|nh
operator|->
name|entry
argument_list|,
name|debug
argument_list|,
name|now
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|print_fetch
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|dns_adbfetch_t
modifier|*
name|ft
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\t\tFetch(%s): %p -> { nh %p, entry %p, fetch %p }\n"
argument_list|,
name|type
argument_list|,
name|ft
argument_list|,
name|ft
operator|->
name|namehook
argument_list|,
name|ft
operator|->
name|entry
argument_list|,
name|ft
operator|->
name|fetch
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_fetch_list
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|dns_adbname_t
modifier|*
name|n
parameter_list|)
block|{
if|if
condition|(
name|NAME_FETCH_A
argument_list|(
name|n
argument_list|)
condition|)
name|print_fetch
argument_list|(
name|f
argument_list|,
name|n
operator|->
name|fetch_a
argument_list|,
literal|"A"
argument_list|)
expr_stmt|;
if|if
condition|(
name|NAME_FETCH_AAAA
argument_list|(
name|n
argument_list|)
condition|)
name|print_fetch
argument_list|(
name|f
argument_list|,
name|n
operator|->
name|fetch_aaaa
argument_list|,
literal|"AAAA"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_find_list
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|dns_adbname_t
modifier|*
name|name
parameter_list|)
block|{
name|dns_adbfind_t
modifier|*
name|find
decl_stmt|;
name|find
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|finds
argument_list|)
expr_stmt|;
while|while
condition|(
name|find
operator|!=
name|NULL
condition|)
block|{
name|dns_adb_dumpfind
argument_list|(
name|find
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|find
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|find
argument_list|,
name|plink
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbfind_name
parameter_list|(
name|dns_adbname_t
modifier|*
name|adbname
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|dns_rdatatype_t
name|rdtype
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_adb_t
modifier|*
name|adb
decl_stmt|;
name|dns_fixedname_t
name|foundname
decl_stmt|;
name|dns_name_t
modifier|*
name|fname
decl_stmt|;
name|INSIST
argument_list|(
name|DNS_ADBNAME_VALID
argument_list|(
name|adbname
argument_list|)
argument_list|)
expr_stmt|;
name|adb
operator|=
name|adbname
operator|->
name|adb
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|rdtype
operator|==
name|dns_rdatatype_a
operator|||
name|rdtype
operator|==
name|dns_rdatatype_aaaa
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|foundname
argument_list|)
expr_stmt|;
name|fname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|foundname
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_a
condition|)
name|adbname
operator|->
name|fetch_err
operator|=
name|FIND_ERR_UNEXPECTED
expr_stmt|;
else|else
name|adbname
operator|->
name|fetch6_err
operator|=
name|FIND_ERR_UNEXPECTED
expr_stmt|;
name|result
operator|=
name|dns_view_find
argument_list|(
name|adb
operator|->
name|view
argument_list|,
operator|&
name|adbname
operator|->
name|name
argument_list|,
name|rdtype
argument_list|,
name|now
argument_list|,
name|NAME_GLUEOK
argument_list|(
name|adbname
argument_list|)
argument_list|,
name|ISC_TF
argument_list|(
name|NAME_HINTOK
argument_list|(
name|adbname
argument_list|)
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|fname
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* XXXVIX this switch statement is too sparse to gen a jump table. */
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|DNS_R_GLUE
case|:
case|case
name|DNS_R_HINT
case|:
case|case
name|ISC_R_SUCCESS
case|:
comment|/* 		 * Found in the database.  Even if we can't copy out 		 * any information, return success, or else a fetch 		 * will be made, which will only make things worse. 		 */
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_a
condition|)
name|adbname
operator|->
name|fetch_err
operator|=
name|FIND_ERR_SUCCESS
expr_stmt|;
else|else
name|adbname
operator|->
name|fetch6_err
operator|=
name|FIND_ERR_SUCCESS
expr_stmt|;
name|result
operator|=
name|import_rdataset
argument_list|(
name|adbname
argument_list|,
operator|&
name|rdataset
argument_list|,
name|now
argument_list|)
expr_stmt|;
break|break;
case|case
name|DNS_R_NXDOMAIN
case|:
case|case
name|DNS_R_NXRRSET
case|:
comment|/* 		 * We're authoritative and the data doesn't exist. 		 * Make up a negative cache entry so we don't ask again 		 * for a while. 		 * 		 * XXXRTH  What time should we use?  I'm putting in 30 seconds 		 * for now. 		 */
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_a
condition|)
block|{
name|adbname
operator|->
name|expire_v4
operator|=
name|now
operator|+
literal|30
expr_stmt|;
name|DP
argument_list|(
name|NCACHE_LEVEL
argument_list|,
literal|"adb name %p: Caching auth negative entry for A"
argument_list|,
name|adbname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_NXDOMAIN
condition|)
name|adbname
operator|->
name|fetch_err
operator|=
name|FIND_ERR_NXDOMAIN
expr_stmt|;
else|else
name|adbname
operator|->
name|fetch_err
operator|=
name|FIND_ERR_NXRRSET
expr_stmt|;
block|}
else|else
block|{
name|DP
argument_list|(
name|NCACHE_LEVEL
argument_list|,
literal|"adb name %p: Caching auth negative entry for AAAA"
argument_list|,
name|adbname
argument_list|)
expr_stmt|;
name|adbname
operator|->
name|expire_v6
operator|=
name|now
operator|+
literal|30
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_NXDOMAIN
condition|)
name|adbname
operator|->
name|fetch6_err
operator|=
name|FIND_ERR_NXDOMAIN
expr_stmt|;
else|else
name|adbname
operator|->
name|fetch6_err
operator|=
name|FIND_ERR_NXRRSET
expr_stmt|;
block|}
break|break;
case|case
name|DNS_R_NCACHENXDOMAIN
case|:
case|case
name|DNS_R_NCACHENXRRSET
case|:
comment|/* 		 * We found a negative cache entry.  Pull the TTL from it 		 * so we won't ask again for a while. 		 */
name|rdataset
operator|.
name|ttl
operator|=
name|ttlclamp
argument_list|(
name|rdataset
operator|.
name|ttl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_a
condition|)
block|{
name|adbname
operator|->
name|expire_v4
operator|=
name|rdataset
operator|.
name|ttl
operator|+
name|now
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_NCACHENXDOMAIN
condition|)
name|adbname
operator|->
name|fetch_err
operator|=
name|FIND_ERR_NXDOMAIN
expr_stmt|;
else|else
name|adbname
operator|->
name|fetch_err
operator|=
name|FIND_ERR_NXRRSET
expr_stmt|;
name|DP
argument_list|(
name|NCACHE_LEVEL
argument_list|,
literal|"adb name %p: Caching negative entry for A (ttl %u)"
argument_list|,
name|adbname
argument_list|,
name|rdataset
operator|.
name|ttl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DP
argument_list|(
name|NCACHE_LEVEL
argument_list|,
literal|"adb name %p: Caching negative entry for AAAA (ttl %u)"
argument_list|,
name|adbname
argument_list|,
name|rdataset
operator|.
name|ttl
argument_list|)
expr_stmt|;
name|adbname
operator|->
name|expire_v6
operator|=
name|rdataset
operator|.
name|ttl
operator|+
name|now
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_NCACHENXDOMAIN
condition|)
name|adbname
operator|->
name|fetch6_err
operator|=
name|FIND_ERR_NXDOMAIN
expr_stmt|;
else|else
name|adbname
operator|->
name|fetch6_err
operator|=
name|FIND_ERR_NXRRSET
expr_stmt|;
block|}
break|break;
case|case
name|DNS_R_CNAME
case|:
case|case
name|DNS_R_DNAME
case|:
comment|/* 		 * Clear the hint and glue flags, so this will match 		 * more often. 		 */
name|adbname
operator|->
name|flags
operator|&=
operator|~
operator|(
name|DNS_ADBFIND_GLUEOK
operator||
name|DNS_ADBFIND_HINTOK
operator|)
expr_stmt|;
name|rdataset
operator|.
name|ttl
operator|=
name|ttlclamp
argument_list|(
name|rdataset
operator|.
name|ttl
argument_list|)
expr_stmt|;
name|clean_target
argument_list|(
name|adb
argument_list|,
operator|&
name|adbname
operator|->
name|target
argument_list|)
expr_stmt|;
name|adbname
operator|->
name|expire_target
operator|=
name|INT_MAX
expr_stmt|;
name|result
operator|=
name|set_target
argument_list|(
name|adb
argument_list|,
operator|&
name|adbname
operator|->
name|name
argument_list|,
name|fname
argument_list|,
operator|&
name|rdataset
argument_list|,
operator|&
name|adbname
operator|->
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|DNS_R_ALIAS
expr_stmt|;
name|DP
argument_list|(
name|NCACHE_LEVEL
argument_list|,
literal|"adb name %p: caching alias target"
argument_list|,
name|adbname
argument_list|)
expr_stmt|;
name|adbname
operator|->
name|expire_target
operator|=
name|rdataset
operator|.
name|ttl
operator|+
name|now
expr_stmt|;
block|}
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_a
condition|)
name|adbname
operator|->
name|fetch_err
operator|=
name|FIND_ERR_SUCCESS
expr_stmt|;
else|else
name|adbname
operator|->
name|fetch6_err
operator|=
name|FIND_ERR_SUCCESS
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|rdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|fetch_callback
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|dns_fetchevent_t
modifier|*
name|dev
decl_stmt|;
name|dns_adbname_t
modifier|*
name|name
decl_stmt|;
name|dns_adb_t
modifier|*
name|adb
decl_stmt|;
name|dns_adbfetch_t
modifier|*
name|fetch
decl_stmt|;
name|int
name|bucket
decl_stmt|;
name|isc_eventtype_t
name|ev_status
decl_stmt|;
name|isc_stdtime_t
name|now
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|address_type
decl_stmt|;
name|isc_boolean_t
name|want_check_exit
init|=
name|ISC_FALSE
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ev
operator|->
name|ev_type
operator|==
name|DNS_EVENT_FETCHDONE
argument_list|)
expr_stmt|;
name|dev
operator|=
operator|(
name|dns_fetchevent_t
operator|*
operator|)
name|ev
expr_stmt|;
name|name
operator|=
name|ev
operator|->
name|ev_arg
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ADBNAME_VALID
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|adb
operator|=
name|name
operator|->
name|adb
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|bucket
operator|=
name|name
operator|->
name|lock_bucket
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|NAME_FETCH_A
argument_list|(
name|name
argument_list|)
operator|||
name|NAME_FETCH_AAAA
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|address_type
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|NAME_FETCH_A
argument_list|(
name|name
argument_list|)
operator|&&
operator|(
name|name
operator|->
name|fetch_a
operator|->
name|fetch
operator|==
name|dev
operator|->
name|fetch
operator|)
condition|)
block|{
name|address_type
operator|=
name|DNS_ADBFIND_INET
expr_stmt|;
name|fetch
operator|=
name|name
operator|->
name|fetch_a
expr_stmt|;
name|name
operator|->
name|fetch_a
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|NAME_FETCH_AAAA
argument_list|(
name|name
argument_list|)
operator|&&
operator|(
name|name
operator|->
name|fetch_aaaa
operator|->
name|fetch
operator|==
name|dev
operator|->
name|fetch
operator|)
condition|)
block|{
name|address_type
operator|=
name|DNS_ADBFIND_INET6
expr_stmt|;
name|fetch
operator|=
name|name
operator|->
name|fetch_aaaa
expr_stmt|;
name|name
operator|->
name|fetch_aaaa
operator|=
name|NULL
expr_stmt|;
block|}
name|INSIST
argument_list|(
name|address_type
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|dns_resolver_destroyfetch
argument_list|(
operator|&
name|fetch
operator|->
name|fetch
argument_list|)
expr_stmt|;
name|dev
operator|->
name|fetch
operator|=
name|NULL
expr_stmt|;
name|ev_status
operator|=
name|DNS_EVENT_ADBNOMOREADDRESSES
expr_stmt|;
comment|/* 	 * Cleanup things we don't care about. 	 */
if|if
condition|(
name|dev
operator|->
name|node
operator|!=
name|NULL
condition|)
name|dns_db_detachnode
argument_list|(
name|dev
operator|->
name|db
argument_list|,
operator|&
name|dev
operator|->
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|dev
operator|->
name|db
argument_list|)
expr_stmt|;
comment|/* 	 * If this name is marked as dead, clean up, throwing away 	 * potentially good data. 	 */
if|if
condition|(
name|NAME_DEAD
argument_list|(
name|name
argument_list|)
condition|)
block|{
name|free_adbfetch
argument_list|(
name|adb
argument_list|,
operator|&
name|fetch
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
name|want_check_exit
operator|=
name|kill_name
argument_list|(
operator|&
name|name
argument_list|,
name|DNS_EVENT_ADBCANCELED
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_check_exit
condition|)
block|{
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|check_exit
argument_list|(
name|adb
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* 	 * If we got a negative cache response, remember it. 	 */
if|if
condition|(
name|NCACHE_RESULT
argument_list|(
name|dev
operator|->
name|result
argument_list|)
condition|)
block|{
name|dev
operator|->
name|rdataset
operator|->
name|ttl
operator|=
name|ttlclamp
argument_list|(
name|dev
operator|->
name|rdataset
operator|->
name|ttl
argument_list|)
expr_stmt|;
if|if
condition|(
name|address_type
operator|==
name|DNS_ADBFIND_INET
condition|)
block|{
name|DP
argument_list|(
name|NCACHE_LEVEL
argument_list|,
literal|"adb fetch name %p: "
literal|"caching negative entry for A (ttl %u)"
argument_list|,
name|name
argument_list|,
name|dev
operator|->
name|rdataset
operator|->
name|ttl
argument_list|)
expr_stmt|;
name|name
operator|->
name|expire_v4
operator|=
name|ISC_MIN
argument_list|(
name|name
operator|->
name|expire_v4
argument_list|,
name|dev
operator|->
name|rdataset
operator|->
name|ttl
operator|+
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|result
operator|==
name|DNS_R_NCACHENXDOMAIN
condition|)
name|name
operator|->
name|fetch_err
operator|=
name|FIND_ERR_NXDOMAIN
expr_stmt|;
else|else
name|name
operator|->
name|fetch_err
operator|=
name|FIND_ERR_NXRRSET
expr_stmt|;
block|}
else|else
block|{
name|DP
argument_list|(
name|NCACHE_LEVEL
argument_list|,
literal|"adb fetch name %p: "
literal|"caching negative entry for AAAA (ttl %u)"
argument_list|,
name|name
argument_list|,
name|dev
operator|->
name|rdataset
operator|->
name|ttl
argument_list|)
expr_stmt|;
name|name
operator|->
name|expire_v6
operator|=
name|ISC_MIN
argument_list|(
name|name
operator|->
name|expire_v6
argument_list|,
name|dev
operator|->
name|rdataset
operator|->
name|ttl
operator|+
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|result
operator|==
name|DNS_R_NCACHENXDOMAIN
condition|)
name|name
operator|->
name|fetch6_err
operator|=
name|FIND_ERR_NXDOMAIN
expr_stmt|;
else|else
name|name
operator|->
name|fetch6_err
operator|=
name|FIND_ERR_NXRRSET
expr_stmt|;
block|}
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Handle CNAME/DNAME. 	 */
if|if
condition|(
name|dev
operator|->
name|result
operator|==
name|DNS_R_CNAME
operator|||
name|dev
operator|->
name|result
operator|==
name|DNS_R_DNAME
condition|)
block|{
name|dev
operator|->
name|rdataset
operator|->
name|ttl
operator|=
name|ttlclamp
argument_list|(
name|dev
operator|->
name|rdataset
operator|->
name|ttl
argument_list|)
expr_stmt|;
name|clean_target
argument_list|(
name|adb
argument_list|,
operator|&
name|name
operator|->
name|target
argument_list|)
expr_stmt|;
name|name
operator|->
name|expire_target
operator|=
name|INT_MAX
expr_stmt|;
name|result
operator|=
name|set_target
argument_list|(
name|adb
argument_list|,
operator|&
name|name
operator|->
name|name
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|dev
operator|->
name|foundname
argument_list|)
argument_list|,
name|dev
operator|->
name|rdataset
argument_list|,
operator|&
name|name
operator|->
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|DP
argument_list|(
name|NCACHE_LEVEL
argument_list|,
literal|"adb fetch name %p: caching alias target"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|name
operator|->
name|expire_target
operator|=
name|dev
operator|->
name|rdataset
operator|->
name|ttl
operator|+
name|now
expr_stmt|;
block|}
goto|goto
name|check_result
goto|;
block|}
comment|/* 	 * Did we get back junk?  If so, and there are no more fetches 	 * sitting out there, tell all the finds about it. 	 */
if|if
condition|(
name|dev
operator|->
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|char
name|buf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
operator|&
name|name
operator|->
name|name
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|DP
argument_list|(
name|DEF_LEVEL
argument_list|,
literal|"adb: fetch of '%s' %s failed: %s"
argument_list|,
name|buf
argument_list|,
name|address_type
operator|==
name|DNS_ADBFIND_INET
condition|?
literal|"A"
else|:
literal|"AAAA"
argument_list|,
name|dns_result_totext
argument_list|(
name|dev
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXXMLG Don't pound on bad servers. */
if|if
condition|(
name|address_type
operator|==
name|DNS_ADBFIND_INET
condition|)
block|{
name|name
operator|->
name|expire_v4
operator|=
name|ISC_MIN
argument_list|(
name|name
operator|->
name|expire_v4
argument_list|,
name|now
operator|+
literal|300
argument_list|)
expr_stmt|;
name|name
operator|->
name|fetch_err
operator|=
name|FIND_ERR_FAILURE
expr_stmt|;
block|}
else|else
block|{
name|name
operator|->
name|expire_v6
operator|=
name|ISC_MIN
argument_list|(
name|name
operator|->
name|expire_v6
argument_list|,
name|now
operator|+
literal|300
argument_list|)
expr_stmt|;
name|name
operator|->
name|fetch6_err
operator|=
name|FIND_ERR_FAILURE
expr_stmt|;
block|}
goto|goto
name|out
goto|;
block|}
comment|/* 	 * We got something potentially useful. 	 */
name|result
operator|=
name|import_rdataset
argument_list|(
name|name
argument_list|,
operator|&
name|fetch
operator|->
name|rdataset
argument_list|,
name|now
argument_list|)
expr_stmt|;
name|check_result
label|:
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|ev_status
operator|=
name|DNS_EVENT_ADBMOREADDRESSES
expr_stmt|;
if|if
condition|(
name|address_type
operator|==
name|DNS_ADBFIND_INET
condition|)
name|name
operator|->
name|fetch_err
operator|=
name|FIND_ERR_SUCCESS
expr_stmt|;
else|else
name|name
operator|->
name|fetch6_err
operator|=
name|FIND_ERR_SUCCESS
expr_stmt|;
block|}
name|out
label|:
name|free_adbfetch
argument_list|(
name|adb
argument_list|,
operator|&
name|fetch
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
name|clean_finds_at_name
argument_list|(
name|name
argument_list|,
name|ev_status
argument_list|,
name|address_type
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|fetch_name
parameter_list|(
name|dns_adbname_t
modifier|*
name|adbname
parameter_list|,
name|isc_boolean_t
name|start_at_zone
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_adbfetch_t
modifier|*
name|fetch
init|=
name|NULL
decl_stmt|;
name|dns_adb_t
modifier|*
name|adb
decl_stmt|;
name|dns_fixedname_t
name|fixed
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|nameservers
decl_stmt|;
name|unsigned
name|int
name|options
decl_stmt|;
name|INSIST
argument_list|(
name|DNS_ADBNAME_VALID
argument_list|(
name|adbname
argument_list|)
argument_list|)
expr_stmt|;
name|adb
operator|=
name|adbname
operator|->
name|adb
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|(
name|type
operator|==
name|dns_rdatatype_a
operator|&&
operator|!
name|NAME_FETCH_V4
argument_list|(
name|adbname
argument_list|)
operator|)
operator|||
operator|(
name|type
operator|==
name|dns_rdatatype_aaaa
operator|&&
operator|!
name|NAME_FETCH_V6
argument_list|(
name|adbname
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|adbname
operator|->
name|fetch_err
operator|=
name|FIND_ERR_NOTFOUND
expr_stmt|;
name|name
operator|=
name|NULL
expr_stmt|;
name|nameservers
operator|=
name|NULL
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|options
operator|=
name|DNS_FETCHOPT_NOVALIDATE
expr_stmt|;
if|if
condition|(
name|start_at_zone
condition|)
block|{
name|DP
argument_list|(
name|ENTER_LEVEL
argument_list|,
literal|"fetch_name: starting at zone for name %p"
argument_list|,
name|adbname
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_view_findzonecut2
argument_list|(
name|adb
operator|->
name|view
argument_list|,
operator|&
name|adbname
operator|->
name|name
argument_list|,
name|name
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|ISC_TRUE
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|DNS_R_HINT
condition|)
goto|goto
name|cleanup
goto|;
name|nameservers
operator|=
operator|&
name|rdataset
expr_stmt|;
name|options
operator||=
name|DNS_FETCHOPT_UNSHARED
expr_stmt|;
block|}
name|fetch
operator|=
name|new_adbfetch
argument_list|(
name|adb
argument_list|)
expr_stmt|;
if|if
condition|(
name|fetch
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|result
operator|=
name|dns_resolver_createfetch
argument_list|(
name|adb
operator|->
name|view
operator|->
name|resolver
argument_list|,
operator|&
name|adbname
operator|->
name|name
argument_list|,
name|type
argument_list|,
name|name
argument_list|,
name|nameservers
argument_list|,
name|NULL
argument_list|,
name|options
argument_list|,
name|adb
operator|->
name|task
argument_list|,
name|fetch_callback
argument_list|,
name|adbname
argument_list|,
operator|&
name|fetch
operator|->
name|rdataset
argument_list|,
name|NULL
argument_list|,
operator|&
name|fetch
operator|->
name|fetch
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|type
operator|==
name|dns_rdatatype_a
condition|)
name|adbname
operator|->
name|fetch_a
operator|=
name|fetch
expr_stmt|;
else|else
name|adbname
operator|->
name|fetch_aaaa
operator|=
name|fetch
expr_stmt|;
name|fetch
operator|=
name|NULL
expr_stmt|;
comment|/* Keep us from cleaning this up below. */
name|cleanup
label|:
if|if
condition|(
name|fetch
operator|!=
name|NULL
condition|)
name|free_adbfetch
argument_list|(
name|adb
argument_list|,
operator|&
name|fetch
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|rdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * XXXMLG Needs to take a find argument and an address info, no zone or adb,  * since these can be extracted from the find itself.  */
end_comment

begin_function
name|isc_result_t
name|dns_adb_marklame
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbaddrinfo_t
modifier|*
name|addr
parameter_list|,
name|dns_name_t
modifier|*
name|zone
parameter_list|,
name|isc_stdtime_t
name|expire_time
parameter_list|)
block|{
name|dns_adbzoneinfo_t
modifier|*
name|zi
decl_stmt|;
name|int
name|bucket
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADBADDRINFO_VALID
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|zone
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|bucket
operator|=
name|addr
operator|->
name|entry
operator|->
name|lock_bucket
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|zi
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|addr
operator|->
name|entry
operator|->
name|zoneinfo
argument_list|)
expr_stmt|;
while|while
condition|(
name|zi
operator|!=
name|NULL
operator|&&
name|dns_name_equal
argument_list|(
name|zone
argument_list|,
operator|&
name|zi
operator|->
name|zone
argument_list|)
condition|)
name|zi
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|zi
argument_list|,
name|plink
argument_list|)
expr_stmt|;
if|if
condition|(
name|zi
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|expire_time
operator|>
name|zi
operator|->
name|lame_timer
condition|)
name|zi
operator|->
name|lame_timer
operator|=
name|expire_time
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
name|zi
operator|=
name|new_adbzoneinfo
argument_list|(
name|adb
argument_list|,
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zi
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
name|zi
operator|->
name|lame_timer
operator|=
name|expire_time
expr_stmt|;
name|ISC_LIST_PREPEND
argument_list|(
name|addr
operator|->
name|entry
operator|->
name|zoneinfo
argument_list|,
name|zi
argument_list|,
name|plink
argument_list|)
expr_stmt|;
name|unlock
label|:
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_adb_adjustsrtt
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbaddrinfo_t
modifier|*
name|addr
parameter_list|,
name|unsigned
name|int
name|rtt
parameter_list|,
name|unsigned
name|int
name|factor
parameter_list|)
block|{
name|int
name|bucket
decl_stmt|;
name|unsigned
name|int
name|new_srtt
decl_stmt|;
name|isc_stdtime_t
name|now
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADBADDRINFO_VALID
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|factor
operator|<=
literal|10
argument_list|)
expr_stmt|;
name|bucket
operator|=
name|addr
operator|->
name|entry
operator|->
name|lock_bucket
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|factor
operator|==
name|DNS_ADB_RTTADJAGE
condition|)
name|new_srtt
operator|=
name|addr
operator|->
name|entry
operator|->
name|srtt
operator|*
literal|98
operator|/
literal|100
expr_stmt|;
else|else
name|new_srtt
operator|=
operator|(
name|addr
operator|->
name|entry
operator|->
name|srtt
operator|/
literal|10
operator|*
name|factor
operator|)
operator|+
operator|(
name|rtt
operator|/
literal|10
operator|*
operator|(
literal|10
operator|-
name|factor
operator|)
operator|)
expr_stmt|;
name|addr
operator|->
name|entry
operator|->
name|srtt
operator|=
name|new_srtt
expr_stmt|;
name|addr
operator|->
name|srtt
operator|=
name|new_srtt
expr_stmt|;
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|addr
operator|->
name|entry
operator|->
name|expires
operator|=
name|now
operator|+
name|ADB_ENTRY_WINDOW
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_adb_changeflags
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbaddrinfo_t
modifier|*
name|addr
parameter_list|,
name|unsigned
name|int
name|bits
parameter_list|,
name|unsigned
name|int
name|mask
parameter_list|)
block|{
name|int
name|bucket
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADBADDRINFO_VALID
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|bucket
operator|=
name|addr
operator|->
name|entry
operator|->
name|lock_bucket
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|addr
operator|->
name|entry
operator|->
name|flags
operator|=
operator|(
name|addr
operator|->
name|entry
operator|->
name|flags
operator|&
operator|~
name|mask
operator|)
operator||
operator|(
name|bits
operator|&
name|mask
operator|)
expr_stmt|;
comment|/* 	 * Note that we do not update the other bits in addr->flags with 	 * the most recent values from addr->entry->flags. 	 */
name|addr
operator|->
name|flags
operator|=
operator|(
name|addr
operator|->
name|flags
operator|&
operator|~
name|mask
operator|)
operator||
operator|(
name|bits
operator|&
name|mask
operator|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_adb_findaddrinfo
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|sa
parameter_list|,
name|dns_adbaddrinfo_t
modifier|*
modifier|*
name|addrp
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
name|int
name|bucket
decl_stmt|;
name|dns_adbentry_t
modifier|*
name|entry
decl_stmt|;
name|dns_adbaddrinfo_t
modifier|*
name|addr
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|in_port_t
name|port
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|addrp
operator|!=
name|NULL
operator|&&
operator|*
name|addrp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|now
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|bucket
operator|=
name|DNS_ADB_INVALIDBUCKET
expr_stmt|;
name|entry
operator|=
name|find_entry_and_lock
argument_list|(
name|adb
argument_list|,
name|sa
argument_list|,
operator|&
name|bucket
argument_list|)
expr_stmt|;
if|if
condition|(
name|adb
operator|->
name|entry_sd
index|[
name|bucket
index|]
condition|)
block|{
name|result
operator|=
name|ISC_R_SHUTTINGDOWN
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * We don't know anything about this address. 		 */
name|entry
operator|=
name|new_adbentry
argument_list|(
name|adb
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
name|entry
operator|->
name|sockaddr
operator|=
operator|*
name|sa
expr_stmt|;
name|link_entry
argument_list|(
name|adb
argument_list|,
name|bucket
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|DP
argument_list|(
name|ENTER_LEVEL
argument_list|,
literal|"findaddrinfo: new entry %p"
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
else|else
name|DP
argument_list|(
name|ENTER_LEVEL
argument_list|,
literal|"findaddrinfo: found entry %p"
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|port
operator|=
name|isc_sockaddr_getport
argument_list|(
name|sa
argument_list|)
expr_stmt|;
name|addr
operator|=
name|new_adbaddrinfo
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|!=
name|NULL
condition|)
block|{
name|inc_entry_refcnt
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
operator|*
name|addrp
operator|=
name|addr
expr_stmt|;
block|}
name|unlock
label|:
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_adb_freeaddrinfo
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_adbaddrinfo_t
modifier|*
modifier|*
name|addrp
parameter_list|)
block|{
name|dns_adbaddrinfo_t
modifier|*
name|addr
decl_stmt|;
name|dns_adbentry_t
modifier|*
name|entry
decl_stmt|;
name|int
name|bucket
decl_stmt|;
name|isc_stdtime_t
name|now
decl_stmt|;
name|isc_boolean_t
name|want_check_exit
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|addrp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|addr
operator|=
operator|*
name|addrp
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADBADDRINFO_VALID
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|=
name|addr
operator|->
name|entry
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADBENTRY_VALID
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
operator|*
name|addrp
operator|=
name|NULL
expr_stmt|;
name|bucket
operator|=
name|addr
operator|->
name|entry
operator|->
name|lock_bucket
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|entry
operator|->
name|expires
operator|=
name|now
operator|+
name|ADB_ENTRY_WINDOW
expr_stmt|;
name|want_check_exit
operator|=
name|dec_entry_refcnt
argument_list|(
name|adb
argument_list|,
name|entry
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|entrylocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|addr
operator|->
name|entry
operator|=
name|NULL
expr_stmt|;
name|free_adbaddrinfo
argument_list|(
name|adb
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_check_exit
condition|)
block|{
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|check_exit
argument_list|(
name|adb
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|dns_adb_flush
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|INSIST
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* 	 * Call our cleanup routines. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUCKETS
condition|;
name|i
operator|++
control|)
name|RUNTIME_CHECK
argument_list|(
name|cleanup_names
argument_list|(
name|adb
argument_list|,
name|i
argument_list|,
name|INT_MAX
argument_list|)
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUCKETS
condition|;
name|i
operator|++
control|)
name|RUNTIME_CHECK
argument_list|(
name|cleanup_entries
argument_list|(
name|adb
argument_list|,
name|i
argument_list|,
name|INT_MAX
argument_list|)
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DUMP_ADB_AFTER_CLEANING
name|dump_adb
argument_list|(
name|adb
argument_list|,
name|stdout
argument_list|,
name|ISC_TRUE
argument_list|,
name|INT_MAX
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_adb_flushname
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|dns_adbname_t
modifier|*
name|adbname
decl_stmt|;
name|dns_adbname_t
modifier|*
name|nextname
decl_stmt|;
name|int
name|bucket
decl_stmt|;
name|INSIST
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|bucket
operator|=
name|dns_name_hash
argument_list|(
name|name
argument_list|,
name|ISC_FALSE
argument_list|)
operator|%
name|NBUCKETS
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|adbname
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|adb
operator|->
name|names
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|adbname
operator|!=
name|NULL
condition|)
block|{
name|nextname
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|adbname
argument_list|,
name|plink
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|NAME_DEAD
argument_list|(
name|adbname
argument_list|)
operator|&&
name|dns_name_equal
argument_list|(
name|name
argument_list|,
operator|&
name|adbname
operator|->
name|name
argument_list|)
condition|)
block|{
name|RUNTIME_CHECK
argument_list|(
name|kill_name
argument_list|(
operator|&
name|adbname
argument_list|,
name|DNS_EVENT_ADBCANCELED
argument_list|)
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
name|adbname
operator|=
name|nextname
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|namelocks
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|adb
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|water
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|mark
parameter_list|)
block|{
name|dns_adb_t
modifier|*
name|adb
init|=
name|arg
decl_stmt|;
name|isc_boolean_t
name|overmem
init|=
name|ISC_TF
argument_list|(
name|mark
operator|==
name|ISC_MEM_HIWATER
argument_list|)
decl_stmt|;
name|isc_interval_t
name|interval
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
name|DP
argument_list|(
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"adb reached %s water mark"
argument_list|,
name|overmem
condition|?
literal|"high"
else|:
literal|"low"
argument_list|)
expr_stmt|;
name|adb
operator|->
name|overmem
operator|=
name|overmem
expr_stmt|;
if|if
condition|(
name|overmem
condition|)
block|{
name|isc_interval_set
argument_list|(
operator|&
name|interval
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|isc_timer_reset
argument_list|(
name|adb
operator|->
name|timer
argument_list|,
name|isc_timertype_once
argument_list|,
name|NULL
argument_list|,
operator|&
name|interval
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|dns_adb_setadbsize
parameter_list|(
name|dns_adb_t
modifier|*
name|adb
parameter_list|,
name|isc_uint32_t
name|size
parameter_list|)
block|{
name|isc_uint32_t
name|hiwater
decl_stmt|;
name|isc_uint32_t
name|lowater
decl_stmt|;
name|INSIST
argument_list|(
name|DNS_ADB_VALID
argument_list|(
name|adb
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|!=
literal|0
operator|&&
name|size
operator|<
name|DNS_ADB_MINADBSIZE
condition|)
name|size
operator|=
name|DNS_ADB_MINADBSIZE
expr_stmt|;
name|hiwater
operator|=
name|size
operator|-
operator|(
name|size
operator|>>
literal|3
operator|)
expr_stmt|;
comment|/* Approximately 7/8ths. */
name|lowater
operator|=
name|size
operator|-
operator|(
name|size
operator|>>
literal|2
operator|)
expr_stmt|;
comment|/* Approximately 3/4ths. */
if|if
condition|(
name|size
operator|==
literal|0
operator|||
name|hiwater
operator|==
literal|0
operator|||
name|lowater
operator|==
literal|0
condition|)
name|isc_mem_setwater
argument_list|(
name|adb
operator|->
name|mctx
argument_list|,
name|water
argument_list|,
name|adb
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|isc_mem_setwater
argument_list|(
name|adb
operator|->
name|mctx
argument_list|,
name|water
argument_list|,
name|adb
argument_list|,
name|hiwater
argument_list|,
name|lowater
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004, 2005, 2007, 2009  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2001  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: lib.c,v 1.19 2009-09-03 00:12:23 each Exp $ */
end_comment

begin_comment
comment|/*! \file */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<isc/hash.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/msgcat.h>
end_include

begin_include
include|#
directive|include
file|<isc/mutex.h>
end_include

begin_include
include|#
directive|include
file|<isc/once.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/ecdb.h>
end_include

begin_include
include|#
directive|include
file|<dns/lib.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dst/dst.h>
end_include

begin_comment
comment|/***  *** Globals  ***/
end_comment

begin_decl_stmt
name|LIBDNS_EXTERNAL_DATA
name|unsigned
name|int
name|dns_pps
init|=
literal|0U
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|LIBDNS_EXTERNAL_DATA
name|isc_msgcat_t
modifier|*
name|dns_msgcat
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/***  *** Private  ***/
end_comment

begin_decl_stmt
specifier|static
name|isc_once_t
name|msgcat_once
init|=
name|ISC_ONCE_INIT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/***  *** Functions  ***/
end_comment

begin_function
specifier|static
name|void
name|open_msgcat
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_msgcat_open
argument_list|(
literal|"libdns.cat"
argument_list|,
operator|&
name|dns_msgcat
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_lib_initmsgcat
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* 	 * Initialize the DNS library's message catalog, dns_msgcat, if it 	 * has not already been initialized. 	 */
name|RUNTIME_CHECK
argument_list|(
name|isc_once_do
argument_list|(
operator|&
name|msgcat_once
argument_list|,
name|open_msgcat
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|isc_once_t
name|init_once
init|=
name|ISC_ONCE_INIT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_mem_t
modifier|*
name|dns_g_mctx
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|BIND9
end_ifndef

begin_decl_stmt
specifier|static
name|dns_dbimplementation_t
modifier|*
name|dbimp
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|initialize_done
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_mutex_t
name|reflock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|references
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|initialize
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|initialize_done
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_mem_create
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|dns_g_mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return;
name|dns_result_register
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|BIND9
name|result
operator|=
name|dns_ecdb_register
argument_list|(
name|dns_g_mctx
argument_list|,
operator|&
name|dbimp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_mctx
goto|;
endif|#
directive|endif
name|result
operator|=
name|isc_hash_create
argument_list|(
name|dns_g_mctx
argument_list|,
name|NULL
argument_list|,
name|DNS_NAME_MAXWIRE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_db
goto|;
name|result
operator|=
name|dst_lib_init
argument_list|(
name|dns_g_mctx
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_hash
goto|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|reflock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_dst
goto|;
name|initialize_done
operator|=
name|ISC_TRUE
expr_stmt|;
return|return;
name|cleanup_dst
label|:
name|dst_lib_destroy
argument_list|()
expr_stmt|;
name|cleanup_hash
label|:
name|isc_hash_destroy
argument_list|()
expr_stmt|;
name|cleanup_db
label|:
ifndef|#
directive|ifndef
name|BIND9
name|dns_ecdb_unregister
argument_list|(
operator|&
name|dbimp
argument_list|)
expr_stmt|;
name|cleanup_mctx
label|:
endif|#
directive|endif
name|isc_mem_detach
argument_list|(
operator|&
name|dns_g_mctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_lib_init
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
comment|/* 	 * Since this routine is expected to be used by a normal application, 	 * it should be better to return an error, instead of an emergency 	 * abort, on any failure. 	 */
name|result
operator|=
name|isc_once_do
argument_list|(
operator|&
name|init_once
argument_list|,
name|initialize
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
operator|!
name|initialize_done
condition|)
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
name|LOCK
argument_list|(
operator|&
name|reflock
argument_list|)
expr_stmt|;
name|references
operator|++
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|reflock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_lib_shutdown
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_boolean_t
name|cleanup_ok
init|=
name|ISC_FALSE
decl_stmt|;
name|LOCK
argument_list|(
operator|&
name|reflock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|references
operator|==
literal|0
condition|)
name|cleanup_ok
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|reflock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cleanup_ok
condition|)
return|return;
name|dst_lib_destroy
argument_list|()
expr_stmt|;
name|isc_hash_destroy
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|BIND9
name|dns_ecdb_unregister
argument_list|(
operator|&
name|dbimp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|isc_mem_detach
argument_list|(
operator|&
name|dns_g_mctx
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

